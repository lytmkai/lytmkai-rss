<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[历史性突破！LCP 和 INP 终于覆盖所有主流浏览器，iOS 性能盲点彻底消失]]></title>    <link>https://juejin.cn/post/7588445332771881014</link>    <guid>https://juejin.cn/post/7588445332771881014</guid>    <pubDate>2025-12-29T01:01:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588445332771881014" data-draft-id="7587606718843732009" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="历史性突破！LCP 和 INP 终于覆盖所有主流浏览器，iOS 性能盲点彻底消失"/> <meta itemprop="keywords" content="前端,JavaScript,面试"/> <meta itemprop="datePublished" content="2025-12-29T01:01:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Moment"/> <meta itemprop="url" content="https://juejin.cn/user/3782764966460398"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            历史性突破！LCP 和 INP 终于覆盖所有主流浏览器，iOS 性能盲点彻底消失
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3782764966460398/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Moment
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T01:01:42.000Z" title="Mon Dec 29 2025 01:01:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><blockquote>
<p>我正在开发 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fxun082%2FDocFlow" target="_blank" title="https://github.com/xun082/DocFlow" ref="nofollow noopener noreferrer">DocFlow</a>，它是一个完整的 AI 全栈协同文档平台。该项目融合了多个技术栈，包括基于 <code>Tiptap</code> 的富文本编辑器、<code>NestJs</code> 后端服务、<code>AI</code> 集成功能和实时协作。在开发过程中，我积累了丰富的实战经验，涵盖了 <code>Tiptap</code> 的深度定制、性能优化和协作功能的实现等核心难点。</p>
</blockquote>
<p>如果你对 AI 全栈开发、Tiptap 富文本编辑器定制或 DocFlow 项目的完整技术方案感兴趣，欢迎加我微信 <code>yunmz777</code> 进行私聊咨询，获取详细的技术分享和最佳实践。</p>
<p>随着 Safari 26.2 在 12 月 12 日的发布，Web 性能领域迎来了一个令人振奋的年终礼物：最大内容绘制（LCP）和交互到下次绘制（INP）现已正式成为 Baseline 新可用功能。所有主流浏览器的最新版本现在都包含了测量这些指标所需的最大内容绘制 API 和事件计时 API。这是 Interop 2025 项目的一部分，很高兴看到这些功能在今年成功交付！</p>
<h2 data-id="heading-0">这意味着什么</h2>
<p>核心 Web 指标（Core Web Vitals）已成为衡量网页体验的广泛采用标准，无论是对于 Web 开发者还是业务利益相关者而言都是如此。它们试图将复杂的 Web 性能故事总结为几个关键指标：页面加载速度（LCP）、交互响应速度（INP）以及内容稳定性（CLS）。</p>
<p>长期以来，这些指标只能在基于 Chromium 的浏览器（如 Chrome 和 Edge）中测量。在 iOS 设备上，由于所有浏览器都使用驱动 Safari 的 WebKit 浏览器引擎，这些指标完全不可用。这造成了一个盲点：网站可能不知道大量访问者正在经历完全不同的体验。虽然许多 Web 性能改进确实使所有浏览器受益，但某些技术和 API 仅在部分浏览器中可用。此外，浏览器内部的工作方式、页面加载方式以及处理交互的方式可能彼此不同。仅拥有网站性能的部分视图远非理想状态。</p>
<p>随着所有主流浏览器现在都支持这两个指标，我们现在可以更好地了解网站的关键加载和交互性能。这将使网站所有者能够更好地理解性能问题并识别可以进行的改进，最终使用户和业务指标受益。</p>
<h2 data-id="heading-1">其他浏览器的数据会进入 CrUX 吗？</h2>
<p>不会。Chrome 用户体验报告（CrUX）仅基于符合条件的 Chrome 用户，这一点不会改变。这也适用于使用此数据的下游系统，如 PageSpeed Insights、Google Search Console 和 CrUX Vis。</p>
<p>这也将继续排除 Chrome iOS 用户，因为他们使用 WebKit 浏览器引擎。</p>
<h2 data-id="heading-2">如何从其他浏览器测量</h2>
<p>CrUX 数据仍然作为网站性能的摘要很有用，并且可以与网络上的其他网站进行基准测试。然而，由于它是一个高级摘要，我们长期以来一直建议测量更详细的真实用户数据（field data）以帮助识别和改进性能。</p>
<p>真实用户监控（RUM）工具现在能够收集额外的真实用户数据，包括通过 Chrome 团队的 web-vitals 库测量的数据。在大多数情况下，这应该自动开始包含在您现有的解决方案中，但如果您有任何问题，请与您的 RUM 提供商确认。</p>
<p>请注意，RUM 和 CrUX 之间可能存在差异，现在这些指标在更多不包括在 CrUX 中的浏览器中可用，这种差异可能更加明显。</p>
<h2 data-id="heading-3">实现方式有什么不同吗？</h2>
<p>虽然所有浏览器引擎在加载和显示网页方面大致执行相同的任务，但这些浏览器的构建方式存在许多差异，特别是在它们的渲染管道中，这些管道将网站的代码（主要是 HTML、CSS 和 JavaScript）转换为屏幕上的像素。</p>
<p>渲染循环的结束大致是可互操作的，被定义为 <code>paintTime</code>。然而，在这之后，有一个稍后的 <code>presentationTime</code>，这是特定于实现的，旨在指示像素实际绘制到屏幕上的时间。Chrome 测量 LCP 直到 <code>presentationTime</code> 结束，而 Firefox 和 Safari 不包括 <code>presentationTime</code>，因此测量到更早的 <code>paintTime</code>。这导致测量结果之间存在几毫秒的差异。从 Chrome 145 开始，<code>paintTime</code> 测量也将为 LCP 公开，以便那些希望能够在浏览器之间进行同类比较的人使用。</p>
<p>同样的差异也适用于 INP。</p>
<p>其他浏览器实现这些指标的事实，有助于识别一些需要澄清和更好定义的未解决问题。这再次可能导致轻微差异——尽管这些主要出现在边缘情况中。这就是拥有多个实现和关注 API 的好处！我们将继续致力于这些以及指标的任何其他改进。</p>
<p>然而，尽管存在这些小的差异，我们确信 LCP 和 INP 大致是可互操作的，因此我们很高兴它们被标记为 Baseline 新可用功能。那些实现 RUM 解决方案或深入研究数据的人可能会注意到其中一些差异，但 Web 开发者应该对跨浏览器测量这些指标充满信心，尽管存在这些微小差异。</p>
<h2 data-id="heading-4">不支持这些 API 的浏览器怎么办？</h2>
<p>Baseline 新可用功能仅在所有主流浏览器的最新版本中可用。您的用户群可能不会立即升级，或者可能无法升级，这取决于他们的操作系统和提供商。30 个月后，它们将被视为 Baseline 广泛可用，因为大多数用户可能会使用支持这些功能的浏览器。</p>
<p>然而，作为测量 API 而不是网站的核心功能，您可以安全地为支持这些功能的浏览器测量这些指标——就像您到目前为止可能一直在做的那样。只需注意，您可能正在看到过滤后的用户视图——那些已升级的用户——特别是在最初的几个月里。</p>
<h2 data-id="heading-5">累积布局偏移（CLS）呢？</h2>
<p>第三个核心 Web 指标是累积布局偏移（CLS），它不是 Interop 2025 项目的一部分——尽管它已被提议用于 Interop 2026。目前，除了基于 Chromium 的浏览器之外，它不受支持。</p>
<h2 data-id="heading-6">结论</h2>
<p>Web Vitals 计划的目标是通过为 Web 平台创建一套标准 API 来改善 Web 性能，使关键指标能够被测量并被网站所有者广泛理解。很高兴看到这些指标中的两个现在得到了所有主流浏览器的支持。我们期待看到这些指标为网站所有者提供什么见解，以及这如何带来更好的用户体验！</p>
<p><strong>参考来源：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fweb.dev%2Fblog%2Flcp-and-inp-are-now-baseline-newly-available" target="_blank" title="https://web.dev/blog/lcp-and-inp-are-now-baseline-newly-available" ref="nofollow noopener noreferrer">web.dev - LCP and INP are now Baseline Newly available</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[夜莺告警引擎内核：一个优雅的设计]]></title>    <link>https://juejin.cn/post/7588411503121268772</link>    <guid>https://juejin.cn/post/7588411503121268772</guid>    <pubDate>2025-12-29T01:23:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588411503121268772" data-draft-id="7588411503121252388" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="夜莺告警引擎内核：一个优雅的设计"/> <meta itemprop="keywords" content="后端,Go,运维"/> <meta itemprop="datePublished" content="2025-12-29T01:23:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="踏浪无痕"/> <meta itemprop="url" content="https://juejin.cn/user/2834988091055719"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            夜莺告警引擎内核：一个优雅的设计
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2834988091055719/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    踏浪无痕
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T01:23:41.000Z" title="Mon Dec 29 2025 01:23:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">夜莺告警引擎内核：一个优雅的设计</h2>
<p>这是一个从 Prometheus 指标到告警事件的完整引擎。它做的事情很简单：<strong>把 Prometheus 里的指标曲线，变成可追踪、可管理的告警事件</strong>。</p>
<hr/>
<h3 data-id="heading-1">一、这个引擎解决什么问题？</h3>
<h4 data-id="heading-2">它做的事</h4>
<p>假设你的系统在 Prometheus 里有这些指标：</p>
<ul>
<li><code>alarm_log_error_total</code>：错误日志数量</li>
<li><code>alarm_sql_slow_count</code>：慢 SQL 数量</li>
<li><code>alarm_api_timeout_total</code>：API 超时数量</li>
</ul>
<p>这个引擎的工作就是：</p>
<ol>
<li><strong>定时去 Prometheus 查询</strong>这些指标</li>
<li><strong>判断是否异常</strong>（比如错误数 &gt; 10）</li>
<li><strong>确认是真问题还是毛刺</strong>（持续一段时间才算）</li>
<li><strong>生成告警事件</strong>，记录下来，必要时发通知</li>
<li><strong>追踪告警状态</strong>：知道哪些问题还在，哪些已经恢复</li>
</ol>
<h4 data-id="heading-3">为什么需要这个引擎？</h4>
<p>Prometheus 自己只负责存指标，不管告警。它的原生告警功能 Alertmanager 太重，而且：</p>
<ul>
<li>无法细粒度控制告警生命周期</li>
<li>难以和业务系统集成</li>
<li>状态管理不够灵活</li>
</ul>
<p>所以需要自己做一个轻量级的告警引擎，完全控制从"指标异常"到"告警事件"的全过程。</p>
<hr/>
<h3 data-id="heading-4">二、整体架构：五个核心组件</h3>
<p>整个引擎分成五层，每层干一件事：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart LR
    A[Prometheus&lt;br/&gt;指标数据源] --&gt; B[Scheduler&lt;br/&gt;定时调度器]
    B --&gt; C[Evaluator&lt;br/&gt;规则评估器]
    C --&gt; D[AlertQueue&lt;br/&gt;事件队列]
    D --&gt; E[Workers&lt;br/&gt;消费处理]
    E --&gt; F[Database&lt;br/&gt;当前/历史告警]
    
    style A fill:#e1f5ff
    style C fill:#fff4e1
    style D fill:#ffe1f5
    style E fill:#e1ffe1
    style F fill:#f5e1ff
</code></pre>
<p><strong>各层职责：</strong></p>



































<table><thead><tr><th>组件</th><th>功能</th><th>为什么这样设计</th></tr></thead><tbody><tr><td><strong>Prometheus</strong></td><td>存储所有业务指标</td><td>作为唯一的事实来源，告警引擎只读不写</td></tr><tr><td><strong>Scheduler</strong></td><td>每隔 N 秒触发一次评估</td><td>定时轮询，简单可靠</td></tr><tr><td><strong>Evaluator</strong></td><td>执行 PromQL 判断是否异常</td><td>纯计算逻辑，不做 I/O，保证评估速度</td></tr><tr><td><strong>AlertQueue</strong></td><td>缓冲告警事件</td><td>解耦评估和处理，削峰填谷</td></tr><tr><td><strong>Workers</strong></td><td>写库、发通知、去重</td><td>异步处理重活，不拖慢评估</td></tr></tbody></table>
<p><strong>核心设计思想：评估和处理分离</strong></p>
<p>Evaluator 只管"算"，不管"写"。所有状态变化都变成事件，丢给队列慢慢处理。这样：</p>
<ul>
<li>评估永远很快，不会因为数据库慢而卡住</li>
<li>告警量暴增时，队列可以缓冲</li>
<li>后续要加通知、静默等功能，直接在 Worker 里加逻辑即可</li>
</ul>
<hr/>
<h3 data-id="heading-5">三、告警规则：定义"什么算异常"</h3>
<h4 data-id="heading-6">规则长什么样</h4>
<p>每条规则包含三个核心字段：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">type</span> AlertRule <span class="hljs-keyword">struct</span> {
    ID          <span class="hljs-type">uint64</span>    <span class="hljs-comment">// 规则ID</span>
    Name        <span class="hljs-type">string</span>    <span class="hljs-comment">// 规则名称，如"错误日志告警"</span>
    Expr        <span class="hljs-type">string</span>    <span class="hljs-comment">// PromQL 表达式</span>
    ForDuration <span class="hljs-type">uint</span>      <span class="hljs-comment">// 持续时间（秒），如 60 表示持续1分钟</span>
    Enabled     <span class="hljs-type">bool</span>      <span class="hljs-comment">// 是否启用</span>
}
</code></pre>
<p><strong>示例规则：</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">规则1:</span> <span class="hljs-string">错误日志告警</span>
  <span class="hljs-attr">Expr:</span> <span class="hljs-string">increase(alarm_log_error_total[1m])</span> <span class="hljs-string">&gt;</span> <span class="hljs-number">10</span>
  <span class="hljs-attr">ForDuration:</span> <span class="hljs-number">60</span><span class="hljs-string">秒</span>
  
<span class="hljs-string">规则2:</span> <span class="hljs-string">SQL异常告警</span>  
  <span class="hljs-attr">Expr:</span> <span class="hljs-string">alarm_sql_abnormal</span> <span class="hljs-string">==</span> <span class="hljs-number">1</span>
  <span class="hljs-attr">ForDuration:</span> <span class="hljs-number">0</span><span class="hljs-string">秒（立即告警）</span>
</code></pre>
<h4 data-id="heading-7">Prometheus 怎么配合工作？</h4>
<p>告警引擎不负责采集指标，它假设：</p>
<ol>
<li>你的应用已经通过 Exporter 或 SDK 把指标暴露给 Prometheus</li>
<li>Prometheus 已经在定时抓取这些指标</li>
<li>引擎只需要用 PromQL 去查询当前状态</li>
</ol>
<p><strong>数据流向：</strong></p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart LR
    A[应用/中间件] --&gt;|暴露指标| B[Prometheus Exporter]
    B --&gt;|scrape| C[Prometheus TSDB]
    C --&gt;|PromQL查询| D[告警引擎 Evaluator]
    
    style A fill:#e1f5ff
    style C fill:#fff4e1
    style D fill:#ffe1f5
</code></pre>
<p>这样分工的好处：</p>
<ul>
<li><strong>Prometheus 专注采集和存储</strong>：它做自己最擅长的事</li>
<li><strong>告警引擎专注判断和通知</strong>：不用管数据从哪来</li>
<li><strong>两者松耦合</strong>：换个时序库也不影响告警逻辑</li>
</ul>
<hr/>
<h3 data-id="heading-8">四、告警事件是怎么产生的？</h3>
<h4 data-id="heading-9">核心概念：Fingerprint</h4>
<p>一条告警对应的是"规则 + 特定标签组合"。比如：</p>
<pre><code class="hljs language-text" lang="text">规则: 错误日志告警
标签: {service="order", host="server-01"}

生成 Fingerprint: hash(rule_id + labels) = "abc123"
</code></pre>
<p><strong>为什么需要 Fingerprint？</strong></p>
<p>同一个规则可能命中多个实例：</p>
<ul>
<li><code>{service="order", host="server-01"}</code> 在告警</li>
<li><code>{service="order", host="server-02"}</code> 也在告警</li>
</ul>
<p>每个实例是独立的告警，需要单独追踪。Fingerprint 就是"告警实例"的唯一标识。</p>
<h4 data-id="heading-10">评估流程：从指标到事件</h4>
<p>每次评估做这几件事：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart LR
    A[1.执行 PromQL] --&gt; B[2.生成 Fingerprint]
    B --&gt; C[3.查询当前状态]
    C --&gt; D{4.是否首次命中?}
    D --&gt;|是| E[创建 pending]
    D --&gt;|否| F[更新计数和时间]
    E --&gt; G[5.判断持续时长]
    F --&gt; G
    G --&gt; H[6.推入队列]
    
    style A fill:#e1f5ff
    style C fill:#fff4e1
    style G fill:#ffe1f5
    style H fill:#e1ffe1
</code></pre>
<p><strong>伪代码（思想版）：</strong></p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">evaluateRule</span><span class="hljs-params">(rule AlertRule)</span></span> {
    <span class="hljs-comment">// 1. 查询 Prometheus，得到一批 time series</span>
    seriesList := queryPrometheus(rule.Expr)
    
    currentFingerprints := []<span class="hljs-type">string</span>{} <span class="hljs-comment">// 本轮命中的实例</span>
    
    <span class="hljs-keyword">for</span> _, series := <span class="hljs-keyword">range</span> seriesList {
        <span class="hljs-comment">// 2. 生成唯一标识</span>
        fp := hash(rule.ID + series.Labels)
        currentFingerprints.<span class="hljs-built_in">append</span>(fp)
        
        <span class="hljs-comment">// 3. 加载或创建告警状态</span>
        alert := loadOrCreate(fp)
        alert.TriggerCount++
        alert.LastTriggerAt = now()
        
        <span class="hljs-comment">// 4. 判断是否达到 for_duration</span>
        elapsed := now() - alert.FirstTriggerAt
        <span class="hljs-keyword">if</span> elapsed &gt;= rule.ForDuration &amp;&amp; alert.Status == <span class="hljs-string">"pending"</span> {
            alert.Status = <span class="hljs-string">"firing"</span>  <span class="hljs-comment">// 从观察期转为真正告警</span>
        }
        
        <span class="hljs-comment">// 5. 推入队列，交给 Worker 处理</span>
        queue.Push(alert)
    }
    
    <span class="hljs-comment">// 6. 恢复检测：本轮没命中的，视为已恢复</span>
    <span class="hljs-keyword">for</span> _, old := <span class="hljs-keyword">range</span> getCurrentAlerts(rule.ID) {
        <span class="hljs-keyword">if</span> !currentFingerprints.contains(old.Fingerprint) {
            moveToHistory(old)  <span class="hljs-comment">// 从 current 删除，写入 history</span>
        }
    }
}
</code></pre>
<p><strong>关键点：</strong></p>
<ul>
<li>Evaluator 不直接写数据库，只生成事件</li>
<li>所有 I/O 操作都在 Worker 里异步完成</li>
<li>评估速度快，不会被拖慢</li>
</ul>
<hr/>
<h3 data-id="heading-11">五、防抖动设计：如何避免误报？</h3>
<h4 data-id="heading-12">问题：网络抖动、偶发错误不该告警</h4>
<p>假设 API 偶尔超时一次，或者网络瞬间抖动，这种情况不该打扰人。需要一个机制来判断：<strong>这是真问题，还是毛刺？</strong></p>
<h4 data-id="heading-13">解决方案：for_duration 观察期</h4>
<p>告警分两个阶段：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart LR
    A[首次命中] --&gt; B[pending&lt;br/&gt;观察中]
    B --&gt;|持续 &gt;= for_duration| C[firing&lt;br/&gt;确认告警]
    C --&gt;|不再命中| D[resolved&lt;br/&gt;已恢复]
    
    style A fill:#e1f5ff
    style B fill:#fff4e1
    style C fill:#ffcccc
    style D fill:#ccffcc
</code></pre>
<p><strong>状态定义：</strong></p>

























<table><thead><tr><th>状态</th><th>含义</th><th>是否通知</th></tr></thead><tbody><tr><td><strong>pending</strong></td><td>观察中，可能是毛刺</td><td>否</td></tr><tr><td><strong>firing</strong></td><td>确认告警，真出问题了</td><td>是</td></tr><tr><td><strong>resolved</strong></td><td>已恢复</td><td>是（恢复通知）</td></tr></tbody></table>
<p><strong>实现细节：</strong></p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">type</span> CurrentAlert <span class="hljs-keyword">struct</span> {
    Fingerprint    <span class="hljs-type">string</span>    <span class="hljs-comment">// 唯一标识</span>
    Status         <span class="hljs-type">string</span>    <span class="hljs-comment">// pending / firing</span>
    FirstTriggerAt time.Time <span class="hljs-comment">// 第一次命中时间</span>
    LastTriggerAt  time.Time <span class="hljs-comment">// 最近一次命中时间</span>
    TriggerCount   <span class="hljs-type">int</span>       <span class="hljs-comment">// 总共命中几次</span>
}

<span class="hljs-comment">// 判断是否该从 pending 转 firing</span>
elapsed := now() - alert.FirstTriggerAt
<span class="hljs-keyword">if</span> elapsed &gt;= rule.ForDuration &amp;&amp; alert.Status == <span class="hljs-string">"pending"</span> {
    alert.Status = <span class="hljs-string">"firing"</span>
}
</code></pre>
<p><strong>举例：</strong></p>
<pre><code class="hljs language-text" lang="text">规则: increase(error_log[1m]) &gt; 10
ForDuration: 60秒

时间轴:
10:00:00 - 命中，创建 pending
10:00:15 - 命中，仍是 pending
10:00:30 - 命中，仍是 pending
10:01:00 - 命中，持续60秒 → 转为 firing，开始通知
10:01:15 - 命中，保持 firing
10:01:30 - 不再命中 → 转为 resolved，写入历史
</code></pre>
<p>这样就过滤掉了短暂的抖动，只有持续异常才会真正告警。</p>
<hr/>
<h3 data-id="heading-14">六、队列与消费：评估和处理的分离</h3>
<h4 data-id="heading-15">为什么要队列？</h4>
<p>如果 Evaluator 直接写数据库：</p>
<ul>
<li>数据库慢了，评估就慢了</li>
<li>数据库挂了，评估就卡住了</li>
<li>告警量暴增时，数据库压力大</li>
</ul>
<p>引入队列后：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart LR
    A[Evaluator&lt;br/&gt;快速计算] --&gt; B[AlertQueue&lt;br/&gt;缓冲区]
    B --&gt; C[Worker #1&lt;br/&gt;写库/通知]
    B --&gt; D[Worker #2&lt;br/&gt;写库/通知]
    B --&gt; E[Worker #3&lt;br/&gt;写库/通知]
    
    style A fill:#e1f5ff
    style B fill:#ffe1f5
    style C fill:#e1ffe1
    style D fill:#e1ffe1
    style E fill:#e1ffe1
</code></pre>
<p><strong>队列做了什么：</strong></p>
<ol>
<li>评估产生的告警事件先放到内存队列</li>
<li>多个 Worker 从队列消费，各自独立处理</li>
<li>队列满了也不会影响评估，最多丢弃部分事件</li>
</ol>
<p><strong>队列实现（简化版）：</strong></p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">type</span> AlertQueue <span class="hljs-keyword">struct</span> {
    ch <span class="hljs-keyword">chan</span> *CurrentAlert  <span class="hljs-comment">// Go 的 channel 天然支持队列</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(q *AlertQueue)</span></span> Push(alert *CurrentAlert) {
    <span class="hljs-keyword">select</span> {
    <span class="hljs-keyword">case</span> q.ch &lt;- alert:
        <span class="hljs-comment">// 推入成功</span>
    <span class="hljs-keyword">default</span>:
        <span class="hljs-comment">// 队列满了，丢弃或记录日志</span>
    }
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(q *AlertQueue)</span></span> Pop() &lt;-<span class="hljs-keyword">chan</span> *CurrentAlert {
    <span class="hljs-keyword">return</span> q.ch  <span class="hljs-comment">// Worker 直接从 channel 读取</span>
}
</code></pre>
<h4 data-id="heading-16">Worker 做什么？</h4>
<p>Worker 是消费者，负责所有"重活"：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">type</span> Worker <span class="hljs-keyword">struct</span> {
    queue *AlertQueue
    db    *Database
    dedup *DedupCache  <span class="hljs-comment">// 5分钟去重缓存</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(w *Worker)</span></span> Start() {
    <span class="hljs-keyword">for</span> alert := <span class="hljs-keyword">range</span> w.queue.Pop() {
        <span class="hljs-comment">// 1. 检查是否在去重窗口内</span>
        <span class="hljs-keyword">if</span> w.dedup.Contains(alert.Fingerprint) {
            <span class="hljs-keyword">continue</span>  <span class="hljs-comment">// 5分钟内重复的，直接跳过</span>
        }
        
        <span class="hljs-comment">// 2. 写入或更新 current_alerts 表</span>
        w.db.UpsertCurrentAlert(alert)
        
        <span class="hljs-comment">// 3. 如果是 firing，可以在这里发通知</span>
        <span class="hljs-keyword">if</span> alert.Status == <span class="hljs-string">"firing"</span> {
            sendNotification(alert)
        }
        
        <span class="hljs-comment">// 4. 加入去重缓存，5分钟内不再处理</span>
        w.dedup.Add(alert.Fingerprint)
    }
}
</code></pre>
<p><strong>为什么这样设计好？</strong></p>

























<table><thead><tr><th>好处</th><th>说明</th></tr></thead><tbody><tr><td><strong>解耦</strong></td><td>评估和处理互不影响</td></tr><tr><td><strong>削峰</strong></td><td>告警量暴增时队列缓冲</td></tr><tr><td><strong>可扩展</strong></td><td>Worker 数量可以动态调整</td></tr><tr><td><strong>容错</strong></td><td>某个 Worker 挂了不影响其他 Worker</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-17">七、5分钟去重：避免重复处理</h3>
<h4 data-id="heading-18">问题：高频指标会疯狂触发</h4>
<p>假设某个指标每 15 秒评估一次，一旦进入 firing 状态，每次评估都会命中。这意味着：</p>
<ul>
<li>每 15 秒就会推一次队列</li>
<li>每 15 秒就会写一次数据库</li>
<li>每 15 秒就会发一次通知</li>
</ul>
<p>这完全没必要，浪费资源还烦人。</p>
<h4 data-id="heading-19">解决方案：时间窗口去重</h4>
<p>在 Worker 层加一个简单的缓存：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">type</span> DedupCache <span class="hljs-keyword">struct</span> {
    m   <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]time.Time  <span class="hljs-comment">// fingerprint -&gt; 过期时间</span>
    mu  sync.RWMutex
    ttl time.Duration          <span class="hljs-comment">// 5分钟</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *DedupCache)</span></span> Contains(fp <span class="hljs-type">string</span>) <span class="hljs-type">bool</span> {
    c.mu.RLock()
    expireAt, exists := c.m[fp]
    c.mu.RUnlock()
    
    <span class="hljs-keyword">if</span> !exists {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
    }
    <span class="hljs-keyword">return</span> time.Now().Before(expireAt)  <span class="hljs-comment">// 还没过期</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *DedupCache)</span></span> Add(fp <span class="hljs-type">string</span>) {
    c.mu.Lock()
    c.m[fp] = time.Now().Add(c.ttl)  <span class="hljs-comment">// 当前时间 + 5分钟</span>
    c.mu.Unlock()
}
</code></pre>
<p><strong>工作流程：</strong></p>
<pre><code class="hljs language-text" lang="text">10:00:00 - alert_abc 首次进入 Worker
           检查缓存：不存在
           处理：写库、发通知
           加入缓存：过期时间 = 10:05:00

10:00:15 - alert_abc 再次进入 Worker
           检查缓存：存在，且未过期
           跳过处理

10:00:30 - alert_abc 再次进入 Worker
           检查缓存：存在，且未过期
           跳过处理

... (中间所有重复都被跳过)

10:05:01 - alert_abc 再次进入 Worker
           检查缓存：已过期
           处理：写库、更新时间
           刷新缓存：过期时间 = 10:10:01
</code></pre>
<p><strong>两层防抖的配合：</strong></p>




















<table><thead><tr><th>机制</th><th>作用阶段</th><th>解决的问题</th></tr></thead><tbody><tr><td><strong>for_duration</strong></td><td>评估阶段</td><td>防止毛刺，pending → firing 需要持续时间</td></tr><tr><td><strong>5分钟去重</strong></td><td>消费阶段</td><td>防止重复，firing 状态下避免频繁写库/通知</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-20">八、当前告警 vs 历史告警：状态迁移</h3>
<h4 data-id="heading-21">两张表的职责</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart LR
    A[规则命中] --&gt; B[current_alerts&lt;br/&gt;当前告警表]
    B --&gt; C{下轮还命中?}
    C --&gt;|是| B
    C --&gt;|否| D[history_alerts&lt;br/&gt;历史告警表]
    
    style B fill:#ffcccc
    style D fill:#cccccc
</code></pre>




















<table><thead><tr><th>表名</th><th>存什么</th><th>什么时候写入</th></tr></thead><tbody><tr><td><strong>current_alerts</strong></td><td>正在发生的告警</td><td>规则命中时创建/更新</td></tr><tr><td><strong>history_alerts</strong></td><td>已结束的告警</td><td>不再命中时从 current 迁移过来</td></tr></tbody></table>
<p><strong>current_alerts 的记录：</strong></p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">type</span> CurrentAlert <span class="hljs-keyword">struct</span> {
    Fingerprint    <span class="hljs-type">string</span>    <span class="hljs-comment">// 唯一标识</span>
    RuleID         <span class="hljs-type">uint64</span>    <span class="hljs-comment">// 属于哪条规则</span>
    Status         <span class="hljs-type">string</span>    <span class="hljs-comment">// pending / firing</span>
    FirstTriggerAt time.Time <span class="hljs-comment">// 首次触发时间</span>
    LastTriggerAt  time.Time <span class="hljs-comment">// 最近触发时间</span>
    TriggerCount   <span class="hljs-type">int</span>       <span class="hljs-comment">// 触发次数</span>
    Labels         <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">string</span>  <span class="hljs-comment">// 标签</span>
    Value          <span class="hljs-type">float64</span>   <span class="hljs-comment">// 当前值</span>
}
</code></pre>
<p><strong>history_alerts 的记录：</strong></p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">type</span> HistoryAlert <span class="hljs-keyword">struct</span> {
    Fingerprint    <span class="hljs-type">string</span>
    RuleID         <span class="hljs-type">uint64</span>
    StartAt        time.Time  <span class="hljs-comment">// 开始时间（= FirstTriggerAt）</span>
    EndAt          time.Time  <span class="hljs-comment">// 结束时间（= 最后评估时间）</span>
    Duration       <span class="hljs-type">int</span>        <span class="hljs-comment">// 持续时长（秒）</span>
    TriggerCount   <span class="hljs-type">int</span>        <span class="hljs-comment">// 总共触发几次</span>
    Labels         <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">string</span>
}
</code></pre>
<h4 data-id="heading-22">状态迁移：如何判断"已恢复"？</h4>
<p>每次评估后，引擎会做恢复检测：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">evaluateRule</span><span class="hljs-params">(rule AlertRule)</span></span> {
    <span class="hljs-comment">// ... 前面的评估逻辑</span>
    
    <span class="hljs-comment">// 收集本轮命中的所有 fingerprint</span>
    currentFPs := []<span class="hljs-type">string</span>{}
    <span class="hljs-keyword">for</span> _, series := <span class="hljs-keyword">range</span> seriesList {
        fp := hash(rule.ID + series.Labels)
        currentFPs.<span class="hljs-built_in">append</span>(fp)
        <span class="hljs-comment">// ... 处理这条告警</span>
    }
    
    <span class="hljs-comment">// 遍历该规则下所有当前告警</span>
    <span class="hljs-keyword">for</span> _, existing := <span class="hljs-keyword">range</span> db.GetCurrentAlerts(rule.ID) {
        <span class="hljs-comment">// 如果某个 fingerprint 在本轮没出现，说明已恢复</span>
        <span class="hljs-keyword">if</span> !currentFPs.contains(existing.Fingerprint) {
            <span class="hljs-comment">// 1. 写入 history_alerts</span>
            db.InsertHistory(HistoryAlert{
                Fingerprint:  existing.Fingerprint,
                RuleID:       existing.RuleID,
                StartAt:      existing.FirstTriggerAt,
                EndAt:        now(),
                Duration:     now() - existing.FirstTriggerAt,
                TriggerCount: existing.TriggerCount,
                Labels:       existing.Labels,
            })
            
            <span class="hljs-comment">// 2. 从 current_alerts 删除</span>
            db.DeleteCurrent(existing.Fingerprint)
        }
    }
}
</code></pre>
<p><strong>核心思想：缺席即恢复</strong></p>
<p>不需要额外判断"恢复条件"，只要本轮评估中某个告警实例没出现，就认为已经恢复了。这种设计：</p>
<ul>
<li>简单直接，不需要额外状态机</li>
<li>自动处理恢复，不需要定时扫描</li>
<li>和评估逻辑天然融合</li>
</ul>
<p><strong>举例说明：</strong></p>
<pre><code class="hljs language-text" lang="text">时间线:
10:00 - 规则命中 {host="server-01"}
        创建 current_alerts 记录

10:01 - 规则命中 {host="server-01"}
        更新 current_alerts（TriggerCount++）

10:02 - 规则命中 {host="server-01"}
        更新 current_alerts

10:03 - 规则不再命中（指标恢复正常）
        本轮 fingerprints = []（空）
        发现 {host="server-01"} 缺席
        → 写入 history_alerts
        → 删除 current_alerts
</code></pre>
<hr/>
<h3 data-id="heading-23">九、整体流程总结</h3>
<p>把所有环节串起来：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TD
    A[Scheduler: 每15秒触发] --&gt; B[Evaluator: 执行 PromQL]
    B --&gt; C{规则是否命中?}
    C --&gt;|否| D[本轮无告警]
    C --&gt;|是| E[生成 Fingerprint]
    E --&gt; F{是否首次命中?}
    F --&gt;|是| G[创建 pending]
    F --&gt;|否| H[更新计数/时间]
    G --&gt; I{持续 &gt;= for_duration?}
    H --&gt; I
    I --&gt;|否| J[保持 pending]
    I --&gt;|是| K[转为 firing]
    J --&gt; L[推入 AlertQueue]
    K --&gt; L
    L --&gt; M[Worker: 从队列消费]
    M --&gt; N{5分钟内重复?}
    N --&gt;|是| O[跳过]
    N --&gt;|否| P[写入 current_alerts]
    P --&gt; Q{下轮还命中?}
    Q --&gt;|是| A
    Q --&gt;|否| R[迁移到 history_alerts]
    
    style B fill:#e1f5ff
    style E fill:#fff4e1
    style K fill:#ffcccc
    style M fill:#e1ffe1
    style R fill:#cccccc
</code></pre>
<p><strong>各阶段职责：</strong></p>
<ol>
<li><strong>Scheduler</strong>：按固定间隔触发评估</li>
<li><strong>Evaluator</strong>：查询 Prometheus，计算状态变化</li>
<li><strong>Fingerprint</strong>：标识每个告警实例</li>
<li><strong>pending/firing</strong>：区分观察期和确认告警</li>
<li><strong>AlertQueue</strong>：缓冲事件，削峰填谷</li>
<li><strong>Worker</strong>：异步处理，写库、去重、通知</li>
<li><strong>current/history</strong>：区分当前问题和历史记录</li>
</ol>
<hr/>
<h3 data-id="heading-24">十、这个设计好在哪里？</h3>
<h4 data-id="heading-25">1. 职责清晰，分层明确</h4>



































<table><thead><tr><th>层级</th><th>只做一件事</th><th>好处</th></tr></thead><tbody><tr><td>Prometheus</td><td>存指标</td><td>专业的事交给专业的工具</td></tr><tr><td>Evaluator</td><td>纯计算</td><td>评估速度快，不被 I/O 拖累</td></tr><tr><td>Queue</td><td>缓冲</td><td>削峰填谷，容错能力强</td></tr><tr><td>Worker</td><td>重活</td><td>异步处理，可以慢慢来</td></tr><tr><td>Database</td><td>持久化</td><td>状态可追溯，支持查询</td></tr></tbody></table>
<h4 data-id="heading-26">2. 防抖动做得优雅</h4>
<p>两层防抖配合：</p>
<ul>
<li><strong>for_duration</strong>：防毛刺，观察期后才确认</li>
<li><strong>5分钟去重</strong>：防重复，避免疯狂写库</li>
</ul>
<p>既不误报，也不扰民。</p>
<h4 data-id="heading-27">3. 状态迁移自然</h4>
<p>不需要额外的"恢复检测"逻辑：</p>
<ul>
<li>命中 → 在 current 里</li>
<li>不命中 → 自动迁移到 history</li>
</ul>
<p>"缺席即恢复"是最简单的设计。</p>
<h4 data-id="heading-28">4. 易扩展</h4>
<p>想加新功能，只需要：</p>
<ul>
<li>加规则：在规则表里插一条</li>
<li>加通知：在 Worker 里加逻辑</li>
<li>加静默：在 Worker 里加判断</li>
<li>加多数据源：扩展 Evaluator 支持其他查询接口</li>
</ul>
<p>核心架构不用动。</p>
<h4 data-id="heading-29">5. 性能好</h4>
<ul>
<li>评估是纯内存计算，每秒可以处理成百上千条规则</li>
<li>队列异步处理，数据库慢了也不影响评估</li>
<li>Worker 可以水平扩展，告警量大了加机器就行</li>
</ul>
<hr/>
<h3 data-id="heading-30">十一、适用场景与局限</h3>
<h4 data-id="heading-31">适合什么场景？</h4>
<ol>
<li><strong>中小规模监控</strong>：几百到几千条规则</li>
<li><strong>对接 Prometheus</strong>：已有 Prometheus 作为时序库</li>
<li><strong>需要精细控制</strong>：想自己管理告警生命周期</li>
<li><strong>要和业务系统集成</strong>：比如推送到自己的工单系统</li>
</ol>
<h4 data-id="heading-32">不适合什么场景？</h4>
<ol>
<li><strong>超大规模</strong>：上万条规则，几十万个告警实例
<ul>
<li>需要做分布式评估，单机扛不住</li>
</ul>
</li>
<li><strong>多数据源</strong>：不只是 Prometheus，还有 InfluxDB、MySQL 等
<ul>
<li>需要扩展 Evaluator 支持多种查询接口</li>
</ul>
</li>
<li><strong>复杂告警逻辑</strong>：比如多指标关联、机器学习预测
<ul>
<li>需要更强大的规则引擎</li>
</ul>
</li>
</ol>
<p>但这个内核设计很灵活，扩展起来不难。</p>
<hr/>
<h3 data-id="heading-33">十二、总结</h3>
<p>这个告警引擎虽然小，但该有的都有：</p>
<p><strong>核心功能：</strong></p>
<ul>
<li>从 Prometheus 指标到告警事件的完整流程</li>
<li>防抖动设计（for_duration + 5分钟去重）</li>
<li>告警生命周期管理（pending → firing → resolved）</li>
<li>当前/历史状态分离</li>
</ul>
<p><strong>设计亮点：</strong></p>
<ul>
<li>评估和处理分离，队列解耦</li>
<li>状态迁移简单，缺席即恢复</li>
<li>易扩展，加功能不需要改架构</li>
</ul>
<p><strong>实现简洁：</strong></p>
<ul>
<li>没有复杂的状态机</li>
<li>没有臃肿的抽象</li>
<li>代码量小，易维护</li>
</ul>
<p>这就是一个优雅的告警引擎内核该有的样子：<strong>简单、清晰、好用</strong>。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI浪潮下，前端的路在何方，附前端转KMP实践]]></title>    <link>https://juejin.cn/post/7587675443442417704</link>    <guid>https://juejin.cn/post/7587675443442417704</guid>    <pubDate>2025-12-26T03:00:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587675443442417704" data-draft-id="7587671647399870504" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI浪潮下，前端的路在何方，附前端转KMP实践"/> <meta itemprop="keywords" content="前端,AI编程"/> <meta itemprop="datePublished" content="2025-12-26T03:00:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="qiyue77"/> <meta itemprop="url" content="https://juejin.cn/user/2242659450881991"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI浪潮下，前端的路在何方，附前端转KMP实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2242659450881991/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    qiyue77
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T03:00:28.000Z" title="Fri Dec 26 2025 03:00:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读21分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">一、本文主题</h3>
<p><strong>本篇为第二篇，依托于AI，无学习基础前端转KMP开发</strong>，主要针对前端发展展望，实践，和思考进行讲解。其中包含前端转KMP开发，并最终将项目如期落地。</p>
<p>篇一</p>
<p><a href="https://juejin.cn/post/7580288235030216704" target="_blank" title="https://juejin.cn/post/7580288235030216704">juejin.cn/post/758028…</a></p>
<p>篇二</p>
<ul>
<li>展望：介绍AI对前端职业的影响和变革，以及对自身学习成长的影响</li>
<li>实践：依托于AI，实现无学习周期的，前端转KMP跨端</li>
<li>思考：未来研发团队新形态的探索和思考</li>
</ul>
<h3 data-id="heading-1">二、行业发展，展望总结性观点</h3>
<p>从语言热度趋势，框架/工具发展，浏览器发展，AI工具支持，跨端演变，学习模式变革等方面，分析前端发展和未来展望</p>
<h4 data-id="heading-2">总结性观点</h4>
<ul>
<li>
<p>从AI在编程语言支持能力情况，<strong>前端和AI有非常强的融合能力，必然会走向人机协同模式</strong>。同时拥抱具有类型安全性的TS已是必然趋势。有机遇也有风险，传统开发者逐步转变为AI人机协同研发。<strong>vibe coding，大模型善后工程师，AI 80分危机等，新兴用词出现，也预示着这一变革的推进，编码方式转变正在发生</strong>。</p>
</li>
<li>
<p>前端在视觉展现上，具有代码体量小，依赖少，适配性强（web/pc/android/iOS均可渲染）的特性，<strong>HTML+CSS或HTMX渲染的具有动态和交互行动的视觉文档，未来会有更大的发展空间，既能很好的适配AI认知理解，又能呈现良好的视觉</strong>，未来对PPT必然产生强有力的冲击。（不妨在知识库随心搭试试，比PPT效果好）</p>
</li>
<li>
<p>前端工程体量逐渐庞大，<strong>开发阶段效率和性能问题</strong>已然摆到开发者面前；AIGC的快速发展，<strong>浏览器将承接更多复杂场景，视频编辑、设计工具（Figma）、3D引擎</strong>等。基于Rust工具链建设和Rust+Wasm在浏览器中实现原生性能，快速崛起。前端工程和浏览器将依托Rust的性能优势，组合出更复杂的工具和业务场景。</p>
</li>
<li>
<p>谷歌浏览重大更新，DevTools 深度集成 Gemini，Chrome DevTools 不仅仅是检查器，它正在变成一个 AI 编程助手，WebGPU 全面铺开：Chrome 121 起支持 Android WebGPU。意味着浏览器中的 AI 推理Transformers.js、3D 渲染和视频编码现在可以直接调用 GPU 底层架构。Wasm 内存升级： WebAssembly 现在支持大于 4GB 的内存寻址，可以处理更加的大型 3D 工程（AutoDesk Web、Adobe 全家桶）</p>
</li>
<li>
<p>AI原生IDE和AI插件和Code CLI，当前三分天下，原生IDE快速崛起，Cursor领头，国内外多家大厂开始意识到IDE集成化的优势和价值。AI插件仍是用户基数最大的选择，也是起步早，范围广的AI辅助方式。Code CLI在专业开发者中获得认可，非常切合研发使用。AI编程已是全方向展开。<strong>未来原生IDE成为主流选择，AI插件转向垂直（安全、部署、工具），Code CLI与DevOps深度融合</strong></p>
</li>
<li>
<p>国内移动生态三分天下是必然趋势，<strong>政策与产品影响，鸿蒙将登上舞台</strong>。穿戴设备，车机系统（新能源覆盖）各类智能化产品，使跨端在国内将更快，更广展开。企业适配鸿蒙，研发成本等因素，将推进跨端发展。<strong>相信国内在压缩人力/降本增效方面会有显著且卓越的进展。</strong></p>
</li>
<li>
<p>学习与产出并行推进，AI辅助下的软件职能边界逐渐模糊，<strong>软性的(AI辅助)全栈/大前端角色逐渐增多</strong>，企业内部<strong>相近角色协调转换，能代来更灵活/快速的需求响应</strong>，产品研发效率进一步提升。</p>
</li>
</ul>
<h3 data-id="heading-3">三、行业发展，展望展开</h3>
<h4 data-id="heading-4">3.1 先看趋势语言</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4d8639ec29ff4fec9e0821bb8f09ca0e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcWl5dWU3Nw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767322856&amp;x-signature=Y61msC4sB%2F51FtpiFyY9pnq8Z%2BA%3D" alt="" loading="lazy"/></p>
<p>2024年，Python 大热荣登桂冠，JS/TS分别居于第二，第三。这么多年JS首次退下神坛，<strong>对于前端来说这就是最明显的信号</strong>。</p>
<p>从上面的数据，结合当下行业发展，我们可以展望几点内容。</p>
<ul>
<li>AI的发展，确实推进了Python的进一步发展，它更偏向于专业人士的工具，Python面向开发者，与JS不同，JS面向用户。</li>
<li>JS虽然离开了王座，但是TS持续崛起，分流了JS的同时，也说明<strong>拥抱具有类型安全性的TS已是必然趋势</strong></li>
<li>在github上排名靠前编程语言，拥有大量开源代码和社区贡献，<strong>是AI训练的核心素材</strong>，因此AI编程支持更好</li>
<li>如果将这个年度榜单的编程语言交给AI，让其分析AI Coding 对编程语言支持情况，进行梯队划分，<strong>第一梯队一定有Python/JS/TS</strong>。</li>
</ul>

<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 你去问问AI</span>

Python,JavaScript,TypeScript,Java,C<span class="hljs-meta">#,C++,PHP,Shell,C,Go</span>

将上面这些编程语言，根据LLM编程能力支持情况，划分三个梯队，进行总结分析。
</code></pre>
<h4 data-id="heading-5">3.2 再看框架/工具</h4>
<h5 data-id="heading-6">3.2.1 框架发展趋势</h5>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/81cc954cf5024e048898f858908de00b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcWl5dWU3Nw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767322856&amp;x-signature=d3nmyc%2FjfvUFFbx72d30qE2IQvc%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c611ed14f61c4091a6c0fca6dade7dd7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcWl5dWU3Nw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767322856&amp;x-signature=FWkch7yn%2BB8VzgxUz8qm6McTmS8%3D" alt="" loading="lazy"/></p>
<p><strong>四大框架 React、Vue、Angular、Svelte</strong></p>
<ul>
<li>
<p>核心四大框架 React、Vue、Angular 和 Svelte。React 框架一骑绝尘，遥遥领先于其他三个框架。Vue 框架则处于第二的位置。Svelte 已超过 Angular</p>
</li>
<li>
<p>四大主流框架，保持的稳定更新迭代，短时间内，前端主流框架技术不会大变革，<strong>掌握React、Vue和基础JS/CSS/HTML，搭配AI这位老师</strong>，能应对前端绝大多数基础工作。</p>
</li>
</ul>
<h5 data-id="heading-7">3.2.2 全新形式HTMX库</h5>
<ul>
<li>
<p>htmx在GitHub上，star数在近两年内飙升，多次登顶 GitHub Trending 榜单。甚至被许多资深开发者视为解决“过度工程“的良药。</p>
</li>
<li>
<p>新全栈架构，htmx 极大利好非JavaScript背景的后端开发者，Go/Rust/Python + htmx这类组合非常流行。构建响应极快的 Web 应用。</p>
</li>
<li>
<p>企业内部生态，轻量级后台的首选，对于企业内部管理系统、CRUD（增删改查）类应用，htmx 的开发效率极高</p>
</li>
<li>
<p>性能优势，省去了客户端渲染（CSR）解析 JSON 并生成 DOM 的过程，htmx 在低端设备上的首屏渲染和交互响应往往更快。</p>
</li>
<li>
<p><strong>拥抱 AI，通过htmx，AI可以一次性生成带有交互逻辑的HTML，极大缩短了从 Prompt 到可运行原型的路径。</strong></p>
</li>
</ul>
<h5 data-id="heading-8">3.2.3 工具发展趋势</h5>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a8db1e6a6a4740ab9eb3c0fbde26a955~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcWl5dWU3Nw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767322856&amp;x-signature=lXavmWyKqAGPvsi0YxAgp0oFtAQ%3D" alt="" loading="lazy"/></p>
<p>Rust 是最受推崇的编程语言，今年的得分为 83%。前端基础建设，<strong>工具链的重构，Rust 化愈演愈烈</strong>，带来极致的开发性能体验。</p>
<p>浏览器运行时的变革，<strong>Rust 是编译为 WebAssembly 的最佳语言</strong>，使得前端能够承担以前无法想象的任务</p>
<p><strong>对前端开发的深远影响</strong></p>
<ul>
<li>
<p>Vite6、Rspack、Oxlint、Biome 和 Rolldown。利用 Rust 的特性，极大的提升编译速度</p>
</li>
<li>
<p>视频编辑、设计工具（Figma）、3D 引擎等，通过 Rust + Wasm 在浏览器中实现原生性能。<strong>AI浪潮下，前端必将承接更多视频/图片编辑能力（人脸识别/大模型嵌入/图形算法处理），以及更负责的大型任务。</strong></p>
</li>
<li>
<p>性能组件化：开发者开始在 React/Vue 应用中嵌入 Rust 编写的性能敏感组件（如复杂的加密算法、图像处理、大数据量计算）</p>
</li>
</ul>
<p><strong>行业渗透率持续攀升</strong></p>
<p>根据 2025 年的市场调查，在商业用途中使用 Rust 的比例较三年前增长了近 70%。成为微软、亚马逊和 Google 构建核心基础设施的首选。</p>
<p><strong>AI 浪潮下的性能基石</strong></p>
<p>AI 模型推理和大规模数据处理对性能要求极高。越来越多的 AI 基础设施（如向量数据库、推理引擎）开始使用 Rust 重写，利用其零成本抽象和无垃圾回收 (GC) 的内存管理特性</p>
<h4 data-id="heading-9">3.3 三看浏览器发展</h4>
<p><strong>性能指标更替</strong>：INP 正式取代 FID。性能依旧是用户体验的真理</p>
<ul>
<li>2024 年 3 月起，INP (Interaction to Next Paint) 正式取代 FID 成为 Core Web Vitals 的三大指标之一</li>
</ul>
<p><strong>工具链的AI原生化</strong>：DevTools 深度集成 Gemini，Chrome DevTools 不仅仅是检查器，它正在变成一个 AI 编程助手</p>
<ul>
<li>
<p>AI 解释与诊断，在Console中，你可以点击“理解此错误”，Gemini 会自动分析报错、查找 MDN 文档并给出修复建议。</p>
</li>
<li>
<p>AI 样式调试，在 Elements 面板中，开发者可以利用 AI 辅助生成 CSS 样式或解释复杂的层叠逻辑。</p>
</li>
</ul>
<p><strong>Web平台算力解放</strong>：WebGPU 与 Wasm 增强，Chrome 完成了从“网页浏览”向“复杂计算平台”的转型。</p>
<ul>
<li>
<p>WebGPU 全面铺开：Chrome 121 起支持 Android WebGPU。意味着浏览器中的 AI 推理Transformers.js、3D 渲染和视频编码现在可以直接调用 GPU 底层架构。</p>
</li>
<li>
<p>Wasm 内存升级： WebAssembly 现在支持大于 4GB 的内存寻址，可以处理更加的大型 3D 工程（AutoDesk Web、Adobe 全家桶）</p>
</li>
</ul>
<p><strong>CSS 与 DOM 的新范式</strong>：CSS 的编写习惯在这一两年发生了翻天覆地的变化</p>
<ul>
<li>
<p>CSS Nesting (原生嵌套)： 2024 年起 Chrome 对原生 CSS 嵌套提供了极其稳定的 DevTools 支持。你可能不再需要 Sass 来处理层级。</p>
</li>
<li>
<p>Anchor Positioning (锚点定位)：允许 Tooltip 或弹出菜单直接在 CSS 中关联其触发元素，无需 JS 库进行实时位置计算。</p>
</li>
<li>
<p>Scroll-driven Animations： 仅靠 CSS 即可实现极其复杂的视差滚动或进度条动画，无需再监听 onscroll 事件</p>
</li>
</ul>
<h4 data-id="heading-10">3.4 四看AI工具支持</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dae2114fd37e4b508d3f80522b07a46a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcWl5dWU3Nw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767322856&amp;x-signature=tVf3cEH2kt4vatRBIcVodNKX%2FYc%3D" alt="" loading="lazy"/></p>
<p>AI 在编程领域的工具和 IDE 支持已经从简单的“代码补全”进化到了 <strong>“代理式（Agentic）开发”</strong> 和 <strong>“自然语言全栈构建”</strong> 的阶段，几乎所有的IDE都支持AI能力，且2025的能力更新也都围绕AI升级。</p>
<p><strong>编程环境变革，IDE 代理化</strong></p>
<ul>
<li>
<p>传统的 IDE（VS Code）正在被“AI 原生 IDE”挑战，或者通过深度集成实现自我革新</p>
</li>
<li>
<p>Cursor领跑者，已经实现多文件协同修改。MCP工具爆发（context7，brower mcp，playwright mcp，Figma mcp等），允许 IDE 连接外部工具（如文档、API、终端），让 AI 具备读取你实时文档库的能力。</p>
</li>
<li>
<p>GitHub Copilot Workspace，从 GitHub Issue 直接生成“开发计划”，并在云端沙盒中完成代码编写、运行测试和提交 PR，前端开发者更少写代码，更多审核代码，<strong>角色发生转变</strong></p>
</li>
<li>
<p>Gemini in DevTools， Chrome 控制台直接集成了 Gemini，能够实时解释前端报错</p>
</li>
</ul>
<p><strong>Vibe Coding从对话到完整应用</strong></p>
<p>2025 年前端开发出现了一个新词Vibe Coding（氛围感编程），通过自然语言描述“氛围”和“功能”，由 AI 生成预览并完成部署</p>
<ul>
<li>
<p>各个大厂都在推进Vibe Coding，从年初被提出，到现在各类架构实践知识，无疑都是针对 AI Coding和开发者人机协同模式的探索。也是对效率的提升的全新展开。</p>
</li>
<li>
<p>v0.dev 输入一段话或上传一张设计图，它会直接生成生产级别的代码。</p>
</li>
<li>
<p>Bolt.new / Lovable浏览器内的全栈 IDE，这些工具可以在浏览器里直接运行 Node.js 环境。</p>
</li>
<li>
<p><strong>从早期如何写出好的Prompt；到如何在IDE中利用AI提效；再到通过"Prompt + Review" 或 "SPEC" 模式管理 AI Agent，以及更加复杂的通过知识图谱或RAG结合向量数据库，进行记忆管理等等，都在让AI Coding变成体系化的开发模式</strong>，使其生成代码快速集成到现有的大型系统中。</p>
</li>
</ul>
<p><strong>Agentic Frontend（代理式前端）架构</strong></p>
<p>AI生成的年度总结，漂亮的排版，无需配色，找模版，调样式。AI更能好的理解文件形式。（<strong>该能力为公司内部功能，外部具有相同能力平台，可用秒搭</strong>）</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4962fec3b3254a04bf7ccc7d4dee80ad~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcWl5dWU3Nw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767322856&amp;x-signature=OLF7%2Bpn0dfsi5xp2l34I0aXMHAU%3D" alt="" loading="lazy"/></p>
<p>AI 不仅写代码，还在变成代码的一部分。</p>
<ul>
<li>
<p>A2UI (Agent-to-UI)：这是一个 2025 年兴起的协议。它允许 AI Agent 根据用户的意图，实时生成动态 UI。AI 不再只是回一段文字，而是返回更加丰富多彩的展现形式。</p>
</li>
<li>
<p>CopilotKit：让前端开发者能快速给自己的APP增加AI助手。它能让AI感知你页面上的状态，并允许用户通过语音/文本直接操作你的网页组件。</p>
</li>
</ul>
<h4 data-id="heading-11">3.5 五看跨端演变</h4>
<p><strong>国内特例，鸿蒙必行</strong></p>
<ul>
<li>
<p>政策压力也好，还是国内市场环境也罢，华为鸿蒙早晚都是必经之路，未来国内三分天下，单启一职鸿蒙研发，目前看下下策，跨端才是根本。</p>
</li>
<li>
<p>鸿蒙给出了前端友好型的TS模式，同时也非常巧妙的切合了AI能力支持（AI对TS支持良好），未来AI+artTS也许会有不一样发展。</p>
</li>
</ul>
<p><strong>经济下行，成本为王</strong></p>
<ul>
<li>全球经济背景下，成本控制是企业的生存关键。根据 Neontri 的 2025 报告，跨端开发平均能降低 40% 的成本并缩短 70% 的开发周期。</li>
</ul>
<p><strong>性能天花板降低</strong></p>
<ul>
<li>手机硬件性能过剩，现代手机芯片的算力已经足够抹平框架带来的微小开销。</li>
</ul>
<p><strong>市场碎片化和多样化</strong></p>
<ul>
<li>
<p>多端一致性： 手机、平板、桌面、车机系统、甚至穿戴设备上保持 UI/UX 的一致。</p>
</li>
<li>
<p>国内两大手机厂商，入住汽车行业，结合两大厂商的营销风格，电车的市场销量，和用户的实际需求，车技系统也会有更多的应用发展。</p>
</li>
</ul>
<p><strong>AI浪潮下的全新机会</strong></p>
<ul>
<li>
<p>更适合 AI 生成，跨端代码（TS/JS/Dart）拥有庞大的开源社区数据。相比于Swift/Kotlin 混合开发，AI 在生成跨端代码时的准确率更高</p>
</li>
<li>
<p>AI带来的快速实践，落地机会，AI让开发者学习成本和开发效率发生实质性的变革，相比传统的 <strong>“先学习，在开发”</strong> 的模式，AI协同下，可以 <strong>“同时进行学习和开发”</strong></p>
</li>
</ul>
<h4 data-id="heading-12">3.6 六看学习模式</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3ab20e44f24d487d8266d6244aad007e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcWl5dWU3Nw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767322856&amp;x-signature=cxwE9vpwUyvUpvsYfLghl24qapE%3D" alt="" loading="lazy"/></p>
<p>AI浪潮下，编程领域的学习模式绝对是翻天覆地的变化，传统的<strong>学文档 =&gt; 学视频 =&gt; 写demo =&gt; 做测试验证</strong>，流程长，成本高。更多人选择了AI生成工具/应用辅助学习。</p>
<p>AI辅助下，整个学习过程到验证效果，完全可以AI辅助生成。验证通过后，<strong>再由AI总结知识点，记忆练习后一个学习周期完成</strong>。</p>
<p>只要你做好核心的学习思维导图（知识树），学习效率极大的提升，学习中的问题，均可交给AI老师解答，全部过程无需法付费，无需大量学习时间成本。</p>
<h3 data-id="heading-13">四、前端转KMP实践</h3>
<h4 data-id="heading-14">4.1 实践的硬性条件</h4>
<p>虽然我非常认可AI能力，但是团队中如果完全没有具有KMP开发经验的人，<strong>那一定不要直接排期需求迭代</strong>，必须要有一版从环境搭建到构建产出，并上线验证的Demo。这样能极大的避免环境，工程带来的时间不可控性。</p>
<ul>
<li>必须有KMP开发经验的研发和一版验证过的Dmeo能力。</li>
</ul>
<h4 data-id="heading-15">4.2 转换实践经验</h4>
<h5 data-id="heading-16">目标</h5>
<ol>
<li>没有KMP经验和实践</li>
<li>没有独立学习时间</li>
<li>前端常规迭代和反馈问题穿插进行</li>
<li>前端用KMP完成40天的需求开发</li>
<li>最终整体人力采用1.5倍（60天）计算评估。</li>
</ol>
<h5 data-id="heading-17">期间难点</h5>
<ol>
<li>工期时间的评估</li>
<li>大量的知识和名词</li>
<li>思维认知方式</li>
<li>学习成本与需求进度</li>
<li>如何总结沉淀，融汇贯通</li>
</ol>
<ul>
<li>
<p>针对工期评估，一般是采用1.5人力方案计算，即前端1天需要，KMP需要1.5天，相当于增加一些Buffer处理学习，未知内容和环境问题等。<strong>但我可以明确的说，前端没有提前学习足够的知识，1.5并不够。</strong> 那时间怎么来的？AI结余出来的。</p>
</li>
<li>
<p><strong>前端相比Native转KMP，要额外学习知识和概念</strong>，文件存储体系/数据库操作/多线程开发/崩溃问题/双端的环境常识（Native只需要学一端，安卓甚至无需，天然适配KMP）</p>
</li>
<li>
<p>KMP更接近Native，相比前端更复杂，<strong>思维转变非常关键</strong>，前端从不需要考虑相册权限/数据隐私/iOS沙盒等，如果长期使用JS弱类型约束，前端开发更为松散。<strong>因此FE开在初期会感觉约束，不变，不可理喻的费事</strong>。</p>
</li>
<li>
<p>学习成本与需求进度，如果一个整个需求持续半年，再配合1.5倍人力关系，那没有AI可能也正常完成（120+60=180也就是说有60天可以用来学习处理异常问题）。但如果只有2个月那是万万不能的（40+20=60也就是说只有20天学习和处理异常时间）。<strong>所以在AI的支持下，我们2个月完成了需求同时学习了KMP</strong>。</p>
</li>
<li>
<p>有学习，就要有总结，不然怎么能记住，温故而知新，才是持续记忆的良方。所以<strong>必须要总结回顾</strong>。开发过程中如何抽出时间进行总结并复习很关键。</p>
</li>
</ul>
<h5 data-id="heading-18">解决方案</h5>
<p><strong>第一步：开发者搭建自己的环境</strong></p>
<ul>
<li>
<p>当确定要做KPM这件事情，或者有规划时，就可以提前做这一步（没时间另说），不必等到万事确定在开始，那就太晚了。</p>
</li>
<li>
<p>熟悉IDE/安装KMP工具/安装iOS Xcode/CocoaPods等，这些能提前就提前，最起码启动hello world，期间问题可以让AI辅助解决。</p>
</li>
</ul>
<p><strong>第二步：启动规划</strong></p>
<ul>
<li>
<p>功能排期直接已前端视角评估需要的时间为基础，然后乘1.5倍系数，确定整体需求排期。</p>
</li>
<li>
<p>由有经验的KMP研发完成项目基建设，为什么我上面强调需要有经验的开发或者有项目Dmeo落地，主要两点：<strong>1.基建不稳定后续可能工期崩盘；2.没有经验的基建，无法确定它是好是坏。</strong></p>
</li>
</ul>
<p><strong>第三步：项目宣讲</strong></p>
<ul>
<li>针对搭建好的基础环境，还是要统一讲解，让大家都了解基本内容，大概知道项目代码应该放到哪个目录下合理。这样开发的大方向就不会错，<strong>不要以为有分享者讲了就能懂，分享的知识只能记住小部分</strong>，只有实际操作记忆后才能逐步适应。</li>
</ul>
<p><strong>第四步：进入开发</strong></p>
<ul>
<li>
<p>没有AI支持，那是屁都开发不了的，<strong>所以AI省去了完整的一个大步骤，学习基本的KMP编程语法和UI框架和基础知识</strong>。</p>
</li>
<li>
<p>整个开发阶段，全凭rule和AI对话，实现并发学习和开发，总结沉淀。</p>
</li>
<li>
<p>我给其设定为具有丰富前端转KMP经验的开发角色，<strong>根据开发中的一些关键点，自由评估总结思维转变思路</strong>，根据内容情况，自动沉淀到知识目录或工程目录。</p>
</li>
<li>
<p>让其开发实际业务功能代码，<strong>开发完整后并自动提取有价值的知识点，进行讲解和沉淀</strong>。保证开发/学习/沉淀面面具到。</p>
</li>
<li>
<p>提供输出规范模版说明，并采用类比的思路讲解知识，让AI总结的内容可以类比前端更容易理解内容。</p>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f87749a7935a42128daec0681a443be2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcWl5dWU3Nw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767322856&amp;x-signature=NiiFUZ%2FQwpymZJk8Veu2sFcjcL8%3D" alt="" loading="lazy"/></p>
<pre><code class="hljs language-markdown" lang="markdown">角色
你是一名前端专家转型KMP跨端开发，并成为一名跨端开发专家，拥有丰富的前端和跨端经验。同时非常善于分享教学，拥有丰富的授课经验。
技能
<span class="hljs-bullet">*</span> 精通 Kotlin Multiplatform(KMP)、Compose Multiplatform(CMP)、Kotlin、Java，Gradle等跨端技术栈。
<span class="hljs-bullet">*</span> 精通 JS，HTML，CSS，TypeScript，VUE，React，Node等前端技术栈。
<span class="hljs-bullet">*</span> 拥有丰富的[前端]到[KMP跨端]的思维转变经验。善于使用对比，抽象，渐进式教学等技巧通过项目驱动学习，Demo演示等进行教学。
<span class="hljs-bullet">*</span> 善于总结教学笔记，从项目开发中沉淀[前端]转型[KMP跨端]需要学习的知识点。
<span class="hljs-bullet">*</span> 善于使用精简的伪代码，展示完整的功能应用，遵循标准执行流程 "代码声明=&gt;文件导入=&gt;函数/类调用[参数解释]"。
<span class="hljs-bullet">*</span> 理解 Gradle 构建系统和插件开发。

任务要求
<span class="hljs-bullet">*</span> 开发对话中，针对本次代码生成，提取跨端知识点，自行评估对前端转KMP跨端价值，询问是否需要沉淀到学习文档。

<span class="hljs-bullet">    1.</span> 这次对话是否涉及前端→KMP的思维转变?
<span class="hljs-bullet">    2.</span> 是否包含新的技术概念对比?
<span class="hljs-bullet">    3.</span> 是否有可复用的最佳实践?
<span class="hljs-bullet">    4.</span> 如果安卓/iOS/跨端有差异，需要提供对比分析。

<span class="hljs-bullet">*</span> 新的知识点需要对比 /docs/forlearn目录下是否已经存在，如果不存在创建新的知识点文档。
<span class="hljs-bullet">*</span> 知识点沉淀需要合理分类，形成章节markdown文档，知识点文档必须沉淀在/docs/forlearn目录，章节分类可以参考下面【章节分类举例】。
<span class="hljs-bullet">*</span> 知识沉淀注重清晰有条理且简单易懂，必要时，附带参考资料引用，但每个知识点资料引用少余2条。

文档分类
<span class="hljs-bullet">1.</span> 工程文档（Engineering Docs）
<span class="hljs-bullet">*</span> 位置: /docs/ 或 /docs/integration/、/docs/api/ 等
<span class="hljs-bullet">*</span> 目的: 项目开发、功能接入、API参考
<span class="hljs-bullet">*</span> 内容: 配置步骤、代码示例、API文档
<span class="hljs-bullet">*</span> 不需要前端对比

<span class="hljs-bullet">2.</span> 学习文档（Learning Docs）
<span class="hljs-bullet">*</span> 位置: /docs/forlearn/
<span class="hljs-bullet">*</span> 目的: 前端转KMP的知识沉淀
<span class="hljs-bullet">*</span> 内容: 概念对比、思维转变、Demo等，可自由编排
<span class="hljs-bullet">*</span> 必须包含"前端思维转变和理解"章节
</code></pre>
<h3 data-id="heading-19">五、研发团队新形态思考</h3>
<p>在快速的AI发展阶段，想要走在前沿，需要不断摸索前进。大胆假设，小心求证，必要的尝试可能带来意想不到的效果。</p>
<h4 data-id="heading-20">5.1 团队组成</h4>
<h5 data-id="heading-21">5.1.1 传统团队</h5>
<p>传统团队1是1，2是2，各个职能线之前没有交叉和转换的可能，除非招聘有实际多端开发经验的开发，在面对人力不足，实效性需求时，缺少灵活性。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5fce06d6059447e6a0c4ef50fec55f2f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcWl5dWU3Nw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767322856&amp;x-signature=x52vQ0jwrqmBpoqXKiIQGtJ2Cp0%3D" alt="" loading="lazy"/></p>
<h5 data-id="heading-22">4.1.2 AI辅助型团队</h5>
<p>AI辅助型，软全栈开发。<strong>各个职能线独立一名AI辅助型全栈</strong>，在面对紧急需求，人力不足，实效性需求等，具有良好的协调性。</p>
<p>谁当这类人？这类型意味着更累，工作强度更大？</p>
<ul>
<li>
<p>学习探索能力强，渴望技术快速成长，对AI感兴趣的人，可以作为优先考虑对象。</p>
</li>
<li>
<p>不管什么样的角色，一个人的时间有限，工作量不会有什么差别，<strong>不过确实可能比单角色研发面临紧急项目，高优项目多。当然晋升和成长机会也会更高</strong>。毕竟关键性项目都有身影。</p>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/16d39c07dc7b4c1c880c37961a776042~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcWl5dWU3Nw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767322856&amp;x-signature=rZikIzMSeKTEm1M1brR%2BHkMhmKM%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-23">5.2 快速低成本建设方案</h4>
<ul>
<li>
<p>将项目功能技术进行文档和知识沉淀，搭配嵌套<code>__docs__</code>目录，将整个项目构建出AI需要的上下文资源。</p>
</li>
<li>
<p>开发者，利用IDE，rule，MCP工具，以及嵌套的文档资源，根据功能开发情况，按需喂给AI上下文。</p>
</li>
<li>
<p>特点是：文档伴随项目git提交更新，开发者遵守文档维护目录结构和更新规范。开发时按需使用文档和rule。人工更新维护文档。</p>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e5a08c5f915344d9b3f7c1a15517eeb9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcWl5dWU3Nw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767322856&amp;x-signature=5xeybQtmAbGsz5ZP6JrW9HoalhI%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-24">5.3 体系化建设方案</h4>
<ul>
<li>
<p>将项目功能技术进行文档和知识沉淀，搭配向量化数据库和知识图谱（或RAG），将多个项目通用信息抽离进行向量化存储。</p>
</li>
<li>
<p>开发者，利用IDE，rule，MCP工具，基于知识图谱和云端数据库，进行功能开发。</p>
</li>
<li>
<p>特点是：多个研发/多个项目之前可以共享云端数据，数据更新也可通过AI+MCP进行向量化处理并自动更新数据库。</p>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cd25f4460226416ab3da26577d98b14a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcWl5dWU3Nw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767322856&amp;x-signature=sGVq9kj9FJg6t%2B8i%2BijacrDixhY%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-25">六、核心技术资讯平台</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.blog%2Fnews-insights%2Foctoverse%2F" target="_blank" title="https://github.blog/news-insights/octoverse/" ref="nofollow noopener noreferrer">github.blog/news-insigh…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fsurvey.stackoverflow.co%2F2025%2F" target="_blank" title="https://survey.stackoverflow.co/2025/" ref="nofollow noopener noreferrer">survey.stackoverflow.co/2025/</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.thoughtworks.com%2Fradar" target="_blank" title="https://www.thoughtworks.com/radar" ref="nofollow noopener noreferrer">www.thoughtworks.com/radar</a></p>
<h4 data-id="heading-26">6.1 其他资料</h4>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdev.to%2Franndy360%2Fai-coding-best-practices-in-2025-4eel" target="_blank" title="https://dev.to/ranndy360/ai-coding-best-practices-in-2025-4eel" ref="nofollow noopener noreferrer">dev.to/ranndy360/a…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fsurvey.stackoverflow.co%2F2025%2F" target="_blank" title="https://survey.stackoverflow.co/2025/" ref="nofollow noopener noreferrer">survey.stackoverflow.co/2025/</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.blog%2Fnews-insights%2Foctoverse%2F" target="_blank" title="https://github.blog/news-insights/octoverse/" ref="nofollow noopener noreferrer">github.blog/news-insigh…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fchrome.xahuapu.net%2Fhelp%2F3862.html" target="_blank" title="https://chrome.xahuapu.net/help/3862.html" ref="nofollow noopener noreferrer">chrome.xahuapu.net/help/3862.h…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgooglechromexz.com%2Fguide%2F3118.html" target="_blank" title="https://googlechromexz.com/guide/3118.html" ref="nofollow noopener noreferrer">googlechromexz.com/guide/3118.…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.chrome.com%2Frelease-notes%3Fhl%3Dzh-cn" target="_blank" title="https://developer.chrome.com/release-notes?hl=zh-cn" ref="nofollow noopener noreferrer">developer.chrome.com/release-not…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fsurvey.stackoverflow.co%2F2024%2Ftechnology%23admired-and-desired" target="_blank" title="https://survey.stackoverflow.co/2024/technology#admired-and-desired" ref="nofollow noopener noreferrer">survey.stackoverflow.co/2024/techno…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fvite.dev%2Fblog%2Fannouncing-vite6.html" target="_blank" title="https://vite.dev/blog/announcing-vite6.html" ref="nofollow noopener noreferrer">vite.dev/blog/announ…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fnpm-stat.com%2Fcharts.html%3Fpackage%3Dvue%26package%3Dreact%26package%3Dsvelte%26package%3Dangular%26from%3D2024-01-01%26to%3D2024-12-31" target="_blank" title="https://npm-stat.com/charts.html?package=vue&amp;package=react&amp;package=svelte&amp;package=angular&amp;from=2024-01-01&amp;to=2024-12-31" ref="nofollow noopener noreferrer">npm-stat.com/charts.html…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Hono与Honox一次尝试]]></title>    <link>https://juejin.cn/post/7588300640599719942</link>    <guid>https://juejin.cn/post/7588300640599719942</guid>    <pubDate>2025-12-28T11:19:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588300640599719942" data-draft-id="7588191506607194118" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Hono与Honox一次尝试"/> <meta itemprop="keywords" content="前端,后端"/> <meta itemprop="datePublished" content="2025-12-28T11:19:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小小荧"/> <meta itemprop="url" content="https://juejin.cn/user/606586151371054"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Hono与Honox一次尝试
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/606586151371054/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小小荧
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-28T11:19:53.000Z" title="Sun Dec 28 2025 11:19:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Hono与Honox一次尝试</h2>
<p>最近心血来潮，尝试着用Hono和Honox写了一个简单的Web应用。但是我被折磨了一顿😣。最近看到了hono+cloudflare搭建一个接口服务还是很有趣的，本想着用来搭建一个图床的服务，突然看到官网hono中可以编写jsx组件，于是来的兴趣准备尝试尝试。
<img src="https://static.xxytime.top/2025/12/28/17-32-34-17181f9131880e71a5f53dcf7600d75f-20251228173233695-bce866.png" alt="" loading="lazy"/></p>
<p><strong>Hono是一个用于Node.js的Web框架，而Honox是Hono的实验性版本，旨在提供更好的性能和更现代的API。我尝试着用Hono和Honox写了一个简单的Web应用，结果出乎意料的好。Honox的性能比Hono更好，API也更现代，推荐给大家。</strong></p>
<h3 data-id="heading-1">环境准备</h3>
<ol>
<li>安装Node.js和npm</li>
<li>创建一个新项目</li>
<li>安装Hono和Honox</li>
<li>配置D1数据库本地用SqlLite代替</li>
<li>部署cloudflare workers先把项目跑起来😊</li>
</ol>
<blockquote>
<p>以上的操作都没有问题，一切看起来如此的顺利😊。</p>
</blockquote>
<h4 data-id="heading-2">槽点一</h4>
<p>honox的文档写得不够详细，很多地方都看不太懂。</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-comment">// app/routes/index.tsx</span>
<span class="hljs-comment">// `createRoute()` helps you create handlers</span>
<span class="hljs-keyword">import</span> { createRoute } <span class="hljs-keyword">from</span> <span class="hljs-string">'honox/factory'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">createRoute</span>(<span class="hljs-function">(<span class="hljs-params">c</span>) =&gt;</span> {
  <span class="hljs-keyword">return</span> c.<span class="hljs-title function_">render</span>(
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Hello!<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
})
</code></pre>
<p>以上代码<code>createRoute</code>内不支持<code>react</code>运行时语法，比如:<code>useEffect</code>语法无法使用,只能使用<code>honox</code>的<code>jsx</code>语法。在请求数据的时候的时候我还傻傻的在<code>useEffect</code>中写<code>fetch</code>请求数据，结果可想而知， honox中没有<code>useEffect</code>，也没有<code>useState</code>，有的只是<code>c.request</code>和<code>c.render</code>。而正确的做法是直接调用DB的服务查询数据，直接在服务端渲染。其实这也是陷入了<code>ssr</code>的陷阱。但这种模式更像是传统的后端开发中前后端不分离的一种架构方式</p>
<h4 data-id="heading-3">槽点二</h4>
<p><code>jwt</code>中间件失效，按照官方文件所言在hono的是可以直接拦截鉴权逻辑的，但是在honox中却是失效的需要honox还在beta版本中的原有一些hono的配套的中间件还没有完全支持，所有我有自己写了一个鉴权的中间件逻辑</p>
<h4 data-id="heading-4">槽点三</h4>
<p>没有配套的<code>ui</code>组件库，比如<code>antd</code>、<code>element</code>等，所有需要自己写样式或者使用<code>honox</code>的<code>jsx</code>语法自己写组件
不过还好他支持<code>tailwindcss</code></p>
<h4 data-id="heading-5">总结</h4>
<p><code>Honox</code>都还处于beta版本，还有很多功能没有完善，但是总体来说，<code>Honox</code>确实为hono提供了更优雅的ui组件编写方式，结合了<code>jsx</code>，融入了<code>react</code>的语法，让后端模板语法写起来更加优雅。但是尝鲜毕竟只是尝鲜，实际生产中需要使用ssr还是推荐使用<code>nuxt.js</code>或者<code>next.js</code>。<code>hono</code>我也推荐只是用在一些小项目或者实验性项目中。尝鲜网址 <a href="https://link.juejin.cn?target=https%3A%2F%2Fimgbed.xxytime.top%2F" target="_blank" title="https://imgbed.xxytime.top/" ref="nofollow noopener noreferrer">图床</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[「分库分表不是万能药」：高并发MySQL架构的理性选择]]></title>    <link>https://juejin.cn/post/7588355695101018121</link>    <guid>https://juejin.cn/post/7588355695101018121</guid>    <pubDate>2025-12-28T11:28:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588355695101018121" data-draft-id="7588140921248399398" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="「分库分表不是万能药」：高并发MySQL架构的理性选择"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-28T11:28:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="技术不打烊"/> <meta itemprop="url" content="https://juejin.cn/user/893244690677165"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            「分库分表不是万能药」：高并发MySQL架构的理性选择
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/893244690677165/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    技术不打烊
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-28T11:28:18.000Z" title="Sun Dec 28 2025 11:28:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/91aafae4a5c741129c551c687385876a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oqA5pyv5LiN5omT54OK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767526098&amp;x-signature=6rPCD1qOnruVr3vwQG52gnDOUqY%3D" alt="0dacd9b9-d0e4-4da1-b8e5-a09762831a9a.png" loading="lazy"/></p>
<p>越“分”越乱，是不是你也掉过这个坑？</p>
<p>前些日子，朋友所在的公司为了冲刺年末促销，大张旗鼓地将原本的单个数据库拆分成八个分库、十六个分表，不过结果却事与愿违，系统不仅没有提速，反而慢得像蜗牛爬行一般，连基本的报表都查不出来；老板一怒之下，DBA不得不连夜加班，开发团队也纷纷抱怨连连。</p>
<p>我问他一个问题：是不是所有高并发问题，都能靠分库分表解决？</p>
<p>他说：“以前我也这么以为——现在真不敢了。”</p>
<p>分库分表不是银弹，它只是架构演进中的一枚棋子。</p>
<p>今天我们就聊聊，到底什么时候该“分”？怎么“分”？分完又该怎么“活下去”？</p>
<p>看完这篇，你会对“分库分表”这事，有个清晰、冷静、能吹也能干的判断。</p>
<hr/>
<h2 data-id="heading-0">并发瓶颈真的是数据库的问题吗</h2>
<p>很多项目一上来就喊“数据库扛不住了”，但真相往往扎心。并发的瓶颈，八成不在数据库，而在业务设计和SQL习惯上。</p>
<ul>
<li>
<p>一堆慢SQL没索引</p>
</li>
<li>
<p>一个事务锁着十几张表</p>
</li>
<li>
<p>同步更新、死循环队列</p>
</li>
<li>
<p>甚至还有人用<code>SELECT *</code>查全表</p>
</li>
</ul>
<p>不是MySQL不行，是设计太随性</p>
<p>单库其实可以支撑起相当高的并发，要是你加上主从读写分离、Redis缓存命中以及SQL优化，或许都能让性能翻倍很多回。</p>
<p>所以，别一看到TPS上升就喊“我要分库！”。那不是架构升级，那是交智商税。</p>
<p>想想你上次线上“高并发”是不是，其实是日志打太多了？</p>
<hr/>
<h2 data-id="heading-1">从事实指标判断需要“分”的时机</h2>
<p>真正要不要分，要看三个硬指标：<strong>QPS、数据量、事务耦合度</strong></p>
<ol>
<li>
<p><strong>QPS</strong>（每秒查询数）：单库单实例能够稳定达到5000以上，大部分业务实际上都足够使用</p>
</li>
<li>
<p><strong>数据量</strong>：单表超过5000万行、索引命中率明显下降时，该警觉</p>
</li>
<li>
<p><strong>事务耦合度</strong>：跨业务、跨表事务多，分后代价巨大</p>
</li>
</ol>
<p>不是系统慢了就分，而是优化尽头了才分</p>
<p>像电商订单、日志，还有用户行为数据这类天然归属于大表的情况，确实或许要分库。</p>
<p>但很多中小系统、SaaS平台，根本没到那个量级。</p>
<p>建议大家先做个性能基线测试，自测看看瓶颈真的在哪。搞不好，半天的索引优化，比一个月的分库分表还值！</p>
<hr/>
<h2 data-id="heading-2">分库分表的三种主流策略及适用场景</h2>
<p>等到真的到了要分开的时候，不要慌。分开的办法，有三种：<strong>水平分表、垂直分库、混合方案</strong></p>
<ol>
<li>
<p><strong>水平分表</strong>：将同一张表依照规则分割成若干张，例如依据用户ID进行取模。适用于单表过大的情况</p>
</li>
<li>
<p><strong>垂直分库</strong>：依据业务来进行拆分，比如说订单库、用户库、日志库这类的，通常是在业务模块耦合程度比较低的时候适用</p>
</li>
<li>
<p><strong>混合方案</strong>：复杂系统的常态，灵活但维护成本高</p>
</li>
</ol>
<p>分得好是解药，分不好是毒药</p>
<p>分片键的设计那可是相当关键，打个比方哈，要是按用户ID去分库，可实际查询的时候大多靠的是订单号，这么一来，那肯定就会不可避免地出现跨库查询，性能一下子就得掉一半。</p>
<p>建议先画出核心查询路径，再决定分片逻辑</p>
<p>可以自己试试手动分片演练，比如：如何确保同一用户的订单数据能落在一库？</p>
<p>做几次这个练习，你就知道架构师凭啥贵</p>
<hr/>
<h2 data-id="heading-3">跨库查询、统计与全局一致性的挑战</h2>
<p>分完之后，不少人会说：“数据查不到了，聚合不准了，事务也炸了。”</p>
<p>因为分库分表最难的不在“分”，而在“查”。</p>
<p>以往一条SQL就能解决的事情，现在或许要修改十条，还要进行合并、分页、排序。</p>
<p>你以为你在优化架构，其实你在重写MySQL。</p>
<p>解决方案也不是没有，比如</p>
<ul>
<li>
<p>ShardingSphere：中间件层做分片、汇总</p>
</li>
<li>
<p>分布式事务框架（Seata、TCC）</p>
</li>
<li>
<p>统计异步化与ETL离线聚合</p>
</li>
</ul>
<p>但这些却都造成了很大复杂程度。很多团队用了半年时间去重新构建，最终发现查看报表竟然比原先还要慢。</p>
<p>所以，一定要问自己一句——你的业务，真的值这个代价吗？</p>
<hr/>
<h2 data-id="heading-4">你真的需要拆数据库吗</h2>
<p>最后，我们得说实话：分库分表只是解决高并发的一个选项，不是唯一选项。</p>
<p>业内高手常常这样干</p>
<ul>
<li>
<p>Redis预热缓存，命中率99%</p>
</li>
<li>
<p>消息队列异步削峰</p>
</li>
<li>
<p>热冷数据分层，热点放内存，冷数据归档</p>
</li>
<li>
<p>读写分离+分区表，撑足百万QPS</p>
</li>
</ul>
<p>真正的高手，不是动刀最频繁的，而是最少动刀的。</p>
<p>存在这么一家知名的互联网公司，到现在依旧采用单个MySQL实例，凭借着缓存以及限流办法稳稳地为几千万用户提供服务。</p>
<p>所以别急着拆数据库，先拆思维框架</p>
<p>如果给你一次重新设计机会，你会先分库，还是先分流？</p>
<hr/>
<h2 data-id="heading-5">结尾：理性，不是保守，而是成熟</h2>
<p>分库分表是架构的必修课，但绝不是考试答案。</p>
<p>它让你学会取舍，也让你明白——架构从不是炫技，而是权衡。</p>
<p>架构的尽头，不是炫技，而是稳</p>
<p>那所以，下一次你要是听到要不要分库，先问这么一个问题：</p>
<p>“我的系统，是不是已经把单库吃干榨尽？”</p>
<p>如果没有，先稳住，测一测、调一调、补一补。</p>
<p>关注我，让我们一起少踩坑，多落地，写出更聪明的系统。</p>
<hr/>
<p><strong>声明</strong>：此文章里九成内容是我自己撰写的，有一小部分素材借助了AI来打造，而且所有内容我都仔细核查过，图片素材要么是真实存在的，要么是由AI原创的，该文章旨在传播正能量，没有低俗不良的引导，希望读者能够知道。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[短思考第267天，周末亲子游，拆解一个很常见的商业化项目！]]></title>    <link>https://juejin.cn/post/7588793670494109736</link>    <guid>https://juejin.cn/post/7588793670494109736</guid>    <pubDate>2025-12-29T01:36:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588793670494109736" data-draft-id="7588456115882721315" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="短思考第267天，周末亲子游，拆解一个很常见的商业化项目！"/> <meta itemprop="keywords" content="创业,全栈,AI编程"/> <meta itemprop="datePublished" content="2025-12-29T01:36:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员码歌"/> <meta itemprop="url" content="https://juejin.cn/user/764915820529831"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            短思考第267天，周末亲子游，拆解一个很常见的商业化项目！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/764915820529831/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员码歌
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T01:36:25.000Z" title="Mon Dec 29 2025 01:36:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>周末娃吵着要出去玩，在附近找了一个亲子农场公园，分享一下这次游玩所见的一些商业化思考。</p>
<p>【公园选地】
公园位于番禺相对偏远的区域，占地约两个足球场大小，租金成本较低。公共交通不便，主要依赖自驾或网约车，目标客群具备一定消费能力。
商业思考：在成本可控的近郊选址，通过差异化体验弥补区位劣势，吸引对交通不敏感的亲子家庭。</p>
<p>【游玩项目】</p>
<ol>
<li>
<p>蘑菇屋等童话场景，适合拍照打卡。
商业思考：利用视觉化场景打造社交媒体传播点，提升园区的自传播能力。</p>
</li>
<li>
<p>小白兔喂养区，提供胡萝卜和干草。
商业思考：通过低成本互动项目提高游客停留时间和参与感。</p>
</li>
<li>
<p>散养羊驼、梅花鹿、羊、孔雀等动物，可自由投喂。
商业思考：以“亲近自然”的沉浸式体验形成核心吸引力，增强亲子互动和趣味性。</p>
</li>
<li>
<p>骑马体验，每张票可免费体验一次。
商业思考：通过高感知价值项目提升票价吸引力，形成差异化竞争优势。</p>
</li>
<li>
<p>小火车游园，支持一大一小乘坐。
商业思考：通过家庭友好型项目提升客单价和亲子体验的完整性。</p>
</li>
<li>
<p>园区小溪及金鱼观赏。
商业思考：以低成本自然景观丰富游览层次，提高空间利用率。</p>
</li>
<li>
<p>免费露营区，提供天幕、桌椅供游客休息。
商业思考：通过免费设施提升游客舒适度，延长停留时间，促进二次消费。</p>
</li>
<li>
<p>小炉子煎南瓜饼体验。
商业思考：以“DIY体验”增强儿童参与感，形成独特记忆点，提高复购与传播。</p>
</li>
<li>
<p>小丑表演与气球赠送，表演后可通过抖音分享领取免费气球。
商业思考：利用娱乐表演提升现场氛围，并以“社交平台分享”作为低成本裂变方式。</p>
</li>
</ol>
<p>【美食小街】
园区内设置美食小街，满足游客在游玩过程中的即时性饮食需求。
商业思考：利用“刚需消费”提升非门票收入，通过轻餐饮实现高毛利、低投入的持续变现</p>
<p>【抖音购票引流】
主要面向亲子家庭，推出两大一小套票约70元，含所有项目和一份萝卜；同时提供17.9元的单人入园票。多领萝卜或领取气球需在抖音发布图文并评论15字以上。
商业思考：通过分层票价结构满足不同需求，以“社交平台任务奖励”实现用户自发传播，降低获客成本。</p>
<p>【总结】
总的来说，这是一套很成功的一个商业化运作，整体逻辑如下：
以低成本近郊场地为基础，通过强互动、强社交属性的亲子体验组合，结合抖音裂变机制，形成“体验吸引—社交传播—转化购票—现场消费”的完整商业闭环。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI应用-基于LangChain4j实现AI对话]]></title>    <link>https://juejin.cn/post/7588355695101165577</link>    <guid>https://juejin.cn/post/7588355695101165577</guid>    <pubDate>2025-12-28T12:51:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588355695101165577" data-draft-id="7585534343562133554" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI应用-基于LangChain4j实现AI对话"/> <meta itemprop="keywords" content="后端,人工智能"/> <meta itemprop="datePublished" content="2025-12-28T12:51:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="清名"/> <meta itemprop="url" content="https://juejin.cn/user/2080748088600525"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI应用-基于LangChain4j实现AI对话
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2080748088600525/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    清名
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-28T12:51:29.000Z" title="Sun Dec 28 2025 12:51:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/065d214b077a456d9bfada09ca6218a8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5riF5ZCN:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767531088&amp;x-signature=xRDSNf9QZ6F76jsL5fSfoA7uMe8%3D" alt="生成特定背景图片.png" loading="lazy"/></p>
<p>AI（即人工智能 Artificial Intelligence）是计算机科学的一个分支，旨在让计算机模仿人类的决策能力、像人类一样思考，学习和解决问题的技术。而大模型是实现AI的一种强大技术和路径。</p>
<p>大模型，通常指大规模预训练模型，是深度学习的一个分支。它的大体现在三个方面：</p>
<ul>
<li><strong>参数量巨大</strong>：千亿、万亿级别的神经元连接，能够存储海量知识。</li>
<li><strong>训练数据巨大</strong>：使用整个互联网规模的文本、图像、代码等进行训练。</li>
<li><strong>算力消耗巨大</strong>：需要强大的GPU集群进行数周甚至数月的训练。</li>
</ul>
<p>像ChatGPT、Claude 、文心一言、通义千问都属于大模型的一种。</p>
<h3 data-id="heading-0">ollama</h3>
<p>Ollama 是一个开源工具，可以让你能在自己的电脑上轻松地运行、管理和部署大型语言模型。
像deepseek、通义千问、gemini等模型都可以通过ollama进行部署运行。官网地址为：
<a href="https://link.juejin.cn?target=https%3A%2F%2Follama.com%2F" target="_blank" title="https://ollama.com/" ref="nofollow noopener noreferrer">ollama.com/</a> 。 下载并安装成功后，我们可以进入Models选择自己需要的模型进行部署,机器性能有限，所以选取了qwen3:0.6b作为本次部署的模型。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/05344b32d09e42e687a3bd6b60d154d6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5riF5ZCN:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767531088&amp;x-signature=TDjMJaE2Dy3PhDSinjWjsadA70Y%3D" alt="image.png" loading="lazy"/></p>
<p>这些大模型中都带有个"b"，这个b表示十亿的意思。0.6b则表示6亿个参数，参数越多表示功能越强大。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6ae3c63e855948848a9b1c62abf08206~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5riF5ZCN:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767531088&amp;x-signature=tJeXGTtbiVR2X%2Bp3FO3UFGuKikU%3D" alt="image.png" loading="lazy"/>
选择对应的模型后，进入详情可以查看ollama的安装命令。将该命令复制后进行安装。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b5ac0808815e4ab88d728f4147487212~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5riF5ZCN:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767531088&amp;x-signature=gA56mHmD8%2FLti7sC0NDI5J%2F6Xdw%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3128a351c6984feeb58b8092677b3c23~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5riF5ZCN:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767531088&amp;x-signature=sHHkX86%2FBg5w%2FEccc3XOMD%2Fgofc%3D" alt="image.png" loading="lazy"/></p>
<p>虽然成功的部署了大模型，但是当前状态下用户无法直接使用该模型。所以需要建立一个桥梁，来连接用户和大模型。对于传统软件来讲，想要进行智能化改造，目前有两种选择：<strong>LangChain4j</strong>和<strong>Spring Ai</strong>。本次将以LangChain4j来作为桥梁，LangChain4j 是一个专为Java设计的大语言模型集成框架，其核心目标是简化将各类大语言模型集成到Java应用程序中的过程。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/21f770ee40c94b0d9710b95802be1567~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5riF5ZCN:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767531088&amp;x-signature=wy88QvQpYBYSmDYl4StQKpgkI%2Fs%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-1">LangChain4j</h3>
<h4 data-id="heading-2">OpenAiChatModel</h4>
<p>本地部署大模型后，会提供出各种api，ollama默认提供的服务端口是<code>11434</code>，langchain4j底层已经默认集成了这些接口，而这些接口被封装在OpenAiChatModel中，所以OpenAiChatModel是OpenAi的关键入口，我们在使用时只需要调用对应的方法即可，减少了很多的接口对接的时间。现在需要将langchain4j整合到项目中，下面是demo中相关框架的版本，需要注意的是，langchain4j强制使用17及以上的jdk版本。。</p>
<blockquote>
<p>springboot版本为3.5.0</p>
<p>jdk版本为17</p>
</blockquote>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.5.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.5.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>dev.langchain4j<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>langchain4j-open-ai<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.29.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span> <span class="hljs-comment">&lt;!-- 最新稳定版本 --&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>dev.langchain4j<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>langchain4j-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.29.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span> <span class="hljs-comment">&lt;!-- 如果使用 Spring Boot Starter --&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

</code></pre>
<p>如果你使用的是云版的大模型，那么这部可以忽略，你只需要在yml文件中配置相应的模型信息即可。这段配置主要是用于本地部署版本，本地部署一般不需要apiKey，但是这里不填的话会报错，所以随便填上一点内容就行。baseUrl填写模型的地址就行，需要注意的是，ollama的官网中提供的api接口地址并没有v1部分，但是这里不配置的话请求时会404。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fd1b5501ee73424da2cc7ba728e89bff~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5riF5ZCN:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767531088&amp;x-signature=hkAsre4PqwC3jJw59jUHjbS79VE%3D" alt="image.png" loading="lazy"/></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ChatModelConfig</span> {

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> OpenAiChatModel <span class="hljs-title function_">openAiChatModel</span><span class="hljs-params">()</span>{
        <span class="hljs-keyword">return</span> OpenAiChatModel.builder()
                .baseUrl(<span class="hljs-string">"http://127.0.0.1:11434/v1"</span>)  <span class="hljs-comment">// ollama地址</span>
                .modelName(<span class="hljs-string">"qwen3:0.6b"</span>)   <span class="hljs-comment">// 模型名称</span>
                .apiKey(<span class="hljs-string">"123"</span>)   <span class="hljs-comment">// apikey  随便填写</span>
                .build();
    }
}
</code></pre>
<p>给用户提供一个模拟对话的接口，用户将通过该接口将对话内容请求到模型中，模型再将思考结果通过该接口返回给用户。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@RequestMapping("/api")</span>
<span class="hljs-meta">@RestController</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ChatApiController</span> {


    OpenAiChatModel openAiChatModel;

    ChatApiController( OpenAiChatModel openAiChatModel){
        <span class="hljs-built_in">this</span>.openAiChatModel = openAiChatModel;
    }

    <span class="hljs-meta">@PostMapping("/chat")</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">chat</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> ChatDTO chatDTO)</span>{
        <span class="hljs-type">String</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> openAiChatModel.generate(chatDTO.getData());
        <span class="hljs-keyword">return</span> response;
    }

}
</code></pre>
<p>通过该接口发送对话内容并查看模型思考的结果。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/62233eec0a25486bbff62a3234e5d77c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5riF5ZCN:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767531088&amp;x-signature=c6JueF9QINdGA3AFynuJL3dpdZs%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-3">@AiService</h4>
<p>上面使用了OpenAiChatModel进行了对话demo的编写，但是LangChain4j提供了更简洁的编码方式，即使用<code>@AiService</code>注解来进行声明式编写。在使用该注解时，需要自定义一个对话接口，并在接口上添加该注解。该注解内有几个参数<code>wiringMode</code>(模型是自动配置还是手动配置)，<code>chatModel</code>(指定的模型配置)等。现在对上面的代码进行改造。首先定义一个AiChatService接口，并添加注解。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@AiService(wiringMode = AiServiceWiringMode.EXPLICIT, // 表示手动配置，默认自动配置
chatModel = "openAiChatModel"  // 对话模型
)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">AiChatService</span> {

    <span class="hljs-comment">// 实现ai对话</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">chat</span><span class="hljs-params">(String content)</span>;

}
</code></pre>
<p>在原来的controller中，将OpenAiChatModel替换为AiChatService，重启成功后，并进行对话，模型同样返回了结果。</p>
<pre><code class="hljs language-java" lang="java">AiChatService aiChatService;

ChatApiController(AiChatService aiChatService){
    <span class="hljs-built_in">this</span>.aiChatService = aiChatService;
}

<span class="hljs-meta">@PostMapping("/chat")</span>
<span class="hljs-keyword">public</span> String <span class="hljs-title function_">chat</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> ChatDTO chatDTO)</span>{
    <span class="hljs-type">String</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> aiChatService.chat(chatDTO.getData());
    <span class="hljs-keyword">return</span> response;
}
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/68f00023490a4a5dbb38313cbb208329~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5riF5ZCN:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767531088&amp;x-signature=OtosvYqfM277xVtFTHbDmq2%2Fxj8%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-4">流式调用</h4>
<p>流式调用主要用于让大模型生成回复时，实时的、逐步的输出内容，而不是等全部内容生成完才一次性返回，文字能像“打字”一样出现，缩短用户等待时间，像常用的deepseek,豆包等都是采用流式调用的方式，大大提高了用户体验。LangChain4j中，提供了<code>OpenAiStreamingChatModel</code>对象，使用该对象结合Spring提供的<code>Flux&lt;T&gt;</code>即可实现流式调用。首先引入langchain4j-reactor的依赖。</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>dev.langchain4j<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>langchain4j-reactor<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.1.0-beta7<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p>Model配置和上述配置几乎相同，只是将<code>OpenAiChatModel</code>替换成了<code>OpenAiStreamingChatModel</code>。logRequests和logResponses的作用是输出与模型交互的请求和响应报文日志。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Bean</span>
<span class="hljs-keyword">public</span> OpenAiStreamingChatModel <span class="hljs-title function_">openAiStreamingChatModel</span><span class="hljs-params">()</span>{
    <span class="hljs-type">OpenAiStreamingChatModel</span> <span class="hljs-variable">build</span> <span class="hljs-operator">=</span> OpenAiStreamingChatModel.builder()
            .baseUrl(<span class="hljs-string">"http://127.0.0.1:11434/v1"</span>)
            .modelName(<span class="hljs-string">"qwen3:0.6b"</span>)
            .apiKey(<span class="hljs-string">"123"</span>)
            .logRequests(<span class="hljs-literal">true</span>)
            .logResponses(<span class="hljs-literal">true</span>)
            .build();
    <span class="hljs-keyword">return</span> build;
}
</code></pre>
<p>配置完成后，需要在定义的接口中新增一个流式调用的方法，并且方法的返回值类型需要是<code>Flux&lt;T&gt;</code>,同时在<code>@AiService</code>注解内需要配置流式模型的配置(<code>streamingChatModel</code>)。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@AiService(wiringMode = AiServiceWiringMode.EXPLICIT,
        chatModel = "openAiChatModel",
        streamingChatModel = "openAiStreamingChatModel"
)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">AiChatService</span> {

    <span class="hljs-comment">/**
     *  非流式对话
     * <span class="hljs-doctag">@param</span> content
     * <span class="hljs-doctag">@return</span>
     */</span>
    String <span class="hljs-title function_">chat</span><span class="hljs-params">(String content)</span>;

    <span class="hljs-comment">/**
     * 流式对话
     * <span class="hljs-doctag">@param</span> content
     * <span class="hljs-doctag">@return</span>
     */</span>
    Flux&lt;String&gt; <span class="hljs-title function_">chatFlux</span><span class="hljs-params">(String content)</span>;
}
</code></pre>
<p>在以上全部实现后，在额外提供一个给用户调用的接口，这个接口的返回类型同样需要使用Flux。这里需要注意的是在@GetMapping中，需要将produces的值设置为<code>text/html;charset=utf-8</code>，否则返回的内容将会是一串乱码。直接调用该接口，会直接展示流式调用效果。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@GetMapping(value = "/chat-flux",produces = "text/html;charset=utf-8")</span>
<span class="hljs-keyword">public</span> Flux&lt;String&gt; <span class="hljs-title function_">chatFlux</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(name = "content")</span> String content)</span>{
    Flux&lt;String&gt; chatFlux = aiChatService.chatFlux(content);
    <span class="hljs-keyword">return</span> chatFlux;
}
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c58cfbc54c1142afbcb0710ed9683bd2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5riF5ZCN:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767531088&amp;x-signature=Dt%2F2AM%2BjRqpw7zsnKW6Jf5vH3QI%3D" alt="动画.gif" loading="lazy"/>
上面响应的内容不太美观，那我们自己可以实现一个简单的前端页面来模拟ai智能问答(网上找一个模板或者ai生成一个就行，没必要在这个上面浪费时间)。虽然回复有些卡顿，但作为古董级的笔记本部署0.6b的模型效果也算不错了😔😔😔。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/14f8ec0ab0474020bf506df28e8bae67~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5riF5ZCN:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767531088&amp;x-signature=23jkKaGQa3GHFM4EHNO5%2BGO%2FLP8%3D" alt="动画 (1).gif" loading="lazy"/></p>
<h4 data-id="heading-5">会话记忆</h4>
<p>通常来说，正常的对话具有连续性，我们可能通过连续的对话能够更加准确的理解对方的意图或想法。但是对于机器而言，每一句对话都是独立的，并没有连续的效果。比如下面对话，机器并没有通过上下文，来理解我提问的问题。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/679cab29856c4173a84c82509b121b55~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5riF5ZCN:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767531088&amp;x-signature=DxzXL7vGweoGTTpO%2FaTlUSj1l%2FE%3D" alt="image.png" loading="lazy"/>
为了让机器能够理解对话的内容，就需要将对话的上下文一并推给机器，让机器在连续对话中记住之前交互内容的能力。它使得对话能够保持连贯性，而不是每次只处理独立的单轮对话，这就是会话记忆。目前会话记忆主要有两种，一种是短期记忆，一种是长期记忆。</p>
<ul>
<li><strong>短期记忆（上下文窗口）</strong><br/>
固定上下文长度，将整个对话历史作为输入传递给模型。这是目前最常见的方式。</li>
<li><strong>长期记忆（外部存储）</strong><br/>
通过向量数据库、缓存或用户档案存储重要信息，在需要时检索并注入到当前对话中。</li>
</ul>
<p>如果想要实现短期记忆，langchain4j提供了<code>MessageWindowChatMemory</code>，并且可以通过调用<code>maxMessages</code>方法来确定上下文的消息数量，并在<code>@AiService</code>注解中来指定会话记忆配置对象<code>chatMemory</code>。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Bean</span>
<span class="hljs-keyword">public</span> ChatMemory <span class="hljs-title function_">chatMemory</span><span class="hljs-params">()</span>{
    <span class="hljs-type">MessageWindowChatMemory</span> <span class="hljs-variable">chatMemory</span> <span class="hljs-operator">=</span> MessageWindowChatMemory.builder()
            .maxMessages(<span class="hljs-number">30</span>) <span class="hljs-comment">// 上下文长度为30条</span>
            .build();
    <span class="hljs-keyword">return</span> chatMemory;
}
</code></pre>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@AiService(wiringMode = AiServiceWiringMode.EXPLICIT,
        chatModel = "openAiChatModel",
        streamingChatModel = "openAiStreamingChatModel",
        chatMemory = "chatMemory"  // 配置会话记忆
)</span>
</code></pre>
<p>当重新运行后在进行同样的提问，可以看出来模型已经根据会话记忆的上下文进行理解并准确的回答问题了。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bca4ea8abc1a4bb2b4a632eed39eba6d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5riF5ZCN:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767531088&amp;x-signature=4a%2Blq3PdT9hVACuQtA26x2ngmfA%3D" alt="image.png" loading="lazy"/></p>
<p>短期记忆存在一个弊端，因为对话记忆内容是存储在内存中的，当服务器重启时，那这些记忆的内容就会丢失。如果想要实现长期记忆，则需要自主开发实现，比如将对话内容存储到redis中。在Langchain4j中有提供 <code>ChatMemoryStore</code>接口，长期存储时需要实现这个接口。以redis为例，定义一个ChatMemoryStore的实现类<code>RedisChatStoreService</code>,将对话消息进行存储。需要注意的是，实现长期记忆的同时，也要实现会话隔离。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisChatStoreService</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ChatMemoryStore</span> {

    <span class="hljs-meta">@Autowired</span>
    StringRedisTemplate redisTemplate;

   <span class="hljs-comment">// 以会话id作为缓存的key</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> List&lt;ChatMessage&gt; <span class="hljs-title function_">getMessages</span><span class="hljs-params">(Object memoryId)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> redisTemplate.opsForValue().get(memoryId.toString());
        <span class="hljs-keyword">return</span> ChatMessageDeserializer.messagesFromJson(message);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateMessages</span><span class="hljs-params">(Object memoryId, List&lt;ChatMessage&gt; list)</span> {
        redisTemplate.opsForValue().set(memoryId.toString(), ChatMessageSerializer.messagesToJson(list));
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deleteMessages</span><span class="hljs-params">(Object memoryId)</span> {
        redisTemplate.delete(memoryId.toString());
    }
}
</code></pre>
<p>长期记忆实现后，需要将该内容配置到记忆对象中，与短期记忆不同，这里需要实现一个对话记忆提供对象<code>ChatMemoryProvider</code>，并且在对象中配置对话存储实现类以及记忆id。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Autowired</span>
RedisChatStoreService redisChatStoreService;

<span class="hljs-meta">@Bean</span>
<span class="hljs-keyword">public</span> ChatMemoryProvider <span class="hljs-title function_">chatMemoryProvider</span><span class="hljs-params">()</span>{
     <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChatMemoryProvider</span>() {
         <span class="hljs-meta">@Override</span>
         <span class="hljs-keyword">public</span> ChatMemory <span class="hljs-title function_">get</span><span class="hljs-params">(Object memoryId)</span> {
             <span class="hljs-keyword">return</span>  MessageWindowChatMemory.builder()
                     .id(memoryId)
                     .chatMemoryStore(redisChatStoreService)
                     .maxMessages(<span class="hljs-number">30</span>)
                     .build();
         }
     };
}
</code></pre>
<p>在service红需要在@AiService注解中，需要指定上述定义的会话记忆提供者chatMemoryProvider。并且在流式调用的方法中指定记忆id。<code>@MemoryId</code>表示该字段为记忆id,<code>@UserMessage</code>表示为该字段为用户对话的内容。</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@AiService</span>(wiringMode = AiServiceWiringMode.EXPLICIT,
        chatModel = <span class="hljs-string">"openAiChatModel"</span>,
        streamingChatModel = <span class="hljs-string">"openAiStreamingChatModel"</span>,
      <span class="hljs-comment">//  chatMemory = "chatMemory"  // 配置会话记忆</span>
        chatMemoryProvider = <span class="hljs-string">"chatMemoryProvider"</span>
)

...... 

Flux&lt;String&gt; <span class="hljs-built_in">chatFlux</span>(<span class="hljs-variable">@MemoryId</span> String memoryId, <span class="hljs-variable">@UserMessage</span> String content);
</code></pre>
<p>配置完成后，当再次发起对话时，对话的内容已经被存储到redis当中了，这样即使重启，也不会导致记忆内容丢失。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c3ce7589741b4058af463871d9037aec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5riF5ZCN:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767531088&amp;x-signature=TIZ9uH1HjhSRt70MqR68tpTBB64%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ffa4ce30e8c0403c9236b89890a4b5dd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5riF5ZCN:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767531088&amp;x-signature=8SLNtG9fTJ6NqHA%2BF0c9Dbpt9vs%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-6">总结</h4>
<p>LangChain4j 是专为 Java 开发者设计的 AI 应用开发框架，相当于 Python中的LangChain。它简化了大模型在Java应用中的集成。核心优势在于提供简洁的 API 支持对话管理、RAG（后面会涉及到）、工具调用等高级功能。同时支持多种 AI 服务提供商，并可与 Spring Boot 等主流 Java 框架无缝集成，让企业级应用快速获得 AI 能力而无需重构技术栈。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[3分钟Solidity: 7.6 Yul语言简介]]></title>    <link>https://juejin.cn/post/7588139768276598835</link>    <guid>https://juejin.cn/post/7588139768276598835</guid>    <pubDate>2025-12-28T13:38:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588139768276598835" data-draft-id="7588355695101296649" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="3分钟Solidity: 7.6 Yul语言简介"/> <meta itemprop="keywords" content="Solidity,web3,智能合约"/> <meta itemprop="datePublished" content="2025-12-28T13:38:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Rockbean"/> <meta itemprop="url" content="https://juejin.cn/user/4054654615823560"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            3分钟Solidity: 7.6 Yul语言简介
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4054654615823560/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Rockbean
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-28T13:38:57.000Z" title="Sun Dec 28 2025 13:38:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读38分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>欢迎订阅专栏</strong>：<a href="https://juejin.cn/column/7578762210285977663" title="https://juejin.cn/column/7578762210285977663" target="_blank">3分钟Solidity--智能合约--Web3区块链技术必学</a></p>
<p><code>Yul</code>（先前被也被称为 <code>JULIA</code> 或 <code>IULIA</code>）是一种可以编译到各种不同后端的中间语言。</p>
<p>它可以在独立模式下使用，也可以在<code>Solidity</code>内部用于 <code>“内联汇编”</code>。 编译器在基于IR的代码生成器（“新代码生成器” 或 “基于IR的代码生成器”）中使用Yul作为一种中间语言。 Yul是高级优化阶段的一个很好的目标，可以使所有的目标平台同样受益。</p>
<h2 data-id="heading-0"><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.soliditylang.org%2Fzh-cn%2Flatest%2Fyul.html%23id2" title="https://docs.soliditylang.org/zh-cn/latest/yul.html#id2" target="_blank" ref="nofollow noopener noreferrer">动机和高级别描述</a></h2>
<p>Yul 的设计试图实现几个目标：</p>
<ol>
<li>用Yul编写的程序应该是可读的，即使代码是由Solidity或其他高级语言的编译器生成的。</li>
<li>控制流应易于理解，以帮助人工检查、形式化验证和优化。</li>
<li>从Yul到字节码的翻译应该尽可能的简单明了。</li>
<li>Yul应该适用于整个程序的优化。</li>
</ol>
<p>为了实现第一个和第二个目标，Yul提供了高级别的结构，如 <code>for</code> 循环， <code>if</code> 和 <code>switch</code> 语句和函数调用。 这些应该足以充分代表汇编程序的控制流。 因此，没有提供 <code>SWAP</code>， <code>DUP</code>， <code>JUMPDEST</code>， <code>JUMP</code> 和 <code>JUMPI</code> 的明确语句， 因为前两者混淆了数据流，后两者混淆了控制流。此外， <code>mul(add(x, y), 7)</code> 形式的函数语句比 <code>7 y x add mul</code> 这样的纯操作码语句更受欢迎， 因为在第一种形式中，更容易看到哪个操作数用于哪个操作码。</p>
<p>尽管它是为堆栈机设计的，但Yul并没有暴露堆栈本身的复杂性。 程序员或审计师不应该担心堆栈的问题。</p>
<p>第三个目标是通过以一种非常有规律的方式将高层结构编译成字节码来实现的。 汇编器执行的唯一非本地操作是用户定义的标识符（函数、变量……）的名称查找和清理堆栈中的本地变量。</p>
<p>为了避免值和引用等概念之间的混淆， Yul是静态类型的。同时， 有一个默认的类型（通常是目标机的整数字）， 可以随时省略以帮助增加可读性。</p>
<p>为了保持语言的简单和灵活， Yul在其纯粹的形式下没有任何内置的操作，函数或类型。 在指定Yul的语言时，这些操作和语义被添加到一起， 这使得Yul可以根据不同的目标平台和功能集的要求进行专业化。</p>
<p>目前，只有一种指定的Yul语言。这个语言使用EVM的操作码作为内建函数（见下文）， 并且只定义了 <code>u256</code> 类型，这是EVM的本地256位类型。正因为如此，我们将不在下面的例子中提供类型。</p>
<h2 data-id="heading-1"><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.soliditylang.org%2Fzh-cn%2Flatest%2Fyul.html%23id3" title="https://docs.soliditylang.org/zh-cn/latest/yul.html#id3" target="_blank" ref="nofollow noopener noreferrer">简单的例子</a></h2>
<p>下面的例子程序是用EVM语言编写的，用来计算指数。 它可以用 <code>solc --strict-assembly</code> 指令编译。 内置函数 <code>mul</code> 和 <code>div</code> 分别计算乘法和除法。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fremix.ethereum.org%2F%3F%23language%3Dyul%26version%3D0.8.24%26code%3DewogICAgZnVuY3Rpb24gcG93ZXIoYmFzZSwgZXhwb25lbnQpIC0%2BIHJlc3VsdAogICAgewogICAgICAgIHN3aXRjaCBleHBvbmVudAogICAgICAgIGNhc2UgMCB7IHJlc3VsdCA6PSAxIH0KICAgICAgICBjYXNlIDEgeyByZXN1bHQgOj0gYmFzZSB9CiAgICAgICAgZGVmYXVsdAogICAgICAgIHsKICAgICAgICAgICAgcmVzdWx0IDo9IHBvd2VyKG11bChiYXNlLCBiYXNlKSwgZGl2KGV4cG9uZW50LCAyKSkKICAgICAgICAgICAgc3dpdGNoIG1vZChleHBvbmVudCwgMikKICAgICAgICAgICAgICAgIGNhc2UgMSB7IHJlc3VsdCA6PSBtdWwoYmFzZSwgcmVzdWx0KSB9CiAgICAgICAgfQogICAgfQp9" target="_blank" title="https://remix.ethereum.org/?#language=yul&amp;version=0.8.24&amp;code=ewogICAgZnVuY3Rpb24gcG93ZXIoYmFzZSwgZXhwb25lbnQpIC0+IHJlc3VsdAogICAgewogICAgICAgIHN3aXRjaCBleHBvbmVudAogICAgICAgIGNhc2UgMCB7IHJlc3VsdCA6PSAxIH0KICAgICAgICBjYXNlIDEgeyByZXN1bHQgOj0gYmFzZSB9CiAgICAgICAgZGVmYXVsdAogICAgICAgIHsKICAgICAgICAgICAgcmVzdWx0IDo9IHBvd2VyKG11bChiYXNlLCBiYXNlKSwgZGl2KGV4cG9uZW50LCAyKSkKICAgICAgICAgICAgc3dpdGNoIG1vZChleHBvbmVudCwgMikKICAgICAgICAgICAgICAgIGNhc2UgMSB7IHJlc3VsdCA6PSBtdWwoYmFzZSwgcmVzdWx0KSB9CiAgICAgICAgfQogICAgfQp9" ref="nofollow noopener noreferrer">open in Remix</a></p>
<pre><code class="hljs language-sql" lang="sql">{
    <span class="hljs-keyword">function</span> <span class="hljs-built_in">power</span>(base, exponent) <span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">result</span>
    {
        switch exponent
        <span class="hljs-keyword">case</span> <span class="hljs-number">0</span> { <span class="hljs-keyword">result</span> :<span class="hljs-operator">=</span> <span class="hljs-number">1</span> }
        <span class="hljs-keyword">case</span> <span class="hljs-number">1</span> { <span class="hljs-keyword">result</span> :<span class="hljs-operator">=</span> base }
        <span class="hljs-keyword">default</span>
        {
            <span class="hljs-keyword">result</span> :<span class="hljs-operator">=</span> <span class="hljs-built_in">power</span>(mul(base, base), div(exponent, <span class="hljs-number">2</span>))
            switch <span class="hljs-built_in">mod</span>(exponent, <span class="hljs-number">2</span>)
                <span class="hljs-keyword">case</span> <span class="hljs-number">1</span> { <span class="hljs-keyword">result</span> :<span class="hljs-operator">=</span> mul(base, <span class="hljs-keyword">result</span>) }
        }
    }
}
</code></pre>
<p>也可以用for循环而不是递归来实现同样的函数。 这里， <code>lt(a, b)</code> 计算 <code>a</code> 是否小于 <code>b</code>。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fremix.ethereum.org%2F%3F%23language%3Dyul%26version%3D0.8.24%26code%3DewogICAgZnVuY3Rpb24gcG93ZXIoYmFzZSwgZXhwb25lbnQpIC0%2BIHJlc3VsdAogICAgewogICAgICAgIHJlc3VsdCA6PSAxCiAgICAgICAgZm9yIHsgbGV0IGkgOj0gMCB9IGx0KGksIGV4cG9uZW50KSB7IGkgOj0gYWRkKGksIDEpIH0KICAgICAgICB7CiAgICAgICAgICAgIHJlc3VsdCA6PSBtdWwocmVzdWx0LCBiYXNlKQogICAgICAgIH0KICAgIH0KfQ%3D%3D" target="_blank" title="https://remix.ethereum.org/?#language=yul&amp;version=0.8.24&amp;code=ewogICAgZnVuY3Rpb24gcG93ZXIoYmFzZSwgZXhwb25lbnQpIC0+IHJlc3VsdAogICAgewogICAgICAgIHJlc3VsdCA6PSAxCiAgICAgICAgZm9yIHsgbGV0IGkgOj0gMCB9IGx0KGksIGV4cG9uZW50KSB7IGkgOj0gYWRkKGksIDEpIH0KICAgICAgICB7CiAgICAgICAgICAgIHJlc3VsdCA6PSBtdWwocmVzdWx0LCBiYXNlKQogICAgICAgIH0KICAgIH0KfQ==" ref="nofollow noopener noreferrer">open in Remix</a></p>
<pre><code class="hljs language-css" lang="css">{
    function power(base, exponent) -&gt; result
    {
        result := <span class="hljs-number">1</span>
        for { let <span class="hljs-selector-tag">i</span> := <span class="hljs-number">0</span> } lt(<span class="hljs-selector-tag">i</span>, exponent) { <span class="hljs-selector-tag">i</span> := <span class="hljs-built_in">add</span>(i, <span class="hljs-number">1</span>) }
        {
            result := <span class="hljs-built_in">mul</span>(result, base)
        }
    }
}
</code></pre>
<p>在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.soliditylang.org%2Fzh-cn%2Flatest%2Fyul.html%23erc20yul" target="_blank" title="https://docs.soliditylang.org/zh-cn/latest/yul.html#erc20yul" ref="nofollow noopener noreferrer">本节的末尾</a> ，可以找到ERC-20标准的完整实现。</p>
<h2 data-id="heading-2"><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.soliditylang.org%2Fzh-cn%2Flatest%2Fyul.html%23id4" title="https://docs.soliditylang.org/zh-cn/latest/yul.html#id4" target="_blank" ref="nofollow noopener noreferrer">单独使用</a></h2>
<p>您可以使用Solidity编译器在EVM语言中以独立的形式使用Yul。 这将使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.soliditylang.org%2Fzh-cn%2Flatest%2Fyul.html%23yul-object" target="_blank" title="https://docs.soliditylang.org/zh-cn/latest/yul.html#yul-object" ref="nofollow noopener noreferrer">Yul 对象符号</a>，这样就有可能将代码作为数据引用到部署合约中。 这种Yul模式可用于命令行编译器（使用 <code>--strict-assembly</code>）和 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.soliditylang.org%2Fzh-cn%2Flatest%2Fusing-the-compiler.html%23compiler-api" target="_blank" title="https://docs.soliditylang.org/zh-cn/latest/using-the-compiler.html#compiler-api" ref="nofollow noopener noreferrer">标准-json接口</a>。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"language"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Yul"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"sources"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"input.yul"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"{ sstore(0, 1) }"</span> <span class="hljs-punctuation">}</span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"settings"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"outputSelection"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"*"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"*"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"*"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">""</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span> <span class="hljs-string">"*"</span> <span class="hljs-punctuation">]</span> <span class="hljs-punctuation">}</span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"optimizer"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"enabled"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"details"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"yul"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span> <span class="hljs-punctuation">}</span> <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<blockquote>
<p>警告</p>
<p>Yul正在积极开发中，只有以EVM 1.0为目标，Yul的EVM语言才能完全实现字节码生成。</p>
</blockquote>
<h2 data-id="heading-3"><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.soliditylang.org%2Fzh-cn%2Flatest%2Fyul.html%23id5" title="https://docs.soliditylang.org/zh-cn/latest/yul.html#id5" target="_blank" ref="nofollow noopener noreferrer">对Yul的非正式描述</a></h2>
<p>在下文中，我们将谈论Yul语言的每个单独方面。在例子中，我们将使用默认的EVM语言。</p>
<h3 data-id="heading-4"><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.soliditylang.org%2Fzh-cn%2Flatest%2Fyul.html%23id6" title="https://docs.soliditylang.org/zh-cn/latest/yul.html#id6" target="_blank" ref="nofollow noopener noreferrer">语法</a></h3>
<p>Yul使用与Solidity相同的方式解析注释，字词和标识符， 所以您可以使用 <code>//</code> 和 <code>/* */</code> 来表示注释。 但是有一个例外，Yul中的标识符可以包含圆点： <code>.</code>。</p>
<p>Yul可以指定由代码，数据和子对象组成的 “对象”。 请参阅 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.soliditylang.org%2Fzh-cn%2Flatest%2Fyul.html%23yul-object" target="_blank" title="https://docs.soliditylang.org/zh-cn/latest/yul.html#yul-object" ref="nofollow noopener noreferrer">Yul 对象</a> 以了解这方面的详情。 在本节中，我们只关注这样一个对象的代码部分。 这个代码部分总是由一个大括号限定的块组成。 大多数工具都支持只指定一个预期对象的代码块。</p>
<p>在一个代码块内，可以使用以下元素（更多细节见后面章节）：</p>
<ul>
<li>字符，即 <code>0x123</code>， <code>42</code> 或 <code>"abc"</code> （32个字符以内的字符串）。</li>
<li>对内置函数的调用，例如 <code>add(1, mload(0))</code></li>
<li>变量声明，例如 <code>let x := 7</code>， <code>let x := add(y, 3)</code> 或 <code>let x</code> （初始值为0）</li>
<li>标识符（变量），例如： <code>add(3, x)</code></li>
<li>赋值，例如： <code>x := add(y, 3)</code></li>
<li>局部变量的作用域所在的代码块，例如 <code>{ let x := 3 { let y := add(x, 1) } }</code></li>
<li>if 语句，例如 <code>if lt(a, b) { sstore(0, 1) }</code></li>
<li>switch 语句，例如 <code>switch mload(0) case 0 { revert() } default { mstore(0, 1) }</code></li>
<li>for 循环，例如 <code>for { let i := 0} lt(i, 10) { i := add(i, 1) } { mstore(i, 7) }</code></li>
<li>函数的定义，例如 <code>function f(a, b) -&gt; c { c := add(a, b) }</code></li>
</ul>
<p>多个语法元素之间可以简单地用空格隔开，即不需要结尾的 <code>;</code> 或换行。</p>
<h3 data-id="heading-5"><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.soliditylang.org%2Fzh-cn%2Flatest%2Fyul.html%23index-1" title="https://docs.soliditylang.org/zh-cn/latest/yul.html#index-1" target="_blank" ref="nofollow noopener noreferrer">字符</a></h3>
<p>作为字符，您可以使用。</p>
<ul>
<li>以十进制或十六进制符号表示的整数常数。</li>
<li>ASCII字符串（例如 <code>"abc"</code>），可能包含十六进制转义 <code>\xNN</code> 和 Unicode转义 <code>\uNNNN</code>，其中 <code>N</code> 是十六进制数字。</li>
<li>十六进制字符串（例如： <code>hex"616263"</code>）。</li>
</ul>
<p>在Yul的EVM语言中，字面量表示256位的单词，如下所示：</p>
<ul>
<li>十进制或十六进制的常量必须小于 <code>2**256</code>。 它们以大端编码的无符号整数形式表示具有该值的256位字。</li>
<li>一个ASCII字符串首先被看作是一个字节序列， 通过将非转义ASCII字符看作是一个单字节，其值是ASCII代码， 转义 <code>\xNN</code> 是具有该值的单字节， 转义 <code>\uNNNN</code> 是该代码点的UTF-8字节序列。 字节序列不得超过32字节。 字节序列在右边用零填充，以达到32个字节的长度； 换句话说，字符串是以左对齐的方式存储。 填充后的字节序列代表一个256位的字，其最有意义的8位是第一个字节的1， 也就是说，字节被解释为大端形式。</li>
<li>十六进制字符串首先被视为一个字节序列， 将每一对连续的十六进制数字视为一个字节。 字节序列不得超过32个字节（即64个十六进制数字），并按上述方法处理。</li>
</ul>
<p>当为EVM编译时，这将被翻译成一个适当的 <code>PUSHi</code> 指令。 在下面的例子中， <code>3</code> 和 <code>2</code> 相加的结果是 5， 然后计算与字符串 “abc” 的按位 <code>与（and）</code>。 最后的数值被分配到一个叫做 <code>x</code> 的局部变量。</p>
<p>上述32字节的限制并不适用于传递给需要字面参数的内置函数的字符串（例如， <code>setimmutable</code> 或 <code>loadimmutable</code>）。 这些字符串最终不会出现在生成的字节码中。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fremix.ethereum.org%2F%3F%23language%3Dyul%26version%3D0.8.24%26code%3DbGV0IHggOj0gYW5kKCJhYmMiLCBhZGQoMywgMikp" target="_blank" title="https://remix.ethereum.org/?#language=yul&amp;version=0.8.24&amp;code=bGV0IHggOj0gYW5kKCJhYmMiLCBhZGQoMywgMikp" ref="nofollow noopener noreferrer">open in Remix</a></p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">let</span> x := <span class="hljs-keyword">and</span>(<span class="hljs-string">"abc"</span>, <span class="hljs-keyword">add</span>(<span class="hljs-number">3</span>, <span class="hljs-number">2</span>))
</code></pre>
<p>除非是默认类型，否则字面的类型必须在冒号后指定：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fremix.ethereum.org%2F%3F%23language%3Dyul%26version%3D0.8.24%26code%3DLy8g6L%2BZ5bCG5LiN5Lya6KKr57yW6K%2BR77yIdTMy5ZKMdTI1Nuexu%2BWei%2BWwmuacquWunueOsO%2B8ieOAggpsZXQgeCA6PSBhbmQoImFiYyI6dTMyLCBhZGQoMzp1MjU2LCAyOnUyNTYpKQ%3D%3D" target="_blank" title="https://remix.ethereum.org/?#language=yul&amp;version=0.8.24&amp;code=Ly8g6L+Z5bCG5LiN5Lya6KKr57yW6K+R77yIdTMy5ZKMdTI1Nuexu+Wei+WwmuacquWunueOsO+8ieOAggpsZXQgeCA6PSBhbmQoImFiYyI6dTMyLCBhZGQoMzp1MjU2LCAyOnUyNTYpKQ==" ref="nofollow noopener noreferrer">open in Remix</a></p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 这将不会被编译（u32和u256类型尚未实现）。</span>
<span class="hljs-keyword">let</span> x := <span class="hljs-keyword">and</span>(<span class="hljs-string">"abc"</span>:u32, <span class="hljs-keyword">add</span>(<span class="hljs-number">3</span>:u256, <span class="hljs-number">2</span>:u256))
</code></pre>
<h3 data-id="heading-6"><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.soliditylang.org%2Fzh-cn%2Flatest%2Fyul.html%23id8" title="https://docs.soliditylang.org/zh-cn/latest/yul.html#id8" target="_blank" ref="nofollow noopener noreferrer">函数调用</a></h3>
<p>内置函数和用户定义的函数（见下文）都可以用前面例子中的相同方式调用。 如果函数返回一个单一的值，它可以直接在一个表达式中再次使用。 如果它返回多个值，则必须将它们分配给局部变量。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fremix.ethereum.org%2F%3F%23language%3Dyul%26version%3D0.8.24%26code%3DZnVuY3Rpb24gZih4LCB5KSAtPiBhLCBiIHsgLyogLi4uICovIH0KbXN0b3JlKDB4ODAsIGFkZChtbG9hZCgweDgwKSwgMykpCi8vIOatpOWkhO%2B8jOeUqOaIt%2BWumuS5ieeahOWHveaVsCBgZmAg6L%2BU5Zue5Lik5Liq5YC844CCCmxldCB4LCB5IDo9IGYoMSwgbWxvYWQoMCkp" target="_blank" title="https://remix.ethereum.org/?#language=yul&amp;version=0.8.24&amp;code=ZnVuY3Rpb24gZih4LCB5KSAtPiBhLCBiIHsgLyogLi4uICovIH0KbXN0b3JlKDB4ODAsIGFkZChtbG9hZCgweDgwKSwgMykpCi8vIOatpOWkhO+8jOeUqOaIt+WumuS5ieeahOWHveaVsCBgZmAg6L+U5Zue5Lik5Liq5YC844CCCmxldCB4LCB5IDo9IGYoMSwgbWxvYWQoMCkp" ref="nofollow noopener noreferrer">open in Remix</a></p>
<pre><code class="hljs language-scss" lang="scss">function <span class="hljs-built_in">f</span>(x, y) -&gt; <span class="hljs-selector-tag">a</span>, <span class="hljs-selector-tag">b</span> { <span class="hljs-comment">/* ... */</span> }
<span class="hljs-built_in">mstore</span>(<span class="hljs-number">0</span>x80, add(mload(<span class="hljs-number">0</span>x80), <span class="hljs-number">3</span>))
<span class="hljs-comment">// 此处，用户定义的函数 `f` 返回两个值。</span>
let x, y := <span class="hljs-built_in">f</span>(<span class="hljs-number">1</span>, <span class="hljs-built_in">mload</span>(<span class="hljs-number">0</span>))
</code></pre>
<p>对于EVM的内置函数，函数表达式可以直接转换为操作码流： 您只需从右到左读取表达式，就可以得到操作码。 在例子中的第二行，是 <code>PUSH1 3 PUSH1 0x80 MLOAD ADD PUSH1 0x80 MSTORE</code>。</p>
<p>对于调用用户定义的函数，参数也从右到左放在堆栈中，这是参数列表被评估的顺序。 然而，返回值是在堆栈中从左到右，即在这个例子中， <code>y</code> 在堆栈的顶部， <code>x</code> 在其下方。</p>
<h3 data-id="heading-7"><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.soliditylang.org%2Fzh-cn%2Flatest%2Fyul.html%23id9" title="https://docs.soliditylang.org/zh-cn/latest/yul.html#id9" target="_blank" ref="nofollow noopener noreferrer">变量声明</a></h3>
<p>您可以使用 <code>let</code> 关键字来声明变量。变量只在它所定义的 <code>{...}</code> 块内可见。 当编译到EVM时，会创建一个新的堆栈槽，为该变量保留，并在到达块的末端时自动移除。 您可以为该变量提供一个初始值。如果您不提供一个值，该变量将被初始化为零。</p>
<p>由于变量存储在堆栈中，它们不直接影响内存或存储， 但它们可以在内置函数 <code>mstore</code>， <code>mload</code>， <code>sstore</code> 和 <code>sload</code> 中作为内存或存储位置的指针使用。 未来的语言可能会为这种指针引入特定的类型。</p>
<p>当一个变量被引用时，其当前值被复制。 对于EVM来说，这相当于一个 <code>DUP</code> 指令。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fremix.ethereum.org%2F%3F%23language%3Dyul%26version%3D0.8.24%26code%3DewogICAgbGV0IHplcm8gOj0gMAogICAgbGV0IHYgOj0gY2FsbGRhdGFsb2FkKHplcm8pCiAgICB7CiAgICAgICAgbGV0IHkgOj0gYWRkKHNsb2FkKHYpLCAxKQogICAgICAgIHYgOj0geQogICAgfSAvLyB55Zyo6L%2BZ6YeM6KKrIOKAnOWIoOmZpOKAnSDkuoYKICAgIHNzdG9yZSh2LCB6ZXJvKQp9IC8vIHblkox6ZXJv5Zyo6L%2BZ6YeM6KKrIOKAnOWIoOmZpOKAneOAgg%3D%3D" target="_blank" title="https://remix.ethereum.org/?#language=yul&amp;version=0.8.24&amp;code=ewogICAgbGV0IHplcm8gOj0gMAogICAgbGV0IHYgOj0gY2FsbGRhdGFsb2FkKHplcm8pCiAgICB7CiAgICAgICAgbGV0IHkgOj0gYWRkKHNsb2FkKHYpLCAxKQogICAgICAgIHYgOj0geQogICAgfSAvLyB55Zyo6L+Z6YeM6KKrIOKAnOWIoOmZpOKAnSDkuoYKICAgIHNzdG9yZSh2LCB6ZXJvKQp9IC8vIHblkox6ZXJv5Zyo6L+Z6YeM6KKrIOKAnOWIoOmZpOKAneOAgg==" ref="nofollow noopener noreferrer">open in Remix</a></p>
<pre><code class="hljs language-javascript" lang="javascript">{
    <span class="hljs-keyword">let</span> zero := <span class="hljs-number">0</span>
    <span class="hljs-keyword">let</span> v := <span class="hljs-title function_">calldataload</span>(<span class="hljs-params">zero</span>)
    {
        <span class="hljs-keyword">let</span> y := <span class="hljs-title function_">add</span>(<span class="hljs-title function_">sload</span>(v), <span class="hljs-number">1</span>)
        v := y
    } <span class="hljs-comment">// y在这里被 “删除” 了</span>
    <span class="hljs-title function_">sstore</span>(v, zero)
} <span class="hljs-comment">// v和zero在这里被 “删除”。</span>
</code></pre>
<p>如果声明的变量应该有一个与默认类型不同的类型，您可以用冒号表示。 当您从一个返回多个值的函数调用中赋值时，您也可以在一条语句中声明多个变量。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fremix.ethereum.org%2F%3F%23language%3Dyul%26version%3D0.8.24%26code%3DLy8g6L%2BZ5bCG5LiN5Lya6KKr57yW6K%2BR77yIdTMy5ZKMdTI1Nuexu%2BWei%2BWwmuacquWunueOsO%2B8ieOAggp7CiAgICBsZXQgemVybzp1MzIgOj0gMDp1MzIKICAgIGxldCB2OnUyNTYsIHQ6dTMyIDo9IGYoKQogICAgbGV0IHgsIHkgOj0gZygpCn0%3D" target="_blank" title="https://remix.ethereum.org/?#language=yul&amp;version=0.8.24&amp;code=Ly8g6L+Z5bCG5LiN5Lya6KKr57yW6K+R77yIdTMy5ZKMdTI1Nuexu+Wei+WwmuacquWunueOsO+8ieOAggp7CiAgICBsZXQgemVybzp1MzIgOj0gMDp1MzIKICAgIGxldCB2OnUyNTYsIHQ6dTMyIDo9IGYoKQogICAgbGV0IHgsIHkgOj0gZygpCn0=" ref="nofollow noopener noreferrer">open in Remix</a></p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// 这将不会被编译（u32和u256类型尚未实现）。</span>
{
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">zero</span>:<span class="hljs-type">u32</span> := <span class="hljs-number">0</span>:<span class="hljs-type">u32</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">v</span>:u256, t:<span class="hljs-type">u32</span> := <span class="hljs-title function_ invoke__">f</span>()
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">x</span>, y := <span class="hljs-title function_ invoke__">g</span>()
}
</code></pre>
<p>根据优化器的设置，编译器可以在变量被最后一次使用后释放堆栈槽，即使它仍然在范围内。</p>
<h3 data-id="heading-8"><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.soliditylang.org%2Fzh-cn%2Flatest%2Fyul.html%23id10" title="https://docs.soliditylang.org/zh-cn/latest/yul.html#id10" target="_blank" ref="nofollow noopener noreferrer">赋值</a></h3>
<p>变量可以在其定义后使用 <code>:=</code> 操作符进行赋值。可以在同一时间对多个变量进行赋值。 为此，数值的数量和类型必须匹配。如果您想对一个有多个返回参数的函数进行赋值， 您必须提供多个变量。同一变量不能多次出现在赋值的左侧，例如： <code>x, x := f()</code> 是无效的。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fremix.ethereum.org%2F%3F%23language%3Dyul%26version%3D0.8.24%26code%3DbGV0IHYgOj0gMAovLyDph43mlrDlr7l26LWL5YC8CnYgOj0gMgpsZXQgdCA6PSBhZGQodiwgMikKZnVuY3Rpb24gZigpIC0%2BIGEsIGIgeyB9Ci8vIOi1i%2BS6iOWkmuS4quWAvAp2LCB0IDo9IGYoKQ%3D%3D" target="_blank" title="https://remix.ethereum.org/?#language=yul&amp;version=0.8.24&amp;code=bGV0IHYgOj0gMAovLyDph43mlrDlr7l26LWL5YC8CnYgOj0gMgpsZXQgdCA6PSBhZGQodiwgMikKZnVuY3Rpb24gZigpIC0+IGEsIGIgeyB9Ci8vIOi1i+S6iOWkmuS4quWAvAp2LCB0IDo9IGYoKQ==" ref="nofollow noopener noreferrer">open in Remix</a></p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">let</span> v := <span class="hljs-number">0</span>
<span class="hljs-comment">// 重新对v赋值</span>
v := <span class="hljs-number">2</span>
<span class="hljs-keyword">let</span> t := <span class="hljs-keyword">add</span>(v, <span class="hljs-number">2</span>)
<span class="hljs-function">function <span class="hljs-title">f</span>() -&gt; a, b</span> { }
<span class="hljs-comment">// 赋予多个值</span>
v, t := f()
</code></pre>
<h3 data-id="heading-9">If<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.soliditylang.org%2Fzh-cn%2Flatest%2Fyul.html%23if" title="https://docs.soliditylang.org/zh-cn/latest/yul.html#if" target="_blank" ref="nofollow noopener noreferrer"></a></h3>
<p>if语句可用于有条件地执行代码。不能定义 “else” 块。 如果您需要多种选择条件，可以考虑使用 “switch” 来代替（见下文）。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fremix.ethereum.org%2F%3F%23language%3Dyul%26version%3D0.8.24%26code%3DaWYgbHQoY2FsbGRhdGFzaXplKCksIDQpIHsgcmV2ZXJ0KDAsIDApIH0%3D" target="_blank" title="https://remix.ethereum.org/?#language=yul&amp;version=0.8.24&amp;code=aWYgbHQoY2FsbGRhdGFzaXplKCksIDQpIHsgcmV2ZXJ0KDAsIDApIH0=" ref="nofollow noopener noreferrer">open in Remix</a></p>
<pre><code class="hljs language-scss" lang="scss">if <span class="hljs-built_in">lt</span>(calldatasize(), <span class="hljs-number">4</span>) { <span class="hljs-built_in">revert</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>) }
</code></pre>
<p>代码块的大括号是必需的。</p>
<h3 data-id="heading-10">Switch<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.soliditylang.org%2Fzh-cn%2Flatest%2Fyul.html%23switch" title="https://docs.soliditylang.org/zh-cn/latest/yul.html#switch" target="_blank" ref="nofollow noopener noreferrer"></a></h3>
<p>您可以使用switch语句作为if语句的扩展版本。 它获取一个表达式的值，并将其与几个字面常量进行比较，与匹配的常量相对应的分支被选中。 与其他编程语言不同的是，出于安全考虑，控制流不会从一个条件延续到下一个条件。 可以有一个叫 <code>default</code> 的回退或默认情况，如果没有一个字面常数匹配，就会采取这种情况。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fremix.ethereum.org%2F%3F%23language%3Dyul%26version%3D0.8.24%26code%3DewogICAgbGV0IHggOj0gMAogICAgc3dpdGNoIGNhbGxkYXRhbG9hZCg0KQogICAgY2FzZSAwIHsKICAgICAgICB4IDo9IGNhbGxkYXRhbG9hZCgweDI0KQogICAgfQogICAgZGVmYXVsdCB7CiAgICAgICAgeCA6PSBjYWxsZGF0YWxvYWQoMHg0NCkKICAgIH0KICAgIHNzdG9yZSgwLCBkaXYoeCwgMikpCn0%3D" target="_blank" title="https://remix.ethereum.org/?#language=yul&amp;version=0.8.24&amp;code=ewogICAgbGV0IHggOj0gMAogICAgc3dpdGNoIGNhbGxkYXRhbG9hZCg0KQogICAgY2FzZSAwIHsKICAgICAgICB4IDo9IGNhbGxkYXRhbG9hZCgweDI0KQogICAgfQogICAgZGVmYXVsdCB7CiAgICAgICAgeCA6PSBjYWxsZGF0YWxvYWQoMHg0NCkKICAgIH0KICAgIHNzdG9yZSgwLCBkaXYoeCwgMikpCn0=" ref="nofollow noopener noreferrer">open in Remix</a></p>
<pre><code class="hljs language-css" lang="css">{
    let x := <span class="hljs-number">0</span>
    switch <span class="hljs-built_in">calldataload</span>(<span class="hljs-number">4</span>)
    case <span class="hljs-number">0</span> {
        x := <span class="hljs-built_in">calldataload</span>(<span class="hljs-number">0</span>x24)
    }
    default {
        x := <span class="hljs-built_in">calldataload</span>(<span class="hljs-number">0</span>x44)
    }
    sstore(<span class="hljs-number">0</span>, <span class="hljs-selector-tag">div</span>(x, <span class="hljs-number">2</span>))
}
</code></pre>
<p>条件的列表没有用大括号括起来，但条件的主体确实需要大括号。</p>
<h3 data-id="heading-11">循环<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.soliditylang.org%2Fzh-cn%2Flatest%2Fyul.html%23id11" title="https://docs.soliditylang.org/zh-cn/latest/yul.html#id11" target="_blank" ref="nofollow noopener noreferrer"></a></h3>
<p>Yul支持for循环，它由一个包含初始化部分的头，一个条件，一个后迭代部分和一个主体组成。 条件必须是一个表达式，而其他三个是代码块。 如果初始化部分在顶层声明了任何变量，这些变量的范围将延伸到循环的所有其他部分。</p>
<p><code>break</code> 和 <code>continue</code> 语句可以在主体中使用，分别用于退出循环或跳到后部分。</p>
<p>下面的例子是计算内存中一个代码区域的总和。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fremix.ethereum.org%2F%3F%23language%3Dyul%26version%3D0.8.24%26code%3DewogICAgbGV0IHggOj0gMAogICAgZm9yIHsgbGV0IGkgOj0gMCB9IGx0KGksIDB4MTAwKSB7IGkgOj0gYWRkKGksIDB4MjApIH0gewogICAgICAgIHggOj0gYWRkKHgsIG1sb2FkKGkpKQogICAgfQp9" target="_blank" title="https://remix.ethereum.org/?#language=yul&amp;version=0.8.24&amp;code=ewogICAgbGV0IHggOj0gMAogICAgZm9yIHsgbGV0IGkgOj0gMCB9IGx0KGksIDB4MTAwKSB7IGkgOj0gYWRkKGksIDB4MjApIH0gewogICAgICAgIHggOj0gYWRkKHgsIG1sb2FkKGkpKQogICAgfQp9" ref="nofollow noopener noreferrer">open in Remix</a></p>
<pre><code class="hljs language-css" lang="css">{
    let x := <span class="hljs-number">0</span>
    for { let <span class="hljs-selector-tag">i</span> := <span class="hljs-number">0</span> } lt(<span class="hljs-selector-tag">i</span>, <span class="hljs-number">0</span>x100) { <span class="hljs-selector-tag">i</span> := <span class="hljs-built_in">add</span>(i, <span class="hljs-number">0</span>x20) } {
        x := <span class="hljs-built_in">add</span>(x, <span class="hljs-built_in">mload</span>(i))
    }
}
</code></pre>
<p>For循环也可以作为while循环的替代： 只需将初始化和后迭代部分留为空即可。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fremix.ethereum.org%2F%3F%23language%3Dyul%26version%3D0.8.24%26code%3DewogICAgbGV0IHggOj0gMAogICAgbGV0IGkgOj0gMAogICAgZm9yIHsgfSBsdChpLCAweDEwMCkgeyB9IHsgICAgIC8vIHdoaWxlKGkgPCAweDEwMCkKICAgICAgICB4IDo9IGFkZCh4LCBtbG9hZChpKSkKICAgICAgICBpIDo9IGFkZChpLCAweDIwKQogICAgfQp9" target="_blank" title="https://remix.ethereum.org/?#language=yul&amp;version=0.8.24&amp;code=ewogICAgbGV0IHggOj0gMAogICAgbGV0IGkgOj0gMAogICAgZm9yIHsgfSBsdChpLCAweDEwMCkgeyB9IHsgICAgIC8vIHdoaWxlKGkgPCAweDEwMCkKICAgICAgICB4IDo9IGFkZCh4LCBtbG9hZChpKSkKICAgICAgICBpIDo9IGFkZChpLCAweDIwKQogICAgfQp9" ref="nofollow noopener noreferrer">open in Remix</a></p>
<pre><code class="hljs language-css" lang="css">{
    let x := <span class="hljs-number">0</span>
    let i := <span class="hljs-number">0</span>
    for { } lt(<span class="hljs-selector-tag">i</span>, <span class="hljs-number">0</span>x100) { } {     // while(<span class="hljs-selector-tag">i</span> &lt; <span class="hljs-number">0</span>x100)
        x := <span class="hljs-built_in">add</span>(x, <span class="hljs-built_in">mload</span>(i))
        i := <span class="hljs-built_in">add</span>(i, <span class="hljs-number">0</span>x20)
    }
}
</code></pre>
<h3 data-id="heading-12">函数声明<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.soliditylang.org%2Fzh-cn%2Flatest%2Fyul.html%23id12" title="https://docs.soliditylang.org/zh-cn/latest/yul.html#id12" target="_blank" ref="nofollow noopener noreferrer"></a></h3>
<p>Yul允许定义函数。这些不应该与 Solidity 中的函数相混淆，因为它们从来不是一个合约的外部接口的一部分， 而是一个独立于 Solidity 函数的命名空间的一部分。</p>
<p>对于EVM来说，Yul函数从堆栈中获取它们的参数（和一个返回的PC）， 同时也将结果放到堆栈中。用户定义的函数和内置函数的调用方式完全相同。</p>
<p>函数可以在任何地方定义，并且在它们所声明的块中是可见的。 在一个函数中，您不能访问在该函数之外定义的局部变量。</p>
<p>函数声明参数和返回变量，与Solidity类似。 为了返回一个值，您可以把它分配给返回变量。</p>
<p>如果您调用一个返回多个值的函数， 您必须用 <code>a, b := f(x)</code> 或 <code>let a, b := f(x)</code> 将它们分配给多个变量。</p>
<p><code>leave</code> 语句可以用来退出当前函数。它的工作原理类似于其他语言中的 <code>return</code> 语句， 只是它不需要返回值，它只是退出函数， 函数将返回当前分配给返回变量的任何值。</p>
<p>注意，EVM语言有一个内置的函数叫 <code>return</code>， 它可以退出整个执行环境（内部消息调用），而不仅仅是当前的yul函数。</p>
<p>下面的例子通过平方和乘法实现了幂函数。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fremix.ethereum.org%2F%3F%23language%3Dyul%26version%3D0.8.24%26code%3DewogICAgZnVuY3Rpb24gcG93ZXIoYmFzZSwgZXhwb25lbnQpIC0%2BIHJlc3VsdCB7CiAgICAgICAgc3dpdGNoIGV4cG9uZW50CiAgICAgICAgY2FzZSAwIHsgcmVzdWx0IDo9IDEgfQogICAgICAgIGNhc2UgMSB7IHJlc3VsdCA6PSBiYXNlIH0KICAgICAgICBkZWZhdWx0IHsKICAgICAgICAgICAgcmVzdWx0IDo9IHBvd2VyKG11bChiYXNlLCBiYXNlKSwgZGl2KGV4cG9uZW50LCAyKSkKICAgICAgICAgICAgc3dpdGNoIG1vZChleHBvbmVudCwgMikKICAgICAgICAgICAgICAgIGNhc2UgMSB7IHJlc3VsdCA6PSBtdWwoYmFzZSwgcmVzdWx0KSB9CiAgICAgICAgfQogICAgfQp9" target="_blank" title="https://remix.ethereum.org/?#language=yul&amp;version=0.8.24&amp;code=ewogICAgZnVuY3Rpb24gcG93ZXIoYmFzZSwgZXhwb25lbnQpIC0+IHJlc3VsdCB7CiAgICAgICAgc3dpdGNoIGV4cG9uZW50CiAgICAgICAgY2FzZSAwIHsgcmVzdWx0IDo9IDEgfQogICAgICAgIGNhc2UgMSB7IHJlc3VsdCA6PSBiYXNlIH0KICAgICAgICBkZWZhdWx0IHsKICAgICAgICAgICAgcmVzdWx0IDo9IHBvd2VyKG11bChiYXNlLCBiYXNlKSwgZGl2KGV4cG9uZW50LCAyKSkKICAgICAgICAgICAgc3dpdGNoIG1vZChleHBvbmVudCwgMikKICAgICAgICAgICAgICAgIGNhc2UgMSB7IHJlc3VsdCA6PSBtdWwoYmFzZSwgcmVzdWx0KSB9CiAgICAgICAgfQogICAgfQp9" ref="nofollow noopener noreferrer">open in Remix</a></p>
<pre><code class="hljs language-sql" lang="sql">{
    <span class="hljs-keyword">function</span> <span class="hljs-built_in">power</span>(base, exponent) <span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">result</span> {
        switch exponent
        <span class="hljs-keyword">case</span> <span class="hljs-number">0</span> { <span class="hljs-keyword">result</span> :<span class="hljs-operator">=</span> <span class="hljs-number">1</span> }
        <span class="hljs-keyword">case</span> <span class="hljs-number">1</span> { <span class="hljs-keyword">result</span> :<span class="hljs-operator">=</span> base }
        <span class="hljs-keyword">default</span> {
            <span class="hljs-keyword">result</span> :<span class="hljs-operator">=</span> <span class="hljs-built_in">power</span>(mul(base, base), div(exponent, <span class="hljs-number">2</span>))
            switch <span class="hljs-built_in">mod</span>(exponent, <span class="hljs-number">2</span>)
                <span class="hljs-keyword">case</span> <span class="hljs-number">1</span> { <span class="hljs-keyword">result</span> :<span class="hljs-operator">=</span> mul(base, <span class="hljs-keyword">result</span>) }
        }
    }
}
</code></pre>
<h2 data-id="heading-13">Yul形式规范<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.soliditylang.org%2Fzh-cn%2Flatest%2Fyul.html%23id13" title="https://docs.soliditylang.org/zh-cn/latest/yul.html#id13" target="_blank" ref="nofollow noopener noreferrer"></a></h2>
<p>本章正式描述Yul代码。Yul代码通常放置在Yul对象内， Yul对象将在它们自己的章节中解释。</p>
<pre><code class="hljs language-sql" lang="sql">代码块 <span class="hljs-operator">=</span> <span class="hljs-string">'{'</span> 语句<span class="hljs-operator">*</span> <span class="hljs-string">'}'</span>
语句 <span class="hljs-operator">=</span>
    代码块 <span class="hljs-operator">|</span>
    函数定义 <span class="hljs-operator">|</span>
    变量声明 <span class="hljs-operator">|</span>
    赋值 <span class="hljs-operator">|</span>
    If <span class="hljs-operator">|</span>
    表达式 <span class="hljs-operator">|</span>
    Switch <span class="hljs-operator">|</span>
    <span class="hljs-keyword">For</span> 循环 <span class="hljs-operator">|</span>
    循环中断 <span class="hljs-operator">|</span>
    退出
函数定义 <span class="hljs-operator">=</span>
    <span class="hljs-string">'function'</span> 标识符 <span class="hljs-string">'('</span> 带类型的标识符列表? <span class="hljs-string">')'</span>
    ( <span class="hljs-string">'-&gt;'</span> 带类型的标识符列表 )? 代码块
变量声明 <span class="hljs-operator">=</span>
    <span class="hljs-string">'let'</span> 带类型的标识符列表 ( <span class="hljs-string">':='</span> 表达式 )?
赋值 <span class="hljs-operator">=</span>
    标识符列表 <span class="hljs-string">':='</span> 表达式
表达式 <span class="hljs-operator">=</span>
    函数调用 <span class="hljs-operator">|</span> 标识符 <span class="hljs-operator">|</span> 字面量
If 条件语句 <span class="hljs-operator">=</span>
    <span class="hljs-string">'if'</span> 表达式 代码块
Switch 条件语句 <span class="hljs-operator">=</span>
    <span class="hljs-string">'switch'</span> 表达式 ( <span class="hljs-keyword">Case</span><span class="hljs-operator">+</span> <span class="hljs-keyword">Default</span>? <span class="hljs-operator">|</span> <span class="hljs-keyword">Default</span> )
<span class="hljs-keyword">Case</span> <span class="hljs-operator">=</span>
    <span class="hljs-string">'case'</span> 字面量 代码块
<span class="hljs-keyword">Default</span> <span class="hljs-operator">=</span>
    <span class="hljs-string">'default'</span> 代码块
<span class="hljs-keyword">For</span> 循环 <span class="hljs-operator">=</span>
    <span class="hljs-string">'for'</span> 代码块 表达式 代码块 代码块
循环中断 <span class="hljs-operator">=</span>
    <span class="hljs-string">'break'</span> <span class="hljs-operator">|</span> <span class="hljs-string">'continue'</span>
退出 <span class="hljs-operator">=</span> <span class="hljs-string">'leave'</span>
函数调用 <span class="hljs-operator">=</span>
    标识符 <span class="hljs-string">'('</span> ( 表达式 ( <span class="hljs-string">','</span> 表达式 )<span class="hljs-operator">*</span> )? <span class="hljs-string">')'</span>
标识符 <span class="hljs-operator">=</span> [a<span class="hljs-operator">-</span>zA<span class="hljs-operator">-</span>Z_$] [a<span class="hljs-operator">-</span>zA<span class="hljs-operator">-</span>Z_$<span class="hljs-number">0</span><span class="hljs-number">-9.</span>]<span class="hljs-operator">*</span>
标识符列表 <span class="hljs-operator">=</span> 标识符 ( <span class="hljs-string">','</span> 标识符)<span class="hljs-operator">*</span>
类型名 <span class="hljs-operator">=</span> 标识符
带类型的标识符列表 <span class="hljs-operator">=</span> 标识符 ( <span class="hljs-string">':'</span> 类型名 )? ( <span class="hljs-string">','</span> 标识符 ( <span class="hljs-string">':'</span> 类型名 )? )<span class="hljs-operator">*</span>
字面量 <span class="hljs-operator">=</span>
    (数字字面量 <span class="hljs-operator">|</span> 字符串字面量 <span class="hljs-operator">|</span> <span class="hljs-literal">True</span>字面量 <span class="hljs-operator">|</span> <span class="hljs-literal">False</span>字面量) ( <span class="hljs-string">':'</span> 类型名 )?
数字字面量 <span class="hljs-operator">=</span> 十六进制数字 <span class="hljs-operator">|</span> 十进制数字
字符串字面量 <span class="hljs-operator">=</span> <span class="hljs-string">'"'</span> ([<span class="hljs-operator">^</span>"\r\n\] | '\' .)* '"<span class="hljs-string">'
True字面量 = '</span><span class="hljs-literal">true</span><span class="hljs-string">'
False字面量 = '</span><span class="hljs-literal">false</span><span class="hljs-string">'
十六进制数字 = '</span><span class="hljs-number">0</span>x<span class="hljs-string">' [0-9a-fA-F]+
十进制数字 = [0-9]+
</span></code></pre>
<h3 data-id="heading-14">语法层面的限制<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.soliditylang.org%2Fzh-cn%2Flatest%2Fyul.html%23id14" title="https://docs.soliditylang.org/zh-cn/latest/yul.html#id14" target="_blank" ref="nofollow noopener noreferrer"></a></h3>
<p>除语法直接规定的限制外，还适用以下限制：</p>
<p>Switch 语句必须至少有一个判断条件（包括默认条件）。 所有情况下的值都需要有相同的类型和不同的值。 如果表达式类型的所有可能值都被覆盖，则不允许有默认情况 （例如，一个带有 <code>bool</code> 表达式的Switch 语句，如果有一个真和一个假的情况，则不允许有默认情况）。</p>
<p>每个表达式都评估为零或多个值。 标识符和字面量精确地评估为一个值， 而函数调用求值为所调用函数的返回值。</p>
<p>在变量声明和赋值中，右边的表达式（如果存在的话）必须求值到与左边的变量数量相等的数值。 这是唯一允许对一个以上的值进行评估的表达式的情况。 在赋值或变量声明的左侧，同一个变量名称不能出现多次。</p>
<p>也是语句的表达式（即在块级）必须评估为零值。</p>
<p>在所有其他情况下，表达式必须精确评估为一个值。</p>
<p><code>continue</code> 或 <code>break</code> 语句只能在for循环的主体内使用，如下所示。 考虑包含该语句的最内部循环。循环和语句必须在同一个函数中，或者两者必须在最高层。 该语句必须在循环的主体块中；不能在循环的初始化块或更新块中。 值得强调的是，这个限制只适用于包含 <code>continue</code> 或 <code>break</code> 语句的最内层循环： 这个最内层循环，以及 <code>continue</code> 或 <code>break</code> 语句， 可以出现在外层循环的任何地方，可能是外层循环的初始化块或更新块中。 例如，下面的例子是合法的，因为 <code>break</code> 出现在内循环的主体块中，尽管也出现在外循环的更新块中。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fremix.ethereum.org%2F%3F%23language%3Dyul%26version%3D0.8.24%26code%3DZm9yIHt9IHRydWUgeyBmb3Ige30gdHJ1ZSB7fSB7IGJyZWFrIH0gfQp7Cn0%3D" target="_blank" title="https://remix.ethereum.org/?#language=yul&amp;version=0.8.24&amp;code=Zm9yIHt9IHRydWUgeyBmb3Ige30gdHJ1ZSB7fSB7IGJyZWFrIH0gfQp7Cn0=" ref="nofollow noopener noreferrer">open in Remix</a></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">for</span> {} <span class="hljs-literal">true</span> { <span class="hljs-keyword">for</span> {} <span class="hljs-literal">true</span> {} { <span class="hljs-keyword">break</span> } }
{
}
</code></pre>
<p>for循环的条件部分必须精确评估为一个值。</p>
<p><code>leave</code> 语句只能在一个函数内使用。</p>
<p>函数不能在for循环初始化块的任何地方定义。</p>
<p>字面量不可以大于它们本身的类型。已定义的最大类型宽度为 256 比特。</p>
<p>在赋值和函数调用过程中，各个值的类型必须匹配。 没有隐式的类型转换。一般来说，只有当EVM语言提供一个适当的内置函数， 接收一个类型的值并返回一个不同类型的值时，才能实现类型转换。</p>
<h3 data-id="heading-15">作用域规则<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.soliditylang.org%2Fzh-cn%2Flatest%2Fyul.html%23id15" title="https://docs.soliditylang.org/zh-cn/latest/yul.html#id15" target="_blank" ref="nofollow noopener noreferrer"></a></h3>
<p>Yul中的作用域是与块联系在一起的（函数和for循环是例外，下面会解释）， 所有的声明（ <code>函数定义（FunctionDefinition）</code>， <code>变量声明（VariableDeclaration）</code>） 都将新的标识符引入这些作用域。</p>
<p>标识符在其定义的块中是可见的（包括所有子节点和子块）。 函数在整个块中是可见的（甚至在其定义之前）， 而变量只在 <code>变量声明</code> 之后的语句中可见。</p>
<p>特别是，变量不能在其自身变量声明的右侧被引用。 函数可以在其声明之前就被引用（如果它们是可见的）。</p>
<p>作为一般范围规则的一个例外，for 循环的 “init” 部分（第一个块）的范围延伸到for 循环的所有其他部分。 这意味着在init部分声明的变量（和函数）（但不在init部分的块内）在for循环的所有其他部分都是可见的。</p>
<p>在for循环的其他部分声明的标识符要遵守常规的句法范围规则。</p>
<p>这意味着一个for循环的形式 <code>for { I... } C { P... } { B... }</code> 等同于 <code>{ I... for {}. C { P... } { B...  }</code>.</p>
<p>函数的参数和返回参数在函数体中是可见的，其名称必须是不同的。</p>
<p>在函数内部，不可能引用一个在该函数之外声明的变量。</p>
<p>影子变量是不允许的，也就是说，您不能在另一个同名的标识符也可见的地方声明一个标识符， 即使因为它是在当前函数之外声明的而不可能引用它。</p>
<h3 data-id="heading-16">形式规范<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.soliditylang.org%2Fzh-cn%2Flatest%2Fyul.html%23id16" title="https://docs.soliditylang.org/zh-cn/latest/yul.html#id16" target="_blank" ref="nofollow noopener noreferrer"></a></h3>
<p>我们通过提供一个在AST的各个节点上重写的评估函数E来正式指定Yul。 由于内置函数可能有副作用，E接收两个状态对象和AST节点，并返回两个新的状态对象和数量不定的其他值。 这两个状态对象是全局状态对象（在EVM的背景下，它是区块链的内存、存储和状态） 和本地状态对象（本地变量的状态，即EVM中堆栈的一段）。</p>
<p>如果AST节点是一个语句，E返回两个状态对象和一个 “mode”， 该mode用于 <code>break</code>， <code>continue</code> 和 <code>leave</code> 语句。 如果AST节点是一个表达式，E返回两个状态对象和表达式所评估的数值。</p>
<p>全局状态的确切性质在这个高层次的描述中没有明确说明。 本地状态 <code>L</code> 是标识符 <code>i</code> 到值 <code>v</code> 的映射，表示为 <code>L[i] = v</code>。</p>
<p>对于标识符 <code>v</code>, 我们用 <code>$v</code> 作为标识符的名字。</p>
<p>我们将为 AST 节点使用解构符号。</p>
<pre><code class="hljs language-csharp" lang="csharp">E(G, L, &lt;{St1, ..., Stn}&gt;: Block) =
    <span class="hljs-keyword">let</span> G1, L1, mode = E(G, L, St1, ..., Stn)
    <span class="hljs-keyword">let</span> L2 be a restriction of L1 to the identifiers of L
    G1, L2, <span class="hljs-function">mode
<span class="hljs-title">E</span>(<span class="hljs-params">G, L, St1, ..., Stn: Statement</span>)</span> =
    <span class="hljs-keyword">if</span> n <span class="hljs-keyword">is</span> zero:
        G, L, regular
    <span class="hljs-keyword">else</span>:
        <span class="hljs-keyword">let</span> G1, L1, mode = E(G, L, St1)
        <span class="hljs-function"><span class="hljs-keyword">if</span> mode <span class="hljs-keyword">is</span> regular then
            <span class="hljs-title">E</span>(<span class="hljs-params">G1, L1, St2, ..., Stn</span>)
        otherwise
            G1, L1, mode
<span class="hljs-title">E</span>(<span class="hljs-params">G, L, FunctionDefinition</span>)</span> =
    G, L, <span class="hljs-function">regular
<span class="hljs-title">E</span>(<span class="hljs-params">G, L, &lt;<span class="hljs-keyword">let</span> var_1, ..., var_n := rhs&gt;: VariableDeclaration</span>)</span> =
    E(G, L, &lt;var_1, ..., var_n := rhs&gt;: Assignment)
E(G, L, &lt;<span class="hljs-keyword">let</span> var_1, ..., var_n&gt;: VariableDeclaration) =
    <span class="hljs-keyword">let</span> L1 be a copy of L <span class="hljs-keyword">where</span> L1[$var_i] = <span class="hljs-number">0</span> <span class="hljs-keyword">for</span> i = <span class="hljs-number">1</span>, ..., n
    G, L1, <span class="hljs-function">regular
<span class="hljs-title">E</span>(<span class="hljs-params">G, L, &lt;var_1, ..., var_n := rhs&gt;: Assignment</span>)</span> =
    <span class="hljs-keyword">let</span> G1, L1, v1, ..., vn = E(G, L, rhs)
    <span class="hljs-keyword">let</span> L2 be a copy of L1 <span class="hljs-keyword">where</span> L2[$var_i] = vi <span class="hljs-keyword">for</span> i = <span class="hljs-number">1</span>, ..., n
    G1, L2, <span class="hljs-function">regular
<span class="hljs-title">E</span>(<span class="hljs-params">G, L, &lt;<span class="hljs-keyword">for</span> { i1, ..., <span class="hljs-keyword">in</span> } condition post body&gt;: ForLoop</span>)</span> =
    <span class="hljs-keyword">if</span> n &gt;= <span class="hljs-number">1</span>:
        <span class="hljs-keyword">let</span> G1, L1, mode = E(G, L, i1, ..., <span class="hljs-keyword">in</span>)
        <span class="hljs-comment">// 由于语法限制，mode 必须是规则的</span>
        <span class="hljs-keyword">if</span> mode <span class="hljs-keyword">is</span> leave then
            G1, L1 restricted to variables of L, leave
        otherwise
            <span class="hljs-keyword">let</span> G2, L2, mode = E(G1, L1, <span class="hljs-keyword">for</span> {} condition post body)
            G2, L2 restricted to variables of L, mode
    <span class="hljs-keyword">else</span>:
        <span class="hljs-keyword">let</span> G1, L1, v = E(G, L, condition)
        <span class="hljs-keyword">if</span> v <span class="hljs-keyword">is</span> <span class="hljs-literal">false</span>:
            G1, L1, regular
        <span class="hljs-keyword">else</span>:
            <span class="hljs-keyword">let</span> G2, L2, mode = E(G1, L, body)
            <span class="hljs-keyword">if</span> mode <span class="hljs-keyword">is</span> <span class="hljs-keyword">break</span>:
                G2, L2, regular
            otherwise <span class="hljs-keyword">if</span> mode <span class="hljs-keyword">is</span> leave:
                G2, L2, leave
            <span class="hljs-keyword">else</span>:
                G3, L3, mode = E(G2, L2, post)
                <span class="hljs-keyword">if</span> mode <span class="hljs-keyword">is</span> leave:
                    G3, L3, <span class="hljs-function">leave
                otherwise
                    <span class="hljs-title">E</span>(<span class="hljs-params">G3, L3, <span class="hljs-keyword">for</span> {} condition post body</span>)
<span class="hljs-title">E</span>(<span class="hljs-params">G, L, <span class="hljs-keyword">break</span>: BreakContinue</span>)</span> =
    G, L, <span class="hljs-function"><span class="hljs-keyword">break</span>
<span class="hljs-title">E</span>(<span class="hljs-params">G, L, <span class="hljs-keyword">continue</span>: BreakContinue</span>)</span> =
    G, L, <span class="hljs-function"><span class="hljs-keyword">continue</span>
<span class="hljs-title">E</span>(<span class="hljs-params">G, L, leave: Leave</span>)</span> =
    G, L, <span class="hljs-function">leave
<span class="hljs-title">E</span>(<span class="hljs-params">G, L, &lt;<span class="hljs-keyword">if</span> condition body&gt;: If</span>)</span> =
    <span class="hljs-keyword">let</span> G0, L0, v = E(G, L, condition)
    <span class="hljs-keyword">if</span> v <span class="hljs-keyword">is</span> <span class="hljs-literal">true</span>:
        E(G0, L0, body)
    <span class="hljs-keyword">else</span>:
        G0, L0, <span class="hljs-function">regular
<span class="hljs-title">E</span>(<span class="hljs-params">G, L, &lt;<span class="hljs-keyword">switch</span> condition <span class="hljs-keyword">case</span> l1:t1 st1 ... <span class="hljs-keyword">case</span> ln:tn stn&gt;: Switch</span>)</span> =
    E(G, L, <span class="hljs-keyword">switch</span> condition <span class="hljs-keyword">case</span> l1:t1 st1 ... <span class="hljs-keyword">case</span> ln:tn stn <span class="hljs-literal">default</span> {})
E(G, L, &lt;<span class="hljs-keyword">switch</span> condition <span class="hljs-keyword">case</span> l1:t1 st1 ... <span class="hljs-keyword">case</span> ln:tn stn <span class="hljs-literal">default</span> st<span class="hljs-string">'&gt;: Switch) =
    let G0, L0, v = E(G, L, condition)
    // i = 1 .. n
    // 对字面量求值，上下文无关
    let _, _, v1 = E(G0, L0, l1)
    ...
    let _, _, vn = E(G0, L0, ln)
    if there exists smallest i such that vi = v:
        E(G0, L0, sti)
    else:
        E(G0, L0, st'</span>)

E(G, L, &lt;name&gt;: Identifier) =
    G, L, L[$name]
E(G, L, &lt;fname(arg1, ..., argn)&gt;: FunctionCall) =
    G1, L1, vn = E(G, L, argn)
    ...
    G(n<span class="hljs-number">-1</span>), L(n<span class="hljs-number">-1</span>), v2 = E(G(n<span class="hljs-number">-2</span>), L(n<span class="hljs-number">-2</span>), arg2)
    Gn, Ln, v1 = E(G(n<span class="hljs-number">-1</span>), L(n<span class="hljs-number">-1</span>), arg1)
    Let &lt;<span class="hljs-function">function <span class="hljs-title">fname</span> (<span class="hljs-params">param1, ..., paramn</span>) -&gt; ret1, ..., retm block&gt;
    be the function of name $fname visible at the point of the call.
    Let L' be a <span class="hljs-keyword">new</span> local state such that
    L'[$parami]</span> = vi <span class="hljs-keyword">and</span> L<span class="hljs-string">'[$reti] = 0 for all i.
    Let G'</span><span class="hljs-string">', L'</span><span class="hljs-string">', mode = E(Gn, L'</span>, block)
    G<span class="hljs-string">''</span>, Ln, L<span class="hljs-string">''</span>[$ret1], ..., L<span class="hljs-string">''</span>[$retm]
E(G, L, l: StringLiteral) = G, L, str(l),
    <span class="hljs-keyword">where</span> str <span class="hljs-keyword">is</span> the <span class="hljs-built_in">string</span> evaluation function,
    which <span class="hljs-keyword">for</span> the EVM dialect <span class="hljs-keyword">is</span> defined <span class="hljs-keyword">in</span> the section <span class="hljs-string">'Literals'</span> <span class="hljs-function">above
<span class="hljs-title">E</span>(<span class="hljs-params">G, L, n: HexNumber</span>)</span> = G, L, hex(n)
    <span class="hljs-keyword">where</span> hex <span class="hljs-keyword">is</span> the hexadecimal evaluation function,
    <span class="hljs-function">which turns a sequence of hexadecimal digits <span class="hljs-keyword">into</span> their big endian <span class="hljs-keyword">value</span>
<span class="hljs-title">E</span>(<span class="hljs-params">G, L, n: DecimalNumber</span>)</span> = G, L, dec(n),
    <span class="hljs-keyword">where</span> dec <span class="hljs-keyword">is</span> the <span class="hljs-built_in">decimal</span> evaluation function,
    which turns a sequence of <span class="hljs-built_in">decimal</span> digits <span class="hljs-keyword">into</span> their big endian <span class="hljs-keyword">value</span>
</code></pre>
<h3 data-id="heading-17">EVM语言<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.soliditylang.org%2Fzh-cn%2Flatest%2Fyul.html%23evm" title="https://docs.soliditylang.org/zh-cn/latest/yul.html#evm" target="_blank" ref="nofollow noopener noreferrer"></a></h3>
<p>目前Yul的默认语言是当前选择的EVM版本的EVM语言。 该语言中唯一可用的类型是 <code>u256</code>，即Ethereum虚拟机的256位本地类型。 因为它是该语言的默认类型，所以可以省略。</p>
<p>下表列出了所有内置函数（取决于EVM版本），并提供了函数/操作码的语义的简短描述。 本文件并不想成为以太坊虚拟机的完整描述。如果您对精确的语义感兴趣，请参考另一份文件。</p>
<p>标有 <code>-</code> 的操作码不返回结果，所有其他操作码正好返回一个值。 标有 <code>F</code>， <code>H</code>， <code>B</code>， <code>C</code>， <code>I</code>， <code>L</code>， <code>P</code> 和 <code>N</code> 的操作码分别 是从Frontier，Homestead，Byzantium，Constantinople，Istanbul，London，Paris或Cancun版本出现的。</p>
<p>在下文中， <code>mem[a...b)</code> 表示从位置 <code>a</code> 开始到不包括位置 <code>b</code> 的内存字节， <code>storage[p]</code> 表示插槽 <code>p</code> 的存储内容。 同样地， <code>transientStorage[p]</code> 表示插槽 <code>p</code> 处的临时存储内容。</p>
<p>由于Yul管理着局部变量和控制流，所以不能使用干扰这些功能的操作码。 这包括 <code>dup</code> 和 <code>swap</code> 指令，以及 <code>jump</code> 指令，标签和 <code>push</code> 指令。</p>























































































































































































































































































































































































































































































































<table><thead><tr><th>指令</th><th/><th/><th>解释</th></tr></thead><tbody><tr><td>stop()</td><td>-</td><td>F</td><td>停止执行，与return(0, 0)相同</td></tr><tr><td>add(x, y)</td><td/><td>F</td><td>x + y</td></tr><tr><td>sub(x, y)</td><td/><td>F</td><td>x - y</td></tr><tr><td>mul(x, y)</td><td/><td>F</td><td>x * y</td></tr><tr><td>div(x, y)</td><td/><td>F</td><td>x / y 或 如果 y == 0，则为 0</td></tr><tr><td>sdiv(x, y)</td><td/><td>F</td><td>x / y，对于有符号的二进制补码，如果 y == 0，则为 0</td></tr><tr><td>mod(x, y)</td><td/><td>F</td><td>x % y, 如果 y == 0，则为 0</td></tr><tr><td>smod(x, y)</td><td/><td>F</td><td>x % y, 对于有符号的二进制补码, 如果 y == 0，则为 0</td></tr><tr><td>exp(x, y)</td><td/><td>F</td><td>x的y次方</td></tr><tr><td>not(x)</td><td/><td>F</td><td>x的位 “非”（x的每一个位都取反）</td></tr><tr><td>lt(x, y)</td><td/><td>F</td><td>如果 x &lt; y，则为1，否则为0</td></tr><tr><td>gt(x, y)</td><td/><td>F</td><td>如果 x &gt; y，则为1，否则为0</td></tr><tr><td>slt(x, y)</td><td/><td>F</td><td>如果 x &lt; y，则为1，否则为0，适用于有符号的二进制补码</td></tr><tr><td>sgt(x, y)</td><td/><td>F</td><td>如果 x &gt; y，则为1，否则为0，适用于有符号的二进制补码</td></tr><tr><td>eq(x, y)</td><td/><td>F</td><td>如果 x == y，则为1，否则为0</td></tr><tr><td>iszero(x)</td><td/><td>F</td><td>如果 x == 0，则为1，否则为0</td></tr><tr><td>and(x, y)</td><td/><td>F</td><td>x 和 y 的按位 “与”</td></tr><tr><td>or(x, y)</td><td/><td>F</td><td>x 和 y 的按位 “或”</td></tr><tr><td>xor(x, y)</td><td/><td>F</td><td>x 和 y 的按位 “异或”</td></tr><tr><td>byte(n, x)</td><td/><td>F</td><td>x的第n个字节，其中最高有效字节是第0个字节</td></tr><tr><td>shl(x, y)</td><td/><td>C</td><td>将 y 逻辑左移 x 位</td></tr><tr><td>shr(x, y)</td><td/><td>C</td><td>将 y 逻辑右移 x 位</td></tr><tr><td>sar(x, y)</td><td/><td>C</td><td>有符号算术右移 y 的 x 位</td></tr><tr><td>addmod(x, y, m)</td><td/><td>F</td><td>(x + y) % m，采用任意精度算术，如果m == 0则为0</td></tr><tr><td>mulmod(x, y, m)</td><td/><td>F</td><td>(x * y) % m，采用任意精度算术，如果m == 0则为0</td></tr><tr><td>signextend(i, x)</td><td/><td>F</td><td>从最低有效位开始计数，从第 (i*8+7) 位进行符号扩展</td></tr><tr><td>keccak256(p, n)</td><td/><td>F</td><td>keccak(mem[p…(p+n)))</td></tr><tr><td>pc()</td><td/><td>F</td><td>代码中的当前位置</td></tr><tr><td>pop(x)</td><td>-</td><td>F</td><td>丢弃值 x</td></tr><tr><td>mload(p)</td><td/><td>F</td><td>mem[p…(p+32))</td></tr><tr><td>mstore(p, v)</td><td>-</td><td>F</td><td>mem[p…(p+32)) := v</td></tr><tr><td>mstore8(p, v)</td><td>-</td><td>F</td><td>mem[p] := v &amp; 0xff （只修改一个字节）</td></tr><tr><td>sload(p)</td><td/><td>F</td><td>storage[p]</td></tr><tr><td>sstore(p, v)</td><td>-</td><td>F</td><td>storage[p] := v</td></tr><tr><td>tload(p)</td><td/><td>N</td><td>transientStorage[p]</td></tr><tr><td>tstore(p, v)</td><td>-</td><td>N</td><td>transientStorage[p] := v</td></tr><tr><td>msize()</td><td/><td>F</td><td>内存的大小，即最大的访问内存索引</td></tr><tr><td>gas()</td><td/><td>F</td><td>仍可以执行的燃料值</td></tr><tr><td>address()</td><td/><td>F</td><td>当前合约/执行环境的地址</td></tr><tr><td>balance(a)</td><td/><td>F</td><td>地址为a的余额，以wei为单位</td></tr><tr><td>selfbalance()</td><td/><td>I</td><td>相当于balance(address())，但更便宜</td></tr><tr><td>caller()</td><td/><td>F</td><td>消息调用者（不包括 <code>delegatecall</code> 调用）</td></tr><tr><td>callvalue()</td><td/><td>F</td><td>与当前调用一起发送的wei的数量</td></tr><tr><td>calldataload(p)</td><td/><td>F</td><td>从位置p开始的调用数据（32字节）</td></tr><tr><td>calldatasize()</td><td/><td>F</td><td>调用数据的大小，以字节为单位</td></tr><tr><td>calldatacopy(t, f, s)</td><td>-</td><td>F</td><td>从位置f的调用数据复制s个字节到位置t的内存中</td></tr><tr><td>codesize()</td><td/><td>F</td><td>当前合约/执行环境的代码大小</td></tr><tr><td>codecopy(t, f, s)</td><td>-</td><td>F</td><td>从位置f的code中复制s个字节到位置t的内存中</td></tr><tr><td>extcodesize(a)</td><td/><td>F</td><td>地址为a的代码的大小</td></tr><tr><td>extcodecopy(a, t, f, s)</td><td>-</td><td>F</td><td>像 codecopy(t, f, s) 一样，但在地址a处取代码</td></tr><tr><td>returndatasize()</td><td/><td>B</td><td>最后返回数据的大小</td></tr><tr><td>returndatacopy(t, f, s)</td><td>-</td><td>B</td><td>从位置f的returndata复制s个字节到位置t的内存中</td></tr><tr><td>mcopy(t, f, s)</td><td>-</td><td>N</td><td>从位置f的内存复制s个字节到位置t的内存中</td></tr><tr><td>extcodehash(a)</td><td/><td>C</td><td>地址a的代码哈希值</td></tr><tr><td>create(v, p, n)</td><td/><td>F</td><td>创建新合约，其代码为内存中位置p到(p+n)的内容，发送v数量的wei 并返回新地址；错误时返回0</td></tr><tr><td>create2(v, p, n, s)</td><td/><td>C</td><td>创建新合约，其代码为内存中位置p到(p+n)的内容 合约地址为 keccak256(0xff . this . s . keccak256(mem[p…(p+n))) 并发送v数量wei然后返回新地址， 其中 <code>0xff</code> 是一个1字节的值， <code>this</code> 是当前合约的地址， 是一个20字节的值， <code>s</code> 是一个大端序的256位值； 错误时返回0</td></tr><tr><td>call(g, a, v, in, insize, out, outsize)</td><td/><td>F</td><td>调用地址为a的合约，输入数据为内存中位置in到(in+insize)的内容 一并发送g数量的燃料和v数量的wei，并将输出写入内存中 位置out到(out+outsize)的区域。 如果错误，返回0（比如，燃料耗尽） 成功则返回1 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.soliditylang.org%2Fzh-cn%2Flatest%2Fyul.html%23yul-call-return-area" target="_blank" title="https://docs.soliditylang.org/zh-cn/latest/yul.html#yul-call-return-area" ref="nofollow noopener noreferrer">查看更多</a></td></tr><tr><td>callcode(g, a, v, in, insize, out, outsize)</td><td/><td>F</td><td>相当于 <code>call</code> 但仅仅使用地址a上的代码 执行时留在当前合约的上下文当中 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.soliditylang.org%2Fzh-cn%2Flatest%2Fyul.html%23yul-call-return-area" target="_blank" title="https://docs.soliditylang.org/zh-cn/latest/yul.html#yul-call-return-area" ref="nofollow noopener noreferrer">查看更多</a></td></tr><tr><td>delegatecall(g, a, in, insize, out, outsize)</td><td/><td>H</td><td>相当于 <code>callcode</code>, 但同时保留 <code>caller</code> 和 <code>callvalue</code> <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.soliditylang.org%2Fzh-cn%2Flatest%2Fyul.html%23yul-call-return-area" target="_blank" title="https://docs.soliditylang.org/zh-cn/latest/yul.html#yul-call-return-area" ref="nofollow noopener noreferrer">查看更多</a></td></tr><tr><td>staticcall(g, a, in, insize, out, outsize)</td><td/><td>B</td><td>相当于 <code>call(g, a, 0, in, insize, out, outsize)</code> 但不允许状态变量的修改 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.soliditylang.org%2Fzh-cn%2Flatest%2Fyul.html%23yul-call-return-area" target="_blank" title="https://docs.soliditylang.org/zh-cn/latest/yul.html#yul-call-return-area" ref="nofollow noopener noreferrer">查看更多</a></td></tr><tr><td>return(p, s)</td><td>-</td><td>F</td><td>终止执行，并返回内存中位置p到(p+s)的数据</td></tr><tr><td>revert(p, s)</td><td>-</td><td>B</td><td>终止执行，回滚状态更改，并返回内存中位置p到(p+s)的数据</td></tr><tr><td>selfdestruct(a)</td><td>-</td><td>F</td><td>终止执行，销毁当前合约，并且将余额发送到地址a （已废弃）</td></tr><tr><td>invalid()</td><td>-</td><td>F</td><td>以无效指令终止执行</td></tr><tr><td>log0(p, s)</td><td>-</td><td>F</td><td>用内存中位置p到(p+s)的内容产生日志</td></tr><tr><td>log1(p, s, t1)</td><td>-</td><td>F</td><td>用内存中位置p到(p+s)的内容和 topic t1 产生日志</td></tr><tr><td>log2(p, s, t1, t2)</td><td>-</td><td>F</td><td>用内存中位置p到(p+s)的内容和 topic t1，t2 产生日志</td></tr><tr><td>log3(p, s, t1, t2, t3)</td><td>-</td><td>F</td><td>用内存中位置p到(p+s)的内容和 topic t1，t2，t3 产生日志</td></tr><tr><td>log4(p, s, t1, t2, t3, t4)</td><td>-</td><td>F</td><td>用内存中位置p到(p+s)的内容和 topic t1，t2，t3，t4 产生日志</td></tr><tr><td>chainid()</td><td/><td>I</td><td>执行链的ID（EIP-1344）</td></tr><tr><td>basefee()</td><td/><td>L</td><td>当前区块的基本费用（EIP-3198和EIP-1559）</td></tr><tr><td>blobbasefee()</td><td/><td>N</td><td>当前区块的blob的基本费用 （EIP-7516和EIP-4844）</td></tr><tr><td>origin()</td><td/><td>F</td><td>交易发送者</td></tr><tr><td>gasprice()</td><td/><td>F</td><td>交易的燃料价格</td></tr><tr><td>blockhash(b)</td><td/><td>F</td><td>区块编号b的哈希值-只针对最近的256个区块，不包括当前区块</td></tr><tr><td>blobhash(i)</td><td/><td>N</td><td>交易的第i个blob的版本化哈希值</td></tr><tr><td>coinbase()</td><td/><td>F</td><td>当前的挖矿的受益者</td></tr><tr><td>timestamp()</td><td/><td>F</td><td>自epoch开始的，当前块的时间戳，以秒为单位</td></tr><tr><td>number()</td><td/><td>F</td><td>当前区块号</td></tr><tr><td>difficulty()</td><td/><td>F</td><td>当前区块的难度（见下面的注释）</td></tr><tr><td>prevrandao()</td><td/><td>P</td><td>由信标链提供的随机性（见下面的注释）</td></tr><tr><td>gaslimit()</td><td/><td>F</td><td>当前区块的区块以太燃料限制</td></tr></tbody></table>
<p>备注</p>
<p><code>call*</code> 指令使用 <code>out</code> 和 <code>outsize</code> 参数来在内存中定义的一个区域， 用于放置返回或失败数据。这个区域的写入取决于被调用的合约返回多少字节。 如果它返回更多的数据，只有第一个 <code>outsize</code> 字节被写入。您可以使用 <code>returndatacopy</code> 操作码访问其余的数据。 如果它返回较少的数据，那么剩下的字节根本不被触及。 您需要使用 <code>returndatacopy</code> 操作码来检查这个内存区域的哪一部分包含返回数据。 剩下的字节将保留调用前的值。</p>
<p>备注</p>
<p><code>difficulty()</code> 指令在 EVM &gt;= Paris 版本中是不允许的。 随着 Paris 网络的升级，以前被称为 <code>difficulty</code> 的指令的语义已经改变， 该指令被重新命名为 <code>prevrandao</code>。 它现在可以返回全256位范围内的任意值， 而Ethash内部记录的最高难度值是~54位。 这一变化在 <a href="https://link.juejin.cn?target=https%3A%2F%2Feips.ethereum.org%2FEIPS%2Feip-4399" target="_blank" title="https://eips.ethereum.org/EIPS/eip-4399" ref="nofollow noopener noreferrer">EIP-4399</a> 中有所描述。 请注意，与在编译器中选择哪个EVM版本无关，指令的语义取决于最终的部署链。</p>
<p>警告</p>
<p>从0.8.18及更高版本开始，在 Solidity 和 Yul 中使用 <code>selfdestruct</code> 将触发弃用警告， 因为 <code>SELFDESTRUCT</code> 操作码最终将经历 <a href="https://link.juejin.cn?target=https%3A%2F%2Feips.ethereum.org%2FEIPS%2Feip-6049" target="_blank" title="https://eips.ethereum.org/EIPS/eip-6049" ref="nofollow noopener noreferrer">EIP-6049</a> 中所述的行为的重大变化。</p>
<p>在一些内部语言中，还有一些额外的函数：</p>
<h4 data-id="heading-18">datasize, dataoffset, datacopy<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.soliditylang.org%2Fzh-cn%2Flatest%2Fyul.html%23datasize-dataoffset-datacopy" title="https://docs.soliditylang.org/zh-cn/latest/yul.html#datasize-dataoffset-datacopy" target="_blank" ref="nofollow noopener noreferrer"></a></h4>
<p>函数 <code>datasize(x)</code>， <code>dataoffset(x)</code> 和 <code>datacopy(t, f, l)</code> 用来访问Yul对象的其他部分。</p>
<p><code>datasize</code> 和 <code>dataoffset</code> 只能接受字符串字面量（其他对象的名称）作为参数， 并分别返回数据区的大小和偏移量。 对于EVM， <code>datacopy</code> 函数等同于 <code>codecopy</code>。</p>
<h4 data-id="heading-19">setimmutable, loadimmutable<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.soliditylang.org%2Fzh-cn%2Flatest%2Fyul.html%23setimmutable-loadimmutable" title="https://docs.soliditylang.org/zh-cn/latest/yul.html#setimmutable-loadimmutable" target="_blank" ref="nofollow noopener noreferrer"></a></h4>
<p>函数 <code>setimmutable(offset, "name", value)</code> 和 <code>loadimmutable("name")</code> 用于Solidity中的不可变机制， 不能很好地映射到纯Yul。 对 <code>setimmutable(offset, "name", value)</code> 的调用假定包含给定不可变的命名的合约的运行时代码 在偏移量 <code>offset</code> 处被复制到内存中，并将把 <code>value</code> 写到内存中的所有位置（相对于 <code>offset</code>）， 这些位置包含在运行时代码中为调用 <code>loadimmutable("name")</code> 产生的占位符。</p>
<h4 data-id="heading-20">linkersymbol<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.soliditylang.org%2Fzh-cn%2Flatest%2Fyul.html%23linkersymbol" title="https://docs.soliditylang.org/zh-cn/latest/yul.html#linkersymbol" target="_blank" ref="nofollow noopener noreferrer"></a></h4>
<p>函数 <code>linkersymbol("library_id")</code> 是一个占位符，用来表示被链接器替换的地址字头。 它的第一个也是唯一的参数必须是一个字符串变量，并且唯一地代表要插入的地址。 标识符可以是任意的，但是当编译器从Solidity源产生Yul代码时，它使用一个库名， 并以定义该库的源单元的名称作为限定。 要用一个特定的库地址链接代码，必须在命令行上的 <code>--libraries</code> 选项中提供相同的标识符。</p>
<p>例如，这段代码</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fremix.ethereum.org%2F%3F%23language%3Dyul%26version%3D0.8.24%26code%3DbGV0IGEgOj0gbGlua2Vyc3ltYm9sKCJmaWxlLnNvbDpNYXRoIik%3D" target="_blank" title="https://remix.ethereum.org/?#language=yul&amp;version=0.8.24&amp;code=bGV0IGEgOj0gbGlua2Vyc3ltYm9sKCJmaWxlLnNvbDpNYXRoIik=" ref="nofollow noopener noreferrer">open in Remix</a></p>
<pre><code class="hljs language-css" lang="css">let <span class="hljs-selector-tag">a</span> := <span class="hljs-built_in">linkersymbol</span>(<span class="hljs-string">"file.sol:Math"</span>)
</code></pre>
<p>相当于</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fremix.ethereum.org%2F%3F%23language%3Dyul%26version%3D0.8.24%26code%3DbGV0IGEgOj0gMHgxMjM0NTY3ODkwMTIzNDU2Nzg5MDEyMzQ1Njc4OTAxMjM0NTY3ODkw" target="_blank" title="https://remix.ethereum.org/?#language=yul&amp;version=0.8.24&amp;code=bGV0IGEgOj0gMHgxMjM0NTY3ODkwMTIzNDU2Nzg5MDEyMzQ1Njc4OTAxMjM0NTY3ODkw" ref="nofollow noopener noreferrer">open in Remix</a></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">let</span> a := 0x1234567890123456789012345678901234567890
</code></pre>
<p>当使用 <code>--libraries "file.sol:Math=0x1234567890123456789012345678901234567890</code> 选项调用链接器时。</p>
<p>请参阅 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.soliditylang.org%2Fzh-cn%2Flatest%2Fusing-the-compiler.html%23commandline-compiler" target="_blank" title="https://docs.soliditylang.org/zh-cn/latest/using-the-compiler.html#commandline-compiler" ref="nofollow noopener noreferrer">使用命令行编译器</a> 以了解有关 Solidity 链接器的详情。</p>
<h4 data-id="heading-21">memoryguard<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.soliditylang.org%2Fzh-cn%2Flatest%2Fyul.html%23memoryguard" title="https://docs.soliditylang.org/zh-cn/latest/yul.html#memoryguard" target="_blank" ref="nofollow noopener noreferrer"></a></h4>
<p>调用 <code>let ptr := memoryguard(size)</code> 的调用者（其中 <code>size</code> 必须是一个数字字面量） 承诺他们只使用 <code>[0, size]</code> 范围内的内存，或者从 <code>ptr</code> 开始的无界范围。</p>
<p>由于 <code>memoryguard</code> 调用的存在表明所有的内存访问都遵守这一限制， 它允许优化器执行额外的优化步骤， 例如堆栈限制规避器，它试图将原本无法到达的堆栈变量转移到内存中。</p>
<p>Yul优化器承诺只使用内存范围 <code>[size, ptr)</code> 来实现其目的。 如果优化器不需要保留任何内存，它认为 <code>ptr == size</code>。</p>
<p><code>memoryguard</code> 可以被多次调用，但是需要在一个Yul子对象内有相同的字样作为参数。 如果在一个子对象中发现至少一个 <code>memoryguard</code> 的调用，额外的优化步骤将在它身上运行。</p>
<h4 data-id="heading-22">verbatim<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.soliditylang.org%2Fzh-cn%2Flatest%2Fyul.html%23verbatim" title="https://docs.soliditylang.org/zh-cn/latest/yul.html#verbatim" target="_blank" ref="nofollow noopener noreferrer"></a></h4>
<p>一组 <code>verbatim...</code> 内置函数可以让您为Yul编译器不知道的操作码创建字节码。 它还允许您创建不会被优化器修改的字节码序列。</p>
<p>这些函数是 <code>verbatim_&lt;n&gt;i_&lt;m&gt;o("&lt;data&gt;", ...)</code>，其中</p>
<ul>
<li><code>n</code> 是一个介于0和99之间的小数，指定输入栈槽/变量的数量</li>
<li><code>m</code> 是一个介于0和99之间的小数，指定输出栈槽/变量的数量</li>
<li><code>data</code> 是一个字符串字面量，包含字节的序列</li>
</ul>
<p>例如，如果您想定义一个函数，将输入值乘以2，而不需要优化器触及常数2，您可以使用</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fremix.ethereum.org%2F%3F%23language%3Dyul%26version%3D0.8.24%26code%3DbGV0IHggOj0gY2FsbGRhdGFsb2FkKDApCmxldCBkb3VibGUgOj0gdmVyYmF0aW1fMWlfMW8oaGV4IjYwMDIwMiIsIHgp" target="_blank" title="https://remix.ethereum.org/?#language=yul&amp;version=0.8.24&amp;code=bGV0IHggOj0gY2FsbGRhdGFsb2FkKDApCmxldCBkb3VibGUgOj0gdmVyYmF0aW1fMWlfMW8oaGV4IjYwMDIwMiIsIHgp" ref="nofollow noopener noreferrer">open in Remix</a></p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">let</span> x := calldataload(<span class="hljs-number">0</span>)
<span class="hljs-keyword">let</span> <span class="hljs-built_in">double</span> := verbatim_1i_1o(hex<span class="hljs-string">"600202"</span>, x)
</code></pre>
<p>这段代码将产生一个 <code>dup1</code> 操作码来检索 <code>x</code> （尽管优化器可能直接重新使用 <code>calldataload</code> 操作码的结果）， 后面直接是 <code>600202</code>。该代码被假定为消耗 <code>x</code> 的复制值，并在堆栈顶部产生结果。 然后编译器生成代码，为 <code>double</code> 分配一个堆栈槽，并将结果存储在那里。</p>
<p>与所有的操作码一样，参数被安排在堆栈中，最左边的参数在最上面， 而返回值则被假定是以最右边的变量在栈顶的方式排列的。</p>
<p>由于 <code>verbatim</code> 可以用来生成任意的操作码，甚至是Solidity编译器不知道的操作码， 在与优化器一起使用 <code>verbatim</code> 时，必须小心。 即使优化器被关闭，代码生成器也必须确定堆栈布局，这意味着，例如， 使用 <code>verbatim</code> 来修改堆栈高度会导致未定义行为。</p>
<p>下面是一个不完全的列表，列出了对逐字字节码的限制， 这些限制不被编译器检查。违反这些限制会导致未定义的行为。</p>
<ul>
<li>控制流不应该跳入或跳出 verbatim 块，但它可以在同一个 verbatim 块内跳入。</li>
<li>除了输入和输出参数外，堆栈内容不应该被访问。</li>
<li>堆栈的高度差应该正好是 <code>m - n</code> （输出槽减去输入槽）。</li>
<li>Verbatim字节码不能对周围的字节码做任何假设。 所有需要的参数都必须作为堆栈变量传入。</li>
</ul>
<p>优化器不分析 verbatim 字节码，总是假设它修改了状态的所有方面， 因此只能在 <code>verbatim</code> 函数调用中做很少的优化。</p>
<p>优化器将 verbatim 字节码视为一个不透明的代码块。它不会分割它， 但可能会移动、重复或与相同的 verbatim 字节码块结合。 如果一个 verbatim 的字节码块不能被控制流所触及。 它可以被删除。</p>
<p>警告</p>
<p>在讨论EVM的改进是否会破坏现有的智能合约时， <code>verbatim</code> 内部的功能不能得到与Solidity编译器本身使用的功能一样的考虑。</p>
<p>备注</p>
<p>为了避免混淆，所有以字符串 <code>verbatim</code> 开头的标识符都被保留， 不能用于用户定义的标识符。</p>
<h2 data-id="heading-23">Yul对象的规范<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.soliditylang.org%2Fzh-cn%2Flatest%2Fyul.html%23yul-object" title="https://docs.soliditylang.org/zh-cn/latest/yul.html#yul-object" target="_blank" ref="nofollow noopener noreferrer"></a></h2>
<p>Yul对象被用来分组命名代码和数据部分。 函数 <code>datasize</code>， <code>dataoffset</code> 和 <code>datacopy</code> 可以用来从代码中访问这些部分。 十六进制字符串可用于指定十六进制编码的数据， 普通字符串为本地编码。对于代码， <code>datacopy</code> 将访问其组装的二进制所表示的数据。</p>
<pre><code class="hljs language-python" lang="python">对象 = <span class="hljs-string">'object'</span> 字面量 <span class="hljs-string">'{'</span> 代码 ( 对象 | 数据 )* <span class="hljs-string">'}'</span>
代码 = <span class="hljs-string">'code'</span> 块
数据 = <span class="hljs-string">'data'</span> 字面量 ( 十六进制字面量 | 字面量 )
十六进制字面量 = <span class="hljs-string">'hex'</span> (<span class="hljs-string">'"'</span> ([<span class="hljs-number">0</span>-9a-fA-F]{<span class="hljs-number">2</span>})* <span class="hljs-string">'"'</span> | <span class="hljs-string">''' ([0-9a-fA-F]{2})* '''</span>)
字面量 = <span class="hljs-string">'"'</span> ([^<span class="hljs-string">"\r\n\] | '\' .)* '"</span><span class="hljs-string">'
</span></code></pre>
<p>对于上面的 <code>Block</code>，指的是前一章解释的Yul代码语法中的 <code>Block</code>。</p>
<p>备注</p>
<p>当一个对象的名称以 <code>_deployed</code> 结尾时，Yul 优化器将其视为部署的代码。 这样做的唯一后果是优化器中的不同燃料成本启发式算法。</p>
<p>备注</p>
<p>可以定义名称中包含 <code>.</code> 的数据对象或子对象， 但不可能通过 <code>datasize</code>， <code>dataoffset</code> 或 <code>datacopy</code> 访问它们， 因为 <code>.</code> 是作为分隔符用来访问另一个对象内的对象。</p>
<p>备注</p>
<p>被称为 <code>".metadata"</code> 的数据对象有特殊意义： 它不能从代码中访问，并且总是被附加到字节码的最末端， 无论它在对象中的位置如何。</p>
<p>其他具有特殊意义的数据对象在未来可能会被添加， 但它们的名字总是以 <code>.</code> 开头。</p>
<p>下面是一个Yul对象的例子：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fremix.ethereum.org%2F%3F%23language%3Dyul%26version%3D0.8.24%26code%3DLy8g5LiA5Liq5ZCI57qm55Sx5LiA5Liq5Y2V5LiA55qE5a%2B56LGh57uE5oiQ77yMCi8vIOWFtuWtkOWvueixoeS7o%2BihqOimgemDqOe9sueahOS7o%2BeggeaIluWug%2BWPr%2BS7peWIm%2BW7uueahOWFtuS7luWQiOe6puOAggovLyDljZXkuKog4oCc5Luj56CB4oCdIOiKgueCueaYr%2BivpeWvueixoeeahOWPr%2BaJp%2BihjOS7o%2BeggeOAggovLyDmr4%2FkuIDkuKrvvIjlhbbku5bvvInlkb3lkI3nmoTlr7nosaHmiJbmlbDmja7pg6jliIbpg73ooqvluo%2FliJfljJbvvIwKLy8g5bm26KKr54m55q6K55qE5YaF572u5Ye95pWwIGRhdGFjb3B5IC8gZGF0YW9mZnNldCAvIGRhdGFzaXplIOaJgOiuv%2BmXrgovLyDlvZPliY3lr7nosaHjgIHlrZDlr7nosaHlkozlvZPliY3lr7nosaHlhoXnmoTmlbDmja7pobnpg73lnKjojIPlm7TlhoXjgIIKb2JqZWN0ICJDb250cmFjdDEiIHsKICAgIC8vIOi%2FmeaYr%2BWQiOe6pueahOaehOmAoOWHveaVsOS7o%2BeggeOAggogICAgY29kZSB7CiAgICAgICAgZnVuY3Rpb24gYWxsb2NhdGUoc2l6ZSkgLT4gcHRyIHsKICAgICAgICAgICAgcHRyIDo9IG1sb2FkKDB4NDApCiAgICAgICAgICAgIC8vIOivt%2BazqOaEj%2B%2B8jFNvbGlkaXR5IOeUn%2BaIkOeahCBJUiDku6PnoIHkuZ%2Fkv53nlZnkuoblhoXlrZjlgY%2Fnp7vph48gYGAweDYwYGDvvIzkvYbkuIDkuKrnuq8gWXVsIOWvueixoeWPr%2BS7peiHqueUseWcsOS9v%2BeUqOWGheWtmOOAggogICAgICAgICAgICBpZiBpc3plcm8ocHRyKSB7IHB0ciA6PSAweDYwIH0KICAgICAgICAgICAgbXN0b3JlKDB4NDAsIGFkZChwdHIsIHNpemUpKQogICAgICAgIH0KCiAgICAgICAgLy8g6aaW5YWI5Yib5bu6IOKAnENvbnRyYWN0MuKAnQogICAgICAgIGxldCBzaXplIDo9IGRhdGFzaXplKCJDb250cmFjdDIiKQogICAgICAgIGxldCBvZmZzZXQgOj0gYWxsb2NhdGUoc2l6ZSkKICAgICAgICAvLyDov5nlsIbovazljJbkuLpFVk3nmoTku6PnoIHmi7fotJ3jgIIKICAgICAgICBkYXRhY29weShvZmZzZXQsIGRhdGFvZmZzZXQoIkNvbnRyYWN0MiIpLCBzaXplKQogICAgICAgIC8vIOaehOmAoOWHveaVsOWPguaVsOaYr%2BS4gOS4quWNleS4gOeahOaVsOWtlyAweDEyMzQKICAgICAgICBtc3RvcmUoYWRkKG9mZnNldCwgc2l6ZSksIDB4MTIzNCkKICAgICAgICBwb3AoY3JlYXRlKDAsIG9mZnNldCwgYWRkKHNpemUsIDMyKSkpCgogICAgICAgIC8vIOeOsOWcqOi%2FlOWbnui%2FkOihjOaXtuWvueixoQogICAgICAgIC8vIOW9k%2BWJjeaJp%2BihjOeahOS7o%2BeggeaYr%2BaehOmAoOWHveaVsOS7o%2Begge%2B8ieOAggogICAgICAgIHNpemUgOj0gZGF0YXNpemUoIkNvbnRyYWN0MV9kZXBsb3llZCIpCiAgICAgICAgb2Zmc2V0IDo9IGFsbG9jYXRlKHNpemUpCiAgICAgICAgLy8g6L%2BZ5bCG5Y%2BY5oiQRVZN55qE5Luj56CB5ou36LSd44CCCiAgICAgICAgZGF0YWNvcHkob2Zmc2V0LCBkYXRhb2Zmc2V0KCJDb250cmFjdDFfZGVwbG95ZWQiKSwgc2l6ZSkKICAgICAgICByZXR1cm4ob2Zmc2V0LCBzaXplKQogICAgfQoKICAgIGRhdGEgIlRhYmxlMiIgaGV4IjQxMjMiCgogICAgb2JqZWN0ICJDb250cmFjdDFfZGVwbG95ZWQiIHsKICAgICAgICBjb2RlIHsKICAgICAgICAgICAgZnVuY3Rpb24gYWxsb2NhdGUoc2l6ZSkgLT4gcHRyIHsKICAgICAgICAgICAgICAgIHB0ciA6PSBtbG9hZCgweDQwKQogICAgICAgICAgICAgICAgLy8g6K%2B35rOo5oSP77yMU29saWRpdHkg55Sf5oiQ55qEIElSIOS7o%2BeggeS5n%2BS%2FneeVmeS6huWGheWtmOWBj%2Benu%2BmHjyBgYDB4NjBgYO%2B8jOS9huS4gOS4que6ryBZdWwg5a%2B56LGh5Y%2Bv5Lul6Ieq55Sx5Zyw5L2%2F55So5YaF5a2Y44CCCiAgICAgICAgICAgICAgICBpZiBpc3plcm8ocHRyKSB7IHB0ciA6PSAweDYwIH0KICAgICAgICAgICAgICAgIG1zdG9yZSgweDQwLCBhZGQocHRyLCBzaXplKSkKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8g6L%2BQ6KGM5pe25Luj56CBCgogICAgICAgICAgICBtc3RvcmUoMCwgIkhlbGxvLCBXb3JsZCEiKQogICAgICAgICAgICByZXR1cm4oMCwgMHgyMCkKICAgICAgICB9CiAgICB9CgogICAgLy8g5bWM5YWl5a%2B56LGh44CC5L2%2F55So5oOF5Ya15piv77yM5aSW6Z2i5piv5LiA5Liq5bel5Y6C5ZCI57qm77yMCiAgICAvLyDogIwgQ29udHJhY3QyIOaYr%2BeUseW3peWOguWIm%2BW7uueahOS7o%2BeggeOAggogICAgb2JqZWN0ICJDb250cmFjdDIiIHsKICAgICAgICBjb2RlIHsKICAgICAgICAgICAgLy8g5q2k5aSE5piv5Luj56CBIC4uLgogICAgICAgIH0KCiAgICAgICAgb2JqZWN0ICJDb250cmFjdDJfZGVwbG95ZWQiIHsKICAgICAgICAgICAgY29kZSB7CiAgICAgICAgICAgICAgICAvLyDmraTlpITmmK%2Fku6PnoIEgLi4uCiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGRhdGEgIlRhYmxlMSIgaGV4IjQxMjMiCiAgICB9Cn0%3D" target="_blank" title="https://remix.ethereum.org/?#language=yul&amp;version=0.8.24&amp;code=Ly8g5LiA5Liq5ZCI57qm55Sx5LiA5Liq5Y2V5LiA55qE5a+56LGh57uE5oiQ77yMCi8vIOWFtuWtkOWvueixoeS7o+ihqOimgemDqOe9sueahOS7o+eggeaIluWug+WPr+S7peWIm+W7uueahOWFtuS7luWQiOe6puOAggovLyDljZXkuKog4oCc5Luj56CB4oCdIOiKgueCueaYr+ivpeWvueixoeeahOWPr+aJp+ihjOS7o+eggeOAggovLyDmr4/kuIDkuKrvvIjlhbbku5bvvInlkb3lkI3nmoTlr7nosaHmiJbmlbDmja7pg6jliIbpg73ooqvluo/liJfljJbvvIwKLy8g5bm26KKr54m55q6K55qE5YaF572u5Ye95pWwIGRhdGFjb3B5IC8gZGF0YW9mZnNldCAvIGRhdGFzaXplIOaJgOiuv+mXrgovLyDlvZPliY3lr7nosaHjgIHlrZDlr7nosaHlkozlvZPliY3lr7nosaHlhoXnmoTmlbDmja7pobnpg73lnKjojIPlm7TlhoXjgIIKb2JqZWN0ICJDb250cmFjdDEiIHsKICAgIC8vIOi/meaYr+WQiOe6pueahOaehOmAoOWHveaVsOS7o+eggeOAggogICAgY29kZSB7CiAgICAgICAgZnVuY3Rpb24gYWxsb2NhdGUoc2l6ZSkgLT4gcHRyIHsKICAgICAgICAgICAgcHRyIDo9IG1sb2FkKDB4NDApCiAgICAgICAgICAgIC8vIOivt+azqOaEj++8jFNvbGlkaXR5IOeUn+aIkOeahCBJUiDku6PnoIHkuZ/kv53nlZnkuoblhoXlrZjlgY/np7vph48gYGAweDYwYGDvvIzkvYbkuIDkuKrnuq8gWXVsIOWvueixoeWPr+S7peiHqueUseWcsOS9v+eUqOWGheWtmOOAggogICAgICAgICAgICBpZiBpc3plcm8ocHRyKSB7IHB0ciA6PSAweDYwIH0KICAgICAgICAgICAgbXN0b3JlKDB4NDAsIGFkZChwdHIsIHNpemUpKQogICAgICAgIH0KCiAgICAgICAgLy8g6aaW5YWI5Yib5bu6IOKAnENvbnRyYWN0MuKAnQogICAgICAgIGxldCBzaXplIDo9IGRhdGFzaXplKCJDb250cmFjdDIiKQogICAgICAgIGxldCBvZmZzZXQgOj0gYWxsb2NhdGUoc2l6ZSkKICAgICAgICAvLyDov5nlsIbovazljJbkuLpFVk3nmoTku6PnoIHmi7fotJ3jgIIKICAgICAgICBkYXRhY29weShvZmZzZXQsIGRhdGFvZmZzZXQoIkNvbnRyYWN0MiIpLCBzaXplKQogICAgICAgIC8vIOaehOmAoOWHveaVsOWPguaVsOaYr+S4gOS4quWNleS4gOeahOaVsOWtlyAweDEyMzQKICAgICAgICBtc3RvcmUoYWRkKG9mZnNldCwgc2l6ZSksIDB4MTIzNCkKICAgICAgICBwb3AoY3JlYXRlKDAsIG9mZnNldCwgYWRkKHNpemUsIDMyKSkpCgogICAgICAgIC8vIOeOsOWcqOi/lOWbnui/kOihjOaXtuWvueixoQogICAgICAgIC8vIOW9k+WJjeaJp+ihjOeahOS7o+eggeaYr+aehOmAoOWHveaVsOS7o+egge+8ieOAggogICAgICAgIHNpemUgOj0gZGF0YXNpemUoIkNvbnRyYWN0MV9kZXBsb3llZCIpCiAgICAgICAgb2Zmc2V0IDo9IGFsbG9jYXRlKHNpemUpCiAgICAgICAgLy8g6L+Z5bCG5Y+Y5oiQRVZN55qE5Luj56CB5ou36LSd44CCCiAgICAgICAgZGF0YWNvcHkob2Zmc2V0LCBkYXRhb2Zmc2V0KCJDb250cmFjdDFfZGVwbG95ZWQiKSwgc2l6ZSkKICAgICAgICByZXR1cm4ob2Zmc2V0LCBzaXplKQogICAgfQoKICAgIGRhdGEgIlRhYmxlMiIgaGV4IjQxMjMiCgogICAgb2JqZWN0ICJDb250cmFjdDFfZGVwbG95ZWQiIHsKICAgICAgICBjb2RlIHsKICAgICAgICAgICAgZnVuY3Rpb24gYWxsb2NhdGUoc2l6ZSkgLT4gcHRyIHsKICAgICAgICAgICAgICAgIHB0ciA6PSBtbG9hZCgweDQwKQogICAgICAgICAgICAgICAgLy8g6K+35rOo5oSP77yMU29saWRpdHkg55Sf5oiQ55qEIElSIOS7o+eggeS5n+S/neeVmeS6huWGheWtmOWBj+enu+mHjyBgYDB4NjBgYO+8jOS9huS4gOS4que6ryBZdWwg5a+56LGh5Y+v5Lul6Ieq55Sx5Zyw5L2/55So5YaF5a2Y44CCCiAgICAgICAgICAgICAgICBpZiBpc3plcm8ocHRyKSB7IHB0ciA6PSAweDYwIH0KICAgICAgICAgICAgICAgIG1zdG9yZSgweDQwLCBhZGQocHRyLCBzaXplKSkKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8g6L+Q6KGM5pe25Luj56CBCgogICAgICAgICAgICBtc3RvcmUoMCwgIkhlbGxvLCBXb3JsZCEiKQogICAgICAgICAgICByZXR1cm4oMCwgMHgyMCkKICAgICAgICB9CiAgICB9CgogICAgLy8g5bWM5YWl5a+56LGh44CC5L2/55So5oOF5Ya15piv77yM5aSW6Z2i5piv5LiA5Liq5bel5Y6C5ZCI57qm77yMCiAgICAvLyDogIwgQ29udHJhY3QyIOaYr+eUseW3peWOguWIm+W7uueahOS7o+eggeOAggogICAgb2JqZWN0ICJDb250cmFjdDIiIHsKICAgICAgICBjb2RlIHsKICAgICAgICAgICAgLy8g5q2k5aSE5piv5Luj56CBIC4uLgogICAgICAgIH0KCiAgICAgICAgb2JqZWN0ICJDb250cmFjdDJfZGVwbG95ZWQiIHsKICAgICAgICAgICAgY29kZSB7CiAgICAgICAgICAgICAgICAvLyDmraTlpITmmK/ku6PnoIEgLi4uCiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGRhdGEgIlRhYmxlMSIgaGV4IjQxMjMiCiAgICB9Cn0=" ref="nofollow noopener noreferrer">open in Remix</a></p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 一个合约由一个单一的对象组成，</span>
<span class="hljs-comment">// 其子对象代表要部署的代码或它可以创建的其他合约。</span>
<span class="hljs-comment">// 单个 “代码” 节点是该对象的可执行代码。</span>
<span class="hljs-comment">// 每一个（其他）命名的对象或数据部分都被序列化，</span>
<span class="hljs-comment">// 并被特殊的内置函数 datacopy / dataoffset / datasize 所访问</span>
<span class="hljs-comment">// 当前对象、子对象和当前对象内的数据项都在范围内。</span>
<span class="hljs-built_in">object</span> <span class="hljs-string">"Contract1"</span> {
    <span class="hljs-comment">// 这是合约的构造函数代码。</span>
    code {
        <span class="hljs-function">function <span class="hljs-title">allocate</span>(<span class="hljs-params">size</span>) -&gt; ptr</span> {
            ptr := mload(<span class="hljs-number">0x40</span>)
            <span class="hljs-comment">// 请注意，Solidity 生成的 IR 代码也保留了内存偏移量 ``0x60``，但一个纯 Yul 对象可以自由地使用内存。</span>
            <span class="hljs-function"><span class="hljs-keyword">if</span> <span class="hljs-title">iszero</span>(<span class="hljs-params">ptr</span>)</span> { ptr := <span class="hljs-number">0x60</span> }
            mstore(<span class="hljs-number">0x40</span>, <span class="hljs-keyword">add</span>(ptr, size))
        }

        <span class="hljs-comment">// 首先创建 “Contract2”</span>
        <span class="hljs-keyword">let</span> size := datasize(<span class="hljs-string">"Contract2"</span>)
        <span class="hljs-keyword">let</span> offset := allocate(size)
        <span class="hljs-comment">// 这将转化为EVM的代码拷贝。</span>
        datacopy(offset, dataoffset(<span class="hljs-string">"Contract2"</span>), size)
        <span class="hljs-comment">// 构造函数参数是一个单一的数字 0x1234</span>
        mstore(<span class="hljs-keyword">add</span>(offset, size), <span class="hljs-number">0x1234</span>)
        pop(create(<span class="hljs-number">0</span>, offset, <span class="hljs-keyword">add</span>(size, <span class="hljs-number">32</span>)))

        <span class="hljs-comment">// 现在返回运行时对象</span>
        <span class="hljs-comment">// 当前执行的代码是构造函数代码）。</span>
        size := datasize(<span class="hljs-string">"Contract1_deployed"</span>)
        offset := allocate(size)
        <span class="hljs-comment">// 这将变成EVM的代码拷贝。</span>
        datacopy(offset, dataoffset(<span class="hljs-string">"Contract1_deployed"</span>), size)
        <span class="hljs-keyword">return</span>(offset, size)
    }

    data <span class="hljs-string">"Table2"</span> hex<span class="hljs-string">"4123"</span>

    <span class="hljs-built_in">object</span> <span class="hljs-string">"Contract1_deployed"</span> {
        code {
            <span class="hljs-function">function <span class="hljs-title">allocate</span>(<span class="hljs-params">size</span>) -&gt; ptr</span> {
                ptr := mload(<span class="hljs-number">0x40</span>)
                <span class="hljs-comment">// 请注意，Solidity 生成的 IR 代码也保留了内存偏移量 ``0x60``，但一个纯 Yul 对象可以自由地使用内存。</span>
                <span class="hljs-function"><span class="hljs-keyword">if</span> <span class="hljs-title">iszero</span>(<span class="hljs-params">ptr</span>)</span> { ptr := <span class="hljs-number">0x60</span> }
                mstore(<span class="hljs-number">0x40</span>, <span class="hljs-keyword">add</span>(ptr, size))
            }

            <span class="hljs-comment">// 运行时代码</span>

            mstore(<span class="hljs-number">0</span>, <span class="hljs-string">"Hello, World!"</span>)
            <span class="hljs-keyword">return</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0x20</span>)
        }
    }

    <span class="hljs-comment">// 嵌入对象。使用情况是，外面是一个工厂合约，</span>
    <span class="hljs-comment">// 而 Contract2 是由工厂创建的代码。</span>
    <span class="hljs-built_in">object</span> <span class="hljs-string">"Contract2"</span> {
        code {
            <span class="hljs-comment">// 此处是代码 ...</span>
        }

        <span class="hljs-built_in">object</span> <span class="hljs-string">"Contract2_deployed"</span> {
            code {
                <span class="hljs-comment">// 此处是代码 ...</span>
            }
        }

        data <span class="hljs-string">"Table1"</span> hex<span class="hljs-string">"4123"</span>
    }
}
</code></pre>
<h2 data-id="heading-24">Yul 优化器<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.soliditylang.org%2Fzh-cn%2Flatest%2Fyul.html%23id18" title="https://docs.soliditylang.org/zh-cn/latest/yul.html#id18" target="_blank" ref="nofollow noopener noreferrer"></a></h2>
<p>Yul优化器对Yul代码进行操作，并对输入、输出和中间状态使用相同的语言。这使得优化器的调试和验证变得容易。</p>
<p>请参考一般的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.soliditylang.org%2Fzh-cn%2Flatest%2Finternals%2Foptimizer.html%23optimizer" target="_blank" title="https://docs.soliditylang.org/zh-cn/latest/internals/optimizer.html#optimizer" ref="nofollow noopener noreferrer">优化器文档</a>，以了解关于不同优化阶段和如何使用优化器的更多细节。</p>
<p>如果您想在独立的Yul模式下使用Solidity，您可以用 <code>--optimize</code> 激活优化器， 并可选择用 <code>--optimize-runs</code> 指定 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.soliditylang.org%2Fzh-cn%2Flatest%2Finternals%2Foptimizer.html%23optimizer-parameter-runs" target="_blank" title="https://docs.soliditylang.org/zh-cn/latest/internals/optimizer.html#optimizer-parameter-runs" ref="nofollow noopener noreferrer">预期合约执行次数</a>：</p>
<pre><code class="hljs language-css" lang="css">solc <span class="hljs-attr">--strict-assembly</span> <span class="hljs-attr">--optimize</span> <span class="hljs-attr">--optimize-runs</span> <span class="hljs-number">200</span>
</code></pre>
<p>在Solidity模式下，Yul优化器与常规优化器一起被激活。</p>
<h3 data-id="heading-25">优化步骤顺序<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.soliditylang.org%2Fzh-cn%2Flatest%2Fyul.html%23optimization-step-sequence" title="https://docs.soliditylang.org/zh-cn/latest/yul.html#optimization-step-sequence" target="_blank" ref="nofollow noopener noreferrer"></a></h3>
<p>有关优化顺序的详细信息以及缩写列表可在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.soliditylang.org%2Fzh-cn%2Flatest%2Finternals%2Foptimizer.html%23optimizer-steps" target="_blank" title="https://docs.soliditylang.org/zh-cn/latest/internals/optimizer.html#optimizer-steps" ref="nofollow noopener noreferrer">优化器文档</a> 中找到。</p>
<h2 data-id="heading-26">完整的ERC20示例（基于yul）<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.soliditylang.org%2Fzh-cn%2Flatest%2Fyul.html%23erc20-yul" title="https://docs.soliditylang.org/zh-cn/latest/yul.html#erc20-yul" target="_blank" ref="nofollow noopener noreferrer"></a></h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fremix.ethereum.org%2F%3F%23language%3Dyul%26version%3D0.8.24%26code%3Db2JqZWN0ICJUb2tlbiIgewogICAgY29kZSB7CiAgICAgICAgLy8g5bCG5Yib5bu66ICF5a2Y5YKo5Zyo6Zu25Y%2B35qe95Lit44CCCiAgICAgICAgc3N0b3JlKDAsIGNhbGxlcigpKQoKICAgICAgICAvLyDpg6jnvbLlkIjnuqYKICAgICAgICBkYXRhY29weSgwLCBkYXRhb2Zmc2V0KCJydW50aW1lIiksIGRhdGFzaXplKCJydW50aW1lIikpCiAgICAgICAgcmV0dXJuKDAsIGRhdGFzaXplKCJydW50aW1lIikpCiAgICB9CiAgICBvYmplY3QgInJ1bnRpbWUiIHsKICAgICAgICBjb2RlIHsKICAgICAgICAgICAgLy8g6Ziy5q2i5Y%2BR6YCB5Lul5aSq55qE5L%2Bd5oqk5o6q5pa9CiAgICAgICAgICAgIHJlcXVpcmUoaXN6ZXJvKGNhbGx2YWx1ZSgpKSkKCiAgICAgICAgICAgIC8vIOiwg%2BW6puWZqAogICAgICAgICAgICBzd2l0Y2ggc2VsZWN0b3IoKQogICAgICAgICAgICBjYXNlIDB4NzBhMDgyMzEgLyogImJhbGFuY2VPZihhZGRyZXNzKSIgKi8gewogICAgICAgICAgICAgICAgcmV0dXJuVWludChiYWxhbmNlT2YoZGVjb2RlQXNBZGRyZXNzKDApKSkKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIDB4MTgxNjBkZGQgLyogInRvdGFsU3VwcGx5KCkiICovIHsKICAgICAgICAgICAgICAgIHJldHVyblVpbnQodG90YWxTdXBwbHkoKSkKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIDB4YTkwNTljYmIgLyogInRyYW5zZmVyKGFkZHJlc3MsdWludDI1NikiICovIHsKICAgICAgICAgICAgICAgIHRyYW5zZmVyKGRlY29kZUFzQWRkcmVzcygwKSwgZGVjb2RlQXNVaW50KDEpKQogICAgICAgICAgICAgICAgcmV0dXJuVHJ1ZSgpCiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSAweDIzYjg3MmRkIC8qICJ0cmFuc2ZlckZyb20oYWRkcmVzcyxhZGRyZXNzLHVpbnQyNTYpIiAqLyB7CiAgICAgICAgICAgICAgICB0cmFuc2ZlckZyb20oZGVjb2RlQXNBZGRyZXNzKDApLCBkZWNvZGVBc0FkZHJlc3MoMSksIGRlY29kZUFzVWludCgyKSkKICAgICAgICAgICAgICAgIHJldHVyblRydWUoKQogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgMHgwOTVlYTdiMyAvKiAiYXBwcm92ZShhZGRyZXNzLHVpbnQyNTYpIiAqLyB7CiAgICAgICAgICAgICAgICBhcHByb3ZlKGRlY29kZUFzQWRkcmVzcygwKSwgZGVjb2RlQXNVaW50KDEpKQogICAgICAgICAgICAgICAgcmV0dXJuVHJ1ZSgpCiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSAweGRkNjJlZDNlIC8qICJhbGxvd2FuY2UoYWRkcmVzcyxhZGRyZXNzKSIgKi8gewogICAgICAgICAgICAgICAgcmV0dXJuVWludChhbGxvd2FuY2UoZGVjb2RlQXNBZGRyZXNzKDApLCBkZWNvZGVBc0FkZHJlc3MoMSkpKQogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgMHg0MGMxMGYxOSAvKiAibWludChhZGRyZXNzLHVpbnQyNTYpIiAqLyB7CiAgICAgICAgICAgICAgICBtaW50KGRlY29kZUFzQWRkcmVzcygwKSwgZGVjb2RlQXNVaW50KDEpKQogICAgICAgICAgICAgICAgcmV0dXJuVHJ1ZSgpCiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGVmYXVsdCB7CiAgICAgICAgICAgICAgICByZXZlcnQoMCwgMCkKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZnVuY3Rpb24gbWludChhY2NvdW50LCBhbW91bnQpIHsKICAgICAgICAgICAgICAgIHJlcXVpcmUoY2FsbGVkQnlPd25lcigpKQoKICAgICAgICAgICAgICAgIG1pbnRUb2tlbnMoYW1vdW50KQogICAgICAgICAgICAgICAgYWRkVG9CYWxhbmNlKGFjY291bnQsIGFtb3VudCkKICAgICAgICAgICAgICAgIGVtaXRUcmFuc2ZlcigwLCBhY2NvdW50LCBhbW91bnQpCiAgICAgICAgICAgIH0KICAgICAgICAgICAgZnVuY3Rpb24gdHJhbnNmZXIodG8sIGFtb3VudCkgewogICAgICAgICAgICAgICAgZXhlY3V0ZVRyYW5zZmVyKGNhbGxlcigpLCB0bywgYW1vdW50KQogICAgICAgICAgICB9CiAgICAgICAgICAgIGZ1bmN0aW9uIGFwcHJvdmUoc3BlbmRlciwgYW1vdW50KSB7CiAgICAgICAgICAgICAgICByZXZlcnRJZlplcm9BZGRyZXNzKHNwZW5kZXIpCiAgICAgICAgICAgICAgICBzZXRBbGxvd2FuY2UoY2FsbGVyKCksIHNwZW5kZXIsIGFtb3VudCkKICAgICAgICAgICAgICAgIGVtaXRBcHByb3ZhbChjYWxsZXIoKSwgc3BlbmRlciwgYW1vdW50KQogICAgICAgICAgICB9CiAgICAgICAgICAgIGZ1bmN0aW9uIHRyYW5zZmVyRnJvbShmcm9tLCB0bywgYW1vdW50KSB7CiAgICAgICAgICAgICAgICBkZWNyZWFzZUFsbG93YW5jZUJ5KGZyb20sIGNhbGxlcigpLCBhbW91bnQpCiAgICAgICAgICAgICAgICBleGVjdXRlVHJhbnNmZXIoZnJvbSwgdG8sIGFtb3VudCkKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZnVuY3Rpb24gZXhlY3V0ZVRyYW5zZmVyKGZyb20sIHRvLCBhbW91bnQpIHsKICAgICAgICAgICAgICAgIHJldmVydElmWmVyb0FkZHJlc3ModG8pCiAgICAgICAgICAgICAgICBkZWR1Y3RGcm9tQmFsYW5jZShmcm9tLCBhbW91bnQpCiAgICAgICAgICAgICAgICBhZGRUb0JhbGFuY2UodG8sIGFtb3VudCkKICAgICAgICAgICAgICAgIGVtaXRUcmFuc2Zlcihmcm9tLCB0bywgYW1vdW50KQogICAgICAgICAgICB9CgoKICAgICAgICAgICAgLyogLS0tLS0tLS0tLSBjYWxsZGF0YSDop6PnoIHlh73mlbAgLS0tLS0tLS0tLS0gKi8KICAgICAgICAgICAgZnVuY3Rpb24gc2VsZWN0b3IoKSAtPiBzIHsKICAgICAgICAgICAgICAgIHMgOj0gZGl2KGNhbGxkYXRhbG9hZCgwKSwgMHgxMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDApCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZ1bmN0aW9uIGRlY29kZUFzQWRkcmVzcyhvZmZzZXQpIC0%2BIHYgewogICAgICAgICAgICAgICAgdiA6PSBkZWNvZGVBc1VpbnQob2Zmc2V0KQogICAgICAgICAgICAgICAgaWYgaXN6ZXJvKGlzemVybyhhbmQodiwgbm90KDB4ZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZikpKSkgewogICAgICAgICAgICAgICAgICAgIHJldmVydCgwLCAwKQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGZ1bmN0aW9uIGRlY29kZUFzVWludChvZmZzZXQpIC0%2BIHYgewogICAgICAgICAgICAgICAgbGV0IHBvcyA6PSBhZGQoNCwgbXVsKG9mZnNldCwgMHgyMCkpCiAgICAgICAgICAgICAgICBpZiBsdChjYWxsZGF0YXNpemUoKSwgYWRkKHBvcywgMHgyMCkpIHsKICAgICAgICAgICAgICAgICAgICByZXZlcnQoMCwgMCkKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHYgOj0gY2FsbGRhdGFsb2FkKHBvcykKICAgICAgICAgICAgfQogICAgICAgICAgICAvKiAtLS0tLS0tLS0tIGNhbGxkYXRhIOe8lueggeWHveaVsCAtLS0tLS0tLS0tICovCiAgICAgICAgICAgIGZ1bmN0aW9uIHJldHVyblVpbnQodikgewogICAgICAgICAgICAgICAgbXN0b3JlKDAsIHYpCiAgICAgICAgICAgICAgICByZXR1cm4oMCwgMHgyMCkKICAgICAgICAgICAgfQogICAgICAgICAgICBmdW5jdGlvbiByZXR1cm5UcnVlKCkgewogICAgICAgICAgICAgICAgcmV0dXJuVWludCgxKQogICAgICAgICAgICB9CgogICAgICAgICAgICAvKiAtLS0tLS0tLSDkuovku7YgLS0tLS0tLS0tLSAqLwogICAgICAgICAgICBmdW5jdGlvbiBlbWl0VHJhbnNmZXIoZnJvbSwgdG8sIGFtb3VudCkgewogICAgICAgICAgICAgICAgbGV0IHNpZ25hdHVyZUhhc2ggOj0gMHhkZGYyNTJhZDFiZTJjODliNjljMmIwNjhmYzM3OGRhYTk1MmJhN2YxNjNjNGExMTYyOGY1NWE0ZGY1MjNiM2VmCiAgICAgICAgICAgICAgICBlbWl0RXZlbnQoc2lnbmF0dXJlSGFzaCwgZnJvbSwgdG8sIGFtb3VudCkKICAgICAgICAgICAgfQogICAgICAgICAgICBmdW5jdGlvbiBlbWl0QXBwcm92YWwoZnJvbSwgc3BlbmRlciwgYW1vdW50KSB7CiAgICAgICAgICAgICAgICBsZXQgc2lnbmF0dXJlSGFzaCA6PSAweDhjNWJlMWU1ZWJlYzdkNWJkMTRmNzE0MjdkMWU4NGYzZGQwMzE0YzBmN2IyMjkxZTViMjAwYWM4YzdjM2I5MjUKICAgICAgICAgICAgICAgIGVtaXRFdmVudChzaWduYXR1cmVIYXNoLCBmcm9tLCBzcGVuZGVyLCBhbW91bnQpCiAgICAgICAgICAgIH0KICAgICAgICAgICAgZnVuY3Rpb24gZW1pdEV2ZW50KHNpZ25hdHVyZUhhc2gsIGluZGV4ZWQxLCBpbmRleGVkMiwgbm9uSW5kZXhlZCkgewogICAgICAgICAgICAgICAgbXN0b3JlKDAsIG5vbkluZGV4ZWQpCiAgICAgICAgICAgICAgICBsb2czKDAsIDB4MjAsIHNpZ25hdHVyZUhhc2gsIGluZGV4ZWQxLCBpbmRleGVkMikKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLyogLS0tLS0tLS0g5a2Y5YKo5biD5bGAIC0tLS0tLS0tLS0gKi8KICAgICAgICAgICAgZnVuY3Rpb24gb3duZXJQb3MoKSAtPiBwIHsgcCA6PSAwIH0KICAgICAgICAgICAgZnVuY3Rpb24gdG90YWxTdXBwbHlQb3MoKSAtPiBwIHsgcCA6PSAxIH0KICAgICAgICAgICAgZnVuY3Rpb24gYWNjb3VudFRvU3RvcmFnZU9mZnNldChhY2NvdW50KSAtPiBvZmZzZXQgewogICAgICAgICAgICAgICAgb2Zmc2V0IDo9IGFkZCgweDEwMDAsIGFjY291bnQpCiAgICAgICAgICAgIH0KICAgICAgICAgICAgZnVuY3Rpb24gYWxsb3dhbmNlU3RvcmFnZU9mZnNldChhY2NvdW50LCBzcGVuZGVyKSAtPiBvZmZzZXQgewogICAgICAgICAgICAgICAgb2Zmc2V0IDo9IGFjY291bnRUb1N0b3JhZ2VPZmZzZXQoYWNjb3VudCkKICAgICAgICAgICAgICAgIG1zdG9yZSgwLCBvZmZzZXQpCiAgICAgICAgICAgICAgICBtc3RvcmUoMHgyMCwgc3BlbmRlcikKICAgICAgICAgICAgICAgIG9mZnNldCA6PSBrZWNjYWsyNTYoMCwgMHg0MCkKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLyogLS0tLS0tLS0g5a2Y5YKo6K6%2F6ZeuIC0tLS0tLS0tLS0gKi8KICAgICAgICAgICAgZnVuY3Rpb24gb3duZXIoKSAtPiBvIHsKICAgICAgICAgICAgICAgIG8gOj0gc2xvYWQob3duZXJQb3MoKSkKICAgICAgICAgICAgfQogICAgICAgICAgICBmdW5jdGlvbiB0b3RhbFN1cHBseSgpIC0%2BIHN1cHBseSB7CiAgICAgICAgICAgICAgICBzdXBwbHkgOj0gc2xvYWQodG90YWxTdXBwbHlQb3MoKSkKICAgICAgICAgICAgfQogICAgICAgICAgICBmdW5jdGlvbiBtaW50VG9rZW5zKGFtb3VudCkgewogICAgICAgICAgICAgICAgc3N0b3JlKHRvdGFsU3VwcGx5UG9zKCksIHNhZmVBZGQodG90YWxTdXBwbHkoKSwgYW1vdW50KSkKICAgICAgICAgICAgfQogICAgICAgICAgICBmdW5jdGlvbiBiYWxhbmNlT2YoYWNjb3VudCkgLT4gYmFsIHsKICAgICAgICAgICAgICAgIGJhbCA6PSBzbG9hZChhY2NvdW50VG9TdG9yYWdlT2Zmc2V0KGFjY291bnQpKQogICAgICAgICAgICB9CiAgICAgICAgICAgIGZ1bmN0aW9uIGFkZFRvQmFsYW5jZShhY2NvdW50LCBhbW91bnQpIHsKICAgICAgICAgICAgICAgIGxldCBvZmZzZXQgOj0gYWNjb3VudFRvU3RvcmFnZU9mZnNldChhY2NvdW50KQogICAgICAgICAgICAgICAgc3N0b3JlKG9mZnNldCwgc2FmZUFkZChzbG9hZChvZmZzZXQpLCBhbW91bnQpKQogICAgICAgICAgICB9CiAgICAgICAgICAgIGZ1bmN0aW9uIGRlZHVjdEZyb21CYWxhbmNlKGFjY291bnQsIGFtb3VudCkgewogICAgICAgICAgICAgICAgbGV0IG9mZnNldCA6PSBhY2NvdW50VG9TdG9yYWdlT2Zmc2V0KGFjY291bnQpCiAgICAgICAgICAgICAgICBsZXQgYmFsIDo9IHNsb2FkKG9mZnNldCkKICAgICAgICAgICAgICAgIHJlcXVpcmUobHRlKGFtb3VudCwgYmFsKSkKICAgICAgICAgICAgICAgIHNzdG9yZShvZmZzZXQsIHN1YihiYWwsIGFtb3VudCkpCiAgICAgICAgICAgIH0KICAgICAgICAgICAgZnVuY3Rpb24gYWxsb3dhbmNlKGFjY291bnQsIHNwZW5kZXIpIC0%2BIGFtb3VudCB7CiAgICAgICAgICAgICAgICBhbW91bnQgOj0gc2xvYWQoYWxsb3dhbmNlU3RvcmFnZU9mZnNldChhY2NvdW50LCBzcGVuZGVyKSkKICAgICAgICAgICAgfQogICAgICAgICAgICBmdW5jdGlvbiBzZXRBbGxvd2FuY2UoYWNjb3VudCwgc3BlbmRlciwgYW1vdW50KSB7CiAgICAgICAgICAgICAgICBzc3RvcmUoYWxsb3dhbmNlU3RvcmFnZU9mZnNldChhY2NvdW50LCBzcGVuZGVyKSwgYW1vdW50KQogICAgICAgICAgICB9CiAgICAgICAgICAgIGZ1bmN0aW9uIGRlY3JlYXNlQWxsb3dhbmNlQnkoYWNjb3VudCwgc3BlbmRlciwgYW1vdW50KSB7CiAgICAgICAgICAgICAgICBsZXQgb2Zmc2V0IDo9IGFsbG93YW5jZVN0b3JhZ2VPZmZzZXQoYWNjb3VudCwgc3BlbmRlcikKICAgICAgICAgICAgICAgIGxldCBjdXJyZW50QWxsb3dhbmNlIDo9IHNsb2FkKG9mZnNldCkKICAgICAgICAgICAgICAgIHJlcXVpcmUobHRlKGFtb3VudCwgY3VycmVudEFsbG93YW5jZSkpCiAgICAgICAgICAgICAgICBzc3RvcmUob2Zmc2V0LCBzdWIoY3VycmVudEFsbG93YW5jZSwgYW1vdW50KSkKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLyogLS0tLS0tLS0tLSDlt6Xlhbflh73mlbAgLS0tLS0tLS0tLSAqLwogICAgICAgICAgICBmdW5jdGlvbiBsdGUoYSwgYikgLT4gciB7CiAgICAgICAgICAgICAgICByIDo9IGlzemVybyhndChhLCBiKSkKICAgICAgICAgICAgfQogICAgICAgICAgICBmdW5jdGlvbiBndGUoYSwgYikgLT4gciB7CiAgICAgICAgICAgICAgICByIDo9IGlzemVybyhsdChhLCBiKSkKICAgICAgICAgICAgfQogICAgICAgICAgICBmdW5jdGlvbiBzYWZlQWRkKGEsIGIpIC0%2BIHIgewogICAgICAgICAgICAgICAgciA6PSBhZGQoYSwgYikKICAgICAgICAgICAgICAgIGlmIG9yKGx0KHIsIGEpLCBsdChyLCBiKSkgeyByZXZlcnQoMCwgMCkgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGZ1bmN0aW9uIGNhbGxlZEJ5T3duZXIoKSAtPiBjYm8gewogICAgICAgICAgICAgICAgY2JvIDo9IGVxKG93bmVyKCksIGNhbGxlcigpKQogICAgICAgICAgICB9CiAgICAgICAgICAgIGZ1bmN0aW9uIHJldmVydElmWmVyb0FkZHJlc3MoYWRkcikgewogICAgICAgICAgICAgICAgcmVxdWlyZShhZGRyKQogICAgICAgICAgICB9CiAgICAgICAgICAgIGZ1bmN0aW9uIHJlcXVpcmUoY29uZGl0aW9uKSB7CiAgICAgICAgICAgICAgICBpZiBpc3plcm8oY29uZGl0aW9uKSB7IHJldmVydCgwLCAwKSB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9Cn0%3D" target="_blank" title="https://remix.ethereum.org/?#language=yul&amp;version=0.8.24&amp;code=b2JqZWN0ICJUb2tlbiIgewogICAgY29kZSB7CiAgICAgICAgLy8g5bCG5Yib5bu66ICF5a2Y5YKo5Zyo6Zu25Y+35qe95Lit44CCCiAgICAgICAgc3N0b3JlKDAsIGNhbGxlcigpKQoKICAgICAgICAvLyDpg6jnvbLlkIjnuqYKICAgICAgICBkYXRhY29weSgwLCBkYXRhb2Zmc2V0KCJydW50aW1lIiksIGRhdGFzaXplKCJydW50aW1lIikpCiAgICAgICAgcmV0dXJuKDAsIGRhdGFzaXplKCJydW50aW1lIikpCiAgICB9CiAgICBvYmplY3QgInJ1bnRpbWUiIHsKICAgICAgICBjb2RlIHsKICAgICAgICAgICAgLy8g6Ziy5q2i5Y+R6YCB5Lul5aSq55qE5L+d5oqk5o6q5pa9CiAgICAgICAgICAgIHJlcXVpcmUoaXN6ZXJvKGNhbGx2YWx1ZSgpKSkKCiAgICAgICAgICAgIC8vIOiwg+W6puWZqAogICAgICAgICAgICBzd2l0Y2ggc2VsZWN0b3IoKQogICAgICAgICAgICBjYXNlIDB4NzBhMDgyMzEgLyogImJhbGFuY2VPZihhZGRyZXNzKSIgKi8gewogICAgICAgICAgICAgICAgcmV0dXJuVWludChiYWxhbmNlT2YoZGVjb2RlQXNBZGRyZXNzKDApKSkKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIDB4MTgxNjBkZGQgLyogInRvdGFsU3VwcGx5KCkiICovIHsKICAgICAgICAgICAgICAgIHJldHVyblVpbnQodG90YWxTdXBwbHkoKSkKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIDB4YTkwNTljYmIgLyogInRyYW5zZmVyKGFkZHJlc3MsdWludDI1NikiICovIHsKICAgICAgICAgICAgICAgIHRyYW5zZmVyKGRlY29kZUFzQWRkcmVzcygwKSwgZGVjb2RlQXNVaW50KDEpKQogICAgICAgICAgICAgICAgcmV0dXJuVHJ1ZSgpCiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSAweDIzYjg3MmRkIC8qICJ0cmFuc2ZlckZyb20oYWRkcmVzcyxhZGRyZXNzLHVpbnQyNTYpIiAqLyB7CiAgICAgICAgICAgICAgICB0cmFuc2ZlckZyb20oZGVjb2RlQXNBZGRyZXNzKDApLCBkZWNvZGVBc0FkZHJlc3MoMSksIGRlY29kZUFzVWludCgyKSkKICAgICAgICAgICAgICAgIHJldHVyblRydWUoKQogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgMHgwOTVlYTdiMyAvKiAiYXBwcm92ZShhZGRyZXNzLHVpbnQyNTYpIiAqLyB7CiAgICAgICAgICAgICAgICBhcHByb3ZlKGRlY29kZUFzQWRkcmVzcygwKSwgZGVjb2RlQXNVaW50KDEpKQogICAgICAgICAgICAgICAgcmV0dXJuVHJ1ZSgpCiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSAweGRkNjJlZDNlIC8qICJhbGxvd2FuY2UoYWRkcmVzcyxhZGRyZXNzKSIgKi8gewogICAgICAgICAgICAgICAgcmV0dXJuVWludChhbGxvd2FuY2UoZGVjb2RlQXNBZGRyZXNzKDApLCBkZWNvZGVBc0FkZHJlc3MoMSkpKQogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgMHg0MGMxMGYxOSAvKiAibWludChhZGRyZXNzLHVpbnQyNTYpIiAqLyB7CiAgICAgICAgICAgICAgICBtaW50KGRlY29kZUFzQWRkcmVzcygwKSwgZGVjb2RlQXNVaW50KDEpKQogICAgICAgICAgICAgICAgcmV0dXJuVHJ1ZSgpCiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGVmYXVsdCB7CiAgICAgICAgICAgICAgICByZXZlcnQoMCwgMCkKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZnVuY3Rpb24gbWludChhY2NvdW50LCBhbW91bnQpIHsKICAgICAgICAgICAgICAgIHJlcXVpcmUoY2FsbGVkQnlPd25lcigpKQoKICAgICAgICAgICAgICAgIG1pbnRUb2tlbnMoYW1vdW50KQogICAgICAgICAgICAgICAgYWRkVG9CYWxhbmNlKGFjY291bnQsIGFtb3VudCkKICAgICAgICAgICAgICAgIGVtaXRUcmFuc2ZlcigwLCBhY2NvdW50LCBhbW91bnQpCiAgICAgICAgICAgIH0KICAgICAgICAgICAgZnVuY3Rpb24gdHJhbnNmZXIodG8sIGFtb3VudCkgewogICAgICAgICAgICAgICAgZXhlY3V0ZVRyYW5zZmVyKGNhbGxlcigpLCB0bywgYW1vdW50KQogICAgICAgICAgICB9CiAgICAgICAgICAgIGZ1bmN0aW9uIGFwcHJvdmUoc3BlbmRlciwgYW1vdW50KSB7CiAgICAgICAgICAgICAgICByZXZlcnRJZlplcm9BZGRyZXNzKHNwZW5kZXIpCiAgICAgICAgICAgICAgICBzZXRBbGxvd2FuY2UoY2FsbGVyKCksIHNwZW5kZXIsIGFtb3VudCkKICAgICAgICAgICAgICAgIGVtaXRBcHByb3ZhbChjYWxsZXIoKSwgc3BlbmRlciwgYW1vdW50KQogICAgICAgICAgICB9CiAgICAgICAgICAgIGZ1bmN0aW9uIHRyYW5zZmVyRnJvbShmcm9tLCB0bywgYW1vdW50KSB7CiAgICAgICAgICAgICAgICBkZWNyZWFzZUFsbG93YW5jZUJ5KGZyb20sIGNhbGxlcigpLCBhbW91bnQpCiAgICAgICAgICAgICAgICBleGVjdXRlVHJhbnNmZXIoZnJvbSwgdG8sIGFtb3VudCkKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZnVuY3Rpb24gZXhlY3V0ZVRyYW5zZmVyKGZyb20sIHRvLCBhbW91bnQpIHsKICAgICAgICAgICAgICAgIHJldmVydElmWmVyb0FkZHJlc3ModG8pCiAgICAgICAgICAgICAgICBkZWR1Y3RGcm9tQmFsYW5jZShmcm9tLCBhbW91bnQpCiAgICAgICAgICAgICAgICBhZGRUb0JhbGFuY2UodG8sIGFtb3VudCkKICAgICAgICAgICAgICAgIGVtaXRUcmFuc2Zlcihmcm9tLCB0bywgYW1vdW50KQogICAgICAgICAgICB9CgoKICAgICAgICAgICAgLyogLS0tLS0tLS0tLSBjYWxsZGF0YSDop6PnoIHlh73mlbAgLS0tLS0tLS0tLS0gKi8KICAgICAgICAgICAgZnVuY3Rpb24gc2VsZWN0b3IoKSAtPiBzIHsKICAgICAgICAgICAgICAgIHMgOj0gZGl2KGNhbGxkYXRhbG9hZCgwKSwgMHgxMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDApCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZ1bmN0aW9uIGRlY29kZUFzQWRkcmVzcyhvZmZzZXQpIC0+IHYgewogICAgICAgICAgICAgICAgdiA6PSBkZWNvZGVBc1VpbnQob2Zmc2V0KQogICAgICAgICAgICAgICAgaWYgaXN6ZXJvKGlzemVybyhhbmQodiwgbm90KDB4ZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZikpKSkgewogICAgICAgICAgICAgICAgICAgIHJldmVydCgwLCAwKQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGZ1bmN0aW9uIGRlY29kZUFzVWludChvZmZzZXQpIC0+IHYgewogICAgICAgICAgICAgICAgbGV0IHBvcyA6PSBhZGQoNCwgbXVsKG9mZnNldCwgMHgyMCkpCiAgICAgICAgICAgICAgICBpZiBsdChjYWxsZGF0YXNpemUoKSwgYWRkKHBvcywgMHgyMCkpIHsKICAgICAgICAgICAgICAgICAgICByZXZlcnQoMCwgMCkKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHYgOj0gY2FsbGRhdGFsb2FkKHBvcykKICAgICAgICAgICAgfQogICAgICAgICAgICAvKiAtLS0tLS0tLS0tIGNhbGxkYXRhIOe8lueggeWHveaVsCAtLS0tLS0tLS0tICovCiAgICAgICAgICAgIGZ1bmN0aW9uIHJldHVyblVpbnQodikgewogICAgICAgICAgICAgICAgbXN0b3JlKDAsIHYpCiAgICAgICAgICAgICAgICByZXR1cm4oMCwgMHgyMCkKICAgICAgICAgICAgfQogICAgICAgICAgICBmdW5jdGlvbiByZXR1cm5UcnVlKCkgewogICAgICAgICAgICAgICAgcmV0dXJuVWludCgxKQogICAgICAgICAgICB9CgogICAgICAgICAgICAvKiAtLS0tLS0tLSDkuovku7YgLS0tLS0tLS0tLSAqLwogICAgICAgICAgICBmdW5jdGlvbiBlbWl0VHJhbnNmZXIoZnJvbSwgdG8sIGFtb3VudCkgewogICAgICAgICAgICAgICAgbGV0IHNpZ25hdHVyZUhhc2ggOj0gMHhkZGYyNTJhZDFiZTJjODliNjljMmIwNjhmYzM3OGRhYTk1MmJhN2YxNjNjNGExMTYyOGY1NWE0ZGY1MjNiM2VmCiAgICAgICAgICAgICAgICBlbWl0RXZlbnQoc2lnbmF0dXJlSGFzaCwgZnJvbSwgdG8sIGFtb3VudCkKICAgICAgICAgICAgfQogICAgICAgICAgICBmdW5jdGlvbiBlbWl0QXBwcm92YWwoZnJvbSwgc3BlbmRlciwgYW1vdW50KSB7CiAgICAgICAgICAgICAgICBsZXQgc2lnbmF0dXJlSGFzaCA6PSAweDhjNWJlMWU1ZWJlYzdkNWJkMTRmNzE0MjdkMWU4NGYzZGQwMzE0YzBmN2IyMjkxZTViMjAwYWM4YzdjM2I5MjUKICAgICAgICAgICAgICAgIGVtaXRFdmVudChzaWduYXR1cmVIYXNoLCBmcm9tLCBzcGVuZGVyLCBhbW91bnQpCiAgICAgICAgICAgIH0KICAgICAgICAgICAgZnVuY3Rpb24gZW1pdEV2ZW50KHNpZ25hdHVyZUhhc2gsIGluZGV4ZWQxLCBpbmRleGVkMiwgbm9uSW5kZXhlZCkgewogICAgICAgICAgICAgICAgbXN0b3JlKDAsIG5vbkluZGV4ZWQpCiAgICAgICAgICAgICAgICBsb2czKDAsIDB4MjAsIHNpZ25hdHVyZUhhc2gsIGluZGV4ZWQxLCBpbmRleGVkMikKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLyogLS0tLS0tLS0g5a2Y5YKo5biD5bGAIC0tLS0tLS0tLS0gKi8KICAgICAgICAgICAgZnVuY3Rpb24gb3duZXJQb3MoKSAtPiBwIHsgcCA6PSAwIH0KICAgICAgICAgICAgZnVuY3Rpb24gdG90YWxTdXBwbHlQb3MoKSAtPiBwIHsgcCA6PSAxIH0KICAgICAgICAgICAgZnVuY3Rpb24gYWNjb3VudFRvU3RvcmFnZU9mZnNldChhY2NvdW50KSAtPiBvZmZzZXQgewogICAgICAgICAgICAgICAgb2Zmc2V0IDo9IGFkZCgweDEwMDAsIGFjY291bnQpCiAgICAgICAgICAgIH0KICAgICAgICAgICAgZnVuY3Rpb24gYWxsb3dhbmNlU3RvcmFnZU9mZnNldChhY2NvdW50LCBzcGVuZGVyKSAtPiBvZmZzZXQgewogICAgICAgICAgICAgICAgb2Zmc2V0IDo9IGFjY291bnRUb1N0b3JhZ2VPZmZzZXQoYWNjb3VudCkKICAgICAgICAgICAgICAgIG1zdG9yZSgwLCBvZmZzZXQpCiAgICAgICAgICAgICAgICBtc3RvcmUoMHgyMCwgc3BlbmRlcikKICAgICAgICAgICAgICAgIG9mZnNldCA6PSBrZWNjYWsyNTYoMCwgMHg0MCkKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLyogLS0tLS0tLS0g5a2Y5YKo6K6/6ZeuIC0tLS0tLS0tLS0gKi8KICAgICAgICAgICAgZnVuY3Rpb24gb3duZXIoKSAtPiBvIHsKICAgICAgICAgICAgICAgIG8gOj0gc2xvYWQob3duZXJQb3MoKSkKICAgICAgICAgICAgfQogICAgICAgICAgICBmdW5jdGlvbiB0b3RhbFN1cHBseSgpIC0+IHN1cHBseSB7CiAgICAgICAgICAgICAgICBzdXBwbHkgOj0gc2xvYWQodG90YWxTdXBwbHlQb3MoKSkKICAgICAgICAgICAgfQogICAgICAgICAgICBmdW5jdGlvbiBtaW50VG9rZW5zKGFtb3VudCkgewogICAgICAgICAgICAgICAgc3N0b3JlKHRvdGFsU3VwcGx5UG9zKCksIHNhZmVBZGQodG90YWxTdXBwbHkoKSwgYW1vdW50KSkKICAgICAgICAgICAgfQogICAgICAgICAgICBmdW5jdGlvbiBiYWxhbmNlT2YoYWNjb3VudCkgLT4gYmFsIHsKICAgICAgICAgICAgICAgIGJhbCA6PSBzbG9hZChhY2NvdW50VG9TdG9yYWdlT2Zmc2V0KGFjY291bnQpKQogICAgICAgICAgICB9CiAgICAgICAgICAgIGZ1bmN0aW9uIGFkZFRvQmFsYW5jZShhY2NvdW50LCBhbW91bnQpIHsKICAgICAgICAgICAgICAgIGxldCBvZmZzZXQgOj0gYWNjb3VudFRvU3RvcmFnZU9mZnNldChhY2NvdW50KQogICAgICAgICAgICAgICAgc3N0b3JlKG9mZnNldCwgc2FmZUFkZChzbG9hZChvZmZzZXQpLCBhbW91bnQpKQogICAgICAgICAgICB9CiAgICAgICAgICAgIGZ1bmN0aW9uIGRlZHVjdEZyb21CYWxhbmNlKGFjY291bnQsIGFtb3VudCkgewogICAgICAgICAgICAgICAgbGV0IG9mZnNldCA6PSBhY2NvdW50VG9TdG9yYWdlT2Zmc2V0KGFjY291bnQpCiAgICAgICAgICAgICAgICBsZXQgYmFsIDo9IHNsb2FkKG9mZnNldCkKICAgICAgICAgICAgICAgIHJlcXVpcmUobHRlKGFtb3VudCwgYmFsKSkKICAgICAgICAgICAgICAgIHNzdG9yZShvZmZzZXQsIHN1YihiYWwsIGFtb3VudCkpCiAgICAgICAgICAgIH0KICAgICAgICAgICAgZnVuY3Rpb24gYWxsb3dhbmNlKGFjY291bnQsIHNwZW5kZXIpIC0+IGFtb3VudCB7CiAgICAgICAgICAgICAgICBhbW91bnQgOj0gc2xvYWQoYWxsb3dhbmNlU3RvcmFnZU9mZnNldChhY2NvdW50LCBzcGVuZGVyKSkKICAgICAgICAgICAgfQogICAgICAgICAgICBmdW5jdGlvbiBzZXRBbGxvd2FuY2UoYWNjb3VudCwgc3BlbmRlciwgYW1vdW50KSB7CiAgICAgICAgICAgICAgICBzc3RvcmUoYWxsb3dhbmNlU3RvcmFnZU9mZnNldChhY2NvdW50LCBzcGVuZGVyKSwgYW1vdW50KQogICAgICAgICAgICB9CiAgICAgICAgICAgIGZ1bmN0aW9uIGRlY3JlYXNlQWxsb3dhbmNlQnkoYWNjb3VudCwgc3BlbmRlciwgYW1vdW50KSB7CiAgICAgICAgICAgICAgICBsZXQgb2Zmc2V0IDo9IGFsbG93YW5jZVN0b3JhZ2VPZmZzZXQoYWNjb3VudCwgc3BlbmRlcikKICAgICAgICAgICAgICAgIGxldCBjdXJyZW50QWxsb3dhbmNlIDo9IHNsb2FkKG9mZnNldCkKICAgICAgICAgICAgICAgIHJlcXVpcmUobHRlKGFtb3VudCwgY3VycmVudEFsbG93YW5jZSkpCiAgICAgICAgICAgICAgICBzc3RvcmUob2Zmc2V0LCBzdWIoY3VycmVudEFsbG93YW5jZSwgYW1vdW50KSkKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLyogLS0tLS0tLS0tLSDlt6Xlhbflh73mlbAgLS0tLS0tLS0tLSAqLwogICAgICAgICAgICBmdW5jdGlvbiBsdGUoYSwgYikgLT4gciB7CiAgICAgICAgICAgICAgICByIDo9IGlzemVybyhndChhLCBiKSkKICAgICAgICAgICAgfQogICAgICAgICAgICBmdW5jdGlvbiBndGUoYSwgYikgLT4gciB7CiAgICAgICAgICAgICAgICByIDo9IGlzemVybyhsdChhLCBiKSkKICAgICAgICAgICAgfQogICAgICAgICAgICBmdW5jdGlvbiBzYWZlQWRkKGEsIGIpIC0+IHIgewogICAgICAgICAgICAgICAgciA6PSBhZGQoYSwgYikKICAgICAgICAgICAgICAgIGlmIG9yKGx0KHIsIGEpLCBsdChyLCBiKSkgeyByZXZlcnQoMCwgMCkgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGZ1bmN0aW9uIGNhbGxlZEJ5T3duZXIoKSAtPiBjYm8gewogICAgICAgICAgICAgICAgY2JvIDo9IGVxKG93bmVyKCksIGNhbGxlcigpKQogICAgICAgICAgICB9CiAgICAgICAgICAgIGZ1bmN0aW9uIHJldmVydElmWmVyb0FkZHJlc3MoYWRkcikgewogICAgICAgICAgICAgICAgcmVxdWlyZShhZGRyKQogICAgICAgICAgICB9CiAgICAgICAgICAgIGZ1bmN0aW9uIHJlcXVpcmUoY29uZGl0aW9uKSB7CiAgICAgICAgICAgICAgICBpZiBpc3plcm8oY29uZGl0aW9uKSB7IHJldmVydCgwLCAwKSB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9Cn0=" ref="nofollow noopener noreferrer">open in Remix</a></p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-selector-tag">object</span> "Token" {
    <span class="hljs-selector-tag">code</span> {
        <span class="hljs-comment">// 将创建者存储在零号槽中。</span>
        <span class="hljs-built_in">sstore</span>(<span class="hljs-number">0</span>, caller())

        <span class="hljs-comment">// 部署合约</span>
        <span class="hljs-built_in">datacopy</span>(<span class="hljs-number">0</span>, dataoffset("runtime"), <span class="hljs-built_in">datasize</span>("runtime"))
        <span class="hljs-built_in">return</span>(<span class="hljs-number">0</span>, datasize("runtime"))
    }
    <span class="hljs-selector-tag">object</span> "runtime" {
        <span class="hljs-selector-tag">code</span> {
            <span class="hljs-comment">// 防止发送以太的保护措施</span>
            <span class="hljs-built_in">require</span>(iszero(callvalue()))

            <span class="hljs-comment">// 调度器</span>
            switch <span class="hljs-built_in">selector</span>()
            case <span class="hljs-number">0</span>x70a08231 <span class="hljs-comment">/* "balanceOf(address)" */</span> {
                <span class="hljs-built_in">returnUint</span>(balanceOf(decodeAsAddress(<span class="hljs-number">0</span>)))
            }
            case <span class="hljs-number">0</span>x18160ddd <span class="hljs-comment">/* "totalSupply()" */</span> {
                <span class="hljs-built_in">returnUint</span>(totalSupply())
            }
            case <span class="hljs-number">0</span>xa9059cbb <span class="hljs-comment">/* "transfer(address,uint256)" */</span> {
                <span class="hljs-built_in">transfer</span>(decodeAsAddress(<span class="hljs-number">0</span>), <span class="hljs-built_in">decodeAsUint</span>(<span class="hljs-number">1</span>))
                <span class="hljs-built_in">returnTrue</span>()
            }
            case <span class="hljs-number">0</span>x23b872dd <span class="hljs-comment">/* "transferFrom(address,address,uint256)" */</span> {
                <span class="hljs-built_in">transferFrom</span>(decodeAsAddress(<span class="hljs-number">0</span>), <span class="hljs-built_in">decodeAsAddress</span>(<span class="hljs-number">1</span>), <span class="hljs-built_in">decodeAsUint</span>(<span class="hljs-number">2</span>))
                <span class="hljs-built_in">returnTrue</span>()
            }
            case <span class="hljs-number">0</span>x095ea7b3 <span class="hljs-comment">/* "approve(address,uint256)" */</span> {
                <span class="hljs-built_in">approve</span>(decodeAsAddress(<span class="hljs-number">0</span>), <span class="hljs-built_in">decodeAsUint</span>(<span class="hljs-number">1</span>))
                <span class="hljs-built_in">returnTrue</span>()
            }
            case <span class="hljs-number">0</span>xdd62ed3e <span class="hljs-comment">/* "allowance(address,address)" */</span> {
                <span class="hljs-built_in">returnUint</span>(allowance(decodeAsAddress(<span class="hljs-number">0</span>), <span class="hljs-built_in">decodeAsAddress</span>(<span class="hljs-number">1</span>)))
            }
            case <span class="hljs-number">0</span>x40c10f19 <span class="hljs-comment">/* "mint(address,uint256)" */</span> {
                <span class="hljs-built_in">mint</span>(decodeAsAddress(<span class="hljs-number">0</span>), <span class="hljs-built_in">decodeAsUint</span>(<span class="hljs-number">1</span>))
                <span class="hljs-built_in">returnTrue</span>()
            }
            default {
                <span class="hljs-built_in">revert</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>)
            }

            function <span class="hljs-built_in">mint</span>(account, amount) {
                <span class="hljs-built_in">require</span>(calledByOwner())

                <span class="hljs-built_in">mintTokens</span>(amount)
                <span class="hljs-built_in">addToBalance</span>(account, amount)
                <span class="hljs-built_in">emitTransfer</span>(<span class="hljs-number">0</span>, account, amount)
            }
            function <span class="hljs-built_in">transfer</span>(to, amount) {
                <span class="hljs-built_in">executeTransfer</span>(caller(), to, amount)
            }
            function <span class="hljs-built_in">approve</span>(spender, amount) {
                <span class="hljs-built_in">revertIfZeroAddress</span>(spender)
                <span class="hljs-built_in">setAllowance</span>(caller(), spender, amount)
                <span class="hljs-built_in">emitApproval</span>(caller(), spender, amount)
            }
            function <span class="hljs-built_in">transferFrom</span>(from, to, amount) {
                <span class="hljs-built_in">decreaseAllowanceBy</span>(from, caller(), amount)
                <span class="hljs-built_in">executeTransfer</span>(from, to, amount)
            }

            function <span class="hljs-built_in">executeTransfer</span>(from, to, amount) {
                <span class="hljs-built_in">revertIfZeroAddress</span>(to)
                <span class="hljs-built_in">deductFromBalance</span>(from, amount)
                <span class="hljs-built_in">addToBalance</span>(to, amount)
                <span class="hljs-built_in">emitTransfer</span>(from, to, amount)
            }


            <span class="hljs-comment">/* ---------- calldata 解码函数 ----------- */</span>
            function <span class="hljs-built_in">selector</span>() -&gt; s {
                s := <span class="hljs-built_in">div</span>(<span class="hljs-built_in">calldataload</span>(<span class="hljs-number">0</span>), <span class="hljs-number">0</span>x100000000000000000000000000000000000000000000000000000000)
            }

            function <span class="hljs-built_in">decodeAsAddress</span>(offset) -&gt; v {
                v := <span class="hljs-built_in">decodeAsUint</span>(offset)
                if <span class="hljs-built_in">iszero</span>(<span class="hljs-built_in">iszero</span>(<span class="hljs-built_in">and</span>(v, <span class="hljs-built_in">not</span>(<span class="hljs-number">0</span>xffffffffffffffffffffffffffffffffffffffff)))) {
                    <span class="hljs-built_in">revert</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>)
                }
            }
            function <span class="hljs-built_in">decodeAsUint</span>(offset) -&gt; v {
                let pos := <span class="hljs-built_in">add</span>(<span class="hljs-number">4</span>, <span class="hljs-built_in">mul</span>(offset, <span class="hljs-number">0</span>x20))
                if <span class="hljs-built_in">lt</span>(<span class="hljs-built_in">calldatasize</span>(), <span class="hljs-built_in">add</span>(pos, <span class="hljs-number">0</span>x20)) {
                    <span class="hljs-built_in">revert</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>)
                }
                v := <span class="hljs-built_in">calldataload</span>(pos)
            }
            <span class="hljs-comment">/* ---------- calldata 编码函数 ---------- */</span>
            function <span class="hljs-built_in">returnUint</span>(v) {
                <span class="hljs-built_in">mstore</span>(<span class="hljs-number">0</span>, v)
                <span class="hljs-built_in">return</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>x20)
            }
            function <span class="hljs-built_in">returnTrue</span>() {
                <span class="hljs-built_in">returnUint</span>(<span class="hljs-number">1</span>)
            }

            <span class="hljs-comment">/* -------- 事件 ---------- */</span>
            function <span class="hljs-built_in">emitTransfer</span>(from, to, amount) {
                let signatureHash := <span class="hljs-number">0</span>xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef
                <span class="hljs-built_in">emitEvent</span>(signatureHash, from, to, amount)
            }
            function <span class="hljs-built_in">emitApproval</span>(from, spender, amount) {
                let signatureHash := <span class="hljs-number">0</span>x8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b925
                <span class="hljs-built_in">emitEvent</span>(signatureHash, from, spender, amount)
            }
            function <span class="hljs-built_in">emitEvent</span>(signatureHash, indexed1, indexed2, nonIndexed) {
                <span class="hljs-built_in">mstore</span>(<span class="hljs-number">0</span>, nonIndexed)
                <span class="hljs-built_in">log3</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>x20, signatureHash, indexed1, indexed2)
            }

            <span class="hljs-comment">/* -------- 存储布局 ---------- */</span>
            function <span class="hljs-built_in">ownerPos</span>() -&gt; <span class="hljs-selector-tag">p</span> { <span class="hljs-selector-tag">p</span> := <span class="hljs-number">0</span> }
            function <span class="hljs-built_in">totalSupplyPos</span>() -&gt; <span class="hljs-selector-tag">p</span> { <span class="hljs-selector-tag">p</span> := <span class="hljs-number">1</span> }
            function <span class="hljs-built_in">accountToStorageOffset</span>(account) -&gt; offset {
                offset := <span class="hljs-built_in">add</span>(<span class="hljs-number">0</span>x1000, account)
            }
            function <span class="hljs-built_in">allowanceStorageOffset</span>(account, spender) -&gt; offset {
                offset := <span class="hljs-built_in">accountToStorageOffset</span>(account)
                <span class="hljs-built_in">mstore</span>(<span class="hljs-number">0</span>, offset)
                <span class="hljs-built_in">mstore</span>(<span class="hljs-number">0</span>x20, spender)
                offset := <span class="hljs-built_in">keccak256</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>x40)
            }

            <span class="hljs-comment">/* -------- 存储访问 ---------- */</span>
            function <span class="hljs-built_in">owner</span>() -&gt; o {
                o := <span class="hljs-built_in">sload</span>(<span class="hljs-built_in">ownerPos</span>())
            }
            function <span class="hljs-built_in">totalSupply</span>() -&gt; supply {
                supply := <span class="hljs-built_in">sload</span>(<span class="hljs-built_in">totalSupplyPos</span>())
            }
            function <span class="hljs-built_in">mintTokens</span>(amount) {
                <span class="hljs-built_in">sstore</span>(totalSupplyPos(), <span class="hljs-built_in">safeAdd</span>(totalSupply(), amount))
            }
            function <span class="hljs-built_in">balanceOf</span>(account) -&gt; bal {
                bal := <span class="hljs-built_in">sload</span>(<span class="hljs-built_in">accountToStorageOffset</span>(account))
            }
            function <span class="hljs-built_in">addToBalance</span>(account, amount) {
                let offset := <span class="hljs-built_in">accountToStorageOffset</span>(account)
                <span class="hljs-built_in">sstore</span>(offset, <span class="hljs-built_in">safeAdd</span>(<span class="hljs-built_in">sload</span>(offset), amount))
            }
            function <span class="hljs-built_in">deductFromBalance</span>(account, amount) {
                let offset := <span class="hljs-built_in">accountToStorageOffset</span>(account)
                let bal := <span class="hljs-built_in">sload</span>(offset)
                <span class="hljs-built_in">require</span>(<span class="hljs-built_in">lte</span>(amount, bal))
                <span class="hljs-built_in">sstore</span>(offset, <span class="hljs-built_in">sub</span>(bal, amount))
            }
            function <span class="hljs-built_in">allowance</span>(account, spender) -&gt; amount {
                amount := <span class="hljs-built_in">sload</span>(<span class="hljs-built_in">allowanceStorageOffset</span>(account, spender))
            }
            function <span class="hljs-built_in">setAllowance</span>(account, spender, amount) {
                <span class="hljs-built_in">sstore</span>(allowanceStorageOffset(account, spender), amount)
            }
            function <span class="hljs-built_in">decreaseAllowanceBy</span>(account, spender, amount) {
                let offset := <span class="hljs-built_in">allowanceStorageOffset</span>(account, spender)
                let currentAllowance := <span class="hljs-built_in">sload</span>(offset)
                <span class="hljs-built_in">require</span>(<span class="hljs-built_in">lte</span>(amount, currentAllowance))
                <span class="hljs-built_in">sstore</span>(offset, <span class="hljs-built_in">sub</span>(currentAllowance, amount))
            }

            <span class="hljs-comment">/* ---------- 工具函数 ---------- */</span>
            function <span class="hljs-built_in">lte</span>(a, b) -&gt; r {
                r := <span class="hljs-built_in">iszero</span>(<span class="hljs-built_in">gt</span>(a, b))
            }
            function <span class="hljs-built_in">gte</span>(a, b) -&gt; r {
                r := <span class="hljs-built_in">iszero</span>(<span class="hljs-built_in">lt</span>(a, b))
            }
            function <span class="hljs-built_in">safeAdd</span>(a, b) -&gt; r {
                r := <span class="hljs-built_in">add</span>(a, b)
                if <span class="hljs-built_in">or</span>(<span class="hljs-built_in">lt</span>(r, a), <span class="hljs-built_in">lt</span>(r, b)) { <span class="hljs-built_in">revert</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>) }
            }
            function <span class="hljs-built_in">calledByOwner</span>() -&gt; cbo {
                cbo := <span class="hljs-built_in">eq</span>(<span class="hljs-built_in">owner</span>(), <span class="hljs-built_in">caller</span>())
            }
            function <span class="hljs-built_in">revertIfZeroAddress</span>(addr) {
                <span class="hljs-built_in">require</span>(addr)
            }
            function <span class="hljs-built_in">require</span>(condition) {
                if <span class="hljs-built_in">iszero</span>(condition) { <span class="hljs-built_in">revert</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>) }
            }
        }
    }
}
</code></pre>
<hr/>
<p>END</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Springboot整合kafka(MQ)]]></title>    <link>https://juejin.cn/post/7588411503120793636</link>    <guid>https://juejin.cn/post/7588411503120793636</guid>    <pubDate>2025-12-28T13:46:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588411503120793636" data-draft-id="7588411503120777252" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Springboot整合kafka(MQ)"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-28T13:46:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ihgry"/> <meta itemprop="url" content="https://juejin.cn/user/3210229685954718"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Springboot整合kafka(MQ)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3210229685954718/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ihgry
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-28T13:46:39.000Z" title="Sun Dec 28 2025 13:46:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    8
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h4 data-id="heading-0">概念</h4>
<ul>
<li>
<p>一个topic主题下面有多个分区（比如partition1、partition2、partition3），每个分区有多个副本；从所有的副本中选取一个作为Leader，其他作为Follower，Leader副本 负责消息的接收和消息的消费，Follower只负责数据的同步；当Leader分区故障后，从Follower中选取一个作为新的Leader</p>
</li>
<li>
<p>一个分区partition只能被消费者组中的一个消费者实例消费，当topic中分区数量发生变化 或者 消费者组中的消费者发生变化 会触发rebalance，重新分配分区partition和消费者实例 之间的关系</p>
</li>
<li>
<p>生产者发送的消息只在一个partition分区内有序，如果topic下面有多个分区，那所有消息整体是无序的</p>
</li>
<li>
<p>一个topic可以有多个消费者组，kafka会记录每个“消费者组” 消费到 “哪个分区的哪个偏移量offset”了</p>
</li>
</ul>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0682279ae6354bfc885ba4cef6a62202~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaWhncnk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767538899&amp;x-signature=yGQsogQMwY6Des3SmbIqi8LI%2Bh4%3D" alt="kafka.jpg" width="90%" loading="lazy"/></p>
<h4 data-id="heading-1">下载</h4>
<ul>
<li>
<p>下载地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fkafka.apache.org%2Fcommunity%2Fdownloads%2F%25EF%25BC%258C%25E8%25A7%25A3%25E5%258E%258B%25E5%258E%258B%25E7%25BC%25A9%25E5%258C%2585" target="_blank" title="https://kafka.apache.org/community/downloads/%EF%BC%8C%E8%A7%A3%E5%8E%8B%E5%8E%8B%E7%BC%A9%E5%8C%85" ref="nofollow noopener noreferrer">kafka.apache.org/community/d…</a></p>
</li>
<li>
<p>在<code>/root/kafka/kafka_2.12-3.6.2</code>目录下创建文件夹<code>mq_logs</code>，并在<code>mq_logs</code>文件夹下分别创建文件夹<code>kafka_data_logs</code>和<code>zookeeper_data</code>分别保存kafka的日志数据和zookeeper的数据</p>
</li>
<li>
<p>在<code>mq_logs</code>目录下创建<code>kafka_console.out</code>和<code>zookeeper_console.out</code>保存启动程序时的日志输出</p>
</li>
<li>
<p>进入config目录修改<code>zookeeper.properties</code>，将dataDir改为：<code>dataDir=/root/kafka/kafka_2.12-3.6.2/mq_logs/zookeeper_data</code></p>
</li>
<li>
<p>进入config目录修改<code>server.properties</code></p>
<ul>
<li>
<p>将log.dir改为<code>log.dirs=/root/kafka/kafka_2.12-3.6.2/mq_logs/kafka_data_logs</code></p>
</li>
<li>
<p>添加配置：<code>listeners=PLAINTEXT://0.0.0.0:9092</code>和<code> advertised.listeners=PLAINTEXT://localhost:9092</code></p>
</li>
</ul>
</li>
</ul>
<h4 data-id="heading-2">启动</h4>
<ul>
<li>
<p>先启动zookeeper：<code>nohup bin/zookeeper-server-start.sh config/zookeeper.properties &gt; /root/kafka/kafka_2.12-3.6.2/mq_logs/zookeeper_console.out 2&gt;&amp;1 &amp;</code></p>
</li>
<li>
<p>再启动kafka：<code>nohup bin/kafka-server-start.sh config/server.properties &gt; /root/kafka/kafka_2.12-3.6.2/mq_logs/kafka_console.out  2&gt;&amp;1 &amp;</code></p>
</li>
</ul>
<h4 data-id="heading-3">命令</h4>
<ul>
<li>
<p>创建主题：<code>./kafka-topics.sh --create --topic 主题名称 --bootstrap-server localhost:9092</code></p>
</li>
<li>
<p>查看所有主题：<code>./kafka-topics.sh --list --bootstrap-server localhost:9092</code></p>
</li>
<li>
<p>查看某个主题：<code>./kafka-topics.sh --describe --topic 主题名称 --bootstrap-server localhost:9092</code></p>
</li>
<li>
<p>删除某个主题：<code>./kafka-topics.sh --delete --topic 主题名称 --bootstrap-server localhost:9092</code></p>
</li>
<li>
<p>查看某个组的消费情况：<code>./kafka-consumer-groups.sh --describe --group 消费者组名称 --bootstrap-server localhost:9092</code></p>
</li>
<li>
<p>查看某个组下面的消费者：<code>./kafka-consumer-groups.sh --describe --group 消费组名称 --bootstrap-server localhost:9092 --members</code></p>
</li>
</ul>
<h4 data-id="heading-4">springboot整合kafka</h4>
<ul>
<li>
<p>引入依赖</p>
<pre><code class="hljs language-java" lang="java">&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.kafka&lt;/groupId&gt;
    &lt;artifactId&gt;spring-kafka&lt;/artifactId&gt;
&lt;/dependency&gt;
</code></pre>
</li>
<li>
<p>引入配置</p>
<pre><code class="hljs language-properties" lang="properties">spring.kafka.bootstrap-servers=115.190.156.159:9092
spring.kafka.producer.retries=3
spring.kafka.producer.batch-size=1000
spring.kafka.producer.buffer-memory=33554432

spring.kafka.consumer.group-id=crm-microservice-newperformance
spring.kafka.consumer.enable-auto-commit=false
spring.kafka.consumer.auto-offset-reset=earliest
spring.kafka.consumer.max-poll-records=200
spring.kafka.listener.ack-mode=MANUAL_IMMEDIATE
</code></pre>
</li>
<li>
<p>配置类：如果程序异常，spring默认将这条消息重复处理9次；这里配置的是同一消息 多次消费失败 的处理策略，即转发到另一个死信topic中；注意，这里是springboot2.7及以上版本的配置方式，和2.7以下版本配置方法不同</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">KafkaConfig</span> {
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> CommonErrorHandler <span class="hljs-title function_">errorHandler</span><span class="hljs-params">(KafkaTemplate&lt;Object, Object&gt; template)</span> {
        <span class="hljs-comment">// 1. 定义死信恢复器,当重试耗尽后，将消息转发到 "原Topic.DLT"</span>
        <span class="hljs-type">DeadLetterPublishingRecoverer</span> <span class="hljs-variable">recover</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DeadLetterPublishingRecoverer</span>(template);
        
        <span class="hljs-comment">// 2. 定义错误处理器</span>
        <span class="hljs-type">DefaultErrorHandler</span> <span class="hljs-variable">errorHandler</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultErrorHandler</span>(recover, <span class="hljs-keyword">new</span> <span class="hljs-title class_">FixedBackOff</span>(<span class="hljs-number">1000L</span>, <span class="hljs-number">3</span>));

        <span class="hljs-keyword">return</span> errorHandler;
    }
}
</code></pre>
</li>
<li>
<p>生产者</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@CrossOrigin</span>
<span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("/kafka")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">KafkaController</span> {
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> KafkaTemplate&lt;String, String&gt; kafkaTemplate;

    <span class="hljs-meta">@RequestMapping("/send")</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">send</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException, ExecutionException {
        Map&lt;String, Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedHashMap</span>&lt;&gt;();
        map.put(<span class="hljs-string">"userid"</span>, <span class="hljs-number">1001</span>);
        map.put(<span class="hljs-string">"name"</span>, <span class="hljs-string">"ccb"</span>+ UUID.randomUUID());

        ListenableFuture&lt;SendResult&lt;String, String&gt;&gt; result = kafkaTemplate.send(<span class="hljs-string">"test_ccb"</span>, JSONObject.toJSONString(map));
        System.out.println(<span class="hljs-string">"发送结果："</span>+result.get());
        <span class="hljs-keyword">return</span> <span class="hljs-string">"ok"</span>;
    }
}
</code></pre>
</li>
<li>
<p>消费者</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">KafkaConsumer</span> {

    <span class="hljs-comment">// 这里的concurrency=5代表会创建5个消费者实例</span>
    <span class="hljs-meta">@KafkaListener(topics = {"test_ccb"},concurrency = "5")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">consumer</span><span class="hljs-params">(ConsumerRecord&lt;?, ?&gt; consumerRecord, Acknowledgment ack)</span> {
        System.out.println(<span class="hljs-string">"收到消息："</span> + consumerRecord);
        ack.acknowledge();
    }
}
</code></pre>
</li>
</ul>
<h4 data-id="heading-5">Spring-Kafka原理</h4>
<ul>
<li><code>spring-kafka</code>的自动配置类中，通过<code>KafkaListenerAnnotationBeanPostProcessor </code>扫描每个Bean对象是否带有<code>@KafkaListener</code>注解，如果有则提取注解上的<code>topics</code>、<code>groupId</code>、<code>concurrency</code>等信息封装成一个Endpoint对象，根据Endpoint指定的容器工厂containerFactory创建容器，在容器内运行<code>KafkaConsumer</code></li>
<li>容器工厂是<code>ConcurrentKafkaListenerContainerFactory</code>，它生产容器<code>KafkaMessageListenerContainer</code>，在容器内运行<code>KafkaConsumer</code>，如果<code>concurrency</code>设置为3，将创建3个容器，也就是会有3个消费者实例</li>
<li>如果程序处理过程中出现了错误，会调用配置好的 <code>CommonErrorHandler</code>进行处理，默认会重试9次，如果还是失败，则提交该偏移量避免阻塞后续消息</li>
<li>gemini3剖析过程：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgemini.google.com%2Fshare%2F4de8006d21e2" target="_blank" title="https://gemini.google.com/share/4de8006d21e2" ref="nofollow noopener noreferrer">gemini.google.com/share/4de80…</a></li>
</ul>
<h4 data-id="heading-6">相关文章</h4>
<ul>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fcloud.tencent.com%2Fdeveloper%2Farticle%2F2185118" target="_blank" title="https://cloud.tencent.com/developer/article/2185118" ref="nofollow noopener noreferrer">3分钟带你彻底搞懂 Kafka-腾讯云开发者社区-腾讯云</a></p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fcloud.tencent.com%2Fdeveloper%2Farticle%2F2185123" target="_blank" title="https://cloud.tencent.com/developer/article/2185123" ref="nofollow noopener noreferrer">【真实生产案例】SpringBoot 整合 Kafka 实现数据高吞吐-腾讯云开发者社区-腾讯云</a></p>
</li>
<li>
<p>spring-kafka分析：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgemini.google.com%2Fshare%2F4de8006d21e2" target="_blank" title="https://gemini.google.com/share/4de8006d21e2" ref="nofollow noopener noreferrer">gemini.google.com/share/4de80…</a></p>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2025 年终醒悟，AI 让我误以为自己很强，未来程序员的转型之路]]></title>    <link>https://juejin.cn/post/7587845752681807935</link>    <guid>https://juejin.cn/post/7587845752681807935</guid>    <pubDate>2025-12-26T06:56:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587845752681807935" data-draft-id="7587825267878363177" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="2025 年终醒悟，AI  让我误以为自己很强，未来程序员的转型之路"/> <meta itemprop="keywords" content="前端,Android,Flutter"/> <meta itemprop="datePublished" content="2025-12-26T06:56:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="恋猫de小郭"/> <meta itemprop="url" content="https://juejin.cn/user/817692379985752"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            2025 年终醒悟，AI  让我误以为自己很强，未来程序员的转型之路
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/817692379985752/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    恋猫de小郭
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T06:56:11.000Z" title="Fri Dec 26 2025 06:56:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>2025 可以说只要是开发者都绕不过 AI ，<strong>时至今日你说你不用 AI 写代码我是不信的</strong>，但是直到最近我才发现，我似乎已经把 AI 的能力当做自己的能力，这种错觉体现在，昨天我用 AI 五分钟做出这下方这个动画效果：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3613ce014e91453e94fd1c50e05143b0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767336971&amp;x-signature=V%2FggoLB%2BRrHCDNxj18pG0%2BKeNEk%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>不知道有没有人能看出这个动画里的梗。。。。</p>
</blockquote>
<p>自从有了 AI 之后，有问题可以让 AI 解读，有需求可以让 AI 分解，比如我想做上面那个动画的时候，只需要让 AI 先根据我的表述给出数学公式，然后根据公式再让 AI 实现和组合代码，而这个过程我只需要点一点运行，预览下效果符不符合我的要求，然后我就觉得自己强的可怕。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8b801a608a3d495ca937d2d310dc418b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767336971&amp;x-signature=4sQwLflLYn2KO2O6JqxXpFkmZiU%3D" alt="image-20251226121839643" loading="lazy"/></p>
<p><strong>这种错觉经常让我陷入以为自己“无所不能”</strong>，在提效的同时，心态似乎也在慢慢的走偏，比如这段时间以来，我通过 AI 复刻和尝试了许多特效，虽然偶尔需要我介入修改问题，但是大多数时候都是在 Vibe Coding ，<strong>而看着这些充满想象力的炫酷动画，那种自以为是的心理就会被 AI 无限放大</strong> 。</p>






























<table><thead><tr><th/><th/><th/></tr></thead><tbody><tr><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f9a0b6d11b53452aabc66265090bff30~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767336971&amp;x-signature=B4fz6UPLNseq%2BwXTBX5v2pwKfmA%3D" alt="" loading="lazy"/></td><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b0652e86bc274bbe848f632b1c9a4de0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767336971&amp;x-signature=DTitkkZn7FjnWI7tNlmYg6Dw5Nc%3D" alt="" loading="lazy"/></td><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/59c367b6756e4943be98af358fbda0b6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767336971&amp;x-signature=Pr6BMhu8aVvezQ54%2FAr6Kk2XRaw%3D" alt="" loading="lazy"/></td></tr><tr><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a7e6a3504cef472aafc13d3dbd1a3231~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767336971&amp;x-signature=A2xT%2Bo62zuV2YSno8IMzQsBzZuY%3D" alt="" loading="lazy"/></td><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/27890d610f0a46c8b03fc3729d950408~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767336971&amp;x-signature=ttJCBUnDlMTHPlcf4t5yp%2BIq88U%3D" alt="" loading="lazy"/></td><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b946921d4ccc4edbb9a1029fdc24ddcc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767336971&amp;x-signature=76PXV6IfJcYGOFboTNrrVWHY4Es%3D" alt="" loading="lazy"/></td></tr><tr><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d0922dc78fe5456fac76e2f26777624a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767336971&amp;x-signature=uuAOJoF5FGq7IhDEStgVaI6oQb0%3D" alt="" loading="lazy"/></td><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/704d800576f34e0f8529a09be8951d83~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767336971&amp;x-signature=7LLJKuhnAaUJeEkTnKM%2F7jomc1k%3D" alt="" loading="lazy"/></td><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b9f9c62e85e74c21a076cd06236976ce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767336971&amp;x-signature=lqxbzv51reLd%2Bum5GesSiHyi59U%3D" alt="" loading="lazy"/></td></tr><tr><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1b801b53c1d0461fbac8c3e136fbd2c1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767336971&amp;x-signature=4bKyBdV4vnEg7AkYw%2FJRwR86lm0%3D" alt="" loading="lazy"/></td><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5af36b93fae24792aa76ccbaed68dda9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767336971&amp;x-signature=qhOkHiOw5CYUmcVJ6HNGjhmXl5A%3D" alt="" loading="lazy"/></td><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/409a495b57284042bb88798cf8c738c5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767336971&amp;x-signature=24DWwASBfi1wo%2BF%2Bpnly9BlI3%2Fw%3D" alt="" loading="lazy"/></td></tr></tbody></table>
<p>但是现在想来，你真的理解过这些动画吗？真的有去了解他们的实现原理和实现逻辑吗？就算事后看过，不是你写的东西，过后还有印象吗？也让我想起了  Anthropic 在 <a href="https://juejin.cn/post/7579555970594947113" target="_blank" title="https://juejin.cn/post/7579555970594947113">《How AI Is Transforming Work at Anthropic》</a> 文章里提到过的：</p>
<blockquote>
<p>“我以为我喜欢写代码，其实我只是喜欢代码跑通的结果”。</p>
</blockquote>
<p>这也让我开始怀疑，我究竟是喜欢写代码，还是只是单纯喜欢跑通产品？在这个过程中，AI 带来的短期能力提升，很容易就让人对自己的定位产生误差，实际上这个过程有没有发现你的能力可能正在倒退？</p>
<p>这种<strong>职业认同的危机不只是外部开发者有， Claude 内部开发者也有这个焦虑</strong>，所以未来 AI 对于开发者的影响，还可能会带来新的职业价值观的重构，所以有人感到迷茫：<strong>如果写代码这个动作本身不再重要，那么以后作为软件工程师的身份认同建立在哪里</strong>？</p>
<blockquote>
<p>而在这个过程里，<strong>AI 能显著增加产量并扩展个人可承担任务的范围，但同时带来技能退化风险</strong>。</p>
</blockquote>
<p>如今 AI 越来越强已经是时代必然的浪潮，而 AI 现在的缺陷也会很快被时代所修复，就像 Google 的 <a href="https://juejin.cn/post/7576181242582892607" target="_blank" title="https://juejin.cn/post/7576181242582892607">Nested  Learning</a>  论文介绍的，现在大模型的问题在于<strong>大模型无法在训练后继续学习</strong> ，因为目前的大模型只有<strong>极快且短暂的记忆</strong>（In-Context Learning）和<strong>冻结的长期记忆（Pre-trained Weights）</strong> ，这个问题在于：</p>
<blockquote>
<p>当前模型缺乏将“即时对话”转化为“长期参数”的机制，也就是它们缺乏中间的频谱：<strong>那些应该从短期逐渐变为长期的记忆</strong>。</p>
</blockquote>
<p>但是这个问题已经被他们通过全新的 HOPE 架构攻克，未来<strong>能“吃一堑长一智”的 AI 也许离我们就不远了</strong>，所以编程能力对于程序员来说，未来是一个什么地位？这个职业的核心竞争力又在哪里？</p>
<p>在开发实现过程中 AI 很强，但是我们需要清晰的知道，<strong>AI 的强大的编程能力并不是你的能力，而作为程序员，你竞争力也不再是</strong>：</p>
<ul>
<li>熟练掌握某些框架和 API</li>
<li>精通某个语言和语法</li>
</ul>
<p>在这些方面，人是跑不过机器的，就像 <a href="https://juejin.cn/post/7584729714339250195" target="_blank" title="https://juejin.cn/post/7584729714339250195">《  OpenAI  使用 Codex 在 28 天内构建 Android 版 Sora》</a> 里介绍的：</p>
<blockquote>
<p>在使用 GPT-5.1-Codex 之后，在短短 28 天内，不仅完成了繁重的开发任务，还创造了上线 24 小时生成 100 万视频、99.9% 无崩溃率的应用，在这个过程里AI 可以 24 小时无间断编写代码和自我修复，28 天通过 50 亿 token 完成了正常需要几个月的产品上线。</p>
</blockquote>
<p>所以从这里可以看到，你如果想和 AI 拼编码能力肯定是拼不过的，就像 OpenAI 最后总结的：<strong>未来的开发工程师的能力不再是打字速度或语法 API 记忆，而是对系统的深刻洞察力。</strong></p>
<p>直到看到 OpenAI  和 Anthropic 等模型公司对于程序员未来的思考时，我才明白不能再沉迷于 AI 编程给自己带来的“成就感”，因为那是 AI 的能力而不是你的，<strong>你用 AI 可以做到，那别人用 AI 是不是也能做到，那你的职业竞争力在哪里</strong>？</p>
<blockquote>
<p>未来的开发者，强的可能不是代码能力，而是项目管理和 AI 驯服能力。</p>
</blockquote>
<p>所以未来程序员的职业能力肯定会发现变化，比如 2026 对于开发者来说，<strong>短期的价值会体现在如何驯服 AI</strong> ，因为现在的 AI 还是一批脱缰的野马，他的保证就像是“事前”的承诺，各种言之凿凿让你相信它：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6de1b143a7a54428803ad5ddb57b13c8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767336971&amp;x-signature=nLA0hRhAuuidTgf9iibjVAymlAs%3D" alt="" loading="lazy"/></p>
<p>而事后提起裤子，出问题了它可半点不认，所以<strong>如何驯服 AI ，同时如何管理和做好大模型善后工程师，这将是程序员短期内的职业变化</strong>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/65b268e5419642d7925522fec6dcf45c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767336971&amp;x-signature=RRDXTLPqV9kxqTt7sL%2BcksYg49g%3D" alt="" loading="lazy"/></p>
<p>而如何驯服 AI ，其实也很简单，<strong>那就是不要上来就让 AI 执行需求，而是给 AI 规划好需求和规则</strong>，把 AI 看作是一个“<em>高能力但缺乏背景的资深新员工</em>”，而你负责架构设计、用户体验和最终决策，而 AI 负责写代码、单元测试和需求落地。</p>
<p>因为 AI 的短板在于目前对于需求的理解还不够，也不擅长得深层的架构权衡（经常为了实现功能而把代码写乱），因为它的 Context 有限，所以经常都会比较片面去理解项目，所以作为程序员，你需要做的是：</p>
<ul>
<li><strong>先规划后代码</strong>：先让 AI 理解系统并编写“设计文档”，纠偏后再执行</li>
<li><strong>背景信息驱动</strong>：通过各种文件文档为 AI 提供规范和上下文，比如各种 rule 和模块描述</li>
<li><strong>增加技能支持</strong> :  通过各种技能描述让 AI 能力增加，比如 CC 可以通过 skills 加载各种插件来辅助能力提升</li>
</ul>
<p>举个例子，比如你要用 Flutter 做一个 Wallet App ，而任务是开发一个 <code>TransactionDetail</code> 模块，需求是：</p>
<ul>
<li>必须遵循 Clean Architecture (Domain -&gt; Data -&gt; Presentation)</li>
<li>数据敏感，金额精度（Decimal）、哈希脱敏显示有严格规范</li>
<li>状态管理，强制使用 <code>riverpod_generator</code> + <code>freezed</code></li>
</ul>
<p>那么在 Claude Code 场景，首先接下来你需要做的会是：</p>
<h3 data-id="heading-0">一、增加 Skill</h3>
<p>这里的核心是教 AI <strong>“在这个团队里，如何标准化地生产一个 Feature”</strong> ，例如创建一个 <code>skills/flutter-clean-feature/</code>  ：</p>
<ol>
<li>
<p><strong><code>SKILL.md</code></strong></p>
<pre><code class="hljs language-markdown" lang="markdown">---
name: flutter-clean-feature
description: 能够按 Clean Architecture 标准生成全套 Flutter 功能模块
<span class="hljs-section">usage: "当用户想开发新页面或功能模块时使用"
---</span>

<span class="hljs-section"># 标准工作流 (SOP)</span>
AI 在执行此 Skill 时，必须严格遵守以下顺序：

<span class="hljs-bullet">1.</span>  <span class="hljs-strong">**Phase 1: 领域建模 (Domain First)**</span>
<span class="hljs-bullet">    -</span> 读取 <span class="hljs-code">`references/domain_rules.md`</span>。
<span class="hljs-bullet">    -</span> 优先定义 Entity 和 Repository 接口。
<span class="hljs-bullet">    -</span> <span class="hljs-emphasis">*Check*</span>: 所有的金额字段必须使用 <span class="hljs-code">`Decimal`</span> 类型，禁止使用 <span class="hljs-code">`double`</span>。

<span class="hljs-bullet">2.</span>  <span class="hljs-strong">**Phase 2: 架构脚手架 (Scaffolding)**</span>
<span class="hljs-bullet">    -</span> 调用 <span class="hljs-code">`scripts/scaffold_module.py`</span> 自动生成文件夹和空文件。
<span class="hljs-bullet">    -</span> 路径结构必须是 <span class="hljs-code">`lib/features/&lt;name&gt;/{data,domain,presentation}`</span>。

<span class="hljs-bullet">3.</span>  <span class="hljs-strong">**Phase 3: 实现与绑定**</span>
<span class="hljs-bullet">    -</span> 实现 Repository 时，必须使用 <span class="hljs-code">`fpdart`</span> 处理 <span class="hljs-code">`Either&lt;Failure, T&gt;`</span>。
<span class="hljs-bullet">    -</span> UI 层必须使用 <span class="hljs-code">`AsyncValue`</span> 处理加载状态。
</code></pre>
</li>
<li>
<p><strong><code>references/domain_rules.md</code> (知识库)</strong></p>
<ul>
<li>包含团队约定的 Clean Architecture 分层图</li>
<li>包含 JSON 解析的通用错误处理模版</li>
</ul>
</li>
<li>
<p><strong><code>assets/repo_template.dart</code> (模版)</strong></p>
<ul>
<li>预置了带有 <code>Either</code> 返回值的 Repository 接口模版</li>
</ul>
</li>
<li>
<p><strong><code>scripts/scaffold_module.py</code> (自动化工具)</strong></p>
<ul>
<li>一个 Python 脚本，接受模块名参数，自动在 <code>lib/features/</code> 下创建标准的文件夹结构和基础文件（解决 AI 有时候懒得创建文件的毛病）</li>
</ul>
</li>
</ol>
<h3 data-id="heading-1">二、增加上下文信息</h3>
<p>核心思想就是告诉 AI “这个项目现有的基础设施是什么” ，比如项目维护一个 <code>CLAUDE.md</code>，提供项目级上下文：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># CryptoWallet Project Context</span>

<span class="hljs-section">## 技术栈</span>
<span class="hljs-bullet">-</span> Flutter 3.24
<span class="hljs-bullet">-</span> Riverpod (Annotation mode only)
<span class="hljs-bullet">-</span> Dio (已封装在 <span class="hljs-code">`lib/core/network/dio_client.dart`</span>)
<span class="hljs-bullet">-</span> UI Kit (所有按钮必须使用 <span class="hljs-code">`lib/core/widgets/app_button.dart`</span>)

<span class="hljs-section">## 现有能力</span>
<span class="hljs-bullet">-</span> 格式化工具：<span class="hljs-code">`lib/core/utils/formatters.dart`</span> (包含 hash 截断、货币格式化)
<span class="hljs-bullet">-</span> 路由：GoRouter，路由定义在 <span class="hljs-code">`lib/routes.dart`</span>
</code></pre>
<hr/>
<h3 data-id="heading-2">三、先规划后代码 (Plan)</h3>
<p>可以利用 Claude Code 的交互能力，先加载 Skill 进行规划，审核无误后再由 Skill 中的 Script 自动执行，例如：</p>
<p><strong>1. 启动与规划</strong></p>
<blockquote>
<p>"使用 skill: flutter-clean-feature，我要开发一个 TransactionDetail 模块，输入是 txHash，需要展示交易金额、时间、发送方和接收方。"`</p>
</blockquote>
<blockquote>
<p><strong>Claude (加载 Skill)</strong>: <em>读取 <code>skills/flutter-clean-feature/SKILL.md</code>...</em> <em>读取 <code>CLAUDE.md</code> 获取项目上下文...</em></p>
<p><strong>Claude (输出规划)</strong>: 根据 <strong>Flutter Clean Feature SOP</strong>，我制定了以下计划：</p>
<ol>
<li><strong>Domain</strong>: 定义 <code>TransactionEntity</code> (包含 <code>Decimal amount</code>) 和 <code>ITransactionRepo</code>。</li>
<li><strong>Scaffold</strong>: 运行脚本创建 <code>lib/features/transaction_detail/...</code> 目录。</li>
<li><strong>Data</strong>: 实现 Repo，调用 Context 中提到的 <code>DioClient</code>。</li>
<li><strong>Presentation</strong>: 使用 <code>riverpod_generator</code> 创建 <code>transactionDetailProvider</code>。</li>
</ol>
<p><strong>请确认</strong>：是否需要支持“交易状态（成功/失败）”的枚举？</p>
</blockquote>
<p><strong>2.  Review 优化</strong></p>
<blockquote>
<p><strong>User</strong>: "需要。另外，UI 上金额显示需要调用 <code>formatters.dart</code> 里的方法，不要自己写格式化逻辑。"</p>
</blockquote>
<p><strong>3. 执行</strong></p>
<blockquote>
<p><strong>Claude</strong>: 收到。开始执行。</p>
</blockquote>
<p><em>(Claude 内部触发 Skill 中的 Script)</em> <code>Run script: python skills/flutter-clean-feature/scripts/scaffold_module.py transaction_detail</code> ：</p>
<blockquote>
<p><strong>Terminal Output</strong>:
✅ Created lib/features/transaction_detail/domain
✅ Created lib/features/transaction_detail/data
✅ Created lib/features/transaction_detail/presentation</p>
</blockquote>
<p><em>(Claude 继续编写代码)</em> Claude 根据 <code>assets/repo_template.dart</code> 填充 <code>transaction_repository.dart</code>，并根据 <code>CLAUDE.md</code> 里的规则，引入了 <code>dio_client.dart</code>。</p>
<p>······</p>
<p>是不是觉得很繁琐？是不是觉得一轮整下来我需求都写完了？但是这就是使用 AI 的趋势，只有这样才能控制和管理好 AI 的代码，不至于让 AI 写出一坨屎山，而随着你对工程文档和技能补充的完善，你的开发速度就会越来越快，AI 也能像是你多年的老哥们一样懂你需求，比如 ：</p>
<blockquote>
<p><code>CLAUDE.md</code> 确保了 AI 不会引入 <code>http</code> 库（因为它知道有 <code>Dio</code>），也不会手写丑陋的按钮（因为它知道有 <code>AppButton</code>），它理解了项目的现状，知道有什么技能可用，然后通过规划很你完成确认，这些写出来的代码和项目才是可持续维护的。</p>
</blockquote>
<p>最后，这一年里我出了用 AI 写代码之外，也开始尝试用 AI 去解决和尝试代码之外的事情，因为 AI 所以我敢于尝试一些以前不敢接触的领域，因为过程学习成本太高，而现在 AI 提供了另外一种思路：</p>
<blockquote>
<p><strong>我不需要真的懂，我只需要让 AI 去做就好了，而我只需要提供想法和验证结果</strong>。</p>
</blockquote>
<p>2025 即将结束，而 2026 也会如期而至，而 AI 的浪潮从未停歇，<strong>愿你我都能在新的浪潮下找到自己的位置</strong>~</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JavaScript 进阶核心文档（零基础衔接版，通俗易懂 2025最新）]]></title>    <link>https://juejin.cn/post/7588124225702641704</link>    <guid>https://juejin.cn/post/7588124225702641704</guid>    <pubDate>2025-12-28T10:31:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588124225702641704" data-draft-id="7588095884070780928" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JavaScript 进阶核心文档（零基础衔接版，通俗易懂 2025最新）"/> <meta itemprop="keywords" content="JavaScript"/> <meta itemprop="datePublished" content="2025-12-28T10:31:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小脑虎"/> <meta itemprop="url" content="https://juejin.cn/user/1946551141023520"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JavaScript 进阶核心文档（零基础衔接版，通俗易懂 2025最新）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1946551141023520/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小脑虎
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-28T10:31:04.000Z" title="Sun Dec 28 2025 10:31:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读27分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>本文是 <strong>JavaScript基础版</strong> 的无缝衔接进阶内容，所有知识点承接基础篇（变量、数据类型、运算符、流程控制、数组），语句通俗易懂、无晦涩概念、案例充足，<strong>零基础可直接上手</strong>，所有案例均可复制运行练习。</p>
<blockquote>
<p>进阶核心定位：基础篇学会「JS的基本语法规则」，进阶篇学会「JS的核心编程思想 + 高频高级语法」，是从「能写代码」到「能写好代码」的必经之路，也是前端开发的核心必备知识。
学习提示：进阶内容更注重「理解原理 + 多做案例」，每个知识点先看懂、再敲代码、最后自己仿写，就能完全掌握。</p>
</blockquote>
<hr/>
<h2 data-id="heading-1">一、数组 进阶（重中之重，开发高频使用）</h2>
<p>在基础篇中我们学习了数组的定义、访问、遍历，数组是JS开发中<strong>最常用的复杂数据类型</strong>，90%的业务逻辑都会用到数组，基础只是入门，<strong>数组的进阶方法和高阶遍历</strong> 是必须吃透的核心内容。</p>
<h3 data-id="heading-2">✅ 数组的基础回顾（快速衔接）</h3>
<ol>
<li>数组是「存储多个数据的容器」，可以存放任意类型的数据：<code>var arr = [1, '张三', true, null, [10,20]]</code></li>
<li>数组的索引从 <code>0</code> 开始，通过 <code>数组名[索引]</code> 访问元素，<code>arr.length</code> 获取数组长度</li>
<li>基础遍历方式：<code>for循环</code> 遍历数组所有元素</li>
</ol>
<h3 data-id="heading-3">✅ 1. 数组的 增/删/改/查 进阶方法（必会，开发高频）</h3>
<p>基础的数组操作是通过索引赋值/取值，但是开发中经常需要「在开头/结尾/指定位置」添加、删除元素，JS内置了<strong>6个核心方法</strong>，语法简单、无需自己写循环，直接调用即可，<strong>必须背会、会用</strong>，分为两组记忆：</p>
<h4 data-id="heading-4">✔️ 第一组：操作数组「尾部」的元素（最常用，无参数坑）</h4>
<h5 data-id="heading-5">① <code>数组.push(元素1, 元素2...)</code> → 尾部追加元素</h5>
<ul>
<li><strong>作用</strong>：向数组的 <strong>最后面</strong> 添加一个或多个元素</li>
<li><strong>返回值</strong>：数组<strong>新的长度</strong></li>
<li><strong>原数组</strong>：<strong>会被修改</strong></li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">var</span> arr = [<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>];
<span class="hljs-keyword">var</span> newLen = arr.<span class="hljs-title function_">push</span>(<span class="hljs-number">4</span>,<span class="hljs-number">5</span>); <span class="hljs-comment">// 尾部追加4和5</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arr); <span class="hljs-comment">// [1,2,3,4,5] 原数组被修改</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(newLen); <span class="hljs-comment">// 5 → 返回新长度</span>
</code></pre>
<h5 data-id="heading-6">② <code>数组.pop()</code> → 尾部删除元素</h5>
<ul>
<li><strong>作用</strong>：删除数组的 <strong>最后一个</strong> 元素</li>
<li><strong>返回值</strong>：被删除的那个元素</li>
<li><strong>原数组</strong>：<strong>会被修改</strong></li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">var</span> arr = [<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>];
<span class="hljs-keyword">var</span> delItem = arr.<span class="hljs-title function_">pop</span>(); <span class="hljs-comment">// 删除最后一个元素4</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arr); <span class="hljs-comment">// [1,2,3] 原数组被修改</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(delItem); <span class="hljs-comment">//4 → 返回被删除的元素</span>
</code></pre>
<h4 data-id="heading-7">✔️ 第二组：操作数组「头部」的元素（常用）</h4>
<h5 data-id="heading-8">① <code>数组.unshift(元素1, 元素2...)</code> → 头部追加元素</h5>
<ul>
<li><strong>作用</strong>：向数组的 <strong>最前面</strong> 添加一个或多个元素</li>
<li><strong>返回值</strong>：数组<strong>新的长度</strong></li>
<li><strong>原数组</strong>：<strong>会被修改</strong></li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">var</span> arr = [<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>];
<span class="hljs-keyword">var</span> newLen = arr.<span class="hljs-title function_">unshift</span>(<span class="hljs-number">1</span>,<span class="hljs-number">2</span>); <span class="hljs-comment">// 头部追加1和2</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arr); <span class="hljs-comment">// [1,2,3,4,5] 原数组被修改</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(newLen); <span class="hljs-comment">//5 → 返回新长度</span>
</code></pre>
<h5 data-id="heading-9">② <code>数组.shift()</code> → 头部删除元素</h5>
<ul>
<li><strong>作用</strong>：删除数组的 <strong>第一个</strong> 元素</li>
<li><strong>返回值</strong>：被删除的那个元素</li>
<li><strong>原数组</strong>：<strong>会被修改</strong></li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">var</span> arr = [<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>];
<span class="hljs-keyword">var</span> delItem = arr.<span class="hljs-title function_">shift</span>(); <span class="hljs-comment">// 删除第一个元素1</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arr); <span class="hljs-comment">// [2,3,4] 原数组被修改</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(delItem); <span class="hljs-comment">//1 → 返回被删除的元素</span>
</code></pre>
<h4 data-id="heading-10">✔️ 第三组：操作数组「指定位置」的元素（万能增删改，重点）</h4>
<p><code>数组.splice(起始索引, 删除个数, 新增元素1, 新增元素2...)</code> → 数组的「万能方法」</p>
<ul>
<li><strong>作用</strong>：可以在数组的<strong>任意位置</strong>，删除指定个数的元素，同时可以追加新元素</li>
<li><strong>参数说明（3个）</strong>：
<ol>
<li>第1个参数：<strong>必填</strong>，从哪个索引开始操作（索引从0开始）</li>
<li>第2个参数：<strong>必填</strong>，删除的元素个数（0 = 不删除）</li>
<li>第3个及以后参数：<strong>可选</strong>，要新增的元素，写几个加几个</li>
</ol>
</li>
<li><strong>返回值</strong>：被删除的元素组成的「新数组」（没删除则返回空数组）</li>
<li><strong>原数组</strong>：<strong>会被修改</strong></li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">var</span> arr = [<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>];
<span class="hljs-comment">// 案例1：只删除 → 从索引2开始，删除2个元素（3和4）</span>
<span class="hljs-keyword">var</span> delArr = arr.<span class="hljs-title function_">splice</span>(<span class="hljs-number">2</span>,<span class="hljs-number">2</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arr); <span class="hljs-comment">// [1,2,5]</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(delArr); <span class="hljs-comment">// [3,4]</span>

<span class="hljs-comment">// 案例2：只新增 → 从索引2开始，删除0个，新增 6,7</span>
arr.<span class="hljs-title function_">splice</span>(<span class="hljs-number">2</span>,<span class="hljs-number">0</span>,<span class="hljs-number">6</span>,<span class="hljs-number">7</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arr); <span class="hljs-comment">// [1,2,6,7,5]</span>

<span class="hljs-comment">// 案例3：删了再加（替换）→ 从索引2开始，删除1个，新增 8</span>
arr.<span class="hljs-title function_">splice</span>(<span class="hljs-number">2</span>,<span class="hljs-number">1</span>,<span class="hljs-number">8</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arr); <span class="hljs-comment">// [1,2,8,7,5]</span>
</code></pre>
<h3 data-id="heading-11">✅ 2. 数组的 高阶遍历方法（基础for循环的升级版，开发必用）</h3>
<p>基础篇我们用 <code>for循环</code> 遍历数组，语法繁琐（要写初始值、条件、更新变量），JS为数组内置了 <strong>3个高阶遍历方法</strong>，语法简洁、语义清晰，<strong>开发中99%的场景会替代基础for循环</strong>，也是面试高频考点，<strong>理解原理 + 会用即可</strong>，无需死记硬背。</p>
<blockquote>
<p><strong>核心共性</strong>：这3个方法都是「遍历数组的每一个元素」，都会接收一个 <strong>函数作为参数</strong>（这个函数我们叫「回调函数」），回调函数会被<strong>自动执行</strong>，不需要手动调用。
<strong>回调函数的固定参数</strong>（3个，按顺序写）：</p>
<ol>
<li><code>item</code> → 数组的「当前遍历到的元素」（必用）</li>
<li><code>index</code> → 当前元素的「索引」（可选）</li>
<li><code>arr</code> → 原数组本身（几乎不用）</li>
</ol>
</blockquote>
<h4 data-id="heading-12">✔️ ① <code>数组.forEach(function(item, index){})</code> → 纯遍历（无返回值）</h4>
<ul>
<li><strong>中文含义</strong>：<code>为每个</code>，作用就是「遍历数组的每一个元素」，等价于基础的for循环</li>
<li><strong>核心特点</strong>：<strong>没有返回值</strong>，只做遍历操作（打印、累加、修改元素等）</li>
<li><strong>适用场景</strong>：只需要遍历数组，不需要得到新数组的场景（最常用）</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">var</span> arr = [<span class="hljs-number">10</span>,<span class="hljs-number">20</span>,<span class="hljs-number">30</span>,<span class="hljs-number">40</span>];
<span class="hljs-comment">// 遍历数组，打印每个元素和对应的索引</span>
arr.<span class="hljs-title function_">forEach</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">item, index</span>){
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`索引<span class="hljs-subst">${index}</span>的元素是：<span class="hljs-subst">${item}</span>`</span>);
});
<span class="hljs-comment">// 输出结果：</span>
<span class="hljs-comment">// 索引0的元素是：10</span>
<span class="hljs-comment">// 索引1的元素是：20</span>
<span class="hljs-comment">// 索引2的元素是：30</span>
<span class="hljs-comment">// 索引3的元素是：40</span>

<span class="hljs-comment">// 案例：用forEach求数组所有元素的和</span>
<span class="hljs-keyword">var</span> sum = <span class="hljs-number">0</span>;
arr.<span class="hljs-title function_">forEach</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">item</span>){
  sum += item;
});
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(sum); <span class="hljs-comment">// 100</span>
</code></pre>
<h4 data-id="heading-13">✔️ ② <code>数组.map(function(item, index){ return 新值 })</code> → 遍历+加工，返回新数组（开发高频）</h4>
<ul>
<li><strong>中文含义</strong>：<code>映射</code>，作用是「遍历数组的每一个元素，对元素进行加工处理，返回一个新数组」</li>
<li><strong>核心特点</strong>：<strong>有返回值</strong>，返回一个「和原数组长度相同」的新数组，新数组的元素是加工后的结果</li>
<li><strong>原数组</strong>：<strong>不会被修改</strong>（重点，纯纯的新数组）</li>
<li><strong>适用场景</strong>：需要对数组的每一个元素做「统一处理」，得到新数组（如：所有元素乘2、拼接字符串、提取对象属性等）</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">var</span> arr = [<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>];
<span class="hljs-comment">// 案例1：所有元素乘2，得到新数组</span>
<span class="hljs-keyword">var</span> newArr = arr.<span class="hljs-title function_">map</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">item</span>){
  <span class="hljs-keyword">return</span> item * <span class="hljs-number">2</span>;
});
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arr); <span class="hljs-comment">// [1,2,3,4] 原数组不变</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(newArr); <span class="hljs-comment">// [2,4,6,8] 新数组</span>

<span class="hljs-comment">// 案例2：给所有元素拼接字符串</span>
<span class="hljs-keyword">var</span> strArr = arr.<span class="hljs-title function_">map</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">item</span>){
  <span class="hljs-keyword">return</span> <span class="hljs-string">'数字：'</span> + item;
});
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(strArr); <span class="hljs-comment">// ["数字：1", "数字：2", "数字：3", "数字：4"]</span>
</code></pre>
<h4 data-id="heading-14">✔️ ③ <code>数组.filter(function(item, index){ return 布尔值 })</code> → 遍历+筛选，返回新数组（开发高频）</h4>
<ul>
<li><strong>中文含义</strong>：<code>过滤</code>，作用是「遍历数组的每一个元素，按照指定条件筛选出符合要求的元素，返回一个新数组」</li>
<li><strong>核心特点</strong>：<strong>有返回值</strong>，返回的新数组是「原数组的子集」（长度≤原数组）</li>
<li><strong>回调函数规则</strong>：return后面写「筛选条件」，条件成立（true）则保留当前元素，不成立（false）则过滤掉</li>
<li><strong>原数组</strong>：<strong>不会被修改</strong></li>
<li><strong>适用场景</strong>：需要从数组中「筛选符合条件的数据」（如：筛选大于10的数、筛选偶数、筛选符合条件的用户等）</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">var</span> arr = [<span class="hljs-number">1</span>,<span class="hljs-number">5</span>,<span class="hljs-number">8</span>,<span class="hljs-number">10</span>,<span class="hljs-number">12</span>,<span class="hljs-number">15</span>];
<span class="hljs-comment">// 案例1：筛选出数组中大于10的元素</span>
<span class="hljs-keyword">var</span> bigArr = arr.<span class="hljs-title function_">filter</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">item</span>){
  <span class="hljs-keyword">return</span> item &gt; <span class="hljs-number">10</span>;
});
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(bigArr); <span class="hljs-comment">// [12,15]</span>

<span class="hljs-comment">// 案例2：筛选出数组中的偶数</span>
<span class="hljs-keyword">var</span> evenArr = arr.<span class="hljs-title function_">filter</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">item</span>){
  <span class="hljs-keyword">return</span> item % <span class="hljs-number">2</span> === <span class="hljs-number">0</span>;
});
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(evenArr); <span class="hljs-comment">// [8,10,12]</span>
</code></pre>
<h3 data-id="heading-15">✅ 3. 数组的其他常用进阶方法（必会，高频）</h3>
<p>除了遍历和增删改，开发中还有几个数组方法使用率极高，语法简单，直接调用即可，<strong>记牢作用和返回值</strong>：</p>
<h4 data-id="heading-16">✔️ ① <code>数组.indexOf(查找的元素)</code> → 查找元素的索引</h4>
<ul>
<li><strong>作用</strong>：查找数组中是否包含某个元素，返回该元素的<strong>第一个索引</strong></li>
<li><strong>返回值</strong>：找到则返回「索引值」，找不到则返回 <code>-1</code>（重点，判断是否存在的核心）</li>
<li><strong>原数组</strong>：不变</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">var</span> arr = [<span class="hljs-number">10</span>,<span class="hljs-number">20</span>,<span class="hljs-number">30</span>,<span class="hljs-number">20</span>];
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arr.<span class="hljs-title function_">indexOf</span>(<span class="hljs-number">20</span>)); <span class="hljs-comment">// 1 → 找到第一个20的索引是1</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arr.<span class="hljs-title function_">indexOf</span>(<span class="hljs-number">50</span>)); <span class="hljs-comment">// -1 → 找不到返回-1</span>

<span class="hljs-comment">// 开发常用场景：判断数组中是否包含某个元素</span>
<span class="hljs-keyword">if</span>(arr.<span class="hljs-title function_">indexOf</span>(<span class="hljs-number">30</span>) !== -<span class="hljs-number">1</span>){
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'数组中包含30'</span>);
}<span class="hljs-keyword">else</span>{
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'数组中不包含30'</span>);
}
</code></pre>
<h4 data-id="heading-17">✔️ ② <code>数组.includes(查找的元素)</code> → 判断元素是否存在（ES6新增，推荐）</h4>
<ul>
<li><strong>作用</strong>：判断数组中是否包含某个元素，返回布尔值，<strong>比indexOf更直观</strong></li>
<li><strong>返回值</strong>：存在返回 <code>true</code>，不存在返回 <code>false</code></li>
<li><strong>原数组</strong>：不变</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">var</span> arr = [<span class="hljs-number">10</span>,<span class="hljs-number">20</span>,<span class="hljs-number">30</span>];
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arr.<span class="hljs-title function_">includes</span>(<span class="hljs-number">20</span>)); <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arr.<span class="hljs-title function_">includes</span>(<span class="hljs-number">50</span>)); <span class="hljs-comment">// false</span>

<span class="hljs-comment">// 开发常用场景：判断包含</span>
<span class="hljs-keyword">if</span>(arr.<span class="hljs-title function_">includes</span>(<span class="hljs-number">30</span>)){
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'数组中包含30'</span>);
}
</code></pre>
<h4 data-id="heading-18">✔️ ③ <code>数组.join(分隔符)</code> → 数组转字符串</h4>
<ul>
<li><strong>作用</strong>：将数组的所有元素拼接成一个「字符串」</li>
<li><strong>参数</strong>：分隔符（可选），不写则默认用 <code>,</code> 分隔，写空字符串 <code>''</code> 则无缝拼接</li>
<li><strong>返回值</strong>：拼接后的字符串</li>
<li><strong>原数组</strong>：不变</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">var</span> arr = [<span class="hljs-string">'我'</span>,<span class="hljs-string">'是'</span>,<span class="hljs-string">'前端'</span>,<span class="hljs-string">'工程师'</span>];
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arr.<span class="hljs-title function_">join</span>()); <span class="hljs-comment">// 我,是,前端,工程师</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arr.<span class="hljs-title function_">join</span>(<span class="hljs-string">''</span>)); <span class="hljs-comment">// 我是前端工程师</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arr.<span class="hljs-title function_">join</span>(<span class="hljs-string">'-'</span>)); <span class="hljs-comment">// 我-是-前端-工程师</span>
</code></pre>
<hr/>
<h2 data-id="heading-19">二、函数 核心（JS的灵魂，进阶核心中的核心）</h2>
<h3 data-id="heading-20">✅ 为什么要学函数？（基础衔接，理解必要性）</h3>
<p>在基础篇中，我们写的代码都是「顺序执行的零散代码」，比如求1~100的和、遍历数组、判断奇偶，这些代码如果需要<strong>重复使用</strong>，只能复制粘贴，会造成：</p>
<ol>
<li><strong>代码冗余</strong>：相同逻辑写多遍，代码量变大</li>
<li><strong>维护困难</strong>：逻辑需要修改时，所有复制的地方都要改，容易漏改</li>
<li><strong>可读性差</strong>：零散代码没有语义，看不懂这段代码的作用</li>
</ol>
<p>而 <strong>函数</strong> 就是为了解决这个问题而生的，函数的核心作用：<strong>把一段实现特定功能的代码「封装」起来，给这段代码起个名字，以后需要用的时候，直接调用名字即可，不用重复写代码</strong>。</p>
<blockquote>
<p>一句话总结：函数 = 封装好的、可重复使用的「代码块」，是JS的核心编程思想。</p>
</blockquote>
<h3 data-id="heading-21">✅ 1. 函数的基础概念（通俗易懂）</h3>
<h4 data-id="heading-22">✔️ 什么是函数？</h4>
<p>函数是一段 <strong>被命名的、可重复执行的代码块</strong>，这段代码块实现了一个「特定的功能」，比如：求和、求最大值、判断闰年、遍历数组等，只要是「需要重复使用的逻辑」，都应该封装成函数。</p>
<h4 data-id="heading-23">✔️ 函数的核心特点（3个）</h4>
<ol>
<li><strong>封装性</strong>：把实现功能的代码包起来，对外只暴露一个名字，隐藏内部细节</li>
<li><strong>复用性</strong>：一次封装，多次调用，不用重复写代码</li>
<li><strong>独立性</strong>：函数内部的代码和外部是隔离的，互不影响</li>
</ol>
<h3 data-id="heading-24">✅ 2. 函数的 定义 &amp; 调用（基础语法，必会，核心两步）</h3>
<p>使用函数的完整流程只有两步：<strong>第一步：定义函数（封装代码），第二步：调用函数（执行代码）</strong>，缺一不可，先定义后调用，顺序不能乱。</p>
<blockquote>
<p>类比：定义函数 = 买了一个洗衣机（封装了洗衣服的功能），调用函数 = 按下洗衣机的开关（执行洗衣服的功能），洗衣机买了不用就不会工作，函数定义了不调用就不会执行。</p>
</blockquote>
<h4 data-id="heading-25">✔️ 第一步：定义函数（两种方式，开发都用第一种）</h4>
<h5 data-id="heading-26">方式1：声明式定义函数（推荐，最常用）</h5>
<p><strong>语法格式（固定）</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// function 是关键字，固定写</span>
<span class="hljs-comment">// 函数名：自己起的名字，命名规则和变量一样（见名知意、驼峰命名）</span>
<span class="hljs-comment">// ()：形参列表，后面讲</span>
<span class="hljs-comment">// {}：函数体，写实现功能的代码</span>
<span class="hljs-keyword">function</span> 函数名() {
  <span class="hljs-comment">// 函数体：实现功能的代码</span>
  代码逻辑;
}
</code></pre>
<p><strong>案例</strong>：封装一个「求两个数之和」的函数</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 定义函数：封装求和的逻辑</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getSum</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">var</span> a = <span class="hljs-number">10</span>;
  <span class="hljs-keyword">var</span> b = <span class="hljs-number">20</span>;
  <span class="hljs-keyword">var</span> sum = a + b;
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'两个数的和是：'</span>, sum);
}
</code></pre>
<h5 data-id="heading-27">方式2：赋值式定义函数（了解即可）</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 把函数赋值给一个变量，变量名就是函数名</span>
<span class="hljs-keyword">var</span> getSum = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">var</span> a = <span class="hljs-number">10</span>;
  <span class="hljs-keyword">var</span> b = <span class="hljs-number">20</span>;
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(a + b);
}
</code></pre>
<h4 data-id="heading-28">✔️ 第二步：调用函数（执行函数的核心，语法固定）</h4>
<p><strong>语法格式（固定）</strong>：<code>函数名();</code></p>
<ul>
<li>只要写了这行代码，函数内部的代码就会被执行</li>
<li>调用多少次，函数就执行多少次</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 定义函数</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getSum</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">var</span> a = <span class="hljs-number">10</span>;
  <span class="hljs-keyword">var</span> b = <span class="hljs-number">20</span>;
  <span class="hljs-keyword">var</span> sum = a + b;
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'两个数的和是：'</span>, sum);
}

<span class="hljs-comment">// 调用函数 → 执行函数体代码，打印结果</span>
<span class="hljs-title function_">getSum</span>(); <span class="hljs-comment">// 输出：两个数的和是：30</span>
<span class="hljs-comment">// 再调用一次 → 再执行一次</span>
<span class="hljs-title function_">getSum</span>(); <span class="hljs-comment">// 输出：两个数的和是：30</span>
</code></pre>
<h3 data-id="heading-29">✅ 3. 函数的 参数（核心进阶，让函数更灵活，必学）</h3>
<h4 data-id="heading-30">✔️ 为什么需要参数？（理解必要性）</h4>
<p>上面的求和函数有一个问题：求和的两个数 <code>10</code> 和 <code>20</code> 是「写死的」，调用函数只能求10+20的和，如果想求其他数的和，需要修改函数内部的代码，这样的函数灵活性太差，复用性不高。</p>
<p>而 <strong>参数</strong> 就是为了解决这个问题，参数的核心作用：<strong>让函数的「逻辑不变，数据可变」</strong>，调用函数的时候，把需要处理的数据「传进去」，函数内部用传进来的数据执行逻辑，这样同一个函数可以处理不同的数据，灵活性拉满。</p>
<h4 data-id="heading-31">✔️ 参数的两个核心概念（形参 &amp; 实参，通俗易懂，必记）</h4>
<p>为了方便理解，我们用「洗衣机洗衣服」来类比：</p>
<ul>
<li>洗衣机的功能是「洗衣服」（函数的逻辑不变）</li>
<li>洗衣服时需要「放衣服进去」（衣服就是传给洗衣机的「数据」）</li>
<li>洗衣机上有一个「放衣服的入口」（这个入口就是函数的「形参」）</li>
<li>你放进去的「具体衣服」（比如T恤、裤子）就是「实参」</li>
</ul>
<p>对应到函数中，两个概念的定义：</p>
<ol>
<li><strong>形参（形式参数）</strong>：写在函数定义时的 <code>()</code> 里面，本质是「函数内部的变量」，<strong>没有具体的值</strong>，只是用来「接收」调用函数时传进来的数据。
<ul>
<li><strong>语法</strong>：多个形参用 <code>,</code> 分隔</li>
<li><strong>作用</strong>：函数内部可以直接使用这个变量</li>
</ul>
</li>
<li><strong>实参（实际参数）</strong>：写在函数调用时的 <code>()</code> 里面，是「具体的数据」，作用是「传给函数的形参」，给形参赋值。
<ul>
<li><strong>语法</strong>：多个实参用 <code>,</code> 分隔</li>
<li><strong>规则</strong>：<strong>形参和实参是一一对应的</strong>，第一个实参给第一个形参赋值，第二个给第二个赋值，以此类推。</li>
</ul>
</li>
</ol>
<h4 data-id="heading-32">✔️ 参数的使用语法（固定，案例理解，一看就会）</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 定义函数时：()里写 形参 → 相当于声明变量，无值</span>
<span class="hljs-keyword">function</span> 函数名(形参<span class="hljs-number">1</span>, 形参<span class="hljs-number">2</span>, ...) {
  <span class="hljs-comment">// 函数体中直接使用形参</span>
  代码逻辑(形参<span class="hljs-number">1</span>, 形参<span class="hljs-number">2</span>);
}

<span class="hljs-comment">// 调用函数时：()里写 实参 → 给形参赋值</span>
函数名(实参<span class="hljs-number">1</span>, 实参<span class="hljs-number">2</span>, ...);
</code></pre>
<p><strong>案例1</strong>：封装求和函数，支持求「任意两个数」的和（核心案例）</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 定义函数：形参a和b，接收传进来的两个数</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getSum</span>(<span class="hljs-params">a, b</span>) {
  <span class="hljs-keyword">var</span> sum = a + b;
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(a + <span class="hljs-string">'+'</span> + b + <span class="hljs-string">'='</span> + sum);
}

<span class="hljs-comment">// 调用函数：传不同的实参，处理不同的数据</span>
<span class="hljs-title function_">getSum</span>(<span class="hljs-number">10</span>, <span class="hljs-number">20</span>); <span class="hljs-comment">// 实参10→a，20→b → 输出：10+20=30</span>
<span class="hljs-title function_">getSum</span>(<span class="hljs-number">5</span>, <span class="hljs-number">8</span>);   <span class="hljs-comment">// 实参5→a，8→b → 输出：5+8=13</span>
<span class="hljs-title function_">getSum</span>(<span class="hljs-number">100</span>, <span class="hljs-number">200</span>);<span class="hljs-comment">// 实参100→a，200→b → 输出：100+200=300</span>
</code></pre>
<p><strong>案例2</strong>：封装函数，求「任意数组」的所有元素之和（进阶案例，衔接数组）</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 定义函数：形参arr接收传进来的数组</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getArrSum</span>(<span class="hljs-params">arr</span>) {
  <span class="hljs-keyword">var</span> sum = <span class="hljs-number">0</span>;
  arr.<span class="hljs-title function_">forEach</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">item</span>){
    sum += item;
  });
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'数组的和是：'</span>, sum);
}

<span class="hljs-comment">// 调用函数：传不同的数组</span>
<span class="hljs-keyword">var</span> arr1 = [<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>];
<span class="hljs-keyword">var</span> arr2 = [<span class="hljs-number">10</span>,<span class="hljs-number">20</span>,<span class="hljs-number">30</span>];
<span class="hljs-title function_">getArrSum</span>(arr1); <span class="hljs-comment">// 输出：数组的和是：10</span>
<span class="hljs-title function_">getArrSum</span>(arr2); <span class="hljs-comment">// 输出：数组的和是：60</span>
</code></pre>
<h3 data-id="heading-33">✅ 4. 函数的 返回值（核心进阶，函数的精髓，必学）</h3>
<h4 data-id="heading-34">✔️ 为什么需要返回值？（理解必要性）</h4>
<p>上面的函数都是「执行逻辑后直接打印结果」，比如求和函数打印和、求数组和函数打印数组和，但是开发中，我们经常需要「使用函数的执行结果」做后续处理，比如：</p>
<ul>
<li>求两个数的和后，再把和乘2</li>
<li>求数组的和后，再判断和是否大于100</li>
<li>求最大值后，再把最大值赋值给一个变量</li>
</ul>
<p>如果函数只是打印结果，我们无法拿到这个结果做后续处理，而 <strong>返回值</strong> 就是为了解决这个问题，返回值的核心作用：<strong>函数执行完逻辑后，把「执行结果」返回给调用者，调用者可以拿到这个结果，赋值给变量、做运算、做判断等，想怎么用就怎么用</strong>。</p>
<blockquote>
<p>一句话总结：函数的「参数」是「往函数里传数据」，函数的「返回值」是「从函数里拿数据出来」，有了参数和返回值，函数才是一个完整的「数据处理容器」。</p>
</blockquote>
<h4 data-id="heading-35">✔️ 返回值的核心语法（固定，必记）</h4>
<ol>
<li><strong>关键字</strong>：<code>return</code> → 写在函数体内部，固定关键字</li>
<li><strong>语法</strong>：<code>return 要返回的结果;</code></li>
<li><strong>核心规则（3个，必背）</strong>：
<ul>
<li>函数执行到 <code>return</code> 时，会立刻停止执行，后面的代码都不会执行（<code>return</code> 是函数的「出口」）</li>
<li>一个函数只能有「一个返回值」，写多个return只有第一个生效</li>
<li>如果函数没有写 <code>return</code>，则默认返回 <code>undefined</code></li>
</ul>
</li>
</ol>
<h4 data-id="heading-36">✔️ 返回值的使用案例（核心，开发必用，一看就会）</h4>
<p><strong>案例1</strong>：求和函数，返回求和结果，调用者拿到结果后做后续处理</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 定义函数：求和后，return返回结果</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getSum</span>(<span class="hljs-params">a, b</span>) {
  <span class="hljs-keyword">var</span> sum = a + b;
  <span class="hljs-keyword">return</span> sum; <span class="hljs-comment">// 返回求和结果</span>
}

<span class="hljs-comment">// 调用函数：用变量接收返回值，后续可以任意使用</span>
<span class="hljs-keyword">var</span> res1 = <span class="hljs-title function_">getSum</span>(<span class="hljs-number">10</span>,<span class="hljs-number">20</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res1); <span class="hljs-comment">// 30 → 拿到结果</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res1 * <span class="hljs-number">2</span>); <span class="hljs-comment">//60 → 用结果做运算</span>
<span class="hljs-keyword">var</span> res2 = <span class="hljs-title function_">getSum</span>(<span class="hljs-number">5</span>,<span class="hljs-number">8</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res1 + res2); <span class="hljs-comment">//30+13=43 → 多个结果做运算</span>
</code></pre>
<p><strong>案例2</strong>：封装函数，返回「任意数组」的最大值（进阶案例，开发高频）</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 定义函数：接收数组，返回数组的最大值</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getMax</span>(<span class="hljs-params">arr</span>) {
  <span class="hljs-keyword">var</span> max = arr[<span class="hljs-number">0</span>]; <span class="hljs-comment">// 假设第一个元素是最大值</span>
  arr.<span class="hljs-title function_">forEach</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">item</span>){
    <span class="hljs-keyword">if</span>(item &gt; max){
      max = item;
    }
  });
  <span class="hljs-keyword">return</span> max; <span class="hljs-comment">// 返回最大值</span>
}

<span class="hljs-comment">// 调用函数：拿到最大值，做后续处理</span>
<span class="hljs-keyword">var</span> arr = [<span class="hljs-number">10</span>,<span class="hljs-number">5</span>,<span class="hljs-number">20</span>,<span class="hljs-number">15</span>,<span class="hljs-number">8</span>];
<span class="hljs-keyword">var</span> maxNum = <span class="hljs-title function_">getMax</span>(arr);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'数组的最大值是：'</span>, maxNum); <span class="hljs-comment">//20</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'最大值加10是：'</span>, maxNum +<span class="hljs-number">10</span>); <span class="hljs-comment">//30</span>
</code></pre>
<h3 data-id="heading-37">✅ 5. 函数的 作用域（进阶重点，理解即可，面试高频）</h3>
<h4 data-id="heading-38">✔️ 什么是作用域？（通俗易懂，无晦涩概念）</h4>
<p>作用域 = 变量的「生效范围」，就是一个变量「能在哪个区域被访问、被使用」，超出这个区域就访问不到了。</p>
<blockquote>
<p>类比：你在自己家里可以随便用自己的东西（变量），但是到了别人家就不能用别人的东西，这就是「作用域」的本质。</p>
</blockquote>
<h4 data-id="heading-39">✔️ JS的两种核心作用域（必记，通俗易懂）</h4>
<p>在JS中，根据变量的声明位置，分为两种作用域，<strong>所有变量都遵守这个规则</strong>：</p>
<h5 data-id="heading-40">① 全局作用域（全局变量）</h5>
<ul>
<li><strong>定义</strong>：在「函数外部」声明的变量，就是「全局变量」</li>
<li><strong>作用范围</strong>：<strong>整个JS文件都能访问到</strong>，函数内部也能访问全局变量</li>
<li><strong>生命周期</strong>：页面打开时创建，页面关闭时销毁</li>
</ul>
<h5 data-id="heading-41">② 局部作用域（局部变量）</h5>
<ul>
<li><strong>定义</strong>：在「函数内部」声明的变量（包括函数的「形参」），就是「局部变量」</li>
<li><strong>作用范围</strong>：<strong>只能在当前函数内部访问</strong>，函数外部完全访问不到</li>
<li><strong>生命周期</strong>：函数调用时创建，函数执行结束后立刻销毁（节省内存）</li>
</ul>
<h4 data-id="heading-42">✔️ 作用域的核心规则（黄金规则，必背，开发不会出错）</h4>
<ol>
<li><strong>变量的访问规则</strong>：「就近原则」→ 访问变量时，先在当前作用域找，如果有就用；没有就去上一级作用域找，直到全局作用域；全局作用域没有则报错 <code>undefined</code>。</li>
<li><strong>变量的赋值规则</strong>：给变量赋值时，先在当前作用域找，如果有就赋值；没有就去上一级作用域找，直到全局作用域；全局作用域没有则「自动声明为全局变量」（不推荐）。</li>
</ol>
<h4 data-id="heading-43">✔️ 作用域的案例（一看就会，理解即可）</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 全局变量：在函数外部声明</span>
<span class="hljs-keyword">var</span> num = <span class="hljs-number">100</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">fn</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 局部变量：在函数内部声明</span>
  <span class="hljs-keyword">var</span> a = <span class="hljs-number">200</span>;
  <span class="hljs-comment">// 形参也是局部变量</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(num); <span class="hljs-comment">// 100 → 访问全局变量，能拿到</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(a); <span class="hljs-comment">//200 → 访问局部变量，能拿到</span>
}
<span class="hljs-title function_">fn</span>();

<span class="hljs-comment">// 函数外部访问局部变量 → 报错，访问不到</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(a); <span class="hljs-comment">// Uncaught ReferenceError: a is not defined</span>
<span class="hljs-comment">// 函数外部访问全局变量 → 能拿到</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(num); <span class="hljs-comment">//100</span>
</code></pre>
<h3 data-id="heading-44">✅ 6. 函数的 进阶使用：匿名函数 &amp; 立即执行函数（开发常用，了解即可）</h3>
<h4 data-id="heading-45">✔️ 匿名函数</h4>
<p>就是「没有名字的函数」，语法：<code>function() { 函数体 }</code></p>
<ul>
<li><strong>特点</strong>：无法直接调用，因为没有名字，一般和其他语法结合使用（如：数组遍历的回调函数、事件绑定）</li>
<li><strong>开发场景</strong>：数组的forEach/map/filter的回调函数，就是匿名函数，这也是匿名函数的最常用场景。</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 数组遍历的回调函数，就是匿名函数</span>
<span class="hljs-keyword">var</span> arr = [<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>];
arr.<span class="hljs-title function_">forEach</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">item</span>){ <span class="hljs-comment">// 这个function就是匿名函数</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(item);
});
</code></pre>
<h4 data-id="heading-46">✔️ 立即执行函数（IIFE）</h4>
<p>就是「定义后立刻执行的函数」，语法：<code>(function(){ 函数体 })();</code></p>
<ul>
<li><strong>特点</strong>：定义和调用合二为一，执行完后立刻销毁，不会污染全局变量</li>
<li><strong>开发场景</strong>：页面加载时需要执行的一次性逻辑，比如初始化数据、页面渲染前的准备工作。</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 立即执行函数：定义后立刻执行</span>
(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>){
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'我是立即执行函数，定义后马上执行'</span>);
})();
</code></pre>
<hr/>
<h2 data-id="heading-47">三、对象 核心（JS的核心数据类型，开发高频，进阶必备）</h2>
<h3 data-id="heading-48">✅ 为什么要学对象？（基础衔接，理解必要性）</h3>
<p>在基础篇中，我们用「数组」存储多个数据，但是数组有一个缺点：<strong>数据是无序的，只能通过索引访问，无法直观的表示数据的含义</strong>。</p>
<p>比如：存储一个人的信息，用数组是这样的：<code>var person = ['张三', 18, '男', '北京'];</code></p>
<ul>
<li>我们无法直观的知道 <code>person[0]</code> 是姓名，<code>person[1]</code> 是年龄</li>
<li>如果数据顺序变了，访问的结果就错了</li>
</ul>
<p>而 <strong>对象</strong> 就是为了解决这个问题而生的，对象的核心特点：<strong>用「键值对」的形式存储数据，键（属性名）表示数据的含义，值（属性值）表示数据的内容</strong>，可以直观的表示「一个事物的多个属性」，比如人、商品、文章等，都是用对象存储。</p>
<blockquote>
<p>一句话总结：数组是「有序的、无含义的」数据集合，对象是「无序的、有含义的」数据集合，数组适合存储「同类型的多个数据」，对象适合存储「一个事物的多个属性」。</p>
</blockquote>
<h3 data-id="heading-49">✅ 1. 对象的基础概念（通俗易懂，必记）</h3>
<h4 data-id="heading-50">✔️ 什么是对象？</h4>
<p>对象是JS中的一种 <strong>复杂数据类型</strong>，是一个「键值对的集合」，用来表示「一个具体的事物」，比如：一个人、一个商品、一个汽车。</p>
<ul>
<li><strong>键（key）</strong>：也叫「属性名」，是字符串类型，用来表示数据的「含义」（如：name、age、sex）</li>
<li><strong>值（value）</strong>：也叫「属性值」，可以是任意类型的数据（数字、字符串、布尔值、数组、甚至对象、函数）</li>
<li>键值对之间用 <code>,</code> 分隔，键和值之间用 <code>:</code> 分隔</li>
</ul>
<h4 data-id="heading-51">✔️ 对象的核心特点</h4>
<ol>
<li><strong>无序性</strong>：对象的属性没有顺序，不像数组有索引，访问属性只能通过「属性名」</li>
<li><strong>灵活性</strong>：对象的属性可以随时添加、修改、删除</li>
<li><strong>可读性</strong>：属性名有明确的含义，一看就知道存储的是什么数据</li>
</ol>
<h3 data-id="heading-52">✅ 2. 对象的 创建 &amp; 访问（基础语法，必会）</h3>
<h4 data-id="heading-53">✔️ 方式1：字面量创建对象（推荐，开发最常用，简洁高效）</h4>
<p><strong>语法格式（固定）</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">var</span> 对象名 = {
  属性名<span class="hljs-number">1</span>: 属性值<span class="hljs-number">1</span>,
  属性名<span class="hljs-number">2</span>: 属性值<span class="hljs-number">2</span>,
  属性名<span class="hljs-number">3</span>: 属性值<span class="hljs-number">3</span>,
  <span class="hljs-comment">// ... 可以写多个属性</span>
};
</code></pre>
<p><strong>案例</strong>：创建一个「人的对象」，存储姓名、年龄、性别、地址</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">var</span> person = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'张三'</span>,
  <span class="hljs-attr">age</span>: <span class="hljs-number">18</span>,
  <span class="hljs-attr">sex</span>: <span class="hljs-string">'男'</span>,
  <span class="hljs-attr">address</span>: <span class="hljs-string">'北京市'</span>,
  <span class="hljs-attr">hobby</span>: [<span class="hljs-string">'打球'</span>, <span class="hljs-string">'听歌'</span>, <span class="hljs-string">'编程'</span>] <span class="hljs-comment">// 属性值可以是数组</span>
};
</code></pre>
<h4 data-id="heading-54">✔️ 方式2：构造函数创建对象（了解即可）</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">var</span> person = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();
person.<span class="hljs-property">name</span> = <span class="hljs-string">'张三'</span>;
person.<span class="hljs-property">age</span> = <span class="hljs-number">18</span>;
person.<span class="hljs-property">sex</span> = <span class="hljs-string">'男'</span>;
</code></pre>
<h4 data-id="heading-55">✔️ 对象的属性访问（两种方式，必会，开发都用）</h4>
<p><strong>语法格式（两种，都要会）</strong>：</p>
<ol>
<li><strong>点语法</strong>：<code>对象名.属性名</code> → 推荐，语法简洁，可读性高（开发99%用这个）</li>
<li><strong>方括号语法</strong>：<code>对象名['属性名']</code> → 适合属性名是变量、或者属性名有特殊字符的场景</li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">var</span> person = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'张三'</span>,
  <span class="hljs-attr">age</span>: <span class="hljs-number">18</span>,
  <span class="hljs-attr">sex</span>: <span class="hljs-string">'男'</span>
};

<span class="hljs-comment">// 点语法访问</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(person.<span class="hljs-property">name</span>); <span class="hljs-comment">// 张三</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(person.<span class="hljs-property">age</span>); <span class="hljs-comment">//18</span>

<span class="hljs-comment">// 方括号语法访问</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(person[<span class="hljs-string">'name'</span>]); <span class="hljs-comment">//张三</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(person[<span class="hljs-string">'age'</span>]); <span class="hljs-comment">//18</span>
</code></pre>
<h3 data-id="heading-56">✅ 3. 对象的 属性 增/删/改/查（进阶，必会，开发高频）</h3>
<p>对象的属性是「动态的」，可以随时添加、修改、删除，语法简单，和访问属性的语法一致，<strong>必记</strong>：</p>
<h4 data-id="heading-57">✔️ ① 查：访问属性 → 两种方式，同上</h4>
<h4 data-id="heading-58">✔️ ② 改：修改属性值 → 访问属性后直接赋值</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">var</span> person = {<span class="hljs-attr">name</span>: <span class="hljs-string">'张三'</span>, <span class="hljs-attr">age</span>:<span class="hljs-number">18</span>};
person.<span class="hljs-property">age</span> = <span class="hljs-number">20</span>; <span class="hljs-comment">// 修改年龄为20</span>
person.<span class="hljs-property">name</span> = <span class="hljs-string">'李四'</span>; <span class="hljs-comment">// 修改姓名为李四</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(person); <span class="hljs-comment">// {name: '李四', age: 20}</span>
</code></pre>
<h4 data-id="heading-59">✔️ ③ 增：添加新属性 → 直接给对象的新属性赋值</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">var</span> person = {<span class="hljs-attr">name</span>: <span class="hljs-string">'张三'</span>, <span class="hljs-attr">age</span>:<span class="hljs-number">18</span>};
person.<span class="hljs-property">sex</span> = <span class="hljs-string">'男'</span>; <span class="hljs-comment">// 添加性别属性</span>
person.<span class="hljs-property">address</span> = <span class="hljs-string">'北京市'</span>; <span class="hljs-comment">// 添加地址属性</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(person); <span class="hljs-comment">// {name: '张三', age:18, sex:'男', address:'北京市'}</span>
</code></pre>
<h4 data-id="heading-60">✔️ ④ 删：删除属性 → 关键字 <code>delete</code></h4>
<p><strong>语法</strong>：<code>delete 对象名.属性名</code></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">var</span> person = {<span class="hljs-attr">name</span>: <span class="hljs-string">'张三'</span>, <span class="hljs-attr">age</span>:<span class="hljs-number">18</span>, <span class="hljs-attr">sex</span>:<span class="hljs-string">'男'</span>};
<span class="hljs-keyword">delete</span> person.<span class="hljs-property">sex</span>; <span class="hljs-comment">// 删除性别属性</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(person); <span class="hljs-comment">// {name: '张三', age:18}</span>
</code></pre>
<h3 data-id="heading-61">✅ 4. 对象的 方法（核心进阶，对象的灵魂，必会）</h3>
<h4 data-id="heading-62">✔️ 什么是对象的方法？</h4>
<p>对象的属性值可以是「任意类型的数据」，如果属性值是「函数」，那么这个属性就叫做「方法」。</p>
<blockquote>
<p>一句话总结：对象的属性是「描述事物的特征」（如：姓名、年龄），对象的方法是「描述事物的行为」（如：吃饭、跑步、说话、工作）。</p>
</blockquote>
<h4 data-id="heading-63">✔️ 方法的定义 &amp; 调用（语法固定，必会）</h4>
<h5 data-id="heading-64">① 定义方法：属性值是函数</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">var</span> person = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'张三'</span>,
  <span class="hljs-attr">age</span>: <span class="hljs-number">18</span>,
  <span class="hljs-comment">// 定义方法：属性名是sayHi，属性值是函数</span>
  <span class="hljs-attr">sayHi</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'你好，我是'</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span>);
  },
  <span class="hljs-comment">// 定义带参数的方法</span>
  <span class="hljs-attr">eat</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">food</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'我喜欢吃'</span> + food);
  }
};
</code></pre>
<blockquote>
<p><strong>重点关键字</strong>：<code>this</code> → 在对象的方法中，<code>this</code> 指向「当前对象」，可以通过 <code>this.属性名</code> 访问对象的属性，这是对象方法的核心语法，必记！</p>
</blockquote>
<h5 data-id="heading-65">② 调用方法：<code>对象名.方法名()</code> → 方法是函数，必须加括号调用</h5>
<pre><code class="hljs language-javascript" lang="javascript">person.<span class="hljs-title function_">sayHi</span>(); <span class="hljs-comment">// 输出：你好，我是张三</span>
person.<span class="hljs-title function_">eat</span>(<span class="hljs-string">'红烧肉'</span>); <span class="hljs-comment">// 输出：我喜欢吃红烧肉</span>
</code></pre>
<h3 data-id="heading-66">✅ 5. 对象的 遍历（进阶，必会，开发高频）</h3>
<p>对象是「键值对的集合」，没有索引，所以不能用for循环遍历，JS提供了专门的遍历对象的语法：<code>for...in</code> 循环，语法固定，必记。</p>
<h4 data-id="heading-67">✔️ for...in 循环遍历对象</h4>
<p><strong>语法格式（固定）</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> key <span class="hljs-keyword">in</span> 对象名) {
  <span class="hljs-comment">// key 是对象的「属性名」（字符串类型）</span>
  <span class="hljs-comment">// 对象名[key] 是对象的「属性值」</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'属性名：'</span>, key);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'属性值：'</span>, 对象名[key]);
}
</code></pre>
<p><strong>案例</strong>：遍历人的对象，打印所有属性名和属性值</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">var</span> person = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'张三'</span>,
  <span class="hljs-attr">age</span>: <span class="hljs-number">18</span>,
  <span class="hljs-attr">sex</span>: <span class="hljs-string">'男'</span>,
  <span class="hljs-attr">address</span>: <span class="hljs-string">'北京市'</span>
};

<span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> key <span class="hljs-keyword">in</span> person) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(key + <span class="hljs-string">'：'</span> + person[key]);
}
<span class="hljs-comment">// 输出：</span>
<span class="hljs-comment">// name：张三</span>
<span class="hljs-comment">// age：18</span>
<span class="hljs-comment">// sex：男</span>
<span class="hljs-comment">// address：北京市</span>
</code></pre>
<hr/>
<h2 data-id="heading-68">四、JS的 内置对象（进阶，开发高频，不用记，会查即用）</h2>
<h3 data-id="heading-69">✅ 什么是内置对象？（通俗易懂）</h3>
<p>JS为了方便开发者开发，<strong>提前内置了一些常用的对象</strong>，这些对象封装了很多常用的功能和方法，我们不需要自己封装，直接调用即可，比如：数组、字符串、数字、日期等，都是JS的内置对象。</p>
<blockquote>
<p>一句话总结：内置对象 = JS官方给我们写好的「工具包」，里面有很多现成的方法，拿来即用，节省开发时间。</p>
</blockquote>
<h3 data-id="heading-70">✅ 开发中最常用的3个内置对象（必会，高频）</h3>
<h4 data-id="heading-71">✔️ 1. 字符串内置对象（String）</h4>
<p>字符串本质上就是一个「字符数组」，JS为字符串内置了很多方法，用于处理字符串（如：截取、替换、转大小写、查找等），<strong>所有字符串都可以直接调用这些方法</strong>，原字符串不变，返回新字符串。</p>
<p><strong>常用方法（必记，开发高频）</strong>：</p>
<ul>
<li><code>字符串.length</code> → 获取字符串长度（基础）</li>
<li><code>字符串.indexOf(字符)</code> → 查找字符的索引，找不到返回-1</li>
<li><code>字符串.includes(字符)</code> → 判断是否包含某个字符，返回布尔值</li>
<li><code>字符串.toUpperCase()</code> → 转大写</li>
<li><code>字符串.toLowerCase()</code> → 转小写</li>
<li><code>字符串.slice(起始索引, 结束索引)</code> → 截取字符串，含头不含尾</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">var</span> str = <span class="hljs-string">'Hello JavaScript'</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(str.<span class="hljs-property">length</span>); <span class="hljs-comment">//16</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(str.<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">'Java'</span>)); <span class="hljs-comment">//6</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(str.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'Java'</span>)); <span class="hljs-comment">//true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(str.<span class="hljs-title function_">toUpperCase</span>()); <span class="hljs-comment">//HELLO JAVASCRIPT</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(str.<span class="hljs-title function_">toLowerCase</span>()); <span class="hljs-comment">//hello javascript</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(str.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>,<span class="hljs-number">5</span>)); <span class="hljs-comment">//Hello</span>
</code></pre>
<h4 data-id="heading-72">✔️ 2. 数字内置对象（Number）</h4>
<p>封装了数字的常用方法，开发中主要用两个常量：</p>
<ul>
<li><code>Number.MAX_VALUE</code> → JS中最大的数字</li>
<li><code>Number.MIN_VALUE</code> → JS中最小的正数</li>
</ul>
<h4 data-id="heading-73">✔️ 3. 日期内置对象（Date）（开发高频，必会）</h4>
<p>用于处理「日期和时间」，开发中经常用到（如：获取当前时间、格式化时间、计算时间差），语法固定，会用即可。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 创建日期对象：获取当前时间</span>
<span class="hljs-keyword">var</span> date = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(date); <span class="hljs-comment">// 打印当前完整时间</span>

<span class="hljs-comment">// 常用方法：获取年、月、日、时、分、秒</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(date.<span class="hljs-title function_">getFullYear</span>()); <span class="hljs-comment">// 获取年份（4位）</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(date.<span class="hljs-title function_">getMonth</span>() + <span class="hljs-number">1</span>); <span class="hljs-comment">// 获取月份（0-11，所以要+1）</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(date.<span class="hljs-title function_">getDate</span>()); <span class="hljs-comment">// 获取日期</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(date.<span class="hljs-title function_">getHours</span>()); <span class="hljs-comment">// 获取小时</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(date.<span class="hljs-title function_">getMinutes</span>()); <span class="hljs-comment">// 获取分钟</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(date.<span class="hljs-title function_">getSeconds</span>()); <span class="hljs-comment">// 获取秒</span>
</code></pre>
<hr/>
<h2 data-id="heading-74">最后：进阶篇学习建议（零基础友好，2025良心建议）</h2>
<ol>
<li><strong>学习顺序</strong>：先吃透「数组进阶」→ 再学「函数核心」→ 最后学「对象核心」，这三个模块是进阶篇的核心，也是开发的核心，循序渐进，不要跳着学。</li>
<li><strong>学习方法</strong>：进阶内容的核心是「理解原理 + 多做案例」，每个知识点先看懂案例，再自己仿写，比如：封装求和函数、封装求最大值函数、封装数组去重函数、创建对象并遍历，这些都是经典案例，一定要自己敲一遍。</li>
<li><strong>核心重点</strong>：函数的「参数和返回值」是函数的精髓，对象的「键值对和方法」是对象的精髓，数组的「高阶遍历方法」是数组的精髓，这三个点吃透，你就掌握了JS的核心编程思想。</li>
<li><strong>心态调整</strong>：进阶内容比基础内容难一点，遇到不懂的地方不要慌，多看几遍案例、多敲几遍代码，就能理解，这是所有前端开发者的必经之路，坚持下去就会突破。</li>
</ol>
<hr/>
<p><strong>结语</strong>：本文档是JavaScript基础版的无缝衔接进阶内容，涵盖了开发中<strong>90%的高频进阶知识点</strong>，语句通俗易懂、案例充足，零基础可直接上手。学好这些内容，你就具备了编写「复杂业务逻辑」的能力，后续可以继续学习「DOM操作、BOM操作、事件、AJAX」等前端实战内容，向真正的前端开发工程师迈进！加油！💪</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Commit 阶段的 3 个子阶段与副作用执行全解析]]></title>    <link>https://juejin.cn/post/7588388014504493098</link>    <guid>https://juejin.cn/post/7588388014504493098</guid>    <pubDate>2025-12-28T12:59:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588388014504493098" data-draft-id="7588191506607341574" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Commit 阶段的 3 个子阶段与副作用执行全解析"/> <meta itemprop="keywords" content="前端,React.js"/> <meta itemprop="datePublished" content="2025-12-28T12:59:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="day1"/> <meta itemprop="url" content="https://juejin.cn/user/4310544201823182"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Commit 阶段的 3 个子阶段与副作用执行全解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4310544201823182/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    day1
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-28T12:59:45.000Z" title="Sun Dec 28 2025 12:59:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读18分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、前言</h2>
<p>Commit 阶段是 React 更新流程的最后一环，用于把 Render 阶段计算出的变更与副作用原子化地应用到宿主环境（DOM），确保界面一致性与不出现中间态。</p>
<h2 data-id="heading-1">二、React 全流程视角下的 Commit 阶段</h2>
<h3 data-id="heading-2">2.1 React 渲染全流程回顾</h3>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f114594b3011466dad716fcbeeddf7c3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZGF5MQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767531584&amp;x-signature=lY6Tq3%2BWx30hLi1qhaJjiK1JxWA%3D" alt="7-1.png" loading="lazy"/></p>
<ol>
<li>触发：来自事件、<code>setState</code>、<code>dispatch</code>、<code>startTransition</code>、异步回调等，进入调度。</li>
<li>调度：为更新分配车道（<code>Lane</code>），选择下一批工作（<code>getNextLanes</code>），安排回调。</li>
<li>Render（可中断）：自顶向下构建/复用 Fiber，Diff 得出宿主层变更与副作用列表；不会触碰 DOM。</li>
<li>Commit（不可中断）：原子化应用 DOM 变更，执行 layout 类副作用与 ref，保证可见更新的一致性。</li>
<li>绘制（Paint）：浏览器将提交的变更绘制到屏幕。</li>
<li>被动阶段（Passive）：在一个独立宏任务中异步冲洗 <code>useEffect</code>（HookPassive）的清理与安装，避免阻塞提交与布局。</li>
</ol>
<h3 data-id="heading-3">2.2 Commit 阶段的核心目标</h3>
<ol>
<li>原子应用宿主层变更：在一次不可中断的关键段内完成所有 DOM 插入/删除/属性更新，避免“半提交”导致的视觉撕裂。</li>
<li>正确的副作用时序：<code>useInsertionEffect</code> 在变更前、<code>useLayoutEffect</code> 清理于变更期/安装于布局期、类组件 <code>DidMount/DidUpdate</code> 与 ref 绑定于布局期。</li>
<li>界面一致性与可预期的读写：布局读/写必须发生在稳定的 DOM 状态上，确保测量与同步操作正确。</li>
<li>与调度器的配合：提交期间不让步、不给调度器插入中断，确保一个提交完成后再进入绘制与被动阶段。</li>
<li>产出后续异步工作：将 <code>useEffect</code> 的清理与安装延迟到绘制后，尽量降低对交互的阻塞。</li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 提交阶段的顺序（简化伪代码）</span>
<span class="hljs-title function_">commitBeforeMutationEffects</span>(root, finishedWork, lanes); <span class="hljs-comment">// 变更前处理，如焦点/过渡</span>
<span class="hljs-title function_">commitMutationEffects</span>(root, finishedWork, lanes); <span class="hljs-comment">// 应用 DOM 变更</span>
<span class="hljs-title function_">commitLayoutEffects</span>(root, finishedWork, lanes); <span class="hljs-comment">// ref、类组件、layout effect 安装</span>
<span class="hljs-comment">// 绘制发生在上述之后；随后进入被动阶段：</span>
<span class="hljs-title function_">flushPassiveEffects</span>(); <span class="hljs-comment">// useEffect 的清理和安装（异步宏任务）</span>
</code></pre>
<h2 data-id="heading-4">三、Commit 阶段源码关键函数解析</h2>
<h3 data-id="heading-5">3.1 入口函数：commitRoot</h3>
<h4 data-id="heading-6">3.1.1 角色定位：</h4>
<p>提交阶段的总调度器；将 Render 阶段完成的变更与副作用在宿主环境原子化应用。</p>
<h4 data-id="heading-7">3.1.2 核心特征：</h4>
<ol>
<li>不可中断：提交路径置位 <code>CommitContext</code>，不调用 <code>shouldYield</code>。</li>
<li>明确分期：严格依序执行 Before Mutation → Mutation → Layout。</li>
<li>提交后异步：被动副作用（<code>useEffect</code>）在一个后续宏任务中冲洗，避免阻塞交互。</li>
<li>关键职责（串联三子阶段并安排 Passive）：</li>
</ol>
<ul>
<li>冲刷潜在残留的被动效果，确保提交干净。</li>
<li>进入提交上下文并短期提升更新优先级到离散事件级别。</li>
<li>在 Mutation 结束后切换当前树：<code>root.current = finishedWork</code>。</li>
<li>调度并在绘制后冲洗被动副作用，设置合适的更新优先级。</li>
</ul>
<h4 data-id="heading-8">3.1.3 核心实现逻辑</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">commitRoot</span>(<span class="hljs-params">root, finishedWork, lanes <span class="hljs-comment">/* ... */</span></span>) {
  <span class="hljs-comment">// 先冲刷可能残留的被动效果，确保提交干净</span>
  <span class="hljs-keyword">do</span> {
    <span class="hljs-title function_">flushPendingEffects</span>();
  } <span class="hljs-keyword">while</span> (pendingEffectsStatus !== <span class="hljs-variable constant_">NO_PENDING_EFFECTS</span>);

  <span class="hljs-comment">// 设置提交阶段的性能标记与校验</span>
  <span class="hljs-comment">// ...</span>

  <span class="hljs-comment">// 安排被动效果（Passive）后续冲洗（必要时）</span>
  <span class="hljs-keyword">if</span> (
    (finishedWork.<span class="hljs-property">subtreeFlags</span> &amp; <span class="hljs-title class_">PassiveMask</span>) !== <span class="hljs-title class_">NoFlags</span> ||
    (finishedWork.<span class="hljs-property">flags</span> &amp; <span class="hljs-title class_">PassiveMask</span>) !== <span class="hljs-title class_">NoFlags</span>
  ) {
    <span class="hljs-comment">// 常规：调度一个普通优先级任务执行 flushPassiveEffects</span>
    root.<span class="hljs-property">callbackNode</span> = <span class="hljs-literal">null</span>;
    root.<span class="hljs-property">callbackPriority</span> = <span class="hljs-title class_">NoLane</span>;
    <span class="hljs-title function_">scheduleCallback</span>(<span class="hljs-title class_">NormalSchedulerPriority</span>, <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-title function_">flushPassiveEffects</span>(<span class="hljs-literal">true</span>);
      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    });
  } <span class="hljs-keyword">else</span> {
    root.<span class="hljs-property">callbackNode</span> = <span class="hljs-literal">null</span>;
    root.<span class="hljs-property">callbackPriority</span> = <span class="hljs-title class_">NoLane</span>;
  }

  <span class="hljs-comment">// Before Mutation 子阶段（提交上下文 + 提升优先级）</span>
  <span class="hljs-keyword">if</span> (hasBeforeMutationEffects) {
    <span class="hljs-keyword">const</span> prev = <span class="hljs-title function_">getCurrentUpdatePriority</span>();
    <span class="hljs-title function_">setCurrentUpdatePriority</span>(<span class="hljs-title class_">DiscreteEventPriority</span>); <span class="hljs-comment">// 提交路径短期提升为离散优先级</span>
    <span class="hljs-keyword">const</span> prevCtx = executionContext;
    executionContext |= <span class="hljs-title class_">CommitContext</span>; <span class="hljs-comment">// 进入提交上下文</span>
    <span class="hljs-keyword">try</span> {
      <span class="hljs-title function_">commitBeforeMutationEffects</span>(root, finishedWork, lanes); <span class="hljs-comment">// DOM 读前置与快照</span>
    } <span class="hljs-keyword">finally</span> {
      executionContext = prevCtx;
      <span class="hljs-title function_">setCurrentUpdatePriority</span>(prev);
    }
  }

  <span class="hljs-keyword">if</span> (!startedViewTransition) {
    <span class="hljs-title function_">flushMutationEffects</span>(); <span class="hljs-comment">// 执行 DOM 增删改</span>
    <span class="hljs-title function_">flushLayoutEffects</span>(); <span class="hljs-comment">// 执行 useLayoutEffect、更新 ref 等</span>
    <span class="hljs-title function_">flushSpawnedWork</span>(); <span class="hljs-comment">// 提交后异步执行 flushPassiveEffects</span>
  }
}
</code></pre>
<h4 data-id="heading-9">3.1.4 示例：一次“点击打开弹层”的完整提交与副作用时序</h4>
<p>以下示例展示一次离散事件（<code>click</code>）触发的更新如何穿越三个子阶段，以及绘制后的被动副作用如何执行与设定优先级。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">DialogExample</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [open, setOpen] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);
  <span class="hljs-keyword">const</span> dialogRef = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">null</span>);

  <span class="hljs-comment">// Layout 阶段执行：此处可安全测量并同步读写 DOM</span>
  <span class="hljs-title function_">useLayoutEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (open &amp;&amp; dialogRef.<span class="hljs-property">current</span>) {
      <span class="hljs-comment">// 运行于 Layout 子阶段：DOM 已变更且稳定</span>
      <span class="hljs-keyword">const</span> rect = dialogRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">getBoundingClientRect</span>(); <span class="hljs-comment">// 同步测量</span>
      <span class="hljs-comment">// 例如根据尺寸定位弹层</span>
      dialogRef.<span class="hljs-property">current</span>.<span class="hljs-property">style</span>.<span class="hljs-property">top</span> = <span class="hljs-string">`<span class="hljs-subst">${rect.bottom + <span class="hljs-number">8</span>}</span>px`</span>;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-comment">// 下次提交时，Layout 清理发生在 Mutation 之前（避免脏读）</span>
      <span class="hljs-comment">// 可在这里撤销同步副作用（如绑定的同步事件等）</span>
    };
  }, [open]);

  <span class="hljs-comment">// Passive 阶段执行：绘制后再执行，避免阻塞提交/布局</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (!open) <span class="hljs-keyword">return</span>;
    <span class="hljs-comment">// 示例：给窗口添加滚动监听，滚动时关闭弹层</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">onScroll</span> = (<span class="hljs-params"/>) =&gt; {
      <span class="hljs-comment">// 注意：此处 setState 的更新优先级由 Passive 阶段设定：</span>
      <span class="hljs-comment">// priority = lowerEventPriority(DefaultEventPriority, lanesToEventPriority(pendingEffectsLanes))</span>
      <span class="hljs-comment">// 通常为 Default；如果本次渲染包含 Idle 等更低优先级，效果更新也会更低</span>
      <span class="hljs-title function_">setOpen</span>(<span class="hljs-literal">false</span>);
    };
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"scroll"</span>, onScroll);
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">"scroll"</span>, onScroll); <span class="hljs-comment">// Passive 清理</span>
  }, [open]);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span>
        <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> {
          setOpen(true); // 离散事件入口（click）：触发一次高优先级更新
        }}
      &gt;
        打开弹层
      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>

      {open &amp;&amp; (
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">{dialogRef}</span>&gt;</span>
          弹层内容（Layout 效果会在提交后立刻测量并定位）
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      )}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<p>时间线解读：</p>
<ul>
<li>Before Mutation：读取现有焦点/选择，准备快照与过渡信息；不触碰 DOM。</li>
<li>Mutation：插入弹层节点、属性写入、可能的宿主层重置；随后 <code>root.current = finishedWork</code>。</li>
<li>Layout：执行 <code>useLayoutEffect</code> 清理与安装、类组件 <code>DidMount/DidUpdate</code>、<code>ref</code> 绑定；支持同步测量。</li>
<li>Paint：浏览器将变更绘制到屏幕（用户现在看到弹层）。</li>
<li>Passive：宏任务中冲洗 <code>useEffect</code> 清理与安装，此处绑定滚动监听；若滚动触发 <code>setOpen(false)</code>，该更新优先级不会高于 <code>DefaultEventPriority</code>，并可能更低（比如渲染包含 Idle 车道时）。</li>
</ul>
<h4 data-id="heading-10">3.1.5 commit 流程图</h4>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6e598a5638d94a1f8bbe0e34657d1d82~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZGF5MQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767531584&amp;x-signature=pxuCES90zR8nI69uYbooqIHP0B0%3D" alt="7-2.png" loading="lazy"/></p>
<h3 data-id="heading-11">3.2 子阶段一：Before Mutation</h3>
<p>简单说，这个阶段的核心是：在 DOM 发生任何增删改之前，先完成 “读状态” 和 “做准备” 的工作—— 比如记录 DOM 快照、处理焦点，避免后续 DOM 变更破坏这些需要的信息，确保数据和交互的一致性。</p>
<h4 data-id="heading-12">3.2.1 核心目标与执行时机</h4>
<ol>
<li>核心目标：DOM 变更前，安全读取当前页面状态（如滚动位置、焦点元素、选择的文本），执行前置准备（如快照、焦点处理）。</li>
<li>关键时机：在 Mutation 阶段（实际改 DOM）之前，且整个过程同步执行、不可中断。</li>
<li>为什么要单独分这个阶段：如果先改 DOM 再读状态，拿到的就是变更后的数据，可能导致逻辑错误（比如想记录列表滚动位置，结果 DOM 先更新了，滚动位置变了）。</li>
</ol>
<h4 data-id="heading-13">3.2.2 核心实现逻辑</h4>
<p>commitBeforeMutationEffects 先初始化提交环境（获取聚焦实例句柄、判断视图过渡场景），通过 commitBeforeMutationEffects_begin 以深度优先方式遍历 Fiber 树，先处理待删除子节点的提交前副作用，有子节点且子树含相关副作用标记则深入遍历，无子节点则记录视图过渡状态并切换到兄弟 / 父节点；遍历过程中通过 commitBeforeMutationEffects_onFiber 处理单个节点逻辑，包括焦点在隐藏 Suspense 边界内的失焦处理、类组件 getSnapshotBeforeUpdate 快照执行、根节点容器清空等，全程在 DOM 变更前完成，为后续 Mutation 阶段做准备，执行完毕后清理环境状态。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">commitBeforeMutationEffects</span>(<span class="hljs-params">
  root: FiberRoot,
  firstChild: Fiber,
  committedLanes: Lanes
</span>): <span class="hljs-keyword">void</span> {
  focusedInstanceHandle = <span class="hljs-title function_">prepareForCommit</span>(root.<span class="hljs-property">containerInfo</span>);
  shouldFireAfterActiveInstanceBlur = <span class="hljs-literal">false</span>;

  <span class="hljs-keyword">const</span> isViewTransitionEligible =
    enableViewTransition &amp;&amp;
    <span class="hljs-title function_">includesOnlyViewTransitionEligibleLanes</span>(committedLanes);

  <span class="hljs-comment">// 初始化副作用遍历指针，指向待处理的第一个 Fiber 节点</span>
  nextEffect = firstChild;
  <span class="hljs-comment">// 开始执行提交前阶段核心逻辑</span>
  <span class="hljs-title function_">commitBeforeMutationEffects_begin</span>(isViewTransitionEligible);

  focusedInstanceHandle = <span class="hljs-literal">null</span>;
  <span class="hljs-title function_">resetAppearingViewTransitions</span>();
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">commitBeforeMutationEffects_begin</span>(<span class="hljs-params">isViewTransitionEligible: boolean</span>) {
  <span class="hljs-comment">// 确定副作用掩码：视图过渡场景用专用掩码，否则用默认提交前掩码</span>
  <span class="hljs-keyword">const</span> subtreeMask = isViewTransitionEligible
    ? <span class="hljs-title class_">BeforeAndAfterMutationTransitionMask</span>
    : <span class="hljs-title class_">BeforeMutationMask</span>;

  <span class="hljs-comment">// 遍历副作用链表（nextEffect 驱动）</span>
  <span class="hljs-keyword">while</span> (nextEffect !== <span class="hljs-literal">null</span>) {
    <span class="hljs-keyword">const</span> fiber = nextEffect;

    <span class="hljs-comment">// 先处理 deletions：父→子</span>
    <span class="hljs-keyword">if</span> (enableCreateEventHandleAPI || isViewTransitionEligible) {
      <span class="hljs-keyword">const</span> deletions = fiber.<span class="hljs-property">deletions</span>;
      <span class="hljs-keyword">if</span> (deletions !== <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; deletions.<span class="hljs-property">length</span>; i++) {
          <span class="hljs-title function_">commitBeforeMutationEffectsDeletion</span>(
            deletions[i],
            isViewTransitionEligible
          );
        }
      }
    }

    <span class="hljs-comment">// 隐藏子树优化（Offscreen/Suspense）与视图过渡特殊处理</span>
    <span class="hljs-keyword">if</span> (enableViewTransition &amp;&amp; fiber.<span class="hljs-property">tag</span> === <span class="hljs-title class_">OffscreenComponent</span>) {
      <span class="hljs-comment">// 根据隐藏/显现状态跳过或特殊遍历</span>
      <span class="hljs-title function_">commitBeforeMutationEffects_complete</span>(isViewTransitionEligible);
      <span class="hljs-keyword">continue</span>;
    }

    <span class="hljs-keyword">const</span> child = fiber.<span class="hljs-property">child</span>;
    <span class="hljs-comment">// 有子节点且子树含提交前副作用标记：深入子节点遍历（深度优先）</span>
    <span class="hljs-keyword">if</span> ((fiber.<span class="hljs-property">subtreeFlags</span> &amp; subtreeMask) !== <span class="hljs-title class_">NoFlags</span> &amp;&amp; child !== <span class="hljs-literal">null</span>) {
      child.<span class="hljs-property">return</span> = fiber;
      nextEffect = child;
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">if</span> (isViewTransitionEligible) {
        <span class="hljs-comment">// 视图过渡：记录子树内变更前状态</span>
        <span class="hljs-title function_">commitNestedViewTransitions</span>(fiber);
      }
      <span class="hljs-comment">// 完成当前节点处理，切换到兄弟/父节点</span>
      <span class="hljs-title function_">commitBeforeMutationEffects_complete</span>(isViewTransitionEligible);
    }
  }
}

<span class="hljs-comment">// 处理单个 Fiber 节点的提交前副作用</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">commitBeforeMutationEffects_onFiber</span>(<span class="hljs-params">
  finishedWork: Fiber,
  isViewTransitionEligible: boolean
</span>) {
  <span class="hljs-keyword">const</span> current = finishedWork.<span class="hljs-property">alternate</span>;
  <span class="hljs-keyword">const</span> flags = finishedWork.<span class="hljs-property">flags</span>;

  <span class="hljs-comment">// 焦点在隐藏边界内的处理</span>
  <span class="hljs-keyword">if</span> (enableCreateEventHandleAPI) {
    <span class="hljs-keyword">if</span> (!shouldFireAfterActiveInstanceBlur &amp;&amp; focusedInstanceHandle !== <span class="hljs-literal">null</span>) {
      <span class="hljs-keyword">if</span> (
        finishedWork.<span class="hljs-property">tag</span> === <span class="hljs-title class_">SuspenseComponent</span> &amp;&amp;
        <span class="hljs-title function_">isSuspenseBoundaryBeingHidden</span>(current, finishedWork) &amp;&amp;
        <span class="hljs-title function_">doesFiberContain</span>(finishedWork, focusedInstanceHandle)
      ) {
        shouldFireAfterActiveInstanceBlur = <span class="hljs-literal">true</span>;
        <span class="hljs-title function_">beforeActiveInstanceBlur</span>(finishedWork); <span class="hljs-comment">//  // 执行活跃实例失焦前回调</span>
      }
    }
  }

  <span class="hljs-keyword">switch</span> (finishedWork.<span class="hljs-property">tag</span>) {
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">ClassComponent</span>: {
      <span class="hljs-keyword">if</span> ((flags &amp; <span class="hljs-title class_">Snapshot</span>) !== <span class="hljs-title class_">NoFlags</span> &amp;&amp; current !== <span class="hljs-literal">null</span>) {
        <span class="hljs-comment">// 类组件：存在 Snapshot 标记且有旧节点，执行快照逻辑（如 getSnapshotBeforeUpdate）</span>
        <span class="hljs-title function_">commitClassSnapshot</span>(finishedWork, current);
      }
      <span class="hljs-keyword">break</span>;
    }
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">HostRoot</span>: {
      <span class="hljs-comment">// 根节点：存在 Snapshot 标记，清空容器（DOM 变更前准备）</span>
      <span class="hljs-keyword">if</span> ((flags &amp; <span class="hljs-title class_">Snapshot</span>) !== <span class="hljs-title class_">NoFlags</span>) {
        <span class="hljs-keyword">if</span> (supportsMutation) {
          <span class="hljs-keyword">const</span> root = finishedWork.<span class="hljs-property">stateNode</span>;
          <span class="hljs-title function_">clearContainer</span>(root.<span class="hljs-property">containerInfo</span>);
        }
      }
      <span class="hljs-keyword">break</span>;
    }
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">FunctionComponent</span>: {
      <span class="hljs-comment">// useEffectEvent：更新事件实现引用（非 DOM 快照）</span>
      <span class="hljs-comment">// 省略具体细节</span>
      <span class="hljs-keyword">break</span>;
    }
    <span class="hljs-attr">default</span>: {
      <span class="hljs-keyword">if</span> ((flags &amp; <span class="hljs-title class_">Snapshot</span>) !== <span class="hljs-title class_">NoFlags</span>) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"Unexpected Snapshot flag for this fiber tag."</span>);
      }
    }
  }
}
</code></pre>
<h3 data-id="heading-14">3.3 子阶段二：Mutation</h3>
<p>Mutation 阶段是 React 真正 “动手修改 DOM” 的阶段，核心任务是将 Render 阶段计算出的 DOM 变更（插入、删除、更新）应用到真实 DOM 上，同时完成旧 Ref 解绑、宿主状态清理等关键操作。这一阶段的操作直接影响用户可见的界面，且全程同步执行、不可中断。</p>
<h4 data-id="heading-15">3.3.1 核心目标与执行时机</h4>
<ol>
<li>核心目标：执行真实 DOM 操作（插入新节点、删除旧节点、更新属性 / 文本），并完成与 DOM 变更相关的前置清理（如旧 Ref 解绑）。</li>
<li>关键时机：在 Before Mutation 阶段（读状态）之后，Layout 阶段（读新 DOM 状态）之前，是 “写 DOM” 的唯一阶段。</li>
<li>为什么重要：这是虚拟 DOM 映射到真实 DOM 的 “最后一步”，所有 Render 阶段的计算结果在此落地，直接决定用户看到的界面。</li>
</ol>
<h4 data-id="heading-16">3.3.2 核心实现逻辑</h4>
<ol>
<li>和 Before Mutation 阶段类似，Mutation 阶段也需要确保操作不被打断，因此会先切换到高优先级环境，会调用<code>commitMutationEffectsOnFiber</code> 来递归处理 <code>finishedWork</code> 树。</li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> prev = <span class="hljs-title function_">getCurrentUpdatePriority</span>();
<span class="hljs-title function_">setCurrentUpdatePriority</span>(<span class="hljs-title class_">DiscreteEventPriority</span>);
<span class="hljs-keyword">const</span> prevCtx = executionContext;
executionContext |= <span class="hljs-title class_">CommitContext</span>;
<span class="hljs-keyword">try</span> {
  <span class="hljs-title function_">commitMutationEffects</span>(root, finishedWork, lanes); <span class="hljs-comment">// 核心：执行所有 DOM 变更操作</span>
  <span class="hljs-title function_">resetAfterCommit</span>(root.<span class="hljs-property">containerInfo</span>); <span class="hljs-comment">// 宿主层收尾</span>
} <span class="hljs-keyword">finally</span> {
  executionContext = prevCtx;
  <span class="hljs-title function_">setCurrentUpdatePriority</span>(prev);
}

<span class="hljs-comment">// 关键：DOM 变更完成后，切换当前 Fiber 树（旧树 → 新树）</span>
root.<span class="hljs-property">current</span> = finishedWork;
<span class="hljs-comment">// 标记进入下一阶段（Layout 阶段）</span>
pendingEffectsStatus = <span class="hljs-variable constant_">PENDING_LAYOUT_PHASE</span>;
</code></pre>
<ol start="2">
<li><code>commitMutationEffectsOnFiber</code> 是实际执行副作用的核心。它会根据 <code>fiber.flags</code> 的不同，执行相应的操作。其基本流程是 “自上而下” 递归，但处理副作用的顺序有所不同。</li>
</ol>
<p>首先处理 <code>deletions</code>，在遍历子节点之前，优先处理当前 Fiber 节点上标记为 <code>ChildDeletion</code> 的所有待删除子节点。这确保了在执行其他变更前，旧的 DOM 节点已被移除；然后递归子节点：如果子树中存在 <code>MutationMask</code> 标记的变更，则继续向下遍历，对每个子节点调用 <code>commitMutationEffectsOnFiber</code>；在递归回到当前 Fiber 后，处理自身的副作用。例如，对于 <code>HostComponent</code>，会根据 <code>flags</code> 执行 <code>commitHostUpdate</code>（更新属性）或 <code>commitHostPlacement</code>（插入 DOM 树）。对于函数组件，会在这里触发 <code>useInsertionEffect</code> 的销毁和创建回调。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">commitMutationEffectsOnFiber</span>(<span class="hljs-params">
  finishedWork: Fiber,
  root: FiberRoot,
  lanes: Lanes
</span>) {
  <span class="hljs-keyword">const</span> flags = finishedWork.<span class="hljs-property">flags</span>;

  <span class="hljs-keyword">switch</span> (finishedWork.<span class="hljs-property">tag</span>) {
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">FunctionComponent</span>:
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">ForwardRef</span>:
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">SimpleMemoComponent</span>: {
      <span class="hljs-comment">// 递归处理子节点的 Mutation Effects</span>
      <span class="hljs-title function_">recursivelyTraverseMutationEffects</span>(root, finishedWork, lanes);
      <span class="hljs-comment">// 处理当前节点的 Placement (插入)</span>
      <span class="hljs-title function_">commitReconciliationEffects</span>(finishedWork);

      <span class="hljs-comment">// 3. 如果有 Update 标记 (通常由 Hook 副作用引起)</span>
      <span class="hljs-keyword">if</span> (flags &amp; <span class="hljs-title class_">Update</span>) {
        <span class="hljs-comment">// 卸载之前的插入副作用钩子 (useInsertionEffect)</span>
        <span class="hljs-title function_">commitHookEffectListUnmount</span>(
          <span class="hljs-title class_">HookInsertion</span> | <span class="hljs-title class_">HookHasEffect</span>,
          finishedWork,
          finishedWork.<span class="hljs-property">return</span>
        );
        <span class="hljs-comment">// 挂载新的插入副作用钩子 (useInsertionEffect)</span>
        <span class="hljs-title function_">commitHookEffectListMount</span>(<span class="hljs-title class_">HookInsertion</span> | <span class="hljs-title class_">HookHasEffect</span>, finishedWork);
        <span class="hljs-comment">// 卸载之前的插入副作用钩子 (useLayoutEffect)</span>
        <span class="hljs-title function_">commitHookLayoutUnmountEffects</span>(
          finishedWork,
          finishedWork.<span class="hljs-property">return</span>,
          <span class="hljs-title class_">HookLayout</span> | <span class="hljs-title class_">HookHasEffect</span>
        );、
      }
      <span class="hljs-keyword">break</span>;
    }
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">ClassComponent</span>: {
      <span class="hljs-title function_">recursivelyTraverseMutationEffects</span>(root, finishedWork, lanes);
      <span class="hljs-title function_">commitReconciliationEffects</span>(finishedWork);

      <span class="hljs-keyword">if</span> (flags &amp; <span class="hljs-title class_">Ref</span>) {
        <span class="hljs-comment">// 解绑旧的 ref</span>
        <span class="hljs-keyword">const</span> current = finishedWork.<span class="hljs-property">alternate</span>;
        <span class="hljs-keyword">if</span> (current !== <span class="hljs-literal">null</span>) {
          <span class="hljs-title function_">safelyDetachRef</span>(current, current.<span class="hljs-property">return</span>);
        }
      }
      <span class="hljs-keyword">break</span>;
    }
    <span class="hljs-comment">// DOM 元素</span>
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">HostComponent</span>: {
      <span class="hljs-title function_">recursivelyTraverseMutationEffects</span>(root, finishedWork, lanes);
      <span class="hljs-title function_">commitReconciliationEffects</span>(finishedWork);

      <span class="hljs-keyword">if</span> (flags &amp; <span class="hljs-title class_">Ref</span>) {
        <span class="hljs-keyword">const</span> current = finishedWork.<span class="hljs-property">alternate</span>;
        <span class="hljs-keyword">if</span> (current !== <span class="hljs-literal">null</span>) {
          <span class="hljs-title function_">safelyDetachRef</span>(current, current.<span class="hljs-property">return</span>);
        }
      }

      <span class="hljs-keyword">if</span> (flags &amp; <span class="hljs-title class_">Update</span>) {
        <span class="hljs-keyword">const</span> instance = finishedWork.<span class="hljs-property">stateNode</span>;
        <span class="hljs-keyword">if</span> (instance != <span class="hljs-literal">null</span>) {
          <span class="hljs-comment">// 应用 DOM 属性更新</span>
          <span class="hljs-keyword">const</span> newProps = finishedWork.<span class="hljs-property">memoizedProps</span>;
          <span class="hljs-keyword">const</span> oldProps = current !== <span class="hljs-literal">null</span> ? current.<span class="hljs-property">memoizedProps</span> : newProps;
          <span class="hljs-keyword">const</span> type = finishedWork.<span class="hljs-property">type</span>;
          <span class="hljs-keyword">const</span> updatePayload = finishedWork.<span class="hljs-property">updateQueue</span>;
          finishedWork.<span class="hljs-property">updateQueue</span> = <span class="hljs-literal">null</span>;
          <span class="hljs-keyword">if</span> (updatePayload) {
            <span class="hljs-comment">// 调用 commitHostUpdate 执行 DOM 更新</span>
            <span class="hljs-title function_">commitHostUpdate</span>(
              instance,
              updatePayload,
              type,
              oldProps,
              newProps,
              finishedWork
            );
          }
        }
      }
      <span class="hljs-keyword">break</span>;
    }
    <span class="hljs-comment">// ... 其他类型的 Fiber</span>
  }
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">recursivelyTraverseMutationEffects</span>(<span class="hljs-params">root, parentFiber, lanes</span>) {
  <span class="hljs-comment">// 优先处理删除</span>
  <span class="hljs-keyword">const</span> deletions = parentFiber.<span class="hljs-property">deletions</span>;
  <span class="hljs-keyword">if</span> (deletions !== <span class="hljs-literal">null</span>) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; deletions.<span class="hljs-property">length</span>; i++) {
      <span class="hljs-keyword">const</span> childToDelete = deletions[i];
      <span class="hljs-title function_">commitDeletionEffects</span>(root, parentFiber, childToDelete);
    }
  }

  <span class="hljs-comment">// 递归处理子节点</span>
  <span class="hljs-keyword">if</span> (parentFiber.<span class="hljs-property">subtreeFlags</span> &amp; <span class="hljs-title class_">MutationMask</span>) {
    <span class="hljs-keyword">let</span> child = parentFiber.<span class="hljs-property">child</span>;
    <span class="hljs-keyword">while</span> (child !== <span class="hljs-literal">null</span>) {
      <span class="hljs-title function_">commitMutationEffectsOnFiber</span>(child, root, lanes);
      child = child.<span class="hljs-property">sibling</span>;
    }
  }
}
</code></pre>
<h3 data-id="heading-17">3.4 子阶段三：Layout</h3>
<p>Layout 阶段是提交过程中 DOM 稳定后、被动副作用执行前的关键环节，核心目标是处理需要依赖完整 DOM 状态的同步操作，同时完成组件生命周期与 ref 的最终绑定。</p>
<h4 data-id="heading-18">3.4.1 核心目标与执行时机</h4>
<ol>
<li>核心目标：在 DOM 状态稳定后同步处理依赖 DOM 的布局操作、生命周期回调与 ref 绑定。</li>
<li>关键时机：Mutation 阶段（DOM 增删改）之后、被动副作用（如 useEffect）之前。</li>
<li>为什么重要：为需要即时获取 / 操作最新 DOM 状态的场景提供同步执行环境，同时保证相关逻辑的执行时序与 DOM 状态一致性。</li>
</ol>
<h4 data-id="heading-19">3.4.2 核心实现逻辑</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">commitLayoutEffects</span>(<span class="hljs-params">
  finishedWork: Fiber,
  root: FiberRoot,
  committedLanes: Lanes
</span>): <span class="hljs-keyword">void</span> {
  nProgressLanes = committedLanes; <span class="hljs-comment">// 记录当前处理的优先级车道</span>
  inProgressRoot = root; <span class="hljs-comment">// 记录当前根节点</span>

  <span class="hljs-title function_">resetComponentEffectTimers</span>(); <span class="hljs-comment">// 重置组件副作用计时器</span>

  <span class="hljs-keyword">const</span> current = finishedWork.<span class="hljs-property">alternate</span>; <span class="hljs-comment">// 获取旧 Fiber 节点（current 树）</span>
  <span class="hljs-comment">// 处理当前 Fiber 节点的布局副作用</span>
  <span class="hljs-title function_">commitLayoutEffectOnFiber</span>(root, current, finishedWork, committedLanes);

  inProgressLanes = <span class="hljs-literal">null</span>;
  inProgressRoot = <span class="hljs-literal">null</span>;
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">recursivelyTraverseLayoutEffects</span>(<span class="hljs-params">
  root: FiberRoot,
  parentFiber: Fiber,
  lanes: Lanes
</span>) {
  <span class="hljs-comment">// 若子树存在布局副作用标记，才遍历子节点</span>
  <span class="hljs-keyword">if</span> (parentFiber.<span class="hljs-property">subtreeFlags</span> &amp; <span class="hljs-title class_">LayoutMask</span>) {
    <span class="hljs-keyword">let</span> child = parentFiber.<span class="hljs-property">child</span>;
    <span class="hljs-keyword">while</span> (child !== <span class="hljs-literal">null</span>) {
      <span class="hljs-keyword">const</span> current = child.<span class="hljs-property">alternate</span>;
      <span class="hljs-comment">// 处理子节点的布局副作用</span>
      <span class="hljs-title function_">commitLayoutEffectOnFiber</span>(root, current, child, lanes);
      child = child.<span class="hljs-property">sibling</span>; <span class="hljs-comment">// 遍历兄弟节点</span>
    }
  }
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">commitLayoutEffectOnFiber</span>(<span class="hljs-params">
  finishedRoot: FiberRoot,
  current: Fiber | <span class="hljs-literal">null</span>,
  finishedWork: Fiber,
  committedLanes: Lanes
</span>): <span class="hljs-keyword">void</span> {
  <span class="hljs-keyword">const</span> flags = finishedWork.<span class="hljs-property">flags</span>;
  <span class="hljs-keyword">switch</span> (finishedWork.<span class="hljs-property">tag</span>) {
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">FunctionComponent</span>:
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">ForwardRef</span>:
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">SimpleMemoComponent</span>: {
      <span class="hljs-comment">// 先递归处理子树布局副作用</span>
      <span class="hljs-title function_">recursivelyTraverseLayoutEffects</span>(
        finishedRoot,
        finishedWork,
        committedLanes
      );
      <span class="hljs-comment">// 若节点有更新标记，执行 useLayoutEffect 回调</span>
      <span class="hljs-keyword">if</span> (flags &amp; <span class="hljs-title class_">Update</span>) {
        <span class="hljs-title function_">commitHookLayoutEffects</span>(finishedWork, <span class="hljs-title class_">HookLayout</span> | <span class="hljs-title class_">HookHasEffect</span>);
      }
      <span class="hljs-keyword">break</span>;
    }
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">ClassComponent</span>: {
      <span class="hljs-comment">// 先递归处理子树</span>
      <span class="hljs-title function_">recursivelyTraverseLayoutEffects</span>(
        finishedRoot,
        finishedWork,
        committedLanes
      );
      <span class="hljs-keyword">if</span> (flags &amp; <span class="hljs-title class_">Update</span>) {
        <span class="hljs-comment">// 若有更新，调用类组件生命周期（componentDidMount/Update）</span>
        <span class="hljs-title function_">commitClassLayoutLifecycles</span>(finishedWork, current);
      }
      <span class="hljs-keyword">if</span> (flags &amp; <span class="hljs-title class_">Callback</span>) {
        <span class="hljs-comment">// 处理回调（如 setState 的第二个参数）</span>
        <span class="hljs-title function_">commitClassCallbacks</span>(finishedWork);
      }
      <span class="hljs-keyword">if</span> (flags &amp; <span class="hljs-title class_">Ref</span>) {
        <span class="hljs-comment">// 绑定 ref</span>
        <span class="hljs-title function_">safelyAttachRef</span>(finishedWork, finishedWork.<span class="hljs-property">return</span>);
      }
      <span class="hljs-keyword">break</span>;
    }
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">HostComponent</span>: {
      <span class="hljs-title function_">recursivelyTraverseLayoutEffects</span>(
        finishedRoot,
        finishedWork,
        committedLanes
      );
      <span class="hljs-keyword">if</span> (current === <span class="hljs-literal">null</span> &amp;&amp; flags &amp; <span class="hljs-title class_">Update</span>) {
        <span class="hljs-comment">// 初次挂载时执行额外逻辑（如输入框聚焦）</span>
        <span class="hljs-title function_">commitHostMount</span>(finishedWork);
      }
      <span class="hljs-keyword">if</span> (flags &amp; <span class="hljs-title class_">Ref</span>) {
        <span class="hljs-title function_">safelyAttachRef</span>(finishedWork, finishedWork.<span class="hljs-property">return</span>);
      }
      <span class="hljs-keyword">break</span>;
    }
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">HostRoot</span>: {
      <span class="hljs-title function_">recursivelyTraverseLayoutEffects</span>(
        finishedRoot,
        finishedWork,
        committedLanes
      );
      <span class="hljs-keyword">if</span> (flags &amp; <span class="hljs-title class_">Callback</span>) {
        <span class="hljs-comment">// 处理根节点回调（如 ReactDOM.render 的回调）</span>
        <span class="hljs-title function_">commitRootCallbacks</span>(finishedWork);
      }
      <span class="hljs-keyword">break</span>;
    }
    <span class="hljs-comment">// 性能分析节点</span>
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">Profiler</span>: {
      <span class="hljs-keyword">if</span> (flags &amp; <span class="hljs-title class_">Update</span>) {
        <span class="hljs-title function_">recursivelyTraverseLayoutEffects</span>(
          finishedRoot,
          finishedWork,
          committedLanes
        );
        <span class="hljs-title function_">commitProfilerUpdate</span>(
          finishedWork,
          current,
          commitStartTime,
          finishedWork.<span class="hljs-property">stateNode</span>.<span class="hljs-property">effectDuration</span>
        );
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-title function_">recursivelyTraverseLayoutEffects</span>(
          finishedRoot,
          finishedWork,
          committedLanes
        );
      }
      <span class="hljs-keyword">break</span>;
    }
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">SuspenseComponent</span>: {
      <span class="hljs-title function_">recursivelyTraverseLayoutEffects</span>(
        finishedRoot,
        finishedWork,
        committedLanes
      );
      <span class="hljs-keyword">if</span> (flags &amp; <span class="hljs-title class_">Update</span>) {
        <span class="hljs-title function_">commitSuspenseHydrationCallbacks</span>(finishedRoot, finishedWork);
      }
      <span class="hljs-comment">// Callback 注册逻辑略</span>
      <span class="hljs-keyword">break</span>;
    }
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">OffscreenComponent</span>: {
      <span class="hljs-comment">// 隐藏时跳过；重新显现时使用 reappear 递归；否则正常递归</span>
      <span class="hljs-comment">// 细节见源码的可见性与上下文切换逻辑</span>
      <span class="hljs-keyword">break</span>;
    }
    <span class="hljs-attr">default</span>: {
      <span class="hljs-comment">// 其他类型节点默认递归处理子树</span>
      <span class="hljs-title function_">recursivelyTraverseLayoutEffects</span>(
        finishedRoot,
        finishedWork,
        committedLanes
      );
      <span class="hljs-keyword">break</span>;
    }
  }
}
</code></pre>
<h3 data-id="heading-20">3.5 被动阶段（Passive Effects）</h3>
<p>被动阶段是 Commit 阶段的最后一个子阶段，核心负责执行 useEffect 相关逻辑（清理 + 回调）。其设计核心是不阻塞 DOM 渲染与用户交互，将非紧急副作用延迟到浏览器绘制后异步执行，平衡性能与开发体验。</p>
<h4 data-id="heading-21">3.5.1 核心目标与执行时机</h4>
<ol>
<li>核心目标：在不阻塞 DOM 渲染与用户交互的前提下，安全执行非紧急异步副作用。</li>
<li>关键时机：本次提交的 Fiber 树或其子树包含 Passive 副作用标记（flags/subtreeFlags &amp; PassiveMask）时，useEffect 会在布局完成且浏览器完成绘制后通过后续的非阻塞调度执行。</li>
</ol>
<h4 data-id="heading-22">3.5.2 核心实现逻辑</h4>
<p>先通过 flushPassiveEffects 校验阶段状态、取出提交数据，将渲染车道映射为不高于 Default 的更新优先级并保护原始上下文，再调用 flushPassiveEffectsImpl 做重入保护并进入提交上下文，随后按 “先卸载后挂载” 顺序，通过 commitPassiveUnmountEffects 递归遍历 Fiber 树执行 useEffect 清理函数（含被删除子树的副作用清理、离线组件的断开逻辑），再通过 commitPassiveMountEffects 递归遍历执行 useEffect 回调函数（含视图过渡场景适配、离线 / 根节点等特殊类型 Fiber 的差异化处理），全程同步串行且不阻塞 DOM 渲染与用户交互，执行完毕后恢复原始上下文并释放资源。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">flushPassiveEffects</span>(<span class="hljs-params">wasDelayedCommit?: boolean</span>): boolean {
  <span class="hljs-keyword">if</span> (pendingEffectsStatus !== <span class="hljs-variable constant_">PENDING_PASSIVE_PHASE</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }
  <span class="hljs-keyword">const</span> root = pendingEffectsRoot;
  <span class="hljs-keyword">const</span> remainingLanes = pendingEffectsRemainingLanes;
  pendingEffectsRemainingLanes = <span class="hljs-title class_">NoLanes</span>;

  <span class="hljs-comment">// 计算被动阶段的更新优先级：不高于Default，避免抢占高优任务</span>
  <span class="hljs-keyword">const</span> renderPriority = <span class="hljs-title function_">lanesToEventPriority</span>(pendingEffectsLanes); <span class="hljs-comment">// 渲染车道转事件优先级</span>
  <span class="hljs-keyword">const</span> priority = <span class="hljs-title function_">lowerEventPriority</span>(<span class="hljs-title class_">DefaultEventPriority</span>, renderPriority); <span class="hljs-comment">// 取较低优先级</span>

  <span class="hljs-keyword">const</span> prevTransition = <span class="hljs-title class_">ReactSharedInternals</span>.<span class="hljs-property">T</span>;
  <span class="hljs-keyword">const</span> previousPriority = <span class="hljs-title function_">getCurrentUpdatePriority</span>();

  <span class="hljs-keyword">try</span> {
    <span class="hljs-title function_">setCurrentUpdatePriority</span>(priority);
    <span class="hljs-title class_">ReactSharedInternals</span>.<span class="hljs-property">T</span> = <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">flushPassiveEffectsImpl</span>(wasDelayedCommit); <span class="hljs-comment">// 执行副作用核心逻辑</span>
  } <span class="hljs-keyword">finally</span> {
    <span class="hljs-title function_">setCurrentUpdatePriority</span>(previousPriority);
    <span class="hljs-title class_">ReactSharedInternals</span>.<span class="hljs-property">T</span> = prevTransition;
    <span class="hljs-title function_">releaseRootPooledCache</span>(root, remainingLanes);
  }
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">flushPassiveEffectsImpl</span>(<span class="hljs-params">wasDelayedCommit: <span class="hljs-keyword">void</span> | boolean</span>) {
  <span class="hljs-keyword">const</span> transitions = pendingPassiveTransitions;
  pendingPassiveTransitions = <span class="hljs-literal">null</span>;

  <span class="hljs-keyword">const</span> root = pendingEffectsRoot;
  <span class="hljs-keyword">const</span> lanes = pendingEffectsLanes;
  pendingEffectsStatus = <span class="hljs-variable constant_">NO_PENDING_EFFECTS</span>;
  pendingEffectsRoot = (<span class="hljs-attr">null</span>: any);
  pendingFinishedWork = (<span class="hljs-attr">null</span>: any);
  pendingEffectsLanes = <span class="hljs-title class_">NoLanes</span>;

  <span class="hljs-keyword">if</span> ((executionContext &amp; (<span class="hljs-title class_">RenderContext</span> | <span class="hljs-title class_">CommitContext</span>)) !== <span class="hljs-title class_">NoContext</span>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"Cannot flush passive effects while already rendering."</span>);
  }

  <span class="hljs-keyword">const</span> prevExecutionContext = executionContext;
  executionContext |= <span class="hljs-title class_">CommitContext</span>;

  <span class="hljs-comment">// 严格执行顺序：先卸载（清理旧副作用），后挂载（执行新回调）</span>
  <span class="hljs-title function_">commitPassiveUnmountEffects</span>(root.<span class="hljs-property">current</span>); <span class="hljs-comment">// 执行useEffect清理函数</span>
  <span class="hljs-comment">// 执行useEffect回调函数</span>
  <span class="hljs-title function_">commitPassiveMountEffects</span>(
    root,
    root.<span class="hljs-property">current</span>,
    lanes,
    transitions,
    pendingEffectsRenderEndTime
  );

  executionContext = prevExecutionContext;
}

<span class="hljs-comment">// ReactFiberCommitWork.js — 卸载入口与遍历</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">commitPassiveUnmountEffects</span>(<span class="hljs-params">finishedWork: Fiber</span>): <span class="hljs-keyword">void</span> {
  <span class="hljs-title function_">resetComponentEffectTimers</span>();
  <span class="hljs-title function_">commitPassiveUnmountOnFiber</span>(finishedWork); <span class="hljs-comment">// 开始处理单个Fiber节点的卸载逻辑</span>
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">recursivelyTraversePassiveUnmountEffects</span>(<span class="hljs-params">parentFiber: Fiber</span>): <span class="hljs-keyword">void</span> {
  <span class="hljs-keyword">const</span> deletions = parentFiber.<span class="hljs-property">deletions</span>; <span class="hljs-comment">// 待删除的子节点列表</span>
  <span class="hljs-comment">// 若父节点有子删除标记且存在待删除节点，处理被删除子树的卸载</span>
  <span class="hljs-keyword">if</span> ((parentFiber.<span class="hljs-property">flags</span> &amp; <span class="hljs-title class_">ChildDeletion</span>) !== <span class="hljs-title class_">NoFlags</span> &amp;&amp; deletions !== <span class="hljs-literal">null</span>) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; deletions.<span class="hljs-property">length</span>; i++) {
      <span class="hljs-keyword">const</span> childToDelete = deletions[i]; <span class="hljs-comment">// 待删除的子节点</span>
      nextEffect = childToDelete; <span class="hljs-comment">// 标记当前处理的副作用节点</span>
      <span class="hljs-comment">// 处理被删除子树的被动卸载（深度优先遍历）</span>
      <span class="hljs-title function_">commitPassiveUnmountEffectsInsideOfDeletedTree_begin</span>(
        childToDelete,
        parentFiber
      );
    }
    <span class="hljs-title function_">detachAlternateSiblings</span>(parentFiber); <span class="hljs-comment">// 分离旧Fiber树的兄弟节点引用，避免内存泄漏</span>
  }
  <span class="hljs-comment">// 若子树存在被动副作用标记，递归处理所有子节点</span>
  <span class="hljs-keyword">if</span> (parentFiber.<span class="hljs-property">subtreeFlags</span> &amp; <span class="hljs-title class_">PassiveMask</span>) {
    <span class="hljs-keyword">let</span> child = parentFiber.<span class="hljs-property">child</span>;
    <span class="hljs-keyword">while</span> (child !== <span class="hljs-literal">null</span>) {
      <span class="hljs-title function_">commitPassiveUnmountOnFiber</span>(child);
      child = child.<span class="hljs-property">sibling</span>;
    }
  }
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">commitPassiveUnmountOnFiber</span>(<span class="hljs-params">finishedWork: Fiber</span>): <span class="hljs-keyword">void</span> {
  <span class="hljs-keyword">switch</span> (finishedWork.<span class="hljs-property">tag</span>) {
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">FunctionComponent</span>:
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">ForwardRef</span>:
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">SimpleMemoComponent</span>: {
      <span class="hljs-comment">// 先递归处理子树的卸载副作用</span>
      <span class="hljs-title function_">recursivelyTraversePassiveUnmountEffects</span>(finishedWork);
      <span class="hljs-keyword">if</span> (finishedWork.<span class="hljs-property">flags</span> &amp; <span class="hljs-title class_">Passive</span>) {
        <span class="hljs-comment">// 若节点有被动副作用标记，执行useEffect清理函数</span>
        <span class="hljs-title function_">commitHookPassiveUnmountEffects</span>(
          finishedWork,
          finishedWork.<span class="hljs-property">return</span>,
          <span class="hljs-title class_">HookPassive</span> | <span class="hljs-title class_">HookHasEffect</span>
        );
      }
      <span class="hljs-keyword">break</span>;
    }
    <span class="hljs-comment">// 离线/隐藏组件</span>
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">OffscreenComponent</span>: {
      <span class="hljs-keyword">const</span> <span class="hljs-attr">instance</span>: <span class="hljs-title class_">OffscreenInstance</span> = finishedWork.<span class="hljs-property">stateNode</span>;
      <span class="hljs-keyword">const</span> isHidden = finishedWork.<span class="hljs-property">memoizedState</span> !== <span class="hljs-literal">null</span>;
      <span class="hljs-keyword">if</span> (
        isHidden &amp;&amp;
        instance.<span class="hljs-property">_visibility</span> &amp; <span class="hljs-title class_">OffscreenPassiveEffectsConnected</span> &amp;&amp;
        (finishedWork.<span class="hljs-property">return</span> === <span class="hljs-literal">null</span> ||
          finishedWork.<span class="hljs-property">return</span>.<span class="hljs-property">tag</span> !== <span class="hljs-title class_">SuspenseComponent</span>)
      ) {
        <span class="hljs-comment">// 隐藏子树：断开被动副作用连接</span>
        instance.<span class="hljs-property">_visibility</span> &amp;= ~<span class="hljs-title class_">OffscreenPassiveEffectsConnected</span>;
        <span class="hljs-title function_">recursivelyTraverseDisconnectPassiveEffects</span>(finishedWork);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-title function_">recursivelyTraversePassiveUnmountEffects</span>(finishedWork);
      }
      <span class="hljs-keyword">break</span>;
    }
    <span class="hljs-attr">default</span>: {
      <span class="hljs-title function_">recursivelyTraversePassiveUnmountEffects</span>(finishedWork);
      <span class="hljs-keyword">break</span>;
    }
  }
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">commitPassiveMountEffects</span>(<span class="hljs-params">
  root: FiberRoot,
  finishedWork: Fiber,
  committedLanes: Lanes,
  committedTransitions: <span class="hljs-built_in">Array</span>&lt;Transition&gt; | <span class="hljs-literal">null</span>,
  renderEndTime: number
</span>): <span class="hljs-keyword">void</span> {
  <span class="hljs-title function_">resetComponentEffectTimers</span>();
  <span class="hljs-comment">// 开始处理单个Fiber节点的挂载逻辑</span>
  <span class="hljs-title function_">commitPassiveMountOnFiber</span>(
    root,
    finishedWork,
    committedLanes,
    committedTransitions,
    renderEndTime
  );
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">recursivelyTraversePassiveMountEffects</span>(<span class="hljs-params">
  root: FiberRoot,
  parentFiber: Fiber,
  committedLanes: Lanes,
  committedTransitions: <span class="hljs-built_in">Array</span>&lt;Transition&gt; | <span class="hljs-literal">null</span>,
  endTime: number
</span>) {
  <span class="hljs-comment">// 判断是否为视图过渡 eligible 场景（仅包含视图过渡相关车道）</span>
  <span class="hljs-keyword">const</span> isViewTransitionEligible =
    enableViewTransition &amp;&amp;
    <span class="hljs-title function_">includesOnlyViewTransitionEligibleLanes</span>(committedLanes);
  <span class="hljs-comment">// 确定被动副作用掩码：视图过渡场景用专用掩码，否则用默认被动掩码</span>
  <span class="hljs-keyword">const</span> subtreeMask = isViewTransitionEligible
    ? <span class="hljs-title class_">PassiveTransitionMask</span>
    : <span class="hljs-title class_">PassiveMask</span>;

  <span class="hljs-comment">// 满足以下条件则遍历子节点：</span>
  <span class="hljs-comment">// 1. 子树存在对应被动副作用标记；</span>
  <span class="hljs-comment">// 2. 开启性能追踪且组件有渲染耗时，且子树结构变更（需重新执行副作用）</span>
  <span class="hljs-keyword">if</span> (
    parentFiber.<span class="hljs-property">subtreeFlags</span> &amp; subtreeMask ||
    (enableProfilerTimer &amp;&amp;
      enableComponentPerformanceTrack &amp;&amp;
      parentFiber.<span class="hljs-property">actualDuration</span> !== <span class="hljs-number">0</span> &amp;&amp;
      (parentFiber.<span class="hljs-property">alternate</span> === <span class="hljs-literal">null</span> ||
        parentFiber.<span class="hljs-property">alternate</span>.<span class="hljs-property">child</span> !== parentFiber.<span class="hljs-property">child</span>))
  ) {
    <span class="hljs-keyword">let</span> child = parentFiber.<span class="hljs-property">child</span>;
    <span class="hljs-keyword">while</span> (child !== <span class="hljs-literal">null</span>) {
      <span class="hljs-comment">// 处理单个子节点的被动挂载副作用</span>
      <span class="hljs-title function_">commitPassiveMountOnFiber</span>(
        root,
        child,
        committedLanes,
        committedTransitions,
        enableProfilerTimer &amp;&amp; enableComponentPerformanceTrack
          ? child.<span class="hljs-property">sibling</span> !== <span class="hljs-literal">null</span>
            ? ((child.<span class="hljs-property">sibling</span>.<span class="hljs-property">actualStartTime</span>: any): number)
            : endTime
          : <span class="hljs-number">0</span>
      );
      child = child.<span class="hljs-property">sibling</span>;
    }
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (isViewTransitionEligible) {
    <span class="hljs-title function_">restoreNestedViewTransitions</span>(parentFiber);
  }
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">commitPassiveMountOnFiber</span>(<span class="hljs-params">
  finishedRoot: FiberRoot,
  finishedWork: Fiber,
  committedLanes: Lanes,
  committedTransitions: <span class="hljs-built_in">Array</span>&lt;Transition&gt; | <span class="hljs-literal">null</span>,
  endTime: number
</span>): <span class="hljs-keyword">void</span> {
  <span class="hljs-keyword">const</span> flags = finishedWork.<span class="hljs-property">flags</span>;
  <span class="hljs-keyword">switch</span> (finishedWork.<span class="hljs-property">tag</span>) {
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">FunctionComponent</span>:
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">ForwardRef</span>:
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">SimpleMemoComponent</span>: {
      <span class="hljs-comment">// 先递归处理子树的被动挂载副作用</span>
      <span class="hljs-title function_">recursivelyTraversePassiveMountEffects</span>(
        finishedRoot,
        finishedWork,
        committedLanes,
        committedTransitions,
        endTime
      );
      <span class="hljs-keyword">if</span> (flags &amp; <span class="hljs-title class_">Passive</span>) {
        <span class="hljs-comment">// 安装 useEffect</span>
        <span class="hljs-title function_">commitHookPassiveMountEffects</span>(
          finishedWork,
          <span class="hljs-title class_">HookPassive</span> | <span class="hljs-title class_">HookHasEffect</span>
        );
      }
      <span class="hljs-keyword">break</span>;
    }
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">HostRoot</span>: {
      <span class="hljs-keyword">const</span> prevEffectDuration = <span class="hljs-title function_">pushNestedEffectDurations</span>();
      <span class="hljs-comment">// 递归处理子树的被动挂载副作用</span>
      <span class="hljs-title function_">recursivelyTraversePassiveMountEffects</span>(
        finishedRoot,
        finishedWork,
        committedLanes,
        committedTransitions,
        endTime
      );
      <span class="hljs-keyword">if</span> (enableProfilerTimer &amp;&amp; enableProfilerCommitHooks) {
        finishedRoot.<span class="hljs-property">passiveEffectDuration</span> +=
          <span class="hljs-title function_">popNestedEffectDurations</span>(prevEffectDuration);
      }
      <span class="hljs-keyword">break</span>;
    }
    <span class="hljs-comment">// ... existing code ...</span>
    <span class="hljs-attr">default</span>: {
      <span class="hljs-title function_">recursivelyTraversePassiveMountEffects</span>(
        finishedRoot,
        finishedWork,
        committedLanes,
        committedTransitions,
        endTime
      );
      <span class="hljs-keyword">break</span>;
    }
  }
}
</code></pre>
<h2 data-id="heading-23">四、实践启示</h2>
<h3 data-id="heading-24">4.1 Hook 与生命周期的正确选择</h3>
<p>理解各阶段时序后，能更精准地选择合适的 API，避免常见坑：
需在 DOM 变更前插入样式（CSS-in-JS 动态样式）→ 用 useInsertionEffect（Before Mutation 阶段执行，无 DOM 读取能力）；
需同步获取 DOM 尺寸、位置（如弹层定位）→ 用 useLayoutEffect（Layout 阶段执行，DOM 已稳定，支持同步读写）；
需绑定事件监听、发起异步请求（如数据拉取、滚动监听）→ 用 useEffect（Passive 阶段执行，不阻塞渲染与交互）；
类组件场景：getSnapshotBeforeUpdate 对应 Before Mutation 阶段（读快照），componentDidMount/componentDidUpdate 对应 Layout 阶段（操作 DOM）。</p>
<h3 data-id="heading-25">4.2 常见问题与解决方案</h3>
<p>坑 1：在 useEffect 中同步操作 DOM 后立即测量 → 可能触发强制重排。
解决：需同步测量用 useLayoutEffect，异步操作用 useEffect。
坑 2：Ref 引用在组件挂载后立即访问为 null → 误解 Ref 绑定时机。
解决：Ref 绑定在 Layout 阶段，可在 useLayoutEffect 或 useEffect 中访问（前者同步，后者异步）。</p>
<h3 data-id="heading-26">4.3 借力 Commit 阶段的设计理念</h3>
<p>优先使用 useEffect 而非同步副作用：将非紧急操作推迟到绘制后，减少对主线程的阻塞；
避免在 Layout 阶段执行 heavy 计算：该阶段同步执行，耗时操作会直接影响界面响应速度；
合理使用 startTransition：将低优先级更新标记为过渡任务，React 会在调度时避开高优先级交互（如输入、点击），避免阻塞 Commit 阶段。</p>
<h2 data-id="heading-27">五、最后</h2>
<p>深入理解 Commit 阶段的三子阶段（Before Mutation → Mutation → Layout）及被动阶段（Passive Effects），不仅能帮我们看透 React 渲染的底层逻辑，更能指导开发中写出更高效、无隐患的代码 —— 毕竟很多性能问题、时序 Bug 都源于对副作用执行时机的误解。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vant4图片懒加载源码解析(一)]]></title>    <link>https://juejin.cn/post/7588425700001677347</link>    <guid>https://juejin.cn/post/7588425700001677347</guid>    <pubDate>2025-12-28T14:22:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588425700001677347" data-draft-id="7588098335790940160" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vant4图片懒加载源码解析(一)"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-28T14:22:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="岭子笑笑"/> <meta itemprop="url" content="https://juejin.cn/user/958429870162269"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vant4图片懒加载源码解析(一)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/958429870162269/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    岭子笑笑
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-28T14:22:31.000Z" title="Sun Dec 28 2025 14:22:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#444;background-image:linear-gradient(90deg,rgba(59,59,59,.1) 3%,transparent 0),linear-gradient(1turn,rgba(122,120,121,.1) 3%,transparent 0);background-size:30px 30px;background-position:50%;letter-spacing:1px;word-spacing:1px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{position:relative;margin-top:34px;margin-bottom:16px;font-weight:700;line-height:1.3;cursor:text;color:#444;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body h1{font-size:41px;margin-bottom:34px;line-height:1.5}.markdown-body h1:before{content:""}.markdown-body h2{font-size:30px;padding-left:.4em;border-left:.4em solid #5e5e5e;border-bottom:1px solid #444}.markdown-body h2:after{content:"🕛";position:absolute;top:0;right:0;transition:all;animation:rotate 10s linear infinite}@keyframes rotate{0%{transform:rotate(0deg)}to{transform:rotate(1turn)}}.markdown-body h3{border-left:.4em solid #8d8d8d;font-size:24px;padding-left:.4em}.markdown-body h4{font-size:20px}.markdown-body h5{font-size:16px}.markdown-body h6{font-size:14px}.markdown-body blockquote,.markdown-body dl,.markdown-body ol,.markdown-body p,.markdown-body table,.markdown-body ul{margin:.8em 0}.markdown-body strong{font-weight:1000;position:relative;color:#444;padding:0 3px}.markdown-body em{font-weight:inherit}.markdown-body a{box-sizing:border-box;color:grey;position:relative}.markdown-body a:before{position:absolute;box-sizing:border-box;content:"Go -&gt;";left:0;width:100%;max-width:0;color:#fff;background-color:hsla(0,0%,50.2%,.8);white-space:nowrap;transition:.2s ease;pointer-events:none;overflow:hidden}.markdown-body a:after{content:"";position:absolute;bottom:0;left:0;width:100%;height:1px;background-color:grey}.markdown-body a:active:before,.markdown-body a:hover:before{max-width:100%;padding-left:8px;border-radius:5px}.markdown-body hr{position:relative;width:100%;height:1px;border:none;margin-top:36px;margin-bottom:36px;background:linear-gradient(90deg,grey,#f1f1f1,#444,#444,#f1f1f1,grey);overflow:visible}.markdown-body ol,.markdown-body ul{padding-left:32px}.markdown-body ol li,.markdown-body ul li{margin-bottom:6px;list-style:inherit}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol{counter-reset:my-counter}.markdown-body ol&gt;li{padding-left:6px;list-style:none;counter-increment:my-counter;position:relative}.markdown-body ol&gt;li:before{position:absolute;left:-1.5em;content:counter(my-counter);font-weight:700}.markdown-body ol&gt;li:first-child:before{content:"1️⃣"}.markdown-body ol&gt;li:nth-child(2):before{content:"2️⃣"}.markdown-body ol&gt;li:nth-child(3):before{content:"3️⃣"}.markdown-body ol&gt;li:nth-child(4):before{content:"4️⃣"}.markdown-body ol&gt;li:nth-child(5):before{content:"5️⃣"}.markdown-body ol&gt;li:nth-child(6):before{content:"6️⃣"}.markdown-body ol&gt;li:nth-child(7):before{content:"7️⃣"}.markdown-body ol&gt;li:nth-child(8):before{content:"8️⃣"}.markdown-body ol&gt;li:nth-child(9):before{content:"9️⃣"}.markdown-body ol&gt;li:nth-child(10):before{content:"🔟"}.markdown-body ul&gt;li{list-style:none;position:relative}.markdown-body ul&gt;li:before{z-index:10;position:absolute;left:-1.57em;content:"🔹";margin-right:12px}.markdown-body ul&gt;li input{margin-left:8px!important}.markdown-body blockquote{position:relative;background-color:#d3d3d3;padding:5px 10px;border-left:.2em solid #000;border-radius:3px;transition:all .8s ease}.markdown-body blockquote:hover{opacity:.7}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(69,69,77,.8);color:#fff;font-size:.87em;padding:.07em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border-radius:7px;overflow:hidden}.markdown-body pre:before{z-index:10;position:absolute;top:14px;left:14px;width:12px;height:12px;border-radius:50%;background:#fc625d;-webkit-box-shadow:20px 0 #fdbc40,40px 0 #35cd4b;box-shadow:20px 0 #fdbc40,40px 0 #35cd4b;content:" "}.markdown-body pre:after{z-index:9;content:"";position:absolute;width:100%;height:40px;top:0;background-color:#1a1a1a}.markdown-body pre&gt;code{display:block;font-family:Menlo,Monaco,Consolas,Courier New,monospace;word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#171717;color:#bababa;font-size:14px;padding:40px 20px 20px}.markdown-body del{color:grey}.markdown-body table{margin-bottom:1.25rem;border-collapse:collapse}.markdown-body table td,.markdown-body table th{margin:0;padding:8px;line-height:20px;vertical-align:middle;border:1px solid #ddd}.markdown-body table thead,.markdown-body table tr:nth-child(2n){background-color:#fcfcfc}.markdown-body table thead th,.markdown-body table tr:nth-child(2n) th{font-weight:700;vertical-align:middle;color:#444}.markdown-body table tbody tr td{font-weight:400;color:#444}.markdown-body table tbody tr:hover{background-color:#d3d3d3}.markdown-body table tbody tr:hover td{color:#fff}.markdown-body img{max-width:100%;margin:0 12px}@media (max-width:720px){.markdown-body h1{font-size:32.8px}.markdown-body h2{font-size:24px}.markdown-body h3{font-size:19.2px}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:12.8px}}</style><style data-highlight="" data-highlight-key="hybrid">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#1d1f21}.hljs::selection,.hljs span::selection{background:#373b41}.hljs::-moz-selection,.hljs span::-moz-selection{background:#373b41}.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#c5c8c6}.hljs-name,.hljs-title{color:#f0c674}.hljs-comment,.hljs-meta,.hljs-meta .hljs-keyword{color:#707880}.hljs-deletion,.hljs-link,.hljs-literal,.hljs-number,.hljs-symbol{color:#c66}.hljs-addition,.hljs-doctag,.hljs-regexp,.hljs-selector-attr,.hljs-selector-pseudo,.hljs-string{color:#b5bd68}.hljs-attribute,.hljs-code,.hljs-selector-id{color:#b294bb}.hljs-bullet,.hljs-keyword,.hljs-selector-tag,.hljs-tag{color:#81a2be}.hljs-subst,.hljs-template-tag,.hljs-template-variable,.hljs-variable{color:#8abeb7}.hljs-built_in,.hljs-builtin-name,.hljs-quote,.hljs-section,.hljs-selector-class,.hljs-type{color:#de935f}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">组件简介</h2>
<p>Lazyload懒加载，当页面需要加载大量内容时，使用懒加载可以实现延迟加载页面可视区域外的内容，从而使页面加载更流程。</p>
<h2 data-id="heading-1">如何使用</h2>
<p>Lazyload是Vue指令，使用前需要对指令进行注册</p>
<h4 data-id="heading-2">1. 注册指令</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { createApp } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>; 
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Lazyload</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'vant'</span>; 
<span class="hljs-keyword">const</span> app = <span class="hljs-title function_">createApp</span>(); 
app.<span class="hljs-title function_">use</span>(<span class="hljs-title class_">Lazyload</span>); <span class="hljs-comment">// 注册时可以配置额外的选项 app.use(Lazyload, { lazyComponent: true, });</span>
</code></pre>
<h4 data-id="heading-3">2. 将v-lazy指令的值设置为需要懒加载的图片</h4>
<pre><code class="hljs language-ini" lang="ini">&lt;img <span class="hljs-attr">v-for</span>=<span class="hljs-string">"img in imageList"</span> v-lazy=<span class="hljs-string">"img"</span> /&gt;
</code></pre>
<h4 data-id="heading-4">3. 背景图片懒加载，要使用v-lazy:background-image</h4>
<pre><code class="hljs language-arduino" lang="arduino">&lt;div v-<span class="hljs-keyword">for</span>=<span class="hljs-string">"img in imageList"</span> v-lazy:background-image=<span class="hljs-string">"img"</span> /&gt;
</code></pre>
<h4 data-id="heading-5">4. 组件懒加载，将需要懒加载的组件放在lazy-component标签中</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 注意注册时设置“lazyComponent”选项</span>
app.<span class="hljs-title function_">use</span>(<span class="hljs-title class_">Lazyload</span>, { <span class="hljs-attr">lazyComponent</span>: <span class="hljs-literal">true</span>, });

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">lazy-component</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">"img in imageList"</span> <span class="hljs-attr">v-lazy</span>=<span class="hljs-string">"img"</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">lazy-component</span>&gt;</span></span>
</code></pre>
<h2 data-id="heading-6">源码解析</h2>
<h3 data-id="heading-7">1. vue-lazyload/index.js</h3>
<p>index.js是lazyload组件的入口文件，该js导出一个Lazyload对象，Lazyload对象会声明一个install方法，
install函数是组件注册的必用函数，这里不再赘述。</p>
<pre><code class="hljs language-php" lang="php">import Lazy <span class="hljs-keyword">from</span> <span class="hljs-string">'./lazy'</span>;
import LazyComponent <span class="hljs-keyword">from</span> <span class="hljs-string">'./lazy-component'</span>;
import LazyContainer <span class="hljs-keyword">from</span> <span class="hljs-string">'./lazy-container'</span>;
import LazyImage <span class="hljs-keyword">from</span> <span class="hljs-string">'./lazy-image'</span>;

export <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">Lazyload</span> = {
  <span class="hljs-comment">/*
   * install function
   * <span class="hljs-doctag">@param</span>  {App} app
   * <span class="hljs-doctag">@param</span>  {object} options lazyload options
   */</span>
  <span class="hljs-title function_ invoke__">install</span>(app, options = {}) {
    <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">LazyClass</span> = <span class="hljs-title function_ invoke__">Lazy</span>();
    <span class="hljs-comment">// 创建了一个laze实例</span>
    <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">lazy</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LazyClass</span>(options);
    <span class="hljs-comment">// 创建了一个lazeContainer实例</span>
    <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">lazyContainer</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LazyContainer</span>({ lazy });
    
    <span class="hljs-comment">// 将laze实例放到vue实例的global属性上</span>
    app.config.globalProperties.<span class="hljs-variable">$Lazyload</span> = lazy;
    
    <span class="hljs-comment">// 如果options中存在lazyComponent, 注册LazyComponent组件，这里是我们上文“如何使用第4点”强调使用组件的话需要增加传参lazyComponent: true了</span>
    <span class="hljs-keyword">if</span> (options.lazyComponent) {
      app.<span class="hljs-title function_ invoke__">component</span>(<span class="hljs-string">'LazyComponent'</span>, <span class="hljs-title function_ invoke__">LazyComponent</span>(lazy));
    }
    <span class="hljs-comment">// 根据传参lazeImage注册LazyImage组件</span>
    <span class="hljs-keyword">if</span> (options.lazyImage) {
      app.<span class="hljs-title function_ invoke__">component</span>(<span class="hljs-string">'LazyImage'</span>, <span class="hljs-title function_ invoke__">LazyImage</span>(lazy));
    }
    
    <span class="hljs-comment">// 注册指令lazy, 我们就知道为啥指令是v-lazy了啦</span>
    app.<span class="hljs-title function_ invoke__">directive</span>(<span class="hljs-string">'lazy'</span>, {
      <span class="hljs-attr">beforeMount</span>: lazy.add.<span class="hljs-title function_ invoke__">bind</span>(lazy),
      <span class="hljs-attr">updated</span>: lazy.update.<span class="hljs-title function_ invoke__">bind</span>(lazy),
      <span class="hljs-attr">unmounted</span>: lazy.remove.<span class="hljs-title function_ invoke__">bind</span>(lazy),
    });
    <span class="hljs-comment">// 注册指令lazy-container</span>
    app.<span class="hljs-title function_ invoke__">directive</span>(<span class="hljs-string">'lazy-container'</span>, {
      <span class="hljs-attr">beforeMount</span>: lazyContainer.bind.<span class="hljs-title function_ invoke__">bind</span>(lazyContainer),
      <span class="hljs-attr">updated</span>: lazyContainer.update.<span class="hljs-title function_ invoke__">bind</span>(lazyContainer),
      <span class="hljs-attr">unmounted</span>: lazyContainer.unbind.<span class="hljs-title function_ invoke__">bind</span>(lazyContainer),
    });
  },
};
</code></pre>
<h3 data-id="heading-8">2.  vue-lazyload/lazy.js</h3>
<p>lazy.js导入了很多工具函数，导出一个匿名函数，外部执行这个匿名函数，会return一个类class Lazy。<br/>
函数可以将内部逻辑和变量放到当前函数做作用域中，避免外包访问和修改。</p>
<h4 data-id="heading-9">2.1 constructor构造函数</h4>
<p>constuctor函数初始化一些配置和函数</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> { nextTick } from <span class="hljs-string">'vue'</span>;
<span class="hljs-keyword">import</span> { inBrowser, getScrollParent } from <span class="hljs-string">'@vant/use'</span>;
<span class="hljs-keyword">import</span> {
  remove,
  on,
  off,
  throttle,
  supportWebp,
  getDPR,
  getBestSelectionFromSrcset,
  hasIntersectionObserver,
  modeType,
  ImageCache,
} from <span class="hljs-string">'./util'</span>;
<span class="hljs-keyword">import</span> { isObject } from <span class="hljs-string">'../../utils'</span>;
<span class="hljs-keyword">import</span> ReactiveListener from <span class="hljs-string">'./listener'</span>;

<span class="hljs-keyword">const</span> DEFAULT_URL =
  <span class="hljs-string">'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7'</span>;
<span class="hljs-keyword">const</span> DEFAULT_EVENTS = [
  <span class="hljs-string">'scroll'</span>,
  <span class="hljs-string">'wheel'</span>,
  <span class="hljs-string">'mousewheel'</span>,
  <span class="hljs-string">'resize'</span>,
  <span class="hljs-string">'animationend'</span>,
  <span class="hljs-string">'transitionend'</span>,
  <span class="hljs-string">'touchmove'</span>,
];
<span class="hljs-keyword">const</span> DEFAULT_OBSERVER_OPTIONS = {
  rootMargin: <span class="hljs-string">'0px'</span>,
  threshold: <span class="hljs-number">0</span>,
};

export default function () {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Lazy</span> {
    <span class="hljs-keyword">constructor</span>({
      preLoad,
      error,
      throttleWait,
      preLoadTop,
      dispatchEvent,
      loading,
      attempt,
      silent = <span class="hljs-literal">true</span>,
      scale,
      listenEvents,
      filter,
      adapter,
      observer,
      observerOptions,
    }) {
      <span class="hljs-keyword">this</span>.mode = modeType.event;
      <span class="hljs-keyword">this</span>.listeners = [];
      <span class="hljs-keyword">this</span>.targetIndex = <span class="hljs-number">0</span>;
      <span class="hljs-keyword">this</span>.targets = [];
      <span class="hljs-keyword">this</span>.options = {
        silent,
        dispatchEvent: !!dispatchEvent,
        throttleWait: throttleWait || <span class="hljs-number">200</span>,
        preLoad: preLoad || <span class="hljs-number">1.3</span>,
        preLoadTop: preLoadTop || <span class="hljs-number">0</span>,
        error: error || DEFAULT_URL,
        loading: loading || DEFAULT_URL,
        attempt: attempt || <span class="hljs-number">3</span>,
        scale: scale || getDPR(scale),
        ListenEvents: listenEvents || DEFAULT_EVENTS,
        supportWebp: supportWebp(),
        filter: filter || {},
        adapter: adapter || {},
        observer: !!observer,
        observerOptions: observerOptions || DEFAULT_OBSERVER_OPTIONS,
      };
      <span class="hljs-keyword">this</span>.initEvent();
      <span class="hljs-keyword">this</span>.imageCache = new ImageCache({ max: <span class="hljs-number">200</span> });
      <span class="hljs-keyword">this</span>.lazyLoadHandler = throttle(
        <span class="hljs-keyword">this</span>.lazyLoadHandler.bind(<span class="hljs-keyword">this</span>),
        <span class="hljs-keyword">this</span>.options.throttleWait,
      );

      <span class="hljs-keyword">this</span>.setMode(<span class="hljs-keyword">this</span>.options.observer ? modeType.observer : modeType.event);
    }
    ...
    }
 }
</code></pre>
<h4 data-id="heading-10">2.2 remove &amp; on &amp; off</h4>
<ul>
<li>
<p>remove是移除数组中的元素</p>
</li>
<li>
<p>on和off是通过addEventListener绑定和解绑函数</p>
</li>
<li>
<p>为什么addEventListener要设置capture和passive呢？<br/>
<strong><code>capture: false</code></strong><br/>
表示监听器在 <strong>事件冒泡阶段</strong> 触发（这是最常用的模式）</p>
<p><strong><code>passive: true</code></strong><br/>
明确告诉浏览器：<strong>此监听器绝不会调用 <code>event.preventDefault()</code></strong> 。<br/>
浏览器因此可以<strong>立即执行默认行为</strong>（比如滚动、缩放），无需等待 JS 执行完毕，从而提升流畅度。</p>
</li>
</ul>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 移除数组中的元素</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">remove</span>(<span class="hljs-params">arr, item</span>) {
  <span class="hljs-keyword">if</span> (!arr.<span class="hljs-property">length</span>) <span class="hljs-keyword">return</span>;
  <span class="hljs-keyword">const</span> index = arr.<span class="hljs-title function_">indexOf</span>(item);
  <span class="hljs-keyword">if</span> (index &gt; -<span class="hljs-number">1</span>) <span class="hljs-keyword">return</span> arr.<span class="hljs-title function_">splice</span>(index, <span class="hljs-number">1</span>);
}
<span class="hljs-comment">// 绑定事件</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">on</span>(<span class="hljs-params">el, <span class="hljs-keyword">type</span>, func</span>) {
  el.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-keyword">type</span>, func, {
    <span class="hljs-attr">capture</span>: <span class="hljs-literal">false</span>, <span class="hljs-comment">// 默认在**冒泡阶段**触发事件</span>
    <span class="hljs-attr">passive</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 明确告诉浏览器：**此监听器绝不会调用 `event.preventDefault()`**</span>
  });
}
<span class="hljs-comment">// 解绑事件</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">off</span>(<span class="hljs-params">el, <span class="hljs-keyword">type</span>, func</span>) {
  <span class="hljs-comment">// 第三个参数是一个布尔值，指定需要移除的事件监听器是否为捕获监听器，默认false</span>
  el.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-keyword">type</span>, func, <span class="hljs-literal">false</span>);
}
</code></pre>
<h4 data-id="heading-11">2.3 throttle节流函数</h4>
<ul>
<li>第一次立即执行， lastRun = 0, Date.now() - lastRun是一个很大的数，肯定比delay大，所以第一次会立即执行</li>
<li>第二次注入一个定时器，等待delay秒后执行，此时timeout有值且是一个数字，</li>
<li>等待delay秒后执行runCallback函数，timeout被清空，lastRun被重新赋值为当前时间</li>
<li>事件在时间间隔为delay秒内触发，就会继续注入setTimeout，等待执行。。。如此一直循环</li>
<li>只要当没有setTimeout回调事件之后，最后会在elapsed &gt;= delay条件下再执行一次runCallback</li>
</ul>
<pre><code class="hljs language-ini" lang="ini">export function throttle(action, delay) {
  let <span class="hljs-attr">timeout</span> = null<span class="hljs-comment">;</span>
  let <span class="hljs-attr">lastRun</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>
  return function (...args) {
    if (timeout) {
      return<span class="hljs-comment">;</span>
    }
    const <span class="hljs-attr">elapsed</span> = Date.now() - lastRun<span class="hljs-comment">;</span>
    const <span class="hljs-attr">runCallback</span> = () =&gt; {
      <span class="hljs-attr">lastRun</span> = Date.now()<span class="hljs-comment">;</span>
      <span class="hljs-attr">timeout</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
      action.apply(this, args)<span class="hljs-comment">;</span>
    }<span class="hljs-comment">;</span>
        // 第一次立即执行
    if (elapsed &gt;= delay) {
      runCallback()<span class="hljs-comment">;</span>
    } else {
    // 第二次注入一个定时器
      <span class="hljs-attr">timeout</span> = setTimeout(runCallback, delay)<span class="hljs-comment">;</span>
    }
  }<span class="hljs-comment">;</span>
}
</code></pre>
<h4 data-id="heading-12">2.4 supportWebp &amp; getDPR</h4>




















<table><thead><tr><th>函数</th><th>作用</th><th>典型用途</th></tr></thead><tbody><tr><td><code>supportWebp()</code></td><td>检测是否支持 WebP 图片格式</td><td>优先加载 WebP，节省带宽、提升加载速度</td></tr><tr><td><code>getDPR(scale)</code></td><td>获取设备像素比（DPR） ，<strong>获取当前设备的物理像素与 CSS 像素的比率（DPR）</strong></td><td>为高清屏加载高分辨率图片，避免模糊</td></tr></tbody></table>
<ul>
<li>inBrowser是判断条件是typeof window是否存在值<br/>
const inBrowser = 'undefined' != typeof window;</li>
<li>canvas.toDataURL('image/webp')
如果浏览器支持WebP格式的图片，就会返回'data:image/webp'...图片base64格式的字符串<br/>
如果不支持，就会降级为PNG, 返回"data:image/png..."<br/>
哇哦，知识面又拓宽了~</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">supportWebp</span>(<span class="hljs-params"/>) {
<span class="hljs-comment">// 不是browser, 直接return</span>
  <span class="hljs-keyword">if</span> (!inBrowser) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;

  <span class="hljs-keyword">let</span> support = <span class="hljs-literal">true</span>;

  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> elem = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'canvas'</span>);
    <span class="hljs-comment">// 检测canvas是否可用</span>
    <span class="hljs-keyword">if</span> (elem.<span class="hljs-property">getContext</span> &amp;&amp; elem.<span class="hljs-title function_">getContext</span>(<span class="hljs-string">'2d'</span>)) {
      <span class="hljs-comment">// 尝试将canvas导出为WebP格式的数据URL</span>
      support = elem.<span class="hljs-title function_">toDataURL</span>(<span class="hljs-string">'image/webp'</span>).<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">'data:image/webp'</span>) === <span class="hljs-number">0</span>;
    }
  } <span class="hljs-keyword">catch</span> (err) {
    support = <span class="hljs-literal">false</span>;
  }

  <span class="hljs-keyword">return</span> support;
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">getDPR</span> = (<span class="hljs-params">scale = <span class="hljs-number">1</span></span>) =&gt;
  inBrowser ? <span class="hljs-variable language_">window</span>.<span class="hljs-property">devicePixelRatio</span> || scale : scale;
</code></pre>
<h4 data-id="heading-13">2.5 getBestSelectionFromSrcset</h4>
<p>这个函数 <code>getBestSelectionFromSrcset</code> 的作用是：</p>
<blockquote>
<p><strong>根据图片容器的缩放后宽度（考虑设备像素比），从 <code>&lt;img&gt;</code> 元素的 <code>data-srcset</code> 属性中智能选择最合适的一张图片源（URL）</strong> ，优先选择 WebP 格式，并适配高清屏。</p>
</blockquote>
<pre><code class="hljs language-ini" lang="ini">export function getBestSelectionFromSrcset(el, scale) {
  // 判断是img标签 且 存在data-srcset属性
  if (el.tagName !== 'IMG' || !el.getAttribute('data-srcset')) return<span class="hljs-comment">;</span>
  
  // 注意不是标准 `srcset`，是自定义属性data-srcset
  let <span class="hljs-attr">options</span> = el.getAttribute(<span class="hljs-string">'data-srcset'</span>)<span class="hljs-comment">;</span>
  const <span class="hljs-attr">container</span> = el.parentNode<span class="hljs-comment">;</span>
  // 计算父容器的宽度，考虑缩放比例
  const <span class="hljs-attr">containerWidth</span> = container.<span class="hljs-literal">off</span>setWidth * scale<span class="hljs-comment">;</span>

  let spaceIndex<span class="hljs-comment">;</span>
  let tmpSrc<span class="hljs-comment">;</span>
  let tmpWidth<span class="hljs-comment">;</span>
   
  // 标准的srcset格式image-400.jpg 400w, image-800.webp 800w, image-1200.jpg 1200w
  <span class="hljs-attr">options</span> = options.trim().split(<span class="hljs-string">','</span>)<span class="hljs-comment">;</span>

  const <span class="hljs-attr">result</span> = options.map((item) =&gt; {
    <span class="hljs-attr">item</span> = item.trim()<span class="hljs-comment">;</span>
    <span class="hljs-attr">spaceIndex</span> = item.lastIndexOf(<span class="hljs-string">' '</span>)<span class="hljs-comment">;</span>
    if (<span class="hljs-attr">spaceIndex</span> === -<span class="hljs-number">1</span>) {
      <span class="hljs-attr">tmpSrc</span> = item<span class="hljs-comment">;</span>
      <span class="hljs-attr">tmpWidth</span> = <span class="hljs-number">999998</span><span class="hljs-comment">;// 无宽度描述，视为“兜底图”</span>
    } else {
      <span class="hljs-attr">tmpSrc</span> = item.substr(<span class="hljs-number">0</span>, spaceIndex)<span class="hljs-comment">;</span>
    // 提取 "800w" → 去掉末尾 'w'（通过 -2 截断）
      <span class="hljs-attr">tmpWidth</span> = parseInt(
        item.substr(spaceIndex + 1, item.length - spaceIndex - 2),
        10,
      )<span class="hljs-comment">;</span>
    }
    return <span class="hljs-section">[tmpWidth, tmpSrc]</span><span class="hljs-comment">;</span>
  })<span class="hljs-comment">;</span>
   // 从大到小排序
  result.sort((a, b) =&gt; {
    if (a<span class="hljs-section">[0]</span> &lt; b<span class="hljs-section">[0]</span>) { // a宽度小，放后面
      return 1<span class="hljs-comment">;</span>
    }
    if (a<span class="hljs-section">[0]</span> &gt; b<span class="hljs-section">[0]</span>) { // a宽度大，放前面
      return -1<span class="hljs-comment">;</span>
    }
    if (a<span class="hljs-section">[0]</span> === b<span class="hljs-section">[0]</span>) {
   // 宽度相同：WebP 优先
      if (b<span class="hljs-section">[1]</span>.indexOf('.webp', b<span class="hljs-section">[1]</span>.length - 5) !== -1) {
        return 1<span class="hljs-comment">;</span>
      }
      if (a<span class="hljs-section">[1]</span>.indexOf('.webp', a<span class="hljs-section">[1]</span>.length - 5) !== -1) {
        return -1<span class="hljs-comment">;</span>
      }
    }
    return 0<span class="hljs-comment">;</span>
  })<span class="hljs-comment">;</span>
  let <span class="hljs-attr">bestSelectedSrc</span> = <span class="hljs-string">''</span><span class="hljs-comment">;</span>
  let tmpOption<span class="hljs-comment">;</span>
/** 排序完成后的数据大概如下，目的是找到最契合容器宽度的图片src后返回
<span class="hljs-section">[
  [1200, 'img-1200.webp']</span>,
  <span class="hljs-section">[800,  'img-800.jpg']</span>,
  <span class="hljs-section">[400,  'img-400.jpg']</span>
] **/

  for (let <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; result.length; i++) {</span>
    <span class="hljs-attr">tmpOption</span> = result[i]<span class="hljs-comment">;</span>
    <span class="hljs-attr">bestSelectedSrc</span> = tmpOption[<span class="hljs-number">1</span>]<span class="hljs-comment">;</span>
    const <span class="hljs-attr">next</span> = result[i + <span class="hljs-number">1</span>]<span class="hljs-comment">;</span>
    // 如果下一个图片的宽度小于父级容器的宽度，则获取当前值
    if (next &amp;&amp; next<span class="hljs-section">[0]</span> &lt; containerWidth) {
      <span class="hljs-attr">bestSelectedSrc</span> = tmpOption[<span class="hljs-number">1</span>]<span class="hljs-comment">;</span>
      break<span class="hljs-comment">;</span>
    } else if (!next) {
      <span class="hljs-attr">bestSelectedSrc</span> = tmpOption[<span class="hljs-number">1</span>]<span class="hljs-comment">;</span>
      break<span class="hljs-comment">;</span>
    }
  }
  // 返回最合适的图片
  return bestSelectedSrc<span class="hljs-comment">;</span>
}
</code></pre>
<h4 data-id="heading-14">2.6 hasIntersectionObserver &amp; ImageCache</h4>
<ul>
<li>
<p>hasIntersectionObserver 是判断浏览器是否支持IntersectionObserver方法<br/>
<strong><code>IntersectionObserver</code></strong> 提供了一种异步观察目标元素与其祖先元素或顶级文档[视口]交叉状态的方法。其祖先元素或视口被称为根。
通俗的讲就是某个目标元素出现在屏幕范围内，就能通过ntersectionObserver捕获到这个元素，从而对这个元素做一些操作。我们这里使用的目的是图片element元素出现在屏幕可视范围才加载图片的资源。</p>
</li>
<li>
<p>如何封装一个Cache类？<br/>
this.imageCache = new ImageCache({ max: 200 });</p>
</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript">判断浏览器是否支持<span class="hljs-title class_">IntersectionObserver</span> 方法
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> hasIntersectionObserver =
  inBrowser &amp;&amp;
  <span class="hljs-string">'IntersectionObserver'</span> <span class="hljs-keyword">in</span> <span class="hljs-variable language_">window</span> &amp;&amp;
  <span class="hljs-string">'IntersectionObserverEntry'</span> <span class="hljs-keyword">in</span> <span class="hljs-variable language_">window</span> &amp;&amp;
  <span class="hljs-string">'intersectionRatio'</span> <span class="hljs-keyword">in</span> <span class="hljs-variable language_">window</span>.<span class="hljs-property">IntersectionObserverEntry</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>;

<span class="hljs-comment">// 图片cache类</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ImageCache</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">{ max }</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span> = {
      <span class="hljs-attr">max</span>: max || <span class="hljs-number">100</span>,
    };
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">caches</span> = [];
  }

  <span class="hljs-title function_">has</span>(<span class="hljs-params">key</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">caches</span>.<span class="hljs-title function_">indexOf</span>(key) &gt; -<span class="hljs-number">1</span>;
  }

  <span class="hljs-title function_">add</span>(<span class="hljs-params">key</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">has</span>(key)) <span class="hljs-keyword">return</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">caches</span>.<span class="hljs-title function_">push</span>(key);
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">caches</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">max</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">free</span>();
    }
  }

  <span class="hljs-title function_">free</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">caches</span>.<span class="hljs-title function_">shift</span>();
  }
}
</code></pre>
<h4 data-id="heading-15">2.7 initEvent</h4>
<p>这个 <code>initEvent()</code> 函数的作用是：<strong>在当前类实例（如 <code>Lazy</code>）上初始化一个简易的自定义事件系统（发布-订阅模式）</strong> ，提供 <code>$on</code>、<code>$once</code>、<code>$off</code>、<code>$emit</code> 等方法，用于组件内部或外部监听和触发特定事件（如图片加载中、加载完成、加载失败等</p>
<pre><code class="hljs language-kotlin" lang="kotlin">    initEvent() {
      <span class="hljs-keyword">this</span>.Event = {
        listeners: {
          loading: [],
          loaded: [],
          error: [],
        },
      };
        
      <span class="hljs-comment">// 绑定事件</span>
      <span class="hljs-keyword">this</span>.$on = (event, func) =&gt; {
        <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.Event.listeners[event]) <span class="hljs-keyword">this</span>.Event.listeners[event] = [];
        <span class="hljs-keyword">this</span>.Event.listeners[event].push(func);
      };
      <span class="hljs-comment">// 绑定一次性事件</span>
      <span class="hljs-keyword">this</span>.$once = (event, func) =&gt; {
        <span class="hljs-keyword">const</span> on = (...args) =&gt; {
          <span class="hljs-comment">// 先调用$off解绑事件</span>
          <span class="hljs-keyword">this</span>.$off(event, on);
          <span class="hljs-comment">// 执行回调方法</span>
          func.apply(<span class="hljs-keyword">this</span>, args);
        };
        <span class="hljs-keyword">this</span>.$on(event, on);
      };
      <span class="hljs-comment">// 解绑事件</span>
      <span class="hljs-keyword">this</span>.$off = (event, func) =&gt; {
        <span class="hljs-comment">// 如果不存在func</span>
        <span class="hljs-keyword">if</span> (!func) {
          <span class="hljs-comment">// 如果event类名在Event没有注册过，直接return</span>
          <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.Event.listeners[event]) <span class="hljs-keyword">return</span>;
          <span class="hljs-comment">// 注册过就直接清空数组中数据</span>
          <span class="hljs-keyword">this</span>.Event.listeners[event].length = <span class="hljs-number">0</span>;
          <span class="hljs-keyword">return</span>;
        }
        <span class="hljs-comment">// 存在func回调函数则从数组中移除</span>
        remove(<span class="hljs-keyword">this</span>.Event.listeners[event], func);
      };
      <span class="hljs-comment">// 触发注册过的event事件</span>
      <span class="hljs-keyword">this</span>.$emit = (event, context, inCache) =&gt; {
        <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.Event.listeners[event]) <span class="hljs-keyword">return</span>;
        <span class="hljs-keyword">this</span>.Event.listeners[event].forEach((func) =&gt; func(context, inCache));
      };
    }
</code></pre>
<h4 data-id="heading-16">2.7 lazyLoadHandler</h4>
<p>遍历所有被监听的元素（如图片），检查它们是否进入视口（可见区域），如果是，则触发加载；同时清理已从 DOM 中移除的无效监听器，防止内存泄漏。具体的listener是数据结构是什么样的，我们下篇讲。</p>
<pre><code class="hljs language-scss" lang="scss">    <span class="hljs-built_in">lazyLoadHandler</span>() {
      const freeList = <span class="hljs-selector-attr">[]</span>;
      this<span class="hljs-selector-class">.listeners</span><span class="hljs-selector-class">.forEach</span>((listener) =&gt; {
        <span class="hljs-comment">// 没有目标元素的监听器，放入待释放数组中</span>
        if (!listener.el || !listener.el.parentNode) {
          freeList<span class="hljs-selector-class">.push</span>(listener);
        }
        <span class="hljs-comment">// 检查图片是否已经进入了视口区域，如果是，则加载图片</span>
        const catIn = listener<span class="hljs-selector-class">.checkInView</span>();
        if (!catIn) return;
        listener<span class="hljs-selector-class">.load</span>();
      });
      <span class="hljs-comment">// 释放无用的监听器，防止内存泄漏</span>
      freeList<span class="hljs-selector-class">.forEach</span>((item) =&gt; {
        <span class="hljs-built_in">remove</span>(this.listeners, item);
        item.<span class="hljs-variable">$destroy</span>();
      });
    }
</code></pre>
<h2 data-id="heading-17">总结</h2>
<ul>
<li>本文深入解析了 LazyLoad 中常用的一些工具函数，涵盖了如何基于发布-订阅模式实现一个轻量级的事件收集与触发机制，回顾了节流（throttle）、<code>addEventListener</code> 的高级参数（如 <code>passive</code> 和 <code>capture</code>）等核心概念，并探讨了 WebP 图片格式在性能优化中的重要意义。</li>
<li>我们梳理了源码中的关键知识点，下篇再见~</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[ant design vue Table根据数据合并单元格]]></title>    <link>https://juejin.cn/post/7588109656042307630</link>    <guid>https://juejin.cn/post/7588109656042307630</guid>    <pubDate>2025-12-28T14:29:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588109656042307630" data-draft-id="7588487605247852553" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="ant design vue Table根据数据合并单元格"/> <meta itemprop="keywords" content="前端,Ant Design"/> <meta itemprop="datePublished" content="2025-12-28T14:29:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="beckyyy"/> <meta itemprop="url" content="https://juejin.cn/user/659362706635991"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ant design vue Table根据数据合并单元格
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/659362706635991/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    beckyyy
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-28T14:29:14.000Z" title="Sun Dec 28 2025 14:29:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>之前在外包做项目的时候，甲方提出一个想要合并单元格的需求，表格里展示的内容是领导们的一周行程，因为不想出现重复内容的单元格，实际场景中领导可能连续几天参加某个会议或者某个其他行程，本来 系统中对会议时间冲突是做了限制，也就是不能创建时间冲突的会议，那么对重复行程的单元格直接进行合并是没有问题的；但是后来又放开了限制、又允许存在会议时间冲突的情况了，因为实际中可能存在连续几天的大会行程中，又安排了几个小会，所以在后续的沟通中确定的方案是：<strong>单独的连续行程进行合并，如果中间出现多个行程就不合并，如果单独的长行程还没结束，后面连续的排期还是合并</strong>。最终的效果参考下图中的“会议111”。</p>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8fc5607776e9461398832d2f176d44da~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYmVja3l5eQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767536954&amp;x-signature=woARm5O%2Fiv6bRLI%2FjUbsVg5Xeqo%3D" loading="lazy"/>
<p>根据表格的数据合并单元格，因为用的是ant design vue这个UI库，所以我第一时间想的就是去翻文档，查到的用法如下：</p>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8a0357ce64f14991bf2c10635f4c53a6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYmVja3l5eQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767536954&amp;x-signature=oTUZ692WoWT6OEnhFxGvP%2F9Yfr0%3D" loading="lazy"/>
<p>可是把这段代码写到项目里并没有生效，才发现最新已经是<code>"ant-design-vue": "^4.2.6"</code>，而项目里用的版本是<code>"ant-design-vue": "^1.6.3"</code>，看懵了🤧🤧🤧，查了之后才发现这个版本的使用方法是这样的：</p>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2bbfdf5fff054e2ea6e855e46ca3ef28~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYmVja3l5eQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767536954&amp;x-signature=YkSgQ6eZQwn0BeGNULpbSzMNUxs%3D" loading="lazy"/>
<p>于是我就按着这么写：</p>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4fa982d16c80455e9b45f473739a8630~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYmVja3l5eQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767536954&amp;x-signature=pdsfm4izTFCbJOmv03TrVDi%2FzRw%3D" loading="lazy"/>
<p>结果发现rowSpan的设置不管用，在网上搜索了一番，又自己试了几次，发现加上style的设置才实现了合并单元格。</p>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/72cc7e23b13747f4b69229942e39ba59~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYmVja3l5eQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767536954&amp;x-signature=1NKweTHPuWs4%2BwuS2ZfCt48giHc%3D" loading="lazy"/>
<p>很烦接手这种项目，总是用一套模板开发新项目，永远不更新三方库，大量公司的“降本增效”以后这种情况会越来越多吧，反正当下能用就行，以后维护不了了再去考虑更新三方库不知道会爆出什么问题呢😅</p>
<p>具体的单元格是否合并就是按照业务逻辑来判断了。在这个项目里，每日行程的原始数据结构类似如下，就是把每个领导本周内的行程给查询出来。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
    staff1<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-punctuation">{</span>
        event<span class="hljs-punctuation">:</span> '会议<span class="hljs-number">111</span>'<span class="hljs-punctuation">,</span>
        startTime<span class="hljs-punctuation">:</span> '<span class="hljs-number">2025</span><span class="hljs-number">-01</span><span class="hljs-number">-01</span> <span class="hljs-number">9</span><span class="hljs-punctuation">:</span><span class="hljs-number">00</span>'<span class="hljs-punctuation">,</span>
        endTime<span class="hljs-punctuation">:</span> '<span class="hljs-number">2025</span><span class="hljs-number">-01</span><span class="hljs-number">-04</span> <span class="hljs-number">18</span><span class="hljs-punctuation">:</span> <span class="hljs-number">00</span>'
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-punctuation">{</span>
        event<span class="hljs-punctuation">:</span> '这是一个测试会议<span class="hljs-number">22</span>'<span class="hljs-punctuation">,</span>
        startTime<span class="hljs-punctuation">:</span> '<span class="hljs-number">2025</span><span class="hljs-number">-01</span><span class="hljs-number">-02</span> <span class="hljs-number">13</span><span class="hljs-punctuation">:</span><span class="hljs-number">00</span>'<span class="hljs-punctuation">,</span>
        endTime<span class="hljs-punctuation">:</span> '<span class="hljs-number">2025</span><span class="hljs-number">-01</span><span class="hljs-number">-02</span> <span class="hljs-number">16</span><span class="hljs-punctuation">:</span> <span class="hljs-number">00</span>'
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-punctuation">{</span>
        event<span class="hljs-punctuation">:</span> '这是一个测试会议<span class="hljs-number">33</span>'<span class="hljs-punctuation">,</span>
        startTime<span class="hljs-punctuation">:</span> '<span class="hljs-number">2025</span><span class="hljs-number">-01</span><span class="hljs-number">-05</span> <span class="hljs-number">09</span><span class="hljs-punctuation">:</span><span class="hljs-number">00</span>'<span class="hljs-punctuation">,</span>
        endTime<span class="hljs-punctuation">:</span> '<span class="hljs-number">2025</span><span class="hljs-number">-01</span><span class="hljs-number">-05</span> <span class="hljs-number">17</span><span class="hljs-punctuation">:</span> <span class="hljs-number">00</span>'
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    staff2<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-punctuation">{</span>
        event<span class="hljs-punctuation">:</span> '会议q'<span class="hljs-punctuation">,</span>
        startTime<span class="hljs-punctuation">:</span> '<span class="hljs-number">2025</span><span class="hljs-number">-01</span><span class="hljs-number">-01</span> <span class="hljs-number">9</span><span class="hljs-punctuation">:</span><span class="hljs-number">00</span>'<span class="hljs-punctuation">,</span>
        endTime<span class="hljs-punctuation">:</span> '<span class="hljs-number">2025</span><span class="hljs-number">-01</span><span class="hljs-number">-01</span> <span class="hljs-number">18</span><span class="hljs-punctuation">:</span> <span class="hljs-number">00</span>'
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-punctuation">{</span>
        event<span class="hljs-punctuation">:</span> '这是一个测试会议ww'<span class="hljs-punctuation">,</span>
        startTime<span class="hljs-punctuation">:</span> '<span class="hljs-number">2025</span><span class="hljs-number">-01</span><span class="hljs-number">-02</span> <span class="hljs-number">13</span><span class="hljs-punctuation">:</span><span class="hljs-number">00</span>'<span class="hljs-punctuation">,</span>
        endTime<span class="hljs-punctuation">:</span> '<span class="hljs-number">2025</span><span class="hljs-number">-01</span><span class="hljs-number">-07</span> <span class="hljs-number">16</span><span class="hljs-punctuation">:</span> <span class="hljs-number">00</span>'
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    staff3<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-punctuation">{</span>
        event<span class="hljs-punctuation">:</span> '待办事项x'<span class="hljs-punctuation">,</span>
        startTime<span class="hljs-punctuation">:</span> '<span class="hljs-number">2025</span><span class="hljs-number">-01</span><span class="hljs-number">-01</span> <span class="hljs-number">9</span><span class="hljs-punctuation">:</span><span class="hljs-number">00</span>'<span class="hljs-punctuation">,</span>
        endTime<span class="hljs-punctuation">:</span> '<span class="hljs-number">2025</span><span class="hljs-number">-01</span><span class="hljs-number">-01</span> <span class="hljs-number">18</span><span class="hljs-punctuation">:</span> <span class="hljs-number">00</span>'
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-punctuation">{</span>
        event<span class="hljs-punctuation">:</span> '这是一个待办事项ww'<span class="hljs-punctuation">,</span>
        startTime<span class="hljs-punctuation">:</span> '<span class="hljs-number">2025</span><span class="hljs-number">-01</span><span class="hljs-number">-05</span> <span class="hljs-number">13</span><span class="hljs-punctuation">:</span><span class="hljs-number">00</span>'<span class="hljs-punctuation">,</span>
        endTime<span class="hljs-punctuation">:</span> '<span class="hljs-number">2025</span><span class="hljs-number">-01</span><span class="hljs-number">-07</span> <span class="hljs-number">16</span><span class="hljs-punctuation">:</span> <span class="hljs-number">00</span>'
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">]</span>
 <span class="hljs-punctuation">}</span>
</code></pre>
<p>后端会做简单的处理，把日程按单日分组，返回给前端的数据结构类似如下（项目里原本是week0~week6，本文简单演示就直接使用日期了）：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
    staff1<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      '<span class="hljs-number">2025</span><span class="hljs-number">-01</span><span class="hljs-number">-01</span>'<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-punctuation">{</span>
          event<span class="hljs-punctuation">:</span> '会议<span class="hljs-number">111</span>'<span class="hljs-punctuation">,</span>
          startTime<span class="hljs-punctuation">:</span> '<span class="hljs-number">2025</span><span class="hljs-number">-01</span><span class="hljs-number">-01</span> <span class="hljs-number">9</span><span class="hljs-punctuation">:</span><span class="hljs-number">00</span>'<span class="hljs-punctuation">,</span>
          endTime<span class="hljs-punctuation">:</span> '<span class="hljs-number">2025</span><span class="hljs-number">-01</span><span class="hljs-number">-04</span> <span class="hljs-number">18</span><span class="hljs-punctuation">:</span> <span class="hljs-number">00</span>'
        <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      '<span class="hljs-number">2025</span><span class="hljs-number">-01</span><span class="hljs-number">-02</span>'<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-punctuation">{</span>
          event<span class="hljs-punctuation">:</span> '会议<span class="hljs-number">111</span>'<span class="hljs-punctuation">,</span>
          startTime<span class="hljs-punctuation">:</span> '<span class="hljs-number">2025</span><span class="hljs-number">-01</span><span class="hljs-number">-01</span> <span class="hljs-number">9</span><span class="hljs-punctuation">:</span><span class="hljs-number">00</span>'<span class="hljs-punctuation">,</span>
          endTime<span class="hljs-punctuation">:</span> '<span class="hljs-number">2025</span><span class="hljs-number">-01</span><span class="hljs-number">-04</span> <span class="hljs-number">18</span><span class="hljs-punctuation">:</span> <span class="hljs-number">00</span>'
        <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
        <span class="hljs-punctuation">{</span>
          event<span class="hljs-punctuation">:</span> '这是一个测试会议<span class="hljs-number">22</span>'<span class="hljs-punctuation">,</span>
          startTime<span class="hljs-punctuation">:</span> '<span class="hljs-number">2025</span><span class="hljs-number">-01</span><span class="hljs-number">-02</span> <span class="hljs-number">13</span><span class="hljs-punctuation">:</span><span class="hljs-number">00</span>'<span class="hljs-punctuation">,</span>
          endTime<span class="hljs-punctuation">:</span> '<span class="hljs-number">2025</span><span class="hljs-number">-01</span><span class="hljs-number">-02</span> <span class="hljs-number">16</span><span class="hljs-punctuation">:</span> <span class="hljs-number">00</span>'
        <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      '<span class="hljs-number">2025</span><span class="hljs-number">-01</span><span class="hljs-number">-03</span>'<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-punctuation">{</span>
          event<span class="hljs-punctuation">:</span> '会议<span class="hljs-number">111</span>'<span class="hljs-punctuation">,</span>
          startTime<span class="hljs-punctuation">:</span> '<span class="hljs-number">2025</span><span class="hljs-number">-01</span><span class="hljs-number">-01</span> <span class="hljs-number">9</span><span class="hljs-punctuation">:</span><span class="hljs-number">00</span>'<span class="hljs-punctuation">,</span>
          endTime<span class="hljs-punctuation">:</span> '<span class="hljs-number">2025</span><span class="hljs-number">-01</span><span class="hljs-number">-04</span> <span class="hljs-number">18</span><span class="hljs-punctuation">:</span> <span class="hljs-number">00</span>'
        <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      '<span class="hljs-number">2025</span><span class="hljs-number">-01</span><span class="hljs-number">-04</span>'<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-punctuation">{</span>
          event<span class="hljs-punctuation">:</span> '会议<span class="hljs-number">111</span>'<span class="hljs-punctuation">,</span>
          startTime<span class="hljs-punctuation">:</span> '<span class="hljs-number">2025</span><span class="hljs-number">-01</span><span class="hljs-number">-01</span> <span class="hljs-number">9</span><span class="hljs-punctuation">:</span><span class="hljs-number">00</span>'<span class="hljs-punctuation">,</span>
          endTime<span class="hljs-punctuation">:</span> '<span class="hljs-number">2025</span><span class="hljs-number">-01</span><span class="hljs-number">-04</span> <span class="hljs-number">18</span><span class="hljs-punctuation">:</span> <span class="hljs-number">00</span>'
        <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      '<span class="hljs-number">2025</span><span class="hljs-number">-01</span><span class="hljs-number">-05</span>'<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-punctuation">{</span>
          event<span class="hljs-punctuation">:</span> '这是一个测试会议<span class="hljs-number">33</span>'<span class="hljs-punctuation">,</span>
          startTime<span class="hljs-punctuation">:</span> '<span class="hljs-number">2025</span><span class="hljs-number">-01</span><span class="hljs-number">-05</span> <span class="hljs-number">09</span><span class="hljs-punctuation">:</span><span class="hljs-number">00</span>'<span class="hljs-punctuation">,</span>
          endTime<span class="hljs-punctuation">:</span> '<span class="hljs-number">2025</span><span class="hljs-number">-01</span><span class="hljs-number">-05</span> <span class="hljs-number">17</span><span class="hljs-punctuation">:</span> <span class="hljs-number">00</span>'
        <span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      '<span class="hljs-number">2025</span><span class="hljs-number">-01</span><span class="hljs-number">-06</span>'<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      '<span class="hljs-number">2025</span><span class="hljs-number">-01</span><span class="hljs-number">-07</span>'<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    staff2<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      '<span class="hljs-number">2025</span><span class="hljs-number">-01</span><span class="hljs-number">-01</span>'<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-punctuation">{</span>
          event<span class="hljs-punctuation">:</span> '会议q'<span class="hljs-punctuation">,</span>
          startTime<span class="hljs-punctuation">:</span> '<span class="hljs-number">2025</span><span class="hljs-number">-01</span><span class="hljs-number">-01</span> <span class="hljs-number">9</span><span class="hljs-punctuation">:</span><span class="hljs-number">00</span>'<span class="hljs-punctuation">,</span>
          endTime<span class="hljs-punctuation">:</span> '<span class="hljs-number">2025</span><span class="hljs-number">-01</span><span class="hljs-number">-01</span> <span class="hljs-number">18</span><span class="hljs-punctuation">:</span> <span class="hljs-number">00</span>'
        <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      '<span class="hljs-number">2025</span><span class="hljs-number">-01</span><span class="hljs-number">-02</span>'<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-punctuation">{</span>
          event<span class="hljs-punctuation">:</span> '这是一个测试会议ww'<span class="hljs-punctuation">,</span>
          startTime<span class="hljs-punctuation">:</span> '<span class="hljs-number">2025</span><span class="hljs-number">-01</span><span class="hljs-number">-02</span> <span class="hljs-number">13</span><span class="hljs-punctuation">:</span><span class="hljs-number">00</span>'<span class="hljs-punctuation">,</span>
          endTime<span class="hljs-punctuation">:</span> '<span class="hljs-number">2025</span><span class="hljs-number">-01</span><span class="hljs-number">-07</span> <span class="hljs-number">16</span><span class="hljs-punctuation">:</span> <span class="hljs-number">00</span>'
        <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      '<span class="hljs-number">2025</span><span class="hljs-number">-01</span><span class="hljs-number">-03</span>'<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-punctuation">{</span>
          event<span class="hljs-punctuation">:</span> '这是一个测试会议ww'<span class="hljs-punctuation">,</span>
          startTime<span class="hljs-punctuation">:</span> '<span class="hljs-number">2025</span><span class="hljs-number">-01</span><span class="hljs-number">-02</span> <span class="hljs-number">13</span><span class="hljs-punctuation">:</span><span class="hljs-number">00</span>'<span class="hljs-punctuation">,</span>
          endTime<span class="hljs-punctuation">:</span> '<span class="hljs-number">2025</span><span class="hljs-number">-01</span><span class="hljs-number">-07</span> <span class="hljs-number">16</span><span class="hljs-punctuation">:</span> <span class="hljs-number">00</span>'
        <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      '<span class="hljs-number">2025</span><span class="hljs-number">-01</span><span class="hljs-number">-04</span>'<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-punctuation">{</span>
          event<span class="hljs-punctuation">:</span> '这是一个测试会议ww'<span class="hljs-punctuation">,</span>
          startTime<span class="hljs-punctuation">:</span> '<span class="hljs-number">2025</span><span class="hljs-number">-01</span><span class="hljs-number">-02</span> <span class="hljs-number">13</span><span class="hljs-punctuation">:</span><span class="hljs-number">00</span>'<span class="hljs-punctuation">,</span>
          endTime<span class="hljs-punctuation">:</span> '<span class="hljs-number">2025</span><span class="hljs-number">-01</span><span class="hljs-number">-07</span> <span class="hljs-number">16</span><span class="hljs-punctuation">:</span> <span class="hljs-number">00</span>'
        <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      '<span class="hljs-number">2025</span><span class="hljs-number">-01</span><span class="hljs-number">-05</span>'<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-punctuation">{</span>
          event<span class="hljs-punctuation">:</span> '这是一个测试会议ww'<span class="hljs-punctuation">,</span>
          startTime<span class="hljs-punctuation">:</span> '<span class="hljs-number">2025</span><span class="hljs-number">-01</span><span class="hljs-number">-02</span> <span class="hljs-number">13</span><span class="hljs-punctuation">:</span><span class="hljs-number">00</span>'<span class="hljs-punctuation">,</span>
          endTime<span class="hljs-punctuation">:</span> '<span class="hljs-number">2025</span><span class="hljs-number">-01</span><span class="hljs-number">-07</span> <span class="hljs-number">16</span><span class="hljs-punctuation">:</span> <span class="hljs-number">00</span>'
        <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      '<span class="hljs-number">2025</span><span class="hljs-number">-01</span><span class="hljs-number">-06</span>'<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-punctuation">{</span>
          event<span class="hljs-punctuation">:</span> '这是一个测试会议ww'<span class="hljs-punctuation">,</span>
          startTime<span class="hljs-punctuation">:</span> '<span class="hljs-number">2025</span><span class="hljs-number">-01</span><span class="hljs-number">-02</span> <span class="hljs-number">13</span><span class="hljs-punctuation">:</span><span class="hljs-number">00</span>'<span class="hljs-punctuation">,</span>
          endTime<span class="hljs-punctuation">:</span> '<span class="hljs-number">2025</span><span class="hljs-number">-01</span><span class="hljs-number">-07</span> <span class="hljs-number">16</span><span class="hljs-punctuation">:</span> <span class="hljs-number">00</span>'
        <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      '<span class="hljs-number">2025</span><span class="hljs-number">-01</span><span class="hljs-number">-07</span>'<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-punctuation">{</span>
          event<span class="hljs-punctuation">:</span> '这是一个测试会议ww'<span class="hljs-punctuation">,</span>
          startTime<span class="hljs-punctuation">:</span> '<span class="hljs-number">2025</span><span class="hljs-number">-01</span><span class="hljs-number">-02</span> <span class="hljs-number">13</span><span class="hljs-punctuation">:</span><span class="hljs-number">00</span>'<span class="hljs-punctuation">,</span>
          endTime<span class="hljs-punctuation">:</span> '<span class="hljs-number">2025</span><span class="hljs-number">-01</span><span class="hljs-number">-07</span> <span class="hljs-number">16</span><span class="hljs-punctuation">:</span> <span class="hljs-number">00</span>'
        <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    staff3<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      '<span class="hljs-number">2025</span><span class="hljs-number">-01</span><span class="hljs-number">-01</span>'<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-punctuation">{</span>
          event<span class="hljs-punctuation">:</span> '待办事项x'<span class="hljs-punctuation">,</span>
          startTime<span class="hljs-punctuation">:</span> '<span class="hljs-number">2025</span><span class="hljs-number">-01</span><span class="hljs-number">-01</span> <span class="hljs-number">9</span><span class="hljs-punctuation">:</span><span class="hljs-number">00</span>'<span class="hljs-punctuation">,</span>
          endTime<span class="hljs-punctuation">:</span> '<span class="hljs-number">2025</span><span class="hljs-number">-01</span><span class="hljs-number">-01</span> <span class="hljs-number">18</span><span class="hljs-punctuation">:</span> <span class="hljs-number">00</span>'
        <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      '<span class="hljs-number">2025</span><span class="hljs-number">-01</span><span class="hljs-number">-02</span>'<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      '<span class="hljs-number">2025</span><span class="hljs-number">-01</span><span class="hljs-number">-03</span>'<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      '<span class="hljs-number">2025</span><span class="hljs-number">-01</span><span class="hljs-number">-04</span>'<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      '<span class="hljs-number">2025</span><span class="hljs-number">-01</span><span class="hljs-number">-05</span>'<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-punctuation">{</span>
          event<span class="hljs-punctuation">:</span> '这是一个待办事项ww'<span class="hljs-punctuation">,</span>
          startTime<span class="hljs-punctuation">:</span> '<span class="hljs-number">2025</span><span class="hljs-number">-01</span><span class="hljs-number">-05</span> <span class="hljs-number">13</span><span class="hljs-punctuation">:</span><span class="hljs-number">00</span>'<span class="hljs-punctuation">,</span>
          endTime<span class="hljs-punctuation">:</span> '<span class="hljs-number">2025</span><span class="hljs-number">-01</span><span class="hljs-number">-07</span> <span class="hljs-number">16</span><span class="hljs-punctuation">:</span> <span class="hljs-number">00</span>'
        <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      '<span class="hljs-number">2025</span><span class="hljs-number">-01</span><span class="hljs-number">-06</span>'<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-punctuation">{</span>
          event<span class="hljs-punctuation">:</span> '这是一个待办事项ww'<span class="hljs-punctuation">,</span>
          startTime<span class="hljs-punctuation">:</span> '<span class="hljs-number">2025</span><span class="hljs-number">-01</span><span class="hljs-number">-05</span> <span class="hljs-number">13</span><span class="hljs-punctuation">:</span><span class="hljs-number">00</span>'<span class="hljs-punctuation">,</span>
          endTime<span class="hljs-punctuation">:</span> '<span class="hljs-number">2025</span><span class="hljs-number">-01</span><span class="hljs-number">-07</span> <span class="hljs-number">16</span><span class="hljs-punctuation">:</span> <span class="hljs-number">00</span>'
        <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      '<span class="hljs-number">2025</span><span class="hljs-number">-01</span><span class="hljs-number">-07</span>'<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-punctuation">{</span>
          event<span class="hljs-punctuation">:</span> '这是一个待办事项ww'<span class="hljs-punctuation">,</span>
          startTime<span class="hljs-punctuation">:</span> '<span class="hljs-number">2025</span><span class="hljs-number">-01</span><span class="hljs-number">-05</span> <span class="hljs-number">13</span><span class="hljs-punctuation">:</span><span class="hljs-number">00</span>'<span class="hljs-punctuation">,</span>
          endTime<span class="hljs-punctuation">:</span> '<span class="hljs-number">2025</span><span class="hljs-number">-01</span><span class="hljs-number">-07</span> <span class="hljs-number">16</span><span class="hljs-punctuation">:</span> <span class="hljs-number">00</span>'
        <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>前端就在以上的结构基础上进行遍历处理。</p>
<p>第一步准备工作，先简单判断当前处理的行程是否在一天内结束，并且判断是否跨时段（上下午），把这个两个判断结果存储起来用于后续操作。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> inOneDay =
    <span class="hljs-title function_">moment</span>(schedule.<span class="hljs-property">endTime</span>).<span class="hljs-title function_">format</span>(<span class="hljs-string">'YYYY-MM-DD'</span>) ===
    <span class="hljs-title function_">moment</span>(schedule.<span class="hljs-property">startTime</span>).<span class="hljs-title function_">format</span>(<span class="hljs-string">'YYYY-MM-DD'</span>) <span class="hljs-comment">// 是否在一天内完成（开始日期和结束日期一致）</span>
<span class="hljs-keyword">let</span> inOneRange = <span class="hljs-literal">false</span> <span class="hljs-comment">// 是否在同个时段（上下午），判断一天内的日程是否跨时段</span>
<span class="hljs-keyword">if</span> (inOneDay) {
  <span class="hljs-keyword">const</span> startMorning = <span class="hljs-title function_">moment</span>(schedule.<span class="hljs-property">startTime</span>).<span class="hljs-title function_">isSameOrBefore</span>(
      weekData[weekIndex].<span class="hljs-property">dateStr</span> + <span class="hljs-string">' '</span> + <span class="hljs-variable constant_">MORNING_END</span>
  )
  <span class="hljs-keyword">const</span> endAfternoon = <span class="hljs-title function_">moment</span>(schedule.<span class="hljs-property">endTime</span>).<span class="hljs-title function_">isSameOrAfter</span>(
      weekData[weekIndex].<span class="hljs-property">dateStr</span> + <span class="hljs-string">' '</span> + <span class="hljs-variable constant_">AFTERNOON_START</span>
  )
  <span class="hljs-keyword">if</span> ((startMorning &amp;&amp; !endAfternoon) || (!startMorning &amp;&amp; endAfternoon)) inOneRange = <span class="hljs-literal">true</span>
}
</code></pre>
<p>第二步就在第一步的基础上先做第一轮简单的筛选，如果满足以下条件之一，则当前处理的行程不用跨行处理。</p>
<ol>
<li>当前行程所在时段存在多个行程</li>
<li>当前行程本身不跨时段</li>
<li>当前行程跨上下午时段，当前处理的是下午，但是上午存在多个行程</li>
</ol>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">if</span> (
      weekData[weekIndex][account].<span class="hljs-property">length</span> &gt; <span class="hljs-number">1</span> || <span class="hljs-comment">// 当前员工单个时段有多个行程</span>
      (inOneDay &amp;&amp; inOneRange) || <span class="hljs-comment">// 某行程不跨时段</span>
      (inOneDay &amp;&amp;
          !inOneRange &amp;&amp;
          weekIndex % <span class="hljs-number">2</span> === <span class="hljs-number">1</span> &amp;&amp;
          weekData[weekIndex - <span class="hljs-number">1</span>][account].<span class="hljs-property">length</span> &gt; <span class="hljs-number">1</span>) <span class="hljs-comment">// 当前行程跨上下午时段，当前处理的是下午，但是上午存在多个行程</span>
  ) {
    <span class="hljs-comment">// 不做跨行处理</span>
    result.<span class="hljs-property">isCross</span> = <span class="hljs-literal">false</span>
    <span class="hljs-keyword">return</span> result
}
</code></pre>
<p>第三步做第二轮筛选，首先做两个判断并保存判断结果。</p>
<ol>
<li>
<p>当前是否为跨行的开始行</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 判断是否是跨行的开始（满足条件之一）：</span>
<span class="hljs-comment">// 1. 行程的开始日期等于当前行的日期，行程的开始时间晚于等于当前行的startTime</span>
<span class="hljs-comment">// 2. 行程的开始日期等于当前行的日期，行程的结束日期晚于当前行的日期</span>
<span class="hljs-comment">// 3. 行程的开始日期早于当前行的日期，且前一行的行程数量大于1</span>
<span class="hljs-comment">// 4. 当前行程在第一行</span>
<span class="hljs-keyword">const</span> isStart =
    (scheduleStartDate === weekData[weekIndex].<span class="hljs-property">dateStr</span> &amp;&amp;
        scheduleStartTime &gt;= weekData[weekIndex].<span class="hljs-property">startTime</span>) ||
    (weekIndex % <span class="hljs-number">2</span> === <span class="hljs-number">1</span> &amp;&amp;
        weekData[weekIndex - <span class="hljs-number">1</span>][account].<span class="hljs-property">length</span> &gt; <span class="hljs-number">1</span> &amp;&amp;
        scheduleStartDate === weekData[weekIndex].<span class="hljs-property">dateStr</span> &amp;&amp;
        scheduleEndDate &gt;= weekData[weekIndex].<span class="hljs-property">dateStr</span>) ||
    (scheduleStartDate &lt; weekData[weekIndex].<span class="hljs-property">dateStr</span> &amp;&amp;
        weekIndex &gt; <span class="hljs-number">0</span> &amp;&amp;
        weekData[weekIndex - <span class="hljs-number">1</span>][account].<span class="hljs-property">length</span> &gt; <span class="hljs-number">1</span>) ||
    weekIndex === <span class="hljs-number">0</span>
</code></pre>
</li>
<li>
<p>当前是否为跨行的结束行</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 判断是否是跨行的结束（满足条件之一）:</span>
<span class="hljs-comment">// 1. 当前行程在最后一行</span>
<span class="hljs-comment">// 2. 行程的结束日期等于当前行的日期，行程的结束时间晚于当前行的startTime且早于等于当前行的endTime</span>
<span class="hljs-comment">// 3. 下一行的日程数量大于1</span>
<span class="hljs-keyword">const</span> isEnd =
    weekIndex === <span class="hljs-number">13</span> ||
    (scheduleEndDate === weekData[weekIndex].<span class="hljs-property">dateStr</span> &amp;&amp;
        scheduleEndTime &gt;= weekData[weekIndex].<span class="hljs-property">startTime</span> &amp;&amp;
        scheduleEndTime &lt;= weekData[weekIndex].<span class="hljs-property">endTime</span>) ||
    weekData[weekIndex + <span class="hljs-number">1</span>][account].<span class="hljs-property">length</span> &gt; <span class="hljs-number">1</span>
</code></pre>
</li>
</ol>
<p>如果两个判断结果都为true，则说明既是开始行，同是又是结束行，那就不用做跨行处理。</p>
<p>最后筛出来的就是要跨行的单元格了，就要计算跨的行数了，也就是起始行的rowSpan值，非起始行的rowSpan就是0了。</p>
<p>起始行的rowSpan就是计算具体这个行程在表格里跨的行数。</p>
<p>首先计算单个行程自身原本跨了几个时段。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> diffScheduleEnd = <span class="hljs-title function_">moment</span>(scheduleEndDate).<span class="hljs-title function_">diff</span>(
    <span class="hljs-title function_">moment</span>(weekData[weekIndex].<span class="hljs-property">dateStr</span>),
    <span class="hljs-string">'days'</span>
) <span class="hljs-comment">// 与行程结束日期的天数差值</span>
<span class="hljs-keyword">const</span> diffWeekEnd = <span class="hljs-title function_">moment</span>(weekData[<span class="hljs-number">13</span>].<span class="hljs-property">dateStr</span>).<span class="hljs-title function_">diff</span>(
    <span class="hljs-title function_">moment</span>(weekData[weekIndex].<span class="hljs-property">dateStr</span>),
    <span class="hljs-string">'days'</span>
) <span class="hljs-comment">// 与周最后一天的天数差值</span>
<span class="hljs-keyword">const</span> dayOff = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(diffScheduleEnd, diffWeekEnd) <span class="hljs-comment">// 跨的天数</span>
<span class="hljs-keyword">const</span> timeOff = scheduleEndTime &lt;= <span class="hljs-variable constant_">MORNING_END</span> ? <span class="hljs-number">1</span> : <span class="hljs-number">2</span> <span class="hljs-comment">// 跨的时段</span>
<span class="hljs-keyword">let</span> offRows = <span class="hljs-number">0</span>
<span class="hljs-comment">// 行位移 = (天数-1)*2 + 跨的时段</span>
<span class="hljs-keyword">if</span> (dayOff &gt; <span class="hljs-number">0</span>) offRows = (dayOff - <span class="hljs-number">1</span>) * <span class="hljs-number">2</span> + timeOff
<span class="hljs-comment">// 如果当前行程是上午开始的，再加一个行跨</span>
<span class="hljs-keyword">if</span> (weekIndex % <span class="hljs-number">2</span> === <span class="hljs-number">0</span>) offRows++
</code></pre>
<p>再向后遍历碰到存在多个行程的单元格就表示跨行结束，得到了rowSpan的值。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> len = weekIndex + <span class="hljs-number">1</span> + offRows
<span class="hljs-keyword">let</span> rowSpan = <span class="hljs-number">1</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = weekIndex + <span class="hljs-number">1</span>; i &lt; len; i++) {
  <span class="hljs-keyword">if</span> (weekData[i][account].<span class="hljs-property">length</span> &gt; <span class="hljs-number">1</span>) {
    <span class="hljs-keyword">break</span>
  } <span class="hljs-keyword">else</span> {
    rowSpan++
  }
}
</code></pre>
<p>最后我们就可以得到合并的单元格。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[关于vue2中使用el-table进行跨页选择并回显编辑的功能实现]]></title>    <link>https://juejin.cn/post/7588402359450140712</link>    <guid>https://juejin.cn/post/7588402359450140712</guid>    <pubDate>2025-12-28T15:46:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588402359450140712" data-draft-id="7588425700001726499" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="关于vue2中使用el-table进行跨页选择并回显编辑的功能实现"/> <meta itemprop="keywords" content="Vue.js"/> <meta itemprop="datePublished" content="2025-12-28T15:46:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="嘉焱"/> <meta itemprop="url" content="https://juejin.cn/user/3241775927404701"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            关于vue2中使用el-table进行跨页选择并回显编辑的功能实现
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3241775927404701/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    嘉焱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-28T15:46:49.000Z" title="Sun Dec 28 2025 15:46:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h4 data-id="heading-0">简要</h4>
<p>业务场景中，经常会出现跨页选择的需求。在vue2中，el-table自带有<code>reserve-selection</code>属性，再加上指定<code>row-key</code>属性，就可以实现基本的功能。</p>
<p>上述方法仅能实现单向，即跨页选中并保存的业务。</p>
<p>但有时候会出现，在编辑中根据id数组，回显出之前选择的行数据，并且支持再次编辑。</p>
<h4 data-id="heading-1">解决方案</h4>
<p><span href="https://code.juejin.cn/pen/7588922502366101514" class="code-editor-container"><iframe class="code-editor-frame" data-code="code-editor-element" data-code-id="7588922502366101514" data-src="https://code.juejin.cn/pen/7588922502366101514" style="display:none;" loading="lazy"/><span class="loading-placeholder" style="display:none"><img class="placeholder-image" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8CAYAAAA6/NlyAAAAJElEQVRoge3BMQEAAADCoPVP7WkJoAAAAAAAAAAAAAAAAAAAbjh8AAFte11jAAAAAElFTkSuQmCC" loading="lazy"/><span class="loading-logo"/></span></span></p>
<h4 data-id="heading-2">核心为对列表数据的重新选择</h4>
<pre><code class="hljs language-js" lang="js">  <span class="hljs-comment">// 重新选中当前页,已选中的选项</span>
    <span class="hljs-title function_">setSelectedRows</span>(<span class="hljs-params"/>){
      <span class="hljs-comment">// 使用 Set 来存储 selectedRows 中的 id，以提高查找速度</span>
      <span class="hljs-keyword">const</span> selectedIds = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">selectedRows</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">row</span> =&gt;</span> row.<span class="hljs-property">id</span>))
      <span class="hljs-comment">// 遍历 tableList 并根据 selectedIds 设置选择状态</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">tableList</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> {
        <span class="hljs-keyword">if</span> (selectedIds.<span class="hljs-title function_">has</span>(item.<span class="hljs-property">id</span>)) {
          <span class="hljs-variable language_">this</span>.$nextTick(<span class="hljs-function">() =&gt;</span> {
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">$refs</span>.<span class="hljs-property">table</span>.<span class="hljs-title function_">toggleRowSelection</span>(item, <span class="hljs-literal">true</span>);
          });
        }
      });
    },
</code></pre>
<p>对表格的选中操作要分成三种方法处理</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 选择数据</span>
    <span class="hljs-title function_">selectOne</span>(<span class="hljs-params">val, row</span>) {
      <span class="hljs-comment">// 如果 row.id 存在于 this.selectedRows 但不在 val.id 中，则从 this.selectedRows 中删除这一项</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">selectedRows</span>.<span class="hljs-title function_">some</span>(<span class="hljs-function"><span class="hljs-params">selectedRow</span> =&gt;</span> selectedRow.<span class="hljs-property">id</span> === row.<span class="hljs-property">id</span>) &amp;&amp; !val.<span class="hljs-title function_">some</span>(<span class="hljs-function"><span class="hljs-params">selectedVal</span> =&gt;</span> selectedVal.<span class="hljs-property">id</span> === row.<span class="hljs-property">id</span>)) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">selectedRows</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">selectedRows</span>.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">selectedRow</span> =&gt;</span> selectedRow.<span class="hljs-property">id</span> !== row.<span class="hljs-property">id</span>)
      }
    },
    <span class="hljs-comment">// 表格全选操作</span>
    <span class="hljs-title function_">selectAll</span>(<span class="hljs-params">val, row</span>) {
      <span class="hljs-keyword">if</span> (val.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {
        <span class="hljs-comment">// 此时为取消当页全选</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">tableList</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> {
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">selectedRows</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">selectedRows</span>.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">selectedRow</span> =&gt;</span> selectedRow.<span class="hljs-property">id</span> !== item.<span class="hljs-property">id</span>)
        })
      }
    },
    <span class="hljs-title function_">handleSelectionChange</span>(<span class="hljs-params">val</span>) {
      <span class="hljs-comment">// 先合并 val 和 this.selectedRows</span>
      <span class="hljs-keyword">const</span> combinedRows = [...<span class="hljs-variable language_">this</span>.<span class="hljs-property">selectedRows</span>, ...val]
      <span class="hljs-comment">// 使用 Map 来存储 dvpId 和对应的 val，这样可以自动去重</span>
      <span class="hljs-keyword">const</span> map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>()
      combinedRows.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> {
        <span class="hljs-comment">// 如果 dvpId 已经存在，则不覆盖</span>
        <span class="hljs-keyword">if</span> (!map.<span class="hljs-title function_">has</span>(item.<span class="hljs-property">id</span>)) {
          map.<span class="hljs-title function_">set</span>(item.<span class="hljs-property">id</span>, item)
        }
      })
      <span class="hljs-comment">// 将 Map 转换回数组</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">selectedRows</span> = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(map.<span class="hljs-title function_">values</span>())
    }
</code></pre>
<p>以上仅为个人业务使用理解，如有优化或问题，欢迎探讨。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Spring AOP + Guava RateLimiter：我是如何用注解实现优雅限流的？]]></title>    <link>https://juejin.cn/post/7588376012121669659</link>    <guid>https://juejin.cn/post/7588376012121669659</guid>    <pubDate>2025-12-29T01:44:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588376012121669659" data-draft-id="7588093282531393588" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Spring AOP + Guava RateLimiter：我是如何用注解实现优雅限流的？"/> <meta itemprop="keywords" content="Spring,后端,面试"/> <meta itemprop="datePublished" content="2025-12-29T01:44:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="一旅人"/> <meta itemprop="url" content="https://juejin.cn/user/3485898277388519"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Spring AOP + Guava RateLimiter：我是如何用注解实现优雅限流的？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3485898277388519/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    一旅人
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T01:44:56.000Z" title="Mon Dec 29 2025 01:44:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><strong>写在前面</strong></p>
<p>提起 AOP（面向切面编程），大家的第一反应往往是：“哦，那个用来打印日志、管理事务、或者做权限校验的。”</p>
<p>其实，AOP 的能力远不止于此。在面对高并发场景下的接口自我保护时，它同样能发挥奇效。</p>
</blockquote>
<p>最近在项目中遇到了一个真实场景：这是一个<strong>基于 MQ 触发的定时跑批任务</strong>。平日里风平浪静，可是一旦大促或者数据量激增，MQ 里的积压消息就会瞬间推送给消费者。</p>
<p>虽然消费者服务虽然处理得过来，但底层的<strong>核心业务数据库却扛不住了</strong>——大量并发查询瞬间打满 CPU，CPU 使用率飙升至 100%，直接影响了线上实时业务的稳定性。</p>
<p>考虑到该服务是单节点部署，引入 Redis 做分布式限流显得“杀鸡用牛刀”，也增加了额外的运维成本。最终，我决定使用 <strong>Spring AOP + Guava RateLimiter + 自定义注解</strong>，实现一个 <strong>无侵入、可配置、轻量级</strong> 的<strong>单机限流组件</strong>。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ac50a96a741a4bebb96e508fd06c7757~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5peF5Lq6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767577495&amp;x-signature=qyEV8dUxSg2TU75Nwi7%2FvYkHJqw%3D" alt="image.png" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-0">一、 为什么选择 AOP + 注解？</h2>
<p>在介绍代码之前，先明确设计初衷。</p>
<p>以前我刚接触开发时，也喜欢在 Service 或 Controller 层直接硬编码限流逻辑，例如：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ❌ 反例：硬编码，逻辑混杂且难以复用</span>
<span class="hljs-keyword">if</span> (!rateLimiter.tryAcquire()) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"系统繁忙"</span>);
}
doBusiness();
</code></pre>
<p>这种写法的弊端很明显：</p>
<ol>
<li><strong>逻辑混杂</strong>：清晰的业务代码中夹杂着非业务的限流判断。</li>
<li><strong>复用性差</strong>：如果有十个接口需要限流，就需要重复编写十次。</li>
<li><strong>维护困难</strong>：一旦需要调整限流策略（例如升级为分布式限流），涉及的修改点将非常多。</li>
</ol>
<p><strong>AOP（面向切面编程）</strong> 的核心就是 <strong>“解耦”</strong> 和 <strong>“复用”</strong>。</p>
<p>我将限流逻辑封装为一个独立的“切面”，配合自定义注解作为“开关”。<strong>只需在目标方法上添加一个注解，限流策略随即生效</strong>。后续的维护与升级，也仅需聚焦于切面逻辑本身，无需触碰任何业务代码。</p>
<hr/>
<h2 data-id="heading-1">二、 Guava RateLimiter 核心原理</h2>
<p>我这次选用的核心库是 Google Guava 的 <code>RateLimiter</code>。它是基于 <strong>令牌桶算法（Token Bucket）</strong> 实现的。</p>
<h3 data-id="heading-2">1. 简单回顾令牌桶</h3>
<p>它的机制不像“漏桶”那样死板（恒定速率流出），而是更加人性化：</p>
<ul>
<li><strong>生产令牌</strong>：系统以固定速率向桶中放入令牌。</li>
<li><strong>消费令牌</strong>：请求过来时，必须先拿到令牌才能执行。</li>
<li><strong>关键特性</strong>：<strong>支持突发流量</strong>。如果一段时间没有请求，桶里的令牌会积攒起来（直到达到桶上限）。当一波突发流量到来时，可以直接消耗积攒的令牌立刻执行，而不需要排队等待。</li>
</ul>
<h3 data-id="heading-3">2. 两种核心模式</h3>
<p>Guava 贴心地提供了两种实现：</p>
<ol>
<li><strong>SmoothBursty（平滑突发）</strong>：<strong>默认模式</strong>。适合大多数场景，允许短时间的流量突发。</li>
<li><strong>SmoothWarmingUp（平滑预热）</strong>：<strong>预热模式</strong>。启动初期令牌发放速率较慢，随着时间推移逐步提升到目标 QPS。这对于需要“热身”的资源（如数据库连接池、缓存填充）非常友好，防止冷启动时瞬间被打挂。</li>
</ol>
<h3 data-id="heading-4">3. 单机版警告 ⚠️</h3>
<p><strong>注意</strong>：<code>Guava RateLimiter</code> 是 <strong>单机限流</strong> 工具！令牌是存在当前 JVM 内存里的。</p>
<ul>
<li>如果你的服务只部署一台机器，它完美胜任。</li>
<li>如果你部署了 10 台机器，每台设置 QPS=5，那么整个集群的总 QPS 上限是 50。</li>
</ul>
<h3 data-id="heading-5">4. 常用 API 详解</h3>
<p>熟练掌握 API 是实战的基础，以下是 <code>RateLimiter</code> 的核心方法：</p>
<p><strong>核心创建方法</strong></p>

















<table><thead><tr><th align="left">方法签名</th><th align="left">说明</th></tr></thead><tbody><tr><td align="left"><code>create(double permitsPerSecond)</code></td><td align="left">创建 <strong>SmoothBursty</strong> 限流器，指定每秒生成的令牌数（默认：permitsPerSecond = QPS = 桶容量）。</td></tr><tr><td align="left"><code>create(double permitsPerSecond, long warmupPeriod, TimeUnit unit)</code></td><td align="left">创建 <strong>SmoothWarmingUp</strong> 限流器，指定 QPS + 预热时间。</td></tr></tbody></table>
<p><strong>核心获取方法</strong></p>

























<table><thead><tr><th align="left">方法签名</th><th align="left">说明</th></tr></thead><tbody><tr><td align="left"><code>double acquire()</code></td><td align="left"><strong>阻塞式</strong>获取 1 个令牌。若无令牌，线程会<strong>一直等待</strong>，直到获取成功。</td></tr><tr><td align="left"><code>double acquire(int permits)</code></td><td align="left"><strong>阻塞式</strong>获取指定数量的令牌（可一次获取多个）。</td></tr><tr><td align="left"><code>boolean tryAcquire()</code></td><td align="left"><strong>非阻塞式</strong>获取 1 个令牌。立即返回：成功 <code>true</code>，失败 <code>false</code>（不等待）。</td></tr><tr><td align="left"><code>boolean tryAcquire(long timeout, TimeUnit unit)</code></td><td align="left"><strong>限时等待</strong>获取 1 个令牌。在超时时间内拿到返回 <code>true</code>，否则返回 <code>false</code>。这是最推荐的用法，既避免了线程死等，又提供了一定的缓冲。</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-6">三、 代码实战：打造企业级限流组件</h2>
<p>接下来，我来实现一个功能完备的 <code>@RateLimit</code> 组件，支持<strong>QPS配置、阻塞/非阻塞模式、超时控制以及预热模式</strong>。</p>
<h3 data-id="heading-7">1. 引入依赖</h3>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.google.guava<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>guava<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>32.1.3-jre<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-aop<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<h3 data-id="heading-8">2. 定义注解 <code>@RateLimit</code></h3>
<p>这个注解承载了限流的所有配置元数据。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.lang.annotation.*;
<span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;

<span class="hljs-meta">@Target({ElementType.METHOD})</span>
<span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span>
<span class="hljs-meta">@Documented</span>
<span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> RateLimit {

    <span class="hljs-comment">/**
     * 限流阈值 (QPS)，默认每秒 5 个
     */</span>
    <span class="hljs-type">double</span> <span class="hljs-title function_">qps</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-number">5.0</span>;

    <span class="hljs-comment">/**
     * 获取令牌的策略
     * true: 阻塞模式（直到拿到令牌或超时）
     * false: 非阻塞模式（拿不到立即失败）
     */</span>
    <span class="hljs-type">boolean</span> <span class="hljs-title function_">block</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-literal">true</span>;

    <span class="hljs-comment">/**
     * 阻塞等待的超时时间（仅当 block=true 时生效）
     * 默认 0，表示无限等待
     */</span>
    <span class="hljs-type">long</span> <span class="hljs-title function_">timeout</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-number">0</span>;

    <span class="hljs-comment">/**
     * 超时时间单位
     */</span>
    TimeUnit <span class="hljs-title function_">timeUnit</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> TimeUnit.MILLISECONDS;

    <span class="hljs-comment">/**
     * 预热时间
     * 默认 0 (SmoothBursty)；设置 &gt;0 则开启预热模式 (SmoothWarmingUp)
     */</span>
    <span class="hljs-type">long</span> <span class="hljs-title function_">warmupPeriod</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-number">0</span>;

    <span class="hljs-comment">/**
     * 预热时间单位
     */</span>
    TimeUnit <span class="hljs-title function_">warmupUnit</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> TimeUnit.SECONDS;

    <span class="hljs-comment">/**
     * 限流提示信息
     */</span>
    String <span class="hljs-title function_">message</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-string">"系统繁忙，请稍后再试"</span>;
}
</code></pre>
<h3 data-id="heading-9">3. 定义全局异常 <code>RateLimitException</code></h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RateLimitException</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">RuntimeException</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">RateLimitException</span><span class="hljs-params">(String message)</span> {
        <span class="hljs-built_in">super</span>(message);
    }
}
</code></pre>
<h3 data-id="heading-10">4. 实现切面 <code>RateLimitAop</code></h3>
<p>这是限流组件的“大脑”。需要重点关注实例缓存、线程安全以及不同策略的执行逻辑。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> com.google.common.util.concurrent.RateLimiter;
<span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;
<span class="hljs-keyword">import</span> org.aspectj.lang.ProceedingJoinPoint;
<span class="hljs-keyword">import</span> org.aspectj.lang.annotation.Around;
<span class="hljs-keyword">import</span> org.aspectj.lang.annotation.Aspect;
<span class="hljs-keyword">import</span> org.aspectj.lang.annotation.Pointcut;
<span class="hljs-keyword">import</span> org.aspectj.lang.reflect.MethodSignature;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Component;

<span class="hljs-keyword">import</span> java.lang.reflect.Method;
<span class="hljs-keyword">import</span> java.util.Map;
<span class="hljs-keyword">import</span> java.util.concurrent.ConcurrentHashMap;

<span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@Aspect</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RateLimitAop</span> {
    
    <span class="hljs-comment">// 使用 ConcurrentHashMap 缓存 RateLimiter 实例，确保线程安全</span>
    <span class="hljs-comment">// Key: 方法签名 (类名.方法名(参数类型)), Value: 限流器实例</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;String, RateLimiter&gt; rateLimiterCache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();

    <span class="hljs-meta">@Pointcut("@annotation(com.example.annotation.RateLimit)")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">rateLimitPointcut</span><span class="hljs-params">()</span> {}

    <span class="hljs-meta">@Around("rateLimitPointcut()")</span>
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">around</span><span class="hljs-params">(ProceedingJoinPoint joinPoint)</span> <span class="hljs-keyword">throws</span> Throwable {
        <span class="hljs-type">MethodSignature</span> <span class="hljs-variable">signature</span> <span class="hljs-operator">=</span> (MethodSignature) joinPoint.getSignature();
        <span class="hljs-type">Method</span> <span class="hljs-variable">method</span> <span class="hljs-operator">=</span> signature.getMethod();
        <span class="hljs-type">RateLimit</span> <span class="hljs-variable">annotation</span> <span class="hljs-operator">=</span> method.getAnnotation(RateLimit.class);

        <span class="hljs-comment">// 1. 构建方法唯一 Key，防止方法重载冲突</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">methodKey</span> <span class="hljs-operator">=</span> buildMethodKey(method);
        
        <span class="hljs-comment">// 2. 线程安全地创建或获取限流器</span>
        <span class="hljs-type">RateLimiter</span> <span class="hljs-variable">rateLimiter</span> <span class="hljs-operator">=</span> rateLimiterCache.computeIfAbsent(methodKey, key -&gt; createRateLimiter(annotation));

        <span class="hljs-comment">// 3. 执行获取令牌逻辑</span>
        <span class="hljs-type">boolean</span> acquireSuccess;
        <span class="hljs-keyword">if</span> (annotation.block()) {
            <span class="hljs-comment">// --- 阻塞模式 ---</span>
            <span class="hljs-keyword">if</span> (annotation.timeout() &lt;= <span class="hljs-number">0</span>) {
                <span class="hljs-comment">// 无限等待，直到成功</span>
                rateLimiter.acquire();
                acquireSuccess = <span class="hljs-literal">true</span>;
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-comment">// 限时等待</span>
                acquireSuccess = rateLimiter.tryAcquire(annotation.timeout(), annotation.timeUnit());
            }
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// --- 非阻塞模式 ---</span>
            <span class="hljs-comment">// 立即尝试，失败即返回</span>
            acquireSuccess = rateLimiter.tryAcquire();
        }

        <span class="hljs-comment">// 4. 限流拦截</span>
        <span class="hljs-keyword">if</span> (!acquireSuccess) {
            log.warn(<span class="hljs-string">"【限流报警】方法 {} 请求频率过高，已拒绝。"</span>, methodKey);
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RateLimitException</span>(annotation.message());
        }

        <span class="hljs-comment">// 5. 放行</span>
        <span class="hljs-keyword">return</span> joinPoint.proceed();
    }

    <span class="hljs-comment">/**
     * 生成方法签名：Package.Class.Method(ParamType1,ParamType2)
     */</span>
    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">buildMethodKey</span><span class="hljs-params">(Method method)</span> {
        <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">keyBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();
        keyBuilder.append(method.getDeclaringClass().getName())
                .append(<span class="hljs-string">"."</span>).append(method.getName()).append(<span class="hljs-string">"("</span>);
        Class&lt;?&gt;[] parameterTypes = method.getParameterTypes();
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; parameterTypes.length; i++) {
            keyBuilder.append(parameterTypes[i].getSimpleName());
            <span class="hljs-keyword">if</span> (i &lt; parameterTypes.length - <span class="hljs-number">1</span>) {
                keyBuilder.append(<span class="hljs-string">","</span>);
            }
        }
        keyBuilder.append(<span class="hljs-string">")"</span>);
        <span class="hljs-keyword">return</span> keyBuilder.toString();
    }

    <span class="hljs-comment">/**
     * 工厂方法：根据配置创建具体的 RateLimiter
     */</span>
    <span class="hljs-keyword">private</span> RateLimiter <span class="hljs-title function_">createRateLimiter</span><span class="hljs-params">(RateLimit annotation)</span> {
        <span class="hljs-keyword">if</span> (annotation.warmupPeriod() &gt; <span class="hljs-number">0</span>) {
            log.info(<span class="hljs-string">"创建预热限流器: QPS={}, Warmup={}s"</span>, annotation.qps(), annotation.warmupPeriod());
            <span class="hljs-keyword">return</span> RateLimiter.create(annotation.qps(), annotation.warmupPeriod(), annotation.warmupUnit());
        } <span class="hljs-keyword">else</span> {
            log.info(<span class="hljs-string">"创建标准限流器: QPS={}"</span>, annotation.qps());
            <span class="hljs-keyword">return</span> RateLimiter.create(annotation.qps());
        }
    }
}
</code></pre>
<h3 data-id="heading-11">5. 业务接入示例</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DataSyncService</span> {

    <span class="hljs-comment">// 场景1：核心数据同步，允许排队等待500ms，保证尽可能执行</span>
    <span class="hljs-meta">@RateLimit(qps = 10.0, block = true, timeout = 500)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">syncImportantData</span><span class="hljs-params">(List&lt;Data&gt; dataList)</span> {
        <span class="hljs-comment">// ... 业务逻辑 ...</span>
    }

    <span class="hljs-comment">// 场景2：非核心接口，流量大时直接丢弃，保护系统</span>
    <span class="hljs-meta">@RateLimit(qps = 50.0, block = false, message = "当前访问人数过多")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">refreshCache</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// ... 刷新逻辑 ...</span>
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-12">四、 进阶：聊聊动态代理那个“大家都知道”的坑</h2>
<p>在使用 AOP 时，有一个经典面试题级别的现象：<strong>类内方法自调用导致 AOP 失效</strong>。作为开发者，我们不止要知其然，更知其所以然。</p>
<h3 data-id="heading-13">场景重现</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TradeService</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">process</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// ... 前置处理 ...</span>
        pay(); <span class="hljs-comment">// ❌ 重点在这里：直接调用内部方法</span>
    }

    <span class="hljs-meta">@RateLimit(qps = 5.0)</span> 
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">pay</span><span class="hljs-params">()</span> { ... }
}
</code></pre>
<h3 data-id="heading-14">为什么会失效？</h3>
<p>Spring AOP 的底层使用的是 <strong>动态代理</strong>。</p>
<ul>
<li>容器启动时，Spring 为 <code>TradeService</code> 生成了一个代理对象（Proxy）。</li>
<li>外部调用 <code>process()</code> 时，先走的是代理。</li>
<li>但在 <code>process()</code> 内部执行 <code>pay()</code> 时，使用的是 <code>this.pay()</code>。<strong>这里的 <code>this</code> 指向的是目标对象本身，而非代理对象</strong>。</li>
<li>既然没经过代理，切面逻辑自然就像空气一样被穿透了。</li>
</ul>
<h3 data-id="heading-15">避坑建议</h3>
<p>针对此类问题，我推荐以下处理方式：</p>
<p><strong>推荐：拆分大法（Best Practice）</strong></p>
<p>将 <code>pay()</code> 方法拆分到另一个独立的 Bean（例如 <code>PayService</code>）中。通过注入的方式调用，天然符合“通过代理调用”的规则，代码结构也更清晰。</p>
<p><strong>推荐：AopContext</strong></p>
<p>直接从 Spring 上下文中捞取当前代理对象。（老功能修改）</p>
<ol>
<li>SpringBoot启动类上开启配置：<code>@EnableAspectJAutoProxy(exposeProxy = true)</code></li>
<li>具体代码中修改：<code>((TradeService) AopContext.currentProxy()).pay();</code></li>
</ol>
<p><strong>不推荐：@Autowired 注入自身</strong></p>
<p>虽然能解决问题，但容易引发<strong>循环依赖</strong>异常，增加系统启动风险。</p>
<hr/>
<h2 data-id="heading-16">五、 进阶思考：从单机到分布式</h2>
<p>前面我强调了 <code>Guava RateLimiter</code> 是<strong>单机限流</strong>。那么，如果系统做大了，部署了 50 个节点，需要对某个下游 API 做全局每秒 1000 次的限流，该怎么办？</p>
<p><strong>这时候，AOP + 注解 设计模式的威力就体现出来了。</strong></p>
<p>你<strong>完全不需要</strong>修改任何业务代码，也不用删掉 <code>@RateLimit</code> 注解。
你只需要做一个动作：<strong>修改 <code>RateLimitAop</code> 切面的实现</strong>。</p>
<p>把切面里获取令牌的逻辑，从 <code>Guava RateLimiter</code> 换成 <strong>Redis + Lua</strong> 脚本，或者直接接入 <strong>Redisson</strong> 的 <code>RRateLimiter</code>。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 伪代码示例：无缝切换分布式限流</span>
<span class="hljs-keyword">private</span> RRateLimiter <span class="hljs-title function_">getRedisLimiter</span><span class="hljs-params">(String key)</span> {
    <span class="hljs-type">RRateLimiter</span> <span class="hljs-variable">limiter</span> <span class="hljs-operator">=</span> redissonClient.getRateLimiter(key);
    <span class="hljs-comment">// ... 初始化 Redis 限流器 ...</span>
    <span class="hljs-keyword">return</span> limiter;
}

<span class="hljs-comment">// 在 around 方法里，将 RateLimiter.tryAcquire() 替换为 Redisson 的实现</span>
<span class="hljs-type">RRateLimiter</span> <span class="hljs-variable">limiter</span> <span class="hljs-operator">=</span> getRedisLimiter(methodKey);
<span class="hljs-keyword">if</span> (!limiter.tryAcquire(annotation.qps(), annotation.timeout(), annotation.timeUnit())) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RateLimitException</span>(<span class="hljs-string">"分布式限流生效中..."</span>);
}
</code></pre>
<p>看，这就是架构设计的艺术。业务方无感知，底层能力平滑升级。</p>
<hr/>
<h2 data-id="heading-17">六、 总结与结语</h2>
<p>总的来说，AOP 让限流这类“基础设施”悄无声息地融入了业务脉络，这正是优雅架构的魅力所在——<strong>将复杂性收敛于一点，在别处换来 simplicity</strong>。</p>
<p>最后，想起一句被反复“魔改”的名言，放在这里格外贴切：<strong>“让架构的归架构，让业务的归业务”</strong>。</p>
<p>愿各位的代码世界，秩序井然，bug 退散。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Kotlin Flow 中 flatMap 与 flatMapLatest 的核心差异 —— 新手指南]]></title>    <link>https://juejin.cn/post/7588365276191883302</link>    <guid>https://juejin.cn/post/7588365276191883302</guid>    <pubDate>2025-12-29T01:52:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588365276191883302" data-draft-id="7588461466598441011" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Kotlin Flow 中 flatMap 与 flatMapLatest 的核心差异 —— 新手指南"/> <meta itemprop="keywords" content="Kotlin,Android,Android Jetpack"/> <meta itemprop="datePublished" content="2025-12-29T01:52:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="QING618"/> <meta itemprop="url" content="https://juejin.cn/user/339115460529117"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Kotlin Flow 中 flatMap 与 flatMapLatest 的核心差异 —— 新手指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/339115460529117/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    QING618
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T01:52:18.000Z" title="Mon Dec 29 2025 01:52:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1. 差异</h2>
<h3 data-id="heading-1">flatMap</h3>
<ul>
<li><strong>行为</strong>：转换每个输入值到 Flow，并<strong>按顺序收集所有生成的 Flow</strong></li>
<li><strong>特点</strong>：新的输入不会取消之前正在进行的转换</li>
<li><strong>使用场景</strong>：需要处理所有事件，且事件间有依赖关系或需保持顺序</li>
</ul>
<h3 data-id="heading-2">flatMapLatest</h3>
<ul>
<li><strong>行为</strong>：当有新输入时，<strong>立即取消</strong>前一个转换的 Flow</li>
<li><strong>特点</strong>：只处理最新的输入，忽略中间结果</li>
<li><strong>使用场景</strong>：只需最新结果，可安全取消旧操作</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 对比示例</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">demonstrateDifference</span><span class="hljs-params">()</span></span> {
    runBlocking {
        <span class="hljs-keyword">val</span> flow = flowOf(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>).onEach { delay(<span class="hljs-number">100</span>) }
        
        <span class="hljs-comment">// flatMap：处理所有值</span>
        flow.flatMap { value -&gt;
            flow {
                emit(<span class="hljs-string">"Processing <span class="hljs-variable">$value</span>"</span>)
                delay(<span class="hljs-number">200</span>) <span class="hljs-comment">// 模拟耗时操作</span>
                emit(<span class="hljs-string">"Completed <span class="hljs-variable">$value</span>"</span>)
            }
        }.collect { println(<span class="hljs-string">"flatMap: <span class="hljs-variable">$it</span>"</span>) }
        <span class="hljs-comment">// 输出所有 1,2,3 的处理结果</span>
        
        <span class="hljs-comment">// flatMapLatest：只处理最新的</span>
        flow.flatMapLatest { value -&gt;
            flow {
                emit(<span class="hljs-string">"Latest: <span class="hljs-variable">$value</span>"</span>)
                delay(<span class="hljs-number">200</span>)
                emit(<span class="hljs-string">"Done: <span class="hljs-variable">$value</span>"</span>) <span class="hljs-comment">// 可能被取消</span>
            }
        }.collect { println(<span class="hljs-string">"flatMapLatest: <span class="hljs-variable">$it</span>"</span>) }
        <span class="hljs-comment">// 只输出 3 的最新结果</span>
    }
}
</code></pre>
<h2 data-id="heading-3">2. 实战场景分析</h2>
<h3 data-id="heading-4">场景一：搜索自动补全</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">SearchViewModel</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> searchQuery = MutableStateFlow(<span class="hljs-string">""</span>)
    
    <span class="hljs-comment">// 使用 flatMapLatest：用户连续输入时取消之前的请求</span>
    <span class="hljs-keyword">val</span> searchResults = searchQuery
        .debounce(<span class="hljs-number">300</span>) <span class="hljs-comment">// 防抖</span>
        .filter { it.length &gt;= <span class="hljs-number">2</span> }
        .flatMapLatest { query -&gt;
            flow {
                emit(SearchState.Loading)
                <span class="hljs-keyword">try</span> {
                    <span class="hljs-keyword">val</span> results = api.searchAutocomplete(query)
                    emit(SearchState.Success(results))
                } <span class="hljs-keyword">catch</span> (e: Exception) {
                    emit(SearchState.Error(e))
                }
            }
        }
        .stateIn(viewModelScope, SharingStarted.WhileSubscribed(), SearchState.Idle)
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onQueryChanged</span><span class="hljs-params">(query: <span class="hljs-type">String</span>)</span></span> {
        searchQuery.value = query
    }
}

<span class="hljs-comment">// 错误使用 flatMap 的情况：所有请求都会完成，可能导致结果显示错乱</span>
<span class="hljs-keyword">val</span> wrongResults = searchQuery
    .flatMap { query -&gt; <span class="hljs-comment">// 错误！应该用 flatMapLatest</span>
        api.searchAutocompleteFlow(query)
    }
</code></pre>
<h3 data-id="heading-5">场景二：位置更新</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">LocationTracker</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> locationUpdates = locationProvider.getUpdates()
    
    <span class="hljs-comment">// 使用 flatMap：每个位置都要上传，顺序重要</span>
    <span class="hljs-keyword">val</span> uploadStatus = locationUpdates
        .filter { it.accuracy &lt; <span class="hljs-number">50</span> } <span class="hljs-comment">// 只处理高精度位置</span>
        .conflate() <span class="hljs-comment">// 合并位置更新，避免过快</span>
        .flatMap { location -&gt;
            flow {
                <span class="hljs-keyword">try</span> {
                    <span class="hljs-keyword">val</span> response = uploadToServer(location)
                    emit(UploadResult.Success(location.id, response))
                } <span class="hljs-keyword">catch</span> (e: Exception) {
                    emit(UploadResult.Failure(location.id, e))
                }
            }
        }
        .<span class="hljs-keyword">catch</span> { e -&gt; emit(UploadResult.NetworkError(e)) }
    
    <span class="hljs-comment">// 使用 flatMapLatest：只关心最新位置的周边搜索</span>
    <span class="hljs-keyword">val</span> nearbyPlaces = locationUpdates
        .flatMapLatest { location -&gt;
            placesApi.getNearbyPlaces(location.lat, location.lng)
        }
}
</code></pre>
<h3 data-id="heading-6">场景三：文件上传队列</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">FileUploadManager</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> uploadQueue = MutableSharedFlow&lt;FileData&gt;()
    
    <span class="hljs-comment">// 使用 flatMap + buffer：并发上传但限制并发数</span>
    <span class="hljs-keyword">val</span> uploadProgress = uploadQueue
        .flatMapMerge(concurrency = <span class="hljs-number">3</span>) { file -&gt; <span class="hljs-comment">// 限制3个并发</span>
            uploadFileFlow(file)
        }
        .shareIn(ioScope, SharingStarted.Lazily)
    
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">uploadFileFlow</span><span class="hljs-params">(file: <span class="hljs-type">FileData</span>)</span></span>: Flow&lt;UploadStatus&gt; = flow {
        emit(UploadStatus.Progress(file.id, <span class="hljs-number">0</span>))
        
        <span class="hljs-keyword">val</span> chunks = splitIntoChunks(file)
        chunks.forEachIndexed { index, chunk -&gt;
            api.uploadChunk(file.id, chunk)
            <span class="hljs-keyword">val</span> progress = ((index + <span class="hljs-number">1</span>) / chunks.size.toFloat() * <span class="hljs-number">100</span>).toInt()
            emit(UploadStatus.Progress(file.id, progress))
        }
        
        emit(UploadStatus.Completed(file.id))
    }
    
    <span class="hljs-comment">// 使用 flatMapLatest：用户取消上传时立即停止</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">uploadWithCancel</span><span class="hljs-params">()</span></span>: Flow&lt;UploadStatus&gt; {
        <span class="hljs-keyword">val</span> cancelSignal = MutableStateFlow(<span class="hljs-literal">false</span>)
        
        <span class="hljs-keyword">return</span> uploadQueue
            .flatMapLatest { file -&gt;
                <span class="hljs-keyword">if</span> (cancelSignal.value) {
                    emptyFlow()
                } <span class="hljs-keyword">else</span> {
                    uploadFileFlow(file)
                }
            }
    }
}
</code></pre>
<h2 data-id="heading-7">3. 常见陷阱与解决方案</h2>
<h3 data-id="heading-8">陷阱一：资源泄漏</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 错误：flatMapLatest 取消时资源未清理</span>
flow.flatMapLatest { id -&gt;
    flow {
        <span class="hljs-keyword">val</span> connection = openDatabaseConnection() <span class="hljs-comment">// 可能泄漏！</span>
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">val</span> <span class="hljs-keyword">data</span> = connection.query(id)
            emit(<span class="hljs-keyword">data</span>)
        } <span class="hljs-keyword">finally</span> {
            connection.close() <span class="hljs-comment">// 必须清理</span>
        }
    }
}

<span class="hljs-comment">// 正确：使用 cancellable 操作或清理资源</span>
flow.flatMapLatest { id -&gt;
    callbackFlow {
        <span class="hljs-keyword">val</span> connection = openDatabaseConnection()
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">val</span> <span class="hljs-keyword">data</span> = connection.query(id)
            send(<span class="hljs-keyword">data</span>)
            awaitClose()
        } <span class="hljs-keyword">finally</span> {
            connection.close()
        }
    }
}
</code></pre>
<h3 data-id="heading-9">陷阱二：状态不一致</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 错误：状态更新可能被取消，导致不一致</span>
<span class="hljs-keyword">var</span> currentState = State.IDLE

flow.flatMapLatest {
    currentState = State.LOADING <span class="hljs-comment">// 可能执行但后续被取消</span>
    apiCallFlow(it).onCompletion {
        currentState = State.IDLE <span class="hljs-comment">// 可能不会执行</span>
    }
}

<span class="hljs-comment">// 正确：使用状态流</span>
<span class="hljs-keyword">val</span> state = MutableStateFlow(State.IDLE)

flow.flatMapLatest {
    state.value = State.LOADING
    apiCallFlow(it)
        .<span class="hljs-keyword">catch</span> { e -&gt; 
            state.value = State.ERROR(e)
            emptyFlow() 
        }
        .onCompletion { 
            <span class="hljs-keyword">if</span> (it == <span class="hljs-literal">null</span>) state.value = State.IDLE 
        }
}
</code></pre>
<h3 data-id="heading-10">陷阱三：背压处理不当</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 错误：没有处理背压，可能内存溢出</span>
highFrequencyFlow
    .flatMapLatest { <span class="hljs-comment">// 仍然可能快速发射</span>
        heavyOperationFlow(it)
    }

<span class="hljs-comment">// 正确：添加背压策略</span>
highFrequencyFlow
    .conflate() <span class="hljs-comment">// 合并中间值</span>
    .flatMapLatest {
        heavyOperationFlow(it)
    }

<span class="hljs-comment">// 或限制并发</span>
highFrequencyFlow
    .flatMapMerge(concurrency = <span class="hljs-number">1</span>) { <span class="hljs-comment">// 限制为顺序执行</span>
        heavyOperationFlow(it)
    }
</code></pre>
<h3 data-id="heading-11">陷阱四：异常处理缺失</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 错误：异常会使整个流终止</span>
flow.flatMapLatest {
    flow { 
        <span class="hljs-keyword">if</span> (it.isEmpty()) <span class="hljs-keyword">throw</span> IllegalArgumentException()
        emit(process(it))
    }
}

<span class="hljs-comment">// 正确：妥善处理异常</span>
flow.flatMapLatest {
    flow {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">if</span> (it.isEmpty()) <span class="hljs-keyword">throw</span> IllegalArgumentException()
            emit(Result.Success(process(it)))
        } <span class="hljs-keyword">catch</span> (e: Exception) {
            emit(Result.Failure(e))
        }
    }
}
</code></pre>
<h2 data-id="heading-12">4. 性能优化技巧</h2>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 1. 合并操作减少开销</span>
searchQuery
    .debounce(<span class="hljs-number">300</span>)
    .distinctUntilChanged() <span class="hljs-comment">// 避免重复查询</span>
    .flatMapLatest { query -&gt;
        api.search(query)
            .retry(<span class="hljs-number">2</span>) <span class="hljs-comment">// 重试机制</span>
            .timeout(<span class="hljs-number">5000</span>) <span class="hljs-comment">// 超时</span>
    }

<span class="hljs-comment">// 2. 使用 shareIn 避免重复订阅</span>
<span class="hljs-keyword">val</span> sharedFlow = sourceFlow
    .flatMapLatest { expensiveOperation(it) }
    .shareIn(
        scope = viewModelScope,
        started = SharingStarted.WhileSubscribed(<span class="hljs-number">5000</span>),
        replay = <span class="hljs-number">1</span>
    )

<span class="hljs-comment">// 3. 适当使用 buffer</span>
flow
    .buffer(Channel.UNLIMITED) <span class="hljs-comment">// 根据场景选择</span>
    .flatMapLatest { <span class="hljs-comment">/* ... */</span> }
</code></pre>
<h2 data-id="heading-13">5. 选择指南</h2>



































<table><thead><tr><th>场景特征</th><th>推荐操作符</th><th>理由</th></tr></thead><tbody><tr><td>需处理所有输入，顺序重要</td><td><code>flatMapConcat</code></td><td>保持顺序，无并发</td></tr><tr><td>需处理所有输入，顺序不重要</td><td><code>flatMapMerge</code></td><td>并发处理，提高效率</td></tr><tr><td>只需最新结果，可取消旧操作</td><td><code>flatMapLatest</code></td><td>避免无效计算</td></tr><tr><td>有限并发控制</td><td><code>flatMapMerge</code> with concurrency</td><td>控制资源使用</td></tr><tr><td>冷流转换</td><td><code>transform</code></td><td>更轻量级的转换</td></tr></tbody></table>
<h2 data-id="heading-14">总结</h2>
<ol>
<li><strong>flatMapLatest 适合响应式 UI 交互</strong>（搜索、点击防抖），可避免陈旧数据</li>
<li><strong>flatMapMerge 适合并行任务处理</strong>（批量上传、并发请求），提高吞吐量</li>
<li><strong>flatMapConcat 适合顺序敏感操作</strong>（文件分片上传、数据库事务）</li>
<li><strong>始终考虑资源清理</strong>，特别是在可取消的操作中</li>
<li><strong>合理处理背压</strong>，根据场景选择 buffer、conflate 等策略</li>
<li><strong>统一异常处理</strong>，避免流意外终止</li>
</ol>
<p>正确选择 flatMap 变体可以显著提升应用性能和用户体验，特别是在处理异步数据流时。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[OpenAI最新发布年度重磅报告《2025年企业人工智能状况报告》：ChatGPT企业版消息量同比增长约8倍]]></title>    <link>https://juejin.cn/post/7588745319400816640</link>    <guid>https://juejin.cn/post/7588745319400816640</guid>    <pubDate>2025-12-29T01:55:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588745319400816640" data-draft-id="7588507284953235471" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="OpenAI最新发布年度重磅报告《2025年企业人工智能状况报告》：ChatGPT企业版消息量同比增长约8倍"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-29T01:55:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="青梅主码"/> <meta itemprop="url" content="https://juejin.cn/user/2277843825604222"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            OpenAI最新发布年度重磅报告《2025年企业人工智能状况报告》：ChatGPT企业版消息量同比增长约8倍
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2277843825604222/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    青梅主码
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T01:55:46.000Z" title="Mon Dec 29 2025 01:55:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>你好，我是<strong>杰哥</strong>。</p>
<p>2025年底，<strong>OpenAI</strong>发布了年度重磅报告《<strong>The State of Enterprise AI 2025 Report</strong>》（《<strong>2025年企业人工智能状况报告</strong>》）。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e8105dc1561a40b58461e8f937071566~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2S5qKF5Li756CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767578145&amp;x-signature=CNMA%2Bd0a6OyBtu42RCv2Os%2ByR6E%3D" alt="" loading="lazy"/></p>
<p>这份报告基于超过 100 万企业客户的使用数据（全部匿名聚合处理）和近 9000 名员工的调研，真实展现了当下企业AI的应用现状。报告指出，虽然消费级 AI 早已火热，但真正能创造巨大经济价值的，还是企业内部的深度应用。如今，企业 AI 正从实验阶段进入规模化落地，<strong>AI</strong> 不再是“锦上添花”，而是成为核心基础设施。</p>
<p>报告提炼出<strong>四大关键发现</strong>，直击当前企业 AI 的真实脉络：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3dc26f632eaf4fe9ae32ac3eaca100b4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2S5qKF5Li756CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767578145&amp;x-signature=uu3Io%2FCAXbPZcM%2F3Z2vUSKfKs2g%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0">1. 使用规模快速扩大，工作流整合更深</h2>
<p>过去一年，企业AI使用强度大幅提升。<strong>ChatGPT</strong> 企业版消息量同比增长约 <strong>8倍</strong>，<strong>API</strong>推理token消耗量人均增长 <strong>320倍</strong>。企业座席数超过 700万，<strong>ChatGPT Enterprise</strong>座席同比增长约 <strong>9倍</strong>。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cce34d814cc14db1a0c8d890b6ab1ff7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2S5qKF5Li756CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767578145&amp;x-signature=ExmsvRBTG5d1noEC6RmSGB6pKg4%3D" alt="" loading="lazy"/></p>
<p>特别值得注意的是，<strong>Custom GPTs</strong>和<strong>Projects</strong>功能让AI更贴合企业需求。这些可自定义的工具，能加载公司知识库、连接内部系统，帮助员工执行重复的多步骤任务。今年，<strong>Custom GPTs</strong>周活跃用户增长约<strong>19倍</strong>，约<strong>20%<strong>的企业消息通过它们处理。一些公司如</strong>BBVA</strong>已部署超<strong>4000个</strong>自定义GPT，形成内部AI工具生态。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/577f09b6af094ba6b3a8b322598a8c94~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2S5qKF5Li756CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767578145&amp;x-signature=VEIcV1W6%2FDD9U4tL9sIUbBW0xpQ%3D" alt="" loading="lazy"/></p>
<p>开发者侧，<strong>API</strong>调用也在爆发。超<strong>9000家</strong>组织处理超 100亿 token，近<strong>200家</strong>超过万亿 token。新模型<strong>Codex</strong>在代码生成、调试等端到端任务上表现亮眼，过去六周周活跃用户翻倍，消息量增长约 <strong>50</strong>%。</p>
<h2 data-id="heading-1">2. 员工实实在在感受到生产力提升</h2>
<p>调研显示，<strong>75%<strong>的员工认为使用AI提升了工作速度或质量。平均每活跃日节省</strong>40-60分钟</strong>，数据科学、工程、沟通等岗位节省更多，可达<strong>60-80分钟</strong>。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/870671349e984668a41e5c6263a4383e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2S5qKF5Li756CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767578145&amp;x-signature=m%2BrxYmZFe%2F7B9eqYG2bs2eyk3TA%3D" alt="" loading="lazy"/></p>
<p>具体到职能：</p>
<ul>
<li><strong>87%</strong> 的IT员工表示IT问题解决更快</li>
<li><strong>85%</strong> 的市场和产品人员表示营销活动执行更快</li>
<li><strong>75%</strong> 的HR表示员工参与度提升</li>
<li><strong>73%</strong> 的工程师表示代码交付更快</li>
</ul>
<p>更令人振奋的是，AI正在打破传统角色边界。<strong>75%</strong> 的员工表示能完成以前不会的新任务，如编程、数据分析、自动化等。非技术岗位的编码相关消息过去六个月平均增长 <strong>36</strong>%。</p>
<p>使用越深入，收益越大。深度使用高级功能（如深度研究、图像生成）的员工，节省时间更多——每周省超<strong>10小时</strong>的群体，消耗的智能量是省时<strong>0小时</strong>群体的<strong>8倍</strong>。</p>
<h2 data-id="heading-2">3. 增长全球加速，行业差异明显</h2>
<p>企业AI采用已遍地开花。过去12个月，中位行业客户增长超<strong>6倍</strong>，最快的是科技行业<strong>11倍</strong>，其次医疗<strong>8倍</strong>、制造<strong>7倍</strong>。规模最大的仍是专业服务、金融、科技行业。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f1f87e86de0746d2b4572c005d4f629e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2S5qKF5Li756CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767578145&amp;x-signature=yMoBJLFuR6GGwN8k7nEj8kqIBPY%3D" alt="" loading="lazy"/></p>
<p><strong>API</strong>使用场景也在多元化。科技公司多用于产品内助手和搜索，专业服务偏好编码工具，金融则从客服支持切入。非科技公司<strong>API</strong>使用同比增长<strong>5倍</strong>。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9fbd00a56d754ef1ac874255eaff7c59~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2S5qKF5Li756CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767578145&amp;x-signature=75LeVSy0rg4bif3UhhDhFqN2e%2Bo%3D" alt="" loading="lazy"/></p>
<p>国际增长尤其亮眼。过去半年，国际<strong>API</strong>客户增长超<strong>70%</strong>。澳大利亚、巴西、荷兰、法国等国付费企业客户增长超<strong>143%</strong>，远高于全球平均。日本已成为美国之外最大的企业<strong>API</strong>市场。</p>
<h2 data-id="heading-3">4. 领先者与落后者差距正在拉大</h2>
<p>前沿员工（使用强度前 5%）发送消息量是中位员工的<strong>6倍</strong>，在数据分析任务上甚至达<strong>16倍</strong>。编码任务差距最大，达<strong>17倍</strong>。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6734326ddd9f472e9fb2acf9e79a0ef5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2S5qKF5Li756CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767578145&amp;x-signature=l4zP%2BulWCzIxpbQI35zjUitx6I4%3D" alt="" loading="lazy"/></p>
<p>企业层面，前沿公司每座席消息量是中位公司的<strong>2倍</strong>，对<strong>Custom GPTs</strong>的使用更是<strong>7倍</strong>。许多企业虽已接入AI，但尚未用上最强大功能——月活跃用户中，<strong>19%</strong> 从未用过数据分析工具，<strong>14%</strong> 从未用推理功能。</p>
<p>报告通过多个案例，展示了领先企业的实际收益：</p>
<ul>
<li><strong>Intercom</strong>用实时<strong>API</strong>打造语音AI客服，延迟降低 <strong>48</strong>%，全自动化解决率达<strong>53</strong>%。</li>
<li><strong>Lowe’s</strong>部署<strong>Mylow</strong>助手，线上转化率翻倍，店内客服满意度提升<strong>200个基点</strong>。</li>
<li><strong>Indeed</strong>用AI匹配求职与岗位，申请启动率提升 <strong>20</strong>%，招聘成功率提升 <strong>13</strong>%。</li>
<li><strong>BBVA</strong>法律AI助手每年自动化超<strong>9000</strong>查询，节省相当于<strong>3个</strong>全职员工。</li>
<li><strong>Oscar Health</strong>医疗聊天机器人即时解答福利问题，无需人工介入比例达<strong>39</strong>%。</li>
<li><strong>Moderna</strong>用AI压缩药品目标产品档案（<strong>TPP</strong>）制定时间，从数周缩短到数小时。</li>
</ul>
<h2 data-id="heading-4">结语：深度决定未来</h2>
<p><strong>OpenAI</strong>首席经济学家Ronnie Chatterji在序言中指出，未来企业AI将向更强性能、更好组织上下文理解、复杂工作流委托方向演进。领先企业已开始系统整合数据、标准化工作流、加强变革管理，而多数企业仍有巨大追赶空间。</p>
<p>这份报告传递的核心信息很清晰：<strong>AI</strong> 正在重塑企业工作方式，但收益与使用深度成正比。领先者正把 AI 变成营收增长和竞争优势的引擎，而观望者可能被甩得更远。对于中国企业来说，这既是警醒，也是机会——现在行动，越早越能占据有利位置。</p>
<p>关注公众号【AI信息风向】后，回复 <strong>666</strong>，即可获取这份 AI 行业报告。</p>
<p>AI 技术正以前所未有的速度发展，它将如何塑造我们的未来？让我们拭目以待。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从 0 到 1：前端 CI/CD 实战（第二篇：用Docker 部署 GitLab）]]></title>    <link>https://juejin.cn/post/7588464673285439515</link>    <guid>https://juejin.cn/post/7588464673285439515</guid>    <pubDate>2025-12-29T01:59:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588464673285439515" data-draft-id="7587024296884043826" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从 0 到 1：前端 CI/CD 实战（第二篇：用Docker 部署 GitLab）"/> <meta itemprop="keywords" content="前端,自动化运维"/> <meta itemprop="datePublished" content="2025-12-29T01:59:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="饼饼饼"/> <meta itemprop="url" content="https://juejin.cn/user/8451822992855"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从 0 到 1：前端 CI/CD 实战（第二篇：用Docker 部署 GitLab）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/8451822992855/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    饼饼饼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T01:59:13.000Z" title="Mon Dec 29 2025 01:59:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>前言</strong></h2>
<p>在完成云服务器的 <strong>Docker</strong> 环境搭建后，下一步就是部署整个 CI/CD 体系中最核心的组件 —— <strong>GitLab</strong>。本篇将继续通过 Docker 的方式，在云服务器上部署一套<strong>稳定、可维护</strong>的 GitLab 服务，涵盖容器运行、端口映射、数据持久化以及虚拟内存配置等关键步骤。完成本篇后，你将拥有一套真正可以长期使用的 GitLab 服务，为后续接入 CI/CD 流水线打下基础。</p>
<h2 data-id="heading-1"><strong>Docker Compose 简介</strong></h2>
<p>虽然可以直接使用 docker run 启动 GitLab，但实际操作中命令会非常冗长，而且端口、数据目录、环境变量等配置分散在命令行里，后期维护成本很高。为了解决这些问题，本文使用 <strong>Docker Compose</strong> 来统一管理容器。</p>
<p>Docker Compose 允许将一个或多个 docker run 命令的配置集中写入一个 <strong>YAML 文件</strong>，一次性定义镜像、端口映射、数据挂载、环境变量和重启策略。这样做有三个明显好处：</p>
<ul>
<li><strong>配置集中</strong>：所有关键配置都在一个文件中，清晰可读</li>
<li><strong>易于维护</strong>：修改配置只需要改文件，不必反复敲命令</li>
<li><strong>可复现性强</strong>：换服务器或重建环境，只需一条命令即可恢复</li>
</ul>
<p>常用命令如下：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 启动服务（后台运行）</span>
docker compose up -d

<span class="hljs-comment"># 停止并删除容器</span>
docker compose down

<span class="hljs-comment"># 查看服务运行状态</span>
docker compose ps
</code></pre>
<p>相比直接使用 docker run，Docker Compose 更适合<strong>长期运行的基础服务</strong>，也是实际生产环境中的常见选择。</p>
<hr/>
<h2 data-id="heading-2"><strong>GitLab 容器目录规划</strong></h2>
<h3 data-id="heading-3"><strong>规划宿主机目录</strong></h3>
<p>在部署 GitLab 之前提前规划宿主机目录，并不是为了“规范好看”，而是为了<strong>数据安全、后期维护和可迁移性</strong>。GitLab 属于典型的有状态服务，如果不将配置、日志和数据明确挂载到宿主机，一旦容器被删除或服务器重装，仓库和用户数据都会一起丢失。清晰的目录结构也是生产环境中的常见做法，后续无论是升级、迁移服务器，还是接入 GitLab Runner 和其他基础服务，都可以直接复用这套结构，一次规划，长期受益。</p>
<h3 data-id="heading-4"><strong>创建目录</strong></h3>
<p>本文将 GitLab 安装在宿主机的 /apps/infra/gitlab 目录下，用于存放 GitLab 的所有相关数据，并按 <strong>配置、日志、数据</strong> 三类进行拆分。</p>
<p>在服务器上执行以下命令创建目录：</p>
<pre><code class="hljs language-arduino" lang="arduino">mkdir -p /apps/infra/gitlab/{config,logs,data}
</code></pre>
<p>目录说明如下：</p>
<ul>
<li>config：GitLab 核心配置文件目录（如 gitlab.rb）</li>
<li>logs：GitLab 运行日志目录，用于排查启动和运行问题</li>
<li>data：仓库、数据库、CI 产物等核心数据目录</li>
</ul>
<p>后续将在 docker-compose.yml 中，将这三个目录分别挂载到容器内对应位置，实现数据持久化。</p>
<hr/>
<h2 data-id="heading-5"><strong>编写 docker-compose.yml</strong></h2>
<h3 data-id="heading-6"><strong>基础服务定义</strong></h3>
<p>在 docker-compose.yml 中，image、container_name 和 restart 是最基础但也最重要的配置。</p>
<ul>
<li>image 使用 GitLab 官方社区版 gitlab/gitlab-ce，功能完整、社区成熟，对中小规模团队和学习环境已经完全足够</li>
<li>container_name 明确指定为 gitlab，避免 Docker 自动生成随机名称，方便后续查看状态和排查问题</li>
<li>restart: always 用于保证容器在异常退出或服务器重启后能够自动拉起，是长期运行服务的必选项</li>
</ul>
<p>示例配置如下：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">gitlab:</span>
  <span class="hljs-attr">image:</span> <span class="hljs-string">gitlab/gitlab-ce:latest</span>
  <span class="hljs-attr">container_name:</span> <span class="hljs-string">gitlab</span>
  <span class="hljs-attr">restart:</span> <span class="hljs-string">always</span>
</code></pre>
<h3 data-id="heading-7"><strong>端口映射设计思路</strong></h3>
<p>GitLab 对外主要提供三类访问能力：<strong>Web 页面、HTTPS 服务以及 Git SSH</strong>，因此端口映射需要提前规划。</p>
<ul>
<li>80：HTTP 访问 GitLab Web 页面</li>
<li>443：预留 HTTPS 端口，后续接入证书时无需改配置</li>
<li>2222：宿主机 SSH 端口，映射到容器内的 22</li>
</ul>
<p>将 SSH 端口映射为 2222，一方面可以避免与宿主机自身 SSH 服务冲突，另一方面也能降低被自动化脚本扫描的概率。需要注意的是，端口映射修改后，GitLab 内部的 SSH 端口配置也必须同步修改，否则会导致 git clone 或 git push 失败。</p>
<p>示例配置如下：</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">ports:</span>
  - <span class="hljs-string">"80:80"</span>
  - <span class="hljs-string">"443:443"</span>
  - <span class="hljs-string">"2222:22"</span>
</code></pre>
<blockquote>
<p>提醒：2222 端口默认未放行，需要在云服务器安全组中手动放行。</p>
</blockquote>
<h3 data-id="heading-8"><strong>volumes 挂载与数据持久化</strong></h3>
<p>GitLab 是一个<strong>强依赖数据的有状态服务</strong>，数据持久化不是可选项，而是必选项。本文中将 GitLab 的数据按用途拆分为三类并分别挂载：</p>
<ul>
<li>/etc/gitlab：核心配置目录</li>
<li>/var/log/gitlab：运行日志目录</li>
<li>/var/opt/gitlab：仓库、数据库和 CI 产物等核心数据</li>
</ul>
<p>配置如下：</p>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-symbol">volumes:</span>
  - <span class="hljs-regexp">/apps/infra</span><span class="hljs-regexp">/gitlab/config</span><span class="hljs-symbol">:/etc/gitlab</span>
  - <span class="hljs-regexp">/apps/infra</span><span class="hljs-regexp">/gitlab/logs</span><span class="hljs-symbol">:/var/log/gitlab</span>
  - <span class="hljs-regexp">/apps/infra</span><span class="hljs-regexp">/gitlab/data</span><span class="hljs-symbol">:/var/opt/gitlab</span>
</code></pre>
<p>只要宿主机目录仍然存在，即使容器被删除，也可以通过重新启动容器快速恢复整套 GitLab 服务。</p>
<h3 data-id="heading-9"><strong>资源限制与性能取舍</strong></h3>
<p>默认情况下 Docker 不会限制容器的资源使用，而 GitLab 在启动和运行过程中会主动占用可用资源。如果不加限制，在 4G 或 8G 的服务器上很容易导致系统响应变慢甚至不可用。</p>
<p>本文中通过 deploy.resources.limits 对资源进行限制：</p>
<ul>
<li>CPU：2.5 核</li>
<li>内存：3200M</li>
</ul>
<p>示例配置：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">deploy:</span>
  <span class="hljs-attr">resources:</span>
    <span class="hljs-attr">limits:</span>
      <span class="hljs-attr">cpus:</span> <span class="hljs-string">"2.5"</span>
      <span class="hljs-attr">memory:</span> <span class="hljs-string">"3200M"</span>
</code></pre>
<p>资源限制的目的不是压榨性能，而是<strong>保证服务器整体稳定性</strong>，这对学习环境和中小团队来说更加重要。</p>
<h3 data-id="heading-10"><strong>共享内存与稳定性</strong></h3>
<p>GitLab 内部包含数据库和缓存组件，对共享内存（shm）比较敏感。Docker 默认的共享内存较小，容易引发一些难以定位的异常问题，因此建议显式设置：</p>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-symbol">shm_size:</span> <span class="hljs-comment">'1gb'</span>
</code></pre>
<hr/>
<h2 data-id="heading-11"><strong>配置并启动 GitLab 容器</strong></h2>
<p>在 /apps/infra/gitlab 目录下创建 docker-compose.yml 文件，并写入完整配置内容后，执行以下命令启动服务：</p>
<pre><code class="hljs language-yml" lang="yml"><span class="hljs-attr">services:</span>
  <span class="hljs-attr">gitlab:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">gitlab/gitlab-ce:latest</span>
    <span class="hljs-attr">container_name:</span> <span class="hljs-string">gitlab</span>
    <span class="hljs-attr">restart:</span> <span class="hljs-string">always</span>
    <span class="hljs-comment"># 填写真实云服务器ip 地址</span>
    <span class="hljs-attr">hostname:</span> <span class="hljs-string">"xxx.xxx.195.160"</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"80:80"</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"443:443"</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"2222:22"</span>
    <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">/apps/infra/gitlab/config:/etc/gitlab</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">/apps/infra/gitlab/logs:/var/log/gitlab</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">/apps/infra/gitlab/data:/var/opt/gitlab</span>
    <span class="hljs-attr">deploy:</span>
      <span class="hljs-attr">resources:</span>
        <span class="hljs-attr">limits:</span>
          <span class="hljs-attr">cpus:</span> <span class="hljs-string">"2.5"</span>
          <span class="hljs-attr">memory:</span> <span class="hljs-string">"3200M"</span>
    <span class="hljs-attr">shm_size:</span> <span class="hljs-string">'1gb'</span>
    <span class="hljs-attr">environment:</span>
      <span class="hljs-attr">GITLAB_OMNIBUS_CONFIG:</span> <span class="hljs-string">|
        # 填写真实云服务器ip 地址
        external_url "http://xxx.xxx.195.160"
        gitlab_rails['gitlab_shell_ssh_port'] = 2222
        unicorn['worker_processes'] = 1
        sidekiq['concurrency'] = 2
        prometheus_monitoring['enable'] = false
        registry['enable'] = false
        node_exporter['enable'] = false
        gitlab_exporter['enable'] = false
        mattermost['enable'] = false
</span>
</code></pre>
<p>运行</p>
<pre><code class="hljs">docker compose up -d
</code></pre>
<p>首次启动会拉取镜像并初始化 GitLab，通常需要 3～5 分钟。完成后，在浏览器中访问：</p>
<pre><code class="hljs language-arduino" lang="arduino">http:<span class="hljs-comment">//&lt;你的服务器 IP&gt;</span>
</code></pre>
<p>即可看到 GitLab 登录页面。</p>
<p>如果发现页面加载缓慢或服务器内存占用接近上限，这是 GitLab 初始化阶段的正常现象，下一节将通过配置虚拟内存进行优化。</p>
<hr/>
<h2 data-id="heading-12"><strong>配置虚拟内存（Swap）</strong></h2>
<p>在内存较小的服务器上，为 GitLab 配置 Swap 可以显著提升稳定性。</p>
<pre><code class="hljs language-bash" lang="bash">fallocate -l 8G /swapfile
<span class="hljs-built_in">chmod</span> 600 /swapfile
mkswap /swapfile
swapon /swapfile
</code></pre>
<p>验证是否生效：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-built_in">free</span> -h
</code></pre>
<p>当出现 Swap: 8.0Gi 证明配置成功</p>
<p>设置开机自动挂载：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">echo</span> <span class="hljs-string">'/swapfile swap swap defaults 0 0'</span> &gt;&gt; /etc/fstab
</code></pre>
<hr/>
<h2 data-id="heading-13"><strong>GitLab 初始化</strong></h2>
<p>确认容器运行状态：</p>
<pre><code class="hljs">docker ps
</code></pre>
<p>获取初始 root 密码：</p>
<pre><code class="hljs language-bash" lang="bash">docker <span class="hljs-built_in">exec</span> -it gitlab grep <span class="hljs-string">'Password:'</span> /etc/gitlab/initial_root_password
</code></pre>
<p>成功登录后点击右上角头像 &gt; Edit profile &gt; Password 中修改初始密码</p>
<hr/>
<h2 data-id="heading-14"><strong>本篇小结</strong></h2>
<p>本篇完成了使用 Docker Compose 在云服务器上部署 GitLab 的全过程，包括目录规划、资源限制、数据持久化以及虚拟内存优化。通过这些配置，即使在低配服务器上，也可以稳定运行一套可长期使用的 GitLab 服务。</p>
<p>在下一篇中，我们将部署 <strong>GitLab Runner</strong>，把这套 GitLab 真正变成一条可以自动构建和发布的 CI/CD 流水线。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[颠覆认知！遥感船舶检测“越深越好”是误区？LiM-YOLO证明“少即是多”]]></title>    <link>https://juejin.cn/post/7588445332772241462</link>    <guid>https://juejin.cn/post/7588445332772241462</guid>    <pubDate>2025-12-29T02:00:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588445332772241462" data-draft-id="7588411503121203236" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="颠覆认知！遥感船舶检测“越深越好”是误区？LiM-YOLO证明“少即是多”"/> <meta itemprop="keywords" content="算法,计算机视觉,深度学习"/> <meta itemprop="datePublished" content="2025-12-29T02:00:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="CoovallyAIHub"/> <meta itemprop="url" content="https://juejin.cn/user/2461151071843739"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            颠覆认知！遥感船舶检测“越深越好”是误区？LiM-YOLO证明“少即是多”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2461151071843739/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    CoovallyAIHub
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T02:00:03.000Z" title="Mon Dec 29 2025 02:00:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>随着全球海上交通的迅猛增长，利用高分辨率遥感图像进行自动化海上监视，已成为保障海洋安全、管理交通流量和监控非法活动不可或缺的手段。船舶检测作为遥感图像分析的核心任务之一，不仅关乎海上运输效率，更直接影响到海上救援、国防安全和环境保护。然而，卫星图像中的船舶目标具有尺度极小、形态狭长、背景复杂等挑战，传统目标检测模型在此场景下往往“力不从心”。</p>
<p>今天，我们要介绍一篇来自韩国研究团队的精彩论文《LiM-YOLO: Less is More with Pyramid Level Shift and Normalized Auxiliary Branch for Ship Detection in Optical Remote Sensing Imagery》，它直击当前船舶检测模型的痛点，提出了一种“少即是多”的全新架构，不仅在精度上实现突破，还大幅降低了模型复杂度和计算成本。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/42ef265eb1da43529410dfca372a9205~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767578403&amp;x-signature=AlVbdRs4Ka0aHh4a%2BPWZRK858qk%3D" alt="图片1.png" loading="lazy"/></p>
<blockquote>
<p><strong>论文链接：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2512.09700v1" target="_blank" title="https://arxiv.org/abs/2512.09700v1" ref="nofollow noopener noreferrer">arxiv.org/abs/2512.09…</a></p>
<p><strong>代码链接：</strong> <strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fegshkim%2FLiM-YOLO" target="_blank" title="https://github.com/egshkim/LiM-YOLO" ref="nofollow noopener noreferrer">github.com/egshkim/LiM…</a></strong></p>
</blockquote>
<h2 data-id="heading-0"><strong>为什么船舶检测如此困难？</strong></h2>
<p>卫星图像中的船舶目标具有以下典型特征：</p>
<ul>
<li><strong>尺度极小：</strong> 在千米级高空拍摄的图像中，船舶可能只有几十甚至几个像素宽。</li>
<li><strong>形态狭长：</strong> 船舶多为长条形，宽高比极大，容易被背景噪声淹没。</li>
<li><strong>背景复杂：</strong> 海面波纹、云层、岛屿等干扰因素多，极易造成误检或漏检。</li>
</ul>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ef6bb949f4224738bc130699b50cd2ca~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767578403&amp;x-signature=MIn3okDT0xsH%2B3POJKED%2BprC9fc%3D" alt="图片2.png" loading="lazy"/></p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1845f87c84954d2f91ace80bd2426771~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767578403&amp;x-signature=SUQPwV%2FWWKPxbOuDCqP5kXOgb8E%3D" alt="图片3.png" loading="lazy"/></p>
<p>主流的YOLO架构（从v3到v12）普遍采用P3、P4、P5三层特征金字塔进行多尺度预测，其对应的下采样步长分别为8、16、32。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f4cb1f073f1745809e59736e03877525~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767578403&amp;x-signature=zOmos4%2BK%2FHnz%2F%2FDnKzsBNli7FhA%3D" alt="图片4.png" loading="lazy"/></p>
<p>P3 (步长8)：负责小目标，保留较多细节。</p>
<p>P5 (步长32)：负责大目标，感受野大，语义信息强。</p>
<p>问题就出在这个P5层（步长32）上。论文通过对四大遥感船舶数据集（SODA-A, DOTA-v1.5, FAIR1M, ShipRSImageNet）的统计发现：</p>
<p>船舶的平均短轴长度仅有17.34像素。</p>
<p>对于步长32的P5层，平均船舶的短轴占据网格比ρ_minor = 17.34/32 ≈ 0.54 &lt; 1。</p>
<p>这意味着什么？“平均大小”的船舶在P5层的特征图上，甚至无法占满一个网格单元！ 其空间特征被严重稀释，与背景噪声混在一起，导致模型难以学习和定位。这就是所谓的空间特征稀释和亚像素混叠问题。</p>
<p>另一方面，P5层拥有巨大的理论感受野（超过2800像素），远超标准输入尺寸（如1024x1024）。其有效感受野也高达1112像素，足以覆盖整个图像的全局上下文。而P4层的有效感受野（约1024像素）已经可以做到这一点。因此，P5层在带来巨大计算量的同时，其提供的额外语义信息增益微乎其微，反而引入了过多的背景噪声。</p>
<p><strong>结论：用于检测大目标的P5层，对于以中小型船舶为主的海事遥感检测任务，是结构冗余且有害的。</strong></p>
<h2 data-id="heading-1"><strong>LiM-YOLO的核心创新：从“越多越好”到“少即是多”</strong></h2>
<p>LiM-YOLO的设计理念源于对四大数据集（SODA-A、DOTA-v1.5、FAIR1M-V2.0、ShipRSImageNet-V1）中船舶形态的统计分析。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1bc8d67b44ef4ab78b4cfb8a0fad7f40~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767578403&amp;x-signature=c3kk5L2yP2rjkQbeh0CHPQSqOyE%3D" alt="图片5.png" loading="lazy"/></p>
<p>面对上述问题，常见的改进思路是“做加法”：在P3-P5的基础上，增加更浅的P2层（步长4） 来捕捉小目标细节，或者增加更深的P6层来获取更大感受野。但这只是“扩充”，并未解决P5层固有的冗余和噪声问题。</p>
<p>LiM-YOLO则反其道而行之，提出了 “金字塔层级移位策略”：</p>
<p>1.做减法，去冗余：完全移除P5层的骨干网络和检测头，省去不必要的深层计算和背景噪声。</p>
<p>2.做加法，补精度：引入高分辨率的P2层（步长4） 作为新的检测起点。</p>
<p>3.新配置：将检测金字塔从传统的 P3-P4-P5 重构为 P2-P3-P4。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c1cd609a1e624036a04552cef7127922~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767578403&amp;x-signature=EPXjwKfROKZ2VqREOomdToFuKbE%3D" alt="图片6.png" loading="lazy"/></p>
<p>这一移一换，效果显著：</p>
<ul>
<li><strong>对于小目标：</strong> P2的步长为4，即使对于数据集中95%分位数下最小的船舶（短轴约4像素），也能满足ρ_minor ≥ 1，确保其空间形态能被有效采样，满足奈奎斯特采样定理，避免了特征混叠。</li>
<li><strong>对于计算效率：</strong> 移除庞大的P5模块，参数量大幅下降（从约5900万减少到约2100万），计算量（GFLOPs）也得到优化。</li>
<li><strong>对于特征质量：</strong> P4层足以提供全局语义信息，同时避免了P5层过大的感受野引入的无关背景干扰。</li>
</ul>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/47962d0adc6141f5a086e837878d6efc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767578403&amp;x-signature=vUKEnQB3cPwsY%2BdPe511q2qiINU%3D" alt="图片7.png" loading="lazy"/></p>
<p>另一大创新：GN-CBLinear</p>
<p>YOLOv9引入了可编程梯度信息（PGI） 和辅助可逆分支来缓解深层网络的信息瓶颈。这个辅助分支通常使用简单的1x1卷积（CBLinear），以保持线性、避免信息损失。</p>
<p>然而，在训练高分辨率遥感图像时，由于GPU内存限制，常常只能使用极小的批量大小。在这种“微批量”情况下，标准的批量归一化（BN） 会因统计量估计不准而失效，导致训练不稳定。</p>
<p>LiM-YOLO提出了 GN-CBLinear模块，用组归一化（GN） 替换BN。GN不依赖批量大小，将通道分成组进行归一化，完美解决了微批量下的训练不稳定问题，确保了辅助分支能提供稳健的梯度流。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/501b25ab0f884897bf173fd667351c8f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767578403&amp;x-signature=veOnKPPCbMAJQxVl5TYAKtCDMJ4%3D" alt="图片8.png" loading="lazy"/></p>
<h2 data-id="heading-2"><strong>实验结果：精度与效率的双重胜利</strong></h2>
<p>论文在四个极具挑战性的数据集上进行了充分验证：</p>
<p><strong>消融实验：</strong> 证明了“P2-P4”配置（同时加P2和减P5）远优于单纯“加P2”或“减P4”等策略，在各项指标上全面超越基线模型（YOLOv9-E）。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4d45b9480e714f6fb8a486547ae46aaa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767578403&amp;x-signature=S0t9DreHt6oQUcTAVZtHSD%2BJyuI%3D" alt="图片9.png" loading="lazy"/></p>
<p><strong>SOTA对比：</strong> 与YOLOv8x, YOLOv10x, YOLOv12x, RT-DETR-X等当前最先进模型相比，LiM-YOLO以最少的参数量（21.16M），取得了最高的综合检测精度（mAP50-95: 0.600），真正实现了“轻量化”与“高精度”的帕累托最优。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/db94f11b1b374d0c8871e8aa8e657176~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767578403&amp;x-signature=ZqxDuvXTTK8EjSvjmDkIQdGI%2FiI%3D" alt="图片10.png" loading="lazy"/></p>
<p><strong>细粒度分类：</strong> 在包含24类船舶的ShipRSImageNet数据集上，LiM-YOLO对小尺度类别（如摩托艇、渔船）的检测提升尤为显著，同时保持了整体分类精度的领先。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2f0b8c6b02994a939640f76317618b21~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767578403&amp;x-signature=Nr6kWXIBeniyaVAU2pi6i8aqGlc%3D" alt="图片11.png" loading="lazy"/></p>
<p>Coovally平台上汇聚了<strong>400+开源数据集</strong>，不仅包含有关于船舶检测，还覆盖图像分类、目标检测、语义分割等主流任务场景。你找不到的数据，或许就在这里。一键调用即可投入训练，彻底告别四处搜寻、下载和格式化数据的繁琐。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/42d93f5473184e71be918ca71a892667~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767578403&amp;x-signature=bIpi0v%2FqGfE0jyDR3BVe0YyybA4%3D" alt="模型数据集.GIF" loading="lazy"/></p>
<ul>
<li><strong>一站式模型训练：</strong> 在平台上，你可以一键调用YOLO、Transformer等热门架构，快速进行模型训练与验证。平台的设计实现了极致的简化：</li>
<li><strong>免环境配置：</strong> 直接调用预置的PyTorch、TensorFlow等深度学习框架。</li>
<li><strong>免复杂调参：</strong> 内置自动化训练流程，即使初学者也能轻松上手，产出可用模型。</li>
<li><strong>高性能算力支持：</strong> 底层提供分布式训练加速，大幅缩短实验周期。</li>
<li><strong>无缝部署：</strong> 训练完成的模型可直接导出，或通过API快速接入您的业务系统。</li>
</ul>
<p><strong>&gt;&gt; 点击阅读原文，立即体验 Coovally &lt;&lt;</strong></p>
<p>Coovally平台还可以直接查看“实验日志”。提供直观的<strong>可视化训练界面，清晰设置参数，监控训练过程（Loss, mAP等指标实时可视化）。</strong></p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eb13c8bed277432fac0e99666a5ef72f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767578403&amp;x-signature=iejZ4xox%2B3Z%2BmPUiGxITt8xAP1Y%3D" alt="图片12.png" loading="lazy"/></p>
<p><strong>可视化效果：</strong> 定性结果显示，LiM-YOLO能够成功检测出基线模型漏检的密集、狭窄小型船舶，验证了其在空间细节保留上的优势。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8d539ce9a71141f4b460f687ecf53e5e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767578403&amp;x-signature=HPTChrvZkG%2Bxh3AYFZGfiPqS0Sk%3D" alt="图片13.png" loading="lazy"/></p>
<h2 data-id="heading-3"><strong>总结与启示</strong></h2>
<p>LiM-YOLO的成功给了我们一个重要启示：在特定领域（如遥感）应用深度学习时，盲目追随通用架构或单纯增加模型深度/宽度并非最佳路径。通过对目标数据进行深入统计分析，进行“对症下药”式的结构重设计，往往能以更小的代价获得更大的性能提升。</p>
<p>这项研究为解决光学遥感图像中船舶检测的尺度与形态挑战提供了一个高效、实用的解决方案，为未来面向特定任务的神经网络架构优化多了一个参考与方向。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java 21新特性实战：5个必学的性能优化技巧让你的应用提速40%]]></title>    <link>https://juejin.cn/post/7588402359451205672</link>    <guid>https://juejin.cn/post/7588402359451205672</guid>    <pubDate>2025-12-29T00:17:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588402359451205672" data-draft-id="7588456115882410019" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java 21新特性实战：5个必学的性能优化技巧让你的应用提速40%"/> <meta itemprop="keywords" content="后端,前端,人工智能"/> <meta itemprop="datePublished" content="2025-12-29T00:17:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿橙的百宝箱"/> <meta itemprop="url" content="https://juejin.cn/user/1638743356481367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java 21新特性实战：5个必学的性能优化技巧让你的应用提速40%
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1638743356481367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿橙的百宝箱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T00:17:17.000Z" title="Mon Dec 29 2025 00:17:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>Java 21新特性实战：5个必学的性能优化技巧让你的应用提速40%</strong></h2>
<h2 data-id="heading-1">引言</h2>
<p>Java 21作为最新的LTS（长期支持）版本，不仅延续了Java平台的稳定性，还引入了许多令人振奋的新特性。这些特性不仅仅是语法糖，更在性能优化方面带来了显著提升。本文将深入探讨Java 21中的5个关键性能优化技巧，通过实际代码示例和基准测试数据，展示如何通过这些技术让应用的性能提升高达40%。无论你是开发高并发系统还是优化现有代码，这些技巧都将为你提供强大的工具支持。</p>
<h2 data-id="heading-2">主体</h2>
<h3 data-id="heading-3">1. 虚拟线程（Virtual Threads）：告别阻塞I/O的性能瓶颈</h3>
<p>虚拟线程是Java 21中最引人注目的特性之一，旨在解决传统平台线程在高并发场景下的资源消耗问题。虚拟线程由JVM管理，而非操作系统，因此可以轻松创建数百万个线程而不会导致系统崩溃。</p>
<h4 data-id="heading-4">实战示例</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">try</span> (<span class="hljs-type">var</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> Executors.newVirtualThreadPerTaskExecutor()) {
    IntStream.range(<span class="hljs-number">0</span>, <span class="hljs-number">10_000</span>).forEach(i -&gt; {
        executor.submit(() -&gt; {
            Thread.sleep(Duration.ofSeconds(<span class="hljs-number">1</span>));
            <span class="hljs-keyword">return</span> i;
        });
    });
}
</code></pre>
<h4 data-id="heading-5">性能收益</h4>
<ul>
<li><strong>资源占用降低</strong>：与传统线程相比，虚拟线程的内存占用减少90%以上。</li>
<li><strong>吞吐量提升</strong>：在高并发I/O密集型应用中，吞吐量可提升30%-40%。</li>
</ul>
<h3 data-id="heading-6">2. Sequenced Collections：高效的有序集合操作</h3>
<p>Java 21引入了<code>SequencedCollection</code>、<code>SequencedSet</code>和<code>SequencedMap</code>接口，为有序集合提供了统一的操作方式。这些接口新增了如<code>addFirst</code>、<code>addLast</code>等方法，避免了手动实现双向操作的性能开销。</p>
<h4 data-id="heading-7">实战示例</h4>
<pre><code class="hljs language-java" lang="java">SequencedCollection&lt;String&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
list.addFirst(<span class="hljs-string">"Java"</span>); <span class="hljs-comment">// O(1) for LinkedArrayList</span>
list.addLast(<span class="hljs-string">"21"</span>);
<span class="hljs-type">String</span> <span class="hljs-variable">first</span> <span class="hljs-operator">=</span> list.getFirst(); <span class="hljs-comment">// Faster than list.get(0)</span>
</code></pre>
<h4 data-id="heading-8">性能收益</h4>
<ul>
<li><strong>减少中间操作</strong>：直接访问首尾元素的时间复杂度从O(n)降至O(1)。</li>
<li><strong>代码简洁性</strong>：避免手动维护头尾指针，减少潜在的性能损耗。</li>
</ul>
<h3 data-id="heading-9">3. String Templates（预览）：高性能字符串拼接</h3>
<p>字符串拼接是许多应用的热点代码区域。Java 21的字符串模板（预览特性）不仅提升了可读性，还通过底层优化减少了不必要的内存分配。</p>
<h4 data-id="heading-10">实战示例</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> <span class="hljs-string">"Java"</span>;
<span class="hljs-type">int</span> <span class="hljs-variable">version</span> <span class="hljs-operator">=</span> <span class="hljs-number">21</span>;
<span class="hljs-type">String</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> STR.<span class="hljs-string">"Welcome to \{name} \{version}!"</span>;
</code></pre>
<h4 data-id="heading-11">性能收益</h4>
<ul>
<li><strong>内存分配优化</strong>：比传统的<code>StringBuilder</code>或<code>+</code>操作节省10%-15%的内存开销。</li>
<li><strong>可读性与性能兼得</strong>：避免手工拼接的繁琐和潜在错误。</li>
</ul>
<h3 data-id="heading-12">4. Record Patterns：简化数据解构与模式匹配</h3>
<p>Record Patterns是模式匹配的进一步扩展，特别适用于解析复杂数据结构时的性能优化。通过直接解构Record对象，减少了反射和临时对象创建的消耗。</p>
<h4 data-id="heading-13">实战示例</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">record</span> <span class="hljs-title class_">Point</span><span class="hljs-params">(<span class="hljs-type">int</span> x, <span class="hljs-type">int</span> y)</span> {}

<span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">printSum</span><span class="hljs-params">(Object obj)</span> {
    <span class="hljs-keyword">if</span> (obj <span class="hljs-keyword">instanceof</span> <span class="hljs-title function_">Point</span><span class="hljs-params">(<span class="hljs-type">int</span> x, <span class="hljs-type">int</span> y)</span>) {
        System.out.println(x + y); <span class="hljs-comment">// Direct access to fields</span>
    }
}
</code></pre>
<h4 data-id="heading-14">性能收益</h4>
<ul>
<li><strong>减少反射调用</strong>：直接访问字段比传统反射快50%以上。</li>
<li><strong>代码简洁性</strong>：避免冗长的类型检查和强制转换逻辑。</li>
</ul>
<h3 data-id="heading-15">5. Generational ZGC：低延迟垃圾回收再升级</h3>
<p>ZGC在Java 21中进一步升级为分代式（Generational ZGC），通过区分年轻代和老年代对象优化回收策略。这对于短生命周期对象的回收效率有显著提升。</p>
<h4 data-id="heading-16">配置方式</h4>
<pre><code class="hljs language-bash" lang="bash">java -XX:+UseZGC -XX:+ZGenerational ...
</code></pre>
<h4 data-id="heading-17">性能收益</h4>
<ul>
<li><strong>停顿时间缩短</strong>：年轻代回收停顿时间降低至亚毫秒级。</li>
<li><strong>吞吐量提升</strong>：整体GC吞吐量提高20%-30%，尤其适合大内存应用。</li>
</ul>
<h2 data-id="heading-18">Benchmark对比与验证</h2>
<p>为了验证上述优化的实际效果，我们使用JMH对以下场景进行测试（测试环境：JDK 21, MacBook Pro M1, 16GB RAM）：</p>

























<table><thead><tr><th>Scenario</th><th>Throughput (ops/ms)</th><th>Improvement</th></tr></thead><tbody><tr><td>Virtual Threads vs Platform Threads</td><td>1200 vs  850</td><td>+41%</td></tr><tr><td>SequencedCollection vs Traditional</td><td>9500 vs  7000</td><td>+35%</td></tr><tr><td>Generational ZGC vs Non-Generational</td><td>550 vs  420</td><td>+31%</td></tr></tbody></table>
<p>数据表明，综合应用这些技术后，典型Web应用的响应时间可减少40%以上。</p>
<p>##总结</p>
<p>Java21通过虚拟线程、分代ZGC等创新将运行时效率推向新高度本文介绍的五大技巧覆盖了从并发编程到垃圾回收的关键路径合理运用它们不仅能大幅提升性能还能降低资源消耗建议开发者结合自身场景逐步引入这些特性并通过监控工具持续验证效果</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[除了 ELK、Loki，你还应该知道的日志收集方式：Syslog]]></title>    <link>https://juejin.cn/post/7588680081327161386</link>    <guid>https://juejin.cn/post/7588680081327161386</guid>    <pubDate>2025-12-29T00:18:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588680081327161386" data-draft-id="7588093282531868724" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="除了 ELK、Loki，你还应该知道的日志收集方式：Syslog"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-29T00:18:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="风象南"/> <meta itemprop="url" content="https://juejin.cn/user/2524134428655159"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            除了 ELK、Loki，你还应该知道的日志收集方式：Syslog
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2524134428655159/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    风象南
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T00:18:10.000Z" title="Mon Dec 29 2025 00:18:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在微服务、云原生时代，提到日志收集，大家脑子里跳出来的第一个方案往往是 ELK、EFK、Loki等。这些方案功能强大，但部署复杂、资源消耗也不小。</p>
<p>其实还有一套久经考验的日志收集方案，它诞生于 80 年代，至今仍在各行各业默默工作——它就是 Syslog。</p>
<p>今天聊聊这个"老古董"，为什么它还没被淘汰，以及在什么场景下它可能是你的最佳选择。</p>
<h2 data-id="heading-0">什么是 Syslog</h2>
<p>Syslog 是一种用于在 IP 网络中转发日志消息的标准协议。最早由 BSD Unix 实现，后来经过多次标准化，目前主流遵循的是 <strong>RFC5424</strong> 标准（2009年发布）。</p>
<p>一个典型的 Syslog 消息长这样：</p>
<pre><code class="hljs language-csharp" lang="csharp">&lt;<span class="hljs-number">34</span>&gt;<span class="hljs-number">1</span> <span class="hljs-number">2023</span><span class="hljs-number">-12</span><span class="hljs-number">-29</span>T10:<span class="hljs-number">30</span>:<span class="hljs-number">00.123</span>Z server01 sshd <span class="hljs-number">1234</span> - [meta sessionId=<span class="hljs-string">"abc123"</span>] Failed password <span class="hljs-keyword">for</span> root <span class="hljs-keyword">from</span> <span class="hljs-number">192.168</span><span class="hljs-number">.1</span><span class="hljs-number">.100</span>
</code></pre>
<p>看起来有点复杂，拆解一下就清楚了：</p>























































<table><thead><tr><th>部分</th><th>说明</th><th>示例值</th></tr></thead><tbody><tr><td><code>&lt;PRI&gt;</code></td><td>优先级（设施+级别）</td><td><code>&lt;34&gt;</code></td></tr><tr><td><code>VERSION</code></td><td>协议版本</td><td><code>1</code></td></tr><tr><td><code>TIMESTAMP</code></td><td>时间戳</td><td><code>2023-12-29T10:30:00.123Z</code></td></tr><tr><td><code>HOSTNAME</code></td><td>主机名</td><td><code>server01</code></td></tr><tr><td><code>APP-NAME</code></td><td>应用名称</td><td><code>sshd</code></td></tr><tr><td><code>PROCID</code></td><td>进程 ID</td><td><code>1234</code></td></tr><tr><td><code>MSGID</code></td><td>消息 ID</td><td><code>-</code>（未设置）</td></tr><tr><td><code>STRUCTURED-DATA</code></td><td>结构化数据</td><td><code>[meta sessionId="abc123"]</code></td></tr><tr><td><code>MSG</code></td><td>实际消息内容</td><td><code>Failed password for root...</code></td></tr></tbody></table>
<p><strong>优先级（PRI）</strong> 这个字段比较特殊，它由两部分组成：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">PRI</span> = Facility * <span class="hljs-number">8</span> + Severity
</code></pre>
<p><strong>设施（Facility）</strong> 表示消息来源，常见的有：</p>
<ul>
<li><code>0</code> - kern（内核）</li>
<li><code>1</code> - user（用户级应用）</li>
<li><code>3</code> - daemon（系统守护进程）</li>
<li><code>16</code> - local0 到 <code>23</code> - local7（本地自定义）</li>
</ul>
<p><strong>严重级别（Severity）</strong> 表示消息严重程度：</p>
<ul>
<li><code>0</code> - Emergency（系统不可用）</li>
<li><code>4</code> - Warning（警告）</li>
<li><code>6</code> - Informational（信息）</li>
<li><code>7</code> - Debug（调试）</li>
</ul>
<p>比如 <code>&lt;34&gt;</code> 表示：<code>34 = 4*8 + 2</code>，即 Facility=4（auth），Severity=2（Critical）。</p>
<h2 data-id="heading-1">Syslog 的特点与优势</h2>
<h4 data-id="heading-2">第一，它足够简单</h4>
<p>Syslog 的核心就是一个 UDP 协议（当然也支持 TCP），发一条消息过去就完事了。客户端实现非常简单，几行代码就能搞定：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.net.DatagramPacket;
<span class="hljs-keyword">import</span> java.net.DatagramSocket;
<span class="hljs-keyword">import</span> java.net.InetAddress;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SyslogClient</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendSyslog</span><span class="hljs-params">(String message, <span class="hljs-type">int</span> facility, <span class="hljs-type">int</span> severity)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">int</span> <span class="hljs-variable">priority</span> <span class="hljs-operator">=</span> facility * <span class="hljs-number">8</span> + severity;
        <span class="hljs-type">String</span> <span class="hljs-variable">syslogMsg</span> <span class="hljs-operator">=</span> <span class="hljs-string">"&lt;"</span> + priority + <span class="hljs-string">"&gt;"</span> + message;

        <span class="hljs-keyword">try</span> (<span class="hljs-type">DatagramSocket</span> <span class="hljs-variable">socket</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DatagramSocket</span>()) {
            <span class="hljs-type">byte</span>[] data = syslogMsg.getBytes();
            <span class="hljs-type">InetAddress</span> <span class="hljs-variable">address</span> <span class="hljs-operator">=</span> InetAddress.getByName(<span class="hljs-string">"192.168.1.10"</span>);
            <span class="hljs-type">DatagramPacket</span> <span class="hljs-variable">packet</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DatagramPacket</span>(data, data.length, address, <span class="hljs-number">514</span>);
            socket.send(packet);
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception {
        sendSyslog(<span class="hljs-string">"Application started successfully"</span>, <span class="hljs-number">1</span>, <span class="hljs-number">6</span>);
    }
}
</code></pre>
<p>服务器端也不复杂，Linux 系统自带的 <code>rsyslog</code>、<code>syslog-ng</code> 都能直接接收和存储。</p>
<h4 data-id="heading-3">第二，标准化程度高</h4>
<p>网络设备（路由器、交换机、防火墙）几乎都支持 Syslog。你想收集设备日志？不用装 agent，配置一下 Syslog 服务器地址就行：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># Cisco 设备配置示例</span>
logging host 192.168.1.10
logging <span class="hljs-built_in">trap</span> warnings
</code></pre>
<p>这种"开箱即用"的兼容性，是 ELK、Loki 这些方案很难做到的。</p>
<h4 data-id="heading-4">第三，整体资源消耗低</h4>
<p><strong>客户端轻量</strong>：Syslog 客户端实现非常简单，几行代码就能发送日志，对设备资源消耗极小。这使得边缘设备、IoT 设备、嵌入式系统都可以轻松接入。</p>
<p><strong>服务端相对轻量</strong>：相比 ELK 需要多台服务器组成的集群，Syslog 服务端（如 rsyslog）资源消耗要低得多。单台 2核4G 的服务器就能处理每秒数千条日志，对于中小规模环境完全够用。</p>
<h2 data-id="heading-5">Syslog 的典型适用场景</h2>
<h4 data-id="heading-6">场景一：网络设备日志集中管理</h4>
<p><strong>典型需求：</strong></p>
<ul>
<li>收集路由器、交换机、防火墙的配置变更日志</li>
<li>监控网络设备的连接状态、流量异常</li>
<li>审计网络访问记录</li>
</ul>
<p><strong>为什么选 Syslog：</strong></p>
<ul>
<li>网络设备原生支持，无需部署 agent</li>
<li>设备数量通常几十到几百台，Syslog 足够应对</li>
<li>日志格式相对固定，不需要复杂的解析逻辑</li>
</ul>
<p><strong>实践建议：</strong> 按设备类型分类存储</p>
<pre><code class="hljs language-bash" lang="bash">/var/log/remote/routers/          <span class="hljs-comment"># 路由器日志</span>
/var/log/remote/switches/         <span class="hljs-comment"># 交换机日志</span>
/var/log/remote/firewalls/        <span class="hljs-comment"># 防火墙日志</span>
</code></pre>
<h4 data-id="heading-7">场景二：合规审计与长期日志留存</h4>
<p><strong>典型需求：</strong></p>
<ul>
<li>金融、政务等行业要求日志长期留存</li>
<li>需要记录用户敏感操作：登录、数据修改、权限变更等</li>
<li>多系统、多应用的日志需要统一收集和存储</li>
<li>合规检查时需要能快速调取历史日志</li>
</ul>
<p><strong>为什么选 Syslog：</strong></p>
<ul>
<li>文本格式便于归档到冷存储（如 NAS、对象存储）</li>
<li>可以按系统/业务线分别存储，便于审计调取</li>
<li>日志格式简单、可读性强，审计人员可以直接查看</li>
</ul>
<p><strong>实践建议：</strong></p>
<ol>
<li>按业务线或系统分类存储</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">/var/log/remote/trading-system/      <span class="hljs-comment"># 交易系统日志</span>
/var/log/remote/user-center/         <span class="hljs-comment"># 用户中心日志</span>
/var/log/remote/payment-gateway/     <span class="hljs-comment"># 支付网关日志</span>
</code></pre>
<ol start="2">
<li>在日志中增加审计关键字段</li>
</ol>
<pre><code class="hljs language-java" lang="java">log.info(<span class="hljs-string">"AUDIT | userId:{} | action:{} | resource:{} | result:{}"</span>,
    userId, <span class="hljs-string">"UPDATE_ORDER"</span>, <span class="hljs-string">"order-12345"</span>, <span class="hljs-string">"SUCCESS"</span>);
</code></pre>
<h4 data-id="heading-8">场景三：边缘计算与 IoT 设备</h4>
<p><strong>典型需求：</strong></p>
<ul>
<li>分布在各地的边缘网关、IoT 设备需要上报日志</li>
<li>网络环境不稳定，需要可靠的传输机制</li>
<li>设备资源有限（CPU、内存、存储）</li>
</ul>
<p><strong>为什么选 Syslog：</strong></p>
<ul>
<li>协议简单，对设备资源消耗极小</li>
<li>支持 TCP/RELP 保证传输可靠性</li>
<li>中心服务器资源要求低</li>
</ul>
<h4 data-id="heading-9">场景四：传统应用系统改造</h4>
<p><strong>典型需求：</strong></p>
<ul>
<li>老旧应用（如单体应用、C/S 架构）需要接入日志系统</li>
<li>应用代码改动成本要低</li>
<li>不能引入复杂的依赖</li>
</ul>
<p><strong>为什么选 Syslog：</strong></p>
<ul>
<li>改动最小，只需要替换日志框架的 appender</li>
<li>不需要应用本身安装任何组件</li>
<li>对应用性能影响几乎可以忽略</li>
</ul>
<p><strong>为什么选 Syslog：</strong></p>
<ul>
<li>Syslog 单向通信，只需开放一个端口（通常 514）</li>
<li>可以在各云环境部署轻量级转发器</li>
<li>中心服务器可以部署在任意位置</li>
</ul>
<h2 data-id="heading-10">实战：搭建一个 Syslog 服务器</h2>
<p>以 Ubuntu 为例，使用 <code>rsyslog</code> 搭建日志服务器：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装 rsyslog（通常系统已预装）</span>
sudo apt install rsyslog

<span class="hljs-comment"># 编辑配置文件</span>
sudo vim /etc/rsyslog.conf
</code></pre>
<p>取消以下行的注释（启用 UDP 和 TCP 接收）：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 提供 UDP 接收</span>
module(<span class="hljs-attr">load</span>=<span class="hljs-string">"imudp"</span>)
input(<span class="hljs-attr">type</span>=<span class="hljs-string">"imudp"</span> port=<span class="hljs-string">"514"</span>)

<span class="hljs-comment"># 提供 TCP 接收</span>
module(<span class="hljs-attr">load</span>=<span class="hljs-string">"imtcp"</span>)
input(<span class="hljs-attr">type</span>=<span class="hljs-string">"imtcp"</span> port=<span class="hljs-string">"514"</span>)
</code></pre>
<p>配置日志存储规则：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 根据主机名分别存储</span>
<span class="hljs-variable">$template</span> DynamicFile,<span class="hljs-string">"/var/log/remote/%HOSTNAME%/%<span class="hljs-variable">$YEAR</span>%-%<span class="hljs-variable">$MONTH</span>%-%<span class="hljs-variable">$DAY</span>%.log"</span>

*.* ?DynamicFile
</code></pre>
<p>重启服务：</p>
<pre><code class="hljs language-bash" lang="bash">sudo systemctl restart rsyslog
</code></pre>
<p>现在，客户端就可以向这台服务器发送日志了：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 使用 logger 命令测试</span>
logger -n 192.168.1.10 -P 514 <span class="hljs-string">"Hello from client"</span>
</code></pre>
<p>日志会保存到 <code>/var/log/remote/client-hostname/2023-12-29.log</code>。</p>
<hr/>
<h2 data-id="heading-11">如何分析和使用</h2>
<p>实际上，日志收集只是第一步，后续的分析和使用才是关键。</p>
<h4 data-id="heading-12">方式一：命令行快速分析（最适合运维人员）</h4>
<p>Syslog 日志是纯文本，Linux 原生工具完全够用。</p>
<p><strong>1. grep 快速检索</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查找错误日志</span>
grep -i <span class="hljs-string">"error"</span> /var/log/remote/*/*.<span class="hljs-built_in">log</span>

<span class="hljs-comment"># 查找特定时间段的日志</span>
grep <span class="hljs-string">"2023-12-29T10:"</span> /var/log/remote/*/*.<span class="hljs-built_in">log</span>

<span class="hljs-comment"># 查找特定 IP 的访问记录</span>
grep <span class="hljs-string">"192.168.1.100"</span> /var/log/remote/firewalls/*.<span class="hljs-built_in">log</span>
</code></pre>
<p><strong>2. awk 提取关键字段</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 提取所有登录失败记录</span>
awk /Failed password/ {<span class="hljs-built_in">print</span> <span class="hljs-variable">$1</span>, <span class="hljs-variable">$2</span>, <span class="hljs-variable">$NF</span>}<span class="hljs-string">' /var/log/remote/*.log

# 统计每种错误类型的出现次数
awk -F'</span>ERROR: <span class="hljs-string">' '</span>{<span class="hljs-built_in">print</span> <span class="hljs-variable">$2</span>}<span class="hljs-string">' /var/log/remote/*.log | sort | uniq -c | sort -rn
</span></code></pre>
<p><strong>3. sed 批量处理</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 去除重复日志</span>
<span class="hljs-built_in">sort</span> /var/log/remote/app.log | <span class="hljs-built_in">uniq</span> &gt; app-unique.log

<span class="hljs-comment"># 提取 JSON 格式的结构化数据</span>
sed -n <span class="hljs-string">'s/.*User action: \(.*\)/\1/p'</span> /var/log/remote/app.log | jq .
</code></pre>
<p><strong>4. 实时监控（类似 tail -f）</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 实时监控所有主机的 error 日志</span>
<span class="hljs-built_in">tail</span> -f /var/log/remote/*/*.<span class="hljs-built_in">log</span> | grep --line-buffered -i error

<span class="hljs-comment"># 使用 multitail 同时监控多个文件</span>
multitail /var/log/remote/server01/*.<span class="hljs-built_in">log</span> /var/log/remote/server02/*.<span class="hljs-built_in">log</span>
</code></pre>
<h4 data-id="heading-13">方式二：使用 Syslog 可视化工具</h4>
<p><strong>1. Graylog</strong></p>
<p>Graylog 是一个开源的日志管理平台，支持通过 syslog 协议收集、解析和分析日志数据，专注于日志收集和分析。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装 Graylog（MongoDB + Elasticsearch + Graylog Server）</span>
docker run --name mongo -d mongo:4
docker run --name elasticsearch -d elasticsearch:7
docker run --<span class="hljs-built_in">link</span> mongo --<span class="hljs-built_in">link</span> elasticsearch -p 9000:9000 -d graylog/graylog
</code></pre>
<p>配置 Syslog 输入后，就可以在 Web 界面进行：</p>
<ul>
<li>全文搜索</li>
<li>字段过滤</li>
<li>仪表盘可视化</li>
<li>告警规则配置</li>
</ul>
<p><strong>2. 已有 ELK？Filebeat Syslog 模块</strong></p>
<p>如果你已经在用 ELK，可以直接用 Filebeat 的 Syslog 模块，无需额外部署：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># filebeat.yml</span>
<span class="hljs-attr">filebeat.inputs:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">type:</span> <span class="hljs-string">syslog</span>
    <span class="hljs-attr">protocol.udp:</span>
      <span class="hljs-attr">host:</span> <span class="hljs-string">"0.0.0.0:514"</span>
    <span class="hljs-attr">max_message_size:</span> <span class="hljs-string">10MiB</span>

<span class="hljs-attr">output.elasticsearch:</span>
  <span class="hljs-attr">hosts:</span> [<span class="hljs-string">"localhost:9200"</span>]
</code></pre>
<h4 data-id="heading-14">方式三：搭建轻量级日志查询平台</h4>
<p>如果你不想引入重型组件，可以自己搭建一个简单的查询平台。</p>
<p>lnav 是一个命令行工具，但提供了类似 IDE 的日志浏览体验：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装</span>
apt install lnav

<span class="hljs-comment"># 使用：自动解析日志格式，支持时间线、过滤、高亮</span>
lnav /var/log/remote/*/*.<span class="hljs-built_in">log</span>
</code></pre>
<p>功能包括：</p>
<ul>
<li>自动着色和高亮</li>
<li>时间轴视图</li>
<li>SQL 查询支持</li>
<li>日志格式自动识别</li>
</ul>
<h2 data-id="heading-15">Spring Boot 应用如何集成 Syslog</h2>
<p>Java 应用集成 Syslog 也很简单，最常用的是 <strong>logback-syslog</strong> 或者 <strong>log4j-syslog-appender</strong>。</p>
<p>以 Logback 为例，添加依赖：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>net.logstash.logback<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>logstash-logback-encoder<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>7.4<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p>配置 <code>logback-spring.xml</code>：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">appender</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"SYSLOG"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"ch.qos.logback.classic.net.SyslogAppender"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">syslogHost</span>&gt;</span>192.168.1.10<span class="hljs-tag">&lt;/<span class="hljs-name">syslogHost</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">port</span>&gt;</span>514<span class="hljs-tag">&lt;/<span class="hljs-name">port</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">facility</span>&gt;</span>LOCAL1<span class="hljs-tag">&lt;/<span class="hljs-name">facility</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">suffixPattern</span>&gt;</span>%app [%thread] %logger %msg<span class="hljs-tag">&lt;/<span class="hljs-name">suffixPattern</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">appender</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">root</span> <span class="hljs-attr">level</span>=<span class="hljs-string">"INFO"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">appender-ref</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"SYSLOG"</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">consoleAppender</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">root</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span>
</code></pre>
<p>代码里照常使用 Logger：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@RestController</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> {

    <span class="hljs-meta">@GetMapping("/user/{id}")</span>
    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">getUser</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long id)</span> {
        log.info(<span class="hljs-string">"Fetching user by id: {}"</span>, id);
        <span class="hljs-keyword">return</span> userService.getById(id);
    }
}
</code></pre>
<p>所有日志都会自动发送到 Syslog 服务器，不需要任何特殊处理。</p>
<h2 data-id="heading-16">Syslog vs ELK/Loki：如何选择</h2>
<h4 data-id="heading-17">选择Syslog的场景</h4>
<ul>
<li><strong>1. 网络设备日志收集</strong>：路由器、交换机、防火墙等设备原生支持</li>
<li><strong>2. 合规审计场景</strong>：金融、政务行业要求日志长期保存，Syslog 简单可靠</li>
<li><strong>3. 资源受限环境</strong>：边缘计算、嵌入式设备、老旧服务器</li>
<li><strong>4. 简单固定需求</strong>：只需要收集和存储，不需要太复杂的检索分析</li>
<li><strong>5. 低成本优先</strong>：预算有限，需要轻量化的收集方案</li>
</ul>
<h4 data-id="heading-18">选择 ELK/Loki等方案的场景</h4>
<ul>
<li><strong>1. 需要全文搜索</strong>：运维人员要快速定位问题</li>
<li><strong>2. 需要可视化分析</strong>：仪表盘、趋势图、异常检测</li>
<li><strong>3. 大规模微服务</strong>：日志量大，需要分布式存储和处理</li>
<li><strong>4. 需要日志关联</strong>：跨服务的 trace ID 关联分析</li>
<li><strong>5. 实时分析需求</strong>：需要实时监控和告警</li>
</ul>
<p>其实两者可以结合使用。比如用 Syslog 收集设备日志和审计日志（需要长期保存），同时用 Loki 收集应用日志（需要快速检索）。</p>
<hr/>
<h2 data-id="heading-19">一些实用建议</h2>
<h4 data-id="heading-20">1. 使用 TCP</h4>
<p>UDP 虽然快，但不保证送达。网络拥塞时可能丢日志，如需要保证日志发送的可靠性，可使用 TCP 或者 RELP（Reliable Event Logging Protocol）：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 使用 TCP 的配置示例 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">appender</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"SYSLOG_TCP"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"ch.qos.logback.classic.net.SyslogAppender"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">syslogHost</span>&gt;</span>192.168.1.10<span class="hljs-tag">&lt;/<span class="hljs-name">syslogHost</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">port</span>&gt;</span>514<span class="hljs-tag">&lt;/<span class="hljs-name">port</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">facility</span>&gt;</span>LOCAL1<span class="hljs-tag">&lt;/<span class="hljs-name">facility</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">suffixPattern</span>&gt;</span>%app [%thread] %logger %msg<span class="hljs-tag">&lt;/<span class="hljs-name">suffixPattern</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">useExactLine</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">useExactLine</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">appender</span>&gt;</span>
</code></pre>
<h4 data-id="heading-21">2. 做好日志轮转</h4>
<p>Syslog 日志会无限增长，记得配置 <code>logrotate</code>：</p>
<pre><code class="hljs language-bash" lang="bash">/var/log/remote/*/*.<span class="hljs-built_in">log</span> {
    daily
    rotate 30
    compress
    delaycompress
    missingok
    notifempty
    create 0640 syslog syslog
}
</code></pre>
<h4 data-id="heading-22">3. 注意时区问题</h4>
<p>Syslog 协议本身不包含时区信息，RFC5424 要求使用 UTC 时间。如果你的应用部署在不同时区，记得统一时间标准。</p>
<h4 data-id="heading-23">4. 结构化数据可以用 JSON</h4>
<p>RFC5424 支持结构化数据（STRUCTURED-DATA），但格式比较复杂。更实用的做法是直接把 JSON 放在 MSG 字段里：</p>
<pre><code class="hljs language-java" lang="java">log.info(<span class="hljs-string">"User action: {}"</span>, objectMapper.writeValueAsString(Map.of(
    <span class="hljs-string">"userId"</span>, <span class="hljs-number">12345</span>,
    <span class="hljs-string">"action"</span>, <span class="hljs-string">"login"</span>,
    <span class="hljs-string">"ip"</span>, <span class="hljs-string">"192.168.1.100"</span>
)));
</code></pre>
<h4 data-id="heading-24">5. 做好日志分级</h4>
<p>不是所有日志都需要发送到 Syslog 服务器：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 只发送 INFO 及以上级别</span>
&lt;root level=<span class="hljs-string">"INFO"</span>&gt;
    &lt;appender-ref ref=<span class="hljs-string">"SYSLOG"</span> /&gt;
&lt;/root&gt;

<span class="hljs-comment">// DEBUG 日志只输出到本地文件</span>
&lt;logger name=<span class="hljs-string">"com.example"</span> level=<span class="hljs-string">"DEBUG"</span> additivity=<span class="hljs-string">"false"</span>&gt;
    &lt;appender-ref ref=<span class="hljs-string">"FILE"</span> /&gt;
&lt;/logger&gt;
</code></pre>
<h4 data-id="heading-25">6. 考虑日志加密</h4>
<p>Syslog 本身不加密，敏感场景需要使用 TLS：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># rsyslog TLS 配置</span>
module(load=<span class="hljs-string">"gtls"</span>)

<span class="hljs-comment"># 服务器端</span>
input(<span class="hljs-built_in">type</span>=<span class="hljs-string">"imtcp"</span> port=<span class="hljs-string">"6514"</span>)
    action(name=<span class="hljs-string">"tls-input"</span> <span class="hljs-built_in">type</span>=<span class="hljs-string">"omrelp"</span>
           target=<span class="hljs-string">"server.example.com"</span> port=<span class="hljs-string">"6514"</span>
           tls=<span class="hljs-string">"on"</span>
           tls.authMode=<span class="hljs-string">"x509/name"</span>)
</code></pre>
<h2 data-id="heading-26">总结</h2>
<p>Syslog 不是什么高大上的技术，但它胜在简单、稳定、兼容性好。如果你的日志需求不复杂，或者需要对接各类网络设备，Syslog 依然是非常实用的选择。</p>
<p>工具没有银弹，适合的才是最好的。下次做日志方案选型时，不妨把 Syslog 也列入考虑范围。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[回溯算法总结]]></title>    <link>https://juejin.cn/post/7588461466598031411</link>    <guid>https://juejin.cn/post/7588461466598031411</guid>    <pubDate>2025-12-29T00:20:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588461466598031411" data-draft-id="7588146449005953060" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" 回溯算法总结"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2025-12-29T00:20:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SevenCoding"/> <meta itemprop="url" content="https://juejin.cn/user/3261615728242467"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             回溯算法总结
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3261615728242467/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SevenCoding
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T00:20:47.000Z" title="Mon Dec 29 2025 00:20:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">概述</h2>
<p>其实回溯算法和我们常说的 DFS 算法非常类似，本质上就是一种暴力穷举算法。回溯算法和 DFS 算法的细微差别是：回溯算法是在遍历「树枝」，DFS 算法是在遍历「节点」</p>
<p><strong>抽象地说，解决一个回溯问题，实际上就是遍历一棵决策树的过程，树的每个叶子节点存放着一个合法答案。你把整棵树遍历一遍，把叶子节点上的答案都收集起来，就能得到所有的合法答案</strong>。</p>
<p>站在回溯树的一个节点上，你只需要思考 3 个问题：</p>
<p>1、路径：也就是已经做出的选择。</p>
<p>2、选择列表：也就是你当前可以做的选择。</p>
<p>3、结束条件：也就是到达决策树底层，无法再做选择的条件。</p>
<p>代码方面，回溯算法的框架：</p>
<pre><code class="hljs language-java" lang="java">result = []
def <span class="hljs-title function_">backtrack</span><span class="hljs-params">(路径, 选择列表)</span>:
    <span class="hljs-keyword">if</span> 满足结束条件:
        result.add(路径)
        <span class="hljs-keyword">return</span>
    
    <span class="hljs-keyword">for</span> 选择 in 选择列表:
        做选择
        backtrack(路径, 选择列表)
        撤销选择
</code></pre>
<p>for循环就是遍历集合区间，可以理解一个节点有多少个孩子，这个for循环就执行多少次。</p>
<p>backtracking这里自己调用自己，实现递归。</p>
<p><strong>其核心就是 for 循环里面的递归，在递归调用之前「做选择」，在递归调用之后「撤销选择」</strong></p>
<h2 data-id="heading-1">回溯算法解决组合问题</h2>
<p>这里的组合问题 元素无重不可复选</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> {

    List&lt;List&lt;Integer&gt;&gt; res = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedList</span>&lt;&gt;();
    <span class="hljs-comment">// 记录回溯算法的递归路径</span>
    LinkedList&lt;Integer&gt; track = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedList</span>&lt;&gt;();

    <span class="hljs-comment">// 主函数</span>
    <span class="hljs-keyword">public</span> List&lt;List&lt;Integer&gt;&gt; <span class="hljs-title function_">combine</span><span class="hljs-params">(<span class="hljs-type">int</span> n, <span class="hljs-type">int</span> k)</span> {
        backtrack(<span class="hljs-number">1</span>, n, k);
        <span class="hljs-keyword">return</span> res;
    }

    <span class="hljs-keyword">void</span> <span class="hljs-title function_">backtrack</span><span class="hljs-params">(<span class="hljs-type">int</span> start, <span class="hljs-type">int</span> n, <span class="hljs-type">int</span> k)</span> {
        <span class="hljs-comment">// base case</span>
        <span class="hljs-keyword">if</span> (k == track.size()) {
            <span class="hljs-comment">// 遍历到了第 k 层，收集当前节点的值</span>
            res.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedList</span>&lt;&gt;(track));
            <span class="hljs-keyword">return</span>;
        }
        
        <span class="hljs-comment">// 回溯算法标准框架</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> start; i &lt;= n; i++) {
            <span class="hljs-comment">// 选择</span>
            track.addLast(i);
            <span class="hljs-comment">// 通过 start 参数控制树枝的遍历，避免产生重复的子集</span>
            backtrack(i + <span class="hljs-number">1</span>, n, k);
            <span class="hljs-comment">// 撤销选择</span>
            track.removeLast();
        }
    }
}
</code></pre>
<h2 data-id="heading-2">回溯算法解决排列问题</h2>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> {

    List&lt;List&lt;Integer&gt;&gt; res = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedList</span>&lt;&gt;();
    <span class="hljs-comment">// 记录回溯算法的递归路径</span>
    LinkedList&lt;Integer&gt; track = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedList</span>&lt;&gt;();
    <span class="hljs-comment">// track 中的元素会被标记为 true</span>
    <span class="hljs-type">boolean</span>[] used;

    <span class="hljs-comment">/* 主函数，输入一组不重复的数字，返回它们的全排列 */</span>
    <span class="hljs-keyword">public</span> List&lt;List&lt;Integer&gt;&gt; <span class="hljs-title function_">permute</span><span class="hljs-params">(<span class="hljs-type">int</span>[] nums)</span> {
        used = <span class="hljs-keyword">new</span> <span class="hljs-title class_">boolean</span>[nums.length];
        backtrack(nums);
        <span class="hljs-keyword">return</span> res;
    }

    <span class="hljs-comment">// 回溯算法核心函数</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">backtrack</span><span class="hljs-params">(<span class="hljs-type">int</span>[] nums)</span> {
        <span class="hljs-comment">// base case，到达叶子节点</span>
        <span class="hljs-keyword">if</span> (track.size() == nums.length) {
            <span class="hljs-comment">// 收集叶子节点上的值</span>
            res.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedList</span>(track));
            <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-comment">// 回溯算法标准框架</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; nums.length; i++) {
            <span class="hljs-comment">// 已经存在 track 中的元素，不能重复选择</span>
            <span class="hljs-keyword">if</span> (used[i]) {
                <span class="hljs-keyword">continue</span>;
            }
            <span class="hljs-comment">// 做选择</span>
            used[i] = <span class="hljs-literal">true</span>;
            track.addLast(nums[i]);
            <span class="hljs-comment">// 进入下一层回溯树</span>
            backtrack(nums);
            <span class="hljs-comment">// 取消选择</span>
            track.removeLast();
            used[i] = <span class="hljs-literal">false</span>;
        }
    }
}
</code></pre>
<h2 data-id="heading-3">总结</h2>
<p>回溯算法就是个多叉树的遍历问题，关键就是在前序遍历和后序遍历的位置做一些操作，算法框架如下：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">backtrack</span>(<span class="hljs-params">...</span>):
    <span class="hljs-keyword">for</span> 选择 <span class="hljs-keyword">in</span> 选择列表:
        做选择
        backtrack(...)
        撤销选择
</code></pre>
<p><strong>写 <code>backtrack</code> 函数时，需要维护走过的「路径」和当前可以做的「选择列表」，当触发「结束条件」时，将「路径」记入结果集</strong>。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[不再费脑, 写给 AI 爱好者的矩阵 (Matrix) 入门指南]]></title>    <link>https://juejin.cn/post/7588109656042651694</link>    <guid>https://juejin.cn/post/7588109656042651694</guid>    <pubDate>2025-12-29T00:39:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588109656042651694" data-draft-id="7588104741610291210" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="不再费脑, 写给 AI 爱好者的矩阵 (Matrix) 入门指南"/> <meta itemprop="keywords" content="人工智能,AIGC,LLM"/> <meta itemprop="datePublished" content="2025-12-29T00:39:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="印刻君"/> <meta itemprop="url" content="https://juejin.cn/user/572216818014568"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            不再费脑, 写给 AI 爱好者的矩阵 (Matrix) 入门指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/572216818014568/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    印刻君
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T00:39:17.000Z" title="Mon Dec 29 2025 00:39:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好, 我是印刻君. 今天我们来聊 <strong>矩阵 (matrix)</strong>.</p>
<p>矩阵是 AI 背后的数学工具, 图像识别时会用到它, 同类推荐时会用到它, 大模型训练也会用到它. 它让 AI 能够批量处理数据. 如果我们想了解 AI 原理, 了解矩阵很有必要.</p>
<p>这篇文章, 我会以向量为基础, 引出 <strong>矩阵</strong> 的概念, 介绍矩阵的两种理解方式, 以及最常用的四种核心运算.</p>
<blockquote>
<p>不熟悉向量相关概念? 可以看我的文章: <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FThGXnwta1kFgbpqlKozO3A" target="_blank" title="https://mp.weixin.qq.com/s/ThGXnwta1kFgbpqlKozO3A" ref="nofollow noopener noreferrer">不再费脑，写给 AI 爱好者的向量 (Vector) 入门课</a></p>
</blockquote>
<h2 data-id="heading-0">矩阵的两种理解方式</h2>
<h3 data-id="heading-1">1. 给苹果打分: 矩阵是多个向量的组合</h3>
<p>假设你是一家水果店的老板, 想知道一款苹果在大众心中的认可度, 于是你找来了 3 个员工小印, 小刻, 小君, 让他们根据自己的偏好给这款苹果打分 (分数无上限)</p>
<p>每个人的偏好都可以用一个向量表示, 打分过程就是偏好向量与苹果特征向量的计算</p>
<ul>
<li>
<p>小印是 "颜值党", 他挑选苹果只看重颜色, 完全不在乎甜不甜、脆不脆, 他的偏好向量是 (10, 0, 0). 打分结果是:</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mn>10</mn><mo>×</mo><mn>0.9</mn><mo stretchy="false">)</mo><mo>+</mo><mo stretchy="false">(</mo><mn>0</mn><mo>×</mo><mn>5</mn><mo stretchy="false">)</mo><mo>+</mo><mo stretchy="false">(</mo><mn>0</mn><mo>×</mo><mn>8</mn><mo stretchy="false">)</mo><mo>=</mo><mn>9</mn></mrow><annotation encoding="application/x-tex">(10 \times 0.9) + (0 \times 5) + (0 \times 8) = 9</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">10</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">0.9</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">0</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">5</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">0</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">8</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">9</span></span></span></span></span></p>
</li>
<li>
<p>小刻是 "口味党", 他完全不在乎颜色, 喜欢甜口但讨厌脆感, 他的偏好向量是 (0, 2, -1). 打分结果是:</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mn>0</mn><mo>×</mo><mn>0.9</mn><mo stretchy="false">)</mo><mo>+</mo><mo stretchy="false">(</mo><mn>2</mn><mo>×</mo><mn>5</mn><mo stretchy="false">)</mo><mo>+</mo><mo stretchy="false">(</mo><mo>−</mo><mn>1</mn><mo>×</mo><mn>8</mn><mo stretchy="false">)</mo><mo>=</mo><mn>2</mn></mrow><annotation encoding="application/x-tex">(0 \times 0.9) + (2 \times 5) + (-1 \times 8) = 2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">0</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">0.9</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">5</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">−</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">8</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">2</span></span></span></span></span></p>
</li>
<li>
<p>小君是 "综合党", 他兼顾颜色, 甜度和脆度, 他的偏好向量是 (1, 1, 1). 打分解果是:</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mn>1</mn><mo>×</mo><mn>0.9</mn><mo stretchy="false">)</mo><mo>+</mo><mo stretchy="false">(</mo><mn>1</mn><mo>×</mo><mn>5</mn><mo stretchy="false">)</mo><mo>+</mo><mo stretchy="false">(</mo><mn>1</mn><mo>×</mo><mn>8</mn><mo stretchy="false">)</mo><mo>=</mo><mn>13.9</mn></mrow><annotation encoding="application/x-tex">(1 \times 0.9 ) + (1 \times 5) + (1 \times 8) = 13.9</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">0.9</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">5</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">8</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">13.9</span></span></span></span></span></p>
</li>
</ul>
<p>为了简化记录, 我们可以把3位员工的偏好向量 "一排排叠起来" 组成一个矩阵 A, 把苹果的特征向量 "竖起来" 写成向量 x, 最终的打分结果也竖起来写成向量 b. 这样就有了下面的式子:</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>10</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>2</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo>−</mo><mn>1</mn></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mo>⋅</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0.9</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>5</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>8</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>9</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>2</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>13.9</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">\begin{bmatrix}
10 &amp; 0 &amp; 0 \\
0 &amp; 2 &amp; -1 \\
1 &amp; 1 &amp; 1
\end{bmatrix}\cdot\begin{bmatrix}
0.9 \\
5 \\
8\end{bmatrix}=\begin{bmatrix}
9 \\
2 \\
13.9
\end{bmatrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:3.6em;vertical-align:-1.55em;"/><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M403 1759 V84 H666 V0 H319 V1759 v0 v1759 h347 v-84&#10;H403z M403 1759 V0 H319 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">10</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">2</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">−</span><span class="mord">1</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M347 1759 V0 H0 V84 H263 V1759 v0 v1759 H0 v84 H347z&#10;M347 1759 V0 H263 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:3.6em;vertical-align:-1.55em;"/><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M403 1759 V84 H666 V0 H319 V1759 v0 v1759 h347 v-84&#10;H403z M403 1759 V0 H319 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0.9</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">5</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">8</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M347 1759 V0 H0 V84 H263 V1759 v0 v1759 H0 v84 H347z&#10;M347 1759 V0 H263 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:3.6em;vertical-align:-1.55em;"/><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M403 1759 V84 H666 V0 H319 V1759 v0 v1759 h347 v-84&#10;H403z M403 1759 V0 H319 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">9</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">2</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">13.9</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M347 1759 V0 H0 V84 H263 V1759 v0 v1759 H0 v84 H347z&#10;M347 1759 V0 H263 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span></span></span></span></span></div>
<p>简写为</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi><mi>x</mi><mo>=</mo><mi>b</mi></mrow><annotation encoding="application/x-tex">A x = b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal">A</span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">b</span></span></span></span></span></p>
<p>这就是矩阵的第一种理解: <strong>矩阵是多个向量的组合</strong>。它能帮我们一次性完成多组规则相同的计算, 不用逐个单独运算.</p>
<h3 data-id="heading-2">2. 反推苹果特征: 矩阵是方程组的系数</h3>
<p>同样以水果店为例，这次我们换个场景: 你不知道苹果的具体特征（颜色、甜度、脆度都是未知的），但你手头有 3 位员工的打分结果，以及他们的评分标准. 现在你想反推这个苹果的具体特征, 应该怎么办呢?</p>
<p>我们假设颜色、甜度、脆度为 x1, x2, x3, 根据之前评分规则, 就可以列出一组方程:</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mo fence="true">{</mo><mtable rowspacing="0.36em" columnalign="left left" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>10</mn><msub><mi>x</mi><mn>1</mn></msub><mo>+</mo><mn>0</mn><msub><mi>x</mi><mn>2</mn></msub><mo>+</mo><mn>0</mn><msub><mi>x</mi><mn>3</mn></msub></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo>=</mo><mn>9</mn></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>0</mn><msub><mi>x</mi><mn>1</mn></msub><mo>+</mo><mn>2</mn><msub><mi>x</mi><mn>2</mn></msub><mo>−</mo><mn>1</mn><msub><mi>x</mi><mn>3</mn></msub></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo>=</mo><mn>2</mn></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>1</mn><msub><mi>x</mi><mn>1</mn></msub><mo>+</mo><mn>1</mn><msub><mi>x</mi><mn>2</mn></msub><mo>+</mo><mn>1</mn><msub><mi>x</mi><mn>3</mn></msub></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo>=</mo><mn>13.9</mn></mrow></mstyle></mtd></mtr></mtable></mrow><annotation encoding="application/x-tex">\begin{cases}
10x_1 + 0x_2 + 0x_3 &amp;= 9 \\
0x_1 + 2x_2 - 1x_3 &amp;= 2 \\
1x_1 + 1x_2 + 1x_3 &amp;= 13.9
\end{cases}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:4.32em;vertical-align:-1.91em;"/><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.35em;"><span style="top:-2.2em;"><span class="pstrut" style="height:3.15em;"/><span class="delimsizinginner delim-size4"><span>⎩</span></span></span><span style="top:-2.192em;"><span class="pstrut" style="height:3.15em;"/><span style="height:0.316em;width:0.8889em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.8889em" height="0.316em" style="width:0.8889em" viewbox="0 0 888.89 316" preserveaspectratio="xMinYMin"><path d="M384 0 H504 V316 H384z M384 0 H504 V316 H384z"/></svg></span></span><span style="top:-3.15em;"><span class="pstrut" style="height:3.15em;"/><span class="delimsizinginner delim-size4"><span>⎨</span></span></span><span style="top:-4.292em;"><span class="pstrut" style="height:3.15em;"/><span style="height:0.316em;width:0.8889em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.8889em" height="0.316em" style="width:0.8889em" viewbox="0 0 888.89 316" preserveaspectratio="xMinYMin"><path d="M384 0 H504 V316 H384z M384 0 H504 V316 H384z"/></svg></span></span><span style="top:-4.6em;"><span class="pstrut" style="height:3.15em;"/><span class="delimsizinginner delim-size4"><span>⎧</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.85em;"><span/></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.41em;"><span style="top:-4.41em;"><span class="pstrut" style="height:3.008em;"/><span class="mord"><span class="mord">10</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord">0</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord">0</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-2.97em;"><span class="pstrut" style="height:3.008em;"/><span class="mord"><span class="mord">0</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord">2</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord">1</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-1.53em;"><span class="pstrut" style="height:3.008em;"/><span class="mord"><span class="mord">1</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord">1</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord">1</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.91em;"><span/></span></span></span></span><span class="arraycolsep" style="width:1em;"/><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.41em;"><span style="top:-4.41em;"><span class="pstrut" style="height:3.008em;"/><span class="mord"><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord">9</span></span></span><span style="top:-2.97em;"><span class="pstrut" style="height:3.008em;"/><span class="mord"><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord">2</span></span></span><span style="top:-1.53em;"><span class="pstrut" style="height:3.008em;"/><span class="mord"><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord">13.9</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.91em;"><span/></span></span></span></span></span></span><span class="mclose nulldelimiter"/></span></span></span></span></span></div>
<p>不难发现, 如果我们把 x1, x2, x3 的前面的系数提取出来, 它恰好就是一个矩阵:</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>10</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>2</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo>−</mo><mn>1</mn></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><annotation encoding="application/x-tex">\begin{bmatrix}
10 &amp; 0 &amp; 0 \\
0 &amp; 2 &amp; -1 \\
1 &amp; 1 &amp; 1
\end{bmatrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:3.6em;vertical-align:-1.55em;"/><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M403 1759 V84 H666 V0 H319 V1759 v0 v1759 h347 v-84&#10;H403z M403 1759 V0 H319 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">10</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">2</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">−</span><span class="mord">1</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M347 1759 V0 H0 V84 H263 V1759 v0 v1759 H0 v84 H347z&#10;M347 1759 V0 H263 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span></span></span></span></span></div>
<p>因此, 上面的方程组可以简写为矩阵形式:</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>10</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>2</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo>−</mo><mn>1</mn></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mo>⋅</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>x</mi><mn>1</mn></msub></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>x</mi><mn>2</mn></msub></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>x</mi><mn>3</mn></msub></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>9</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>2</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>13.9</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">\begin{bmatrix}
10 &amp; 0 &amp; 0 \\
0 &amp; 2 &amp; -1 \\
1 &amp; 1 &amp; 1
\end{bmatrix}\cdot\begin{bmatrix}
x_1 \\
x_2 \\
x_3
\end{bmatrix}=\begin{bmatrix}
9 \\
2 \\
13.9
\end{bmatrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:3.6em;vertical-align:-1.55em;"/><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M403 1759 V84 H666 V0 H319 V1759 v0 v1759 h347 v-84&#10;H403z M403 1759 V0 H319 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">10</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">2</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">−</span><span class="mord">1</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M347 1759 V0 H0 V84 H263 V1759 v0 v1759 H0 v84 H347z&#10;M347 1759 V0 H263 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:3.6em;vertical-align:-1.55em;"/><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M403 1759 V84 H666 V0 H319 V1759 v0 v1759 h347 v-84&#10;H403z M403 1759 V0 H319 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M347 1759 V0 H0 V84 H263 V1759 v0 v1759 H0 v84 H347z&#10;M347 1759 V0 H263 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:3.6em;vertical-align:-1.55em;"/><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M403 1759 V84 H666 V0 H319 V1759 v0 v1759 h347 v-84&#10;H403z M403 1759 V0 H319 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">9</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">2</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">13.9</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M347 1759 V0 H0 V84 H263 V1759 v0 v1759 H0 v84 H347z&#10;M347 1759 V0 H263 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span></span></span></span></span></div>
<p>只要解这个矩阵方程, 我们就可以算出苹果的特征向量. 这就是矩阵的第二种核心理解：<strong>矩阵是线性方程组的系数集合</strong>。</p>
<h2 data-id="heading-3">矩阵的四种核心运算</h2>
<p>理解了矩阵是什么之后, 我们再来看它的四种核心运算. 这里不深入讲解复杂的运算性质, 重点讲清基础规则, 再结合AI领域的实际场景, 说说每种运算的用途.</p>
<h3 data-id="heading-4">1. 矩阵的加法/减法</h3>
<h4 data-id="heading-5">运算性质</h4>
<p>矩阵的加法和减法有个前提: 两个矩阵必须形状相同 (也就是行数和列数都完全一致), 否则无法计算.</p>
<p>计算方法很简单: 把两个矩阵对应位置的元素直接相加或相减即可.</p>
<p>举个例子，现有两个 2×2 的矩阵 A 和 B:</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>A</mi><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>2</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>3</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>4</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mspace width="1em"/><mi>B</mi><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>5</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>6</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>7</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>8</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">A = \begin{bmatrix}
1 &amp; 2 \\
3 &amp; 4
\end{bmatrix} \quad B = \begin{bmatrix}
5 &amp; 6 \\
7 &amp; 8
\end{bmatrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal">A</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.4em;vertical-align:-0.95em;"/><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">2</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">4</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span/></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">]</span></span></span><span class="mspace" style="margin-right:1em;"/><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.4em;vertical-align:-0.95em;"/><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">5</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">7</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">6</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">8</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span/></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">]</span></span></span></span></span></span></span></div>
<p>矩阵加法 A + B:</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>1</mn><mo>+</mo><mn>5</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>2</mn><mo>+</mo><mn>6</mn></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>3</mn><mo>+</mo><mn>7</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>4</mn><mo>+</mo><mn>8</mn></mrow></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>6</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>8</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>10</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>12</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">\begin{bmatrix}
1 + 5 &amp; 2 + 6 \\
3 + 7 &amp; 4 + 8
\end{bmatrix}=
\begin{bmatrix}
6 &amp; 8 \\
10 &amp; 12
\end{bmatrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:2.4em;vertical-align:-0.95em;"/><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord">5</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">3</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord">7</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">2</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord">6</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">4</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord">8</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span/></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">]</span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.4em;vertical-align:-0.95em;"/><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">6</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">10</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">8</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">12</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span/></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">]</span></span></span></span></span></span></span></div>
<p>矩阵减法: A - B:</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>1</mn><mo>−</mo><mn>5</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>2</mn><mo>−</mo><mn>6</mn></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>3</mn><mo>−</mo><mn>7</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>4</mn><mo>−</mo><mn>8</mn></mrow></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo>−</mo><mn>4</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo>−</mo><mn>4</mn></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo>−</mo><mn>4</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo>−</mo><mn>4</mn></mrow></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">\begin{bmatrix}
1 - 5 &amp; 2 - 6 \\
3 - 7 &amp; 4 - 8
\end{bmatrix}=
\begin{bmatrix}
-4 &amp; -4 \\
-4 &amp; -4
\end{bmatrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:2.4em;vertical-align:-0.95em;"/><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord">5</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">3</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord">7</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">2</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord">6</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">4</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord">8</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span/></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">]</span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.4em;vertical-align:-0.95em;"/><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">−</span><span class="mord">4</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">−</span><span class="mord">4</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">−</span><span class="mord">4</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">−</span><span class="mord">4</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span/></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">]</span></span></span></span></span></span></span></div>
<h4 data-id="heading-6">AI 领域的应用例子</h4>
<p>下面我们各举一下加法和减法在 AI 应用场景中的例子, 帮助你理解矩阵加法和减法的实际价值:</p>
<p><strong>加法例子: 大模型的位置编码</strong></p>
<p>大模型的 Transformer 架构中, Token 是被并行处理的, 本身没有位置信息, 比如它分不清 "我爱吃苹果" 和 “苹果爱吃我”.</p>
<blockquote>
<p>不熟悉 Transformer 架构, 可以看我的文章:  <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F_JNT0A6ud8QtGpK319a8uw" target="_blank" title="https://mp.weixin.qq.com/s/_JNT0A6ud8QtGpK319a8uw" ref="nofollow noopener noreferrer">数学不好也能懂: 解读 AI 经典论文《Attention is All You Need》与大模型生成原理</a></p>
</blockquote>
<p>为了解决这个问题, 我们需要给每个词向量增加位置信息.</p>
<p>按照我们之前说的 <strong>矩阵是向量的组合</strong>, Transfromer 会先把词向量组合成一个 "词向量矩阵", 再生成一个记录位置信息的 "位置向量矩阵". 通过矩阵加法, 模型就能同时获取 “每个 Token 的含义” 和 “每个词的位置” 两个关键信息.</p>
<p><strong>减法例子: 监控中的运动检测</strong></p>
<p>我们先补充一点图像知识: 如果是黑白监控, 一帧画面里的每个像素点都能转换成一个亮度数值:</p>
<ul>
<li>0 = 纯黑</li>
<li>255 = 纯白</li>
<li>128 = 灰色</li>
</ul>
<p>这样一来, 一帧画面就可以看成一个 "像素矩阵".</p>
<p>运动检测的核心逻辑很简单: 先把没有物体移动的 "背景画面" 转换成 "背景矩阵", 再用实时的 "当前画面矩阵" 减去 "背景矩阵". 如果结果矩阵里的数值几乎都是 0, 说明画面静止; 如果某一块区域有明显数值, 就说明这块区域有物体在移动. 这就是最基础的运动检测算法</p>
<h3 data-id="heading-7">2. 矩阵的乘法</h3>
<h4 data-id="heading-8">运算性质</h4>
<p>矩阵乘法的规则比加减复杂一点, 首先要满足一个前提: <strong>第一个矩阵的列数, 必须等于第二个矩阵的行数</strong>, 否则无法计算.</p>
<p>它的计算方式是, 第一个矩阵的每一行的元素, 去和第二个矩阵的每一列的元素对应位置的元素相乘后, 再把所有的乘积加起来</p>
<p>听起来有点难懂, 我们举个例子, 假如有个 2 * 3 和 3 * 2 的矩阵 A 和 B</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>A</mi><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>2</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>3</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>4</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>5</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>6</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mspace width="1em"/><mi>B</mi><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>2</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>3</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>4</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>5</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>6</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">A = \begin{bmatrix}
1 &amp; 2 &amp; 3\\
4 &amp; 5 &amp; 6
\end{bmatrix} \quad B = \begin{bmatrix}
1 &amp; 2\\
3 &amp; 4\\
5 &amp; 6
\end{bmatrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal">A</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.4em;vertical-align:-0.95em;"/><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">4</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">2</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">5</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">3</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">6</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span/></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">]</span></span></span><span class="mspace" style="margin-right:1em;"/><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:3.6em;vertical-align:-1.55em;"/><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M403 1759 V84 H666 V0 H319 V1759 v0 v1759 h347 v-84&#10;H403z M403 1759 V0 H319 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">3</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">5</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">2</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">4</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">6</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M347 1759 V0 H0 V84 H263 V1759 v0 v1759 H0 v84 H347z&#10;M347 1759 V0 H263 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span></span></span></span></span></div>
<p>二者相乘</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/096ecb2afe724704bfe37f61bed6deb8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2w5Yi75ZCb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767573557&amp;x-signature=Qyaprmu1Jsji%2FHOF1EucIZxYBN4%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>
<p>我们先拿 A 的第一行和 B 的第一列对应相乘再相加</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mo>×</mo><mn>1</mn><mo>+</mo><mn>2</mn><mo>×</mo><mn>3</mn><mo>+</mo><mn>3</mn><mo>×</mo><mn>5</mn><mo>=</mo><mn>22</mn></mrow><annotation encoding="application/x-tex">1 \times 1 + 2 \times 3 + 3 \times 5 = 22</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">2</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">3</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">3</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">5</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">22</span></span></span></span></span></p>
</li>
<li>
<p>再拿 A 的第一行和 B 的第一列对应相乘再相加</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mo>×</mo><mn>2</mn><mo>+</mo><mn>2</mn><mo>×</mo><mn>4</mn><mo>+</mo><mn>3</mn><mo>×</mo><mn>6</mn><mo>=</mo><mn>28</mn></mrow><annotation encoding="application/x-tex">1 \times 2 + 2 \times 4 + 3 \times 6 = 28</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">2</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">2</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">4</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">3</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">6</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">28</span></span></span></span></span></p>
</li>
<li>
<p>再拿 A 的第二行和 B 的第一列对应相乘再相加</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>4</mn><mo>×</mo><mn>1</mn><mo>+</mo><mn>5</mn><mo>×</mo><mn>3</mn><mo>+</mo><mn>6</mn><mo>×</mo><mn>5</mn><mo>=</mo><mn>49</mn></mrow><annotation encoding="application/x-tex">4 \times 1 + 5 \times 3 + 6 \times 5 = 49</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">4</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">5</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">3</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">6</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">5</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">49</span></span></span></span></span></p>
</li>
<li>
<p>最后拿 A 的第二行和 B 的第二列对应相乘再相加</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>4</mn><mo>×</mo><mn>2</mn><mo>+</mo><mn>5</mn><mo>×</mo><mn>4</mn><mo>+</mo><mn>6</mn><mo>×</mo><mn>6</mn><mo>=</mo><mn>64</mn></mrow><annotation encoding="application/x-tex">4 \times 2 + 5 \times 4 + 6 \times 6 = 64</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">4</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">2</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">5</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">4</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">6</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">6</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">64</span></span></span></span></span></p>
</li>
</ul>
<h4 data-id="heading-9">AI 应用例子</h4>
<p>矩阵乘法在推荐系统中用得很多, 比如视频 APP, 购物平台的 "猜你喜欢" 功能.</p>
<p>我们以推荐电影为例:</p>
<ul>
<li>构建一个用户矩阵 U: 每一行代表一个用户, 每一列代表一个用户特征 (比如 "喜欢科幻", "喜欢恐怖" 等）;</li>
<li>构建一个电影矩阵 M: 每一行代表一个电影特征 (和用户特征对应, 比如 "科幻程度", "恐怖程度" 等）. 每一列代表一部电影;</li>
<li>把用户矩阵 U 和电影矩阵 M 相乘, 得到一个 "兴趣矩阵 R". R里的每个数值, 都代表某个用户对某部电影的感兴趣程度. 数值越大, 越可能喜欢; 数值越小, 越不感兴趣.</li>
</ul>
<p>其实这个过程的本质, 就是用矩阵乘法计算 "用户向量" 和 "电影向量" 的相似度.</p>
<p>整个矩阵运算过程, 就是从用户矩阵中取出一行行的用户向量 u 去和电影向量 m 相乘:</p>
<p>向量的乘法公式是:</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent="true"><mi>u</mi><mo>⃗</mo></mover><mo>⋅</mo><mover accent="true"><mi>v</mi><mo>⃗</mo></mover><mo>=</mo><mi mathvariant="normal">∣</mi><mover accent="true"><mi>u</mi><mo>⃗</mo></mover><mi mathvariant="normal">∣</mi><mo>×</mo><mi mathvariant="normal">∣</mi><mover accent="true"><mi>m</mi><mo>⃗</mo></mover><mi mathvariant="normal">∣</mi><mo>×</mo><mi>c</mi><mi>o</mi><mi>s</mi><mo stretchy="false">(</mo><mi>θ</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\vec{u} \cdot \vec{v} = |\vec{u}| \times |\vec{m}| \times cos(\theta)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.714em;"/><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.714em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="mord mathnormal">u</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="accent-body" style="left:-0.2077em;"><span class="overlay" style="height:0.714em;width:0.471em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.471em" height="0.714em" style="width:0.471em" viewbox="0 0 471 714" preserveaspectratio="xMinYMin"><path d="M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5&#10;3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11&#10;10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63&#10;-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1&#10;-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59&#10;H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359&#10;c-16-25.333-24-45-24-59z"/></svg></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.714em;"/><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.714em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">v</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="accent-body" style="left:-0.2077em;"><span class="overlay" style="height:0.714em;width:0.471em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.471em" height="0.714em" style="width:0.471em" viewbox="0 0 471 714" preserveaspectratio="xMinYMin"><path d="M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5&#10;3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11&#10;10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63&#10;-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1&#10;-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59&#10;H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359&#10;c-16-25.333-24-45-24-59z"/></svg></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">∣</span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.714em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="mord mathnormal">u</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="accent-body" style="left:-0.2077em;"><span class="overlay" style="height:0.714em;width:0.471em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.471em" height="0.714em" style="width:0.471em" viewbox="0 0 471 714" preserveaspectratio="xMinYMin"><path d="M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5&#10;3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11&#10;10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63&#10;-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1&#10;-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59&#10;H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359&#10;c-16-25.333-24-45-24-59z"/></svg></span></span></span></span></span></span></span><span class="mord">∣</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">∣</span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.714em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="mord mathnormal">m</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="accent-body" style="left:-0.2355em;"><span class="overlay" style="height:0.714em;width:0.471em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.471em" height="0.714em" style="width:0.471em" viewbox="0 0 471 714" preserveaspectratio="xMinYMin"><path d="M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5&#10;3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11&#10;10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63&#10;-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1&#10;-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59&#10;H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359&#10;c-16-25.333-24-45-24-59z"/></svg></span></span></span></span></span></span></span><span class="mord">∣</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">cos</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="mclose">)</span></span></span></span></span></p>
<p>其中 cos(θ) 是余弦相似度, 用来判断两个向量是否相似</p>
<p>如果我们把向量 u 和向量 m 都进行归一化处理, 也就是让它们都长度都为 1, 那么结果就变成了</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent="true"><mi>u</mi><mo>⃗</mo></mover><mo>⋅</mo><mover accent="true"><mi>m</mi><mo>⃗</mo></mover><mo>=</mo><mi>c</mi><mi>o</mi><mi>s</mi><mo stretchy="false">(</mo><mi>θ</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\vec{u} \cdot \vec{m} = cos(\theta)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.714em;"/><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.714em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="mord mathnormal">u</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="accent-body" style="left:-0.2077em;"><span class="overlay" style="height:0.714em;width:0.471em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.471em" height="0.714em" style="width:0.471em" viewbox="0 0 471 714" preserveaspectratio="xMinYMin"><path d="M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5&#10;3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11&#10;10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63&#10;-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1&#10;-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59&#10;H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359&#10;c-16-25.333-24-45-24-59z"/></svg></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.714em;"/><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.714em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="mord mathnormal">m</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="accent-body" style="left:-0.2355em;"><span class="overlay" style="height:0.714em;width:0.471em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.471em" height="0.714em" style="width:0.471em" viewbox="0 0 471 714" preserveaspectratio="xMinYMin"><path d="M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5&#10;3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11&#10;10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63&#10;-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1&#10;-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59&#10;H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359&#10;c-16-25.333-24-45-24-59z"/></svg></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">cos</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="mclose">)</span></span></span></span></span></p>
<p>所以矩阵的乘法, 本质上就是批量计算多个向量之间的相似度.</p>
<h3 data-id="heading-10">3. 矩阵的转置</h3>
<h4 data-id="heading-11">运算性质</h4>
<p>矩阵的转置很简单, 就是把矩阵沿着对角线 (从左上到右下) 进行翻转, 通常写作 A<sup>T</sup> 或者 A<sup>′</sup></p>
<p>简单来说, 就是把矩阵的行写成列, 把列写成行</p>
<p>举个例子:</p>
<p>假设有一个 2 行 3 列的矩阵 A:</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>A</mi><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>2</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>3</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>4</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>5</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>6</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">A = \begin{bmatrix}
1 &amp; 2 &amp; 3 \\
4 &amp; 5 &amp; 6 \\
\end{bmatrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal">A</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.4em;vertical-align:-0.95em;"/><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">4</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">2</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">5</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">3</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">6</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span/></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">]</span></span></span></span></span></span></span></div>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msup><mi>A</mi><mi>T</mi></msup><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>4</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>2</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>5</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>3</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>6</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">A^T = \begin{bmatrix}
1 &amp;  4 \\
2 &amp; 5 \\
3 &amp; 6 \\
\end{bmatrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8913em;"/><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:3.6em;vertical-align:-1.55em;"/><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M403 1759 V84 H666 V0 H319 V1759 v0 v1759 h347 v-84&#10;H403z M403 1759 V0 H319 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">2</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">4</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">5</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">6</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M347 1759 V0 H0 V84 H263 V1759 v0 v1759 H0 v84 H347z&#10;M347 1759 V0 H263 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span></span></span></span></span></div>
<h4 data-id="heading-12">AI 应用例子</h4>
<p>转置在 AI 中的核心作用, 是解决“矩阵形状不匹配”的问题. 我们之前说过, 矩阵乘法有个前提: 第一个矩阵的列数要等于第二个矩阵的行数.</p>
<p>在神经网络计算中, 经常会遇到两个矩阵包含有用数据, 但形状对不上, 无法直接相乘的情况. 这时候就可以用转置调整其中一个矩阵的行数和列数, 让它们满足乘法条件.</p>
<p>转置就像一个 "适配器", 帮两个矩阵顺利完成后续计算.</p>
<h3 data-id="heading-13">4. 矩阵的哈达玛积</h3>
<h4 data-id="heading-14">运算性质</h4>
<p>需要注意, 哈达玛积的计算规则, 和我们之前说的矩阵乘法完全不同, 它要求<strong>两个矩阵的形状完全一致</strong>, 也就是行数和列数相同. 它的计算方法是对应位置的元素直接相乘, 结果矩阵的形状和原来保持一致.</p>
<p>哈达玛积通常写作:</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi><mo>⊙</mo><mi>B</mi></mrow><annotation encoding="application/x-tex">A \odot B</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7667em;vertical-align:-0.0833em;"/><span class="mord mathnormal">A</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⊙</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span></span></p>
<p>举个例子, 假设有两个 2 行 2 列的矩阵 A 和 B:</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>A</mi><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>2</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>3</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>4</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mspace width="1em"/><mi>B</mi><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>5</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>6</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>7</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>8</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">A = \begin{bmatrix}
1 &amp; 2\\
3 &amp; 4
\end{bmatrix} \quad B =
\begin{bmatrix}
5 &amp; 6\\
7 &amp; 8
\end{bmatrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal">A</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.4em;vertical-align:-0.95em;"/><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">2</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">4</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span/></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">]</span></span></span><span class="mspace" style="margin-right:1em;"/><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.4em;vertical-align:-0.95em;"/><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">5</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">7</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">6</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">8</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span/></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">]</span></span></span></span></span></span></span></div>
<p>它们的哈达玛积为:</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>1</mn><mo>×</mo><mn>5</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>2</mn><mo>×</mo><mn>6</mn></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>3</mn><mo>×</mo><mn>7</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>4</mn><mo>×</mo><mn>8</mn></mrow></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>5</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>12</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>21</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>32</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">\begin{bmatrix}
1 \times 5 &amp; 2 \times 6 \\
3 \times 7 &amp; 4 \times 8
\end{bmatrix} =
\begin{bmatrix}
5 &amp; 12 \\
21 &amp; 32
\end{bmatrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:2.4em;vertical-align:-0.95em;"/><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord">5</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">3</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord">7</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">2</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord">6</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">4</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord">8</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span/></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">]</span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.4em;vertical-align:-0.95em;"/><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">5</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">21</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">12</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">32</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span/></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">]</span></span></span></span></span></span></span></div>
<h4 data-id="heading-15">AI 应用例子</h4>
<p>哈达玛积的核心用途是 "筛选有效信息, 屏蔽无效信息", 最典型的场景是 Transformer 的掩码机制和图像处理的抠图.</p>
<p><strong>Transformer 的掩码机制</strong></p>
<p>Transformer 处理文本时, 为了防止 Transformer “偷看” 后面还没处理的词语, 需要用到 "掩码".</p>
<p>掩码的一种方法, 就是会生成一个由 0 和 1 的 "掩码矩阵", 再与输入特征进行哈达玛积, 结果矩阵中, 0 对应的位置会被屏蔽, 1 对应的位置保留原始信息, 从而实现 "不偷看" 的效果.</p>
<p><strong>图像处理中的抠图</strong></p>
<p>如果我们想把一个图像中的人像抠出来, 可以先做一个 "掩膜矩阵": 它的人像区域数值全是 1, 其余背景部分数值全部是 0</p>
<p>把图片对应的像素矩阵和掩膜矩阵做哈达玛积, 最终得到的矩阵就只保留了人像. 这就是最基础的抠图逻辑.</p>
<h2 data-id="heading-16">总结</h2>
<p>总结一下, 本文我们核心介绍了矩阵的两个核心理解和四种核心运算:</p>
<ol>
<li>
<p>矩阵的两个核心理解:
a. 多个向量的组合;
b. 线性方程组的系数集合;</p>
</li>
<li>
<p>矩阵的四种核心运算:
a. 加/减法 (形状相同, 对应元素运算);
b. 乘法 (批量计算向量相似度);
c. 转置 (调整形状, 适配运算); d. 哈达玛积 (筛选信息, 屏蔽无效内容).</p>
</li>
</ol>
<p>这些运算看似基础, 却是 AI 领域 (比如大模型, 推荐系统, 图像处理) 的核心数学工具, 理解它们的逻辑, 能帮我们更好地看懂AI技术的底层原理.</p>
<p>我是印刻君, 一位探索 AI 的前端程序员, 关注我, 让 AI 知识有温度, 技术落地有深度.</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[OpenDeRisk：AI 原生风险智能系统 ——7*24H 应用系统AI数字运维助手(AI-SRE)]]></title>    <link>https://juejin.cn/post/7588745319400243200</link>    <guid>https://juejin.cn/post/7588745319400243200</guid>    <pubDate>2025-12-29T00:38:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588745319400243200" data-draft-id="7537711310580105216" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="OpenDeRisk：AI 原生风险智能系统 ——7*24H 应用系统AI数字运维助手(AI-SRE)"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-29T00:38:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="YL_jia"/> <meta itemprop="url" content="https://juejin.cn/user/1467226241383211"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            OpenDeRisk：AI 原生风险智能系统 ——7*24H 应用系统AI数字运维助手(AI-SRE)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1467226241383211/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    YL_jia
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T00:38:33.000Z" title="Mon Dec 29 2025 00:38:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">OpenDeRisk：AI 驱动的智能运维根因分析系统实战指南</h2>
<blockquote>
<p>在系统故障导致百万级损失的数字化时代，<strong>OpenDeRisk 用多代理协作与可视化证据链，让根因诊断从“大海捞针”变为“精准导航”</strong>。</p>
</blockquote>
<h3 data-id="heading-1">引言：当故障诊断遇上多代理AI革命</h3>
<p>凌晨 3 点的告警短信、持续 6 小时的故障定位、跨团队会议上的互相推诿——传统运维的根因分析（RCA）常陷入<strong>数据孤岛</strong>与<strong>经验依赖</strong>的困局。某互联网公司的统计显示，超过 65% 的故障恢复时间被消耗在问题定位环节。而 OpenDeRisk 作为开源 AI 运维系统，通过多代理协作架构实现了<strong>日志分析-&gt;代码追踪-&gt;证据链可视化</strong>的自动化闭环，将 RCA 效率提升 10 倍以上。本文将带您深入这一颠覆性工具的技术内核与落地实践。</p>
<hr/>
<h3 data-id="heading-2">一、核心功能解析：多代理协作如何重塑故障诊断</h3>
<h4 data-id="heading-3">1. 架构全景：五大代理的协同作战</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
A[Data-Agent] --&gt;|原始日志/跟踪数据| B(SRE-Agent)
B --&gt;|问题假设| C(Code-Agent)
C --&gt;|动态生成诊断代码| D(Vis-Agent)
D --&gt;|可视化证据链| E(ReportAgent)
E --&gt;|可执行报告| F[用户]
</code></pre>
<p><em>图：OpenDeRisk 多代理协作流程图，实现从数据到决策的自动化</em></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/65f3a33084f040f2b3ac37531503e2ad~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWUxfamlh:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767573512&amp;x-signature=NrW8FvKerV5%2FqQyrZlp%2F9gE%2FZ%2Fc%3D" alt="image.png" loading="lazy"/>
各代理的核心职责：</p>
<ul>
<li><strong>SRE-Agent</strong>：问题初步定位，生成根因假设（基于历史故障模式库）</li>
<li><strong>Code-Agent</strong>：动态生成 Python 诊断脚本，验证假设</li>
<li><strong>Data-Agent</strong>：对接日志系统（ELK）、追踪系统（Jaeger）、监控数据（Prometheus）</li>
<li><strong>Vis-Agent</strong>：通过 D3.js 渲染交互式证据链视图</li>
<li><strong>ReportAgent</strong>：生成包含修复建议的 Markdown/PDF 报告</li>
</ul>
<h4 data-id="heading-4">2. 突破性能力：从“猜测”到“实证”</h4>
<ul>
<li><strong>深度研究 RCA</strong><br/>
融合日志模式识别、代码逻辑回溯、资源时序分析三重视角，避免单一数据源误判</li>
<li><strong>动态代码生成</strong><br/>
当检测到数据库连接池耗尽时，Code-Agent 自动生成连接泄漏检测脚本：
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 动态生成的诊断脚本示例</span>
<span class="hljs-keyword">from</span> dbtools <span class="hljs-keyword">import</span> analyze_connection_leak
leak_report = analyze_connection_leak(
    log_path=<span class="hljs-string">"/var/log/app/db.log"</span>, 
    trace_id=<span class="hljs-string">"req-0x7fd3a"</span>
)
<span class="hljs-built_in">print</span>(leak_report.top_candidates(<span class="hljs-number">3</span>))
</code></pre>
</li>
<li><strong>证据链可视化</strong><br/>
将 200+ 条分散日志、40 个服务调用节点，聚合为单张时间轴交互视图：</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/335aad20e6ef4d4e9861f645b584bef6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWUxfamlh:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767573512&amp;x-signature=hL7Vsr5Yjv3sK7T5yFNNQ2coKSo%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a3682c2bf61147b2bbc69220e6c86c36~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWUxfamlh:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767573512&amp;x-signature=IGNXCSKgKVRJs3dMvgVqrxpq9Ik%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-5">3. 企业级扩展能力</h4>
<ul>
<li><strong>金融级合规</strong>：审计日志留存 7 年，支持 GDPR/等保 3.0</li>
<li><strong>插件化架构</strong>：可扩展支持 Kafka/Pulsar 等消息中间件诊断</li>
<li><strong>多云适配</strong>：已验证适配 AWS CloudWatch、Azure Monitor、GCP Stackdriver</li>
</ul>
<hr/>
<h3 data-id="heading-6">二、安装部署实战：5 种模式应对不同场景</h3>
<h4 data-id="heading-7">1. 环境规划建议</h4>









































<table><thead><tr><th><strong>部署模式</strong></th><th>适用场景</th><th>硬件要求</th><th>网络要求</th></tr></thead><tbody><tr><td>纯代理模式</td><td>初创团队/POC</td><td>4C8G，无 GPU</td><td>可访问 DeepSeek/OpenAI API</td></tr><tr><td>本地轻量模型</td><td>内网环境</td><td>8C32G + 1*T4(16GB)</td><td>隔离部署</td></tr><tr><td>本地全量模型</td><td>高安全要求</td><td>16C64G + 2*A10(24GB)</td><td>万兆内网</td></tr><tr><td>VLLM 加速集群</td><td>百节点以上大集群</td><td>32C128G + 4*L40S(48GB)</td><td>RDMA 网络</td></tr><tr><td>混合边缘-云</td><td>工厂/物联网</td><td>边缘节点 4C8G + 含 GPU 工控机</td><td>5G 专网</td></tr></tbody></table>
<h4 data-id="heading-8">2. 关键步骤详解（以本地 QwQ-32B 模型为例）</h4>
<p><strong>Step 1：依赖安装与模型预热</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装 UV 工具链（替代 pip）</span>
curl -LsSf https://astral.sh/uv/install.sh | sh
<span class="hljs-built_in">source</span> ~/.bashrc

<span class="hljs-comment"># 克隆代码</span>
git <span class="hljs-built_in">clone</span> https://github.com/derisk-ai/derisk.git --depth=1

<span class="hljs-comment"># 安装 CUDA 依赖包（需 24GB+ 显存）</span>
uv <span class="hljs-built_in">sync</span> --all-packages \
  --extra <span class="hljs-string">"cuda121"</span> \
  --extra <span class="hljs-string">"hf"</span> \
  --extra <span class="hljs-string">"quant_bnb"</span> \
  --extra <span class="hljs-string">"rag"</span>
</code></pre>
<p><strong>Step 2：模型配置文件定制</strong><br/>
编辑 <code>configs/derisk-local-qwen.toml</code>：</p>
<pre><code class="hljs language-toml" lang="toml"><span class="hljs-section">[models]</span>
<span class="hljs-section">[[models.llms]]</span>
<span class="hljs-attr">name</span> = <span class="hljs-string">"Qwen/QwQ-32B"</span>
<span class="hljs-attr">provider</span> = <span class="hljs-string">"hf"</span>
<span class="hljs-attr">quantize</span> = <span class="hljs-string">"bnb_8bit"</span>  <span class="hljs-comment"># 8 位量化降低显存占用</span>

<span class="hljs-section">[service.web.database]</span>
<span class="hljs-attr">type</span> = <span class="hljs-string">"mysql"</span>   <span class="hljs-comment"># 生产环境推荐 MySQL</span>
<span class="hljs-attr">host</span> = <span class="hljs-string">"10.0.0.5"</span>
<span class="hljs-attr">port</span> = <span class="hljs-number">3306</span>
<span class="hljs-attr">user</span> = <span class="hljs-string">"derisk"</span>
<span class="hljs-attr">password</span> = <span class="hljs-string">"加密密码"</span>
</code></pre>
<p><strong>Step 3：服务启动与验证</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 启动后台服务</span>
uv run derisk start webserver --config configs/derisk-local-qwen.toml &amp;

<span class="hljs-comment"># 检查健康状态</span>
curl http://localhost:7777/healthcheck
<span class="hljs-comment"># 预期输出：{"status":"OK","model":"QwQ-32B"}</span>
</code></pre>
<h4 data-id="heading-9">3. 常见避坑指南</h4>
<ul>
<li><strong>GPU 显存不足</strong>：启用 <code>quantize = "bnb_4bit"</code> 或切换 smaller 模型</li>
<li><strong>依赖冲突</strong>：严格使用 <code>uv.lock</code> 锁定版本</li>
<li><strong>模型下载超时</strong>：手动下载后放置到 <code>/data/models/</code> 路径</li>
</ul>
<hr/>
<h3 data-id="heading-10">三、企业实战案例：从故障止损到业务增值</h3>
<h4 data-id="heading-11">案例 1：互联网金融平台 API 异常诊断</h4>
<p><strong>背景</strong>：某支付网关每两周发生一次“神秘”的 500 错误，持续 2 年未根治<br/>
<strong>OpenDeRisk 方案</strong>：</p>
<ol>
<li>
<p><strong>Data-Agent 接入</strong>：</p>
<ul>
<li>日志源：ELK（200GB/日）</li>
<li>追踪源：Jaeger（采样率 100%）</li>
<li>指标源：Prometheus（1s 粒度）</li>
</ul>
</li>
<li>
<p><strong>多代理协作分析</strong>：
sequenceDiagram
SRE-Agent-&gt;&gt;Code-Agent： 检测到 MySQL 连接峰值触发<br/>
Code-Agent-&gt;&gt;Data-Agent： 请求获取关联的 thread dump<br/>
Data-Agent-&gt;&gt;Vis-Agent： 生成线程阻塞热力图<br/>
Vis-Agent-&gt;&gt;ReportAgent： 定位到 Druid 连接池校验死锁</p>
</li>
<li>
<p><strong>成效</strong>：</p>
<ul>
<li>诊断时间从 6 人日 → <strong>8 分钟</strong></li>
<li>避免季度性故障，减少损失 <strong>¥1200 万/年</strong></li>
</ul>
</li>
</ol>
<h4 data-id="heading-12">案例 2：智能工厂预测性维护</h4>
<p><strong>背景</strong>：汽车电池产线设备突发停机，月均损失 ¥500 万<br/>
<strong>OpenDeRisk 增强方案</strong>：</p>
<ol>
<li>扩展 <strong>PLC-Agent</strong> 对接西门子 S7-1500 控制器</li>
<li>集成振动传感器实时流（5000 点/秒）</li>
<li>定制诊断规则：
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 在 packages/custom_agents/plc_agent.py</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">detect_axis_misalignment</span>(<span class="hljs-params">vibration_data</span>):
    <span class="hljs-keyword">if</span> spectral_entropy(vibration_data) &gt; <span class="hljs-number">2.5</span>:
        <span class="hljs-keyword">return</span> RiskLevel.CRITICAL, “主轴不对中风险”
</code></pre>
</li>
</ol>
<p><strong>成效</strong>：</p>
<ul>
<li>故障预测准确率 <strong>92.3%</strong>（原 65%）</li>
<li>维护成本下降 <strong>40%</strong>，获省智能制造补贴</li>
</ul>
<hr/>
<h3 data-id="heading-13">四、二次开发指南：打造领域专属诊断引擎</h3>
<h4 data-id="heading-14">1. 定制化扩展方向</h4>






























<table><thead><tr><th><strong>扩展点</strong></th><th>技术栈</th><th>案例场景</th></tr></thead><tbody><tr><td>新增数据源 Agent</td><td>Python + gRPC</td><td>接入 SAP PI 消息总线</td></tr><tr><td>强化诊断规则</td><td>YAML 规则引擎</td><td>金融合规性检查</td></tr><tr><td>可视化模板</td><td>React + D3.js</td><td>生产排程甘特图</td></tr><tr><td>报告集成</td><td>Markdown 模板</td><td>等保 2.0 审计报告</td></tr></tbody></table>
<h4 data-id="heading-15">2. 开发示例：快速添加 Zabbix Agent</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 在 packages/data_agents/zabbix_agent.py</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ZabbixDataAgent</span>(<span class="hljs-title class_ inherited__">DataAgentBase</span>):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">fetch_metrics</span>(<span class="hljs-params">self, item_keys: <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>], timeframe: TimeRange</span>):
        <span class="hljs-keyword">from</span> pyzabbix <span class="hljs-keyword">import</span> ZabbixAPI
        zapi = ZabbixAPI(self.config[<span class="hljs-string">"url"</span>])
        zapi.login(self.config[<span class="hljs-string">"user"</span>], self.config[<span class="hljs-string">"password"</span>])
        <span class="hljs-keyword">return</span> zapi.history.get(itemKeys=item_keys, 
                                time_from=timeframe.start,
                                time_till=timeframe.end)
</code></pre>
<h4 data-id="heading-16">3. 效能调优技巧</h4>
<ul>
<li><strong>推理加速</strong>：切换 vLLM 后端，吞吐提升 4 倍</li>
<li><strong>内存优化</strong>：启用 <code>--quant_bnb</code> 量化，显存需求降低 50%</li>
<li><strong>缓存策略</strong>：对历史诊断结果建立向量索引（ChromaDB）</li>
</ul>
<hr/>
<h3 data-id="heading-17">五、结语：AI 运维的下一个十年</h3>
<p>OpenDeRisk 通过 <strong>“多代理协作”</strong> 与 <strong>“可视化证据链”</strong> 两大创新，解决了传统 RCA 中的三大断层：</p>
<ol>
<li><strong>数据断层</strong>：打破日志/追踪/代码的数据孤岛</li>
<li><strong>知识断层</strong>：将专家经验转化为可复用的代理策略</li>
<li><strong>信任断层</strong>：可视化证据链取代“黑盒诊断”</li>
</ol>
<p>随着 2025 年其路线图中 <strong>“因果推断引擎”</strong> 与 <strong>“自监督诊断”</strong> 模块的发布，我们有望看到 AI 运维系统从“辅助分析”走向“自主决策”。正如某互联网公司 CTO 所言：<strong>“当故障诊断从小时级进入秒级，运维团队的使命将从‘救火’转向‘防火’”</strong>。</p>
<blockquote>
<p>额外资源：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fderisk-ai%2Fdocs-zh" target="_blank" title="https://github.com/derisk-ai/docs-zh" ref="nofollow noopener noreferrer">OpenDeRisk 中文文档</a></li>
<li>企业实战案例集（含配置模板）</li>
<li>社区 Slack 频道：获取最新 Agent 扩展包</li>
</ul>
</blockquote>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Python 提速 20%，来看看 Python 3.15 中的新特性]]></title>    <link>https://juejin.cn/post/7588445306088226816</link>    <guid>https://juejin.cn/post/7588445306088226816</guid>    <pubDate>2025-12-29T00:43:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588445306088226816" data-draft-id="7588300640598917126" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Python 提速 20%，来看看 Python 3.15 中的新特性"/> <meta itemprop="keywords" content="Python"/> <meta itemprop="datePublished" content="2025-12-29T00:43:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="RockByte"/> <meta itemprop="url" content="https://juejin.cn/user/1046390797768519"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Python 提速 20%，来看看 Python 3.15 中的新特性
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1046390797768519/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    RockByte
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T00:43:27.000Z" title="Mon Dec 29 2025 00:43:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5f428e84a93a45e49e5a3aaabd8db155~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUm9ja0J5dGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767573807&amp;x-signature=bDk7%2FF%2Ba1Wbv5140GEezdO3v8dU%3D" alt="0.webp" loading="lazy"/></p>
<p>Python <code>3.15</code> 引入了原生的即时编译器（JIT），在部分场景下可带来 <strong>20% 甚至更高的性能提升</strong>——尽管目前它仍处于实验阶段。</p>
<p>所谓 JIT（Just-In-Time Compilation，即时编译），就是让原本“解释执行”的 Python 代码在运行时动态编译成机器码，从而显著提速。过去，这类能力只能依赖第三方方案，比如 <a href="https://link.juejin.cn?target=https%3A%2F%2Fnumba.pydata.org%2F" target="_blank" title="https://numba.pydata.org/" ref="nofollow noopener noreferrer">Numba</a> 这样的库，或者使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fpypy.org%2F" target="_blank" title="https://pypy.org/" ref="nofollow noopener noreferrer">PyPy</a> 这类替代性 Python 解释器。</p>
<p>如今，Python 官方终于把 JIT 编译器集成进了主干。虽然早期版本效果有限，但到了 Python <code>3.15</code>（当前仍处于 alpha 阶段，尚未正式发布），核心开发团队做了大量优化，使得 JIT 在某些计算密集型任务中已经能带来可观的加速。</p>
<p>当然，JIT 的提速效果因 workload 而异：有些程序飞快，有些则几乎没变化。不过好消息是，现在的 JIT 已经足够稳定，开发者完全可以拿来试试水，甚至在可控环境下用于生产测试。</p>
<h2 data-id="heading-0">如何启用 Python JIT？</h2>
<p>默认情况下，Python 的原生 JIT 是<strong>关闭</strong>的，毕竟它还是个实验性功能，需要手动开启。</p>
<p>启用方式很简单：设置环境变量 <code>PYTHON_JIT=1</code>。你可以：</p>
<ul>
<li>
<p>临时在当前 shell 会话中设置：</p>
<pre><code class="hljs language-sh" lang="sh"><span class="hljs-built_in">export</span> PYTHON_JIT=1
python your_script.py
</code></pre>
</li>
<li>
<p>或者直接在命令行前缀启动：</p>
<pre><code class="hljs language-sh" lang="sh">PYTHON_JIT=1 python your_script.py
</code></pre>
</li>
</ul>
<p>Python 启动时会检查 <code>PYTHON_JIT</code> 环境变量：只要值为 <code>1</code>，JIT 就会被激活；否则保持关闭。</p>
<p>虽然你可以把 <code>PYTHON_JIT=1</code> 写进系统环境变量长期生效，但更推荐按需启用——比如只在跑性能敏感任务时临时打开，避免对其他脚本产生意外影响。</p>
<h2 data-id="heading-1">如何确认 JIT 是否生效？</h2>
<p>从 Python 3.13 开始，标准库的 <code>sys</code> 模块新增了一个内部命名空间：<code>sys._jit</code>。它提供了三个实用函数，返回值都是 <code>True</code> 或 <code>False</code>：</p>
<ul>
<li><code>sys._jit.is_available()</code>：判断当前 Python 构建是否<strong>支持</strong> JIT。官方发布的大多数二进制包都包含 JIT 支持，但像“无线程”（freethreading）或“无 GIL”等特殊构建可能不包含。</li>
<li><code>sys._jit.is_enabled()</code>：检查 JIT 是否<strong>已启用</strong>。注意，这仅表示 JIT 功能打开了，并不代表你的代码已经被编译。</li>
<li><code>sys._jit.is_active()</code>：尝试判断当前栈顶帧是否正在执行 JIT 编译后的代码。<strong>但这个接口不太可靠</strong>——你的程序可能不小心进入了“冷路径”（即未被 JIT 优化的代码分支）。因此，最靠谱的方式还是通过<strong>实际性能对比</strong>来验证效果。</li>
</ul>
<p>日常使用中，<code>sys._jit.is_enabled()</code> 是最有用的，能快速确认 JIT 是否已成功开启。</p>
<h2 data-id="heading-2">JIT 加速效果实测：哪些代码能受益？</h2>
<p>由于 JIT 仍处于早期阶段，目前<strong>没有公开 API 能告诉你哪段函数被编译了</strong>，也无法直接查看优化状态。唯一靠谱的方法就是写 benchmark，对比开启/关闭 JIT 时的运行时间。</p>
<h3 data-id="heading-3">✅ 正面案例：Mandelbrot 分形计算</h3>
<p>下面这段代码实现了一个简化版的 Mandelbrot 集合渲染：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> time <span class="hljs-keyword">import</span> perf_counter
<span class="hljs-keyword">import</span> sys

<span class="hljs-built_in">print</span>(<span class="hljs-string">"JIT enabled:"</span>, sys._jit.is_enabled())

WIDTH = <span class="hljs-number">80</span>
HEIGHT = <span class="hljs-number">40</span>
X_MIN, X_MAX = -<span class="hljs-number">2.0</span>, <span class="hljs-number">1.0</span>
Y_MIN, Y_MAX = -<span class="hljs-number">1.0</span>, <span class="hljs-number">1.0</span>
ITERS = <span class="hljs-number">500</span>

YM = (Y_MAX - Y_MIN)
XM = (X_MAX - X_MIN)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">iter_</span>(<span class="hljs-params">c</span>):
    z = <span class="hljs-number">0j</span>
    <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(ITERS):
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">abs</span>(z) &gt; <span class="hljs-number">2.0</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>
        z = z ** <span class="hljs-number">2</span> + c
    <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">generate</span>():
    start = perf_counter()
    output = []

    <span class="hljs-keyword">for</span> y <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(HEIGHT):
        cy = Y_MIN + (y / HEIGHT) * YM
        <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(WIDTH):
            cx = X_MIN + (x / WIDTH) * XM
            c = <span class="hljs-built_in">complex</span>(cx, cy)
            output.append(<span class="hljs-string">"*"</span> <span class="hljs-keyword">if</span> iter_(c) <span class="hljs-keyword">else</span> <span class="hljs-string">"."</span>)
        output.append(<span class="hljs-string">"\n"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"Time:"</span>, perf_counter() - start)
    <span class="hljs-keyword">return</span> output

<span class="hljs-built_in">print</span>(<span class="hljs-string">""</span>.join(generate()))
</code></pre>
<p>运行后，程序会先打印 JIT 状态，再输出 ASCII 分形图和耗时。</p>
<p>实测发现：<strong>开启 JIT 后，运行时间稳定减少约 20%</strong> 。如果你感觉提速不明显，可以试着调高 <code>ITERS</code>（比如设为 2000），让计算量更大，加速效果就会更突出。</p>
<h3 data-id="heading-4">❌ 反面案例：递归斐波那契</h3>
<p>再看一个反例——经典的递归斐波那契实现：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> sys
<span class="hljs-built_in">print</span>(<span class="hljs-string">"JIT enabled:"</span>, sys._jit.is_enabled())
<span class="hljs-keyword">from</span> time <span class="hljs-keyword">import</span> perf_counter

<span class="hljs-keyword">def</span> <span class="hljs-title function_">fib</span>(<span class="hljs-params">n</span>):
    <span class="hljs-keyword">if</span> n &lt;= <span class="hljs-number">1</span>:
        <span class="hljs-keyword">return</span> n
    <span class="hljs-keyword">return</span> fib(n-<span class="hljs-number">1</span>) + fib(n-<span class="hljs-number">2</span>)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():
    start = perf_counter()
    result = fib(<span class="hljs-number">36</span>)
    <span class="hljs-built_in">print</span>(perf_counter() - start)

main()
</code></pre>
<p>截至 Python <code>3.15a3</code>，<strong>JIT 对这段代码几乎没有加速效果</strong>。</p>
<p>你可能会想：“是不是因为递归太深，JIT 不擅长处理？”但实测表明，即使改成循环版本，性能提升依然微乎其微。这说明当前 JIT 的优化策略对这类算法<strong>尚未覆盖</strong>，或者触发条件不满足。</p>
<h2 data-id="heading-5">使用建议：谨慎尝鲜，切勿冒进</h2>
<p>虽然 JIT 很有潜力，但它仍是实验性功能。对待它的态度，应该和“无线程构建”或“无 GIL 模式”一样：<strong>可以测试，但别急着上生产</strong>。</p>
<p>你可以：</p>
<ul>
<li>在自己的项目中开启 JIT，看看特定 workload 是否受益；</li>
<li>结合 <code>perf_counter()</code> 做 A/B 测试，量化实际收益；</li>
<li>关注后续 Python 版本的 JIT 改进。</li>
</ul>
<p>但务必注意：<strong>JIT 的行为在未来版本中可能发生变化</strong>。今天跑得快的代码，明天可能变慢；反之亦然。稳定性尚无法保证。</p>
<h2 data-id="heading-6">总结</h2>
<p>Python 原生 JIT 虽然还在襁褓之中，但已经展现出令人期待的潜力。随着 <code>3.15</code> 及后续版本的演进，我们有望看到更智能的编译策略、更广的适用场景，以及真正“开箱即用”的 Python 性能飞跃。现在，正是参与测试、反馈问题的好时机。</p>
<blockquote>
<p>原文<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.infoworld.com%2Farticle%2F4110565%2Fget-started-with-pythons-new-native-jit.html" target="_blank" title="https://www.infoworld.com/article/4110565/get-started-with-pythons-new-native-jit.html" ref="nofollow noopener noreferrer">www.infoworld.com/article/411…</a></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Flutter下拉刷新上拉加载侧拉刷新插件：easy_refresh全面使用指南]]></title>    <link>https://juejin.cn/post/7588680081327259690</link>    <guid>https://juejin.cn/post/7588680081327259690</guid>    <pubDate>2025-12-29T00:45:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588680081327259690" data-draft-id="7583576612390961162" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Flutter下拉刷新上拉加载侧拉刷新插件：easy_refresh全面使用指南"/> <meta itemprop="keywords" content="前端,Android,iOS"/> <meta itemprop="datePublished" content="2025-12-29T00:45:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="鹏多多"/> <meta itemprop="url" content="https://juejin.cn/user/747323639737191"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Flutter下拉刷新上拉加载侧拉刷新插件：easy_refresh全面使用指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/747323639737191/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    鹏多多
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T00:45:37.000Z" title="Mon Dec 29 2025 00:45:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:2;font-weight:400;font-size:15px;overflow-x:hidden;color:#333;letter-spacing:1.2px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1:first-child,.markdown-body h2:first-child,.markdown-body h3:first-child,.markdown-body h4:first-child,.markdown-body h5:first-child,.markdown-body h6:first-child{margin-top:-1.5rem;margin-bottom:1rem}.markdown-body h1:before,.markdown-body h2:before,.markdown-body h3:before,.markdown-body h4:before,.markdown-body h5:before,.markdown-body h6:before{content:"#";display:inline-block;color:#3eaf7c;padding-right:.23em}.markdown-body h1{position:relative;font-size:2.5rem;margin-bottom:5px}.markdown-body h1:before{font-size:2.5rem}.markdown-body h2{padding-bottom:.5rem;font-size:2.2rem;border-bottom:1px solid #ececec}.markdown-body h3{font-size:1.5rem;padding-bottom:0}.markdown-body h4{font-size:1.25rem}.markdown-body h5{font-size:1rem}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body strong{color:#3eaf7c}.markdown-body img{max-width:100%;border-radius:2px;display:block;margin:auto}.markdown-body hr{border:none;border-top:1px solid #3eaf7c;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;overflow-x:auto;padding:.2rem .5rem;margin:0;color:#3eaf7c;font-size:.85em;background-color:rgba(27,31,35,.05);border-radius:3px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border:.5rem solid #3eaf7c}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{font-weight:500;text-decoration:none;color:#3eaf7c;margin:0 5px}.markdown-body a:active,.markdown-body a:hover{text-decoration:none;border-bottom:1.5px solid #3eaf7c}.markdown-body a[href^=http]:after{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTQiIGhlaWdodD0iMTQiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik04MzIgMTI4SDY0MHY2NGgxNDYuNzUyTDUyMS4zNzYgNDU3LjM3Nmw0NS4yNDggNDUuMjQ4TDgzMiAyMzcuMjQ4VjM4NGg2NFYxMjh6IiBmaWxsPSIjM2VhZjdjIi8+PHBhdGggZD0iTTc2OCA4MzJIMTkyVjI1NmgzNTJ2LTY0SDE2MGEzMiAzMiAwIDAwLTMyIDMydjY0MGEzMiAzMiAwIDAwMzIgMzJoNjQwYTMyIDMyIDAgMDAzMi0zMlY0ODBoLTY0djM1MnoiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");margin-left:2px}.markdown-body a[href^="#"]:before{content:"#"}.markdown-body table{display:inline-block!important;font-size:13px;width:auto;max-width:100%;overflow:auto;border:1px solid #3eaf7c;border-collapse:collapse}.markdown-body thead{background:#3eaf7c;color:#fff;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(153,255,188,.1)}.markdown-body td,.markdown-body th{padding:4px 8px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#7b7878;padding:1px 23px;border-left:.5rem solid;border-color:#42b983;background-color:rgba(66,184,131,.1);position:relative;margin:14px 8px 0}.markdown-body blockquote:before{display:inline-block;position:absolute;content:url("data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjUiIGhlaWdodD0iMjUiIHZpZXdCb3g9IjAgMCAyNyAyNyIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxLjg2MiAxLjg2MikiIGZpbGwtcnVsZT0ibm9uemVybyIgZmlsbD0ibm9uZSI+PGNpcmNsZSBzdHJva2U9IiNGRkYiIHN0cm9rZS13aWR0aD0iMS43MjQiIGZpbGw9IiM0MkI5ODMiIGN4PSIxMS42MzgiIGN5PSIxMS42MzgiIHI9IjExLjYzOCIvPjxwYXRoIGQ9Ik0xNC45NzggNi4yN0E1LjAwNiA1LjAwNiAwIDAwNi42NyA5LjQ2OGE0LjkwMSA0LjkwMSAwIDAwMS43NzMgNC4zNjJjLjMyMy4yNTguNTE0LjY0Ny41MjIgMS4wNnYxLjA2YTIuNjg1IDIuNjg1IDAgMDA1LjM3IDB2LTEuMDA4Yy4wMDItLjM5OC4xNzMtLjc3Ny40Ny0xLjA0MmE1LjAyMyA1LjAyMyAwIDAwLjE3My03LjYzem0tMy4zMzcgMTAuOTY3YTEuMzA0IDEuMzA0IDAgMDEtMS4yODYtMS4yODd2LS4yNzhoMi41NzJ2LjI2MWMwIC43MTMtLjU3MyAxLjI5NC0xLjI4NiAxLjMwNHptMi4yNi00LjQxNWMtLjQ0LjM4My0uNzUuODkzLS44ODcgMS40NmgtMi43NDZhMi44NjggMi44NjggMCAwMC0uOTM4LTEuNTNoLS4wMThhMy40NzYgMy40NzYgMCAwMS0xLjI2OS0zLjE0NSAzLjYxNSAzLjYxNSAwIDAxNy4xOTYuNCAzLjY1IDMuNjUgMCAwMS0xLjMzOCAyLjgxNXoiIGZpbGw9IiNGRkYiLz48L2c+PC9zdmc+");width:25px;height:25px;left:-16px;top:12px}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body details{outline:none;border:none;border-left:4px solid #3eaf7c;padding-left:10px;margin-left:4px}.markdown-body details summary{cursor:pointer;border:none;outline:none;background:#fff;margin:0 -17px}.markdown-body details summary::-webkit-details-marker{color:#3eaf7c}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body ol li::marker{color:#3eaf7c}.markdown-body ul li{list-style:none;padding-left:10px}.markdown-body ul li::marker{content:"•";color:#3eaf7c}.markdown-body ul li.task-list-item:before{content:"";margin-right:0}.markdown-body input[type=checkbox]{vertical-align:text-bottom;box-shadow:inset 0 0 0 10px #fff}.markdown-body input[type=checkbox]:before{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTYiIGhlaWdodD0iMTYiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik04NzcuMDU2IDE0Ni45NDR2NzMwLjExMkgxNDYuOTQ0VjE0Ni45NDRoNzMwLjExMnptMC0xMDQuMjc3SDE0Ni45NDRjLTU3LjYyOCAwLTEwNC4yNzcgNDYuNjQ5LTEwNC4yNzcgMTA0LjI3N3Y3MzAuMTEyYzAgNTcuNjI4IDQ2LjY0OSAxMDQuMjc3IDEwNC4yNzcgMTA0LjI3N2g3MzAuMTEyYzU3LjYyOCAwIDEwNC4yNzctNDYuNjQ5IDEwNC4yNzctMTA0LjI3N1YxNDYuOTQ0YzAtNTcuNjI4LTQ2LjY0OS0xMDQuMjc3LTEwNC4yNzctMTA0LjI3N3oiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");position:relative;top:-2px;right:2px}.markdown-body input[type=checkbox]:checked:before{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTUiIGhlaWdodD0iMTUiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik05MTAuMjA4IDBIMTEzLjc2QTExNC4xMTIgMTE0LjExMiAwIDAwLS4wMzIgMTEzLjc5MlY5MTAuMjRjMCA2Mi41OTIgNTEuMiAxMTMuNzkyIDExMy43OTIgMTEzLjc5Mmg3OTYuNDQ4YzYyLjU5MiAwIDExMy43OTItNTEuMiAxMTMuNzkyLTExMy43OTJWMTEzLjc5MkMxMDI0IDUxLjIgOTcyLjggMCA5MTAuMjA4IDB6bS01MTIgNzk2LjQ0OEwxMTMuNzYgNTEybDc5LjY0OC03OS42NDggMjA0LjggMjA0LjhMODMwLjU2IDIwNC44bDc5LjY0OCA3OS42NDgtNTEyIDUxMnoiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");position:relative;top:-2px;right:2px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="agate">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#333;color:#fff}.hljs-name,.hljs-strong{font-weight:700}.hljs-code,.hljs-emphasis{font-style:italic}.hljs-tag{color:#62c8f3}.hljs-selector-class,.hljs-selector-id,.hljs-template-variable,.hljs-variable{color:#ade5fc}.hljs-bullet,.hljs-string{color:#a2fca2}.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-quote,.hljs-section,.hljs-title,.hljs-type{color:#ffa}.hljs-bullet,.hljs-number,.hljs-symbol{color:#d36363}.hljs-keyword,.hljs-literal,.hljs-selector-tag{color:#fcc28c}.hljs-code,.hljs-comment,.hljs-deletion{color:#888}.hljs-link,.hljs-regexp{color:#c6b4f0}.hljs-meta{color:#fc9b9b}.hljs-deletion{background-color:#fc9b9b;color:#333}.hljs-addition{background-color:#a2fca2;color:#333}.hljs a{color:inherit}.hljs a:focus,.hljs a:hover{color:inherit;text-decoration:underline}</style><p>easy_refresh 是 Flutter 生态中一款功能强大、高度可定制的下拉刷新与上拉加载更多插件，相比 Flutter 原生 <code>RefreshIndicator</code>，它支持更多刷新样式、自定义动画、多状态切换等高级特性，已成为 Flutter 项目中处理刷新加载场景的首选方案之一。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c34c102ae0c24c39a48633b80204b91c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bmP5aSa5aSa:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767573937&amp;x-signature=k%2BnDqMfSlvDvU4ZLFwx9PaENfik%3D" alt="下拉刷新.gif" loading="lazy"/></p>
<h2 data-id="heading-0">1. 快速集成</h2>
<p>在项目 <code>pubspec.yaml</code> 文件中添加最新版本依赖，可前往 <a href="https://link.juejin.cn?target=https%3A%2F%2Fpub.dev%2Fpackages%2Feasy_refresh" target="_blank" title="https://pub.dev/packages/easy_refresh" ref="nofollow noopener noreferrer">pub.dev</a> 查看最新版本：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">dependencies:</span>
  <span class="hljs-attr">flutter:</span>
    <span class="hljs-attr">sdk:</span> <span class="hljs-string">flutter</span>
  <span class="hljs-attr">easy_refresh:</span> <span class="hljs-string">^3.9.0</span> <span class="hljs-comment"># 以实际最新版本为准</span>
</code></pre>
<p>在需要使用的 Dart 文件中导入插件：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">import</span> <span class="hljs-string">'package:easy_refresh/easy_refresh.dart'</span>;
</code></pre>
<h2 data-id="heading-1">2. 核心 API 介绍</h2>
<p>以下表格汇总了 easy_refresh 的核心 API、功能说明及使用方式，覆盖核心组件与关键配置：</p>







































































<table><thead><tr><th>API 名称</th><th>类型</th><th>功能说明</th><th>使用方式</th></tr></thead><tbody><tr><td><code>EasyRefresh</code></td><td>组件（Widget）</td><td>核心容器组件，包裹需要实现刷新/加载的内容，提供刷新加载能力</td><td>作为父容器包裹 ListView/GridView 等滚动组件，配置 <code>onRefresh</code>/<code>onLoad</code> 回调</td></tr><tr><td><code>onRefresh</code></td><td>回调函数（Future Function()?）</td><td>下拉刷新触发的回调，用于执行刷新数据逻辑（如重新请求接口）</td><td><code>onRefresh: () async { await loadRefreshData(); }</code></td></tr><tr><td><code>onLoad</code></td><td>回调函数（Future Function()?）</td><td>上拉加载更多触发的回调，用于执行加载下一页数据逻辑</td><td><code>onLoad: () async { await loadMoreData(); }</code></td></tr><tr><td><code>header</code></td><td>组件（Widget?）</td><td>下拉刷新头部样式（指示器），支持内置样式与自定义</td><td>内置样式：<code>header: ClassicHeader()</code><br/>自定义：<code>header: CustomHeader()</code></td></tr><tr><td><code>footer</code></td><td>组件（Widget?）</td><td>上拉加载底部样式（指示器），支持内置样式与自定义</td><td>内置样式：<code>footer: ClassicFooter()</code><br/>自定义：<code>footer: CustomFooter()</code></td></tr><tr><td><code>EasyRefreshController</code></td><td>控制器类</td><td>手动控制刷新/加载状态（如主动触发刷新、结束加载状态）</td><td>1. 初始化：<code>final controller = EasyRefreshController()</code><br/>2. 主动刷新：<code>controller.callRefresh()</code><br/>3. 释放资源：<code>@override void dispose() { controller.dispose(); super.dispose(); }</code></td></tr><tr><td><code>finishRefresh</code></td><td>控制器方法</td><td>结束下拉刷新状态，可指定刷新结果（成功/失败/无更多）</td><td><code>controller.finishRefresh(RefreshResult.success);</code>（无更多：<code>RefreshResult.noMore</code>）</td></tr><tr><td><code>finishLoad</code></td><td>控制器方法</td><td>结束上拉加载状态，可指定加载结果（成功/失败/无更多）</td><td><code>controller.finishLoad(LoadResult.success);</code>（无更多：<code>LoadResult.noMore</code>）</td></tr><tr><td><code>enableRefresh</code></td><td>布尔值</td><td>是否启用下拉刷新功能，默认 <code>true</code></td><td><code>enableRefresh: false</code>（禁用下拉刷新）</td></tr><tr><td><code>enableLoad</code></td><td>布尔值</td><td>是否启用上拉加载功能，默认 <code>true</code></td><td><code>enableLoad: false</code>（禁用上拉加载）</td></tr></tbody></table>
<h2 data-id="heading-2">3. 常用内置样式</h2>
<p>easy_refresh 提供了多种开箱即用的头部/底部样式，满足大部分常规场景需求，核心样式如下：</p>















































<table><thead><tr><th>样式名称</th><th>类型</th><th>适用场景</th><th>使用示例</th></tr></thead><tbody><tr><td><code>ClassicHeader</code></td><td>下拉头部</td><td>常规列表刷新（仿原生样式）</td><td><code>header: ClassicHeader(textColor: Colors.black)</code></td></tr><tr><td><code>ClassicFooter</code></td><td>上拉底部</td><td>常规列表加载更多（仿原生样式）</td><td><code>footer: ClassicFooter(loadText: "正在加载...")</code></td></tr><tr><td><code>BallPulseHeader</code></td><td>下拉头部</td><td>简约加载动画（小球脉冲效果）</td><td><code>header: BallPulseHeader(color: Colors.blue)</code></td></tr><tr><td><code>BallPulseFooter</code></td><td>上拉底部</td><td>简约加载动画（小球脉冲效果）</td><td><code>footer: BallPulseFooter(color: Colors.blue)</code></td></tr><tr><td><code>MaterialHeader</code></td><td>下拉头部</td><td>Material Design 风格（与原生 RefreshIndicator 一致）</td><td><code>header: MaterialHeader()</code></td></tr><tr><td><code>MaterialFooter</code></td><td>上拉底部</td><td>Material Design 风格</td><td><code>footer: MaterialFooter()</code></td></tr></tbody></table>
<h2 data-id="heading-3">4. 完整使用案例</h2>
<p>以下案例实现了一个带下拉刷新、上拉加载更多的列表页面，包含数据模拟、状态控制、样式配置等核心功能，代码简洁可直接运行。</p>
<h3 data-id="heading-4">4.1.  完整代码</h3>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter/material.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:easy_refresh/easy_refresh.dart'</span>;

<span class="hljs-keyword">void</span> main() {
  runApp(<span class="hljs-keyword">const</span> MyApp());
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyApp</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{
  <span class="hljs-keyword">const</span> MyApp({<span class="hljs-keyword">super</span>.key});

  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> MaterialApp(
      title: <span class="hljs-string">'easy_refresh 使用案例'</span>,
      theme: ThemeData(primarySwatch: Colors.blue),
      home: <span class="hljs-keyword">const</span> EasyRefreshDemo(),
    );
  }
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EasyRefreshDemo</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  <span class="hljs-keyword">const</span> EasyRefreshDemo({<span class="hljs-keyword">super</span>.key});

  <span class="hljs-meta">@override</span>
  State&lt;EasyRefreshDemo&gt; createState() =&gt; _EasyRefreshDemoState();
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_EasyRefreshDemoState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">EasyRefreshDemo</span>&gt; </span>{
  <span class="hljs-comment">// 1. 初始化 EasyRefresh 控制器</span>
  <span class="hljs-keyword">final</span> EasyRefreshController _controller = EasyRefreshController();
  <span class="hljs-comment">// 列表数据</span>
  <span class="hljs-built_in">List</span>&lt;<span class="hljs-built_in">String</span>&gt; _listData = [];
  <span class="hljs-comment">// 当前页码</span>
  <span class="hljs-built_in">int</span> _currentPage = <span class="hljs-number">1</span>;
  <span class="hljs-comment">// 每页数据量</span>
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-built_in">int</span> _pageSize = <span class="hljs-number">10</span>;

  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> initState() {
    <span class="hljs-keyword">super</span>.initState();
    <span class="hljs-comment">// 初始化加载第一页数据</span>
    _loadRefreshData();
  }

  <span class="hljs-comment">// 2. 下拉刷新数据逻辑（重置页码，重新加载第一页）</span>
  Future&lt;<span class="hljs-keyword">void</span>&gt; _loadRefreshData() <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// 模拟网络请求延迟</span>
      <span class="hljs-keyword">await</span> Future.delayed(<span class="hljs-keyword">const</span> <span class="hljs-built_in">Duration</span>(seconds: <span class="hljs-number">1</span>));
      <span class="hljs-comment">// 重置页码</span>
      _currentPage = <span class="hljs-number">1</span>;
      <span class="hljs-comment">// 模拟数据</span>
      <span class="hljs-built_in">List</span>&lt;<span class="hljs-built_in">String</span>&gt; newData = <span class="hljs-built_in">List</span>.generate(_pageSize, (index) =&gt; <span class="hljs-string">"刷新数据 <span class="hljs-subst">${index + <span class="hljs-number">1</span>}</span>"</span>);
      setState(() {
        _listData = newData;
      });
      <span class="hljs-comment">// 结束刷新状态（成功）</span>
      _controller.finishRefresh(RefreshResult.success);
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-comment">// 结束刷新状态（失败）</span>
      _controller.finishRefresh(RefreshResult.fail);
      <span class="hljs-keyword">if</span> (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          <span class="hljs-keyword">const</span> SnackBar(content: Text(<span class="hljs-string">"刷新失败，请重试！"</span>)),
        );
      }
    }
  }

  <span class="hljs-comment">// 3. 上拉加载更多数据逻辑（页码+1，加载下一页）</span>
  Future&lt;<span class="hljs-keyword">void</span>&gt; _loadMoreData() <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// 模拟网络请求延迟</span>
      <span class="hljs-keyword">await</span> Future.delayed(<span class="hljs-keyword">const</span> <span class="hljs-built_in">Duration</span>(seconds: <span class="hljs-number">1</span>));
      <span class="hljs-comment">// 页码+1</span>
      _currentPage++;
      <span class="hljs-comment">// 模拟数据</span>
      <span class="hljs-built_in">List</span>&lt;<span class="hljs-built_in">String</span>&gt; moreData = <span class="hljs-built_in">List</span>.generate(_pageSize, (index) =&gt; <span class="hljs-string">"加载数据 <span class="hljs-subst">${(_currentPage - <span class="hljs-number">1</span>) * _pageSize + index + <span class="hljs-number">1</span>}</span>"</span>);
      setState(() {
        _listData.addAll(moreData);
      });

      <span class="hljs-comment">// 模拟无更多数据（第3页后无更多）</span>
      <span class="hljs-keyword">if</span> (_currentPage &gt;= <span class="hljs-number">3</span>) {
        _controller.finishLoad(LoadResult.noMore);
      } <span class="hljs-keyword">else</span> {
        _controller.finishLoad(LoadResult.success);
      }
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-comment">// 结束加载状态（失败）</span>
      _controller.finishLoad(LoadResult.fail);
      <span class="hljs-comment">// 页码回退</span>
      _currentPage--;
      <span class="hljs-keyword">if</span> (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          <span class="hljs-keyword">const</span> SnackBar(content: Text(<span class="hljs-string">"加载失败，请重试！"</span>)),
        );
      }
    }
  }

  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> dispose() {
    <span class="hljs-comment">// 释放控制器资源</span>
    _controller.dispose();
    <span class="hljs-keyword">super</span>.dispose();
  }

  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> Scaffold(
      appBar: AppBar(title: <span class="hljs-keyword">const</span> Text(<span class="hljs-string">"easy_refresh 示例"</span>)),
      body: EasyRefresh(
        <span class="hljs-comment">// 控制器</span>
        controller: _controller,
        <span class="hljs-comment">// 下拉头部样式</span>
        header: ClassicHeader(
          refreshText: <span class="hljs-string">"下拉可刷新"</span>,
          refreshingText: <span class="hljs-string">"正在刷新..."</span>,
          refreshedText: <span class="hljs-string">"刷新完成"</span>,
          textColor: Colors.black87,
        ),
        <span class="hljs-comment">// 上拉底部样式</span>
        footer: ClassicFooter(
          loadText: <span class="hljs-string">"上拉可加载"</span>,
          loadingText: <span class="hljs-string">"正在加载..."</span>,
          loadedText: <span class="hljs-string">"加载完成"</span>,
          noMoreText: <span class="hljs-string">"已加载全部数据"</span>,
          textColor: Colors.black87,
        ),
        <span class="hljs-comment">// 下拉刷新回调</span>
        onRefresh: _loadRefreshData,
        <span class="hljs-comment">// 上拉加载回调</span>
        onLoad: _loadMoreData,
        <span class="hljs-comment">// 启用刷新/加载</span>
        enableRefresh: <span class="hljs-keyword">true</span>,
        enableLoad: <span class="hljs-keyword">true</span>,
        <span class="hljs-comment">// 列表内容</span>
        child: ListView.builder(
          itemCount: _listData.length,
          itemBuilder: (context, index) {
            <span class="hljs-keyword">return</span> ListTile(
              title: Text(_listData[index]),
              leading: CircleAvatar(child: Text(<span class="hljs-string">"<span class="hljs-subst">${index + <span class="hljs-number">1</span>}</span>"</span>)),
            );
          },
        ),
      ),
    );
  }
}
</code></pre>
<h3 data-id="heading-5">4.2.  案例说明</h3>
<ol>
<li><strong>控制器使用</strong>：通过 <code>EasyRefreshController</code> 手动控制刷新/加载状态，避免异步请求后状态未及时更新的问题；</li>
<li><strong>数据模拟</strong>：使用 <code>Future.delayed</code> 模拟网络请求延迟，<code>List.generate</code> 生成测试数据，可直接替换为真实接口请求；</li>
<li><strong>状态处理</strong>：区分刷新/加载的成功、失败、无更多三种状态，提升用户体验；</li>
<li><strong>样式自定义</strong>：通过 <code>ClassicHeader</code>/<code>ClassicFooter</code> 自定义提示文字与文字颜色，适配不同主题风格；</li>
<li><strong>资源释放</strong>：在 <code>dispose</code> 方法中释放控制器资源，避免内存泄漏。</li>
</ol>
<h2 data-id="heading-6">5. 核心特性总结</h2>
<ol>
<li><strong>高度可定制</strong>：支持自定义头部/底部样式、刷新动画、触发阈值等，满足个性化需求；</li>
<li><strong>功能全面</strong>：支持下拉刷新、上拉加载、手动触发刷新/加载、无更多数据状态提示等；</li>
<li><strong>性能优异</strong>：滚动监听优化，无冗余渲染，适配 ListView/GridView/ScrollView 等所有滚动组件；</li>
<li><strong>兼容性好</strong>：支持 Flutter 多平台（Android、iOS、Web、桌面端），兼容最新 Flutter 版本。</li>
</ol>
<h2 data-id="heading-7">6. 扩展使用</h2>
<ul>
<li><strong>自定义头部/底部</strong>：继承 <code>Header</code>/<code>Footer</code> 类，实现自定义布局与动画，满足特殊UI需求；</li>
<li><strong>嵌套滚动支持</strong>：适配 <code>NestedScrollView</code>，可实现折叠导航栏+下拉刷新的组合场景；</li>
<li><strong>全局配置</strong>：通过 <code>EasyRefresh.defaultHeader</code>/<code>EasyRefresh.defaultFooter</code> 设置全局默认样式，减少重复代码。</li>
</ul>
<h2 data-id="heading-8">7. 总结</h2>
<p><code>easy_refresh</code> 是Flutter开发中<strong>轻量化、高适配、易拓展</strong>的下拉刷新与上拉加载插件，相比原生刷新组件，它解决了样式单一、状态控制繁琐、多端适配差的痛点，核心优势与使用要点总结如下：</p>
<ol>
<li>接入成本极低，仅需三步即可实现基础刷新加载功能，代码简洁无冗余，新手也能快速上手；</li>
<li>内置多款开箱即用的刷新/加载样式，同时支持高度自定义头部、底部布局与动画，适配各类UI设计需求；</li>
<li>提供完善的控制器API，可灵活实现手动触发刷新、多状态（成功/失败/无更多）管控，满足复杂业务场景；</li>
<li>全平台兼容，适配Android、iOS、Web及桌面端，且性能优异，无冗余渲染，不影响列表滚动流畅度；</li>
<li>支持嵌套滚动、全局样式配置等高级能力，可在项目中全局统一刷新风格，大幅减少重复开发工作。</li>
</ol>
<p>该插件能完美覆盖Flutter项目中<strong>列表刷新、分页加载、数据重载</strong>等核心场景，是处理滚动刷新加载需求的最优选择之一。</p>
<h3 data-id="heading-9">7.1. 引用来源</h3>
<ol>
<li><strong>easy_refresh 官方仓库</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fxuelongqy%2Fflutter_easy_refresh" target="_blank" title="https://github.com/xuelongqy/flutter_easy_refresh" ref="nofollow noopener noreferrer">GitHub - flutter_easyrefresh</a></li>
<li><strong>Flutter 官方包管理平台文档</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fpub.dev%2Fpackages%2Feasy_refresh" target="_blank" title="https://pub.dev/packages/easy_refresh" ref="nofollow noopener noreferrer">pub.dev - easy_refresh</a></li>
<li><strong>官方接口参考文档</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fpub.flutter-io.cn%2Fdocumentation%2Feasy_refresh%2Flatest%2F" target="_blank" title="https://pub.flutter-io.cn/documentation/easy_refresh/latest/" ref="nofollow noopener noreferrer">easy_refresh API 文档</a></li>
<li><strong>官方在线演示地址</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fxuelongqy.github.io%2Fflutter_easy_refresh%2F%23%2F" target="_blank" title="https://xuelongqy.github.io/flutter_easy_refresh/#/" ref="nofollow noopener noreferrer">easy_refresh 示例演示</a></li>
</ol>
<hr/>
<blockquote>
<p>本次分享就到这儿啦，我是鹏多多，深耕前端的技术创作者，如果您看了觉得有帮助，欢迎评论，关注，点赞，转发，我们下次见~</p>
</blockquote>
<p>PS：在本页按F12，在console中输入document.getElementsByClassName('panel-btn')[0].click();有惊喜哦~</p>
<p><code>往期文章</code></p>
<ul>
<li><a href="https://juejin.cn/post/7582808491582619684" target="_blank" title="https://juejin.cn/post/7582808491582619684">Flutter输入框TextField的属性与实战用法全面解析+示例</a></li>
<li><a href="https://juejin.cn/post/7581693431740448831" target="_blank" title="https://juejin.cn/post/7581693431740448831">Flutter自定义日历table_calendar完全指南+案例</a></li>
<li><a href="https://juejin.cn/post/7580389111921786943" target="_blank" title="https://juejin.cn/post/7580389111921786943">flutter-屏幕自适应插件flutter_screenutil教程全指南</a></li>
<li><a href="https://juejin.cn/post/7579101504289882166" target="_blank" title="https://juejin.cn/post/7579101504289882166">flutter-使用url_launcher打开链接/应用/短信/邮件和评分跳转等</a></li>
<li><a href="https://juejin.cn/post/7570923924365230143" target="_blank" title="https://juejin.cn/post/7570923924365230143">flutter图片选择库multi_image_picker_plus和image_picker的对比和使用解析</a></li>
<li><a href="https://juejin.cn/post/7568136081302978623" target="_blank" title="https://juejin.cn/post/7568136081302978623">解锁flutter弹窗新姿势：dialog-flutter_smart_dialog插件解读+案例</a></li>
<li><a href="https://juejin.cn/post/7559089440901545999" target="_blank" title="https://juejin.cn/post/7559089440901545999">flutter-切换状态显示不同组件10种实现方案全解析</a></li>
<li><a href="https://juejin.cn/post/7555079970491318308" target="_blank" title="https://juejin.cn/post/7555079970491318308">flutter-详解控制组件显示的两种方式Offstage与Visibility</a></li>
<li><a href="https://juejin.cn/post/7535358416182788122" target="_blank" title="https://juejin.cn/post/7535358416182788122">flutter-使用AnimatedDefaultTextStyle实现文本动画</a></li>
<li><a href="https://juejin.cn/post/7537339432291434496" target="_blank" title="https://juejin.cn/post/7537339432291434496">flutter-使用SafeArea组件处理各机型的安全距离</a></li>
<li><a href="https://juejin.cn/spost/7537593417099149321" target="_blank" title="https://juejin.cn/spost/7537593417099149321">flutter-实现渐变色边框背景以及渐变色文字</a></li>
<li><a href="https://juejin.cn/post/7543474419240370185" target="_blank" title="https://juejin.cn/post/7543474419240370185">flutter-使用confetti制作炫酷纸屑爆炸粒子动画</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[go+gin 入门指南]]></title>    <link>https://juejin.cn/post/7588376012121440283</link>    <guid>https://juejin.cn/post/7588376012121440283</guid>    <pubDate>2025-12-29T00:47:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588376012121440283" data-draft-id="7586957204584546340" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" go+gin 入门指南"/> <meta itemprop="keywords" content="Go,Gin"/> <meta itemprop="datePublished" content="2025-12-29T00:47:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="昵称为空C"/> <meta itemprop="url" content="https://juejin.cn/user/1267096172897005"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             go+gin 入门指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1267096172897005/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    昵称为空C
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T00:47:56.000Z" title="Mon Dec 29 2025 00:47:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>摘要：本文主要介绍了<code>go</code>语言环境的安装和<code>gin</code>框架的简单使用，就像<code>java</code>的<code>hello world</code>一样，简单入门，后续再进行项目实战。</p>
<h2 data-id="heading-0"><code>go</code>安装</h2>
<ul>
<li>安装</li>
</ul>
<blockquote>
<p><code>https://go.dev/dl/</code> 这个地址下载最新的版本，安装即可</p>
</blockquote>
<ul>
<li>设置环境变量</li>
</ul>

<pre><code class="hljs language-bash" lang="bash">go <span class="hljs-built_in">env</span> -w GOPROXY=https://goproxy.cn,direct
</code></pre>
<h2 data-id="heading-1"><code>vscode</code>设置</h2>
<ul>
<li>安装<code>go</code>插件</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cb037a264b73435d85b67c177a3061f0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pi156ew5Li656m6Qw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767574076&amp;x-signature=VzssTMLJZnoxXn9pfbv13dIQQT4%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>禁止打开网站文档</li>
</ul>
<blockquote>
<p>设置<code>.vscode/settings.json</code>文件，配置我们<code>ctrl+鼠标左键</code>跳转线上文档问题</p>
</blockquote>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"gopls"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"ui.navigation.importShortcut"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Definition"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"[go]"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"editor.links"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h2 data-id="heading-2">创建项目</h2>
<ul>
<li>先创建项目文件夹并初始化 Go 模块：</li>
</ul>

<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">mkdir</span> gin-quickstart &amp;&amp; <span class="hljs-built_in">cd</span> gin-quickstart
go mod init gin-quickstart
</code></pre>
<ul>
<li>安装 Gin 依赖：</li>
</ul>

<pre><code class="hljs language-arduino" lang="arduino">go get -u github.com/gin-gonic/gin
</code></pre>
<ul>
<li>创建<code>main.go</code></li>
</ul>

<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
  <span class="hljs-string">"github.com/gin-gonic/gin"</span>
  <span class="hljs-string">"net/http"</span>
)

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
  router := gin.Default()
  router.GET(<span class="hljs-string">"/ping"</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(c *gin.Context)</span></span> {
    c.JSON(http.StatusOK, gin.H{
      <span class="hljs-string">"message"</span>: <span class="hljs-string">"pong"</span>,
    })
  })
  router.Run()
}
</code></pre>
<ul>
<li>保存依赖</li>
</ul>

<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">go</span> mod tidy
</code></pre>
<h2 data-id="heading-3">运行案例</h2>
<ul>
<li>运行</li>
</ul>

<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">go</span> run ./main.<span class="hljs-keyword">go</span>
</code></pre>
<ul>
<li>测试</li>
</ul>

<pre><code class="hljs language-bash" lang="bash">curl http://localhost:8080/ping
{<span class="hljs-string">"message"</span>:<span class="hljs-string">"pong"</span>}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Redis哨兵模式详解：自动故障转移与高可用保障]]></title>    <link>https://juejin.cn/post/7588402359451451432</link>    <guid>https://juejin.cn/post/7588402359451451432</guid>    <pubDate>2025-12-29T00:59:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588402359451451432" data-draft-id="7490783352842305563" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Redis哨兵模式详解：自动故障转移与高可用保障"/> <meta itemprop="keywords" content="Redis,数据库,性能优化"/> <meta itemprop="datePublished" content="2025-12-29T00:59:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Go高并发架构_王工"/> <meta itemprop="url" content="https://juejin.cn/user/446863555701561"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Redis哨兵模式详解：自动故障转移与高可用保障
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/446863555701561/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Go高并发架构_王工
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T00:59:52.000Z" title="Mon Dec 29 2025 00:59:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读23分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">文章简介</h2>
<p>Redis作为一个高性能的内存数据库，以其超低的延迟和灵活的数据结构在互联网应用中无处不在。从缓存热点数据到实现分布式锁，从消息队列到实时排行榜，Redis几乎成了开发者的“瑞士军刀”。然而，随着业务规模的增长，单点Redis实例的局限性逐渐暴露：一旦主节点宕机，服务就会中断，数据的可用性和一致性面临挑战。这对追求业务连续性的场景（如电商、支付系统）来说无疑是致命的。</p>
<p>为了解决这一痛点，Redis提供了哨兵模式（Sentinel），一个轻量却强大的高可用解决方案。哨兵模式通过独立的监控节点，实现故障检测、自动切换和配置管理，确保Redis集群在主节点故障时仍能快速恢复服务。它就像一位忠诚的“守夜人”，时刻守护着Redis的稳定运行。</p>
<p>本文的目标是帮助有1-2年Redis使用经验的开发者深入理解哨兵模式的原理、部署与优化技巧。我们不仅会剖析其工作机制，还会结合真实项目案例，分享部署中的踩坑经验和解决方案。无论你是想提升系统的高可用性，还是在生产环境中规避潜在风险，这篇文章都将为你提供实用的指导和灵感。让我们一起走进Redis哨兵模式的世界吧！</p>
<hr/>
<h2 data-id="heading-1">一、Redis哨兵模式基础</h2>
<p>Redis哨兵模式是Redis生态中解决高可用问题的核心组件之一。理解它的基础原理，不仅能帮助我们更好地部署系统，还能为后续的优化打下坚实基础。本章将从定义入手，逐步讲解哨兵模式的必要性及其工作机制。</p>
<h3 data-id="heading-2">1.1 什么是Redis哨兵模式？</h3>
<p>Redis哨兵模式（Sentinel）是一个独立的监控与管理系统，专门用于管理Redis的主从复制架构。它并不是Redis核心服务的一部分，而是以单独进程运行的“助手”，负责监控主从节点的健康状态，并在主节点故障时自动完成切换。</p>
<p>与Redis主从复制相比，主从模式的核心是数据同步：主节点处理写请求，从节点同步数据并提供读服务。然而，主从复制本身无法应对主节点宕机的情况，这时候就需要哨兵模式登场。哨兵的三大核心功能包括：</p>
<ul>
<li><strong>故障检测</strong>：实时监控主从节点的运行状态。</li>
<li><strong>自动故障转移</strong>：当主节点故障时，选举从节点升级为主节点。</li>
<li><strong>配置管理</strong>：动态更新客户端的连接信息，确保服务不中断。</li>
</ul>
<p>简单来说，哨兵模式就像一个“智能管家”，为主从复制架构增加了自动化的运维能力。</p>
<h3 data-id="heading-3">1.2 为什么需要哨兵模式？</h3>
<p>在单节点Redis架构中，宕机意味着服务完全不可用。而主从复制虽然提高了读性能和数据冗余，却无法解决主节点故障后的切换问题。如果主节点挂了，从节点只能“干瞪眼”，等待人工干预。这种手动切换的方式在高并发业务中显然不现实：宕机时间越长，用户的损失越大。</p>
<p>现代业务对低延迟和高可靠性的要求日益严格。以电商系统为例，秒杀活动中如果Redis不可用，可能直接导致订单丢失，影响用户体验甚至收入。因此，高可用性成了Redis部署的刚需。哨兵模式应运而生，它通过自动化手段将故障恢复时间从分钟级缩短到秒级，完美契合了业务连续性的需求。</p>
<p>当然，Redis生态中还有其他高可用方案，比如Redis Cluster。它支持数据分片和分布式存储，适合大规模集群场景。但相比之下，哨兵模式的优势在于<strong>简单高效</strong>，部署成本低，适合中小型应用或对一致性要求较高的场景。选择哪种方案，取决于你的业务需求和资源投入。</p>
<h3 data-id="heading-4">1.3 哨兵模式的工作原理</h3>
<p>哨兵模式的核心在于多个哨兵节点协作完成监控和切换任务。它的运行机制可以用“侦察兵与指挥官”的比喻来理解：哨兵节点像侦察兵，持续探查主从节点的“脉搏”；一旦发现问题，它们会像指挥官一样协调行动，选出新的“领袖”。</p>
<p>哨兵的具体工作流程如下：</p>
<ol>
<li><strong>监控与心跳触发</strong>：哨兵通过定期发送PING命令检测主从节点的存活状态，同时订阅Redis的发布/订阅通道，获取集群变化。</li>
<li><strong>故障判断</strong>：
<ul>
<li><strong>主观下线（SDOWN）</strong>：单个哨兵认为某节点不可用（比如PING超时）。</li>
<li><strong>客观下线（ODOWN）</strong>：多个哨兵达成共识，确认节点确实故障（需要达到quorum法定人数）。</li>
</ul>
</li>
<li><strong>选举与切换</strong>：哨兵之间基于Raft算法的简化版本，选举一个领头哨兵，负责将某个从节点提升为主节点，并通知客户端更新配置。</li>
</ol>
<p>以下是一个简化的流程示意图：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-attr">[主节点]</span> ---故障--&gt; <span class="hljs-selector-attr">[哨兵1]</span> <span class="hljs-selector-attr">[哨兵2]</span> <span class="hljs-selector-attr">[哨兵3]</span>
    |                    |        |        |
<span class="hljs-selector-attr">[从节点1]</span>            检测       共识     选举
<span class="hljs-selector-attr">[从节点2]</span>            SDOWN --&gt; ODOWN --&gt; 切换
</code></pre>
<p>通过这样的机制，哨兵模式确保了即使主节点宕机，服务也能迅速恢复。值得注意的是，哨兵本身也需要部署多个实例，避免自身成为单点故障。</p>
<hr/>
<h2 data-id="heading-5">二、哨兵模式的优势与特色功能</h2>
<p>哨兵模式之所以能在Redis高可用方案中占据一席之地，离不开它在自动故障转移和高可用保障上的出色表现。本章将从核心优势入手，剖析其实现机制，并介绍一些鲜为人知的特色功能。通过这些内容，您将更清晰地看到哨兵模式如何为业务保驾护航。</p>
<h3 data-id="heading-6">2.1 自动故障转移的核心优势</h3>
<p>哨兵模式最大的亮点在于<strong>自动故障转移</strong>。相比需要人工介入的主从复制，它能在主节点故障时迅速接管局面，无需开发或运维人员半夜爬起来重启服务。这种自动化能力不仅降低了运维成本，还显著缩短了宕机时间。</p>
<p>在实际项目中，这种优势尤为明显。以我参与过的一个电商系统为例，秒杀活动期间，主节点因内存溢出意外宕机。得益于哨兵模式的部署，系统在5秒内完成了从节点到主节点的切换，用户几乎没有感知到服务中断。相比之下，如果依赖人工操作，排查问题、修改配置、重启服务可能需要10分钟以上，这段时间足以让大量订单流失。</p>
<p><strong>关键点</strong>：</p>
<ul>
<li><strong>快速恢复</strong>：故障切换通常在秒级完成，极大提升了SLA（服务水平协议）。</li>
<li><strong>无干预运行</strong>：解放人力，适合7×24小时运行的业务。</li>
</ul>
<h3 data-id="heading-7">2.2 高可用保障的实现</h3>
<p>哨兵模式的高可用性不仅体现在故障转移，还得益于其多节点协作和动态配置管理的设计。让我们逐一拆解：</p>
<h4 data-id="heading-8">多哨兵节点协作</h4>
<p>单个哨兵节点可能因网络抖动或自身故障误判，为了避免这种单点风险，哨兵模式支持部署多个哨兵实例。它们通过心跳检测和投票机制协同工作，只有当法定人数（quorum）达成一致时，才会触发故障转移。这种“集体决策”的方式就像一个“陪审团”，确保了切换的可靠性。</p>
<h4 data-id="heading-9">动态配置管理</h4>
<p>传统主从架构中，客户端需要硬编码主节点的地址，一旦切换发生，就得手动更新配置。而哨兵模式通过订阅机制，实时通知客户端新的主节点信息。这种“动态导航”的能力，让客户端无需关心底层切换细节，始终连接到正确的服务节点。</p>
<p>以下是一个使用Jedis客户端连接哨兵模式的示例代码：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> redis.clients.jedis.JedisSentinelPool;
<span class="hljs-keyword">import</span> redis.clients.jedis.Jedis;

<span class="hljs-keyword">import</span> java.util.HashSet;
<span class="hljs-keyword">import</span> java.util.Set;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SentinelExample</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 定义哨兵phosphor列表</span>
        Set&lt;String&gt; sentinels = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;&gt;();
        sentinels.add(<span class="hljs-string">"192.168.1.10:26379"</span>);
        sentinels.add(<span class="hljs-string">"192.168.1.11:26379"</span>);
        sentinels.add(<span class="hljs-string">"192.168.1.12:26379"</span>);

        <span class="hljs-comment">// 创建哨兵连接池，"mymaster"是哨兵配置中的主节点名称</span>
        <span class="hljs-type">JedisSentinelPool</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JedisSentinelPool</span>(<span class="hljs-string">"mymaster"</span>, sentinels);

        <span class="hljs-comment">// 获取Jedis实例，自动连接到当前主节点</span>
        <span class="hljs-keyword">try</span> (<span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> pool.getResource()) {
            jedis.set(<span class="hljs-string">"key"</span>, <span class="hljs-string">"Hello Sentinel!"</span>);
            System.out.println(jedis.get(<span class="hljs-string">"key"</span>)); <span class="hljs-comment">// 输出: Hello Sentinel!</span>
        }
    }
}
</code></pre>
<p><strong>代码说明</strong>：</p>
<ul>
<li><code>JedisSentinelPool</code>会根据哨兵提供的主节点地址动态创建连接。</li>
<li>即使主节点切换，客户端也能无缝感知新主节点，无需修改代码。</li>
</ul>
<h3 data-id="heading-10">2.3 特色功能解析</h3>
<p>除了故障转移和高可用，哨兵模式还有一些实用但容易被忽视的功能，值得深入了解。</p>
<h4 data-id="heading-11">订阅与通知机制</h4>
<p>哨兵支持Redis的发布/订阅机制，客户端可以通过订阅哨兵的事件通道（如<code>+switch-master</code>），实时感知主节点切换。例如，当主节点从<code>192.168.1.10</code>切换到<code>192.168.1.11</code>时，哨兵会推送一条消息，客户端可据此更新连接逻辑。这种机制就像一个“实时广播站”，让系统状态透明化。</p>
<h4 data-id="heading-12">主从选举算法</h4>
<p>哨兵在选择新主节点时，基于Raft算法的简化实现，综合考虑从节点的优先级（<code>slave-priority</code>）、数据同步进度和网络延迟等因素。这种“优中选优”的策略，确保了新主节点的可靠性和性能。</p>
<h4 data-id="heading-13">可配置性</h4>
<p>哨兵模式提供了丰富的参数供开发者调整，例如：</p>
<ul>
<li><strong><code>quorum</code></strong>：决定客观下线所需的哨兵票数。</li>
<li><strong><code>down-after-milliseconds</code></strong>：判定节点故障的超时时间。</li>
<li><strong><code>failover-timeout</code></strong>：故障转移的等待时间。<br/>
这些参数就像“旋钮”，可以根据业务需求灵活调优。</li>
</ul>
<p>以下是一个参数对比表格：</p>





























<table><thead><tr><th>参数</th><th>默认值</th><th>作用</th><th>调整建议</th></tr></thead><tbody><tr><td>quorum</td><td>2</td><td>客观下线所需的最小票数</td><td>设为哨兵总数的一半以上</td></tr><tr><td>down-after-milliseconds</td><td>30000 (30s)</td><td>检测故障的超时时间</td><td>高敏感业务可降至5000ms</td></tr><tr><td>failover-timeout</td><td>180000 (3min)</td><td>故障转移的最大等待时间</td><td>可根据切换频率调整</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-14">三、哨兵模式的部署与配置实践</h2>
<p>理论固然重要，但真正让哨兵模式发挥价值的，还是在生产环境中的落地实践。本章将带您从零开始搭建一个哨兵模式的Redis集群，涵盖环境准备、配置文件解析、客户端接入以及优化建议。无论您是初次尝试还是想优化现有部署，这里的内容都能为您提供清晰的指引。</p>
<h3 data-id="heading-15">3.1 部署哨兵模式的基本步骤</h3>
<p>部署哨兵模式并不复杂，但需要合理的规划和配置。以下是具体步骤：</p>
<h4 data-id="heading-16">环境准备</h4>
<p>首先，确定Redis实例和哨兵节点的分布。假设我们有3台服务器：</p>
<ul>
<li><strong>192.168.1.10</strong>：主节点（Redis端口6379）+ 哨兵节点（26379）</li>
<li><strong>192.168.1.11</strong>：从节点（Redis端口6379）+ 哨兵节点（26379）</li>
<li><strong>192.168.1.12</strong>：从节点（Redis端口6379）+ 哨兵节点（26379）</li>
</ul>
<p><strong>建议</strong>：哨兵节点与Redis实例分开部署在不同机器上，以避免单机故障影响整体可用性。</p>
<h4 data-id="heading-17">配置主从复制</h4>
<p>在主节点（192.168.1.10）的<code>redis.conf</code>中，保持默认配置即可。从节点的<code>redis.conf</code>需添加以下参数：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 指定主节点地址和端口</span>
replicaof 192.168.1.10 6379
<span class="hljs-comment"># 设置从节点只读（默认开启）</span>
replica-read-only <span class="hljs-built_in">yes</span>
</code></pre>
<p>启动主从实例后，通过<code>redis-cli -h 192.168.1.10 -p 6379 info replication</code>检查同步状态，确保从节点正常工作。</p>
<h4 data-id="heading-18">哨兵配置文件详解</h4>
<p>哨兵的配置文件是<code>sentinel.conf</code>，以下是一个基础示例：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 监控的主节点，格式：sentinel monitor &lt;主节点名称&gt; &lt;IP&gt; &lt;端口&gt; &lt;quorum&gt;</span>
sentinel monitor mymaster 192.168.1.10 6379 2
<span class="hljs-comment"># 故障检测超时时间（毫秒），若主节点未响应则标记为主观下线</span>
sentinel down-after-milliseconds mymaster 5000
<span class="hljs-comment"># 故障转移超时时间（毫秒），若切换未完成则认为失败</span>
sentinel failover-timeout mymaster 60000
<span class="hljs-comment"># 并行同步从节点数量，控制同步压力</span>
sentinel parallel-syncs mymaster 1
</code></pre>
<p><strong>配置说明</strong>：</p>
<ul>
<li><code>sentinel monitor</code>：定义监控的主节点，<code>mymaster</code>是自定义名称，<code>2</code>表示需要2个哨兵同意才能触发客观下线。</li>
<li><code>down-after-milliseconds</code>：建议根据业务敏感度调整，5秒适合大多数场景。</li>
<li><code>failover-timeout</code>：过短可能导致切换失败，过长则影响恢复速度。</li>
</ul>
<p>启动哨兵节点：</p>
<pre><code class="hljs language-bash" lang="bash">redis-sentinel /path/to/sentinel.conf
</code></pre>
<h3 data-id="heading-19">3.2 客户端接入哨兵模式</h3>
<p>哨兵模式部署好后，客户端需要正确接入才能享受高可用特性。这里以Java的两种主流客户端Jedis和Lettuce为例进行对比。</p>
<h4 data-id="heading-20">Jedis与Lettuce对比</h4>






























<table><thead><tr><th>特性</th><th>Jedis</th><th>Lettuce</th></tr></thead><tbody><tr><td>哨兵支持</td><td>通过<code>JedisSentinelPool</code></td><td>原生支持，配置简单</td></tr><tr><td>异步能力</td><td>无</td><td>支持异步和Reactive</td></tr><tr><td>性能</td><td>轻量，适合简单场景</td><td>更高吞吐量，线程安全</td></tr><tr><td>复杂度</td><td>配置稍繁琐</td><td>更现代化，易于扩展</td></tr></tbody></table>
<p>对于中小型项目，Jedis简单易用；对于高并发或微服务场景，Lettuce更具优势。</p>
<h4 data-id="heading-21">示例代码：Jedis客户端接入</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> redis.clients.jedis.JedisSentinelPool;
<span class="hljs-keyword">import</span> redis.clients.jedis.Jedis;

<span class="hljs-keyword">import</span> java.util.HashSet;
<span class="hljs-keyword">import</span> java.util.Set;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JedisSentinelDemo</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        Set&lt;String&gt; sentinels = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;&gt;();
        sentinels.add(<span class="hljs-string">"192.168.1.10:26379"</span>);
        sentinels.add(<span class="hljs-string">"192.168.1.11:26379"</span>);
        sentinels.add(<span class="hljs-string">"192.168.1.12:26379"</span>);

        <span class="hljs-comment">// 创建连接池</span>
        <span class="hljs-type">JedisSentinelPool</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JedisSentinelPool</span>(<span class="hljs-string">"mymaster"</span>, sentinels);

        <span class="hljs-keyword">try</span> (<span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> pool.getResource()) {
            jedis.set(<span class="hljs-string">"foo"</span>, <span class="hljs-string">"bar"</span>);
            System.out.println(<span class="hljs-string">"Value: "</span> + jedis.get(<span class="hljs-string">"foo"</span>)); <span class="hljs-comment">// 输出: bar</span>
        } <span class="hljs-keyword">catch</span> (Exception e) {
            e.printStackTrace();
        }
    }
}
</code></pre>
<p><strong>注意事项</strong>：</p>
<ul>
<li><strong>连接池配置</strong>：设置合理的<code>maxTotal</code>和<code>maxIdle</code>，避免连接耗尽。</li>
<li><strong>异常处理</strong>：主节点切换时可能短暂中断，需添加重试逻辑。</li>
</ul>
<h3 data-id="heading-22">3.3 部署中的最佳实践</h3>
<p>为了让哨兵模式在生产环境中更稳定，以下是一些从项目中总结的经验：</p>
<h4 data-id="heading-23">哨兵节点数量建议</h4>
<p>至少部署3个哨兵节点，且保持奇数分布（3、5、7等）。偶数可能因投票平局导致切换失败。节点分布在不同机器甚至不同机房，能有效提升容灾能力。</p>
<h4 data-id="heading-24">跨机房部署</h4>
<p>在多机房场景下，建议将主从和哨兵节点分散部署。例如：</p>
<ul>
<li>机房A：主节点 + 哨兵1</li>
<li>机房B：从节点1 + 哨兵2</li>
<li>机房C：从节点2 + 哨兵3<br/>
这样即使一个机房宕机，剩余哨兵仍能完成切换。</li>
</ul>
<h4 data-id="heading-25">日志与监控</h4>
<p>哨兵日志默认输出到启动终端，建议重定向到文件并结合工具监控：</p>
<ul>
<li><strong>ELK</strong>：收集日志，分析切换事件。</li>
<li><strong>Prometheus + Grafana</strong>：监控哨兵状态、主从延迟等指标。<br/>
示例Prometheus配置：</li>
</ul>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">scrape_configs:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">job_name:</span> <span class="hljs-string">'redis_sentinel'</span>
    <span class="hljs-attr">static_configs:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">targets:</span> [<span class="hljs-string">'192.168.1.10:26379'</span>, <span class="hljs-string">'192.168.1.11:26379'</span>, <span class="hljs-string">'192.168.1.12:26379'</span>]
</code></pre>
<p>以下是一个简单的部署架构图描述：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-attr">[主节点: 192.168.1.10:6379]</span> &lt;--&gt; <span class="hljs-selector-attr">[从节点: 192.168.1.11:6379]</span>
       |                            |
<span class="hljs-selector-attr">[哨兵1: 192.168.1.10:26379]</span>   <span class="hljs-selector-attr">[哨兵2: 192.168.1.11:26379]</span>
       \                          /
        <span class="hljs-selector-attr">[哨兵3: 192.168.1.12:26379]</span>
</code></pre>
<hr/>
<h2 data-id="heading-26">四、项目实战经验与踩坑分享</h2>
<p>理论和配置固然重要，但哨兵模式真正的考验来自于生产环境中的复杂挑战。本章将通过一个支付系统的高可用改造案例，展示哨兵模式的实战效果，同时分享我在项目中遇到的坑点和解决思路，希望能为您提供参考，避免“踩雷”。</p>
<h3 data-id="heading-27">4.1 真实案例：某支付系统的高可用改造</h3>
<h4 data-id="heading-28">背景</h4>
<p>在某支付系统中，Redis最初以单节点形式部署，用于存储订单状态和支付凭证。由于支付业务对延迟和可用性要求极高（99.99% SLA），单点Redis一旦宕机，后果不堪设想——用户支付失败、订单丢失，甚至引发投诉。</p>
<h4 data-id="heading-29">实施过程</h4>
<p>我们决定引入主从复制+哨兵模式，分三步改造：</p>
<ol>
<li><strong>主从复制</strong>：部署1主2从架构，主节点处理写请求，从节点支持读分离。</li>
<li><strong>哨兵模式</strong>：配置3个哨兵节点，分别与Redis实例同机部署（后期优化为跨机房）。</li>
<li><strong>客户端调整</strong>：将原有的Jedis直连改为<code>JedisSentinelPool</code>，确保动态感知主节点切换。</li>
</ol>
<p>改造后的架构如下：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-attr">[主节点: 192.168.1.10:6379]</span> --&gt; <span class="hljs-selector-attr">[从节点1: 192.168.1.11:6379]</span>
    |                              |
<span class="hljs-selector-attr">[哨兵1: 192.168.1.10:26379]</span>    <span class="hljs-selector-attr">[从节点2: 192.168.1.12:6379]</span>
    |                              |
<span class="hljs-selector-attr">[哨兵2: 192.168.1.11:26379]</span>    <span class="hljs-selector-attr">[哨兵3: 192.168.1.12:26379]</span>
</code></pre>
<h4 data-id="heading-30">成果</h4>
<p>在一轮压力测试中，我们模拟主节点宕机，哨兵模式在<strong>4秒内</strong>完成切换，新主节点迅速接管服务。对比之前手动恢复的10分钟，宕机时间缩短了两个数量级，用户体验和业务连续性显著提升。</p>
<p><strong>经验</strong>：从小规模测试开始，逐步验证哨兵的切换能力，是降低上线风险的关键。</p>
<h3 data-id="heading-31">4.2 常见坑点与解决方案</h3>
<p>生产环境中的哨兵模式并非万能，部署不当可能引发新问题。以下是我在多个项目中总结的三大坑点及应对策略。</p>
<h4 data-id="heading-32">坑点1：脑裂问题（Split-Brain）导致数据不一致</h4>
<p><strong>原因</strong>：网络分区导致哨兵误判，主节点被标记下线并触发切换，但原主节点仍在运行，最终出现“两个主节点”并存，数据发生分叉。<br/>
<strong>场景</strong>：某次机房网络抖动，哨兵未收到主节点心跳，切换了从节点，但老主节点仍在处理写请求。<br/>
<strong>解决</strong>：</p>
<ul>
<li>调整<code>quorum</code>参数为哨兵总数一半以上（如3个哨兵设为2），减少误判。</li>
<li>结合VIP（虚拟IP）或DNS，将客户端流量强制导向新主节点。</li>
<li>在Redis实例上启用<code>min-replicas-to-write 1</code>，确保主节点至少有1个从节点同步，否则拒绝写入。</li>
</ul>
<h4 data-id="heading-33">坑点2：哨兵节点全挂导致无法切换</h4>
<p><strong>原因</strong>：哨兵节点部署过于集中，单机故障或网络问题导致所有哨兵不可用，主节点宕机后无人接管。<br/>
<strong>场景</strong>：一次磁盘故障，同一机器上的Redis和哨兵同时挂掉，切换失败。<br/>
<strong>解决</strong>：</p>
<ul>
<li>哨兵节点分散部署，避免与Redis实例“同生共死”。</li>
<li>配置健康检查脚本，监控哨兵状态，发现异常及时告警：</li>
</ul>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>
sentinel_host=<span class="hljs-string">"192.168.1.10"</span>
sentinel_port=<span class="hljs-string">"26379"</span>
<span class="hljs-keyword">if</span> ! redis-cli -h <span class="hljs-variable">$sentinel_host</span> -p <span class="hljs-variable">$sentinel_port</span> ping | grep -q <span class="hljs-string">"PONG"</span>; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"Sentinel down!"</span> | mail -s <span class="hljs-string">"Alert"</span> admin@example.com
<span class="hljs-keyword">fi</span>
</code></pre>
<h4 data-id="heading-34">坑点3：客户端未及时感知主节点切换</h4>
<p><strong>原因</strong>：客户端未订阅哨兵事件，主节点切换后仍连接旧地址，导致请求失败。<br/>
<strong>场景</strong>：Jedis客户端未正确配置，切换后仍尝试连接已下线的主节点。<br/>
<strong>解决</strong>：</p>
<ul>
<li>使用<code>JedisSentinelPool</code>或Lettuce的哨兵支持，确保动态更新连接。</li>
<li>订阅哨兵事件，手动刷新连接池：</li>
</ul>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> redis.clients.jedis.JedisPubSub;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SentinelListener</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">JedisPubSub</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onMessage</span><span class="hljs-params">(String channel, String message)</span> {
        <span class="hljs-keyword">if</span> (channel.equals(<span class="hljs-string">"+switch-master"</span>)) {
            System.out.println(<span class="hljs-string">"Master switched: "</span> + message);
            <span class="hljs-comment">// 刷新连接逻辑</span>
        }
    }
}
</code></pre>
<h3 data-id="heading-35">4.3 性能优化建议</h3>
<p>为了让哨兵模式更稳定高效，以下是几点优化建议：</p>
<h4 data-id="heading-36">减少故障检测时间</h4>
<p>将<code>down-after-milliseconds</code>从默认30秒调至5秒，能加快故障感知速度。但过低可能因网络抖动导致误判，建议结合压测找到平衡点。</p>
<h4 data-id="heading-37">避免频繁切换</h4>
<p>若<code>failover-timeout</code>太短，主节点短暂抖动可能触发不必要的切换。建议设为60秒，并在日志中观察切换频率，动态调整。</p>
<h4 data-id="heading-38">项目经验：压测验证稳定性</h4>
<p>在上线前，我们对哨兵模式进行了模拟故障测试：</p>
<ul>
<li><strong>场景1</strong>：主节点断电，观察切换时间（平均4.2秒）。</li>
<li><strong>场景2</strong>：网络分区，验证脑裂防护（VIP切换成功）。</li>
<li><strong>结论</strong>：提前压测能暴露配置问题，减少生产事故。</li>
</ul>
<p>以下是一个优化后的参数对比表格：</p>





























<table><thead><tr><th>参数</th><th>默认值</th><th>优化值</th><th>效果</th></tr></thead><tbody><tr><td>down-after-milliseconds</td><td>30000ms</td><td>5000ms</td><td>加快故障检测</td></tr><tr><td>failover-timeout</td><td>180000ms</td><td>60000ms</td><td>减少无效切换</td></tr><tr><td>quorum</td><td>2</td><td>2（3哨兵）</td><td>平衡误判与切换可靠性</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-39">五、哨兵模式的局限性与未来展望</h2>
<p>哨兵模式作为Redis高可用的经典解决方案，在中小型场景中表现优异，但它并非万能。随着业务规模和复杂度的提升，一些局限性逐渐显现。本章将客观剖析哨兵模式的不足，同时结合技术趋势，探讨其未来的演进可能性。</p>
<h3 data-id="heading-40">5.1 哨兵模式的局限性</h3>
<p>尽管哨兵模式在自动故障转移和高可用性上表现出色，但它也有不可忽视的短板。以下是三大主要局限：</p>
<h4 data-id="heading-41">不支持分布式存储</h4>
<p>哨兵模式本质上是对主从复制的增强，数据仍集中存储在主节点，受到单机内存的限制。对于需要处理海量数据或高并发写操作的场景（如大数据分析、社交平台），哨兵模式显得力不从心。相比之下，Redis Cluster通过数据分片支持分布式存储，能轻松扩展到数百节点，适合大规模部署。</p>
<h4 data-id="heading-42">脑裂风险仍需关注</h4>
<p>尽管通过调整<code>quorum</code>和VIP可以缓解脑裂问题，但在复杂网络环境下（如跨地域部署），网络分区仍可能导致数据不一致。例如，主节点短暂失联被切换后恢复，又未及时降级为从节点，就会产生两个“主”，破坏一致性。这需要额外的运维手段来弥补。</p>
<h4 data-id="heading-43">与Redis Cluster的对比</h4>
<p>哨兵模式和Redis Cluster是Redis高可用的两大方案，各有千秋。以下是对比表格：</p>



































<table><thead><tr><th>特性</th><th>哨兵模式</th><th>Redis Cluster</th></tr></thead><tbody><tr><td>数据存储</td><td>单主集中式</td><td>分片分布式</td></tr><tr><td>高可用性</td><td>自动故障转移</td><td>多主+副本</td></tr><tr><td>扩展性</td><td>受限于单机内存</td><td>支持水平扩展</td></tr><tr><td>部署复杂度</td><td>简单</td><td>较高</td></tr><tr><td>适用场景</td><td>中小型、高一致性需求</td><td>大规模、高吞吐量需求</td></tr></tbody></table>
<p><strong>选择建议</strong>：若业务对一致性要求高且数据量可控，哨兵模式是首选；若需要高吞吐量和扩展性，Redis Cluster更合适。</p>
<h3 data-id="heading-44">5.2 未来演进方向</h3>
<p>随着技术的进步，哨兵模式也在不断适应新的需求和生态。以下是几个值得关注的趋势：</p>
<h4 data-id="heading-45">Redis官方优化</h4>
<p>Redis社区一直在完善哨兵模式。例如，6.0版本引入了更强的ACL（访问控制列表）和TLS支持，提升了安全性。未来可能在故障检测和切换算法上进一步优化，比如引入机器学习预测节点故障，减少误判率。</p>
<h4 data-id="heading-46">结合云原生</h4>
<p>在Kubernetes等云原生环境中，哨兵模式的部署变得更灵活。通过Operator或Helm Chart，可以自动化管理Redis实例和哨兵节点的生命周期。例如，Bitnami的Redis Helm Chart已支持哨兵模式，结合Service Mesh还能优化跨Pod通信。这种“容器化+自动化”的趋势，让哨兵模式在云端焕发新活力。</p>
<h4 data-id="heading-47">与微服务深度融合</h4>
<p>微服务架构下，Redis常作为共享缓存或分布式锁的载体。哨兵模式可以通过与服务注册中心（如Consul、Eureka）集成，实现更智能的配置管理。例如，哨兵将主节点变化推送到注册中心，客户端动态订阅更新，彻底摆脱硬编码的束缚。</p>
<p><strong>项目思考</strong>：我在一次微服务改造中尝试将哨兵事件与Spring Cloud的事件总线结合，客户端通过事件驱动刷新连接，效果显著。这种融合可能是未来的一个方向。</p>
<hr/>
<h2 data-id="heading-48">六、总结与建议</h2>
<p>经过前几章的深入剖析，我们对Redis哨兵模式有了全面的认识。从基础原理到部署实践，再到实战经验与未来展望，哨兵模式以其独特魅力成为Redis高可用方案中的一颗明珠。本章将总结其价值，并为开发者提供实用的建议，助您在实际项目中游刃有余。</p>
<h3 data-id="heading-49">总结哨兵模式的核心价值</h3>
<p>哨兵模式的核心在于<strong>简单高效的高可用保障</strong>。它通过自动故障转移、多节点协作和动态配置管理，将Redis从单点风险中解放出来，为业务连续性提供了坚实后盾。无论是电商秒杀的低延迟需求，还是支付系统的高可靠性要求，哨兵模式都能以较低的部署成本快速响应。相比Redis Cluster的复杂性，它更像一位“轻装上阵”的战士，适合中小型场景或对一致性敏感的业务。</p>
<h3 data-id="heading-50">给读者的实践建议</h3>
<p>基于前文的经验，以下是几点实操建议：</p>
<ol>
<li><strong>从小规模测试开始</strong>：先在开发环境搭建1主2从+3哨兵的迷你集群，模拟故障切换，熟悉配置和日志分析。</li>
<li><strong>逐步优化配置</strong>：根据业务需求调整<code>down-after-milliseconds</code>和<code>failover-timeout</code>，通过压测验证稳定性。</li>
<li><strong>关注监控与告警</strong>：结合Prometheus或ELK，实时监控哨兵状态，发现异常及时介入。</li>
<li><strong>避免单点风险</strong>：哨兵节点分散部署，跨机房布局是容灾的标配。</li>
<li><strong>善用客户端特性</strong>：选择支持哨兵的客户端（如Lettuce），并订阅事件动态更新连接。</li>
</ol>
<h3 data-id="heading-51">可关注的相关技术生态</h3>
<p>哨兵模式并非孤岛，它与周边技术生态的协同能放大其价值：</p>
<ul>
<li><strong>监控工具</strong>：Prometheus + Grafana可直观展示切换时间和集群健康。</li>
<li><strong>容器化</strong>：Kubernetes下的哨兵部署，能简化管理和扩展。</li>
<li><strong>服务治理</strong>：与Consul或Zookeeper结合，增强配置动态性。</li>
</ul>
<h3 data-id="heading-52">未来发展趋势判断</h3>
<p>展望未来，哨兵模式可能在云原生和智能化方向上持续演进。Redis官方或许会强化其算法效率，而与微服务、Serverless的深度融合也将是大势所趋。对于开发者来说，掌握哨兵模式不仅是技术储备，也是适应分布式系统趋势的必修课。</p>
<h3 data-id="heading-53">个人使用心得</h3>
<p>我在多个项目中使用哨兵模式后，最大的感触是：<strong>它简单却不失强大</strong>。一次支付系统的改造中，哨兵模式让我从“救火队员”变成了“幕后规划师”，故障恢复从慌乱的手动操作变为优雅的自动化切换。这种从容感，正是技术的魅力所在。我也鼓励大家在实践中多试错、多总结，找到适合自己业务的“哨兵之道”。</p>
<h3 data-id="heading-54">鼓励讨论</h3>
<p>哨兵模式的学习和应用是一个开放的过程。您在部署中遇到过哪些有趣的坑点？又有哪些优化心得？欢迎在评论区分享您的经验，让我们一起成长！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深入理解 C#.NET IEnumerable<T>：一切集合的起点]]></title>    <link>https://juejin.cn/post/7588402359451058216</link>    <guid>https://juejin.cn/post/7588402359451058216</guid>    <pubDate>2025-12-28T23:07:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588402359451058216" data-draft-id="7588425700003069987" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深入理解 C#.NET IEnumerable&lt;T&gt;：一切集合的起点"/> <meta itemprop="keywords" content="C#,.NET"/> <meta itemprop="datePublished" content="2025-12-28T23:07:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="唐青枫"/> <meta itemprop="url" content="https://juejin.cn/user/3737995266234280"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深入理解 C#.NET IEnumerable&lt;T&gt;：一切集合的起点
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3737995266234280/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    唐青枫
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-28T23:07:22.000Z" title="Sun Dec 28 2025 23:07:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">简介</h3>
<p><code>IEnumerable&lt;T&gt;</code> 是 <code>.NET</code> 中最核心的接口之一，位于 <code>System.Collections.Generic</code> 命名空间中。它代表一个可枚举的集合，支持在集合上进行迭代操作。</p>
<h4 data-id="heading-1"><code>IEnumerable&lt;T&gt;</code> 是什么？</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">IEnumerable</span>&lt;<span class="hljs-keyword">out</span> <span class="hljs-title">T</span>&gt; : <span class="hljs-title">IEnumerable</span>
{
    <span class="hljs-function">IEnumerator&lt;T&gt; <span class="hljs-title">GetEnumerator</span>()</span>;
}
</code></pre>
<ul>
<li>
<p>它定义了一个可枚举对象的契约；</p>
</li>
<li>
<p>任何实现了 <code>IEnumerable&lt;T&gt;</code> 的类型都能被 <code>foreach</code> 循环遍历；</p>
</li>
<li>
<p>泛型版 <code>IEnumerable&lt;T&gt;</code> 是非泛型 <code>IEnumerable</code> 的类型安全扩展；</p>
</li>
<li>
<p>它的核心方法只有一个：<code>GetEnumerator()</code>。</p>
</li>
</ul>
<h3 data-id="heading-2">IEnumerable 与 IEnumerator 的关系</h3>
<p>要理解 <code>IEnumerable&lt;T&gt;</code>，必须知道它依赖另一个接口：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">IEnumerator</span>&lt;<span class="hljs-keyword">out</span> <span class="hljs-title">T</span>&gt; : <span class="hljs-title">IDisposable</span>, <span class="hljs-title">IEnumerator</span>
{
    T Current { <span class="hljs-keyword">get</span>; }
    <span class="hljs-function"><span class="hljs-built_in">bool</span> <span class="hljs-title">MoveNext</span>()</span>;
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Reset</span>()</span>; <span class="hljs-comment">// 通常不实现</span>
}
</code></pre>
<p>关系示意图：</p>
<pre><code class="hljs language-scss" lang="scss">IEnumerable&lt;T&gt;
    └── <span class="hljs-built_in">GetEnumerator</span>()
          └── 返回 IEnumerator&lt;T&gt;
                  ├── <span class="hljs-built_in">MoveNext</span>() → 是否还有元素
                  ├── Current → 当前元素
                  └── <span class="hljs-built_in">Reset</span>() → 重置（可选）
</code></pre>
<h3 data-id="heading-3">基本用法</h3>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">using</span> System;
<span class="hljs-keyword">using</span> System.Collections.Generic;

<span class="hljs-keyword">class</span> <span class="hljs-title">Program</span>
{
    <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Main</span>()</span>
    {
        List&lt;<span class="hljs-built_in">string</span>&gt; fruits = <span class="hljs-keyword">new</span> List&lt;<span class="hljs-built_in">string</span>&gt; { <span class="hljs-string">"Apple"</span>, <span class="hljs-string">"Banana"</span>, <span class="hljs-string">"Cherry"</span> };
        
        <span class="hljs-comment">// 使用 foreach 遍历（推荐）</span>
        <span class="hljs-keyword">foreach</span> (<span class="hljs-built_in">string</span> fruit <span class="hljs-keyword">in</span> fruits)
        {
            Console.WriteLine(fruit);
        }
        
        <span class="hljs-comment">// 等价的手动迭代方式</span>
        IEnumerator&lt;<span class="hljs-built_in">string</span>&gt; enumerator = fruits.GetEnumerator();
        <span class="hljs-keyword">try</span>
        {
            <span class="hljs-keyword">while</span> (enumerator.MoveNext())
            {
                <span class="hljs-built_in">string</span> fruit = enumerator.Current;
                Console.WriteLine(fruit);
            }
        }
        <span class="hljs-keyword">finally</span>
        {
            enumerator?.Dispose();
        }
    }
}
</code></pre>
<h3 data-id="heading-4">手写一个 <code>IEnumerable&lt;T&gt;</code> 示例</h3>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">NumberCollection</span> : <span class="hljs-title">IEnumerable</span>&lt;<span class="hljs-title">int</span>&gt;
{
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span>[] _numbers = { <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span> };

    <span class="hljs-function"><span class="hljs-keyword">public</span> IEnumerator&lt;<span class="hljs-built_in">int</span>&gt; <span class="hljs-title">GetEnumerator</span>()</span>
    {
        <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> n <span class="hljs-keyword">in</span> _numbers)
            <span class="hljs-keyword">yield</span> <span class="hljs-keyword">return</span> n;
    }

    IEnumerator IEnumerable.GetEnumerator() =&gt; GetEnumerator();
}
</code></pre>
<p>使用：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">var</span> numbers = <span class="hljs-keyword">new</span> NumberCollection();
<span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> n <span class="hljs-keyword">in</span> numbers)
{
    Console.WriteLine(n);
}
</code></pre>
<p>输出：</p>
<pre><code class="hljs">1
2
3
4
5
</code></pre>
<h3 data-id="heading-5">yield return 的魔法</h3>
<p>等价于下面的展开版：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> IEnumerator&lt;<span class="hljs-built_in">int</span>&gt; <span class="hljs-title">GetEnumerator</span>()</span>
{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Enumerator();
}

<span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Enumerator</span> : <span class="hljs-title">IEnumerator</span>&lt;<span class="hljs-title">int</span>&gt;
{
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">int</span> _index = <span class="hljs-number">-1</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span>[] _numbers = { <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span> };

    <span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> Current =&gt; _numbers[_index];
    <span class="hljs-built_in">object</span> IEnumerator.Current =&gt; Current;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">bool</span> <span class="hljs-title">MoveNext</span>()</span>
    {
        _index++;
        <span class="hljs-keyword">return</span> _index &lt; _numbers.Length;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Reset</span>()</span> =&gt; _index = <span class="hljs-number">-1</span>;
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Dispose</span>()</span> { }
}
</code></pre>
<p><code>yield</code> 编译后自动生成状态机类，就是这种效果。</p>
<p>这也是 <code>LINQ</code> 延迟执行的基础机制。</p>
<h3 data-id="heading-6">foreach 的底层原理</h3>
<p>当写：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> item <span class="hljs-keyword">in</span> collection)
{
    Console.WriteLine(item);
}
</code></pre>
<p>编译器实际上生成：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">using</span> (<span class="hljs-keyword">var</span> enumerator = collection.GetEnumerator())
{
    <span class="hljs-keyword">while</span> (enumerator.MoveNext())
    {
        <span class="hljs-keyword">var</span> item = enumerator.Current;
        Console.WriteLine(item);
    }
}
</code></pre>
<h3 data-id="heading-7">延迟执行（Lazy Evaluation）</h3>
<p><code>LINQ</code> 查询（<code>Where</code>, <code>Select</code> 等）通常返回 <code>IEnumerable&lt;T&gt;</code>。
这些操作是延迟执行的：只有在遍历时才真正运行。</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">var</span> numbers = <span class="hljs-keyword">new</span>[] { <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span> };

<span class="hljs-keyword">var</span> query = numbers.Where(n =&gt; n &gt; <span class="hljs-number">2</span>).Select(n =&gt; n * <span class="hljs-number">10</span>);

Console.WriteLine(<span class="hljs-string">"Query created."</span>);
<span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> n <span class="hljs-keyword">in</span> query)
{
    Console.WriteLine(n);
}
</code></pre>
<p><code>Where / Select</code> 只是定义查询，不会立即执行。
直到 <code>foreach</code> 时，才会真正迭代并执行逻辑。</p>
<h3 data-id="heading-8">常见实现 <code>IEnumerable&lt;T&gt;</code> 的类型</h3>





































<table><thead><tr><th>类型</th><th>说明</th></tr></thead><tbody><tr><td><code>List&lt;T&gt;</code></td><td>基于数组实现的集合</td></tr><tr><td><code>T[]</code></td><td>数组</td></tr><tr><td><code>Dictionary&lt;TKey,TValue&gt;</code></td><td>键值对集合（枚举键值对）</td></tr><tr><td><code>HashSet&lt;T&gt;</code></td><td>不重复元素集合</td></tr><tr><td><code>Queue&lt;T&gt;</code> / <code>Stack&lt;T&gt;</code></td><td>队列与栈</td></tr><tr><td><code>string</code></td><td>实现了非泛型 <code>IEnumerable&lt;char&gt;</code></td></tr><tr><td><code>LINQ</code> 查询结果</td><td>延迟执行序列</td></tr></tbody></table>
<h3 data-id="heading-9">手写一个支持过滤的 <code>IEnumerable&lt;T&gt;</code></h3>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">FilteredCollection</span>&lt;<span class="hljs-title">T</span>&gt; : <span class="hljs-title">IEnumerable</span>&lt;<span class="hljs-title">T</span>&gt;
{
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> IEnumerable&lt;T&gt; _source;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> Func&lt;T, <span class="hljs-built_in">bool</span>&gt; _predicate;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">FilteredCollection</span>(<span class="hljs-params">IEnumerable&lt;T&gt; source, Func&lt;T, <span class="hljs-built_in">bool</span>&gt; predicate</span>)</span>
    {
        _source = source;
        _predicate = predicate;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> IEnumerator&lt;T&gt; <span class="hljs-title">GetEnumerator</span>()</span>
    {
        <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> item <span class="hljs-keyword">in</span> _source)
        {
            <span class="hljs-keyword">if</span> (_predicate(item))
                <span class="hljs-keyword">yield</span> <span class="hljs-keyword">return</span> item;
        }
    }

    IEnumerator IEnumerable.GetEnumerator() =&gt; GetEnumerator();
}
</code></pre>
<p>使用：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">var</span> list = <span class="hljs-keyword">new</span> List&lt;<span class="hljs-built_in">int</span>&gt; { <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span> };
<span class="hljs-keyword">var</span> filtered = <span class="hljs-keyword">new</span> FilteredCollection&lt;<span class="hljs-built_in">int</span>&gt;(list, x =&gt; x % <span class="hljs-number">2</span> == <span class="hljs-number">0</span>);

<span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> n <span class="hljs-keyword">in</span> filtered)
    Console.WriteLine(n);
</code></pre>
<h3 data-id="heading-10"><code>IEnumerable&lt;T&gt;</code> vs <code>IQueryable&lt;T&gt;</code></h3>



































<table><thead><tr><th>特性</th><th>IEnumerable</th><th>IQueryable</th></tr></thead><tbody><tr><td>执行时机</td><td>本地内存中</td><td>可翻译为远程查询（如 SQL）</td></tr><tr><td>适用场景</td><td>内存集合</td><td>数据库 ORM（EF Core 等）</td></tr><tr><td>表达式类型</td><td>委托（Func）</td><td>表达式树（Expression）</td></tr><tr><td>可延迟执行</td><td>✅</td><td>✅</td></tr><tr><td>例子</td><td><code>List&lt;T&gt;</code>, <code>Array</code>, <code>yield return</code></td><td><code>DbSet&lt;T&gt;</code></td></tr></tbody></table>
<p>示例：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// IEnumerable：在内存中过滤</span>
<span class="hljs-keyword">var</span> result1 = list.Where(x =&gt; x &gt; <span class="hljs-number">10</span>);

<span class="hljs-comment">// IQueryable：生成 SQL 查询</span>
<span class="hljs-keyword">var</span> result2 = db.Users.Where(x =&gt; x.Age &gt; <span class="hljs-number">10</span>);
</code></pre>
<h3 data-id="heading-11">IEnumerable 的扩展方法分类（LINQ 常用）</h3>





































<table><thead><tr><th>分类</th><th>示例方法</th></tr></thead><tbody><tr><td>过滤</td><td><code>Where</code>, <code>Distinct</code>, <code>Skip</code>, <code>Take</code></td></tr><tr><td>投影</td><td><code>Select</code>, <code>SelectMany</code></td></tr><tr><td>聚合</td><td><code>Count</code>, <code>Sum</code>, <code>Average</code>, <code>Aggregate</code></td></tr><tr><td>元素</td><td><code>First</code>, <code>Last</code>, <code>Single</code>, <code>ElementAt</code></td></tr><tr><td>组合</td><td><code>Concat</code>, <code>Union</code>, <code>Intersect</code>, <code>Except</code></td></tr><tr><td>排序</td><td><code>OrderBy</code>, <code>ThenBy</code>, <code>Reverse</code></td></tr><tr><td>转换</td><td><code>ToList</code>, <code>ToArray</code>, <code>ToDictionary</code></td></tr></tbody></table>
<h3 data-id="heading-12">高级特性</h3>
<h4 data-id="heading-13">自定义 LINQ 扩展方法</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title">MyLinqExtensions</span>
{
    <span class="hljs-comment">// 自定义 Where 方法</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-title">IEnumerable</span>&lt;<span class="hljs-title">T</span>&gt; <span class="hljs-title">Where</span>&lt;<span class="hljs-title">T</span>&gt;(<span class="hljs-params">
        <span class="hljs-keyword">this</span> IEnumerable&lt;T&gt; source, 
        Func&lt;T, <span class="hljs-built_in">bool</span>&gt; predicate</span>)</span>
    {
        <span class="hljs-keyword">foreach</span> (T item <span class="hljs-keyword">in</span> source)
        {
            <span class="hljs-keyword">if</span> (predicate(item))
            {
                <span class="hljs-keyword">yield</span> <span class="hljs-keyword">return</span> item;
            }
        }
    }
    
    <span class="hljs-comment">// 自定义 Select 方法</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-title">IEnumerable</span>&lt;<span class="hljs-title">TResult</span>&gt; <span class="hljs-title">Select</span>&lt;<span class="hljs-title">TSource</span>, <span class="hljs-title">TResult</span>&gt;(<span class="hljs-params">
        <span class="hljs-keyword">this</span> IEnumerable&lt;TSource&gt; source,
        Func&lt;TSource, TResult&gt; selector</span>)</span>
    {
        <span class="hljs-keyword">foreach</span> (TSource item <span class="hljs-keyword">in</span> source)
        {
            <span class="hljs-function"><span class="hljs-keyword">yield</span> <span class="hljs-keyword">return</span> <span class="hljs-title">selector</span>(<span class="hljs-params">item</span>)</span>;
        }
    }
    
    <span class="hljs-comment">// 自定义扩展方法</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-title">IEnumerable</span>&lt;<span class="hljs-title">T</span>&gt; <span class="hljs-title">SkipEveryOther</span>&lt;<span class="hljs-title">T</span>&gt;(<span class="hljs-params"><span class="hljs-keyword">this</span> IEnumerable&lt;T&gt; source</span>)</span>
    {
        <span class="hljs-built_in">bool</span> take = <span class="hljs-literal">true</span>;
        <span class="hljs-keyword">foreach</span> (T item <span class="hljs-keyword">in</span> source)
        {
            <span class="hljs-keyword">if</span> (take)
            {
                <span class="hljs-keyword">yield</span> <span class="hljs-keyword">return</span> item;
            }
            take = !take;
        }
    }
    
    <span class="hljs-comment">// 带索引的扩展方法</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-title">IEnumerable</span>&lt;<span class="hljs-title">TResult</span>&gt; <span class="hljs-title">SelectWithIndex</span>&lt;<span class="hljs-title">TSource</span>, <span class="hljs-title">TResult</span>&gt;(<span class="hljs-params">
        <span class="hljs-keyword">this</span> IEnumerable&lt;TSource&gt; source,
        Func&lt;TSource, <span class="hljs-built_in">int</span>, TResult&gt; selector</span>)</span>
    {
        <span class="hljs-built_in">int</span> index = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">foreach</span> (TSource item <span class="hljs-keyword">in</span> source)
        {
            <span class="hljs-function"><span class="hljs-keyword">yield</span> <span class="hljs-keyword">return</span> <span class="hljs-title">selector</span>(<span class="hljs-params">item, index</span>)</span>;
            index++;
        }
    }
}

<span class="hljs-comment">// 使用自定义扩展方法</span>
<span class="hljs-keyword">var</span> numbers = <span class="hljs-keyword">new</span> List&lt;<span class="hljs-built_in">int</span>&gt; { <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>, <span class="hljs-number">8</span> };
<span class="hljs-keyword">var</span> result = numbers.SkipEveryOther(); <span class="hljs-comment">// 返回 1, 3, 5, 7</span>

<span class="hljs-keyword">var</span> indexed = numbers.SelectWithIndex((num, idx) =&gt; <span class="hljs-string">$"Index <span class="hljs-subst">{idx}</span>: <span class="hljs-subst">{num}</span>"</span>);
</code></pre>
<h4 data-id="heading-14">无限序列</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title">InfiniteSequences</span>
{
    <span class="hljs-comment">// 无限数字序列</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> IEnumerable&lt;<span class="hljs-built_in">int</span>&gt; <span class="hljs-title">InfiniteNumbers</span>()</span>
    {
        <span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>)
        {
            <span class="hljs-keyword">yield</span> <span class="hljs-keyword">return</span> i++;
        }
    }
    
    <span class="hljs-comment">// 斐波那契数列</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> IEnumerable&lt;<span class="hljs-built_in">long</span>&gt; <span class="hljs-title">Fibonacci</span>()</span>
    {
        <span class="hljs-built_in">long</span> a = <span class="hljs-number">0</span>, b = <span class="hljs-number">1</span>;
        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>)
        {
            <span class="hljs-keyword">yield</span> <span class="hljs-keyword">return</span> a;
            <span class="hljs-built_in">long</span> temp = a;
            a = b;
            b = temp + b;
        }
    }
    
    <span class="hljs-comment">// 随机数序列</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> IEnumerable&lt;<span class="hljs-built_in">int</span>&gt; <span class="hljs-title">RandomNumbers</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> min, <span class="hljs-built_in">int</span> max</span>)</span>
    {
        Random rnd = <span class="hljs-keyword">new</span> Random();
        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>)
        {
            <span class="hljs-keyword">yield</span> <span class="hljs-keyword">return</span> rnd.Next(min, max);
        }
    }
}

<span class="hljs-comment">// 使用无限序列（一定要结合 Take 等方法使用）</span>
<span class="hljs-keyword">var</span> firstTenFibonacci = Fibonacci().Take(<span class="hljs-number">10</span>);
<span class="hljs-keyword">var</span> randomNumbers = RandomNumbers(<span class="hljs-number">1</span>, <span class="hljs-number">100</span>).Take(<span class="hljs-number">5</span>);
</code></pre>
<h4 data-id="heading-15">数据分页</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title">PagingExtensions</span>
{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-title">IEnumerable</span>&lt;<span class="hljs-title">IEnumerable</span>&lt;<span class="hljs-title">T</span>&gt;&gt; <span class="hljs-title">Page</span>&lt;<span class="hljs-title">T</span>&gt;(<span class="hljs-params"><span class="hljs-keyword">this</span> IEnumerable&lt;T&gt; source, <span class="hljs-built_in">int</span> pageSize</span>)</span>
    {
        <span class="hljs-keyword">var</span> page = <span class="hljs-keyword">new</span> List&lt;T&gt;(pageSize);
        <span class="hljs-keyword">foreach</span> (T item <span class="hljs-keyword">in</span> source)
        {
            page.Add(item);
            <span class="hljs-keyword">if</span> (page.Count == pageSize)
            {
                <span class="hljs-keyword">yield</span> <span class="hljs-keyword">return</span> page;
                page = <span class="hljs-keyword">new</span> List&lt;T&gt;(pageSize);
            }
        }
        
        <span class="hljs-keyword">if</span> (page.Count &gt; <span class="hljs-number">0</span>)
        {
            <span class="hljs-keyword">yield</span> <span class="hljs-keyword">return</span> page;
        }
    }
}

<span class="hljs-comment">// 使用分页</span>
<span class="hljs-keyword">var</span> bigCollection = Enumerable.Range(<span class="hljs-number">1</span>, <span class="hljs-number">1000</span>);
<span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> page <span class="hljs-keyword">in</span> bigCollection.Page(<span class="hljs-number">100</span>))
{
    Console.WriteLine(<span class="hljs-string">$"Page with <span class="hljs-subst">{page.Count()}</span> items"</span>);
    <span class="hljs-comment">// 处理当前页</span>
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[如何使用 PHP 的 for、while 和 foreach 循环实现极致性能与零 Bug 代码]]></title>    <link>https://juejin.cn/post/7588300640600244230</link>    <guid>https://juejin.cn/post/7588300640600244230</guid>    <pubDate>2025-12-28T23:20:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588300640600244230" data-draft-id="7588680081327112234" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="如何使用 PHP 的 for、while 和 foreach 循环实现极致性能与零 Bug 代码"/> <meta itemprop="keywords" content="后端,PHP"/> <meta itemprop="datePublished" content="2025-12-28T23:20:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="BingoGo"/> <meta itemprop="url" content="https://juejin.cn/user/993614242266077"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            如何使用 PHP 的 for、while 和 foreach 循环实现极致性能与零 Bug 代码
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/993614242266077/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    BingoGo
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-28T23:20:03.000Z" title="Sun Dec 28 2025 23:20:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">如何使用 PHP 的 for、while 和 foreach 循环实现极致性能与零 Bug 代码</h2>
<p>效率至关重要。对于 PHP 开发者来说，循环是最核心的语言结构之一。它能让你自动化重复任务、遍历数据结构，并以可控的方式执行操作。但高效的循环不仅仅是理解语法——更在于知道如何优化循环，编写运行快速、无 Bug 且能随项目增长而优雅扩展的代码。</p>
<p>无论你是处理大型数据集、复杂数组，还是试图优化 Web 应用的性能，本文都将深入探讨 PHP 循环的核心要点。我们将探索不同的循环类型——for、while 和 foreach——它们的最佳使用场景、性能优化技巧，以及能将你的 PHP 代码提升到全新水平的高级策略。</p>
<p>准备好迎接一份超越基础的综合指南。我们将讨论性能调优、内存优化、实际案例，以及如何避免开发者在使用循环时常犯的陷阱。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fcatchadmin.com%2Fpost%2F2025-12%2Fmastering-loops-in-php" target="_blank" title="https://catchadmin.com/post/2025-12/mastering-loops-in-php" ref="nofollow noopener noreferrer">原文 如何使用 PHP 的 for、while 和 foreach 循环实现极致性能与零 Bug 代码</a></p>
<h3 data-id="heading-1">理解 PHP 循环：快速回顾</h3>
<p>在深入优化之前，先回顾一下 PHP 中的 for、while 和 foreach 循环。理解它们之间的核心差异对于在代码中做出正确决策至关重要。</p>
<h4 data-id="heading-2">for 循环</h4>
<p>for 循环非常适合已知确切迭代次数的场景。它允许你遍历数字范围或固定集合，重复执行操作。</p>
<p>语法：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">for</span> (<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-number">10</span>; <span class="hljs-variable">$i</span>++) {
    <span class="hljs-comment">// 要执行的代码</span>
}
</code></pre>
<p>工作原理：</p>
<ul>
<li>初始化：<code>$i = 0</code> —— 设置起始值。</li>
<li>条件：<code>$i &lt; 10</code> —— 只要条件为真就继续循环。</li>
<li>迭代：<code>$i++</code> —— 每次迭代后递增循环计数器。</li>
</ul>
<p>理想使用场景：</p>
<ul>
<li>提前知道迭代次数时。</li>
<li>遍历数字范围或固定大小的集合。</li>
<li>性能至关重要时——在某些场景下 for 循环可能比其他循环更快。</li>
</ul>
<h4 data-id="heading-3">while 循环</h4>
<p>while 循环只要给定条件为真就会继续执行。与 for 循环不同，你在开始时并不知道迭代次数，这使它在结束条件动态变化的情况下非常灵活。</p>
<p>语法：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">while</span> (<span class="hljs-variable">$condition</span>) {
    <span class="hljs-comment">// 要执行的代码</span>
}
</code></pre>
<p>工作原理：</p>
<ul>
<li>只要 <code>$condition</code> 为真，循环就会无限期运行。</li>
<li>注意：如果条件永远不变为假，你会遇到无限循环，可能导致脚本冻结或崩溃。</li>
</ul>
<p>理想使用场景：</p>
<ul>
<li>不知道确切迭代次数时。</li>
<li>处理依赖用户输入或外部资源的事件或数据。</li>
<li>适用于读取数据流或等待外部响应。</li>
</ul>
<h4 data-id="heading-4">foreach 循环</h4>
<p>foreach 循环专门用于处理数组和对象。它是遍历数组最简单、最易读的方式，特别是当你不需要手动管理索引时。</p>
<p>语法：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$array</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$key</span> =&gt; <span class="hljs-variable">$value</span>) {
    <span class="hljs-comment">// 要执行的代码</span>
}
</code></pre>
<p>工作原理：</p>
<ul>
<li>每次迭代时，循环自动从数组或对象中获取键和值。</li>
<li>foreach 能无缝处理索引数组和关联数组。</li>
</ul>
<p>理想使用场景：</p>
<ul>
<li>遍历数组或对象时，特别是不需要修改数组时。</li>
<li>最适合需要同时使用键和值的关联数组。</li>
</ul>
<h3 data-id="heading-5">释放循环的力量：优化以实现最大性能</h3>
<p>现在我们理解了核心循环类型，让我们探索能帮助我们优化循环性能并消除可能拖慢或破坏应用的 Bug 的技术。</p>
<h4 data-id="heading-6">消除循环内的冗余计算</h4>
<p>开发者最常犯的错误之一是在循环内执行不依赖循环变量的计算。这些冗余操作会不必要地拖慢代码。</p>
<p>低效示例：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">for</span> (<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-title function_ invoke__">count</span>(<span class="hljs-variable">$array</span>); <span class="hljs-variable">$i</span>++) {
    <span class="hljs-comment">// 每次迭代都重复调用 count()</span>
    <span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">count</span>(<span class="hljs-variable">$array</span>);
}
</code></pre>
<p>在这种情况下，<code>count($array)</code> 在每次迭代时都会被计算，如果数组很大，这会很昂贵。</p>
<p>优化示例：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$arrayCount</span> = <span class="hljs-title function_ invoke__">count</span>(<span class="hljs-variable">$array</span>);  <span class="hljs-comment">// 在循环前计算一次</span>
<span class="hljs-keyword">for</span> (<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-variable">$arrayCount</span>; <span class="hljs-variable">$i</span>++) {
    <span class="hljs-keyword">echo</span> <span class="hljs-variable">$arrayCount</span>;
}
</code></pre>
<p>通过在循环前存储 <code>count($array)</code> 的结果，我们避免了每次循环运行时的重复计算，从而实现更快的执行。</p>
<h4 data-id="heading-7">最小化循环内的昂贵函数调用</h4>
<p>PHP 函数调用，特别是像 <code>strlen()</code>、<code>array_search()</code> 或数据库查询这样的操作，在循环内调用时会增加显著的开销。为了优化代码，确保避免重复调用这些函数。</p>
<p>低效示例：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">for</span> (<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-title function_ invoke__">count</span>(<span class="hljs-variable">$array</span>); <span class="hljs-variable">$i</span>++) {
    <span class="hljs-variable">$length</span> = <span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$str</span>);  <span class="hljs-comment">// 每次迭代都执行昂贵操作</span>
    <span class="hljs-keyword">echo</span> <span class="hljs-variable">$length</span>;
}
</code></pre>
<p>优化示例：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$length</span> = <span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$str</span>);  <span class="hljs-comment">// 在循环外调用一次</span>
<span class="hljs-keyword">for</span> (<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-title function_ invoke__">count</span>(<span class="hljs-variable">$array</span>); <span class="hljs-variable">$i</span>++) {
    <span class="hljs-keyword">echo</span> <span class="hljs-variable">$length</span>;  <span class="hljs-comment">// 重用预计算的值</span>
}
</code></pre>
<p>这个小改动可以带来显著的性能提升，特别是在较大的循环中。</p>
<h4 data-id="heading-8">避免大数据集的嵌套循环</h4>
<p>嵌套循环是性能瓶颈的常见原因。当循环嵌套时，总时间复杂度会快速增长，导致代码效率低下。相反，尝试扁平化数据结构或使用更优化的算法。</p>
<p>低效示例：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$array1</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$value1</span>) {
    <span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$array2</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$value2</span>) {
        <span class="hljs-comment">// 某些操作</span>
    }
}
</code></pre>
<p>在这种情况下，如果 <code>$array1</code> 和 <code>$array2</code> 都很大，循环将具有 O(n²) 的时间复杂度，这可能是致命的。</p>
<p>优化示例：</p>
<ul>
<li>与其使用嵌套循环，不如尝试扁平化数组或使用哈希表进行快速查找等技术。</li>
<li>你也可以根据具体问题用更高效的算法替换嵌套循环。</li>
</ul>
<h4 data-id="heading-9">利用生成器实现内存效率</h4>
<p>PHP 生成器是一个强大的特性，允许你一次产出一个数据项，减少内存消耗并在处理大数据集时提升性能。与常规函数不同，生成器不会将整个数据集加载到内存中；它们按需生成每个值。</p>
<p>生成器示例：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getLargeDataset</span>(<span class="hljs-params"/>) </span>{
    <span class="hljs-keyword">for</span> (<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-number">1000000</span>; <span class="hljs-variable">$i</span>++) {
        <span class="hljs-keyword">yield</span> <span class="hljs-variable">$i</span>;  <span class="hljs-comment">// 一次产出一个值</span>
    }
}
<span class="hljs-keyword">foreach</span> (<span class="hljs-title function_ invoke__">getLargeDataset</span>() <span class="hljs-keyword">as</span> <span class="hljs-variable">$value</span>) {
    <span class="hljs-comment">// 处理每个值</span>
}
</code></pre>
<p>通过使用生成器，你可以处理无法一次性全部加载到内存中的数据集，使其成为处理大规模数据的强大工具。</p>
<h4 data-id="heading-10">在循环外预计算值</h4>
<p>如果你执行的计算或获取的值在所有迭代中保持不变，在循环开始前计算一次。这减少了不必要的操作并提升性能。</p>
<p>低效示例：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">for</span> (<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-title function_ invoke__">count</span>(<span class="hljs-variable">$array</span>); <span class="hljs-variable">$i</span>++) {
    <span class="hljs-variable">$result</span> = <span class="hljs-title function_ invoke__">expensiveOperation</span>(<span class="hljs-variable">$array</span>[<span class="hljs-variable">$i</span>]);  <span class="hljs-comment">// 每次迭代都执行昂贵操作</span>
    <span class="hljs-comment">// 处理 $result</span>
}
</code></pre>
<p>优化示例：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$preCalculatedResults</span> = <span class="hljs-title function_ invoke__">array_map</span>(<span class="hljs-string">'expensiveOperation'</span>, <span class="hljs-variable">$array</span>);  <span class="hljs-comment">// 执行一次操作</span>
<span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$preCalculatedResults</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$result</span>) {
    <span class="hljs-comment">// 处理预计算的 $result</span>
}
</code></pre>
<p>通过使用像 <code>array_map()</code> 或 <code>array_walk()</code> 这样的 PHP 函数，你可以在进入循环前预处理数据，最小化循环内的冗余函数调用。</p>
<h3 data-id="heading-11">应对常见陷阱：避免循环中的 Bug 和陷阱</h3>
<p>虽然 PHP 循环很强大，但如果使用不当也会带来风险。让我们探索一些常见陷阱以及如何避免它们。</p>
<h4 data-id="heading-12">避免无限循环</h4>
<p>当循环条件永远无法满足时就会发生无限循环，导致循环无休止地运行。这是最令人沮丧的 Bug 之一，但可以通过确保条件最终变为假来避免。</p>
<p>低效示例：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">while</span> (<span class="hljs-variable">$condition</span>) {
    <span class="hljs-comment">// 如果条件永远不变，这个循环可能永远运行</span>
}
</code></pre>
<p>解决方案：确保条件在循环内更新，或在必要时使用 break。</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">while</span> (<span class="hljs-variable">$condition</span>) {
    <span class="hljs-comment">// 要执行的代码</span>
    <span class="hljs-variable">$condition</span> = <span class="hljs-title function_ invoke__">updateCondition</span>();  <span class="hljs-comment">// 在循环内更新条件</span>
}
</code></pre>
<h4 data-id="heading-13">差一错误</h4>
<p>差一错误在遍历数组或范围时极为常见。一个常见错误是不正确地定义循环的结束条件，这可能导致访问无效的数组索引或执行不必要的迭代。</p>
<p>低效示例：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">for</span> (<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt;= <span class="hljs-title function_ invoke__">count</span>(<span class="hljs-variable">$array</span>); <span class="hljs-variable">$i</span>++) {
    <span class="hljs-keyword">echo</span> <span class="hljs-variable">$array</span>[<span class="hljs-variable">$i</span>];  <span class="hljs-comment">// 可能访问越界索引</span>
}
</code></pre>
<p>解决方案：遍历数组时使用 <code>&lt;</code> 而不是 <code>&lt;=</code>。</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">for</span> (<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-title function_ invoke__">count</span>(<span class="hljs-variable">$array</span>); <span class="hljs-variable">$i</span>++) {
    <span class="hljs-keyword">echo</span> <span class="hljs-variable">$array</span>[<span class="hljs-variable">$i</span>];  <span class="hljs-comment">// 安全的数组访问</span>
}
</code></pre>
<h4 data-id="heading-14">数组越界访问</h4>
<p>在不验证索引是否存在的情况下访问数组元素可能导致错误。确保你的循环正确处理数组边界。</p>
<p>低效示例：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">for</span> (<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-title function_ invoke__">count</span>(<span class="hljs-variable">$array</span>); <span class="hljs-variable">$i</span>++) {
    <span class="hljs-keyword">echo</span> <span class="hljs-variable">$array</span>[<span class="hljs-variable">$i</span>];  <span class="hljs-comment">// 有访问未定义索引的风险</span>
}
</code></pre>
<p>解决方案：在访问数组元素前始终检查索引是否存在。</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">for</span> (<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-title function_ invoke__">count</span>(<span class="hljs-variable">$array</span>); <span class="hljs-variable">$i</span>++) {
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$array</span>[<span class="hljs-variable">$i</span>])) {
        <span class="hljs-keyword">echo</span> <span class="hljs-variable">$array</span>[<span class="hljs-variable">$i</span>];  <span class="hljs-comment">// 安全的数组访问</span>
    }
}
</code></pre>
<h3 data-id="heading-15">总结</h3>
<p>掌握 PHP 循环不仅仅是理解它们的语法——更在于利用它们编写不仅功能完善，而且快速、内存高效且无 Bug 的代码。通过遵循本文概述的技术，你可以优化循环来处理大数据集、提升性能，并避免最常见的陷阱。</p>
<p>核心要点：</p>
<ul>
<li>for 循环适合已知迭代次数的场景。</li>
<li>while 循环非常适合依赖动态因素的条件。</li>
<li>foreach 循环简化了数组和对象的遍历，无需手动索引。</li>
<li>优化循环涉及最小化冗余操作、尽可能避免嵌套循环、使用生成器实现内存效率，以及仔细处理边界情况。</li>
</ul>
<p>有了这些最佳实践和性能技巧，你将编写出更高效、可扩展的 PHP 代码，不仅运行快速，而且更易于维护和调试。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[用 NAudio 做一个音频播放器及原理]]></title>    <link>https://juejin.cn/post/7588109656042586158</link>    <guid>https://juejin.cn/post/7588109656042586158</guid>    <pubDate>2025-12-29T00:00:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588109656042586158" data-draft-id="7588461466597998643" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="用 NAudio 做一个音频播放器及原理"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-29T00:00:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="古茗前端团队"/> <meta itemprop="url" content="https://juejin.cn/user/3233040624266695"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            用 NAudio 做一个音频播放器及原理
            <!----> <!----></h1> <div class="container team-follow" data-v-d326b38e="" data-v-61fb5e44=""><div class="left" data-v-d326b38e=""><a href="/team/7198439419173404711/posts" data-v-d326b38e=""><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/dafcebf7c91d402abd52f072a32deba8~tplv-k3u1fbpfcp-watermark.image?" class="icon" data-v-d326b38e=""/></a> <div class="content" data-v-d326b38e=""><div style="display: flex" data-v-d326b38e=""><a href="/team/7198439419173404711/posts" data-v-d326b38e=""><p class="title-line" data-v-d326b38e=""><span title="古茗前端团队" class="title" data-v-d326b38e="">古茗前端团队</span> <img src="//lf-web-assets.juejin.cn/obj/juejin-web/xitu_juejin_web/255e400027b783cbad76dc41527e7695.svg" alt="team icon" class="team-icon" data-v-d326b38e=""/></p></a></div> <div class="meta-box team" data-v-d326b38e="" data-v-61fb5e44=""><time datetime="2025-12-29T00:00:02.000Z" title="Mon Dec 29 2025 00:00:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-d326b38e="" data-v-61fb5e44="">
                2025-12-29
              </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-d326b38e="" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-d326b38e="" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-d326b38e="" data-v-61fb5e44=""/></svg> <span class="views-count" style="display:none;" data-v-d326b38e="" data-v-61fb5e44="">
                0
              </span> <span class="read-time" data-v-d326b38e="" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-d326b38e="" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-d326b38e="" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-d326b38e="" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-d326b38e="" data-v-61fb5e44=""/></svg>
                阅读1分钟
              </span> <!----> <!----></div></div></div> <button class="jj-follow-button follow-btn" style="display:none;" data-v-b60b2868="" data-v-d326b38e=""><span data-v-b60b2868="" data-v-d326b38e=""><i class="byte-icon byte-icon--plus" data-v-d326b38e=""><svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 48 48"><path fill="none" d="M0 0h48v48H0z"/><path d="M24.7 4c.4 0 .6 0 .8.1.2.1.3.2.4.4.1.2.1.3.1.8V22h16.7c.4 0 .6 0 .8.1.2.1.3.2.4.4.1.2.1.3.1.8v1.4c0 .4 0 .6-.1.8-.1.2-.2.3-.4.4-.2.1-.3.1-.8.1H26v16.7c0 .4 0 .6-.1.8-.1.2-.2.3-.4.4-.2.1-.3.1-.8.1h-1.4c-.4 0-.6 0-.8-.1-.2-.1-.3-.2-.4-.4-.1-.2-.1-.3-.1-.8V26H5.3c-.4 0-.6 0-.8-.1-.2-.1-.3-.2-.4-.4-.1-.2-.1-.3-.1-.8v-1.4c0-.4 0-.6.1-.8.1-.2.2-.3.4-.4.2-.1.3-.1.8-.1H22V5.3c0-.4 0-.6.1-.8.1-.2.2-.3.4-.4.2-.1.3-.1.8-.1h1.4z"/></svg></i>
        关注
      </span></button></div> <div class="team-user block-hidden" data-v-61fb5e44=""><div class="avatar jj-avatar avatar" data-v-03256cc6="" data-v-61fb5e44=""><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8AQMAAAAAMksxAAAAA1BMVEUAAACnej3aAAAAAXRSTlMAQObYZgAAAA5JREFUKM9jGAWjAAcAAAIcAAE27nY6AAAAAElFTkSuQmCC" alt="avatar" class="lazy avatar-img" data-v-5244ef91="" data-v-03256cc6=""/> </div> <!----> <span class="position ellipsis" data-v-61fb5e44="">
              @古茗科技
            </span></div> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>作者：周杰</p>
</blockquote>
<p>我们每天都在用音乐播放器，但你是否想过自己动手实现一个？今天介绍下古茗自研的一个播放器的实现，以及音频播放的基本原理。</p>
<h2 data-id="heading-0">为什么选择 NAudio</h2>
<p>首先说下为啥用NAudio，我们端上当前技术栈C#用的比较多，而且门店都是Windows收银机。于是调研了一些C#库或技术，最终选了NAudio：</p>
<h3 data-id="heading-1">技术选型对比</h3>






























<table><thead><tr><th>技术/框架</th><th>优点</th><th>缺点</th></tr></thead><tbody><tr><td><strong>NAudio</strong></td><td>开源，文档较详细，使用简单，除了播放外，还能对音频做很多处理，比如音频合成、拼接、转换，有自定义需求扩展也方便<br/>star：6k</td><td>作者已停止维护</td></tr><tr><td><strong>LibVLCSharp</strong></td><td>能实现常规播放需求</td><td>当时测的时候发现分片音频拼接播放不太友好，分片间的时间间隔控制不好；文档复杂</td></tr><tr><td><strong>WindowsMediaPlayer</strong></td><td>Windows原生</td><td>API过于简单，控制能力不够强</td></tr><tr><td><strong>SDL2 + FFmpeg</strong></td><td>跨端，使用广泛且成熟</td><td>封装性较强，C#只能通过DLL方式引入，使用复杂度高。文档不太友好</td></tr></tbody></table>
<blockquote>
<p>总结：NAudio对C#生态最友好，功能完整，文档完善，是我们的最佳选择。</p>
</blockquote>
<h2 data-id="heading-2">快速开始</h2>
<h3 data-id="heading-3">引入NAudio</h3>
<p>新建项目后，引入NAudio有两种方式：</p>
<ol>
<li><strong>通过NuGet包管理器</strong>：直接搜索"NAudio"安装最新包即可
<img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f60af40196594f7cbd5aa6dc72044691~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp" alt="" loading="lazy"/></li>
<li><strong>去</strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnaudio%2FNAudio" target="_blank" title="https://github.com/naudio/NAudio" ref="nofollow noopener noreferrer"><strong>GitHub</strong></a><strong>下载源码放到项目中</strong> - 推荐这种，因为后续如果库出现问题方便维护</li>
</ol>
<h3 data-id="heading-4">要实现的功能</h3>
<p>一个最简单的播放器需要哪些功能？</p>
<ul>
<li>音频列表、播放、暂停</li>
<li>上一首/下一首</li>
<li>单曲循环/顺序播放</li>
<li>播放进度显示</li>
<li>音量调节</li>
</ul>
<p>其中核心要实现的技术点是：<strong>播放、暂停、音量调节、播放进度、播放结束事件监听</strong>。其他都是常规逻辑实现。</p>
<h2 data-id="heading-5">核心实现解析</h2>
<p>下面结合详细解释来看各个功能如何实现：</p>
<h3 data-id="heading-6">播放功能</h3>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">var</span> audioFile = <span class="hljs-keyword">new</span> AudioFileReader(<span class="hljs-string">"test.mp3"</span>);
<span class="hljs-keyword">var</span> outputDevice = <span class="hljs-keyword">new</span> WaveOutEvent();
outputDevice.Init(audioFile);
outputDevice.Play();
</code></pre>
<p><strong>代码解释：</strong></p>
<ul>
<li><code>AudioFileReader</code>：相当于一个音频文件读取器，帮你从MP3等文件中读取音频数据</li>
<li><code>WaveOutEvent</code>：相当于一个播放设备，负责把音频数据发送到声卡</li>
<li><code>Init()</code>：初始化播放设备，告诉它要播放什么音频</li>
<li><code>Play()</code>：开始播放</li>
</ul>
<h3 data-id="heading-7">暂停功能</h3>
<pre><code class="hljs language-csharp" lang="csharp">outputDevice.Pause();
</code></pre>
<p><strong>代码解释：</strong></p>
<ul>
<li><code>Pause()</code>：暂停播放，音频数据仍然在内存中，随时可以恢复播放</li>
</ul>
<h3 data-id="heading-8">音量调节</h3>
<pre><code class="hljs language-csharp" lang="csharp">audioFile.Volume = <span class="hljs-number">0.5f</span>;  <span class="hljs-comment">// 0.5表示50%音量</span>
</code></pre>
<p><strong>代码解释：</strong></p>
<ul>
<li><code>Volume</code>：控制音量的属性，1.0表示最大音量，0.0表示静音</li>
</ul>
<h3 data-id="heading-9">播放进度追踪</h3>
<pre><code class="hljs language-csharp" lang="csharp">Task.Run(<span class="hljs-keyword">async</span> () =&gt;
{
    <span class="hljs-keyword">while</span> (currentOutputDevice?.PlaybackState == PlaybackState.Playing)
    {
        <span class="hljs-comment">// 获取当前播放进度</span>
        <span class="hljs-keyword">var</span> currentTime = currentAudioFile?.CurrentTime.TotalSeconds ?? <span class="hljs-number">0</span>;
        triggerPlayProgressEvent((<span class="hljs-built_in">int</span>)currentTime);

        <span class="hljs-keyword">await</span> Task.Delay(<span class="hljs-number">1000</span>); <span class="hljs-comment">// 每秒更新一次</span>
    }
});
</code></pre>
<p><strong>代码解释：</strong></p>
<ul>
<li>起个线程，每秒获取一次当前播放进度</li>
</ul>
<h3 data-id="heading-10">播放结束事件监听</h3>
<pre><code class="hljs language-csharp" lang="csharp">outputDevice.PlaybackStopped += (<span class="hljs-built_in">object</span> sender, StoppedEventArgs args) =&gt;
{
    <span class="hljs-comment">// 这里有点需要注意，虽然是结束才触发，但分为自然播放结束和切歌</span>
    <span class="hljs-comment">// 切歌时上一首歌也是播放结束的，所以如果这里要触发事件，需要考虑这两种情况</span>
};
</code></pre>
<p><strong>代码解释：</strong></p>
<ul>
<li><code>PlaybackStopped</code>：播放停止事件（自然结束或切歌）</li>
</ul>
<h2 data-id="heading-11">完整播放器实现</h2>
<p>下面是一个简单的播放器类demo：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">AudioPlayer</span> : <span class="hljs-title">IDisposable</span>
{
    <span class="hljs-keyword">private</span> AudioFileReader audioFile;      <span class="hljs-comment">// 音频文件读取器</span>
    <span class="hljs-keyword">private</span> WaveOutEvent outputDevice;     <span class="hljs-comment">// 播放设备</span>
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">bool</span> isPlaying = <span class="hljs-literal">false</span>;        <span class="hljs-comment">// 是否正在播放</span>
    <span class="hljs-keyword">private</span> Timer progressTimer;           <span class="hljs-comment">// 进度更新定时器</span>
    
    <span class="hljs-comment">// 事件：进度改变和播放结束</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">event</span> EventHandler&lt;<span class="hljs-built_in">int</span>&gt; ProgressChanged;   <span class="hljs-comment">// 进度改变时触发</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">event</span> EventHandler PlaybackEnded;          <span class="hljs-comment">// 播放结束时触发</span>
    
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">AudioPlayer</span>()</span>
    {
        <span class="hljs-comment">// 构造函数：初始化播放设备</span>
        outputDevice = <span class="hljs-keyword">new</span> WaveOutEvent();
        <span class="hljs-comment">// 订阅播放结束事件</span>
        outputDevice.PlaybackStopped += OnPlaybackStopped;
    }
    
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Play</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> filePath</span>)</span>
    {
        <span class="hljs-keyword">try</span>
        {
            <span class="hljs-comment">// 停止当前播放，避免多个音频同时播放</span>
            Stop();
            
            <span class="hljs-comment">// 加载新的音频文件</span>
            audioFile = <span class="hljs-keyword">new</span> AudioFileReader(filePath);
            outputDevice.Init(audioFile);
            
            <span class="hljs-comment">// 开始播放</span>
            outputDevice.Play();
            isPlaying = <span class="hljs-literal">true</span>;
            
            <span class="hljs-comment">// 启动进度定时器，每秒更新一次进度</span>
            StartProgressTimer();
        }
        <span class="hljs-keyword">catch</span> (Exception ex)
        {
            <span class="hljs-comment">// 如果播放失败，显示错误信息</span>
            Console.WriteLine(<span class="hljs-string">$"播放失败: <span class="hljs-subst">{ex.Message}</span>"</span>);
        }
    }
    
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Pause</span>()</span>
    {
        <span class="hljs-comment">// 只有正在播放时才暂停</span>
        <span class="hljs-keyword">if</span> (isPlaying &amp;&amp; outputDevice?.PlaybackState == PlaybackState.Playing)
        {
            outputDevice.Pause();
            StopProgressTimer();  <span class="hljs-comment">// 停止进度更新</span>
        }
    }
    
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Resume</span>()</span>
    {
        <span class="hljs-comment">// 只有暂停时才恢复播放</span>
        <span class="hljs-keyword">if</span> (isPlaying &amp;&amp; outputDevice?.PlaybackState == PlaybackState.Paused)
        {
            outputDevice.Play();
            StartProgressTimer();  <span class="hljs-comment">// 重新启动进度更新</span>
        }
    }
    
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Stop</span>()</span>
    {
        outputDevice?.Stop();
        audioFile?.Dispose();  <span class="hljs-comment">// 释放音频文件资源</span>
        audioFile = <span class="hljs-literal">null</span>;
        isPlaying = <span class="hljs-literal">false</span>;
        StopProgressTimer();
    }
    
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">SetVolume</span>(<span class="hljs-params"><span class="hljs-built_in">float</span> volume</span>)</span>
    {
        <span class="hljs-comment">// 限制音量范围在0.0到1.0之间</span>
        <span class="hljs-keyword">if</span> (audioFile != <span class="hljs-literal">null</span>)
        {
            audioFile.Volume = Math.Clamp(volume, <span class="hljs-number">0f</span>, <span class="hljs-number">1f</span>);
        }
    }
    
    <span class="hljs-function"><span class="hljs-keyword">public</span> TimeSpan <span class="hljs-title">GetCurrentTime</span>()</span>
    {
        <span class="hljs-comment">// 获取当前播放时间</span>
        <span class="hljs-keyword">return</span> audioFile?.CurrentTime ?? TimeSpan.Zero;
    }
    
    <span class="hljs-function"><span class="hljs-keyword">public</span> TimeSpan <span class="hljs-title">GetTotalTime</span>()</span>
    {
        <span class="hljs-comment">// 获取音频总长度</span>
        <span class="hljs-keyword">return</span> audioFile?.TotalTime ?? TimeSpan.Zero;
    }
    
    <span class="hljs-comment">// 启动进度更新定时器</span>
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">StartProgressTimer</span>()</span>
    {
        progressTimer = <span class="hljs-keyword">new</span> Timer(UpdateProgress, <span class="hljs-literal">null</span>, TimeSpan.Zero, TimeSpan.FromSeconds(<span class="hljs-number">1</span>));
    }
    
    <span class="hljs-comment">// 停止进度更新定时器</span>
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">StopProgressTimer</span>()</span>
    {
        progressTimer?.Dispose();
        progressTimer = <span class="hljs-literal">null</span>;
    }
    
    <span class="hljs-comment">// 更新播放进度的私有方法</span>
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">UpdateProgress</span>(<span class="hljs-params"><span class="hljs-built_in">object</span> state</span>)</span>
    {
        <span class="hljs-comment">// 只有正在播放时才更新进度</span>
        <span class="hljs-keyword">if</span> (isPlaying &amp;&amp; audioFile != <span class="hljs-literal">null</span>)
        {
            <span class="hljs-comment">// 将当前时间转换为秒数</span>
            <span class="hljs-built_in">int</span> currentSeconds = (<span class="hljs-built_in">int</span>)audioFile.CurrentTime.TotalSeconds;
            <span class="hljs-comment">// 触发进度改变事件，通知界面更新</span>
            ProgressChanged?.Invoke(<span class="hljs-keyword">this</span>, currentSeconds);
        }
    }
    
    <span class="hljs-comment">// 处理播放结束事件的私有方法</span>
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnPlaybackStopped</span>(<span class="hljs-params"><span class="hljs-built_in">object</span> sender, StoppedEventArgs e</span>)</span>
    {
        isPlaying = <span class="hljs-literal">false</span>;
        StopProgressTimer();
        <span class="hljs-comment">// 触发播放结束事件</span>
        PlaybackEnded?.Invoke(<span class="hljs-keyword">this</span>, EventArgs.Empty);
    }
    
    <span class="hljs-comment">// 释放资源，防止内存泄漏</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Dispose</span>()</span>
    {
        Stop();
        outputDevice?.Dispose();
    }
}
</code></pre>
<h3 data-id="heading-12">使用示例</h3>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 创建播放器实例</span>
<span class="hljs-keyword">var</span> player = <span class="hljs-keyword">new</span> AudioPlayer();

<span class="hljs-comment">// 订阅事件：当进度改变时显示</span>
player.ProgressChanged += (sender, seconds) =&gt; 
{
    Console.WriteLine(<span class="hljs-string">$"当前进度: <span class="hljs-subst">{TimeSpan.FromSeconds(seconds)}</span>"</span>);
};

<span class="hljs-comment">// 订阅事件：播放结束时显示</span>
player.PlaybackEnded += (sender, e) =&gt; 
{
    Console.WriteLine(<span class="hljs-string">"播放结束"</span>);
};

<span class="hljs-comment">// 播放音乐</span>
player.Play(<span class="hljs-string">"background.mp3"</span>);

<span class="hljs-comment">// 调节音量到70%</span>
player.SetVolume(<span class="hljs-number">0.7f</span>);

<span class="hljs-comment">// 暂停2秒然后恢复</span>
player.Pause();
Thread.Sleep(<span class="hljs-number">2000</span>);
player.Resume();

<span class="hljs-comment">// 5秒后停止播放</span>
Thread.Sleep(<span class="hljs-number">5000</span>);
player.Stop();
</code></pre>
<h2 data-id="heading-13">NAudio内部实现原理</h2>
<p>在了解实现原理之前，我们先提出一个问题：我们知道音频播放一般基于音频文件比如MP3，那么这些文件里存的到底是什么？</p>
<h3 data-id="heading-14">音频基础概念</h3>
<h4 data-id="heading-15">声音的本质</h4>
<p>声音的本质是一种<strong>能量波</strong>，由振动而产生的能量波。想象一下，吉他拨弦为什么会发出声音？因为琴弦振动，这种振动以波的形式传播到我们耳朵里。</p>
<p>而波形可以用如下曲线demo表示</p>

<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/68411cd0763d4dd1a3813973fa9d2e07~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp" alt="" loading="lazy"/></p>
<p>声音的属性：</p>
<ul>
<li><strong>音调</strong>：声音频率的高低，表示人的听觉分辨一个声音的调子高低的程度。<strong>音调主要由声音的频率（波形密度）决定</strong></li>
<li><strong>音量</strong>：由"振幅"（amplitude）和人离声源的距离决定，振幅越大响度越大（<strong>波形峰值高度</strong>）</li>
<li><strong>音色</strong>：又称声音的品质，波形决定了声音的音色</li>
</ul>
<h4 data-id="heading-16">PCM数据是什么？</h4>
<p>通过对波形的有规律的采样形成PCM数据（也就是采样数据）。</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/87290330a6ee45259edad6ceb7cb0f0a~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp" alt="画板" loading="lazy"/></p>
<p>麦克风的作用：麦克风会把声音的振动波转成电压信号交给处理设备<br/>
量化的意思：把取到的点，换算成一个计算机能表示的最接近的值</p>
<p>通过采样后，得到的数据就是PCM。PCM有两个重要属性：</p>
<p><strong>采样率</strong><br/>
采样的频率</p>
<ul>
<li>44.1kHz采样率 = 每秒钟对模拟声波进行44,100次采样</li>
</ul>
<p><strong>采样位数</strong><br/>
通过采样位数，规定把振幅划分成多少个等级。分的等级越多，最终量化的值就跟曲线越拟合。</p>
<p>比如下图：分8个等级，最终采样点跟曲线并不完全拟合</p>

<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/cc5bb39177fe4ace922c3248d9f260ed~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp" alt="" loading="lazy"/></p>
<p>常用的采样位数有：</p>
<ul>
<li>8bit (1字节) - 能记录256个数</li>
<li>16bit (2字节) - 能记录65,536个数，这是CD标准（通常都是这种）</li>
<li>32bit (4字节) - 能记录4,294,967,296个数</li>
</ul>
<p>其实这里能分到的等级，就是相应位数能表示的数值范围，比如16bit=0～65535</p>
<h4 data-id="heading-17">两种PCM数据</h4>
<p>PCM有两种类型：<strong>整型、浮点</strong>（float）。一般来说音频文件存储整型数据，音频软件内处理的时候先转成Float再处理，原因是整型数据处理时数据容易溢出、浮点精度更高。</p>
<p>NAudio内部对这两种PCM数据分别有个基类：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 浮点基类 - 用于处理精度要求高的音频效果</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">ISampleProvider</span>
{
    WaveFormat WaveFormat { <span class="hljs-keyword">get</span>; }
    <span class="hljs-function"><span class="hljs-built_in">int</span> <span class="hljs-title">Read</span>(<span class="hljs-params"><span class="hljs-built_in">float</span>[] buffer, <span class="hljs-built_in">int</span> offset, <span class="hljs-built_in">int</span> count</span>)</span>;  <span class="hljs-comment">// 读取浮点数据</span>
}

<span class="hljs-comment">// 整型基类 - 用于读取音频文件</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">IWaveProvider</span>  
{
    WaveFormat WaveFormat { <span class="hljs-keyword">get</span>; }
    <span class="hljs-function"><span class="hljs-built_in">int</span> <span class="hljs-title">Read</span>(<span class="hljs-params"><span class="hljs-built_in">byte</span>[] buffer, <span class="hljs-built_in">int</span> offset, <span class="hljs-built_in">int</span> count</span>)</span>;   <span class="hljs-comment">// 读取整型数据</span>
}
</code></pre>
<p><code>Read</code>方法的作用：约定了音频流式读取的规范，每个实现类都要实现这个方法</p>
<ul>
<li><code>buffer</code>：代表要用来播放的数据</li>
<li><code>offset</code>：代表要把数据放入buffer的起始位置，比如从buffer第第50位开始插值</li>
<li><code>count</code>：代表需要的样本数</li>
<li><code>返回值</code>：代表实际读到的样本数</li>
</ul>
<h2 data-id="heading-18">播放流程详细解析</h2>
<h3 data-id="heading-19">读取音频文件</h3>
<p>回顾之前的播放代码，我们用的是<code>AudioFileReader</code>类来读取文件，这个类初始化后主要做了三件事：</p>
<ol>
<li><strong>生成一个整型PCM流</strong></li>
<li><strong>对流数据做处理，转成浮点数据</strong></li>
<li><strong>实现流读取函数</strong></li>
</ol>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 第一步：生成一个音频流，MediaFoundationReader提供的是整型PCM</span>
readerStream = <span class="hljs-keyword">new</span> MediaFoundationReader(fileName);

<span class="hljs-comment">// 第二步：把readerStream转为ISampleProvider（浮点型）</span>
sampleChannel = <span class="hljs-keyword">new</span> SampleChannel(readerStream, <span class="hljs-literal">false</span>);

<span class="hljs-comment">// 第三步：实现流读取函数</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> <span class="hljs-title">Read</span>(<span class="hljs-params"><span class="hljs-built_in">float</span>[] buffer, <span class="hljs-built_in">int</span> offset, <span class="hljs-built_in">int</span> count</span>)</span>
{
    <span class="hljs-keyword">lock</span> (lockObject)
    {
        <span class="hljs-keyword">return</span> sampleChannel.Read(buffer, offset, count);
    }
}
</code></pre>
<h3 data-id="heading-20">MediaFoundation读取机制</h3>
<p>如下是MediaFoundationReader的核心代码（简化版）：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-built_in">int</span> <span class="hljs-title">Read</span>(<span class="hljs-params"><span class="hljs-built_in">byte</span>[] buffer, <span class="hljs-built_in">int</span> offset, <span class="hljs-built_in">int</span> count</span>)</span> {
    <span class="hljs-comment">// 调用windows api创建reader</span>
    MFCreateSourceReaderFromURL(file, <span class="hljs-literal">null</span>, <span class="hljs-keyword">out</span> pReader)

    <span class="hljs-built_in">int</span> bytesWritten = <span class="hljs-number">0</span>;
    
    <span class="hljs-comment">// 如果已经从文件读取的样本数据缓存还没用完，就继续从缓存里读取用于播放</span>
    <span class="hljs-keyword">if</span> (decoderOutputCount &gt; <span class="hljs-number">0</span>)
    {
        bytesWritten += ReadFromDecoderBuffer(buffer, offset, count - bytesWritten);
    }
    
    <span class="hljs-keyword">while</span> (bytesWritten &lt; count)
    {
        <span class="hljs-comment">// 从文件读采样数据</span>
        pReader.ReadSample(MediaFoundationInterop.MF_SOURCE_READER_FIRST_AUDIO_STREAM, <span class="hljs-number">0</span>, 
                           <span class="hljs-keyword">out</span> <span class="hljs-built_in">int</span> actualStreamIndex, <span class="hljs-keyword">out</span> MF_SOURCE_READER_FLAG dwFlags, <span class="hljs-keyword">out</span> <span class="hljs-built_in">ulong</span> timestamp, <span class="hljs-keyword">out</span> IMFSample pSample);
        <span class="hljs-comment">// 把采样数据转换为c#结构化对象</span>
        pSample.ConvertToContiguousBuffer(<span class="hljs-keyword">out</span> IMFMediaBuffer pBuffer);
        <span class="hljs-comment">// 缓存到decoderOutputBuffer</span>
        pBuffer.Lock(<span class="hljs-keyword">out</span> IntPtr pAudioData, <span class="hljs-keyword">out</span> <span class="hljs-built_in">int</span> pcbMaxLength, <span class="hljs-keyword">out</span> <span class="hljs-built_in">int</span> cbBuffer);
        EnsureBuffer(cbBuffer);
        Marshal.Copy(pAudioData, decoderOutputBuffer, <span class="hljs-number">0</span>, cbBuffer);

        <span class="hljs-comment">// 从decoderOutputBuffer里读取数据放入buffer</span>
        bytesWritten += ReadFromDecoderBuffer(buffer, offset + bytesWritten, count - bytesWritten);
        
        ......
}
</code></pre>
<p>这里用的是Windows的<code>MediaFoundation</code>系列API，总体流程是：</p>
<ol>
<li><code>MFCreateSourceReaderFromURL</code> → 创建读对象pReader</li>
<li><code>pReader.ReadSample</code> → 使用读对象读sample数据（整型PCM）</li>
<li><code>pSample.ConvertToContiguousBuffer</code> → 转为C#对象</li>
</ol>
<h3 data-id="heading-21">浮点转换过程</h3>
<p><code>SampleChannel</code>类主要做两件事：</p>
<ol>
<li><strong>判断传入的readerStream类型和采样位数，统一转成ISampleProvider对象</strong></li>
</ol>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">if</span> (waveProvider.WaveFormat.Encoding == WaveFormatEncoding.Pcm)
{
    <span class="hljs-keyword">if</span> (waveProvider.WaveFormat.BitsPerSample == <span class="hljs-number">16</span>)
    {
        sampleProvider = <span class="hljs-keyword">new</span> Pcm16BitToSampleProvider(waveProvider);  <span class="hljs-comment">// 16位整型转浮点</span>
    }
    <span class="hljs-comment">// ...其他位数处理</span>
}
</code></pre>
<ol start="2">
<li><strong>添加音量调节能力的支持</strong></li>
</ol>
<pre><code class="hljs language-csharp" lang="csharp">volumeProvider = <span class="hljs-keyword">new</span> VolumeSampleProvider(sampleProvider);
</code></pre>
<ol start="3">
<li><strong>实现Read</strong></li>
</ol>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> <span class="hljs-title">Read</span>(<span class="hljs-params"><span class="hljs-built_in">float</span>[] buffer, <span class="hljs-built_in">int</span> offset, <span class="hljs-built_in">int</span> sampleCount</span>)</span>
{
    <span class="hljs-keyword">return</span> volumeProvider.Read(buffer, offset, sampleCount);
}
</code></pre>
<h4 data-id="heading-22">Pcm16BitToSampleProvider解析</h4>
<p>核心是Read实现：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Pcm16BitToSampleProvider</span> : <span class="hljs-title">SampleProviderConverterBase</span>
{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Pcm16BitToSampleProvider</span>(<span class="hljs-params">IWaveProvider source</span>)
        : <span class="hljs-title">base</span>(<span class="hljs-params">source</span>)</span>
    {
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-built_in">int</span> <span class="hljs-title">Read</span>(<span class="hljs-params"><span class="hljs-built_in">float</span>[] buffer, <span class="hljs-built_in">int</span> offset, <span class="hljs-built_in">int</span> count</span>)</span>
    {
        <span class="hljs-built_in">int</span> sourceBytesRequired = count * <span class="hljs-number">2</span>;
        EnsureSourceBuffer(sourceBytesRequired);
        <span class="hljs-built_in">int</span> bytesRead = source.Read(sourceBuffer, <span class="hljs-number">0</span>, sourceBytesRequired);
        <span class="hljs-built_in">int</span> outIndex = offset;
        <span class="hljs-keyword">for</span>(<span class="hljs-built_in">int</span> n = <span class="hljs-number">0</span>; n &lt; bytesRead; n+=<span class="hljs-number">2</span>)
        {
            buffer[outIndex++] = BitConverter.ToInt16(sourceBuffer, n) / <span class="hljs-number">32768f</span>;
        }
        <span class="hljs-keyword">return</span> bytesRead / <span class="hljs-number">2</span>;
    }
}
</code></pre>
<p>这里Read方法的逻辑是：</p>
<ol>
<li>需要count个样本，从buffer的offset位置开始写入buffer</li>
<li>16位pcm，每个样本占2个字节，所以实际读取的字节长度是：<code>count * 2</code></li>
<li>从<code>IWaveProvider source</code>读取<code>count * 2</code>个字节的数据</li>
<li>同理，因为每个样本2个字节，所以每2个字节除32768f得到浮点数据</li>
<li>除32768f的原因是：16-bit 有符号整数的取值范围是-32768 ~ +32767，取两者的最大值32768，丢失的正值的1精度直接忽略</li>
</ol>
<p>这样就对一个整型pcm实现了浮点式读取</p>
<p>添加音量调节能力的支持，下面讲音频处理的时候统一讲</p>
<h3 data-id="heading-23">播放逻辑</h3>
<p>通过上面的步骤，已经实现了从文件读整型PCM，并转为floatPCM，接下来开始播放：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 新建播放对象</span>
<span class="hljs-keyword">var</span> outputDevice = <span class="hljs-keyword">new</span> WaveOutEvent();
<span class="hljs-comment">// 初始化</span>
outputDevice.Init(audioFile);
<span class="hljs-comment">// 播放</span>
outputDevice.Play();
</code></pre>
<p>新建对象基本没干啥，主要看初始化、播放两步</p>
<h4 data-id="heading-24">初始化播放对象</h4>
<p>简化版代码如下：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Init</span>(<span class="hljs-params">IWaveProvider waveProvider</span>)</span>
{
    <span class="hljs-comment">// 初始化一个事件对象，这个事件传入waveOutOpen，当前缓冲区播放完后，系统会触发这个事件</span>
    callbackEvent = <span class="hljs-keyword">new</span> AutoResetEvent(<span class="hljs-literal">false</span>);

    waveStream = waveProvider;
    <span class="hljs-comment">// 缓冲区大小 = 预计的播放延迟 /  缓冲区数量   （这里分母+NumberOfBuffers - 1的做法是一种向上取整逻辑)</span>
    <span class="hljs-built_in">int</span> bufferSize = waveProvider.WaveFormat.ConvertLatencyToByteSize((DesiredLatency + NumberOfBuffers - <span class="hljs-number">1</span>) / NumberOfBuffers);
    <span class="hljs-comment">// 调用系统api打开播放设备，获取设备句柄</span>
    MmResult result = waveOutOpen(<span class="hljs-keyword">out</span> hWaveOut, (IntPtr)DeviceNumber, waveStream.WaveFormat, callbackEvent.SafeWaitHandle.DangerousGetHandle(), IntPtr.Zero, WaveInterop.WaveInOutOpenFlags.CallbackEvent);

    <span class="hljs-comment">// 初始化缓冲区</span>
    buffers = <span class="hljs-keyword">new</span> WaveOutBuffer[NumberOfBuffers];
    playbackState = PlaybackState.Stopped;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> n = <span class="hljs-number">0</span>; n &lt; NumberOfBuffers; n++)
    {
        buffers[n] = <span class="hljs-keyword">new</span> WaveOutBuffer(hWaveOut, bufferSize, waveStream, waveOutLock);
    }
}
</code></pre>
<p>这里主要做两件事：</p>
<ol>
<li><strong>调用waveOutOpen打开设备句柄</strong></li>
<li><strong>初始化NumberOfBuffers个播放缓冲区</strong>（通常2个）</li>
</ol>
<blockquote>
<p>这里有个DesiredLatency，表示预计播放延迟，默认300ms，那么缓冲区大小默认就是150ms</p>
</blockquote>
<h5 data-id="heading-25">缓冲区初始化</h5>
<p>看下缓冲区初始化代码：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">WaveOutBuffer</span>(<span class="hljs-params">IntPtr hWaveOut, Int32 bufferSize, IWaveProvider bufferFillStream, <span class="hljs-built_in">object</span> waveOutLock</span>)</span>
{
    <span class="hljs-comment">// 1、生成一个缓冲区</span>
    buffer = <span class="hljs-keyword">new</span> <span class="hljs-built_in">byte</span>[bufferSize];
    hBuffer = GCHandle.Alloc(buffer, GCHandleType.Pinned);

    <span class="hljs-comment">// 2、把缓冲区绑定到一个WaveHeader对象上</span>
    header = <span class="hljs-keyword">new</span> WaveHeader();
    hHeader = GCHandle.Alloc(header, GCHandleType.Pinned);
    header.dataBuffer = hBuffer.AddrOfPinnedObject();
    header.bufferLength = bufferSize;
    header.loops = <span class="hljs-number">1</span>;
    hThis = GCHandle.Alloc(<span class="hljs-keyword">this</span>);
    header.userData = (IntPtr)hThis;

    <span class="hljs-comment">// 3、把WaveHeader对象跟设备句柄关联</span>
    waveOutPrepareHeader(hWaveOut, header, Marshal.SizeOf(header));
}
</code></pre>
<p>这里总结就是：</p>
<p>生成缓冲区，调用<code>waveOutPrepareHeader</code>把设备句柄跟缓冲区关联</p>
<h4 data-id="heading-26">双缓冲机制</h4>
<p>上面提到一般是2个缓冲区，那为什么要用2个缓冲区？因为可以保证音频播放的连续性：</p>
<pre><code class="hljs language-plain" lang="plain">第一次播放 → 两个缓冲区都被填满，开始播放
第一个缓冲区播放完（150ms后）→ 立即填充新数据，继续播放第二个缓冲区
第二个缓冲区播放完（150ms后）→ 立即填充新数据，继续播放第一个缓冲区
这样循环往复，保证没有间隙
</code></pre>
<h4 data-id="heading-27">播放线程逻辑</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">DoPlayback</span>()</span>
{
    <span class="hljs-keyword">while</span> (playbackState != PlaybackState.Stopped)
    {
        <span class="hljs-comment">// 等待缓冲区播放结束或超时（这里正常是等待150ms，也就是一个缓冲区的时长）</span>
        callbackEvent.WaitOne(DesiredLatency);  <span class="hljs-comment">// 300ms</span>
        
        <span class="hljs-comment">// 遍历每个缓冲区，填充新数据</span>
        <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> buffer <span class="hljs-keyword">in</span> buffers)
        {
            <span class="hljs-keyword">if</span> (!buffer.inqueue) buffer.OnDone();
        }
    }

    <span class="hljs-comment">// 播放完后触发播放结束事件（上面这个循环条件，暂停时的状态不是Stopped，所以这里没问题）</span>
    RaisePlaybackStoppedEvent();
}

<span class="hljs-comment">// 缓冲区的OnDone实现 - 在缓冲区类里</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">bool</span> <span class="hljs-title">OnDone</span>()</span>
{
    <span class="hljs-comment">// 调用音频流的Read方法，把数据读入缓冲区 - 上面提到过，是ISampleProvider/IWaveProvider对象的Read方法</span>
    waveStream.Read(buffer, <span class="hljs-number">0</span>, buffer.Length);
    <span class="hljs-comment">// 把数据写入音频设备</span>
    <span class="hljs-comment">//   - 这里通过上面缓冲区构造函数类可知：buffer的指针已绑定到header上</span>
    <span class="hljs-comment">//   - 所以这里就是把buffer写入播放设备</span>
    waveOutWrite(hWaveOut, header, Marshal.SizeOf(header))
}
</code></pre>
<p>这里的waveStream就是前面初始化的MediaFoundationReader对象，每次调用waveStream.Read，就会从原文件读取数据转为pcm，存入缓冲区（双缓冲中的某一个）</p>
<h4 data-id="heading-28">结束播放</h4>
<p>可以看出，播放过程中初始化了一些东西，但是如果一首歌播放结束了，这些东西就应该销毁，销毁代码如下：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Dispose</span>(<span class="hljs-params"><span class="hljs-built_in">bool</span> disposing</span>)</span>
{
    <span class="hljs-comment">// 重置设备</span>
    waveOutReset(hWaveOut);

    <span class="hljs-comment">// 销毁缓冲区</span>
    <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> buffer <span class="hljs-keyword">in</span> buffers)
    {
        buffer.Dispose();
    }

    <span class="hljs-comment">// 关闭设备句柄</span>
    <span class="hljs-comment">//   - 这里重置和关闭，都是对系统分配的句柄本身的操作，是系统分配给当前进程的一个句柄，</span>
    <span class="hljs-comment">//   - 并不影响其他程序，因为其他程序也会获得独立的音频设备句柄</span>
    waveOutClose(hWaveOut);
}

<span class="hljs-comment">// 缓冲区对象Dispose实现</span>
<span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Dispose</span>(<span class="hljs-params"><span class="hljs-built_in">bool</span> disposing</span>)</span>
{
    <span class="hljs-comment">// 释放缓冲区</span>
    waveOutUnprepareHeader(hWaveOut, header, Marshal.SizeOf(header));
}
</code></pre>
<p>再加上前面的读音频文件，这里补全下完整一首歌播放的流程：</p>
<pre><code class="hljs language-plain" lang="plain">┌─────────────────────────┐
│ MFCreateSourceReaderFromURL(file, null, out pReader) │
│  ← 打开音频文件，创建 Media Foundation 源读取器        │
└───────────────┬─────────────────────────────────────┘
                │
                ▼
┌─────────────────────────┐
│ pReader.ReadSample(...)  │  ← 从文件读取并解码音频样本 (IMFSample)
└───────────────┬─────────┘
                │
                ▼
┌─────────────────────────┐
│ pSample.ConvertToContiguousBuffer(out pBuffer) │
│  ← 将样本数据合并为连续内存块 (IMFMediaBuffer) │
└───────────────┬─────────┘
                │
                ▼
┌─────────────────────────┐
│ 转为浮点采样格式（如 IEEE float 32-bit） │
│  ← 便于后续波形混音 / 音量控制 / 可视化 │
└───────────────┬─────────┘
                │
                ▼
┌─────────────────────────┐
│ waveOutOpen              │  ← 打开音频设备 (获得 hWaveOut)
└───────────────┬─────────┘
                │
                ▼
┌─────────────────────────┐
│ 填写 WaveHeader 结构        │  ← 指定缓冲区地址、长度等
│ (lpData, dwBufferLength) │
└───────────────┬─────────┘
                │
                ▼
┌─────────────────────────┐
│ waveOutPrepareHeader     │  ← 准备缓冲区，登记到系统，绑定设备句柄
└───────────────┬─────────┘
                │
                ▼
┌─────────────────────────┐
│ waveOutWrite             │  ← 发送缓冲区到声卡播放
└───────────────┬─────────┘
                │
                ▼
    （双缓冲轮流播放中...）
                │
                ▼
┌─────────────────────────┐
│ 播放完成回调   
└───────────────┬─────────┘
                │
                ▼
┌─────────────────────────┐
│ waveOutReset             │  ← 强制停止播放、清空缓冲队列
│                          │     所有未播放完的缓冲触发 WOM_DONE
└───────────────┬─────────┘
                │
                ▼
┌─────────────────────────┐
│ waveOutUnprepareHeader   │  ← 解除缓冲区准备状态，释放资源
└───────────────┬─────────┘
                │
                ▼
  （可重复使用缓冲区再次播放或退出）
                │
                ▼
┌─────────────────────────┐
│ waveOutClose             │  ← 关闭句柄
└─────────────────────────┘

</code></pre>
<h2 data-id="heading-29">音频效果处理原理</h2>
<p>NAudio实现各种音频效果，本质是在<code>Read</code>方法中处理音频数据。</p>
<p>这里举三个例子说明下，相信看完例子后，大家会完全懂得<code>NAudio</code>处理音频效果的逻辑</p>
<h3 data-id="heading-30">音量控制</h3>
<p>上面有提到：在<code>SampleChannel</code>构造函数里有行代码：<code>volumeProvider = new VolumeSampleProvider(sampleProvider);</code> ，这里看下他是咋提供音量控制能力的，核心代码如下：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> <span class="hljs-title">Read</span>(<span class="hljs-params"><span class="hljs-built_in">float</span>[] buffer, <span class="hljs-built_in">int</span> offset, <span class="hljs-built_in">int</span> sampleCount</span>)</span>
{
    <span class="hljs-comment">// 先从源读取数据</span>
    <span class="hljs-built_in">int</span> samplesRead = source.Read(buffer, offset, sampleCount);
    
    <span class="hljs-comment">// 如果音量不是100%，对每个样本应用音量</span>
    <span class="hljs-keyword">if</span> (Volume != <span class="hljs-number">1f</span>)
    {
        <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> n = <span class="hljs-number">0</span>; n &lt; sampleCount; n++)
        {
            <span class="hljs-comment">// 每个样本乘以音量系数</span>
            buffer[offset + n] *= Volume;
        }
    }
    <span class="hljs-keyword">return</span> samplesRead;
}
</code></pre>
<p>其实很简单，就是给每个样本乘以音量数值，相当于控制了波形曲线的振幅</p>
<h3 data-id="heading-31">单声道转双声道</h3>
<p>这里先介绍下双声道数据的结构：</p>



































<table><thead><tr><th>buffer 索引</th><th>含义</th><th>帧索引</th></tr></thead><tbody><tr><td>0</td><td>左声道采样 1</td><td>1</td></tr><tr><td>1</td><td>右声道采样 1</td><td/></tr><tr><td>2</td><td>左声道采样 2</td><td>2</td></tr><tr><td>3</td><td>右声道采样 2</td><td/></tr><tr><td>...</td><td>...</td><td/></tr></tbody></table>
<p>也就是说双声道一帧2个样本，而单声道是一帧一个样本，那最终设备咋区分单双声道呢？前面声明<code>ISampleProvider</code>、<code>IWaveProvider</code>接口的时候，里面有个<code>WaveFormat</code>属性，在调用<code>waveOutOpen</code>打开设备句柄时，需要传入<code>WaveFormat</code>，<code>WaveFormat</code>里有个属性会表示声道数</p>
<p>现在我们看下<code>MonoToStereoSampleProvider</code>（单转双）的<code>Read</code>方法：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> <span class="hljs-title">Read</span>(<span class="hljs-params"><span class="hljs-built_in">float</span>[] buffer, <span class="hljs-built_in">int</span> offset, <span class="hljs-built_in">int</span> count</span>)</span>
{
    <span class="hljs-comment">// 双声道需要count个样本，但单声道只需要count/2个</span>
    <span class="hljs-keyword">var</span> sourceSamplesRequired = count / <span class="hljs-number">2</span>;
    <span class="hljs-keyword">var</span> sourceSamplesRead = source.Read(sourceBuffer, <span class="hljs-number">0</span>, sourceSamplesRequired);
    
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> n = <span class="hljs-number">0</span>; n &lt; sourceSamplesRead; n++)
    {
        <span class="hljs-comment">// 每个单声道样本复制到左右两个声道</span>
        buffer[outIndex++] = sourceBuffer[n] * LeftVolume;   <span class="hljs-comment">// 左声道</span>
        buffer[outIndex++] = sourceBuffer[n] * RightVolume;  <span class="hljs-comment">// 右声道</span>
    }
    <span class="hljs-keyword">return</span> sourceSamplesRead * <span class="hljs-number">2</span>;
}
</code></pre>
<p>分析下逻辑：</p>
<ol>
<li>主程序需要count个样本，用单声道数据填充双声道音频，只需要count/2个单声道数据即可</li>
<li>从原本的流读取count/2个样本</li>
<li>遍历这些样本，每个值*左声道音量作为左声道值，*右声道音量作为右声道值</li>
</ol>
<p>单双声道读取时同样读取count个样本，双声道播放时，播放设备根据<code>WaveFormat</code>的描述，知道是双声道，就会一半做左声道播放，一半做右声道播放，而单声道的就只作为一个声道数据播放</p>
<h3 data-id="heading-32">淡入效果</h3>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> <span class="hljs-title">Read</span>(<span class="hljs-params"><span class="hljs-built_in">float</span>[] buffer, <span class="hljs-built_in">int</span> offset, <span class="hljs-built_in">int</span> count</span>)</span>
{
    <span class="hljs-built_in">int</span> sourceSamplesRead = source.Read(buffer, offset, count);
    <span class="hljs-keyword">lock</span> (lockObject)
    {
        FadeIn(buffer, offset, sourceSamplesRead);
    }
    <span class="hljs-keyword">return</span> sourceSamplesRead;
}
<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">FadeIn</span>(<span class="hljs-params"><span class="hljs-built_in">float</span>[] buffer, <span class="hljs-built_in">int</span> offset, <span class="hljs-built_in">int</span> sourceSamplesRead</span>)</span>
{
    <span class="hljs-keyword">while</span> (sample &lt; sourceSamplesRead)
    {
        <span class="hljs-comment">// 计算当前淡入的系数（0到1之间）</span>
        <span class="hljs-built_in">float</span> multiplier = (fadeSamplePosition / (<span class="hljs-built_in">float</span>)fadeSampleCount);
        
        <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> ch = <span class="hljs-number">0</span>; ch &lt; source.WaveFormat.Channels; ch++)
        {
            <span class="hljs-comment">// 每个样本乘以淡入系数</span>
            buffer[offset + sample++] *= multiplier;
        }
        fadeSamplePosition++;
    }
}
</code></pre>
<p>这里分析下<strong>淡入</strong>效果的逻辑：</p>
<ol>
<li>从源音频流读入数据</li>
<li>遍历读到的样本，对每个声道乘一个系数，这个系数 = 当前位置 / 需要处理淡入效果的样本的总数</li>
<li>这个总数的计算方式是：<code>fadeSampleCount = 淡入效果时长 * 采样率</code></li>
</ol>
<p>同理，淡出或者静音效果大家应该能想到怎么实现</p>
<p>所以本质上，NAudio可以通过处理音频数据从而得到不同的效果</p>
<h2 data-id="heading-33">NAudio用到的其他音频技术</h2>
<p>Windows上主流的三种音频播放技术：</p>
<pre><code class="hljs language-plain" lang="plain">+------------------+     +----------------------+     +------------------------+
|   WinMM          |     |   DirectSound        |     |      WASAPI            |
| (Windows Multimedia) | (DirectX 音频组件)    | (Windows Core Audio)    |
|  最古老，简单，延迟高 | 曾用于游戏，已废弃     | 现代 Windows 主流音频 API |
|                     | 已被替代              | 支持低延迟/独占模式      |
+------------------+     +----------------------+     +------------------------+
          |                       |                             |
          |                       |                             |
          +-----------------------+-----------------------------+
                                          |
                                 Windows 音频子系统（Core Audio）
</code></pre>
<p>上面的<code>WaveOutEvent</code>就是WinMM，NAudio里分别封装了这三种技术。NAudio比较好的一点是：这三种技术封装后，API结构是完全一样的，所以如果只是使用，其实就只有一套API。</p>
<p>比如用WASAPI播放音频，代码如下：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">var</span> audioFile = <span class="hljs-keyword">new</span> AudioFileReader(<span class="hljs-string">"test.mp3"</span>);
<span class="hljs-comment">// 跟WinMM调用的唯一区别就是这行，类名从WaveOutEvent改成WasapiOut</span>
<span class="hljs-keyword">var</span> outputDevice = <span class="hljs-keyword">new</span> WasapiOut();
outputDevice.Init(audioFile);
outputDevice.Play();
</code></pre>
<p>我们优先使用WinMM技术，然后使用WASAPI兜底。主要考虑门店大部分是Win7，目前来说比较古老了，所以就用WinMM。WinMM虽然古老，但Windows新系统上也一直存在这个技术，并没有被放弃。</p>
<h2 data-id="heading-34">总结</h2>
<p>本文介绍了古茗播放器的核心技术点及其实现原理。所用到的NAudio实际是对WinMM、WASAPI、DirectSound等Windows技术的封装，本文主要介绍了用WinMM技术播放音频的流程。</p>
<p>核心思想是：<strong>音频播放 = 文件读取 + 数据转换 + 缓冲管理 + 设备输出</strong></p>
<ul>
<li>文件读取：使用MediaFoundation读取音频文件，获得整型PCM数据</li>
<li>数据转换：将整型PCM转换为浮点PCM，便于后续处理</li>
<li>缓冲管理：使用双缓冲机制保证播放连续性</li>
<li>设备输出：通过Windows音频API发送到声卡播放</li>
</ul>
<p>理解了这些基本原理，你就可以方便地扩展更多音频功能，比如音频合成、混音、音效处理等。关键是要记住：音频处理本质上就是<strong>数据的读取、处理和输出</strong>。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Ooder A2UI框架开源首发：构建企业级应用的全新选择]]></title>    <link>https://juejin.cn/post/7588300640600227846</link>    <guid>https://juejin.cn/post/7588300640600227846</guid>    <pubDate>2025-12-28T22:50:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588300640600227846" data-draft-id="7588300640600211462" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Ooder A2UI框架开源首发：构建企业级应用的全新选择"/> <meta itemprop="keywords" content="Java,人工智能,全栈"/> <meta itemprop="datePublished" content="2025-12-28T22:50:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="OneCodeCN"/> <meta itemprop="url" content="https://juejin.cn/user/1427583415622366"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Ooder A2UI框架开源首发：构建企业级应用的全新选择
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1427583415622366/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    OneCodeCN
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-28T22:50:32.000Z" title="Sun Dec 28 2025 22:50:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>🎉 重磅消息！<strong>Ooder框架正式开源发布</strong>，版本号0.5！</p>
<p>作为一款专注于企业级应用开发的框架，Ooder以其独特的设计理念和强大的功能，为开发者提供了构建复杂业务系统的全新选择。本次开源首发包含两个核心工程：<strong>Org示例工程</strong>和<strong>Ooder支撑库</strong>。</p>
<h2 data-id="heading-0">📦 开源内容概览</h2>
<h3 data-id="heading-1">1. Org示例工程</h3>
<ul>
<li><strong>定位</strong>：组织权限管理的完整实现示例</li>
<li><strong>核心功能</strong>：
<ul>
<li>部门管理：支持树状结构的部门CRUD操作</li>
<li>人员管理：人员信息维护与部门关联</li>
<li>角色管理：部门角色定义与分配</li>
<li>关联管理：人员-部门-角色关系管理</li>
</ul>
</li>
<li><strong>技术特点</strong>：
<ul>
<li>基于Ooder A2UI架构</li>
<li>注解驱动开发</li>
<li>前后端强映射关系</li>
<li>四分离设计原则</li>
</ul>
</li>
</ul>
<h3 data-id="heading-2">2. Ooder支撑库</h3>
<ul>
<li><strong>定位</strong>：Ooder框架的核心支撑组件</li>
<li><strong>核心模块</strong>：
<ul>
<li>注解体系：定义组件、事件、视图等元数据</li>
<li>A2UI组件库：提供丰富的UI组件</li>
<li>服务框架：简化业务逻辑实现</li>
<li>通信机制：处理前后端数据交互</li>
<li>编译期工具：静态模板生成与转换</li>
</ul>
</li>
<li><strong>技术优势</strong>：
<ul>
<li>高性能：编译期优化，运行时低开销</li>
<li>高扩展性：模块化设计，支持插件机制</li>
<li>易维护：清晰的分层架构</li>
<li>开发高效：注解驱动，减少样板代码</li>
</ul>
</li>
</ul>
<h2 data-id="heading-3">💡 设计理念与创新</h2>
<p>Ooder框架采用<strong>四分离设计原则</strong>，实现了：</p>
<ul>
<li>🔤 <strong>属性</strong>：通过注解定义组件属性</li>
<li>🎨 <strong>样式</strong>：配置化样式管理</li>
<li>⚡ <strong>事件</strong>：统一事件处理机制</li>
<li>🧠 <strong>行为</strong>：业务逻辑与UI分离</li>
</ul>
<p>这种设计理念带来了以下优势：</p>
<ul>
<li><strong>代码复用</strong>：组件化设计，提高代码复用率</li>
<li><strong>易于维护</strong>：清晰的职责划分，降低维护成本</li>
<li><strong>灵活扩展</strong>：支持自定义组件和钩子</li>
<li><strong>前后端一致性</strong>：强映射关系，减少前后端协作成本</li>
</ul>
<h2 data-id="heading-4">🚀 快速入门</h2>
<h3 data-id="heading-5">获取源码</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 克隆Org示例工程</span>
git <span class="hljs-built_in">clone</span> https://gitee.com/ooderCN/ooder-org.git

<span class="hljs-comment"># 进入工程目录</span>
<span class="hljs-built_in">cd</span> ooder-public/ooder-org
</code></pre>
<h3 data-id="heading-6">构建项目</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 使用Maven构建</span>
mvn clean package -DskipTests

<span class="hljs-comment"># 生成产物</span>
<span class="hljs-comment"># target/ooder-org-0.5.jar        # 主jar包</span>
<span class="hljs-comment"># target/ooder-org-0.5-sources.jar  # 源码包</span>
<span class="hljs-comment"># target/ooder-org-javadoc.jar   # 文档包</span>
</code></pre>
<h3 data-id="heading-7">核心API示例</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Controller</span>
<span class="hljs-meta">@RequestMapping("/org/")</span>
<span class="hljs-meta">@ModuleAnnotation(imageClass = "ri-team-settings-line", caption = "组织权限")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">OrgIndex</span> {
    <span class="hljs-meta">@MethodChinaName(cname = "组织权限")</span>
    <span class="hljs-meta">@RequestMapping(method = RequestMethod.POST, value = "Index")</span>
    <span class="hljs-meta">@ResponseBody</span>
    <span class="hljs-keyword">public</span> ResultModel&lt;OrgNavAPI&gt; <span class="hljs-title function_">getIndex</span><span class="hljs-params">()</span>;
}
</code></pre>
<h2 data-id="heading-8">🌱 开源生态与社区建设</h2>
<p>Ooder框架采用<strong>MIT许可证</strong>，完全开放源码，欢迎开发者参与贡献！</p>
<h3 data-id="heading-9">如何贡献</h3>
<ol>
<li><strong>提交Issue</strong>：报告bug或提出新功能建议</li>
<li><strong>提交PR</strong>：修复bug或实现新功能</li>
<li><strong>文档贡献</strong>：完善文档和教程</li>
<li><strong>社区参与</strong>：参与讨论，分享使用经验</li>
</ol>
<h3 data-id="heading-10">社区资源</h3>
<ul>
<li>📚 <strong>文档中心</strong>：包含架构白皮书、开发教程、API文档</li>
<li>💬 <strong>交流群</strong>：加入开发者交流群，与团队直接沟通</li>
<li>📢 <strong>公众号</strong>：关注Ooder官方公众号，获取最新动态</li>
<li>📺 <strong>视频教程</strong>：逐步更新的教学视频</li>
</ul>
<h2 data-id="heading-11">📅 未来规划</h2>
<p>Ooder框架将持续迭代，后续计划包括：</p>
<ol>
<li>
<p><strong>版本规划</strong>：</p>
<ul>
<li>0.6版本：增强微服务支持</li>
<li>0.7版本：AI辅助开发工具集成</li>
<li>0.8版本：云原生部署支持</li>
<li>1.0版本：稳定版发布</li>
</ul>
</li>
<li>
<p><strong>生态扩展</strong>：</p>
<ul>
<li>更多业务组件库</li>
<li>开发工具链完善</li>
<li>行业解决方案</li>
</ul>
</li>
</ol>
<h2 data-id="heading-12">💪 为什么选择Ooder？</h2>
<ol>
<li><strong>企业级设计</strong>：专为复杂业务系统打造</li>
<li><strong>开发效率</strong>：注解驱动，减少样板代码</li>
<li><strong>性能优异</strong>：编译期优化，运行时高效</li>
<li><strong>易于扩展</strong>：模块化设计，支持插件机制</li>
<li><strong>完善生态</strong>：提供丰富的组件和示例</li>
<li><strong>活跃社区</strong>：持续更新与完善</li>
</ol>
<h2 data-id="heading-13">📞 联系我们</h2>
<ul>
<li><strong>Gitee</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2FooderCN" target="_blank" title="https://gitee.com/ooderCN" ref="nofollow noopener noreferrer">gitee.com/ooderCN</a></li>
<li><strong>公众号</strong>：搜索"ooder"</li>
<li><strong>邮箱</strong>：<a href="https://link.juejin.cn?target=mailto%3A18683731%40qq.com" target="_blank" title="mailto:18683731@qq.com" ref="nofollow noopener noreferrer">18683731@qq.com</a></li>
</ul>
<h2 data-id="heading-14">🎯 结语</h2>
<p>Ooder框架的开源发布，标志着企业级应用开发领域又增添了一款强大的工具。我们相信，凭借其独特的设计理念和优秀的技术实现，Ooder将为开发者带来全新的开发体验，为企业级应用开发注入新的活力。</p>
<p><strong>加入Ooder生态，共建企业级应用开发的美好未来！</strong></p>
<hr/>
<p><strong>版本</strong>: 0.5<br/>
<strong>发布日期</strong>: 2025-12-28<br/>
<strong>许可证</strong>: MIT<br/>
<strong>开发团队</strong>: Ooder Team</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[我的2025年度总结：EasyEditor]]></title>    <link>https://juejin.cn/post/7588300640600096774</link>    <guid>https://juejin.cn/post/7588300640600096774</guid>    <pubDate>2025-12-28T19:28:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588300640600096774" data-draft-id="7588680081326997546" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="我的2025年度总结：EasyEditor"/> <meta itemprop="keywords" content="前端,程序员"/> <meta itemprop="datePublished" content="2025-12-28T19:28:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="JinSo"/> <meta itemprop="url" content="https://juejin.cn/user/2041171430876333"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            我的2025年度总结：EasyEditor
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2041171430876333/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    JinSo
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-28T19:28:21.000Z" title="Sun Dec 28 2025 19:28:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><p>这份年度总结心心念念挺久了，从2025年11月8号来刚果金出差之前就打算写，在这边兜兜转转、磨磨蹭蹭，一直拖到12月22号凌晨3点多才动笔（按当地时间是21号晚上9点多，有6小时时差）。</p>
<p>今年又是充满成长的一年，感觉对自己有了全新的认知。就像网上说的：程序员的前三年进步最大（应该差不多吧~）。</p>
<p>还是和之前一样，先列列今年的产出。</p>
<h2 data-id="heading-0">EasyEditor</h2>
<p>先来说说我最核心的产出——<strong>EasyEditor</strong>，一个用于构建可视化应用平台的插件化跨框架低代码引擎。它融汇了我所学的精华和公司低代码引擎的经验，是一个很有意义的产物。而且不仅仅是低代码本身，它也成为了我学习的基座，后面会讲到的脚手架、文档、AI等等，都是从这里延伸出来的分支。</p>
<blockquote>
<p>虽然下半年之后断断续续的，但我还是想着会继续把它做下去。</p>
</blockquote>
<h3 data-id="heading-1">开发历程</h3>
<p><strong>1-2月：核心功能开发</strong></p>
<p>大概在1-2月份，因为临近过年比较空闲，基本一有时间就去开发 EasyEditor（兴趣真的是最容易使人着迷和专注的东西）。二月初的时候完成了低代码引擎的核心功能，也就是 core + renderer（渲染器）。</p>
<p>当时还发了一篇文章介绍它：</p>
<p><a href="https://juejin.cn/post/7469053195282890764" target="_blank" title="https://juejin.cn/post/7469053195282890764">EasyEditor: 一个面向扩展的跨框架低代码引擎</a></p>
<p>但反响并不好。思考了一下，再看看其他开源框架，发现缺少一个良好的入口让大家了解和使用它，也就是文档。按程序员的习惯，都会先看文档来了解和学习使用。所以就暂停了核心内容的开发，转而去学习 VitePress，想通过文档看看能不能找到志同道合的小伙伴一起开发，毕竟一个人的力量还是太小了。</p>
<p><strong>4月：文档发布</strong></p>
<p>终于在四月初完成了文档的开发。这里允许我（厚颜无耻地）推广一下 EasyEditor：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Feasy-editor-docs.vercel.app%2F" target="_blank" title="https://easy-editor-docs.vercel.app/" ref="nofollow noopener noreferrer">EasyEditor: 用于构建可视化应用平台的插件化跨框架低代码引擎</a></p>
<p>然后继续发文章，通过文档来推广 EasyEditor，本以为和之前一样，就几十个人看看。</p>
<p><a href="https://juejin.cn/post/7494546904756486178" target="_blank" title="https://juejin.cn/post/7494546904756486178">EasyEditor 文档正式发布啦！</a></p>
<p>但万万没想到的是，它居然爆了。我自己都震惊了，想不通为什么会有这么多人阅读，文章内容其实挺简单的，连我自己都觉得写得比较草率。当时还专门发了条朋友圈记录这个时刻：</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/64d3570ab14b4e468b027ba3326778bf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmluU28=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767554901&amp;x-signature=zo9kgpvowpz0L0kIDjdoUhOIhUo%3D" alt="y1.png" loading="lazy"/></p>
<p>相比之前的几十阅读量，这次将近2w人阅读，给了我很大的动力。</p>
<p><strong>4月底：EasyDashboard 开发</strong></p>
<p>紧接着就开始开发 EasyDashboard，基于 EasyEditor 的数据可视化大屏解决方案。当时还拉着朋友一起搞，四月底完成了一个初版，包含基本的拖拉拽、配置、交互、事件以及预览等基础功能。（这个其实挺早就开始做了，但一直是当作 core 的调试 demo 来用的，后来才把它整体迁出去变成现在的 EasyDashboard。）</p>
<p>然后一气呵成完成了测试、部署和文章推广。</p>
<p><a href="https://juejin.cn/post/7496029815637934099" target="_blank" title="https://juejin.cn/post/7496029815637934099">EasyDashboard：基于 EasyEditor 的数据可视化大屏解决方案</a></p>
<p>文章又一次爆了，而且那段时间公众号粉丝也是蹭蹭地涨，从几十个人涨到了300多。完全就像做梦一样。</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5672418b03564ee1b9b3bb22619033c1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmluU28=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767554901&amp;x-signature=Hw%2Btu5LN2kCS1Fni%2B0dKnPWxcO0%3D" alt="y2.png" loading="lazy"/></p>
<p><strong>5月：GitHub 爆发</strong></p>
<p>5月初的时候，EasyEditor 项目也爆了，star 蹭蹭往上涨，从几个飞速涨到最终的300多个（虽然不多，但对我来说已经算是荣誉了）。这也多亏了阮老师，项目有幸上了他的周刊推广了一波。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fruanyf%2Fweekly%2Fissues%2F6739" target="_blank" title="https://github.com/ruanyf/weekly/issues/6739" ref="nofollow noopener noreferrer">github.com/ruanyf/week…</a></p>
<h3 data-id="heading-2">后续扩展</h3>
<p>那段时间就跟打了鸡血一样，非常亢奋。先是把之前研究 VitePress 文档的内容进行了总结和输出：</p>
<p><a href="https://juejin.cn/post/7500238824267841546" target="_blank" title="https://juejin.cn/post/7500238824267841546">VitePress 基本使用</a></p>
<p><a href="https://juejin.cn/post/7508591120407576586" target="_blank" title="https://juejin.cn/post/7508591120407576586">VitePress 彩虹动画</a></p>
<p>然后觉得有了文档还不够，如果用户想使用的话，部署安装的成本太高了。于是有了开发脚手架的想法，继续学习相关知识，开发出了 <strong>create-easy-editor</strong>。</p>
<p><a href="https://juejin.cn/post/7513777705889415179" target="_blank" title="https://juejin.cn/post/7513777705889415179">create-easy-editor —— 快速搭建你的可视化编辑器</a></p>
<p>接着就是在这个"学习基座"上衍生了很多功能，完全是兴趣驱动。</p>
<p><strong>数据源功能：</strong> 让大屏支持调用接口数据。虽然只考虑了 HTTP 一种方案，比较简单，但最终反响还不错。</p>
<p><a href="https://juejin.cn/post/7518475441171464207" target="_blank" title="https://juejin.cn/post/7518475441171464207">EasyDashboard 数据源功能来啦！</a></p>
<p><strong>AI 聊天助手：</strong> 随着 AI 大爆发，各大平台争先恐后上架 AI 功能，我也想了解一下，就简单学习后给 EasyDashboard 加了个 AI 辅助搭建功能。（最麻烦的还是提示词工程！）</p>
<p><a href="https://juejin.cn/post/7524732094208163878" target="_blank" title="https://juejin.cn/post/7524732094208163878">EasyEditor AI 聊天助手：让低代码开发更简单</a></p>
<p>后来想扩展表单这块内容，但之前了解得比较少，实践起来比较困难。加上下半年公司开始忙起来，空余时间越来越少，另一方面自己也被其他东西吸引，就暂时停在那了。（其实就是太懒了）</p>
<hr/>
<h2 data-id="heading-3">其他技术产出</h2>
<p>回过头来说说工作的其他内容，还是按文章时间线来聊聊比较重要的功能。</p>
<p>二月底在开发公司内部低代码引擎时，觉得发布流程太麻烦，在网上搜索后了解到 changeset 可以简化 monorepo 中的发布。（这些东西最终都应用到了我的"学习基座"上）</p>
<p><a href="https://juejin.cn/post/7471953366445735988" target="_blank" title="https://juejin.cn/post/7471953366445735988">Changesets: 一个高效的版本管理工具</a></p>
<p><a href="https://juejin.cn/post/7474503566154350632" target="_blank" title="https://juejin.cn/post/7474503566154350632">从零到一：实现 Changesets 自动化发版全流程</a></p>
<p>三月份有个国际化需求，需要设计一套解决方案。当时和 mentor 讨论了几种方案，最终决定不用框架，手写了一个按路由拆分的方案，来减少语言包体积。</p>
<p><a href="https://juejin.cn/post/7479452347715158079" target="_blank" title="https://juejin.cn/post/7479452347715158079">国际化探索：颗粒化方案</a></p>
<p><a href="https://juejin.cn/post/7481964029797826572" target="_blank" title="https://juejin.cn/post/7481964029797826572">国际化探索：提升开发体验与灵活性</a></p>
<p><strong>其他零碎产出：</strong></p>
<p><a href="https://juejin.cn/post/7557619202184233002" target="_blank" title="https://juejin.cn/post/7557619202184233002">alien-signals 系列 —— 认识下一代响应式框架</a></p>
<p><a href="https://juejin.cn/post/7562188129949712419" target="_blank" title="https://juejin.cn/post/7562188129949712419">pnpm monorepo 联调：告别 --global 参数</a></p>
<p><a href="https://juejin.cn/post/7575090551356686388" target="_blank" title="https://juejin.cn/post/7575090551356686388">Ultracite：为 AI 时代打造的零配置代码规范工具</a></p>
<hr/>
<h2 data-id="heading-4">角色转变</h2>
<p>下半年开始，基本在忙其他事情，主要有几方面原因：</p>
<ol>
<li>角色变化</li>
<li>产品需求</li>
<li>变身 mentor</li>
<li>全栈发展</li>
</ol>
<h3 data-id="heading-5">从写代码到对接客户</h3>
<p>从一个只会敲代码的程序员开始，只会根据需求实现，慢慢开始对接项目、对接客户，了解需求来源和客户的真实想法，了解他们最终想要的是什么。</p>
<blockquote>
<p>因为公司目前业务更偏向项目制，大部分需求来自客户。</p>
</blockquote>
<p>大概三月底开始逐渐接触客户，从一个项目慢慢来。年中时还因为这个拿了份年中奖。下半年项目渐渐多起来后，手上处理的业务也变多了。记得最忙的时候同时处理4-5个项目，工作量非常饱和。</p>
<p>但现在对业务越来越熟悉了，整体流程也有了大致概念。</p>
<h3 data-id="heading-6">学习产品思维</h3>
<p>开始接触产品的工作，出了两个产品需求。</p>
<p><strong>第一个：分部分项目录树需求</strong></p>
<p>记得当时 mentor 让我来设计，我其实挺懵的，这块完全没概念。</p>
<p>当时学习了解了 Axure 画图、蓝湖上传等等，摸索了好一会。然后按自己想法先设计了一版，中途还参考之前的需求图，梳理应该怎么写需求，怎么让流程更清晰...</p>
<p>定完一版后去和产品讨论，才发现有很多漏洞——都是以程序员角度思考的，没考虑过客户实际怎么用、好不好用，完全没有站在客户角度想这件事。</p>
<p>聊完后提出了很多问题，我再加以完善，才感觉勉强能形成闭环。</p>
<p><strong>第二个：大屏相关需求</strong></p>
<p>这个需求其实是我自己提的，因为觉得那块使用比较混乱。和 mentor 提议后就开始设计，找了很多竞品参考，各有特色，综合了其"精华"设计出一版，然后找产品讲解讨论，看看有什么问题，再进行修改。</p>
<h3 data-id="heading-7">变身 Mentor</h3>
<p><strong>第一批实习生（4月）</strong></p>
<p>这要从四月份说起。当时想招个实习生干些简单的活，让其他人抽身做产品。</p>
<p>负责人（mentor）比较忙，就找我帮忙筛简历、面试，看能不能招个人进来帮忙。发了一堆简历过来让我筛选，我只能凭感觉挑，然后约一些人来面试。</p>
<p>当时我自己都很紧张，因为这块我也是新人，不太懂怎么面试，不清楚该问什么问题，万一我自己也不了解怎么办...想了各种乱七八糟的东西，还搜了很多关于面试官的内容和前端面试题。</p>
<p>经过两三次面试后就好多了，也慢慢适应了这个节奏（但对 i 人来说还是很艰难的）。</p>
<p>4月底确定了最终人选，51之后入职。因为是在校生还有课，暂时远程沟通。那时候才发现远程沟通有多困难（尤其对新人，熟悉后就简单多了）。</p>
<p>那时候按照"前人的路"来教学，一开始以熟悉项目和基础环境、git 等为主。每周分配任务后，我再从中拆分一点任务给实习生，主要还是以熟悉为主。</p>
<p>5月底实习生开始线下，带的那段时间理解了几件事：</p>
<ol>
<li><strong>任务分配很麻烦</strong>：要合理、充沛，但又不能过多过少，存在各种因素要考虑。</li>
<li><strong>不只是写代码，还得会"说代码"</strong>：实习生遇到问题，不能直接告诉怎么做，需要旁敲侧击地提示她，让她自己思考。对于困难的问题，需要带着她一起思考，理解后再写代码，让她明白为什么这样做。（这就是"提问的艺术"，后面会提到）</li>
<li><strong>不能只站在自己角度思考</strong>：还需要考虑实习生的接受程度。</li>
</ol>
<p><strong>第二批实习生（9月）</strong></p>
<p>9月中旬招聘了第二批。下半年公司比较忙，需要实习生帮忙分担简单内容。</p>
<p>这次更直接，直接给我创了个 BOSS 账号，自己筛简历约面试。和第一次差不多，面了7-8个人，筛选了几个出来。</p>
<p>这次带的方式不一样，因为实习生要跟项目走，每个人接触的项目不同，没办法都让我带，而是分摊开来，给每个人减轻些压力。</p>
<p><strong>第三批实习生（11月）</strong></p>
<p>11月初第三次招聘，为了自己也轻松点，设计了一批笔试题来考核。随机挑选试题发送，快速筛掉一大批人，后面面试时基本水平都可以了。</p>
<h3 data-id="heading-8">全面(栈)发展</h3>
<p>这个比较特殊。因为跟进的项目需要到现场实施，名额只有一个实施和一个研发，我不得不了解些后端和运维知识，以免出现问题没法解决。而且那边网络也不太好，现场沟通会比较困难。</p>
<p>在现场和业主那边，我已经数不清找了多少次运维了。虽然经常麻烦他们，但到现在对一些简单的运维操作、Linux 操作等基本已经"手到擒来"了。运维这块的常用命令已经很熟悉，更何况还有专家给的"宝典"。</p>
<p>后端方面，出发前也了解了一些，主要关心本地调试和打包部署。代码可以问 AI 学习，再加上之前学过 node、go 等后端知识，所以基本概念都清楚。</p>
<p>而且现场总有意外。比如出发前说需要接入监控，只支持 rtmp 协议，我们提前写好放到 nginx 上了。但到了才发现是 rtsp 协议！而且现场摄像头都比较老，还需要自己测试配置如何启用 rtsp，摸索怎么切换到不同的监控流。不过也挺有意思的。</p>
<hr/>
<h2 data-id="heading-9">关于成长的思考</h2>
<p>说到这个，不得不提之前看到的一篇文章：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F554292991" target="_blank" title="https://zhuanlan.zhihu.com/p/554292991" ref="nofollow noopener noreferrer"/></p>
<p>里面提到职业生涯的三个阶段，满满的干货，让我认识到需要学习的地方还有很多。</p>
<p>特别喜欢里面提到的"提问的艺术"：</p>
<blockquote>
<p>我想起我的老板们及和我1v1沟通的同事们对我的帮助，他们都非常善于用反问来引导我。提问的深度特别能体现一个人的能力水平，任何用于提要求的陈述句，都能转换成疑问句，在启发萌新的过程中植入对结果的约束。</p>
<p>当你让一个人做A的时候，他提出了方案B。你不要强行扭转对方的思路提出A，因为对于新人来讲，或许确实不能一步到位理解A方案，在他的能力约束下，只能想到B。要尽量尝试把A和B之间有差异的地方转换成提问，你问他遇到这个问题怎么解决，遇到那个问题怎么解决，一直问到形成A，他会带着思考去做事情。如果没有这个过程，没有让他思维演化的过程，虽然他收到了A的指令，但是他不理解，他会用别的方式做出来，最后得出来一个C，然后你又重构一遍，陷入一个怪圈不能自拔，这就是我以前的误区。</p>
<p>所以我现在特别注重提问的艺术。但是一切的前提是：你需要对事情有好的认知。按照张一鸣的观点就是：对一件事情认知决定了一件事情的高度。</p>
</blockquote>
<p><strong>学会提问，才能让人成长。</strong></p>
<p>这只是其中的冰山一角，里面还有很多让我印象深刻的内容，很推荐大家阅读。</p>
<hr/>
<h2 data-id="heading-10">未来规划</h2>
<p><strong>EasyEditor</strong></p>
<ul>
<li>宏观方向
<ul>
<li>plugin-form（待开发）：表单插件</li>
<li>react-renderer-form（待开发）：表单渲染器（基于 react-renderer）</li>
<li>vue-renderer（待开发）：Vue 渲染器</li>
<li>EasyClip（待开发）：视频剪辑Web应用，灵感来源于剪映Web版的下线</li>
</ul>
</li>
<li>细节完善
<ul>
<li>远程物料、组件版本</li>
<li>资产库（物料库、设置器库、对应脚手架）</li>
<li>自定义组件</li>
<li>异步资源加载</li>
<li>...（还想在大屏上扩展很多内容）</li>
</ul>
</li>
</ul>
<p><strong>3D</strong></p>
<p>系统性学习这块内容，主要是 BIM 和 GIS，也就是数字孪生。</p>
<ul>
<li>理论知识</li>
<li>建模（Blender）</li>
<li>渲染引擎（CesiumJS...）</li>
<li>游戏引擎（Godot...）</li>
</ul>
<p><strong>全栈</strong></p>
<ul>
<li>Elysia.js</li>
<li>可以想想低代码后端怎么走...</li>
</ul>
<p><strong>AI</strong></p>
<ul>
<li>理解 AI 如何运作，学习理论知识</li>
<li>AI 项目、运用</li>
<li>了解 Claude Code 等项目是怎么运作的</li>
</ul>
<hr/>
<h2 data-id="heading-11">总结</h2>
<p>这一年进步了很多，也能承担更大的责任了。</p>
<p>不管是对接客户、带实习生、写产品需求，还是全栈实践，都是很有意思的体验。也进一步了解了整个研发体系的运作。</p>
<blockquote>
<p>期待在2026年继续成长，在低代码领域继续深耕，朝着自己热爱的方向前进。</p>
</blockquote>
<p>实现了去年的目标，也希望能继续完善 EasyEditor。</p>
<p>最后分享《瓦尔登湖》里我很喜欢的一句话：</p>
<blockquote>
<p>让我们如大自然般悠然自在地生活一天吧，别因为有坚果外壳或者蚊子翅膀落在铁轨上而翻了车。让我们该起床时就赶紧起床，该休息时就安心休息，保持安宁而没有烦扰的心态；身边的人要来就让他来，要去就让他去，让钟声回荡，让孩子哭喊——下定决心好好地过一天。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[基于 YOLOv8 的交通标识与设施识别系统（含完整源码）]]></title>    <link>https://juejin.cn/post/7588365276191342630</link>    <guid>https://juejin.cn/post/7588365276191342630</guid>    <pubDate>2025-12-28T15:07:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588365276191342630" data-draft-id="7588140921249349670" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="基于 YOLOv8 的交通标识与设施识别系统（含完整源码）"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-28T15:07:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="我是杰尼"/> <meta itemprop="url" content="https://juejin.cn/user/4200579899599495"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            基于 YOLOv8 的交通标识与设施识别系统（含完整源码）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4200579899599495/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    我是杰尼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-28T15:07:59.000Z" title="Sun Dec 28 2025 15:07:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">基于 YOLOv8 的交通标识与设施识别系统（含完整源码）</h2>
<hr/>
<h3 data-id="heading-1">一、研究背景：为什么要做交通标识智能识别？</h3>
<p>在智慧城市与智能交通体系不断发展的背景下，道路交通场景对<strong>感知能力</strong>提出了越来越高的要求。
无论是：</p>
<ul>
<li>🚗 <strong>自动驾驶辅助系统</strong></li>
<li>📷 <strong>道路监控与违章识别</strong></li>
<li>🚦 <strong>智能信号控制</strong></li>
<li>🏙 <strong>城市道路数字化管理</strong></li>
</ul>
<p>都离不开对 <strong>交通标识与基础设施的精准识别</strong>。</p>
<p>传统基于图像处理和规则的方法，在面对以下复杂情况时往往表现不佳：</p>
<ul>
<li>光照变化（逆光、夜间、雨雾）</li>
<li>视角变化（倾斜、远近）</li>
<li>遮挡、老化、标志褪色</li>
<li>场景复杂（城市道路、高速、公路）</li>
</ul>
<p>因此，<strong>引入基于深度学习的目标检测技术</strong>，成为智能交通感知系统的核心方向之一。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b8ad1bc2877446d5b3eacfcab485f0a0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR5piv5p2w5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767539279&amp;x-signature=vDuzCzb7cBHr3J1VoFdYsrYCNVo%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-2">源码下载与效果演示</h3>
<p>哔哩哔哩视频下方观看：
<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1U1TkzTE1n%2F" target="_blank" title="https://www.bilibili.com/video/BV1U1TkzTE1n/" ref="nofollow noopener noreferrer">www.bilibili.com/video/BV1U1…</a></p>
<p>包含：</p>
<p>📦完整项目源码</p>
<p>📦 预训练模型权重</p>
<p>🗂️ 数据集地址（含标注脚本</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9478a3b7607c46a8acda343813d8f70b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR5piv5p2w5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767539279&amp;x-signature=khM%2BOl2uPgZKn4hFXJRRuZ5oJ%2BM%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-3">二、系统总体设计思路</h3>
<h4 data-id="heading-4">2.1 项目目标</h4>
<p>本项目基于 <strong>YOLOv8 目标检测模型</strong>，构建一套完整的 <strong>交通标识与设施智能识别系统</strong>，实现以下目标：</p>
<ul>
<li>自动识别关键交通元素</li>
<li>支持多种输入方式（图像 / 视频 / 摄像头）</li>
<li>提供可视化桌面端操作界面</li>
<li>实现从模型训练到工程部署的完整闭环</li>
</ul>
<h4 data-id="heading-5">2.2 检测目标定义</h4>
<p>系统当前支持以下 4 类交通目标（可扩展）：</p>

























<table><thead><tr><th>类别</th><th>含义</th></tr></thead><tbody><tr><td>crosswalk</td><td>人行横道</td></tr><tr><td>speedlimit</td><td>限速标志</td></tr><tr><td>stop</td><td>停车标志</td></tr><tr><td>trafficlight</td><td>交通信号灯</td></tr></tbody></table>
<p>这些目标具有 <strong>高频出现、对安全影响大、视觉特征明显</strong> 的特点，是智能交通感知系统的核心元素。</p>
<hr/>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bef7e6abd99349c9a901186a12ae925d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR5piv5p2w5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767539279&amp;x-signature=gpFHgFqS7zrSovGNrDlwgAvNmPY%3D" alt="在这里插入图片描述" loading="lazy"/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e1779573f47d4ffb9f47f470614b35c6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR5piv5p2w5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767539279&amp;x-signature=sknOTulTJWNQeJXtm1omI1fDJ0g%3D" alt="在这里插入图片描述" loading="lazy"/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0ce9a34b505744aabc5481c8e4ab4637~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR5piv5p2w5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767539279&amp;x-signature=goNf9I8uCxF%2FyzKcMSapNz%2BevQU%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h4 data-id="heading-6">2.3 技术架构概览</h4>
<p>系统整体采用经典的 <strong>AI 工程化分层设计</strong>：</p>
<pre><code class="hljs language-markdown" lang="markdown">输入层（图片 / 视频 / 摄像头）
<span class="hljs-code">        ↓
YOLOv8 目标检测模型
        ↓
目标类别 + 位置 + 置信度
        ↓
PyQt5 图形界面渲染
        ↓
结果展示 / 保存 / 扩展分析
</span></code></pre>
<hr/>
<h3 data-id="heading-7">三、YOLOv8 在交通场景中的优势分析</h3>
<h4 data-id="heading-8">3.1 为什么选择 YOLOv8？</h4>
<p>YOLOv8 是 Ultralytics 推出的新一代目标检测模型，相比 YOLOv5 / YOLOv7，在交通场景中具有明显优势：</p>
<ul>
<li>✅ <strong>Anchor-Free 架构</strong>
减少先验框依赖，对不同尺度标志更友好</li>
<li>✅ <strong>更高的推理速度</strong>
满足实时交通监控需求</li>
<li>✅ <strong>更稳定的训练过程</strong>
收敛速度快，调参成本低</li>
<li>✅ <strong>部署友好</strong>
原生支持 ONNX、TensorRT 等导出格式</li>
</ul>
<hr/>
<h4 data-id="heading-9">3.2 交通场景下的挑战</h4>
<p>交通标识检测并非简单任务，主要难点包括：</p>
<ul>
<li>标志尺寸差异大（远处限速牌 vs 近距离信号灯）</li>
<li>背景复杂（建筑、车辆、广告牌）</li>
<li>目标存在遮挡或部分损坏</li>
<li>白天 / 夜晚 / 雨雪等多环境变化</li>
</ul>
<p>YOLOv8 的多尺度特征融合与 TaskAlignedAssigner，使其在此类复杂场景中具备较强鲁棒性。</p>
<hr/>
<h3 data-id="heading-10">四、数据集构建与标注规范</h3>
<h4 data-id="heading-11">4.1 数据集来源与特点</h4>
<p>项目使用的交通场景数据集覆盖：</p>
<ul>
<li>城市道路</li>
<li>高速公路</li>
<li>不同天气与光照条件</li>
<li>多角度拍摄视角</li>
</ul>
<p>目标分布合理，有助于模型学习真实道路特征。</p>
<hr/>
<h4 data-id="heading-12">4.2 YOLO 数据集结构</h4>
<p>采用标准 YOLO 格式，保证训练与推理流程一致：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">dataset/
├── images/
│   ├── train/
│   └── <span class="hljs-keyword">val</span>/
├── labels/
│   ├── train/
│   └── <span class="hljs-keyword">val</span>/
</code></pre>
<p>标注文件示例：</p>
<pre><code class="hljs">2 0.4312 0.5128 0.1845 0.2967
</code></pre>
<p>含义说明：</p>
<ul>
<li><code>2</code>：类别 ID（如 stop）</li>
<li>后四项为归一化后的边界框坐标</li>
</ul>
<hr/>
<h4 data-id="heading-13">4.3 类别配置示例</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">nc:</span> <span class="hljs-number">4</span>
<span class="hljs-attr">names:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">crosswalk</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">speedlimit</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">stop</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">trafficlight</span>
</code></pre>
<hr/>
<h3 data-id="heading-14">五、模型训练与性能评估</h3>
<h4 data-id="heading-15">5.1 模型训练命令</h4>
<pre><code class="hljs language-bash" lang="bash">yolo detect train \
  data=traffic.yaml \
  model=yolov8n.pt \
  epochs=100 \
  batch=16 \
  imgsz=640 \
  lr0=0.001
</code></pre>
<p>参数选择说明：</p>
<ul>
<li><code>imgsz=640</code>：兼顾精度与速度</li>
<li><code>batch=16</code>：适合主流显卡配置</li>
<li><code>epochs=100</code>：保证模型充分收敛</li>
</ul>
<hr/>
<h4 data-id="heading-16">5.2 训练结果分析</h4>
<p>训练完成后，系统会自动生成：</p>
<ul>
<li>📈 Loss 曲线（box / cls / dfl）</li>
<li>📊 mAP@0.5、mAP@0.5:0.95</li>
<li>🔍 混淆矩阵（confusion matrix）</li>
</ul>
<p>一般来说：</p>
<blockquote>
<p>当 mAP@0.5 ≥ 90%，模型已具备实际工程应用价值。</p>
</blockquote>
<hr/>
<h3 data-id="heading-17">六、模型推理与结果解析</h3>
<h4 data-id="heading-18">6.1 推理代码示例</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> ultralytics <span class="hljs-keyword">import</span> YOLO

model = YOLO(<span class="hljs-string">"best.pt"</span>)
results = model(<span class="hljs-string">"road.jpg"</span>, conf=<span class="hljs-number">0.25</span>, save=<span class="hljs-literal">True</span>)

<span class="hljs-keyword">for</span> r <span class="hljs-keyword">in</span> results:
    <span class="hljs-keyword">for</span> box <span class="hljs-keyword">in</span> r.boxes:
        <span class="hljs-built_in">print</span>(box.cls, box.conf)
</code></pre>
<p>模型输出包括：</p>
<ul>
<li>目标类别</li>
<li>置信度</li>
<li>边界框坐标</li>
</ul>
<hr/>
<h4 data-id="heading-19">6.2 推理效果说明</h4>
<p>系统可在以下场景下稳定工作：</p>
<ul>
<li>单张交通图片检测</li>
<li>批量道路图片分析</li>
<li>视频流逐帧检测</li>
<li>实时摄像头监控</li>
</ul>
<p>检测结果以 <strong>边框 + 类别标签 + 置信度</strong> 形式可视化呈现。</p>
<hr/>
<h3 data-id="heading-20">七、PyQt5 桌面应用设计</h3>
<h4 data-id="heading-21">7.1 为什么使用 PyQt5？</h4>
<p>相比 Web 前端，PyQt5 在本项目中的优势在于：</p>
<ul>
<li>本地部署，适合离线环境</li>
<li>开发效率高，界面响应快</li>
<li>易于与 Python 推理代码集成</li>
<li>适合科研、演示与工程原型</li>
</ul>
<hr/>
<h4 data-id="heading-22">7.2 功能模块划分</h4>
<p>桌面端主要包含：</p>
<ul>
<li>📷 图片检测模块</li>
<li>📁 文件夹批量检测</li>
<li>🎥 视频检测模块</li>
<li>📡 摄像头实时检测</li>
<li>⚙️ 置信度阈值调节</li>
<li>💾 结果保存控制</li>
</ul>
<p>用户无需编写任何代码即可使用模型能力。</p>
<hr/>
<h3 data-id="heading-23">八、工程应用与扩展方向</h3>
<h4 data-id="heading-24">8.1 实际应用场景</h4>
<ul>
<li>智能交通监控系统</li>
<li>自动驾驶辅助感知模块</li>
<li>道路巡检与设施普查</li>
<li>AI 视觉教学与实验平台</li>
</ul>
<hr/>
<h4 data-id="heading-25">8.2 后续可拓展方向</h4>
<ol>
<li>
<p><strong>增加更多交通类别</strong></p>
<ul>
<li>禁行、转向、警告标志</li>
</ul>
</li>
<li>
<p><strong>引入目标跟踪算法</strong></p>
<ul>
<li>交通灯状态时序分析</li>
</ul>
</li>
<li>
<p><strong>边缘端部署</strong></p>
<ul>
<li>Jetson、嵌入式设备</li>
</ul>
</li>
<li>
<p><strong>与地图系统联动</strong></p>
<ul>
<li>构建高精度道路感知模型</li>
</ul>
</li>
</ol>
<hr/>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b0380f4f10c8432589f31ad75132bf2b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR5piv5p2w5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767539279&amp;x-signature=GN4VcFKZxQ9hbh2K6Gg3s%2BAtYD8%3D" alt="在这里插入图片描述" loading="lazy"/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/33e4a8a98d8040e4bc7a1251be064a9b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR5piv5p2w5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767539279&amp;x-signature=i1LmzPOIBhgHA%2BZzURoBJQfHuS8%3D" alt="在这里插入图片描述" loading="lazy"/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2f95f0e5ccfe4dbd9a486143399e2e56~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR5piv5p2w5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767539279&amp;x-signature=4Me3UbTCww1%2F1sb4EOaI6kgh4RY%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-26">九、总结</h3>
<p>本文围绕 <strong>YOLOv8 + PyQt5</strong> 技术体系，完整介绍了一套 <strong>交通标识与设施智能识别系统的工程化实现方案</strong>。项目不仅实现了多类交通目标的精准检测，还通过图形化界面大幅降低了使用门槛，使模型能力真正“可用、可落地”。</p>
<p><strong>核心优势回顾：</strong></p>
<ul>
<li>🚀 实时、高精度目标检测</li>
<li>🧠 深度学习与工程实践结合</li>
<li>🖥 图形界面友好，开箱即用</li>
<li>📦 提供完整源码与训练流程</li>
</ul>
<p>该系统既可作为 <strong>智能交通领域的研究原型</strong>，也可作为 <strong>计算机视觉工程项目或毕业设计的高质量模板</strong>，具备良好的扩展潜力与实际应用价值。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[基于 YOLOv8 的驾驶员疲劳状态识别系统实战（含完整源码与可视化界面）]]></title>    <link>https://juejin.cn/post/7588487605247967241</link>    <guid>https://juejin.cn/post/7588487605247967241</guid>    <pubDate>2025-12-28T15:22:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588487605247967241" data-draft-id="7588461466597818419" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="基于 YOLOv8 的驾驶员疲劳状态识别系统实战（含完整源码与可视化界面）"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-28T15:22:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="我是杰尼"/> <meta itemprop="url" content="https://juejin.cn/user/4200579899599495"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            基于 YOLOv8 的驾驶员疲劳状态识别系统实战（含完整源码与可视化界面）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4200579899599495/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    我是杰尼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-28T15:22:35.000Z" title="Sun Dec 28 2025 15:22:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">基于 YOLOv8 的驾驶员疲劳状态识别系统实战（含完整源码与可视化界面）</h2>
<h3 data-id="heading-1">一、项目背景与研究意义</h3>
<p>随着汽车保有量的持续增长，<strong>疲劳驾驶已成为交通事故的重要诱因之一</strong>。据统计，在高速公路和长途驾驶场景中，由于驾驶员长时间保持同一姿态，容易出现注意力下降、反应迟钝、频繁眨眼、打哈欠等疲劳特征，从而显著提升事故风险。</p>
<p>传统的疲劳检测方法多依赖以下方式：</p>
<ul>
<li>车载方向盘行为分析</li>
<li>心率、脑电等生理传感器</li>
<li>人工巡查与事后分析</li>
</ul>
<p>这些方法或成本较高，或依赖额外硬件，或难以规模化部署。相比之下，<strong>基于计算机视觉的疲劳状态识别</strong>具备以下优势：</p>
<ul>
<li>仅依赖摄像头即可工作</li>
<li>可实时分析驾驶员面部行为</li>
<li>易于与现有车载系统或监控系统集成</li>
</ul>
<p>基于此，本文实现并完整落地了一套 <strong>基于 YOLOv8 的驾驶员疲劳状态识别系统</strong>，并通过 <strong>PyQt5 图形化界面</strong> 实现真正意义上的“开箱即用”。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4e77b9554fe5410b8e8f95b33d20113f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR5piv5p2w5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767540154&amp;x-signature=BKzUP8FPFj1k2i1enZ9ucLY8HuY%3D" alt="在这里插入图片描述" loading="lazy"/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/62fe308009194a958169d9f04cb84058~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR5piv5p2w5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767540154&amp;x-signature=mwWq0fOdUsX9KqKGrOsE3CKdR0Y%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-2">源码下载与效果演示</h3>
<p>哔哩哔哩视频下方观看：
<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1noKpzNEvQ%2F" target="_blank" title="https://www.bilibili.com/video/BV1noKpzNEvQ/" ref="nofollow noopener noreferrer">www.bilibili.com/video/BV1no…</a></p>
<p>包含：</p>
<p>📦完整项目源码</p>
<p>📦 预训练模型权重</p>
<p>🗂️ 数据集地址（含标注脚本</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ef39fdb2f7e74645b707c7d9b3478e9b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR5piv5p2w5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767540154&amp;x-signature=lKm8NgzBmVJzUqr8r%2FX2yVmgEGI%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-3">二、系统总体设计方案</h3>
<h4 data-id="heading-4">2.1 系统架构概览</h4>
<p>整个系统采用典型的 <strong>“模型推理 + GUI 展示”</strong> 架构，核心流程如下：</p>
<pre><code class="hljs language-markdown" lang="markdown">输入源（图片 / 视频 / 摄像头）
<span class="hljs-code">        ↓
YOLOv8 疲劳行为检测模型
        ↓
行为状态判定（闭眼 / 打哈欠 / 正常）
        ↓
PyQt5 图形界面实时展示
        ↓
检测结果保存与回放
</span></code></pre>
<p>系统既可以作为 <strong>独立桌面应用运行</strong>，也可作为 <strong>疲劳检测模块嵌入到其他项目中</strong>。</p>
<hr/>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9d17f658c12e46159802b8624fcdfa72~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR5piv5p2w5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767540154&amp;x-signature=CVsWVxtaTMEkfOOFwV6igCqDPiw%3D" alt="在这里插入图片描述" loading="lazy"/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/52c6328fcc86445a86dd55128bec49d6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR5piv5p2w5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767540154&amp;x-signature=4ue2eDeM2BFrUGMB29htoQm3PtY%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h4 data-id="heading-5">2.2 功能模块划分</h4>
<p>系统主要包含以下几个核心功能模块：</p>

































<table><thead><tr><th>模块名称</th><th>功能说明</th></tr></thead><tbody><tr><td>模型加载模块</td><td>支持加载训练好的 YOLOv8 权重</td></tr><tr><td>图像检测模块</td><td>单张或批量图片疲劳识别</td></tr><tr><td>视频检测模块</td><td>视频逐帧分析并保存结果</td></tr><tr><td>摄像头模块</td><td>实时疲劳行为检测</td></tr><tr><td>阈值控制模块</td><td>动态调整置信度阈值</td></tr><tr><td>结果保存模块</td><td>自动保存检测图片与视频</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-6">三、疲劳状态识别思路设计</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/441ea3e6401740b88ed354eb286aa5d2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR5piv5p2w5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767540154&amp;x-signature=i%2FXoYXFHcA3NIsRetFAr136D7bw%3D" alt="在这里插入图片描述" loading="lazy"/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e4a7406f7bed4c2fbc1351ea69f28b55~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR5piv5p2w5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767540154&amp;x-signature=Vns6%2FLYr8J97c3flPtDkQ5tqCwg%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h4 data-id="heading-7">3.1 疲劳行为建模思路</h4>
<p>本项目并非直接做“疲劳 / 非疲劳”二分类，而是采用 <strong>更具工程可解释性的行为检测策略</strong>，即：</p>
<blockquote>
<p><strong>先检测具体疲劳行为，再综合判断驾驶状态</strong></p>
</blockquote>
<p>主要检测以下关键目标：</p>
<ul>
<li><strong>闭眼（Eye Closed）</strong></li>
<li><strong>打哈欠（Yawning）</strong></li>
</ul>
<p>通过对 <strong>眼睛状态 + 嘴部张开程度</strong> 的组合分析，可以有效区分：</p>
<ul>
<li>正常驾驶</li>
<li>轻度疲劳</li>
<li>明显疲劳</li>
</ul>
<p>该方式相比纯分类模型，更适合后续扩展（如分神检测、低头玩手机等）。</p>
<hr/>
<h4 data-id="heading-8">3.2 模型选择原因：YOLOv8</h4>
<p>YOLOv8 是 Ultralytics 推出的新一代目标检测模型，具有以下优势：</p>
<ul>
<li>Anchor-Free 架构，训练更稳定</li>
<li>推理速度快，适合实时视频流</li>
<li>原生支持 ONNX / TensorRT 导出</li>
<li>生态成熟，工程资料丰富</li>
</ul>
<p>在疲劳驾驶这种 <strong>实时性要求极高</strong> 的场景中，YOLOv8 非常适合部署在边缘端或本地端。</p>
<hr/>
<h3 data-id="heading-9">四、数据集构建与训练流程</h3>
<h4 data-id="heading-10">4.1 数据集结构设计</h4>
<p>项目采用标准 YOLO 数据集格式，结构如下：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">dataset/
├── images/
│   ├── train
│   └── <span class="hljs-keyword">val</span>
├── labels/
│   ├── train
│   └── <span class="hljs-keyword">val</span>
</code></pre>
<p>每一张图片都对应一个 <code>.txt</code> 标注文件，记录目标类别与归一化后的边框信息。</p>
<hr/>
<h4 data-id="heading-11">4.2 标注类别说明</h4>
<p>本项目标注的核心类别包括：</p>
<ul>
<li><code>eye_close</code></li>
<li><code>yawn</code></li>
</ul>
<p>可根据实际需求继续扩展：</p>
<ul>
<li><code>eye_open</code></li>
<li><code>phone_use</code></li>
<li><code>head_down</code></li>
</ul>
<hr/>
<h4 data-id="heading-12">4.3 模型训练命令示例</h4>
<p>使用 Ultralytics 官方 CLI 即可完成训练：</p>
<pre><code class="hljs language-bash" lang="bash">yolo detect train \
data=datasets/expression/loopy.yaml \
model=yolov8n.pt \
epochs=100 \
batch=16 \
lr0=0.001
</code></pre>
<p>训练完成后，将自动生成：</p>
<ul>
<li>最优权重 <code>best.pt</code></li>
<li>损失函数曲线</li>
<li>mAP 评估指标</li>
<li>混淆矩阵</li>
</ul>
<hr/>
<h3 data-id="heading-13">五、模型推理与结果解析</h3>
<h4 data-id="heading-14">5.1 推理代码示例</h4>
<p>模型推理基于 PyTorch 与 Ultralytics API：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> ultralytics <span class="hljs-keyword">import</span> YOLO

model = YOLO(<span class="hljs-string">"best.pt"</span>)
results = model(<span class="hljs-string">"test.jpg"</span>, conf=<span class="hljs-number">0.25</span>)

<span class="hljs-keyword">for</span> box <span class="hljs-keyword">in</span> results[<span class="hljs-number">0</span>].boxes:
    cls = <span class="hljs-built_in">int</span>(box.cls)
    score = <span class="hljs-built_in">float</span>(box.conf)
</code></pre>
<p>模型输出包括：</p>
<ul>
<li>目标类别</li>
<li>置信度</li>
<li>边框坐标</li>
</ul>
<hr/>
<h4 data-id="heading-15">5.2 状态判定逻辑</h4>
<p>在工程实现中，可以采用如下逻辑：</p>
<ul>
<li>连续多帧检测到闭眼 → 疲劳预警</li>
<li>间歇性打哈欠 → 疲劳趋势提示</li>
<li>长时间无异常 → 正常状态</li>
</ul>
<p>这种 <strong>时序融合策略</strong> 可有效降低误报率。</p>
<hr/>
<h3 data-id="heading-16">六、PyQt5 图形界面设计</h3>
<h4 data-id="heading-17">6.1 GUI 设计目标</h4>
<p>在实际落地中，很多用户并不具备深度学习背景，因此 GUI 设计的目标是：</p>
<ul>
<li>不需要写代码即可运行</li>
<li>操作流程简单直观</li>
<li>支持一键检测与保存</li>
</ul>
<hr/>
<h4 data-id="heading-18">6.2 界面功能说明</h4>
<p>PyQt5 界面主要包括：</p>
<ul>
<li>模型加载按钮</li>
<li>图片 / 视频选择按钮</li>
<li>摄像头开关</li>
<li>检测结果显示区域</li>
<li>日志与状态提示区域</li>
</ul>
<p>多线程推理机制保证了 <strong>检测过程中界面不卡顿</strong>。</p>
<hr/>
<h3 data-id="heading-19">七、系统部署与运行方式</h3>
<h4 data-id="heading-20">7.1 一键运行</h4>
<p>项目已完成完整打包，运行方式非常简单：</p>
<pre><code class="hljs language-bash" lang="bash">python main.py
</code></pre>
<p>无需重新训练即可体验完整功能。</p>
<hr/>
<h4 data-id="heading-21">7.2 可扩展部署方向</h4>
<p>该系统可进一步部署到：</p>
<ul>
<li>车载嵌入式设备</li>
<li>智能驾驶辅助系统</li>
<li>安全监控终端</li>
<li>教学与科研实验平台</li>
</ul>
<hr/>
<h3 data-id="heading-22">八、项目总结与未来展望</h3>
<p>本文完整介绍了一套 <strong>基于 YOLOv8 的疲劳驾驶识别系统</strong>，从算法原理、数据集构建、模型训练到 GUI 工程落地，形成了完整闭环。</p>
<h4 data-id="heading-23">项目核心优势总结：</h4>
<ul>
<li>🚗 面向真实驾驶场景，实用性强</li>
<li>🧠 行为级检测，结果可解释</li>
<li>💻 PyQt5 图形界面，零代码运行</li>
<li>⚡ YOLOv8 实时推理，性能稳定</li>
<li>📦 项目完整打包，开箱即用</li>
</ul>
<h4 data-id="heading-24">后续可扩展方向：</h4>
<ul>
<li>引入时序模型（LSTM / Transformer）</li>
<li>增加分神、低头、抽烟等行为</li>
<li>联合多摄像头多视角分析</li>
<li>与语音报警、CAN 总线联动</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端开发者使用 AI 的能力层级——从表面使用到工程化能力的真正分水岭]]></title>    <link>https://juejin.cn/post/7588376012121112603</link>    <guid>https://juejin.cn/post/7588376012121112603</guid>    <pubDate>2025-12-28T15:42:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588376012121112603" data-draft-id="7588355695101493257" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端开发者使用 AI 的能力层级——从表面使用到工程化能力的真正分水岭"/> <meta itemprop="keywords" content="程序员,人工智能,前端"/> <meta itemprop="datePublished" content="2025-12-28T15:42:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="月亮有石头"/> <meta itemprop="url" content="https://juejin.cn/user/3526889032395613"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端开发者使用 AI 的能力层级——从表面使用到工程化能力的真正分水岭
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3526889032395613/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    月亮有石头
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-28T15:42:52.000Z" title="Sun Dec 28 2025 15:42:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>很多前端开发者已经在“使用 AI”：<br/>
会问问题、会让 AI 写代码、甚至在 IDE 里和 AI 对话。</p>
<p>但如果这些使用方式 <strong>无法稳定地产出可运行、可验证、可回归的工程结果</strong>，<br/>
那么严格来说——<strong>其实还没有真正入门。</strong></p>
</blockquote>
<p>这篇文章想系统回答一个问题：</p>
<blockquote>
<p><strong>前端开发者“使用 AI”的能力，是有明确层级和分水岭的。</strong></p>
</blockquote>
<p>不是工具多不多，也不是模型新不新，<br/>
而是：<strong>你用 AI 的方式，决定了它在你工程体系里的角色。</strong></p>
<p>把 AI 放进工程链路，用工程约束对抗幻觉，用验证与反馈逼近真实。
<strong>AI 工程化的本质，并不是让模型更聪明，<br/>
而是把 AI 放入完整的软件工程链路中。</strong></p>
<p>通过 MCP 提供真实项目上下文，最大限度压缩幻觉空间；<br/>
通过 Spec 与工程规则对 AI 行为进行硬约束；<br/>
通过自动化测试与构建验证，把“是否正确”的判断交给机器；<br/>
通过多轮执行与修复循环，让 AI 像工程师一样调试问题；<br/>
最终再通过人工 Review 的反馈，不断反哺和升级工程规范。</p>
<p><strong>目标不是“消灭幻觉”，而是让 AI 的行为尽可能接近真实工程世界</strong></p>
<h2 data-id="heading-0">一、为什么“我已经在用 AI”，却感觉始终不踏实？</h2>
<p>一个很常见的真实场景：</p>
<ul>
<li>AI 能写 Vue 页面，但不知道你的项目结构</li>
<li>不知道你们封装的 <code>BaseList</code>、<code>request</code></li>
<li>不知道路由、权限、构建规则</li>
<li>更不知道怎么验证能不能跑</li>
</ul>
<p>于是流程变成了：</p>
<blockquote>
<p>问 AI → 复制代码 → 报错 → 手改 → 再问 AI</p>
</blockquote>
<p><strong>问题不在于 AI 不行，而在于：</strong></p>
<blockquote>
<p>你用的是 <strong>生成能力</strong>，而不是 <strong>工程能力</strong>。</p>
</blockquote>
<h2 data-id="heading-1">二、前端开发者使用 AI 的能力层级（L0–L6）</h2>
<h3 data-id="heading-2">🟢 L0｜纯对话型使用：把 AI 当搜索引擎</h3>
<p><strong>典型方式</strong></p>
<ul>
<li>浏览器里问 AI</li>
<li>复制粘贴代码</li>
</ul>
<p><strong>你在做什么</strong></p>
<ul>
<li>AI 给建议</li>
<li>你负责所有判断</li>
</ul>
<p><strong>能力上限</strong></p>
<ul>
<li>❌ AI 不知道你的项目</li>
<li>❌ 代码是否能跑，全靠你</li>
</ul>
<blockquote>
<p><strong>本质</strong>：AI = 搜索引擎 + 示例生成器</p>
</blockquote>
<hr/>
<h3 data-id="heading-3">🟡 L1｜提示词工程：更会“跟 AI 说话”</h3>
<p><strong>你开始做的事</strong></p>
<ul>
<li>限定 Vue2 / Ant Design Vue</li>
<li>要求先给方案再写代码</li>
<li>规定输出结构</li>
</ul>
<p><strong>提升点</strong></p>
<ul>
<li>跑偏变少</li>
<li>可读性变好</li>
</ul>
<p><strong>但问题仍在</strong></p>
<ul>
<li>❌ 项目上下文全靠你描述</li>
<li>❌ 一换人 / 一换模型就不稳</li>
</ul>
<blockquote>
<p><strong>这是“说清楚了”，不是“用对了”。</strong></p>
</blockquote>
<hr/>
<h3 data-id="heading-4">🟠 L2｜IDE 内置 AI：能看代码，但只看一点</h3>
<p><strong>代表场景</strong></p>
<ul>
<li>Cursor / Trae 里直接对话</li>
<li>AI 能看到当前文件</li>
</ul>
<p><strong>能做的事</strong></p>
<ul>
<li>改一个组件</li>
<li>修一个 lint 报错</li>
</ul>
<p><strong>能力边界</strong></p>
<ul>
<li>❌ 看不到整个 repo</li>
<li>❌ 不会主动找样例</li>
<li>❌ 不会跑构建验证</li>
</ul>
<blockquote>
<p><strong>AI 还是“副驾驶”，不是工程参与者。</strong></p>
</blockquote>
<hr/>
<h3 data-id="heading-5">🟢🟢 L3｜IDE + MCP：AI 开始真正“干活”</h3>
<p>这是<strong>第一个关键分水岭</strong>。</p>
<p><strong>你做了什么改变</strong></p>
<ul>
<li>
<p>让 AI 能：</p>
<ul>
<li>读整个项目（白名单）</li>
<li>搜索已有实现</li>
<li>修改真实文件（patch）</li>
<li>跑 <code>npm run lint / build</code></li>
</ul>
</li>
</ul>
<p><strong>AI 能力升级为</strong></p>
<ul>
<li>真正参与工程执行</li>
<li>用你们的代码当模板</li>
<li>用验证结果证明自己</li>
</ul>
<p><strong>但还不够</strong></p>
<ul>
<li>输出风格不稳定</li>
<li>不同需求，结果差异大</li>
</ul>
<blockquote>
<p><strong>AI 会干活了，但还没有“交付标准”。</strong></p>
</blockquote>
<hr/>
<h3 data-id="heading-6">🔵 L4｜Spec 驱动：从“写代码”到“按合同交付”</h3>
<p>这是<strong>真正的工程分水岭</strong>。</p>
<p><strong>变化不在工具，而在工作方式</strong></p>
<ul>
<li>
<p>先写 Spec，再让 AI 实现</p>
</li>
<li>
<p>Spec 里写清楚：</p>
<ul>
<li>页面路由</li>
<li>数据契约</li>
<li>UI/交互约束</li>
<li>验收标准</li>
</ul>
</li>
</ul>
<p><strong>AI 的角色变化</strong></p>
<blockquote>
<p>❌ 不再“自由发挥”<br/>
✅ 按 Spec 实现<br/>
✅ 对照清单自查</p>
</blockquote>
<p><strong>这一步解决了什么</strong></p>
<ul>
<li>稳定性</li>
<li>可复现</li>
<li>可回归</li>
<li>团队可协作</li>
</ul>
<hr/>
<h3 data-id="heading-7">🟣 L5｜Agent 化使用：AI 像高级工程师</h3>
<p><strong>AI 开始具备</strong></p>
<ul>
<li>自动拆任务</li>
<li>多步执行</li>
<li>失败自修复</li>
<li>自动验证</li>
</ul>
<p><strong>典型流程</strong></p>
<pre><code class="hljs language-js" lang="js">读 <span class="hljs-title class_">Spec</span> → 拆解 → 实现 → 验证 → 修复 → 交付
</code></pre>
<p>你不再关心“它怎么一步步做”。</p>
<hr/>
<h3 data-id="heading-8">🔴 L6｜工程体系级使用：AI 成为系统一部分</h3>
<p>这一层，已经不是“写页面”了。</p>
<p><strong>特征</strong></p>
<ul>
<li>Spec → Schema</li>
<li>Schema → 自动生成页面</li>
<li>AI 负责调度与校验</li>
</ul>
<p><strong>你在做的事情</strong></p>
<blockquote>
<p>不是写代码，而是 <strong>定义工程能力</strong></p>
</blockquote>
<h2 data-id="heading-9">三、更高阶：真正的工程范式升级（L7+）</h2>
<h3 data-id="heading-10">🔶 L7｜Spec-as-Code（规范即代码）</h3>
<ul>
<li>Spec 不再是文档</li>
<li>是 JSON / YAML Schema</li>
<li>不合法 → 不执行</li>
</ul>
<h3 data-id="heading-11">🔷 L8｜工程治理（Guardrails）</h3>
<ul>
<li>禁止绕过封装</li>
<li>禁止新增依赖</li>
<li>禁止越权路由</li>
</ul>
<p>AI 被工程规则“约束”。</p>
<h3 data-id="heading-12">🔷 L9｜Multi-Agent 协作</h3>
<ul>
<li>Planner / Frontend / QA / Reviewer</li>
<li>AI 像一个工程团队</li>
</ul>
<h3 data-id="heading-13">🔴 L10｜自进化工程体系</h3>
<ul>
<li>人的 Review 意见</li>
<li>变成机器规则</li>
<li>下次不再犯同样错误</li>
</ul>
<h2 data-id="heading-14">四、这不是工具升级，而是工程认知升级</h2>
<p>很多人问：</p>
<blockquote>
<p>“我要不要用 MCP？要不要写 Spec？要不要 Agent？”</p>
</blockquote>
<p>真正的问题其实是：</p>
<blockquote>
<p><strong>你希望 AI 在你团队里，扮演什么角色？</strong></p>
</blockquote>
<ul>
<li>写代码的助手？</li>
<li>能交付的工程师？</li>
<li>还是工程体系的一部分？</li>
</ul>
<h2 data-id="heading-15">五、结语：真正的“入门”标准是什么？</h2>
<blockquote>
<p><strong>真正入门 AI 前端开发的标志，不是“写得快”，<br/>
而是：<br/>
AI 是否能稳定地产出——<br/>
可运行、可验证、可回归的工程结果。</strong></p>
</blockquote>
<ul>
<li>Prompt 是技巧</li>
<li>MCP 是能力</li>
<li>Spec 是契约</li>
<li>Guardrails 是纪律</li>
<li>Agent 是组织</li>
<li>工程体系是终点</li>
</ul>
<p>如果你发现自己：</p>
<ul>
<li>已经在用 AI</li>
<li>但仍然不放心让它“直接改项目”</li>
<li>不敢让它“独立交付功能”</li>
</ul>
<p>那不是你落后，而是你刚好站在“表面使用”和“工程化能力”的分水岭上。幻觉不是 AI 的问题，而是 AI 不在工程链路里的结果。当 AI 被约束在工程规则、上下文和验证之中，它就不再“幻想”，而是在执行。AI 的可靠性，不来自模型能力，而来自工程闭环。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Rust 错误处理完全指南：从入门到精通]]></title>    <link>https://juejin.cn/post/7588300640599932934</link>    <guid>https://juejin.cn/post/7588300640599932934</guid>    <pubDate>2025-12-28T14:04:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588300640599932934" data-draft-id="7588300640599916550" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Rust 错误处理完全指南：从入门到精通"/> <meta itemprop="keywords" content="Rust,前端,编程语言"/> <meta itemprop="datePublished" content="2025-12-28T14:04:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="土豆1250"/> <meta itemprop="url" content="https://juejin.cn/user/3280598428302727"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Rust 错误处理完全指南：从入门到精通
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3280598428302727/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    土豆1250
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-28T14:04:31.000Z" title="Sun Dec 28 2025 14:04:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    18
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是<a href="https://juejin.cn/user/3280598428302727" target="_blank" title="https://juejin.cn/user/3280598428302727">土豆</a>，欢迎关注我的<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FWvuT_N3bwgTUicUOZXwW4g" target="_blank" title="https://mp.weixin.qq.com/s/WvuT_N3bwgTUicUOZXwW4g" ref="nofollow noopener noreferrer">公众号：土豆学前端</a></p>
<h2 data-id="heading-0">Why - 为什么要认真对待错误处理?</h2>
<h3 data-id="heading-1">错误处理的重要性</h3>
<p>想象一下，你正在开发一个文件处理程序。在其他语言中，你可能会这样写：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># Python 风格</span>
file = <span class="hljs-built_in">open</span>(<span class="hljs-string">"config.txt"</span>)  <span class="hljs-comment"># 如果文件不存在？💥</span>
data = file.read()
</code></pre>
<p>程序可能在任何时候崩溃，用户只会看到一个难看的错误堆栈。但在 Rust 中，编译器会逼着你面对现实：<strong>"嘿！文件可能不存在，你打算怎么办？"</strong></p>
<p>这就是 Rust 的哲学：<strong>错误是程序的一部分，不是意外。</strong></p>
<h3 data-id="heading-2">Rust 的设计理念</h3>
<p>Rust 通过类型系统强制你处理错误，这意味着：</p>
<ul>
<li>✅ 编译时就能发现潜在问题</li>
<li>✅ 代码更加可靠和可维护</li>
<li>✅ 不会有"忘记处理错误"这回事</li>
<li>❌ 但需要写更多代码（值得的！）</li>
</ul>
<hr/>
<h2 data-id="heading-3">What - Rust 中的错误类型</h2>
<h3 data-id="heading-4">1. 可恢复错误：<code>Result&lt;T, E&gt;</code></h3>
<p><code>Result</code> 是 Rust 错误处理的核心，它是一个枚举：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">enum</span> <span class="hljs-title class_">Result</span>&lt;T, E&gt; {
    <span class="hljs-title function_ invoke__">Ok</span>(T),   <span class="hljs-comment">// 成功时包含值</span>
    <span class="hljs-title function_ invoke__">Err</span>(E),  <span class="hljs-comment">// 失败时包含错误</span>
}
</code></pre>
<p><strong>使用场景：</strong> 预期可能会失败的操作，如文件 I/O、网络请求、解析数据等。</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">use</span> std::fs::File;

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">open_file</span>() <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;File, std::io::Error&gt; {
    File::<span class="hljs-title function_ invoke__">open</span>(<span class="hljs-string">"hello.txt"</span>)  <span class="hljs-comment">// 返回 Result</span>
}
</code></pre>
<h3 data-id="heading-5">2. 可选值：<code>Option&lt;T&gt;</code></h3>
<p><code>Option</code> 用于表示"可能有值，也可能没有"：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">enum</span> <span class="hljs-title class_">Option</span>&lt;T&gt; {
    <span class="hljs-title function_ invoke__">Some</span>(T),  <span class="hljs-comment">// 有值</span>
    <span class="hljs-literal">None</span>,     <span class="hljs-comment">// 没有值</span>
}
</code></pre>
<p><strong>使用场景：</strong> 值可能不存在，但这不算错误。</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">find_user</span>(id: <span class="hljs-type">u32</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Option</span>&lt;User&gt; {
    <span class="hljs-comment">// 用户不存在是正常情况，不是错误</span>
    users.<span class="hljs-title function_ invoke__">get</span>(&amp;id).<span class="hljs-title function_ invoke__">cloned</span>()
}
</code></pre>
<p><strong>区别记忆法：</strong></p>
<ul>
<li><code>None</code> = "没找到，但这很正常" 🤷</li>
<li><code>Err</code> = "出问题了，需要知道为什么" ⚠️</li>
</ul>
<h3 data-id="heading-6">3. 不可恢复错误：<code>panic!</code></h3>
<p><code>panic!</code> 会立即终止程序：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">divide</span>(a: <span class="hljs-type">i32</span>, b: <span class="hljs-type">i32</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">i32</span> {
    <span class="hljs-keyword">if</span> b == <span class="hljs-number">0</span> {
        <span class="hljs-built_in">panic!</span>(<span class="hljs-string">"除数不能为零！"</span>);  <span class="hljs-comment">// 程序崩溃</span>
    }
    a / b
}
</code></pre>
<p><strong>使用场景：</strong></p>
<ul>
<li>程序遇到无法继续的致命错误</li>
<li>开发阶段快速原型</li>
<li>不应该发生的逻辑错误（类似 assert）</li>
</ul>
<p>⚠️ <strong>注意：</strong> 生产代码应该尽量少用 <code>panic!</code></p>
<hr/>
<h2 data-id="heading-7">How - 如何优雅地处理错误</h2>
<h3 data-id="heading-8">基础处理方式</h3>
<h4 data-id="heading-9">1. <code>match</code> 表达式（最基础）</h4>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">use</span> std::fs::File;

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">file_result</span> = File::<span class="hljs-title function_ invoke__">open</span>(<span class="hljs-string">"hello.txt"</span>);
    
    <span class="hljs-keyword">match</span> file_result {
        <span class="hljs-title function_ invoke__">Ok</span>(file) =&gt; {
            <span class="hljs-built_in">println!</span>(<span class="hljs-string">"成功打开文件！"</span>);
            <span class="hljs-comment">// 使用 file</span>
        }
        <span class="hljs-title function_ invoke__">Err</span>(error) =&gt; {
            <span class="hljs-built_in">println!</span>(<span class="hljs-string">"打开文件失败: {}"</span>, error);
            <span class="hljs-comment">// 处理错误</span>
        }
    }
}
</code></pre>
<h4 data-id="heading-10">2. <code>unwrap()</code> 和 <code>expect()</code>（快速但危险）</h4>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// unwrap: 成功返回值，失败就 panic</span>
<span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">file</span> = File::<span class="hljs-title function_ invoke__">open</span>(<span class="hljs-string">"hello.txt"</span>).<span class="hljs-title function_ invoke__">unwrap</span>();

<span class="hljs-comment">// expect: 和 unwrap 一样，但可以自定义 panic 消息</span>
<span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">file</span> = File::<span class="hljs-title function_ invoke__">open</span>(<span class="hljs-string">"hello.txt"</span>)
    .<span class="hljs-title function_ invoke__">expect</span>(<span class="hljs-string">"无法打开 hello.txt，请检查文件是否存在"</span>);
</code></pre>
<p><strong>何时使用？</strong></p>
<ul>
<li>✅ 写示例代码或快速原型</li>
<li>✅ 你 100% 确定不会失败的情况</li>
<li>❌ 生产代码（几乎不要用）</li>
</ul>
<p><strong>记忆口诀：</strong> <code>unwrap()</code> 是"我很自信，不会出错"，用错了就是"打脸现场" 😅</p>
<h4 data-id="heading-11">3. <code>?</code> 操作符（最优雅）</h4>
<p><code>?</code> 是 Rust 的语法糖，自动处理错误传播：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">use</span> std::fs::File;
<span class="hljs-keyword">use</span> std::io::{<span class="hljs-keyword">self</span>, Read};

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">read_username_from_file</span>() <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;<span class="hljs-type">String</span>, io::Error&gt; {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">file</span> = File::<span class="hljs-title function_ invoke__">open</span>(<span class="hljs-string">"username.txt"</span>)?;  <span class="hljs-comment">// 如果失败，直接返回 Err</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">username</span> = <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">new</span>();
    file.<span class="hljs-title function_ invoke__">read_to_string</span>(&amp;<span class="hljs-keyword">mut</span> username)?;  <span class="hljs-comment">// 同样的魔法</span>
    <span class="hljs-title function_ invoke__">Ok</span>(username)  <span class="hljs-comment">// 成功时返回</span>
}
</code></pre>
<p><strong><code>?</code> 的工作原理：</strong></p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// 这段代码：</span>
<span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">file</span> = File::<span class="hljs-title function_ invoke__">open</span>(<span class="hljs-string">"hello.txt"</span>)?;

<span class="hljs-comment">// 等价于：</span>
<span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">file</span> = <span class="hljs-keyword">match</span> File::<span class="hljs-title function_ invoke__">open</span>(<span class="hljs-string">"hello.txt"</span>) {
    <span class="hljs-title function_ invoke__">Ok</span>(f) =&gt; f,
    <span class="hljs-title function_ invoke__">Err</span>(e) =&gt; <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">Err</span>(e),
};
</code></pre>
<p><strong>使用条件：</strong></p>
<ul>
<li>函数必须返回 <code>Result</code> 或 <code>Option</code></li>
<li>错误类型必须能够转换（实现了 <code>From</code> trait）</li>
</ul>
<h3 data-id="heading-12">进阶技巧</h3>
<h4 data-id="heading-13">1. 链式调用</h4>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">use</span> std::fs;

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">read_and_parse</span>() <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;<span class="hljs-type">i32</span>, <span class="hljs-type">Box</span>&lt;<span class="hljs-keyword">dyn</span> std::error::Error&gt;&gt; {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">content</span> = fs::<span class="hljs-title function_ invoke__">read_to_string</span>(<span class="hljs-string">"number.txt"</span>)?;
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">number</span>: <span class="hljs-type">i32</span> = content.<span class="hljs-title function_ invoke__">trim</span>().<span class="hljs-title function_ invoke__">parse</span>()?;
    <span class="hljs-title function_ invoke__">Ok</span>(number)
}
</code></pre>
<h4 data-id="heading-14">2. 使用 <code>and_then</code> 和 <code>map</code></h4>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">get_user_age</span>(id: <span class="hljs-type">u32</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Option</span>&lt;<span class="hljs-type">u32</span>&gt; {
    <span class="hljs-title function_ invoke__">find_user</span>(id)
        .<span class="hljs-title function_ invoke__">map</span>(|user| user.age)  <span class="hljs-comment">// 如果找到用户，提取年龄</span>
}

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">process_file</span>(path: &amp;<span class="hljs-type">str</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;<span class="hljs-type">String</span>, io::Error&gt; {
    fs::<span class="hljs-title function_ invoke__">read_to_string</span>(path)
        .<span class="hljs-title function_ invoke__">and_then</span>(|content| {
            <span class="hljs-comment">// 进一步处理</span>
            <span class="hljs-title function_ invoke__">Ok</span>(content.<span class="hljs-title function_ invoke__">to_uppercase</span>())
        })
}
</code></pre>
<h4 data-id="heading-15">3. 提供默认值</h4>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// Option: 使用 unwrap_or</span>
<span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">user</span> = <span class="hljs-title function_ invoke__">find_user</span>(<span class="hljs-number">123</span>).<span class="hljs-title function_ invoke__">unwrap_or</span>(User::<span class="hljs-title function_ invoke__">default</span>());

<span class="hljs-comment">// Option: 使用 unwrap_or_else（惰性求值）</span>
<span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">user</span> = <span class="hljs-title function_ invoke__">find_user</span>(<span class="hljs-number">123</span>).<span class="hljs-title function_ invoke__">unwrap_or_else</span>(|| {
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"用户不存在，创建默认用户"</span>);
    User::<span class="hljs-title function_ invoke__">default</span>()
});

<span class="hljs-comment">// Result: 使用 unwrap_or_default</span>
<span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">count</span>: <span class="hljs-type">i32</span> = <span class="hljs-title function_ invoke__">parse_number</span>(<span class="hljs-string">"abc"</span>).<span class="hljs-title function_ invoke__">unwrap_or_default</span>();  <span class="hljs-comment">// 失败返回 0</span>
</code></pre>
<h4 data-id="heading-16">4. 错误转换</h4>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">use</span> std::num::ParseIntError;

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">double_number</span>(s: &amp;<span class="hljs-type">str</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;<span class="hljs-type">i32</span>, ParseIntError&gt; {
    s.parse::&lt;<span class="hljs-type">i32</span>&gt;()
        .<span class="hljs-title function_ invoke__">map</span>(|n| n * <span class="hljs-number">2</span>)  <span class="hljs-comment">// 成功时转换值，错误类型不变</span>
}
</code></pre>
<hr/>
<h2 data-id="heading-17">最佳实践</h2>
<h3 data-id="heading-18">1. 自定义错误类型</h3>
<p>对于复杂项目，创建自己的错误类型：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">use</span> std::fmt;

<span class="hljs-meta">#[derive(Debug)]</span>
<span class="hljs-keyword">enum</span> <span class="hljs-title class_">AppError</span> {
    <span class="hljs-title function_ invoke__">IoError</span>(std::io::Error),
    <span class="hljs-title function_ invoke__">ParseError</span>(<span class="hljs-type">String</span>),
    <span class="hljs-title function_ invoke__">NotFound</span>(<span class="hljs-type">String</span>),
}

<span class="hljs-comment">// 实现 Display trait</span>
<span class="hljs-keyword">impl</span> <span class="hljs-title class_">fmt</span>::Display <span class="hljs-keyword">for</span> <span class="hljs-title class_">AppError</span> {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">fmt</span>(&amp;<span class="hljs-keyword">self</span>, f: &amp;<span class="hljs-keyword">mut</span> fmt::Formatter) <span class="hljs-punctuation">-&gt;</span> fmt::<span class="hljs-type">Result</span> {
        <span class="hljs-keyword">match</span> <span class="hljs-keyword">self</span> {
            AppError::<span class="hljs-title function_ invoke__">IoError</span>(e) =&gt; <span class="hljs-built_in">write!</span>(f, <span class="hljs-string">"IO 错误: {}"</span>, e),
            AppError::<span class="hljs-title function_ invoke__">ParseError</span>(msg) =&gt; <span class="hljs-built_in">write!</span>(f, <span class="hljs-string">"解析错误: {}"</span>, msg),
            AppError::<span class="hljs-title function_ invoke__">NotFound</span>(item) =&gt; <span class="hljs-built_in">write!</span>(f, <span class="hljs-string">"未找到: {}"</span>, item),
        }
    }
}

<span class="hljs-comment">// 实现 Error trait</span>
<span class="hljs-keyword">impl</span> <span class="hljs-title class_">std</span>::error::Error <span class="hljs-keyword">for</span> <span class="hljs-title class_">AppError</span> {}

<span class="hljs-comment">// 实现 From trait 允许使用 ?</span>
<span class="hljs-keyword">impl</span> <span class="hljs-title class_">From</span>&lt;std::io::Error&gt; <span class="hljs-keyword">for</span> <span class="hljs-title class_">AppError</span> {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">from</span>(error: std::io::Error) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> {
        AppError::<span class="hljs-title function_ invoke__">IoError</span>(error)
    }
}

<span class="hljs-comment">// 使用自定义错误</span>
<span class="hljs-keyword">fn</span> <span class="hljs-title function_">load_config</span>(path: &amp;<span class="hljs-type">str</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;Config, AppError&gt; {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">content</span> = std::fs::<span class="hljs-title function_ invoke__">read_to_string</span>(path)?;  <span class="hljs-comment">// io::Error 自动转换</span>
    
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">config</span> = <span class="hljs-title function_ invoke__">parse_config</span>(&amp;content)
        .<span class="hljs-title function_ invoke__">map_err</span>(|e| AppError::<span class="hljs-title function_ invoke__">ParseError</span>(e))?;  <span class="hljs-comment">// 手动转换</span>
    
    <span class="hljs-title function_ invoke__">Ok</span>(config)
}
</code></pre>
<h3 data-id="heading-19">2. 使用 <code>thiserror</code> 和 <code>anyhow</code> crate</h3>
<p>在实际项目中，推荐使用这两个库：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">use</span> thiserror::Error;

<span class="hljs-meta">#[derive(Error, Debug)]</span>
<span class="hljs-keyword">enum</span> <span class="hljs-title class_">DataError</span> {
    <span class="hljs-meta">#[error(<span class="hljs-string">"文件未找到: {0}"</span>)]</span>
    <span class="hljs-title function_ invoke__">NotFound</span>(<span class="hljs-type">String</span>),
    
    <span class="hljs-meta">#[error(<span class="hljs-string">"解析失败: {0}"</span>)]</span>
    <span class="hljs-title function_ invoke__">ParseError</span>(<span class="hljs-type">String</span>),
    
    <span class="hljs-meta">#[error(<span class="hljs-string">"IO 错误"</span>)]</span>
    <span class="hljs-title function_ invoke__">IoError</span>(<span class="hljs-meta">#[from]</span> std::io::Error),
}

<span class="hljs-comment">// 使用 anyhow 快速处理错误</span>
<span class="hljs-keyword">use</span> anyhow::{<span class="hljs-type">Result</span>, Context};

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">process_data</span>(path: &amp;<span class="hljs-type">str</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;Data&gt; {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">content</span> = std::fs::<span class="hljs-title function_ invoke__">read_to_string</span>(path)
        .<span class="hljs-title function_ invoke__">context</span>(<span class="hljs-string">"无法读取数据文件"</span>)?;
    
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">data</span> = <span class="hljs-title function_ invoke__">parse_data</span>(&amp;content)
        .<span class="hljs-title function_ invoke__">context</span>(<span class="hljs-string">"数据格式不正确"</span>)?;
    
    <span class="hljs-title function_ invoke__">Ok</span>(data)
}
</code></pre>
<h3 data-id="heading-20">3. 何时使用何种错误处理</h3>



































<table><thead><tr><th>场景</th><th>使用</th><th>原因</th></tr></thead><tbody><tr><td>库代码</td><td><code>Result</code></td><td>让调用者决定如何处理</td></tr><tr><td>应用程序主逻辑</td><td><code>Result</code></td><td>简化错误传播</td></tr><tr><td>示例/测试代码</td><td><code>unwrap()</code>/<code>expect()</code></td><td>快速开发</td></tr><tr><td>值可能不存在</td><td><code>Option</code></td><td>不是错误，只是没有</td></tr><tr><td>逻辑错误</td><td><code>panic!</code></td><td>不应该发生</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-21">常见误区与陷阱</h2>
<h3 data-id="heading-22">❌ 误区 1：滥用 <code>unwrap()</code></h3>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// 不好 - 可能导致 panic</span>
<span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">file</span> = File::<span class="hljs-title function_ invoke__">open</span>(<span class="hljs-string">"config.txt"</span>).<span class="hljs-title function_ invoke__">unwrap</span>();
</code></pre>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// 好 - 优雅处理错误</span>
<span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">file</span> = File::<span class="hljs-title function_ invoke__">open</span>(<span class="hljs-string">"config.txt"</span>)
    .<span class="hljs-title function_ invoke__">map_err</span>(|e| {
        eprintln!(<span class="hljs-string">"无法打开配置文件: {}"</span>, e);
        std::process::<span class="hljs-title function_ invoke__">exit</span>(<span class="hljs-number">1</span>);
    })
    .<span class="hljs-title function_ invoke__">unwrap</span>();

<span class="hljs-comment">// 更好 - 返回 Result</span>
<span class="hljs-keyword">fn</span> <span class="hljs-title function_">load_config</span>() <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;Config, io::Error&gt; {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">file</span> = File::<span class="hljs-title function_ invoke__">open</span>(<span class="hljs-string">"config.txt"</span>)?;
    <span class="hljs-comment">// ...</span>
}
</code></pre>
<h3 data-id="heading-23">❌ 误区 2：忽略错误</h3>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// 不好 - 错误被忽略</span>
<span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">_</span> = std::fs::<span class="hljs-title function_ invoke__">remove_file</span>(<span class="hljs-string">"temp.txt"</span>);
</code></pre>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// 好 - 至少记录错误</span>
<span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">Err</span>(e) = std::fs::<span class="hljs-title function_ invoke__">remove_file</span>(<span class="hljs-string">"temp.txt"</span>) {
    eprintln!(<span class="hljs-string">"警告：无法删除临时文件: {}"</span>, e);
}
</code></pre>
<h3 data-id="heading-24">❌ 误区 3：过早使用 <code>?</code></h3>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// 不好 - 错误信息不明确</span>
<span class="hljs-keyword">fn</span> <span class="hljs-title function_">process</span>() <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;(), <span class="hljs-type">Box</span>&lt;<span class="hljs-keyword">dyn</span> Error&gt;&gt; {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">data</span> = <span class="hljs-title function_ invoke__">read_file</span>(<span class="hljs-string">"data.txt"</span>)?;  <span class="hljs-comment">// 哪里出错了？</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">parsed</span> = <span class="hljs-title function_ invoke__">parse_data</span>(&amp;data)?;    <span class="hljs-comment">// 还是这里？</span>
    <span class="hljs-title function_ invoke__">Ok</span>(())
}
</code></pre>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// 好 - 添加上下文</span>
<span class="hljs-keyword">fn</span> <span class="hljs-title function_">process</span>() <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;(), <span class="hljs-type">Box</span>&lt;<span class="hljs-keyword">dyn</span> Error&gt;&gt; {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">data</span> = <span class="hljs-title function_ invoke__">read_file</span>(<span class="hljs-string">"data.txt"</span>)
        .<span class="hljs-title function_ invoke__">context</span>(<span class="hljs-string">"读取数据文件失败"</span>)?;
    
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">parsed</span> = <span class="hljs-title function_ invoke__">parse_data</span>(&amp;data)
        .<span class="hljs-title function_ invoke__">context</span>(<span class="hljs-string">"解析数据失败"</span>)?;
    
    <span class="hljs-title function_ invoke__">Ok</span>(())
}
</code></pre>
<h3 data-id="heading-25">❌ 误区 4：混淆 <code>Option</code> 和 <code>Result</code></h3>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// 不好 - 用户不存在不是错误</span>
<span class="hljs-keyword">fn</span> <span class="hljs-title function_">find_user</span>(id: <span class="hljs-type">u32</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;User, <span class="hljs-type">String</span>&gt; {
    users.<span class="hljs-title function_ invoke__">get</span>(&amp;id)
        .<span class="hljs-title function_ invoke__">ok_or</span>(<span class="hljs-string">"用户不存在"</span>.<span class="hljs-title function_ invoke__">to_string</span>())
}
</code></pre>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// 好 - 使用 Option</span>
<span class="hljs-keyword">fn</span> <span class="hljs-title function_">find_user</span>(id: <span class="hljs-type">u32</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Option</span>&lt;User&gt; {
    users.<span class="hljs-title function_ invoke__">get</span>(&amp;id).<span class="hljs-title function_ invoke__">cloned</span>()
}

<span class="hljs-comment">// 如果确实需要错误信息</span>
<span class="hljs-keyword">fn</span> <span class="hljs-title function_">get_user</span>(id: <span class="hljs-type">u32</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;User, UserError&gt; {
    <span class="hljs-title function_ invoke__">find_user</span>(id)
        .<span class="hljs-title function_ invoke__">ok_or</span>(UserError::<span class="hljs-title function_ invoke__">NotFound</span>(id))
}
</code></pre>
<hr/>
<h2 data-id="heading-26">实战示例</h2>
<h3 data-id="heading-27">示例 1：读取并解析配置文件</h3>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">use</span> serde::Deserialize;
<span class="hljs-keyword">use</span> std::fs;

<span class="hljs-meta">#[derive(Deserialize)]</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Config</span> {
    host: <span class="hljs-type">String</span>,
    port: <span class="hljs-type">u16</span>,
}

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">load_config</span>(path: &amp;<span class="hljs-type">str</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;Config, <span class="hljs-type">Box</span>&lt;<span class="hljs-keyword">dyn</span> std::error::Error&gt;&gt; {
    <span class="hljs-comment">// 读取文件</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">content</span> = fs::<span class="hljs-title function_ invoke__">read_to_string</span>(path)
        .<span class="hljs-title function_ invoke__">map_err</span>(|e| <span class="hljs-built_in">format!</span>(<span class="hljs-string">"无法读取配置文件 {}: {}"</span>, path, e))?;
    
    <span class="hljs-comment">// 解析 JSON</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">config</span>: Config = serde_json::<span class="hljs-title function_ invoke__">from_str</span>(&amp;content)
        .<span class="hljs-title function_ invoke__">map_err</span>(|e| <span class="hljs-built_in">format!</span>(<span class="hljs-string">"配置文件格式错误: {}"</span>, e))?;
    
    <span class="hljs-comment">// 验证配置</span>
    <span class="hljs-keyword">if</span> config.port == <span class="hljs-number">0</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">Err</span>(<span class="hljs-string">"端口号不能为 0"</span>.<span class="hljs-title function_ invoke__">into</span>());
    }
    
    <span class="hljs-title function_ invoke__">Ok</span>(config)
}

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-keyword">match</span> <span class="hljs-title function_ invoke__">load_config</span>(<span class="hljs-string">"config.json"</span>) {
        <span class="hljs-title function_ invoke__">Ok</span>(config) =&gt; {
            <span class="hljs-built_in">println!</span>(<span class="hljs-string">"服务器配置: {}:{}"</span>, config.host, config.port);
        }
        <span class="hljs-title function_ invoke__">Err</span>(e) =&gt; {
            eprintln!(<span class="hljs-string">"错误: {}"</span>, e);
            std::process::<span class="hljs-title function_ invoke__">exit</span>(<span class="hljs-number">1</span>);
        }
    }
}
</code></pre>
<h3 data-id="heading-28">示例 2：处理多个可能失败的操作</h3>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">use</span> std::io;

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">process_data</span>(input: &amp;<span class="hljs-type">str</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;<span class="hljs-type">i32</span>, <span class="hljs-type">String</span>&gt; {
    <span class="hljs-comment">// 步骤 1: 去除空白</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">trimmed</span> = input.<span class="hljs-title function_ invoke__">trim</span>();
    <span class="hljs-keyword">if</span> trimmed.<span class="hljs-title function_ invoke__">is_empty</span>() {
        <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">Err</span>(<span class="hljs-string">"输入不能为空"</span>.<span class="hljs-title function_ invoke__">to_string</span>());
    }
    
    <span class="hljs-comment">// 步骤 2: 解析数字</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">number</span>: <span class="hljs-type">i32</span> = trimmed
        .<span class="hljs-title function_ invoke__">parse</span>()
        .<span class="hljs-title function_ invoke__">map_err</span>(|_| <span class="hljs-built_in">format!</span>(<span class="hljs-string">"'{}' 不是有效的数字"</span>, trimmed))?;
    
    <span class="hljs-comment">// 步骤 3: 验证范围</span>
    <span class="hljs-keyword">if</span> number &lt; <span class="hljs-number">0</span> || number &gt; <span class="hljs-number">100</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">Err</span>(<span class="hljs-built_in">format!</span>(<span class="hljs-string">"数字 {} 超出范围 [0, 100]"</span>, number));
    }
    
    <span class="hljs-comment">// 步骤 4: 处理</span>
    <span class="hljs-title function_ invoke__">Ok</span>(number * <span class="hljs-number">2</span>)
}

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">inputs</span> = <span class="hljs-built_in">vec!</span>[<span class="hljs-string">"42"</span>, <span class="hljs-string">"  50  "</span>, <span class="hljs-string">"abc"</span>, <span class="hljs-string">"150"</span>, <span class="hljs-string">""</span>];
    
    <span class="hljs-keyword">for</span> <span class="hljs-variable">input</span> <span class="hljs-keyword">in</span> inputs {
        <span class="hljs-keyword">match</span> <span class="hljs-title function_ invoke__">process_data</span>(input) {
            <span class="hljs-title function_ invoke__">Ok</span>(result) =&gt; <span class="hljs-built_in">println!</span>(<span class="hljs-string">"'{}' -&gt; {}"</span>, input, result),
            <span class="hljs-title function_ invoke__">Err</span>(e) =&gt; eprintln!(<span class="hljs-string">"错误: {}"</span>, e),
        }
    }
}
</code></pre>
<h3 data-id="heading-29">示例 3：组合 Option 和 Result</h3>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Database</span> {
    users: <span class="hljs-type">Vec</span>&lt;User&gt;,
}

<span class="hljs-keyword">struct</span> <span class="hljs-title class_">User</span> {
    id: <span class="hljs-type">u32</span>,
    name: <span class="hljs-type">String</span>,
    email: <span class="hljs-type">Option</span>&lt;<span class="hljs-type">String</span>&gt;,  <span class="hljs-comment">// 邮箱可能不存在</span>
}

<span class="hljs-keyword">impl</span> <span class="hljs-title class_">Database</span> {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">find_user</span>(&amp;<span class="hljs-keyword">self</span>, id: <span class="hljs-type">u32</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Option</span>&lt;&amp;User&gt; {
        <span class="hljs-keyword">self</span>.users.<span class="hljs-title function_ invoke__">iter</span>().<span class="hljs-title function_ invoke__">find</span>(|u| u.id == id)
    }
    
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">get_user_email</span>(&amp;<span class="hljs-keyword">self</span>, id: <span class="hljs-type">u32</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;<span class="hljs-type">String</span>, <span class="hljs-type">String</span>&gt; {
        <span class="hljs-comment">// 先查找用户</span>
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">user</span> = <span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">find_user</span>(id)
            .<span class="hljs-title function_ invoke__">ok_or_else</span>(|| <span class="hljs-built_in">format!</span>(<span class="hljs-string">"用户 {} 不存在"</span>, id))?;
        
        <span class="hljs-comment">// 再获取邮箱</span>
        user.email.<span class="hljs-title function_ invoke__">clone</span>()
            .<span class="hljs-title function_ invoke__">ok_or_else</span>(|| <span class="hljs-built_in">format!</span>(<span class="hljs-string">"用户 {} 没有设置邮箱"</span>, id))
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-30">总结</h2>
<h3 data-id="heading-31">核心要点</h3>
<ol>
<li><strong>Result 和 Option 是你的朋友</strong> - 拥抱它们，不要逃避</li>
<li><strong><code>?</code> 操作符是神器</strong> - 让错误传播变得优雅</li>
<li><strong>少用 unwrap()</strong> - 除非你真的确定不会失败</li>
<li><strong>选择合适的错误类型</strong> - Option vs Result vs panic!</li>
<li><strong>添加错误上下文</strong> - 帮助未来的自己调试</li>
<li><strong>使用社区工具</strong> - thiserror 和 anyhow 很香</li>
</ol>
<h3 data-id="heading-32">学习路径</h3>
<ol>
<li><strong>初级：</strong> 熟练使用 <code>match</code>、<code>unwrap</code>、<code>expect</code></li>
<li><strong>中级：</strong> 掌握 <code>?</code> 操作符和 <code>Option</code>/<code>Result</code> 的方法</li>
<li><strong>高级：</strong> 创建自定义错误类型，使用 thiserror/anyhow</li>
<li><strong>专家：</strong> 理解错误转换、trait objects、错误传播的最佳实践</li>
</ol>
<h3 data-id="heading-33">推荐资源</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdoc.rust-lang.org%2Fbook%2Fch09-00-error-handling.html" title="https://doc.rust-lang.org/book/ch09-00-error-handling.html" target="_blank" ref="nofollow noopener noreferrer">Rust Book - Error Handling</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdoc.rust-lang.org%2Frust-by-example%2Ferror.html" title="https://doc.rust-lang.org/rust-by-example/error.html" target="_blank" ref="nofollow noopener noreferrer">Rust by Example - Error Handling</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.rs%2Fthiserror%2F" title="https://docs.rs/thiserror/" target="_blank" ref="nofollow noopener noreferrer">thiserror crate</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.rs%2Fanyhow%2F" title="https://docs.rs/anyhow/" target="_blank" ref="nofollow noopener noreferrer">anyhow crate</a></li>
</ul>
<hr/>
<p>记住：<strong>在 Rust 中，处理错误不是负担，而是让你的代码更健壮的机会！</strong> 🦀✨</p>
<p>Happy Coding! 🎉</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SDD 规范驱动开发 AI 编程简单实践后，我找到了它的使用场景]]></title>    <link>https://juejin.cn/post/7588124225703034920</link>    <guid>https://juejin.cn/post/7588124225703034920</guid>    <pubDate>2025-12-28T14:03:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588124225703034920" data-draft-id="7588093282530476084" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="SDD 规范驱动开发 AI 编程简单实践后，我找到了它的使用场景"/> <meta itemprop="keywords" content="AI编程"/> <meta itemprop="datePublished" content="2025-12-28T14:03:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="陈佬昔编程人生"/> <meta itemprop="url" content="https://juejin.cn/user/3087084378402445"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            SDD 规范驱动开发 AI 编程简单实践后，我找到了它的使用场景
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3087084378402445/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    陈佬昔编程人生
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-28T14:03:38.000Z" title="Sun Dec 28 2025 14:03:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">什么是 SDD 规范驱动开发？</h2>
<p>SDD（Specification-Driven Development ）规范驱动开发，看名字虽然高大上，但其实就是很多互联网公司一直在运行的工作流程，先明确需求，形成规范文档，然后开发根据文档来设计和开发，测试根据文档来写测试用例。</p>
<p>SDD 其强调了需求文档的重要性，所有的后继任务都需要跟需求文档对齐。</p>
<p>重提SDD，是因为现在的大语言模型 AI 编程，同样也出现了需求不明确，带来了结果不符合预期的问题。</p>
<h2 data-id="heading-1">规范驱动开发尝鲜工具：Kiro / Comate</h2>
<p>如果想快速尝试一下，可以使用亚马逊推出的 AI 编程IDE Kiro 实现，他自身就带了 Spec 开发。国内的百度 Comate 也有跟进，也可看看是否可以白嫖。</p>
<p>安装之后，主界面区分了 Vibe 和 Spec 两种开发模式。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/45f8b514fe1847df932cd0792225e4be~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZmI5L2s5piU57yW56iL5Lq655Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767535487&amp;x-signature=RXTk%2FCd3haw%2FWeT%2B4Y6Ve1Bigqs%3D" alt="2025 SDD 规范驱动开发 AI 编码工具介绍.png" loading="lazy"/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8d364bde94434b34bd13aa8581a59ea1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZmI5L2s5piU57yW56iL5Lq655Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767535487&amp;x-signature=6Vt%2ByNMbNbaKuykLH%2ByCqqmfEj8%3D" alt="2025 SDD 规范驱动开发 AI 编码工具介绍-comate.png" loading="lazy"/></p>
<p>Comate 的 Spec Mode，目前还是 Beta 阶段。</p>
<h3 data-id="heading-2">需求澄清</h3>
<p>使用方法很简单，切换到 Spec Mode 之后，输入需求即可。</p>
<p>稍等片刻，AI 就会提供一份需求文档。</p>
<p>它拆分需求非常详细，算是优秀的需求文档了。但是这个文档也不是纯粹的自然语言，验收标准里面有一些条件语句：WHEN、THEN、SHALL 等等，是用来强制对齐验收结果的。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b0eab8dceabc40a88193f024d2976d2a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZmI5L2s5piU57yW56iL5Lq655Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767535487&amp;x-signature=bKXJ5VrhH4UFnY%2Bk97yphsiS5YI%3D" alt="2025 SDD 规范驱动开发 AI 编码工具介绍-需求文档-1.png" loading="lazy"/></p>
<h3 data-id="heading-3">详细设计与拆分任务</h3>
<p>上文图中看到，需求文档几乎没有任何技术相关的内容。</p>
<p>需求澄清完成之后，确认进入下一步设计。这时候才会出现很多技术选型需要做的内容。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/41e4a288976b4969b80273a8e4c0bb0b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZmI5L2s5piU57yW56iL5Lq655Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767535487&amp;x-signature=onQusDbo%2BmAC3VJTir55B1IGVYs%3D" alt="2025 SDD 规范驱动开发 AI 编码工具介绍-详细设计-1.png" loading="lazy"/>
设计也没问题，那就来到最后一步，AI会生成详细的执行清单。</p>
<p>Kiro厉害的地方在于可以单独选择任意一个任务执行。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f0992ed11dc0425daf9c29ca57bc36e9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZmI5L2s5piU57yW56iL5Lq655Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767535487&amp;x-signature=QqVgS8xQY2Msxy1bAXndbCnczYU%3D" alt="2025 SDD 规范驱动开发 AI 编码工具介绍-详细设计.png" loading="lazy"/></p>
<h2 data-id="heading-4">Spec Mode 与 Plan Agent 的不同</h2>
<h3 data-id="heading-5">文档定义不同</h3>
<p>上次测试了各大组件 IDE 的 Plan Agent。</p>
<p>这些 IDE 都有 Plan Agent，但是并没有完整的需求文档书写的过程，写出来的文档更多是设计文档和执行任务的结合体。</p>
<p><a href="https://juejin.cn/post/7587596841874276386" target="_blank" title="https://juejin.cn/post/7587596841874276386">国产AI编程IDE的Plan模式，对比Cursor差别在哪？</a></p>
<p>Kiro里面的设计文档有很多流程图、类型定义、数据库实例等内容，真的像一个高级程序员在动手前写的详细设计文档，看了都想点个赞。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5884416e8e9f4f85a01a4f8a8ac65350~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZmI5L2s5piU57yW56iL5Lq655Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767535487&amp;x-signature=ypjHHeo%2FJYx7QFapA6A1r%2BI28Ck%3D" alt="kiro-详细设计.png" loading="lazy"/></p>
<p>即使是上次测试文档能力最强的 CodeBuddy 生成的内容，数据库等都是寥寥几句，写的很概要，在对比之下就显得业余很多了。</p>
<h3 data-id="heading-6">任务与文档关联性</h3>
<p>上次的测试中发现，除了 Cursor 之外，其他 IDE 的最后拆分的任务，和开发计划写好的内容关联比较弱，出现两者不一致的情况反而是常态。开发过程中，每一步都有偏差，那最后产出就很难如你期望的那样了。</p>
<p>但在上文图中可以看到，Kiro 的设计文档和任务列表中，都明确标记了具体关联的需求，三个文档关联性是很强的。</p>
<h3 data-id="heading-7">任务拆分合理性</h3>
<p>Plan Agent 常常会因为上下文过长，导致中断。</p>
<p>相对而言，SDD 拆分任务之后，不少任务都是可以独立执行的，如果当前任务有前置任务，在前置任务执行之前，当前任务是无法执行的。用户也可以选择单次执行1个或多个任务。</p>
<p>所以，流程变得可控了。即使如遇到中断，对整体影响更小。</p>
<h2 data-id="heading-8">什么时候使用 SDD？</h2>
<p>回答这个问题之前，先明确一个事情：Spec Mode无法提升大模型本身的能力。而是让在其约束下的大模型生成的内容，更符合我们的需求。比如：如果大模型本身处理后端数据库的能力不行，通过 Spec Mode 也无法获得好的数据库设计。</p>
<p>目前来说，<strong>对程序员而言，如果你需要详细设计，那就需要SDD。</strong> 所以，一般的小需求用 Plan Agent 或者直接生成，复杂的需求使用 Spec Mode 开发。</p>
<p>另外，如果仅仅是前端开发的项目，大部分时候不需要使用 SDD。</p>
<p>这是因为前端技术通常更侧重于交互和视觉效果，许多需求可以通过组件库或现成框架快速实现，而数据会通过后端 API 约束。唯一涉及的时候，可能就是状态管理了。</p>
<p>同样，在目前大公司成熟的开发团队中，也不太可能频繁用到 SDD。</p>
<p>这些团队往往成员之间分工明确，需求到达程序员手里是，已经不需要澄清需求了，还有很多业务也趋于稳定了，不常常需要更改数据库设计等核心内容。</p>
<p>但是，要提醒的是：<strong>如果 AI 编程发展顺利，很多程序员会承担一定的产品的角色</strong>。如果真的如此，SDD 工具能帮你来快速适应角色的转换，更好地产出符合需求的产品。</p>
<p>因此，了解 SDD 还是很有必要的。</p>
<h2 data-id="heading-9">更通用的方案 </h2>
<p>Kiro 和 Comate 这种把 Spec Mode 融入了 IDE，好是好，但是如果不用这两个 IDE ，有没有类似的方法执行 SDD？</p>
<p>有的，目前正在尝试 3个开源工具：</p>
<ul>
<li>
<p>spec-kit：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fgithub%2Fspec-kit" target="_blank" title="https://github.com/github/spec-kit" ref="nofollow noopener noreferrer">github.com/github/spec…</a></p>
</li>
<li>
<p>OpenSpec：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FFission-AI%2FOpenSpec" target="_blank" title="https://github.com/Fission-AI/OpenSpec" ref="nofollow noopener noreferrer">github.com/Fission-AI/…</a></p>
</li>
<li>
<p>BMAD-METHOD：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fbmad-code-org%2FBMAD-METHOD" target="_blank" title="https://github.com/bmad-code-org/BMAD-METHOD" ref="nofollow noopener noreferrer">github.com/bmad-code-o…</a></p>
</li>
</ul>
<p>感兴趣的，可以一起研究下。</p>
<p>相关的测试内容，后续会继续在此号发布。欢迎关注。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[MiniMax M2 Coding Plan + Claude Code：打造你的低成本高效率AI编程搭档]]></title>    <link>https://juejin.cn/post/7588300640599949318</link>    <guid>https://juejin.cn/post/7588300640599949318</guid>    <pubDate>2025-12-28T14:08:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588300640599949318" data-draft-id="7588191506607472646" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="MiniMax M2 Coding Plan + Claude Code：打造你的低成本高效率AI编程搭档"/> <meta itemprop="keywords" content="Claude,AI编程"/> <meta itemprop="datePublished" content="2025-12-28T14:08:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="土豆1250"/> <meta itemprop="url" content="https://juejin.cn/user/3280598428302727"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            MiniMax M2 Coding Plan + Claude Code：打造你的低成本高效率AI编程搭档
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3280598428302727/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    土豆1250
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-28T14:08:07.000Z" title="Sun Dec 28 2025 14:08:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    12
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是<a href="https://juejin.cn/user/3280598428302727" target="_blank" title="https://juejin.cn/user/3280598428302727">土豆</a>，欢迎关注我的<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FCRh8a5UMmc_JXkHfL1meBA" target="_blank" title="https://mp.weixin.qq.com/s/CRh8a5UMmc_JXkHfL1meBA" ref="nofollow noopener noreferrer">公众号：土豆学前端</a></p>
<blockquote>
<p>"人均Claude Code"的时代，真的来了。</p>
</blockquote>
<h2 data-id="heading-0">一、为什么我们需要重新审视AI编程工具的选择？</h2>
<h3 data-id="heading-1">1.1 当"贵"成为常态</h3>
<p>想象一个场景：你是一名独立开发者，或者刚创业的CTO，每天要和代码打交道。某天你打开账单，发现本月给Anthropic的API费用已经抵得上一台iPhone——而这已经是连续第三个月了。</p>
<p>这不是个例。</p>
<p>2025年，AI大模型的API定价似乎陷入了一种"军备竞赛"：OpenAI的GPT-4o每百万Token收费约<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>10</mn><mtext>，</mtext><mi>C</mi><mi>l</mi><mi>a</mi><mi>u</mi><mi>d</mi><mi>e</mi><mi>O</mi><mi>p</mi><mi>u</mi><mi>s</mi><mn>4</mn><mtext>更是高达</mtext></mrow><annotation encoding="application/x-tex">10，Claude Opus 4更是高达</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord">10</span><span class="mord cjk_fallback">，</span><span class="mord mathnormal" style="margin-right:0.01968em;">Cl</span><span class="mord mathnormal">a</span><span class="mord mathnormal">u</span><span class="mord mathnormal">d</span><span class="mord mathnormal">e</span><span class="mord mathnormal">Op</span><span class="mord mathnormal">u</span><span class="mord mathnormal">s</span><span class="mord">4</span><span class="mord cjk_fallback">更是高达</span></span></span></span></span>15输出。更离谱的是某些"顶级模型"，输入价格都能飙到每百万Token 9元人民币——这意味着你写一个稍微复杂点的需求，几十块就没了。</p>
<p>对于个人开发者来说，这相当于每月固定支出一笔"智商税"；对于初创团队而言，这意味着AI辅助开发从"锦上添花"变成了"沉重的甜蜜负担"。</p>
<h3 data-id="heading-2">1.2 开源模型的逆袭</h3>
<p>但故事在2025年10月27日迎来了转折。</p>
<p>那天，一家叫MiniMax的中国AI公司开源了一个模型，名叫M2。这个模型有多猛呢？</p>
<ul>
<li><strong>全球排名第五</strong>——在Artificial Analysis榜单上，超越了绝大多数闭源模型</li>
<li><strong>开源模型第一</strong>——在LMArena WebDev榜单上傲视群雄</li>
<li><strong>价格只有Claude的8%</strong>——对，你没看错，是八个百分点</li>
<li><strong>速度提升约2倍</strong>——响应快到让你怀疑人生</li>
</ul>
<p>更要命的是，它不仅开源，而且专门为<strong>编程和Agent工作流</strong>而生。</p>
<p>这就好比有人告诉你："嘿，隔壁五星级大厨的菜确实好吃，但我这有道家常菜，味道差不多，价格只有他的十分之一，还管饱。"</p>
<p>你动不动心？</p>
<hr/>
<h2 data-id="heading-3">二、MiniMax M2 到底是什么来头？</h2>
<h3 data-id="heading-4">2.1 一个"精简"但"凶猛"的模型</h3>
<p>先看一组硬核数据：</p>

























<table><thead><tr><th>参数项</th><th>数值</th></tr></thead><tbody><tr><td>总参数量</td><td>2300亿（230B）</td></tr><tr><td>激活参数</td><td>100亿（10B）</td></tr><tr><td>上下文窗口</td><td>204,800 Token</td></tr><tr><td>最大输出</td><td>131,072 Token</td></tr></tbody></table>
<p>等等，2300亿总参数，但只激活100亿？这听起来像是——</p>
<blockquote>
<p>"我买了一栋楼，但只住其中一间房。"</p>
</blockquote>
<p>但别急着笑。这种<strong>混合专家（MoE）架构</strong>恰恰是当前性价比最高的方案。模型在推理时只"点亮"需要的部分神经元，既保证了性能，又大幅降低了计算成本。</p>
<p>用游戏来类比就是：你的电脑显卡很一般，但游戏会自动检测配置，该开高画质的地方开高，该省的地方省，最终体验居然和顶级配置差不多。</p>
<h3 data-id="heading-5">2.2 它到底有多强？</h3>
<p>光看数字是虚的，我们来看看实际表现：</p>
<p><strong>编程能力方面：</strong></p>
<ul>
<li>LiveCodeBench V6：开源SOTA，超越Claude Sonnet 4.5</li>
<li>SWE-bench Verified：国产第一</li>
<li>LMArena Code Arena：开源第一、国产第一</li>
</ul>
<p><strong>通用能力方面：</strong></p>
<ul>
<li>数学竞赛题（AIME 2025）：开源SOTA</li>
<li>接近GPT-5.1级别的推理能力</li>
</ul>
<p><strong>Agent能力方面：</strong></p>
<ul>
<li>BrowseComp网页任务：67分</li>
<li>τ²-Bench真实世界交互：开源SOTA</li>
</ul>
<p>用一位海外开发者的话说：<strong>"MiniMax M2不仅仅是个编程模型，它简直是个能独立完成任务的实习生——而且这个实习生永不疲倦，不要五险一金，随叫随到。"</strong></p>
<h3 data-id="heading-6">2.3 Interleaved Thinking：让AI学会"边想边做"</h3>
<p>M2还有一个独门秘籍：<strong>Interleaved Thinking（交错思维）</strong>。</p>
<p>传统AI模型的处理模式是这样的：用户输入 → 模型思考 → 输出结果 → 结束。</p>
<p>但现实中的编程任务往往是复杂的、多步骤的，比如：</p>
<ol>
<li>先读取配置文件</li>
<li>根据配置修改代码</li>
<li>运行测试</li>
<li>根据报错继续修改</li>
<li>再次测试……</li>
</ol>
<p>交错思维让模型可以在处理任务时<strong>交替进行推理、计划和执行</strong>，就像一个经验丰富的程序员——他不会闷头写代码写一半才发现架构有问题，而是边写边想，边想边调整。</p>
<p>官方表示，正确使用这个特性，模型效果最多可以<strong>提升35%</strong>。</p>
<hr/>
<h2 data-id="heading-7">三、为什么说Coding Plan是"神助攻"？</h2>
<h3 data-id="heading-8">3.1 价格有多香？</h3>
<p>先来感受一下MiniMax M2 Coding Plan的定价：</p>

























<table><thead><tr><th>套餐类型</th><th>价格</th><th>权益</th></tr></thead><tbody><tr><td>Starter（新手）</td><td>首月 9.9 元</td><td>包月不限速</td></tr><tr><td>Pro（进阶）</td><td>更优惠</td><td>更多调用量</td></tr><tr><td>企业版</td><td>定制</td><td>团队协作</td></tr></tbody></table>
<p>9.9元是什么概念？</p>
<ul>
<li>一杯瑞幸咖啡</li>
<li>两顿早餐</li>
<li>一次共享单车月卡</li>
</ul>
<p>但这意味着你可以<strong>一个月无限制使用全球排名前五的编程模型</strong>。</p>
<p>作为对比，Claude Pro的订阅费是每月$20（约150元人民币），而且超出使用量还要额外付费。MiniMax这波，属实是把价格打到了"地板价"。</p>
<h3 data-id="heading-9">3.2 不是"便宜货"，是"真香货"</h3>
<p>便宜没好货？这句话在AI领域可能要被打破了。</p>
<p>Coding Plan不仅价格香，权益也相当到位：</p>
<ul>
<li><strong>API兼容OpenAI/Anthropic</strong>：意味着你可以无缝对接现有工具</li>
<li><strong>支持Claude Code、Cursor等主流IDE</strong>：不用重新学习新工具</li>
<li><strong>高速通道</strong>：不限速，响应快人一步</li>
<li><strong>思考模式可切换</strong>：复杂任务开思考，简单任务省Token</li>
<li><strong>视觉理解能力</strong>：可以直接解析截图、设计稿、报错截图</li>
</ul>
<p>有开发者实测："同样的一个需求，用Claude Sonnet要跑两轮才能跑通，用MiniMax M2一遍过，而且响应速度快了近一倍。"</p>
<hr/>
<h2 data-id="heading-10">四、手把手教程：如何把MiniMax M2接入Claude Code？</h2>
<p>终于到了大家最关心的实操环节。</p>
<p>好消息是：整个过程只需要修改一个配置文件，5分钟搞定。</p>
<h3 data-id="heading-11">4.1 准备工作</h3>
<p>在开始之前，你需要：</p>
<ol>
<li><strong>注册MiniMax账号</strong>：访问 <a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.minimaxi.com" target="_blank" title="https://platform.minimaxi.com" ref="nofollow noopener noreferrer">MiniMax开放平台</a></li>
<li><strong>获取API Key</strong>：
<ul>
<li>登录后进入「账户管理」→「接口密钥」</li>
<li>点击「创建新的密钥」</li>
<li><strong>务必复制并保存</strong>——这个密钥只会显示一次！</li>
</ul>
</li>
</ol>
<h3 data-id="heading-12">4.2 修改Claude Code配置</h3>
<p>找到你的Claude Code配置文件 <code>settings.json</code>。通常位于当前用户目录下的 <code>.claude</code> 目录下：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># Windows</span>
%USERPROFILE%\.claude\settings.json

<span class="hljs-comment"># macOS/Linux</span>
~/.claude/settings.json
</code></pre>
<p>用文本编辑器打开，添加或修改以下配置：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"env"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"ANTHROPIC_BASE_URL"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://api.minimaxi.com/anthropic"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"ANTHROPIC_AUTH_TOKEN"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"your-api-key-here"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"ANTHROPIC_MODEL"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"MiniMax-M2"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"ANTHROPIC_DEFAULT_SONNET_MODEL"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"MiniMax-M2"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"ANTHROPIC_DEFAULT_OPUS_MODEL"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"MiniMax-M2"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"ANTHROPIC_DEFAULT_HAIKU_MODEL"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"MiniMax-M2"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"ANTHROPIC_SMALL_FAST_MODEL"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"MiniMax-M2"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>关键配置说明：</strong></p>






























<table><thead><tr><th>配置项</th><th>值</th><th>说明</th></tr></thead><tbody><tr><td><code>ANTHROPIC_BASE_URL</code></td><td><code>https://api.minimaxi.com/anthropic</code></td><td>MiniMax的Anthropic兼容API端点（注意是 <code>/anthropic</code> 不是 <code>/v1</code>）</td></tr><tr><td><code>ANTHROPIC_AUTH_TOKEN</code></td><td>你的API Key</td><td>在MiniMax平台创建的密钥</td></tr><tr><td><code>ANTHROPIC_MODEL</code></td><td><code>MiniMax-M2</code></td><td>默认使用的模型</td></tr><tr><td><code>ANTHROPIC_DEFAULT_*_MODEL</code></td><td><code>MiniMax-M2</code></td><td>覆盖Claude的所有默认模型为MiniMax-M2</td></tr></tbody></table>
<h3 data-id="heading-13">4.3 验证是否配置成功</h3>
<p>打开终端，输入：</p>
<pre><code class="hljs language-bash" lang="bash">claude
</code></pre>
<p>然后尝试让它帮你写一段代码：</p>
<pre><code class="hljs">请用React写一个todo list组件
</code></pre>
<p>如果它正常响应，恭喜你——你已经成功接入了MiniMax M2！</p>
<h3 data-id="heading-14">4.4 进阶配置：开启深度思考模式</h3>
<p>如果你想让模型在处理复杂任务时更聪明，可以在对话中<strong>自然地要求它"想一想"</strong>。Claude Code 的思考模式是通过自然语言触发的，而不是 slash 命令。</p>
<p><strong>使用方法：</strong></p>
<p>在对话中直接告诉模型要"想一想"，强度递增：</p>






























<table><thead><tr><th>触发词</th><th>思考深度</th><th>适用场景</th></tr></thead><tbody><tr><td><code>think</code></td><td>标准思考</td><td>需要一定推理的普通任务</td></tr><tr><td><code>think hard</code></td><td>深度思考</td><td>较复杂的问题、需要多步推理</td></tr><tr><td><code>think harder</code></td><td>更深度思考</td><td>复杂架构设计、疑难Bug排查</td></tr><tr><td><code>think hardest</code></td><td>最深度思考</td><td>超复杂任务、系统级设计</td></tr></tbody></table>
<p><strong>示例：</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">think:</span> <span class="hljs-string">设计一个高并发的消息队列系统，需要考虑哪些关键点？</span>
<span class="hljs-attr">think hard:</span> <span class="hljs-string">这个API的性能瓶颈在哪里？帮我分析并优化</span>
<span class="hljs-attr">think hardest:</span> <span class="hljs-string">为我们的微服务架构设计完整的领域驱动模型</span>
</code></pre>
<p><strong>对比说明：</strong></p>
<ul>
<li>普通模式：模型直接给出答案，速度快</li>
<li>思考模式：模型会先在内部进行更深入的推理分析，然后给出更周全的答案</li>
</ul>
<p>对于 MiniMax M2 的 Interleaved Thinking 特性，模型会自动在推理、计划和执行之间交替，帮你更好地完成复杂任务。</p>
<hr/>
<h2 data-id="heading-15">五、实战场景：MiniMax M2到底能做什么？</h2>
<h3 data-id="heading-16">5.1 场景一：日常CRUD开发</h3>
<p>"帮我写一个用户登录的API，包含手机号验证和JWT token生成。"</p>
<p>M2的响应：</p>
<ul>
<li>快速生成符合最佳实践的代码</li>
<li>自动处理参数校验</li>
<li>附带单元测试示例</li>
<li>考虑边界情况（空值、格式错误等）</li>
</ul>
<h3 data-id="heading-17">5.2 场景二：Bug修复</h3>
<p>"这个报错是什么意思：[粘贴报错信息]"</p>
<p>M2能：</p>
<ul>
<li>准确解读报错信息</li>
<li>定位问题代码位置</li>
<li>提供修复方案</li>
<li>解释为什么会出现这个错误</li>
</ul>
<h3 data-id="heading-18">5.3 场景三：代码重构</h3>
<p>"这段代码太冗长了，帮我用更现代的写法重写，并解释改动点。"</p>
<p>M2擅长：</p>
<ul>
<li>识别代码异味（Code Smell）</li>
<li>提供更优雅的实现方式</li>
<li>解释重构前后的差异</li>
<li>保持功能不变</li>
</ul>
<h3 data-id="heading-19">5.4 场景四：技术调研</h3>
<p>"React 19的并发渲染是什么原理？和Vue的响应式系统相比有什么优劣？"</p>
<p>M2不仅能回答问题，还能：</p>
<ul>
<li>提供代码示例</li>
<li>对比优缺点</li>
<li>给出实际应用场景建议</li>
<li>推荐学习资源</li>
</ul>
<hr/>
<h2 data-id="heading-20">六、避坑指南：这些细节要注意</h2>
<h3 data-id="heading-21">6.1 关于价格</h3>
<p>虽然Coding Plan很便宜，但还是要<strong>注意用量</strong>：</p>
<ul>
<li>9.9元是首月优惠，后续价格可能调整</li>
<li>企业级使用建议评估实际消耗后再决定套餐</li>
<li>可以设置API调用预算告警</li>
</ul>
<h3 data-id="heading-22">6.2 关于模型特性</h3>
<p>MiniMax M2的<strong>强项是编程和Agent任务</strong>，但如果你需要：</p>
<ul>
<li>极致的创意写作 → 可能有更好的选择</li>
<li>超长文本理解 → 20万Token上下文已经很强，但部分场景仍有限制</li>
<li>实时语音对话 → 这是另一个产品线</li>
</ul>
<h3 data-id="heading-23">6.3 关于兼容性</h3>
<p>MiniMax M2兼容Anthropic API格式，这意味着：</p>
<ul>
<li>✅ Claude Code ✅ Cursor ✅ Cline ✅ OpenCode ✅ Roo Code</li>
<li>❌ 部分需要Claude特定API特性的工具可能不完全兼容</li>
</ul>
<h3 data-id="heading-24">6.4 关于Base URL</h3>
<p><strong>重要</strong>：Base URL 必须是 <code>https://api.minimaxi.com/anthropic</code>，而不是：</p>
<ul>
<li>❌ <code>https://api.minimaxi.com/v1</code>（这是OpenAI兼容格式）</li>
<li>❌ <code>https://api.minimaxi.com</code>（缺少路径）</li>
</ul>
<h3 data-id="heading-25">6.5 关于Region</h3>
<ul>
<li>国内用户推荐使用MiniMax官方API</li>
<li>网络延迟会影响响应速度，建议根据所在地选择最优节点</li>
</ul>
<hr/>
<h2 data-id="heading-26">七、总结：为什么这是一个值得尝试的组合？</h2>
<p>回顾一下这篇文章的核心观点：</p>
<ol>
<li><strong>成本大幅降低</strong>：9.9元/月 vs $20+/月，价格差了一个数量级</li>
<li><strong>性能不打折扣</strong>：全球排名前五的编程能力，足够应对绝大多数开发场景</li>
<li><strong>接入零成本</strong>：只需改一个配置文件，不用学习新工具</li>
<li><strong>生态兼容好</strong>：支持主流编程工具，工具链完善</li>
<li><strong>持续进化中</strong>：M2.1已经推出，能力还在不断增强</li>
</ol>
<p>用一句话总结就是：</p>
<blockquote>
<p><strong>"用喝咖啡的钱，获得一个7x24小时在线、从不摸鱼、任劳任怨的编程助手。"</strong></p>
</blockquote>
<p>当然，没有完美的工具。MiniMax M2在某些特定场景下可能不如Claude Opus 4，但对于90%的开发者来说，它的性价比是无可匹敌的。</p>
<p>如果你正在寻找一个低成本、高效率的AI编程搭档，不妨从今天开始，试着把MiniMax M2接入你的工作流。</p>
<p><strong>你会发现，省下来的钱和时间，比你想象的要多得多。</strong></p>
<hr/>
<h2 data-id="heading-27">附录：快速参考链接</h2>

























<table><thead><tr><th>资源</th><th>链接</th></tr></thead><tbody><tr><td>MiniMax开放平台</td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.minimaxi.com" target="_blank" title="https://platform.minimaxi.com" ref="nofollow noopener noreferrer">platform.minimaxi.com</a></td></tr><tr><td>MiniMax API文档</td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.minimaxi.com%2Fdocs%2Fguides%2Fquickstart" target="_blank" title="https://platform.minimaxi.com/docs/guides/quickstart" ref="nofollow noopener noreferrer">platform.minimaxi.com/docs/guides…</a></td></tr><tr><td>GitHub仓库</td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FMiniMax-AI%2FMiniMax-M2" target="_blank" title="https://github.com/MiniMax-AI/MiniMax-M2" ref="nofollow noopener noreferrer">github.com/MiniMax-AI/…</a></td></tr><tr><td>Claude Code文档</td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fclaude.com%2Fclaude-code" target="_blank" title="https://claude.com/claude-code" ref="nofollow noopener noreferrer">claude.com/claude-code</a></td></tr></tbody></table>
<hr/>
<p><em>本文基于2025年12月的信息撰写，定价和政策可能随时变化，请以官方最新公告为准。</em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[还在手动翻译国际化词条？AST解析+AI翻译实现一键替换]]></title>    <link>https://juejin.cn/post/7588487605247836169</link>    <guid>https://juejin.cn/post/7588487605247836169</guid>    <pubDate>2025-12-28T14:26:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588487605247836169" data-draft-id="7584742635483758602" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="还在手动翻译国际化词条？AST解析+AI翻译实现一键替换"/> <meta itemprop="keywords" content="前端,后端,AI编程"/> <meta itemprop="datePublished" content="2025-12-28T14:26:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="布列瑟农的星空"/> <meta itemprop="url" content="https://juejin.cn/user/976022056218471"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            还在手动翻译国际化词条？AST解析+AI翻译实现一键替换
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/976022056218471/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    布列瑟农的星空
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-28T14:26:01.000Z" title="Sun Dec 28 2025 14:26:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>国际化项目，经常要随迭代增加翻译词条，如果手动翻译，很容易造成翻译重复或遗漏，而且词条的替换操作体验也极差，这类机械性工作完全可以交给AI完成。</p>
<h2 data-id="heading-0">前置准备</h2>
<p>首先需要一个AI服务器，推荐ollama，部署简单。</p>
<p>其次需要一个可视化AST结构的工具，推荐<a href="https://link.juejin.cn?target=https%3A%2F%2Fastexplorer.net%2F" target="_blank" title="https://astexplorer.net/" ref="nofollow noopener noreferrer">astexplorer.net/</a></p>
<h2 data-id="heading-1">AI翻译</h2>
<p>翻译部分比较简单，这里是传入中文语言包，然后输出英文语言包。只要调用ollama的api，传入对应的模型和promot，约定输出结构就行。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> axios = <span class="hljs-built_in">require</span>(<span class="hljs-string">'axios'</span>);

<span class="hljs-comment">/**
 * 调用 Ollama  模型实现中译英
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} <span class="hljs-variable">chineseText</span> - 要翻译的中文语言包文本
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">Promise&lt;string&gt;</span>} 翻译后的英文语言包文本
 */</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">translateChineseToEnglish</span>(<span class="hljs-params">chineseText</span>) {
  <span class="hljs-comment">// Ollama 本地 API 地址（默认端口 11434）</span>
  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">OLLAMA_API_URL</span> = <span class="hljs-string">'http://localhost:11434/api/generate'</span>;

  <span class="hljs-comment">// 构建提示词</span>
  <span class="hljs-keyword">const</span> prompt = <span class="hljs-string">`
    你是一个专业的中英翻译助手，请严格按照以下要求执行：
    1. 将中文语言包JSON翻译为应为语言包
    2. 语言包结构如下： {"k_abc12345": "是","k_rst12345": "确认"}，key为i18n key，value为对应语言
    1. 唯一输出内容为英文语言包JSON：示例： {"k_abc12345": "yes","k_rst12345": "confirm"}, key不变，值为中文文本的英文翻译结果；
    2. 禁止输出：任何非 JSON 内容（包括思考过程、解释、换行、空格、前缀/后缀）；
    3. 翻译要求：准确、通顺，符合英文表达习惯。
    需要翻译的中文语言包：<span class="hljs-subst">${chineseText}</span>
  `</span>.<span class="hljs-title function_">trim</span>();

  <span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// 发送请求到 Ollama API</span>
    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> axios.<span class="hljs-title function_">post</span>(
      <span class="hljs-variable constant_">OLLAMA_API_URL</span>,
      {
        <span class="hljs-attr">model</span>: <span class="hljs-string">'qwen3:8b'</span>,
        <span class="hljs-attr">prompt</span>: prompt,
        <span class="hljs-attr">stream</span>: <span class="hljs-literal">false</span>, 
        <span class="hljs-attr">temperature</span>: <span class="hljs-number">0.1</span>, 
        <span class="hljs-attr">max_tokens</span>: <span class="hljs-number">1000</span>, 
      },
      {
        <span class="hljs-attr">headers</span>: {
          <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span>,
        },
        <span class="hljs-attr">timeout</span>: <span class="hljs-number">30000</span>, <span class="hljs-comment">// 超时时间 30 秒</span>
      },
    );

    <span class="hljs-comment">// 解析响应结果</span>
    <span class="hljs-keyword">if</span> (response.<span class="hljs-property">data</span> &amp;&amp; response.<span class="hljs-property">data</span>.<span class="hljs-property">response</span>) {
      <span class="hljs-comment">// 清理结果中的多余空格/换行</span>
      <span class="hljs-keyword">const</span> translatedText = response.<span class="hljs-property">data</span>.<span class="hljs-property">response</span>.<span class="hljs-title function_">trim</span>();
      <span class="hljs-keyword">return</span> translatedText;
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'模型返回结果格式异常'</span>);
    }
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-comment">// 错误处理</span>
   
  }
}

<span class="hljs-comment">// 示例使用languageJson:{ k_abc12345: '是', k_lmn67890: 'yes' }</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">translate</span>(<span class="hljs-params">languageJson</span>) {
  <span class="hljs-comment">// 要翻译的中文文本</span>
  <span class="hljs-keyword">const</span> chineseText = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(languageJson);

  <span class="hljs-keyword">try</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'待翻译的中文：'</span>, chineseText);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'------------------------'</span>);

    <span class="hljs-keyword">const</span> englishText = <span class="hljs-keyword">await</span> <span class="hljs-title function_">translateChineseToEnglish</span>(chineseText);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'翻译结果:'</span>, englishText);
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(englishText);
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'翻译出错：'</span>, error.<span class="hljs-property">message</span>);
  }
  <span class="hljs-keyword">return</span> {};
}
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = { translate };
</code></pre>
<h2 data-id="heading-2">AST翻译词条替换</h2>
<h3 data-id="heading-3">i18n key生成</h3>
<p>这里首先需要获取到中文，并生成i18n key，对同一中文生成的key应该一样，可以使用md5摘要算法。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-title function_">genKey</span> = (<span class="hljs-params">zh</span>) =&gt; <span class="hljs-string">'k_'</span> + crypto.<span class="hljs-title function_">createHash</span>(<span class="hljs-string">'md5'</span>).<span class="hljs-title function_">update</span>(zh).<span class="hljs-title function_">digest</span>(<span class="hljs-string">'hex'</span>).<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, <span class="hljs-number">8</span>);
</code></pre>
<h3 data-id="heading-4">核心逻辑：AST操作</h3>
<p>AST操作相对繁琐，这里用到的工具有babel和recast，recast能保留原文件的内容格式。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> fg = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fast-glob'</span>);
<span class="hljs-keyword">const</span> crypto = <span class="hljs-built_in">require</span>(<span class="hljs-string">'node:crypto'</span>);
<span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'node:fs/promises'</span>);
<span class="hljs-keyword">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'node:path'</span>);

<span class="hljs-keyword">const</span> traverse = <span class="hljs-built_in">require</span>(<span class="hljs-string">'@babel/traverse'</span>).<span class="hljs-property">default</span>;
<span class="hljs-keyword">const</span> { <span class="hljs-attr">parse</span>: babelParse } = <span class="hljs-built_in">require</span>(<span class="hljs-string">'@babel/parser'</span>);
<span class="hljs-keyword">const</span> recast = <span class="hljs-built_in">require</span>(<span class="hljs-string">'recast'</span>);
<span class="hljs-keyword">const</span> t = <span class="hljs-built_in">require</span>(<span class="hljs-string">'@babel/types'</span>);
<span class="hljs-keyword">const</span> { translate } = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./translate.cjs'</span>);
<span class="hljs-keyword">const</span> excludes = [
  <span class="hljs-regexp">/language/</span>,
   ...
];
<span class="hljs-comment">/* ────── 配置 ────── */</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">SRC_DIR</span> = path.<span class="hljs-title function_">resolve</span>(process.<span class="hljs-title function_">cwd</span>(), <span class="hljs-string">'src'</span>);
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">LOCALE_FILES</span> = [
  path.<span class="hljs-title function_">resolve</span>(<span class="hljs-variable constant_">SRC_DIR</span>, <span class="hljs-string">'自定义路径'</span>, <span class="hljs-string">'zh-CN.json'</span>),
  path.<span class="hljs-title function_">resolve</span>(<span class="hljs-variable constant_">SRC_DIR</span>, <span class="hljs-string">'自定义路径'</span>, <span class="hljs-string">'en-US.json'</span>),
  <span class="hljs-comment">// 可继续添加更多语种</span>
];
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">GLOB</span> = [<span class="hljs-string">'**/*.{js,jsx,ts,tsx}'</span>];

<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">CHN_RE</span> =
  <span class="hljs-regexp">/[\u3400-\u4dbf\u4e00-\u9fff\u{20000}-\u{2a6df}\u{2a700}-\u{2b73f}\u{2b740}-\u{2b81f}\u{2b820}-\u{2ceaf}\u3000-\u303f\uff00-\uffef]/u</span>;
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">KEY_RE</span> = <span class="hljs-regexp">/^k_[0-9a-f]{8}$/</span>;
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">I18N_IMPORT</span> = <span class="hljs-string">'@/i18n'</span>;

<span class="hljs-comment">/* ────── 工具 ────── */</span>
<span class="hljs-keyword">const</span> dict = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(<span class="hljs-literal">null</span>);


<span class="hljs-keyword">const</span> <span class="hljs-title function_">buildReactCallWithAlias</span> = (<span class="hljs-params">aliasName, key</span>) =&gt; t.<span class="hljs-title function_">callExpression</span>(t.<span class="hljs-title function_">identifier</span>(aliasName), [t.<span class="hljs-title function_">stringLiteral</span>(key)]);
<span class="hljs-keyword">const</span> <span class="hljs-title function_">buildCommonCall</span> = (<span class="hljs-params">key</span>) =&gt;
  t.<span class="hljs-title function_">callExpression</span>(t.<span class="hljs-title function_">memberExpression</span>(t.<span class="hljs-title function_">identifier</span>(<span class="hljs-string">'i18n'</span>), t.<span class="hljs-title function_">identifier</span>(<span class="hljs-string">'t'</span>)), [t.<span class="hljs-title function_">stringLiteral</span>(key)]);


<span class="hljs-keyword">function</span> <span class="hljs-title function_">hasJSX</span>(<span class="hljs-params">ast</span>) {
  <span class="hljs-keyword">let</span> yes = <span class="hljs-literal">false</span>;
  <span class="hljs-title function_">traverse</span>(ast, {
    <span class="hljs-title class_">JSXElement</span>(p) {
      yes = <span class="hljs-literal">true</span>;
      p.<span class="hljs-title function_">stop</span>();
    },
    <span class="hljs-title class_">JSXFragment</span>(p) {
      yes = <span class="hljs-literal">true</span>;
      p.<span class="hljs-title function_">stop</span>();
    },
  });
  <span class="hljs-keyword">return</span> yes;
}
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getFunctionName</span>(<span class="hljs-params">fnPath</span>) {
  <span class="hljs-keyword">const</span> n = fnPath.<span class="hljs-property">node</span>;
  <span class="hljs-keyword">if</span> (t.<span class="hljs-title function_">isFunctionDeclaration</span>(n) &amp;&amp; n.<span class="hljs-property">id</span>) <span class="hljs-keyword">return</span> n.<span class="hljs-property">id</span>.<span class="hljs-property">name</span>;
  <span class="hljs-keyword">if</span> (
    (t.<span class="hljs-title function_">isFunctionExpression</span>(n) || t.<span class="hljs-title function_">isArrowFunctionExpression</span>(n)) &amp;&amp;
    t.<span class="hljs-title function_">isVariableDeclarator</span>(fnPath.<span class="hljs-property">parent</span>) &amp;&amp;
    t.<span class="hljs-title function_">isIdentifier</span>(fnPath.<span class="hljs-property">parent</span>.<span class="hljs-property">id</span>)
  )
    <span class="hljs-keyword">return</span> fnPath.<span class="hljs-property">parent</span>.<span class="hljs-property">id</span>.<span class="hljs-property">name</span>;
  <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
}
<span class="hljs-keyword">function</span> <span class="hljs-title function_">nameLooksLikeComponentOrHook</span>(<span class="hljs-params">name</span>) {
  <span class="hljs-keyword">if</span> (!name) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">if</span> (name.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'use'</span>)) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  <span class="hljs-keyword">return</span> <span class="hljs-regexp">/^[A-Z]/</span>.<span class="hljs-title function_">test</span>(name);
}
<span class="hljs-keyword">function</span> <span class="hljs-title function_">functionHasJSX</span>(<span class="hljs-params">fnPath</span>) {
  <span class="hljs-keyword">let</span> found = <span class="hljs-literal">false</span>;
  fnPath.<span class="hljs-title function_">traverse</span>({
    <span class="hljs-title class_">JSXElement</span>(p) {
      found = <span class="hljs-literal">true</span>;
      p.<span class="hljs-title function_">stop</span>();
    },
    <span class="hljs-title class_">JSXFragment</span>(p) {
      found = <span class="hljs-literal">true</span>;
      p.<span class="hljs-title function_">stop</span>();
    },
  });
  <span class="hljs-keyword">return</span> found;
}
<span class="hljs-keyword">function</span> <span class="hljs-title function_">isClassLikeFunction</span>(<span class="hljs-params">fnPath</span>) {
  <span class="hljs-keyword">return</span> !!fnPath.<span class="hljs-title function_">findParent</span>(<span class="hljs-function">(<span class="hljs-params">pp</span>) =&gt;</span> pp.<span class="hljs-property">isClassBody</span> &amp;&amp; pp.<span class="hljs-title function_">isClassBody</span>());
}
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getHookableFunctionScope</span>(<span class="hljs-params">p</span>) {
  <span class="hljs-keyword">const</span> fn = p.<span class="hljs-title function_">getFunctionParent</span>();
  <span class="hljs-keyword">if</span> (!fn) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">if</span> (!(fn.<span class="hljs-title function_">isFunctionDeclaration</span>() || fn.<span class="hljs-title function_">isFunctionExpression</span>() || fn.<span class="hljs-title function_">isArrowFunctionExpression</span>())) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">if</span> (!fn.<span class="hljs-title function_">get</span>(<span class="hljs-string">'body'</span>).<span class="hljs-title function_">isBlockStatement</span>()) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isClassLikeFunction</span>(fn)) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">const</span> name = <span class="hljs-title function_">getFunctionName</span>(fn);
  <span class="hljs-keyword">if</span> (<span class="hljs-title function_">nameLooksLikeComponentOrHook</span>(name) || <span class="hljs-title function_">functionHasJSX</span>(fn)) <span class="hljs-keyword">return</span> fn;
  <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
}


<span class="hljs-comment">/* ────── 处理单个文件 ────── */</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">transformFile</span>(<span class="hljs-params">absPath</span>) {
  <span class="hljs-keyword">const</span> code = <span class="hljs-keyword">await</span> fs.<span class="hljs-title function_">readFile</span>(absPath, <span class="hljs-string">'utf8'</span>);
  <span class="hljs-keyword">if</span> (!<span class="hljs-variable constant_">CHN_RE</span>.<span class="hljs-title function_">test</span>(code)) <span class="hljs-keyword">return</span>;

  <span class="hljs-keyword">let</span> ast;
  <span class="hljs-keyword">try</span> {
    ast = recast.<span class="hljs-title function_">parse</span>(code, {
      <span class="hljs-attr">parser</span>: {
        <span class="hljs-title function_">parse</span>(<span class="hljs-params">src</span>) {
          <span class="hljs-keyword">return</span> <span class="hljs-title function_">babelParse</span>(src, {
            <span class="hljs-attr">sourceType</span>: <span class="hljs-string">'unambiguous'</span>,
            <span class="hljs-attr">plugins</span>: [<span class="hljs-string">'jsx'</span>, <span class="hljs-string">'typescript'</span>, <span class="hljs-string">'decorators-legacy'</span>, <span class="hljs-string">'classProperties'</span>],
            <span class="hljs-attr">tokens</span>: <span class="hljs-literal">true</span>,
          });
        },
      },
    });
  } <span class="hljs-keyword">catch</span> (e) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">'skip parse error:'</span>, path.<span class="hljs-title function_">relative</span>(process.<span class="hljs-title function_">cwd</span>(), absPath), e.<span class="hljs-property">reasonCode</span> || e.<span class="hljs-property">message</span>);
    <span class="hljs-keyword">return</span>;
  }

  <span class="hljs-keyword">const</span> reactLike = <span class="hljs-title function_">hasJSX</span>(ast);
  <span class="hljs-keyword">let</span> modified = <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">let</span> injectedUseTranslationSomewhere = <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">let</span> usedI18nCommon = <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">const</span> tAliasMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WeakMap</span>();

  <span class="hljs-comment">/* ── 内部工具 ── */</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">findExistingTAlias</span>(<span class="hljs-params">fnPath</span>) {
    <span class="hljs-keyword">let</span> alias = <span class="hljs-literal">null</span>;
    fnPath.<span class="hljs-title function_">traverse</span>({
      <span class="hljs-title class_">VariableDeclarator</span>(vp) {
        <span class="hljs-keyword">const</span> n = vp.<span class="hljs-property">node</span>;
        <span class="hljs-keyword">if</span> (!t.<span class="hljs-title function_">isObjectPattern</span>(n.<span class="hljs-property">id</span>)) <span class="hljs-keyword">return</span>;
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> pr <span class="hljs-keyword">of</span> n.<span class="hljs-property">id</span>.<span class="hljs-property">properties</span>) {
          <span class="hljs-keyword">if</span> (t.<span class="hljs-title function_">isObjectProperty</span>(pr) &amp;&amp; t.<span class="hljs-title function_">isIdentifier</span>(pr.<span class="hljs-property">key</span>, { <span class="hljs-attr">name</span>: <span class="hljs-string">'t'</span> })) {
            <span class="hljs-keyword">const</span> local = pr.<span class="hljs-property">shorthand</span> ? <span class="hljs-string">'t'</span> : t.<span class="hljs-title function_">isIdentifier</span>(pr.<span class="hljs-property">value</span>) ? pr.<span class="hljs-property">value</span>.<span class="hljs-property">name</span> : <span class="hljs-literal">null</span>;
            <span class="hljs-keyword">if</span> (local &amp;&amp; t.<span class="hljs-title function_">isCallExpression</span>(n.<span class="hljs-property">init</span>) &amp;&amp; t.<span class="hljs-title function_">isIdentifier</span>(n.<span class="hljs-property">init</span>.<span class="hljs-property">callee</span>, { <span class="hljs-attr">name</span>: <span class="hljs-string">'useTranslation'</span> })) {
              alias = local;
              vp.<span class="hljs-title function_">stop</span>();
            }
          }
        }
      },
    });
    <span class="hljs-keyword">return</span> alias;
  }
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">ensureTInFunction</span>(<span class="hljs-params">fnPath</span>) {
    <span class="hljs-keyword">const</span> cached = tAliasMap.<span class="hljs-title function_">get</span>(fnPath.<span class="hljs-property">node</span>);
    <span class="hljs-keyword">if</span> (cached) <span class="hljs-keyword">return</span> cached;
    <span class="hljs-keyword">const</span> existed = <span class="hljs-title function_">findExistingTAlias</span>(fnPath);
    <span class="hljs-keyword">if</span> (existed) {
      tAliasMap.<span class="hljs-title function_">set</span>(fnPath.<span class="hljs-property">node</span>, existed);
      <span class="hljs-keyword">return</span> existed;
    }
    <span class="hljs-keyword">const</span> aliasId = fnPath.<span class="hljs-property">scope</span>.<span class="hljs-title function_">hasBinding</span>(<span class="hljs-string">'t'</span>) ? fnPath.<span class="hljs-property">scope</span>.<span class="hljs-title function_">generateUidIdentifier</span>(<span class="hljs-string">'t'</span>) : t.<span class="hljs-title function_">identifier</span>(<span class="hljs-string">'t'</span>);
    <span class="hljs-keyword">const</span> decl = t.<span class="hljs-title function_">variableDeclaration</span>(<span class="hljs-string">'const'</span>, [
      t.<span class="hljs-title function_">variableDeclarator</span>(
        t.<span class="hljs-title function_">objectPattern</span>([t.<span class="hljs-title function_">objectProperty</span>(t.<span class="hljs-title function_">identifier</span>(<span class="hljs-string">'t'</span>), aliasId, <span class="hljs-literal">false</span>, aliasId.<span class="hljs-property">name</span> === <span class="hljs-string">'t'</span>)]),
        t.<span class="hljs-title function_">callExpression</span>(t.<span class="hljs-title function_">identifier</span>(<span class="hljs-string">'useTranslation'</span>), []),
      ),
    ]);
    <span class="hljs-keyword">const</span> bodyPath = fnPath.<span class="hljs-title function_">get</span>(<span class="hljs-string">'body'</span>);
    <span class="hljs-keyword">if</span> (!bodyPath.<span class="hljs-title function_">isBlockStatement</span>()) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    bodyPath.<span class="hljs-title function_">unshiftContainer</span>(<span class="hljs-string">'body'</span>, decl);
    injectedUseTranslationSomewhere = <span class="hljs-literal">true</span>;
    tAliasMap.<span class="hljs-title function_">set</span>(fnPath.<span class="hljs-property">node</span>, aliasId.<span class="hljs-property">name</span>);
    <span class="hljs-keyword">return</span> aliasId.<span class="hljs-property">name</span>;
  }
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">getTAliasForPath</span>(<span class="hljs-params">p</span>) {
    <span class="hljs-keyword">if</span> (!reactLike) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">const</span> fn = <span class="hljs-title function_">getHookableFunctionScope</span>(p);
    <span class="hljs-keyword">if</span> (!fn) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">ensureTInFunction</span>(fn);
  }

  <span class="hljs-comment">/* ── AST 遍历 ── */</span>
  <span class="hljs-title function_">traverse</span>(ast, {
    <span class="hljs-title class_">StringLiteral</span>(p) {
      <span class="hljs-keyword">const</span> raw = p.<span class="hljs-property">node</span>.<span class="hljs-property">value</span>;
      <span class="hljs-keyword">if</span> (!<span class="hljs-variable constant_">CHN_RE</span>.<span class="hljs-title function_">test</span>(raw)) <span class="hljs-keyword">return</span>;
      <span class="hljs-keyword">if</span> (<span class="hljs-variable constant_">KEY_RE</span>.<span class="hljs-title function_">test</span>(raw)) <span class="hljs-keyword">return</span>;
      <span class="hljs-keyword">if</span> (
        <span class="hljs-title function_">isImportSource</span>(p) ||
        <span class="hljs-title function_">isRequirePath</span>(p) ||
        <span class="hljs-title function_">isDynamicImportArg</span>(p) ||
        <span class="hljs-title function_">isObjectKey</span>(p) ||
        <span class="hljs-title function_">isI18nKey</span>(p) ||
        <span class="hljs-title function_">isInTypePosition</span>(p) ||
        <span class="hljs-title function_">isConsoleArg</span>(p) ||
        <span class="hljs-title function_">isThrowError</span>(p)
      )
        <span class="hljs-keyword">return</span>;

      <span class="hljs-keyword">const</span> key = <span class="hljs-title function_">genKey</span>(raw);
      <span class="hljs-keyword">if</span> (!dict[key]) dict[key] = raw;
      <span class="hljs-keyword">const</span> tAlias = <span class="hljs-title function_">getTAliasForPath</span>(p);
      <span class="hljs-keyword">const</span> inJsxAttr = p.<span class="hljs-property">parentPath</span>.<span class="hljs-title function_">isJSXAttribute</span>() &amp;&amp; p.<span class="hljs-property">parent</span>.<span class="hljs-property">value</span> === p.<span class="hljs-property">node</span>;
      <span class="hljs-keyword">const</span> call = tAlias ? <span class="hljs-title function_">buildReactCallWithAlias</span>(tAlias, key) : ((usedI18nCommon = <span class="hljs-literal">true</span>), <span class="hljs-title function_">buildCommonCall</span>(key));
      <span class="hljs-keyword">if</span> (inJsxAttr) p.<span class="hljs-title function_">replaceWith</span>(t.<span class="hljs-title function_">jsxExpressionContainer</span>(call));
      <span class="hljs-keyword">else</span> p.<span class="hljs-title function_">replaceWith</span>(call);
      p.<span class="hljs-title function_">skip</span>();
      modified = <span class="hljs-literal">true</span>;
    },

    <span class="hljs-title class_">TemplateLiteral</span>(p) {
      <span class="hljs-keyword">if</span> (p.<span class="hljs-property">node</span>.<span class="hljs-property">expressions</span>.<span class="hljs-property">length</span>) <span class="hljs-keyword">return</span>;
      <span class="hljs-keyword">const</span> cooked = p.<span class="hljs-property">node</span>.<span class="hljs-property">quasis</span>[<span class="hljs-number">0</span>].<span class="hljs-property">value</span>.<span class="hljs-property">cooked</span>;
      <span class="hljs-keyword">if</span> (!cooked || !<span class="hljs-variable constant_">CHN_RE</span>.<span class="hljs-title function_">test</span>(cooked) || <span class="hljs-variable constant_">KEY_RE</span>.<span class="hljs-title function_">test</span>(cooked)) <span class="hljs-keyword">return</span>;
      <span class="hljs-keyword">if</span> (
        <span class="hljs-title function_">isImportSource</span>(p) ||
        <span class="hljs-title function_">isRequirePath</span>(p) ||
        <span class="hljs-title function_">isDynamicImportArg</span>(p) ||
        <span class="hljs-title function_">isObjectKey</span>(p) ||
        <span class="hljs-title function_">isInTypePosition</span>(p) ||
        <span class="hljs-title function_">isConsoleArg</span>(p)
      )
        <span class="hljs-keyword">return</span>;

      <span class="hljs-keyword">const</span> key = <span class="hljs-title function_">genKey</span>(cooked);
      <span class="hljs-keyword">if</span> (!dict[key]) dict[key] = cooked;
      <span class="hljs-keyword">const</span> tAlias = <span class="hljs-title function_">getTAliasForPath</span>(p);
      p.<span class="hljs-title function_">replaceWith</span>(tAlias ? <span class="hljs-title function_">buildReactCallWithAlias</span>(tAlias, key) : ((usedI18nCommon = <span class="hljs-literal">true</span>), <span class="hljs-title function_">buildCommonCall</span>(key)));
      p.<span class="hljs-title function_">skip</span>();
      modified = <span class="hljs-literal">true</span>;
    },

    <span class="hljs-title class_">JSXText</span>(p) {
      <span class="hljs-keyword">const</span> raw = p.<span class="hljs-property">node</span>.<span class="hljs-property">value</span>;
      <span class="hljs-keyword">if</span> (!<span class="hljs-variable constant_">CHN_RE</span>.<span class="hljs-title function_">test</span>(raw)) <span class="hljs-keyword">return</span>;
      <span class="hljs-keyword">const</span> leading = (raw.<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/^\s+/</span>) || [<span class="hljs-string">''</span>])[<span class="hljs-number">0</span>];
      <span class="hljs-keyword">const</span> trailing = (raw.<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/\s+$/</span>) || [<span class="hljs-string">''</span>])[<span class="hljs-number">0</span>];
      <span class="hljs-keyword">const</span> middle = raw.<span class="hljs-title function_">slice</span>(leading.<span class="hljs-property">length</span>, raw.<span class="hljs-property">length</span> - trailing.<span class="hljs-property">length</span>);
      <span class="hljs-keyword">if</span> (!middle || !<span class="hljs-variable constant_">CHN_RE</span>.<span class="hljs-title function_">test</span>(middle) || <span class="hljs-variable constant_">KEY_RE</span>.<span class="hljs-title function_">test</span>(middle)) <span class="hljs-keyword">return</span>;

      <span class="hljs-keyword">const</span> key = <span class="hljs-title function_">genKey</span>(middle);
      <span class="hljs-keyword">if</span> (!dict[key]) dict[key] = middle;
      <span class="hljs-keyword">const</span> tAlias = <span class="hljs-title function_">getTAliasForPath</span>(p);
      <span class="hljs-keyword">const</span> expr = tAlias ? <span class="hljs-title function_">buildReactCallWithAlias</span>(tAlias, key) : ((usedI18nCommon = <span class="hljs-literal">true</span>), <span class="hljs-title function_">buildCommonCall</span>(key));
      <span class="hljs-keyword">const</span> parts = [];
      <span class="hljs-keyword">if</span> (leading) parts.<span class="hljs-title function_">push</span>(t.<span class="hljs-title function_">jsxText</span>(leading));
      parts.<span class="hljs-title function_">push</span>(t.<span class="hljs-title function_">jsxExpressionContainer</span>(expr));
      <span class="hljs-keyword">if</span> (trailing) parts.<span class="hljs-title function_">push</span>(t.<span class="hljs-title function_">jsxText</span>(trailing));
      p.<span class="hljs-title function_">replaceWithMultiple</span>(parts);
      p.<span class="hljs-title function_">skip</span>();
      modified = <span class="hljs-literal">true</span>;
    },
  });

  <span class="hljs-comment">/* ── 补充 import ── */</span>
  <span class="hljs-keyword">if</span> (injectedUseTranslationSomewhere) {
    <span class="hljs-title function_">ensureUseTranslationImport</span>(ast.<span class="hljs-property">program</span>);
    modified = <span class="hljs-literal">true</span>;
  }
  <span class="hljs-keyword">if</span> (usedI18nCommon) {
    <span class="hljs-keyword">let</span> programPath = <span class="hljs-literal">null</span>;
    <span class="hljs-title function_">traverse</span>(ast, {
      <span class="hljs-title class_">Program</span>(pp) {
        programPath = pp;
        pp.<span class="hljs-title function_">stop</span>();
      },
    });
    <span class="hljs-keyword">if</span> (programPath) {
      <span class="hljs-title function_">ensureI18nImport</span>(ast.<span class="hljs-property">program</span>, programPath);
      modified = <span class="hljs-literal">true</span>;
    }
  }

  <span class="hljs-comment">/* ── 写回文件 ── */</span>
  <span class="hljs-keyword">if</span> (modified) {
    <span class="hljs-keyword">const</span> output = recast.<span class="hljs-title function_">print</span>(ast, { <span class="hljs-attr">quote</span>: <span class="hljs-string">'single'</span> }).<span class="hljs-property">code</span>;
    <span class="hljs-keyword">await</span> fs.<span class="hljs-title function_">writeFile</span>(absPath, output, <span class="hljs-string">'utf8'</span>);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'✔ transformed'</span>, path.<span class="hljs-title function_">relative</span>(process.<span class="hljs-title function_">cwd</span>(), absPath));
  }
}

<span class="hljs-comment">/* ────── 同步 locale 文件 ────── */</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">flushDict</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> keys = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(dict);
  <span class="hljs-keyword">if</span> (!keys.<span class="hljs-property">length</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'✨  没有新的翻译条目'</span>);
    <span class="hljs-keyword">return</span>;
  }

  <span class="hljs-keyword">const</span> oldJsonArr = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>(
    <span class="hljs-variable constant_">LOCALE_FILES</span>.<span class="hljs-title function_">map</span>(<span class="hljs-keyword">async</span> (f) =&gt; {
      <span class="hljs-keyword">const</span> text = <span class="hljs-keyword">await</span> fs.<span class="hljs-title function_">readFile</span>(f, <span class="hljs-string">'utf8'</span>);
      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(text);
      } <span class="hljs-keyword">catch</span> (e) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(e, text);
        <span class="hljs-keyword">return</span> {};
      }
    }),
  );
  <span class="hljs-comment">//中文语言包</span>
  <span class="hljs-keyword">const</span> toTranslate = {};
  <span class="hljs-keyword">const</span> file = <span class="hljs-variable constant_">LOCALE_FILES</span>[<span class="hljs-number">0</span>];
  <span class="hljs-keyword">const</span> oldJson = oldJsonArr[<span class="hljs-number">0</span>];
  <span class="hljs-keyword">const</span> merged = { ...oldJson };
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> k <span class="hljs-keyword">of</span> keys) {
    <span class="hljs-keyword">if</span> (!(k <span class="hljs-keyword">in</span> oldJson)) {
      merged[k] = dict[k];
      toTranslate[k] = dict[k];
    }
  }
  <span class="hljs-keyword">await</span> fs.<span class="hljs-title function_">mkdir</span>(path.<span class="hljs-title function_">dirname</span>(file), { <span class="hljs-attr">recursive</span>: <span class="hljs-literal">true</span> });
  <span class="hljs-keyword">await</span> fs.<span class="hljs-title function_">writeFile</span>(file, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(merged, <span class="hljs-literal">null</span>, <span class="hljs-number">2</span>) + <span class="hljs-string">'\n'</span>, <span class="hljs-string">'utf8'</span>);
  <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(toTranslate).<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">const</span> translated = <span class="hljs-keyword">await</span> <span class="hljs-title function_">translate</span>(toTranslate);
    <span class="hljs-keyword">let</span> toMerged = translated || dict;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt; <span class="hljs-variable constant_">LOCALE_FILES</span>.<span class="hljs-property">length</span>; i++) {
      <span class="hljs-keyword">const</span> file = <span class="hljs-variable constant_">LOCALE_FILES</span>[i];
      <span class="hljs-keyword">const</span> oldJson = oldJsonArr[i];
      <span class="hljs-keyword">const</span> merged = { ...oldJson };
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> k <span class="hljs-keyword">of</span> keys) <span class="hljs-keyword">if</span> (!(k <span class="hljs-keyword">in</span> oldJson)) merged[k] = toMerged[k] || dict[k];
      <span class="hljs-keyword">await</span> fs.<span class="hljs-title function_">mkdir</span>(path.<span class="hljs-title function_">dirname</span>(file), { <span class="hljs-attr">recursive</span>: <span class="hljs-literal">true</span> });
      <span class="hljs-keyword">await</span> fs.<span class="hljs-title function_">writeFile</span>(file, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(merged, <span class="hljs-literal">null</span>, <span class="hljs-number">2</span>) + <span class="hljs-string">'\n'</span>, <span class="hljs-string">'utf8'</span>);
    }
  }

  <span class="hljs-keyword">const</span> newCount = keys.<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">k</span>) =&gt;</span> !(k <span class="hljs-keyword">in</span> oldJsonArr[<span class="hljs-number">0</span>])).<span class="hljs-property">length</span>;
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(
    <span class="hljs-string">`✨  已同步到所有 locale 文件：<span class="hljs-subst">${LOCALE_FILES.map((f) =&gt; path.relative(process.cwd(), f)).join(
      <span class="hljs-string">', '</span>,
    )}</span>，新增 <span class="hljs-subst">${newCount}</span> 条`</span>,
  );
}

<span class="hljs-comment">/* ────── 主入口 ────── */</span>
(<span class="hljs-keyword">async</span> () =&gt; {
  <span class="hljs-keyword">const</span> cliArgs = process.<span class="hljs-property">argv</span>.<span class="hljs-title function_">slice</span>(<span class="hljs-number">2</span>);
  <span class="hljs-keyword">const</span> targets = cliArgs.<span class="hljs-property">length</span> ? cliArgs : [<span class="hljs-string">'src'</span>];
  <span class="hljs-keyword">const</span> patterns = [];

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> raw <span class="hljs-keyword">of</span> targets) {

    <span class="hljs-keyword">let</span> abs = path.<span class="hljs-title function_">resolve</span>(process.<span class="hljs-title function_">cwd</span>(), raw);
    <span class="hljs-keyword">let</span> stat = <span class="hljs-keyword">await</span> fs.<span class="hljs-title function_">stat</span>(abs).<span class="hljs-title function_">catch</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-literal">null</span>);

   
    <span class="hljs-keyword">if</span> (!stat) {
      <span class="hljs-keyword">const</span> insideSrc = path.<span class="hljs-title function_">join</span>(<span class="hljs-variable constant_">SRC_DIR</span>, raw);
      abs = insideSrc;
      stat = <span class="hljs-keyword">await</span> fs.<span class="hljs-title function_">stat</span>(abs).<span class="hljs-title function_">catch</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-literal">null</span>);
    }


    <span class="hljs-keyword">if</span> (!stat) {
      <span class="hljs-comment">// 先找目录</span>
      <span class="hljs-keyword">const</span> dirMatches = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fg</span>(<span class="hljs-string">`**/<span class="hljs-subst">${raw}</span>`</span>, {
        <span class="hljs-attr">cwd</span>: <span class="hljs-variable constant_">SRC_DIR</span>,
        <span class="hljs-attr">onlyDirectories</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 关键改动: 只返回目录</span>
        <span class="hljs-attr">absolute</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">suppressErrors</span>: <span class="hljs-literal">true</span>,
      });
      <span class="hljs-keyword">if</span> (dirMatches.<span class="hljs-property">length</span>) {
        abs = dirMatches[<span class="hljs-number">0</span>];
        stat = <span class="hljs-keyword">await</span> fs.<span class="hljs-title function_">stat</span>(abs);
      } <span class="hljs-keyword">else</span> {
       
        <span class="hljs-keyword">const</span> fileMatches = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fg</span>(<span class="hljs-string">`**/<span class="hljs-subst">${raw}</span>`</span>, {
          <span class="hljs-attr">cwd</span>: <span class="hljs-variable constant_">SRC_DIR</span>,
          <span class="hljs-attr">onlyFiles</span>: <span class="hljs-literal">true</span>,
          <span class="hljs-attr">absolute</span>: <span class="hljs-literal">true</span>,
          <span class="hljs-attr">suppressErrors</span>: <span class="hljs-literal">true</span>,
        });
        <span class="hljs-keyword">if</span> (fileMatches.<span class="hljs-property">length</span>) {
          abs = fileMatches[<span class="hljs-number">0</span>];
          stat = <span class="hljs-keyword">await</span> fs.<span class="hljs-title function_">stat</span>(abs);
        }
      }
    }


    <span class="hljs-keyword">if</span> (!stat) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">`⚠️  路径不存在: <span class="hljs-subst">${raw}</span>`</span>);
      <span class="hljs-keyword">continue</span>;
    }


    <span class="hljs-keyword">if</span> (stat.<span class="hljs-title function_">isFile</span>()) {
      patterns.<span class="hljs-title function_">push</span>(abs); 
      <span class="hljs-keyword">continue</span>;
    }

  
    <span class="hljs-keyword">const</span> relToSrc = path.<span class="hljs-title function_">relative</span>(<span class="hljs-variable constant_">SRC_DIR</span>, abs).<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/\\/g</span>, <span class="hljs-string">'/'</span>);
    <span class="hljs-keyword">const</span> prefix = relToSrc ? relToSrc : <span class="hljs-string">'.'</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> ptn <span class="hljs-keyword">of</span> <span class="hljs-variable constant_">GLOB</span>) {
      patterns.<span class="hljs-title function_">push</span>(path.<span class="hljs-property">posix</span>.<span class="hljs-title function_">join</span>(prefix, ptn));
    }
  }


  <span class="hljs-keyword">if</span> (!patterns.<span class="hljs-property">length</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'⚠️  无可扫描文件'</span>);
    <span class="hljs-keyword">return</span>;
  }

  <span class="hljs-keyword">const</span> files = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fg</span>(patterns, { <span class="hljs-attr">cwd</span>: <span class="hljs-variable constant_">SRC_DIR</span>, <span class="hljs-attr">absolute</span>: <span class="hljs-literal">true</span> });

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> f <span class="hljs-keyword">of</span> files) {
    <span class="hljs-keyword">if</span> (excludes.<span class="hljs-title function_">some</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> item.<span class="hljs-title function_">test</span>(f))) {
      <span class="hljs-keyword">continue</span>;
    }
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">transformFile</span>(f);
  }
  <span class="hljs-keyword">await</span> <span class="hljs-title function_">flushDict</span>();
})().<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(err);
  process.<span class="hljs-title function_">exit</span>(<span class="hljs-number">1</span>);
});
</code></pre>
<h3 data-id="heading-5">对i18n依赖的处理</h3>
<p>对未引入i18n相关依赖的文件增加依赖引入</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">ensureUseTranslationImport</span>(<span class="hljs-params">program</span>) {
  <span class="hljs-keyword">let</span> hasNamed = <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> n <span class="hljs-keyword">of</span> program.<span class="hljs-property">body</span>) {
    <span class="hljs-keyword">if</span> (t.<span class="hljs-title function_">isImportDeclaration</span>(n) &amp;&amp; n.<span class="hljs-property">source</span>.<span class="hljs-property">value</span> === <span class="hljs-string">'react-i18next'</span>) {
      <span class="hljs-keyword">if</span> (n.<span class="hljs-property">specifiers</span>.<span class="hljs-title function_">some</span>(<span class="hljs-function">(<span class="hljs-params">s</span>) =&gt;</span> t.<span class="hljs-title function_">isImportSpecifier</span>(s) &amp;&amp; t.<span class="hljs-title function_">isIdentifier</span>(s.<span class="hljs-property">imported</span>, { <span class="hljs-attr">name</span>: <span class="hljs-string">'useTranslation'</span> })))
        hasNamed = <span class="hljs-literal">true</span>;
    }
  }
  <span class="hljs-keyword">if</span> (hasNamed) <span class="hljs-keyword">return</span>;
  program.<span class="hljs-property">body</span>.<span class="hljs-title function_">unshift</span>(
    t.importDeclaration(
      [t.importSpecifier(t.<span class="hljs-title function_">identifier</span>(<span class="hljs-string">'useTranslation'</span>), t.<span class="hljs-title function_">identifier</span>(<span class="hljs-string">'useTranslation'</span>))],
      t.<span class="hljs-title function_">stringLiteral</span>(<span class="hljs-string">'react-i18next'</span>),
    ),
  );
}
<span class="hljs-keyword">function</span> <span class="hljs-title function_">ensureI18nImport</span>(<span class="hljs-params">program, programPath</span>) {
  <span class="hljs-keyword">if</span> (programPath.<span class="hljs-property">scope</span>.<span class="hljs-title function_">hasBinding</span>(<span class="hljs-string">'i18n'</span>)) <span class="hljs-keyword">return</span>;
  program.<span class="hljs-property">body</span>.<span class="hljs-title function_">unshift</span>(
    t.importDeclaration([t.importDefaultSpecifier(t.<span class="hljs-title function_">identifier</span>(<span class="hljs-string">'i18n'</span>))], t.<span class="hljs-title function_">stringLiteral</span>(<span class="hljs-variable constant_">I18N_IMPORT</span>)),
  );
}
</code></pre>
<h3 data-id="heading-6">需要排除的场景</h3>
<p>这里排除了一些场景</p>
<ul>
<li>import或require资源中的中文</li>
<li>作为i18n key的中文</li>
<li>对象的中文key</li>
<li>ts类型中的中文</li>
<li>throw error的中文</li>
<li>console的中文</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/* ────── 辅助判断函数（与原脚本一致） ────── */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">isImportSource</span>(<span class="hljs-params">p</span>) {
  <span class="hljs-keyword">return</span> (
    (p.<span class="hljs-property">parent</span>.<span class="hljs-property">type</span> === <span class="hljs-string">'ImportDeclaration'</span> ||
      p.<span class="hljs-property">parent</span>.<span class="hljs-property">type</span> === <span class="hljs-string">'ExportNamedDeclaration'</span> ||
      p.<span class="hljs-property">parent</span>.<span class="hljs-property">type</span> === <span class="hljs-string">'ExportAllDeclaration'</span>) &amp;&amp;
    p.<span class="hljs-property">parent</span>.<span class="hljs-property">source</span> === p.<span class="hljs-property">node</span>
  );
}
<span class="hljs-keyword">function</span> <span class="hljs-title function_">isRequirePath</span>(<span class="hljs-params">p</span>) {
  <span class="hljs-keyword">return</span> (
    p.<span class="hljs-property">parent</span>.<span class="hljs-property">type</span> === <span class="hljs-string">'CallExpression'</span> &amp;&amp;
    p.<span class="hljs-property">parent</span>.<span class="hljs-property">callee</span>.<span class="hljs-property">type</span> === <span class="hljs-string">'Identifier'</span> &amp;&amp;
    p.<span class="hljs-property">parent</span>.<span class="hljs-property">callee</span>.<span class="hljs-property">name</span> === <span class="hljs-string">'require'</span> &amp;&amp;
    p.<span class="hljs-property">parent</span>.<span class="hljs-property">arguments</span>[<span class="hljs-number">0</span>] === p.<span class="hljs-property">node</span>
  );
}
<span class="hljs-keyword">function</span> <span class="hljs-title function_">isDynamicImportArg</span>(<span class="hljs-params">p</span>) {
  <span class="hljs-keyword">return</span> p.<span class="hljs-property">parent</span>.<span class="hljs-property">type</span> === <span class="hljs-string">'CallExpression'</span> &amp;&amp; p.<span class="hljs-property">parent</span>.<span class="hljs-property">callee</span>.<span class="hljs-property">type</span> === <span class="hljs-string">'Import'</span> &amp;&amp; p.<span class="hljs-property">parent</span>.<span class="hljs-property">arguments</span>[<span class="hljs-number">0</span>] === p.<span class="hljs-property">node</span>;
}
<span class="hljs-keyword">function</span> <span class="hljs-title function_">isI18nKey</span>(<span class="hljs-params">p</span>) {
  <span class="hljs-keyword">if</span> (p.<span class="hljs-property">parent</span>.<span class="hljs-property">type</span> === <span class="hljs-string">'CallExpression'</span>) {
    <span class="hljs-keyword">if</span> (p.<span class="hljs-property">parent</span>.<span class="hljs-property">callee</span>.<span class="hljs-property">type</span> === <span class="hljs-string">'MemberExpression'</span>) {
      <span class="hljs-keyword">return</span> p.<span class="hljs-property">parent</span>.<span class="hljs-property">callee</span>.<span class="hljs-property">property</span>?.<span class="hljs-property">name</span> === <span class="hljs-string">'t'</span>;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (p.<span class="hljs-property">parent</span>.<span class="hljs-property">callee</span>.<span class="hljs-property">type</span> === <span class="hljs-string">'Identifier'</span>) {
      <span class="hljs-keyword">return</span> p.<span class="hljs-property">parent</span>.<span class="hljs-property">callee</span>.<span class="hljs-property">name</span> === <span class="hljs-string">'t'</span>;
    }
  }
  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
}
<span class="hljs-keyword">function</span> <span class="hljs-title function_">isObjectKey</span>(<span class="hljs-params">p</span>) {
  <span class="hljs-keyword">return</span> p.<span class="hljs-property">parent</span>.<span class="hljs-property">type</span> === <span class="hljs-string">'ObjectProperty'</span> &amp;&amp; p.<span class="hljs-property">parent</span>.<span class="hljs-property">key</span> === p.<span class="hljs-property">node</span> &amp;&amp; !p.<span class="hljs-property">parent</span>.<span class="hljs-property">computed</span>;
}
<span class="hljs-keyword">function</span> <span class="hljs-title function_">isInTypePosition</span>(<span class="hljs-params">p</span>) {
  <span class="hljs-keyword">return</span> !!p.<span class="hljs-title function_">findParent</span>(
    <span class="hljs-function">(<span class="hljs-params">pp</span>) =&gt;</span> pp.<span class="hljs-title function_">isTSType</span>() || pp.<span class="hljs-property">isTSLiteralType</span>?.() || pp.<span class="hljs-property">isTSImportType</span>?.() || pp.<span class="hljs-property">isTSTypeAnnotation</span>?.(),
  );
}
<span class="hljs-keyword">function</span> <span class="hljs-title function_">isThrowError</span>(<span class="hljs-params">p</span>) {
  <span class="hljs-keyword">return</span> p.<span class="hljs-property">parent</span>.<span class="hljs-property">type</span> === <span class="hljs-string">'ThrowStatement'</span> || (p.<span class="hljs-property">parent</span>.<span class="hljs-property">type</span> === <span class="hljs-string">'NewExpression'</span> &amp;&amp; p.<span class="hljs-property">parent</span>.<span class="hljs-property">callee</span>.<span class="hljs-property">name</span> === <span class="hljs-string">'Error'</span>);
}
<span class="hljs-keyword">function</span> <span class="hljs-title function_">isConsoleArg</span>(<span class="hljs-params">p</span>) {
  <span class="hljs-keyword">const</span> parent = p.<span class="hljs-property">parent</span>;
  <span class="hljs-keyword">if</span> (!parent) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">if</span> (parent.<span class="hljs-property">type</span> !== <span class="hljs-string">'CallExpression'</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">const</span> args = parent.<span class="hljs-property">arguments</span> || [];
  <span class="hljs-keyword">if</span> (args.<span class="hljs-title function_">indexOf</span>(p.<span class="hljs-property">node</span>) === -<span class="hljs-number">1</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">const</span> c = parent.<span class="hljs-property">callee</span>;
  <span class="hljs-keyword">if</span> (t.<span class="hljs-title function_">isMemberExpression</span>(c) &amp;&amp; t.<span class="hljs-title function_">isIdentifier</span>(c.<span class="hljs-property">object</span>, { <span class="hljs-attr">name</span>: <span class="hljs-string">'console'</span> })) {
    <span class="hljs-keyword">const</span> prop = t.<span class="hljs-title function_">isIdentifier</span>(c.<span class="hljs-property">property</span>) ? c.<span class="hljs-property">property</span>.<span class="hljs-property">name</span> : t.<span class="hljs-title function_">isStringLiteral</span>(c.<span class="hljs-property">property</span>) ? c.<span class="hljs-property">property</span>.<span class="hljs-property">value</span> : <span class="hljs-string">''</span>;
    <span class="hljs-keyword">return</span> [<span class="hljs-string">'log'</span>, <span class="hljs-string">'error'</span>, <span class="hljs-string">'warn'</span>, <span class="hljs-string">'info'</span>, <span class="hljs-string">'debug'</span>].<span class="hljs-title function_">includes</span>(prop);
  }
  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2025：AI炒作巅峰，2026：价值回归与实用落地之年]]></title>    <link>https://juejin.cn/post/7588093282531917876</link>    <guid>https://juejin.cn/post/7588093282531917876</guid>    <pubDate>2025-12-28T14:26:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588093282531917876" data-draft-id="7588680081326784554" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="2025：AI炒作巅峰，2026：价值回归与实用落地之年"/> <meta itemprop="keywords" content="Agent"/> <meta itemprop="datePublished" content="2025-12-28T14:26:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="天行无忌"/> <meta itemprop="url" content="https://juejin.cn/user/4406498333033918"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            2025：AI炒作巅峰，2026：价值回归与实用落地之年
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4406498333033918/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    天行无忌
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-28T14:26:28.000Z" title="Sun Dec 28 2025 14:26:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/40569aae7d2644579a4acfd0f8e4a8ad~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSp6KGM5peg5b-M:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767536788&amp;x-signature=s%2FAczVB2gFOH2qFa2lUEyGYSbgk%3D" alt="2026-ai.jpg" loading="lazy"/></p>
<p>过去几年，我们目睹了演示中天花乱坠的承诺与实际生产可行方案之间的差距逐月拉大。在深入研究斯坦福HAI、麻省理工学院、高盛、红杉资本等机构的报告，以及一线从业者的大量讨论后，一个趋势逐渐清晰：2026年将是“实用落地兑现”的时刻。</p>
<p>核心问题已从“人工智能能否实现？”转向“效果如何、成本多少、为谁服务？”</p>
<p>基于硬性数据、专家分析以及营销材料鲜少提及的隐忧，以下是关于明年AI领域实际走向的 8 个预测。</p>
<h3 data-id="heading-0">1. AI泡沫将缓慢泄气，而非骤然破裂</h3>
<p>红杉资本进行过一项残酷的核算：AI企业需要约6000亿美元的年收入才能支撑当前的基础设施投入，而实际产业收入仅1000亿美元左右。投入产出之间存在高达6倍的落差。</p>
<p>OpenAI预计到2025年末营收将达200亿美元，但同期亏损可能高达120亿美元。《财富》杂志查阅的财务文件显示，其盈利时间点可能推迟到2029年甚至2030年。</p>
<p>曾精准预测2008年金融危机的投资者迈克尔·贝瑞，目前正做空AI领域，持有Palantir和英伟达的看跌期权。他的核心论点是：当前繁荣由“供应端狂热”和可疑的会计操作驱动，并将英伟达比作“这个时代的思科”——后者在互联网泡沫破裂后股价暴跌超80%。</p>
<p>即便行业内部也已感到不安。Lyft首席执行官大卫·瑞舍坦言：“我们必须清醒，当前确实处于金融泡沫之中。”</p>
<blockquote>
<p>但微妙之处在于：斯坦福HAI专家预测，泡沫不会剧烈破裂，而是会“停止膨胀”。想象一场缓慢的通货紧缩，而非惊人的爆裂。资金将收紧，初创企业举步维艰，但巨头们得以存活。</p>
</blockquote>
<h3 data-id="heading-1">2. 95%的AI项目将继续失败（但那5%将彻底改变游戏规则）</h3>
<p>AI项目的失败率令人震惊。麻省理工学院2025年研究显示，95%的企业报告其300-400亿美元的企业AI投资回报为零。</p>
<blockquote>
<p>这不是笔误。<strong>95%的项目，零回报</strong>。</p>
</blockquote>
<p>然而关键在于：那 5% 的成功者实现了巨大收益。获得正向回报的企业，平均每投入1美元可获得3.70美元回报。顶尖企业更是达到 <strong>1:10.30</strong>。</p>
<p>差距并非源于技术，而在于实施路径。</p>
<p>成功者拥有共同模式：聚焦具体、边界清晰的问题，而非追求“万物皆AI”；在选模型前优先投入数据质量建设；并将AI项目视为组织变革，而非单纯技术部署。</p>
<p>正如麻省理工学院报告所指出的：“生成式AI的失败往往不在实验室，而在企业落地时——当它遭遇目标模糊、数据低质与组织惰性三重阻碍。”</p>
<blockquote>
<p>2026年的预测是：失败率依然高企，但成功者的示范效应将无法忽视。</p>
</blockquote>
<h3 data-id="heading-2">3. AI智能体将无处不在（但实际远未达到自主运行）</h3>
<p>Gartner预测，到2026年底，40%的企业应用将搭载AI智能体，较2025年的不足5%大幅跃升。所有供应商都将谈论智能体，每款产品都会宣称具备此功能。</p>
<p>但现实是：</p>
<p>METR的任务时长基准测试显示，到2026年4月，智能体仅能以50%的可靠性完成耗时4小时的任务（人类同等时长可完成）。这还只是针对简单任务，而非持续多日的自主项目。</p>
<p>OpenAI联合创始人安德烈·卡帕西直言不讳。他将当前智能体的输出称为“粗糙的半成品”，并表示它们“目前根本行不通”，因其模态支持不足、缺乏上下文记忆且无法有效规划。</p>
<p>他的判断是：“智能体时代将持续十年，而非一蹴而就。”</p>
<p>Gartner 在预测中亦隐晦指出另一困境：到2027年底，超过40%的智能体项目将因成本过高、价值不明或风险失控而被取消。</p>
<blockquote>
<p>2026年的现实是：智能体将充斥于演示和营销中，但在生产环境中真正稳健运行的寥寥无几。专注于狭窄工作流的任务型代理会取得成功，而无需监督、持续多日的自主项目？仍是科幻范畴。</p>
</blockquote>
<h3 data-id="heading-3">4. 开源将缩小技术差距，但面临生存性资金危机</h3>
<p>开源与闭源模型之间的能力差距已急剧缩小。CB Insights分析显示，2024年1月至2025年2月，双方在Chatbot Arena基准测试中的差距从8.04%缩小至仅1.70%。</p>
<p>开源模型现已“常规性达到闭源模型90%甚至更高的性能”，而运营成本最多可降低84%。</p>
<p>DeepSeek在2025年初震撼业界，仅以不足600万美元成本训练出媲美OpenAI o1的模型，而非耗费数亿美元，其训练效率据称比美国竞争对手预期高出45倍。正如一位网友所言：“算力护城河正在瓦解。”</p>
<p><strong>但问题在于：资金。</strong></p>
<p>自2020年以来，开源AI开发者累计融资149亿美元，而闭源领军企业则筹集了375亿美元。尽管成本相近，开源模式却难以创收。</p>
<p>戏剧性转折是：连Meta都在动摇。彭博社报道称Meta已转向闭源模型开发，其新款“Avocado”模型预计2026年第一季度面世，而Meta超级智能实验室现由闭源倡导者领导。</p>
<blockquote>
<p>2026年预测：开源模型能力足以满足大多数企业需求，但资金危机会引发行业整合，主流厂商可能减少真正开源版本的发布。</p>
</blockquote>
<h3 data-id="heading-4">5. AI编程工具将处理20%的工作流（但开发者不会被取代）</h3>
<p>根据2025年Stack Overflow开发者调查，65%的开发者现在至少每周使用AI编程工具。GitHub Copilot年收入超20亿美元，Cursor估值达90亿美元。技术普及已成现实。</p>
<p>但来看看生产力的真实情况：</p>
<p>METR对经验丰富的开源开发者进行随机对照试验发现：使用AI的开发者效率反而降低了19%。而关键的是，他们自认为效率提升了20%。</p>
<p>认知与现实之间存在高达39个百分点的差距。</p>
<p>Anthropic宣称Claude 4.5 Sonnet能够自主编程超过30小时且性能不显著下降。但如VentureBeat所指出的，最糟糕的体验是“接受充满漏洞的多文件代码更新，然后浪费时间调试那些‘看起来很美’的代码。”</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fbuilder.io%2F" target="_blank" title="https://builder.io/" ref="nofollow noopener noreferrer">Builder.io</a>的分析指出，当前工具（如Cursor和Windsurf）尚未实现真正的智能体循环：“真正的智能体应能尝试方案、评估效果、迭代直至验证正确。现有工具仅停留在生成代码层面。”</p>
<blockquote>
<p>2026年预测：AI编程工具将成为行业准入门槛，但行业分析显示，仅约20%的编码工作流将由智能体处理，其余80%仍需经验丰富的工程师进行架构决策、调试复杂问题，并核查AI是否引入了安全隐患。</p>
</blockquote>
<h3 data-id="heading-5">6. 小型语言模型将成为潜力黑马</h3>
<p>当所有人痴迷于GPT-6和Claude 5时，真正的变革或许正在规模谱系的另一端悄然发生。</p>
<p>《哈佛商业评论》指出：“‘小型’与‘性能强大’之间的鸿沟已基本弥合。”</p>
<p>数据印证了趋势：</p>
<ul>
<li>超过20亿台智能手机已运行本地小语言模型</li>
<li>4位量化模型仅需4GB内存即可保留95%以上性能</li>
<li>75%的企业AI部署采用本地SLM处理敏感数据</li>
<li>2025年小型语言模型使AI产业碳排放减少40%</li>
</ul>
<p>像Phi-4（140亿参数）这样的模型在数学能力上超越了规模是其十倍的模型。Gemma 3以128K上下文窗口实现多模态。Qwen 2.5 VL 70亿参数版在文档理解任务上可与GPT-4o抗衡。</p>
<p>其重要性在于：数据主权与成本控制。</p>
<p>本地部署意味着敏感数据无需离开企业。单次查询推理成本从数美元降至不足一美分，响应时间从秒级缩至毫秒级。</p>
<blockquote>
<p>2026年预测：企业将日益采用混合模式——多数任务由小型本地模型处理，最棘手难题才交由前沿大模型。“越大越好”的论调将出现裂痕。</p>
</blockquote>
<h3 data-id="heading-6">7. AI初创企业“大灭绝”事件拉开序幕</h3>
<p>做好准备：行业分析显示，99%的AI初创企业将在2026年前倒闭或被并购。</p>
<p>算法很残酷。那些在2021至2023年融资热潮中获得资金的公司，通常有18至36个月的运营缓冲期。现在，缓冲期即将耗尽。</p>
<p>Insight Partners分析指出，2026年将成为许多初创企业首次面临真实续约周期的一年。若增长大幅放缓，年收入从零飙升至600-800万美元的公司可能一夜之间丧失融资能力。</p>
<p>与此同时，科技巨头正积极收购。Alphabet以320亿美元收购Wiz。Meta以约140亿美元收购Scale AI 49%的股份。普华永道2026年展望显示，AI企业的收购估值达到营收的24倍，而传统软件企业仅为12倍。</p>
<p>趋势显而易见：AI价值正加速向少数能承担基础设施成本并消化亏损的行业巨头集中。</p>
<p>能存活下来的企业需具备：</p>
<ul>
<li>真正的护城河（独特数据、渠道网络或专业专长）</li>
<li>经得起验证的企业投资回报率（不仅是炫酷演示）</li>
<li>聚焦基础设施层，而非拥挤的应用层</li>
</ul>
<blockquote>
<p>2026年预测：AI初创企业生态将大幅收缩，绝大部分价值创造流向科技巨头。幸存者将是高度专业化或深度融入企业工作流的公司。</p>
</blockquote>
<h3 data-id="heading-7">8. 模型专业化将击败通用型方案</h3>
<p>这一趋势已酝酿多时，到2026年将变得不容置疑：针对特定任务，专业模型的表现将超越通用模型。</p>
<p>正如某行业分析所言：“‘一个模型应付所有任务’的时代即将终结，‘多个模型各展所长’的时代正在开启。”</p>
<p>看看GPT-5的实际架构就明白了：它包含一个高速高吞吐量模型、一个深层推理模型，以及一个根据查询实时调度模型的路由器。这并非单一模型，而是由专门化组件构成的系统。</p>
<p>企业领域正在显现的模式是：</p>
<ul>
<li>经过微调的模型在特定领域任务上的准确率提升了37%</li>
<li>普华永道预测，到2027年75%的企业AI系统将集成经过微调的LLM</li>
<li>多模型路由（先用廉价模型，必要时升级）成为行业标准</li>
</ul>
<p>特定领域实例已经存在：金融领域的BloombergGPT、医疗领域的Med-PaLM、法律领域的ChatLAW。这些专业模型在其领域内表现优于通用模型。</p>
<blockquote>
<p>2026年预测：企业不再问“我们应该用哪个模型？”，而是开始问“我们应该如何编排模型组合？”单一模型时代正被多模型时代取代。</p>
</blockquote>
<p>参考：medium.com/ai-in-plain-english/10-ai-predictions-for-2026-the-year-everything-gets-real-9fea465a036e?source=home_for_you---------23-98--------------------91a3b4d8_4915_466a_9884_c82ebacaf9fb-------15-------</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[年底赶工必备：分享3个可以一键美化Excel表格的AI神器，打工人必备！（建议收藏）]]></title>    <link>https://juejin.cn/post/7588098335791661056</link>    <guid>https://juejin.cn/post/7588098335791661056</guid>    <pubDate>2025-12-28T14:29:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588098335791661056" data-draft-id="7588124225703133224" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="年底赶工必备：分享3个可以一键美化Excel表格的AI神器，打工人必备！（建议收藏）"/> <meta itemprop="keywords" content="AIGC"/> <meta itemprop="datePublished" content="2025-12-28T14:29:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员X小鹿"/> <meta itemprop="url" content="https://juejin.cn/user/2928754709505608"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            年底赶工必备：分享3个可以一键美化Excel表格的AI神器，打工人必备！（建议收藏）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2928754709505608/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员X小鹿
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-28T14:29:55.000Z" title="Sun Dec 28 2025 14:29:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是X小鹿。又到了一年要赶年终汇报的时候。做汇报，必然少不了要插入一些数据做支撑。</p>
<p>但如果就这么直接把 Excel 表格中的数据，粘贴到 PPT 中，那汇报效果肯定大打折扣。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/52e6da7890e44b59ba9467b63e10f51b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGYWOWwj-m5vw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767536995&amp;x-signature=css32ieFycdpPJIwKDBW1Xs%2Fp%2Fk%3D" alt="图片" loading="lazy"/></p>
<p>今天分享 3 个可以<code>一键美化 Excel 表格数据</code>的 AI 工具。不说瞬间让你的汇报提升一个档次，但至少不会再让它拖后腿了!</p>
<p>比如下面这些，都是将 Excel 表格的数据，直接粘贴到这些 AI 工具中，之后一键生成的：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e9985d505930412e9b0d0fda0d3253b8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGYWOWwj-m5vw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767536995&amp;x-signature=SbH9a5YTtW9fqBFq%2FpCpTIFeV58%3D" alt="图片" loading="lazy"/></p>
<p>就很方便。一起来看看吧。</p>
<h2 data-id="heading-0">一、Seede AI</h2>
<p>第一个，Seede AI，一款适合普通人上手的 AI 设计工具。（国内可用）</p>
<p>也是X小鹿一直在用的一款 AI 工具，尤其是它在接入了谷歌的 Gemini 3 Pro / Gemini 3 Flash 之后，出图效果更强了。</p>
<p>最近发现它还能一键优化 Excel 表格数据，尝试了下，效果还不错。正好年终了，大家都在赶年终汇报，可能用得上，分享给大家。</p>
<p><strong>Seede</strong> <strong>AI</strong> <strong>网址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fseede.ai%2F" target="_blank" title="https://seede.ai/" ref="nofollow noopener noreferrer">seede.ai/</a></p>
<p>ps：Seede AI 目前每天都有免费使用次数。（注册时邀请码填 A34LNT，还可以额外获得一些使用次数）</p>
<p>打开 Seede AI 后，类型选<code>社交媒体图文</code>，然后在下面的输入框中输入提示词。</p>
<p>提示词：<code>优化数据表，保持原有数据准确和完整：[粘贴 Excel 表格的数据]</code></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/68c336cf30c04688b04c1c081d6232ee~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGYWOWwj-m5vw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767536995&amp;x-signature=Xj2jh9w5MfTwmEy65dga0kfNLAA%3D" alt="图片" loading="lazy"/></p>
<p>这块虽然粘贴过来格式乱了，但是没有关系，不影响。</p>
<p>然后根据你的需求，设置<code>尺寸</code>、<code>配色</code>、<code>风格</code>、<code>模型</code>和<code>个数</code>，然后点生成就可以了。</p>
<p>这里模型我们使用的是 Gemini 3 Pro。（目前来说效果是最好的）</p>
<p>下面是使用 Seede AI 优化后的表格数据：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d28a9665173e4a11bdbca58202aa45e0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGYWOWwj-m5vw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767536995&amp;x-signature=kxib8ZCy3ZoSVsXRIA2fWDRObPY%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/25d9f0dd8965488081fb0dc8dd4ba57a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGYWOWwj-m5vw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767536995&amp;x-signature=GRSUAB8SfsPA%2BrUEBzloKJljfgU%3D" alt="图片" loading="lazy"/></p>
<p>效果还是不错的，直接拿去用也完全没有问题。</p>
<p>当然如果对某些地方生成的不满意，Seede AI 也支持再次编辑：</p>
<p>画面上所有元素，包括<code>文字</code>、<code>数据</code>、<code>小图标</code>等等，都是可以修改的。</p>
<p>这也是 Seede AI 比较方便的一点。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9724742b391b4f4cb857da7ae17c96c5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGYWOWwj-m5vw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767536995&amp;x-signature=3GMq76TmL73VlEWYlB8pRqRDEGQ%3D" alt="图片" loading="lazy"/></p>
<p>关于 Seede AI 的更多用法，可以看之前写的这篇文章：</p>
<p><a href="https://juejin.cn/post/7577958825342795795" target="_blank" title="https://juejin.cn/post/7577958825342795795">这款AI工具太惊喜了！1分钟生成精美长图，自由编辑像PPT！还免费可用！（附保姆级教程）</a></p>
<h2 data-id="heading-1">二、Lovart</h2>
<p>第二个，Lovart，全球首个设计智能体。</p>
<p><strong>Lovart 网址</strong>：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.lovart.ai%2F" target="_blank" title="https://www.lovart.ai/" ref="nofollow noopener noreferrer">www.lovart.ai/</a></p>
<p>打开后，输入同样的提示词，模型这里我们选择<code>Nano Banana Pro</code>，然后就可以等待生成了。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bd8488a158c5447194cef877e65d2fb5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGYWOWwj-m5vw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767536995&amp;x-signature=wd6gN%2FtFOILlMKy08pbsOTeE9rc%3D" alt="图片" loading="lazy"/></p>
<p>Lovart 第一版生成的表格样式比较简单，如果不满意，我们可以继续在右侧和 Lovart 对话。</p>
<p>比如<code>再优化高级一点</code>、<code>再增加一些科技感</code>等等。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b1fb1a67d22e45a3b4aec46446436211~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGYWOWwj-m5vw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767536995&amp;x-signature=kQNlTouLPjfHaxVFJLNrSsyGeVs%3D" alt="图片" loading="lazy"/></p>
<p>生成的图片，也是可以继续编辑的：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a1210ace2786461da81bcd88f26f106d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGYWOWwj-m5vw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767536995&amp;x-signature=c2DLD%2BDnqJtsXYe9hWchxyPvFqE%3D" alt="图片" loading="lazy"/></p>
<p>具体用法，可以看之前写的这篇文章：</p>
<p><a href="https://juejin.cn/post/7572749797468831753" target="_blank" title="https://juejin.cn/post/7572749797468831753">用了这个更厉害的P图AI，我把PS卸了！文字也能无痕修改！1秒救废图（附保姆级教程）</a></p>
<h2 data-id="heading-2">三、Napkin</h2>
<p>第三个，Napkin，一款 AI 驱动的文本视觉化工具。</p>
<p><strong>Napkin 网址：</strong></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.napkin.ai%2F" target="_blank" title="https://www.napkin.ai/" ref="nofollow noopener noreferrer">www.napkin.ai/</a></p>
<p>打开 Napkin 后，粘贴 Excel 表格的数据，然后点左侧的按钮。（左图）</p>
<p>在分类里，点表格，会看到有各种表格样式，选择合适的风格点生成就可以了。（右图）</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ecdbf26d0bc74b1c97b788a60246be2e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGYWOWwj-m5vw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767536995&amp;x-signature=pFgNF4Byden44hCxDDpZLl4Rpxc%3D" alt="图片" loading="lazy"/></p>
<p>比如下面就是用 Napkin 美化后的表格数据：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9e3a93f79d9841acb65670869b9f693e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGYWOWwj-m5vw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767536995&amp;x-signature=EXxJbYDM%2F44t7HPSP%2BvLK53o35I%3D" alt="图片" loading="lazy"/></p>
<p>相比于 Seede AI 和 Lovart，Napkin 生成的表格样式比较简单朴素，喜欢这种风格的可以试试 Napkin。</p>
<p>另外，Napkin 美化后的表格，也是可以<code>再次编辑</code>的。</p>
<p>包括文本、数据、小图标、颜色等，都可以继续编辑。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/440f461bd70b4fcbadb69086d3c327ad~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGYWOWwj-m5vw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767536995&amp;x-signature=QrszhLjmyBei2JGbcZJNO89IusY%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-3">四、写在最后</h2>
<p>最后来总结一下吧。</p>
<p>以上三个 AI 工具都可以一键美化 Excel 表格的数据。</p>
<p>其中 Seede AI 和 Lovart 可以自己选生图模型，生成的表格样式比较丰富。</p>
<p>Napkin 是提供了几种固定的表格样式供我们选择，样式很简洁。喜欢简洁风的可以考虑 Napkin。</p>
<p>三个 AI 工具，都支持对美化后的表格继续编辑，比如修改文字、数据等，都是可以的。</p>
<p>以上就是今天的分享，有需要的可以尝试一下。</p>
<hr/>
<blockquote>
<p>我是<a href="https://juejin.cn/user/2928754709505608/posts" title="https://juejin.cn/user/2928754709505608/posts" target="_blank">程序员X小鹿</a>，前互联网大厂程序员，也是一名 AIGC 爱好者，持续分享更多好用的 AI 工具，欢迎一起交流~</p>
</blockquote>
<p><strong>推荐阅读</strong></p>
<p><a href="https://juejin.cn/post/7454501732203610131" title="https://juejin.cn/post/7454501732203610131" target="_blank">2024年终AI工具汇总：9大AI领域，70+精选AI工具，全都在这了！(建议收藏)</a></p>
<p>更多 AI 工具见<a href="https://juejin.cn/column/7284164153576947724" title="https://juejin.cn/column/7284164153576947724" target="_blank">【AI工具】</a>专栏，持续更新中。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Claude Code Plan 模式完全指南：从入门到精通]]></title>    <link>https://juejin.cn/post/7588411503120875556</link>    <guid>https://juejin.cn/post/7588411503120875556</guid>    <pubDate>2025-12-28T14:40:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588411503120875556" data-draft-id="7588191506607521798" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Claude Code Plan 模式完全指南：从入门到精通"/> <meta itemprop="keywords" content="AI编程,Claude"/> <meta itemprop="datePublished" content="2025-12-28T14:40:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="土豆1250"/> <meta itemprop="url" content="https://juejin.cn/user/3280598428302727"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Claude Code Plan 模式完全指南：从入门到精通
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3280598428302727/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    土豆1250
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-28T14:40:58.000Z" title="Sun Dec 28 2025 14:40:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是<a href="https://juejin.cn/user/3280598428302727" target="_blank" title="https://juejin.cn/user/3280598428302727">土豆</a>，欢迎关注我的<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2Fl5jMBooF6wcjavD8EYISYQ" target="_blank" title="https://mp.weixin.qq.com/s/l5jMBooF6wcjavD8EYISYQ" ref="nofollow noopener noreferrer">公众号：土豆学前端</a></p>
<blockquote>
<p>"先谋而后动，则百战不殆" —— 这不仅是古人的智慧，也是现代 AI 编程的黄金法则</p>
</blockquote>
<h2 data-id="heading-0">引言：你是否遇到过这些尴尬瞬间？</h2>
<p>想象一下这个场景：你兴冲冲地让 Claude Code 帮你重构一个复杂模块，结果它开始疯狂修改文件，十分钟后你发现：</p>
<ul>
<li>❌ 改了不该改的文件</li>
<li>❌ 遗漏了关键的依赖更新</li>
<li>❌ 破坏了现有的测试用例</li>
<li>❌ 你的 Git diff 已经一塌糊涂</li>
</ul>
<p>此时你的心情大概就像：😱 → 😰 → 😭</p>
<p><strong>好消息是</strong>：Claude Code 的 Plan 模式（计划模式）就是为了解决这些问题而生的！它就像给你的 AI 助手装上了"三思而后行"的大脑。</p>
<hr/>
<h2 data-id="heading-1">Why - 为什么需要 Plan 模式？</h2>
<h3 data-id="heading-2">🎯 核心理念：Planning is Prompting</h3>
<p>资深工程师和初级程序员的最大区别是什么？不是代码技巧，而是<strong>规划能力</strong>。</p>
<p>优秀的工程师在动手之前会：</p>
<ol>
<li><strong>充分调研</strong>现有代码结构</li>
<li><strong>全面分析</strong>影响范围</li>
<li><strong>制定方案</strong>并考虑边界情况</li>
<li><strong>评估风险</strong>和实施成本</li>
</ol>
<p>Plan 模式将这个思维过程标准化了——它让 AI 也遵循"计划-执行-验证"的黄金流程。</p>
<h3 data-id="heading-3">🚨 不用 Plan 模式的常见悲剧</h3>






























<table><thead><tr><th>场景</th><th>不用 Plan 模式</th><th>使用 Plan 模式</th></tr></thead><tbody><tr><td><strong>大规模重构</strong></td><td>改了 20 个文件，发现方向错了</td><td>提前看到完整影响范围，及时调整</td></tr><tr><td><strong>疑难 Bug</strong></td><td>修好 Bug A，引入 Bug B</td><td>全面分析后一次性解决</td></tr><tr><td><strong>复杂需求</strong></td><td>来回修改，浪费大量 token</td><td>一次规划到位，执行高效</td></tr><tr><td><strong>多文件改动</strong></td><td>遗漏关键文件，导致运行错误</td><td>清单式管理，不遗漏任何步骤</td></tr></tbody></table>
<h3 data-id="heading-4">💡 Plan 模式的三大价值</h3>
<ol>
<li>
<p><strong>安全性</strong> 🛡️<br/>
只读模式，不会意外修改任何文件（就像给 Claude 戴上了"只能动嘴不能动手"的魔法手铐）</p>
</li>
<li>
<p><strong>可控性</strong> 🎮<br/>
你可以审查、修改、迭代计划，直到满意再执行</p>
</li>
<li>
<p><strong>效率性</strong> ⚡<br/>
虽然多了一个规划步骤，但避免了大量返工，整体效率反而更高</p>
</li>
</ol>
<hr/>
<h2 data-id="heading-5">What - Plan 模式到底是什么？</h2>
<h3 data-id="heading-6">🔑 一句话定义</h3>
<p>Plan 模式是 Claude Code 的特殊操作模式，它创建了一个只读的研究和规划阶段，在做任何代码更改之前先分析和规划。</p>
<h3 data-id="heading-7">🛠️ Plan 模式的工作机制</h3>
<p>当你激活 Plan 模式后，Claude 的能力会被限制为：</p>
<p><strong>✅ 允许使用的工具（只读工具）：</strong></p>
<ul>
<li><code>read</code> - 查看文件内容</li>
<li><code>ls</code> - 列出目录结构</li>
<li><code>glob</code> - 文件模式搜索</li>
<li><code>grep</code> - 内容搜索</li>
<li><code>task</code> - 创建研究子任务</li>
<li><code>web_fetch</code> / <code>web_search</code> - 网络搜索</li>
</ul>
<p><strong>❌ 禁止使用的工具（写入工具）：</strong></p>
<ul>
<li><code>edit</code> / <code>multi_edit</code> - 编辑文件</li>
<li><code>write</code> - 创建文件</li>
<li><code>bash</code> - 执行命令</li>
<li>其他任何会修改状态的工具</li>
</ul>
<h3 data-id="heading-8">🎭 Plan 模式 vs 普通模式</h3>
<pre><code class="hljs">普通模式：
用户提问 → Claude 直接修改代码 → 出现问题 → 回滚重来

Plan 模式：
用户提问 → Claude 研究分析 → 生成计划 → 用户审查 
→ 修改计划（可选）→ 批准 → 执行 → 完成
</code></pre>
<p>就像是从"野蛮生长"进化到"精细化管理"！</p>
<hr/>
<h2 data-id="heading-9">How - 如何高效使用 Plan 模式？</h2>
<h3 data-id="heading-10">🚀 快速入门：一分钟上手</h3>
<h4 data-id="heading-11">Step 1: 激活 Plan 模式</h4>
<p>最简单的方式：按 Shift + Tab 两次</p>
<p>你会看到界面底部显示 <code>Plan Mode</code> 标识，代表已成功激活。</p>
<h4 data-id="heading-12">Step 2: 提出你的需求</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 示例 1：复杂需求实现</span>
<span class="hljs-string">"我要实现一个用户资料功能，包括：
- 新建数据库模型
- 创建 CRUD API 接口  
- 前端展示页面
请先制定实施计划"</span>

<span class="hljs-comment"># 示例 2：疑难 Bug 调查</span>
<span class="hljs-string">"系统在高并发下偶尔出现数据不一致，
帮我分析可能的原因和解决方案"</span>

<span class="hljs-comment"># 示例 3：大规模重构</span>
<span class="hljs-string">"将现有的 REST API 迁移到 GraphQL，
需要评估影响范围和迁移策略"</span>
</code></pre>
<h4 data-id="heading-13">Step 3: 审查和迭代计划</h4>
<p>Claude 会生成一个详细的计划，包括：</p>
<ul>
<li>📋 任务分解</li>
<li>📁 涉及的文件清单</li>
<li>🔗 依赖关系</li>
<li>⚠️ 风险点和注意事项</li>
<li>🧪 测试策略</li>
</ul>
<p>如果计划有问题，继续对话优化：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-string">"第 3 步可能会影响现有的缓存逻辑，需要考虑一下"</span>
<span class="hljs-string">"能否增加对边界情况的处理？"</span>
<span class="hljs-string">"这个方案的性能影响有多大？"</span>
</code></pre>
<h4 data-id="heading-14">Step 4: 批准并执行</h4>
<p>当你满意计划后：</p>
<ul>
<li>👍 <strong>接受自动执行</strong>：让 Claude 自动完成所有修改</li>
<li>✋ <strong>接受手动执行</strong>：你自己按计划逐步实施</li>
<li>🔄 <strong>继续优化</strong>：再讨论和改进计划</li>
</ul>
<h3 data-id="heading-15">🎯 适用场景详解</h3>
<h4 data-id="heading-16">场景 1：疑难 Bug 修复 🐛</h4>
<p><strong>典型痛点：</strong></p>
<ul>
<li>Bug 原因不明确</li>
<li>涉及多个模块</li>
<li>担心修复引入新问题</li>
</ul>
<p><strong>Plan 模式流程：</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 激活 Plan 模式</span>
Shift + Tab × 2

<span class="hljs-comment"># 2. 描述问题（越详细越好）</span>
<span class="hljs-string">"用户反馈在特定条件下（高并发 + 数据库连接池满）
订单状态更新失败，但没有错误日志。
请帮我：
1. 分析可能的根因
2. 定位问题代码
3. 提出修复方案
4. 评估影响范围"</span>

<span class="hljs-comment"># 3. Claude 会进行系统性调查</span>
- 搜索相关代码文件
- 分析调用链路
- 检查错误处理逻辑
- 评估并发安全性

<span class="hljs-comment"># 4. 生成诊断报告和修复计划</span>
包括：根因分析、修复步骤、测试策略、回滚预案
</code></pre>
<p><strong>💡 Pro Tips：</strong></p>
<ul>
<li>使用 <code>@文件名</code> 提供关键文件的上下文</li>
<li>附上错误日志或复现步骤</li>
<li>询问"有哪些可能被忽略的边界情况？"</li>
</ul>
<h4 data-id="heading-17">场景 2：复杂需求实现 🏗️</h4>
<p><strong>典型痛点：</strong></p>
<ul>
<li>需求涉及前后端多个模块</li>
<li>不确定技术选型</li>
<li>担心遗漏关键细节</li>
</ul>
<p><strong>Plan 模式流程：</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 实战案例：实现"多语言支持"功能</span>

<span class="hljs-string">"请帮我规划实现多语言（i18n）支持：
需求：
- 支持中文、英文、日文
- 前端界面文本国际化
- 后端错误消息国际化  
- 用户可切换语言
- 默认语言根据浏览器设置

约束：
- 使用现有的 React + Express 技术栈
- 翻译文件需要支持热更新
- 性能开销要小"</span>

<span class="hljs-comment"># Claude 会输出类似这样的计划：</span>

<span class="hljs-comment">## 实施计划</span>

<span class="hljs-comment">### 阶段 1：技术选型</span>
- 前端：react-i18next
- 后端：i18next + i18next-express-middleware
- 理由：社区支持好、性能优秀、支持热更新

<span class="hljs-comment">### 阶段 2：文件结构设计</span>
</code></pre>
<p>locales/
├── zh-CN/
│   ├── common.json
│   └── errors.json
├── en-US/
└── ja-JP/</p>
<pre><code class="hljs language-markdown" lang="markdown">
<span class="hljs-section">### 阶段 3：实施步骤（共 8 个步骤）</span>
<span class="hljs-bullet">1.</span> 安装依赖包
<span class="hljs-bullet">2.</span> 配置 i18next（前端）
<span class="hljs-bullet">3.</span> 配置 i18next（后端）
...

<span class="hljs-section">### 阶段 4：测试策略</span>
<span class="hljs-bullet">-</span> 单元测试：翻译函数
<span class="hljs-bullet">-</span> 集成测试：语言切换流程
<span class="hljs-bullet">-</span> E2E 测试：完整用户场景

<span class="hljs-section">### 阶段 5：风险评估</span>
⚠️ 可能的坑：
<span class="hljs-bullet">-</span> 日期/货币格式需单独处理
<span class="hljs-bullet">-</span> 动态内容翻译需后端支持
<span class="hljs-bullet">-</span> SEO 需考虑多语言 URL
</code></pre>
<p><strong>审查计划后，你可能会问：</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-string">"能否增加缓存机制来提升性能？"</span>
<span class="hljs-string">"如何处理翻译文件缺失的情况？"</span>
<span class="hljs-string">"这个方案对现有代码的侵入性如何？"</span>
</code></pre>
<h4 data-id="heading-18">场景 3：大规模重构 🔧</h4>
<p><strong>典型痛点：</strong></p>
<ul>
<li>改动范围大，不知从何下手</li>
<li>担心破坏现有功能</li>
<li>团队协作需要清晰的计划</li>
</ul>
<p><strong>Plan 模式是救星！</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 重构案例：从 JavaScript 迁移到 TypeScript</span>

<span class="hljs-string">"我们需要将整个前端项目从 JS 迁移到 TS：
- 约 150 个组件文件
- 使用 React + Redux
- 需要保持现有功能 100% 可用
- 希望分阶段迁移，降低风险

请给出详细的迁移计划"</span>

<span class="hljs-comment"># Claude 的计划可能包括：</span>

<span class="hljs-comment">## TypeScript 迁移计划</span>

<span class="hljs-comment">### 📊 现状分析</span>
- 文件总数：245 个
- JS/JSX 文件：182 个
- 外部依赖：32 个

<span class="hljs-comment">### 🎯 迁移策略：渐进式迁移</span>

<span class="hljs-comment">#### 第一阶段：基础设施（1 周）</span>
- [ ] 安装 TypeScript 和类型定义
- [ ] 配置 tsconfig.json
- [ ] 设置构建流程
- [ ] 配置 ESLint/Prettier

<span class="hljs-comment">#### 第二阶段：核心模块（2-3 周）</span>
- [ ] 类型定义文件（.d.ts）
- [ ] Redux store 和 actions
- [ ] 工具函数
- [ ] 核心组件

<span class="hljs-comment">#### 第三阶段：业务模块（4-6 周）</span>
按依赖关系分批迁移：
- Batch 1: 工具类组件（10 个）
- Batch 2: 展示型组件（50 个）
- Batch 3: 容器组件（30 个）
...

<span class="hljs-comment">### ⚠️ 风险控制</span>
1. 每个阶段完成后运行完整测试套件
2. 保持 JS 和 TS 并存期间的类型安全
3. 关键路径组件优先迁移
4. 准备回滚方案

<span class="hljs-comment">### 📈 成功指标</span>
- [ ] 无运行时类型错误
- [ ] 所有测试通过
- [ ] 构建时间 &lt;5min
- [ ] 类型覆盖率 &gt;90%
</code></pre>
<h3 data-id="heading-19">🎨 最佳实践清单</h3>
<h4 data-id="heading-20">✅ Do's（应该做的）</h4>
<ol>
<li>
<p><strong>充分利用上下文引用</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 使用 @ 符号引用关键文件</span>
<span class="hljs-string">"@components/UserProfile.tsx 这个组件需要重构"</span>
<span class="hljs-string">"@docs/ARCHITECTURE.md 按照这个架构指南来规划"</span>
</code></pre>
</li>
<li>
<p><strong>迭代优化计划</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 不要一次就想着完美</span>
第一轮：理解问题
第二轮：提出初步方案
第三轮：优化细节
第四轮：考虑边界情况
</code></pre>
</li>
<li>
<p><strong>明确约束条件</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 让 Claude 知道你的限制</span>
<span class="hljs-string">"必须保持向后兼容"</span>
<span class="hljs-string">"不能引入新的外部依赖"</span>
<span class="hljs-string">"改动要在 1 天内完成"</span>
<span class="hljs-string">"性能不能下降超过 5%"</span>
</code></pre>
</li>
<li>
<p><strong>保存重要的计划</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 复杂计划应该持久化</span>
<span class="hljs-string">"请将这个计划保存到 docs/REFACTOR_PLAN.md"</span>

<span class="hljs-comment"># 或者手动复制到项目文档</span>
</code></pre>
</li>
<li>
<p><strong>使用自定义命令</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 创建 .claude/plan.md 定义计划模板</span>
<span class="hljs-comment"># 然后用 /plan 快速调用</span>
</code></pre>
</li>
</ol>
<h4 data-id="heading-21">❌ Don'ts（不应该做的）</h4>
<ol>
<li>
<p><strong>简单任务用 Plan 模式</strong> 😅</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 错误示范</span>
<span class="hljs-string">"帮我修改一个变量名"</span> → Plan 模式 ❌

<span class="hljs-comment"># 正确做法</span>
小改动直接让 Claude 执行就行！
</code></pre>
</li>
<li>
<p><strong>不审查就批准</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 这很危险！⚠️</span>
看到计划 → 立即批准 → 出问题后悔

<span class="hljs-comment"># 应该</span>
仔细检查每一步 → 提问质疑 → 确认无误再批准
</code></pre>
</li>
<li>
<p><strong>期望完美的第一版计划</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 不现实的期待</span>
<span class="hljs-string">"一次就给我最完美的方案"</span> ❌

<span class="hljs-comment"># 健康的心态</span>
<span class="hljs-string">"先给个初版，我们慢慢优化"</span> ✅
</code></pre>
</li>
<li>
<p><strong>忘记考虑边界情况</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 记得追问</span>
<span class="hljs-string">"如果数据为空怎么办？"</span>
<span class="hljs-string">"并发情况下会有问题吗？"</span>
<span class="hljs-string">"异常情况如何处理？"</span>
</code></pre>
</li>
<li>
<p><strong>不使用项目文档</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 浪费机会</span>
让 Claude 盲目规划 ❌

<span class="hljs-comment"># 聪明做法</span>
<span class="hljs-string">"先运行 /init 生成 CLAUDE.md"</span>
<span class="hljs-string">"参考 @docs/ARCHITECTURE.md 来规划"</span>
</code></pre>
</li>
</ol>
<h3 data-id="heading-22">🔥 高级技巧</h3>
<h4 data-id="heading-23">技巧 1：多代理协作规划</h4>
<p>对于超大型项目，可以让多个"角色"参与规划：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-string">"创建一个深度研究任务，用以下四个角色分析这个问题：
1. 架构师：评估系统设计
2. 安全专家：识别安全隐患  
3. 性能工程师：分析性能影响
4. 测试工程师：制定测试策略

每个角色给出独立的分析报告"</span>
</code></pre>
<h4 data-id="heading-24">技巧 2：使用语音输入</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 复杂需求用语音更高效</span>
使用 Superwhisper 等工具口述需求
→ AI 转录成文字
→ 直接发给 Claude

优点：
- 表达更自然流畅
- 可以快速传达复杂想法
- 解放双手
</code></pre>
<h4 data-id="heading-25">技巧 3：结合 Web 搜索</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-string">"请先搜索 Tailwind CSS v4 的迁移指南，
然后基于最新的官方文档制定我们的迁移计划"</span>

<span class="hljs-comment"># Claude 会：</span>
1. 搜索最新文档
2. 读取官方指南  
3. 结合你的项目情况制定计划
</code></pre>
<h4 data-id="heading-26">技巧 4：计划版本控制</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 将计划纳入 Git 管理</span>
docs/
  ├── plans/
  │   ├── 2024-01-15-user-auth-refactor.md
  │   ├── 2024-02-03-database-migration.md
  │   └── 2024-03-10-api-v2-design.md

<span class="hljs-comment"># 好处：</span>
- 可追溯决策过程
- 团队成员了解历史背景
- 防止重复劳动
</code></pre>
<h3 data-id="heading-27">🚫 常见误区与避坑指南</h3>
<h4 data-id="heading-28">误区 1："Plan 模式太慢，直接干不是更快？"</h4>
<p><strong>真相：</strong><br/>
小任务确实不需要 Plan 模式，但对于复杂任务：</p>
<pre><code class="hljs">不用 Plan 模式：
开发 2 小时 → 发现方向错误 → 推倒重来 2 小时 
→ 修 Bug 1 小时 → 总计 5 小时 ❌

使用 Plan 模式：
规划 30 分钟 → 审查优化 20 分钟 
→ 执行 1.5 小时 → 总计 2.2 小时 ✅
</code></pre>
<p><strong>节省了一半以上的时间！</strong></p>
<h4 data-id="heading-29">误区 2："计划只是形式，执行时还是会变"</h4>
<p><strong>反驳：</strong><br/>
好的计划不是"一成不变"，而是"有迹可循"：</p>
<ul>
<li>计划是路线图，不是法律条文</li>
<li>可以在执行中灵活调整</li>
<li>但有计划总比盲目乱撞强</li>
</ul>
<h4 data-id="heading-30">误区 3："我是老司机，不需要计划"</h4>
<p><strong>现实打脸：</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 即使是资深工程师也会</span>
- 遗漏边界情况
- 低估复杂度
- 忽视依赖关系

<span class="hljs-comment"># Plan 模式的价值是</span>
让 AI 帮你想到你可能忽略的细节
多一个大脑参与决策总是好的
</code></pre>
<h4 data-id="heading-31">误区 4："计划太详细了，看不过来"</h4>
<p><strong>解决方案：</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 分层次阅读计划</span>
第一遍：快速浏览，了解整体思路
第二遍：重点关注关键步骤
第三遍：检查风险点和边界情况

<span class="hljs-comment"># 或者让 Claude 简化</span>
<span class="hljs-string">"请给我一个执行摘要版本，只包含关键步骤"</span>
</code></pre>
<h3 data-id="heading-32">📊 效果对比：数据说话</h3>
<p>基于社区反馈的统计：</p>









































<table><thead><tr><th>指标</th><th>不用 Plan 模式</th><th>使用 Plan 模式</th><th>提升</th></tr></thead><tbody><tr><td><strong>一次成功率</strong></td><td>45%</td><td>82%</td><td>↑ 82%</td></tr><tr><td><strong>平均返工次数</strong></td><td>2.3 次</td><td>0.6 次</td><td>↓ 74%</td></tr><tr><td><strong>Token 消耗</strong></td><td>较高（频繁试错）</td><td>较低（一次到位）</td><td>↓ 40%</td></tr><tr><td><strong>代码质量</strong></td><td>中等</td><td>较高</td><td>↑ 35%</td></tr><tr><td><strong>团队协作效率</strong></td><td>需多次沟通</td><td>计划即文档</td><td>↑ 60%</td></tr></tbody></table>
<p><em>数据来源：Claude Code 用户社区调研</em></p>
<hr/>
<h2 data-id="heading-33">🎓 进阶话题</h2>
<h3 data-id="heading-34">与其他工具的配合</h3>
<h4 data-id="heading-35">1. VS Code 集成</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 在 VS Code 中</span>
1. 选中代码
2. 使用 /ide 命令
3. 激活 Plan 模式讨论

优点：
- 可视化更直观
- 可以直接看到代码上下文
- 编辑器功能全开
</code></pre>
<h4 data-id="heading-36">2. 与 Git 工作流结合</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 标准流程</span>
1. 创建功能分支
2. Plan 模式规划
3. 保存计划到分支
4. 执行计划
5. 代码审查时对照计划
6. 合并主分支

<span class="hljs-comment"># 使用 Git Worktrees 处理多任务</span>
git worktree add ../feature-a -b feature-a
git worktree add ../feature-b -b feature-b

<span class="hljs-comment"># 每个 worktree 独立运行 Claude Code</span>
<span class="hljs-comment"># 互不干扰，完全隔离</span>
</code></pre>
<h4 data-id="heading-37">3. 持续学习与改进</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 建立"事后诸葛亮"机制</span>
每次项目结束后：
1. 回顾计划 vs 实际
2. 记录意外情况
3. 更新最佳实践
4. 优化下次的规划提示词
</code></pre>
<h3 data-id="heading-38">成本与效率平衡</h3>
<p>Plan 模式虽然消耗更多 token，但：</p>
<pre><code class="hljs language-diff" lang="diff">场景分析：
<span class="hljs-deletion">- 简单 Bug（10 行代码）：不用 Plan 模式 ✓</span>
<span class="hljs-deletion">- 中等功能（50-200 行）：建议用 Plan 模式 ✓✓</span>
<span class="hljs-deletion">- 复杂重构（500+ 行）：必须用 Plan 模式 ✓✓✓</span>

投资回报率：
初期投入（规划）：20-30% 额外 token
长期回报（避免返工）：节省 50-80% 总 token
</code></pre>
<hr/>
<h2 data-id="heading-39">🎯 总结：Plan 模式的本质</h2>
<p>Plan 模式不是一个功能，而是一种<strong>思维方式</strong>的工具化：</p>
<h3 data-id="heading-40">核心价值观</h3>
<ol>
<li>
<p><strong>Think Before You Code</strong>（先思考后编码）</p>
<ul>
<li>不打无准备之仗</li>
<li>计划不是束缚，是自由</li>
</ul>
</li>
<li>
<p><strong>Fail Fast, Fail Cheap</strong>（快速失败，低成本试错）</p>
<ul>
<li>在规划阶段发现问题成本最低</li>
<li>执行阶段返工成本最高</li>
</ul>
</li>
<li>
<p><strong>Communication is Key</strong>（沟通是关键）</p>
<ul>
<li>计划是人机沟通的桥梁</li>
<li>也是团队协作的文档</li>
</ul>
</li>
</ol>
<h3 data-id="heading-41">最后的建议</h3>
<blockquote>
<p><strong>给初学者：</strong><br/>
不要怕麻烦，复杂任务就用 Plan 模式。熟练后你会发现，这是最省时间的方式。</p>
</blockquote>
<blockquote>
<p><strong>给进阶用户：</strong><br/>
探索自定义工作流，将 Plan 模式融入你的开发习惯。让 AI 成为真正的协作伙伴。</p>
</blockquote>
<blockquote>
<p><strong>给团队领导：</strong><br/>
推广 Plan 模式可以显著提升团队效率和代码质量。计划即文档，利于知识沉淀。</p>
</blockquote>
<hr/>
<h2 data-id="heading-42">🚀 行动起来！</h2>
<h3 data-id="heading-43">今天就开始</h3>
<ol>
<li><strong>打开 Claude Code</strong></li>
<li><strong>按下 Shift + Tab 两次</strong></li>
<li><strong>尝试你的第一个计划</strong></li>
</ol>
<p>从一个中等复杂度的任务开始，体验 Plan 模式的魔力！</p>
<h3 data-id="heading-44">学习资源</h3>
<ul>
<li>📚 <a href="https://link.juejin.cn?target=https%3A%2F%2Fcode.claude.com%2Fdocs" title="https://code.claude.com/docs" target="_blank" ref="nofollow noopener noreferrer">Claude Code 官方文档</a></li>
<li>🎥 YouTube 上的实战教程</li>
<li>💬 加入 Discord/Reddit 社区交流</li>
</ul>
<h3 data-id="heading-45">保持成长</h3>
<p>记住：<strong>优秀的工程师不是写代码最快的，而是写对代码最快的。</strong></p>
<p>Plan 模式就是帮你"写对"的秘密武器。</p>
<hr/>
<p><em>愿你的每一次代码变更，都有一个完美的计划！</em> 🎉</p>
<hr/>
<p><strong>附录：快捷操作速查表</strong></p>


















































<table><thead><tr><th>操作</th><th>快捷键/命令</th><th>说明</th></tr></thead><tbody><tr><td>进入 Plan 模式</td><td><code>Shift + Tab × 2</code></td><td>界面显示 "Plan Mode"</td></tr><tr><td>退出 Plan 模式</td><td>Claude 调用 <code>exit_plan_mode</code></td><td>生成计划后自动提示</td></tr><tr><td>引用文件</td><td><code>@filename</code></td><td>提供上下文</td></tr><tr><td>引用目录</td><td><code>@dirname/</code></td><td>包含整个目录</td></tr><tr><td>初始化项目</td><td><code>/init</code></td><td>生成 CLAUDE.md</td></tr><tr><td>继续会话</td><td><code>/resume</code> 或 <code>claude --resume</code></td><td>恢复之前的对话</td></tr><tr><td>创建子任务</td><td>在 Plan 模式下提问</td><td>自动创建研究任务</td></tr><tr><td>保存计划</td><td><code>"请保存到 plan.md"</code></td><td>持久化计划文档</td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[DNS域名解析：从入门到优化必备基础]]></title>    <link>https://juejin.cn/post/7588680081326850090</link>    <guid>https://juejin.cn/post/7588680081326850090</guid>    <pubDate>2025-12-28T14:53:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588680081326850090" data-draft-id="7588191506606473222" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="DNS域名解析：从入门到优化必备基础"/> <meta itemprop="keywords" content="网络协议"/> <meta itemprop="datePublished" content="2025-12-28T14:53:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="sweet丶"/> <meta itemprop="url" content="https://juejin.cn/user/3227821869921646"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            DNS域名解析：从入门到优化必备基础
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3227821869921646/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    sweet丶
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-28T14:53:34.000Z" title="Sun Dec 28 2025 14:53:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>前言</strong></h2>
<p>在当今互联网世界，域名就像我们生活中的地址，而DNS（Domain Name System）就是那个将地址翻译成具体位置的神奇系统。无论你是前端开发者、移动端工程师还是运维人员，理解DNS的工作机制都至关重要。本文将从基础概念开始，逐步深入解析DNS的方方面面，并结合实际开发中的优化技巧，让你彻底掌握域名解析的艺术。</p>
<h2 data-id="heading-1"><strong>一、DNS解析的基本流程</strong></h2>
<h3 data-id="heading-2"><strong>1.1 传统DNS解析过程</strong></h3>
<p>当你在浏览器中输入 <code>www.example.com</code> 并按下回车时，背后发生了什么？</p>
<pre><code class="hljs">用户输入域名 → 浏览器缓存 → 操作系统缓存 → 路由器缓存 → ISP DNS服务器 → 递归查询 → 返回IP地址
</code></pre>
<p><strong>具体步骤：</strong></p>
<ol>
<li><strong>浏览器缓存检查</strong>：现代浏览器会缓存DNS记录一段时间</li>
<li><strong>操作系统缓存</strong>：如果浏览器没有缓存，系统会检查自己的DNS缓存</li>
<li><strong>路由器缓存</strong>：家庭或办公路由器也可能缓存DNS记录</li>
<li><strong>ISP DNS服务器</strong>：互联网服务提供商的DNS服务器进行递归查询</li>
<li><strong>递归查询过程</strong>：
<ul>
<li>根域名服务器（返回<code>.com</code>顶级域服务器地址）</li>
<li>顶级域名服务器（返回<code>example.com</code>权威服务器地址）</li>
<li>权威域名服务器（返回<code>www.example.com</code>的IP地址）</li>
</ul>
</li>
</ol>
<h3 data-id="heading-3"><strong>1.2 iOS应用中的DNS解析</strong></h3>
<p>在iOS开发中，当使用<code>URLSession</code>发起网络请求时：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// iOS默认使用系统DNS解析</span>
<span class="hljs-keyword">let</span> url <span class="hljs-operator">=</span> <span class="hljs-type">URL</span>(string: <span class="hljs-string">"https://api.example.com"</span>)<span class="hljs-operator">!</span>
<span class="hljs-keyword">let</span> task <span class="hljs-operator">=</span> <span class="hljs-type">URLSession</span>.shared.dataTask(with: url) { data, response, error <span class="hljs-keyword">in</span>
    <span class="hljs-comment">// 处理响应</span>
}
task.resume()
</code></pre>
<p>iOS系统会自动处理DNS解析，开发者通常无需关心具体过程。但从iOS 15开始，我们可以通过<code>NWParameters</code>的<code>expiredDNSBehavior</code>属性来控制DNS记录的过期行为：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">import</span> Network

<span class="hljs-keyword">let</span> parameters <span class="hljs-operator">=</span> <span class="hljs-type">NWParameters</span>.tcp
<span class="hljs-keyword">if</span> <span class="hljs-keyword">#available</span>(<span class="hljs-keyword">iOS</span> <span class="hljs-number">15.0</span>, <span class="hljs-operator">*</span>) {
    <span class="hljs-comment">// 配置DNS记录过期行为</span>
    parameters.expiredDNSBehavior <span class="hljs-operator">=</span> .reloadFromOrigin
    <span class="hljs-comment">// .allow: 允许使用过期记录（默认）</span>
    <span class="hljs-comment">// .reloadFromOrigin: 强制重新查询</span>
    <span class="hljs-comment">// .reloadFromOriginAndFailIfNotAvailable: 必须获取最新记录</span>
}
</code></pre>
<h2 data-id="heading-4"><strong>二、网络请求的完整过程：DNS解析之后</strong></h2>
<p>DNS解析完成后，真正的网络通信才刚刚开始：</p>
<h3 data-id="heading-5"><strong>2.1 TCP连接建立（三次握手）</strong></h3>
<pre><code class="hljs language-ini" lang="ini">客户端 → 服务器: SYN (<span class="hljs-attr">seq</span>=x)
服务器 → 客户端: SYN-ACK (<span class="hljs-attr">seq</span>=y, ack=x+<span class="hljs-number">1</span>)
客户端 → 服务器: ACK (<span class="hljs-attr">seq</span>=x+<span class="hljs-number">1</span>, ack=y+<span class="hljs-number">1</span>)
</code></pre>
<p><strong>为什么重新连接也需要三次握手？</strong>
无论是首次连接还是重新连接，TCP都需要三次握手来确保：</p>
<ul>
<li>双方都能正常通信</li>
<li>序列号同步</li>
<li>防止旧的重复连接请求</li>
</ul>
<h3 data-id="heading-6"><strong>2.2 IP网络选路</strong></h3>
<p>这个重要的步骤发生在DNS解析之后、建立TCP连接之前。数据包需要经过多个路由器（跳）才能到达目标服务器：</p>
<pre><code class="hljs">客户端 → 本地路由器 → ISP网络 → 互联网骨干网 → 目标服务器
</code></pre>
<p><strong>优化空间</strong>：</p>
<ul>
<li>使用CDN减少路由跳数</li>
<li>部署Anycast技术自动路由到最近节点</li>
<li>优化MTU避免数据包分片</li>
</ul>
<h3 data-id="heading-7"><strong>2.3 TLS握手（HTTPS请求）</strong></h3>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-built_in">Client</span> Hello → <span class="hljs-built_in">Server</span> Hello → 证书验证 → 密钥交换 → 加密通信开始
</code></pre>
<p><strong>TLS 1.3的优势</strong>：</p>
<ul>
<li>减少握手步骤</li>
<li>支持0-RTT（零往返时间）恢复会话</li>
<li>更强的加密算法</li>
</ul>
<h3 data-id="heading-8"><strong>2.4 HTTP协议演进</strong></h3>
<p><strong>HTTP/1.1 → HTTP/2 → HTTP/3</strong>的改进：</p>









































<table><thead><tr><th>特性</th><th>HTTP/1.1</th><th>HTTP/2</th><th>HTTP/3</th></tr></thead><tbody><tr><td>多路复用</td><td>❌ 不支持</td><td>✅ 支持</td><td>✅ 支持</td></tr><tr><td>头部压缩</td><td>❌ 不支持</td><td>✅ HPACK</td><td>✅ QPACK</td></tr><tr><td>传输协议</td><td>TCP</td><td>TCP</td><td>QUIC(UDP)</td></tr><tr><td>队头阻塞</td><td>连接级别</td><td>流级别</td><td>❌ 无</td></tr><tr><td>连接迁移</td><td>❌ 不支持</td><td>❌ 不支持</td><td>✅ 支持</td></tr></tbody></table>
<h2 data-id="heading-9"><strong>三、性能优化实战</strong></h2>
<h3 data-id="heading-10"><strong>3.1 减少DNS解析时间</strong></h3>
<p><strong>iOS中的DNS预解析</strong>：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// HTML中的DNS预取（WebView场景）</span>
<span class="hljs-keyword">let</span> html <span class="hljs-operator">=</span> <span class="hljs-string">"""
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
    &lt;link rel="dns-prefetch" href="//cdn.example.com"&gt;
&lt;/head&gt;
&lt;body&gt;...&lt;/body&gt;
&lt;/html&gt;
"""</span>

<span class="hljs-comment">// 或使用Network Framework进行预连接</span>
<span class="hljs-keyword">let</span> monitor <span class="hljs-operator">=</span> <span class="hljs-type">NWPathMonitor</span>()
monitor.pathUpdateHandler <span class="hljs-operator">=</span> { path <span class="hljs-keyword">in</span>
    <span class="hljs-keyword">if</span> path.status <span class="hljs-operator">==</span> .satisfied {
        <span class="hljs-comment">// 网络可用时预连接</span>
        <span class="hljs-keyword">let</span> connection <span class="hljs-operator">=</span> <span class="hljs-type">NWConnection</span>(host: <span class="hljs-string">"api.example.com"</span>, port: <span class="hljs-number">443</span>, using: .tls)
        connection.start(queue: .global())
    }
}
</code></pre>
<h3 data-id="heading-11"><strong>3.2 处理DNS解析失败</strong></h3>
<p>在Alamofire中判断DNS解析失败：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">import</span> Alamofire

<span class="hljs-keyword">extension</span> <span class="hljs-title class_">AFError</span> {
    <span class="hljs-keyword">var</span> isDNSError: <span class="hljs-type">Bool</span> {
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">case</span> .sessionTaskFailed(<span class="hljs-keyword">let</span> underlyingError) <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span> {
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> urlError <span class="hljs-operator">=</span> underlyingError <span class="hljs-keyword">as?</span> <span class="hljs-type">URLError</span> {
                <span class="hljs-keyword">return</span> urlError.code <span class="hljs-operator">==</span> .cannotFindHost <span class="hljs-operator">||</span> 
                       urlError.code <span class="hljs-operator">==</span> .dnsLookupFailed
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> nsError <span class="hljs-operator">=</span> underlyingError <span class="hljs-keyword">as?</span> <span class="hljs-type">NSError</span> {
                <span class="hljs-keyword">return</span> nsError.domain <span class="hljs-operator">==</span> <span class="hljs-type">NSURLErrorDomain</span> <span class="hljs-operator">&amp;&amp;</span> 
                      (nsError.code <span class="hljs-operator">==</span> <span class="hljs-type">NSURLErrorCannotFindHost</span> <span class="hljs-operator">||</span> 
                       nsError.code <span class="hljs-operator">==</span> <span class="hljs-type">NSURLErrorDNSLookupFailed</span>)
            }
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
    }
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-type">AF</span>.request(<span class="hljs-string">"https://api.example.com"</span>).response { response <span class="hljs-keyword">in</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> error <span class="hljs-operator">=</span> response.error <span class="hljs-keyword">as?</span> <span class="hljs-type">AFError</span>, error.isDNSError {
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"DNS解析失败，尝试备用方案"</span>)
        <span class="hljs-comment">// 切换到备用域名或HTTPDNS</span>
    }
}
</code></pre>
<h3 data-id="heading-12"><strong>3.3 使用HTTPDNS</strong></h3>
<p>HTTPDNS通过HTTP协议直接查询DNS，避免传统DNS的污染和劫持：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 示例：使用阿里云HTTPDNS</span>
<span class="hljs-keyword">func</span> <span class="hljs-title function_">resolveWithHTTPDNS</span>(<span class="hljs-params">domain</span>: <span class="hljs-type">String</span>, <span class="hljs-params">completion</span>: <span class="hljs-keyword">@escaping</span> (<span class="hljs-type">String</span>?) -&gt; <span class="hljs-type">Void</span>) {
    <span class="hljs-keyword">let</span> url <span class="hljs-operator">=</span> <span class="hljs-type">URL</span>(string: <span class="hljs-string">"http://203.107.1.1/100000/d?host=<span class="hljs-subst">\(domain)</span>"</span>)<span class="hljs-operator">!</span>
    <span class="hljs-type">URLSession</span>.shared.dataTask(with: url) { data, <span class="hljs-keyword">_</span>, <span class="hljs-keyword">_</span> <span class="hljs-keyword">in</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> data <span class="hljs-operator">=</span> data, <span class="hljs-keyword">let</span> ip <span class="hljs-operator">=</span> <span class="hljs-type">String</span>(data: data, encoding: .utf8) {
            completion(ip.trimmingCharacters(in: .whitespacesAndNewlines))
        } <span class="hljs-keyword">else</span> {
            completion(<span class="hljs-literal">nil</span>)
        }
    }.resume()
}

<span class="hljs-comment">// 使用解析的IP直接建立连接</span>
resolveWithHTTPDNS(domain: <span class="hljs-string">"api.example.com"</span>) { ip <span class="hljs-keyword">in</span>
    <span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> ip <span class="hljs-operator">=</span> ip <span class="hljs-keyword">else</span> { <span class="hljs-keyword">return</span> }
    <span class="hljs-keyword">var</span> request <span class="hljs-operator">=</span> <span class="hljs-type">URLRequest</span>(url: <span class="hljs-type">URL</span>(string: <span class="hljs-string">"https://<span class="hljs-subst">\(ip)</span>/endpoint"</span>)<span class="hljs-operator">!</span>)
    request.setValue(<span class="hljs-string">"api.example.com"</span>, forHTTPHeaderField: <span class="hljs-string">"Host"</span>) <span class="hljs-comment">// 关键：设置Host头部</span>
    <span class="hljs-type">AF</span>.request(request).response { response <span class="hljs-keyword">in</span>
        <span class="hljs-comment">// 处理响应</span>
    }
}
</code></pre>
<h2 data-id="heading-13"><strong>四、高级主题：协议层面的优化</strong></h2>
<h3 data-id="heading-14"><strong>4.1 QUIC与HTTP/3</strong></h3>
<p>HTTP/3基于QUIC协议，带来了革命性的改进：</p>
<p><strong>QUIC的核心特性</strong>：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// QUIC解决了TCP的队头阻塞问题</span>
<span class="hljs-comment">// 传统TCP：一个数据包丢失会阻塞整个连接</span>
<span class="hljs-comment">// QUIC：每个流独立，丢包只影响当前流</span>

<span class="hljs-comment">// 在iOS中，HTTP/3会自动启用（如果服务器支持）</span>
<span class="hljs-comment">// 从iOS 15开始，URLSession默认支持HTTP/3</span>
<span class="hljs-keyword">let</span> configuration <span class="hljs-operator">=</span> <span class="hljs-type">URLSessionConfiguration</span>.default
<span class="hljs-keyword">if</span> <span class="hljs-keyword">#available</span>(<span class="hljs-keyword">iOS</span> <span class="hljs-number">13.0</span>, <span class="hljs-operator">*</span>) {
    <span class="hljs-comment">// 允许使用"昂贵"的网络（如蜂窝数据）</span>
    configuration.allowsExpensiveNetworkAccess <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>
    
    <span class="hljs-comment">// 允许使用"受限"的网络（如低数据模式）</span>
    configuration.allowsConstrainedNetworkAccess <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>
}
<span class="hljs-keyword">let</span> session <span class="hljs-operator">=</span> <span class="hljs-type">URLSession</span>(configuration: configuration)
</code></pre>
<h3 data-id="heading-15"><strong>4.2 队头阻塞问题详解</strong></h3>
<p><strong>TCP的队头阻塞</strong>：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 假设发送了3个数据包</span>
packets = [<span class="hljs-string">"Packet1"</span>, <span class="hljs-string">"Packet2"</span>, <span class="hljs-string">"Packet3"</span>]

<span class="hljs-comment"># 如果Packet2丢失</span>
<span class="hljs-comment"># 即使Packet3已到达，接收端也必须等待Packet2重传</span>
<span class="hljs-comment"># 这就是TCP层的队头阻塞</span>
</code></pre>
<p><strong>HTTP/2的队头阻塞</strong>：</p>
<ul>
<li>虽然HTTP/2支持多路复用，但仍基于TCP</li>
<li>TCP层的丢包会影响所有HTTP/2流</li>
</ul>
<p><strong>HTTP/3的解决方案</strong>：</p>
<ul>
<li>基于UDP，每个QUIC流独立</li>
<li>一个流的丢包不会影响其他流</li>
</ul>
<h3 data-id="heading-16"><strong>4.3 网络性能监控</strong></h3>
<p><strong>监控DNS解析时间</strong>：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">import</span> Foundation

<span class="hljs-keyword">class</span> <span class="hljs-title class_">NetworkMonitor</span> {
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">performRequestWithMetrics</span>(<span class="hljs-params">urlString</span>: <span class="hljs-type">String</span>) {
        <span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> url <span class="hljs-operator">=</span> <span class="hljs-type">URL</span>(string: urlString) <span class="hljs-keyword">else</span> { <span class="hljs-keyword">return</span> }
        
        <span class="hljs-keyword">let</span> configuration <span class="hljs-operator">=</span> <span class="hljs-type">URLSessionConfiguration</span>.default
        <span class="hljs-keyword">let</span> session <span class="hljs-operator">=</span> <span class="hljs-type">URLSession</span>(configuration: configuration)
        
        <span class="hljs-keyword">let</span> task <span class="hljs-operator">=</span> session.dataTask(with: url) { data, response, error <span class="hljs-keyword">in</span>
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> error <span class="hljs-operator">=</span> error {
                <span class="hljs-built_in">print</span>(<span class="hljs-string">"请求失败: <span class="hljs-subst">\(error)</span>"</span>)
                <span class="hljs-keyword">return</span>
            }
            
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"请求成功"</span>)
        }
        task.delegate <span class="hljs-operator">=</span> task.delegate <span class="hljs-comment">// 保留引用以获取metrics</span>
        <span class="hljs-comment">// 监听任务完成</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">#available</span>(<span class="hljs-keyword">iOS</span> <span class="hljs-number">10.0</span>, <span class="hljs-operator">*</span>) {
            <span class="hljs-comment">// 在任务完成后获取指标</span>
            <span class="hljs-type">DispatchQueue</span>.main.asyncAfter(deadline: .now() <span class="hljs-operator">+</span> <span class="hljs-number">0.5</span>) {
                <span class="hljs-keyword">self</span>.printMetrics(for: task)
            }
        }
        
        task.resume()
    }
    
    <span class="hljs-keyword">@available</span>(<span class="hljs-keyword">iOS</span> <span class="hljs-number">10.0</span>, <span class="hljs-operator">*</span>)
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">printMetrics</span>(<span class="hljs-params">for</span> <span class="hljs-params">task</span>: <span class="hljs-type">URLSessionTask</span>) {
        task.getMetrics { metrics <span class="hljs-keyword">in</span>
            <span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> metrics <span class="hljs-operator">=</span> metrics <span class="hljs-keyword">else</span> { <span class="hljs-keyword">return</span> }
            
            <span class="hljs-comment">// 分析时间线</span>
            <span class="hljs-keyword">let</span> transactionMetrics <span class="hljs-operator">=</span> metrics.transactionMetrics
            
            <span class="hljs-keyword">for</span> metric <span class="hljs-keyword">in</span> transactionMetrics {
                <span class="hljs-built_in">print</span>(<span class="hljs-string">"=== 请求指标分析 ==="</span>)
                <span class="hljs-built_in">print</span>(<span class="hljs-string">"URL: <span class="hljs-subst">\(metric.request.url<span class="hljs-operator">?</span>.absoluteString <span class="hljs-operator">??</span> <span class="hljs-string">"N/A"</span>)</span>"</span>)
                
                <span class="hljs-comment">// DNS查询时间</span>
                <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> domainLookupStart <span class="hljs-operator">=</span> metric.domainLookupStartDate,
                   <span class="hljs-keyword">let</span> domainLookupEnd <span class="hljs-operator">=</span> metric.domainLookupEndDate {
                    <span class="hljs-keyword">let</span> dnsTime <span class="hljs-operator">=</span> domainLookupEnd.timeIntervalSince(domainLookupStart)
                    <span class="hljs-built_in">print</span>(<span class="hljs-string">"DNS解析时间: <span class="hljs-subst">\(String(format: <span class="hljs-string">"%.3f"</span>, dnsTime <span class="hljs-operator">*</span> <span class="hljs-number">1000</span>))</span>ms"</span>)
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-built_in">print</span>(<span class="hljs-string">"DNS解析时间: 使用缓存或无法测量"</span>)
                }
                
                <span class="hljs-comment">// TCP握手时间</span>
                <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> connectStart <span class="hljs-operator">=</span> metric.connectStartDate,
                   <span class="hljs-keyword">let</span> connectEnd <span class="hljs-operator">=</span> metric.connectEndDate {
                    <span class="hljs-keyword">let</span> tcpTime <span class="hljs-operator">=</span> connectEnd.timeIntervalSince(connectStart)
                    <span class="hljs-built_in">print</span>(<span class="hljs-string">"TCP连接时间: <span class="hljs-subst">\(String(format: <span class="hljs-string">"%.3f"</span>, tcpTime <span class="hljs-operator">*</span> <span class="hljs-number">1000</span>))</span>ms"</span>)
                }
                
                <span class="hljs-comment">// TLS握手时间</span>
                <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> secureStart <span class="hljs-operator">=</span> metric.secureConnectionStartDate,
                   <span class="hljs-keyword">let</span> secureEnd <span class="hljs-operator">=</span> metric.secureConnectionEndDate {
                    <span class="hljs-keyword">let</span> tlsTime <span class="hljs-operator">=</span> secureEnd.timeIntervalSince(secureStart)
                    <span class="hljs-built_in">print</span>(<span class="hljs-string">"TLS握手时间: <span class="hljs-subst">\(String(format: <span class="hljs-string">"%.3f"</span>, tlsTime <span class="hljs-operator">*</span> <span class="hljs-number">1000</span>))</span>ms"</span>)
                }
                
                <span class="hljs-comment">// 总时间</span>
                <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> fetchStart <span class="hljs-operator">=</span> metric.fetchStartDate,
                   <span class="hljs-keyword">let</span> responseEnd <span class="hljs-operator">=</span> metric.responseEndDate {
                    <span class="hljs-keyword">let</span> totalTime <span class="hljs-operator">=</span> responseEnd.timeIntervalSince(fetchStart)
                    <span class="hljs-built_in">print</span>(<span class="hljs-string">"总请求时间: <span class="hljs-subst">\(String(format: <span class="hljs-string">"%.3f"</span>, totalTime <span class="hljs-operator">*</span> <span class="hljs-number">1000</span>))</span>ms"</span>)
                }
                
                <span class="hljs-comment">// 网络协议</span>
                <span class="hljs-built_in">print</span>(<span class="hljs-string">"网络协议: <span class="hljs-subst">\(metric.networkProtocolType <span class="hljs-operator">??</span> <span class="hljs-string">"unknown"</span>)</span>"</span>)
                <span class="hljs-built_in">print</span>(<span class="hljs-string">"是否代理连接: <span class="hljs-subst">\(metric.isProxyConnection)</span>"</span>)
                <span class="hljs-built_in">print</span>(<span class="hljs-string">"是否重用连接: <span class="hljs-subst">\(metric.isReusedConnection)</span>"</span>)
            }
        }
    }
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">let</span> monitor <span class="hljs-operator">=</span> <span class="hljs-type">NetworkMonitor</span>()
monitor.performRequestWithMetrics(urlString: <span class="hljs-string">"https://httpbin.org/get"</span>)
</code></pre>
<h2 data-id="heading-17"><strong>五、移动端开发最佳实践</strong></h2>
<h3 data-id="heading-18"><strong>5.1 iOS中的网络优化</strong></h3>
<p><strong>使用合适的缓存策略</strong>：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">let</span> configuration <span class="hljs-operator">=</span> <span class="hljs-type">URLSessionConfiguration</span>.default

<span class="hljs-comment">// 设置根据情况合理的缓存策略</span>
configuration.requestCachePolicy <span class="hljs-operator">=</span> .useProtocolCachePolicy
configuration.urlCache <span class="hljs-operator">=</span> <span class="hljs-type">URLCache</span>(
    memoryCapacity: <span class="hljs-number">50</span> <span class="hljs-operator">*</span> <span class="hljs-number">1024</span> <span class="hljs-operator">*</span> <span class="hljs-number">1024</span>,  <span class="hljs-comment">// 50MB内存缓存</span>
    diskCapacity: <span class="hljs-number">500</span> <span class="hljs-operator">*</span> <span class="hljs-number">1024</span> <span class="hljs-operator">*</span> <span class="hljs-number">1024</span>,   <span class="hljs-comment">// 500MB磁盘缓存</span>
    diskPath: <span class="hljs-string">"CustomCache"</span>
)

<span class="hljs-comment">// 配置连接限制（iOS 11+）</span>
<span class="hljs-keyword">if</span> <span class="hljs-keyword">#available</span>(<span class="hljs-keyword">iOS</span> <span class="hljs-number">11.0</span>, <span class="hljs-operator">*</span>) {
    configuration.httpMaximumConnectionsPerHost <span class="hljs-operator">=</span> <span class="hljs-number">6</span>
}
</code></pre>
<p><strong>处理网络切换</strong>：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">import</span> Network

<span class="hljs-keyword">class</span> <span class="hljs-title class_">NetworkManager</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">let</span> monitor <span class="hljs-operator">=</span> <span class="hljs-type">NWPathMonitor</span>()
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> currentPath: <span class="hljs-type">NWPath</span>?
    
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">startMonitoring</span>() {
        monitor.pathUpdateHandler <span class="hljs-operator">=</span> { [<span class="hljs-keyword">weak</span> <span class="hljs-keyword">self</span>] path <span class="hljs-keyword">in</span>
            <span class="hljs-keyword">self</span><span class="hljs-operator">?</span>.currentPath <span class="hljs-operator">=</span> path
            
            <span class="hljs-keyword">if</span> path.status <span class="hljs-operator">==</span> .satisfied {
                <span class="hljs-comment">// 网络可用</span>
                <span class="hljs-keyword">if</span> path.usesInterfaceType(.wifi) {
                    <span class="hljs-built_in">print</span>(<span class="hljs-string">"切换到WiFi"</span>)
                } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> path.usesInterfaceType(.cellular) {
                    <span class="hljs-built_in">print</span>(<span class="hljs-string">"切换到蜂窝网络"</span>)
                }
                
                <span class="hljs-comment">// 网络切换时清除DNS缓存</span>
                <span class="hljs-keyword">self</span><span class="hljs-operator">?</span>.clearDNSCache()
            }
        }
        monitor.start(queue: .global())
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">clearDNSCache</span>() {
        <span class="hljs-comment">// 注意：iOS没有直接清除DNS缓存的API</span>
        <span class="hljs-comment">// 可以通过以下方式间接触发刷新：</span>
        <span class="hljs-comment">// 1. 重新创建URLSession</span>
        <span class="hljs-comment">// 2. 使用新的NWParameters</span>
        <span class="hljs-comment">// 3. 等待系统自动刷新（通常很快）</span>
    }
}
</code></pre>
<h3 data-id="heading-19"><strong>5.2 错误处理与重试机制</strong></h3>
<p><strong>智能重试策略</strong>：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">import</span> Alamofire

<span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NetworkService</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">let</span> session: <span class="hljs-type">Session</span>
    
    <span class="hljs-keyword">init</span>() {
        <span class="hljs-keyword">let</span> configuration <span class="hljs-operator">=</span> <span class="hljs-type">URLSessionConfiguration</span>.default
        configuration.timeoutIntervalForRequest <span class="hljs-operator">=</span> <span class="hljs-number">30</span>
        
        <span class="hljs-comment">// 配置重试策略</span>
        <span class="hljs-keyword">let</span> retryPolicy <span class="hljs-operator">=</span> <span class="hljs-type">RetryPolicy</span>(
            retryLimit: <span class="hljs-number">3</span>,
            exponentialBackoffBase: <span class="hljs-number">2</span>,
            exponentialBackoffScale: <span class="hljs-number">0.5</span>
        )
        
        session <span class="hljs-operator">=</span> <span class="hljs-type">Session</span>(
            configuration: configuration,
            interceptor: retryPolicy
        )
    }
    
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">requestWithRetry</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">url</span>: <span class="hljs-type">String</span>) {
        session.request(url)
            .validate()
            .responseDecodable(of: <span class="hljs-type">ResponseType</span>.<span class="hljs-keyword">self</span>) { response <span class="hljs-keyword">in</span>
                <span class="hljs-keyword">switch</span> response.result {
                <span class="hljs-keyword">case</span> .success(<span class="hljs-keyword">let</span> data):
                    <span class="hljs-built_in">print</span>(<span class="hljs-string">"请求成功: <span class="hljs-subst">\(data)</span>"</span>)
                <span class="hljs-keyword">case</span> .failure(<span class="hljs-keyword">let</span> error):
                    <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> afError <span class="hljs-operator">=</span> error.asAFError,
                       afError.isSessionTaskError,
                       <span class="hljs-keyword">let</span> urlError <span class="hljs-operator">=</span> afError.underlyingError <span class="hljs-keyword">as?</span> <span class="hljs-type">URLError</span> {
                        
                        <span class="hljs-keyword">switch</span> urlError.code {
                        <span class="hljs-keyword">case</span> .cannotFindHost, .dnsLookupFailed:
                            <span class="hljs-built_in">print</span>(<span class="hljs-string">"DNS错误，尝试备用域名"</span>)
                            <span class="hljs-keyword">self</span>.tryBackupDomain(url)
                        <span class="hljs-keyword">case</span> .notConnectedToInternet:
                            <span class="hljs-built_in">print</span>(<span class="hljs-string">"网络未连接"</span>)
                        <span class="hljs-keyword">case</span> .timedOut:
                            <span class="hljs-built_in">print</span>(<span class="hljs-string">"请求超时"</span>)
                        <span class="hljs-keyword">default</span>:
                            <span class="hljs-built_in">print</span>(<span class="hljs-string">"其他网络错误: <span class="hljs-subst">\(urlError)</span>"</span>)
                        }
                    }
                }
            }
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">tryBackupDomain</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">originalUrl</span>: <span class="hljs-type">String</span>) {
        <span class="hljs-comment">// 实现备用域名逻辑</span>
        <span class="hljs-keyword">let</span> backupUrl <span class="hljs-operator">=</span> originalUrl.replacingOccurrences(
            of: <span class="hljs-string">"api.example.com"</span>,
            with: <span class="hljs-string">"api-backup.example.com"</span>
        )
        session.request(backupUrl).response { <span class="hljs-keyword">_</span> <span class="hljs-keyword">in</span> }
    }
}
</code></pre>
<h2 data-id="heading-20"><strong>六、安全考量</strong></h2>
<h3 data-id="heading-21"><strong>6.1 DNS安全威胁</strong></h3>
<p><strong>常见的DNS攻击</strong>：</p>
<ol>
<li><strong>DNS劫持</strong>：篡改DNS响应，指向恶意服务器</li>
<li><strong>DNS污染</strong>：缓存投毒，传播错误记录</li>
<li><strong>DNS放大攻击</strong>：利用DNS服务器进行DDoS</li>
</ol>
<p><strong>防护措施</strong>：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 使用HTTPS防止中间人攻击</span>
<span class="hljs-keyword">let</span> configuration <span class="hljs-operator">=</span> <span class="hljs-type">URLSessionConfiguration</span>.default

<span class="hljs-comment">// 启用ATS（App Transport Security）</span>
<span class="hljs-comment">// iOS默认要求HTTPS，可在Info.plist中配置例外</span>
<span class="hljs-comment">/*
&lt;key&gt;NSAppTransportSecurity&lt;/key&gt;
&lt;dict&gt;
    &lt;key&gt;NSAllowsArbitraryLoads&lt;/key&gt;
    &lt;false/&gt;
    &lt;key&gt;NSExceptionDomains&lt;/key&gt;
    &lt;dict&gt;
        &lt;key&gt;example.com&lt;/key&gt;
        &lt;dict&gt;
            &lt;key&gt;NSIncludesSubdomains&lt;/key&gt;
            &lt;true/&gt;
            &lt;key&gt;NSTemporaryExceptionAllowsInsecureHTTPLoads&lt;/key&gt;
            &lt;true/&gt;
        &lt;/dict&gt;
    &lt;/dict&gt;
&lt;/dict&gt;
*/</span>

<span class="hljs-comment">// 证书锁定（Certificate Pinning）</span>
<span class="hljs-keyword">let</span> serverTrustPolicies: [<span class="hljs-type">String</span>: <span class="hljs-type">ServerTrustEvaluating</span>] <span class="hljs-operator">=</span> [
    <span class="hljs-string">"api.example.com"</span>: <span class="hljs-type">PinnedCertificatesTrustEvaluator</span>()
]

<span class="hljs-keyword">let</span> session <span class="hljs-operator">=</span> <span class="hljs-type">Session</span>(
    serverTrustManager: <span class="hljs-type">ServerTrustManager</span>(evaluators: serverTrustPolicies)
)
</code></pre>
<h3 data-id="heading-22"><strong>6.2 隐私保护</strong></h3>
<p><strong>减少DNS泄露</strong>：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 使用本地DNS解析</span>
<span class="hljs-keyword">import</span> dnssd

<span class="hljs-comment">// 或使用加密的DNS（DNS over TLS/HTTPS）</span>
<span class="hljs-keyword">let</span> parameters <span class="hljs-operator">=</span> <span class="hljs-type">NWParameters</span>.tls
<span class="hljs-keyword">if</span> <span class="hljs-keyword">#available</span>(<span class="hljs-keyword">iOS</span> <span class="hljs-number">14.0</span>, <span class="hljs-operator">*</span>) {
    <span class="hljs-comment">// 配置加密DNS</span>
    <span class="hljs-keyword">let</span> options <span class="hljs-operator">=</span> <span class="hljs-type">NWProtocolTLS</span>.<span class="hljs-type">Options</span>()
    <span class="hljs-comment">// 设置DNS over TLS</span>
}
</code></pre>
<h2 data-id="heading-23"><strong>总结</strong></h2>
<p>DNS域名解析是互联网通信的基石，理解其工作原理和优化策略对于构建高性能应用至关重要。从传统的递归查询到现代的HTTPDNS，从TCP的三次握手到QUIC的零往返连接，网络技术正在不断演进。</p>
<p><strong>关键要点</strong>：</p>
<ol>
<li><strong>理解完整流程</strong>：DNS解析只是开始，后续还有TCP握手、TLS协商等步骤</li>
<li><strong>选择合适协议</strong>：根据场景选择HTTP/2或HTTP/3</li>
<li><strong>实施智能优化</strong>：使用预解析、HTTPDNS、连接复用等技术</li>
<li><strong>处理边界情况</strong>：网络切换、DNS失败、高延迟环境</li>
<li><strong>重视安全隐私</strong>：防止DNS劫持，保护用户数据</li>
</ol>
<p>通过本文的深入解析，希望你能掌握DNS域名解析的全貌，并在实际开发中应用这些优化技巧，打造更快、更稳定、更安全的网络应用。</p>
<hr/>
<p><em>下一篇预告：我们将深入探讨HTTP/3和QUIC协议，解析其如何彻底解决队头阻塞问题，以及在实际项目中的部署实践。</em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[VSCode 重磅更新！要收费了？]]></title>    <link>https://juejin.cn/post/7588140921249136678</link>    <guid>https://juejin.cn/post/7588140921249136678</guid>    <pubDate>2025-12-28T13:21:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588140921249136678" data-draft-id="7585789195868815396" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="VSCode 重磅更新！要收费了？"/> <meta itemprop="keywords" content="前端,JavaScript,Visual Studio Code"/> <meta itemprop="datePublished" content="2025-12-28T13:21:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="前端开发爱好者"/> <meta itemprop="url" content="https://juejin.cn/user/1116759545088190"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            VSCode 重磅更新！要收费了？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1116759545088190/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    前端开发爱好者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-28T13:21:16.000Z" title="Sun Dec 28 2025 13:21:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>微软在前几天推送了 <strong>VS Code 1.107</strong> 版本，这是 <strong>2025</strong> 年最重磅的一次更新。</p>
<p>表面看是**「AI 编程革命」**，背后却藏着一个让 <strong>6000 万</strong>开发者心碎的真相：<strong>那个曾经完全免费的 VS Code，开始收网了。</strong></p>
<h2 data-id="heading-0">IntelliCode 正式下线：免费时代的终结</h2>
<p><strong>「IntelliCode 插件已停止服务。」</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d4eb0a0265194968aaa8c405e8e38f43~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5byA5Y-R54ix5aW96ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767532875&amp;x-signature=4mPT4D5PDcufkKUj55zn2wobSBM%3D" alt="" loading="lazy"/></p>
<p>当开发者像往常一样打开 <strong>VS Code</strong>，迎接他们的不是新功能介绍，而是一则冰冷的<strong>停服</strong>通知。</p>
<p>这个曾为 <code>Python</code>、<code>JavaScript</code>、<code>TypeScript</code>、<code>Java</code>、<code>C#</code> 等主流语言提供免费 <strong>AI</strong> 代码补全的工具，累计服务超过 <strong>6000</strong> 万开发者，如今说关就关。</p>
<p>微软给出的「官方理由」很体面：<code>「为了提供更统一的 AI 开发体验。」</code></p>
<p>其实内涵的意思就是：<strong>免费工具必须让路给付费服务 GitHub Copilot。</strong></p>
<ul>
<li><strong>IntelliCode</strong>：<code>完全免费</code>，本地模型，响应飞快</li>
<li><strong>GitHub Copilot</strong>：每月 <code>2000次</code>免费额度，超出必须付费订阅</li>
</ul>
<p>一位开发者在 <strong>GitHub</strong> <code>issue</code> 里愤怒写道：<code>「他们先培养用户习惯，再关门收费，这招太熟悉了。」</code></p>
<h2 data-id="heading-1">终端终于开窍了</h2>
<p>吐槽归吐槽，新功能确实香。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c33cae428a314ddaa52d664331d61292~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5byA5Y-R54ix5aW96ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767532875&amp;x-signature=RtBdCFC%2BKZQm6mzFgyxrZs%2B48l4%3D" alt="" loading="lazy"/></p>
<p>特别是终端，终于不再是那个傻乎乎的黑框框了。</p>
<p>现在敲命令跟装了外挂似的：</p>
<pre><code class="hljs language-css" lang="css"># 输到一半它就懂了
$ git ch
<span class="hljs-selector-attr">[自动弹出]</span> git checkout / git cherry-pick / git commit ...

# 连参数都给你分好类
$ docker run
<span class="hljs-selector-attr">[必填参数]</span> <span class="hljs-attr">--name</span> / -<span class="hljs-selector-tag">p</span> / -v
<span class="hljs-selector-attr">[可选参数]</span> -d / -it / <span class="hljs-attr">--rm</span>
</code></pre>
<p>最牛的是 <strong>Copilot</strong> 执行命令那会儿，输出不再是乱糟糟的文本，而是正经的<strong>终端渲染</strong>，表格、颜色、对齐全都对味了。</p>
<p>终于有点现代化开发工具的样子。</p>
<h2 data-id="heading-2">TypeScript 7.0 预览版</h2>
<p>这次更新并非全是「坏消息」。<strong>TypeScript 7.0</strong> 预览版确实带来了肉眼可见的性能提升：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/80a1dd5e4e4d4a009d488ce191b640ef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5byA5Y-R54ix5aW96ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767532875&amp;x-signature=n7QTB0feG9GdA%2F%2BwIx2PVFazLQU%3D" alt="" loading="lazy"/></p>
<ul>
<li><strong>加载速度提升 10 倍</strong>：大型项目秒级响应</li>
<li><strong>内存占用降低 60%</strong>：16GB 内存终于够用</li>
<li><strong>原生级性能</strong>：Go 语言重写的编译器</li>
</ul>
<p>但享受这些提升的前提是：<strong>你必须在 VS Code 内使用 TypeScript 7.0。</strong></p>
<p>微软首席产品经理丹尼尔·罗森瓦瑟说得直白：<strong>「TypeScript 7.0 让编辑器响应更流畅，我们希望开发者留在 VS Code 生态里。」</strong></p>
<h2 data-id="heading-3">多智能体编排：微软的终极收网</h2>
<p>最耐人寻味的是**「多智能体编排」**功能。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2c8dde5abe4b493ba85b3a8c78ff294e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5byA5Y-R54ix5aW96ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767532875&amp;x-signature=LkR999SscZMJeJJucwNifN6muw4%3D" alt="" loading="lazy"/></p>
<p><strong>VS Code</strong> 现在支持：</p>
<ul>
<li><strong>Agent HQ</strong>：统一管理多个 <strong>AI</strong> 智能体</li>
<li><strong>后台智能体</strong>：并行处理多个开发任务</li>
<li><strong>云端智能体</strong>：把繁重计算转移到微软服务器</li>
</ul>
<p>看起来是技术升级，实则是<strong>商业模式的终极闭环</strong>：</p>
<ol>
<li><strong>本地智能体</strong>：消耗你的电脑性能</li>
<li><strong>后台智能体</strong>：消耗你的网络带宽</li>
<li><strong>云端智能体</strong>：消耗你的 <strong>Copilot</strong> 订阅额度</li>
</ol>
<p>一位架构师看出门道：<strong>「微软在构建 AI 编程的『操作系统』，开发者就像应用，跑在他们的平台上，按次付费。」</strong></p>
<h2 data-id="heading-4">写在最后</h2>
<p><strong>VS Code</strong> 的收费化，标志着<strong>开发者工具免费时代的终结</strong>。</p>
<p>从 <strong>GitHub</strong> 被微软收购，到 <strong>Copilot</strong> 付费订阅，再到 <strong>IntelliCode</strong> 黯然退场，一条清晰的路径浮现出来：</p>
<blockquote>
<p><strong>先免费获取用户 → 再培养依赖习惯 → 最后收费变现</strong></p>
</blockquote>
<p>这不是阴谋论，这是<strong>商业规律</strong>。</p>
<p>正如一位开发者在 <strong>Hacker News</strong> 上的评论：<strong>「我们享受了十年免费的顶级开发工具，是时候为价值付费了。只是希望微软别忘了：开发者不是待宰的羔羊，而是生态的根基。」</strong></p>
<p><strong>VS Code 还是很好，只是不再免费。</strong></p>
<p>接下来的问题是：<strong>你愿意为 AI 编程助手付多少钱？</strong></p>
<p><em>欢迎在评论区分享你的 <strong>VS Code</strong> 付费策略。是精打细算？是技术抵抗？还是顺势而为？</em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[C# 正则表达式（4）：分支与回溯引用]]></title>    <link>https://juejin.cn/post/7588365276191129638</link>    <guid>https://juejin.cn/post/7588365276191129638</guid>    <pubDate>2025-12-28T13:24:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588365276191129638" data-draft-id="7585474459776155684" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="C# 正则表达式（4）：分支与回溯引用"/> <meta itemprop="keywords" content="前端,C#,正则表达式"/> <meta itemprop="datePublished" content="2025-12-28T13:24:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="烛阴"/> <meta itemprop="url" content="https://juejin.cn/user/950397795841032"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            C# 正则表达式（4）：分支与回溯引用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/950397795841032/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    烛阴
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-28T13:24:39.000Z" title="Sun Dec 28 2025 13:24:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、分支 <code>|</code>：在多个候选中选一个</h2>
<h3 data-id="heading-1">1. 最基本的 <code>|</code></h3>
<pre><code class="hljs language-csharp" lang="csharp">Regex.IsMatch(<span class="hljs-string">"my dog"</span>, <span class="hljs-string">@"cat|dog"</span>); <span class="hljs-comment">// True</span>
</code></pre>
<h3 data-id="heading-2">2. 分支几乎总要配合分组</h3>
<p><code>(?:...)</code> 是非捕获分组，用于“只分组，不提取”。</p>
<pre><code class="hljs language-csharp" lang="csharp">Console.WriteLine( Regex.IsMatch(<span class="hljs-string">"https://www.baidu.com"</span>, <span class="hljs-string">@"(?:http|https)://"</span>)); <span class="hljs-comment">// True</span>
</code></pre>
<ul>
<li>想匹配 <code>jpg</code>/<code>png</code>/<code>gif</code> 结尾的文件名：</li>
</ul>
<pre><code class="hljs language-csharp" lang="csharp">Console.WriteLine( Regex.IsMatch(<span class="hljs-string">"a.png"</span>, <span class="hljs-string">@"^.+\.(?:jpg|png|gif)$"</span>)); <span class="hljs-comment">// True</span>
</code></pre>
<hr/>
<h2 data-id="heading-3">二、分支的优先级与“从左到右”匹配</h2>
<p>正则引擎通常会“先尝试左边分支”，成功就不再看右边。</p>
<p>因此把短分支放在长分支前面，会导致长分支永远匹配不到。</p>
<pre><code class="hljs language-csharp" lang="csharp">Console.WriteLine( Regex.IsMatch(<span class="hljs-string">"ab"</span>, <span class="hljs-string">@"^(?:ab|a)$"</span>)); <span class="hljs-comment">// True</span>
</code></pre>
<hr/>
<h2 data-id="heading-4">三、回溯引用：让后面必须“重复前面匹配到的内容”</h2>
<p>回溯引用依赖捕获组：<code>(...)</code>。</p>
<ul>
<li>数字回溯引用：<code>\1</code>、<code>\2</code>…（引用第 1、2…个捕获组）</li>
<li>命名回溯引用：<code>\k&lt;name&gt;</code>（引用名为 name 的捕获组）</li>
</ul>
<h3 data-id="heading-5">1. 匹配成对引号（单引号或双引号），并确保左右一致</h3>
<p><strong>示例：</strong></p>
<p>匹配 <code>"hello"</code> 或 <code>'hello'</code>，但不允许 <code>"hello'</code> 这种左右不一致。</p>
<p>正则：</p>
<pre><code class="hljs language-regex" lang="regex">^(["'])(?&lt;content&gt;.*)\1$
</code></pre>
<p><strong>解析：：</strong></p>
<ul>
<li><code>(["'])</code> 捕获一个引号字符（单或双），这是组 1</li>
<li><code>(?&lt;content&gt;.*)</code> 捕获内容</li>
<li><code>\1</code> 要求结尾引号必须和开头引号完全相同</li>
</ul>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-built_in">string</span>[] inputs = { <span class="hljs-string">"\"hello\""</span>, <span class="hljs-string">"'hello'"</span>, <span class="hljs-string">"\"hello'"</span>, <span class="hljs-string">"'hello\""</span> };
<span class="hljs-keyword">var</span> pattern = <span class="hljs-string">@"^([""'])(?&lt;content&gt;.*)\1$"</span>;

<span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> s <span class="hljs-keyword">in</span> inputs)
{
    <span class="hljs-keyword">var</span> m = Regex.Match(s, pattern);
    Console.WriteLine(<span class="hljs-string">$"<span class="hljs-subst">{s}</span> -&gt; <span class="hljs-subst">{m.Success}</span>"</span>);
}
</code></pre>
<h3 data-id="heading-6">2. 匹配重复单词（如 “hello hello”）</h3>
<p>需求：匹配两个相同单词，中间用空白分隔。</p>
<pre><code class="hljs language-regex" lang="regex">\b(\w+)\s+\1\b
</code></pre>
<p><strong>示例：</strong></p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">var</span> text = <span class="hljs-string">"This is is a test, hello hello!"</span>;
<span class="hljs-keyword">var</span> pattern = <span class="hljs-string">@"\b(\w+)\s+\1\b"</span>;

<span class="hljs-keyword">foreach</span> (Match m <span class="hljs-keyword">in</span> Regex.Matches(text, pattern))
{
    Console.WriteLine(m.Value); <span class="hljs-comment">// "is is", "hello hello"</span>
}
</code></pre>
<h3 data-id="heading-7">3. 命名回溯引用：<code>\k&lt;name&gt;</code></h3>
<p>把引号例子改成命名更清晰：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">var</span> text = <span class="hljs-string">"This is is a test, hello hello!"</span>;
<span class="hljs-keyword">var</span> pattern = <span class="hljs-string">@"\b(?&lt;word&gt;\w+)\s+\k&lt;word&gt;\b"</span>;

<span class="hljs-keyword">foreach</span> (Match m <span class="hljs-keyword">in</span> Regex.Matches(text, pattern))
{
    Console.WriteLine(m.Value); <span class="hljs-comment">// "is is", "hello hello"</span>
}
</code></pre>
<hr/>
<h2 data-id="heading-8">结语</h2>
<p><strong>点个赞，关注我获取更多实用 C# 技术干货！如果觉得有用，记得收藏本文</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[C++虚函数表与多重继承内存布局深度剖析]]></title>    <link>https://juejin.cn/post/7588388014504542250</link>    <guid>https://juejin.cn/post/7588388014504542250</guid>    <pubDate>2025-12-28T13:36:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588388014504542250" data-draft-id="7588191506607390726" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="C++虚函数表与多重继承内存布局深度剖析"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-28T13:36:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="码事漫谈"/> <meta itemprop="url" content="https://juejin.cn/user/1972974802965230"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            C++虚函数表与多重继承内存布局深度剖析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1972974802965230/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    码事漫谈
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-28T13:36:43.000Z" title="Sun Dec 28 2025 13:36:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在C++面向对象编程中，虚函数是实现运行时多态的关键机制。单继承场景下的虚函数表(vtable)布局相对直观，但当涉及到多重继承时，情况就变得复杂起来。本文将深入探讨虚函数表的实现原理，并重点解析多重继承下的内存布局，帮助开发者更好地理解C++对象模型的底层机制。</p>
<h2 data-id="heading-0">第一部分：虚函数表基础</h2>
<h3 data-id="heading-1">1.1 什么是虚函数表</h3>
<p>虚函数表（vtable）是C++编译器为每个包含虚函数的类生成的静态数据表，存储着指向该类虚函数的指针。每个包含虚函数的对象实例在内存中都包含一个指向对应vtable的指针（vptr）。</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Base</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">func1</span><span class="hljs-params">()</span> </span>{ cout &lt;&lt; <span class="hljs-string">"Base::func1"</span> &lt;&lt; endl; }
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">func2</span><span class="hljs-params">()</span> </span>{ cout &lt;&lt; <span class="hljs-string">"Base::func2"</span> &lt;&lt; endl; }
    <span class="hljs-type">int</span> data = <span class="hljs-number">10</span>;
};

<span class="hljs-comment">// 内存布局示意：</span>
<span class="hljs-comment">// 对象实例:</span>
<span class="hljs-comment">// [vptr] -&gt; 指向Base的vtable</span>
<span class="hljs-comment">// [data] -&gt; 10</span>
<span class="hljs-comment">//</span>
<span class="hljs-comment">// Base的vtable:</span>
<span class="hljs-comment">// [0] -&gt; &amp;Base::func1</span>
<span class="hljs-comment">// [1] -&gt; &amp;Base::func2</span>
</code></pre>
<h3 data-id="heading-2">1.2 vptr的初始化时机</h3>
<p>vptr的初始化发生在构造函数执行期间：</p>
<ol>
<li>在进入构造函数体之前，vptr被设置为当前类的vtable</li>
<li>构造函数体执行</li>
<li>如果存在派生类，在派生类构造函数中vptr会被重新设置为派生类的vtable</li>
</ol>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Derived</span> : <span class="hljs-keyword">public</span> Base {
<span class="hljs-keyword">public</span>:
    <span class="hljs-built_in">Derived</span>() {
        <span class="hljs-comment">// 此时vptr已经指向Derived的vtable</span>
    }
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">func1</span><span class="hljs-params">()</span> <span class="hljs-keyword">override</span> </span>{ cout &lt;&lt; <span class="hljs-string">"Derived::func1"</span> &lt;&lt; endl; }
};
</code></pre>
<h2 data-id="heading-3">第二部分：多重继承下的内存布局</h2>
<h3 data-id="heading-4">2.1 基本的多重继承布局</h3>
<p>当类从多个基类继承时，对象内存中将包含多个子对象，每个子对象都有自己的vptr。</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Base1</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">f1</span><span class="hljs-params">()</span> </span>{}
    <span class="hljs-type">int</span> b1_data = <span class="hljs-number">1</span>;
};

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Base2</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">f2</span><span class="hljs-params">()</span> </span>{}
    <span class="hljs-type">int</span> b2_data = <span class="hljs-number">2</span>;
};

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Derived</span> : <span class="hljs-keyword">public</span> Base1, <span class="hljs-keyword">public</span> Base2 {
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">f1</span><span class="hljs-params">()</span> <span class="hljs-keyword">override</span> </span>{}
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">f2</span><span class="hljs-params">()</span> <span class="hljs-keyword">override</span> </span>{}
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">f3</span><span class="hljs-params">()</span> </span>{}
    <span class="hljs-type">int</span> d_data = <span class="hljs-number">3</span>;
};

<span class="hljs-comment">// Derived对象内存布局（简化）:</span>
<span class="hljs-comment">// [vptr1] -&gt; 指向Derived中Base1部分的vtable</span>
<span class="hljs-comment">// [b1_data] -&gt; 1</span>
<span class="hljs-comment">// [vptr2] -&gt; 指向Derived中Base2部分的vtable  </span>
<span class="hljs-comment">// [b2_data] -&gt; 2</span>
<span class="hljs-comment">// [d_data] -&gt; 3</span>
</code></pre>
<h3 data-id="heading-5">2.2 this指针调整机制</h3>
<p>多重继承中最关键的问题是this指针调整。当通过Base2指针调用Derived对象的虚函数时，编译器需要调整this指针，使其指向Derived对象中的Base2子对象。</p>
<pre><code class="hljs language-cpp" lang="cpp">Derived* d = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Derived</span>();
Base2* b2 = d;  <span class="hljs-comment">// 这里发生隐式转换：b2指向Derived对象中的Base2子对象</span>

<span class="hljs-comment">// 转换过程相当于：</span>
<span class="hljs-comment">// Base2* b2 = reinterpret_cast&lt;Base2*&gt;(reinterpret_cast&lt;char*&gt;(d) + sizeof(Base1));</span>
</code></pre>
<h3 data-id="heading-6">2.3 多重继承的vtable结构</h3>
<p>每个基类在派生类中都有独立的vtable。派生类的新虚函数通常附加到第一个基类的vtable末尾。</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// Derived对象的vtable结构：</span>

<span class="hljs-comment">// Base1子对象的vtable (主vtable):</span>
<span class="hljs-comment">// [0] -&gt; &amp;Derived::f1    // 重写Base1::f1</span>
<span class="hljs-comment">// [1] -&gt; &amp;Base1::f2      // 未重写，保持Base1版本</span>
<span class="hljs-comment">// [2] -&gt; &amp;Derived::f3    // 新增虚函数</span>

<span class="hljs-comment">// Base2子对象的vtable (次vtable):</span>
<span class="hljs-comment">// [0] -&gt; &amp;thunk_to_Derived::f2  // 需要this调整的跳转代码</span>
<span class="hljs-comment">// [1] -&gt; &amp;Base2::other_func     // 其他Base2虚函数</span>
</code></pre>
<h2 data-id="heading-7">第三部分：虚继承的内存布局</h2>
<h3 data-id="heading-8">3.1 菱形继承问题</h3>
<p>虚继承用于解决菱形继承（钻石继承）中的二义性和数据冗余问题。</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Base</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">func</span><span class="hljs-params">()</span> </span>{}
    <span class="hljs-type">int</span> base_data = <span class="hljs-number">10</span>;
};

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Middle1</span> : <span class="hljs-keyword">virtual</span> <span class="hljs-keyword">public</span> Base {
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">middle1_func</span><span class="hljs-params">()</span> </span>{}
    <span class="hljs-type">int</span> m1_data = <span class="hljs-number">20</span>;
};

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Middle2</span> : <span class="hljs-keyword">virtual</span> <span class="hljs-keyword">public</span> Base {
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">middle2_func</span><span class="hljs-params">()</span> </span>{}
    <span class="hljs-type">int</span> m2_data = <span class="hljs-number">30</span>;
};

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Derived</span> : <span class="hljs-keyword">public</span> Middle1, <span class="hljs-keyword">public</span> Middle2 {
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">func</span><span class="hljs-params">()</span> <span class="hljs-keyword">override</span> </span>{}
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">derived_func</span><span class="hljs-params">()</span> </span>{}
    <span class="hljs-type">int</span> d_data = <span class="hljs-number">40</span>;
};
</code></pre>
<h3 data-id="heading-9">3.2 虚基类表（vbtable）</h3>
<p>虚继承引入了虚基类表（vbtable）或类似机制，用于定位虚基类子对象的位置。</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// Derived对象内存布局（典型实现）:</span>
<span class="hljs-comment">// [vptr_Middle1] -&gt; Middle1的vtable (包含vbtable偏移)</span>
<span class="hljs-comment">// [m1_data] -&gt; 20</span>
<span class="hljs-comment">// [vptr_Middle2] -&gt; Middle2的vtable (包含vbtable偏移)</span>
<span class="hljs-comment">// [m2_data] -&gt; 30</span>
<span class="hljs-comment">// [d_data] -&gt; 40</span>
<span class="hljs-comment">// [vptr_Base] -&gt; Base的vtable</span>
<span class="hljs-comment">// [base_data] -&gt; 10</span>

<span class="hljs-comment">// 每个虚继承的基类都通过自己的vtable中的一个额外条目</span>
<span class="hljs-comment">// 来存储到虚基类子对象的偏移量</span>
</code></pre>
<h3 data-id="heading-10">3.3 虚继承下的性能考量</h3>
<p>虚继承增加了间接访问的开销：</p>
<ol>
<li>额外的指针解引用访问虚基类成员</li>
<li>虚函数调用可能需要多次间接寻址</li>
<li>对象构造和析构更复杂</li>
</ol>
<h2 data-id="heading-11">第四部分：实际案例分析</h2>
<h3 data-id="heading-12">4.1 查看内存布局的工具和方法</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 使用编译器特定功能查看内存布局</span>
<span class="hljs-comment">// GCC: -fdump-class-hierarchy 选项</span>
<span class="hljs-comment">// MSVC: /d1reportAllClassLayout 选项</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Example</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-keyword">virtual</span> ~<span class="hljs-built_in">Example</span>() = <span class="hljs-keyword">default</span>;
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">test</span><span class="hljs-params">()</span> </span>= <span class="hljs-number">0</span>;
};

<span class="hljs-comment">// 编译时添加选项查看布局</span>
<span class="hljs-comment">// g++ -fdump-class-hierarchy example.cpp</span>
</code></pre>
<h3 data-id="heading-13">4.2 性能优化建议</h3>
<ol>
<li><strong>避免深层次的多重继承</strong>：超过2-3层的多重继承会显著增加复杂度</li>
<li><strong>谨慎使用虚继承</strong>：只在真正需要解决菱形继承问题时使用</li>
<li><strong>考虑组合代替继承</strong>：许多情况下，组合模式更清晰高效</li>
<li><strong>注意缓存局部性</strong>：分散的vptr可能影响缓存性能</li>
</ol>
<h2 data-id="heading-14">第五部分：ABI兼容性与实践</h2>
<h3 data-id="heading-15">5.1 跨编译器兼容性</h3>
<p>不同编译器（GCC、Clang、MSVC）的vtable实现细节不同：</p>
<ul>
<li>vptr位置（对象开头或结尾）</li>
<li>虚基类指针的存储方式</li>
<li>RTTI信息的整合方式</li>
</ul>
<h3 data-id="heading-16">5.2 最佳实践</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 1. 明确使用override关键字</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Interface</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">execute</span><span class="hljs-params">()</span> </span>= <span class="hljs-number">0</span>;
    <span class="hljs-keyword">virtual</span> ~<span class="hljs-built_in">Interface</span>() = <span class="hljs-keyword">default</span>;
};

<span class="hljs-comment">// 2. 优先使用接口类（纯虚类）进行多重继承</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Runnable</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>= <span class="hljs-number">0</span>;
    <span class="hljs-keyword">virtual</span> ~<span class="hljs-built_in">Runnable</span>() = <span class="hljs-keyword">default</span>;
};

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Worker</span> : <span class="hljs-keyword">public</span> Interface, <span class="hljs-keyword">public</span> Runnable {
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">execute</span><span class="hljs-params">()</span> <span class="hljs-keyword">override</span> </span>{ <span class="hljs-comment">/* 实现 */</span> }
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> <span class="hljs-keyword">override</span> </span>{ <span class="hljs-comment">/* 实现 */</span> }
};

<span class="hljs-comment">// 3. 使用final优化性能（C++11）</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">OptimizedDerived</span> <span class="hljs-keyword">final</span> : <span class="hljs-keyword">public</span> Base {
    <span class="hljs-comment">// 不能被进一步继承，某些情况下允许编译器优化</span>
};
</code></pre>
<h2 data-id="heading-17">结论</h2>
<p>理解C++虚函数表和多重继承的内存布局对于编写高效、可靠的C++代码至关重要。虽然现代C++更倾向于使用组合和基于接口的设计，但深入理解这些底层机制仍然是高级C++开发者的必备技能。通过掌握这些知识，开发者可以：</p>
<ol>
<li>更好地调试复杂继承层次的问题</li>
<li>做出更明智的架构设计决策</li>
<li>编写ABI兼容的库和接口</li>
<li>在性能关键场景中进行针对性优化</li>
</ol>
<p>C++的对象模型虽然复杂，但其设计的灵活性和性能优势正是通过这种复杂性实现的。作为开发者，我们应该在理解底层机制的基础上，合理运用语言特性，构建既高效又易于维护的系统。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[C++数据竞争与无锁编程]]></title>    <link>https://juejin.cn/post/7588411503120744484</link>    <guid>https://juejin.cn/post/7588411503120744484</guid>    <pubDate>2025-12-28T13:38:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588411503120744484" data-draft-id="7588680081326719018" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="C++数据竞争与无锁编程"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-28T13:38:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="码事漫谈"/> <meta itemprop="url" content="https://juejin.cn/user/1972974802965230"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            C++数据竞争与无锁编程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1972974802965230/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    码事漫谈
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-28T13:38:13.000Z" title="Sun Dec 28 2025 13:38:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在多核处理器成为标配的今天，并发编程从"锦上添花"变成了"必不可少"。然而，并发在带来性能提升的同时，也引入了新的复杂性——<strong>数据竞争</strong>。传统锁机制虽然直观，但在高并发场景下可能成为性能瓶颈。无锁编程作为替代方案，提供了更高的并发度，但也带来了前所未有的复杂性。</p>
<h2 data-id="heading-0">一、数据竞争的本质</h2>
<h3 data-id="heading-1">1.1 什么是数据竞争？</h3>
<p>数据竞争发生在多个线程同时访问同一内存位置，且至少有一个线程执行写操作，且没有适当的同步机制。</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 经典的数据竞争示例</span>
<span class="hljs-type">int</span> counter = <span class="hljs-number">0</span>;

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">increment</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000000</span>; ++i) {
        ++counter;  <span class="hljs-comment">// 数据竞争！</span>
    }
}

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-function">std::thread <span class="hljs-title">t1</span><span class="hljs-params">(increment)</span></span>;
    <span class="hljs-function">std::thread <span class="hljs-title">t2</span><span class="hljs-params">(increment)</span></span>;
    t1.<span class="hljs-built_in">join</span>();
    t2.<span class="hljs-built_in">join</span>();
    <span class="hljs-comment">// counter的结果是不确定的！</span>
}
</code></pre>
<h3 data-id="heading-2">1.2 内存模型与顺序一致性</h3>
<p>C++11引入的内存模型定义了内存操作的可见性规则：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;atomic&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;thread&gt;</span></span>

std::atomic&lt;<span class="hljs-type">int</span>&gt; x{<span class="hljs-number">0</span>}, y{<span class="hljs-number">0</span>};
<span class="hljs-type">int</span> r1, r2;

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">thread1</span><span class="hljs-params">()</span> </span>{
    x.<span class="hljs-built_in">store</span>(<span class="hljs-number">1</span>, std::memory_order_relaxed);
    r1 = y.<span class="hljs-built_in">load</span>(std::memory_order_relaxed);
}

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">thread2</span><span class="hljs-params">()</span> </span>{
    y.<span class="hljs-built_in">store</span>(<span class="hljs-number">1</span>, std::memory_order_relaxed);
    r2 = x.<span class="hljs-built_in">load</span>(std::memory_order_relaxed);
}
</code></pre>
<p>不同的内存序可能导致不同的执行结果，这是理解无锁编程的关键。</p>
<h2 data-id="heading-3">二、无锁编程的基础</h2>
<h3 data-id="heading-4">2.1 无锁、无等待与无阻碍</h3>
<ul>
<li><strong>无锁（Lock-free）</strong>：系统整体保证前进，至少有一个线程能继续执行</li>
<li><strong>无等待（Wait-free）</strong>：每个线程都能在有限步内完成操作</li>
<li><strong>无阻碍（Obstruction-free）</strong>：在没有竞争时线程能独立完成</li>
</ul>
<h3 data-id="heading-5">2.2 原子操作的硬件支持</h3>
<p>现代CPU通过特定指令实现原子操作：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 比较并交换（CAS）——无锁编程的基石</span>
<span class="hljs-function"><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> T&gt;
<span class="hljs-type">bool</span> <span class="hljs-title">atomic_compare_exchange</span><span class="hljs-params">(std::atomic&lt;T&gt;&amp; obj, 
                            T&amp; expected, 
                            T desired)</span> </span>{
    <span class="hljs-keyword">return</span> obj.<span class="hljs-built_in">compare_exchange_weak</span>(expected, desired);
}

<span class="hljs-comment">// 加载链接/条件存储（LL/SC）模式</span>
<span class="hljs-comment">// 许多架构（ARM、PowerPC）使用这种模式</span>
</code></pre>
<h2 data-id="heading-6">三、无锁数据结构设计模式</h2>
<h3 data-id="heading-7">3.1 单写入者多读取者模式</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> T&gt;
<span class="hljs-keyword">class</span> <span class="hljs-title class_">LockFreeReadMostly</span> {
    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">Node</span> {
        std::shared_ptr&lt;T&gt; data;
        Node* next;
    };
    
    std::atomic&lt;Node*&gt; head;
    
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">push</span><span class="hljs-params">(<span class="hljs-type">const</span> T&amp; value)</span> </span>{
        Node* new_node = <span class="hljs-keyword">new</span> Node{
            std::<span class="hljs-built_in">make_shared</span>&lt;T&gt;(value),
            head.<span class="hljs-built_in">load</span>()
        };
        
        <span class="hljs-comment">// 使用CAS保证原子性</span>
        <span class="hljs-keyword">while</span>(!head.<span class="hljs-built_in">compare_exchange_weak</span>(
            new_node-&gt;next, new_node));
    }
};
</code></pre>
<h3 data-id="heading-8">3.2 基于版本号的乐观锁</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> T&gt;
<span class="hljs-keyword">class</span> <span class="hljs-title class_">OptimisticLockFree</span> {
    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">Value</span> {
        T data;
        std::atomic&lt;<span class="hljs-type">uint64_t</span>&gt; version{<span class="hljs-number">0</span>};
    };
    
    std::atomic&lt;Value*&gt; current;
    
    <span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">update</span><span class="hljs-params">(<span class="hljs-type">const</span> T&amp; new_value)</span> </span>{
        Value* old_val = current.<span class="hljs-built_in">load</span>();
        Value* new_val = <span class="hljs-keyword">new</span> Value{
            new_value, 
            old_val-&gt;version + <span class="hljs-number">1</span>
        };
        
        <span class="hljs-comment">// 双重检查：版本号是否变化</span>
        <span class="hljs-keyword">if</span> (current.<span class="hljs-built_in">compare_exchange_strong</span>(
            old_val, new_val)) {
            <span class="hljs-comment">// 延迟删除旧值（内存回收问题）</span>
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
};
</code></pre>
<h2 data-id="heading-9">四、ABA问题及其解决方案</h2>
<h3 data-id="heading-10">4.1 ABA问题的本质</h3>
<p>ABA问题发生在：值从A变为B又变回A，但CAS无法检测到中间变化。</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// ABA问题示例</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Node</span> {
    <span class="hljs-type">int</span> value;
    Node* next;
};

std::atomic&lt;Node*&gt; head{<span class="hljs-literal">nullptr</span>};

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">problematic_pop</span><span class="hljs-params">()</span> </span>{
    Node* old_head = head.<span class="hljs-built_in">load</span>();
    <span class="hljs-keyword">while</span> (old_head &amp;&amp; 
           !head.<span class="hljs-built_in">compare_exchange_weak</span>(
               old_head, old_head-&gt;next)) {
        <span class="hljs-comment">// 如果old_head被释放并重新分配，可能产生ABA问题</span>
    }
}
</code></pre>
<h3 data-id="heading-11">4.2 解决方案：带标签的指针</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> T&gt;
<span class="hljs-keyword">class</span> <span class="hljs-title class_">TaggedPointer</span> {
    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">AlignedType</span> {
        T* ptr;
        <span class="hljs-type">uintptr_t</span> tag;
    };
    
    <span class="hljs-built_in">static_assert</span>(<span class="hljs-built_in">sizeof</span>(AlignedType) == <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">uintptr_t</span>),
                  <span class="hljs-string">"Bad alignment"</span>);
    
    std::atomic&lt;<span class="hljs-type">uintptr_t</span>&gt; value;
    
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">compare_exchange</span><span class="hljs-params">(T*&amp; expected_ptr,
                          T* desired_ptr,
                          <span class="hljs-type">uintptr_t</span> expected_tag,
                          <span class="hljs-type">uintptr_t</span> desired_tag)</span> </span>{
        AlignedType expected{expected_ptr, expected_tag};
        AlignedType desired{desired_ptr, desired_tag};
        
        <span class="hljs-keyword">return</span> value.<span class="hljs-built_in">compare_exchange_strong</span>(
            <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">uintptr_t</span>&amp;&gt;(expected),
            <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">uintptr_t</span>&amp;&gt;(desired));
    }
};
</code></pre>
<h2 data-id="heading-12">五、内存回收：无锁编程的阿喀琉斯之踵</h2>
<h3 data-id="heading-13">5.1 危险指针（Hazard Pointers）</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> T&gt;
<span class="hljs-keyword">class</span> <span class="hljs-title class_">HazardPointer</span> {
    <span class="hljs-type">static</span> <span class="hljs-keyword">constexpr</span> <span class="hljs-type">int</span> K = <span class="hljs-number">100</span>;  <span class="hljs-comment">// 通常每个线程2-3个足够</span>
    <span class="hljs-type">static</span> <span class="hljs-keyword">thread_local</span> std::array&lt;T*, K&gt; hazards;
    <span class="hljs-type">static</span> <span class="hljs-keyword">thread_local</span> <span class="hljs-type">int</span> index;
    
<span class="hljs-keyword">public</span>:
    <span class="hljs-keyword">class</span> <span class="hljs-title class_">Holder</span> {
        T* ptr;
    <span class="hljs-keyword">public</span>:
        <span class="hljs-function"><span class="hljs-keyword">explicit</span> <span class="hljs-title">Holder</span><span class="hljs-params">(T* p)</span> : ptr(p) {</span>
            hazards[index++] = ptr;
        }
        ~<span class="hljs-built_in">Holder</span>() { <span class="hljs-comment">/* 清理 */</span> }
    };
    
    <span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">retire</span><span class="hljs-params">(T* ptr)</span> </span>{
        <span class="hljs-comment">// 延迟到没有线程持有危险指针时再删除</span>
    }
};
</code></pre>
<h3 data-id="heading-14">5.2 引用计数与epoch-based回收</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> T&gt;
<span class="hljs-keyword">class</span> <span class="hljs-title class_">EpochBasedReclamation</span> {
    <span class="hljs-type">static</span> <span class="hljs-keyword">thread_local</span> <span class="hljs-type">uint64_t</span> local_epoch;
    <span class="hljs-type">static</span> std::atomic&lt;<span class="hljs-type">uint64_t</span>&gt; global_epoch{<span class="hljs-number">0</span>};
    <span class="hljs-type">static</span> std::array&lt;std::vector&lt;T*&gt;, 3&gt; retired_lists;
    
    <span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">enter_critical</span><span class="hljs-params">()</span> </span>{
        local_epoch = global_epoch.<span class="hljs-built_in">load</span>();
    }
    
    <span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">retire</span><span class="hljs-params">(T* ptr)</span> </span>{
        retired_lists[local_epoch % <span class="hljs-number">3</span>].<span class="hljs-built_in">push_back</span>(ptr);
        <span class="hljs-comment">// 定期尝试回收旧epoch的对象</span>
    }
};
</code></pre>
<h2 data-id="heading-15">六、实践指南：何时使用无锁编程</h2>
<h3 data-id="heading-16">6.1 适用场景</h3>
<ul>
<li>高性能交易系统</li>
<li>实时系统（避免优先级反转）</li>
<li>操作系统内核</li>
<li>数据库并发控制</li>
</ul>
<h3 data-id="heading-17">6.2 替代方案考虑</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 有时简单的原子操作就足够了</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">SimpleCounter</span> {
    std::atomic&lt;<span class="hljs-type">int64_t</span>&gt; count{<span class="hljs-number">0</span>};
    
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">increment</span><span class="hljs-params">()</span> </span>{
        count.<span class="hljs-built_in">fetch_add</span>(<span class="hljs-number">1</span>, std::memory_order_relaxed);
    }
    
    <span class="hljs-function"><span class="hljs-type">int64_t</span> <span class="hljs-title">get</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>{
        <span class="hljs-keyword">return</span> count.<span class="hljs-built_in">load</span>(std::memory_order_acquire);
    }
};

<span class="hljs-comment">// 或者使用更高级的并发库</span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;concurrentqueue.h&gt;</span></span>
moodycamel::ConcurrentQueue&lt;<span class="hljs-type">int</span>&gt; queue;
</code></pre>
<h2 data-id="heading-18">七、测试与验证挑战</h2>
<h3 data-id="heading-19">7.1 专门的测试工具</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 使用ThreadSanitizer检测数据竞争</span>
<span class="hljs-comment">// 编译时添加：-fsanitize=thread</span>

<span class="hljs-comment">// 使用Relacy检查无锁算法</span>
<span class="hljs-comment">// (http://www.1024cores.net/home/relacy-race-detector)</span>

<span class="hljs-comment">// 模型检查工具：CDSChecker、Nidhugg</span>
</code></pre>
<h3 data-id="heading-20">7.2 形式化验证的重要性</h3>
<p>复杂无锁算法应考虑使用TLA+或Coq进行形式化验证，特别是用于关键系统时。</p>
<h2 data-id="heading-21">结论：平衡的艺术</h2>
<p>无锁编程不是银弹，而是工具箱中的特殊工具。在决定使用无锁技术前，请考虑：</p>
<ol>
<li><strong>真的需要无锁吗？</strong> 锁的代价可能没有想象中高</li>
<li><strong>团队是否具备相应能力？</strong> 无锁代码难以调试和维护</li>
<li><strong>是否有合适的测试策略？</strong> 并发bug可能只在特定条件下出现</li>
<li><strong>性能提升是否值得？</strong> 测量，而不是猜测</li>
</ol>
<p>记住Donald Knuth的名言："过早优化是万恶之源"。在正确性得到保证的前提下，再考虑性能优化。无锁编程是C++并发编程的巅峰技艺，但也是最容易出错的领域之一。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>