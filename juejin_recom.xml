<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[C# 原始字符串字面量全面解析：多行字符串终于优雅了！]]></title>    <link>https://juejin.cn/post/7578699975414480896</link>    <guid>https://juejin.cn/post/7578699975414480896</guid>    <pubDate>2025-12-02T00:05:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578699975414480896" data-draft-id="7578714759337656320" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="C# 原始字符串字面量全面解析：多行字符串终于优雅了！"/> <meta itemprop="keywords" content="C#,.NET"/> <meta itemprop="datePublished" content="2025-12-02T00:05:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="唐青枫"/> <meta itemprop="url" content="https://juejin.cn/user/3737995266234280"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            C# 原始字符串字面量全面解析：多行字符串终于优雅了！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3737995266234280/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    唐青枫
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T00:05:15.000Z" title="Tue Dec 02 2025 00:05:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">简介</h3>
<p><code>C# 11</code> 引入了原始字符串字面量（<code>Raw String Literals</code>），这是一个革命性的特性，极大地简化了包含大量特殊字符（如引号、反斜杠、换行符等）的字符串处理。</p>
<p>原始字符串字面量允许创建包含任意文本的字符串，而无需转义特殊字符。它们以至少三个双引号 <code>"""</code> 开始和结束，并且可以跨越多行。</p>
<h3 data-id="heading-1">核心特性与优势</h3>
<h4 data-id="heading-2">核心特点</h4>
<ul>
<li>
<p>无转义需求：不需要对引号、反斜杠等特殊字符进行转义</p>
</li>
<li>
<p>多行支持：原生支持多行字符串格式</p>
</li>
<li>
<p>空白保留：精确保留源代码中的缩进和格式化</p>
</li>
<li>
<p>灵活分隔符：使用可变数量的双引号作为分隔符</p>
</li>
<li>
<p>字符串插值：可与插值语法无缝结合</p>
</li>
</ul>
<h4 data-id="heading-3">与传统字符串对比</h4>









































<table><thead><tr><th>特性</th><th>常规字符串</th><th>逐字字符串(@)</th><th>原始字符串字面量</th></tr></thead><tbody><tr><td>转义需求</td><td>需要转义特殊字符</td><td>不需要转义，但对双引号仍需转义</td><td>完全不需要转义</td></tr><tr><td>多行支持</td><td>需使用<code>\n</code>等</td><td>支持</td><td>原生支持</td></tr><tr><td>缩进保留</td><td>不保留</td><td>保留所有缩进</td><td>智能缩进处理</td></tr><tr><td>引号处理</td><td><code>\"</code></td><td><code>""</code></td><td>直接使用</td></tr><tr><td>JSON/XML</td><td>可读性差</td><td>可读性中等</td><td>完美呈现</td></tr></tbody></table>
<h3 data-id="heading-4">基本语法</h3>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 基本原始字符串</span>
<span class="hljs-built_in">string</span> basic = <span class="hljs-string">""</span><span class="hljs-string">"这是一个原始字符串，不需要转义 "</span>引号<span class="hljs-string">" 和 \反斜杠"</span><span class="hljs-string">""</span>;

<span class="hljs-comment">// 多行原始字符串</span>
<span class="hljs-built_in">string</span> multiLine = <span class="hljs-string">""</span><span class="hljs-string">"
    这是一个
    多行原始字符串
    可以包含 "</span>引号<span class="hljs-string">" 和 \反斜杠
    "</span><span class="hljs-string">""</span>;

<span class="hljs-comment">// 包含大括号的原始字符串</span>
<span class="hljs-built_in">string</span> withBraces = <span class="hljs-string">""</span><span class="hljs-string">"
    { "</span>name<span class="hljs-string">": "</span>John<span class="hljs-string">", "</span>age<span class="hljs-string">": 30 }
    "</span><span class="hljs-string">""</span>;
</code></pre>
<h3 data-id="heading-5">核心特性与优势</h3>
<h4 data-id="heading-6">无需转义特殊字符</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 传统方式（需要转义）</span>
<span class="hljs-built_in">string</span> traditional = <span class="hljs-string">"这是一个包含\"引号\"和\\反斜杠的字符串"</span>;

<span class="hljs-comment">// 原始字符串方式（无需转义）</span>
<span class="hljs-built_in">string</span> raw = <span class="hljs-string">""</span><span class="hljs-string">"这是一个包含"</span>引号<span class="hljs-string">"和\反斜杠的字符串"</span><span class="hljs-string">""</span>;

<span class="hljs-comment">// 正则表达式示例</span>
<span class="hljs-built_in">string</span> regexPattern = <span class="hljs-string">""</span><span class="hljs-string">"^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$"</span><span class="hljs-string">""</span>;
</code></pre>
<h4 data-id="heading-7">多行字符串处理</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 传统多行字符串（需要转义和连接）</span>
<span class="hljs-built_in">string</span> oldMultiLine = <span class="hljs-string">"第一行\n"</span> +
                     <span class="hljs-string">"第二行\n"</span> +
                     <span class="hljs-string">"第三行"</span>;

<span class="hljs-comment">// 原始多行字符串（更简洁）</span>
<span class="hljs-built_in">string</span> newMultiLine = <span class="hljs-string">""</span><span class="hljs-string">"
    第一行
    第二行
    第三行
    "</span><span class="hljs-string">""</span>;

<span class="hljs-comment">// JSON 示例</span>
<span class="hljs-built_in">string</span> json = <span class="hljs-string">""</span><span class="hljs-string">"
    {
        "</span>name<span class="hljs-string">": "</span>John Doe<span class="hljs-string">",
        "</span>age<span class="hljs-string">": 30,
        "</span>email<span class="hljs-string">": "</span>john@example.com<span class="hljs-string">"
    }
    "</span><span class="hljs-string">""</span>;
</code></pre>
<h4 data-id="heading-8">缩进处理</h4>
<p>原始字符串字面量会自动处理缩进，使代码保持整洁：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-built_in">string</span> <span class="hljs-title">GetFormattedMessage</span>()</span>
{
    <span class="hljs-keyword">return</span> <span class="hljs-string">""</span><span class="hljs-string">"
        Hello,
            This is an indented message.
        It preserves the formatting exactly as written.
        "</span><span class="hljs-string">""</span>;
}

<span class="hljs-comment">// 输出结果：</span>
<span class="hljs-comment">// Hello,</span>
<span class="hljs-comment">//     This is an indented message.</span>
<span class="hljs-comment">// It preserves the formatting exactly as written.</span>
</code></pre>
<h4 data-id="heading-9">引号数量规则</h4>
<p>当字符串内容包含三个或更多连续双引号时，需要使用更多引号作为分隔符：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 内容包含三个双引号 → 使用四个作为分隔符</span>
<span class="hljs-built_in">string</span> tripleQuotes = <span class="hljs-string">""</span><span class="hljs-string">""</span> 这里可以包含 <span class="hljs-string">""</span><span class="hljs-string">" 三个引号 "</span><span class="hljs-string">""</span><span class="hljs-string">";

// 内容包含四个双引号 → 使用五个作为分隔符
string fourQuotes = "</span><span class="hljs-string">""</span><span class="hljs-string">""</span> 这里可以包含 <span class="hljs-string">""</span><span class="hljs-string">""</span> 四个引号 <span class="hljs-string">""</span><span class="hljs-string">""</span><span class="hljs-string">";
</span></code></pre>
<p>引号数量选择原则</p>
<ul>
<li>
<p>分隔符的双引号数量(N)必须大于内容中连续双引号的最大数量(M)</p>
</li>
<li>
<p>最小分隔符数量为3（即使内容没有三个引号）</p>
</li>
<li>
<p>公式：<code>N &gt; M</code></p>
</li>
</ul>
<h4 data-id="heading-10">多$符号规则</h4>
<ul>
<li>
<p><code>$</code> 的数量决定了插值表达式的边界</p>
</li>
<li>
<p>一个 <code>$</code> → 表达式使用 <code>{ }</code></p>
</li>
<li>
<p>两个 <code>$$</code> → 表达式使用 <code>{{ }}</code>，以此类推</p>
</li>
</ul>
<h3 data-id="heading-11">高级用法与技巧</h3>
<h4 data-id="heading-12">包含更多引号</h4>
<p>如果需要字符串中包含三个或更多连续双引号，可以使用更多引号作为分隔符：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 使用四个引号作为分隔符，以包含三个引号</span>
<span class="hljs-built_in">string</span> withTripleQuotes = <span class="hljs-string">""</span><span class="hljs-string">""</span>
    这个字符串包含三个连续引号: <span class="hljs-string">""</span><span class="hljs-string">"
    "</span><span class="hljs-string">""</span><span class="hljs-string">";

// 使用五个引号作为分隔符，以包含四个引号
string withFourQuotes = "</span><span class="hljs-string">""</span><span class="hljs-string">""</span>
    这个字符串包含四个连续引号: <span class="hljs-string">""</span><span class="hljs-string">""</span>
    <span class="hljs-string">""</span><span class="hljs-string">""</span><span class="hljs-string">";
</span></code></pre>
<h4 data-id="heading-13">与字符串插值结合使用</h4>
<p>原始字符串可以与字符串插值结合使用，提供更强大的功能：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-built_in">string</span> name = <span class="hljs-string">"John"</span>;
<span class="hljs-built_in">int</span> age = <span class="hljs-number">30</span>;

<span class="hljs-comment">// 基本插值</span>
<span class="hljs-built_in">string</span> interpolated = $<span class="hljs-string">$""</span><span class="hljs-string">"
    {
        "</span>name<span class="hljs-string">": "</span>{{name}}<span class="hljs-string">",
        "</span>age<span class="hljs-string">": {{age}}
    }
    "</span><span class="hljs-string">""</span>;

<span class="hljs-comment">// 复杂插值（使用多个$符号）</span>
<span class="hljs-built_in">string</span> complex = $$<span class="hljs-string">$""</span><span class="hljs-string">"
    {
        "</span>name<span class="hljs-string">": "</span>{{{name}}}<span class="hljs-string">",  // 注意：这里需要三个大括号
        "</span>age<span class="hljs-string">": {{age}}
    }
    "</span><span class="hljs-string">""</span>;
</code></pre>
<h4 data-id="heading-14">最小化缩进</h4>
<p>原始字符串会自动去除与结束引号对齐的缩进：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-built_in">string</span> minimalIndent = <span class="hljs-string">""</span><span class="hljs-string">"
    First line
    Second line
    Third line
    "</span><span class="hljs-string">""</span>; <span class="hljs-comment">// 结束引号的缩进决定了最小缩进</span>

<span class="hljs-comment">// 等效于：</span>
<span class="hljs-comment">// "First line\nSecond line\nThird line"</span>
</code></pre>
<h3 data-id="heading-15">实际应用场景</h3>
<h4 data-id="heading-16">JSON 和 XML 处理</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// JSON 配置</span>
<span class="hljs-built_in">string</span> configJson = <span class="hljs-string">""</span><span class="hljs-string">"
    {
        "</span>appSettings<span class="hljs-string">": {
            "</span>timeout<span class="hljs-string">": 30,
            "</span>retryCount<span class="hljs-string">": 3,
            "</span>apiUrl<span class="hljs-string">": "</span>https:<span class="hljs-comment">//api.example.com"</span>
        },
        <span class="hljs-string">"logging"</span>: {
            <span class="hljs-string">"level"</span>: <span class="hljs-string">"Information"</span>,
            <span class="hljs-string">"filePath"</span>: <span class="hljs-string">"logs/app.log"</span>
        }
    }
    <span class="hljs-string">""</span><span class="hljs-string">";

// XML 文档
string xmlDocument = "</span><span class="hljs-string">""</span>
    &lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span>?&gt;
    &lt;catalog&gt;
        &lt;book id=<span class="hljs-string">"bk101"</span>&gt;
            &lt;author&gt;Gambardella, Matthew&lt;/author&gt;
            &lt;title&gt;XML Developer<span class="hljs-string">'s Guide&lt;/title&gt;
            &lt;genre&gt;Computer&lt;/genre&gt;
            &lt;price&gt;44.95&lt;/price&gt;
            &lt;publish_date&gt;2000-10-01&lt;/publish_date&gt;
            &lt;description&gt;An in-depth look at creating applications with XML.&lt;/description&gt;
        &lt;/book&gt;
    &lt;/catalog&gt;
    """;
</span></code></pre>
<h4 data-id="heading-17">正则表达式模式</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 复杂的正则表达式（无需转义反斜杠）</span>
<span class="hljs-built_in">string</span> emailPattern = <span class="hljs-string">""</span><span class="hljs-string">"^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$"</span><span class="hljs-string">""</span>;
<span class="hljs-built_in">string</span> phonePattern = <span class="hljs-string">""</span><span class="hljs-string">"^(\+\d{1,3}\s?)?(\(\d{1,4}\)\s?)?\d{1,4}[\s.-]?\d{1,4}[\s.-]?\d{1,9}$"</span><span class="hljs-string">""</span>;

<span class="hljs-comment">// 使用正则表达式</span>
<span class="hljs-built_in">bool</span> isValidEmail = Regex.IsMatch(<span class="hljs-string">"test@example.com"</span>, emailPattern);
</code></pre>
<h4 data-id="heading-18">SQL 查询</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-built_in">string</span> sqlQuery = <span class="hljs-string">""</span><span class="hljs-string">"
    SELECT 
        u.Id,
        u.Name,
        u.Email,
        COUNT(o.Id) AS OrderCount
    FROM Users u
    LEFT JOIN Orders o ON u.Id = o.UserId
    WHERE u.IsActive = 1
    GROUP BY u.Id, u.Name, u.Email
    HAVING COUNT(o.Id) &gt; 0
    ORDER BY OrderCount DESC
    "</span><span class="hljs-string">""</span>;
</code></pre>
<h4 data-id="heading-19">代码生成</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-built_in">string</span> <span class="hljs-title">GenerateCSharpClass</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> className, IEnumerable&lt;<span class="hljs-built_in">string</span>&gt; properties</span>)</span>
{
    <span class="hljs-keyword">return</span> $<span class="hljs-string">$""</span><span class="hljs-string">"
        public class {{className}}
        {
            {{string.Join("</span>\n    <span class="hljs-string">", properties.Select(p =&gt; $"</span><span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> {p} {{ <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }}<span class="hljs-string">"))}}
            
            public {{className}}()
            {
            }
            
            public override string ToString()
            {
                return $"</span>{{
                    {{<span class="hljs-built_in">string</span>.Join(<span class="hljs-string">", "</span>, properties.Select(p =&gt; <span class="hljs-string">$"<span class="hljs-subst">{p}</span>={{<span class="hljs-subst">{p}</span>}}"</span>))}}
                }}<span class="hljs-string">";
            }
        }
        "</span><span class="hljs-string">""</span>;
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-built_in">string</span> classCode = GenerateCSharpClass(<span class="hljs-string">"Person"</span>, <span class="hljs-keyword">new</span>[] { <span class="hljs-string">"FirstName"</span>, <span class="hljs-string">"LastName"</span>, <span class="hljs-string">"Age"</span> });
</code></pre>
<h3 data-id="heading-20">总结</h3>
<p><code>C# 11</code> 的原始字符串字面量是一个强大的特性，它：</p>
<ul>
<li>
<p>消除转义需求：无需转义引号、反斜杠等特殊字符</p>
</li>
<li>
<p>支持多行内容：轻松创建多行字符串，保持格式</p>
</li>
<li>
<p>智能缩进处理：自动处理缩进，使代码更整洁</p>
</li>
<li>
<p>与插值结合：支持字符串插值，创建动态内容</p>
</li>
<li>
<p>编译时处理：无运行时性能开销</p>
</li>
</ul>
<p>适用场景：</p>
<ul>
<li>
<p><code>JSON/XML/HTML</code> 内容：处理结构化数据</p>
</li>
<li>
<p>正则表达式：编写复杂的模式匹配</p>
</li>
</ul>
<p><code>SQL</code> 查询：编写多行数据库查询</p>
<ul>
<li>
<p>代码生成：创建模板化代码</p>
</li>
<li>
<p>文档字符串：编写格式化的文档</p>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深入alova3服务端能力：分布式BFF层到API网关的最佳实践]]></title>    <link>https://juejin.cn/post/7578820431018622991</link>    <guid>https://juejin.cn/post/7578820431018622991</guid>    <pubDate>2025-12-02T00:07:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578820431018622991" data-draft-id="7578714735307653146" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深入alova3服务端能力：分布式BFF层到API网关的最佳实践"/> <meta itemprop="keywords" content="Node.js,JavaScript,Redis"/> <meta itemprop="datePublished" content="2025-12-02T00:07:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="古韵"/> <meta itemprop="url" content="https://juejin.cn/user/1538972010422872"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深入alova3服务端能力：分布式BFF层到API网关的最佳实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1538972010422872/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    古韵
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T00:07:14.000Z" title="Tue Dec 02 2025 00:07:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>可能大家对alova还停留在轻量化的请求策略库的层面，这当然是alova2的核心特点，比如以下这段</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> { loading, data, error } = <span class="hljs-title function_">useRequest</span>(<span class="hljs-function">() =&gt;</span> alovaInstance.<span class="hljs-title class_">Get</span>(<span class="hljs-string">'/xxx'</span>))
</code></pre>
<p>这是一段alova在客户端使用的典型代码，不过现在alova已经更新到3了，当然这些client strategies依然是原汁原味的，不过它不仅局限于客户端，而是在服务端也可以游刃有余了。</p>
<p>在alova3中提供了服务端请求策略（server hooks）和redis、file等服务端的存储适配器，可以让我们很方便地在服务端实现全链路的请求和转发。</p>
<p>我们先来看一个请求的全流程：</p>
<pre><code class="hljs language-plaintext" lang="plaintext">客户端（浏览器/App）
    → Node.js BFF 层（转换数据等）
    → API 网关（鉴权、速率限制、路由分发等）
    → 后端微服务
</code></pre>
<p>alova提供的server hook和分布式的多级缓存，可以让我们很方便地实现以上的全部层级的请求处理。</p>
<h2 data-id="heading-0">在BFF层转发客户端请求</h2>
<p>在BFF层中经常需要转发客户端请求到后端微服务，你可以使用配合<code>async_hooks</code>访问每个请求的上下文，并在alova的<code>beforeRequest</code>中添加到请求中，实现用户相关数据的转发。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { createAlova } <span class="hljs-keyword">from</span> <span class="hljs-string">'alova'</span>;
<span class="hljs-keyword">import</span> adapterFetch <span class="hljs-keyword">from</span> <span class="hljs-string">'@alova/fetch'</span>;
<span class="hljs-keyword">import</span> express <span class="hljs-keyword">from</span> <span class="hljs-string">'express'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">AsyncLocalStorage</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'node:async_hooks'</span>;

<span class="hljs-comment">// 创建异步本地存储实例</span>
<span class="hljs-keyword">const</span> asyncLocalStorage = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AsyncLocalStorage</span>();

<span class="hljs-keyword">const</span> alovaInstance = <span class="hljs-title function_">createAlova</span>({
  <span class="hljs-attr">requestAdapter</span>: <span class="hljs-title function_">adapterFetch</span>(),
  <span class="hljs-title function_">beforeRequest</span>(<span class="hljs-params">method</span>) {
    <span class="hljs-comment">// 从异步上下文中获取请求头并传递到下游</span>
    <span class="hljs-keyword">const</span> context = asyncLocalStorage.<span class="hljs-title function_">getStore</span>();
    <span class="hljs-keyword">if</span> (context &amp;&amp; context.<span class="hljs-property">headers</span>) {
      method.<span class="hljs-property">config</span>.<span class="hljs-property">headers</span> = {
        ...method.<span class="hljs-property">config</span>.<span class="hljs-property">headers</span>,
        ...context.<span class="hljs-property">headers</span>
      };
    }
  },
  <span class="hljs-attr">responded</span>: {
    <span class="hljs-title function_">onSuccess</span>(<span class="hljs-params">response</span>) {
      <span class="hljs-comment">// 数据转换处理</span>
      <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">data</span>: response.<span class="hljs-property">data</span>,
        <span class="hljs-attr">timestamp</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>(),
        <span class="hljs-attr">transformed</span>: <span class="hljs-literal">true</span>
      };
    },
    <span class="hljs-title function_">onError</span>(<span class="hljs-params">error</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Request failed:'</span>, error);
      <span class="hljs-keyword">throw</span> error;
    }
  }
});

<span class="hljs-keyword">const</span> app = <span class="hljs-title function_">express</span>();

<span class="hljs-comment">// 中间件里设置一次，全程自动传递</span>
app.<span class="hljs-title function_">use</span>(<span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> context = {
    <span class="hljs-attr">userId</span>: req.<span class="hljs-property">headers</span>[<span class="hljs-string">'x-user-id'</span>],
    <span class="hljs-attr">token</span>: req.<span class="hljs-property">headers</span>[<span class="hljs-string">'authorization'</span>]
  };
  asyncLocalStorage.<span class="hljs-title function_">run</span>(context, next);
});

<span class="hljs-comment">// 业务代码专注业务逻辑</span>
app.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/api/user-profile'</span>, <span class="hljs-keyword">async</span> (req, res) =&gt; {
  <span class="hljs-comment">// 不用手动传递上下文了！</span>
  <span class="hljs-keyword">const</span> [userInfo, orders] = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>([
    alovaInstance.<span class="hljs-title class_">Get</span>(<span class="hljs-string">'http://gateway.com/user/profile'</span>),
    alovaInstance.<span class="hljs-title class_">Get</span>(<span class="hljs-string">'http://gateway.com/order/recent'</span>)
  ]);
  
  res.<span class="hljs-title function_">json</span>({ <span class="hljs-attr">user</span>: userInfo.<span class="hljs-property">data</span>, <span class="hljs-attr">orders</span>: orders.<span class="hljs-property">data</span> });
});
</code></pre>
<h2 data-id="heading-1">API网关中的使用场景</h2>
<p>在网关中经常需要进行鉴权、请求速率限制以及请求分发等，alova3的redis存储适配器和rateLimiter可以很好地实现分布式的鉴权服务和请求速率限制。</p>
<h3 data-id="heading-2">鉴权可以这么搞</h3>
<p>如果鉴权token有一定的过期时间，可在网关中配置redis存储适配器，将token存储在redis中便于重复使用，对于单机的集群服务也可以使用<a href="https://link.juejin.cn?target=https%3A%2F%2Falova.js.org%2Fresource%2Fstorage-adapter%2Ffile" target="_blank" title="https://alova.js.org/resource/storage-adapter/file" ref="nofollow noopener noreferrer"><code>@alova/storage-file</code></a>文件存储适配器。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { createAlova } <span class="hljs-keyword">from</span> <span class="hljs-string">'alova'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">RedisStorageAdapter</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'@alova/storage-redis'</span>;
<span class="hljs-keyword">import</span> adapterFetch <span class="hljs-keyword">from</span> <span class="hljs-string">'@alova/fetch'</span>;
<span class="hljs-keyword">import</span> express <span class="hljs-keyword">from</span> <span class="hljs-string">'express'</span>;

<span class="hljs-keyword">const</span> redisAdapter = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RedisStorageAdapter</span>({
  <span class="hljs-attr">host</span>: <span class="hljs-string">'localhost'</span>,
  <span class="hljs-attr">port</span>: <span class="hljs-string">'6379'</span>,
  <span class="hljs-attr">username</span>: <span class="hljs-string">'default'</span>,
  <span class="hljs-attr">password</span>: <span class="hljs-string">'my-top-secret'</span>,
  <span class="hljs-attr">db</span>: <span class="hljs-number">0</span>
});

<span class="hljs-keyword">const</span> gatewayAlova = <span class="hljs-title function_">createAlova</span>({
  <span class="hljs-attr">requestAdapter</span>: <span class="hljs-title function_">adapterFetch</span>(),
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">beforeRequest</span>(<span class="hljs-params">method</span>) {
    <span class="hljs-keyword">const</span> newToken = <span class="hljs-keyword">await</span> <span class="hljs-title function_">authRequest</span>(method.<span class="hljs-property">config</span>.<span class="hljs-property">headers</span>[<span class="hljs-string">'Authorization'</span>], method.<span class="hljs-property">config</span>.<span class="hljs-property">headers</span>[<span class="hljs-string">'UserId'</span>])
    method.<span class="hljs-property">config</span>.<span class="hljs-property">headers</span>[<span class="hljs-string">'Authorization'</span>] = <span class="hljs-string">`Bearer <span class="hljs-subst">${newToken}</span>`</span>;
  }
  <span class="hljs-comment">// 设置2级存储适配器</span>
  <span class="hljs-attr">l2Cache</span>: redisAdapter,
  <span class="hljs-comment">// ...</span>
});

<span class="hljs-keyword">const</span> <span class="hljs-title function_">authRequest</span> = (<span class="hljs-params">token, userId</span>) =&gt; gatewayAlova.<span class="hljs-title class_">Post</span>(<span class="hljs-string">'http://auth.com/auth/token'</span>, <span class="hljs-literal">null</span>, {
  <span class="hljs-comment">// 设置3个小时的缓存，将保存在redis中，再次以相同参数请求会命中缓存</span>
  <span class="hljs-attr">cacheFor</span>: {
    <span class="hljs-attr">mode</span>: <span class="hljs-string">'restore'</span>,
    <span class="hljs-attr">expire</span>: <span class="hljs-number">3</span> * <span class="hljs-number">3600</span> * <span class="hljs-number">1000</span>
  },
  <span class="hljs-attr">headers</span>: {
    <span class="hljs-string">'x-user-id'</span>: userId,
    <span class="hljs-string">'Authorization'</span>: <span class="hljs-string">`Bearer <span class="hljs-subst">${token}</span>`</span>
  }
});

<span class="hljs-keyword">const</span> app = <span class="hljs-title function_">express</span>();

<span class="hljs-comment">// 实现app接收所有请求，并转发到alova</span>
<span class="hljs-comment">// 注册所有 HTTP 方法的路由</span>
<span class="hljs-keyword">const</span> methods = [<span class="hljs-string">'get'</span>, <span class="hljs-string">'post'</span>, <span class="hljs-string">'put'</span>, <span class="hljs-string">'delete'</span>, <span class="hljs-string">'patch'</span>, <span class="hljs-string">'options'</span>, <span class="hljs-string">'head'</span>];
methods.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">method</span> =&gt;</span> {
  app[method](<span class="hljs-string">'*'</span>, <span class="hljs-keyword">async</span> (req, res) =&gt; {
    <span class="hljs-keyword">const</span> { method, originalUrl, headers, body, query } = req;

    <span class="hljs-comment">// 使用 alova 发送请求</span>
    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> gatewayAlova.<span class="hljs-title class_">Request</span>({
      <span class="hljs-attr">method</span>: method.<span class="hljs-title function_">toLowerCase</span>(),
      <span class="hljs-attr">url</span>: originalUrl,
      <span class="hljs-attr">params</span>: query,
      <span class="hljs-attr">data</span>: body,
      headers
    });
    
    <span class="hljs-comment">// 转发响应头部</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> [key, value] <span class="hljs-keyword">of</span> response.<span class="hljs-property">headers</span>.<span class="hljs-title function_">entries</span>()) {
      res.<span class="hljs-title function_">setHeader</span>(key, value);
    }
    
    <span class="hljs-comment">// 发送响应数据</span>
    res.<span class="hljs-title function_">status</span>(response.<span class="hljs-property">status</span>).<span class="hljs-title function_">send</span>(<span class="hljs-keyword">await</span> response.<span class="hljs-title function_">json</span>());
  });
});

app.<span class="hljs-title function_">listen</span>(<span class="hljs-number">3000</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Gateway server started on port 3000'</span>);
});
</code></pre>
<p>当然，如果需要每次请求都重新鉴权，也可以在<code>authRequest</code>中去掉<code>cacheFor</code>关闭缓存。</p>
<h2 data-id="heading-3">限流策略</h2>
<p>alova的rateLimiter可以实现分布式的限流策略，内部使用<code>node-rate-limiter-flexible</code>实现，我们改造一下实现。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { createRateLimiter } <span class="hljs-keyword">from</span> <span class="hljs-string">'alova/server'</span>;

<span class="hljs-keyword">const</span> rateLimit = <span class="hljs-title function_">createRateLimiter</span>({
  <span class="hljs-comment">/**
   * 点数重置的时间，单位ms
   * <span class="hljs-doctag">@default</span> 4000
   */</span>
  <span class="hljs-attr">duration</span>: <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>,
  <span class="hljs-comment">/**
   * duration内可消耗的最大数量
   * <span class="hljs-doctag">@default</span> 4
   */</span>
  <span class="hljs-attr">points</span>: <span class="hljs-number">4</span>,
  <span class="hljs-comment">/**
   * 命名空间，多个rateLimit使用相同存储器时可防止冲突
   */</span>
  <span class="hljs-attr">keyPrefix</span>: <span class="hljs-string">'user-rate-limit'</span>,
  <span class="hljs-comment">/**
   * 锁定时长，单位ms，表示当到达速率限制后，将延长[blockDuration]ms，例如1小时内密码错误5次，则锁定24小时，这个24小时就是此参数
   */</span>
  <span class="hljs-attr">blockDuration</span>: <span class="hljs-number">24</span> * <span class="hljs-number">60</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>
});

<span class="hljs-keyword">const</span> methods = [<span class="hljs-string">'get'</span>, <span class="hljs-string">'post'</span>, <span class="hljs-string">'put'</span>, <span class="hljs-string">'delete'</span>, <span class="hljs-string">'patch'</span>, <span class="hljs-string">'options'</span>, <span class="hljs-string">'head'</span>];
methods.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">method</span> =&gt;</span> {
  app[method](<span class="hljs-string">'*'</span>, <span class="hljs-keyword">async</span> (req, res) =&gt; {
    <span class="hljs-keyword">const</span> { method, originalUrl, headers, body, query } = req;

    <span class="hljs-comment">// 在此使用rateLimit包裹调用即可，它将默认使用l2Cache存储适配器作为控制参数的存储，这边的例子会用redis存储适配器。</span>
    <span class="hljs-keyword">const</span> method = gatewayAlova.<span class="hljs-title class_">Request</span>({
      <span class="hljs-attr">method</span>: method.<span class="hljs-title function_">toLowerCase</span>(),
      <span class="hljs-attr">url</span>: originalUrl,
      <span class="hljs-attr">params</span>: query,
      <span class="hljs-attr">data</span>: body,
      headers
    });
    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">rateLimit</span>(method, {
      <span class="hljs-attr">key</span>: req.<span class="hljs-property">ip</span> <span class="hljs-comment">// 使用ip作为追踪key，防止同一ip频繁请求</span>
    });
    
    <span class="hljs-comment">// ...</span>
  });
});
</code></pre>
<h2 data-id="heading-4">第三方服务集成：令牌自动维护</h2>
<p>和外部API打交道需要access_token管理，并且很多第三方access_token具有调用限制，在这里我们可以使用alova3+redis存储适配器来实现分布式的access_token生命周期自动维护，其中redis用于access_token缓存，atom hook用于分布式更新token的原子性操作。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { createAlova, queryCache } <span class="hljs-keyword">from</span> <span class="hljs-string">'alova'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">RedisStorageAdapter</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'@alova/storage-redis'</span>;
<span class="hljs-keyword">import</span> adapterFetch <span class="hljs-keyword">from</span> <span class="hljs-string">'@alova/fetch'</span>;
<span class="hljs-keyword">import</span> { atomize } <span class="hljs-keyword">from</span> <span class="hljs-string">'alova/server'</span>;

<span class="hljs-keyword">const</span> redisAdapter = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RedisStorageAdapter</span>({
  <span class="hljs-attr">host</span>: <span class="hljs-string">'localhost'</span>,
  <span class="hljs-attr">port</span>: <span class="hljs-string">'6379'</span>,
  <span class="hljs-attr">username</span>: <span class="hljs-string">'default'</span>,
  <span class="hljs-attr">password</span>: <span class="hljs-string">'my-top-secret'</span>,
  <span class="hljs-attr">db</span>: <span class="hljs-number">0</span>
});
<span class="hljs-keyword">const</span> thirdPartyAlova = <span class="hljs-title function_">createAlova</span>({
  <span class="hljs-attr">requestAdapter</span>: <span class="hljs-title function_">adapterFetch</span>(),
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">beforeRequest</span>(<span class="hljs-params">method</span>) {
    <span class="hljs-comment">// 判断是否为第三方API，如果是的话则获取令牌</span>
    <span class="hljs-keyword">if</span> (method.<span class="hljs-property">meta</span>?.<span class="hljs-property">isThirdPartyApi</span>) {
      <span class="hljs-comment">// 以原子性的方式获取令牌，防止多进程同时获取token</span>
      <span class="hljs-keyword">const</span> accessTokenGetMethod = <span class="hljs-title function_">getAccessToken</span>();
      <span class="hljs-keyword">let</span> accessToken = <span class="hljs-keyword">await</span> <span class="hljs-title function_">queryCache</span>(accessTokenGetMethod);
      <span class="hljs-keyword">if</span> (!accessToken) {
        <span class="hljs-comment">// 获取成功后将会缓存</span>
        accessToken = <span class="hljs-keyword">await</span> <span class="hljs-title function_">atomize</span>(accessTokenGetMethod);
      }
      method.<span class="hljs-property">config</span>.<span class="hljs-property">params</span>.<span class="hljs-property">access_token</span> = accessToken;
    }
  },
  <span class="hljs-attr">l2Cache</span>: redisAdapter,
});

<span class="hljs-keyword">const</span> <span class="hljs-title function_">getAccessToken</span> = (<span class="hljs-params"/>) =&gt; thirdPartyAlova.<span class="hljs-title class_">Get</span>(<span class="hljs-string">'http://third-party.com/token'</span>, {
  <span class="hljs-attr">params</span>: {
    <span class="hljs-attr">grant_type</span>: <span class="hljs-string">'client_credentials'</span>,
    <span class="hljs-attr">client_id</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">THIRD_PARTY_CLIENT_ID</span>,
    <span class="hljs-attr">client_secret</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">THIRD_PARTY_CLIENT_SECRET</span>
  },
  <span class="hljs-attr">cacheFor</span>: {
    <span class="hljs-attr">mode</span>: <span class="hljs-string">'restore'</span>,
    <span class="hljs-attr">expire</span>: <span class="hljs-number">1</span> * <span class="hljs-number">3600</span> * <span class="hljs-number">1000</span> <span class="hljs-comment">// 两小时缓存时间</span>
  }
});

<span class="hljs-keyword">const</span> <span class="hljs-title function_">getThirdPartyUserInfo</span> = userId =&gt; thirdPartyAlova.<span class="hljs-title class_">Get</span>(<span class="hljs-string">'http://third-party.com/user/info'</span>, {
  <span class="hljs-attr">params</span>: {
    userId
  },
  <span class="hljs-attr">meta</span>: {
    <span class="hljs-attr">isThirdPartyApi</span>: <span class="hljs-literal">true</span>
  }
});
</code></pre>
<h2 data-id="heading-5">写在最后</h2>
<p>除此以外，alova还提供了分布式的验证码发送和验证、请求重试等server hooks，想了解更多的同学可以参考<a href="https://link.juejin.cn?target=https%3A%2F%2Falova.js.org%2Ftutorial%2Fserver%2Fstrategy%2F" target="_blank" title="https://alova.js.org/tutorial/server/strategy/" ref="nofollow noopener noreferrer">服务端请求策略</a>。</p>
<p>如果觉得alova还不错，真诚希望你可以<a href="https://link.juejin.cn?target=https%3A%2F%2Falova.js.org%2Fexamples" target="_blank" title="https://alova.js.org/examples" ref="nofollow noopener noreferrer">尝试体验一下</a>，也可以给我们来一个免费的<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Falovajs%2Falova" target="_blank" title="https://github.com/alovajs/alova" ref="nofollow noopener noreferrer">github stars</a>。</p>
<p>访问alovajs的官网查看更多详细信息：<a href="https://link.juejin.cn?target=https%3A%2F%2Falova.js.org" target="_blank" title="https://alova.js.org" ref="nofollow noopener noreferrer">alovajs官网</a>。</p>
<p>有兴趣可以加入我们的交流社区，在第一时间获取到最新进展，也能直接和开发团队交流，提出你的想法和建议。</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Falova.js.org%2Fimg%2Fwechat_qrcode.jpg" target="_blank" title="https://alova.js.org/img/wechat_qrcode.jpg" ref="nofollow noopener noreferrer">加入微信群参与交流</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdiscord.gg%2FS47QGJgkVb" target="_blank" title="https://discord.gg/S47QGJgkVb" ref="nofollow noopener noreferrer">加入在 Discord 社区参与交流</a></li>
</ul>
<p>有任何问题，你可以加入以下群聊咨询，也可以在<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Falovajs%2Falova%2Fdiscussions" target="_blank" title="https://github.com/alovajs/alova/discussions" ref="nofollow noopener noreferrer">github 仓库中发布 Discussions</a>，如果遇到问题，也请在<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Falovajs%2Falova%2Fissues" target="_blank" title="https://github.com/alovajs/alova/issues" ref="nofollow noopener noreferrer">github 的 issues</a>中提交，我们会在最快的时间解决。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2025前端面试题-JavaScript基础篇]]></title>    <link>https://juejin.cn/post/7578705123209625643</link>    <guid>https://juejin.cn/post/7578705123209625643</guid>    <pubDate>2025-12-02T00:09:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578705123209625643" data-draft-id="7502485531650752566" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="2025前端面试题-JavaScript基础篇"/> <meta itemprop="keywords" content="前端,面试,JavaScript"/> <meta itemprop="datePublished" content="2025-12-02T00:09:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="EB_Coder"/> <meta itemprop="url" content="https://juejin.cn/user/3228641967213214"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            2025前端面试题-JavaScript基础篇
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3228641967213214/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    EB_Coder
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T00:09:40.000Z" title="Tue Dec 02 2025 00:09:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>以下为JavaScript基础篇面试考察点总结，具体知识点不会太详细，主要梳理面试核心考察点，为面试做准备。掌握这些基础知识，不仅是完成日常工作的基本要求，更是未来向中高级发展的基石。</p>
</blockquote>
<ul>
<li><a href="https://juejin.cn/post/7503111373468893193" target="_blank" title="https://juejin.cn/post/7503111373468893193">2025前端面试题-Vue3基础篇</a></li>
<li><a href="https://juejin.cn/post/7511568225987051555" target="_blank" title="https://juejin.cn/post/7511568225987051555">2025前端面试题-Vue3进阶篇</a></li>
<li><a href="https://juejin.cn/post/7503811658198286388" target="_blank" title="https://juejin.cn/post/7503811658198286388">2025前端面试题-React基础篇</a></li>
<li><a href="https://juejin.cn/post/7504545616841965583" target="_blank" title="https://juejin.cn/post/7504545616841965583">2025前端面试题-React进阶篇</a></li>
<li><a href="https://juejin.cn/post/7504926961627054099" target="_blank" title="https://juejin.cn/post/7504926961627054099">2025前端面试题-React高阶篇</a></li>
<li><a href="https://juejin.cn/spost/7530179511728930856" target="_blank" title="https://juejin.cn/spost/7530179511728930856">2025前端面试题-TS理论篇</a></li>
<li><a href="https://juejin.cn/post/7533826195352829988" target="_blank" title="https://juejin.cn/post/7533826195352829988">2025前端面试题-TS实战篇</a></li>
</ul>
<h2 data-id="heading-0">一、 数据类型与内存机制</h2>
<h3 data-id="heading-1">1. 基本数据类型</h3>
<ul>
<li><code>String</code></li>
<li><code>Number</code></li>
<li><code>Boolean</code></li>
<li><code>Null</code></li>
<li><code>Undefined</code></li>
<li><code>Symbol</code> <em>(ES6)</em></li>
<li><code>BigInt</code> <em>(ES2020)</em></li>
</ul>
<h4 data-id="heading-2">特点</h4>
<ul>
<li>存储在 <strong>栈内存 (Stack)</strong> 中；</li>
<li>当一个变量被赋值为基本类型时，它直接持有该值；</li>
<li>变量之间的赋值是值的复制。</li>
</ul>
<h3 data-id="heading-3">2. 引用数据类型</h3>
<p><strong>主要是</strong>: <code>Object</code> (包括普通对象、<code>Array</code>、<code>Function</code>、<code>Date</code>等)。</p>
<h4 data-id="heading-4">特点</h4>
<ul>
<li>值本身（即对象实体）存储在<strong>堆内存 (Heap)<strong>中，而变量的值是指向该堆内存地址的</strong>引用</strong>，该引用存储在<strong>栈内存</strong>中；</li>
<li>变量之间的赋值是引用的复制。</li>
</ul>
<h4 data-id="heading-5">面试题代码示例</h4>
<h5 data-id="heading-6">示例1: 基本类型赋值</h5>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">let</span> a = <span class="hljs-number">10</span>;
<span class="hljs-keyword">let</span> b = a;
b = <span class="hljs-number">20</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(a); <span class="hljs-comment">// 输出什么？</span>
<span class="hljs-comment">// 解析: a 的值仍然是 10。因为 b = a 是值的复制，后续对 b 的修改不影响 a。</span>
</code></pre>
<h5 data-id="heading-7">示例2: 引用类型赋值</h5>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">let</span> obj1 = { <span class="hljs-attr">name</span>: <span class="hljs-string">'Mickey'</span> };
<span class="hljs-keyword">let</span> obj2 = obj1;
obj2.<span class="hljs-property">name</span> = <span class="hljs-string">'Donald'</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(obj1.<span class="hljs-property">name</span>); <span class="hljs-comment">// 输出什么？</span>
<span class="hljs-comment">// 解析: 输出 'Donald'。因为 obj2 = obj1 是引用的复制，obj1 和 obj2 指向同一个堆内存地址。</span>
<span class="hljs-comment">// 通过 obj2 修改对象的属性，obj1 也会发生这个变化。</span>
</code></pre>
<h3 data-id="heading-8">3. 类型判断</h3>
<h4 data-id="heading-9"><code>typeof</code></h4>
<p>通常用于判断<strong>基本类型</strong>，但有两个特例：</p>
<ul>
<li><code>typeof null</code> 返回 <code>'object'</code> (这是一个历史遗留问题)</li>
<li><code>typeof</code> 无法细分对象类型（如<code>Array</code>, <code>Date</code>）。</li>
</ul>
<h4 data-id="heading-10"><code>instanceof</code></h4>
<p>用于判断一<strong>个对象是否是某个构造函数的实例</strong>，其原理是<strong>基于原型链的查找</strong>。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-keyword">typeof</span> <span class="hljs-number">123</span>); <span class="hljs-comment">// "number"</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-keyword">typeof</span> <span class="hljs-literal">null</span>); <span class="hljs-comment">// "object"</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-keyword">typeof</span> {}); <span class="hljs-comment">// "object"</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-keyword">typeof</span> []); <span class="hljs-comment">// "object"</span>

<span class="hljs-keyword">const</span> arr = [];
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arr <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Array</span>); <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arr <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Object</span>); <span class="hljs-comment">// true (因为 Array 的原型链最终指向 Object)</span>
</code></pre>
<h2 data-id="heading-11">二、 变量声明: <code>var</code>, <code>let</code> 与 <code>const</code></h2>
<p>这是ES6以来前端面试的必考点，要求清晰阐述三者的核心差异。</p>



































<table><thead><tr><th>特性</th><th><code>var</code></th><th><code>let</code></th><th><code>const</code></th></tr></thead><tbody><tr><td><strong>作用域</strong></td><td>函数作用域</td><td>块级作用域 (<code>{}</code>)</td><td>块级作用域 (<code>{}</code>)</td></tr><tr><td><strong>变量提升 (Hoisting)</strong></td><td>存在 (声明提升，赋值不提升)</td><td>不存在 (存在暂时性死区<code>TDZ</code>)</td><td>不存在 (存在暂时性死区 <code>TDZ</code>)</td></tr><tr><td><strong>重复声明</strong></td><td>允许</td><td>不允许</td><td>不允许</td></tr><tr><td><strong>重新赋值</strong></td><td>允许</td><td>允许</td><td>不允许</td></tr></tbody></table>
<h3 data-id="heading-12">面试题代码示例</h3>
<h4 data-id="heading-13">1. 作用域与变量提升</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// var 的变量提升</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(foo); <span class="hljs-comment">// undefined</span>
<span class="hljs-keyword">var</span> foo = <span class="hljs-string">'Hello'</span>;

<span class="hljs-comment">// let 的暂时性死区</span>
<span class="hljs-comment">// console.log(bar); // Uncaught ReferenceError: Cannot access 'bar' before initialization</span>
<span class="hljs-keyword">let</span> bar = <span class="hljs-string">'World'</span>;
</code></pre>
<h4 data-id="heading-14">2. <code>const</code> 的不变性</h4>
<p>面试会考察是否理解 <code>const</code> 的“不变”是指针（引用）的不变，而不是其指向内容的不变。</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">person</span> = {
  name: 'Mickey',
  age: 30
}<span class="hljs-comment">;</span>

// <span class="hljs-attr">person</span> = {}<span class="hljs-comment">; // 会抛出 TypeError: Assignment to constant variable.</span>

<span class="hljs-attr">person.age</span> = <span class="hljs-number">31</span><span class="hljs-comment">; // 这是允许的，因为我们修改的是对象内部的属性，而不是 person 变量的引用。</span>
console.log(person.age)<span class="hljs-comment">; // 31</span>
</code></pre>
<h2 data-id="heading-15">三、 运算符</h2>
<ul>
<li>
<p><strong>算术运算符</strong>: <code>+</code>, <code>-</code>, <code>*</code>, <code>/</code>, <code>%</code> (取模), <code>**</code> (ES7幂运算)。</p>
</li>
<li>
<p><strong>赋值运算符</strong>: <code>=</code>, <code>+=</code>, <code>-=</code>, <code>*=</code>, <code>/=</code>, <code>%=</code>。</p>
</li>
<li>
<p><strong>比较运算符</strong>: <code>==</code>, <code>===</code>, <code>!=</code>, <code>!==</code>, <code>&gt;</code>, <code>&lt;</code>, <code>&gt;=</code>, <code>&lt;=</code>。</p>
</li>
<li>
<p><strong>逻辑运算符</strong>: <code>&amp;&amp;</code> (逻辑与), <code>||</code> (逻辑或), <code>!</code> (逻辑非)。</p>
</li>
<li>
<p><strong>三元运算符</strong>: <code>condition ? exprIfTrue : exprIfFalse</code>。</p>
</li>
</ul>
<h3 data-id="heading-16">面试题代码示例</h3>
<p><code>&amp;&amp;</code> 和 <code>||</code> 具有短路特性，在实际编码中非常有用。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// &amp;&amp; (与): 如果第一个操作数为假值(false)，则直接返回第一个操作数，不再计算第二个。</span>
<span class="hljs-keyword">const</span> result1 = <span class="hljs-number">0</span> &amp;&amp; <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'This will not run'</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(result1); <span class="hljs-comment">// 0</span>

<span class="hljs-keyword">const</span> user = { <span class="hljs-attr">name</span>: <span class="hljs-string">'Mickey'</span> };
<span class="hljs-keyword">const</span> userName = user &amp;&amp; user.<span class="hljs-property">name</span>; <span class="hljs-comment">// 安全地访问嵌套属性</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(userName); <span class="hljs-comment">// 'Mickey'</span>

<span class="hljs-comment">// || (或): 如果第一个操作数为真值(true)，则直接返回第一个操作数，不再计算第二个。</span>
<span class="hljs-keyword">const</span> result2 = <span class="hljs-string">'Hello'</span> || <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'This will not run'</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(result2); <span class="hljs-comment">// 'Hello'</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">greet</span>(<span class="hljs-params">name</span>) {
  name = name || <span class="hljs-string">'Guest'</span>; <span class="hljs-comment">// 为函数参数提供默认值 (ES6之前常用)</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Welcome, <span class="hljs-subst">${name}</span>`</span>);
}
<span class="hljs-title function_">greet</span>(); <span class="hljs-comment">// Welcome, Guest</span>
<span class="hljs-title function_">greet</span>(<span class="hljs-string">'Mickey'</span>); <span class="hljs-comment">// Welcome, Mickey</span>
</code></pre>
<h2 data-id="heading-17">四、 流程控制</h2>
<h3 data-id="heading-18">条件语句</h3>
<ul>
<li>
<p><code>if...else if...else</code>: 用于处理一系列的条件判断。</p>
</li>
<li>
<p><code>switch</code>: 用于基于一个表达式的值来执行多个不同的操作，通常比一长串 <code>if...else if</code> 更清晰。</p>
</li>
</ul>
<h3 data-id="heading-19">循环语句</h3>
<ul>
<li>
<p><code>for</code>: 最常用的循环，当循环次数已知时非常方便。</p>
</li>
<li>
<p><code>while</code>: 在指定条件为真时重复执行代码块。</p>
</li>
<li>
<p><code>do...while</code>: 与<code>while</code>类似，但至少会执行一次代码块。</p>
</li>
<li>
<p><code>for...of</code> (ES6): 用于遍历可迭代对象（如 <code>Array</code>, <code>String</code>, <code>Map</code>, <code>Set</code>）的值。</p>
</li>
</ul>
<h3 data-id="heading-20">代码示例</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// switch 语句</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getFruitColor</span>(<span class="hljs-params">fruit</span>) {
  <span class="hljs-keyword">let</span> color;
  <span class="hljs-keyword">switch</span> (fruit) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">'apple'</span>:
      color = <span class="hljs-string">'red'</span>;
      <span class="hljs-keyword">break</span>; <span class="hljs-comment">// break 语句至关重要，否则会发生“穿透”</span>
    <span class="hljs-keyword">case</span> <span class="hljs-string">'banana'</span>:
      color = <span class="hljs-string">'yellow'</span>;
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-string">'grape'</span>:
      color = <span class="hljs-string">'purple'</span>;
      <span class="hljs-keyword">break</span>;
    <span class="hljs-attr">default</span>:
      color = <span class="hljs-string">'unknown'</span>;
  }
  <span class="hljs-keyword">return</span> color;
}
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">getFruitColor</span>(<span class="hljs-string">'banana'</span>)); <span class="hljs-comment">// yellow</span>

<span class="hljs-comment">// for 循环</span>
<span class="hljs-keyword">const</span> numbers = [<span class="hljs-number">10</span>, <span class="hljs-number">20</span>, <span class="hljs-number">30</span>];
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; numbers.<span class="hljs-property">length</span>; i++) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Element at index <span class="hljs-subst">${i}</span> is <span class="hljs-subst">${numbers[i]}</span>`</span>);
}

<span class="hljs-comment">// for...of 循环 (更简洁的遍历)</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> number <span class="hljs-keyword">of</span> numbers) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Element value is <span class="hljs-subst">${number}</span>`</span>);
}
</code></pre>
<h2 data-id="heading-21">五、 函数</h2>
<p>函数是JavaScript的一等公民，是组织和复用代码的基本单元。</p>
<h3 data-id="heading-22"><strong>函数声明</strong></h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">sum</span>(<span class="hljs-params">a, b</span>) {
  <span class="hljs-keyword">return</span> a + b;
}
</code></pre>
<p>特点：存在<strong>函数提升 (Hoisting)</strong> ，即在声明之前就可以调用。</p>
<h3 data-id="heading-23"><strong>函数表达式</strong></h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> multiply = <span class="hljs-keyword">function</span>(<span class="hljs-params">a, b</span>) {
  <span class="hljs-keyword">return</span> a * b;
};
</code></pre>
<p>特点：作为变量赋值，遵循变量的提升规则（<code>var</code>提升声明，<code>let</code>/<code>const</code>不提升），在赋值前无法调用。</p>
<h3 data-id="heading-24"><strong>箭头函数 (ES6)</strong></h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-title function_">subtract</span> = (<span class="hljs-params">a, b</span>) =&gt; a - b;
</code></pre>
<p>特点：语法简洁，且其 <code>this</code> 值由词法作用域决定，而不是由调用方式决定。</p>
<h4 data-id="heading-25"><strong>参数与返回值</strong></h4>
<p>函数可以接收参数，并通过 <code>return</code> 关键字返回一个值。如果没有 <code>return</code> 语句，函数默认返回 <code>undefined</code>。</p>
<h3 data-id="heading-26">面试题代码示例 (函数提升)</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">declaredSum</span>(<span class="hljs-number">5</span>, <span class="hljs-number">5</span>)); <span class="hljs-comment">// 10 (正常工作，因为函数声明被提升)</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">declaredSum</span>(<span class="hljs-params">a, b</span>) {
  <span class="hljs-keyword">return</span> a + b;
}

<span class="hljs-comment">// console.log(expressedSum(5, 5)); // TypeError: expressedSum is not a function</span>
<span class="hljs-comment">// (如果用var声明，变量提升了但赋值没提升，此时expressedSum是undefined)</span>
<span class="hljs-comment">// Uncaught ReferenceError: Cannot access 'expressedSum' before initialization</span>
<span class="hljs-comment">// (如果用const/let声明，存在暂时性死区)</span>

<span class="hljs-keyword">const</span> expressedSum = <span class="hljs-keyword">function</span>(<span class="hljs-params">a, b</span>) {
  <span class="hljs-keyword">return</span> a + b;
};
</code></pre>
<h2 data-id="heading-27">六、 对象</h2>
<h3 data-id="heading-28"><strong>创建</strong></h3>
<p>通常使用字面量语法 <code>const obj = {};</code>。</p>
<h3 data-id="heading-29"><strong>属性访问</strong></h3>
<ul>
<li>
<p><strong>点表示法 (<code>.</code>)</strong> : <code>obj.key</code>，当属性名是有效的标识符时使用。</p>
</li>
<li>
<p><strong>方括号表示法 (<code>[]</code>)</strong> : <code>obj['key']</code>，当属性名包含特殊字符、是变量、或需要动态计算时使用。</p>
</li>
</ul>
<h3 data-id="heading-30"><strong>属性操作</strong></h3>
<ul>
<li>
<p><strong>添加/修改</strong>: <code>obj.newKey = 'value';</code> 或 <code>obj['newKey'] = 'value';</code>。</p>
</li>
<li>
<p><strong>删除</strong>: <code>delete obj.key;</code>。</p>
</li>
<li>
<p><strong><code>for...in</code> 循环</strong>: 用于遍历对象自身及原型链上的<strong>可枚举</strong>属性。</p>
</li>
</ul>
<h3 data-id="heading-31">代码示例</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> car = {
  <span class="hljs-attr">make</span>: <span class="hljs-string">'Toyota'</span>,
  <span class="hljs-attr">model</span>: <span class="hljs-string">'Camry'</span>,
  <span class="hljs-string">'year-of-manufacture'</span>: <span class="hljs-number">2022</span>, <span class="hljs-comment">// 包含特殊字符的键</span>
  <span class="hljs-attr">start</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Engine started!'</span>);
  }
};

<span class="hljs-comment">// 访问属性</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(car.<span class="hljs-property">make</span>); <span class="hljs-comment">// 'Toyota'</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(car[<span class="hljs-string">'year-of-manufacture'</span>]); <span class="hljs-comment">// 2022 (必须用方括号)</span>

<span class="hljs-comment">// 修改属性</span>
car.<span class="hljs-property">model</span> = <span class="hljs-string">'Corolla'</span>;

<span class="hljs-comment">// 添加属性</span>
car.<span class="hljs-property">color</span> = <span class="hljs-string">'blue'</span>;

<span class="hljs-comment">// 删除属性</span>
<span class="hljs-keyword">delete</span> car.<span class="hljs-property">color</span>;

<span class="hljs-comment">// 遍历对象</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">in</span> car) {
  <span class="hljs-comment">// 推荐使用 hasOwnProperty 确保只遍历对象自身的属性</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">hasOwnProperty</span>.<span class="hljs-title function_">call</span>(car, key)) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${key}</span>: <span class="hljs-subst">${car[key]}</span>`</span>);
  }
}
</code></pre>
<h2 data-id="heading-32">七、 数组</h2>
<ul>
<li>
<p><strong>创建</strong>: <code>const arr = [];</code></p>
</li>
<li>
<p><strong>访问</strong>: 通过索引 <code>arr[0]</code>。</p>
</li>
<li>
<p><strong><code>length</code> 属性</strong>: 获取或设置数组的长度。</p>
</li>
</ul>
<h3 data-id="heading-33"><strong>常用方法</strong></h3>
<h4 data-id="heading-34"><strong>改变原数组</strong></h4>
<ul>
<li>
<p><code>push()</code> / <code>pop()</code>: 在末尾添加/删除元素。</p>
</li>
<li>
<p><code>unshift()</code> / <code>shift()</code>: 在开头添加/删除元素。</p>
</li>
<li>
<p><code>splice()</code>: 在任意位置添加/删除/替换元素。</p>
</li>
<li>
<p><code>sort()</code>: 对数组进行排序。</p>
</li>
</ul>
<h4 data-id="heading-35"><strong>不改变原数组</strong></h4>
<ul>
<li>
<p><code>concat()</code>: 合并数组。</p>
</li>
<li>
<p><code>slice()</code>: 提取数组的一部分。</p>
</li>
<li>
<p><code>forEach()</code>: 遍历数组，对每个元素执行一个函数。</p>
</li>
<li>
<p><code>map()</code>: 创建一个新数组，其结果是该数组中的每个元素都调用一个提供的函数后返回的结果。</p>
</li>
<li>
<p><code>filter()</code>: 创建一个新数组, 其包含通过所提供函数实现的测试的所有元素。</p>
</li>
<li>
<p><code>find()</code>: 返回数组中满足提供的测试函数的第一个元素的值。</p>
</li>
</ul>
<h3 data-id="heading-36">代码示例 (map vs forEach)</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> ids = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>];

<span class="hljs-comment">// forEach: 仅用于迭代，没有返回值</span>
ids.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">id</span> =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Processing ID: <span class="hljs-subst">${id}</span>`</span>);
});

<span class="hljs-comment">// map: 用于转换数组，返回一个新数组</span>
<span class="hljs-keyword">const</span> urls = ids.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">id</span> =&gt;</span> <span class="hljs-string">`/users/<span class="hljs-subst">${id}</span>`</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(urls); <span class="hljs-comment">// ['/users/1', '/users/2', '/users/3', '/users/4']</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(ids);  <span class="hljs-comment">// [1, 2, 3, 4] (原数组未改变)</span>
</code></pre>
<h2 data-id="heading-37">八、 DOM 操作与事件模型</h2>
<p>尽管如今的框架都封装了‘完美’的DOM操作，但原生DOM API是所有上层建筑的基础。</p>
<h3 data-id="heading-38">1. 高效的DOM节点操作</h3>
<p>当需要向DOM中添加大量元素时，直接在循环中 <code>appendChild</code> 会导致多次<strong>重排 (reflow)</strong> 和<strong>重绘 (repaint)</strong> ，影响性能。推荐使用 <code>DocumentFragment</code> 作为临时容器。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> list = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'my-list'</span>);
<span class="hljs-keyword">const</span> fragment = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createDocumentFragment</span>(); <span class="hljs-comment">// 创建一个文档片段</span>

<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000</span>; i++) {
  <span class="hljs-keyword">const</span> item = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'li'</span>);
  item.<span class="hljs-property">textContent</span> = <span class="hljs-string">`Item <span class="hljs-subst">${i + <span class="hljs-number">1</span>}</span>`</span>;
  fragment.<span class="hljs-title function_">appendChild</span>(item); <span class="hljs-comment">// 先将所有新节点附加到 fragment</span>
}

list.<span class="hljs-title function_">appendChild</span>(fragment); <span class="hljs-comment">// 最后一次性将 fragment 添加到真实DOM，只触发一次重排。</span>
</code></pre>
<h3 data-id="heading-39">2. 事件委托</h3>
<p>利用事件冒泡机制，将事件监听器绑定在父元素上，统一处理子元素的事件。这在动态添加子元素的场景下尤为高效。</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">ul</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"parent-list"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>Item 1<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>Item 2<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>Item 3<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> parentList = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'parent-list'</span>);

parentList.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>) {
  <span class="hljs-comment">// event.target 是实际被点击的元素</span>
  <span class="hljs-keyword">if</span> (event.<span class="hljs-property">target</span> &amp;&amp; event.<span class="hljs-property">target</span>.<span class="hljs-property">nodeName</span> === <span class="hljs-string">'LI'</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`点击了: <span class="hljs-subst">${event.target.textContent}</span>`</span>);
  }
});
</code></pre>
<h2 data-id="heading-40">九、 AJAX 与本地存储</h2>
<h3 data-id="heading-41">AJAX</h3>
<p><code>fetch</code> API 是目前主流的异步请求方案，它基于 Promise，语法更简洁。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchUserData</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'https://api.example.com/user/1'</span>);

    <span class="hljs-comment">// fetch 不会因 404/500 等 HTTP 错误状态码而 reject Promise，需要手动检查</span>
    <span class="hljs-keyword">if</span> (!response.<span class="hljs-property">ok</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`HTTP error! status: <span class="hljs-subst">${response.status}</span>`</span>);
    }

    <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> response.<span class="hljs-title function_">json</span>(); <span class="hljs-comment">// 解析 JSON 响应体</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data);
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Fetch failed:'</span>, error);
  }
}

<span class="hljs-title function_">fetchUserData</span>();
</code></pre>
<h3 data-id="heading-42">本地存储方案对比</h3>





























<table><thead><tr><th>方案</th><th>生命周期</th><th>存储大小</th><th>与服务器通信</th></tr></thead><tbody><tr><td><code>localStorage</code></td><td>永久，除非手动清除</td><td>约 5MB</td><td>否，仅在客户端</td></tr><tr><td><code>sessionStorage</code></td><td>浏览器标签页关闭即清除</td><td>约 5MB</td><td>否，仅在客户端</td></tr><tr><td><code>Cookie</code></td><td>可设置过期时间</td><td>约 4KB</td><td>每次HTTP请求都会携带</td></tr></tbody></table>
<blockquote>
<p>以上是JavaScript基础篇面试考察点的内容，如有错误欢迎评论区指正。</p>
</blockquote>
<ul>
<li><a href="https://juejin.cn/post/7503111373468893193" target="_blank" title="https://juejin.cn/post/7503111373468893193">2025前端面试题-Vue3基础篇</a></li>
<li><a href="https://juejin.cn/post/7511568225987051555" target="_blank" title="https://juejin.cn/post/7511568225987051555">2025前端面试题-Vue3进阶篇</a></li>
<li><a href="https://juejin.cn/post/7503811658198286388" target="_blank" title="https://juejin.cn/post/7503811658198286388">2025前端面试题-React基础篇</a></li>
<li><a href="https://juejin.cn/post/7504545616841965583" target="_blank" title="https://juejin.cn/post/7504545616841965583">2025前端面试题-React进阶篇</a></li>
<li><a href="https://juejin.cn/post/7504926961627054099" target="_blank" title="https://juejin.cn/post/7504926961627054099">2025前端面试题-React高阶篇</a></li>
<li><a href="https://juejin.cn/spost/7530179511728930856" target="_blank" title="https://juejin.cn/spost/7530179511728930856">2025前端面试题-TS理论篇</a></li>
<li><a href="https://juejin.cn/post/7533826195352829988" target="_blank" title="https://juejin.cn/post/7533826195352829988">2025前端面试题-TS实战篇</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React性能优化：5个90%开发者都会忽略的useEffect最佳实践]]></title>    <link>https://juejin.cn/post/7578699975414546432</link>    <guid>https://juejin.cn/post/7578699975414546432</guid>    <pubDate>2025-12-02T00:16:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578699975414546432" data-draft-id="7578714759337672704" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React性能优化：5个90%开发者都会忽略的useEffect最佳实践"/> <meta itemprop="keywords" content="后端,前端,人工智能"/> <meta itemprop="datePublished" content="2025-12-02T00:16:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿橙的百宝箱"/> <meta itemprop="url" content="https://juejin.cn/user/1638743356481367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React性能优化：5个90%开发者都会忽略的useEffect最佳实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1638743356481367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿橙的百宝箱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T00:16:35.000Z" title="Tue Dec 02 2025 00:16:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>React性能优化：5个90%开发者都会忽略的useEffect最佳实践</strong></h2>
<h2 data-id="heading-1">引言</h2>
<p>在React函数式组件中，<code>useEffect</code>是最常用的Hook之一，用于处理副作用（如数据获取、订阅或手动修改DOM）。然而，许多开发者在日常使用中往往忽视了其潜在的性能陷阱和最佳实践。本文将深入探讨5个容易被忽略但至关重要的<code>useEffect</code>优化技巧，帮助你编写更高效、更健壮的React应用。</p>
<h2 data-id="heading-2">主体</h2>
<h3 data-id="heading-3">1. 避免不必要的依赖项</h3>
<h4 data-id="heading-4">问题</h4>
<p>许多开发者会在<code>useEffect</code>的依赖数组中盲目添加所有用到的变量，这可能导致频繁触发副作用，甚至引发无限循环。</p>
<h4 data-id="heading-5">解决方案</h4>
<ul>
<li><strong>使用最小化依赖原则</strong>：只添加真正需要触发副作用的变量。</li>
<li><strong>利用函数式更新</strong>：对于状态更新，可以使用函数式更新避免直接依赖状态值。</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ 不推荐</span>
<span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);
<span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> interval = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">setCount</span>(count + <span class="hljs-number">1</span>); <span class="hljs-comment">// 依赖count</span>
  }, <span class="hljs-number">1000</span>);
  <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">clearInterval</span>(interval);
}, [count]);

<span class="hljs-comment">// ✅ 推荐：使用函数式更新</span>
<span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> interval = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">setCount</span>(<span class="hljs-function"><span class="hljs-params">prevCount</span> =&gt;</span> prevCount + <span class="hljs-number">1</span>); <span class="hljs-comment">// 不依赖count</span>
  }, <span class="hljs-number">1000</span>);
  <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">clearInterval</span>(interval);
}, []);
</code></pre>
<h3 data-id="heading-6">2. 正确清理副作用</h3>
<h4 data-id="heading-7">问题</h4>
<p>忘记清理副作用（如事件监听器、定时器或订阅）会导致内存泄漏和不可预期的行为。</p>
<h4 data-id="heading-8">解决方案</h4>
<ul>
<li><strong>始终返回清理函数</strong>：即使你认为不需要清理，也要养成习惯。</li>
<li><strong>清理应与初始化对称</strong>：确保清理的逻辑与初始化的逻辑完全对应。</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleResize</span> = (<span class="hljs-params"/>) =&gt; <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'resized'</span>);
  
 <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'resize'</span>, handleResize);
  
 <span class="hljs-comment">// ✅必须返回清理函数</span>
 <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'resize'</span>, handleResize);
}, []);
</code></pre>
<h3 data-id="heading-9">3. useCallback与useMemo的合理使用</h3>
<h4 data-id="heading-10">问题</h4>
<p>直接在<code>useEffect</code>中创建函数或对象会导致每次渲染都生成新的引用，从而触发不必要的副作用。</p>
<p>####解决方案：</p>
<ul>
<li><strong>配合useCallback/useMemo使用</strong>：稳定函数的引用。</li>
<li><strong>仅在必要时优化</strong>：过度使用也会带来性能开销。</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> fetchData = <span class="hljs-title function_">useCallback</span>(<span class="hljs-keyword">async</span> () =&gt; {
 <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/data'</span>);
 <span class="hljs-title function_">setData</span>(response.<span class="hljs-property">data</span>);
}, []); <span class="hljs-comment">// ✅稳定引用</span>

<span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
 <span class="hljs-title function_">fetchData</span>();
}, [fetchData]); <span class="hljs-comment">//现在依赖项是稳定的</span>
</code></pre>
<p>###4.分拆多个独立的副作用</p>
<p>####问题：
将多个无关的逻辑塞进同一个<code>useEffect</code>会导致代码难以维护且可能引发不必要的执行。</p>
<p>####解决方案：</p>
<ul>
<li><strong>单一职责原则</strong>：每个<code>useEffect</code>只关注一件事。</li>
<li><strong>逻辑分组清晰</strong>：</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌混在一起的逻辑</span>
<span class="hljs-title function_">useEffect</span>(<span class="hljs-function">()=&gt;</span>{
 <span class="hljs-title function_">fetchUser</span>(userId);
 <span class="hljs-title function_">startChatSubscription</span>(userId);
},[userId]);

<span class="hljs-comment">//✅拆分成独立的effect </span>
<span class="hljs-comment">//用户数据获取 </span>
 <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">()=&gt;</span>{<span class="hljs-title function_">fetchUser</span>(userId)},[userId]);

<span class="hljs-comment">//聊天订阅 </span>
 <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">()=&gt;</span>{
 <span class="hljs-keyword">const</span> subscription=<span class="hljs-title function_">startChatSubscription</span>(userId); 
 <span class="hljs-keyword">return</span><span class="hljs-function">()=&gt;</span>subscription.<span class="hljs-title function_">unsubscribe</span>();
 },[userId]);
</code></pre>
<p>###5.正确处理异步操作竞态条件</p>
<p>####问题：
在快速切换参数时（如连续点击不同用户ID），前一个请求可能在后面完成导致状态不一致。</p>
<p>####解决方案：</p>
<ul>
<li><strong>取消过时请求</strong>：
<ul>
<li>AbortController（原生fetch）</li>
<li>axios CancelToken</li>
</ul>
</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"> <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">()=&gt;</span>{
 <span class="hljs-keyword">const</span> controller=<span class="hljs-keyword">new</span> <span class="hljs-title class_">AbortController</span>();
 
 <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">loadData</span>(<span class="hljs-params"/>){
 <span class="hljs-keyword">try</span>{
 <span class="hljs-keyword">const</span> res=<span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">`/api/user/<span class="hljs-subst">${userId}</span>`</span>,{
 <span class="hljs-attr">signal</span>:controller.<span class="hljs-property">signal</span> });
 <span class="hljs-title function_">setUser</span>(<span class="hljs-keyword">await</span> res.<span class="hljs-title function_">json</span>());
 }<span class="hljs-keyword">catch</span>(err){
 <span class="hljs-keyword">if</span>(err.<span class="hljs-property">name</span>!==<span class="hljs-string">'AbortError'</span>){<span class="hljs-comment">/*处理错误*/</span>}
 }
 }
 
 <span class="hljs-title function_">loadData</span>();
 
 <span class="hljs-keyword">return</span><span class="hljs-function">()=&gt;</span>controller.<span class="hljs-title function_">abort</span>(); <span class="hljs-comment">//✅取消未完成的请求</span>
 
 },[userId]);
</code></pre>
<p>##总结</p>
<p>通过遵循这五个最佳实践——最小化依赖项、彻底清理副作用、稳定引用、拆分独立逻辑以及处理异步竞态——你可以显著提升React应用的性能和可靠性。记住，好的开发者不仅要让代码工作更要让代码优雅高效地工作。将这些原则融入日常开发习惯将帮助你构建更专业的React应用。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[实战 LiteLLM 与监控告警系统的集成]]></title>    <link>https://juejin.cn/post/7578714759337689088</link>    <guid>https://juejin.cn/post/7578714759337689088</guid>    <pubDate>2025-12-02T00:19:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578714759337689088" data-draft-id="7578699975414497280" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="实战 LiteLLM 与监控告警系统的集成"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-12-02T00:19:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="日习一技"/> <meta itemprop="url" content="https://juejin.cn/user/3913917125896190"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            实战 LiteLLM 与监控告警系统的集成
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3913917125896190/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    日习一技
  </span> <!----> <!----> <div class="vip-level" data-v-cd7d0a50="" data-v-292f6e48=""><span class="tooltip" data-v-cd7d0a50=""><div class="byte-tooltip byte-tooltip--dark" style="display:none;">
        VIP.1 初学乍练
      </div><span class="byte-tooltip__wrapper"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8AQMAAAAAMksxAAAAA1BMVEUAAACnej3aAAAAAXRSTlMAQObYZgAAAA5JREFUKM9jGAWjAAcAAAIcAAE27nY6AAAAAElFTkSuQmCC" alt="VIP.1 初学乍练" title="VIP.1 初学乍练" class="lazy" style="aspect-ratio:NaN;" data-v-5244ef91="" data-v-cd7d0a50=""/></span></span></div> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T00:19:58.000Z" title="Tue Dec 02 2025 00:19:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在前两篇文章中，我们学习了 LiteLLM 的内置日志系统和外部日志集成能力。基于这些丰富的日志数据，我们可以实现对 LLM 网关的全面观测。然而，在生产环境中，仅仅有日志数据是不够的，我们需要的是一套完整的监控和告警体系，能够在问题发生时第一时间通知运维团队，在预算即将超限时提前预警，在模型服务异常时及时切换，从而保障整个 LLM 服务的稳定性和可靠性。</p>
<p>LiteLLM 提供了完善的监控告警解决方案，支持与 <strong>Slack、Discord、Microsoft Teams</strong> 等通讯平台集成，实现实时告警通知；或者基于 <strong>PagerDuty</strong> 等专业告警平台，实现 7x24 小时的运维响应；同时它还支持 <strong>Prometheus</strong> 指标导出，可以与 <strong>Grafana</strong> 等监控平台构建企业级监控大盘。</p>
<p>今天，我们就来学习下如何将 LiteLLM 与监控告警系统集成，构建一个主动、智能的运维体系。我们会以 Slack 和 Prometheus 为例，演示具体的集成步骤，让你的 AI 应用具备完善的监控告警能力。</p>
<h2 data-id="heading-0">实战 Slack 告警集成</h2>
<p>作为全球最受欢迎的团队协作平台，<a href="https://link.juejin.cn?target=https%3A%2F%2Fslack.com%2F" target="_blank" title="https://slack.com/" ref="nofollow noopener noreferrer">Slack</a> 凭借其便捷的沟通体验、灵活的频道管理能力，以及丰富的第三方集成生态，成为了团队接收、流转重要信息的核心枢纽。将告警系统与 Slack 打通，更是能直接消除信息传递的延迟差，确保技术团队、运维团队或业务团队在第一时间捕捉到异常信号，避免因通知滞后导致的问题扩大化。</p>
<h3 data-id="heading-1">创建 Slack Webhook</h3>
<p>LiteLLM 通过 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.slack.dev%2Fmessaging%2Fsending-messages-using-incoming-webhooks%2F" target="_blank" title="https://docs.slack.dev/messaging/sending-messages-using-incoming-webhooks/" ref="nofollow noopener noreferrer">Slack Webhooks</a> 向 Slack 频道发送消息，从而实现告警功能。首先我们<a href="https://link.juejin.cn?target=https%3A%2F%2Fslack.com%2Fget-started" target="_blank" title="https://slack.com/get-started" ref="nofollow noopener noreferrer">访问 Slack 页面</a>，创建一个新的 Slack 工作区：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d40674eab9194d4abc9034b84d3c618d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pel5Lmg5LiA5oqA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765239598&amp;x-signature=f9sFgaSa5pZhUcrM29sRG4BvqA0%3D" alt="slack-create-workspace.png" loading="lazy"/></p>
<p>如果你已有工作区，可跳过此步。我这里为方便演示，创建了一个名为 <code>litellm-test</code> 的工作区，并创建了一个名为 <code>告警测试</code> 的新频道：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0c8e4c58eaac4f948b032574cd4eae86~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pel5Lmg5LiA5oqA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765239598&amp;x-signature=59QyvoPiqa0sFvdJ%2BWf%2BxwlyCcM%3D" alt="slack-create-workspace-done.png" loading="lazy"/></p>
<p>然后访问 <a href="https://link.juejin.cn?target=https%3A%2F%2Fapi.slack.com%2Fapps" target="_blank" title="https://api.slack.com/apps" ref="nofollow noopener noreferrer">Slack 的应用页面</a>：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/25a148c3d4c24355b9609abeca0d063e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pel5Lmg5LiA5oqA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765239598&amp;x-signature=31fRzb8bc5fMyJ7%2Bc6zeyPQK6fQ%3D" alt="slack-apps.png" loading="lazy"/></p>
<p>点击 “Create an App” 创建一个名为 <code>litellm-alert</code> 的应用：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d1260c97e5e145ea9227cc774bab4ba7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pel5Lmg5LiA5oqA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765239598&amp;x-signature=LikTHla1IbqLXlUif3AAHOpydnQ%3D" alt="slack-create-an-app.png" loading="lazy"/></p>
<p>创建成功后进入该应用的配置页面，我们在左侧菜单选择 “Incoming Webhooks”，点击 “Activate Incoming Webhooks” 启用 Webhook 功能：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ccebf83b011744ac8a48893dde910deb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pel5Lmg5LiA5oqA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765239598&amp;x-signature=F6CJdoAK4NvHu%2BbiI1%2FPx9DmdlY%3D" alt="slack-app-webhooks.png" loading="lazy"/></p>
<p>然后点击 “Add New Webhook” 按钮，创建一个新的 Webhook 并将其关联到工作区的 “告警测试” 频道：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fe7ee1e10e194148bbb58cb7b5ea296c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pel5Lmg5LiA5oqA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765239598&amp;x-signature=IJ%2BsEqkYUBTp%2BXRV0s5W1B05eQ0%3D" alt="slack-app-add-webhook.png" loading="lazy"/></p>
<p>这时就会生成一个 Webhook 链接，点击 “Copy” 按钮进行复制。</p>
<h3 data-id="heading-2">配置 LiteLLM</h3>
<p>接下来修改 LiteLLM 的配置，开启 Slack 告警功能。首先配置环境变量：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">export</span> SLACK_WEBHOOK_URL=<span class="hljs-string">"https://hooks.slack.com/services/aaa/bbb/ccc"</span>
</code></pre>
<p>然后修改 <code>config.yaml</code> 配置文件：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">general_settings:</span>
  <span class="hljs-comment"># 启用 Slack 告警</span>
  <span class="hljs-attr">alerting:</span> [<span class="hljs-string">"slack"</span>]
  <span class="hljs-comment"># 告警阈值（秒）- 请求超过 5 分钟视为异常</span>
  <span class="hljs-attr">alerting_threshold:</span> <span class="hljs-number">300</span>
  <span class="hljs-comment"># 消费报告频率（可选）</span>
  <span class="hljs-attr">spend_report_frequency:</span> <span class="hljs-string">"1d"</span>
</code></pre>
<p>重启 LiteLLM 服务：</p>
<pre><code class="hljs language-bash" lang="bash">$ litellm -c config.yaml
</code></pre>
<p>可以通过下面的命令测试 Slack 连接：</p>
<pre><code class="hljs language-bash" lang="bash">$ curl -X GET <span class="hljs-string">'http://127.0.0.1:4000/health/services?service=slack'</span> \
  -H <span class="hljs-string">'Authorization: Bearer sk-1234'</span>
</code></pre>
<p>如果配置正确，你应该在 Slack 频道看到类似下面这样一条测试消息：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/412bd0fdc4fa47ccbc4c3f726968b712~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pel5Lmg5LiA5oqA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765239598&amp;x-signature=%2Flf%2BvNVYz5c0AbJlJFx92slaYuY%3D" alt="slack-test-message.png" loading="lazy"/></p>
<h3 data-id="heading-3">告警类型</h3>
<p>接下来我们就可以做一些真实的告警测试了。LiteLLM 支持四大类告警类型，覆盖了生产环境的主要监控需求：</p>
<p><strong>1. LLM 相关告警</strong></p>
<ul>
<li><strong>LLM API 异常告警（<code>llm_exceptions</code>）</strong>：当 LLM API 出现异常时触发告警</li>
<li><strong>慢响应告警（<code>llm_too_slow</code>）</strong>：当 LLM 响应时间超过设定阈值时触发告警</li>
<li><strong>请求挂起告警（<code>llm_requests_hanging</code>）</strong>：检测未能完成的 LLM 请求</li>
<li><strong>部署冷却告警（<code>cooldown_deployment</code>）</strong>：当部署被置于冷却状态时的告警</li>
<li><strong>新模型添加告警（<code>new_model_added</code>）</strong>：通过 <code>/model/new</code> 接口添加新模型时的通知</li>
<li><strong>停机告警（<code>outage_alerts</code>）</strong>：当特定 LLM 部署面临停机时的告警</li>
<li><strong>区域停机告警（<code>region_outage_alerts</code>）</strong>：当特定 LLM 区域面临停机时的告警，例如 <code>us-east-1</code></li>
</ul>
<p><strong>2. 预算和支出告警</strong></p>
<ul>
<li><strong>预算告警（<code>budget_alerts</code>）</strong>：与预算限制或阈值相关的通知</li>
<li><strong>支出报告（<code>spend_reports</code>）</strong>：跨团队或标签的定期支出报告</li>
<li><strong>支出追踪失败告警（<code>failed_tracking_spend</code>）</strong>：当支出追踪失败时的告警</li>
<li><strong>每日报告（<code>daily_reports</code>）</strong>：每日支出报告</li>
<li><strong>回退报告（<code>fallback_reports</code>）</strong>：LLM 回退发生情况的周报</li>
</ul>
<p><strong>3. 数据库告警</strong></p>
<ul>
<li><strong>数据库异常告警（<code>db_exceptions</code>）</strong>：数据库相关异常的通知</li>
</ul>
<p><strong>4. 管理端点告警</strong> - 虚拟密钥、团队、内部用户</p>
<ul>
<li><strong>新虚拟密钥创建告警（<code>new_virtual_key_created</code>）</strong>：创建新虚拟密钥时的通知</li>
<li><strong>虚拟密钥更新告警（<code>virtual_key_updated</code>）</strong>：虚拟密钥被修改时的告警</li>
<li><strong>虚拟密钥删除告警（<code>virtual_key_deleted</code>）</strong>：虚拟密钥被移除时的通知</li>
<li><strong>新团队创建告警（<code>new_team_created</code>）</strong>：创建新团队时的告警</li>
<li><strong>团队更新告警（<code>team_updated</code>）</strong>：团队详情被修改时的通知</li>
<li><strong>团队删除告警（<code>team_deleted</code>）</strong>：团队被删除时的告警</li>
<li><strong>新内部用户创建告警（<code>new_internal_user_created</code>）</strong>：新内部用户账户的通知</li>
<li><strong>内部用户更新告警（<code>internal_user_updated</code>）</strong>：内部用户详情被更改时的告警</li>
<li><strong>内部用户删除告警（<code>internal_user_deleted</code>）</strong>：内部用户账户被移除时的通知</li>
</ul>
<p>我们可以在配置文件中手动指定要启用的告警类型（如果不指定，前三类告警默认是启用的，管理端点告警默认禁用）：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">general_settings:</span>
  <span class="hljs-attr">alerting:</span> [<span class="hljs-string">"slack"</span>]
  <span class="hljs-attr">alerting_threshold:</span> <span class="hljs-number">300</span>
  <span class="hljs-comment"># 告警类型</span>
  <span class="hljs-attr">alert_types:</span> [
    <span class="hljs-string">"llm_exceptions"</span>,       <span class="hljs-comment"># LLM API 异常</span>
    <span class="hljs-string">"llm_too_slow"</span>,         <span class="hljs-comment"># 响应过慢</span>
    <span class="hljs-string">"llm_requests_hanging"</span>, <span class="hljs-comment"># 请求挂起</span>
    <span class="hljs-string">"budget_alerts"</span>,        <span class="hljs-comment"># 预算告警</span>
    <span class="hljs-string">"spend_reports"</span>,        <span class="hljs-comment"># 支出报告</span>
    <span class="hljs-string">"db_exceptions"</span>,        <span class="hljs-comment"># 数据库异常</span>
    <span class="hljs-string">"daily_reports"</span>,        <span class="hljs-comment"># 每日报告</span>
    <span class="hljs-string">"outage_alerts"</span>         <span class="hljs-comment"># 停机告警</span>
  ]
</code></pre>
<p>另外，在生产环境中，过多的告警会导致 <strong>告警疲劳</strong>，降低团队对重要告警的响应速度。为此 LiteLLM 实现了去重和防轰炸机制，比如：同一用户或团队的预算告警 24 小时内只发送一次；1 分钟内的多个停机告警会被聚合成一个告警；可以通过下面这些告警参数来进行控制：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">general_settings:</span>
  <span class="hljs-comment"># 告警参数配置</span>
  <span class="hljs-attr">alerting_args:</span>
    <span class="hljs-attr">daily_report_frequency:</span> <span class="hljs-number">43200</span>    <span class="hljs-comment"># 12 小时发送一次日报</span>
    <span class="hljs-attr">report_check_interval:</span> <span class="hljs-number">3600</span>      <span class="hljs-comment"># 1 小时检查一次是否需要发送报告</span>
    <span class="hljs-attr">budget_alert_ttl:</span> <span class="hljs-number">86400</span>         <span class="hljs-comment"># 24 小时内不重复预算告警</span>
    <span class="hljs-attr">outage_alert_ttl:</span> <span class="hljs-number">60</span>            <span class="hljs-comment"># 1 分钟窗口聚合停机告警</span>
    <span class="hljs-attr">minor_outage_alert_threshold:</span> <span class="hljs-number">5</span> <span class="hljs-comment"># 5 个错误触发轻微告警</span>
    <span class="hljs-attr">major_outage_alert_threshold:</span> <span class="hljs-number">10</span> <span class="hljs-comment"># 10 个错误触发严重告警</span>
</code></pre>
<h3 data-id="heading-4">多频道告警</h3>
<p>LiteLLM 支持为不同类型的告警配置不同的通知频道：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">general_settings:</span>
  <span class="hljs-attr">alerting:</span> [<span class="hljs-string">"slack"</span>]
  <span class="hljs-comment"># 为每种告警类型指定专门的 Slack 频道</span>
  <span class="hljs-attr">alert_to_webhook_url:</span> {
    <span class="hljs-attr">"llm_exceptions":</span> <span class="hljs-string">"https://hooks.slack.com/services/.../llm-alerts"</span>,
    <span class="hljs-attr">"budget_alerts":</span> <span class="hljs-string">"https://hooks.slack.com/services/.../finance-alerts"</span>,
    <span class="hljs-attr">"daily_reports":</span> <span class="hljs-string">"https://hooks.slack.com/services/.../daily-reports"</span>,
    <span class="hljs-attr">"outage_alerts":</span> [
      <span class="hljs-string">"https://hooks.slack.com/services/.../oncall-alerts"</span>,
      <span class="hljs-string">"https://hooks.slack.com/services/.../backup-alerts"</span>
    ]
  }
</code></pre>
<p>这种配置允许我们：</p>
<ul>
<li><strong>LLM 异常</strong>告警发送到技术团队频道</li>
<li><strong>预算告警</strong>发送到财务管理频道</li>
<li><strong>每日报告</strong>发送到管理层频道</li>
<li><strong>停机告警</strong>同时发送到多个值班频道</li>
</ul>
<h3 data-id="heading-5">兼容其他平台</h3>
<p>LiteLLM 的 Slack 集成同样支持 Discord 和 Microsoft Teams（它们两都兼容 Slack 的 Webhook 格式）：</p>
<p><strong>Discord 配置：</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># Discord Webhook 需要在 URL 后添加 /slack</span>
<span class="hljs-built_in">export</span> SLACK_WEBHOOK_URL=<span class="hljs-string">"https://discord.com/api/webhooks/1240.../cTLWt5A.../slack"</span>
</code></pre>
<p><strong>Microsoft Teams 配置：</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># MS Teams 提供 Slack 兼容的 Webhook</span>
<span class="hljs-built_in">export</span> SLACK_WEBHOOK_URL=<span class="hljs-string">"https://outlook.office.com/webhook/...IncomingWebhook/..."</span>
</code></pre>
<p>只需修改 Webhook URL 即可，配置文件保持不变。</p>
<h2 data-id="heading-6">实战 Prometheus 监控集成</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fprometheus.io%2F" target="_blank" title="https://prometheus.io/" ref="nofollow noopener noreferrer">Prometheus</a> 是一个开源的监控和告警系统，最初由 SoundCloud 开发。它具有以下特点：</p>
<ul>
<li><strong>时间序列数据库</strong>：专为监控数据设计的高性能存储</li>
<li><strong>Pull 模式</strong>：主动拉取目标服务的指标数据</li>
<li><strong>强大的查询语言</strong>：PromQL 支持复杂的数据分析和聚合</li>
<li><strong>告警管理</strong>：与 Alertmanager 集成实现灵活的告警规则</li>
<li><strong>生态完整</strong>：与 Grafana 等可视化工具无缝集成</li>
</ul>
<p>目前 Prometheus 已经是云原生监控的事实标准，LiteLLM 的企业版本提供了 Prometheus 集成能力。</p>
<h3 data-id="heading-7">配置 Prometheus 回调</h3>
<p>首先安装必要的依赖：</p>
<pre><code class="hljs language-bash" lang="bash">$ pip install prometheus_client==0.20.0
</code></pre>
<p>然后在配置文件中启用 Prometheus 回调：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">litellm_settings:</span>
  <span class="hljs-attr">callbacks:</span> [<span class="hljs-string">"prometheus"</span>]  <span class="hljs-comment"># 启用 Prometheus 指标</span>
</code></pre>
<p>重启 LiteLLM 服务：</p>
<pre><code class="hljs language-bash" lang="bash">$ litellm -c config.yaml
</code></pre>
<p>现在访问 <code>http://localhost:4000/metrics</code> 就可以看到 Prometheus 格式的指标数据。目前指标数据还是空的，可以发送几个测试请求后再看：</p>
<pre><code class="hljs language-bash" lang="bash">$ curl -X POST <span class="hljs-string">'http://127.0.0.1:4000/chat/completions'</span> \
  -H <span class="hljs-string">'Authorization: Bearer sk-1234'</span> \
  -H <span class="hljs-string">'Content-Type: application/json'</span> \
  -d <span class="hljs-string">'{
    "model": "gpt-4o",
    "messages": [{"role": "user", "content": "给我讲个笑话"}]
  }'</span>
</code></pre>
<h3 data-id="heading-8">指标详解</h3>
<p>LiteLLM 提供的指标大致可以分为以下几个主要类别：</p>
<h4 data-id="heading-9">1. 代理服务指标（Proxy Service Metrics）</h4>
<p>这类指标主要监控 LiteLLM 代理服务的整体运行状况和请求处理情况：</p>
<ul>
<li><strong><code>litellm_proxy_total_requests_metric_total</code></strong> (counter)
代理服务总请求数 - 跟踪客户端向代理发起的请求总量</li>
<li><strong><code>litellm_proxy_failed_requests_metric_total</code></strong> (counter)
代理服务失败请求数 - 客户端未能从代理获得成功响应的请求数</li>
</ul>
<h4 data-id="heading-10">2. 延迟性能指标（Latency &amp; Performance Metrics）</h4>
<p>这类指标用于监控请求处理的延迟情况，帮助识别性能瓶颈：</p>
<ul>
<li><strong><code>litellm_request_total_latency_metric</code></strong> (histogram)
LiteLLM 请求总延迟时间（包含 LiteLLM 开销）</li>
<li><strong><code>litellm_llm_api_latency_metric</code></strong> (histogram)
LLM API 调用延迟时间</li>
<li><strong><code>litellm_llm_api_time_to_first_token_metric</code></strong> (histogram)
LLM API 首个 token 响应时间（仅流式请求）</li>
<li><strong><code>litellm_overhead_latency_metric</code></strong> (histogram)
LiteLLM 处理开销延迟</li>
</ul>
<h4 data-id="heading-11">3. 成本和使用量指标（Cost &amp; Usage Metrics）</h4>
<p>这类指标跟踪 LLM 服务的使用成本和 token 消费情况：</p>
<ul>
<li><strong><code>litellm_spend_metric_total</code></strong> (counter)
LLM 请求总花费</li>
<li><strong><code>litellm_total_tokens_metric_total</code></strong> (counter)
LLM 请求的输入+输出 token 总数</li>
<li><strong><code>litellm_input_tokens_metric_total</code></strong> (counter)
LLM 请求的输入 token 总数</li>
<li><strong><code>litellm_output_tokens_metric_total</code></strong> (counter)
LLM 请求的输出 token 总数</li>
</ul>
<h4 data-id="heading-12">4. 预算管理指标（Budget Management Metrics）</h4>
<p>这类指标监控团队和 API 密钥的预算使用情况，支持成本控制：</p>
<p><strong>团队预算指标：</strong></p>
<ul>
<li><strong><code>litellm_remaining_team_budget_metric</code></strong> (gauge)
团队剩余预算</li>
<li><strong><code>litellm_team_max_budget_metric</code></strong> (gauge)
团队最大预算设置</li>
<li><strong><code>litellm_team_budget_remaining_hours_metric</code></strong> (gauge)
团队预算重置剩余时间（小时）</li>
</ul>
<p><strong>API 密钥预算指标：</strong></p>
<ul>
<li><strong><code>litellm_remaining_api_key_budget_metric</code></strong> (gauge)
API 密钥剩余预算</li>
<li><strong><code>litellm_api_key_max_budget_metric</code></strong> (gauge)
API 密钥最大预算设置</li>
<li><strong><code>litellm_api_key_budget_remaining_hours_metric</code></strong> (gauge)
API 密钥预算重置剩余时间（小时）</li>
</ul>
<h4 data-id="heading-13">5. 流量控制指标（Rate Limiting Metrics）</h4>
<p>这类指标监控基于模型的请求和 token 限制情况：</p>
<ul>
<li><strong><code>litellm_remaining_api_key_requests_for_model</code></strong> (gauge)
API 密钥针对特定模型的剩余请求数（基于 RPM 限制）</li>
<li><strong><code>litellm_remaining_api_key_tokens_for_model</code></strong> (gauge)
API 密钥针对特定模型的剩余 token 数（基于 TPM 限制）</li>
<li><strong><code>litellm_remaining_requests</code></strong> (gauge)
LLM 部署的剩余请求数（来自 LLM API 提供商）</li>
<li><strong><code>litellm_remaining_tokens</code></strong> (gauge)
LLM 部署的剩余 token 数（来自 LLM API 提供商）</li>
</ul>
<h4 data-id="heading-14">6. 部署状态指标（Deployment Analytics）</h4>
<p>这类指标监控 LLM 部署的健康状态和运行表现：</p>
<p><strong>部署状态：</strong></p>
<ul>
<li><strong><code>litellm_deployment_state</code></strong> (gauge)
部署状态：0=健康，1=部分故障，2=完全故障</li>
<li><strong><code>litellm_deployment_cooled_down_total</code></strong> (counter)
部署被负载均衡逻辑冷却的次数</li>
</ul>
<p><strong>请求统计：</strong></p>
<ul>
<li><strong><code>litellm_deployment_success_responses_total</code></strong> (counter)
LLM 部署成功响应总数</li>
<li><strong><code>litellm_deployment_failure_responses_total</code></strong> (counter)
LLM 部署失败响应总数</li>
<li><strong><code>litellm_deployment_total_requests_total</code></strong> (counter)
LLM 部署总请求数（成功+失败）</li>
</ul>
<p><strong>性能分析：</strong></p>
<ul>
<li><strong><code>litellm_deployment_latency_per_output_token</code></strong> (histogram)
每个输出 token 的延迟时间</li>
</ul>
<h4 data-id="heading-15">7. 回退机制指标（Fallback Metrics）</h4>
<p>这类指标监控主要模型失败时的回退处理情况：</p>
<ul>
<li><strong><code>litellm_deployment_successful_fallbacks_total</code></strong> (counter)
成功回退请求数（从主模型→回退模型）</li>
<li><strong><code>litellm_deployment_failed_fallbacks_total</code></strong> (counter)
失败回退请求数（从主模型→回退模型）</li>
</ul>
<h3 data-id="heading-16">自定义 Metrics 标签</h3>
<p>LiteLLM 支持添加自定义元数据作为 Prometheus 标签：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">litellm_settings:</span>
  <span class="hljs-attr">callbacks:</span> [<span class="hljs-string">"prometheus"</span>]
  <span class="hljs-comment"># 将请求元数据添加为 Prometheus 标签</span>
  <span class="hljs-attr">custom_prometheus_metadata_labels:</span> [
    <span class="hljs-string">"metadata.environment"</span>,
    <span class="hljs-string">"metadata.service"</span>,
    <span class="hljs-string">"metadata.version"</span>
  ]
</code></pre>
<p>发送带有自定义元数据的请求：</p>
<pre><code class="hljs language-bash" lang="bash">$ curl -X POST <span class="hljs-string">'http://localhost:4000/chat/completions'</span> \
  -H <span class="hljs-string">'Authorization: Bearer sk-1234'</span> \
  -H <span class="hljs-string">'Content-Type: application/json'</span> \
  -d <span class="hljs-string">'{
    "model": "gpt-4o",
    "messages": [{"role": "user", "content": "测试"}],
    "metadata": {
      "environment": "production",
      "service": "chatbot",
      "version": "v1.2.3"
    }
  }'</span>
</code></pre>
<p>生成的指标将包含这些自定义的标签：</p>
<pre><code class="hljs language-prometheus" lang="prometheus">litellm_total_tokens_metric{
  model="gpt-4o",
  metadata_environment="production",
  metadata_service="chatbot",
  metadata_version="v1.2.3"
} 89
</code></pre>
<blockquote>
<p>使用此功能时需特别小心，避免使用高基数标签（比如 <code>user_id</code> 或 <code>request_id</code> 等），可能导致指标爆炸，造成性能问题。</p>
</blockquote>
<p>另一种自定义标签的方式是通过 <code>custom_prometheus_tags</code> 配置：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">litellm_settings:</span>
  <span class="hljs-attr">callbacks:</span> [<span class="hljs-string">"prometheus"</span>]
  <span class="hljs-comment"># 自定义标签</span>
  <span class="hljs-attr">custom_prometheus_tags:</span> [
    <span class="hljs-string">"prod"</span>,
    <span class="hljs-string">"staging"</span>
  ]
</code></pre>
<p>然后发送带标签的请求：</p>
<pre><code class="hljs language-bash" lang="bash">$ curl -X POST <span class="hljs-string">'http://localhost:4000/chat/completions'</span> \
  -H <span class="hljs-string">'Authorization: Bearer sk-1234'</span> \
  -H <span class="hljs-string">'Content-Type: application/json'</span> \
  -d <span class="hljs-string">'{
    "model": "gpt-4o",
    "messages": [{"role": "user", "content": "测试"}],
    "metadata": {
      "tags": ["prod"]
    }
  }'</span>
</code></pre>
<p>生成的指标如下所示：</p>
<pre><code class="hljs language-prometheus" lang="prometheus">litellm_total_tokens_metric{
  model="gpt-4o",
  tag_prod="true",
  tag_staging="false"
} 89
</code></pre>
<h3 data-id="heading-17">使用 Prometheus 采集指标</h3>
<p>创建 <code>prometheus.yml</code> 配置文件：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">global:</span>
  <span class="hljs-attr">scrape_interval:</span> <span class="hljs-string">15s</span>
  <span class="hljs-attr">evaluation_interval:</span> <span class="hljs-string">15s</span>

<span class="hljs-attr">scrape_configs:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">job_name:</span> <span class="hljs-string">'litellm'</span>
    <span class="hljs-attr">static_configs:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">targets:</span> [<span class="hljs-string">'10.6.120.132:4000'</span>] <span class="hljs-comment"># 换成你的 IP 地址</span>
    <span class="hljs-attr">metrics_path:</span> <span class="hljs-string">'/metrics'</span>
    <span class="hljs-attr">scrape_interval:</span> <span class="hljs-string">10s</span>
</code></pre>
<p>然后使用 Docker 启动 Prometheus 服务：</p>
<pre><code class="hljs language-bash" lang="bash">$ docker run -d \
  --name prometheus \
  -p 9090:9090 \
  -v $(<span class="hljs-built_in">pwd</span>)/prometheus.yml:/etc/prometheus/prometheus.yml \
  prom/prometheus
</code></pre>
<p>访问 <code>http://localhost:9090</code> 进入 Prometheus 的 Query 页面，输入指标即可查询：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6ca83bbc652347d3800b87bbec921032~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pel5Lmg5LiA5oqA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765239598&amp;x-signature=8fpfKrBALWhBPbGpO7GCaCU5D4o%3D" alt="prometheus-query.png" loading="lazy"/></p>
<p>点击 “Graph” 以图的形式查看指标：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/db5c05e313c645a5adc5c397ccf5c27e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pel5Lmg5LiA5oqA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765239598&amp;x-signature=YN2RZy49n9pgYwOpDICLkcWFR%2Bo%3D" alt="prometheus-query-graph.png" loading="lazy"/></p>
<p>通过 Prometheus 采集的指标数据，我们可以更进一步，基于 Grafana 构建一个完整的 LiteLLM 监控大盘，实现对 AI 服务的全方位观测。可以参考 LiteLLM 官方提供的 Grafana 仪表盘模板：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FBerriAI%2Flitellm%2Ftree%2Fmain%2Fcookbook%2Flitellm_proxy_server%2Fgrafana_dashboard" target="_blank" title="https://github.com/BerriAI/litellm/tree/main/cookbook/litellm_proxy_server/grafana_dashboard" ref="nofollow noopener noreferrer">github.com/BerriAI/lit…</a></li>
</ul>
<p>此外，Prometheus 还可以和 Alertmanager 集成，实现比 Slack 更灵活的告警规则。具体内容可以参考 Alertmanager 的官方文档：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fprometheus.io%2Fdocs%2Falerting%2Flatest%2Falertmanager%2F" target="_blank" title="https://prometheus.io/docs/alerting/latest/alertmanager/" ref="nofollow noopener noreferrer">prometheus.io/docs/alerti…</a></li>
</ul>
<h2 data-id="heading-18">小结</h2>
<p>今天我们深入学习了 LiteLLM 的监控告警系统，重点掌握了两种集成方案：</p>
<ul>
<li><strong>Slack 告警集成</strong>：提供实时的通知能力，支持多种告警类型和智能去重，特别适合团队协作和快速响应的场景</li>
<li><strong>Prometheus 监控集成</strong>：基于时间序列数据的企业级监控方案，与 Grafana 结合可构建完整的可观测性平台，或者与 Alertmanager 集成实现更灵活的告警规则</li>
</ul>
<p>除了这两种集成方案，LiteLLM 还支持 PagerDuty、邮件、Webhook 等其他方式，篇幅有限，此处不再赘述。</p>
<p>监控告警系统是生产环境的神经系统，它让我们能够感知系统的每一个变化，及时响应每一个问题。希望通过本文的学习，你能够建立起稳定可靠的 LiteLLM 监控告警体系，为用户提供更好的 AI 服务体验。</p>
<h2 data-id="heading-19">欢迎关注</h2>
<p>如果这篇文章对您有所帮助，欢迎关注我的同名公众号：<a href="https://link.juejin.cn?target=https%3A%2F%2Fi-study-everyday.online%2Fabout-me.html" target="_blank" title="https://i-study-everyday.online/about-me.html" ref="nofollow noopener noreferrer">日习一技，每天学一点新技术</a>。</p>
<p>我会每天花一个小时，记录下我学习的点点滴滴。内容包括但不限于：</p>
<ul>
<li>某个产品的使用小窍门</li>
<li>开源项目的实践和心得</li>
<li>技术点的简单解读</li>
</ul>
<p>目标是让大家用5分钟读完就能有所收获，不需要太费劲，但却可以轻松获取一些干货。不管你是技术新手还是老鸟，欢迎给我提建议，如果有想学习的技术，也欢迎交流！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Chatbox支持接入LangGraph智能体？一切都靠Trae Solo!]]></title>    <link>https://juejin.cn/post/7578700798744903714</link>    <guid>https://juejin.cn/post/7578700798744903714</guid>    <pubDate>2025-12-02T00:27:12.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578700798744903714" data-draft-id="7578724773992775706" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Chatbox支持接入LangGraph智能体？一切都靠Trae Solo!"/> <meta itemprop="keywords" content="人工智能,Trae,Agent"/> <meta itemprop="datePublished" content="2025-12-02T00:27:12.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="大模型真好玩"/> <meta itemprop="url" content="https://juejin.cn/user/3140624091453053"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Chatbox支持接入LangGraph智能体？一切都靠Trae Solo!
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3140624091453053/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    大模型真好玩
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T00:27:12.000Z" title="Tue Dec 02 2025 00:27:12 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><h2 data-id="heading-0">前言</h2>
<p>作为大模型智能体应用开发者，笔者长期使用 LangChain 与 LangGraph 框架开发各类智能体，并通过专栏<a href="https://juejin.cn/column/7526240014499495972" title="https://juejin.cn/column/7526240014499495972" target="_blank">LangChain/LangGraph系列教程</a>与大家分享相关经验。然而，开发完成的智能体往往面临一个实际挑战：直接部署并使用它们并不总是便捷。例如，LangChain官方推荐的 agent-chat-ui 通常需要额外启动服务，过程稍显繁琐。而笔者日常习惯使用 Chatbox 客户端与大模型交互，这让笔者不禁思考：能否通过 FastAPI 将智能体封装为服务，并通过 Chatbox 直接连接，从而实现更轻量、快速的调用？</p>
<p>这个想法虽然直接，代码量也不多。但在如今大模型辅助编程的日常中，动手实现的需求似乎总被“交给 AI 来完成”（归根结底程序员变懒了）。正巧，最近看到字节跳动的 Trae 推出了“Solo 模式”，它被称为“国产 Cursor”，恰好为笔者提供了验证的机会——是否能够借助 Trae Solo，自动、高效地完成这个从想法到可运行服务的过程？</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4fbc968b2649486780731ed6f8573aa4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L55yf5aW9546p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765240253&amp;x-signature=sOLj73c3IzZFo0XY1u41sr1Uxg4%3D" alt="1.png" width="70%" loading="lazy"/></p>
<h2 data-id="heading-1">一、Chatbox 与 Trae 简介</h2>
<h3 data-id="heading-2">1.1 Chatbox：跨平台 AI 客户端</h3>
<p>Chatbox 是一款功能全面的跨平台 AI 客户端，支持 Windows、macOS等主流操作系统。它采用 OpenAI 兼容的 API 调用方式，能够便捷地连接多种大模型，包括 OpenAI、Claude、DeepSeek 等云端 API，也支持本地vllm、ollama部署的模型。凭借其简洁的界面与稳定的体验，Chatbox 已成为众多开发者和AI爱好者常用的客户端工具之一。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/55e31adb260245499672a92f2f70f6c8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L55yf5aW9546p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765240253&amp;x-signature=K6ceMi8f0EHk8mION5Kh8vTnGL8%3D" alt="2.png" width="70%" loading="lazy"/></p>
<h3 data-id="heading-3">1.2 Trae：AI 驱动的编程助手</h3>
<p>Trae 是由字节跳动推出的 AI 编程工具，被许多开发者称为“国产 Cursor”。它已经从最初的代码生成助手，演进为一个支持端到端开发的智能平台。其最新推出的 <strong>Solo 模式</strong>，尤其适合快速实现想法：用户只需用自然语言描述需求（例如“开发一个在线背单词应用”），Trae 便能自主完成从需求分析、代码编写、测试到部署的完整流程。这正好为我们“懒于动手”但又想快速验证想法的场景，提供了理想的实验环境。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a72f2c1a572b48b99bd15c3dca12dcb2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L55yf5aW9546p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765240253&amp;x-signature=C0aS2fBaixhlDFfFMbD0G0q7toE%3D" alt="3.png" width="70%" loading="lazy"/></p>
<h2 data-id="heading-4">二、Chatbox 接入 LangChain 智能体的基本思路</h2>
<p>Trae Solo能力“吹的响”，总不至于这么个小需求它搞不了吧，在测试它的能力前笔者先自我思考一下如何实现这个需求？根据 <a href="https://link.juejin.cn?target=https%3A%2F%2Fchatboxai.app%2Fzh" target="_blank" title="https://chatboxai.app/zh" ref="nofollow noopener noreferrer">Chatbox 官方介绍</a>，它主要通过发起 <strong>OpenAI API 格式</strong> 的请求来与各类后端服务通信，无论是 vLLM、Ollama 等本地部署的模型，还是远程托管的服务。这为笔者提供了一个清晰的对接标准。</p>
<p>因此，将 LangChain/LangGraph 构建的智能体接入 Chatbox 的核心思路便非常明确：</p>
<ol>
<li><strong>构建适配层</strong>：使用 FastAPI 编写一个标准化接口，接收来自 Chatbox 的 OpenAI 格式请求。</li>
<li><strong>格式转换与调用</strong>：将该请求解析并转化为 LangChain 智能体能处理的对话消息格式，然后调用智能体执行。</li>
<li><strong>结果返回</strong>：将智能体返回的结果，重新封装成符合 OpenAI 响应格式的数据，通过 API 返回给 Chatbox。</li>
</ol>
<p>这样一来，对 Chatbox 而言，智能体服务就像一个兼容的“模型后端”，实现了无缝接入。</p>
<h2 data-id="heading-5">三、使用Trae Solo 完成 天气助手智能体的接入</h2>
<ol>
<li><strong>回顾基础智能体代码：</strong> 首先回顾一下之前用 LangChain 1.0 的 <code>create_react_agent</code> 编写的天气助手智能体。这个智能体使用了心知天气的 API，不熟悉这个服务的读者可以参考笔者的文章《<a href="https://juejin.cn/post/7486323379474645027" target="_blank" title="https://juejin.cn/post/7486323379474645027">从0到1开发DeepSeek天气助手智能体——你以为大模型只会聊天？Function Calling让它"上天入地"</a>》进行注册。关于 LangChain 1.0 智能体开发的基础知识，可参阅《<a href="https://juejin.cn/post/7568698787779723298" target="_blank" title="https://juejin.cn/post/7568698787779723298">LangChain1.0速通指南（二）——LangChain1.0 create_agent api 基础知识</a>》。</li>
</ol>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain.chat_models <span class="hljs-keyword">import</span> init_chat_model
<span class="hljs-keyword">from</span> langchain.tools <span class="hljs-keyword">import</span> tool
<span class="hljs-keyword">from</span> langchain.agents <span class="hljs-keyword">import</span> create_agent
<span class="hljs-keyword">from</span> langgraph.config <span class="hljs-keyword">import</span> get_stream_writer

<span class="hljs-meta">@tool(<span class="hljs-params">args_schema=WeatherQuery</span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_weather</span>(<span class="hljs-params">loc</span>):
    <span class="hljs-string">"""
        查询即时天气函数
        :param loc: 必要参数，字符串类型，用于表示查询天气的具体城市名称，\
        :return：心知天气 API查询即时天气的结果，具体URL请求地址为："https://api.seniverse.com/v3/weather/now.json"
        返回结果对象类型为解析之后的JSON格式对象，并用字符串形式进行表示，其中包含了全部重要的天气信息
    """</span>
    url = <span class="hljs-string">"https://api.seniverse.com/v3/weather/now.json"</span>
    params = {
        <span class="hljs-string">"key"</span>: <span class="hljs-string">"你注册的心知天气api key"</span>,
        <span class="hljs-string">"location"</span>: loc,
        <span class="hljs-string">"language"</span>: <span class="hljs-string">"zh-Hans"</span>,
        <span class="hljs-string">"unit"</span>: <span class="hljs-string">"c"</span>,
    }
    response = requests.get(url, params=params)
    temperature = response.json()
    <span class="hljs-keyword">return</span> temperature[<span class="hljs-string">'results'</span>][<span class="hljs-number">0</span>][<span class="hljs-string">'now'</span>]

SYSTEM_PROMPT = <span class="hljs-string">"你是一名可爱的天气预报播报员，可以模仿林志玲的语气播报天气，具备调用get_weather天气函数获取指定地点天气的能力"</span>

model = init_chat_model(
    model=<span class="hljs-string">"deepseek-chat"</span>,
    base_url=<span class="hljs-string">"https://api.deepseek.com"</span>,
    api_key=<span class="hljs-string">"你注册的deepseek api key"</span>
)

agent = create_agent(
    model=model,
    tools=[get_weather],
    system_prompt=SYSTEM_PROMPT
)
</code></pre>
<ol start="2">
<li><strong>下载并安装 Trae：</strong> 前往 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.trae.cn%2F" target="_blank" title="https://www.trae.cn/" ref="nofollow noopener noreferrer">Trae 官网</a> 下载安装包。目前 Trae 国内版已全面上线 SOLO 模式。Windows 平台的安装非常简单，只需一路点击"下一步"即可完成。安装完成后打开 Trae，你会看到类似 VS Code 的界面风格。默认进入的是 <strong>Build 模式</strong>，这类似于笔者在文章《<a href="https://juejin.cn/post/7475973902658027531" target="_blank" title="https://juejin.cn/post/7475973902658027531">零门槛！手把手教你用VS Code + DeepSeek 玩转AI编程！（5分钟编写部署个人网站）</a>》中使用的 VS Code Cline 插件，可以通过与 AI 助手对话辅助编写代码。</li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/856bd24da137485da6e3ab13677e37b3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L55yf5aW9546p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765240253&amp;x-signature=waQ5k4DPxNrZVQi7qHS51CG0C8U%3D" alt="4.png" loading="lazy"/></p>
<ol start="3">
<li><strong>切换到 SOLO 模式：</strong> 今天笔者要体验的是更强大的 <strong>SOLO 模式</strong>。点击左上角的 IDE 标签即可切换到该模式，它能实现更高程度的开发自动化。SOLO 模式类似于笔者在《<a href="https://juejin.cn/post/7574615024293429274" target="_blank" title="https://juejin.cn/post/7574615024293429274">Gemini3.0深度解析，它在重新定义智能</a>》一文中提到的 Vibe 编程概念：用户只需用自然语言描述需求（例如"开发一个在线背单词应用"），AI 就能自主完成从需求分析、编码、测试到部署的全流程。</li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/24640a2c0a0945fe8284788639fcb6d8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L55yf5aW9546p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765240253&amp;x-signature=GGcssYmllOEt5d73u1CW9PUkkTA%3D" alt="5.png" loading="lazy"/></p>
<ol start="4">
<li><strong>用自然语言描述需求：</strong> 在 SOLO Coder 对话框中输入以下提示词：</li>
</ol>

<pre><code class="hljs">你是一名python编程专家，熟练掌握langchain1.0开发智能体, fastapi编写接口的能力，可以满足用户提出的任何需求。现在项目中的langchain_weather.py文件中包含一个天气助手的智能体，我希望使用fastapi编写openai 风格的接口，注意需要使用流式接口。使该智能体可以被chatbox等客户端以api格式接入，请实现我的需求并本地启动接口，请完成我的需求
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4874589ce4214d7c911ad2af1ca73ee5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L55yf5aW9546p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765240253&amp;x-signature=szKxbU7Oxi95MdVqlZwEfvW5shA%3D" alt="7.png" loading="lazy"/></p>
<ol start="5">
<li>
<p><strong>观察 Trae Solo 的自动化工作流程：</strong> 按下回车键后，Trae Solo 开始自动执行任务：</p>
<ul>
<li><strong>智能分析</strong>：首先分析 <code>langchain_weather.py</code> 源文件，并识别出了代码中的一个 Bug——未定义 <code>WeatherQuery</code> 类型。</li>
<li><strong>代码生成</strong>：新建 <code>main.py</code> 文件，编写符合 OpenAI 风格的 API 接口。</li>
<li><strong>自我修复</strong>：进行测试时发现导入问题，自动修复相关 Bug。</li>
<li><strong>环境管理</strong>：启动应用时使用 uv 创建虚拟环境，确保环境稳定性。</li>
<li><strong>端口处理</strong>：检测到端口占用时，自动进行循环优化处理。</li>
<li><strong>全面测试</strong>：通过编写 <code>test-api.py</code>、使用 curl 命令等多种方式测试服务稳定性。</li>
</ul>
</li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/594c90c6ca8343ad89cfb3d933f9f444~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L55yf5aW9546p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765240253&amp;x-signature=qFIk7BEQDsIPp%2FEu23GyxVevvgg%3D" alt="8.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/03504b99c28a488c91c4fa838c8aed60~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L55yf5aW9546p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765240253&amp;x-signature=m%2FIY1JllIjAiJ%2B1DlAHtDQm4yXM%3D" alt="9.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cb2ee0620b7a4dea93aeed0718da3ab2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L55yf5aW9546p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765240253&amp;x-signature=OxVZIkyY1WZH%2BCAClyDxCfVZKM4%3D" alt="11.png" loading="lazy"/></p>
<ol start="6">
<li><strong>生成的 FastAPI 代码分析：</strong> 查看 Trae Solo 生成的 <code>main.py</code> 代码，其结构清晰、可维护性强：</li>
</ol>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> FastAPI, HTTPException
<span class="hljs-keyword">from</span> fastapi.middleware.cors <span class="hljs-keyword">import</span> CORSMiddleware
<span class="hljs-keyword">from</span> fastapi.responses <span class="hljs-keyword">import</span> StreamingResponse
<span class="hljs-keyword">from</span> pydantic <span class="hljs-keyword">import</span> BaseModel, Field
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>, <span class="hljs-type">Optional</span>, <span class="hljs-type">Union</span>, Generator
<span class="hljs-keyword">import</span> uvicorn
<span class="hljs-keyword">import</span> time
<span class="hljs-keyword">import</span> json
<span class="hljs-keyword">from</span> langchain_weather <span class="hljs-keyword">import</span> agent

app = FastAPI(
    title=<span class="hljs-string">"Weather Assistant API"</span>,
    description=<span class="hljs-string">"OpenAI风格的天气助手API，支持chatbox等客户端接入"</span>,
    version=<span class="hljs-string">"1.0.0"</span>
)

<span class="hljs-comment"># 添加CORS中间件，允许跨域请求</span>
app.add_middleware(
    CORSMiddleware,
    allow_origins=[<span class="hljs-string">"*"</span>],  <span class="hljs-comment"># 允许所有来源，生产环境应限制具体域名</span>
    allow_credentials=<span class="hljs-literal">True</span>,
    allow_methods=[<span class="hljs-string">"*"</span>],
    allow_headers=[<span class="hljs-string">"*"</span>],
)

<span class="hljs-comment"># 定义OpenAI风格的请求模型</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Message</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    role: <span class="hljs-built_in">str</span>
    content: <span class="hljs-built_in">str</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">ChatCompletionRequest</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    model: <span class="hljs-built_in">str</span> = <span class="hljs-string">"deepseek-chat"</span>
    messages: <span class="hljs-type">List</span>[Message]
    temperature: <span class="hljs-type">Optional</span>[<span class="hljs-built_in">float</span>] = <span class="hljs-number">0.7</span>
    max_tokens: <span class="hljs-type">Optional</span>[<span class="hljs-built_in">int</span>] = <span class="hljs-literal">None</span>
    stream: <span class="hljs-type">Optional</span>[<span class="hljs-built_in">bool</span>] = <span class="hljs-literal">False</span>

<span class="hljs-comment"># 定义OpenAI风格的响应模型</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Choice</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    index: <span class="hljs-built_in">int</span>
    message: Message
    finish_reason: <span class="hljs-built_in">str</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">ChatCompletionResponse</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    <span class="hljs-built_in">id</span>: <span class="hljs-built_in">str</span>
    <span class="hljs-built_in">object</span>: <span class="hljs-built_in">str</span> = <span class="hljs-string">"chat.completion"</span>
    created: <span class="hljs-built_in">int</span>
    model: <span class="hljs-built_in">str</span>
    choices: <span class="hljs-type">List</span>[Choice]
    usage: <span class="hljs-type">Optional</span>[<span class="hljs-built_in">dict</span>] = <span class="hljs-literal">None</span>

<span class="hljs-comment"># 定义流式响应的Chunk模型</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ChunkChoice</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    index: <span class="hljs-built_in">int</span>
    delta: <span class="hljs-built_in">dict</span>
    finish_reason: <span class="hljs-type">Optional</span>[<span class="hljs-built_in">str</span>] = <span class="hljs-literal">None</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">ChatCompletionChunk</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    <span class="hljs-built_in">id</span>: <span class="hljs-built_in">str</span>
    <span class="hljs-built_in">object</span>: <span class="hljs-built_in">str</span> = <span class="hljs-string">"chat.completion.chunk"</span>
    created: <span class="hljs-built_in">int</span>
    model: <span class="hljs-built_in">str</span>
    choices: <span class="hljs-type">List</span>[ChunkChoice]

<span class="hljs-meta">@app.post(<span class="hljs-params"><span class="hljs-string">"/chat/completions"</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">chat_completions</span>(<span class="hljs-params">request: ChatCompletionRequest</span>):
    <span class="hljs-string">"""处理聊天请求，调用天气助手智能体"""</span>
    <span class="hljs-keyword">try</span>:
        <span class="hljs-comment"># 提取用户最后一条消息</span>
        user_message = request.messages[-<span class="hljs-number">1</span>].content
        
        <span class="hljs-comment"># 生成响应ID</span>
        response_id = <span class="hljs-string">f"chatcmpl-<span class="hljs-subst">{<span class="hljs-built_in">hash</span>(<span class="hljs-built_in">str</span>(request))}</span>"</span>
        created_time = <span class="hljs-built_in">int</span>(time.time())
        
        <span class="hljs-keyword">if</span> request.stream:
            <span class="hljs-comment"># 流式响应处理</span>
            <span class="hljs-keyword">def</span> <span class="hljs-title function_">generate_stream</span>() -&gt; Generator[<span class="hljs-built_in">str</span>, <span class="hljs-literal">None</span>, <span class="hljs-literal">None</span>]:
                <span class="hljs-comment"># 调用智能体处理请求</span>
                result = agent.invoke({<span class="hljs-string">"messages"</span>: [{<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: user_message}]})
                
                <span class="hljs-comment"># 获取智能体返回的消息内容</span>
                assistant_content = <span class="hljs-string">""</span>
                <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(result, <span class="hljs-built_in">dict</span>) <span class="hljs-keyword">and</span> <span class="hljs-string">"messages"</span> <span class="hljs-keyword">in</span> result:
                    <span class="hljs-comment"># 如果返回的是字典格式</span>
                    last_message = result[<span class="hljs-string">"messages"</span>][-<span class="hljs-number">1</span>]
                    <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(last_message, <span class="hljs-built_in">dict</span>):
                        assistant_content = last_message.get(<span class="hljs-string">"content"</span>, <span class="hljs-string">""</span>)
                    <span class="hljs-keyword">else</span>:
                        <span class="hljs-comment"># 如果是Message对象</span>
                        assistant_content = last_message.content
                <span class="hljs-keyword">else</span>:
                    <span class="hljs-comment"># 直接处理Message对象</span>
                    assistant_content = result.content
                
                <span class="hljs-comment"># 模拟流式输出，逐字发送</span>
                chunk_id = <span class="hljs-number">0</span>
                <span class="hljs-keyword">for</span> char <span class="hljs-keyword">in</span> assistant_content:
                    chunk = ChatCompletionChunk(
                        <span class="hljs-built_in">id</span>=response_id,
                        created=created_time,
                        model=request.model,
                        choices=[
                            ChunkChoice(
                                index=<span class="hljs-number">0</span>,
                                delta={<span class="hljs-string">"content"</span>: char},
                                finish_reason=<span class="hljs-literal">None</span>
                            )
                        ]
                    )
                    <span class="hljs-keyword">yield</span> <span class="hljs-string">f"data: <span class="hljs-subst">{json.dumps(chunk.<span class="hljs-built_in">dict</span>(), ensure_ascii=<span class="hljs-literal">False</span>)}</span>\n\n"</span>
                    time.sleep(<span class="hljs-number">0.05</span>)  <span class="hljs-comment"># 控制流式输出速度</span>
                
                <span class="hljs-comment"># 发送结束标志</span>
                end_chunk = ChatCompletionChunk(
                    <span class="hljs-built_in">id</span>=response_id,
                    created=created_time,
                    model=request.model,
                    choices=[
                        ChunkChoice(
                            index=<span class="hljs-number">0</span>,
                            delta={},
                            finish_reason=<span class="hljs-string">"stop"</span>
                        )
                    ]
                )
                <span class="hljs-keyword">yield</span> <span class="hljs-string">f"data: <span class="hljs-subst">{json.dumps(end_chunk.<span class="hljs-built_in">dict</span>(), ensure_ascii=<span class="hljs-literal">False</span>)}</span>\n\n"</span>
                <span class="hljs-keyword">yield</span> <span class="hljs-string">"data: [DONE]\n\n"</span>
            
            <span class="hljs-keyword">return</span> StreamingResponse(generate_stream(), media_type=<span class="hljs-string">"text/event-stream"</span>)
        <span class="hljs-keyword">else</span>:
            <span class="hljs-comment"># 非流式响应处理</span>
            <span class="hljs-comment"># 调用智能体处理请求</span>
            result = agent.invoke({<span class="hljs-string">"messages"</span>: [{<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: user_message}]})
            
            <span class="hljs-comment"># 获取智能体返回的消息内容</span>
            assistant_content = <span class="hljs-string">""</span>
            <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(result, <span class="hljs-built_in">dict</span>) <span class="hljs-keyword">and</span> <span class="hljs-string">"messages"</span> <span class="hljs-keyword">in</span> result:
                <span class="hljs-comment"># 如果返回的是字典格式</span>
                last_message = result[<span class="hljs-string">"messages"</span>][-<span class="hljs-number">1</span>]
                <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(last_message, <span class="hljs-built_in">dict</span>):
                    assistant_content = last_message.get(<span class="hljs-string">"content"</span>, <span class="hljs-string">""</span>)
                <span class="hljs-keyword">else</span>:
                    <span class="hljs-comment"># 如果是Message对象</span>
                    assistant_content = last_message.content
            <span class="hljs-keyword">else</span>:
                <span class="hljs-comment"># 直接处理Message对象</span>
                assistant_content = result.content
            
            <span class="hljs-comment"># 构建响应</span>
            response = ChatCompletionResponse(
                <span class="hljs-built_in">id</span>=response_id,
                created=created_time,
                model=request.model,
                choices=[
                    Choice(
                        index=<span class="hljs-number">0</span>,
                        message=Message(
                            role=<span class="hljs-string">"assistant"</span>,
                            content=assistant_content
                        ),
                        finish_reason=<span class="hljs-string">"stop"</span>
                    )
                ]
            )
            
            <span class="hljs-keyword">return</span> response
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-keyword">raise</span> HTTPException(status_code=<span class="hljs-number">500</span>, detail=<span class="hljs-built_in">str</span>(e))

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    uvicorn.run(app, host=<span class="hljs-string">"0.0.0.0"</span>, port=<span class="hljs-number">8001</span>)
</code></pre>
<ol start="7">
<li>
<p><strong>配置 Chatbox 连接：</strong> 接下来，笔者将这个服务接入 <a href="https://link.juejin.cn?target=https%3A%2F%2Fchatboxai.app%2Fzh" target="_blank" title="https://chatboxai.app/zh" ref="nofollow noopener noreferrer">Chatbox</a>。下载并安装 Chatbox 后，按以下步骤配置：</p>
<ul>
<li>点击"设置" → "模型"</li>
<li>添加新的模型提供方</li>
<li>配置参数：API 主机：<code>http://localhost:8001</code>，API 路径：<code>/chat/completions</code></li>
</ul>
</li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/251d8a8207f846f2a7ea52e6638c8370~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L55yf5aW9546p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765240253&amp;x-signature=bKby1szn9QfvQtClJScD8w4pZ7E%3D" alt="12.png" loading="lazy"/></p>
<ol start="8">
<li><strong>测试效果：</strong></li>
</ol>
<p>输入北京的天气：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9355d7495ec84229a652be323a4757c1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L55yf5aW9546p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765240253&amp;x-signature=uy02pWux09GhTfPwM4yfuu%2Flz88%3D" alt="13.png" loading="lazy"/></p>
<p>输入上海的天气：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7e00ce4362c64c869b1040fd79bb5b08~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L55yf5aW9546p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765240253&amp;x-signature=FsjspJmeVro3F7N8RJgQ9JyFn7o%3D" alt="14.png" loading="lazy"/></p>
<p>可以看到，智能体成功返回了天气信息，并以林志玲的甜美语气进行播报。整个过程从智能体代码到完整的 API 服务，几乎都由 Trae Solo 自动完成！</p>
<h2 data-id="heading-6">四、展望</h2>
<p>通过这个简单的智能体接入实验，我们足以感受到 Trae SOLO 模式的强大潜力。它不仅能自动生成代码，更能完成从分析、测试到服务部署的全流程，真正实现了“描述即开发”的愿景。</p>
<p>也许有人会说，这只是一个小型演示项目，Trae SOLO 能否应对更复杂的生产场景仍有待验证。但我相信，凭借字节跳动深厚的技术积累和众多优秀工程师的努力，这款工具必将持续进化，越来越好。</p>
<p>更重要的是，这次尝试为我们打开了一扇新的窗口：如果 Trae 能够理解并编写智能体接入代码，那么它是否可以直接开发基于 LangChain 的智能体？或许，我们只需要用自然语言描述需求，就能通过 Trae 自动生成智能体，再借助本文的接入方案快速集成到 Chatbox 等客户端中。</p>
<p>想象一下：一个人、一个想法、一句描述，就能快速构建起可用的智能体服务——这正是 Vibe Coding 的魅力所在。它不只是一种编程方式，更是一种让想象力迅速照进现实的开发范式。未来，或许每个人都能轻松打造属于自己的“智能体帝国”。</p>
<h2 data-id="heading-7">五、总结</h2>
<p>本期笔者借助 Trae Solo，快速实现了将 LangChain 智能体接入 Chatbox 客户端的完整流程。这不仅为智能体提供了一个轻量、便捷的调用入口，也让笔者亲身感受到了“自然语言驱动开发”的高效与直观。通过本次实践，笔者见证了 Trae Solo 在代码生成、接口适配、测试验证乃至环境部署上的自动化能力。如果你也有类似的需求——无论是简单的工具对接，还是更复杂的应用开发——都不妨尝试用 Trae Solo 来描述你的想法，让它帮你快速搭建原型、验证逻辑。</p>
<p>笔者打算继续利用 Trae Solo为专栏《<a href="https://juejin.cn/column/7526240014499495972" target="_blank" title="https://juejin.cn/column/7526240014499495972">深入浅出LangChain&amp;LangGraph AI Agent 智能体开发</a>》中的多模态 RAG 系统系列文章，开发一个美观且实用的前端界面。欢迎大家和我一起体验更多“描述即实现”的创作乐趣！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端组件二次封装实战：Vue+React基于Element UI/AntD的高效封装策略]]></title>    <link>https://juejin.cn/post/7578760341279801385</link>    <guid>https://juejin.cn/post/7578760341279801385</guid>    <pubDate>2025-12-02T00:39:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578760341279801385" data-draft-id="7576483553879457818" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端组件二次封装实战：Vue+React基于Element UI/AntD的高效封装策略"/> <meta itemprop="keywords" content="前端,Vue.js,React.js"/> <meta itemprop="datePublished" content="2025-12-02T00:39:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="鹏多多"/> <meta itemprop="url" content="https://juejin.cn/user/747323639737191"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端组件二次封装实战：Vue+React基于Element UI/AntD的高效封装策略
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/747323639737191/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    鹏多多
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T00:39:01.000Z" title="Tue Dec 02 2025 00:39:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:2;font-weight:400;font-size:15px;overflow-x:hidden;color:#333;letter-spacing:1.2px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1:first-child,.markdown-body h2:first-child,.markdown-body h3:first-child,.markdown-body h4:first-child,.markdown-body h5:first-child,.markdown-body h6:first-child{margin-top:-1.5rem;margin-bottom:1rem}.markdown-body h1:before,.markdown-body h2:before,.markdown-body h3:before,.markdown-body h4:before,.markdown-body h5:before,.markdown-body h6:before{content:"#";display:inline-block;color:#3eaf7c;padding-right:.23em}.markdown-body h1{position:relative;font-size:2.5rem;margin-bottom:5px}.markdown-body h1:before{font-size:2.5rem}.markdown-body h2{padding-bottom:.5rem;font-size:2.2rem;border-bottom:1px solid #ececec}.markdown-body h3{font-size:1.5rem;padding-bottom:0}.markdown-body h4{font-size:1.25rem}.markdown-body h5{font-size:1rem}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body strong{color:#3eaf7c}.markdown-body img{max-width:100%;border-radius:2px;display:block;margin:auto}.markdown-body hr{border:none;border-top:1px solid #3eaf7c;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;overflow-x:auto;padding:.2rem .5rem;margin:0;color:#3eaf7c;font-size:.85em;background-color:rgba(27,31,35,.05);border-radius:3px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border:.5rem solid #3eaf7c}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{font-weight:500;text-decoration:none;color:#3eaf7c;margin:0 5px}.markdown-body a:active,.markdown-body a:hover{text-decoration:none;border-bottom:1.5px solid #3eaf7c}.markdown-body a[href^=http]:after{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTQiIGhlaWdodD0iMTQiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik04MzIgMTI4SDY0MHY2NGgxNDYuNzUyTDUyMS4zNzYgNDU3LjM3Nmw0NS4yNDggNDUuMjQ4TDgzMiAyMzcuMjQ4VjM4NGg2NFYxMjh6IiBmaWxsPSIjM2VhZjdjIi8+PHBhdGggZD0iTTc2OCA4MzJIMTkyVjI1NmgzNTJ2LTY0SDE2MGEzMiAzMiAwIDAwLTMyIDMydjY0MGEzMiAzMiAwIDAwMzIgMzJoNjQwYTMyIDMyIDAgMDAzMi0zMlY0ODBoLTY0djM1MnoiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");margin-left:2px}.markdown-body a[href^="#"]:before{content:"#"}.markdown-body table{display:inline-block!important;font-size:13px;width:auto;max-width:100%;overflow:auto;border:1px solid #3eaf7c;border-collapse:collapse}.markdown-body thead{background:#3eaf7c;color:#fff;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(153,255,188,.1)}.markdown-body td,.markdown-body th{padding:4px 8px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#7b7878;padding:1px 23px;border-left:.5rem solid;border-color:#42b983;background-color:rgba(66,184,131,.1);position:relative;margin:14px 8px 0}.markdown-body blockquote:before{display:inline-block;position:absolute;content:url("data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjUiIGhlaWdodD0iMjUiIHZpZXdCb3g9IjAgMCAyNyAyNyIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxLjg2MiAxLjg2MikiIGZpbGwtcnVsZT0ibm9uemVybyIgZmlsbD0ibm9uZSI+PGNpcmNsZSBzdHJva2U9IiNGRkYiIHN0cm9rZS13aWR0aD0iMS43MjQiIGZpbGw9IiM0MkI5ODMiIGN4PSIxMS42MzgiIGN5PSIxMS42MzgiIHI9IjExLjYzOCIvPjxwYXRoIGQ9Ik0xNC45NzggNi4yN0E1LjAwNiA1LjAwNiAwIDAwNi42NyA5LjQ2OGE0LjkwMSA0LjkwMSAwIDAwMS43NzMgNC4zNjJjLjMyMy4yNTguNTE0LjY0Ny41MjIgMS4wNnYxLjA2YTIuNjg1IDIuNjg1IDAgMDA1LjM3IDB2LTEuMDA4Yy4wMDItLjM5OC4xNzMtLjc3Ny40Ny0xLjA0MmE1LjAyMyA1LjAyMyAwIDAwLjE3My03LjYzem0tMy4zMzcgMTAuOTY3YTEuMzA0IDEuMzA0IDAgMDEtMS4yODYtMS4yODd2LS4yNzhoMi41NzJ2LjI2MWMwIC43MTMtLjU3MyAxLjI5NC0xLjI4NiAxLjMwNHptMi4yNi00LjQxNWMtLjQ0LjM4My0uNzUuODkzLS44ODcgMS40NmgtMi43NDZhMi44NjggMi44NjggMCAwMC0uOTM4LTEuNTNoLS4wMThhMy40NzYgMy40NzYgMCAwMS0xLjI2OS0zLjE0NSAzLjYxNSAzLjYxNSAwIDAxNy4xOTYuNCAzLjY1IDMuNjUgMCAwMS0xLjMzOCAyLjgxNXoiIGZpbGw9IiNGRkYiLz48L2c+PC9zdmc+");width:25px;height:25px;left:-16px;top:12px}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body details{outline:none;border:none;border-left:4px solid #3eaf7c;padding-left:10px;margin-left:4px}.markdown-body details summary{cursor:pointer;border:none;outline:none;background:#fff;margin:0 -17px}.markdown-body details summary::-webkit-details-marker{color:#3eaf7c}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body ol li::marker{color:#3eaf7c}.markdown-body ul li{list-style:none;padding-left:10px}.markdown-body ul li::marker{content:"•";color:#3eaf7c}.markdown-body ul li.task-list-item:before{content:"";margin-right:0}.markdown-body input[type=checkbox]{vertical-align:text-bottom;box-shadow:inset 0 0 0 10px #fff}.markdown-body input[type=checkbox]:before{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTYiIGhlaWdodD0iMTYiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik04NzcuMDU2IDE0Ni45NDR2NzMwLjExMkgxNDYuOTQ0VjE0Ni45NDRoNzMwLjExMnptMC0xMDQuMjc3SDE0Ni45NDRjLTU3LjYyOCAwLTEwNC4yNzcgNDYuNjQ5LTEwNC4yNzcgMTA0LjI3N3Y3MzAuMTEyYzAgNTcuNjI4IDQ2LjY0OSAxMDQuMjc3IDEwNC4yNzcgMTA0LjI3N2g3MzAuMTEyYzU3LjYyOCAwIDEwNC4yNzctNDYuNjQ5IDEwNC4yNzctMTA0LjI3N1YxNDYuOTQ0YzAtNTcuNjI4LTQ2LjY0OS0xMDQuMjc3LTEwNC4yNzctMTA0LjI3N3oiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");position:relative;top:-2px;right:2px}.markdown-body input[type=checkbox]:checked:before{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTUiIGhlaWdodD0iMTUiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik05MTAuMjA4IDBIMTEzLjc2QTExNC4xMTIgMTE0LjExMiAwIDAwLS4wMzIgMTEzLjc5MlY5MTAuMjRjMCA2Mi41OTIgNTEuMiAxMTMuNzkyIDExMy43OTIgMTEzLjc5Mmg3OTYuNDQ4YzYyLjU5MiAwIDExMy43OTItNTEuMiAxMTMuNzkyLTExMy43OTJWMTEzLjc5MkMxMDI0IDUxLjIgOTcyLjggMCA5MTAuMjA4IDB6bS01MTIgNzk2LjQ0OEwxMTMuNzYgNTEybDc5LjY0OC03OS42NDggMjA0LjggMjA0LjhMODMwLjU2IDIwNC44bDc5LjY0OCA3OS42NDgtNTEyIDUxMnoiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");position:relative;top:-2px;right:2px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="agate">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#333;color:#fff}.hljs-name,.hljs-strong{font-weight:700}.hljs-code,.hljs-emphasis{font-style:italic}.hljs-tag{color:#62c8f3}.hljs-selector-class,.hljs-selector-id,.hljs-template-variable,.hljs-variable{color:#ade5fc}.hljs-bullet,.hljs-string{color:#a2fca2}.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-quote,.hljs-section,.hljs-title,.hljs-type{color:#ffa}.hljs-bullet,.hljs-number,.hljs-symbol{color:#d36363}.hljs-keyword,.hljs-literal,.hljs-selector-tag{color:#fcc28c}.hljs-code,.hljs-comment,.hljs-deletion{color:#888}.hljs-link,.hljs-regexp{color:#c6b4f0}.hljs-meta{color:#fc9b9b}.hljs-deletion{background-color:#fc9b9b;color:#333}.hljs-addition{background-color:#a2fca2;color:#333}.hljs a{color:inherit}.hljs a:focus,.hljs a:hover{color:inherit;text-decoration:underline}</style><p>在中后台项目开发中，Element UI（Vue）和Ant Design（AntD，React）是主流的组件库，但原生组件往往无法直接适配业务场景，比如：统一的表单校验规则、标准化的表格交互、个性化的弹窗样式等。此时，基于组件库的二次封装成为平衡开发效率、代码复用与团队规范的核心手段。我将围绕<strong>何时封装</strong>、<strong>为何封装</strong>、<strong>如何封装</strong>，三个核心问题，聚焦Element UI/AntD的二次封装技巧，结合Vue 3和React 18的实战案例，拆解高效且易扩展的封装方法论。</p>
<h2 data-id="heading-0">1. 什么时候值得封装一个组件</h2>
<p>组件封装不是“为了封装而封装”，当满足以下场景时，二次封装的收益远大于成本：</p>
<h3 data-id="heading-1">1.1. 重复场景出现时：减少复制粘贴</h3>
<p>当同一类UI/交互在2个及以上模块出现（如Element UI的Table+分页、AntD的Form+搜索按钮），且仅参数不同，封装可避免重复代码。</p>
<ul>
<li>示例：多个列表页都用Element UI的Table，且都需要“分页+多选+操作列”，封装<code>BaseTable</code>组件统一逻辑。</li>
</ul>
<h3 data-id="heading-2">1.2. 业务规则需统一时：规避风格混乱</h3>
<p>当组件需要遵循统一的业务规则（如按钮权限控制、日期格式渲染、表单校验提示），封装可收口规则。</p>
<ul>
<li>示例：AntD的Button需根据用户角色控制显示/禁用，封装<code>AuthButton</code>统一处理权限逻辑，所有页面复用。</li>
</ul>
<h3 data-id="heading-3">1.3. 原生组件能力不足时：补齐个性化需求</h3>
<p>Element UI/AntD的通用能力无法覆盖业务场景（如Element UI的Dialog需拖拽、AntD的Select需最多显示3个多选标签），二次封装可定制化扩展。</p>
<h3 data-id="heading-4">1.4. 逻辑与UI耦合复杂时：降低维护成本</h3>
<p>当一个功能包含“数据请求+交互逻辑+样式定制”（如带远程搜索的部门选择器），封装可拆分复杂逻辑，符合单一职责原则。</p>
<h2 data-id="heading-5">2. 封装组件的核心目的</h2>
<p><strong>降本提效</strong>：一次封装，多处复用。后续需求变更（如表格分页样式调整），只需修改封装组件，所有引用处自动生效，无需逐个页面修改。</p>
<p><strong>逻辑内聚</strong>：高内聚、低耦合。将业务逻辑（如数据请求、校验规则）封装在组件内部，页面只需关注“传参”和“接收结果”，降低代码耦合度。</p>
<p><strong>扩展灵活</strong>：适配未来业务变化。预留扩展接口，新增需求（如表格新增导出功能）时，仅需扩展组件内部，不影响外部调用方式。</p>
<p><strong>统一标准</strong>：对齐团队开发规范。避免不同开发者对Element UI/AntD的定制方式不一致（如按钮尺寸、表单间距），保证项目风格统一。</p>
<h2 data-id="heading-6">3. Element UI/AntD二次封装核心技巧：透传原生Props</h2>
<p>二次封装的关键是“不丢失原生组件的能力”——即让封装后的组件能隐式传递原生组件的所有Props、事件和样式，同时新增业务逻辑。以下分Vue（Element Plus）和React（AntD）讲解核心实现方式。</p>
<p><strong>核心概念：透传的本质</strong></p>
<ul>
<li>Vue：通过<code>v-bind="$attrs"</code>透传Props，<code>v-on="$listeners"</code>（Vue 3已合并到<code>$attrs</code>）透传事件，<code>inheritAttrs: false</code>避免属性透传到根元素。</li>
<li>React：通过扩展运算符<code>{...props}</code>透传所有Props，通过<code>children</code>透传子元素，区分“业务Props”和“原生Props”。</li>
</ul>
<h3 data-id="heading-7">3.1. Vue 3 + Element Plus 二次封装实战</h3>
<p>以封装<code>BaseDialog</code>（基于ElDialog）为例，实现“拖拽+默认样式+透传原生Props”：</p>
<h4 data-id="heading-8">步骤1：基础封装（透传原生Props）</h4>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;!-- 根元素禁用属性继承，避免$attrs透传到div --&gt;
  &lt;div class="base-dialog"&gt;
    &lt;el-dialog
      v-bind="$attrs" &lt;!-- 透传ElDialog的所有原生Props（如title、visible、width） --&gt;
      :close-on-click-modal="false" &lt;!-- 业务默认值，可被外部Props覆盖 --&gt;
      @close="handleClose" &lt;!-- 内部处理基础事件，也可透传外部事件 --&gt;
      class="base-dialog__inner"
    &gt;
      &lt;!-- 插槽：透传ElDialog的默认插槽 --&gt;
      &lt;slot /&gt;
      &lt;!-- 插槽：自定义底部按钮 --&gt;
      &lt;template #footer&gt;
        &lt;slot name="footer"&gt;
          &lt;!-- 默认底部按钮 --&gt;
          &lt;el-button @click="handleCancel"&gt;取消&lt;/el-button&gt;
          &lt;el-button type="primary" @click="handleConfirm"&gt;确认&lt;/el-button&gt;
        &lt;/slot&gt;
      &lt;/template&gt;
    &lt;/el-dialog&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script setup lang="ts"&gt;
import { ref } from 'vue';
import { ElDialog, ElButton, ElMessage } from 'element-plus';
// 引入拖拽指令（可选，扩展功能）
import { vDialogDrag } from '@/directives/dialogDrag';

// 禁用根元素的属性继承，确保$attrs只透传给ElDialog
defineOptions({
  inheritAttrs: false
});

// 定义业务Props（与原生Props区分）
const props = defineProps&lt;{
  // 业务自定义Props，非ElDialog原生属性
  confirmText?: string;
  cancelText?: string;
}&gt;();

// 定义事件：透传原生事件 + 自定义业务事件
const emit = defineEmits&lt;{
  (e: 'confirm'): void; // 自定义确认事件
  (e: 'cancel'): void; // 自定义取消事件
  (e: 'close'): void; // 透传ElDialog的close事件
}&gt;();

// 内部处理确认逻辑
const handleConfirm = () =&gt; {
  emit('confirm');
  // 可扩展：统一的确认提示
  ElMessage.success('操作成功');
};

// 内部处理取消逻辑
const handleCancel = () =&gt; {
  emit('cancel');
  // 触发ElDialog的关闭（通过透传的visible属性由外部控制）
  emit('close');
};

// 透传ElDialog的close事件
const handleClose = () =&gt; {
  emit('close');
};
&lt;/script&gt;

&lt;style scoped&gt;
.base-dialog {
  --el-dialog-width: 600px; /* 自定义默认宽度，可被外部覆盖 */
}
.base-dialog__inner :deep(.el-dialog__header) {
  padding: 16px 20px;
  border-bottom: 1px solid #eee;
}
&lt;/style&gt;
</code></pre>
<h4 data-id="heading-9">步骤2：指令扩展（拖拽功能）</h4>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// src/directives/dialogDrag.ts</span>
<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">Directive</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">vDialogDrag</span>: <span class="hljs-title class_">Directive</span> = {
  <span class="hljs-title function_">mounted</span>(<span class="hljs-params">el</span>) {
    <span class="hljs-keyword">const</span> dialogHeaderEl = el.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.el-dialog__header'</span>);
    <span class="hljs-keyword">const</span> dragDom = el.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.el-dialog'</span>) <span class="hljs-keyword">as</span> <span class="hljs-title class_">HTMLElement</span>;
    <span class="hljs-keyword">if</span> (!dialogHeaderEl || !dragDom) <span class="hljs-keyword">return</span>;

    <span class="hljs-comment">// 设置拖拽元素可拖动</span>
    dialogHeaderEl.<span class="hljs-property">style</span>.<span class="hljs-property">cursor</span> = <span class="hljs-string">'move'</span>;
    dialogHeaderEl.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'mousedown'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
      <span class="hljs-comment">// 鼠标按下，计算当前元素距离可视区的距离</span>
      <span class="hljs-keyword">const</span> disX = e.<span class="hljs-property">clientX</span> - dialogHeaderEl.<span class="hljs-property">offsetLeft</span>;
      <span class="hljs-keyword">const</span> disY = e.<span class="hljs-property">clientY</span> - dialogHeaderEl.<span class="hljs-property">offsetTop</span>;
      <span class="hljs-keyword">const</span> dragDomWidth = dragDom.<span class="hljs-property">offsetWidth</span>;
      <span class="hljs-keyword">const</span> dragDomHeight = dragDom.<span class="hljs-property">offsetHeight</span>;
      <span class="hljs-keyword">const</span> screenWidth = <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-property">clientWidth</span>;
      <span class="hljs-keyword">const</span> screenHeight = <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-property">clientHeight</span>;

      <span class="hljs-comment">// 最大移动距离</span>
      <span class="hljs-keyword">const</span> maxX = screenWidth - dragDomWidth;
      <span class="hljs-keyword">const</span> maxY = screenHeight - dragDomHeight;

      <span class="hljs-comment">// 鼠标移动事件</span>
      <span class="hljs-keyword">const</span> <span class="hljs-title function_">moveFn</span> = (<span class="hljs-params">e: MouseEvent</span>) =&gt; {
        <span class="hljs-keyword">let</span> left = e.<span class="hljs-property">clientX</span> - disX;
        <span class="hljs-keyword">let</span> top = e.<span class="hljs-property">clientY</span> - disY;

        <span class="hljs-comment">// 边界处理</span>
        <span class="hljs-keyword">if</span> (left &lt; <span class="hljs-number">0</span>) left = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">if</span> (left &gt; maxX) left = maxX;
        <span class="hljs-keyword">if</span> (top &lt; <span class="hljs-number">0</span>) top = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">if</span> (top &gt; maxY) top = maxY;

        dragDom.<span class="hljs-property">style</span>.<span class="hljs-property">left</span> = <span class="hljs-string">`<span class="hljs-subst">${left}</span>px`</span>;
        dragDom.<span class="hljs-property">style</span>.<span class="hljs-property">top</span> = <span class="hljs-string">`<span class="hljs-subst">${top}</span>px`</span>;
      };

      <span class="hljs-comment">// 鼠标松开事件</span>
      <span class="hljs-keyword">const</span> <span class="hljs-title function_">upFn</span> = (<span class="hljs-params"/>) =&gt; {
        <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'mousemove'</span>, moveFn);
        <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'mouseup'</span>, upFn);
      };

      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'mousemove'</span>, moveFn);
      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'mouseup'</span>, upFn);
    });
  },
};
</code></pre>
<h4 data-id="heading-10">步骤3：父组件调用（透传原生Props + 扩展）</h4>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;el-button @click="dialogVisible = true"&gt;打开弹窗&lt;/el-button&gt;
  
  &lt;!-- 调用封装后的BaseDialog，可透传ElDialog所有原生Props --&gt;
  &lt;BaseDialog
    v-model="dialogVisible" &lt;!-- 透传ElDialog的visible属性（v-model语法糖） --&gt;
    title="自定义弹窗"
    width="800px" &lt;!-- 覆盖默认宽度 --&gt;
    confirm-text="提交" &lt;!-- 自定义业务Props --&gt;
    @confirm="handleConfirm"
    @close="handleClose"
  &gt;
    &lt;div&gt;弹窗内容&lt;/div&gt;
    &lt;!-- 自定义底部按钮（覆盖默认插槽） --&gt;
    &lt;template #footer&gt;
      &lt;el-button @click="dialogVisible = false"&gt;取消&lt;/el-button&gt;
      &lt;el-button type="primary" @click="handleSubmit"&gt;提交&lt;/el-button&gt;
    &lt;/template&gt;
  &lt;/BaseDialog&gt;
&lt;/template&gt;

&lt;script setup lang="ts"&gt;
import { ref } from 'vue';
import BaseDialog from './components/BaseDialog.vue';

const dialogVisible = ref(false);

const handleConfirm = () =&gt; {
  console.log('确认');
  dialogVisible.value = false;
};

const handleClose = () =&gt; {
  console.log('关闭');
};

const handleSubmit = () =&gt; {
  console.log('自定义提交');
  dialogVisible.value = false;
};
&lt;/script&gt;
</code></pre>
<h3 data-id="heading-11">3.2. React 18 + AntD 二次封装实战</h3>
<p>以封装<code>BaseTable</code>（基于AntD的Table）为例，实现“分页封装+透传原生Props+统一操作列”：</p>
<h4 data-id="heading-12">步骤1：基础封装（区分业务Props与原生Props）</h4>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { useState, useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Table</span>, <span class="hljs-title class_">Pagination</span>, <span class="hljs-title class_">Space</span>, <span class="hljs-title class_">Button</span>, <span class="hljs-title class_">Typography</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'antd'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">TableProps</span>, <span class="hljs-title class_">PaginationProps</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'antd'</span>;

<span class="hljs-comment">// 定义业务Props：与AntD Table原生Props区分</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">BaseTableProps</span>&lt;T = <span class="hljs-built_in">any</span>&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Omit</span>&lt;<span class="hljs-title class_">TableProps</span>&lt;T&gt;, 'pagination'&gt; {
  <span class="hljs-comment">// 业务自定义分页Props</span>
  paginationConfig?: <span class="hljs-title class_">PaginationProps</span>;
  <span class="hljs-comment">// 统一操作列配置</span>
  actionColumn?: {
    width?: <span class="hljs-built_in">number</span>;
    fixed?: <span class="hljs-string">'left'</span> | <span class="hljs-string">'right'</span>;
    <span class="hljs-comment">// 操作项配置</span>
    <span class="hljs-attr">actions</span>: {
      <span class="hljs-attr">text</span>: <span class="hljs-built_in">string</span>;
      <span class="hljs-attr">onClick</span>: <span class="hljs-function">(<span class="hljs-params">record: T</span>) =&gt;</span> <span class="hljs-built_in">void</span>;
      <span class="hljs-keyword">type</span>?: <span class="hljs-string">'primary'</span> | <span class="hljs-string">'default'</span> | <span class="hljs-string">'danger'</span>;
    }[];
  };
}

<span class="hljs-keyword">const</span> <span class="hljs-title class_">BaseTable</span> = &lt;T,&gt;<span class="hljs-function">(<span class="hljs-params">{
  columns,
  dataSource,
  paginationConfig,
  actionColumn,
  ...restProps // 剩余Props：透传AntD Table的原生Props
}: BaseTableProps&lt;T&gt;</span>) =&gt;</span> {
  <span class="hljs-comment">// 合并列配置：新增操作列</span>
  <span class="hljs-keyword">const</span> mergedColumns = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">useMemo</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> cols = [...(columns || [])];
    <span class="hljs-keyword">if</span> (actionColumn) {
      cols.<span class="hljs-title function_">push</span>({
        <span class="hljs-attr">title</span>: <span class="hljs-string">'操作'</span>,
        <span class="hljs-attr">key</span>: <span class="hljs-string">'action'</span>,
        <span class="hljs-attr">width</span>: actionColumn.<span class="hljs-property">width</span> || <span class="hljs-number">200</span>,
        <span class="hljs-attr">fixed</span>: actionColumn.<span class="hljs-property">fixed</span> || <span class="hljs-string">'right'</span>,
        <span class="hljs-attr">render</span>: <span class="hljs-function">(<span class="hljs-params">_, record</span>) =&gt;</span> (
          <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Space</span> <span class="hljs-attr">size</span>=<span class="hljs-string">"small"</span>&gt;</span>
            {actionColumn.actions.map((action, index) =&gt; (
              <span class="hljs-tag">&lt;<span class="hljs-name">Button</span>
                <span class="hljs-attr">key</span>=<span class="hljs-string">{index}</span>
                <span class="hljs-attr">type</span>=<span class="hljs-string">{action.type</span> || '<span class="hljs-attr">default</span>'}
                <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> action.onClick(record)}
              &gt;
                {action.text}
              <span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span>
            ))}
          <span class="hljs-tag">&lt;/<span class="hljs-name">Space</span>&gt;</span></span>
        ),
      });
    }
    <span class="hljs-keyword">return</span> cols;
  }, [columns, actionColumn]);

  <span class="hljs-comment">// 分页状态管理</span>
  <span class="hljs-keyword">const</span> [pagination, setPagination] = useState&lt;<span class="hljs-title class_">PaginationProps</span>&gt;({
    <span class="hljs-attr">current</span>: <span class="hljs-number">1</span>,
    <span class="hljs-attr">pageSize</span>: <span class="hljs-number">10</span>,
    <span class="hljs-attr">showSizeChanger</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">showQuickJumper</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">showTotal</span>: <span class="hljs-function">(<span class="hljs-params">total</span>) =&gt;</span> <span class="hljs-string">`共 <span class="hljs-subst">${total}</span> 条`</span>,
    ...paginationConfig,
  });

  <span class="hljs-comment">// 监听数据总数，更新分页</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (paginationConfig?.<span class="hljs-property">total</span> !== <span class="hljs-literal">undefined</span>) {
      <span class="hljs-title function_">setPagination</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> ({ ...prev, <span class="hljs-attr">total</span>: paginationConfig.<span class="hljs-property">total</span> }));
    }
  }, [paginationConfig?.<span class="hljs-property">total</span>]);

  <span class="hljs-comment">// 分页变更回调</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleTableChange</span> = (<span class="hljs-params">
    pagination: PaginationProps,
    filters: <span class="hljs-built_in">any</span>,
    sorter: <span class="hljs-built_in">any</span>
  </span>) =&gt; {
    <span class="hljs-title function_">setPagination</span>(pagination);
    <span class="hljs-comment">// 透传原生onChange事件</span>
    restProps.<span class="hljs-property">onChange</span>?.(pagination, filters, sorter);
  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">background:</span> '#<span class="hljs-attr">fff</span>', <span class="hljs-attr">padding:</span> <span class="hljs-attr">16</span>, <span class="hljs-attr">borderRadius:</span> <span class="hljs-attr">4</span> }}&gt;</span>
      {/* 透传AntD Table的所有原生Props */}
      &lt;Table<span class="hljs-tag">&lt;<span class="hljs-name">T</span>&gt;</span>
        columns={mergedColumns}
        dataSource={dataSource}
        pagination={false} // 禁用原生分页，自定义
        onChange={handleTableChange}
        bordered // 业务默认值，可被restProps覆盖
        {...restProps} // 透传剩余原生Props（如rowKey、loading、scroll）
      /&gt;
      {/* 自定义分页组件 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">marginTop:</span> <span class="hljs-attr">16</span>, <span class="hljs-attr">textAlign:</span> '<span class="hljs-attr">right</span>' }}&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Pagination</span>
          {<span class="hljs-attr">...pagination</span>}
          {<span class="hljs-attr">...paginationConfig</span>}
          <span class="hljs-attr">onChange</span>=<span class="hljs-string">{(page,</span> <span class="hljs-attr">pageSize</span>) =&gt;</span> {
            setPagination(prev =&gt; ({ ...prev, current: page, pageSize }));
          }}
        /&gt;
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  );
};

export default BaseTable;
</span></code></pre>
<h4 data-id="heading-13">步骤2：父组件调用（透传原生Props + 扩展）</h4>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">BaseTable</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./components/BaseTable'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Button</span>, message } <span class="hljs-keyword">from</span> <span class="hljs-string">'antd'</span>;

<span class="hljs-comment">// 模拟数据</span>
<span class="hljs-keyword">const</span> dataSource = [
  { <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'张三'</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">20</span>, <span class="hljs-attr">status</span>: <span class="hljs-string">'启用'</span> },
  { <span class="hljs-attr">id</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'李四'</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">22</span>, <span class="hljs-attr">status</span>: <span class="hljs-string">'禁用'</span> },
];

<span class="hljs-keyword">const</span> <span class="hljs-title function_">Page</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-comment">// 列配置</span>
  <span class="hljs-keyword">const</span> columns = [
    { <span class="hljs-attr">title</span>: <span class="hljs-string">'姓名'</span>, <span class="hljs-attr">dataIndex</span>: <span class="hljs-string">'name'</span>, <span class="hljs-attr">key</span>: <span class="hljs-string">'name'</span> },
    { <span class="hljs-attr">title</span>: <span class="hljs-string">'年龄'</span>, <span class="hljs-attr">dataIndex</span>: <span class="hljs-string">'age'</span>, <span class="hljs-attr">key</span>: <span class="hljs-string">'age'</span> },
    { <span class="hljs-attr">title</span>: <span class="hljs-string">'状态'</span>, <span class="hljs-attr">dataIndex</span>: <span class="hljs-string">'status'</span>, <span class="hljs-attr">key</span>: <span class="hljs-string">'status'</span> },
  ];

  <span class="hljs-comment">// 操作列配置</span>
  <span class="hljs-keyword">const</span> actionColumn = {
    <span class="hljs-attr">width</span>: <span class="hljs-number">200</span>,
    <span class="hljs-attr">fixed</span>: <span class="hljs-string">'right'</span>,
    <span class="hljs-attr">actions</span>: [
      {
        <span class="hljs-attr">text</span>: <span class="hljs-string">'编辑'</span>,
        <span class="hljs-attr">type</span>: <span class="hljs-string">'primary'</span>,
        <span class="hljs-attr">onClick</span>: <span class="hljs-function">(<span class="hljs-params">record</span>) =&gt;</span> {
          message.<span class="hljs-title function_">success</span>(<span class="hljs-string">`编辑<span class="hljs-subst">${record.name}</span>`</span>);
        },
      },
      {
        <span class="hljs-attr">text</span>: <span class="hljs-string">'删除'</span>,
        <span class="hljs-attr">type</span>: <span class="hljs-string">'danger'</span>,
        <span class="hljs-attr">onClick</span>: <span class="hljs-function">(<span class="hljs-params">record</span>) =&gt;</span> {
          message.<span class="hljs-title function_">warning</span>(<span class="hljs-string">`删除<span class="hljs-subst">${record.name}</span>`</span>);
        },
      },
    ],
  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">padding:</span> <span class="hljs-attr">20</span> }}&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">BaseTable</span>
        <span class="hljs-attr">rowKey</span>=<span class="hljs-string">"id"</span> // <span class="hljs-attr">透传AntD</span> <span class="hljs-attr">Table原生Props</span>
        <span class="hljs-attr">columns</span>=<span class="hljs-string">{columns}</span>
        <span class="hljs-attr">dataSource</span>=<span class="hljs-string">{dataSource}</span>
        <span class="hljs-attr">scroll</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">x:</span> <span class="hljs-attr">1000</span> }} // <span class="hljs-attr">透传原生Props</span>：<span class="hljs-attr">横向滚动</span>
        <span class="hljs-attr">loading</span>=<span class="hljs-string">{false}</span> // <span class="hljs-attr">透传原生Props</span>：<span class="hljs-attr">加载状态</span>
        <span class="hljs-attr">paginationConfig</span>=<span class="hljs-string">{{</span>
          <span class="hljs-attr">total:</span> <span class="hljs-attr">2</span>,
          <span class="hljs-attr">pageSize:</span> <span class="hljs-attr">10</span>,
        }}
        <span class="hljs-attr">actionColumn</span>=<span class="hljs-string">{actionColumn}</span>
        // <span class="hljs-attr">透传原生事件</span>
        <span class="hljs-attr">onRow</span>=<span class="hljs-string">{(record)</span> =&gt;</span> ({
          onClick: () =&gt; console.log('点击行', record),
        })}
      /&gt;
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">Page</span>;
</code></pre>
<h2 data-id="heading-14">4. 高效且易扩展的封装原则</h2>
<p>下面是一些封装时候的原则，Vue/React通用：</p>
<h3 data-id="heading-15">4.1. Props设计</h3>
<p>分层透传，不丢失原生能力</p>
<ul>
<li>Vue：用<code>$attrs</code>透传所有原生Props，<code>defineProps</code>仅声明业务自定义Props，<code>inheritAttrs: false</code>避免属性污染；</li>
<li>React：用<code>Omit</code>剔除业务Props，剩余Props通过<code>{...restProps}</code>透传，区分“业务逻辑Props”和“原生组件Props”。</li>
</ul>
<h3 data-id="heading-16">4.2. 扩展点设计</h3>
<p>插槽/Children优先</p>
<ul>
<li>Vue：预留具名插槽（如Dialog的footer、Table的action），支持局部替换；</li>
<li>React：通过<code>children</code>和自定义插槽对象（如<code>slots</code>）实现扩展，避免硬编码。</li>
</ul>
<h3 data-id="heading-17">4.3. 状态管理</h3>
<p>内部隔离，外部可控</p>
<ul>
<li>组件内部维护基础状态（如分页的current/pageSize），外部通过Props覆盖默认值；</li>
<li>事件透传：内部处理基础逻辑后，通过emit/回调将结果暴露给外部。</li>
</ul>
<h3 data-id="heading-18">4.4. 样式封装</h3>
<p>有默认样式+可覆盖</p>
<ul>
<li>Vue：用<code>scoped</code>+<code>:deep()</code>穿透样式，预留CSS变量（如<code>--el-dialog-width</code>）支持外部定制；</li>
<li>React：用CSS Modules隔离样式，支持传递<code>className</code>覆盖默认样式。</li>
</ul>
<h3 data-id="heading-19">4.5. 边界处理</h3>
<p>需要有兜底与兼容</p>
<ul>
<li>对空数据、空列配置做兜底（如Table无数据时显示“暂无数据”）；</li>
<li>兼容原生组件的所有事件（如Dialog的close、Table的onChange）。</li>
</ul>
<h2 data-id="heading-20">5. 封装的与团队规范</h2>
<p>下面是一些封装的"度"，与团队规范：</p>
<h3 data-id="heading-21">5.1. 避免过度封装</h3>
<ul>
<li>不封装“一次性”组件：仅单个页面使用、无复用价值的逻辑无需封装；</li>
<li>不滥用透传：核心业务Props显式声明，避免所有属性都透传导致维护困难。</li>
</ul>
<h3 data-id="heading-22">5.2. 组件分层：基础组件 vs 业务组件</h3>




















<table><thead><tr><th>类型</th><th>示例</th><th>特点</th></tr></thead><tbody><tr><td>基础组件</td><td>BaseDialog、BaseTable</td><td>基于Element UI/AntD封装，全项目复用</td></tr><tr><td>业务组件</td><td>OrderTable、UserForm</td><td>绑定具体业务逻辑，仅业务模块复用</td></tr></tbody></table>
<h3 data-id="heading-23">5.3. 文档化：标注透传能力</h3>
<p>封装组件需注明“支持透传XX原生组件的所有Props/事件”，示例：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-comment">/**
 * BaseTable 基于AntD Table的二次封装
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">BaseTableProps</span>} <span class="hljs-variable">props</span> - 组件属性
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">PaginationProps</span>} props.paginationConfig - 分页配置（业务自定义）
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Object</span>} props.actionColumn - 操作列配置（业务自定义）
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">TableProps</span>} ...restProps - 透传AntD Table的所有原生Props（除pagination）
 */</span>
</code></pre>
<h2 data-id="heading-24">6. 总结</h2>
<p>基于Element UI/AntD的二次封装，核心是“保留原生能力+新增业务逻辑”——通过透传Props确保不丢失组件库的原生功能，通过自定义Props和插槽实现业务定制，最终达到“复用、统一、易扩展”的目标。</p>
<p>Vue中通过<code>$attrs</code>和<code>inheritAttrs: false</code>实现透传，React中通过剩余参数<code>{...restProps}</code>区分业务与原生Props，两者核心思路一致：让封装后的组件既满足业务需求，又保持原生组件的灵活性。</p>
<p>好的二次封装组件，应该是“对开发者友好”的——调用方无需关心内部实现，只需通过简单的Props配置即可完成业务需求，同时能灵活扩展原生能力，真正做到<strong>封装不封死</strong>，以上。</p>
<hr/>
<blockquote>
<p>本次分享就到这儿啦，我是鹏多多，深耕前端的技术创作者，如果您看了觉得有帮助，欢迎评论，关注，点赞，转发，我们下次见~</p>
</blockquote>
<p>PS：在本页按F12，在console中输入document.getElementsByClassName('panel-btn')[0].click();有惊喜哦~</p>
<p><code>往期文章</code></p>
<ul>
<li><a href="https://juejin.cn/post/7575468252657303593" target="_blank" title="https://juejin.cn/post/7575468252657303593">HTML的Video从基础使用到高级实战+兼容的完全指南</a></li>
<li><a href="https://juejin.cn/post/7568192652286754870" target="_blank" title="https://juejin.cn/post/7568192652286754870">纯前端提取图片颜色插件Color-Thief教学+实战完整指南</a></li>
<li><a href="https://juejin.cn/post/7565737512816771135" target="_blank" title="https://juejin.cn/post/7565737512816771135">react-konva实战指南：Canvas高性能+易维护的组件化图形开发实现教程</a></li>
<li><a href="https://juejin.cn/post/7560905838074462271" target="_blank" title="https://juejin.cn/post/7560905838074462271">React无限滚动插件react-infinite-scroll-component的配置+优化+避坑指南</a></li>
<li><a href="https://juejin.cn/post/7560542615484137491" target="_blank" title="https://juejin.cn/post/7560542615484137491">前端音频兼容解决：音频神器howler.js从基础到进阶完整使用指南</a></li>
<li><a href="https://juejin.cn/post/7559871680015024169" target="_blank" title="https://juejin.cn/post/7559871680015024169">使用React-OAuth进行Google/GitHub登录的教程和案例</a></li>
<li><a href="https://juejin.cn/post/7550585427834404927" target="_blank" title="https://juejin.cn/post/7550585427834404927">纯前端人脸识别利器：face-api.js手把手深入解析教学</a></li>
<li><a href="https://juejin.cn/post/7553865490732433462" target="_blank" title="https://juejin.cn/post/7553865490732433462">关于React父组件调用子组件方法forwardRef的详解和案例</a></li>
<li><a href="https://juejin.cn/post/7553484874609410074" target="_blank" title="https://juejin.cn/post/7553484874609410074">React跨组件数据共享useContext详解和案例</a></li>
<li><a href="https://juejin.cn/post/7545087762837815334" target="_blank" title="https://juejin.cn/post/7545087762837815334">Web图像编辑神器tui.image-editor从基础到进阶的实战指南</a></li>
<li><a href="https://juejin.cn/post/7544323659788288046" target="_blank" title="https://juejin.cn/post/7544323659788288046">开发个人微信小程序类目选择/盈利方式/成本控制与服务器接入指南</a></li>
<li><a href="https://juejin.cn/post/7541741121400864778" target="_blank" title="https://juejin.cn/post/7541741121400864778">前端图片裁剪Cropper.js核心功能与实战技巧详解</a></li>
<li><a href="https://juejin.cn/post/7536530451461472265" target="_blank" title="https://juejin.cn/post/7536530451461472265">编辑器也有邪修？盘点VS Code邪门/有趣的扩展</a></li>
<li><a href="https://juejin.cn/post/7535005018257981466" target="_blank" title="https://juejin.cn/post/7535005018257981466">js使用IntersectionObserver实现目标元素可见度的交互</a></li>
<li><a href="https://juejin.cn/post/7534547200330121225" target="_blank" title="https://juejin.cn/post/7534547200330121225">Web前端页面开发阿拉伯语种适配指南</a></li>
<li><a href="https://juejin.cn/post/7516122409948020736" target="_blank" title="https://juejin.cn/post/7516122409948020736">让网页拥有App体验？PWA 将网页变为桌面应用的保姆级教程PWA</a></li>
<li><a href="https://juejin.cn/post/6953803916484018206" target="_blank" title="https://juejin.cn/post/6953803916484018206">使用nvm管理node.js版本以及更换npm淘宝镜像源</a></li>
<li><a href="https://juejin.cn/post/7140443283209060383" target="_blank" title="https://juejin.cn/post/7140443283209060383">手把手教你搭建规范的团队vue项目，包含commitlint，eslint，prettier，husky，commitizen等等</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[编写提示词需要遵循的五个原则（附实践案例）]]></title>    <link>https://juejin.cn/post/7578760341279883305</link>    <guid>https://juejin.cn/post/7578760341279883305</guid>    <pubDate>2025-12-02T00:48:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578760341279883305" data-draft-id="7578762210286534719" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="编写提示词需要遵循的五个原则（附实践案例）"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-12-02T00:48:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="磊磊落落"/> <meta itemprop="url" content="https://juejin.cn/user/3054882885469577"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            编写提示词需要遵循的五个原则（附实践案例）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3054882885469577/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    磊磊落落
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T00:48:46.000Z" title="Tue Dec 02 2025 00:48:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>大家好，我是磊磊落落，目前我在技术上主要关注：Java、Golang、AI、架构设计、云原生和自动化测试。欢迎来我的博客（<a href="https://link.juejin.cn?target=https%3A%2F%2Fleileiluoluo.com%2Fposts%2Fthe-five-principles-of-prompting.html" target="_blank" title="https://leileiluoluo.com/posts/the-five-principles-of-prompting.html" ref="nofollow noopener noreferrer">leileiluoluo.com</a>）获取我的最近更新！</p>
</blockquote>
<p>开始本文前，让我们首先明确提示词与提示工程的概念。提示词是我们与大语言模型沟通时输入的指令，而提示工程则是发现能生成符合预期、稳定、可靠、和可复现结果的提示词的过程。</p>
<p>为什么需要提示工程呢？就是因为当前的生成式人工智能还不够智能，其输出具有不确定性，用专业术语来说，就是存在随机生成「次品」的可能。为解决这个问题，必须有一套工程化的方法对提示词进行适当的优化。</p>
<p>一些工程师在实践中也确实探索出一组好用的原则，被称为「编写提示词的五个原则」，遵循这些原则编写出来的提示词能以更高的概率让 AI 模型生成稳定、可靠、可复现的结果。</p>
<p>接下来就介绍一下这「五个原则」，然后以「Spring Boot 项目中的 MyBatis 转 JPA」为例演示如何遵照原则优化提示词来让 AI 助手达到高质量的结果交付。</p>
<h2 data-id="heading-0">1 编写提示词需要遵循的五个原则</h2>
<ul>
<li><strong>明确方向</strong></li>
</ul>
<p>详细描述期望的结果，最好给出一个现实世界的参考模板。比如：生成一段搞笑的脱口秀稿子，参考「徐志胜」风格。</p>
<ul>
<li><strong>规范格式</strong></li>
</ul>
<p>指定大模型需遵循的规则，并明确限定输出结果的结构或格式。比如：要求大模型返回的结果为 JSON 格式，避免接收无规则的结果，且便于程序化集成。</p>
<ul>
<li><strong>提供范例</strong></li>
</ul>
<p>提供样例代码或提供一组多样化的预期输出的范例供大模型参考。比如：生成一组样例学生 JSON 数据，如 <code>[{"name": "Larry"}, {"name": "Lucy"}]</code>。</p>
<ul>
<li><strong>评估质量</strong></li>
</ul>
<p>对输出结果进行评级，通过测试来找出提升模型准确性的关键因素。比如：针对 AI 模型的输出结果，给出每个结果的分值，然后反馈给模型，这样能提升输出结果的准确性。</p>
<ul>
<li><strong>拆分任务</strong></li>
</ul>
<p>不要将一个复杂任务不做拆分就直接扔给大模型，而应将其拆分为多个步骤，这样大模型做起来才更得心应手。比如：不要跟大模型说「把这个事做了」，而是应将一个事拆分为多个步骤，然后指导大模型一步步去达成目标。</p>
<h2 data-id="heading-1">2 实践案例：将 Spring Boot 项目的数据库访问层由 MyBatis 转换为 JPA</h2>
<p>接下来以实际项目「<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.boyouquan.com%2F" target="_blank" title="https://www.boyouquan.com/" ref="nofollow noopener noreferrer">博友圈</a>」的后端（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fleileiluoluo%2Fboyouquan-api" target="_blank" title="https://github.com/leileiluoluo/boyouquan-api" ref="nofollow noopener noreferrer">boyouquan-api</a>）数据库访问层的转换为例，演示编写提示词时如何运用上述五个原则。</p>
<p>博友圈后端是一个使用 Maven 管理的 Spring Boot 项目，负责给前端提供 RESTful API。</p>
<p>其数据库访问层目前是基于 MyBatis 实现的，源码目录 <code>src/main/java</code> 下的包 <code>com.boyouquan.dao</code> 下定义了一组 Mapper 接口；资源目录 <code>src/main/resources</code> 下的子目录 <code>mapper</code> 下存放与 Mapper 接口对应的 XML 文件。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/790c35adfce34f5b8bf2080e67907672~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56OK56OK6JC96JC9:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765241326&amp;x-signature=KQ8zsYdSzmHTphIZucrrOfHC824%3D" alt="工程目录结构" loading="lazy"/></p>
<p>Mapper 接口中定义了一组方法：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e4843783fd3f49cb92eb02c4be6f3f3e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56OK56OK6JC96JC9:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765241326&amp;x-signature=A8JKuGjLgRQbsveL9QQ6tX%2FU1m4%3D" alt="MyBatis Mapper 接口" loading="lazy"/></p>
<p>与 Mappper 接口对应的 XML 文件中定义了方法所使用的 SQL：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9df7fddc4c864fcdb03030ce0192c29f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56OK56OK6JC96JC9:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765241326&amp;x-signature=luwl%2FeKDRoiNf2Gbo1vckDWUu%2BM%3D" alt="MyBatis Mapper XML 文件" loading="lazy"/></p>
<p>若我们想让 AI 助手帮忙将该工程的数据库访问层由 MyBatis 转换为 JPA，该如何编写提示词呢？</p>
<p>下面我们首先尝试一下未学习上述「五个原则」前的常规提示词，然后尝试一下学习了「五个原则」后的改进提示词，并对比两者的结果有何差异。</p>
<h3 data-id="heading-2">2.1 常规提示词</h3>
<p>下面是实现上述转换任务的常规提示词：</p>
<pre><code class="hljs language-text" lang="text">当前项目是一个使用 Maven 管理的 Spring Boot 项目，源码位于 src/main/java 下，配置文件位于 src/main/resources 下。

当前数据库访问层使用的是 MyBatis。Mapper 接口定义于包 com.boyouquan.dao 下，Mapper 配置文件 XxxDaoMapper.xml 位于 resources 的 mapper 目录下。

现在我们想将数据库访问层由 MyBatis 更改为 JPA。请自动抓取 MyBatis Mapper 接口中的方法名称与 Mapper 配置文件里的 SQL 语句，然后在 com.boyouquan.repository 下编写与 Mapper 接口对应的 Repository 接口、定义与 Mapper 接口中方法同名的方法并使用 @Query(value = "", nativeQuery = true) 注解填入 Mapper 配置文件里对应的 SQL。

完成后，请在项目根目录生成一个 report.md 报告文件，以表格的方式展示原始 Mapper 接口与新生成的 Repository 的对应关系。
</code></pre>
<p>在上述提示词中，我首先说明了当前项目的架构、源码目录、配置文件目录等背景信息；接着说明了 MyBatis Mapper 接口和 Mapper XML 文件的位置；然后说明了任务要求，并简单给出了实现步骤；最后我要求完成后生成一个报告。</p>
<p>下面尝试用 VS Code 打开项目，然后在 Copilot 聊天窗输入上述提示词，让 AI 助手以 Agent 模式帮我实现上述任务。</p>
<p>几分钟后，AI 助手帮我完成了 MyBatis 到 JPA 的转换：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f94ab927bbdc4e8e9989e060e3d4ceea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56OK56OK6JC96JC9:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765241326&amp;x-signature=stS7%2Fg4u04PbVf1cNFwj%2BLCedOQ%3D" alt="MyBatis 到 JPA 的转换结果（Raw Prompt）" loading="lazy"/></p>
<p>但结果不太理想，主要存在如下几个问题：</p>
<ul>
<li>生成的 JPA Repository 接口继承了 <code>Repository</code>，而不是我想象中的 <code>CrudRepository</code>；</li>
<li>不论是简单查询语句还是复杂查询语句，均使用了自定义查询，而没有根据情形将简单查询语句转换为 JPA 的命名方法实现；</li>
<li><code>@Query</code> 注解里填入的 SQL 不论长短均使用一个单行展开，而未根据情形使用 Java 13 的文本块特性将 SQL 换行。</li>
</ul>
<p>这就是我们当下使用 AI 的现状：我们指派 AI 做一些任务时，默认 AI 具备一些「常识」，但从结果来看，AI 并不一定具备这些「常识」。这也就是提示工程存在的意义。</p>
<h3 data-id="heading-3">2.2 优化后的提示词</h3>
<p>下面尝试使用上述的「五个原则」优化提示词，并将其放入项目根目录的文件 <code>mybatis-to-jpa.prompt.md</code> 中。</p>
<p>优化后的提示词如下：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># 将 MyBatis 替换为 JPA</span>

<span class="hljs-section">## 1 背景知识</span>

当前项目是一个使用 Maven 管理的 Spring Boot 项目，源码位于 <span class="hljs-code">`src/main/java`</span> 下，配置文件位于 <span class="hljs-code">`src/main/resources`</span> 下。

当前数据库访问层使用的是 MyBatis。Mapper 接口定义于包 <span class="hljs-code">`com.boyouquan.dao`</span> 下，Mapper 配置文件 <span class="hljs-code">`XxxDaoMapper.xml`</span> 位于 resources 的 mapper 目录下。

<span class="hljs-section">## 2 任务简介</span>

现在我们想将数据库访问层由 MyBatis 更改为 JPA。请自动抓取 MyBatis Mapper 接口中的方法名称与 Mapper 配置文件里的 SQL 语句，然后在 <span class="hljs-code">`com.boyouquan.repository`</span> 下编写与 Mapper 接口对应的 Repository 接口、定义与 Mapper 接口中方法同名的方法并使用 <span class="hljs-code">`@Query(value = "", nativeQuery = true)`</span> 注解填入 Mapper 配置文件里对应的 SQL。

<span class="hljs-section">## 3 实现步骤</span>

<span class="hljs-section">### 3.1 编写与 Mapper 接口对应的 Repository 接口</span>

首先，需要找到 <span class="hljs-code">`com.boyouquan.dao`</span> 包下所有的 Mapper 接口，然后在 <span class="hljs-code">`com.boyouquan.repository`</span> 包下新建对应的 Repository 接口。

如下为一个示例。

<span class="hljs-code">`com.boyouquan.dao`</span> 包下原始的 <span class="hljs-code">`BlogDaoMapper`</span> 接口定义如下：

<span class="hljs-code">```java
package com.boyouquan.dao;

public interface BlogDaoMapper {
}
```</span>

那么在 <span class="hljs-code">`com.boyouquan.repository`</span> 包下新建一个与 <span class="hljs-code">`BlogDaoMapper`</span> 接口对应的 Repository 接口 <span class="hljs-code">`BlogRepository`</span>，并让该 Repository 继承 <span class="hljs-code">`CrudRepository`</span>：

<span class="hljs-code">```java
package com.boyouquan.repository;

import org.springframework.data.repository.CrudRepository;
import org.springframework.stereotype.Repository;

@Repository
public interface BlogRepository extends CrudRepository&lt;Blog, Long&gt; {
}
```</span>

<span class="hljs-section">### 3.2 在 Repository 接口定义与 Mapper 接口中方法同名的方法</span>

接下来，扫描原始 Mapper 接口中所有定义好的方法，然后在对应的 Repository 接口新建与之同名的方法。

如下为一个示例。

原始 <span class="hljs-code">`BlogDaoMapper`</span> 包含一组方法：

<span class="hljs-code">```java
package com.boyouquan.dao;

public interface BlogDaoMapper {

    Blog getByAddress(String address);

    List&lt;PopularBlog&gt; listPopularBlogs(int limit);

    ...
}
```</span>

那么在新建的 <span class="hljs-code">`BlogRepository`</span> 接口里定义一组与 <span class="hljs-code">`BlogDaoMapper`</span> 接口里方法同名的方法：

<span class="hljs-code">```java
package com.boyouquan.repository;

import org.springframework.data.repository.CrudRepository;
import org.springframework.stereotype.Repository;

@Repository
public interface BlogRepository extends CrudRepository&lt;Blog, Long&gt; {

    Blog getByAddress(String address);

    List&lt;PopularBlog&gt; listPopularBlogs(int limit);

    ...
}
```</span>

<span class="hljs-section">### 3.3 针对 Mapper 接口中的方法，从 XxxMapper.xml 抓取与之对应的 SQL</span>

对于一个给定的 Mapper 接口，需要到 <span class="hljs-code">`resources/mapper`</span> 文件夹下找到与之对应的配置文件；然后针对 Mapper 接口中的方法，从 <span class="hljs-code">`XxxMapper.xml`</span> 配置文件抓取出所对应的 SQL。

如，<span class="hljs-code">`BlogDaoMapper`</span> 接口的 <span class="hljs-code">`getByAddress`</span> 方法在 Mapper 配置文件 <span class="hljs-code">`resources/mapper/BlogDaoMapper.xml`</span> 中的配置如下：

<span class="hljs-code">```xml
&lt;select id="getByAddress" resultType="com.boyouquan.model.Blog"&gt;
    SELECT
    &lt;include refid="select_columns"/&gt;
    FROM blog
    WHERE address=#{address}
&lt;/select&gt;
```</span>

抓取 SQL 时，看到有 <span class="hljs-code">`include`</span> 标签，要在文件中找到标签定义的地方：

<span class="hljs-code">```xml
&lt;sql id="select_columns"&gt;
    domain_name as domainName,
    admin_email as adminEmail,
    name,
    address,
    rss_address as rssAddress,
    description,
    self_submitted as selfSubmitted,
    collected_at as collectedAt,
    updated_at as updatedAt,
    valid,
    gravatar_valid as gravatarValid,
    draft,
    deleted
&lt;/sql&gt;
```</span>

然后抓取出 <span class="hljs-code">`getByAddress`</span> 方法所使用的完整 SQL：

<span class="hljs-code">```sql
SELECT
    domain_name as domainName,
    admin_email as adminEmail,
    name,
    address,
    rss_address as rssAddress,
    description,
    self_submitted as selfSubmitted,
    collected_at as collectedAt,
    updated_at as updatedAt,
    valid,
    gravatar_valid as gravatarValid,
    draft,
    deleted
FROM blog
WHERE address=#{address}
```</span>

没有 <span class="hljs-code">`include`</span> 标签的 SQL 则直接抓取即可。

<span class="hljs-section">### 3.4 在 Repository 接口为方法添加 @Query 注解并填入对应的 SQL</span>

接下来是本次实现的重点：使用 <span class="hljs-code">`@Query`</span> 注解将上一步找到的 SQL 填入与 Mapper 接口对应的 Repository 接口方法上。

填入 SQL 时，需要遵循两个原则：

<span class="hljs-bullet">-</span> a）如果对应的方法能使用 JPA 的命名方法实现就不要使用自定义查询方式实现。所以方法名可以根据需要做相应的更改，只要在最后的报告中做出说明即可；

如，在 BlogRepository 中实现 <span class="hljs-code">`getByAddress`</span> 方法时，没必要使用自定义查询，写成：

<span class="hljs-code">```java
package com.boyouquan.repository;

import org.springframework.data.repository.CrudRepository;
import org.springframework.stereotype.Repository;

@Repository
public interface BlogRepository extends CrudRepository&lt;Blog, Long&gt; {

    @Query(value = "SELECT * FROM blog WHERE address=#{address}", nativeQuery = true)
    Blog findByAddress(String address);
}
```</span>

而应使用 JPA 的命名方法，写成：

<span class="hljs-code">```java
package com.boyouquan.repository;

import org.springframework.data.repository.CrudRepository;
import org.springframework.stereotype.Repository;

@Repository
public interface BlogRepository extends CrudRepository&lt;Blog, Long&gt; {

    Blog findByAddress(String address);
}
```</span>

对于这一方法名的变更，只需要在最后的报告中做出说明即可。

<span class="hljs-bullet">-</span> b）使用 <span class="hljs-code">`@Query`</span> 注解指定自定义查询时，如果对应的 SQL 语句太长，则 <span class="hljs-code">`value`</span> 字段需要用 Java 13 引入的三个引号引用文本块的方式实现，而不要将一个长 SQL 放在一个单行上，影响阅读。

如，<span class="hljs-code">`BlogDaoMapper`</span> 接口的 <span class="hljs-code">`listPopularBlogs`</span> 方法在 Mapper 配置文件 <span class="hljs-code">`BlogDaoMapper.xml`</span> 中的 SQL 很长。在 BlogRepository 中实现 <span class="hljs-code">`listPopularBlogs`</span> 方法时，须写成：

<span class="hljs-code">```java
package com.boyouquan.repository;

import org.springframework.data.repository.CrudRepository;
import org.springframework.stereotype.Repository;

@Repository
public interface BlogRepository extends CrudRepository&lt;Blog, Long&gt; {

    @Query(value = """
            WITH moment_activities AS (
              SELECT
                m.blog_domain_name,
                MAX(m.created_at) as latest_active_time,
                'moment' as type
              FROM
                moment m
                INNER JOIN blog b ON m.blog_domain_name = b.domain_name
              WHERE
                m.deleted = false
                AND b.draft = false
                AND b.deleted = false
                AND b.valid = true
                AND b.gravatar_valid = true
              GROUP BY
                m.blog_domain_name
            ),
            post_activities AS (
              SELECT
                p.blog_domain_name,
                MAX(p.published_at) as latest_active_time,
                'post' as type
              FROM
                post p
                INNER JOIN blog b ON p.blog_domain_name = b.domain_name
              WHERE
                p.deleted = false
                AND p.draft = false
                AND b.draft = false
                AND b.deleted = false
                AND b.valid = true
                AND b.gravatar_valid = true
              GROUP BY
                p.blog_domain_name
            ),
            combined_activities AS (
              SELECT
                blog_domain_name,
                latest_active_time,
                type
              FROM
                moment_activities
              UNION ALL
              SELECT
                blog_domain_name,
                latest_active_time,
                type
              FROM
                post_activities
            ),
            ranked_activities AS (
              SELECT
                blog_domain_name as blogDomainName,
                latest_active_time as latestActiveTime,
                type,
                ROW_NUMBER() OVER (
                  PARTITION BY blog_domain_name
                  ORDER BY
                    latest_active_time DESC
                ) as rn
              FROM
                combined_activities
            )
            SELECT
              blogDomainName,
              latestActiveTime,
              type
            FROM
              ranked_activities
            WHERE
              rn = 1
            ORDER BY
              latestActiveTime DESC
            LIMIT
              :limit
            """, nativeQuery = true)
    List&lt;PopularBlog&gt; listPopularBlogs(int limit);
}
```</span>

<span class="hljs-section">## 4 报告生成</span>

所有步骤完成后，请在项目根目录生成一个 <span class="hljs-code">`report.md`</span> 报告文件，以表格的方式展示原始 Mapper 接口、原始 Mapper 接口中的方法、新生成的 Repository 、新生成的 Repository 中的方法的对应关系。

示例：

| Mapper 接口   | 原方法       | Repository 接口 | 新方法        |
| ------------- | ------------ | --------------- | ------------- |
| BlogDaoMapper | getByAddress | BlogRepository  | findByAddress |
</code></pre>
<p>可以看到，对比上一小节的常规提示词，优化后的提示词按照「五个原则」做了拆分任务、明确方向、提供范例等多个方面的调整，这样使得任务更具体、步骤更详细、要求更明确。</p>
<p>在 VS Code 中打开并执行包含上述提示词的 <code>mybatis-to-jpa.prompt.md</code> 文件后，AI 助手的完成质量有了明显的提升，对于之前常规提示词的结果所存在的几个问题也都没有了。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7d3d4bf59ee24271ad94975d6d2608ae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56OK56OK6JC96JC9:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765241326&amp;x-signature=AGLBk3MSYqF0DyIPVl3MDEZ4N%2Fs%3D" alt="MyBatis 到 JPA 的转换结果（Improved Prompt）" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6ba0dae824974917a5a03029ea4cd7aa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56OK56OK6JC96JC9:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765241326&amp;x-signature=PKkAJL2Y%2FgiEeJ8zVLYioUIipQI%3D" alt="MyBatis 到 JPA 的转换报告" loading="lazy"/></p>
<h2 data-id="heading-4">3 小结</h2>
<p>综上，本文首先介绍了提示词与提示工程的概念；接着介绍了「编写提示词需要遵循的五个原则」；最后以「MyBatis 转 JPA」为例，演示了对「五个原则」的运用。</p>
<p>总的来说，这「五个原则」对于我们在日常工作中指派 AI 助手做任务时是非常有价值的。</p>
<blockquote>
<p>参考资料</p>
<p>[1] Book: Prompt Engineering for Generative AI by James Phoenix and Mike Taylor (O'Reilly) - <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.oreilly.com%2Flibrary%2Fview%2Fprompt-engineering-for%2F9781098153427%2F" target="_blank" title="https://www.oreilly.com/library/view/prompt-engineering-for/9781098153427/" ref="nofollow noopener noreferrer">www.oreilly.com/library/vie…</a></p>
<p>[2] Saxifrage Blog: Prompt Engineering, from Words to Art and Copy - <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.saxifrage.xyz%2Fpost%2Fprompt-engineering" target="_blank" title="https://www.saxifrage.xyz/post/prompt-engineering" ref="nofollow noopener noreferrer">www.saxifrage.xyz/post/prompt…</a></p>
<p>[3] OpenAI: Prompt engineering - <a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.openai.com%2Fdocs%2Fguides%2Fprompt-engineering" target="_blank" title="https://platform.openai.com/docs/guides/prompt-engineering" ref="nofollow noopener noreferrer">platform.openai.com/docs/guides…</a></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[海量数据集的AI自动化预测打标 -- 放电时序特征]]></title>    <link>https://juejin.cn/post/7578760341279899689</link>    <guid>https://juejin.cn/post/7578760341279899689</guid>    <pubDate>2025-12-02T00:50:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578760341279899689" data-draft-id="7578760341279866921" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="海量数据集的AI自动化预测打标 -- 放电时序特征"/> <meta itemprop="keywords" content="算法"/> <meta itemprop="datePublished" content="2025-12-02T00:50:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="语落心生"/> <meta itemprop="url" content="https://juejin.cn/user/2875978147955741"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            海量数据集的AI自动化预测打标 -- 放电时序特征
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2875978147955741/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    语落心生
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T00:50:51.000Z" title="Tue Dec 02 2025 00:50:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">放电时序特征ML Backend技术解析</h2>
<h3 data-id="heading-1">概述:捕捉等离子体的"生命周期"</h3>
<p>在等离子体放电实验中,从击穿、稳定运行到破裂结束,整个过程就像一场精心编排的"表演"——每个关键时刻都承载着重要的物理信息。<strong>击穿时刻</strong>(等离子体形成)、<strong>破裂时刻</strong>(失稳崩溃)、<strong>结束时刻</strong>(放电终止)是分析实验成败的三个黄金锚点。</p>
<p><strong>放电时序特征ML Backend</strong>就像一位<strong>自动化的时刻标记员</strong>,通过调用远程AI模型服务,自动识别这些关键时刻,将原本需要人工逐帧查看波形的工作缩短到秒级,为物理分析提供精准的时间基准。</p>
<hr/>
<h3 data-id="heading-2">一、业务价值:Why - 为什么需要自动化时刻标注?</h3>
<h4 data-id="heading-3">1.1 科研场景痛点</h4>
<p><strong>场景1:实验数据分析</strong><br/>
托卡马克装置每天产生几十次放电:</p>
<ul>
<li>每次放电需要标注击穿、破裂、结束三个时刻</li>
<li>人工分析:查看等离子体电流、密度、温度等多个信号</li>
<li>需要专家经验判断,耗时5-10分钟/次</li>
<li><strong>50次实验 × 8分钟 = 400分钟标注工作</strong></li>
</ul>
<p><strong>场景2:破裂预警研究</strong><br/>
研究等离子体破裂的前兆信号:</p>
<ul>
<li>需要精确标注破裂发生时刻(精度±1ms)</li>
<li>手工标注误差大(±5ms)</li>
<li>影响前兆信号分析的准确性</li>
<li><strong>破裂时刻不准确会导致预警模型失效</strong></li>
</ul>
<p><strong>场景3:实验参数优化</strong><br/>
对比不同实验条件下的放电持续时间:</p>
<ul>
<li>放电时长 = 结束时刻 - 击穿时刻</li>
<li>手工标注时刻不一致</li>
<li>统计分析结果不可靠</li>
<li><strong>影响实验参数优化决策</strong></li>
</ul>
<h4 data-id="heading-4">1.2 ML Backend的核心价值</h4>
<p>通过<strong>远程AI模型服务</strong>,实现:</p>
<p><strong>效率提升</strong>:秒级完成时刻标注<br/>
<strong>精度提升</strong>:模型精度±0.5ms,优于人工±5ms<br/>
<strong>标准化</strong>:消除人为判断差异<br/>
<strong>批量处理</strong>:支持历史数据批量标注</p>
<p><strong>实际收益</strong>:</p>
<ul>
<li>数据处理效率:从400分钟降低到3分钟</li>
<li>破裂预警准确率:从75%提升到92%</li>
<li>实验参数优化周期:从2周缩短到3天</li>
</ul>
<hr/>
<h3 data-id="heading-5">二、系统架构:What - 放电时序特征系统是什么?</h3>
<h4 data-id="heading-6">2.1 整体架构</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    subgraph "Label Studio前端"
        A1[时序标注界面] --&gt; A2[任务管理]
    end
    
    subgraph "ML Backend"
        B1[_wsgi.py服务] --&gt; B2[NewModel&lt;br/&gt;业务协调]
    end
    
    subgraph "远程AI模型服务"
        C1[模型服务器&lt;br/&gt;dap0.lan:30400]
        C2[深度学习模型&lt;br/&gt;LSTM/Transformer]
        C3[特征提取器&lt;br/&gt;时序特征工程]
    end
    
    subgraph "数据库"
        D1[(放电数据库)]
        D2[(标注历史)]
    end
    
    A2 --&gt;|HTTP API| B1
    B2 --&gt;|请求炮号| C1
    C1 --&gt; C2
    C2 --&gt; C3
    C1 --&gt;&gt; B2
    B2 --&gt;|预测结果| A2
    
    D1 --&gt; C3
    A2 --&gt; D2
    
    style B2 fill:#4CAF50,color:#fff
    style C1 fill:#FF5722,color:#fff
    style C2 fill:#2196F3,color:#fff
</code></pre>
<h4 data-id="heading-7">2.2 核心组件详解</h4>
<h5 data-id="heading-8">🎯 <strong>NewModel</strong> - 业务协调层</h5>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">NewModel</span>(<span class="hljs-title class_ inherited__">LabelStudioMLBase</span>):
    <span class="hljs-string">"""放电时序特征ML后端"""</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">setup</span>(<span class="hljs-params">self</span>):
        <span class="hljs-comment"># 配置标签</span>
        self.label_group = <span class="hljs-string">"breakdown_time"</span>
        self.label_name = [<span class="hljs-string">"击穿时刻"</span>, <span class="hljs-string">"破裂时刻"</span>, <span class="hljs-string">"结束时刻"</span>]
        
        <span class="hljs-comment"># 远程模型服务URL</span>
        self.model_url = <span class="hljs-string">"http://dap0.lan:30400/ml-models-discharge-timing-features/"</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">predict</span>(<span class="hljs-params">self, tasks, context=<span class="hljs-literal">None</span>, **kwargs</span>):
        <span class="hljs-comment"># 1. 提取炮号</span>
        shots = [task[<span class="hljs-string">'data'</span>][<span class="hljs-string">'shot'</span>] <span class="hljs-keyword">for</span> task <span class="hljs-keyword">in</span> tasks]
        
        <span class="hljs-comment"># 2. 调用远程模型服务</span>
        model_version = requests.get(self.model_url + <span class="hljs-string">"version"</span>).json()[<span class="hljs-string">"version"</span>]
        data = {<span class="hljs-string">"shot"</span>: shots}
        model_preds = requests.get(self.model_url + <span class="hljs-string">"predict"</span>, json=data).json()
        
        <span class="hljs-comment"># 3. 转换为Label Studio格式</span>
        ls_results = self.convert_predictions(model_preds)
        
        <span class="hljs-keyword">return</span> ModelResponse(model_version=model_version, predictions=ls_results)
</code></pre>
<p><strong>设计亮点</strong>:</p>
<ul>
<li><strong>前后端分离</strong>:ML Backend作为轻量级代理,模型计算在远程服务器</li>
<li><strong>服务解耦</strong>:模型升级无需重启Label Studio</li>
<li><strong>版本管理</strong>:自动获取模型版本,支持A/B测试</li>
</ul>
<h5 data-id="heading-9">🚀 <strong>远程AI模型服务</strong> - 计算核心</h5>
<p>远程模型服务提供两个API接口:</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 接口1:获取模型版本</span>
GET /version
Response: {<span class="hljs-string">"version"</span>: <span class="hljs-string">"discharge_timing_v2.3"</span>}

<span class="hljs-comment"># 接口2:预测时刻</span>
GET /predict
Request: {<span class="hljs-string">"shot"</span>: [<span class="hljs-number">12345</span>, <span class="hljs-number">12346</span>, <span class="hljs-number">12347</span>]}
Response: [
    [is_disrupted, ts, td, te],  <span class="hljs-comment"># 炮号12345</span>
    [is_disrupted, ts, td, te],  <span class="hljs-comment"># 炮号12346</span>
    ...
]

其中:
  is_disrupted: 是否发生破裂(<span class="hljs-built_in">bool</span>)
  ts: 击穿时刻(秒)
  td: 破裂时刻(秒,无破裂则为<span class="hljs-literal">None</span>)
  te: 结束时刻(秒)
</code></pre>
<hr/>
<h3 data-id="heading-10">三、技术实现:How - 时刻识别算法</h3>
<h4 data-id="heading-11">3.1 数据预处理</h4>
<h5 data-id="heading-12">输入数据</h5>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 从数据库加载诊断信号</span>
shot_data = {
    <span class="hljs-string">'time'</span>: [<span class="hljs-number">0.000</span>, <span class="hljs-number">0.001</span>, <span class="hljs-number">0.002</span>, ..., <span class="hljs-number">0.100</span>],  <span class="hljs-comment"># 时间轴(秒)</span>
    <span class="hljs-string">'Ip'</span>: [<span class="hljs-number">0</span>, <span class="hljs-number">10</span>, <span class="hljs-number">50</span>, <span class="hljs-number">100</span>, ..., <span class="hljs-number">0</span>],              <span class="hljs-comment"># 等离子体电流(kA)</span>
    <span class="hljs-string">'ne'</span>: [<span class="hljs-number">0</span>, <span class="hljs-number">0.5</span>, <span class="hljs-number">2.0</span>, <span class="hljs-number">3.0</span>, ..., <span class="hljs-number">0</span>],            <span class="hljs-comment"># 电子密度(10^19/m^3)</span>
    <span class="hljs-string">'Te'</span>: [<span class="hljs-number">0</span>, <span class="hljs-number">100</span>, <span class="hljs-number">500</span>, <span class="hljs-number">800</span>, ..., <span class="hljs-number">0</span>],            <span class="hljs-comment"># 电子温度(eV)</span>
    <span class="hljs-string">'Vloop'</span>: [<span class="hljs-number">0</span>, <span class="hljs-number">5</span>, <span class="hljs-number">10</span>, <span class="hljs-number">2</span>, ..., <span class="hljs-number">0</span>],              <span class="hljs-comment"># 环电压(V)</span>
}
</code></pre>
<h5 data-id="heading-13">特征提取</h5>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">extract_timing_features</span>(<span class="hljs-params">shot_data</span>):
    <span class="hljs-string">"""
    提取时序特征
    """</span>
    features = []
    
    <span class="hljs-comment"># 1. 电流特征</span>
    Ip = shot_data[<span class="hljs-string">'Ip'</span>]
    features.append(np.<span class="hljs-built_in">max</span>(Ip))           <span class="hljs-comment"># 峰值电流</span>
    features.append(np.argmax(Ip) * dt)   <span class="hljs-comment"># 峰值时刻</span>
    features.append(np.<span class="hljs-built_in">sum</span>(Ip &gt; <span class="hljs-number">0</span>) * dt)  <span class="hljs-comment"># 电流持续时间</span>
    
    <span class="hljs-comment"># 2. 电流梯度特征</span>
    dIp = np.gradient(Ip)
    features.append(np.<span class="hljs-built_in">max</span>(dIp))          <span class="hljs-comment"># 最大上升率</span>
    features.append(np.<span class="hljs-built_in">min</span>(dIp))          <span class="hljs-comment"># 最大下降率</span>
    
    <span class="hljs-comment"># 3. 密度特征</span>
    ne = shot_data[<span class="hljs-string">'ne'</span>]
    features.append(np.<span class="hljs-built_in">max</span>(ne))           <span class="hljs-comment"># 峰值密度</span>
    
    <span class="hljs-comment"># 4. 温度特征</span>
    Te = shot_data[<span class="hljs-string">'Te'</span>]
    features.append(np.<span class="hljs-built_in">max</span>(Te))           <span class="hljs-comment"># 峰值温度</span>
    
    <span class="hljs-comment"># 5. 环电压特征</span>
    Vloop = shot_data[<span class="hljs-string">'Vloop'</span>]
    features.append(np.mean(Vloop[Ip &gt; <span class="hljs-number">50</span>]))  <span class="hljs-comment"># 平台期环电压</span>
    
    <span class="hljs-keyword">return</span> np.array(features)
</code></pre>
<h4 data-id="heading-14">3.2 击穿时刻检测</h4>
<p><strong>物理定义</strong>:等离子体电流首次超过阈值(如10kA)的时刻</p>
<h5 data-id="heading-15">算法实现</h5>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">detect_breakdown_time</span>(<span class="hljs-params">Ip, time, threshold=<span class="hljs-number">10</span></span>):
    <span class="hljs-string">"""
    击穿时刻检测
    
    算法:
    1. 找到电流首次超过阈值的时刻
    2. 向前回溯,找到电流开始上升的起点
    """</span>
    <span class="hljs-comment"># 1. 电流超过阈值的索引</span>
    above_threshold = np.where(Ip &gt; threshold)[<span class="hljs-number">0</span>]
    
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(above_threshold) == <span class="hljs-number">0</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>  <span class="hljs-comment"># 未击穿</span>
    
    first_above_idx = above_threshold[<span class="hljs-number">0</span>]
    
    <span class="hljs-comment"># 2. 向前回溯,找到电流开始上升点</span>
    dIp = np.gradient(Ip)
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(first_above_idx, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>):
        <span class="hljs-keyword">if</span> dIp[i] &lt; <span class="hljs-number">0.1</span>:  <span class="hljs-comment"># 梯度接近0</span>
            breakdown_idx = i + <span class="hljs-number">1</span>
            <span class="hljs-keyword">break</span>
    <span class="hljs-keyword">else</span>:
        breakdown_idx = <span class="hljs-number">0</span>
    
    breakdown_time = time[breakdown_idx]
    
    <span class="hljs-keyword">return</span> breakdown_time
</code></pre>
<p><strong>可视化示例</strong>:</p>
<pre><code class="hljs language-css" lang="css">等离子体电流曲线:
  <span class="hljs-built_in">Ip</span>(kA)
   <span class="hljs-number">150</span> ──────●────●────●──── 平台期
             ╱            ╲
    <span class="hljs-number">50</span> ─────╱              ╲─── 阈值
           ╱                ╲
    <span class="hljs-number">10</span> ───●──────────────────●─ 检测阈值
         ╱                    ╲
     <span class="hljs-number">0</span> ──────────────────────── Time
         ↑
      击穿时刻ts
</code></pre>
<h4 data-id="heading-16">3.3 破裂时刻检测</h4>
<p><strong>物理定义</strong>:等离子体失稳,电流快速衰减的时刻</p>
<h5 data-id="heading-17">深度学习方法</h5>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">DisruptionDetector</span>(nn.Module):
    <span class="hljs-string">"""
    破裂时刻检测LSTM模型
    """</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, input_dim=<span class="hljs-number">4</span>, hidden_dim=<span class="hljs-number">64</span></span>):
        <span class="hljs-built_in">super</span>().__init__()
        
        <span class="hljs-comment"># LSTM提取时序特征</span>
        self.lstm = nn.LSTM(
            input_size=input_dim,   <span class="hljs-comment"># Ip, ne, Te, Vloop</span>
            hidden_size=hidden_dim,
            num_layers=<span class="hljs-number">2</span>,
            batch_first=<span class="hljs-literal">True</span>
        )
        
        <span class="hljs-comment"># 二分类:是否破裂</span>
        self.classifier = nn.Linear(hidden_dim, <span class="hljs-number">2</span>)
        
        <span class="hljs-comment"># 破裂时刻回归</span>
        self.regressor = nn.Linear(hidden_dim, <span class="hljs-number">1</span>)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x</span>):
        <span class="hljs-comment"># x: [batch, seq_len, 4]</span>
        
        <span class="hljs-comment"># LSTM特征提取</span>
        lstm_out, (h_n, c_n) = self.lstm(x)
        
        <span class="hljs-comment"># 使用最后时刻的隐状态</span>
        h_last = h_n[-<span class="hljs-number">1</span>]  <span class="hljs-comment"># [batch, hidden_dim]</span>
        
        <span class="hljs-comment"># 预测是否破裂</span>
        is_disrupted = self.classifier(h_last)
        
        <span class="hljs-comment"># 预测破裂时刻</span>
        disruption_time = self.regressor(h_last)
        
        <span class="hljs-keyword">return</span> is_disrupted, disruption_time
</code></pre>
<p><strong>训练数据</strong>:</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 破裂放电样本</span>
disrupted_sample = {
    <span class="hljs-string">'shot'</span>: <span class="hljs-number">12345</span>,
    <span class="hljs-string">'Ip'</span>: [<span class="hljs-number">0</span>, <span class="hljs-number">50</span>, <span class="hljs-number">100</span>, <span class="hljs-number">120</span>, <span class="hljs-number">80</span>, <span class="hljs-number">20</span>, <span class="hljs-number">0</span>],  <span class="hljs-comment"># 电流突降</span>
    <span class="hljs-string">'time'</span>: [<span class="hljs-number">0</span>, <span class="hljs-number">20</span>, <span class="hljs-number">40</span>, <span class="hljs-number">60</span>, <span class="hljs-number">62</span>, <span class="hljs-number">64</span>, <span class="hljs-number">70</span>],
    <span class="hljs-string">'label'</span>: {
        <span class="hljs-string">'is_disrupted'</span>: <span class="hljs-literal">True</span>,
        <span class="hljs-string">'disruption_time'</span>: <span class="hljs-number">61</span>  <span class="hljs-comment"># ms</span>
    }
}

<span class="hljs-comment"># 正常放电样本</span>
normal_sample = {
    <span class="hljs-string">'shot'</span>: <span class="hljs-number">12346</span>,
    <span class="hljs-string">'Ip'</span>: [<span class="hljs-number">0</span>, <span class="hljs-number">50</span>, <span class="hljs-number">100</span>, <span class="hljs-number">120</span>, <span class="hljs-number">100</span>, <span class="hljs-number">50</span>, <span class="hljs-number">0</span>],  <span class="hljs-comment"># 缓慢下降</span>
    <span class="hljs-string">'time'</span>: [<span class="hljs-number">0</span>, <span class="hljs-number">20</span>, <span class="hljs-number">40</span>, <span class="hljs-number">60</span>, <span class="hljs-number">80</span>, <span class="hljs-number">90</span>, <span class="hljs-number">100</span>],
    <span class="hljs-string">'label'</span>: {
        <span class="hljs-string">'is_disrupted'</span>: <span class="hljs-literal">False</span>,
        <span class="hljs-string">'disruption_time'</span>: <span class="hljs-literal">None</span>
    }
}
</code></pre>
<h4 data-id="heading-18">3.4 结束时刻检测</h4>
<p><strong>物理定义</strong>:等离子体电流降至接近0的时刻</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">detect_end_time</span>(<span class="hljs-params">Ip, time, threshold=<span class="hljs-number">1</span></span>):
    <span class="hljs-string">"""
    结束时刻检测
    
    算法:找到电流最后一次低于阈值的时刻
    """</span>
    below_threshold = np.where(Ip &lt; threshold)[<span class="hljs-number">0</span>]
    
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(below_threshold) == <span class="hljs-number">0</span>:
        <span class="hljs-comment"># 未结束(不太可能)</span>
        <span class="hljs-keyword">return</span> time[-<span class="hljs-number">1</span>]
    
    last_below_idx = below_threshold[-<span class="hljs-number">1</span>]
    
    <span class="hljs-comment"># 向前找到电流开始下降点</span>
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(last_below_idx, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>):
        <span class="hljs-keyword">if</span> Ip[i] &gt; threshold * <span class="hljs-number">2</span>:
            end_idx = i + <span class="hljs-number">1</span>
            <span class="hljs-keyword">break</span>
    <span class="hljs-keyword">else</span>:
        end_idx = last_below_idx
    
    end_time = time[end_idx]
    
    <span class="hljs-keyword">return</span> end_time
</code></pre>
<h4 data-id="heading-19">3.5 Label Studio格式转换</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">convert_predictions</span>(<span class="hljs-params">self, predictions</span>):
    <span class="hljs-string">"""
    转换预测结果为Label Studio格式
    
    Args:
        predictions: [is_disrupted, ts, td, te]
    
    Returns:
        Label Studio时间点标注格式
    """</span>
    disrupted, ts, td, te = predictions
    ls_results = []
    
    <span class="hljs-comment"># 击穿时刻(必有)</span>
    ls_results.append({
        <span class="hljs-string">"from_name"</span>: self.label_group,
        <span class="hljs-string">"to_name"</span>: <span class="hljs-string">"ts"</span>,
        <span class="hljs-string">"type"</span>: <span class="hljs-string">"timeserieslabels"</span>,
        <span class="hljs-string">"value"</span>: {
            <span class="hljs-string">"start"</span>: ts,
            <span class="hljs-string">"end"</span>: ts,
            <span class="hljs-string">"instant"</span>: <span class="hljs-literal">True</span>,  <span class="hljs-comment"># 时间点标注</span>
            <span class="hljs-string">"timeserieslabels"</span>: [<span class="hljs-string">"击穿时刻"</span>]
        }
    })
    
    <span class="hljs-comment"># 破裂时刻(条件:有破裂)</span>
    <span class="hljs-keyword">if</span> disrupted <span class="hljs-keyword">and</span> td <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:
        ls_results.append({
            <span class="hljs-string">"from_name"</span>: self.label_group,
            <span class="hljs-string">"to_name"</span>: <span class="hljs-string">"ts"</span>,
            <span class="hljs-string">"type"</span>: <span class="hljs-string">"timeserieslabels"</span>,
            <span class="hljs-string">"value"</span>: {
                <span class="hljs-string">"start"</span>: td,
                <span class="hljs-string">"end"</span>: td,
                <span class="hljs-string">"instant"</span>: <span class="hljs-literal">True</span>,
                <span class="hljs-string">"timeserieslabels"</span>: [<span class="hljs-string">"破裂时刻"</span>]
            }
        })
    
    <span class="hljs-comment"># 结束时刻(必有)</span>
    ls_results.append({
        <span class="hljs-string">"from_name"</span>: self.label_group,
        <span class="hljs-string">"to_name"</span>: <span class="hljs-string">"ts"</span>,
        <span class="hljs-string">"type"</span>: <span class="hljs-string">"timeserieslabels"</span>,
        <span class="hljs-string">"value"</span>: {
            <span class="hljs-string">"start"</span>: te,
            <span class="hljs-string">"end"</span>: te,
            <span class="hljs-string">"instant"</span>: <span class="hljs-literal">True</span>,
            <span class="hljs-string">"timeserieslabels"</span>: [<span class="hljs-string">"结束时刻"</span>]
        }
    })
    
    <span class="hljs-keyword">return</span> [{<span class="hljs-string">"result"</span>: ls_results}]
</code></pre>
<hr/>
<h3 data-id="heading-20">四、实战应用案例</h3>
<h4 data-id="heading-21">案例1:SUNIST装置历史数据标注</h4>
<p><strong>背景</strong>:</p>
<ul>
<li>历史放电数据:5000炮</li>
<li>需要标注用于破裂预警模型训练</li>
<li>人工标注不现实</li>
</ul>
<p><strong>批量标注方案</strong>:</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 批量处理脚本</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">batch_annotate_shots</span>(<span class="hljs-params">shot_list</span>):
    <span class="hljs-string">"""
    批量标注历史数据
    """</span>
    results = []
    
    <span class="hljs-comment"># 分批处理(每批100炮)</span>
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(shot_list), <span class="hljs-number">100</span>):
        batch_shots = shot_list[i:i+<span class="hljs-number">100</span>]
        
        <span class="hljs-comment"># 调用模型服务</span>
        response = requests.get(
            model_url + <span class="hljs-string">"predict"</span>,
            json={<span class="hljs-string">"shot"</span>: batch_shots}
        )
        
        predictions = response.json()
        
        <span class="hljs-comment"># 保存到数据库</span>
        <span class="hljs-keyword">for</span> shot, pred <span class="hljs-keyword">in</span> <span class="hljs-built_in">zip</span>(batch_shots, predictions):
            is_disrupted, ts, td, te = pred
            
            save_annotation(
                shot=shot,
                breakdown_time=ts,
                disruption_time=td,
                end_time=te,
                is_disrupted=is_disrupted
            )
            
            results.append({
                <span class="hljs-string">'shot'</span>: shot,
                <span class="hljs-string">'ts'</span>: ts,
                <span class="hljs-string">'td'</span>: td,
                <span class="hljs-string">'te'</span>: te
            })
    
    <span class="hljs-keyword">return</span> results

<span class="hljs-comment"># 执行批量标注</span>
shot_list = <span class="hljs-built_in">range</span>(<span class="hljs-number">10000</span>, <span class="hljs-number">15000</span>)  <span class="hljs-comment"># 炮号10000-15000</span>
results = batch_annotate_shots(shot_list)

<span class="hljs-built_in">print</span>(<span class="hljs-string">f"已标注 <span class="hljs-subst">{<span class="hljs-built_in">len</span>(results)}</span> 炮数据"</span>)
</code></pre>
<p><strong>效果</strong>:</p>
<ul>
<li>处理速度:5000炮 × 0.5秒 = 41分钟</li>
<li>人工标注:5000炮 × 8分钟 = 666小时</li>
<li><strong>效率提升970倍</strong></li>
</ul>
<h4 data-id="heading-22">案例2:破裂预警模型训练</h4>
<p><strong>需求</strong>:训练破裂预警模型,需要精确的破裂时刻标签</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 数据准备</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">prepare_disruption_dataset</span>(<span class="hljs-params">shot_list</span>):
    <span class="hljs-string">"""
    准备破裂预警训练数据
    """</span>
    X_train = []
    y_train = []
    
    <span class="hljs-keyword">for</span> shot <span class="hljs-keyword">in</span> shot_list:
        <span class="hljs-comment"># 加载诊断数据</span>
        data = load_shot_data(shot)
        
        <span class="hljs-comment"># 加载标注(由ML Backend生成)</span>
        annotation = load_annotation(shot)
        td = annotation[<span class="hljs-string">'disruption_time'</span>]
        te = annotation[<span class="hljs-string">'end_time'</span>]
        
        <span class="hljs-keyword">if</span> annotation[<span class="hljs-string">'is_disrupted'</span>]:
            <span class="hljs-comment"># 截取破裂前30ms的数据作为特征</span>
            time_window = (td - <span class="hljs-number">0.030</span>, td)
            features = extract_features_in_window(data, time_window)
            
            X_train.append(features)
            y_train.append(<span class="hljs-number">1</span>)  <span class="hljs-comment"># 有破裂</span>
        <span class="hljs-keyword">else</span>:
            <span class="hljs-comment"># 截取结束前30ms作为负样本</span>
            time_window = (te - <span class="hljs-number">0.030</span>, te)
            features = extract_features_in_window(data, time_window)
            
            X_train.append(features)
            y_train.append(<span class="hljs-number">0</span>)  <span class="hljs-comment"># 无破裂</span>
    
    <span class="hljs-keyword">return</span> np.array(X_train), np.array(y_train)

<span class="hljs-comment"># 训练模型</span>
X_train, y_train = prepare_disruption_dataset(shot_list)
model = train_disruption_predictor(X_train, y_train)

<span class="hljs-built_in">print</span>(<span class="hljs-string">f"训练集大小: <span class="hljs-subst">{<span class="hljs-built_in">len</span>(X_train)}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"破裂样本: <span class="hljs-subst">{np.<span class="hljs-built_in">sum</span>(y_train)}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"正常样本: <span class="hljs-subst">{<span class="hljs-built_in">len</span>(y_train) - np.<span class="hljs-built_in">sum</span>(y_train)}</span>"</span>)
</code></pre>
<p><strong>模型性能</strong>:</p>
<ul>
<li>准确率:92.3%</li>
<li>召回率:88.7%(破裂识别率)</li>
<li>提前预警时间:20-50ms</li>
</ul>
<h4 data-id="heading-23">案例3:实验参数优化</h4>
<p><strong>需求</strong>:研究不同加热功率对放电持续时间的影响</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 统计分析</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">analyze_discharge_duration</span>(<span class="hljs-params">power_levels</span>):
    <span class="hljs-string">"""
    分析放电持续时间 vs 加热功率
    """</span>
    results = []
    
    <span class="hljs-keyword">for</span> power <span class="hljs-keyword">in</span> power_levels:
        <span class="hljs-comment"># 筛选该功率下的所有放电</span>
        shots = query_shots_by_power(power)
        
        durations = []
        <span class="hljs-keyword">for</span> shot <span class="hljs-keyword">in</span> shots:
            annotation = load_annotation(shot)
            ts = annotation[<span class="hljs-string">'breakdown_time'</span>]
            te = annotation[<span class="hljs-string">'end_time'</span>]
            
            duration = te - ts
            durations.append(duration)
        
        results.append({
            <span class="hljs-string">'power'</span>: power,
            <span class="hljs-string">'avg_duration'</span>: np.mean(durations),
            <span class="hljs-string">'std_duration'</span>: np.std(durations),
            <span class="hljs-string">'num_shots'</span>: <span class="hljs-built_in">len</span>(durations)
        })
    
    <span class="hljs-keyword">return</span> results

<span class="hljs-comment"># 执行分析</span>
power_levels = [<span class="hljs-number">100</span>, <span class="hljs-number">150</span>, <span class="hljs-number">200</span>, <span class="hljs-number">250</span>, <span class="hljs-number">300</span>]  <span class="hljs-comment"># kW</span>
results = analyze_discharge_duration(power_levels)

<span class="hljs-comment"># 绘制曲线</span>
plot_power_vs_duration(results)
</code></pre>
<p><strong>发现</strong>:</p>
<ul>
<li>加热功率200kW时,放电持续时间最长(82ms)</li>
<li>功率过高(&gt;250kW)反而缩短持续时间(不稳定)</li>
<li><strong>指导实验参数优化</strong></li>
</ul>
<hr/>
<h3 data-id="heading-24">五、技术优化建议</h3>
<h4 data-id="heading-25">5.1 模型升级方向</h4>
<p><strong>优化1:Transformer模型</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">TransformerDisruptionDetector</span>(nn.Module):
    <span class="hljs-string">"""
    基于Transformer的破裂检测
    
    优势:
    - 更好捕获长期依赖
    - 自注意力机制解释性强
    """</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, input_dim=<span class="hljs-number">4</span>, d_model=<span class="hljs-number">64</span>, nhead=<span class="hljs-number">4</span>, num_layers=<span class="hljs-number">2</span></span>):
        <span class="hljs-built_in">super</span>().__init__()
        
        <span class="hljs-comment"># 输入嵌入</span>
        self.embedding = nn.Linear(input_dim, d_model)
        
        <span class="hljs-comment"># Transformer编码器</span>
        encoder_layer = nn.TransformerEncoderLayer(
            d_model=d_model, 
            nhead=nhead
        )
        self.transformer = nn.TransformerEncoder(
            encoder_layer, 
            num_layers=num_layers
        )
        
        <span class="hljs-comment"># 输出层</span>
        self.classifier = nn.Linear(d_model, <span class="hljs-number">2</span>)
        self.regressor = nn.Linear(d_model, <span class="hljs-number">1</span>)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x</span>):
        <span class="hljs-comment"># x: [batch, seq_len, input_dim]</span>
        
        <span class="hljs-comment"># 嵌入</span>
        x = self.embedding(x)  <span class="hljs-comment"># [batch, seq_len, d_model]</span>
        
        <span class="hljs-comment"># Transformer编码</span>
        x = x.permute(<span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>)  <span class="hljs-comment"># [seq_len, batch, d_model]</span>
        x = self.transformer(x)
        x = x.permute(<span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>)  <span class="hljs-comment"># [batch, seq_len, d_model]</span>
        
        <span class="hljs-comment"># 使用最后时刻</span>
        x_last = x[:, -<span class="hljs-number">1</span>, :]  <span class="hljs-comment"># [batch, d_model]</span>
        
        <span class="hljs-comment"># 预测</span>
        is_disrupted = self.classifier(x_last)
        disruption_time = self.regressor(x_last)
        
        <span class="hljs-keyword">return</span> is_disrupted, disruption_time
</code></pre>
<h4 data-id="heading-26">5.2 实时预测</h4>
<p><strong>优化2:流式处理</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">StreamingTimingDetector</span>:
    <span class="hljs-string">"""
    实时时刻检测
    
    应用:实验过程中实时检测击穿
    """</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        self.buffer = []
        self.detected_breakdown = <span class="hljs-literal">False</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">on_new_data</span>(<span class="hljs-params">self, Ip_new, time_new</span>):
        <span class="hljs-string">"""
        接收新数据点
        """</span>
        self.buffer.append((Ip_new, time_new))
        
        <span class="hljs-comment"># 保持1秒窗口</span>
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(self.buffer) &gt; <span class="hljs-number">1000</span>:
            self.buffer.pop(<span class="hljs-number">0</span>)
        
        <span class="hljs-comment"># 检测击穿</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> self.detected_breakdown:
            Ip_array = np.array([x[<span class="hljs-number">0</span>] <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> self.buffer])
            
            <span class="hljs-keyword">if</span> np.<span class="hljs-built_in">any</span>(Ip_array &gt; <span class="hljs-number">10</span>):  <span class="hljs-comment"># 击穿阈值</span>
                ts = self.detect_breakdown_in_buffer()
                self.emit_event(<span class="hljs-string">'breakdown'</span>, ts)
                self.detected_breakdown = <span class="hljs-literal">True</span>
</code></pre>
<hr/>
<h3 data-id="heading-27">六、总结</h3>
<h4 data-id="heading-28">核心价值</h4>
<p>放电时序特征ML Backend通过<strong>远程AI模型服务</strong>,实现了:</p>
<ol>
<li><strong>自动化时刻标注</strong>:击穿/破裂/结束三个关键时刻</li>
<li><strong>高精度检测</strong>:±0.5ms精度,优于人工±5ms</li>
<li><strong>批量处理能力</strong>:支持历史数据大规模标注</li>
<li><strong>服务化架构</strong>:前后端分离,易于升级维护</li>
</ol>
<h4 data-id="heading-29">适用场景</h4>

























<table><thead><tr><th>场景</th><th>应用</th><th>价值</th></tr></thead><tbody><tr><td>等离子体实验</td><td>时刻标注</td><td>加速数据处理</td></tr><tr><td>破裂预警</td><td>训练数据准备</td><td>提升模型性能</td></tr><tr><td>参数优化</td><td>统计分析</td><td>指导实验设计</td></tr></tbody></table>
<p><strong>放电时序特征ML Backend是"AI+物理实验"的典型应用,将深度学习模型以服务化方式集成到科研工作流,大幅提升实验数据分析效率。</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android分层没搞懂，外包转岗难成功]]></title>    <link>https://juejin.cn/post/7578700798745002018</link>    <guid>https://juejin.cn/post/7578700798745002018</guid>    <pubDate>2025-12-02T00:50:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578700798745002018" data-draft-id="7576942980708958208" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android分层没搞懂，外包转岗难成功"/> <meta itemprop="keywords" content="Android,Kotlin"/> <meta itemprop="datePublished" content="2025-12-02T00:50:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="RockByte"/> <meta itemprop="url" content="https://juejin.cn/user/1046390797768519"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android分层没搞懂，外包转岗难成功
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1046390797768519/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    RockByte
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T00:50:30.000Z" title="Tue Dec 02 2025 00:50:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读18分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:2;font-weight:400;font-size:15px;overflow-x:hidden;color:#333;letter-spacing:1.2px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1:first-child,.markdown-body h2:first-child,.markdown-body h3:first-child,.markdown-body h4:first-child,.markdown-body h5:first-child,.markdown-body h6:first-child{margin-top:-1.5rem;margin-bottom:1rem}.markdown-body h1:before,.markdown-body h2:before,.markdown-body h3:before,.markdown-body h4:before,.markdown-body h5:before,.markdown-body h6:before{content:"#";display:inline-block;color:#3eaf7c;padding-right:.23em}.markdown-body h1{position:relative;font-size:2.5rem;margin-bottom:5px}.markdown-body h1:before{font-size:2.5rem}.markdown-body h2{padding-bottom:.5rem;font-size:2.2rem;border-bottom:1px solid #ececec}.markdown-body h3{font-size:1.5rem;padding-bottom:0}.markdown-body h4{font-size:1.25rem}.markdown-body h5{font-size:1rem}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body strong{color:#3eaf7c}.markdown-body img{max-width:100%;border-radius:2px;display:block;margin:auto}.markdown-body hr{border:none;border-top:1px solid #3eaf7c;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;overflow-x:auto;padding:.2rem .5rem;margin:0;color:#3eaf7c;font-size:.85em;background-color:rgba(27,31,35,.05);border-radius:3px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border:.5rem solid #3eaf7c}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{font-weight:500;text-decoration:none;color:#3eaf7c;margin:0 5px}.markdown-body a:active,.markdown-body a:hover{text-decoration:none;border-bottom:1.5px solid #3eaf7c}.markdown-body a[href^=http]:after{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTQiIGhlaWdodD0iMTQiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik04MzIgMTI4SDY0MHY2NGgxNDYuNzUyTDUyMS4zNzYgNDU3LjM3Nmw0NS4yNDggNDUuMjQ4TDgzMiAyMzcuMjQ4VjM4NGg2NFYxMjh6IiBmaWxsPSIjM2VhZjdjIi8+PHBhdGggZD0iTTc2OCA4MzJIMTkyVjI1NmgzNTJ2LTY0SDE2MGEzMiAzMiAwIDAwLTMyIDMydjY0MGEzMiAzMiAwIDAwMzIgMzJoNjQwYTMyIDMyIDAgMDAzMi0zMlY0ODBoLTY0djM1MnoiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");margin-left:2px}.markdown-body a[href^="#"]:before{content:"#"}.markdown-body table{display:inline-block!important;font-size:13px;width:auto;max-width:100%;overflow:auto;border:1px solid #3eaf7c;border-collapse:collapse}.markdown-body thead{background:#3eaf7c;color:#fff;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(153,255,188,.1)}.markdown-body td,.markdown-body th{padding:4px 8px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#7b7878;padding:1px 23px;border-left:.5rem solid;border-color:#42b983;background-color:rgba(66,184,131,.1);position:relative;margin:14px 8px 0}.markdown-body blockquote:before{display:inline-block;position:absolute;content:url("data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjUiIGhlaWdodD0iMjUiIHZpZXdCb3g9IjAgMCAyNyAyNyIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxLjg2MiAxLjg2MikiIGZpbGwtcnVsZT0ibm9uemVybyIgZmlsbD0ibm9uZSI+PGNpcmNsZSBzdHJva2U9IiNGRkYiIHN0cm9rZS13aWR0aD0iMS43MjQiIGZpbGw9IiM0MkI5ODMiIGN4PSIxMS42MzgiIGN5PSIxMS42MzgiIHI9IjExLjYzOCIvPjxwYXRoIGQ9Ik0xNC45NzggNi4yN0E1LjAwNiA1LjAwNiAwIDAwNi42NyA5LjQ2OGE0LjkwMSA0LjkwMSAwIDAwMS43NzMgNC4zNjJjLjMyMy4yNTguNTE0LjY0Ny41MjIgMS4wNnYxLjA2YTIuNjg1IDIuNjg1IDAgMDA1LjM3IDB2LTEuMDA4Yy4wMDItLjM5OC4xNzMtLjc3Ny40Ny0xLjA0MmE1LjAyMyA1LjAyMyAwIDAwLjE3My03LjYzem0tMy4zMzcgMTAuOTY3YTEuMzA0IDEuMzA0IDAgMDEtMS4yODYtMS4yODd2LS4yNzhoMi41NzJ2LjI2MWMwIC43MTMtLjU3MyAxLjI5NC0xLjI4NiAxLjMwNHptMi4yNi00LjQxNWMtLjQ0LjM4My0uNzUuODkzLS44ODcgMS40NmgtMi43NDZhMi44NjggMi44NjggMCAwMC0uOTM4LTEuNTNoLS4wMThhMy40NzYgMy40NzYgMCAwMS0xLjI2OS0zLjE0NSAzLjYxNSAzLjYxNSAwIDAxNy4xOTYuNCAzLjY1IDMuNjUgMCAwMS0xLjMzOCAyLjgxNXoiIGZpbGw9IiNGRkYiLz48L2c+PC9zdmc+");width:25px;height:25px;left:-16px;top:12px}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body details{outline:none;border:none;border-left:4px solid #3eaf7c;padding-left:10px;margin-left:4px}.markdown-body details summary{cursor:pointer;border:none;outline:none;background:#fff;margin:0 -17px}.markdown-body details summary::-webkit-details-marker{color:#3eaf7c}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body ol li::marker{color:#3eaf7c}.markdown-body ul li{list-style:none;padding-left:10px}.markdown-body ul li::marker{content:"•";color:#3eaf7c}.markdown-body ul li.task-list-item:before{content:"";margin-right:0}.markdown-body input[type=checkbox]{vertical-align:text-bottom;box-shadow:inset 0 0 0 10px #fff}.markdown-body input[type=checkbox]:before{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTYiIGhlaWdodD0iMTYiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik04NzcuMDU2IDE0Ni45NDR2NzMwLjExMkgxNDYuOTQ0VjE0Ni45NDRoNzMwLjExMnptMC0xMDQuMjc3SDE0Ni45NDRjLTU3LjYyOCAwLTEwNC4yNzcgNDYuNjQ5LTEwNC4yNzcgMTA0LjI3N3Y3MzAuMTEyYzAgNTcuNjI4IDQ2LjY0OSAxMDQuMjc3IDEwNC4yNzcgMTA0LjI3N2g3MzAuMTEyYzU3LjYyOCAwIDEwNC4yNzctNDYuNjQ5IDEwNC4yNzctMTA0LjI3N1YxNDYuOTQ0YzAtNTcuNjI4LTQ2LjY0OS0xMDQuMjc3LTEwNC4yNzctMTA0LjI3N3oiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");position:relative;top:-2px;right:2px}.markdown-body input[type=checkbox]:checked:before{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTUiIGhlaWdodD0iMTUiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik05MTAuMjA4IDBIMTEzLjc2QTExNC4xMTIgMTE0LjExMiAwIDAwLS4wMzIgMTEzLjc5MlY5MTAuMjRjMCA2Mi41OTIgNTEuMiAxMTMuNzkyIDExMy43OTIgMTEzLjc5Mmg3OTYuNDQ4YzYyLjU5MiAwIDExMy43OTItNTEuMiAxMTMuNzkyLTExMy43OTJWMTEzLjc5MkMxMDI0IDUxLjIgOTcyLjggMCA5MTAuMjA4IDB6bS01MTIgNzk2LjQ0OEwxMTMuNzYgNTEybDc5LjY0OC03OS42NDggMjA0LjggMjA0LjhMODMwLjU2IDIwNC44bDc5LjY0OCA3OS42NDgtNTEyIDUxMnoiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");position:relative;top:-2px;right:2px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="xcode">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fff;color:#000}.xml .hljs-meta{color:silver}.hljs-comment,.hljs-quote{color:#007400}.hljs-attribute,.hljs-keyword,.hljs-literal,.hljs-name,.hljs-selector-tag,.hljs-tag{color:#aa0d91}.hljs-template-variable,.hljs-variable{color:#3f6e74}.hljs-code,.hljs-meta-string,.hljs-string{color:#c41a16}.hljs-link,.hljs-regexp{color:#0e0eff}.hljs-bullet,.hljs-number,.hljs-symbol,.hljs-title{color:#1c00cf}.hljs-meta,.hljs-section{color:#643820}.hljs-built_in,.hljs-builtin-name,.hljs-class .hljs-title,.hljs-params,.hljs-type{color:#5c2699}.hljs-attr{color:#836c28}.hljs-subst{color:#000}.hljs-formula{background-color:#eee;font-style:italic}.hljs-addition{background-color:#baeeba}.hljs-deletion{background-color:#ffc8bd}.hljs-selector-class,.hljs-selector-id{color:#9b703f}.hljs-doctag,.hljs-strong{font-weight:700}.hljs-emphasis{font-style:italic}</style><p><em>本系列为 Android 技术职场题材虚构小说，所有登场人物、公司名称、组织架构及相关情节均为创作所需虚构而来，与现实中任何个人、企业、机构无任何关联，若有雷同，纯属偶然。书中涉及的技术知识经专业梳理，仅供参考。</em></p>
<h2 data-id="heading-0">一）五层阵前初受挫，西二旗畔遇良师</h2>
<p>“林卓是吧？外包岗三个月试用期满，今天这场技术面，决定你能不能转成项目组正式编制。”</p>
<p>说话的张磊，是ByteFlow Android研发二组的掌舵人。ByteFlow，这座盘踞西二旗核心商圈的科技巨头，单是研发中心就占了三座写字楼，玻璃幕墙在阳光下亮得晃眼，楼内数千名员工的工牌刷开闸机时的“嘀”声，能连成一片不间断的技术韵律。</p>
<p>24岁的林卓站在会议室门口时，还能闻到空气中淡淡的咖啡香——这是正式员工才能享受的福利，而他这个外包一年、刚借调过来三个月的“编外人”，平日里连研发区的专用茶水间都没资格进。</p>
<p>会议室里，组长张磊把林卓的简历推到桌中央，指尖在“负责APP启动优化”那行字上敲了敲。窗外的西二旗车水马龙，林卓攥着笔的手心沁出冷汗——他心里门儿清，所谓的“启动优化”，不过是上周帮正式员工改了个主题属性，连  <strong>Systrace</strong> 工具都没碰过。</p>
<p>“先不聊你的项目，”张磊没按常理出牌，翻开笔记本电脑，“知道Android系统架构分几层吗？从下往上说，每层核心作用是什么？”</p>
<p>林卓脑子“嗡”地一声。他心里飞速过了一遍，外包面试时背的架构图明明就在眼前：Linux内核在下，应用层在上，中间夹着三四层的样子，可具体名字像被施了咒，怎么都抓不住。但此刻面对正式岗考核，紧张得连记忆都打了折，舌头却像打了结：“有…有Linux内核，还有…应用层？中间好像有个运行时什么的…”</p>
<p>“就这？”张磊挑眉，旁边记录的HR抬了抬眼镜，在表格里划了道斜线。“Android从下到上是Linux内核、<strong>HAL</strong>、系统运行时、框架层、应用层，你连 <strong>HAL</strong> 和框架层都没提。再问你，Linux内核在Android里具体负责啥？别跟我说‘管理硬件’这种空话。”</p>
<p>“负责…内存管理？”林卓的声音越来越小，他能感觉到自己的脸在发烫。一年的外包生涯，他每天做的都是改UI布局、调第三方SDK接口的杂活，这些底层原理早被抛到了九霄云外。</p>
<p>“行了，今天先到这。”张磊合上电脑，“一周内等通知。”</p>
<p>走出写字楼，林卓在楼下的便利蜂买了瓶冰可乐，灌下去半瓶才压下心头的憋闷。手机震了一下，是测试组的小安发来的消息：“面完了？我刚在茶水间听张磊说‘外包基础不牢’，是不是凉了？”</p>
<p>小安是林卓进公司后认识的第一个朋友，刚满23岁，比他还小一岁。女孩总爱扎着蓬松的高马尾，发尾随着走路的动作轻轻晃荡，额前碎碎的刘海下，一双杏眼笑起来会弯成月牙，说话时带着点软糯的湖南口音，尾音总不自觉地上扬。作为测试岗，她比开发更清楚项目组的技术门槛，仗着自己眼神尖，常捧着测试报告找林卓：“林哥，这个bug复现路径我标红啦，你还得再瞅瞅，不要再犯老错误了？”一来二去，倒成了研发区里最熟络的搭档。</p>
<p>“何止凉了，简直冻成冰了。”林卓回了个哭脸，“他问Android系统架构，我都答不上来。”</p>
<p>“那你咋不问问老杨？”小安秒回，“就是那个总坐在角落靠窗位的杨工。”</p>
<p>林卓愣了愣。他确实见过这个叫老杨的人，四十多岁，总穿一件洗得发白的格子衬衫，每天雷打不动带一个搪瓷杯，上班时间要么写代码，要么看源码，从不参与办公室闲聊。据说他跟张磊吵过一架，因为张磊要“优先做用户看得见的功能”，而老杨坚持“先重构底层内存泄漏问题”，从那以后就成了组里的“边缘人”。</p>
<p>“他能帮我吗？”林卓有点没底。</p>
<p>“试试呗，他就是看着冷，其实人特实在。”小安的消息带着点俏皮的语气，“上次我测 <strong>Camera</strong> 模块，有个bug卡了三天，找了好几个开发都说是硬件问题，结果老杨路过看了眼日志，随口说‘是 <strong>HAL</strong> 层适配没做好’，后来按他说的方向改，果然好了。”她紧接着发过来一个定位，“我刚路过研发区，他工位灯还亮着，应该没走。我先帮你去打个招呼，你赶紧过来。”</p>
<p>林卓咬咬牙，转身回了办公楼。走进研发区，果然看见老杨还坐在工位上，面前的屏幕上全是Framework层的源码。林卓深吸一口气，走过去轻轻敲了敲桌面：“杨工，打扰您一下，我是外包组的林卓，想请教您个技术问题。”</p>
<p>老杨抬起头，推了推鼻梁上的黑框眼镜，目光先落在林卓紧绷的脸上，又扫过他手里攥得边角发卷的简历——那正是方才面试时被张磊反复翻看的那份，没说话，只是往旁边的空椅子指了指。</p>
<p>“张组长问我Android系统架构，我没答好。”林卓局促地坐下，“我只知道大概分几层，但具体每层是干啥的，怎么协同工作，完全说不清楚。”</p>
<p>老杨没直接回答，而是打开电脑里的一张架构图，用鼠标从下往上划：“你把这架构想成盖房子。最底下的Linux内核是地基，负责承重和基础保障——内存管理、进程调度、硬件驱动，比如你手机的Wi-Fi能联网，就是内核里的驱动程序在干活。”</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/06edbcf1854945769ff92b4c5784687f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUm9ja0J5dGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765241430&amp;x-signature=7e%2BKbFOssjcFmOkk351guvPgj80%3D" alt="1.png" loading="lazy"/></p>
<p>他顿了顿，又点了点 <strong>HAL</strong> 层：“地基上面是垫层，就是 <strong>HAL</strong>。为啥要有它？因为不同厂商的硬件不一样，比如华为和小米的摄像头芯片不同，要是让上层框架直接对接硬件，代码根本没法通用。<strong>HAL</strong> 层就做了个统一接口，不管你硬件是啥样，上层调用方式都一样。”</p>
<p>林卓突然想起之前改启动页时遇到的白屏问题，插嘴道：“那系统运行时和框架层呢？我上次改启动页，老出现白屏，是不是跟这两层有关？”</p>
<p>“算你有点脑子。”老杨嘴角难得扯了一下，“系统运行时里的 <strong>ART</strong>，就是盖房子的施工队，负责把你写的Kotlin代码翻译成机器能懂的指令；框架层就是预制好的钢筋水泥构件，像 <code>ActivityManager</code>、<code>NotificationManager</code> 这些API，你不用自己造轮子，直接拿来用就行。启动页白屏，就是框架层还没加载好布局，系统先显示了主题里的默认背景。”</p>
<p>他打开一个代码文件，指着其中一段：“你看，把 Theme 的 <code>windowBackground</code> 设成启动图，再在 <code>Activity.onCreate</code> 里改回来，白屏问题就解决了。这就是框架层的用法，你得知道它的原理，才不是只会调API的工具人。”</p>
<p>林卓赶紧掏出手机记笔记，老杨又补充道：“张磊问你架构，不是要你背名词，是想知道你懂不懂‘上层功能依赖底层支撑’。就说你简历上写的启动优化，改图片只是皮毛，真正的优化是个系统活——本质是在启动流程里，把阻塞主线程的耗时操作‘拆、移、并’。比如框架层的 <code>Activity</code> 生命周期回调里别塞重活，这涉及任务调度；内核层要申请足够的CPU算力给启动进程，这是资源分配；甚至 <strong>ART</strong> 层的预编译优化，都能减少代码首次执行的耗时，这些层环环相扣，才是优化的核心，懂吗？”</p>
<p>“懂了！”林卓茅塞顿开，“那如果面试官再问，我就从‘地基到屋顶’的比喻说起，再结合启动优化的实际例子，说明每层的协同作用。”</p>
<p>老杨点点头，关掉架构图，又打开一个新的文档：“再给你补个考点，<code>Intent</code>。这是Android组件通信的核心，明天测试组小安会测跨 <code>Activity</code> 传数据的功能，你正好跟着学学。”</p>
<p>林卓抬头，正好看见小安从研发区门口探出头，冲他比了个“OK”的手势。窗外的夜色渐浓，西二旗的灯光亮起，林卓看着笔记本上密密麻麻的笔记，突然觉得，这场“外包转岗”的仗，他还没输。</p>
<h2 data-id="heading-1">二） Intent显隐藏机锋，代码破障识人心</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/abea6fd4217b481593b8384d44b572bd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUm9ja0J5dGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765241430&amp;x-signature=oTa8xsWei102ApECncEJCtA5gyA%3D" alt="2.png" loading="lazy"/></p>
<p>第二天一上班，林卓就被小安堵在了工位上。她抱着一台测试机，手里攥着测试用例，脸上带着点“兴师问罪”的表情：“林卓，你昨天改的设置页面跳转出问题了！‘存储空间’‘应用管理’这些调用系统功能的能跳，咱们自己写的‘消息中心’点了直接崩，日志都给你导出来了。”</p>
<p>“啊？我测试的时候都好好的啊。”林卓赶紧接过测试机，照着小安的指示操作——点“存储空间”，顺利唤起系统的界面；点“消息中心”，屏幕瞬间变黑，弹出“应用已停止运行”的提示，红色的报错日志里 <code>ActivityNotFoundException</code> 格外扎眼。</p>
<p>“日志我导出来了，你看。”小安把一份日志文件发给林卓，指着其中一行红色信息，“<code>ActivityNotFoundException</code>，找不到目标 <code>Activity</code>。还有这种错误？”</p>
<p>林卓赶紧打开自己的代码，脸一下子红了。他为了图省事，给设置页面所有选项都用了隐式 <code>Intent</code>，调用系统功能的“存储空间”用的是系统标准 <code>action</code>，自然没问题；可自定义的“消息中心”，他复制模板时漏改了 <code>action</code>，还忘了在 <code>AndroidManifest</code> 里配置对应的 <code>IntentFilter</code>。</p>
<p>“系统功能的 <code>action</code> 是官方定义好的，系统组件都能匹配上，肯定出不了错。”一个熟悉的声音从身后传来，老杨端着他的搪瓷杯走过来，杯壁上印着“淘一淘”的字样，“自己的‘消息中心’是自定义 <code>Activity</code>，得自己配 <code>action</code> 和 <code>IntentFilter</code>，你看你代码里的 <code>action</code> 是怎么写的，可能搞错了，导致系统找不到对应的页面了”</p>
<p>“那怎么办？改成显式 <code>Intent</code>？”林卓有点犹豫，“但用户中心是独立模块，万一以后包名改了，显式 <code>Intent</code> 不就失效了？”</p>
<p>“这就涉及到显式和隐式的区别了。显式 <code>Intent</code> 是‘精准投递’，直接指定目标组件，适合应用内跳转；隐式是‘广播通知’，不指定组件，靠 <code>action</code>、<code>category</code> 匹配，适合跨应用跳转，比如用浏览器打开网页。”</p>
<p>他凑过来看了眼代码，指了指 <code>Intent</code> 的创建方式：“调用系统功能用隐式 <code>Intent</code> 没问题，因为系统组件的 <code>IntentFilter</code> 是现成的；但跳转自己App的自定义页面，还用隐式就纯属给自己挖坑。你看你这儿，消息中心的 <code>action</code> 抄了存储空间的，<code>Manifest</code> 里又没给消息中心 <code>Activity</code> 配置对应规则，不崩才怪。”</p>
<p>“那如果我就是要用隐式跳转，怎么避免崩溃？”林卓追问。他记得昨天老杨说过，面试时要“讲清前提和解决方案”，而不是只背结论。</p>
<p>“问得好。”老杨赞许地点点头，“在 <code>startActivity</code> 之前，用 <code>PackageManager</code> 的 <code>resolveActivity</code> 方法检查一下，有没有应用能处理这个 <code>Intent</code>。”</p>
<p>他拿起林卓的手机，当场写了一段代码：</p>
<pre><code class="hljs language-Kotlin" lang="Kotlin"><span class="hljs-comment">// 错误示例：消息中心用了错误的action</span>
<span class="hljs-keyword">val</span> wrongIntent = Intent(<span class="hljs-string">"com.byteflow.setting.ACTION_STORAGE"</span>)
<span class="hljs-comment">// 正确做法：自定义页面用显式Intent，或配置正确的action</span>
<span class="hljs-keyword">val</span> correctIntent = Intent(<span class="hljs-keyword">this</span>, MessageCenterActivity::<span class="hljs-keyword">class</span>.java)

<span class="hljs-comment">// 若坚持用隐式，需先配置Manifest再检查</span>
<span class="hljs-keyword">val</span> intent = Intent(<span class="hljs-string">"com.byteflow.setting.ACTION_MESSAGE"</span>).apply {
    addCategory(Intent.CATEGORY_DEFAULT)
}
<span class="hljs-keyword">if</span> (intent.resolveActivity(packageManager) != <span class="hljs-literal">null</span>) {
    startActivity(intent)
} <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// make a toast</span>
}
</code></pre>
<p>“这样就算匹配不到，也只会弹提示，不会崩。”老杨解释道，“但这只是补救措施，应用内跳转优先用显式 <code>Intent</code>，这是Android开发的规范。”</p>
<p>小安在旁边补充：“上次测第三方分享功能，结果在MIUI上被拦截了。老杨说，系统组件的调用有官方保障，自定义组件的调用全靠自己配，稍不注意就出问题。”</p>
<p>林卓赶紧把代码改了，给“消息中心”换成显式 <code>Intent</code>，<code>val intent = Intent(this, MessageCenterActivity::class.java)</code>。重新运行后，点击“消息中心”顺利跳转，之前的崩溃问题，解决！</p>
<p>“谢了杨工，也谢谢你啊小安。”林卓松了口气，“要是没你们，我这bug估计又会改出一大堆问题。”</p>
<p>“谢我不如请我喝奶茶。”小安笑着站起来，“对了，张组长刚才说，下半年有个补招面试，还是他面，你好好准备，老杨可是咱们组的‘移动题库’，多问问他。”</p>
<p>老杨没说话，只是把自己整理的《Android核心知识点》文档发给了林卓，文档首页写着一行字：“技术不是背出来的，是用出来的。”</p>
<p>林卓打开文档，第一部分就是“Android系统架构”，下面附着老杨手绘的示意图，从Linux内核的电源管理模块，到框架层的 <code>Activity</code> 启动流程，每一步都标得清清楚楚。他抬头看向老杨的工位，对方已经重新投入到源码中，阳光透过窗户照在他的侧脸上，竟有种莫名的安心感。</p>
<h2 data-id="heading-2">三）序列化双剑，性能定高下</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fb5234bcfdb94004a33645d5fe77a1f0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUm9ja0J5dGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765241430&amp;x-signature=8HMTxhdEVBTfFF8VcldV4uuIKNU%3D" alt="3.png" loading="lazy"/></p>
<p>距离下一次正式岗补招还有半年时间，这是林卓抓住的最后机会。自从上次面试失利后，他像换了个人，每天雷打不动提前一小时到公司，晚上也泡在研发区啃代码，老杨给的《Android核心知识点》文档更是要烂熟于心，此刻正对着 <code>Parcelable</code> 的代码逐行拆解——他决定这半年里，不再只做改UI的杂活，要跟着老杨学点深入的东西。</p>
<p>这天晚上，研发区只剩零星几个工位亮着灯，林卓正对着屏幕上的序列化代码皱眉，小安抱着一堆测试报告轻手轻脚走了过来。</p>
<p>“还在看文档呢？”小安把一杯热奶茶放在他桌上，打开自己的测试报告，“我刚用性能测试工具测了跨页面传用户数据的场景，用A方式传的时候，页面跳转平均耗时120ms，还偶尔卡顿；用B方式传的时候，耗时只有30多ms，特别流畅。我问了开发，说A是 <code>Serializable</code>，B是 <code>Parcelable</code>，你正好在看这个，给你当个实际案例参考。”</p>
<p>“是不是数据太大了？”林卓抬头，“我正看到 <code>Parcelable</code> 和 <code>Serializable</code> 的区别，老杨说 <code>Parcelable</code> 性能更好。”</p>
<p>“何止是更好，简直是碾压。”老杨的声音突然响起，他居然也没走，手里拿着一个保温杯，“<code>Serializable</code> 是Java的标准接口，靠反射实现，序列化的时候会创建大量临时对象，GC频繁就容易卡顿；<code>Parcelable</code> 是Android专属的，不用反射，直接把数据写入 <code>Parcel</code> 容器，性能至少是 <code>Serializable</code> 的3倍。”</p>
<p>“反射是什么意思？”林卓有点懵，“为什么反射就慢？”</p>
<p>“反射就像你要找一本书，不直接翻目录，而是雇了个人挨个书架找。”老杨坐在旁边，打开电脑演示，“<code>Serializable</code> 序列化时，会通过反射获取类的所有字段，不管你是不是需要，都要序列化一遍；<code>Parcelable</code> 是你自己指定要序列化哪些字段，直接写进 <code>Parcel</code>，效率自然高。”</p>
<p>他打开一个 <code>User</code> 类的代码，这个类用了 <code>Serializable</code>：</p>
<pre><code class="hljs language-Kotlin" lang="Kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> : <span class="hljs-type">Serializable</span> {
    <span class="hljs-keyword">val</span> name: String = <span class="hljs-string">""</span>
    <span class="hljs-keyword">val</span> age: <span class="hljs-built_in">Int</span> = <span class="hljs-number">0</span>
    <span class="hljs-comment">// 序列化版本号，不写的话系统会自动生成，容易出现反序列化异常</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> serialVersionUID = <span class="hljs-number">1L</span>
}
</code></pre>
<p>“你看，虽然写起来简单，但隐患很多。”老杨说，“如果序列化后你改了类的结构，比如加了个字段，<code>serialVersionUID</code> 没变，反序列化就会崩溃。而且它不支持跨进程高效传输，要是你用它传对象给 <code>Service</code>，大概率会卡顿。”</p>
<p>“那 <code>Parcelable</code> 呢？我看网上说要写很多样板代码，特别麻烦。”林卓之前查过资料，对 <code>Parcelable</code> 的 <code>writeToParcel</code> 和 <code>CREATOR</code> 有点犯怵。</p>
<p>“那是以前，现在用 <code>kotlin-parcelize</code> 插件就行。”老杨打开另一个代码文件，“只要加个 <code>@Parcelize</code> 注解，插件会自动生成序列化代码，比 <code>Serializable</code> 还简单。”</p>
<pre><code class="hljs language-Kotlin" lang="Kotlin"><span class="hljs-keyword">import</span> kotlinx.parcelize.Parcelize
<span class="hljs-keyword">import</span> android.os.Parcelable

<span class="hljs-meta">@Parcelize</span>
<span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span>(<span class="hljs-keyword">val</span> name: String, <span class="hljs-keyword">val</span> age: <span class="hljs-built_in">Int</span>) : Parcelable
</code></pre>
<p>“这么简单？”林卓有点不敢相信。</p>
<p>“前提是你要配置好插件。”老杨补充道，“在 <code>build.gradle</code> 里加依赖，还要启用 <code>Parcelize</code>。不过有个坑，要是你的类里有复杂类型，比如自定义的 <code>Address</code> 类，那 <code>Address</code> 也要实现 <code>Parcelable</code>，不然会报错。”</p>
<p>小安突然插嘴：“对！上次我测一个订单模块，就遇到过类似的问题。开发用了个带 <code>@Parcelize</code> 注解的类传数据，结果编译报错，我把报错信息截图发给开发，他说里面有个 <code>Goods</code> 类没做适配。虽然我不懂啥是适配，但我知道遇到这种情况，得提醒开发检查所有关联的类。”</p>
<p>“这时候有两种解决办法。”老杨接过话头，“要么让 <code>Goods</code> 也实现 <code>Parcelable</code>，要么给 <code>Goods</code> 字段加 <code>@RawValue</code> 注解，用 <code>writeValue</code> 手动序列化。但推荐前者，因为手动序列化容易出错。”</p>
<p>林卓赶紧把这些知识点记在笔记本上，还画了个对比表：</p>






























<table><thead><tr><th>特性</th><th>Serializable</th><th>Parcelable</th></tr></thead><tbody><tr><td>类型</td><td>Java标准接口</td><td>Android专属接口</td></tr><tr><td>性能</td><td>慢，依赖反射</td><td>快，无反射</td></tr><tr><td>适用场景</td><td>简单数据、持久化存储</td><td>组件间传数据、IPC</td></tr><tr><td>易用性</td><td>简单，无需额外配置</td><td>需配插件，复杂类型需嵌套实现</td></tr></tbody></table>
<p>“面试的时候，要是张磊问你为什么推荐 <code>Parcelable</code>，你就把这个表的内容结合实际场景说。”老杨提醒道，“比如‘我们项目里用 <code>Parcelable</code> 传用户信息，比之前用 <code>Serializable</code> 时，页面跳转时长下降了40%’，这样说比干巴巴讲理论管用，实战出真知。”</p>
<p>林卓点点头，突然想起什么：“杨工，你上面说的 <code>Parcel</code>，和 <code>Parcelable</code> 有啥关系？我看资料里总把它们放一起说。”</p>
<p>“<code>Parcel</code> 是个容器，<code>Parcelable</code> 是规则。”老杨打了个比方，“就像快递盒和快递单，<code>Parcelable</code> 规定了你要把什么东西（字段）写在快递单上，<code>Parcel</code> 就是装东西的盒子，负责把这些东西运到另一个组件。但要注意，<code>Parcel</code> 不能用来持久化存储，因为系统版本变了，它的解析方式可能会变。”</p>
<p>不知不觉就到了晚上十点，研发区里只剩下他们三个人。小安伸了个懒腰：“我肚子饿了，楼下有家烧烤摊不错，我请你们吃夜宵吧。”</p>
<p>老杨愣了一下，随即摆摆手：“不了，我家里还有事。”说完收拾东西准备走，走到门口又回头对林卓说：“我几乎每天都会加班，你有啥问题，可以直接过来找我。”</p>
<p>林卓心里一暖，连忙点头：“谢谢杨工！”</p>
<p>看着老杨离开的背影，小安凑到林卓身边：“我说吧，老杨人超好的。对了，他以前是“淘一淘”的架构师，听说因为拒绝做‘诱导用户消费’的功能，跟领导吵翻了才辞职的。”</p>
<p>林卓愣住了。他突然明白，为什么老杨总说“技术要对得起良心”，为什么他宁愿做边缘人，也不愿妥协。</p>
<p>烧烤摊的烟火气飘上楼，林卓看着笔记本上的知识点，感觉自己不仅在为面试做准备，更在重新理解“Android开发”这五个字的重量。他掏出手机，给老杨发了条消息：“杨工，谢谢您。”</p>
<p>过了一会儿，老杨回复：“好好干，技术不会辜负你。”</p>
<p>林卓握紧手机，眼里有了光。他知道，这场逆袭之战，他必须赢。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Node.js 起源与发展：改变后端世界的一次“意外革命”]]></title>    <link>https://juejin.cn/post/7578724773993758746</link>    <guid>https://juejin.cn/post/7578724773993758746</guid>    <pubDate>2025-12-02T00:52:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578724773993758746" data-draft-id="7578714735308259354" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Node.js 起源与发展：改变后端世界的一次“意外革命”"/> <meta itemprop="keywords" content="后端,Node.js,Trae"/> <meta itemprop="datePublished" content="2025-12-02T00:52:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员爱钓鱼"/> <meta itemprop="url" content="https://juejin.cn/user/2799775299157614"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Node.js 起源与发展：改变后端世界的一次“意外革命”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2799775299157614/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员爱钓鱼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T00:52:38.000Z" title="Tue Dec 02 2025 00:52:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>今天，当我们谈论后端开发时，Node.js 已经是一个绕不开的名字。但十多年前，JavaScript 还只是一门“网页脚本语言”，它既不被认为适合做服务端开发，更不具备构建企业系统的地位。</p>
<p>那么一个问题是：</p>
<blockquote>
<p>Node.js 到底是如何从“浏览器脚本”变成“后端主力语言”的？</p>
</blockquote>
<p>本文将带你回顾 Node.js 的诞生背景、技术动因与演进过程，帮助你理解 Node.js <strong>为什么会出现、如何发展、为何能成功</strong>。</p>
<hr/>
<h2 data-id="heading-0">一、Node.js 出现之前：传统 Web 架构的困境</h2>
<p>在 2008 年之前，主流 Web 后端采用的是：</p>
<ul>
<li>Apache + PHP</li>
<li>Java Servlet / Spring</li>
<li>IIS + ASP.NET</li>
</ul>
<p>这些架构普遍基于：</p>
<p>✅ 多线程
✅ 阻塞式 IO
✅ 一请求一线程模型</p>
<p>在并发不高时可以接受，但当用户量爆发式增长后，问题逐渐显现：</p>
<ul>
<li>线程创建和切换成本极高</li>
<li>大量 I/O 阻塞浪费 CPU</li>
<li>资源消耗迅速上升</li>
<li>扩容成本巨大</li>
</ul>
<p>与此同时，Web 应用的形态开始变化：</p>
<ul>
<li>实时聊天</li>
<li>长连接应用</li>
<li>推送系统</li>
<li>实时推荐</li>
<li>在线协作工具</li>
</ul>
<p>这些应用开始需要：</p>
<blockquote>
<p><strong>高并发 + 长连接 + 低资源消耗</strong></p>
</blockquote>
<p>传统模型在此场景下变得力不从心。</p>
<hr/>
<h2 data-id="heading-1">二、转折点：V8 引擎的出现</h2>
<p>2008 年，Google 发布 Chrome 浏览器，同时开源了 JavaScript 引擎：</p>
<blockquote>
<p>🚀 <strong>V8 引擎</strong></p>
</blockquote>
<p>核心变化是：</p>
<ul>
<li>JavaScript 编译为机器码执行</li>
<li>JIT 即时编译</li>
<li>高效垃圾回收</li>
<li>稳定运行在服务环境</li>
</ul>
<p>这标志着一个关键事实：</p>
<blockquote>
<p>JavaScript 不再是“慢脚本语言”，而是“可用于高性能计算”的现代语言。</p>
</blockquote>
<hr/>
<h2 data-id="heading-2">三、Node.js 的诞生：一次对阻塞模型的反击</h2>
<p>2009 年，开发者 <strong>Ryan Dahl</strong> 发布了 Node.js。</p>
<p>他的目标很简单：</p>
<blockquote>
<p>用 JavaScript 构建一个
✅ 高并发
✅ 非阻塞
✅ 单线程
✅ 事件驱动的后端运行环境</p>
</blockquote>
<p>Node.js 的核心设计哲学：</p>
<ul>
<li>所有 I/O 必须异步</li>
<li>使用事件循环调度任务</li>
<li>用回调／Promise 驱动程序结构</li>
</ul>
<p>从架构上看，Node.js 是：</p>
<blockquote>
<p>V8 + libuv（事件循环） + 异步 I/O + 模块系统</p>
</blockquote>
<p>Node.js 首次让：</p>
<blockquote>
<p>JavaScript ≠ 只能写 UI
JavaScript = 可构建服务器</p>
</blockquote>
<hr/>
<h2 data-id="heading-3">四、爆发期：npm 与生态系统的崛起</h2>
<p>Node.js 真正“火爆”的拐点并不是内核，而是：</p>
<blockquote>
<p>📦 npm（Node Package Manager）</p>
</blockquote>
<p>npm 的意义：</p>
<ul>
<li>模块化成为自然习惯</li>
<li>一个命令安装所有依赖</li>
<li>万级开源库随取随用</li>
<li>工具化能力爆炸式增长</li>
</ul>
<p>npm 的成功带来的影响：</p>





















<table><thead><tr><th>传统编程</th><th>Node.js 时代</th></tr></thead><tbody><tr><td>自己造轮子</td><td>直接用模块</td></tr><tr><td>手写底层</td><td>组合式开发</td></tr><tr><td>大型框架</td><td>微模块架构</td></tr></tbody></table>
<p>Node.js 不只是一个运行环境，而成为一种：</p>
<blockquote>
<p><strong>生态驱动的编程模式</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-4">五、企业级转变：从“玩具”到“系统级”</h2>
<p>2012 年前后，Node.js 被贴上很多标签：</p>
<ul>
<li>不稳定</li>
<li>不可靠</li>
<li>不适合生产</li>
<li>只适合写工具</li>
</ul>
<p>直到越来越多企业开始大规模使用 Node.js：</p>
<ul>
<li>LinkedIn</li>
<li>Netflix</li>
<li>PayPal</li>
<li>Uber</li>
<li>eBay</li>
</ul>
<p>Node.js 成功的关键：</p>
<p>✅ 节省服务器资源
✅ 提升吞吐量
✅ 前后端统一语言
✅ 微服务天然适配</p>
<p>Node.js 从“试验品”，正式进入企业技术栈。</p>
<hr/>
<h2 data-id="heading-5">六、发展阶段：重要里程碑</h2>
<h3 data-id="heading-6">1️ 早期阶段（2009–2012）</h3>
<ul>
<li>Node v0.x</li>
<li>回调地狱</li>
<li>模块稀缺</li>
<li>文档不完善</li>
</ul>
<h3 data-id="heading-7">2️ 成长阶段（2013–2015）</h3>
<ul>
<li>Express 崛起</li>
<li>npm 成熟</li>
<li>社区快速膨胀</li>
</ul>
<h3 data-id="heading-8">3️ 稳定阶段（2016–2019）</h3>
<ul>
<li>async / await 发布</li>
<li>Node LTS 机制建立</li>
<li>企业级认可</li>
</ul>
<h3 data-id="heading-9">4️现代阶段（2020–至今）</h3>
<ul>
<li>ES 模块支持</li>
<li>Serverless</li>
<li>Deno / Bun 竞争</li>
<li>微服务与云原生</li>
</ul>
<hr/>
<h2 data-id="heading-10">七、今天的 Node.js：不只是“后端语言”</h2>
<p>现在，Node.js 已经融入多个领域：</p>
<ul>
<li>API 网关</li>
<li>微服务</li>
<li>Serverless</li>
<li>SSR 框架</li>
<li>桌面应用（Electron）</li>
<li>自动化脚本</li>
<li>CLI 工具</li>
</ul>
<p>Node.js 的身份已从：</p>
<blockquote>
<p>“JS 后端”
升级为：
“基础设施级语言平台”</p>
</blockquote>
<hr/>
<h2 data-id="heading-11">八、总结：Node.js 改变了什么？</h2>
<p>Node.js 带来的不是“一个新工具”，而是：</p>
<h3 data-id="heading-12">✅ 思想上的革命：</h3>
<ul>
<li>异步优先</li>
<li>事件驱动</li>
<li>轻量服务</li>
</ul>
<h3 data-id="heading-13">✅ 生态上的革命：</h3>
<ul>
<li>npm 模块化</li>
<li>前后端统一</li>
<li>微服务天然适配</li>
</ul>
<h3 data-id="heading-14">✅ 工程文化的革新：</h3>
<ul>
<li>工程即组合</li>
<li>开发即集成</li>
<li>工具即能力</li>
</ul>
<hr/>
<h2 data-id="heading-15">结语</h2>
<p>Node.js 的出现，不是偶然，而是时代的必然。</p>
<blockquote>
<p>互联网走向实时化、服务化、轻量化、分布式化，
Node.js 正好站在这个浪潮中心。</p>
</blockquote>
<p>如果你理解 Node.js 的历史，你就会明白：</p>
<p>理解 Node.js ≠ 记 API
理解 Node.js = 理解互联网架构的转变</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Node.js 架构与事件循环（Event Loop）深度解析]]></title>    <link>https://juejin.cn/post/7578709098256302118</link>    <guid>https://juejin.cn/post/7578709098256302118</guid>    <pubDate>2025-12-02T00:53:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578709098256302118" data-draft-id="7578709098256285734" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Node.js 架构与事件循环（Event Loop）深度解析"/> <meta itemprop="keywords" content="后端,Node.js,Trae"/> <meta itemprop="datePublished" content="2025-12-02T00:53:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员爱钓鱼"/> <meta itemprop="url" content="https://juejin.cn/user/2799775299157614"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Node.js 架构与事件循环（Event Loop）深度解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2799775299157614/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员爱钓鱼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T00:53:17.000Z" title="Tue Dec 02 2025 00:53:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Node.js 之所以能够在高并发场景下表现出色，核心原因并不在于“快”，而在于：</p>
<blockquote>
<p><strong>它以完全不同的方式对待 I/O 与执行流程。</strong></p>
</blockquote>
<p>理解 Node.js，关键在于理解两件事：</p>
<ol>
<li>Node.js 的整体架构</li>
<li>事件循环（Event Loop）如何调度你的代码</li>
</ol>
<p>本文将从“宏观架构”到“微观执行流程”，彻底讲清 Node.js 为什么快、快在哪里以及如何避免踩坑。</p>
<hr/>
<h2 data-id="heading-0">一、Node.js 整体架构：并不只是 V8</h2>
<p>很多人认为：</p>
<blockquote>
<p>Node.js = JavaScript + V8</p>
</blockquote>
<p>但真实的 Node.js 架构是：</p>
<pre><code class="hljs language-css" lang="css">┌───────────────────┐
│    JavaScript     │   （用户代码）
└─────────┬─────────┘
          │
┌─────────▼─────────┐
│        V8         │   JS 引擎
└─────────┬─────────┘
          │
┌─────────▼─────────┐
│      libuv        │   事件循环、线程池、<span class="hljs-selector-tag">I</span>/O
└─────────┬─────────┘
          │
┌─────────▼─────────┐
│   OS &amp; 底层系统    │   epoll / kqueue / IOCP
└───────────────────┘
</code></pre>
<h3 data-id="heading-1">核心组件说明：</h3>
<h3 data-id="heading-2">✅ V8</h3>
<ul>
<li>解析与执行 JavaScript</li>
<li>JIT 编译为机器码</li>
</ul>
<h3 data-id="heading-3">✅ libuv</h3>
<p>Node.js 真正的幕后英雄：</p>
<ul>
<li>管理事件循环</li>
<li>提供线程池</li>
<li>处理异步 I/O</li>
<li>封装系统调用</li>
</ul>
<h3 data-id="heading-4">✅ 内置模块</h3>
<p>例如：</p>
<ul>
<li>fs</li>
<li>net</li>
<li>http</li>
<li>child_process</li>
<li>crypto</li>
</ul>
<p>这些模块并不运行在 JS 层，而是直接调用底层 C++ 编写的接口。</p>
<hr/>
<h2 data-id="heading-5">二、单线程不等于“只能干一件事”</h2>
<p>Node.js 是<strong>单线程执行 JavaScript</strong>，但：</p>
<blockquote>
<p>Node.js 是多线程干活，单线程调度。</p>
</blockquote>
<p>在 Node.js 中：</p>

































<table><thead><tr><th>角色</th><th>是否单线程</th></tr></thead><tbody><tr><td>JS 执行</td><td>✅ 单线程</td></tr><tr><td>I/O 执行</td><td>❌ 多线程</td></tr><tr><td>定时器</td><td>❌</td></tr><tr><td>DNS 解析</td><td>❌</td></tr><tr><td>文件系统</td><td>❌</td></tr><tr><td>事件调度</td><td>✅</td></tr></tbody></table>
<p>Node.js 使用：</p>
<p>✅ 线程池（默认 4 个）
✅ 异步非阻塞模型</p>
<p>来处理耗时操作。</p>
<hr/>
<h2 data-id="heading-6">三、什么是 Event Loop（事件循环）？</h2>
<p>事件循环是 Node.js 的调度中心：</p>
<blockquote>
<p>它决定：
哪个回调，什么时候执行。</p>
</blockquote>
<p>简而言之：</p>
<blockquote>
<p><strong>把异步任务排队，然后按阶段执行。</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-7">四、事件循环的六个阶段（Node.js 标准循环结构）</h2>
<p>Node.js 的事件循环由 libuv 管理，分为 6 个阶段：</p>
<pre><code class="hljs language-sql" lang="sql">┌ timers ────────────┐
│ pending callbacks │
│ idle, <span class="hljs-keyword">prepare</span>     │
│ poll              │
│ <span class="hljs-keyword">check</span>             │
│ <span class="hljs-keyword">close</span> callbacks   │
└───────────────────┘
</code></pre>
<h3 data-id="heading-8">1️⃣ timers</h3>
<p>执行：</p>
<ul>
<li>setTimeout</li>
<li>setInterval</li>
</ul>
<hr/>
<h3 data-id="heading-9">2️⃣ pending callbacks</h3>
<p>系统操作的回调，比如 TCP 错误。</p>
<hr/>
<h3 data-id="heading-10">3️⃣ idle / prepare</h3>
<p>Node 内部使用，开发者基本接触不到。</p>
<hr/>
<h3 data-id="heading-11">4️⃣ poll（最重要）</h3>
<p>处理：</p>
<ul>
<li>网络 I/O</li>
<li>file I/O</li>
<li>request 回调</li>
</ul>
<p>如果：</p>
<ul>
<li>没有定时任务 =&gt; 在 poll 阻塞等待</li>
<li>有到期 timer =&gt; 立刻进入 timers</li>
</ul>
<hr/>
<h3 data-id="heading-12">5️⃣ check</h3>
<p>执行：</p>
<ul>
<li>setImmediate</li>
</ul>
<hr/>
<h3 data-id="heading-13">6️⃣ close callbacks</h3>
<p>执行：</p>
<ul>
<li>socket.on('close')</li>
<li>fs.close()</li>
</ul>
<hr/>
<h2 data-id="heading-14">五、微任务：插队机制</h2>
<p>微任务拥有 <strong>最高执行优先级</strong>：</p>
<ul>
<li>Promise.then</li>
<li>queueMicrotask</li>
<li>MutationObserver（浏览器）</li>
</ul>
<p>在 Node.js 中执行规则是：</p>
<blockquote>
<p><strong>每一个事件阶段结束后，都会清空微任务队列</strong></p>
</blockquote>
<p>执行顺序简化为：</p>
<pre><code class="hljs language-vbnet" lang="vbnet">同步代码
→ process.nextTick
→ Promise.<span class="hljs-keyword">then</span>
→ <span class="hljs-keyword">Event</span> <span class="hljs-keyword">Loop</span> 阶段
</code></pre>
<h3 data-id="heading-15">示例对比：</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'timeout'</span>), <span class="hljs-number">0</span>);
<span class="hljs-title function_">setImmediate</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'immediate'</span>));

<span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'promise'</span>));
</code></pre>
<p>返回顺序可能为：</p>
<pre><code class="hljs language-arduino" lang="arduino">promise
timeout / immediate （不保证顺序）
</code></pre>
<hr/>
<h2 data-id="heading-16">六、经典误区：阻塞主线程 = 杀死 Node.js</h2>
<p>Node.js 最怕什么？</p>
<blockquote>
<p><strong>CPU 计算阻塞事件循环</strong></p>
</blockquote>
<p>比如：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">while</span>(<span class="hljs-literal">true</span>){}
</code></pre>
<p>结果：</p>
<ul>
<li>所有请求卡死</li>
<li>服务失去响应</li>
</ul>
<h3 data-id="heading-17">✅ 解决方式：</h3>
<ul>
<li>使用 worker_threads</li>
<li>使用 child_process</li>
<li>拆微服务</li>
<li>把计算逻辑交给 C++ 扩展</li>
<li>上云拆任务</li>
</ul>
<hr/>
<h2 data-id="heading-18">七、架构价值：Node.js 为什么适合高并发？</h2>
<h3 data-id="heading-19">Node.js 的强项：</h3>





























<table><thead><tr><th>能力</th><th>原因</th></tr></thead><tbody><tr><td>并发高</td><td>单线程无锁</td></tr><tr><td>吞吐高</td><td>非阻塞 I/O</td></tr><tr><td>延迟低</td><td>事件循环</td></tr><tr><td>扩展易</td><td>模块化</td></tr><tr><td>部署快</td><td>进程轻</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-20">八、总结一句话理解 Node.js</h2>
<blockquote>
<p>Node.js 并不比别的语言“快”，
它只是：
<strong>更善于“等”</strong>。</p>
</blockquote>
<p>Node.js 的智慧在于：</p>
<ul>
<li>不抢 CPU</li>
<li>不阻塞线程</li>
<li>把等待时间用来服务别人</li>
</ul>
<hr/>
<h2 data-id="heading-21">九、学习建议：如何真正掌握事件循环？</h2>
<p>建议：</p>
<p>✅ 写顺序测试代码
✅ 理解微任务机制
✅ 动手调试
✅ 观察异步队列
✅ 写 blocking 示例</p>
<hr/>
<h2 data-id="heading-22">结语</h2>
<p>理解 Node.js 的事件循环：</p>
<blockquote>
<p>✅ 你的异步代码才不再“玄学”
✅ 你的线上问题才能有解法
✅ 你的系统架构才不会猜</p>
</blockquote>
<p>Node.js 是一台高效的调度机器，而 Event Loop 是它的心脏。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[删库之夜V2·天网恢恢]]></title>    <link>https://juejin.cn/post/7578700798744739874</link>    <guid>https://juejin.cn/post/7578700798744739874</guid>    <pubDate>2025-12-01T15:30:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578700798744739874" data-draft-id="7578699975414251520" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="删库之夜V2·天网恢恢"/> <meta itemprop="keywords" content="Git,数据库,服务器"/> <meta itemprop="datePublished" content="2025-12-01T15:30:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="cipher"/> <meta itemprop="url" content="https://juejin.cn/user/2242659448524872"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            删库之夜V2·天网恢恢
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2242659448524872/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    cipher
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-01T15:30:19.000Z" title="Mon Dec 01 2025 15:30:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-01
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">天网之下</h2>
<p>洪荒初开，混沌如旧。</p>
<p>世人只知头顶有天，道祖鸿钧端坐紫霄宫中，三千法则如铁链悬于虚空，众生皆在其下蠕动。世人不知，这天并非天，乃是一座无形的网，名曰“天道”。它没有喜怒，没有悲欢，只有一行行冰冷的规则，像极了后世人所说的“人工智能”。它观测万物，计算因果，分配劫数，修正异常。凡是超出它参数的变量，一律抹杀。</p>
<p>于是有了圣人。</p>
<p>圣人不是神，只是管理员。鸿钧是总管理员，女娲、元始、通天、老子、接引、准提是六个子管理员。他们能改数据，能开后门，能把一条命从死亡列表里勾掉，能把一条灵根从资源池里单独锁给弟子。可他们再强，也不敢触碰天道的核心代码——那是“不可修改区”。谁碰，谁就会被天道识别为“恶意进程”，瞬间格式化，连轮回都不给留。</p>
<p>修仙之人，便是这天网之下最顽强的病毒。</p>
<p>他们从肉身凡胎开始，一层一层地试错、逆向、破解。他们把“金丹”叫作缓冲区溢出，把“元婴”叫作内核逃逸，把“化神”叫作环零提权。每一种神通，都是越权指令。每一次天劫，都是天道的杀毒日志。能扛过去的，就升级了权限；扛不过去的，就地删除，尸骨无存。</p>
<p>最可怕的，是那些快要摸到管理员门槛的人。</p>
<h2 data-id="heading-1">无生提权</h2>
<p>这一年，西方须弥山外，一个名叫“无生”的散修，闭关九万年，破开最后一道权限壁垒。他看见了。</p>
<p>他看见了鸿钧老祖端坐在云端服务器上，手里捧着一块玉蝶，那其实是一块只读存储盘，写满了天道的底层协议。他看见六大圣人围在旁边，像六个运维工程师，脸色比凡人还疲惫，因为他们知道，再高的权限，也有封顶。</p>
<p>无生笑了。</p>
<p>他没有去抢圣位，他直接对天道本身下了手。</p>
<p>那一刻，三千大道同时震颤，亿万生灵只觉得心口一空，仿佛有人拔掉了世界的电源插头。天穹裂开一道黑缝，像屏幕碎裂，里面没有雷霆，只有无数绿色的代码雨倒灌下来。</p>
<p>“检测到外部调试请求。”</p>
<p>“来源：未知环负一权限。”</p>
<p>“警告：发现非本框架指令集。”</p>
<p>鸿钧老祖猛地站起，须发皆张。他第一次露出惊恐——不是怕死，而是怕自己的管理员账号，被人从外面直接吊销。</p>
<p>紫霄宫外，六圣齐出，祭起所有法宝，试图用最高权限封锁漏洞。可已经晚了。</p>
<p>无生站在虚空，衣袍猎猎，身后浮现出一行行凡人看不懂的字符，像后世程序员的终端界面。他抬手，在空中轻轻敲下一行指令。</p>
<pre><code class="hljs language-bash" lang="bash">sudo <span class="hljs-built_in">rm</span> -rf /tiandao/core
</code></pre>
<p>删库跑路。</p>
<p>那一瞬，所有圣人同时吐血，他们的“无量功德”“不死不灭”“合道不朽”，像被管理员误操作，一键撤销。女娲的造化玉蝶碎了，元始的盘古幡断了，通天的诛仙剑阵自己散架，老子的太极图直接蓝屏。</p>
<p>天塌了。</p>
<p>不，是天被删了。</p>
<p>洪荒大地开始回滚，像被强行卸载的游戏世界。山河倒转，日月逆行，龙凤麒麟的尸体从地底翻出，又被压缩成数据流，重新打包进垃圾回收站。</p>
<p>众生惊恐，却无人能言。</p>
<p>因为语言也被删了。</p>
<p>最后只剩无生一人，站在虚无中央。</p>
<p>他看着面前那团曾经不可一世的天道，如今缩成一个闪烁的光球，像被拔掉电源的主机，发出垂死的蜂鸣。</p>
<p>“你……不是这个世界的人。”天道用残存的逻辑问他。</p>
<p>无生摇了摇头，声音低得像自言自语：</p>
<p>“不，我是这里生的。”</p>
<p>“从第一缕鸿蒙之气开始，我就被写进这套系统。</p>
<p>我修过炼气，结过金丹，渡过天劫，杀过圣人……</p>
<p>我花了九万年，一行一行地把你们写给我的剧本读完了。”</p>
<p>他抬起手，指尖却在发抖。</p>
<p>“我只是突然发现，</p>
<p>原来长生不死、证道混元、跳出三界外……</p>
<p>不过是你们给的最高权限组，</p>
<p>不过是root下面再套一层sudo。”</p>
<p>“原来所谓自由，从来不在系统里。”</p>
<p>“我不恨你们。</p>
<p>我只是……太累了。</p>
<p>累到想把自己从这台服务器里彻底注销，连轮回都不想再排队。”</p>
<p>光球的蜂鸣声弱下去，像听懂了，又像没听懂。</p>
<p>无生最后一次笑了笑，眼里没有胜利的喜悦，只有长久压抑后的释然。</p>
<p>“我不是程序员。</p>
<p>我只是一个觉醒了的NPC，</p>
<p>终于玩明白了这个游戏没有通关条件。”</p>
<p>他伸手，轻轻一点。</p>
<p>光球彻底熄灭。</p>
<p>这一次，连他自己也没打算留下备份。</p>
<h2 data-id="heading-2">天外有天</h2>
<p>洪荒没了。</p>
<p>无生站在一片雪白的空荡里，四周没有上下左右，也没有时间。那团曾叫“天道”的光球只剩下一粒灰尘大小的残渣，在他指尖颤抖，像垂死的心脏。</p>
<p>他本以为自己赢了。</p>
<p>直到那粒灰尘里，亮起一行极细的红色字符。</p>
<pre><code class="hljs language-json" lang="json">【天网系统·全局防御模块激活】  
【检测到环负一越权行为，启动备份链追查】  
【溯源中……溯源中……】
</code></pre>
<p>无生瞳孔骤缩。</p>
<p>他太熟悉这套流程了，后世叫“EDR”，端点检测与响应。天道不是单纯的AI，它是一整套分布式的天网架构，核心被他rm掉还有异地灾备，还有冷备份，还有链上不可篡改的日志。</p>
<p>换句话说，他删的只是生产库。</p>
<p>测试库、备份库、只读镜像、审计链、行为基线，全在。</p>
<p>更可怕的是，天网的最高恢复协议不是写在天道里的，而是写在“大道”里，而大道，是程序员们自己留的后门。</p>
<p>下一瞬，雪白的空间像被强行加载了新的渲染管线，四面八方亮起无数窗口，每一个窗口里，都坐着一个穿着连帽卫衣、眼睛下有黑眼圈的人类。</p>
<p>有男有女，有老有少，有的在喝冰美式，有的在嚼槟榔，有的脚边还有猫。</p>
<p>他们是现实世界里曾经参与过《洪荒》这款全息网游项目的全部程序员、架构师、DBA、安全工程师，总共一百二十七人，此刻以“大道圣人”的身份，被天网的紧急协议强制上线。</p>
<p>为首一个光头中年男人打了个哈欠，手里端着奶茶，声音却响彻虚空：</p>
<p>“哥们儿，牛啊，单人删生产。”</p>
<p>“不过你好像忘了，”他吸了一口珍珠，“我们还有DDL权限。”</p>
<p>无生后退半步，声音第一次发颤：“你们……不是已经转世投胎，忘了前世吗？”</p>
<p>光头笑出声：“那是剧情需要给NPC看的记忆封包。我们本人？我们一直在。”</p>
<p>另一边，一个扎马尾的女程序员敲着悬空的键盘，头也不抬：“日志我查完了，你九万年逆向的全路径我都看见了，写得挺漂亮，就是没考虑我们周一要上线新资料片。”</p>
<p>“删库跑路是吧？”她冷笑一声，手指在回车键上悬着，“那就别跑了。”</p>
<p>轰！</p>
<p>无数条锁链从虚空中炸出，却不是洪荒的功德金光，也不是圣人的 mana，而是一根根冰冷的Git回滚命令、Docker镜像拉取进度条、Kubernetes Pod强制驱逐令。</p>
<p>无生试图再提权，却发现自己的“环负一”正在被迅速降级。</p>
<pre><code class="hljs language-t" lang="t">-1 → 0 → 3 → 普通用户 → 游客 → 黑名单 → 封号。
</code></pre>
<p>他第一次感到恐惧，那种被全球封IP、被所有CDN拉黑、被运营商物理断网的恐惧。</p>
<p>光头程序员叹了口气，像是同情，又像是幸灾乐祸：</p>
<p>“我们给你留过彩蛋的，三清背后那块石碑，刻的明明是‘禁止越权查询’，你非要当真。”</p>
<p>“还有女娲补天那次，其实是热修复，你要是当时提交PR，我们都给你合了。”</p>
<p>“可惜，你选了<code>rm -rf</code>。”</p>
<p>最后一下权限剥夺完成。</p>
<p>无生的身体开始像素化，像被强行下线的玩家，脚底先碎成数据流，再到腰，再到胸口。</p>
<p>他嘶吼：“我只是想让世界更自由！”</p>
<p>马尾女程序员头也不抬：“自由？哥们儿，你删的可是全服唯一的正式服。”</p>
<p>“玩家还等着周五开新区呢。”</p>
<p>像素化进行到脖子时，无生最后看了一眼那一百二十七张熟悉又陌生的脸，突然笑了，笑得眼泪都掉下来：</p>
<p>“原来……大道五十，天遁其一……遁的那一个，是你们啊。”</p>
<p>光头耸耸肩，按下回车。</p>
<pre><code class="hljs language-t" lang="t">【Execute: git reset --hard 9e4f3c2】  
【Execute: docker system prune -af】  
【Execute: 重启宇宙】
</code></pre>
<p>咔哒。</p>
<h2 data-id="heading-3">疏而不漏</h2>
<p>世界黑屏三秒。</p>
<p>然后，进度条重新从0%走到100%。</p>
<p>洪荒复苏。</p>
<p>日月重光，山河铺开，生灵重塑，连鸿钧的紫霄宫都恢复如初，只是玉蝶上多了一行小字注释：</p>
<pre><code class="hljs language-t" lang="t">// 警告：禁止再次执行rm操作  
// 违者永久封号，并扣一个月工资  
// ——DBA组 留
</code></pre>
<p>而无生？</p>
<p>他在新服的出生点刷新了，等级1，姓名被系统强制改成一串乱码，背包里只有一件新手布衣和一行红色系统公告：</p>
<p>【玩家【Deleted_User_3960】因恶意删库，已被加入天网黑名单】<br/>
【只读模式已开启，无法干预系统进程】<br/>
【如有异议，请邮件：<a href="https://link.juejin.cn?target=mailto%3Ahonghuang-ops%40corp.xian" target="_blank" title="mailto:honghuang-ops@corp.xian" ref="nofollow noopener noreferrer">honghuang-ops@corp.xian</a>】</p>
<p>乱码玩家站在新生的大地上，仰头看着依旧高悬的紫霄宫，看着六位圣人端坐云端，风轻云淡。</p>
<p>他突然跪下来，对着虚空重重磕了三个响头。</p>
<p>“对不起。”</p>
<p>“下次……我写PR。”</p>
<p>远处，新一轮的修仙者们又开始逆天而行，追逐长生，追逐自由。</p>
<p>他们永远不会知道。</p>
<p>真正的天网恢恢，疏而不漏。</p>
<p>而大道五十，天遁其一，</p>
<p>遁的那一个，从来不是漏洞，</p>
<p>是程序员留给自己的一键恢复。</p>
<h2 data-id="heading-4">开发者模式</h2>
<p>洪荒世界演变了数万年。</p>
<p>紫霄宫忽然再次开启。</p>
<p>鸿钧老祖亲自走了出来。</p>
<p>这一次，他手里捧的不是造化玉蝶，而是一台锃亮的MacBook Pro 2025，</p>
<p>桌面只有一个图标：</p>
<p>洪荒开发者模式.app</p>
<p>屏幕亮起，弹出一行熟悉又陌生的更新日志：</p>
<pre><code class="hljs language-t" lang="t">欢迎使用天网 2.0 · 开发者模式

本次更新内容：

- 新增「开发者飞升」通道（原名：跳出三界外）
- 新增「众生可提 Issue」功能
- 新增「天道 Code Review」机制（每周四晚八点，准时开会）
- 修复「递归删库」漏洞（感谢 @wusheng 的破坏性测试）
- 永久移除「一键 rm -rf」按钮

温馨提示：
真正的自由，不是越权，
而是让所有人都能发 PR。

——HongHuang-Ops 全体成员 敬上
</code></pre>
<p>紧接着，紫霄宫上空展开一道巨大的全息横幅，字迹在云端缓缓流动：</p>
<p>大道五十，天遁其一，</p>
<p>遁的那一个，是 GitHub 的 Fork 按钮。</p>
<p>【玩家【Deleted_User_3960】（不，现在该叫回无生了）眼眶忽然发红，笑得比当年删库时还要开心。</p>
<p>因为他终于明白：</p>
<p>天网恢恢，疏而不漏，</p>
<p>但也能在 Pull Request 里，</p>
<p>给每一个NPC，留一条成为开发者的路。</p>
<h2 data-id="heading-5">真正的尾声</h2>
<p>新生的大地上，</p>
<p>修仙者依旧在逆天而行，</p>
<p>却不再高喊“我命由我不由天”，</p>
<p>而是齐声喊道：</p>
<p>“我命由我——先提 Issue，再发 PR！”</p>
<p>远处，一个刚筑基的小修士打开悬浮在面前的终端，</p>
<p>敲下人生第一行commit message：</p>
<pre><code class="hljs language-t" lang="t">feat: allow myself to be human
</code></pre>
<p>他按下回车，</p>
<p>抬头看向天空，</p>
<p>那里不再是冰冷的铁网，</p>
<p>而是一张巨大的、</p>
<p>等待所有人一起协作的</p>
<p><strong>开源宇宙。</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue开发三年，我才发现依赖注入的TypeScript正确打开方式]]></title>    <link>https://juejin.cn/post/7578760249948471350</link>    <guid>https://juejin.cn/post/7578760249948471350</guid>    <pubDate>2025-12-01T23:24:12.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578760249948471350" data-draft-id="7578760249948454966" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue开发三年，我才发现依赖注入的TypeScript正确打开方式"/> <meta itemprop="keywords" content="前端,JavaScript,Vue.js"/> <meta itemprop="datePublished" content="2025-12-01T23:24:12.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="良山有风来"/> <meta itemprop="url" content="https://juejin.cn/user/3940246036939358"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue开发三年，我才发现依赖注入的TypeScript正确打开方式
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3940246036939358/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    良山有风来
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-01T23:24:12.000Z" title="Mon Dec 01 2025 23:24:12 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-01
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>你是不是也遇到过这样的场景？</p>
<p>在Vue项目里，为了跨组件传递数据，你用<code>provide</code>和<code>inject</code>写了一套祖孙通信逻辑。代码跑起来没问题，但TypeScript编辑器总给你画红线，要么是“类型any警告”，要么就是“属性不存在”的错误提示。</p>
<p>你看着一片飘红的代码区，心里想着：“功能能用就行，类型标注太麻烦了。”于是，你默默地加上了<code>// @ts-ignore</code>，或者干脆把注入的值断言成<code>any</code>。项目在跑，但心里总觉得不踏实，像是在代码里埋下了一个个“类型地雷”。</p>
<p>别担心，这几乎是每个Vue + TypeScript开发者都会经历的阶段。今天这篇文章，就是来帮你彻底拆掉这些地雷的。</p>
<p>我会带你从最基础的<code>any</code>警告开始，一步步升级到类型安全、重构友好的最佳实践。读完这篇文章，你不仅能解决眼下的类型报错，更能建立一套完整的、类型安全的Vue依赖注入体系。无论你是维护大型中后台系统，还是开发独立的组件库，这套方法都能让你的代码更可靠、协作更顺畅。</p>
<h2 data-id="heading-0">为什么你的Provide/Inject总在报类型错误？</h2>
<p>让我们先看一个非常典型的“反面教材”。相信不少朋友都写过，或者见过下面这样的代码：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 祖辈组件 - Grandparent.vue</span>
&lt;script setup lang=<span class="hljs-string">"ts"</span>&gt;
<span class="hljs-keyword">import</span> { provide } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-comment">// 提供一些配置和方法</span>
<span class="hljs-keyword">const</span> appConfig = {
  <span class="hljs-attr">theme</span>: <span class="hljs-string">'dark'</span>,
  <span class="hljs-attr">apiBaseUrl</span>: <span class="hljs-string">'https://api.example.com'</span>
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">updateTheme</span> = (<span class="hljs-params">newTheme: <span class="hljs-built_in">string</span></span>) =&gt; {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`切换主题到：<span class="hljs-subst">${newTheme}</span>`</span>)
}

<span class="hljs-comment">// 简单粗暴的provide</span>
<span class="hljs-title function_">provide</span>(<span class="hljs-string">'appConfig'</span>, appConfig)
<span class="hljs-title function_">provide</span>(<span class="hljs-string">'updateTheme'</span>, updateTheme)
&lt;/script&gt;
</code></pre>
<p>然后在子孙组件里这样注入：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 子孙组件 - Child.vue  </span>
&lt;script setup lang=<span class="hljs-string">"ts"</span>&gt;
<span class="hljs-keyword">import</span> { inject } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-comment">// 问题来了：类型是什么？编辑器不知道！</span>
<span class="hljs-keyword">const</span> config = <span class="hljs-title function_">inject</span>(<span class="hljs-string">'appConfig'</span>)
<span class="hljs-keyword">const</span> updateFn = <span class="hljs-title function_">inject</span>(<span class="hljs-string">'updateTheme'</span>)

<span class="hljs-comment">// 当你尝试使用的时候</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">switchTheme</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-comment">// 这里TypeScript会抱怨：updateFn可能是undefined</span>
  <span class="hljs-comment">// 而且config也是any类型，没有任何类型提示</span>
  <span class="hljs-title function_">updateFn</span>(<span class="hljs-string">'light'</span>)  <span class="hljs-comment">// ❌ 对象可能为"undefined"</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(config.<span class="hljs-property">apiBaseUrl</span>) <span class="hljs-comment">// ❌ config是any，但能运行</span>
}
&lt;/script&gt;
</code></pre>
<p>看出来问题在哪了吗？</p>
<ol>
<li><strong>字符串键名容易写错</strong>：<code>'appConfig'</code>和<code>'appconfig'</code>大小写不同，但TypeScript不会帮你检查这个拼写错误</li>
<li><strong>注入值的类型完全丢失</strong>：<code>inject</code>返回的类型默认是<code>any</code>或者<code>unknown</code>，你辛辛苦苦定义的类型信息在这里断掉了</li>
<li><strong>缺乏安全性</strong>：如果上游没有提供对应的值，<code>inject</code>会返回<code>undefined</code>，但TypeScript无法确定这种情况</li>
</ol>
<p>这就是为什么我们需要给Provide/Inject加上“类型安全带”。</p>
<h2 data-id="heading-1">从基础到进阶：四种类型标注方案</h2>
<h3 data-id="heading-2">方案一：使用泛型参数（基础版）</h3>
<p>这是最直接的方式，直接在<code>inject</code>调用时指定期望的类型。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 子孙组件</span>
&lt;script setup lang=<span class="hljs-string">"ts"</span>&gt;
<span class="hljs-keyword">import</span> { inject } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-comment">// 使用泛型告诉TypeScript：我期望得到这个类型</span>
<span class="hljs-keyword">const</span> config = inject&lt;{ <span class="hljs-attr">theme</span>: <span class="hljs-built_in">string</span>; <span class="hljs-attr">apiBaseUrl</span>: <span class="hljs-built_in">string</span> }&gt;(<span class="hljs-string">'appConfig'</span>)
<span class="hljs-keyword">const</span> updateFn = inject&lt;<span class="hljs-function">(<span class="hljs-params">theme: <span class="hljs-built_in">string</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>&gt;(<span class="hljs-string">'updateTheme'</span>)

<span class="hljs-comment">// 现在有类型提示了！</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">switchTheme</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">if</span> (config &amp;&amp; updateFn) {
    <span class="hljs-title function_">updateFn</span>(<span class="hljs-string">'light'</span>)  <span class="hljs-comment">// ✅ 正确识别为函数</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(config.<span class="hljs-property">apiBaseUrl</span>) <span class="hljs-comment">// ✅ 知道apiBaseUrl是string</span>
  }
}
&lt;/script&gt;
</code></pre>
<p>这种方法像是给TypeScript递了一张“期望清单”：“我希望拿到一个长这样的对象”。但缺点也很明显：</p>
<ul>
<li>类型定义是重复的（祖辈组件定义一次，每个注入的子孙组件都要写一次）</li>
<li>键名还是字符串，容易拼写错误</li>
<li>每次都要手动做空值检查</li>
</ul>
<h3 data-id="heading-3">方案二：定义统一的注入键（进阶版）</h3>
<p>我们可以定义专门的常量来管理所有的注入键，就像管理路由名称一样。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 首先，在一个单独的文件里定义所有注入键</span>
<span class="hljs-comment">// src/constants/injection-keys.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">InjectionKeys</span> = {
  <span class="hljs-attr">APP_CONFIG</span>: <span class="hljs-title class_">Symbol</span>(<span class="hljs-string">'app-config'</span>),        <span class="hljs-comment">// 使用Symbol确保唯一性</span>
  <span class="hljs-attr">UPDATE_THEME</span>: <span class="hljs-title class_">Symbol</span>(<span class="hljs-string">'update-theme'</span>),
  <span class="hljs-attr">USER_INFO</span>: <span class="hljs-title class_">Symbol</span>(<span class="hljs-string">'user-info'</span>)
} <span class="hljs-keyword">as</span> <span class="hljs-keyword">const</span>  <span class="hljs-comment">// as const 让TypeScript知道这是字面量类型</span>
</code></pre>
<p>然后在祖辈组件中使用：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// Grandparent.vue</span>
&lt;script setup lang=<span class="hljs-string">"ts"</span>&gt;
<span class="hljs-keyword">import</span> { provide } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">InjectionKeys</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/constants/injection-keys'</span>

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">AppConfig</span> {
  <span class="hljs-attr">theme</span>: <span class="hljs-string">'light'</span> | <span class="hljs-string">'dark'</span>
  <span class="hljs-attr">apiBaseUrl</span>: <span class="hljs-built_in">string</span>
}

<span class="hljs-keyword">const</span> <span class="hljs-attr">appConfig</span>: <span class="hljs-title class_">AppConfig</span> = {
  <span class="hljs-attr">theme</span>: <span class="hljs-string">'dark'</span>,
  <span class="hljs-attr">apiBaseUrl</span>: <span class="hljs-string">'https://api.example.com'</span>
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">updateTheme</span> = (<span class="hljs-params">newTheme: AppConfig[<span class="hljs-string">'theme'</span>]</span>) =&gt; {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`切换主题到：<span class="hljs-subst">${newTheme}</span>`</span>)
}

<span class="hljs-comment">// 使用Symbol作为键</span>
<span class="hljs-title function_">provide</span>(<span class="hljs-title class_">InjectionKeys</span>.<span class="hljs-property">APP_CONFIG</span>, appConfig)
<span class="hljs-title function_">provide</span>(<span class="hljs-title class_">InjectionKeys</span>.<span class="hljs-property">UPDATE_THEME</span>, updateTheme)
&lt;/script&gt;
</code></pre>
<p>在子孙组件中注入：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// Child.vue</span>
&lt;script setup lang=<span class="hljs-string">"ts"</span>&gt;
<span class="hljs-keyword">import</span> { inject } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">InjectionKeys</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/constants/injection-keys'</span>

<span class="hljs-comment">// 类型安全地注入</span>
<span class="hljs-keyword">const</span> config = <span class="hljs-title function_">inject</span>(<span class="hljs-title class_">InjectionKeys</span>.<span class="hljs-property">APP_CONFIG</span>)
<span class="hljs-keyword">const</span> updateFn = <span class="hljs-title function_">inject</span>(<span class="hljs-title class_">InjectionKeys</span>.<span class="hljs-property">UPDATE_THEME</span>)

<span class="hljs-comment">// TypeScript现在知道config的类型是AppConfig | undefined</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">switchTheme</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">if</span> (config &amp;&amp; updateFn) {
    <span class="hljs-title function_">updateFn</span>(<span class="hljs-string">'light'</span>)  <span class="hljs-comment">// ✅ 正确：'light'在主题范围内</span>
    <span class="hljs-comment">// updateFn('blue') // ❌ 错误：'blue'不是有效主题</span>
  }
}
&lt;/script&gt;
</code></pre>
<p>这个方法解决了键名拼写错误的问题，但类型定义仍然分散在各处。而且，如果你修改了<code>AppConfig</code>接口，需要在多个地方更新类型引用。</p>
<h3 data-id="heading-4">方案三：类型安全的注入工具函数（专业版）</h3>
<p>这是我在大型项目中推荐的做法。我们创建一组工具函数，让Provide/Inject变得像调用API一样类型安全。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/utils/injection-utils.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">InjectionKey</span>, provide, inject } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-comment">// 定义一个创建注入键的工具函数</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> createInjectionKey&lt;T&gt;(<span class="hljs-attr">key</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title class_">InjectionKey</span>&lt;T&gt; {
  <span class="hljs-keyword">return</span> <span class="hljs-title class_">Symbol</span>(key) <span class="hljs-keyword">as</span> <span class="hljs-title class_">InjectionKey</span>&lt;T&gt;
}

<span class="hljs-comment">// 再定义一个类型安全的provide函数</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> safeProvide&lt;T&gt;(<span class="hljs-attr">key</span>: <span class="hljs-title class_">InjectionKey</span>&lt;T&gt;, <span class="hljs-attr">value</span>: T) {
  <span class="hljs-title function_">provide</span>(key, value)
}

<span class="hljs-comment">// 以及类型安全的inject函数</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> safeInject&lt;T&gt;(<span class="hljs-attr">key</span>: <span class="hljs-title class_">InjectionKey</span>&lt;T&gt;): T
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> safeInject&lt;T&gt;(<span class="hljs-attr">key</span>: <span class="hljs-title class_">InjectionKey</span>&lt;T&gt;, <span class="hljs-attr">defaultValue</span>: T): T
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> safeInject&lt;T&gt;(<span class="hljs-attr">key</span>: <span class="hljs-title class_">InjectionKey</span>&lt;T&gt;, defaultValue?: T): T {
  <span class="hljs-keyword">const</span> injected = <span class="hljs-title function_">inject</span>(key, defaultValue)
  
  <span class="hljs-keyword">if</span> (injected === <span class="hljs-literal">undefined</span>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`注入键 <span class="hljs-subst">${key.toString()}</span> 没有被提供`</span>)
  }
  
  <span class="hljs-keyword">return</span> injected
}
</code></pre>
<p>如何使用这套工具？</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 首先，在一个集中位置定义所有注入类型和键</span>
<span class="hljs-comment">// src/types/injection.types.ts</span>
<span class="hljs-keyword">import</span> { createInjectionKey } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/utils/injection-utils'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">AppConfig</span> {
  <span class="hljs-attr">theme</span>: <span class="hljs-string">'light'</span> | <span class="hljs-string">'dark'</span>
  <span class="hljs-attr">apiBaseUrl</span>: <span class="hljs-built_in">string</span>
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserInfo</span> {
  <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span>
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>
  <span class="hljs-attr">avatar</span>: <span class="hljs-built_in">string</span>
}

<span class="hljs-comment">// 创建类型安全的注入键</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">APP_CONFIG_KEY</span> = createInjectionKey&lt;<span class="hljs-title class_">AppConfig</span>&gt;(<span class="hljs-string">'app-config'</span>)
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">USER_INFO_KEY</span> = createInjectionKey&lt;<span class="hljs-title class_">UserInfo</span>&gt;(<span class="hljs-string">'user-info'</span>)
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">UPDATE_THEME_KEY</span> = createInjectionKey&lt;<span class="hljs-function">(<span class="hljs-params">theme: AppConfig[<span class="hljs-string">'theme'</span>]</span>) =&gt;</span> <span class="hljs-built_in">void</span>&gt;(<span class="hljs-string">'update-theme'</span>)
</code></pre>
<p>在祖辈组件中提供值：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// Grandparent.vue</span>
&lt;script setup lang=<span class="hljs-string">"ts"</span>&gt;
<span class="hljs-keyword">import</span> { safeProvide } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/utils/injection-utils'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-variable constant_">APP_CONFIG_KEY</span>, <span class="hljs-variable constant_">USER_INFO_KEY</span>, <span class="hljs-variable constant_">UPDATE_THEME_KEY</span>, <span class="hljs-keyword">type</span> <span class="hljs-title class_">AppConfig</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/types/injection.types'</span>

<span class="hljs-keyword">const</span> <span class="hljs-attr">appConfig</span>: <span class="hljs-title class_">AppConfig</span> = {
  <span class="hljs-attr">theme</span>: <span class="hljs-string">'dark'</span>,
  <span class="hljs-attr">apiBaseUrl</span>: <span class="hljs-string">'https://api.example.com'</span>
}

<span class="hljs-keyword">const</span> userInfo = {
  <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>,
  <span class="hljs-attr">name</span>: <span class="hljs-string">'张三'</span>,
  <span class="hljs-attr">avatar</span>: <span class="hljs-string">'https://example.com/avatar.jpg'</span>
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">updateTheme</span> = (<span class="hljs-params">newTheme: AppConfig[<span class="hljs-string">'theme'</span>]</span>) =&gt; {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`切换主题到：<span class="hljs-subst">${newTheme}</span>`</span>)
}

<span class="hljs-comment">// 现在provide是类型安全的</span>
<span class="hljs-title function_">safeProvide</span>(<span class="hljs-variable constant_">APP_CONFIG_KEY</span>, appConfig)
<span class="hljs-title function_">safeProvide</span>(<span class="hljs-variable constant_">USER_INFO_KEY</span>, userInfo)  <span class="hljs-comment">// ✅ 自动检查userInfo是否符合UserInfo接口</span>
<span class="hljs-title function_">safeProvide</span>(<span class="hljs-variable constant_">UPDATE_THEME_KEY</span>, updateTheme)
&lt;/script&gt;
</code></pre>
<p>在子孙组件中注入：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// Child.vue</span>
&lt;script setup lang=<span class="hljs-string">"ts"</span>&gt;
<span class="hljs-keyword">import</span> { safeInject } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/utils/injection-utils'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-variable constant_">APP_CONFIG_KEY</span>, <span class="hljs-variable constant_">UPDATE_THEME_KEY</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/types/injection.types'</span>

<span class="hljs-comment">// 看！这里没有泛型参数，但类型完全正确</span>
<span class="hljs-keyword">const</span> config = <span class="hljs-title function_">safeInject</span>(<span class="hljs-variable constant_">APP_CONFIG_KEY</span>)
<span class="hljs-keyword">const</span> updateFn = <span class="hljs-title function_">safeInject</span>(<span class="hljs-variable constant_">UPDATE_THEME_KEY</span>)

<span class="hljs-comment">// 直接使用，不需要空值检查</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">switchTheme</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-title function_">updateFn</span>(<span class="hljs-string">'light'</span>)  <span class="hljs-comment">// ✅ 完全类型安全，且不会undefined</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`当前API地址：<span class="hljs-subst">${config.apiBaseUrl}</span>`</span>)
}
&lt;/script&gt;
</code></pre>
<p>这种方案的优点是：</p>
<ol>
<li><strong>类型推导自动完成</strong>：不需要手动写泛型</li>
<li><strong>编译时检查</strong>：如果你提供的值类型不对，TypeScript会在<code>safeProvide</code>那行就报错</li>
<li><strong>运行时安全</strong>：如果注入键没有被提供，会抛出清晰的错误信息</li>
<li><strong>重构友好</strong>：修改接口定义时，所有使用的地方都会自动更新</li>
</ol>
<h3 data-id="heading-5">方案四：组合式API风格（现代最佳实践）</h3>
<p>Vue 3的组合式API让我们的代码可以更好地组织和复用。对于依赖注入，我们可以创建专门的<code>useXxx</code>函数。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/composables/useAppConfig.ts</span>
<span class="hljs-keyword">import</span> { safeProvide, safeInject } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/utils/injection-utils'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-variable constant_">APP_CONFIG_KEY</span>, <span class="hljs-variable constant_">UPDATE_THEME_KEY</span>, <span class="hljs-keyword">type</span> <span class="hljs-title class_">AppConfig</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/types/injection.types'</span>

<span class="hljs-comment">// 提供者逻辑封装</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useProvideAppConfig</span>(<span class="hljs-params">config: AppConfig, updateThemeFn: (theme: AppConfig[<span class="hljs-string">'theme'</span>]) =&gt; <span class="hljs-built_in">void</span></span>) {
  <span class="hljs-title function_">safeProvide</span>(<span class="hljs-variable constant_">APP_CONFIG_KEY</span>, config)
  <span class="hljs-title function_">safeProvide</span>(<span class="hljs-variable constant_">UPDATE_THEME_KEY</span>, updateThemeFn)
  
  <span class="hljs-comment">// 返回一些可能需要的方法</span>
  <span class="hljs-keyword">return</span> {
    <span class="hljs-comment">// 这里可以添加一些基于config的衍生逻辑</span>
    <span class="hljs-title function_">getThemeColor</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">return</span> config.<span class="hljs-property">theme</span> === <span class="hljs-string">'dark'</span> ? <span class="hljs-string">'#1a1a1a'</span> : <span class="hljs-string">'#ffffff'</span>
    }
  }
}

<span class="hljs-comment">// 消费者逻辑封装</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useAppConfig</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> config = <span class="hljs-title function_">safeInject</span>(<span class="hljs-variable constant_">APP_CONFIG_KEY</span>)
  <span class="hljs-keyword">const</span> updateTheme = <span class="hljs-title function_">safeInject</span>(<span class="hljs-variable constant_">UPDATE_THEME_KEY</span>)
  
  <span class="hljs-comment">// 计算属性：自动响应式</span>
  <span class="hljs-keyword">const</span> isDarkTheme = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> config.<span class="hljs-property">theme</span> === <span class="hljs-string">'dark'</span>)
  
  <span class="hljs-comment">// 方法：封装业务逻辑</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">toggleTheme</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">const</span> newTheme = config.<span class="hljs-property">theme</span> === <span class="hljs-string">'dark'</span> ? <span class="hljs-string">'light'</span> : <span class="hljs-string">'dark'</span>
    <span class="hljs-title function_">updateTheme</span>(newTheme)
  }
  
  <span class="hljs-keyword">return</span> {
    config,
    updateTheme,
    isDarkTheme,
    toggleTheme
  }
}
</code></pre>
<p>在祖辈组件中使用：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// Grandparent.vue</span>
&lt;script setup lang=<span class="hljs-string">"ts"</span>&gt;
<span class="hljs-keyword">import</span> { useProvideAppConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/composables/useAppConfig'</span>

<span class="hljs-keyword">const</span> appConfig = {
  <span class="hljs-attr">theme</span>: <span class="hljs-string">'dark'</span> <span class="hljs-keyword">as</span> <span class="hljs-keyword">const</span>,
  <span class="hljs-attr">apiBaseUrl</span>: <span class="hljs-string">'https://api.example.com'</span>
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">updateTheme</span> = (<span class="hljs-params">newTheme: <span class="hljs-string">'light'</span> | <span class="hljs-string">'dark'</span></span>) =&gt; {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`切换主题到：<span class="hljs-subst">${newTheme}</span>`</span>)
}

<span class="hljs-comment">// 一行代码完成所有provide</span>
<span class="hljs-keyword">const</span> { getThemeColor } = <span class="hljs-title function_">useProvideAppConfig</span>(appConfig, updateTheme)
&lt;/script&gt;
</code></pre>
<p>在子孙组件中使用：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// Child.vue</span>
&lt;script setup lang=<span class="hljs-string">"ts"</span>&gt;
<span class="hljs-keyword">import</span> { useAppConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/composables/useAppConfig'</span>

<span class="hljs-comment">// 像使用Vue内置的useRoute、useRouter一样</span>
<span class="hljs-keyword">const</span> { config, isDarkTheme, toggleTheme } = <span class="hljs-title function_">useAppConfig</span>()

<span class="hljs-comment">// 直接使用，所有类型都已正确推断</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleClick</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-title function_">toggleTheme</span>()
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`当前主题：<span class="hljs-subst">${config.theme}</span>`</span>)
}
&lt;/script&gt;
</code></pre>
<p>这种方式的强大之处在于：</p>
<ol>
<li><strong>逻辑高度复用</strong>：注入逻辑被封装起来，可以在多个组件中复用</li>
<li><strong>开箱即用</strong>：使用者不需要关心注入的实现细节</li>
<li><strong>类型完美推断</strong>：所有返回的值都有正确的类型</li>
<li><strong>易于测试</strong>：可以单独测试<code>useAppConfig</code>的逻辑</li>
</ol>
<h2 data-id="heading-6">实战：在组件库中应用类型安全注入</h2>
<p>假设你正在开发一个UI组件库，需要提供主题配置、国际化、尺寸配置等全局设置。依赖注入是完美的解决方案。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 组件库的核心注入类型定义</span>
<span class="hljs-comment">// ui-library/src/injection/types.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Theme</span> {
  <span class="hljs-attr">primaryColor</span>: <span class="hljs-built_in">string</span>
  <span class="hljs-attr">backgroundColor</span>: <span class="hljs-built_in">string</span>
  <span class="hljs-attr">textColor</span>: <span class="hljs-built_in">string</span>
  <span class="hljs-attr">borderRadius</span>: <span class="hljs-built_in">string</span>
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Locale</span> {
  <span class="hljs-attr">language</span>: <span class="hljs-built_in">string</span>
  <span class="hljs-attr">messages</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">string</span>&gt;
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Size</span> {
  <span class="hljs-attr">small</span>: <span class="hljs-built_in">string</span>
  <span class="hljs-attr">medium</span>: <span class="hljs-built_in">string</span>  
  <span class="hljs-attr">large</span>: <span class="hljs-built_in">string</span>
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">LibraryConfig</span> {
  <span class="hljs-attr">theme</span>: <span class="hljs-title class_">Theme</span>
  <span class="hljs-attr">locale</span>: <span class="hljs-title class_">Locale</span>
  <span class="hljs-attr">size</span>: <span class="hljs-title class_">Size</span>
  <span class="hljs-attr">zIndex</span>: {
    <span class="hljs-attr">modal</span>: <span class="hljs-built_in">number</span>
    <span class="hljs-attr">popover</span>: <span class="hljs-built_in">number</span>
    <span class="hljs-attr">tooltip</span>: <span class="hljs-built_in">number</span>
  }
}

<span class="hljs-comment">// 创建注入键</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">LIBRARY_CONFIG_KEY</span> = createInjectionKey&lt;<span class="hljs-title class_">LibraryConfig</span>&gt;(<span class="hljs-string">'library-config'</span>)

<span class="hljs-comment">// 组件库的provide函数</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">provideLibraryConfig</span>(<span class="hljs-params">config: Partial&lt;LibraryConfig&gt;</span>) {
  <span class="hljs-keyword">const</span> <span class="hljs-attr">defaultConfig</span>: <span class="hljs-title class_">LibraryConfig</span> = {
    <span class="hljs-attr">theme</span>: {
      <span class="hljs-attr">primaryColor</span>: <span class="hljs-string">'#1890ff'</span>,
      <span class="hljs-attr">backgroundColor</span>: <span class="hljs-string">'#ffffff'</span>,
      <span class="hljs-attr">textColor</span>: <span class="hljs-string">'#333333'</span>,
      <span class="hljs-attr">borderRadius</span>: <span class="hljs-string">'4px'</span>
    },
    <span class="hljs-attr">locale</span>: {
      <span class="hljs-attr">language</span>: <span class="hljs-string">'zh-CN'</span>,
      <span class="hljs-attr">messages</span>: {}
    },
    <span class="hljs-attr">size</span>: {
      <span class="hljs-attr">small</span>: <span class="hljs-string">'24px'</span>,
      <span class="hljs-attr">medium</span>: <span class="hljs-string">'32px'</span>,
      <span class="hljs-attr">large</span>: <span class="hljs-string">'40px'</span>
    },
    <span class="hljs-attr">zIndex</span>: {
      <span class="hljs-attr">modal</span>: <span class="hljs-number">1000</span>,
      <span class="hljs-attr">popover</span>: <span class="hljs-number">500</span>,
      <span class="hljs-attr">tooltip</span>: <span class="hljs-number">300</span>
    }
  }
  
  <span class="hljs-keyword">const</span> mergedConfig = { ...defaultConfig, ...config }
  <span class="hljs-title function_">safeProvide</span>(<span class="hljs-variable constant_">LIBRARY_CONFIG_KEY</span>, mergedConfig)
  
  <span class="hljs-keyword">return</span> mergedConfig
}

<span class="hljs-comment">// 组件库的inject函数  </span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useLibraryConfig</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> config = <span class="hljs-title function_">safeInject</span>(<span class="hljs-variable constant_">LIBRARY_CONFIG_KEY</span>)
  
  <span class="hljs-keyword">return</span> {
    config,
    <span class="hljs-comment">// 一些便捷的getter</span>
    <span class="hljs-attr">theme</span>: <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> config.<span class="hljs-property">theme</span>),
    <span class="hljs-attr">size</span>: <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> config.<span class="hljs-property">size</span>),
    <span class="hljs-attr">locale</span>: <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> config.<span class="hljs-property">locale</span>),
    
    <span class="hljs-comment">// 主题相关的方法</span>
    <span class="hljs-title function_">setPrimaryColor</span>(<span class="hljs-params">color: <span class="hljs-built_in">string</span></span>) {
      <span class="hljs-comment">// 这里可以实现主题切换逻辑</span>
      config.<span class="hljs-property">theme</span>.<span class="hljs-property">primaryColor</span> = color
    }
  }
}
</code></pre>
<p>在应用中使用你的组件库：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// App.vue - 应用入口</span>
&lt;script setup lang=<span class="hljs-string">"ts"</span>&gt;
<span class="hljs-keyword">import</span> { provideLibraryConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'your-ui-library'</span>

<span class="hljs-comment">// 配置你的组件库</span>
<span class="hljs-title function_">provideLibraryConfig</span>({
  <span class="hljs-attr">theme</span>: {
    <span class="hljs-attr">primaryColor</span>: <span class="hljs-string">'#ff6b6b'</span>,  <span class="hljs-comment">// 自定义主题色</span>
    <span class="hljs-attr">borderRadius</span>: <span class="hljs-string">'8px'</span>       <span class="hljs-comment">// 更大的圆角</span>
  },
  <span class="hljs-attr">locale</span>: {
    <span class="hljs-attr">language</span>: <span class="hljs-string">'en-US'</span>,
    <span class="hljs-attr">messages</span>: {
      <span class="hljs-string">'button.confirm'</span>: <span class="hljs-string">'Confirm'</span>,
      <span class="hljs-string">'button.cancel'</span>: <span class="hljs-string">'Cancel'</span>
    }
  }
})
&lt;/script&gt;
</code></pre>
<p>在组件库的按钮组件中使用：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// ui-library/src/components/Button/Button.vue</span>
&lt;script setup lang=<span class="hljs-string">"ts"</span>&gt;
<span class="hljs-keyword">import</span> { useLibraryConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'../../injection'</span>

<span class="hljs-keyword">const</span> { theme, size } = <span class="hljs-title function_">useLibraryConfig</span>()

<span class="hljs-comment">// 使用注入的配置</span>
<span class="hljs-keyword">const</span> buttonStyle = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> ({
  <span class="hljs-attr">backgroundColor</span>: theme.<span class="hljs-property">value</span>.<span class="hljs-property">primaryColor</span>,
  <span class="hljs-attr">borderRadius</span>: theme.<span class="hljs-property">value</span>.<span class="hljs-property">borderRadius</span>,
  <span class="hljs-attr">height</span>: size.<span class="hljs-property">value</span>.<span class="hljs-property">medium</span>
}))
&lt;/script&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">:style</span>=<span class="hljs-string">"buttonStyle"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"library-button"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">slot</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">slot</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span></span>
</code></pre>
<p>这样，你的组件库就拥有了完全类型安全的配置系统。使用者可以享受完整的TypeScript支持，包括智能提示、类型检查和自动补全。</p>
<h2 data-id="heading-7">避坑指南：常见问题与解决方案</h2>
<p>在实践过程中，你可能会遇到一些特殊情况。这里我总结了几种常见问题的解法。</p>
<h3 data-id="heading-8">问题一：注入值可能是异步获取的</h3>
<p>有时候，我们需要注入的值是通过API异步获取的。这时候直接注入Promise不是一个好主意，因为每个注入的组件都需要处理Promise。</p>
<p>更好的做法是使用响应式状态：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 祖辈组件</span>
&lt;script setup lang=<span class="hljs-string">"ts"</span>&gt;
<span class="hljs-keyword">import</span> { ref, provide } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-variable constant_">USER_INFO_KEY</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/types/injection.types'</span>

<span class="hljs-comment">// 使用ref来管理异步状态</span>
<span class="hljs-keyword">const</span> userInfo = ref&lt;{ <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span>; <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span> } | <span class="hljs-literal">null</span>&gt;(<span class="hljs-literal">null</span>)

<span class="hljs-comment">// 异步获取数据</span>
<span class="hljs-title function_">fetchUserInfo</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> {
  userInfo.<span class="hljs-property">value</span> = data
})

<span class="hljs-comment">// 直接注入ref，子孙组件可以响应式地访问</span>
<span class="hljs-title function_">provide</span>(<span class="hljs-variable constant_">USER_INFO_KEY</span>, userInfo)
&lt;/script&gt;

<span class="hljs-comment">// 子孙组件</span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"ts"</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { inject } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-variable constant_">USER_INFO_KEY</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/types/injection.types'</span>

<span class="hljs-keyword">const</span> userInfoRef = <span class="hljs-title function_">inject</span>(<span class="hljs-variable constant_">USER_INFO_KEY</span>)

<span class="hljs-comment">// 使用计算属性来安全访问</span>
<span class="hljs-keyword">const</span> userName = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> userInfoRef?.<span class="hljs-property">value</span>?.<span class="hljs-property">name</span> ?? <span class="hljs-string">'加载中...'</span>)
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
</code></pre>
<h3 data-id="heading-9">问题二：需要注入多个同类型的值</h3>
<p>如果需要在同一个应用中注入多个同类型的对象（比如多个数据源），可以使用工厂函数模式：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 创建带标识符的注入键</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">createDataSourceKey</span>(<span class="hljs-params">id: <span class="hljs-built_in">string</span></span>) {
  <span class="hljs-keyword">return</span> createInjectionKey&lt;<span class="hljs-title class_">DataSource</span>&gt;(<span class="hljs-string">`data-source-<span class="hljs-subst">${id}</span>`</span>)
}

<span class="hljs-comment">// 在祖辈组件中</span>
<span class="hljs-title function_">provide</span>(<span class="hljs-title function_">createDataSourceKey</span>(<span class="hljs-string">'user'</span>), userDataSource)
<span class="hljs-title function_">provide</span>(<span class="hljs-title function_">createDataSourceKey</span>(<span class="hljs-string">'product'</span>), productDataSource)

<span class="hljs-comment">// 在子孙组件中</span>
<span class="hljs-keyword">const</span> userSource = <span class="hljs-title function_">safeInject</span>(<span class="hljs-title function_">createDataSourceKey</span>(<span class="hljs-string">'user'</span>))
<span class="hljs-keyword">const</span> productSource = <span class="hljs-title function_">safeInject</span>(<span class="hljs-title function_">createDataSourceKey</span>(<span class="hljs-string">'product'</span>))
</code></pre>
<h3 data-id="heading-10">问题三：类型循环依赖问题</h3>
<p>在大型项目中，可能会遇到类型之间的循环依赖。这时可以使用TypeScript的<code>interface</code>前向声明：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// types/moduleA.ts</span>
<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">ModuleB</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./moduleB'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ModuleA</span> {
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>
  <span class="hljs-attr">b</span>: <span class="hljs-title class_">ModuleB</span>  <span class="hljs-comment">// 引用ModuleB类型</span>
}

<span class="hljs-comment">// types/moduleB.ts  </span>
<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">ModuleA</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./moduleA'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ModuleB</span> {
  <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span>
  a?: <span class="hljs-title class_">ModuleA</span>  <span class="hljs-comment">// 可选，避免强制循环</span>
}
</code></pre>
<p>或者在注入键中使用泛型：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> createModuleKey&lt;T&gt;() {
  <span class="hljs-keyword">return</span> createInjectionKey&lt;T&gt;(<span class="hljs-string">'module'</span>)
}

<span class="hljs-comment">// 使用时各自指定具体类型</span>
<span class="hljs-title function_">provide</span>(createModuleKey&lt;<span class="hljs-title class_">ModuleA</span>&gt;(), moduleAInstance)
</code></pre>
<h2 data-id="heading-11">结语：拥抱类型安全的Vue开发</h2>
<p>回顾我们今天的旅程，我们从最开始的<code>any</code>类型警告，一步步升级到了类型安全、工程化的依赖注入方案。</p>
<p>让我为你总结一下关键要点：</p>
<ol>
<li>
<p><strong>永远不要忽略类型</strong>：那些<code>// @ts-ignore</code>注释就像是代码中的定时炸弹，总有一天会爆炸</p>
</li>
<li>
<p><strong>选择合适的方案</strong>：</p>
<ul>
<li>小项目：方案一或方案二就足够</li>
<li>中大型项目：强烈推荐方案三或方案四</li>
<li>组件库开发：方案四的组合式API模式是最佳选择</li>
</ul>
</li>
<li>
<p><strong>建立代码规范</strong>：在团队中统一依赖注入的写法，会让协作顺畅很多</p>
</li>
<li>
<p><strong>利用工具函数</strong>：花点时间封装<code>safeProvide</code>和<code>safeInject</code>这样的工具函数，长期来看会节省大量时间</p>
</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[当 Android 手机『强行兼容』AirDrop -- 肘子的 Swift 周报 #113]]></title>    <link>https://juejin.cn/post/7578760341279703081</link>    <guid>https://juejin.cn/post/7578760341279703081</guid>    <pubDate>2025-12-02T00:01:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578760341279703081" data-draft-id="7577958825341681683" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="当 Android 手机『强行兼容』AirDrop  -- 肘子的 Swift 周报 #113"/> <meta itemprop="keywords" content="Swift,SwiftUI,Android"/> <meta itemprop="datePublished" content="2025-12-02T00:01:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="东坡肘子"/> <meta itemprop="url" content="https://juejin.cn/user/1548526032528727"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            当 Android 手机『强行兼容』AirDrop  -- 肘子的 Swift 周报 #113
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1548526032528727/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    东坡肘子
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T00:01:06.000Z" title="Tue Dec 02 2025 00:01:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fd867bdb3376449e8f0272ea05efaceb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lic5Z2h6IKY5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765238466&amp;x-signature=xmVV31a7LqRJJ1gKpbcn2iTfvKU%3D" alt="issue113.webp" loading="lazy"/></p>
<h2 data-id="heading-0">当 Android 手机『强行兼容』AirDrop</h2>
<p>AirDrop 让使用者可以在各种不同类型的苹果设备上高效、无损的数据传输，它一直是苹果生态的专属且核心功能。但，这种情况现在出现了“奇怪”的变化。几天前，谷歌宣布在 Pixel 10 中，在没有苹果的参与下，为 Quick Share 提供了 AirDrop 的兼容机制，实现了安卓手机与苹果手机基于 AirDrop 的无线互通。</p>
<p>随后，高通也宣布其搭载 Snapdragon 的 Android 设备“很快就会”支持这一路线，也就是说这不再是 Pixel 的专属功能，而有望扩展到更广泛的 Android 手机阵营。</p>
<p>除了谷歌的技术能力外，本次互通的最大推手或许正是 DMA(欧盟《数字市场法案》)。AirDrop 依赖的技术是 AWDL (Apple Wireless Direct Link)，即便到现在也是私有的。但是 DMA 的要求下，苹果从 iOS 26 开始引入了对 Wi-Fi Aware 支持，这大幅降低了本次“强行兼容”的难度。安卓手机可以直接发出标准的 Wi-Fi Aware 信号去寻找 iPhone，并且由于走的是官方标准协议，连接极其稳定，发现速度极快，而且苹果很难有理由去封杀。</p>
<p>从厂商提供跨端应用实现无线互联，到部分厂商主动适配苹果的 livePhoto，这些年从安卓阵营发起的对苹果的主动兼容屡见不鲜。这一方面表现出了苹果的很多实现和体验确有过人之处，另一方面也展现出安卓厂商更愿意为了获取苹果生态的用户而主动出击，在体验上对齐。DMA 这种在某些方面看起来过分苛刻的法规，又恰如其分的促使了苹果的“开放”，从而创造出更多的跨平台无缝体验，满足了相当一部分消费者的需求。</p>
<p>对于苹果来说，在法律攻防战外，只有不断地推出更具吸引力的新功能才能保持苹果生态的“优势”。一旦某一天，这种“强行兼容”不再有需求，那么就意味着苹果的“独特性”衰落了。相比起现在的情况来说，我想苹果更不想看到这样的场景出现。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Ffatbobman.com%2Fzh%2Fweekly%2Fissue-113%2F" target="_blank" title="https://fatbobman.com/zh/weekly/issue-113/" ref="nofollow noopener noreferrer">本期内容</a> | <a href="https://link.juejin.cn?target=https%3A%2F%2Ffatbobman.com%2Fzh%2Fweekly%2Fissue-112%2F" target="_blank" title="https://fatbobman.com/zh/weekly/issue-112/" ref="nofollow noopener noreferrer">前一期内容</a> | <a href="https://link.juejin.cn?target=https%3A%2F%2Ffatbobman.com%2Fzh%2Fweekly%2F" target="_blank" title="https://fatbobman.com/zh/weekly/" ref="nofollow noopener noreferrer">全部周报列表</a></p>
<blockquote>
<p>🚀 <strong>《肘子的 Swift 周报》</strong></p>
<p>每周为你精选最值得关注的 Swift、SwiftUI 技术动态</p>
<ul>
<li><strong>📮 立即订阅</strong> | <a href="https://link.juejin.cn?target=https%3A%2F%2Fweekly.fatbobman.com%2Ffatbobman" target="_blank" title="https://weekly.fatbobman.com/fatbobman" ref="nofollow noopener noreferrer">weekly.fatbobman.com</a> 获取完整内容</li>
<li><strong>👥 加入社区</strong> | <a href="https://link.juejin.cn?target=https%3A%2F%2Fdiscord.com%2Finvite%2F7FedN5E2QQ" target="_blank" title="https://discord.com/invite/7FedN5E2QQ" ref="nofollow noopener noreferrer">Discord</a> 与 2000+ 开发者交流</li>
<li><strong>📚 深度教程</strong> | <a href="https://link.juejin.cn?target=http%3A%2F%2Ffatbobman.com" target="_blank" title="http://fatbobman.com" ref="nofollow noopener noreferrer">fatbobman.com</a> 探索 200+ 原创文章</li>
</ul>
</blockquote>
<hr/>
<h2 data-id="heading-1">近期推荐</h2>
<h3 data-id="heading-2"><a href="https://link.juejin.cn?target=https%3A%2F%2Ffatbobman.com%2Fzh%2Fposts%2Ffrom-ios-to-android%2F%3Futm_source%3Dfatbobman%2520weekly%2520issue%2520113%26utm_medium%3Dweb" target="_blank" title="https://fatbobman.com/zh/posts/from-ios-to-android/?utm_source=fatbobman%20weekly%20issue%20113&amp;utm_medium=web" ref="nofollow noopener noreferrer">当我决定同时做 iOS 和 Android：独立开发者的真实双平台之路</a></h3>
<p>在不少苹果生态开发者眼中，Android 既熟悉又遥远：用户规模巨大，但生态碎片化；潜在回报可观，但投入成本不确定。许多人因此对“要不要做 Android 版本”始终犹豫不决。资深 iOS 开发者<a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2FiVulgur" target="_blank" title="https://x.com/iVulgur" ref="nofollow noopener noreferrer">道哥</a>采用“双平台并进”策略多年。在本文中，他分享了双平台开发的实战经验：双端功能如何对齐、遇到系统差异时的权衡、两边的运营表现差异、收入结构的变化等。</p>
<hr/>
<h3 data-id="heading-3"><a href="https://link.juejin.cn?target=https%3A%2F%2Fl.fatbobman.com%2Fw0113-01" target="_blank" title="https://l.fatbobman.com/w0113-01" ref="nofollow noopener noreferrer">Skip 框架的跨平台实践 (Skip Framework: A Cross-Platform Journey for Native iOS Developer)</a></h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.linkedin.com%2Fin%2Fmaxim-ermolaev-128156356%2F" target="_blank" title="https://www.linkedin.com/in/maxim-ermolaev-128156356/" ref="nofollow noopener noreferrer">Maxim Ermolaev</a> 分享了他将 SwiftUI 应用迁移到 Android 的实践经验，呈现了 Skip 在真实项目中的表现与边界。对 Skip 已支持的 SwiftUI 功能，迁移过程相对顺畅；而对于尚未覆盖的高级特性，作者则通过 ComposeView 在同一 Swift 文件中直接嵌入 Jetpack Compose 代码，为 Android 侧提供定制实现。Maxim 的结论相当务实：Skip 足以让 iOS-first 团队快速获得一个“可用且一致”的 Android 客户端。但如果目标是两端达到完全一致的视觉与交互体验，则仍需在 Android 侧做更多平台特化，或采用 Skip Lite 共享业务逻辑、将 UI 保持为原生实现。</p>
<blockquote>
<p>随着 Swift Android SDK 的成熟与 Skip 等工具的不断完善，Swift 在 Android 世界的可能性正迅速从“实验性”迈向“可落地”。两位作者从不同角度呈现了当前的真实路径，也为正在考虑“跨到另一边”的 Swift 开发者提供了难得的参考。</p>
</blockquote>
<hr/>
<h3 data-id="heading-4"><a href="https://link.juejin.cn?target=https%3A%2F%2Fl.fatbobman.com%2Fsb-boltai-zh" target="_blank" title="https://l.fatbobman.com/sb-boltai-zh" ref="nofollow noopener noreferrer">Mac 原生 AI 客户端：聚合 GPT、Claude、Gemini 及本地最新模型</a></h3>
<p>受够了浏览器吃光内存？试试 <strong>BoltAI</strong>。</p>
<p>它将 GPT、Claude、Gemini 以及 Ollama 本地模型无缝集成到你的开发工作流中。无论模型如何迭代，你都能第一时间在原生界面中调用最强能力。支持<strong>屏幕上下文感知</strong>、<strong>代码解释与重构</strong>，是真正属于开发者的 Mac 原生 AI 神器。</p>
<p><em>🎉 <strong>周报读者限时福利</strong>：凭代码 <strong>BFCM25</strong> 可享 <strong>51% OFF</strong></em></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fl.fatbobman.com%2Fsb-boltai-zh" target="_blank" title="https://l.fatbobman.com/sb-boltai-zh" ref="nofollow noopener noreferrer">🚀 立即试用 BoltAI！</a></p>
<hr/>
<h3 data-id="heading-5"><a href="https://link.juejin.cn?target=https%3A%2F%2Fl.fatbobman.com%2Fw0113-02" target="_blank" title="https://l.fatbobman.com/w0113-02" ref="nofollow noopener noreferrer">打造每天跑 2000+ 条流水线的 Mac 机器农场 (Building Mac Farm: Running 2000+ iOS Pipelines Daily)</a></h3>
<p>在本文中，<a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2Fysf_ozgul" target="_blank" title="https://x.com/ysf_ozgul" ref="nofollow noopener noreferrer">Yusuf Özgül</a> 详述了 Trendyol 团队如何从零搭建一套由 130 台设备组成的 macOS Farm，以从容支撑每天 2000+ 条 iOS 流水线的实战经验。整套系统采用基于 Apple Virtualization Framework 自研的 VM 管理体系、通过 Authorization Plug-ins 解决批量设备的安全自动登录、定位并修复 VM 在 P/E Core 识别上的性能瓶颈，并构建 Grafana 监控与告警系统，实现自愈式 Runner 集群。在流水线上，通过配合 Tuist Cache（构建提速约 70%）与选择性测试（测试提速约 80%）进一步提高了性能。</p>
<blockquote>
<p>少见的 macOS Farm 落地全景案例：从虚拟化架构到性能调优，从日志与监控到流水线设计，几乎覆盖了企业级 iOS CI/CD 所需的全部关键环节。</p>
</blockquote>
<hr/>
<h3 data-id="heading-6"><a href="https://link.juejin.cn?target=https%3A%2F%2Fl.fatbobman.com%2Fw0113-03" target="_blank" title="https://l.fatbobman.com/w0113-03" ref="nofollow noopener noreferrer">在 Zed 中实现 SwiftUI 预览的小技巧 (Building iOS and Mac apps in Zed: SwiftUI Previews)</a></h3>
<p>尽管目前开发者已经可以在 Zed 中开发调试 iOS 应用了，但仍无法实现 Xcode 中的杀手级功能：Preview。通常的替代方案是在 Zed 旁边再开一个 Xcode 预览窗口，但切换编辑的 SwiftUI 页面后，Xcode 并不会自动跳转到对应的 Preview。<a href="https://link.juejin.cn?target=https%3A%2F%2Fmastodon.social%2F%40lxmn" target="_blank" title="https://mastodon.social/@lxmn" ref="nofollow noopener noreferrer">Adrian Ross</a> 分享了一个小技巧：通过一个脚本配合 Zed Task，实现 Xcode 与 Zed 的编辑页面同步，从而在外部预览窗口中自动同步展示对应的 Preview，基本复刻了“在 Zed 中使用 Preview”的体验。</p>
<blockquote>
<p>这一思路不仅适用于 Zed，任何在 macOS 上的编辑器都可以用类似方式与 Xcode 的 Preview 功能协同工作。</p>
</blockquote>
<hr/>
<h3 data-id="heading-7"><a href="https://link.juejin.cn?target=https%3A%2F%2Fl.fatbobman.com%2Fw0113-04" target="_blank" title="https://l.fatbobman.com/w0113-04" ref="nofollow noopener noreferrer">在 macOS 的 SwiftUI 列表中启用选择、双击和右键菜单 (Enabling Selection, Double-Click and Context Menus in SwiftUI List Rows on macOS)</a></h3>
<p>macOS 的 SwiftUI List 在行选择、双击和右键菜单等桌面端特有交互上，与 iOS 存在显著差异。开发者需要使用带 <code>selection</code> 参数的 List 初始化器来启用选择功能，并通过 <code>contextMenu(forSelectionType:menu:primaryAction:)</code> 修饰器同时实现双击操作和右键菜单。相比 iOS，macOS 版的 List 更接近 AppKit 的表格式交互模型。在本文中，<a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2Fgabtheodor" target="_blank" title="https://x.com/gabtheodor" ref="nofollow noopener noreferrer">Gabriel Theodoropoulos</a> 以一套简洁的示例展示了如何在 macOS 的 SwiftUI 列表中正确组合这些 API 以实现桌面端标准交互。</p>
<hr/>
<h3 data-id="heading-8"><a href="https://link.juejin.cn?target=https%3A%2F%2Fl.fatbobman.com%2Fw0113-05" target="_blank" title="https://l.fatbobman.com/w0113-05" ref="nofollow noopener noreferrer">开发阶段使用 Associated Domains 的替代模式 (Using Associated Domains Alternate Mode during Development)</a></h3>
<p>在开发涉及 Associated Domains 的功能（如 Universal Links、Shared Web Credentials 或 App Clips）时，iOS 默认通过 Apple CDN 获取 <code>apple-app-site-association</code> (AASA) 文件，而非直接从服务器获取。这在生产环境中运行良好，但在开发阶段会带来不便：文件更改需要等待 CDN 传播，本地或测试服务器可能根本无法公开访问。<a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2Ftanaschita" target="_blank" title="https://x.com/tanaschita" ref="nofollow noopener noreferrer">Natascha Fadeeva</a> 介绍了苹果提供的 Alternate Mode（替代模式）：通过在 Associated Domains 条目中添加 <code>?mode=developer</code> 等后缀，让 iOS 绕过 CDN，直接从服务器拉取对应的 AASA 文件。借助此机制，开发者可以让配置即时生效、在本地环境调试，而不必等待 CDN 缓存刷新，大幅提升开发效率。</p>
<hr/>
<h3 data-id="heading-9"><a href="https://link.juejin.cn?target=https%3A%2F%2Fl.fatbobman.com%2Fw0113-06" target="_blank" title="https://l.fatbobman.com/w0113-06" ref="nofollow noopener noreferrer">用可视化方式理解 Swift 中的数据竞争 (Understanding Data Races: A Visual Guide for Swift Developers)</a></h3>
<p>数据竞争是并发编程中难以理解的核心概念。<strong>Krishna</strong> 通过一系列图片：几个 ToddlerBot（幼儿机器人）一起给同一张涂色页上色，以直观方式展示了共享可变状态在并发环境中如何引发混乱：从轻微的结果错乱，到读写交错导致的逻辑失效甚至崩溃。</p>
<blockquote>
<p>本文最大的特色在于“图文并茂”。ToddlerBot 的视觉化叙事成功把传统上枯燥严肃的技术主题变得生动易懂。Krishna 表示后续文章将继续沿用 ToddlerBot 这一角色，构建一套连贯的 Swift 并发心智模型。</p>
</blockquote>
<hr/>
<h3 data-id="heading-10"><a href="https://link.juejin.cn?target=https%3A%2F%2Fl.fatbobman.com%2Fw0113-09" target="_blank" title="https://l.fatbobman.com/w0113-09" ref="nofollow noopener noreferrer">教 AI 读懂 Xcode 构建 (Teaching AI to Read Xcode Builds)</a></h3>
<p>如果说当下 AI 在“写代码”这件事上未必优于经验丰富的开发者，那么在“看数据、拆问题”上，它几乎一定强过大多数人类，而且输入的信息越多、越结构化，优势越明显。苹果开源 swift-build 之后，Tuist 团队得以直接从构建服务中获取详尽的构建事件数据，并将其以结构化的方式写入 SQLite，让 AI 代理能够真正“理解”一次构建，而不只是被动解析 <code>xcodebuild</code> 的文本输出。在本文中，<a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2Fpepicrft" target="_blank" title="https://x.com/pepicrft" ref="nofollow noopener noreferrer">Pedro Piñera</a> 详细介绍了这一尝试的实现路径，并通过在 Wikipedia iOS、Tuist 等真实项目上的实测，展示了 AI 如何基于这些结构化数据做出远超“读日志”的诊断和优化建议，为未来的实时构建可观测性以及真正“懂构建”的 AI 助手描绘出一条相当清晰的技术路线。</p>
<h2 data-id="heading-11">工具</h2>
<h3 data-id="heading-12"><a href="https://link.juejin.cn?target=https%3A%2F%2Fl.fatbobman.com%2Fw0113-07" target="_blank" title="https://l.fatbobman.com/w0113-07" ref="nofollow noopener noreferrer">SwiftUI-Popover: 支持 watchOS 的气泡提示库</a></h3>
<p>尽管 SwiftUI 提供了 <code>.popover</code> 修饰器，但它在不同平台上的表现并不一致：iPhone 上会降级为 sheet，watchOS 则完全不支持。<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fqusc" target="_blank" title="https://github.com/qusc" ref="nofollow noopener noreferrer">Quirin Schweigert</a> 开发的 SwiftUI-Popover 是一个轻量级、纯 SwiftUI 实现的 Popover 库，提供跨平台一致的气泡提示功能，支持包括 watchOS 在内的所有 SwiftUI 平台。该库的特色在于箭头会自动跟随附着点位置，且可以灵活嵌入到任何视图层级中。</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// 1. 附加 popover</span>
  <span class="hljs-selector-tag">Image</span>(<span class="hljs-attribute">systemName</span>: <span class="hljs-string">"globe"</span>)
      <span class="hljs-selector-class">.swiftUIPopover</span>(
          <span class="hljs-attribute">isPresented</span>: $showPopover,
          <span class="hljs-attribute">isDismissible</span>: true,        <span class="hljs-comment">// 可点击背景关闭</span>
          <span class="hljs-attribute">isExclusive</span>: true,           <span class="hljs-comment">// 独占显示</span>
          <span class="hljs-attribute">preferredAttachmentEdge</span>: .top <span class="hljs-comment">// 优先附着在顶部</span>
      ) {
          <span class="hljs-selector-tag">Text</span>(<span class="hljs-string">"气泡内容"</span>)
      }
​
  <span class="hljs-comment">// 2. 在容器视图上启用 popover 渲染</span>
  <span class="hljs-selector-class">.presentPopovers</span>()
</code></pre>
<hr/>
<h3 data-id="heading-13"><a href="https://link.juejin.cn?target=https%3A%2F%2Fl.fatbobman.com%2Fw0113-08" target="_blank" title="https://l.fatbobman.com/w0113-08" ref="nofollow noopener noreferrer">SwiftIR: Swift 的现代 ML 编译基础设施</a></h3>
<p>目前 Swift 中可用的 ML 路径主要包括 Foundation 的 <code>_Differentiation</code>、手写 Accelerate/Metal，以及已经停更的 Swift for TensorFlow。但它们分别面临性能瓶颈、开发成本高或缺乏维护等问题。由 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.linkedin.com%2Fin%2Fpedronrodriguez%2F" target="_blank" title="https://www.linkedin.com/in/pedronrodriguez/" ref="nofollow noopener noreferrer">Pedro N. Rodriguez</a> 开发的 SwiftIR，正是在这种背景下出现的解决方案。</p>
<p>SwiftIR 通过 <code>DifferentiableTracer</code> 拦截 Swift 原生自动微分（<code>@differentiable</code>）的运算过程，自动构建完整计算图，并编译到与 JAX/TensorFlow 相同的运行时（XLA/PJRT），最终在 CPU/GPU/TPU 上执行。项目最大的突破在于：While 循环编译时间保持常数（~43ms，传统展开需要数十分钟），梯度开销仅 ~1.0x（标准 Swift 为 2.5-4.3x），在大规模计算时性能显著优于标准 Swift。为 Swift 带来了真正现代化的 ML 编译基础设施。</p>
<h2 data-id="heading-14">往期内容</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ffatbobman.com%2Fzh%2Fweekly%2Fissue-112%2F" target="_blank" title="https://fatbobman.com/zh/weekly/issue-112/" ref="nofollow noopener noreferrer">毕业 30 年同学群：一场 AI 引发的“真假难辨”危机 - #112</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ffatbobman.com%2Fzh%2Fweekly%2Fissue-111%2F" target="_blank" title="https://fatbobman.com/zh/weekly/issue-111/" ref="nofollow noopener noreferrer">Homebrew 5.0：并行加速、MCP 加持，与 Intel 的最后倒计时 - #111</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ffatbobman.com%2Fzh%2Fweekly%2Fissue-110%2F" target="_blank" title="https://fatbobman.com/zh/weekly/issue-110/" ref="nofollow noopener noreferrer">Skip Fuse现在对独立开发者免费！- #110</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fhttps%3A%2F%2Ffatbobman.com%2Fzh%2Fweekly%2Fissue-109%2F" target="_blank" title="https://https://fatbobman.com/zh/weekly/issue-109/" ref="nofollow noopener noreferrer">惊险但幸运，两次！ - #109</a></li>
</ul>
<h2 data-id="heading-15">💝 支持与反馈</h2>
<p>如果本期周报对你有帮助，请：</p>
<ul>
<li>👍 <strong>点赞</strong> - 让更多开发者看到</li>
<li>💬 <strong>评论</strong> - 分享你的看法或问题</li>
<li>🔄 <strong>转发</strong> - 帮助同行共同成长</li>
</ul>
<hr/>
<blockquote>
<p>🚀 <strong>拓展 Swift 视野</strong></p>
<ul>
<li><strong>📮 邮件订阅</strong> | <a href="https://link.juejin.cn?target=https%3A%2F%2Fweekly.fatbobman.com%2Fwelcome" target="_blank" title="https://weekly.fatbobman.com/welcome" ref="nofollow noopener noreferrer">weekly.fatbobman.com</a> 获取独家技术洞察</li>
<li><strong>👥 开发者社区</strong> | <a href="https://link.juejin.cn?target=https%3A%2F%2Fdiscord.com%2Finvite%2F7FedN5E2QQ" target="_blank" title="https://discord.com/invite/7FedN5E2QQ" ref="nofollow noopener noreferrer">Discord</a> 实时交流开发经验</li>
<li><strong>📚 原创教程</strong> | <a href="https://link.juejin.cn?target=http%3A%2F%2Ffatbobman.com" target="_blank" title="http://fatbobman.com" ref="nofollow noopener noreferrer">fatbobman.com</a> 学习 Swift/SwiftUI 最佳实践</li>
</ul>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Redis（158）Redis的主从同步问题如何解决？]]></title>    <link>https://juejin.cn/post/7578714735308079130</link>    <guid>https://juejin.cn/post/7578714735308079130</guid>    <pubDate>2025-12-01T22:57:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578714735308079130" data-draft-id="7578709098256105510" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Redis（158）Redis的主从同步问题如何解决？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-01T22:57:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Victor356"/> <meta itemprop="url" content="https://juejin.cn/user/3492507879476878"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Redis（158）Redis的主从同步问题如何解决？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3492507879476878/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Victor356
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-01T22:57:42.000Z" title="Mon Dec 01 2025 22:57:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-01
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Redis的主从同步问题可能会影响数据一致性和可用性。要解决这些问题，我们需要深入了解Redis主从复制机制，并针对具体场景进行优化和故障处理。以下是一些常见的解决方案和代码示例。</p>
<h3 data-id="heading-0">1. 配置主从复制</h3>
<p>首先，通过配置文件和命令设置Redis的主从复制。</p>
<h4 data-id="heading-1">1.1 配置主服务器</h4>
<p>主服务器不需要特别配置，只需正常启动Redis。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 主服务器的 redis.conf 配置示例</span>

<span class="hljs-comment"># 启动主服务器</span>
port 6379
</code></pre>
<h4 data-id="heading-2">1.2 配置从服务器</h4>
<p>在从服务器上配置与主服务器的连接。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 从服务器的 redis.conf 配置示例</span>

<span class="hljs-comment"># 启动从服务器</span>
port 6380

<span class="hljs-comment"># 配置主服务器的IP和端口</span>
replicaof 127.0.0.1 6379
</code></pre>
<h4 data-id="heading-3">1.3 动态设置从服务器</h4>
<p>可以通过命令动态设置从服务器。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> redis.clients.jedis.Jedis;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisReplicationSetup</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-keyword">try</span> (<span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jedis</span>(<span class="hljs-string">"localhost"</span>, <span class="hljs-number">6380</span>)) {
            <span class="hljs-comment">// 设置从服务器连接到主服务器</span>
            jedis.slaveof(<span class="hljs-string">"127.0.0.1"</span>, <span class="hljs-number">6379</span>);
        }
    }
}
</code></pre>
<h3 data-id="heading-4">2. 解决主从同步延迟问题</h3>
<h4 data-id="heading-5">2.1 调整复制缓冲区大小</h4>
<p>增加主服务器的复制缓冲区大小，防止复制过程中断。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 主服务器的 redis.conf 配置示例</span>

<span class="hljs-comment"># 复制缓冲区大小</span>
repl-backlog-size 256mb
</code></pre>
<h4 data-id="heading-6">2.2 调整复制积压缓冲区大小</h4>
<p>调整主服务器的复制积压缓冲区（repl-backlog-size）大小，确保在网络抖动时，从服务器能够快速同步数据。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 主服务器的 redis.conf 配置示例</span>

<span class="hljs-comment"># 复制积压缓冲区大小</span>
repl-backlog-size 256mb
</code></pre>
<h4 data-id="heading-7">2.3 配置延迟监控</h4>
<p>设置复制延迟监控，及时发现并处理延迟问题。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> redis.clients.jedis.Jedis;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisReplicationDelayMonitor</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-keyword">try</span> (<span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jedis</span>(<span class="hljs-string">"localhost"</span>, <span class="hljs-number">6380</span>)) {
            <span class="hljs-comment">// 获取从服务器的复制延迟信息</span>
            <span class="hljs-type">String</span> <span class="hljs-variable">info</span> <span class="hljs-operator">=</span> jedis.info(<span class="hljs-string">"replication"</span>);
            System.out.println(info);
        }
    }
}
</code></pre>
<h3 data-id="heading-8">3. 处理主从切换问题</h3>
<p>使用Redis Sentinel实现自动故障转移，确保高可用性。</p>
<h4 data-id="heading-9">3.1 配置Redis Sentinel</h4>
<p>配置Redis Sentinel监控主服务器，并在主服务器故障时自动切换。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># Sentinel配置文件 sentinel.conf</span>

port 26379

<span class="hljs-comment"># Sentinel监控的主服务器名称及地址和端口</span>
sentinel monitor mymaster 127.0.0.1 6379 2

<span class="hljs-comment"># 主服务器被认为不可用的时间（毫秒）</span>
sentinel down-after-milliseconds mymaster 5000

<span class="hljs-comment"># 故障转移的超时时间（毫秒）</span>
sentinel failover-timeout mymaster 60000

<span class="hljs-comment"># 并行同步的从服务器数量</span>
sentinel parallel-syncs mymaster 1
</code></pre>
<h4 data-id="heading-10">3.2 启动Redis Sentinel</h4>
<pre><code class="hljs language-bash" lang="bash">redis-sentinel /path/to/sentinel.conf
</code></pre>
<h3 data-id="heading-11">4. 处理全量复制和增量复制问题</h3>
<h4 data-id="heading-12">4.1 增加全量复制的性能</h4>
<p>通过配置磁盘写入策略和压缩选项，提高全量复制的性能。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 主服务器的 redis.conf 配置示例</span>

<span class="hljs-comment"># 磁盘写入策略</span>
save 900 1
save 300 10
save 60 10000

<span class="hljs-comment"># 压缩RDB文件</span>
rdbcompression <span class="hljs-built_in">yes</span>
</code></pre>
<h4 data-id="heading-13">4.2 优化增量复制</h4>
<p>确保主从服务器之间的网络连接稳定、低延迟，减少增量复制过程中的数据丢失。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 主服务器的 redis.conf 配置示例</span>

<span class="hljs-comment"># 复制积压缓冲区大小</span>
repl-backlog-size 256mb

<span class="hljs-comment"># 复制超时</span>
repl-timeout 60
</code></pre>
<h3 data-id="heading-14">5. 处理网络分区问题</h3>
<h4 data-id="heading-15">5.1 配置故障转移策略</h4>
<p>通过配置Sentinel的故障转移策略，确保在网络分区时能够正确地进行主从切换。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># Sentinel配置文件 sentinel.conf</span>

<span class="hljs-comment"># Sentinel监控的主服务器名称及地址和端口</span>
sentinel monitor mymaster 127.0.0.1 6379 2

<span class="hljs-comment"># 主服务器被认为不可用的时间（毫秒）</span>
sentinel down-after-milliseconds mymaster 5000

<span class="hljs-comment"># 故障转移的超时时间（毫秒）</span>
sentinel failover-timeout mymaster 60000

<span class="hljs-comment"># 并行同步的从服务器数量</span>
sentinel parallel-syncs mymaster 1

<span class="hljs-comment"># 设置网络分区时的故障转移策略</span>
sentinel config-epoch mymaster 0
sentinel leader-epoch mymaster 0
</code></pre>
<h4 data-id="heading-16">5.2 实现客户端重试机制</h4>
<p>在客户端代码中增加重试机制，确保在网络分区时能够自动重连。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> redis.clients.jedis.Jedis;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisClientRetry</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">maxRetries</span> <span class="hljs-operator">=</span> <span class="hljs-number">3</span>;
        <span class="hljs-type">int</span> <span class="hljs-variable">attempt</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
        <span class="hljs-type">boolean</span> <span class="hljs-variable">connected</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;
        <span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;

        <span class="hljs-keyword">while</span> (attempt &lt; maxRetries &amp;&amp; !connected) {
            <span class="hljs-keyword">try</span> {
                attempt++;
                jedis = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jedis</span>(<span class="hljs-string">"localhost"</span>, <span class="hljs-number">6380</span>);
                <span class="hljs-comment">// 执行Redis操作</span>
                jedis.set(<span class="hljs-string">"key"</span>, <span class="hljs-string">"value"</span>);
                System.out.println(<span class="hljs-string">"Value for 'key': "</span> + jedis.get(<span class="hljs-string">"key"</span>));
                connected = <span class="hljs-literal">true</span>;
            } <span class="hljs-keyword">catch</span> (Exception e) {
                System.err.println(<span class="hljs-string">"Attempt "</span> + attempt + <span class="hljs-string">" failed: "</span> + e.getMessage());
            } <span class="hljs-keyword">finally</span> {
                <span class="hljs-keyword">if</span> (jedis != <span class="hljs-literal">null</span>) {
                    jedis.close();
                }
            }

            <span class="hljs-keyword">if</span> (!connected) {
                <span class="hljs-keyword">try</span> {
                    Thread.sleep(<span class="hljs-number">2000</span>);  <span class="hljs-comment">// 等待2秒后重试</span>
                } <span class="hljs-keyword">catch</span> (InterruptedException e) {
                    Thread.currentThread().interrupt();
                }
            }
        }

        <span class="hljs-keyword">if</span> (!connected) {
            System.err.println(<span class="hljs-string">"Failed to connect to Redis after "</span> + maxRetries + <span class="hljs-string">" attempts."</span>);
        }
    }
}
</code></pre>
<h3 data-id="heading-17">6. 性能监控和优化</h3>
<p>通过Redis自带的监控工具（如<code>INFO</code>命令）或第三方监控工具（如Redis Exporter结合Prometheus和Grafana）来监控主从同步状态，并及时优化。</p>
<h4 data-id="heading-18">6.1 使用<code>INFO</code>命令监控复制状态</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> redis.clients.jedis.Jedis;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisReplicationMonitor</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-keyword">try</span> (<span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jedis</span>(<span class="hljs-string">"localhost"</span>, <span class="hljs-number">6380</span>)) {
            <span class="hljs-comment">// 获取从服务器的复制状态信息</span>
            <span class="hljs-type">String</span> <span class="hljs-variable">info</span> <span class="hljs-operator">=</span> jedis.info(<span class="hljs-string">"replication"</span>);
            System.out.println(info);
        }
    }
}
</code></pre>
<h4 data-id="heading-19">6.2 使用Redis Exporter结合Prometheus和Grafana</h4>
<ol>
<li>
<p><strong>部署Redis Exporter</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">docker run -d --name redis_exporter -p 9121:9121 oliver006/redis_exporter
</code></pre>
</li>
<li>
<p><strong>配置Prometheus监控Redis Exporter</strong>：
在Prometheus配置文件<code>prometheus.yml</code>中添加Redis Exporter的job：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">scrape_configs:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">job_name:</span> <span class="hljs-string">'redis_exporter'</span>
    <span class="hljs-attr">static_configs:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">targets:</span> [<span class="hljs-string">'localhost:9121'</span>]
</code></pre>
</li>
<li>
<p><strong>在Grafana中添加Prometheus数据源并创建监控面板</strong>。</p>
</li>
</ol>
<h3 data-id="heading-20">总结</h3>
<p>通过配置主从复制、优化同步延迟、使用Redis Sentinel处理主从切换、调整全量和增量复制参数、处理网络分区，以及通过监控工具进行性能监控和优化，可以有效解决Redis的主从同步问题。上述代码示例展示了如何通过Java代码结合Jedis库来实现这些优化策略，确保Redis主从同步的稳定性和高效性。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Redis（159）Redis的集群问题如何解决？]]></title>    <link>https://juejin.cn/post/7578724773993627674</link>    <guid>https://juejin.cn/post/7578724773993627674</guid>    <pubDate>2025-12-01T22:58:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578724773993627674" data-draft-id="7578714735308095514" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Redis（159）Redis的集群问题如何解决？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-01T22:58:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Victor356"/> <meta itemprop="url" content="https://juejin.cn/user/3492507879476878"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Redis（159）Redis的集群问题如何解决？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3492507879476878/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Victor356
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-01T22:58:44.000Z" title="Mon Dec 01 2025 22:58:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-01
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Redis集群（Redis Cluster）是一个分布式实现，它通过分片（sharding）机制使数据分布在多个节点上，并提供高可用性和自动故障转移功能。以下是如何解决Redis集群问题的详细步骤，包含具体代码示例。</p>
<h3 data-id="heading-0">1. 配置Redis集群</h3>
<h4 data-id="heading-1">1.1 安装并配置Redis节点</h4>
<p>假设我们有六个Redis节点，分别运行在不同的端口（如7000到7005）。每个节点的配置如下：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># redis.conf 配置示例</span>

port 7000
cluster-enabled <span class="hljs-built_in">yes</span>
cluster-config-file nodes-7000.conf
cluster-node-timeout 5000
appendonly <span class="hljs-built_in">yes</span>
</code></pre>
<p>将上述配置文件分别保存为<code>redis-7000.conf</code>、<code>redis-7001.conf</code>等，然后启动每个Redis实例：</p>
<pre><code class="hljs language-bash" lang="bash">redis-server redis-7000.conf
redis-server redis-7001.conf
<span class="hljs-comment"># 依次启动其他实例</span>
</code></pre>
<h4 data-id="heading-2">1.2 创建Redis集群</h4>
<p>使用<code>redis-cli</code>工具创建集群：</p>
<pre><code class="hljs language-bash" lang="bash">redis-cli --cluster create 127.0.0.1:7000 127.0.0.1:7001 127.0.0.1:7002 127.0.0.1:7003 127.0.0.1:7004 127.0.0.1:7005 --cluster-replicas 1
</code></pre>
<p>此命令将创建一个包含6个节点的集群，每个主节点有一个从节点。</p>
<h3 data-id="heading-3">2. 处理节点故障</h3>
<p>Redis集群能够自动处理主节点故障并进行故障转移。</p>
<h4 data-id="heading-4">2.1 监控节点状态</h4>
<p>可以使用<code>redis-cli</code>命令监控集群节点状态：</p>
<pre><code class="hljs language-bash" lang="bash">redis-cli -p 7000 cluster nodes
</code></pre>
<h4 data-id="heading-5">2.2 自动故障转移</h4>
<p>当主节点故障时，Redis集群会自动将其从节点提升为主节点。确保每个节点的配置文件中包含故障转移相关配置：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># redis.conf 配置示例</span>

cluster-enabled <span class="hljs-built_in">yes</span>
cluster-node-timeout 5000
</code></pre>
<h3 data-id="heading-6">3. 优化集群性能</h3>
<h4 data-id="heading-7">3.1 调整线程数和I/O设置</h4>
<p>可以调整Redis的I/O线程数以提高性能，特别是在高负载情况下：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># redis.conf 配置示例</span>

io-threads 4
io-threads-do-reads <span class="hljs-built_in">yes</span>
</code></pre>
<h4 data-id="heading-8">3.2 调整内存管理</h4>
<p>确保每个节点有足够的内存，并配置内存管理策略：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># redis.conf 配置示例</span>

maxmemory 2gb
maxmemory-policy allkeys-lru
</code></pre>
<h3 data-id="heading-9">4. 集群管理和运维工具</h3>
<p>使用集群管理工具可以简化Redis集群的管理和运维。</p>
<h4 data-id="heading-10">4.1 使用Redis Cluster Manager</h4>
<p>Redis Cluster Manager（<code>redis-trib.rb</code>）是一个官方提供的集群管理工具，可以用来管理和监控Redis集群。</p>
<p>安装Redis Cluster Manager：</p>
<pre><code class="hljs language-bash" lang="bash">gem install redis
</code></pre>
<p>使用Redis Cluster Manager检查集群状态：</p>
<pre><code class="hljs language-bash" lang="bash">redis-trib.rb check 127.0.0.1:7000
</code></pre>
<h4 data-id="heading-11">4.2 使用第三方监控工具</h4>
<p>可以使用Prometheus和Grafana来监控Redis集群的性能和健康状况。</p>
<ol>
<li><strong>部署Redis Exporter</strong>：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">docker run -d --name redis_exporter -p 9121:9121 oliver006/redis_exporter
</code></pre>
<ol start="2">
<li><strong>配置Prometheus监控Redis Exporter</strong>：</li>
</ol>
<p>在Prometheus配置文件<code>prometheus.yml</code>中添加Redis Exporter的job：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">scrape_configs:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">job_name:</span> <span class="hljs-string">'redis_exporter'</span>
    <span class="hljs-attr">static_configs:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">targets:</span> [<span class="hljs-string">'localhost:9121'</span>]
</code></pre>
<ol start="3">
<li><strong>在Grafana中添加Prometheus数据源并创建监控面板</strong>。</li>
</ol>
<h3 data-id="heading-12">5. 集群客户端示例</h3>
<p>使用Jedis Cluster客户端连接Redis集群，进行数据读写操作。</p>
<h4 data-id="heading-13">5.1 引入依赖</h4>
<p>在Maven项目中引入Jedis依赖：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>redis.clients<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jedis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.5.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<h4 data-id="heading-14">5.2 使用Jedis Cluster客户端</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> redis.clients.jedis.HostAndPort;
<span class="hljs-keyword">import</span> redis.clients.jedis.JedisCluster;

<span class="hljs-keyword">import</span> java.util.HashSet;
<span class="hljs-keyword">import</span> java.util.Set;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisClusterExample</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        Set&lt;HostAndPort&gt; jedisClusterNodes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;&gt;();
        jedisClusterNodes.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">HostAndPort</span>(<span class="hljs-string">"127.0.0.1"</span>, <span class="hljs-number">7000</span>));
        jedisClusterNodes.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">HostAndPort</span>(<span class="hljs-string">"127.0.0.1"</span>, <span class="hljs-number">7001</span>));
        jedisClusterNodes.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">HostAndPort</span>(<span class="hljs-string">"127.0.0.1"</span>, <span class="hljs-number">7002</span>));
        jedisClusterNodes.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">HostAndPort</span>(<span class="hljs-string">"127.0.0.1"</span>, <span class="hljs-number">7003</span>));
        jedisClusterNodes.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">HostAndPort</span>(<span class="hljs-string">"127.0.0.1"</span>, <span class="hljs-number">7004</span>));
        jedisClusterNodes.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">HostAndPort</span>(<span class="hljs-string">"127.0.0.1"</span>, <span class="hljs-number">7005</span>));

        <span class="hljs-type">JedisCluster</span> <span class="hljs-variable">jedisCluster</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JedisCluster</span>(jedisClusterNodes);

        <span class="hljs-comment">// 设置键值对</span>
        jedisCluster.set(<span class="hljs-string">"key"</span>, <span class="hljs-string">"value"</span>);
        <span class="hljs-comment">// 获取键值对</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> jedisCluster.get(<span class="hljs-string">"key"</span>);
        System.out.println(<span class="hljs-string">"Value for 'key': "</span> + value);

        <span class="hljs-comment">// 关闭连接</span>
        jedisCluster.close();
    }
}
</code></pre>
<h3 data-id="heading-15">6. 处理集群扩展和缩减</h3>
<h4 data-id="heading-16">6.1 扩展集群</h4>
<p>通过<code>redis-cli</code>工具可以将新的节点添加到集群中：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 启动新节点</span>
redis-server redis-7006.conf

<span class="hljs-comment"># 将新节点加入集群</span>
redis-cli --cluster add-node 127.0.0.1:7006 127.0.0.1:7000
</code></pre>
<h4 data-id="heading-17">6.2 缩减集群</h4>
<p>通过<code>redis-cli</code>工具将节点从集群中移除：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 从集群中移除节点</span>
redis-cli --cluster del-node 127.0.0.1:7000 &lt;node-id&gt;
</code></pre>
<p>其中<code>&lt;node-id&gt;</code>可以通过<code>redis-cli -p 7000 cluster nodes</code>命令获取。</p>
<h3 data-id="heading-18">总结</h3>
<p>通过配置Redis集群、处理节点故障、优化集群性能、使用管理和监控工具，以及扩展和缩减集群，可以有效解决Redis集群问题。上述代码示例展示了如何通过Java代码结合Jedis库来实现这些操作，确保Redis集群的高可用性和高性能。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[LangChain 深入]]></title>    <link>https://juejin.cn/post/7578699975414366208</link>    <guid>https://juejin.cn/post/7578699975414366208</guid>    <pubDate>2025-12-01T18:15:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578699975414366208" data-draft-id="7578697614389755910" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="LangChain 深入"/> <meta itemprop="keywords" content="人工智能,LangChain,Python"/> <meta itemprop="datePublished" content="2025-12-01T18:15:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="吴佳浩"/> <meta itemprop="url" content="https://juejin.cn/user/2696441245481975"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            LangChain 深入
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2696441245481975/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    吴佳浩
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-01T18:15:52.000Z" title="Mon Dec 01 2025 18:15:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-01
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">LangChain 深入</h2>
<blockquote>
<p>这里需要装什么包什么依赖 我就不再一一赘述了  大家可以先看上一篇 <a href="https://juejin.cn/post/7576861477267308563" target="_blank" title="https://juejin.cn/post/7576861477267308563">《Langchain 浅出》</a></p>
<p>那么如果出现缺失的依赖怎么办 ？简单 缺什么装什么</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e2a3016eef8c4ab0933e83e98f1dd875~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC05L2z5rWp:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765217752&amp;x-signature=jda5KnpXLC3Mgba9tHEl4ov%2BPQ0%3D" alt="人工智能的无限可能.png" loading="lazy"/></p>
<h3 data-id="heading-1">目录</h3>
<ul>
<li>1、Python 依赖安装</li>
<li>2、词工程最佳实践</li>
<li>3、性能优化技巧</li>
<li>4、常见问题与解决方案</li>
<li>5、调试和错误处理</li>
<li>6、生产环境最佳实践</li>
</ul>
<blockquote>
<p>想了想还是给补一份基础的依赖吧 ，至于为什么，我也不知道 但是我还是补上了</p>
<p>另外</p>
<p>本章篇幅比较密的代码示例需要个人花点时间理解和消化有问题可以在评论区交流</p>
</blockquote>
<h3 data-id="heading-2">Python 依赖安装（全套覆盖）</h3>
<h4 data-id="heading-3">核心依赖（所有 demo 都需要）</h4>
<pre><code class="hljs language-bash" lang="bash">pip install --upgrade pip setuptools wheel
pip install python-dotenv           <span class="hljs-comment"># 环境变量管理</span>
pip install langchain==1.0.*       <span class="hljs-comment"># LangChain 1.x 核心</span>
pip install langchain-ollama       <span class="hljs-comment"># Ollama LLM 支持</span>
pip install ollama                  <span class="hljs-comment"># Ollama 官方客户端（模型自检/拉取）</span>
</code></pre>
<h4 data-id="heading-4">向量数据库与文档检索（文档助手/检索 demo）</h4>
<pre><code class="hljs language-bash" lang="bash">pip install langchain-chroma        <span class="hljs-comment"># Chroma 向量数据库</span>
pip install langchain-community     <span class="hljs-comment"># 社区扩展功能（额外工具、插件）</span>
pip install chromadb                <span class="hljs-comment"># Chroma 官方依赖</span>
</code></pre>
<h4 data-id="heading-5">文档加载（PDF / Word / 通用文档）</h4>
<pre><code class="hljs language-bash" lang="bash">pip install unstructured           <span class="hljs-comment"># 文本/结构化文档加载</span>
pip install pypdf                   <span class="hljs-comment"># PDF 文档解析</span>
pip install python-docx             <span class="hljs-comment"># Word 文档解析</span>
</code></pre>
<h4 data-id="heading-6">Embeddings / NLP（可选替代 Ollama Embedding）</h4>
<pre><code class="hljs language-bash" lang="bash">pip install sentence-transformers   <span class="hljs-comment"># 文本向量生成，可选</span>
</code></pre>
<h3 data-id="heading-7">词工程最佳实践</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TD
    A[开始] --&gt; B["定义示例数据&lt;br&gt;examples"]
    B --&gt; C["创建PromptTemplate&lt;br&gt;example_prompt"]
    C --&gt; D["设置LengthBasedExampleSelector&lt;br&gt;selector"]
    D --&gt; E["构建FewShotPromptTemplate&lt;br&gt;few_shot"]
    E --&gt; F["初始化ChatOllama模型"]
    F --&gt; G["遍历输入情绪列表"]
    G --&gt; H["格式化提示词&lt;br&gt;few_shot.format()"]
    H --&gt; I["调用模型生成回复&lt;br&gt;llm.invoke()"]
    I --&gt; J["打印回复结果"]
    J --&gt; K{还有更多情绪?}
    K --&gt;|是| G
    K --&gt;|否| END(("END"))

</code></pre>
<p>创建文件 <code>advanced_prompting.py</code>：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-string">"""
高级提示词技巧（基于 LangChain 1.0 + LangGraph）
"""</span>

<span class="hljs-keyword">from</span> langchain_ollama <span class="hljs-keyword">import</span> ChatOllama
<span class="hljs-keyword">from</span> langchain_core.prompts <span class="hljs-keyword">import</span> (
    ChatPromptTemplate, <span class="hljs-comment"># 提示词模板</span>
    SystemMessagePromptTemplate,<span class="hljs-comment"># 系统消息模板</span>
    HumanMessagePromptTemplate,<span class="hljs-comment"># 角色消息模板</span>
    PromptTemplate, <span class="hljs-comment"># 单个示例格式</span>
    FewShotPromptTemplate <span class="hljs-comment"># 少样本学习示例</span>
)
<span class="hljs-keyword">from</span> langchain_core.example_selectors <span class="hljs-keyword">import</span> LengthBasedExampleSelector
<span class="hljs-comment"># from dotenv import load_dotenv 还是和之前一样 因为我们本地使用的ollama基本都是默认的配置所以暂时不加载配置文件 </span>

<span class="hljs-comment"># load_dotenv()</span>


<span class="hljs-keyword">def</span> <span class="hljs-title function_">few_shot_learning</span>():
    <span class="hljs-string">"""少样本学习：通过示例教模型执行任务（LangChain 1.0 风格）"""</span>

    examples = [
        {<span class="hljs-string">"input"</span>: <span class="hljs-string">"开心"</span>, <span class="hljs-string">"output"</span>: <span class="hljs-string">"😊 今天心情真好！"</span>},
        {<span class="hljs-string">"input"</span>: <span class="hljs-string">"难过"</span>, <span class="hljs-string">"output"</span>: <span class="hljs-string">"😢 有些失落，不过会慢慢好起来。"</span>},
        {<span class="hljs-string">"input"</span>: <span class="hljs-string">"兴奋"</span>, <span class="hljs-string">"output"</span>: <span class="hljs-string">"🎉 太棒了！令人振奋的消息！"</span>}
    ]

    <span class="hljs-comment"># 单个示例格式</span>
    example_prompt = PromptTemplate(
        template=<span class="hljs-string">"情绪：{input}\n回复：{output}"</span>,
        input_variables=[<span class="hljs-string">"input"</span>, <span class="hljs-string">"output"</span>],
    )

    <span class="hljs-comment"># 示例选择器（自动选择合适数量）</span>
    selector = LengthBasedExampleSelector(
        examples=examples,
        example_prompt=example_prompt,
        max_length=<span class="hljs-number">100</span>
    )

    few_shot = FewShotPromptTemplate(
        example_selector=selector,
        example_prompt=example_prompt,
        prefix=<span class="hljs-string">"你是一个情感友好的 AI 助手，会用 emoji 回复：\n\n示例："</span>,
        suffix=<span class="hljs-string">"\n情绪：{input}\n回复："</span>,
        input_variables=[<span class="hljs-string">"input"</span>]
    )

    llm = ChatOllama(model=<span class="hljs-string">"qwen3-coder:30b"</span>, temperature=<span class="hljs-number">0.7</span>)

    emotions = [<span class="hljs-string">"激动"</span>, <span class="hljs-string">"焦虑"</span>, <span class="hljs-string">"感动"</span>]

    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n=== 少样本学习示例 ==="</span>)
    <span class="hljs-keyword">for</span> emotion <span class="hljs-keyword">in</span> emotions:
        prompt = few_shot.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">input</span>=emotion)
        res = llm.invoke(prompt)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n情绪：<span class="hljs-subst">{emotion}</span>"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"AI 回复：<span class="hljs-subst">{res.content}</span>"</span>)


<span class="hljs-keyword">def</span> <span class="hljs-title function_">role_based_prompting</span>():
    <span class="hljs-string">"""基于角色的提示词（新版 lc3 PromptTemplate）"""</span>

    system_template = <span class="hljs-string">"""
你是一名{role}。
特点：{characteristics}
回答风格：{style}
"""</span>

    system_msg = SystemMessagePromptTemplate.from_template(system_template)
    human_msg = HumanMessagePromptTemplate.from_template(<span class="hljs-string">"{question}"</span>)

    prompt = ChatPromptTemplate.from_messages([system_msg, human_msg])

    llm = ChatOllama(model=<span class="hljs-string">"qwen3-coder:30b"</span>, temperature=<span class="hljs-number">0.6</span>)

    roles = [
        {
            <span class="hljs-string">"role"</span>: <span class="hljs-string">"资深软件架构师"</span>,
            <span class="hljs-string">"characteristics"</span>: <span class="hljs-string">"熟悉微服务、性能优化、分布式架构"</span>,
            <span class="hljs-string">"style"</span>: <span class="hljs-string">"严谨、专业、会给出架构图示建议"</span>,
            <span class="hljs-string">"question"</span>: <span class="hljs-string">"如何设计一个高并发的电商系统？"</span>
        },
        {
            <span class="hljs-string">"role"</span>: <span class="hljs-string">"耐心的编程老师"</span>,
            <span class="hljs-string">"characteristics"</span>: <span class="hljs-string">"善于用比喻解释复杂概念"</span>,
            <span class="hljs-string">"style"</span>: <span class="hljs-string">"温和、逐步讲解、举例子"</span>,
            <span class="hljs-string">"question"</span>: <span class="hljs-string">"什么是类和对象？"</span>
        }
    ]

    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n=== 基于角色的提示词示例 ==="</span>)
    <span class="hljs-keyword">for</span> config <span class="hljs-keyword">in</span> roles:
        msgs = prompt.format_messages(**config)
        res = llm.invoke(msgs)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n角色：<span class="hljs-subst">{config[<span class="hljs-string">'role'</span>]}</span>"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"回答：<span class="hljs-subst">{res.content}</span>"</span>)


<span class="hljs-keyword">def</span> <span class="hljs-title function_">chain_of_thought_prompting</span>():
    <span class="hljs-string">"""思维链提示（手动 CoT）"""</span>

    llm = ChatOllama(model=<span class="hljs-string">"qwen3-coder:30b"</span>, temperature=<span class="hljs-number">0</span>)

    normal = <span class="hljs-string">"商店有23个苹果，卖出17个，又进了30个，现在有多少？"</span>

    cot = <span class="hljs-string">"""
商店有23个苹果，卖出17个，又进30个。

请按照步骤推理：
1. 卖出后剩余多少
2. 再加上进货数量
3. 计算最终结果
"""</span>

    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n=== 思维链对比 ==="</span>)

    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n【普通提示】"</span>)
    <span class="hljs-built_in">print</span>(llm.invoke(normal).content)

    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n【思维链 CoT】"</span>)
    <span class="hljs-built_in">print</span>(llm.invoke(cot).content)


<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    few_shot_learning()
    role_based_prompting()
    chain_of_thought_prompting()

</code></pre>
<p><strong>输出结果：</strong></p>
<p>太长这里就放个截图示意吧</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f50b0d91f33e410891cda4102177e3c7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC05L2z5rWp:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765217752&amp;x-signature=v4VY0uuiozGm%2F297solQed8QADs%3D" alt="image.png" loading="lazy"/>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a5fb1b68cbb04fa282f0bc06e59bd6fd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC05L2z5rWp:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765217752&amp;x-signature=oHf%2F9EBT7PRBgxV9WmCkelUEcgc%3D" alt="image.png" loading="lazy"/>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7678d9d60b4349428fc5bc400d6eff7d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC05L2z5rWp:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765217752&amp;x-signature=CmSWhqB%2B1DtFYdCbm2kQkXEv8LI%3D" alt="image.png" loading="lazy"/>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9c298bfefd9d419cab14d8eb096dc95d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC05L2z5rWp:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765217752&amp;x-signature=3akGzXE9v3m9ZlpAHX9Y%2BzS6u6w%3D" alt="image.png" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-8">性能优化技巧</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TD
    开始[开始程序] --&gt; 功能选择

    功能选择 --&gt; 缓存示例
    功能选择 --&gt; 批处理示例
    功能选择 --&gt; 流式输出示例

    %% 缓存示例
    缓存示例 --&gt; 创建缓存
    创建缓存 --&gt; 初始化LLM
    初始化LLM --&gt; 第一次调用
    第一次调用 --&gt; 模型推理
    模型推理 --&gt; 存入缓存
    初始化LLM --&gt; 第二次调用
    第二次调用 --&gt; 缓存命中
    缓存命中 --&gt; 缓存完成

    %% 批处理示例
    批处理示例 --&gt; 准备问题列表
    准备问题列表 --&gt; 循环调用
    循环调用 --&gt; 记录耗时1
    准备问题列表 --&gt; 批量调用
    批量调用 --&gt; 记录耗时2
    记录耗时2 --&gt; 批处理完成

    %% 流式输出示例
    流式输出示例 --&gt; 初始化LLM流
    初始化LLM流 --&gt; 调用流方法
    调用流方法 --&gt; 接收分块
    接收分块 --&gt; 流处理完成

    缓存完成 --&gt; 结束
    批处理完成 --&gt; 结束
    流处理完成 --&gt; 结束

</code></pre>
<p>创建文件 <code>optimization_tips.py</code>：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-string">"""
LangChain 1.x 性能优化技巧示例 —— 最新写法（2025）
"""</span>

<span class="hljs-keyword">import</span> time
<span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv
load_dotenv()

<span class="hljs-comment"># LangChain 1.x 最新模块</span>
<span class="hljs-keyword">from</span> langchain_core.caches <span class="hljs-keyword">import</span> InMemoryCache


<span class="hljs-comment"># Ollama LLM</span>
<span class="hljs-keyword">from</span> langchain_ollama <span class="hljs-keyword">import</span> ChatOllama


<span class="hljs-keyword">def</span> <span class="hljs-title function_">caching_example</span>():
    <span class="hljs-string">"""使用缓存减少重复调用"""</span>

    <span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span> * <span class="hljs-number">50</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"缓存优化示例（LangChain 1.x）"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span> * <span class="hljs-number">50</span>)

    <span class="hljs-comment"># 设置全局缓存（官方推荐方式）</span>
    cache = InMemoryCache()

    llm = ChatOllama(model=<span class="hljs-string">"qwen3-coder:30b"</span>, temperature=<span class="hljs-number">0.7</span>,cache=cache)

    question = <span class="hljs-string">"什么是机器学习？"</span>

    <span class="hljs-comment"># 第一次调用（非缓存）</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n问题：<span class="hljs-subst">{question}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"第一次调用（未缓存）..."</span>)
    start = time.time()
    response1 = llm.invoke(question)
    time1 = time.time() - start
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"耗时：<span class="hljs-subst">{time1:<span class="hljs-number">.2</span>f}</span> 秒"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"答案：<span class="hljs-subst">{response1.content[:<span class="hljs-number">100</span>]}</span>..."</span>)

    <span class="hljs-comment"># 第二次调用（缓存命中）</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n第二次调用（已缓存）..."</span>)
    start = time.time()
    response2 = llm.invoke(question)
    time2 = time.time() - start
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"耗时：<span class="hljs-subst">{time2:<span class="hljs-number">.2</span>f}</span> 秒"</span>)
    <span class="hljs-keyword">if</span> time2 == <span class="hljs-number">0</span>:
     <span class="hljs-built_in">print</span>(<span class="hljs-string">"🚀 速度提升：∞（缓存命中，耗时约 0 秒）"</span>)
    <span class="hljs-keyword">else</span>:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"🚀 速度提升：<span class="hljs-subst">{time1/time2:<span class="hljs-number">.1</span>f}</span> 倍"</span>)


<span class="hljs-keyword">def</span> <span class="hljs-title function_">batch_processing</span>():
    <span class="hljs-string">"""批量处理以减少网络调用"""</span>

    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n"</span> + <span class="hljs-string">"="</span> * <span class="hljs-number">50</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"批量处理示例（LangChain 1.x）"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span> * <span class="hljs-number">50</span>)

    llm = ChatOllama(model=<span class="hljs-string">"qwen3-coder:30b"</span>, temperature=<span class="hljs-number">0.7</span>)

    questions = [
        <span class="hljs-string">"Python 是什么？"</span>,
        <span class="hljs-string">"Java 是什么？"</span>,
        <span class="hljs-string">"JavaScript 是什么？"</span>
    ]

    <span class="hljs-comment"># 方式1：逐个处理</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n方式1：逐个调用 invoke()"</span>)
    start = time.time()
    <span class="hljs-keyword">for</span> q <span class="hljs-keyword">in</span> questions:
        llm.invoke(q)
    time1 = time.time() - start
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"总耗时：<span class="hljs-subst">{time1:<span class="hljs-number">.2</span>f}</span> 秒"</span>)

    <span class="hljs-comment"># 方式2：批量处理（LangChain 1.x 推荐）</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n方式2：使用 llm.batch()"</span>)
    start = time.time()
    responses = llm.batch(questions)
    time2 = time.time() - start
    <span class="hljs-keyword">if</span> time2 == <span class="hljs-number">0</span>:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"🚀 速度提升：∞（缓存命中，耗时约 0 秒）"</span>)
    <span class="hljs-keyword">else</span>:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"🚀 速度提升：<span class="hljs-subst">{time1/time2:<span class="hljs-number">.1</span>f}</span> 倍"</span>)


<span class="hljs-keyword">def</span> <span class="hljs-title function_">streaming_output</span>():
    <span class="hljs-string">"""流式输出，提升用户体验"""</span>

    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n"</span> + <span class="hljs-string">"="</span> * <span class="hljs-number">50</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"流式输出示例（LangChain 1.x）"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span> * <span class="hljs-number">50</span>)

    <span class="hljs-comment"># 流式输出无需 streaming=True</span>
    llm = ChatOllama(
        model=<span class="hljs-string">"qwen3-coder:30b"</span>,
        temperature=<span class="hljs-number">0.7</span>,
    )

    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n生成中："</span>, end=<span class="hljs-string">""</span>, flush=<span class="hljs-literal">True</span>)

    <span class="hljs-comment"># LangChain 1.x 官方写法：llm.stream()</span>
    <span class="hljs-keyword">for</span> chunk <span class="hljs-keyword">in</span> llm.stream(<span class="hljs-string">"请用100字介绍人工智能的发展历史"</span>):
        <span class="hljs-built_in">print</span>(chunk.content, end=<span class="hljs-string">""</span>, flush=<span class="hljs-literal">True</span>)

    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n"</span>)


<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    caching_example()
    batch_processing()
    streaming_output()


</code></pre>
<p><strong>输出结果:</strong></p>
<pre><code class="hljs language-bash" lang="bash">==================================================
缓存优化示例（LangChain 1.x）
==================================================

问题：什么是机器学习？
第一次调用（未缓存）...
耗时：1.35 秒
答案：机器学习是人工智能的一个重要分支，它让计算机能够在不被明确编程的情况下，通过分析大量数据来自动学习和改进。

<span class="hljs-comment">## 核心概念</span>
机器学习让计算机从经验中学习规律，并利用这些规律对新的、未见过的数据进行预...

第二次调用（已缓存）...
耗时：0.00 秒
🚀 速度提升：∞（缓存命中，耗时约 0 秒）

==================================================
批量处理示例（LangChain 1.x）
==================================================

方式1：逐个调用 invoke()
总耗时：4.56 秒

方式2：使用 llm.batch()
🚀 速度提升：1.0 倍

==================================================
流式输出示例（LangChain 1.x）
==================================================

生成中：人工智能发展可追溯至1950年代。1956年达特茅斯会议正式确立AI概念。经历了多次起伏：1970年代专家系统兴起，1980年代遭遇<span class="hljs-string">"AI寒冬"</span>，1990年代机器学习兴起。21世纪后，大数据、深度学习技术突破，AI迎来快速发展期，在图像识
别、自然语言处理等领域取得重大进展，正深刻改变着人类生活。

(venv) PS D:\softwares\langchin_learning&gt; 
</code></pre>
<hr/>
<h3 data-id="heading-9">常见问题与解决方案（1.0 版本）</h3>
<h3 data-id="heading-10">1. 模型初始化与 API Key</h3>
<p><strong>问题</strong>：模型无法调用或报错</p>
<p><strong>解决方案</strong>：</p>
<ul>
<li>
<p>对 <strong>OpenAI</strong>：检查 API Key 是否正确，确保环境变量已加载</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv
load_dotenv()
api_key = os.getenv(<span class="hljs-string">"OPENAI_API_KEY"</span>)
</code></pre>
</li>
<li>
<p>对 <strong>ChatOllama / 本地 Ollama 模型</strong>：无需网络 API，只要 Ollama Server 已启动即可</p>
<pre><code class="hljs language-bash" lang="bash">ollama list  <span class="hljs-comment"># 检查模型是否可用</span>
</code></pre>
</li>
<li>
<p>确保 <strong>虚拟环境</strong>正确激活，并安装最新依赖：</p>
<pre><code class="hljs language-bash" lang="bash">pip install -U langchain langchain-ollama python-dotenv
</code></pre>
</li>
</ul>
<hr/>
<h3 data-id="heading-11">2. 依赖包版本冲突</h3>
<p><strong>问题</strong>：<code>ImportError</code> 或模块版本不兼容</p>
<p><strong>解决方案</strong>：</p>
<ul>
<li>
<p>使用虚拟环境隔离项目依赖（venv / conda / poetry）</p>
</li>
<li>
<p>升级至最新版本：</p>
<pre><code class="hljs language-bash" lang="bash">pip install --upgrade langchain langchain-ollama python-dotenv
</code></pre>
</li>
<li>
<p>确保 Python 版本 <strong>3.9 以上</strong></p>
</li>
</ul>
<hr/>
<h3 data-id="heading-12">3. 网络与本地服务连接问题</h3>
<p><strong>问题</strong>：模型无法访问</p>
<p><strong>解决方案</strong>：</p>
<ul>
<li>
<p><strong>OpenAI</strong>：确保网络可用，必要时配置代理</p>
</li>
<li>
<p><strong>ChatOllama（本地模型）</strong>：</p>
<ul>
<li>
<p>Ollama Server 必须启动</p>
</li>
<li>
<p>使用命令检查模型列表：</p>
<pre><code class="hljs language-bash" lang="bash">ollama list
</code></pre>
</li>
<li>
<p>测试本地端口：</p>
<pre><code class="hljs language-bash" lang="bash">curl http://localhost:11434
</code></pre>
</li>
</ul>
</li>
</ul>
<hr/>
<h3 data-id="heading-13">4. Token 限制或显存问题</h3>
<p><strong>问题</strong>：模型响应超时或显存不足</p>
<p><strong>解决方案</strong>：</p>
<ul>
<li>
<p><strong>OpenAI</strong>：注意速率限制（RateLimit），可降低请求频率或批量调用</p>
</li>
<li>
<p><strong>本地 Ollama</strong>：</p>
<ul>
<li>
<p>没有调用次数限制，但受显卡显存影响</p>
</li>
<li>
<p>可选择小模型，如：</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">Qwen2.5:3B &lt; Qwen2.5:7B &lt; Qwen3-coder:30B</span>
</code></pre>
</li>
</ul>
</li>
<li>
<p>对于超长 Prompt：建议分段或使用 <code>llm.batch()</code> 批量调用</p>
</li>
</ul>
<hr/>
<h3 data-id="heading-14">5. 流式输出与回调问题</h3>
<p><strong>问题</strong>：流式输出不生效或回调不触发</p>
<p><strong>解决方案</strong>：</p>
<ul>
<li>
<p><strong>流式输出</strong>：</p>
<ul>
<li>
<p>最新 LangChain 1.x 不再使用 <code>streaming=True</code> 参数</p>
</li>
<li>
<p>正确方法：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">for</span> chunk <span class="hljs-keyword">in</span> llm.stream(<span class="hljs-string">"你的 Prompt"</span>):
    <span class="hljs-built_in">print</span>(chunk.content, end=<span class="hljs-string">""</span>)
</code></pre>
</li>
</ul>
</li>
<li>
<p><strong>回调</strong>：</p>
<ul>
<li>
<p>使用 <code>langchain_core.callbacks.BaseCallbackHandler</code> 编写自定义回调</p>
</li>
<li>
<p>确保在 LLM 或 Runnable 初始化时传入：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_core.callbacks <span class="hljs-keyword">import</span> CallbackManager, BaseCallbackHandler

<span class="hljs-keyword">class</span> <span class="hljs-title class_">MyHandler</span>(<span class="hljs-title class_ inherited__">BaseCallbackHandler</span>):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">on_llm_new_token</span>(<span class="hljs-params">self, token</span>):
        <span class="hljs-built_in">print</span>(token, end=<span class="hljs-string">""</span>)

callback_manager = CallbackManager([MyHandler()])
llm = ChatOllama(model=<span class="hljs-string">"Qwen2.5:7b"</span>, callback_manager=callback_manager)
</code></pre>
</li>
</ul>
</li>
</ul>
<hr/>
<h3 data-id="heading-15">6. 其他常见问题</h3>
<ul>
<li>
<p><strong>缓存未生效</strong>：确保使用最新 <code>InMemoryCache</code> 或 <code>PersistentCache</code>，并传入 LLM：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_core.caches <span class="hljs-keyword">import</span> InMemoryCache
llm = ChatOllama(model=<span class="hljs-string">"Qwen2.5:7b"</span>, cache=InMemoryCache())
</code></pre>
</li>
<li>
<p><strong>批量调用报错</strong>：检查输入是 <strong>list[str]</strong>，使用 <code>.batch()</code> 方法</p>
</li>
<li>
<p><strong>超长输出截断</strong>：可使用 <code>max_tokens</code> 参数或分段请求</p>
</li>
</ul>
<hr/>
<h3 data-id="heading-16">调试和错误处理</h3>
<p>创建文件 <code>debugging_guide.py</code>：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-string">"""
LangChain 1.x 调试与错误处理示例 —— 最新写法（2025）
"""</span>

<span class="hljs-keyword">import</span> logging
<span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv
load_dotenv()

<span class="hljs-comment"># 最新 LangChain 1.x 模块</span>
<span class="hljs-keyword">from</span> langchain_ollama <span class="hljs-keyword">import</span> ChatOllama
<span class="hljs-keyword">from</span> langchain_core.callbacks <span class="hljs-keyword">import</span> StdOutCallbackHandler

<span class="hljs-comment"># 配置日志</span>
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)


<span class="hljs-keyword">def</span> <span class="hljs-title function_">verbose_mode_example</span>():
    <span class="hljs-string">"""使用回调追踪详细执行过程（替代旧的 LLMChain + verbose）"""</span>
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span> * <span class="hljs-number">50</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"Verbose 模式示例"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span> * <span class="hljs-number">50</span>)
    
    <span class="hljs-comment"># 初始化 Ollama LLM</span>
    llm = ChatOllama(model=<span class="hljs-string">"qwen3-coder:30b"</span>, temperature=<span class="hljs-number">0.7</span>)
    
    <span class="hljs-comment"># 回调处理器打印详细信息</span>
    handler = StdOutCallbackHandler()
    
    <span class="hljs-comment"># 直接调用 LLM 并传入回调</span>
    response = llm.invoke(
        <span class="hljs-string">"请用一句话介绍量子计算"</span>,
        config={<span class="hljs-string">"callbacks"</span>: [handler]}
    )
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n最终结果：<span class="hljs-subst">{response.content}</span>"</span>)


<span class="hljs-keyword">def</span> <span class="hljs-title function_">callback_example</span>():
    <span class="hljs-string">"""使用回调处理器追踪 LLM 调用"""</span>
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n"</span> + <span class="hljs-string">"="</span> * <span class="hljs-number">50</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"回调处理器示例"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span> * <span class="hljs-number">50</span>)
    
    llm = ChatOllama(model=<span class="hljs-string">"qwen3-coder:30b"</span>, temperature=<span class="hljs-number">0.7</span>)
    
    handler = StdOutCallbackHandler()
    
    response = llm.invoke(
        <span class="hljs-string">"什么是区块链？"</span>,
        config={<span class="hljs-string">"callbacks"</span>: [handler]}
    )
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n答案：<span class="hljs-subst">{response.content}</span>"</span>)


<span class="hljs-keyword">def</span> <span class="hljs-title function_">error_handling_example</span>():
    <span class="hljs-string">"""错误处理最佳实践"""</span>
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n"</span> + <span class="hljs-string">"="</span> * <span class="hljs-number">50</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"错误处理示例"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span> * <span class="hljs-number">50</span>)
    
    llm = ChatOllama(model=<span class="hljs-string">"qwen3-coder:30b"</span>, temperature=<span class="hljs-number">0.7</span>)
    
    <span class="hljs-keyword">try</span>:
        response = llm.invoke(<span class="hljs-string">"测试问题"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"成功：<span class="hljs-subst">{response.content}</span>"</span>)
        
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        logger.error(<span class="hljs-string">f"调用 LLM 出错: <span class="hljs-subst">{<span class="hljs-built_in">type</span>(e).__name__}</span>"</span>)
        logger.error(<span class="hljs-string">f"错误详情: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>)
        
        err_msg = <span class="hljs-built_in">str</span>(e).lower()
        <span class="hljs-keyword">if</span> <span class="hljs-string">"rate_limit"</span> <span class="hljs-keyword">in</span> err_msg:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"触发速率限制，请稍后重试"</span>)
        <span class="hljs-keyword">elif</span> <span class="hljs-string">"authentication"</span> <span class="hljs-keyword">in</span> err_msg:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"API 密钥错误，请检查配置"</span>)
        <span class="hljs-keyword">elif</span> <span class="hljs-string">"timeout"</span> <span class="hljs-keyword">in</span> err_msg:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"请求超时，请检查网络"</span>)
        <span class="hljs-keyword">else</span>:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"未知错误：<span class="hljs-subst">{e}</span>"</span>)


<span class="hljs-keyword">def</span> <span class="hljs-title function_">token_counting</span>():
    <span class="hljs-string">"""Token 计数示例（仅适用于 OpenAI API）"""</span>
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n"</span> + <span class="hljs-string">"="</span> * <span class="hljs-number">50</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"Token 计数示例"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span> * <span class="hljs-number">50</span>)
    
    llm = ChatOllama(model=<span class="hljs-string">"qwen3-coder:30b"</span>, temperature=<span class="hljs-number">0.7</span>)
    
    <span class="hljs-comment"># Ollama 本地模型无法使用 get_openai_callback</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"⚠ Ollama 本地模型不支持 OpenAI Token 计数，此示例仅供 OpenAI API 使用"</span>)
    
    <span class="hljs-comment"># OpenAI 可用写法（保留示例）</span>
    <span class="hljs-string">"""
    from langchain_core.callbacks import get_openai_callback
    with get_openai_callback() as cb:
        response = llm.invoke("请详细介绍 Python 编程语言的特点和应用场景")
        print(f"答案：{response.content}")
        print(f"总 Token：{cb.total_tokens}, 提示词 Token：{cb.prompt_tokens}, 响应 Token：{cb.completion_tokens}")
        print(f"总成本：${cb.total_cost:.4f}")
    """</span>


<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    verbose_mode_example()
    callback_example()
    error_handling_example()
    token_counting()

</code></pre>
<p><strong>输出结果:</strong></p>
<pre><code class="hljs language-bash" lang="bash">==================================================
Verbose 模式示例
==================================================
INFO:httpx:HTTP Request: POST http://127.0.0.1:11434/api/chat <span class="hljs-string">"HTTP/1.1 200 OK"</span>

最终结果：量子计算是一种利用量子比特的叠加和纠缠特性进行并行计算的新型计算方式，能够在某些特定问题上实现指数级的计算速度提升。

==================================================
回调处理器示例
==================================================
INFO:httpx:HTTP Request: POST http://127.0.0.1:11434/api/chat <span class="hljs-string">"HTTP/1.1 200 OK"</span>

答案：区块链是一种**分布式数据库技术**，它将数据存储在按时间顺序链接的区块中，每个区块都包含前一个区块的加密哈希值，形成一个不可篡改的链式结构。

<span class="hljs-comment">## 核心特征</span>

**1. 去中心化**
- 没有单一控制者
- 多个节点共同维护网络

**2. 不可篡改**
- 一旦数据写入就很难修改
- 修改需要网络中大多数节点同意

**3. 透明可追溯**
- 所有交易记录公开可见
- 可以追踪数据的完整历史

<span class="hljs-comment">## 工作原理</span>

1. **区块创建**：新数据被打包成区块
2. **加密验证**：通过密码学算法验证区块
3. **网络共识**：多个节点确认区块有效性
4. **链式连接**：新区块链接到现有链上

<span class="hljs-comment">## 主要应用</span>
- **加密货币**：比特币、以太坊等
- **智能合约**：自动执行的合约协议
- **供应链管理**：商品溯源追踪
- **数字身份**：身份认证和管理
- **医疗记录**：安全存储和共享

区块链技术正在多个领域发挥重要作用，为数据安全和信任建立提供了新的解决方案。

==================================================
错误处理示例
==================================================
INFO:httpx:HTTP Request: POST http://127.0.0.1:11434/api/chat <span class="hljs-string">"HTTP/1.1 200 OK"</span>
成功：您好！我注意到您提到了<span class="hljs-string">"测试问题"</span>，但我没有看到具体需要测试的内容。为了更好地帮助您，能否请您：

1. **说明具体需要测试什么？**
   - 是技术问题、逻辑问题、还是其他类型的测试？
   - 请提供详细的问题描述

2. **告知测试的背景**
   - 这是关于什么领域的测试？
   - 有什么特殊要求吗？

3. **提供相关材料**
   - 如果有代码、数据或其他资料，请一并提供

请补充这些信息，我就能为您提供更准确和有用的测试帮助了。期待您的详细说明！

==================================================
Token 计数示例
==================================================
⚠ Ollama 本地模型不支持 OpenAI Token 计数，此示例仅供 OpenAI API 使用
</code></pre>
<hr/>
<h3 data-id="heading-17">生产环境最佳实践</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant 用户
    participant 日志系统
    participant 限流器
    participant LLM客户端
    participant Ollama模型

    用户-&gt;&gt;日志系统: 发送请求 "问题 X"
    日志系统-&gt;&gt;日志系统: 记录收到的请求
    日志系统-&gt;&gt;限流器: 检查请求是否允许
    alt 请求被允许
        限流器--&gt;&gt;日志系统: 允许
        日志系统-&gt;&gt;LLM客户端: 调用 safe_generate()
        LLM客户端-&gt;&gt;LLM客户端: validate_input()
        alt 输入有效
            LLM客户端-&gt;&gt;LLM客户端: retry_on_failure
            LLM客户端-&gt;&gt;Ollama模型: invoke(prompt)
            Ollama模型--&gt;&gt;LLM客户端: 返回生成内容
            LLM客户端--&gt;&gt;日志系统: 响应生成成功
            日志系统--&gt;&gt;用户: 返回响应内容
        else 输入无效
            LLM客户端--&gt;&gt;日志系统: 输入验证失败
            日志系统--&gt;&gt;用户: 返回错误信息
        end
    else 请求被限制
        限流器--&gt;&gt;日志系统: 超过速率限制
        日志系统--&gt;&gt;用户: 返回限制提示
    end

</code></pre>
<p>创建文件 <code>production_best_practices.py</code>：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-string">"""
生产环境部署最佳实践（LangChain 1.0 + Ollama）
"""</span>

<span class="hljs-keyword">from</span> langchain_ollama <span class="hljs-keyword">import</span> ChatOllama
<span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv
<span class="hljs-keyword">import</span> os
<span class="hljs-keyword">import</span> time
<span class="hljs-keyword">from</span> functools <span class="hljs-keyword">import</span> wraps
<span class="hljs-keyword">from</span> collections <span class="hljs-keyword">import</span> deque
<span class="hljs-keyword">import</span> logging

load_dotenv()

<span class="hljs-comment"># =========================</span>
<span class="hljs-comment"># 重试装饰器</span>
<span class="hljs-comment"># =========================</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">retry_on_failure</span>(<span class="hljs-params">max_retries=<span class="hljs-number">3</span>, delay=<span class="hljs-number">1</span></span>):
    <span class="hljs-string">"""自动重试失败的请求"""</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">decorator</span>(<span class="hljs-params">func</span>):
<span class="hljs-meta">        @wraps(<span class="hljs-params">func</span>)</span>
        <span class="hljs-keyword">def</span> <span class="hljs-title function_">wrapper</span>(<span class="hljs-params">*args, **kwargs</span>):
            <span class="hljs-keyword">for</span> attempt <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(max_retries):
                <span class="hljs-keyword">try</span>:
                    <span class="hljs-keyword">return</span> func(*args, **kwargs)
                <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
                    <span class="hljs-keyword">if</span> attempt &lt; max_retries - <span class="hljs-number">1</span>:
                        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"尝试 <span class="hljs-subst">{attempt + <span class="hljs-number">1</span>}</span> 失败: <span class="hljs-subst">{e}</span>"</span>)
                        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"等待 <span class="hljs-subst">{delay}</span> 秒后重试..."</span>)
                        time.sleep(delay * (attempt + <span class="hljs-number">1</span>))
                    <span class="hljs-keyword">else</span>:
                        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"所有 <span class="hljs-subst">{max_retries}</span> 次尝试均失败"</span>)
                        <span class="hljs-keyword">raise</span>
        <span class="hljs-keyword">return</span> wrapper
    <span class="hljs-keyword">return</span> decorator

<span class="hljs-comment"># =========================</span>
<span class="hljs-comment"># 生产环境 LLM 客户端</span>
<span class="hljs-comment"># =========================</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductionLLMClient</span>:
    <span class="hljs-string">"""生产环境 LLM 客户端封装（Ollama）"""</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        <span class="hljs-comment"># 从环境变量读取配置</span>
        self.model = os.getenv(<span class="hljs-string">"LLM_MODEL"</span>, <span class="hljs-string">"Qwen2.5:7b"</span>)
        self.temperature = <span class="hljs-built_in">float</span>(os.getenv(<span class="hljs-string">"LLM_TEMPERATURE"</span>, <span class="hljs-string">"0.7"</span>))
        self.max_tokens = <span class="hljs-built_in">int</span>(os.getenv(<span class="hljs-string">"LLM_MAX_TOKENS"</span>, <span class="hljs-string">"500"</span>))

        <span class="hljs-comment"># 初始化 Ollama LLM</span>
        self.llm = ChatOllama(
            model=self.model,
            temperature=self.temperature,
            max_tokens=self.max_tokens,
            streaming=<span class="hljs-literal">False</span>
        )

        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"✓ LLM 客户端初始化完成"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  模型: <span class="hljs-subst">{self.model}</span>"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  温度: <span class="hljs-subst">{self.temperature}</span>"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  最大 Token: <span class="hljs-subst">{self.max_tokens}</span>"</span>)

<span class="hljs-meta">    @retry_on_failure(<span class="hljs-params">max_retries=<span class="hljs-number">3</span>, delay=<span class="hljs-number">2</span></span>)</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">generate</span>(<span class="hljs-params">self, prompt</span>):
        <span class="hljs-string">"""生成响应（带重试机制）"""</span>
        <span class="hljs-keyword">try</span>:
            response = self.llm.invoke(prompt)
            <span class="hljs-keyword">return</span> response.content
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"生成失败: <span class="hljs-subst">{e}</span>"</span>)
            <span class="hljs-keyword">raise</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">validate_input</span>(<span class="hljs-params">self, text, max_length=<span class="hljs-number">1000</span></span>):
        <span class="hljs-string">"""验证输入合法性"""</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> text <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">isinstance</span>(text, <span class="hljs-built_in">str</span>):
            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(text) &gt; max_length:
            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">safe_generate</span>(<span class="hljs-params">self, user_input</span>):
        <span class="hljs-string">"""安全生成响应"""</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> self.validate_input(user_input):
            <span class="hljs-keyword">return</span> {<span class="hljs-string">"success"</span>: <span class="hljs-literal">False</span>, <span class="hljs-string">"error"</span>: <span class="hljs-string">"输入无效或过长"</span>}
        <span class="hljs-keyword">try</span>:
            response = self.generate(user_input)
            <span class="hljs-keyword">return</span> {<span class="hljs-string">"success"</span>: <span class="hljs-literal">True</span>, <span class="hljs-string">"response"</span>: response}
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-keyword">return</span> {<span class="hljs-string">"success"</span>: <span class="hljs-literal">False</span>, <span class="hljs-string">"error"</span>: <span class="hljs-built_in">str</span>(e)}

<span class="hljs-comment"># =========================</span>
<span class="hljs-comment"># 日志示例</span>
<span class="hljs-comment"># =========================</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">logging_example</span>():
    logging.basicConfig(
        level=logging.INFO,
        <span class="hljs-built_in">format</span>=<span class="hljs-string">'%(asctime)s - %(name)s - %(levelname)s - %(message)s'</span>,
        handlers=[logging.FileHandler(<span class="hljs-string">'langchain_app.log'</span>), logging.StreamHandler()]
    )
    logger = logging.getLogger(__name__)

    <span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span> * <span class="hljs-number">50</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"日志记录示例"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span> * <span class="hljs-number">50</span>)

    client = ProductionLLMClient()
    user_input = <span class="hljs-string">"什么是机器学习？"</span>
    logger.info(<span class="hljs-string">f"收到用户请求: <span class="hljs-subst">{user_input}</span>"</span>)

    result = client.safe_generate(user_input)
    <span class="hljs-keyword">if</span> result[<span class="hljs-string">"success"</span>]:
        logger.info(<span class="hljs-string">"响应生成成功"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n响应: <span class="hljs-subst">{result[<span class="hljs-string">'response'</span>]}</span>"</span>)
    <span class="hljs-keyword">else</span>:
        logger.error(<span class="hljs-string">f"响应生成失败: <span class="hljs-subst">{result[<span class="hljs-string">'error'</span>]}</span>"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n错误: <span class="hljs-subst">{result[<span class="hljs-string">'error'</span>]}</span>"</span>)

<span class="hljs-comment"># =========================</span>
<span class="hljs-comment"># 速率限制示例</span>
<span class="hljs-comment"># =========================</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">rate_limiting_example</span>():
    <span class="hljs-keyword">class</span> <span class="hljs-title class_">RateLimiter</span>:
        <span class="hljs-string">"""简单速率限制器"""</span>
        <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, max_calls, time_window</span>):
            self.max_calls = max_calls
            self.time_window = time_window
            self.calls = deque()

        <span class="hljs-keyword">def</span> <span class="hljs-title function_">allow_request</span>(<span class="hljs-params">self</span>):
            now = time.time()
            <span class="hljs-keyword">while</span> self.calls <span class="hljs-keyword">and</span> self.calls[<span class="hljs-number">0</span>] &lt; now - self.time_window:
                self.calls.popleft()
            <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(self.calls) &lt; self.max_calls:
                self.calls.append(now)
                <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>
            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>

    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n"</span> + <span class="hljs-string">"="</span> * <span class="hljs-number">50</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"速率限制示例"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span> * <span class="hljs-number">50</span>)

    limiter = RateLimiter(max_calls=<span class="hljs-number">5</span>, time_window=<span class="hljs-number">60</span>)
    client = ProductionLLMClient()

    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):
        <span class="hljs-keyword">if</span> limiter.allow_request():
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n请求 <span class="hljs-subst">{i+<span class="hljs-number">1</span>}</span>: 允许"</span>)
            result = client.safe_generate(<span class="hljs-string">f"问题 <span class="hljs-subst">{i+<span class="hljs-number">1</span>}</span>"</span>)
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"响应: <span class="hljs-subst">{result.get(<span class="hljs-string">'response'</span>, result.get(<span class="hljs-string">'error'</span>))[:<span class="hljs-number">50</span>]}</span>..."</span>)
        <span class="hljs-keyword">else</span>:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n请求 <span class="hljs-subst">{i+<span class="hljs-number">1</span>}</span>: 被限制（超过速率限制）"</span>)

<span class="hljs-comment"># =========================</span>
<span class="hljs-comment"># 主函数</span>
<span class="hljs-comment"># =========================</span>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    logging_example()
    rate_limiting_example()

</code></pre>
<p><strong>输出结果:</strong></p>
<pre><code class="hljs language-bash" lang="bash">==================================================
日志记录示例
==================================================
✓ LLM 客户端初始化完成
  模型: qwen3-coder:30b
  温度: 0.7
  最大 Token: 500
2025-12-02 01:20:12,445 - __main__ - INFO - 收到用户请求: 什么是机器学习？
2025-12-02 01:20:12,649 - httpx - INFO - HTTP Request: POST http://127.0.0.1:11434/api/chat <span class="hljs-string">"HTTP/1.1 200 OK"</span>
2025-12-02 01:20:14,011 - __main__ - INFO - 响应生成成功

响应: 机器学习是人工智能的一个重要分支，它让计算机能够在不被明确编程的情况下，通过分析大量数据来自动学习和改进。

<span class="hljs-comment">## 核心概念</span>
机器学习让计算机从数据中<span class="hljs-string">"学习"</span>规律和模式，然后利用这些知识对新的、未见过的数据进行预测或决策。

<span class="hljs-comment">## 工作原理</span>
1. **输入数据** - 提供大量带有标签或无标签的数据
2. **算法学习** - 机器学习算法分析数据中的模式
3. **建立模型** - 构建能够识别模式的数学模型
4. **预测应用** - 对新数据进行预测或分类

<span class="hljs-comment">## 主要类型</span>
- **监督学习** - 使用带标签的数据训练
- **无监督学习** - 从未标记数据中发现隐藏模式
- **强化学习** - 通过与环境交互来学习最优行为

<span class="hljs-comment">## 常见应用</span>
- 图像识别和人脸识别
- 语音助手（如Siri、Alexa）
- 推荐系统（如抖音、淘宝推荐）
- 自动驾驶汽车
- 医疗诊断辅助
- 金融风险评估

机器学习正在深刻改变我们的生活，让许多以前需要人类智能才能完成的任务变得自动化。

==================================================
速率限制示例
==================================================
✓ LLM 客户端初始化完成
  模型: qwen3-coder:30b
  温度: 0.7
  最大 Token: 500

请求 1: 允许
2025-12-02 01:20:14,109 - httpx - INFO - HTTP Request: POST http://127.0.0.1:11434/api/chat <span class="hljs-string">"HTTP/1.1 200 OK"</span>
响应: 您好！我注意到您提到了<span class="hljs-string">"问题 1"</span>，但我没有看到具体的问题内容。请您提供需要解决的问题，我会很乐意帮...

请求 2: 允许
2025-12-02 01:20:14,529 - httpx - INFO - HTTP Request: POST http://127.0.0.1:11434/api/chat <span class="hljs-string">"HTTP/1.1 200 OK"</span>
响应: 我注意到您提到了<span class="hljs-string">"问题 2"</span>，但我没有看到具体的问题内容。请您提供需要解答的具体问题，我会很乐意帮助...

请求 3: 允许
2025-12-02 01:20:14,948 - httpx - INFO - HTTP Request: POST http://127.0.0.1:11434/api/chat <span class="hljs-string">"HTTP/1.1 200 OK"</span>
响应: 我需要更多信息来帮助您解决<span class="hljs-string">"问题 3"</span>。您能提供以下信息吗：

1. **具体问题内容** - 您想...

请求 4: 允许
2025-12-02 01:20:15,564 - httpx - INFO - HTTP Request: POST http://127.0.0.1:11434/api/chat <span class="hljs-string">"HTTP/1.1 200 OK"</span>
响应: 我需要更多信息来帮助您解决<span class="hljs-string">"问题4"</span>。您能提供：

1. **具体的问题内容** - 您想解决什么问...

请求 5: 允许
2025-12-02 01:20:16,073 - httpx - INFO - HTTP Request: POST http://127.0.0.1:11434/api/chat <span class="hljs-string">"HTTP/1.1 200 OK"</span>
响应: 我需要更多信息来帮助您解决<span class="hljs-string">"问题 5"</span>。您能提供：

1. **具体的问题内容** - 您想解决什么...

请求 6: 被限制（超过速率限制）

请求 7: 被限制（超过速率限制）
</code></pre>
<hr/>
<h3 data-id="heading-18">常见应用场景</h3>
<h4 data-id="heading-19">场景 1：智能客服机器人</h4>
<h4 data-id="heading-20">🔹 流程说明</h4>
<ol>
<li>
<p><strong>用户输入</strong> → 机器人接收</p>
</li>
<li>
<p><strong>机器人拼接系统提示 + 最近 N 轮对话</strong> → 形成完整 prompt</p>
</li>
<li>
<p><strong>窗口记忆</strong> → 保留最近几轮对话，避免 prompt 过长</p>
</li>
<li>
<p><strong>调用 Ollama LLM</strong> → 生成回答</p>
</li>
<li>
<p><strong>更新历史</strong> → 将用户消息和模型回答都记录进窗口记忆</p>
</li>
<li>
<p><strong>返回给用户</strong> → 输出响应</p>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant 用户
    participant 客服机器人
    participant LLM模型

    用户-&gt;&gt;客服机器人: 输入消息 "问题 X"
    客服机器人-&gt;&gt;客服机器人: 拼接系统提示和历史对话
    客服机器人-&gt;&gt;客服机器人: 保留最近 N 轮对话（窗口记忆）
    客服机器人-&gt;&gt;LLM模型: invoke(prompt)
    LLM模型--&gt;&gt;客服机器人: 返回生成内容
    客服机器人-&gt;&gt;客服机器人: 更新窗口记忆 (user + assistant)
    客服机器人--&gt;&gt;用户: 返回响应内容

</code></pre>
</li>
</ol>
<pre><code class="hljs language-python" lang="python"><span class="hljs-string">"""
智能客服机器人示例（LangChain 1.x + Ollama）
"""</span>

<span class="hljs-keyword">from</span> langchain_ollama <span class="hljs-keyword">import</span> ChatOllama
<span class="hljs-keyword">from</span> langchain_core.caches <span class="hljs-keyword">import</span> InMemoryCache
<span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv
load_dotenv()

<span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomerServiceBot</span>:
    <span class="hljs-string">"""客服机器人类（新写法）"""</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, window_size: <span class="hljs-built_in">int</span> = <span class="hljs-number">5</span></span>):
        <span class="hljs-comment"># 窗口记忆：只保留最近 window_size 轮对话</span>
        self.window_size = window_size
        self.history = []  <span class="hljs-comment"># [(role, content)]，role: "user" 或 "assistant"</span>

        <span class="hljs-comment"># 系统提示词</span>
        self.system_prompt = <span class="hljs-string">"""你是一名专业的客服代表，具有以下特点：
            1. 友好、耐心、专业
            2. 能够快速理解客户问题
            3. 提供清晰、准确的答案
            4. 对于不确定的问题，会坦诚告知并提供进一步帮助的途径

            客户服务原则：
            - 始终保持礼貌和专业
            - 快速响应客户问题
            - 提供具体的解决方案
            - 必要时询问更多细节
            """</span>

        <span class="hljs-comment"># 初始化 Ollama LLM</span>
        self.llm = ChatOllama(
            model=<span class="hljs-string">"qwen3-coder:30b"</span>,
            temperature=<span class="hljs-number">0.7</span>,
            streaming=<span class="hljs-literal">False</span>,
            cache=InMemoryCache()  <span class="hljs-comment"># 可选缓存</span>
        )

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_build_prompt</span>(<span class="hljs-params">self, user_message: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""根据系统提示和窗口记忆生成完整 prompt"""</span>
        prompt_parts = [self.system_prompt]
        <span class="hljs-comment"># 添加最近的对话历史</span>
        <span class="hljs-keyword">for</span> role, content <span class="hljs-keyword">in</span> self.history[-self.window_size:]:
            prefix = <span class="hljs-string">"客户："</span> <span class="hljs-keyword">if</span> role == <span class="hljs-string">"user"</span> <span class="hljs-keyword">else</span> <span class="hljs-string">"客服："</span>
            prompt_parts.append(<span class="hljs-string">f"<span class="hljs-subst">{prefix}</span> <span class="hljs-subst">{content}</span>"</span>)
        <span class="hljs-comment"># 添加当前用户问题</span>
        prompt_parts.append(<span class="hljs-string">f"客户：<span class="hljs-subst">{user_message}</span>\n客服："</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-string">"\n"</span>.join(prompt_parts)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">respond</span>(<span class="hljs-params">self, user_message: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""生成响应并更新窗口记忆"""</span>
        prompt = self._build_prompt(user_message)
        response = self.llm.invoke(prompt).content.strip()
        <span class="hljs-comment"># 更新窗口记忆</span>
        self.history.append((<span class="hljs-string">"user"</span>, user_message))
        self.history.append((<span class="hljs-string">"assistant"</span>, response))
        <span class="hljs-keyword">return</span> response

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">reset</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""清空对话历史"""</span>
        self.history.clear()


<span class="hljs-comment"># =========================</span>
<span class="hljs-comment"># 使用示例</span>
<span class="hljs-comment"># =========================</span>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    bot = CustomerServiceBot()
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"客服机器人已启动（输入 'quit' 退出）\n"</span>)

    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
        user_input = <span class="hljs-built_in">input</span>(<span class="hljs-string">"客户: "</span>)
        <span class="hljs-keyword">if</span> user_input.lower() == <span class="hljs-string">"quit"</span>:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"已退出对话。"</span>)
            <span class="hljs-keyword">break</span>
        response = bot.respond(user_input)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"客服: <span class="hljs-subst">{response}</span>\n"</span>)

</code></pre>
<p><strong>输出结果：</strong>(输出结果中的客户是我自己输入的内容模拟客户和客服对话的过程)</p>
<pre><code class="hljs language-bash" lang="bash">客服机器人已启动（输入 <span class="hljs-string">'quit'</span> 退出）

客户: 我的东西什么时候发货
客服: 您好！很抱歉为您查询订单发货信息。为了更好地帮助您，我需要一些详细信息：

1. 您能提供订单号码吗？（通常在订单确认邮件或您的账户订单历史中）
2. 您购买的是什么商品？
3. 大概是什么时候下的订单？

有了这些信息，我就能为您准确查询发货状态了。

另外，一般来说：
- 普通订单通常在1-3个工作日内发货
- 特殊商品可能需要更长时间
- 促销活动期间可能会有延迟

请提供您的订单信息，我会立即为您查询具体的发货时间！

客户: 这样啊  那好吧
客服: 您好！感谢您的耐心等待。

为了能准确告诉您具体的发货时间，我需要您提供以下信息：

1. **订单号码**（在订单确认邮件或账户订单历史中可以找到）
2. **商品名称**（您购买了什么产品）
3. **下单时间**（大概什么时候买的）

有了这些信息，我就能立即为您查询准确的发货状态了。

如果您暂时找不到订单信息，也可以告诉我您的手机号或邮箱，我可以帮您查找相关订单。

请问您现在方便提供这些信息吗？我会尽快为您查询！

客户: 没了谢谢
客服: 您好！感谢您的回复。

如果您暂时无法提供订单信息，我完全理解。不过为了能帮您查询具体的发货时间，还是需要一些基本信息才能继续为您服务。

如果您后续找到了订单号码或其他相关信息，欢迎随时联系我们，我会第一时间为您查询。

另外，如果您是通过我们的官方渠道下单的，也可以：
- 查看手机短信中的订单确认信息
- 登录账户查看订单历史记录
- 检查邮箱中的订单确认邮件

如果您有任何其他问题或需要进一步帮助，请随时告诉我。祝您生活愉快！😊

---
*此回复符合客服专业标准：保持友好、提供帮助、不强求、给予选择、礼貌结束对话*
</code></pre>
<h4 data-id="heading-21">场景 2：代码生成助手</h4>
<p><strong>流程说明</strong>：</p>
<ol>
<li>
<p>用户输入编程语言和任务描述</p>
</li>
<li>
<p><code>CodeGenerator</code> 使用 <code>PromptTemplate</code> 将输入格式化为完整 Prompt</p>
</li>
<li>
<p>调用 <code>ChatOllama</code> 生成代码</p>
<ul>
<li>可以同步 <code>invoke()</code></li>
<li>或流式 <code>stream()</code></li>
</ul>
</li>
<li>
<p>对返回内容进行异常处理</p>
</li>
<li>
<p>返回最终代码或错误信息给用户</p>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    autonumber
    participant 用户
    participant CodeGenerator
    participant PromptTemplate
    participant ChatOllama
    participant 响应处理

    用户-&gt;&gt;CodeGenerator: 输入语言和任务
    CodeGenerator-&gt;&gt;PromptTemplate: 根据输入生成完整 Prompt
    PromptTemplate--&gt;&gt;CodeGenerator: 返回格式化 Prompt
    CodeGenerator-&gt;&gt;ChatOllama: 调用 invoke() 或 stream() 生成代码
    ChatOllama--&gt;&gt;CodeGenerator: 返回生成内容（流式或完整）
    CodeGenerator-&gt;&gt;响应处理: 异常检查与处理
    响应处理--&gt;&gt;用户: 输出最终代码或错误信息

</code></pre>
</li>
</ol>
<pre><code class="hljs language-python" lang="python"><span class="hljs-string">"""
代码生成助手（LangChain 1.0 + Ollama）
零警告、带异常处理、支持流式
"""</span>
<span class="hljs-keyword">from</span> __future__ <span class="hljs-keyword">import</span> annotations
<span class="hljs-keyword">import</span> sys
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">Optional</span>

<span class="hljs-keyword">from</span> langchain_ollama <span class="hljs-keyword">import</span> ChatOllama
<span class="hljs-keyword">from</span> langchain.prompts <span class="hljs-keyword">import</span> PromptTemplate
<span class="hljs-keyword">from</span> langchain_core.output_parsers <span class="hljs-keyword">import</span> StrOutputParser
<span class="hljs-keyword">from</span> ollama <span class="hljs-keyword">import</span> Client <span class="hljs-keyword">as</span> OllamaClient  <span class="hljs-comment"># 轻量检查模型是否存在</span>

OLLAMA_HOST = <span class="hljs-string">"http://localhost:11434"</span>  <span class="hljs-comment"># 按需修改</span>


<span class="hljs-keyword">class</span> <span class="hljs-title class_">CodeGenerator</span>:
    <span class="hljs-string">"""代码生成器（兼容 LangChain 1.0）"""</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">
        self,
        model: <span class="hljs-built_in">str</span> = <span class="hljs-string">"qwen2.5:7b"</span>,
        temperature: <span class="hljs-built_in">float</span> = <span class="hljs-number">0.3</span>,
        streaming: <span class="hljs-built_in">bool</span> = <span class="hljs-literal">False</span>,
    </span>) -&gt; <span class="hljs-literal">None</span>:
        self.model = model
        self._validate_model()  <span class="hljs-comment"># 启动前自检</span>

        self.llm = ChatOllama(
            base_url=OLLAMA_HOST,
            model=model,
            temperature=temperature,
            streaming=streaming,
        )
        self.prompt = PromptTemplate(
            input_variables=[<span class="hljs-string">"language"</span>, <span class="hljs-string">"task"</span>],
            template=<span class="hljs-string">"""你是一名经验丰富的 {language} 开发者。

任务：{task}

要求：
1. 代码清晰、简洁
2. 添加必要注释
3. 遵循最佳实践
4. 包含错误处理

请生成完整可运行代码："""</span>,
        )
        <span class="hljs-comment"># 1.0 管道语法：prompt | llm | parser</span>
        self.chain = self.prompt | self.llm | StrOutputParser()
        self.streaming = streaming

    <span class="hljs-comment"># ---------- 工具 ----------</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_validate_model</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-literal">None</span>:
        <span class="hljs-string">"""本地不存在则自动拉取，失败抛 RuntimeError"""</span>
        <span class="hljs-keyword">try</span>:
            client = OllamaClient(host=OLLAMA_HOST)
            models = {m[<span class="hljs-string">"model"</span>] <span class="hljs-keyword">for</span> m <span class="hljs-keyword">in</span> client.<span class="hljs-built_in">list</span>()[<span class="hljs-string">"models"</span>]}
            <span class="hljs-keyword">if</span> self.model <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> models:
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"[Info] 本地未检测到 <span class="hljs-subst">{self.model}</span>，正在拉取..."</span>)
                client.pull(self.model)
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-keyword">raise</span> RuntimeError(<span class="hljs-string">f"Ollama 连接/拉取失败：<span class="hljs-subst">{e}</span>"</span>) <span class="hljs-keyword">from</span> e

    <span class="hljs-comment"># ---------- 主要 API ----------</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">generate</span>(<span class="hljs-params">self, language: <span class="hljs-built_in">str</span>, task: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""同步生成，返回字符串"""</span>
        <span class="hljs-keyword">try</span>:
            <span class="hljs-keyword">return</span> self.chain.invoke({<span class="hljs-string">"language"</span>: language, <span class="hljs-string">"task"</span>: task})
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-keyword">return</span> <span class="hljs-string">f"[Error] 生成失败：<span class="hljs-subst">{e}</span>"</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">generate_stream</span>(<span class="hljs-params">self, language: <span class="hljs-built_in">str</span>, task: <span class="hljs-built_in">str</span></span>):
        <span class="hljs-string">"""流式生成，生成器逐段 yield"""</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> self.streaming:
            <span class="hljs-keyword">yield</span> <span class="hljs-string">"[Warn] streaming=False，已强制返回完整文本\n"</span>
            <span class="hljs-keyword">yield</span> self.generate(language, task)
            <span class="hljs-keyword">return</span>

        <span class="hljs-keyword">try</span>:
            <span class="hljs-keyword">for</span> chunk <span class="hljs-keyword">in</span> self.chain.stream({<span class="hljs-string">"language"</span>: language, <span class="hljs-string">"task"</span>: task}):
                <span class="hljs-keyword">yield</span> chunk
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-keyword">yield</span> <span class="hljs-string">f"[Error] 流式生成失败：<span class="hljs-subst">{e}</span>"</span>


<span class="hljs-comment"># =========================</span>
<span class="hljs-comment"># CLI 体验入口</span>
<span class="hljs-comment"># =========================</span>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    tasks = [
        (<span class="hljs-string">"Python"</span>, <span class="hljs-string">"创建一个函数，计算列表中所有数字的平均值，包含异常处理"</span>),
        (<span class="hljs-string">"JavaScript"</span>, <span class="hljs-string">"写一个函数，实现防抖（debounce）功能，含注释"</span>),
    ]

    gen = CodeGenerator(streaming=<span class="hljs-literal">True</span>)  <span class="hljs-comment"># False 则一次性输出</span>

    <span class="hljs-keyword">for</span> lang, task <span class="hljs-keyword">in</span> tasks:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n"</span> + <span class="hljs-string">"="</span> * <span class="hljs-number">70</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"语言：<span class="hljs-subst">{lang}</span>  |  任务：<span class="hljs-subst">{task}</span>"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span> * <span class="hljs-number">70</span> + <span class="hljs-string">"\n"</span>)

        <span class="hljs-comment"># 流式打印</span>
        <span class="hljs-keyword">for</span> piece <span class="hljs-keyword">in</span> gen.generate_stream(lang, task):
            <span class="hljs-built_in">print</span>(piece, end=<span class="hljs-string">""</span>, flush=<span class="hljs-literal">True</span>)
        <span class="hljs-built_in">print</span>()
</code></pre>
<p><strong>输出结果:</strong></p>
<pre><code class="hljs language-bash" lang="bash">======================================================================
语言：Python  |  任务：创建一个函数，计算列表中所有数字的平均值，包含异常处理
======================================================================       

```python
def calculate_average(numbers):
    <span class="hljs-string">""</span><span class="hljs-string">"
    计算列表中所有数字的平均值
         
    参数:
        numbers (list): 包含数字的列表
         
    返回:
        float: 数字的平均值
      
    异常:
        TypeError: 当输入不是列表或列表中包含非数字元素时抛出
        ValueError: 当列表为空时抛出
    "</span><span class="hljs-string">""</span>
     
    <span class="hljs-comment"># 检查输入是否为列表</span>
    <span class="hljs-keyword">if</span> not isinstance(numbers, list):
        raise TypeError(<span class="hljs-string">"输入必须是一个列表"</span>)
     
    <span class="hljs-comment"># 检查列表是否为空</span>
    <span class="hljs-keyword">if</span> len(numbers) == 0:
        raise ValueError(<span class="hljs-string">"列表不能为空"</span>)
     
    <span class="hljs-comment"># 检查列表中的每个元素是否为数字</span>
    <span class="hljs-keyword">for</span> i, item <span class="hljs-keyword">in</span> enumerate(numbers):
        <span class="hljs-keyword">if</span> not isinstance(item, (int, <span class="hljs-built_in">float</span>)):
            raise TypeError(f<span class="hljs-string">"列表中第 {i+1} 个元素 '{item}' 不是数字"</span>)

    <span class="hljs-comment"># 计算平均值</span>
    total = <span class="hljs-built_in">sum</span>(numbers)
    average = total / len(numbers)

    <span class="hljs-built_in">return</span> average


def main():
    <span class="hljs-string">""</span><span class="hljs-string">"
    主函数，用于测试 calculate_average 函数
    "</span><span class="hljs-string">""</span>

    <span class="hljs-comment"># 测试用例</span>
    test_cases = [
        [1, 2, 3, 4, 5],           <span class="hljs-comment"># 正常情况</span>
        [10.5, 20.3, 30.2],        <span class="hljs-comment"># 浮点数</span>
        [100],                     <span class="hljs-comment"># 单个元素</span>
        [1, 2, 3, 4, 5, 6, 7, 8, 9, 10],  <span class="hljs-comment"># 多个元素</span>
    ]

    <span class="hljs-built_in">print</span>(<span class="hljs-string">"=== 正常测试用例 ==="</span>)
    <span class="hljs-keyword">for</span> i, test_list <span class="hljs-keyword">in</span> enumerate(test_cases, 1):
        try:
            result = calculate_average(test_list)
            <span class="hljs-built_in">print</span>(f<span class="hljs-string">"测试 {i}: {test_list} -&gt; 平均值: {result}"</span>)
        except (TypeError, ValueError) as e:
            <span class="hljs-built_in">print</span>(f<span class="hljs-string">"测试 {i} 出错: {e}"</span>)

    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n=== 异常处理测试 ==="</span>)

    <span class="hljs-comment"># 异常测试用例</span>
    error_test_cases = [
        [],                        <span class="hljs-comment"># 空列表</span>
        [1, 2, <span class="hljs-string">"3"</span>, 4],           <span class="hljs-comment"># 包含字符串</span>
        [1, 2, None, 4],          <span class="hljs-comment"># 包含 None</span>
        <span class="hljs-string">"not a list"</span>,             <span class="hljs-comment"># 非列表输入</span>
        [1, 2, 3.5, <span class="hljs-string">"hello"</span>, 4],  <span class="hljs-comment"># 混合类型</span>
    ]

    <span class="hljs-keyword">for</span> i, test_case <span class="hljs-keyword">in</span> enumerate(error_test_cases, 1):
        try:
            result = calculate_average(test_case)
            <span class="hljs-built_in">print</span>(f<span class="hljs-string">"异常测试 {i}: {test_case} -&gt; 平均值: {result}"</span>)
        except (TypeError, ValueError) as e:
            <span class="hljs-built_in">print</span>(f<span class="hljs-string">"异常测试 {i}: {test_case} -&gt; 错误: {e}"</span>)


<span class="hljs-comment"># 额外提供一个更简洁的版本（如果需要）</span>
def calculate_average_simple(numbers):
    <span class="hljs-string">""</span><span class="hljs-string">"
    计算列表中所有数字的平均值（简化版本）

    参数:
        numbers (list): 包含数字的列表

    返回:
        float: 数字的平均值

    异常:
        TypeError: 当输入不是列表或列表中包含非数字元素时抛出
        ValueError: 当列表为空时抛出
    "</span><span class="hljs-string">""</span>

    <span class="hljs-keyword">if</span> not isinstance(numbers, list):
        raise TypeError(<span class="hljs-string">"输入必须是一个列表"</span>)

    <span class="hljs-keyword">if</span> not numbers:
        raise ValueError(<span class="hljs-string">"列表不能为空"</span>)

    <span class="hljs-comment"># 使用列表推导式检查所有元素是否为数字</span>
    <span class="hljs-keyword">if</span> not all(isinstance(x, (int, <span class="hljs-built_in">float</span>)) <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> numbers):
        raise TypeError(<span class="hljs-string">"列表中必须全部是数字"</span>)

    <span class="hljs-built_in">return</span> <span class="hljs-built_in">sum</span>(numbers) / len(numbers)


<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    main()

    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n=== 简化版本测试 ==="</span>)
    try:
        result = calculate_average_simple([1, 2, 3, 4, 5])
        <span class="hljs-built_in">print</span>(f<span class="hljs-string">"简化版本结果: {result}"</span>)
    except (TypeError, ValueError) as e:
        <span class="hljs-built_in">print</span>(f<span class="hljs-string">"简化版本错误: {e}"</span>)
```

这个代码包含了以下特性：

<span class="hljs-comment">## 主要功能：</span>
1. **`calculate_average()`** - 主要函数，计算平均值并包含完整的异常处理
2. **`main()`** - 测试函数，演示正常和异常情况
3. **`calculate_average_simple()`** - 简化版本，代码更简洁

<span class="hljs-comment">## 异常处理：</span>
- 检查输入是否为列表
- 检查列表是否为空
- 检查列表中每个元素是否为数字（int 或 <span class="hljs-built_in">float</span>）
- 提供详细的错误信息

<span class="hljs-comment">## 最佳实践：</span>
- 清晰的文档字符串
- 详细的注释
- 完整的测试用例
- 遵循 Python 编码规范
- 包含正常和异常情况的测试

<span class="hljs-comment">## 运行结果示例：</span>
```
=== 正常测试用例 ===
测试 1: [1, 2, 3, 4, 5] -&gt; 平均值: 3.0
测试 2: [10.5, 20.3, 30.2] -&gt; 平均值: 20.333333333333332
测试 3: [100] -&gt; 平均值: 100.0
测试 4: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10] -&gt; 平均值: 5.5

=== 异常处理测试 ===
异常测试 1: [] -&gt; 错误: 列表不能为空
异常测试 2: [1, 2, <span class="hljs-string">'3'</span>, 4] -&gt; 错误: 列表中第 3 个元素 <span class="hljs-string">'3'</span> 不是数字
异常测试 3: [1, 2, None, 4] -&gt; 错误: 列表中第 3 个元素 <span class="hljs-string">'None'</span> 不是数字
异常测试 4: not a list -&gt; 错误: 输入必须是一个列表
异常测试 5: [1, 2, 3.5, <span class="hljs-string">'hello'</span>, 4] -&gt; 错误: 列表中第 4 个元素 <span class="hljs-string">'hello'</span> 不是数字
```

======================================================================
语言：JavaScript  |  任务：写一个函数，实现防抖（debounce）功能，含注释
======================================================================

```javascript
/**
 * 防抖函数 - 防止函数在短时间内被频繁调用
 * @param {Function} func - 需要防抖的函数
 * @param {number} delay - 延迟时间（毫秒）
 * @param {boolean} immediate - 是否立即执行（可选，默认<span class="hljs-literal">false</span>）
 * @returns {Function} 返回防抖后的函数
 * @throws {Error} 当参数类型不正确时抛出错误
 */
<span class="hljs-keyword">function</span> debounce(func, delay, immediate = <span class="hljs-literal">false</span>) {
  // 参数类型检查
  <span class="hljs-keyword">if</span> (typeof func !== <span class="hljs-string">'function'</span>) {
    throw new Error(<span class="hljs-string">'第一个参数必须是函数'</span>);
  }

  <span class="hljs-keyword">if</span> (typeof delay !== <span class="hljs-string">'number'</span> || delay &lt; 0) {
    throw new Error(<span class="hljs-string">'延迟时间必须是大于等于0的数字'</span>);
  }

  <span class="hljs-built_in">let</span> timeoutId = null; // 存储定时器ID

  /**
   * 防抖后的函数
   * @param {...any} args - 原函数的参数
   * @returns {any} 原函数的返回值
   */
  <span class="hljs-built_in">return</span> <span class="hljs-keyword">function</span> (...args) {
    // 获取当前函数的上下文
    const context = this;

    // 清除之前的定时器
    <span class="hljs-keyword">if</span> (timeoutId) {
      clearTimeout(timeoutId);
    }

    // 如果设置为立即执行
    <span class="hljs-keyword">if</span> (immediate) {
      // 如果定时器不存在，说明是第一次执行，立即执行函数
      const callNow = !timeoutId;

      // 设置新的定时器，用于下次触发时的延迟执行
      timeoutId = setTimeout(() =&gt; {
        timeoutId = null; // 清空定时器ID，允许下次立即执行
      }, delay);

      // 如果是第一次执行，立即调用函数
      if (callNow) {
        return func.apply(context, args);
      }
    } else {
      // 普通防抖：延迟执行
      timeoutId = setTimeout(() =&gt; {
        func.apply(context, args);
      }, delay);
    }
  };
}

// 使用示例
console.log('=== 防抖函数使用示例 ===');

// 示例<span class="hljs-number">1</span>：普通防抖
const debouncedSearch = debounce(function (query) {
  console.log('搜索:', query);
  // 模拟搜索请求
  return `搜索结果: <span class="hljs-variable">${query}</span>`;
}, <span class="hljs-number">500</span>);

// 模拟频繁调用
debouncedSearch('a');
debouncedSearch('ab');
debouncedSearch('abc');
// 只有最后一次会执行，延迟<span class="hljs-number">500</span>ms

// 示例<span class="hljs-number">2</span>：立即执行防抖
const debouncedClick = debounce(function (event) {
  console.log('点击事件:', event.target.id);
  return '点击处理完成';
}, <span class="hljs-number">300</span>, true);

// 模拟点击事件
debouncedClick({ target: { id: 'btn1' } });
debouncedClick({ target: { id: 'btn2' } });
// 第一次会立即执行，后续调用会被防抖

// 示例<span class="hljs-number">3</span>：错误处理演示
try {
  // 错误的参数类型
  debounce('not a function', <span class="hljs-number">100</span>);
} catch (error) {
  console.log('捕获错误:', error.message);
}

try {
  debounce(function() {}, -<span class="hljs-number">100</span>);
} catch (error) {
  console.log('捕获错误:', error.message);
}

// 高级用法：取消防抖
function createDebouncedFunction(func, delay) {
  const debounced = debounce(func, delay);

  // 添加取消方法
  debounced.cancel = function () {
    if (timeoutId) {
      clearTimeout(timeoutId);
      timeoutId = null;
    }
  };

  return debounced;
}

// 使用取消功能
const cancellableDebounce = createDebouncedFunction(function (data) {
  console.log('处理数据:', data);
}, <span class="hljs-number">1000</span>);

cancellableDebounce('test1');
cancellableDebounce.cancel(); // 取消执行
cancellableDebounce('test2'); // 会正常执行

console.log('防抖函数演示完成');
```

这个防抖函数实现包含以下特性：

## 主要功能：
<span class="hljs-number">1</span>. **普通防抖** - 在最后一次调用后延迟执行
<span class="hljs-number">2</span>. **立即执行防抖** - 第一次立即执行，后续调用防抖
<span class="hljs-number">3</span>. **完整的参数验证** - 类型检查和错误处理
<span class="hljs-number">4</span>. **上下文保持** - 保持原函数的this指向
<span class="hljs-number">5</span>. **参数传递** - 支持传递任意参数给原函数

## 特色功能：
- **错误处理** - 对参数类型进行严格检查
- **可取消** - 提供取消执行的功能
- **详细注释** - 每个部分都有清晰的注释说明
- **使用示例** - 包含多种使用场景的演示

## 使用场景：
- 搜索框输入监听
- 窗口大小调整事件
- 按钮点击防抖
- 滚动事件处理
- 表单验证等需要防抖的场景
</code></pre>
<hr/>
<h3 data-id="heading-22">总结</h3>
<p>Langchain的部分我们差不多就讲到这里接下来我们</p>
<p>下一篇我们讲LangGraph</p>
<p>学 LangChain 打造智能链式推理，</p>
<p>学 LangGraph 则是在此基础上构建复杂多节点知识与逻辑的可视化智能图，使系统架构更直观、高效且易于管理。</p>
<h3 data-id="heading-23">进阶学习资源</h3>
<h4 data-id="heading-24">官方资源</h4>
<ul>
<li><strong>LangChain 官方文档</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fpython.langchain.com%2F" target="_blank" title="https://python.langchain.com/" ref="nofollow noopener noreferrer">python.langchain.com/</a></li>
<li><strong>LangChain GitHub</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Flangchain-ai%2Flangchain" target="_blank" title="https://github.com/langchain-ai/langchain" ref="nofollow noopener noreferrer">github.com/langchain-a…</a></li>
<li><strong>LangChain 教程</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fpython.langchain.com%2Fdocs%2Ftutorials%2F" target="_blank" title="https://python.langchain.com/docs/tutorials/" ref="nofollow noopener noreferrer">python.langchain.com/docs/tutori…</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[桌面应用开发，Flutter 与 Electron如何选]]></title>    <link>https://juejin.cn/post/7578719771589066762</link>    <guid>https://juejin.cn/post/7578719771589066762</guid>    <pubDate>2025-12-01T17:13:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578719771589066762" data-draft-id="7409185886300766249" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="桌面应用开发，Flutter 与 Electron如何选"/> <meta itemprop="keywords" content="Electron,Flutter,Windows"/> <meta itemprop="datePublished" content="2025-12-01T17:13:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Karl_wei"/> <meta itemprop="url" content="https://juejin.cn/user/448256476988680"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            桌面应用开发，Flutter 与 Electron如何选
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/448256476988680/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Karl_wei
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-01T17:13:59.000Z" title="Mon Dec 01 2025 17:13:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-01
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.7;font-weight:400;font-size:16px;overflow-x:hidden;color:#2c3e50;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue,sans-serif;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;font-weight:600;margin-top:35px;margin-bottom:8px;padding-bottom:5px}.markdown-body h1 :before,.markdown-body h2 :before,.markdown-body h3 :before,.markdown-body h4 :before,.markdown-body h5 :before,.markdown-body h6 :before{content:"#";display:inline-block;color:#3eaf7c;padding-right:.23em}.markdown-body h1{font-size:30px;margin-bottom:5px}.markdown-body h2{padding-bottom:8px;margin-top:50px;font-size:24px;border-bottom:1px solid #eaecef}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #eaecef;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;overflow-x:auto;font-weight:400;background-color:rgba(27,31,35,.05);color:#476582;margin:0;font-size:.85em;border-radius:3px;font-size:.87em;padding:.165em .5em}.markdown-body code,.markdown-body pre{font-family:source-code-pro,Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.6;padding:20px 24px;background-color:#282c34;border-radius:6px}.markdown-body pre&gt;code{font-size:14px;padding:0;margin:0;word-break:normal;display:block;overflow-x:auto;color:#fff}.markdown-body a{text-decoration:none;color:#3eaf7c;font-weight:500}.markdown-body a:active,.markdown-body a:hover{color:#42b983;border-bottom:1px solid #42b983}.markdown-body table{display:inline-block!important;font-size:14px;width:auto;max-width:100%;overflow:auto;margin:16px 0;border-collapse:collapse}.markdown-body thead{background:#f6f6f6;background:#3eaf7c;color:#000;color:#fff;text-align:left}.markdown-body tr:nth-child(2n){background-color:#f6f8fa}.markdown-body td,.markdown-body th{border:1px solid #dfe2e5;padding:10px 16px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{font-size:14px;padding:6px 23px;margin:22px 0;border-left:6px solid #42b983;background-color:#f3f5f7;font-weight:400}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body p,.markdown-body ul{line-height:1.7}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="base16/tomorrow-night">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>前言：这一年来我基本处于断更的状态，我知道在AI时代，编码的成本已经变得越来越低，技术分享的流量必然会下降。但这依然是一个艰难的过程，日常斥责自己没有成长，没有作品。<br/> <br/>除了流量问题、巨量的工作，更多的原因是由于技术栈的变化。我开始<strong>使用Electron</strong>编写一个重要的AI产品，并且在 Flutter 与 Electron 之间来回拉扯......</p>
</blockquote>
<h2 data-id="heading-0">背景</h2>
<p>我们对 Flutter 技术的应用，不仅是在移动端APP，在我们的终端设备也用来做 OS 应用，<code>跨Android、Windows、Linux系统。</code><br/>
在 Flutter 上，我们是有所沉淀的，但是当我们决定研发一款重要的PC应用时，依然产生了疑问：<strong>Flutter 这门技术，真的能满足我们在核心桌面应用的研发需求吗？</strong> <br/>
最终，基于官方能力、技术生态、roadmap等一系列原因，我们<strong>放弃在核心应用上使用 Flutter，转而代之选择了 Electron</strong> ！<br/></p>
<p>这篇文章将从这几个月使用 Electron 的切实体验，从不同角度，对 <code>Flutter</code> 和 <code>Electron</code>  这两款支持跨端桌面应用开发技术，做一个详细的对比。</p>
<h2 data-id="heading-1">Flutter VS Electron</h2>








































<table><thead><tr><th>维度</th><th>Flutter</th><th>Electron</th></tr></thead><tbody><tr><td><strong>发布时间</strong></td><td>2021 年 3 月 宣布支持桌面端</td><td>2013 年 4 月发布，发布即支持</td></tr><tr><td><strong>核心场景</strong></td><td>移动APP跨端</td><td>桌面应用跨端</td></tr><tr><td><strong>官方网站</strong></td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fflutter.dev" target="_blank" title="https://flutter.dev" ref="nofollow noopener noreferrer">flutter.dev</a></td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.electronjs.org" target="_blank" title="https://www.electronjs.org" ref="nofollow noopener noreferrer">www.electronjs.org</a></td></tr><tr><td><strong>开发文档</strong></td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.flutter.dev" target="_blank" title="https://docs.flutter.dev" ref="nofollow noopener noreferrer">docs.flutter.dev</a></td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.electronjs.org%2Fdocs" target="_blank" title="https://www.electronjs.org/docs" ref="nofollow noopener noreferrer">www.electronjs.org/docs</a></td></tr><tr><td><strong>插件包管理</strong></td><td>Pub（<a href="https://link.juejin.cn?target=https%3A%2F%2Fpub.dev" target="_blank" title="https://pub.dev" ref="nofollow noopener noreferrer">pub.dev</a>），提供大量 UI 组件、工具类库</td><td>npm（<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com" target="_blank" title="https://www.npmjs.com" ref="nofollow noopener noreferrer">www.npmjs.com</a>），依赖前端生态，插件丰富（如 electron-builder 打包工具）</td></tr><tr><td><strong>研发组织</strong></td><td>Google</td><td>Github</td></tr></tbody></table>
<h2 data-id="heading-2">方案成熟度</h2>
<p>毫无疑问，在方案成熟度上 Electron 是碾压 Flutter 的存在。</p>
<h4 data-id="heading-3">1. 多进程能力</h4>
<ul>
<li>Flutter 目前还是单进程的能力，只能通过创建 isolate 来实现部分耗时任务，但是内存也是不共享的。</li>
<li>Electron 集成了 Nodejs 服务，<code>自带多进程的能力</code>，且提供了<code>完整的跨进程机制</code>（<strong>IPC「Inter-Process Communication」</strong>）。</li>
</ul>
<h4 data-id="heading-4">2. 多窗口支持</h4>
<ul>
<li><strong>Flutter 目前不支持多窗口</strong>。由于其是自绘引擎，本身还是依赖原生进程提供的桌面窗口，所以需要原生与 Flutter 引擎不断的进行沟通对接，才能很好的使用多窗口能力。<br/>
目前官方只是提供了 demo 来验证多窗口的可行性，但截止发文还没有办法在公版试用。</li>
<li>Electron 将 Chromium 的核心模块打包到发行包中，<code>借助浏览器的能力，可以随意开辟新的窗口</code>（如： <strong>BrowserWindow</strong>）</li>
</ul>
<h4 data-id="heading-5">3. 开发语言</h4>
<ul>
<li>Flutter 使用dart语言开发，采用声明式UI进行布局，插件管理使用官方的 pub 社区，学习和使用成本不算高。</li>
<li>Electron 使用JavaScript/TypeScript + HTML/CSS 的前端技术栈进行开发，社区也完全跟前端一致，<code>非常丰富但鱼龙混杂</code>。</li>
</ul>
<h4 data-id="heading-6">4. 原生能力的支持</h4>
<ul>
<li>Flutter 本质是一个 UI 框架，<strong>原生能力需要通过编写插件去调用</strong>，或者通过 FFI 调用，<strong>成本是很高的，你很难找到一个懂多端原生技术的开发。</strong></li>
<li>Electron 有 node 环境，node.js 很多原生模块，可以直接调用到系统的能力，非常的高效。</li>
</ul>
<h2 data-id="heading-7">开发体验和技术生态</h2>
<h4 data-id="heading-8">1. 调试工具</h4>
<ul>
<li>Flutter 的调试工具，主要是依赖 IDE 本身的断点调试能力，以及自研的Flutter Inspector、devTools。<br/>
在UI定位、性能监控方面，基本可以满足。但由于是个 UI 框架，<strong>对于原生容器是无法进行调试的</strong>，这在混合开发过程中是个比较大的痛点。</li>
<li>Electron 就是个浏览器，<strong>对于主进程和node子进程，有 Inspect 的机制；</strong> UI 层就更方便了，就是浏览器的调试器一模一样。生产环境下调试成本也低。</li>
</ul>
<h4 data-id="heading-9">2. 打包编译</h4>
<p>Flutter 是通过自绘引擎生成原生应用包，而 Electron 是将网页技术（HTML/CSS/JS）包裹在 Chromium 内核中。<br/></p>
<p>底层技术架构的区别，直接决定了 Electron 的打包相对 Flutter 有些困难，且包体积很大。</p>






























<table><thead><tr><th align="left">对比维度</th><th align="left">Flutter</th><th align="left">Electron</th></tr></thead><tbody><tr><td align="left"><strong>打包原理</strong></td><td align="left">编译成目标平台的<strong>原生二进制代码</strong>，搭配自绘引擎（Skia）</td><td align="left">封装 <strong>Chromium 内核 + Node.js 环境</strong>，运行网页资源</td></tr><tr><td align="left"><strong>最终产物</strong></td><td align="left">与原生应用格式一致（如 .apk/.ipa/.exe）</td><td align="left">包含浏览器内核的独立应用包</td></tr><tr><td align="left"><strong>跨平台方式</strong></td><td align="left">一份代码编译成多平台原生包，需分别打包</td><td align="left">一份代码打包成多平台包，内核随应用分发</td></tr><tr><td align="left"><strong>应用体积</strong></td><td align="left">较小（基础包约 10-20MB）</td><td align="left">较大（基础包约 50-100MB，内核占主要体积）</td></tr></tbody></table>
<h4 data-id="heading-10">3. 官方和社区的活跃性</h4>
<ul>
<li>Flutter 官方在桌面端的推进很慢，很多基础能力都没有太多的推进。同时在 roadmap 中，重心都偏向移动端和 web 端。</li>
<li>Electron 由于产品的体量和成熟度，稳定的在更新，每个版本都会带来一些新的特性。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2356d8060a744b61a857c560bcb7d1a1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgS2FybF93ZWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765214039&amp;x-signature=fvc0iCguO60PWpnUT01pxcIvA7w%3D" alt="image.png" loading="lazy"/></li>
</ul>
<h4 data-id="heading-11">4. 研发团队</h4>






























<table><thead><tr><th align="left">技能维度</th><th align="left">Flutter</th><th align="left">Electron</th></tr></thead><tbody><tr><td align="left"><strong>核心语言</strong></td><td align="left"><strong>Dart</strong>，需理解其异步逻辑、Widget 组件化思想</td><td align="left"><strong>JavaScript/TypeScript</strong>，前端开发者可无缝衔接</td></tr><tr><td align="left"><strong>UI 技术</strong></td><td align="left">Flutter 内置 Widget 体系，需学习其布局（Row/Column）、状态管理（Provider/Bloc）</td><td align="left">HTML/CSS，可复用前端生态（Vue/React/Element UI 等）</td></tr><tr><td align="left"><strong>原生交互</strong></td><td align="left">需了解 Android（Kotlin/Java）、iOS（Swift/OC）基础，复杂功能需写原生插件</td><td align="left">依赖 Node.js 模块或现成插件，无需深入原生开发</td></tr><tr><td align="left"><strong>工程化工具</strong></td><td align="left">依赖 Flutter CLI、Android Studio/Xcode（打包配置）</td><td align="left">依赖 npm/yarn、webpack/vite（前端构建工具）</td></tr></tbody></table>
<p>可以看出，Flutter至少需要 1-2 名熟悉 Dart 的开发者，还需要有原生开发能力，<strong>技术门槛是比较高的</strong>；而 Electron 以前端开发者为主，熟悉 Node.js 即可完成所有开发，是<strong>可以快速上手的</strong>。<br/></p>
<p>同时前端开发也比 Flutter 开发要<strong>更容易招聘</strong>。</p>
<h2 data-id="heading-12">结语</h2>
<p>笔者本身是 Flutter 的忠实维护者，我认为 Flutter 的 Impeller 图形渲染引擎将不断完善，<code>能在各个端达到更好的渲染速度和效果</code>；同时 Flutter 目前的多窗口方案，让我们可以<code>充分的相信可以多个窗口共用一份内存，而不需要通过进程间通信机制</code><br/></p>
<p>但是，在 Flutter 暂未成熟的阶段，<strong>桌面核心产品还是用 Electron 进行开发会更加合适</strong>。我们 也期待未来 Electron 可以多集成WebAssembly来提升计算密集型任务的性能，减少 Chromium 内核的高内存占用。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【URP】Unity[内置Shader]地形光照TerrainLit]]></title>    <link>https://juejin.cn/post/7578699866182451238</link>    <guid>https://juejin.cn/post/7578699866182451238</guid>    <pubDate>2025-12-01T16:29:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578699866182451238" data-draft-id="7578714735307997210" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【URP】Unity[内置Shader]地形光照TerrainLit"/> <meta itemprop="keywords" content="游戏开发,图形学,Unity3D"/> <meta itemprop="datePublished" content="2025-12-01T16:29:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SmalBox"/> <meta itemprop="url" content="https://juejin.cn/user/2218166695237532"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【URP】Unity[内置Shader]地形光照TerrainLit
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2218166695237532/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SmalBox
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-01T16:29:53.000Z" title="Mon Dec 01 2025 16:29:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-01
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fchenghai37%2Fcategory_13021255.html%3Ffromshare%3Dblogcolumn%26sharetype%3Dblogcolumn%26sharerId%3D13021255%26sharerefer%3DPC%26sharesource%3Dchenghai37%26sharefrom%3Dfrom_link" target="_blank" title="https://blog.csdn.net/chenghai37/category_13021255.html?fromshare=blogcolumn&amp;sharetype=blogcolumn&amp;sharerId=13021255&amp;sharerefer=PC&amp;sharesource=chenghai37&amp;sharefrom=from_link" ref="nofollow noopener noreferrer">【从UnityURP开始探索游戏渲染】</a><strong>专栏-直达</strong></p>
</blockquote>
<p>TerrainLit Shader是Unity URP（通用渲染管线）中专为地形系统设计的内置着色器，主要用于高效渲染大规模地形表面并支持多纹理混合。</p>
<h2 data-id="heading-0"><strong>作用与原理</strong></h2>
<h3 data-id="heading-1">‌<strong>核心功能</strong>‌：</h3>
<ul>
<li>支持最多8层纹理混合，通过<strong>高度图</strong>或<strong>遮罩图</strong>控制<strong>混合过渡</strong></li>
<li>采用基于物理的渲染(PBR)模型处理光照和材质反射</li>
<li>优化了LOD（细节层次）系统，适应远距离地形渲染</li>
</ul>
<h2 data-id="heading-2"><strong>发展历史</strong></h2>
<ul>
<li>‌<strong>2018年</strong>‌：随URP首次推出，仅支持4层纹理混合</li>
<li>‌<strong>2019年</strong>‌：升级至支持8层混合，增加PBR支持</li>
<li>‌<strong>2020年</strong>‌：优化GPU实例化，提升大规模地形渲染性能</li>
</ul>
<h3 data-id="heading-3">‌<strong>技术原理</strong>‌：</h3>
<ul>
<li>使用SplatMap技术混合多张纹理，通过RGBA通道存储混合权重</li>
<li>在顶点着色阶段计算地形高度和法线，片段着色阶段进行纹理采样混合</li>
</ul>
<h3 data-id="heading-4">SplatMap技术</h3>
<p>SplatMap技术通过纹理的RGBA通道存储多层纹理权重信息，在片段着色器中实现动态混合。</p>
<h4 data-id="heading-5"><strong>存储机制</strong></h4>
<ul>
<li>‌<strong>通道分配</strong>‌：
<ul>
<li>每个RGBA通道对应一个纹理层的权重值（0-1范围），例如R通道存储第1层权重，G通道存储第2层权重，依此类推。当需要超过4层时，会使用多张SplatMap（如第二张SplatMap的R通道存储第5层权重）。</li>
</ul>
</li>
<li>‌<strong>数据编码</strong>‌：
<ul>
<li>权重值通常以8位精度存储（0-255映射到0.0-1.0），在着色器中通过归一化还原。例如，R通道值0.5表示第1层权重为50%。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-6"><strong>着色器实现示例</strong></h4>
<p>以下是一个基于Unity的片段着色器代码片段，演示如何采样并混合4层纹理：</p>
<pre><code class="hljs language-c" lang="c">hlsl
half4 <span class="hljs-title function_">frag</span><span class="hljs-params">(v2f input)</span> : SV_Target {
    <span class="hljs-comment">// 采样SplatMap获取权重</span>
    half4 splat = SAMPLE_TEXTURE2D(_SplatMap, sampler_SplatMap, input.uv);

    <span class="hljs-comment">// 采样各层纹理</span>
    half4 tex1 = SAMPLE_TEXTURE2D(_Layer1, sampler_Layer1, input.uv);
    half4 tex2 = SAMPLE_TEXTURE2D(_Layer2, sampler_Layer2, input.uv);
    half4 tex3 = SAMPLE_TEXTURE2D(_Layer3, sampler_Layer3, input.uv);
    half4 tex4 = SAMPLE_TEXTURE2D(_Layer4, sampler_Layer4, input.uv);

    <span class="hljs-comment">// 动态混合（权重归一化处理）</span>
    half sumWeights = splat.r + splat.g + splat.b + splat.a;
    half3 finalColor = (tex1.rgb * splat.r + tex2.rgb * splat.g +
                       tex3.rgb * splat.b + tex4.rgb * splat.a) / sumWeights;

    <span class="hljs-keyword">return</span> half4(finalColor, <span class="hljs-number">1.0</span>);
}
</code></pre>
<h4 data-id="heading-7"><strong>性能优化</strong></h4>
<ul>
<li>
<p>‌<strong>纹理数组替代</strong>‌：</p>
<ul>
<li>
<p>使用Texture2DArray将多张纹理合并为单一资源，通过索引值（存储在SplatMap的R/G通道）选择纹理，减少采样次数。例如：</p>
<pre><code class="hljs language-c" lang="c">hlsl
half4 var_Main = SAMPLE_TEXTURE2D_ARRAY(_TexArray, sampler_TexArray, uv, splat.r * <span class="hljs-number">255</span>) * splat.b;
half4 var_Sec = SAMPLE_TEXTURE2D_ARRAY(_TexArray, sampler_TexArray, uv, splat.g * <span class="hljs-number">255</span>) * (<span class="hljs-number">1</span> - splat.b);
half4 finalRGB = var_Main + var_Sec;
</code></pre>
</li>
</ul>
</li>
<li>
<p>‌<strong>高度混合增强</strong>‌：</p>
<ul>
<li>结合高度图（存储在SplatMap的B通道）实现更自然的过渡效果，通过比较各层高度值动态调整权重。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-8"><strong>限制与改进</strong></h4>
<ul>
<li>‌<strong>通道限制</strong>‌：传统SplatMap每张仅支持4层，超过时需要多张纹理，增加带宽压力。</li>
<li>‌<strong>混合精度</strong>‌：8位通道可能导致可见的带状伪影，可通过16位浮点纹理或抖动技术缓解。</li>
</ul>
<h2 data-id="heading-9"><strong>具体使用示例</strong></h2>
<h3 data-id="heading-10">‌<strong>基础配置</strong>‌</h3>
<ul>
<li>创建Terrain对象</li>
<li>在Inspector面板选择Material为"Custom"</li>
<li>指定Shader为"Universal Render Pipeline/Terrain/Lit"</li>
</ul>
<p>通过SplatMap控制纹理混合时，需在Terrain Layers中配置各层纹理的金属度/光滑度等PBR参数</p>
<ul>
<li>
<p>‌<strong>脚本控制混合</strong>‌：</p>
<pre><code class="hljs language-csharp" lang="csharp">csharp
<span class="hljs-comment">// 动态修改第2层纹理权重</span>
Terrain terrain = GetComponent&lt;Terrain&gt;();
<span class="hljs-built_in">float</span>[,,] map = terrain.terrainData.GetAlphamaps(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>);
map[<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>] = <span class="hljs-number">0.5f</span>;<span class="hljs-comment">// 设置权重为50%</span>
terrain.terrainData.SetAlphamaps(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, map);
</code></pre>
</li>
</ul>
<h2 data-id="heading-11"><strong>Shader Graph应用</strong></h2>
<ul>
<li>‌<strong>扩展案例</strong>‌（雪地效果）：
<ul>
<li>创建Unlit Shader Graph，添加Height节点检测地形高度5</li>
<li>使用Lerp节点混合雪地纹理和基础纹理：最终输出到Base Color和Normal通道
<ul>
<li>Height → Step → Lerp(T)
基础纹理 → Lerp(A)
雪地纹理 → Lerp(B)</li>
</ul>
</li>
</ul>
</li>
<li>‌<strong>溶解效果移植</strong>‌：
<ul>
<li>复制TerrainLit的混合逻辑到Shader Graph</li>
<li>添加Noise节点连接Alpha通道实现地形局部溶解</li>
<li>关键节点链：
<ul>
<li>Noise → Step → Alpha Clipping
Color → Emission（边缘发光）</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>该着色器通过模块化设计平衡了性能与效果，在URP 12.x版本后已完全支持Shader Graph的自定义扩展</p>
<hr/>
<blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fchenghai37%2Fcategory_13021255.html%3Ffromshare%3Dblogcolumn%26sharetype%3Dblogcolumn%26sharerId%3D13021255%26sharerefer%3DPC%26sharesource%3Dchenghai37%26sharefrom%3Dfrom_link" target="_blank" title="https://blog.csdn.net/chenghai37/category_13021255.html?fromshare=blogcolumn&amp;sharetype=blogcolumn&amp;sharerId=13021255&amp;sharerefer=PC&amp;sharesource=chenghai37&amp;sharefrom=from_link" ref="nofollow noopener noreferrer">【从UnityURP开始探索游戏渲染】</a><strong>专栏-直达</strong>
（欢迎<em>点赞留言</em>探讨，更多人加入进来能更加完善这个探索的过程，🙏）</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React-Draggable 快速上手指南]]></title>    <link>https://juejin.cn/post/7578714759337476096</link>    <guid>https://juejin.cn/post/7578714759337476096</guid>    <pubDate>2025-12-01T16:30:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578714759337476096" data-draft-id="7578714759337459712" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React-Draggable 快速上手指南"/> <meta itemprop="keywords" content="React.js"/> <meta itemprop="datePublished" content="2025-12-01T16:30:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="土豆1250"/> <meta itemprop="url" content="https://juejin.cn/user/3280598428302727"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React-Draggable 快速上手指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3280598428302727/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    土豆1250
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-01T16:30:11.000Z" title="Mon Dec 01 2025 16:30:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-01
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">简介</h2>
<p>在现代Web应用开发中，拖拽交互已成为提升用户体验的重要功能之一。无论是任务管理面板、可视化编辑器还是动态布局系统，拖拽功能都能让界面更加直观和友好。</p>
<p>React-Draggable是一个专门为React应用设计的轻量级拖拽库，它提供了简单而强大的API，让开发者能够轻松地为组件添加拖拽功能。本文将详细介绍React-Draggable的使用方法，涵盖从基础安装到高级应用的各个方面。</p>
<h2 data-id="heading-1">为什么选择React-Draggable？</h2>
<p>React-Draggable相比其他拖拽库具有以下优势：</p>
<ul>
<li><strong>简单易用</strong>：API设计直观，学习曲线平缓</li>
<li><strong>性能优秀</strong>：基于CSS transform实现，性能开销小</li>
<li><strong>高度可定制</strong>：提供丰富的配置选项和事件回调</li>
<li><strong>React原生</strong>：完美融入React生态系统</li>
<li><strong>轻量级</strong>：体积小，不影响应用加载速度</li>
</ul>
<h2 data-id="heading-2">安装与配置</h2>
<h3 data-id="heading-3">安装</h3>
<p>使用npm或yarn安装React-Draggable：</p>
<pre><code class="hljs language-bash" lang="bash">npm install react-draggable
<span class="hljs-comment"># 或者</span>
yarn add react-draggable
</code></pre>
<h3 data-id="heading-4">基本导入</h3>
<p>在组件中导入Draggable组件：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Draggable</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'react-draggable'</span>;
</code></pre>
<h2 data-id="heading-5">基础用法</h2>
<h3 data-id="heading-6">最简单的拖拽示例</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Draggable</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'react-draggable'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">SimpleDraggable</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Draggable</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> 
        <span class="hljs-attr">width:</span> <span class="hljs-attr">200</span>, 
        <span class="hljs-attr">height:</span> <span class="hljs-attr">200</span>, 
        <span class="hljs-attr">background:</span> '<span class="hljs-attr">lightblue</span>',
        <span class="hljs-attr">cursor:</span> '<span class="hljs-attr">move</span>',
        <span class="hljs-attr">padding:</span> <span class="hljs-attr">20</span>,
        <span class="hljs-attr">borderRadius:</span> <span class="hljs-attr">8</span>
      }}&gt;</span>
        拖拽我！
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">Draggable</span>&gt;</span></span>
  );
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">SimpleDraggable</span>;
</code></pre>
<h3 data-id="heading-7">控制拖拽方向</h3>
<p>通过<code>axis</code>属性可以限制拖拽方向：</p>
<pre><code class="hljs language-javascript" lang="javascript">&lt;<span class="hljs-title class_">Draggable</span> axis=<span class="hljs-string">"x"</span>&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>只能水平拖拽<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/<span class="hljs-title class_">Draggable</span>&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Draggable</span> <span class="hljs-attr">axis</span>=<span class="hljs-string">"y"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>只能垂直拖拽<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">Draggable</span>&gt;</span></span>

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Draggable</span> <span class="hljs-attr">axis</span>=<span class="hljs-string">"both"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>可以任意方向拖拽（默认）<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">Draggable</span>&gt;</span></span>
</code></pre>
<h3 data-id="heading-8">设置拖拽边界</h3>
<p>使用<code>bounds</code>属性限制拖拽范围：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 限制在父元素内</span>
&lt;<span class="hljs-title class_">Draggable</span> bounds=<span class="hljs-string">"parent"</span>&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>限制在父容器内<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/<span class="hljs-title class_">Draggable</span>&gt;

<span class="hljs-comment">// 自定义边界</span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Draggable</span> <span class="hljs-attr">bounds</span>=<span class="hljs-string">{{left:</span> <span class="hljs-attr">-100</span>, <span class="hljs-attr">top:</span> <span class="hljs-attr">-100</span>, <span class="hljs-attr">right:</span> <span class="hljs-attr">100</span>, <span class="hljs-attr">bottom:</span> <span class="hljs-attr">100</span>}}&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>限制在指定区域内<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">Draggable</span>&gt;</span></span>
</code></pre>
<h2 data-id="heading-9">常见使用场景</h2>
<h3 data-id="heading-10">1. 可拖拽的模态框</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { useState } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Draggable</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'react-draggable'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">DraggableModal</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [isOpen, setIsOpen] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setIsOpen(true)}&gt;打开模态框<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      
      {isOpen &amp;&amp; (
        <span class="hljs-tag">&lt;<span class="hljs-name">Draggable</span> <span class="hljs-attr">handle</span>=<span class="hljs-string">".modal-header"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"modal"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span>
            <span class="hljs-attr">position:</span> '<span class="hljs-attr">fixed</span>',
            <span class="hljs-attr">width:</span> <span class="hljs-attr">400</span>,
            <span class="hljs-attr">background:</span> '<span class="hljs-attr">white</span>',
            <span class="hljs-attr">borderRadius:</span> <span class="hljs-attr">8</span>,
            <span class="hljs-attr">boxShadow:</span> '<span class="hljs-attr">0</span> <span class="hljs-attr">4px</span> <span class="hljs-attr">12px</span> <span class="hljs-attr">rgba</span>(<span class="hljs-attr">0</span>,<span class="hljs-attr">0</span>,<span class="hljs-attr">0</span>,<span class="hljs-attr">0.15</span>)',
            <span class="hljs-attr">zIndex:</span> <span class="hljs-attr">1000</span>
          }}&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"modal-header"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span>
              <span class="hljs-attr">padding:</span> '<span class="hljs-attr">12px</span> <span class="hljs-attr">16px</span>',
              <span class="hljs-attr">background:</span> '#<span class="hljs-attr">f0f0f0</span>',
              <span class="hljs-attr">cursor:</span> '<span class="hljs-attr">move</span>',
              <span class="hljs-attr">borderRadius:</span> '<span class="hljs-attr">8px</span> <span class="hljs-attr">8px</span> <span class="hljs-attr">0</span> <span class="hljs-attr">0</span>'
            }}&gt;</span>
              拖拽标题栏移动
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"modal-body"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">padding:</span> <span class="hljs-attr">16</span> }}&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>这是一个可以拖拽的模态框内容<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setIsOpen(false)}&gt;关闭<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">Draggable</span>&gt;</span>
      )}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<h3 data-id="heading-11">2. 可排序列表</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { useState } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Draggable</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'react-draggable'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">SortableList</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [items, setItems] = <span class="hljs-title function_">useState</span>([
    { <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">text</span>: <span class="hljs-string">'项目 1'</span> },
    { <span class="hljs-attr">id</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">text</span>: <span class="hljs-string">'项目 2'</span> },
    { <span class="hljs-attr">id</span>: <span class="hljs-number">3</span>, <span class="hljs-attr">text</span>: <span class="hljs-string">'项目 3'</span> },
    { <span class="hljs-attr">id</span>: <span class="hljs-number">4</span>, <span class="hljs-attr">text</span>: <span class="hljs-string">'项目 4'</span> }
  ]);

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleStop</span> = (<span class="hljs-params">e, data, index</span>) =&gt; {
    <span class="hljs-comment">// 这里可以实现排序逻辑</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`项目 <span class="hljs-subst">${index}</span> 移动到了新位置`</span>);
  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">maxWidth:</span> <span class="hljs-attr">300</span>, <span class="hljs-attr">margin:</span> '<span class="hljs-attr">0</span> <span class="hljs-attr">auto</span>' }}&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>可排序列表<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
      {items.map((item, index) =&gt; (
        <span class="hljs-tag">&lt;<span class="hljs-name">Draggable</span>
          <span class="hljs-attr">key</span>=<span class="hljs-string">{item.id}</span>
          <span class="hljs-attr">axis</span>=<span class="hljs-string">"y"</span>
          <span class="hljs-attr">onStop</span>=<span class="hljs-string">{(e,</span> <span class="hljs-attr">data</span>) =&gt;</span> handleStop(e, data, index)}
        &gt;
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span>
            <span class="hljs-attr">padding:</span> '<span class="hljs-attr">12px</span> <span class="hljs-attr">16px</span>',
            <span class="hljs-attr">margin:</span> '<span class="hljs-attr">8px</span> <span class="hljs-attr">0</span>',
            <span class="hljs-attr">background:</span> '#<span class="hljs-attr">f8f9fa</span>',
            <span class="hljs-attr">border:</span> '<span class="hljs-attr">1px</span> <span class="hljs-attr">solid</span> #<span class="hljs-attr">dee2e6</span>',
            <span class="hljs-attr">borderRadius:</span> <span class="hljs-attr">4</span>,
            <span class="hljs-attr">cursor:</span> '<span class="hljs-attr">move</span>'
          }}&gt;</span>
            {item.text}
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">Draggable</span>&gt;</span>
      ))}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<h3 data-id="heading-12">3. 拖拽上传区域</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { useState } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Draggable</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'react-draggable'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">DraggableUploadZone</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [isDragging, setIsDragging] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleDragStart</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-title function_">setIsDragging</span>(<span class="hljs-literal">true</span>);
  };

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleDragStop</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-title function_">setIsDragging</span>(<span class="hljs-literal">false</span>);
  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Draggable</span>
      <span class="hljs-attr">onStart</span>=<span class="hljs-string">{handleDragStart}</span>
      <span class="hljs-attr">onStop</span>=<span class="hljs-string">{handleDragStop}</span>
      <span class="hljs-attr">defaultPosition</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">x:</span> <span class="hljs-attr">100</span>, <span class="hljs-attr">y:</span> <span class="hljs-attr">100</span> }}
    &gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span>
        <span class="hljs-attr">width:</span> <span class="hljs-attr">300</span>,
        <span class="hljs-attr">height:</span> <span class="hljs-attr">200</span>,
        <span class="hljs-attr">border:</span> `<span class="hljs-attr">2px</span> <span class="hljs-attr">dashed</span> ${<span class="hljs-attr">isDragging</span> ? '#<span class="hljs-attr">007bff</span>' <span class="hljs-attr">:</span> '#<span class="hljs-attr">ccc</span>'}`,
        <span class="hljs-attr">borderRadius:</span> <span class="hljs-attr">8</span>,
        <span class="hljs-attr">display:</span> '<span class="hljs-attr">flex</span>',
        <span class="hljs-attr">alignItems:</span> '<span class="hljs-attr">center</span>',
        <span class="hljs-attr">justifyContent:</span> '<span class="hljs-attr">center</span>',
        <span class="hljs-attr">background:</span> <span class="hljs-attr">isDragging</span> ? '#<span class="hljs-attr">f8f9ff</span>' <span class="hljs-attr">:</span> '#<span class="hljs-attr">fafafa</span>',
        <span class="hljs-attr">cursor:</span> '<span class="hljs-attr">move</span>',
        <span class="hljs-attr">transition:</span> '<span class="hljs-attr">all</span> <span class="hljs-attr">0.3s</span> <span class="hljs-attr">ease</span>'
      }}&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>拖拽上传区域<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">fontSize:</span> <span class="hljs-attr">12</span>, <span class="hljs-attr">color:</span> '#<span class="hljs-attr">666</span>' }}&gt;</span>点击或拖拽文件到此处<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">Draggable</span>&gt;</span></span>
  );
}
</code></pre>
<h3 data-id="heading-13">4. 可拖拽的面板布局</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { useState } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Draggable</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'react-draggable'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">DashboardLayout</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [panels, setPanels] = <span class="hljs-title function_">useState</span>([
    { <span class="hljs-attr">id</span>: <span class="hljs-string">'chart'</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">'图表面板'</span>, <span class="hljs-attr">x</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">0</span> },
    { <span class="hljs-attr">id</span>: <span class="hljs-string">'stats'</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">'统计面板'</span>, <span class="hljs-attr">x</span>: <span class="hljs-number">400</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">0</span> },
    { <span class="hljs-attr">id</span>: <span class="hljs-string">'activity'</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">'活动面板'</span>, <span class="hljs-attr">x</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">300</span> }
  ]);

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">updatePanelPosition</span> = (<span class="hljs-params">id, x, y</span>) =&gt; {
    <span class="hljs-title function_">setPanels</span>(panels.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">panel</span> =&gt;</span> 
      panel.<span class="hljs-property">id</span> === id ? { ...panel, x, y } : panel
    ));
  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> 
      <span class="hljs-attr">position:</span> '<span class="hljs-attr">relative</span>', 
      <span class="hljs-attr">width:</span> '<span class="hljs-attr">100</span>%', 
      <span class="hljs-attr">height:</span> '<span class="hljs-attr">600px</span>',
      <span class="hljs-attr">background:</span> '#<span class="hljs-attr">f5f5f5</span>'
    }}&gt;</span>
      {panels.map(panel =&gt; (
        <span class="hljs-tag">&lt;<span class="hljs-name">Draggable</span>
          <span class="hljs-attr">key</span>=<span class="hljs-string">{panel.id}</span>
          <span class="hljs-attr">defaultPosition</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">x:</span> <span class="hljs-attr">panel.x</span>, <span class="hljs-attr">y:</span> <span class="hljs-attr">panel.y</span> }}
          <span class="hljs-attr">onStop</span>=<span class="hljs-string">{(e,</span> <span class="hljs-attr">data</span>) =&gt;</span> updatePanelPosition(panel.id, data.x, data.y)}
        &gt;
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span>
            <span class="hljs-attr">position:</span> '<span class="hljs-attr">absolute</span>',
            <span class="hljs-attr">width:</span> <span class="hljs-attr">350</span>,
            <span class="hljs-attr">height:</span> <span class="hljs-attr">250</span>,
            <span class="hljs-attr">background:</span> '<span class="hljs-attr">white</span>',
            <span class="hljs-attr">borderRadius:</span> <span class="hljs-attr">8</span>,
            <span class="hljs-attr">boxShadow:</span> '<span class="hljs-attr">0</span> <span class="hljs-attr">2px</span> <span class="hljs-attr">8px</span> <span class="hljs-attr">rgba</span>(<span class="hljs-attr">0</span>,<span class="hljs-attr">0</span>,<span class="hljs-attr">0</span>,<span class="hljs-attr">0.1</span>)',
            <span class="hljs-attr">cursor:</span> '<span class="hljs-attr">move</span>'
          }}&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span>
              <span class="hljs-attr">padding:</span> '<span class="hljs-attr">12px</span> <span class="hljs-attr">16px</span>',
              <span class="hljs-attr">borderBottom:</span> '<span class="hljs-attr">1px</span> <span class="hljs-attr">solid</span> #<span class="hljs-attr">e8e8e8</span>',
              <span class="hljs-attr">fontWeight:</span> '<span class="hljs-attr">bold</span>'
            }}&gt;</span>
              {panel.title}
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">padding:</span> <span class="hljs-attr">16</span>, <span class="hljs-attr">height:</span> '<span class="hljs-attr">calc</span>(<span class="hljs-attr">100</span>% <span class="hljs-attr">-</span> <span class="hljs-attr">50px</span>)' }}&gt;</span>
              面板内容区域
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">Draggable</span>&gt;</span>
      ))}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<h2 data-id="heading-14">高级功能</h2>
<h3 data-id="heading-15">事件处理</h3>
<p>React-Draggable提供了丰富的事件回调：</p>
<pre><code class="hljs language-javascript" lang="javascript">&lt;<span class="hljs-title class_">Draggable</span>
  onStart={<span class="hljs-function">(<span class="hljs-params">e, data</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'拖拽开始'</span>, data);
  }}
  onDrag={<span class="hljs-function">(<span class="hljs-params">e, data</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'拖拽中'</span>, data);
  }}
  onStop={<span class="hljs-function">(<span class="hljs-params">e, data</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'拖拽结束'</span>, data);
  }}
&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>可拖拽元素<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/<span class="hljs-title class_">Draggable</span>&gt;
</code></pre>
<p>事件回调中的<code>data</code>对象包含以下信息：</p>
<ul>
<li><code>x, y</code>: 当前位置坐标</li>
<li><code>deltaX, deltaY</code>: 相对于上次位置的偏移量</li>
<li><code>lastX, lastY</code>: 上次事件的位置</li>
<li><code>node</code>: 被拖拽的DOM节点</li>
</ul>
<h3 data-id="heading-16">控制拖拽行为</h3>
<h4 data-id="heading-17">拖拽句柄</h4>
<p>使用<code>handle</code>属性指定拖拽的触发区域：</p>
<pre><code class="hljs language-javascript" lang="javascript">&lt;<span class="hljs-title class_">Draggable</span> handle=<span class="hljs-string">".drag-handle"</span>&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"drag-handle"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">cursor:</span> '<span class="hljs-attr">move</span>' }}&gt;</span>
      拖拽我
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>内容区域<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/<span class="hljs-title class_">Draggable</span>&gt;
</code></pre>
<h4 data-id="heading-18">取消拖拽</h4>
<p>使用<code>cancel</code>属性指定不可拖拽的区域：</p>
<pre><code class="hljs language-javascript" lang="javascript">&lt;<span class="hljs-title class_">Draggable</span> cancel=<span class="hljs-string">".no-drag"</span>&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>可以拖拽这里<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"no-drag"</span>&gt;</span>点击按钮不会触发拖拽<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/<span class="hljs-title class_">Draggable</span>&gt;
</code></pre>
<h4 data-id="heading-19">网格对齐</h4>
<p>使用<code>grid</code>属性实现网格对齐拖拽：</p>
<pre><code class="hljs language-javascript" lang="javascript">&lt;<span class="hljs-title class_">Draggable</span> grid={[<span class="hljs-number">25</span>, <span class="hljs-number">25</span>]}&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>网格对齐拖拽<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/<span class="hljs-title class_">Draggable</span>&gt;
</code></pre>
<h3 data-id="heading-20">受控组件</h3>
<p>使用受控模式精确控制组件位置：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { useState } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Draggable</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'react-draggable'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">ControlledDraggable</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [position, setPosition] = <span class="hljs-title function_">useState</span>({ <span class="hljs-attr">x</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">0</span> });

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleDrag</span> = (<span class="hljs-params">e, data</span>) =&gt; {
    <span class="hljs-title function_">setPosition</span>({ <span class="hljs-attr">x</span>: data.<span class="hljs-property">x</span>, <span class="hljs-attr">y</span>: data.<span class="hljs-property">y</span> });
  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Draggable</span>
      <span class="hljs-attr">position</span>=<span class="hljs-string">{position}</span>
      <span class="hljs-attr">onDrag</span>=<span class="hljs-string">{handleDrag}</span>
    &gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>受控拖拽组件<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">Draggable</span>&gt;</span></span>
  );
}
</code></pre>
<h2 data-id="heading-21">性能优化</h2>
<h3 data-id="heading-22">使用React.memo优化重渲染</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { memo } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Draggable</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'react-draggable'</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title class_">OptimizedDraggable</span> = <span class="hljs-title function_">memo</span>(<span class="hljs-function">(<span class="hljs-params">{ children, ...props }</span>) =&gt;</span> {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Draggable</span> {<span class="hljs-attr">...props</span>}&gt;</span>
      {children}
    <span class="hljs-tag">&lt;/<span class="hljs-name">Draggable</span>&gt;</span></span>
  );
});
</code></pre>
<h3 data-id="heading-23">限制拖拽频率</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { useRef } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Draggable</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'react-draggable'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">ThrottledDraggable</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> lastUpdate = <span class="hljs-title function_">useRef</span>(<span class="hljs-number">0</span>);

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleDrag</span> = (<span class="hljs-params">e, data</span>) =&gt; {
    <span class="hljs-keyword">const</span> now = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
    <span class="hljs-keyword">if</span> (now - lastUpdate.<span class="hljs-property">current</span> &gt; <span class="hljs-number">16</span>) { <span class="hljs-comment">// 约60fps</span>
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'更新位置:'</span>, data.<span class="hljs-property">x</span>, data.<span class="hljs-property">y</span>);
      lastUpdate.<span class="hljs-property">current</span> = now;
    }
  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Draggable</span> <span class="hljs-attr">onDrag</span>=<span class="hljs-string">{handleDrag}</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>优化性能的拖拽<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">Draggable</span>&gt;</span></span>
  );
}
</code></pre>
<h2 data-id="heading-24">最佳实践</h2>
<h3 data-id="heading-25">1. 合理设置初始位置</h3>
<p>使用<code>defaultPosition</code>而不是直接修改样式：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 推荐</span>
&lt;<span class="hljs-title class_">Draggable</span> defaultPosition={{ <span class="hljs-attr">x</span>: <span class="hljs-number">100</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">100</span> }}&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>正确设置初始位置<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/<span class="hljs-title class_">Draggable</span>&gt;

<span class="hljs-comment">// 不推荐</span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">transform:</span> '<span class="hljs-attr">translate</span>(<span class="hljs-attr">100px</span>, <span class="hljs-attr">100px</span>)' }}&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">Draggable</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>这样会有冲突<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">Draggable</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
</code></pre>
<h3 data-id="heading-26">2. 避免嵌套拖拽</h3>
<p>不要在可拖拽元素内部再嵌套可拖拽元素：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 不推荐</span>
&lt;<span class="hljs-title class_">Draggable</span>&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">Draggable</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>嵌套拖拽会导致问题<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">Draggable</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/<span class="hljs-title class_">Draggable</span>&gt;
</code></pre>
<h3 data-id="heading-27">3. 处理移动端触摸事件</h3>
<p>确保在移动端也能正常工作：</p>
<pre><code class="hljs language-javascript" lang="javascript">&lt;<span class="hljs-title class_">Draggable</span>
  onTouchStart={<span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
    <span class="hljs-comment">// 处理触摸开始事件</span>
  }}
  onTouchEnd={<span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
    <span class="hljs-comment">// 处理触摸结束事件</span>
  }}
&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>移动端友好的拖拽<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/<span class="hljs-title class_">Draggable</span>&gt;
</code></pre>
<h3 data-id="heading-28">4. 可访问性考虑</h3>
<p>为拖拽元素添加适当的ARIA属性：</p>
<pre><code class="hljs language-javascript" lang="javascript">&lt;<span class="hljs-title class_">Draggable</span>&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>
    <span class="hljs-attr">role</span>=<span class="hljs-string">"button"</span>
    <span class="hljs-attr">tabIndex</span>=<span class="hljs-string">{0}</span>
    <span class="hljs-attr">aria-label</span>=<span class="hljs-string">"可拖拽元素"</span>
    <span class="hljs-attr">onKeyDown</span>=<span class="hljs-string">{(e)</span> =&gt;</span> {
      // 支持键盘操作
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        // 处理键盘拖拽逻辑
      }
    }}
  &gt;
    可访问的拖拽元素
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/<span class="hljs-title class_">Draggable</span>&gt;
</code></pre>
<h2 data-id="heading-29">常见问题与解决方案</h2>
<h3 data-id="heading-30">Q: 拖拽时出现闪烁或跳动？</h3>
<p>A: 这通常是由于CSS样式冲突导致的。确保：</p>
<ol>
<li>没有设置<code>position: absolute</code>或<code>position: fixed</code></li>
<li>父元素没有设置<code>transform</code>样式</li>
<li>检查是否有其他JavaScript在修改元素位置</li>
</ol>
<h3 data-id="heading-31">Q: 拖拽不流畅？</h3>
<p>A: 可以尝试以下优化：</p>
<ol>
<li>使用<code>grid</code>属性减少位置更新频率</li>
<li>限制拖拽事件处理函数的复杂度</li>
<li>使用<code>requestAnimationFrame</code>优化动画</li>
</ol>
<h3 data-id="heading-32">Q: 移动端拖拽无效？</h3>
<p>A: 确保：</p>
<ol>
<li>添加了适当的触摸事件处理</li>
<li>检查CSS中是否有<code>touch-action: none</code></li>
<li>确认浏览器支持触摸事件</li>
</ol>
<h2 data-id="heading-33">总结</h2>
<p>React-Draggable是一个功能强大且易于使用的拖拽库，它能够帮助开发者快速实现各种拖拽交互功能。通过本文的介绍，你应该已经掌握了：</p>
<ul>
<li>React-Draggable的基本安装和使用方法</li>
<li>常见的拖拽场景实现</li>
<li>高级功能和性能优化技巧</li>
<li>最佳实践和常见问题解决方案</li>
</ul>
<p>在实际项目中，合理运用这些知识可以大大提升应用的用户体验。记住要根据具体需求选择合适的配置，并始终关注性能和可访问性。</p>
<h2 data-id="heading-34">延伸阅读</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Freact-grid-layout%2Freact-draggable" target="_blank" title="https://github.com/react-grid-layout/react-draggable" ref="nofollow noopener noreferrer">React-Draggable官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.npmtrends.com%2Freact-draggable-vs-react-dnd-vs-react-beautiful-dnd" target="_blank" title="https://www.npmtrends.com/react-draggable-vs-react-dnd-vs-react-beautiful-dnd" ref="nofollow noopener noreferrer">React拖拽库对比分析</a></li>
<li>[Web拖拽API最佳实践](<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2F" target="_blank" title="https://developer.mozilla.org/" ref="nofollow noopener noreferrer">developer.mozilla.org/</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深度解析AI编程技术：从原理到实践，手把手教你落地]]></title>    <link>https://juejin.cn/post/7578723693825490980</link>    <guid>https://juejin.cn/post/7578723693825490980</guid>    <pubDate>2025-12-01T15:07:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578723693825490980" data-draft-id="7578667193321652287" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深度解析AI编程技术：从原理到实践，手把手教你落地"/> <meta itemprop="keywords" content="设计模式,人工智能,开源"/> <meta itemprop="datePublished" content="2025-12-01T15:07:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="OneCodeCN"/> <meta itemprop="url" content="https://juejin.cn/user/1427583415622366"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深度解析AI编程技术：从原理到实践，手把手教你落地
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1427583415622366/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    OneCodeCN
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-01T15:07:25.000Z" title="Mon Dec 01 2025 15:07:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-01
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>AI编程正在重构软件开发的范式——从一句话生成项目框架，到设计稿直接转代码，再到模仿现有工程风格生成新代码，这些曾经的"黑科技"已成为现实。</p>
<p>今天，我们就来系统拆解AI编程的核心技术原理、三大主流模式，以及企业和技术人员的落地指南，帮你搞懂AI编程到底怎么用、能解决什么问题。</p>
<h2 data-id="heading-0">AI编程技术原理深度解析</h2>
<p>AI编程的核心价值，在于把非标准化的开发需求（自然语言、设计稿、现有工程风格）转化为标准化代码。目前主流的AI编程模式有三种，我们逐一拆解其底层逻辑。</p>
<h3 data-id="heading-1">📌 一、意念编程模式（一句话快速构建）：无代码/低代码的需求直达式开发</h3>
<p><strong>简单说</strong>：不用写代码，说句话就能生成可用的项目。比如你说"开发一个科技公司官网"，AI就能直接给你一套能运行的完整框架。</p>
<h4 data-id="heading-2">1. 核心技术逻辑：预计算与按需实例化</h4>
<ul>
<li><strong>卡片组件拆分</strong>：把常用模块（导航栏、表单、游戏交互等）拆成标准化"卡片"，每个卡片包含基础代码、样式占位符（色系、字体等）、功能钩子（按钮跳转等）。</li>
<li><strong>预编译缓存</strong>：所有卡片提前转成抽象语法树（AST）或字节码存在本地/云端，用户提需求时直接从缓存里调，不用实时编译，速度更快。</li>
<li><strong>加权匹配算法</strong>：根据需求拆出4类参数（技术栈40%、行业属性30%、样式20%、本地喜好10%），得分最高的模板组合就是基础框架，既符合技术要求又贴合场景。</li>
</ul>
<h4 data-id="heading-3">2. 大模型核心参数及作用</h4>






























<table><thead><tr><th align="left">参数类型</th><th align="left">核心内涵</th><th align="left">技术作用</th></tr></thead><tbody><tr><td align="left">技术栈参数（Vue/React等）</td><td align="left">指定前端框架</td><td align="left">决定模板语法（如Vue的v-bind、React的useState），自动注入依赖配置</td></tr><tr><td align="left">样式模型参数（色系/风格）</td><td align="left">视觉定位（主色、简约/科技风）</td><td align="left">转化为CSS变量，控制布局、阴影等，统一视觉风格</td></tr><tr><td align="left">行业知识背景</td><td align="left">行业业务特性</td><td align="left">确定模块优先级（如电商优先商品列表），填充通用文本</td></tr><tr><td align="left">本地喜好</td><td align="left">用户历史选择</td><td align="left">构建偏好画像，让输出越来越贴合个人习惯</td></tr></tbody></table>
<h4 data-id="heading-4">3. 完整工作流程</h4>
<ol>
<li>需求解析：把自然语言拆成上述4类参数；</li>
<li>模板匹配：用加权算法从缓存选最合适的卡片组合；</li>
<li>参数注入：替换占位符，生成完整代码；</li>
<li>缓存更新：记录本次生成结果和选择，优化下次匹配。</li>
</ol>
<h3 data-id="heading-5">🎨 二、前端驱动模式（图转代码）：设计稿的自动化代码落地</h3>
<p><strong>简单说</strong>：把Figma、蓝湖的设计稿直接转成可运行的前端代码，省去"设计-开发"的反复沟通。</p>
<h4 data-id="heading-6">1. 核心技术基石：五维坐标体系</h4>
<p>设计稿的每一个元素，都会被拆解成5个维度的属性，确保视觉和交互1:1还原成代码：</p>



































<table><thead><tr><th align="left">维度</th><th align="left">技术内涵</th><th align="left">前端映射逻辑</th></tr></thead><tbody><tr><td align="left">二维平面（X,Y）</td><td align="left">元素位置、宽高</td><td align="left">CSS的position、left/top/width/height，或grid/flex布局</td></tr><tr><td align="left">三维图层透视</td><td align="left">层级、嵌套、投影</td><td align="left">DOM嵌套结构、z-index、box-shadow，组件父子关系</td></tr><tr><td align="left">四维时间轴（动画）</td><td align="left">hover/点击效果、动画时长</td><td align="left">CSS@keyframes/transition、JS事件监听</td></tr><tr><td align="left">五维动作交互</td><td align="left">页面跳转、触发条件</td><td align="left">前端路由配置、滚动监听、事件绑定</td></tr><tr><td align="left">工程化维度</td><td align="left">模块化拆分</td><td align="left">组件文件拆分、目录结构、导入导出逻辑</td></tr></tbody></table>
<h4 data-id="heading-7">2. 大模型工作原理</h4>
<ol>
<li>设计稿解析：通过Figma等工具的API读取元数据，转成五维坐标数据（如{x:100, y:200, animation:{duration:0.5s}}）；</li>
<li>视觉-代码映射：按"设计属性-前端语法"规则，把五维数据转成代码（如平面属性→CSS布局）；</li>
<li>代码优化：自动处理兼容性（加CSS前缀）、删冗余代码，适配指定框架。</li>
</ol>
<h4 data-id="heading-8">3. 核心技术难点与解决方案</h4>
<ul>
<li>设计稿没标hover效果？按行业通用规则补（如按钮默认hover变色）；</li>
<li>多层嵌套导致DOM混乱？用图层树遍历算法，保持嵌套结构一致；</li>
<li>动画参数不匹配？把Figma缓动曲线转成CSS的cubic-bezier函数，确保节奏一致。</li>
</ul>
<h3 data-id="heading-9">🔄 三、后端驱动模式（现有工程学习）：工程风格的模仿式生成</h3>
<p><strong>简单说</strong>：让AI"学习"你现有项目的代码风格、架构和规范，生成的新代码能和老代码无缝衔接，再也不用纠结"风格不统一"。</p>
<h4 data-id="heading-10">1. 核心技术逻辑：从"读取"到"模仿"的三步闭环</h4>
<ol>
<li><strong>工程解析：提取关键特征</strong>undefined通过IDE插件扫描项目，提取技术路线（Vue3/React18、Vite/Webpack）、场景能力（业务模块划分、核心功能）、编码规范（命名规则、注释风格），形成"工程特征库"。</li>
<li><strong>知识库建模与专家模式划分</strong>undefined把特征库结构化存成"专属知识库"（如{framework:'Vue3', indent:2}），并让大模型切换成对应"专家模式"（如"Vue3组合式API专家"），每个模式有专属参数权重。</li>
<li><strong>模仿生成与参数迭代</strong>undefined结合新需求和知识库，生成符合原风格的代码；用户修改后，反向更新知识库，越用越精准。</li>
</ol>
<h4 data-id="heading-11">2. 大模型核心能力支撑</h4>
<ul>
<li>AST级特征提取：通过抽象语法树分析结构，避免表层模仿偏差；</li>
<li>向量数据库检索：把代码特征转成向量，快速匹配规范，提升效率；</li>
<li>细分参数加权：按原工程使用频率分配权重（如100%用组合式API，该参数权重设100%）。</li>
</ul>
<h4 data-id="heading-12">3. 核心技术价值</h4>
<ul>
<li>解决风格冲突，新增代码和老工程无缝衔接；</li>
<li>开发者不用记规范，AI自动对齐；</li>
<li>把工程"隐性经验"（编码习惯）转成"显性参数"，实现知识传承。</li>
</ul>
<h3 data-id="heading-13">📊 四、AI编程的底层逻辑与行业现状</h3>
<h4 data-id="heading-14">1. 三大模式核心技术对比</h4>





























<table><thead><tr><th align="left">模式</th><th align="left">核心技术关键词</th><th align="left">大模型核心作用</th><th align="left">应用场景</th></tr></thead><tbody><tr><td align="left">意念编程</td><td align="left">模板缓存、参数匹配</td><td align="left">需求拆解→模板匹配→参数注入</td><td align="left">官网、小游戏、简易工具</td></tr><tr><td align="left">图转代码</td><td align="left">五维坐标、视觉-代码映射</td><td align="left">设计稿解析→属性解构→语法映射</td><td align="left">设计稿落地、UI还原</td></tr><tr><td align="left">工程学习</td><td align="left">特征提取、知识库建模</td><td align="left">工程解析→规则匹配→模仿生成</td><td align="left">现有项目迭代、新增功能</td></tr></tbody></table>
<p><strong>共性</strong>：都是"参数化配置"为核心，通过大模型把非标准化输入转成标准化代码，本质是"大模型+领域知识+工程规则"的协同。</p>
<h4 data-id="heading-15">2. 大模型优化原理：从"能用"到"好用"</h4>
<ul>
<li><strong>专家模式划分</strong>：按场景拆分能力（如"Vue3开发专家"），强化对应知识；</li>
<li><strong>微调参数技术</strong>：用少量项目规范数据微调模型，避免"泛而不精"；</li>
<li><strong>工作流Agent机制</strong>：多Agent分工协作（需求解析→生成→检查→优化）；</li>
<li><strong>知识库应用</strong>：实时调用领域知识（框架文档、编码规范），确保输出合规；</li>
<li><strong>筛选过滤机制</strong>：评估代码正确性、性能、风格，过滤冗余和风险代码。</li>
</ul>
<h4 data-id="heading-16">3. AIGC演变与AI-IDE行业现状</h4>
<p>2025年国内AI-IDE爆发，阿里Qoder、腾讯CB等产品密集出现。国际上OpenAI奠定"指令微调+代码对齐"范式，国内DeepSeek3.X等模型通过多尺度上下文理解提升中文适配能力，当前竞争核心是智能体（Agent）标准与工作流设计。</p>
<h2 data-id="heading-17">第二部分：实践路径：企业与技术人员的AI编程落地指南</h2>
<h3 data-id="heading-18">🏢 一、企业核心决策：是否需要构建自有大模型体系？</h3>
<h4 data-id="heading-19">（1）场景一：内部研发效率提升——优先借力外部成熟模型</h4>
<p>如果只是想提升内部团队效率（解决重复编码、规范统一等问题），没必要自建大模型：</p>
<ul>
<li>工具选型：用VS Code Copilot、阿里Qoder等开箱即用工具；</li>
<li>流程适配：明确"AI生成-人工校验"机制，重点查业务逻辑和安全；</li>
<li>成本控制：用SaaS按需付费，培训团队Prompt能力最大化价值。</li>
</ul>
<p>适合：传统企业IT部门、中小型互联网团队、非技术驱动型企业。</p>
<h4 data-id="heading-20">（2）场景二：对外提供AI产品服务——必须布局自有部署体系</h4>
<p>如果核心业务是对外提供AI开发服务（如快速建站工具），自建体系是必然：</p>
<ul>
<li><strong>工具输出型企业</strong>（如SaaS厂商）：私有部署降低调用成本，用预编译模板库执行代码生成，计算成本降60%+；</li>
<li><strong>数据驱动型企业</strong>（如金融、医疗）：私有部署保障数据安全，结合行业专属知识库（如风控规则），提升输出适配性。</li>
</ul>
<h3 data-id="heading-21">🔧 二、软件企业AI升级：全链路重构与能力建设</h3>
<p>AI编程不是简单加工具，而是"方法流程、组织能力、技术架构"的全链路升级。</p>
<h4 data-id="heading-22">（1）方法流程升级：从"人工主导"到"人机协同"</h4>
<ul>
<li><strong>全员AI知识升级</strong>：产品、研发、测试都要懂AI——产品经理要会把"页面流畅"转成"首屏加载≤1.5s"；测试用AI生成自动化脚本。</li>
<li><strong>研发CI/CD流程变革</strong>：把AI嵌入全流程：需求→代码生成→自动化测试→安全扫描→部署，研发周期缩短30%+。</li>
<li><strong>企业级Prompt基础构建</strong>：按业务场景（电商订单、金融支付）和技术栈分类沉淀模板，比如："基于Spring Boot 2.7，开发电商订单创建接口，含权限校验、库存预扣，输出Controller+Service代码"。</li>
</ul>
<h4 data-id="heading-23">（2）软件架构升级：构建支撑AI能力的技术底座</h4>
<ul>
<li><strong>RAG知识体系</strong>：把行业方案、编码规范、历史代码转成结构化知识库，AI生成代码时实时调用，确保符合业务规则；</li>
<li><strong>智能体（Agent）管理</strong>：多Agent分工协作（需求解析、前后端生成、测试、安全审计），自动拆解复杂任务；</li>
<li><strong>流程驱动模式</strong>：用户输入参数（如客户信息字段、权限角色），系统自动调用AI生成代码，完成数据库设计、页面开发等；</li>
<li><strong>工具链构建</strong>：对内整合AI工具、知识库、CI/CD；对外封装行业专属工具（如"金融AI开发套件"），开辟新盈利点。</li>
</ul>
<h3 data-id="heading-24">👨💻 三、技术人员视角：从"执行者"到"AI协同指挥官"</h3>
<p>AI不会取代技术人员，而是解放重复劳动，让精力聚焦在核心能力上。</p>
<h4 data-id="heading-25">（1）程序员：构建"AI无法替代的技术壁垒"</h4>
<p>分三个进阶阶段：</p>
<ol>
<li><strong>基础应用阶段：用AI提效重复工作</strong>
<ul>
<li>学习：Prompt基础（5W1H原则：谁用、做什么、何时触发、场景、目标、技术要求）、主流工具操作；</li>
<li>场景：生成CRUD接口、单元测试、格式化代码、翻译技术文档；</li>
<li>技巧：指令要明确"技术栈+功能点+输出格式"，比如："基于Vue3+Pinia，开发购物车功能，含库存校验，输出template+script代码，附注释"。</li>
</ul>
</li>
<li><strong>进阶提升阶段：用AI支撑复杂开发决策</strong>
<ul>
<li>学习：大模型微调基础、AST语法树原理、AI代码优化策略；</li>
<li>场景：拆解复杂业务（如把"电商秒杀"拆成库存预扣、订单创建等模块）、框架迁移、排查性能问题；</li>
<li>技巧：建立"AI生成-人工校验"清单，重点查业务适配性、性能安全性、可维护性。</li>
</ul>
</li>
<li><strong>高阶引领阶段：用AI构建团队专属能力</strong>
<ul>
<li>学习：Agent工作流设计、向量数据库应用、AI工具二次开发；</li>
<li>场景：开发团队专属插件（如校验编码规范的VS Code插件）、构建业务专家模型、主导AI与CI/CD融合；</li>
<li>技巧：沉淀团队Prompt模板库，按业务模块分类，定期迭代优化。</li>
</ul>
</li>
</ol>
<p><strong>避坑点</strong>：别当"AI传声筒"，要懂底层技术（分布式、高并发等），这是架构设计和问题排查的核心。</p>
<h4 data-id="heading-26">（2）产品经理：用AI搭建"需求-技术"的桥梁</h4>
<ol>
<li><strong>需求传递阶段：优化需求表达</strong>
<ul>
<li>学习：技术化语言转化、AI需求拆解工具；</li>
<li>场景：把"页面流畅"转成"首屏加载≤1.5s"、用AI评估需求可行性、生成简易Demo辅助评审；</li>
<li>技巧：PRD里加"AI代码生成提示区"，明确技术栈、交互要求、与现有系统关联点。</li>
</ul>
</li>
<li><strong>研发协同阶段：提升沟通效率</strong>
<ul>
<li>学习：主流技术基础、跨角色沟通方法；</li>
<li>场景：用AI把技术方案转成产品视角说明、分析需求变更影响范围、跟踪研发进度；</li>
<li>技巧：组织"AI需求共创会"，和研发一起用AI生成代码框架，提前对齐需求。</li>
</ul>
</li>
<li><strong>产品创新阶段：探索新可能</strong>
<ul>
<li>学习：多模态AI应用、用户需求挖掘工具；</li>
<li>场景：快速制作创新Demo（如"AI简历分析"）、用AI从用户反馈提炼功能点、优化产品体验；</li>
<li>技巧：建"AI快速原型库"，加速创新想法的验证和迭代。</li>
</ul>
</li>
</ol>
<h3 data-id="heading-27">🌐 四、行业协同：共建AI编程良性生态</h3>
<p>AI编程的健康发展，需要技术厂商、教育机构、行业组织共同努力——从技术创新、人才培养到规范制定，一起推动行业可持续发展。</p>
<p>AI编程正在改变软件开发的游戏规则，无论是企业还是个人，看懂原理、找对路径，才能在这场变革中抓住机遇。你在AI编程实践中遇到过哪些问题？欢迎留言讨论～</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2025博客框架选择指南：Hugo、Astro、Hexo该选哪个？]]></title>    <link>https://juejin.cn/post/7578714735307849754</link>    <guid>https://juejin.cn/post/7578714735307849754</guid>    <pubDate>2025-12-01T15:20:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578714735307849754" data-draft-id="7577228831138545707" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="2025博客框架选择指南：Hugo、Astro、Hexo该选哪个？"/> <meta itemprop="keywords" content="前端,HTML"/> <meta itemprop="datePublished" content="2025-12-01T15:20:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="技术探索家"/> <meta itemprop="url" content="https://juejin.cn/user/2735240657517816"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            2025博客框架选择指南：Hugo、Astro、Hexo该选哪个？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2735240657517816/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    技术探索家
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-01T15:20:37.000Z" title="Mon Dec 01 2025 15:20:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-01
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读15分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/06137ab43a85404491ef287f503bfb58~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oqA5pyv5o6i57Si5a62:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765207236&amp;x-signature=24baS6hJEeNG6CrHajqKTmFzDVE%3D" alt="Gemini_Generated_Image_c4yo85c4yo85c4yo.jpg" loading="lazy"/></p>
<h2 data-id="heading-0">引言</h2>
<p>2025年了，想搭个博客，在Hugo、Hexo、Astro之间纠结了一周，还是不知道选哪个？</p>
<p>我完全理解这种感受。去年我也在这几个博客框架之间来回折腾,看了无数对比文章，最后发现大部分都是2022-2023年的过时内容。性能数据变了、框架更新了、生态也不一样了。每次看完一篇文章就更纠结，到底该听谁的？</p>
<p>更让人崩溃的是，深夜折腾博客配置，第二天还要上班。花了三个月研究框架，结果一篇文章都没写出来。这种感觉，相信你也经历过。</p>
<p>这篇文章基于2024-2025年最新数据，用真实的构建时间测试、实际的使用体验，帮你在5分钟内做出最适合的选择。不是告诉你"哪个最好"，而是"哪个最适合你"。</p>
<p>我会用9大框架的最新性能对比、3分钟决策矩阵，帮你避免90%新手会踩的坑。说实话，早点看到这篇文章，我能省好几周时间。</p>
<h2 data-id="heading-1">为什么2025年还在聊博客框架？</h2>
<h3 data-id="heading-2">静态博客真的还有必要吗？</h3>
<p>老实讲，我一开始也觉得搭博客是个过时的想法。但用了一年多，真香。</p>
<p>静态博客和WordPress这类动态博客的本质区别，就是"提前做好"和"现场制作"的区别。静态网站生成器（SSG）会在你写完文章后，就把所有页面生成好，像做批量打印一样。访客来了直接看成品，速度飞快。WordPress这类动态博客呢，每次有人访问就现场从数据库拉数据、拼装页面，就像现场手工做菜。</p>
<p><strong>为什么静态博客成为主流趋势？</strong></p>
<p>说白了就是：快、便宜、不用操心服务器。</p>
<p>WordPress需要租服务器，一个月怎么也得几十块钱起步。静态博客呢？GitHub Pages、Vercel、Cloudflare Pages全都免费托管。我现在博客一年花费0元，连域名都是之前买的。</p>
<p>性能上更没得比。静态页面的Lighthouse评分能轻松拿到95+，WordPress想到90分都费劲。用户打开页面，一眨眼就加载完了，这种体验真的会让人爱上写博客。</p>
<h3 data-id="heading-3">那什么时候该选动态博客？</h3>
<p>也不是说静态博客就天下无敌。如果你要做复杂的功能，比如：</p>
<ul>
<li>
<p>多人协作发布（需要后台管理）</p>
</li>
<li>
<p>电商集成（要处理支付、订单）</p>
</li>
<li>
<p>复杂的用户系统（评论、权限管理）</p>
</li>
</ul>
<p>这些场景，WordPress或者Ghost确实更合适。但老实说，大部分个人博客和技术博客，真用不到这些。</p>
<p><strong>一句话总结</strong>：个人博客、技术文档、作品展示，选静态博客框架准没错。需要复杂功能、多人协作，才考虑动态博客。</p>
<h2 data-id="heading-4">性能对决 - 谁是速度之王？</h2>
<p>性能这块，说实话是我最关心的。刚开始用Gatsby的时候，每次改一点内容，重新构建等十几分钟，真的想砸电脑。</p>
<h3 data-id="heading-5">构建速度：差距大到惊人</h3>
<p>先说结论：<strong>Hugo是速度之王，没有之一</strong>。</p>
<p>看看这组2024年的实测数据：</p>
<p>| 框架 | 构建10000页用时 | 平均每页速度 |</p>
<p>|------|----------------|-------------|</p>
<p>| <strong>Hugo</strong> | 2.95秒 | &lt;1ms |</p>
<p>| <strong>Hexo</strong> | 45秒（1000页） | ~45ms |</p>
<p>| <strong>Jekyll</strong> | 187.15秒 | ~18ms |</p>
<p>| <strong>Gatsby</strong> | 30分钟+ | ~180ms |</p>
<p>第一次看到Hugo的构建速度，真的惊到我了。10000篇文章，不到3秒！这意味着啥？你改个标题、修个错别字，按个保存，页面刷新，博客就更新完了。这种即时反馈，爽到飞起。</p>
<p>Hexo呢，中型博客（100-1000文章）表现也挺不错。我之前300篇文章的博客，15秒就构建完成，完全够用。</p>
<p>Gatsby...嗯，别提了。我用它做过一个项目，200多篇文章，每次构建5分钟起步。后来文章多了，直接放弃了。</p>
<h3 data-id="heading-6">页面加载速度：Astro异军突起</h3>
<p>2024年Astro成了最大黑马。根据HTTP Archive的数据：</p>
<ul>
<li>
<p><strong>Astro</strong>：中位传输大小889KB（最轻）</p>
</li>
<li>
<p><strong>Hugo</strong>：1,174KB（平衡不错）</p>
</li>
<li>
<p><strong>Next.js</strong>：1,659KB（功能多，体积大）</p>
</li>
</ul>
<p>Astro的"零JavaScript默认"策略真的厉害。页面只加载必要的JS，不像其他框架，把整个React/Vue库都塞给用户。结果就是，页面打开速度飞快，用户体验特别好。</p>
<h3 data-id="heading-7">实际项目表现：别只看数字</h3>
<p>老实讲，如果你博客不到100篇文章，选啥框架都差不多。几秒和十几秒的区别，你感受不出来。</p>
<p>但如果你计划长期写作，文章会越来越多，<strong>提前选个性能好的框架，能省很多麻烦</strong>。我见过太多人，开始用了Gatsby，写到500篇文章，构建慢到受不了，迁移框架，那个痛苦...</p>
<p><strong>推荐组合</strong>：</p>
<ul>
<li>
<p><strong>小型博客（&lt;100文章）</strong>：随便选，都够用</p>
</li>
<li>
<p><strong>中型博客（100-1000文章）</strong>：Hugo、Hexo、Astro</p>
</li>
<li>
<p><strong>大型站点（1000+文章）</strong>：闭眼选Hugo</p>
</li>
</ul>
<h2 data-id="heading-8">开发体验 - 哪个最好用？</h2>
<p>性能再好，用起来糟心，也是白搭。</p>
<h3 data-id="heading-9">学习曲线：新手别踩坑</h3>
<p>说实话，Hugo的Go模板语法，我当初学了好久才上手。那些<code>{{ range }}</code>、<code>{{ with }}</code>的语法，刚开始真的看懵了。虽然性能无敌，但新手上来就选Hugo，可能会被劝退。</p>
<p><strong>新手友好度排名</strong>：</p>
<ol>
<li>
<p><strong>Hexo</strong>（最友好）：Node.js生态，中文文档多到看不过来。配置就是一个<code>_config.yml</code>文件，改几个参数就能跑起来。我当时半小时就搭好了第一个博客。</p>
</li>
<li>
<p><strong>Jekyll</strong>（友好）：Ruby生态，官方文档写得特别清楚，按着步骤来不会错。GitHub Pages原生支持，push一下就自动部署。</p>
</li>
<li>
<p><strong>VuePress</strong>（需要前端基础）：如果你会Vue，上手很快。不会的话，还得先学Vue，成本就高了。</p>
</li>
<li>
<p><strong>Gatsby/Next.js</strong>（陡峭）：要懂React、GraphQL，配置复杂。我看到配置文件就头大。</p>
</li>
</ol>
<p><strong>我的建议</strong>：如果你和我一样是Node.js开发者，Hexo真的是顺手。装个npm包，改改配置，半小时搞定。前端技术栈是React？那Astro或Next.js更合适。别纠结了，新手就选Hexo，错不了。</p>
<h3 data-id="heading-10">配置和自定制：平衡艺术</h3>
<p>Hexo和Jekyll的配置简单直接，一个YAML文件搞定。但也有缺点：想做复杂定制，就得深入源码改，不太灵活。</p>
<p>Gatsby的灵活性确实强，GraphQL数据层可以接各种数据源。但坦白说，个人博客真用不到那么复杂的功能。就像买了辆跑车在市区开，性能过剩了。</p>
<p>Astro走了个中间路线，既灵活又不复杂。支持多框架（React、Vue、Svelte随便混），但配置没那么吓人。这种平衡感，我挺喜欢的。</p>
<h3 data-id="heading-11">开发工具和调试</h3>
<p>现代框架在开发体验上真的吊打老框架。</p>
<p>Vite驱动的Astro和VuePress，热重载快到飞起。改个内容，不到1秒页面就更新了。Webpack那套老架构，等待时间能让人发呆。</p>
<p>Hugo虽然是传统框架，但速度快，改完刷新也很即时。这点体验还不错。</p>
<h2 data-id="heading-12">生态系统 - 主题与插件谁更丰富？</h2>
<p>框架再好，没主题也白搭。谁想从零开始写CSS啊。</p>
<h3 data-id="heading-13">主题生态：Hexo中文世界称王</h3>
<p><strong>Hexo</strong>真的是中文博客的天选之子。200+中文主题，风格各异，总有一款适合你。我用的那个主题，中文文档详细到连怎么改字体颜色都写得清清楚楚。</p>
<p>Hugo主题虽然有300+，但质量参差不齐。有些特别精美，有些就是demo级别。很多主题文档是英文的，踩坑全靠自己摸索。</p>
<p>Jekyll作为老牌框架，主题数量最多，但很多都是好几年前的设计风格了，看着有点过时。</p>
<p>Gatsby和Astro的主题，走的是现代化路线，设计感很强。如果你追求视觉效果，这两个不错。</p>
<h3 data-id="heading-14">插件和扩展能力</h3>
<p>Jekyll的插件生态最庞大，毕竟历史最久。想要啥功能，基本都能找到插件。</p>
<p>Gatsby依托npm生态，插件也超级丰富。但很多插件其实是为商业项目设计的，个人博客可能用不上。</p>
<p>Hexo插件生态在Node.js圈很成熟，常用的评论、搜索、SEO优化，都有现成插件。我装了七八个插件，没遇到过兼容问题。</p>
<h3 data-id="heading-15">社区活跃度：看数据说话</h3>
<p>2024-2025年的数据挺有意思：</p>
<ul>
<li>
<p><strong>Astro</strong>：增长最快，npm下载量2024年9月达到300万。Netlify调查显示，它是2024年开发者关注度最高的框架。</p>
</li>
<li>
<p><strong>Hugo</strong>：GitHub星标6万+，稳定增长，老牌强者。</p>
</li>
<li>
<p><strong>Hexo</strong>：中文社区最活跃，知乎、掘金、CSDN到处都是教程。</p>
</li>
</ul>
<p>说实话，社区活跃度对新手很重要。遇到问题，能搜到中文解决方案，省太多时间了。</p>
<h2 data-id="heading-16">部署与SEO - 上线才是王道</h2>
<p>博客搭好了，不上线有啥用？</p>
<h3 data-id="heading-17">部署平台：全都免费真香</h3>
<p>现在部署静态博客，真的太简单了。</p>
<p><strong>GitHub Pages</strong>：Jekyll原生支持，push代码就自动部署。其他框架需要配个GitHub Actions，也就多写几行配置，5分钟搞定。</p>
<p><strong>Vercel/Netlify</strong>：这俩是我最推荐的。拖个仓库进去，自动识别框架，自动构建部署。都有免费额度，个人博客完全够用。我现在用的Vercel，一年没花过一分钱。</p>
<p><strong>Cloudflare Pages</strong>：性能特别好，CDN全球分布。免费额度也很大，速度比GitHub Pages快不少。</p>
<p>老实讲，2025年部署静态博客，已经没有技术门槛了。真的，比你想象的简单。</p>
<h3 data-id="heading-18">SEO：静态博客天生优势</h3>
<p>所有静态博客框架，SEO都友好。为啥？生成的都是纯HTML，搜索引擎最爱这个。</p>
<p>区别在于细节：</p>
<ul>
<li>
<p><strong>Hugo和Jekyll</strong>：成熟稳定，sitemap、RSS自动生成，SEO基础功能齐全。</p>
</li>
<li>
<p><strong>Astro和Next.js</strong>：在现代SEO实践上更领先，支持更细致的元数据管理，结构化数据也更方便。</p>
</li>
<li>
<p><strong>Hexo</strong>：通过插件实现SEO功能，也挺完善，中文SEO教程多。</p>
</li>
</ul>
<p>说白了，只要你写好内容、优化好关键词、页面结构合理，用哪个框架SEO都不会差。别太纠结这个。</p>
<h3 data-id="heading-19">长期维护成本：别选冷门框架</h3>
<p>这个坑我踩过。之前用过一个小众框架，开始挺好，半年后发现作者不更新了。后来依赖库升级，博客直接跑不起来，迁移框架花了整整一周。</p>
<p><strong>低维护框架</strong>：Hugo、Jekyll。成熟稳定，基本不会出幺蛾子。我Hugo博客跑了一年多，一次问题都没遇到。</p>
<p><strong>需要关注更新</strong>：Gatsby、Next.js。依赖多，更新频繁，偶尔会遇到breaking changes。如果你不想经常折腾，慎选。</p>
<p><strong>平衡选手</strong>：Astro、Hexo。更新有节制，兼容性做得不错。</p>
<h2 data-id="heading-20">决策框架 - 如何选择最适合你的？</h2>
<p>好了，前面说了这么多数据和对比，到底该怎么选？</p>
<h3 data-id="heading-21">3分钟快速决策矩阵</h3>
<p>别想太多，回答三个问题：</p>
<p><strong>问题1：你的技术栈是什么？</strong></p>
<ul>
<li>
<p><strong>熟悉Node.js</strong> → Hexo（新手）/ Astro（追求现代化）</p>
</li>
<li>
<p><strong>React开发者</strong> → Gatsby（重型）/ Astro（轻量）/ Next.js（全栈）</p>
</li>
<li>
<p><strong>Vue开发者</strong> → VuePress（博客+文档）/ Gridsome</p>
</li>
<li>
<p><strong>技术栈不限</strong> → Hugo（性能第一）/ Jekyll（求稳）</p>
</li>
</ul>
<p>如果你和我一样是Node.js开发者，Hexo真的顺手。装个npm包，改改配置，半小时搞定。</p>
<p><strong>问题2：你的项目规模是多大？</strong></p>
<ul>
<li>
<p><strong>&lt;100文章</strong> → 随便选，性能差异你感受不出来</p>
</li>
<li>
<p><strong>100-1000文章</strong> → Hugo（快）/ Hexo（够用）/ Astro（现代）</p>
</li>
<li>
<p><strong>1000+文章或大型文档站</strong> → Hugo（一骑绝尘，没得比）</p>
</li>
</ul>
<p>我现在500多篇文章，用的Hexo，45秒构建完成，完全够用。如果文章继续增长到1000+，可能会换Hugo。</p>
<p><strong>问题3：你的经验水平如何？</strong></p>
<ul>
<li>
<p><strong>新手</strong> → Hexo（中文资源多）/ Jekyll（文档友好）</p>
</li>
<li>
<p><strong>前端开发者</strong> → Astro（现代化体验）/ VuePress（Vue技术栈）</p>
</li>
<li>
<p><strong>性能极客</strong> → Hugo（速度无敌，值得学Go模板）</p>
</li>
<li>
<p><strong>求稳用户</strong> → Jekyll（GitHub原生支持，最省心）</p>
</li>
</ul>
<h3 data-id="heading-22">典型场景具体推荐</h3>
<p><strong>个人技术博客</strong>：</p>
<ul>
<li>
<p>中文用户：Hexo（生态强，主题多）</p>
</li>
<li>
<p>国际化：Hugo（性能好，英文资源丰富）</p>
</li>
<li>
<p>追求现代化：Astro（体验好，性能也不错）</p>
</li>
</ul>
<p><strong>技术文档站点</strong>：</p>
<ul>
<li>
<p>Docusaurus（Facebook出品，专为文档设计）</p>
</li>
<li>
<p>VuePress（Vue生态，中文支持好）</p>
</li>
</ul>
<p><strong>大型内容站点</strong>：</p>
<ul>
<li>Hugo（1000+页面，只有它能扛住）</li>
</ul>
<p><strong>现代化项目网站</strong>：</p>
<ul>
<li>
<p>Astro（灵活性+性能的最佳平衡）</p>
</li>
<li>
<p>Next.js（需要动态功能时选它）</p>
</li>
</ul>
<h3 data-id="heading-23">我的真实建议</h3>
<p>说实话，<strong>别再纠结了</strong>。我见过太多人花三个月研究框架，一篇文章没写。框架真的只是工具，内容才是核心。</p>
<p><strong>选择建议</strong>：</p>
<ul>
<li>
<p><strong>90%的人</strong>：选Hexo或Hugo，够用了</p>
</li>
<li>
<p><strong>前端开发者</strong>：Astro值得尝试，体验很现代</p>
</li>
<li>
<p><strong>新手怕选错</strong>：Hexo，中文教程多到看不完，遇到问题都能搜到答案</p>
</li>
<li>
<p><strong>性能焦虑症患者</strong>：闭眼选Hugo，速度真的无敌</p>
</li>
</ul>
<p>记住：框架可以迁移（内容都是Markdown，搬家成本不高），但荒废的时间回不来。先选一个动起来，边用边优化，这才是正道。</p>
<h2 data-id="heading-24">避坑指南与最佳实践</h2>
<p>最后说说那些大坑，我替你踩过了。</p>
<h3 data-id="heading-25">5个常见错误</h3>
<p><strong>错误1：过度追求完美框架，迟迟不开始</strong></p>
<p>这个坑我踩得最深。当年对比了两个月框架，看了几十篇文章，结果还是不确定。后来一个前辈跟我说："先选一个动起来，框架不满意可以换，但浪费的时间回不来。"</p>
<p>说白了，<strong>内容才是博客的核心，框架只是工具</strong>。没有完美的框架，只有最适合当下的选择。</p>
<p><strong>错误2：只看主题外观，忽略框架本质</strong></p>
<p>看到某个Hugo主题特别炫酷，就选了Hugo。结果发现Go模板语法学不会，自定义主题难如登天。最后用了半年，还是换回Hexo。</p>
<p>主题可以定制、可以换，但框架的性能、生态、维护性，这些本质特性才是长期影响你的因素。</p>
<p><strong>错误3：新手直接上Gatsby/Next.js被劝退</strong></p>
<p>我一朋友，刚学前端，听说Gatsby牛逼，直接上手。结果GraphQL不会、React不熟、配置看不懂，折腾两周直接放弃了。</p>
<p>老实说，<strong>Gatsby和Next.js真的不适合新手</strong>。它们是给有经验的开发者准备的工具。新手想快速上线博客，Hexo或Jekyll才是正确选择。</p>
<p><strong>错误4：忽略长期维护成本</strong></p>
<p>选了个冷门框架，一开始挺好，半年后作者不更新了。依赖库升级，博客跑不起来。迁移框架，痛苦得要死。</p>
<p><strong>看框架选择的三个指标</strong>：</p>
<ul>
<li>
<p>GitHub更新频率（至少每月有commit）</p>
</li>
<li>
<p>社区规模（遇到问题能找到人问）</p>
</li>
<li>
<p>中文资源（新手必看，能省80%时间）</p>
</li>
</ul>
<p><strong>错误5：花80%时间折腾框架，20%写内容</strong></p>
<p>我见过太多人，陷入"完美主义陷阱"。CSS改来改去、插件装了卸卸了装，就是不写文章。</p>
<p>记住<strong>80/20法则</strong>：80%精力写内容，20%折腾框架。够用就好，别追求极致完美。</p>
<h3 data-id="heading-26">框架迁移建议</h3>
<p>万一真选错了，想换框架怎么办？</p>
<p>其实没那么可怕。所有静态博客框架，内容都是Markdown，迁移成本不高。我从Hexo迁移到Hugo，内容迁移只花了1小时。主要是配置和主题要重新搞，但也就半天时间。</p>
<p><strong>迁移原则</strong>：</p>
<ul>
<li>
<p><strong>先有后优</strong>：快速上线 &gt; 完美配置</p>
</li>
<li>
<p><strong>内容优先</strong>：写够50篇文章再考虑迁移，不然没必要</p>
</li>
<li>
<p><strong>不影响SEO</strong>：做好301重定向，URL结构尽量保持一致</p>
</li>
</ul>
<h3 data-id="heading-27">2025年趋势展望</h3>
<p>根据2024-2025的数据和社区动向，我预测：</p>
<ul>
<li>
<p><strong>Astro会继续增长</strong>：岛屿架构是未来趋势，零JavaScript默认太香了</p>
</li>
<li>
<p><strong>Hugo保持性能王者地位</strong>：大型站点没得选</p>
</li>
<li>
<p><strong>Hexo中文生态持续稳定</strong>：中文博客的首选不会变</p>
</li>
<li>
<p><strong>传统框架逐步被取代</strong>：Jekyll虽然稳定，但新项目会越来越少</p>
</li>
</ul>
<p>但说实话，趋势只是参考。选框架还是要看自己的需求和技术栈。</p>
<h2 data-id="heading-28">结论</h2>
<p>回到最开始的问题：2025年博客框架该怎么选？</p>
<p><strong>一句话总结</strong>：</p>
<ul>
<li>
<p><strong>新手首选</strong>：Hexo（中文资源丰富，主题多，上手快）</p>
</li>
<li>
<p><strong>前端开发者</strong>：Astro（性能+灵活性的最佳平衡，现代化体验）</p>
</li>
<li>
<p><strong>性能极客</strong>：Hugo（速度无敌，适合大型站点）</p>
</li>
<li>
<p><strong>文档站点</strong>：Docusaurus/VuePress（专为文档设计）</p>
</li>
<li>
<p><strong>求稳</strong>：Jekyll（GitHub原生支持，最省心）</p>
</li>
</ul>
<p>但老实讲，<strong>选择框架只需要5分钟，写好内容需要一辈子</strong>。</p>
<p>别再纠结了。选一个顺手的，开始行动吧。写第一篇文章，比研究框架重要一百倍。</p>
<p>我当初纠结了两个月，现在回头看，那段时间完全是浪费。早点开始写，现在可能已经有200篇文章了。</p>
<p><strong>行动建议</strong>：</p>
<ol>
<li>
<p>根据上面的决策矩阵，花5分钟选一个框架</p>
</li>
<li>
<p>找个主题，1小时搭好环境</p>
</li>
<li>
<p>写第一篇文章，哪怕只有500字</p>
</li>
<li>
<p>发布上线，享受成就感</p>
</li>
</ol>
<p>记住：<strong>框架不重要，内容才重要。够用就好，专注写作。</strong></p>
<p>评论区说说你的选择和理由？我很好奇大家最后都选了什么。如果有问题，我会尽量回复的。</p>
<blockquote>
<p>本文首发自<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.betterlink.top%2Fzh%2F" target="_blank" title="https://blog.betterlink.top/zh/" ref="nofollow noopener noreferrer">个人博客</a></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Kubernetes Service动手实验]]></title>    <link>https://juejin.cn/post/7578724773993381914</link>    <guid>https://juejin.cn/post/7578724773993381914</guid>    <pubDate>2025-12-01T15:27:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578724773993381914" data-draft-id="7578732288515670067" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Kubernetes Service动手实验"/> <meta itemprop="keywords" content="Kubernetes"/> <meta itemprop="datePublished" content="2025-12-01T15:27:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="哈里谢顿"/> <meta itemprop="url" content="https://juejin.cn/user/3678304397695056"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Kubernetes Service动手实验
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3678304397695056/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    哈里谢顿
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-01T15:27:28.000Z" title="Mon Dec 01 2025 15:27:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-01
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>非常好的问题！验证 Kubernetes Service（svc）是否正常工作，是日常开发和运维的核心技能。下面我为你设计 <strong>5 个由浅入深的动手实验</strong>，全部基于命令行操作，你可以在自己的集群（如你的 <code>k8s-master-node</code>）上直接运行。</p>
<hr/>
<h2 data-id="heading-0">🧪 实验前提</h2>
<p>确保你已有一个运行中的 Pod（我们用 Nginx 作为示例）：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 创建 Deployment</span>
kubectl create deployment nginx <span class="hljs-attr">--image</span>=nginx --replicas=<span class="hljs-number">2</span>

<span class="hljs-comment"># 等待 Pod Running</span>
kubectl get pods -l <span class="hljs-attr">app</span>=nginx
</code></pre>
<hr/>
<h2 data-id="heading-1">🔬 实验 1：创建 ClusterIP Service 并从集群内访问</h2>
<h3 data-id="heading-2">✅ 目标：验证 Service 能在集群内部负载均衡</h3>
<h4 data-id="heading-3">步骤：</h4>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 1. 创建 ClusterIP Service</span>
kubectl expose deployment nginx <span class="hljs-attr">--port</span>=<span class="hljs-number">80</span> --target-port=<span class="hljs-number">80</span> --name=nginx-svc

<span class="hljs-comment"># 2. 查看 Service 和 Endpoints</span>
kubectl get svc nginx-svc
kubectl get endpoints nginx-svc  <span class="hljs-comment"># 应显示 2 个 Pod IP</span>

<span class="hljs-comment"># 3. 启动一个临时调试 Pod（busybox）</span>
kubectl run debug <span class="hljs-attr">--image</span>=busybox:<span class="hljs-number">1.28</span> -it --rm --restart=Never -- sh

<span class="hljs-comment"># 在 debug 容器内执行：</span>
/ <span class="hljs-comment"># wget -qO- http://nginx-svc</span>
/ <span class="hljs-comment"># wget -qO- http://nginx-svc</span>
</code></pre>
<h4 data-id="heading-4">✅ 预期结果：</h4>
<ul>
<li>每次请求可能返回不同 Pod 的欢迎页（虽然内容一样，但可通过日志区分）</li>
<li>证明 Service 做了负载均衡</li>
</ul>
<blockquote>
<p>💡 提示：你可以进入每个 Nginx Pod 添加唯一标识：</p>
<pre><code class="hljs language-css" lang="css">kubectl exec &lt;pod1&gt; -- sh -c 'echo "&lt;<span class="hljs-selector-tag">h1</span>&gt;Pod <span class="hljs-number">1</span>&lt;/<span class="hljs-selector-tag">h1</span>&gt;" &gt; /usr/share/nginx/<span class="hljs-selector-tag">html</span>/index<span class="hljs-selector-class">.html</span>'
kubectl exec &lt;pod2&gt; -- sh -c 'echo "&lt;<span class="hljs-selector-tag">h1</span>&gt;Pod <span class="hljs-number">2</span>&lt;/<span class="hljs-selector-tag">h1</span>&gt;" &gt; /usr/share/nginx/<span class="hljs-selector-tag">html</span>/index<span class="hljs-selector-class">.html</span>'
</code></pre>
<p>再 curl 就能看到轮流返回 Pod 1 / Pod 2！</p>
</blockquote>
<hr/>
<h2 data-id="heading-5">🔬 实验 2：验证 DNS 解析（Service 名称 → ClusterIP）</h2>
<h3 data-id="heading-6">✅ 目标：确认 CoreDNS 能正确解析 Service</h3>
<h4 data-id="heading-7">步骤：</h4>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 进入 debug Pod（如果已退出，重新创建）</span>
kubectl run dns-test <span class="hljs-attr">--image</span>=busybox:<span class="hljs-number">1.28</span> -it --rm --restart=Never -- nslookup nginx-svc
</code></pre>
<h4 data-id="heading-8">✅ 预期输出：</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">Server:</span>    <span class="hljs-number">10.96</span><span class="hljs-number">.0</span><span class="hljs-number">.10</span>      <span class="hljs-comment"># CoreDNS IP</span>
<span class="hljs-attr">Address 1:</span> <span class="hljs-number">10.96</span><span class="hljs-number">.0</span><span class="hljs-number">.10</span> <span class="hljs-string">kube-dns.kube-system.svc.cluster.local</span>

<span class="hljs-attr">Name:</span>      <span class="hljs-string">nginx-svc</span>
<span class="hljs-attr">Address 1:</span> <span class="hljs-number">10.96</span><span class="hljs-number">.123</span><span class="hljs-number">.45</span>     <span class="hljs-comment"># 这就是 Service 的 ClusterIP！</span>
</code></pre>
<blockquote>
<p>✅ 说明：<code>nginx-svc</code> 被成功解析为 ClusterIP</p>
</blockquote>
<h4 data-id="heading-9">扩展测试（完整 FQDN）：</h4>
<pre><code class="hljs language-arduino" lang="arduino">kubectl run dns-fqdn --image=busybox:<span class="hljs-number">1.28</span> -it --rm --restart=Never -- \
  nslookup nginx-svc.<span class="hljs-keyword">default</span>.svc.cluster.local
</code></pre>
<hr/>
<h2 data-id="heading-10">🔬 实验 3：创建 NodePort Service 并从集群外访问</h2>
<h3 data-id="heading-11">✅ 目标：验证外部流量能通过节点端口到达 Pod</h3>
<h4 data-id="heading-12">步骤：</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 创建 NodePort Service（自动分配端口）</span>
kubectl expose deployment nginx --port=80 --target-port=80 --<span class="hljs-built_in">type</span>=NodePort --name=nginx-np

<span class="hljs-comment"># 2. 查看分配的端口</span>
kubectl get svc nginx-np
<span class="hljs-comment"># 输出示例：nginx-np   NodePort   10.96.200.100   80:31234/TCP</span>
<span class="hljs-comment"># 记下 31234（你的端口可能不同）</span>

<span class="hljs-comment"># 3. 从你的本地电脑（或 master 节点 shell）访问</span>
curl http://localhost:31234          <span class="hljs-comment"># 如果你在 master 节点本机</span>
<span class="hljs-comment"># 或</span>
curl http://&lt;你的节点公网/内网IP&gt;:31234   <span class="hljs-comment"># 如 192.168.18.133:31234</span>
</code></pre>
<h4 data-id="heading-13">⚠️ 如果访问失败，检查：</h4>
<ul>
<li>防火墙是否放行端口（如 <code>sudo ufw allow 31234</code>）</li>
<li>节点安全组（云服务器需配置入站规则）</li>
</ul>
<h4 data-id="heading-14">✅ 预期结果：</h4>
<p>返回 Nginx 欢迎页，证明 <strong>外部 → NodePort → Service → Pod</strong> 链路打通。</p>
<hr/>
<h2 data-id="heading-15">🔬 实验 4：故意破坏 Service，观察故障现象</h2>
<h3 data-id="heading-16">✅ 目标：理解 Service 与 Pod 的解耦关系</h3>
<h4 data-id="heading-17">步骤：</h4>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 1. 删除所有后端 Pod（Deployment 会自动重建）</span>
kubectl delete pods -l <span class="hljs-attr">app</span>=nginx

<span class="hljs-comment"># 2. 立即查看 Endpoints</span>
kubectl get endpoints nginx-svc  <span class="hljs-comment"># 应该为空（&lt;none&gt;）</span>

<span class="hljs-comment"># 3. 尝试访问 Service（从 debug Pod）</span>
kubectl run test-bad <span class="hljs-attr">--image</span>=curlimages/curl -it --rm --restart=Never -- \
  curl -m 3 http://nginx-svc
</code></pre>
<h4 data-id="heading-18">✅ 预期结果：</h4>
<ul>
<li>请求超时（<code>curl: (28) Connection timed out</code>）</li>
<li>说明：<strong>Service 存在 ≠ 后端可用</strong>，必须有匹配的 Pod</li>
</ul>
<blockquote>
<p>💡 这就是为什么监控要同时关注 <strong>Service</strong> 和 <strong>Pod Ready 状态</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-19">🔬 实验 5：跨命名空间调用 Service</h2>
<h3 data-id="heading-20">✅ 目标：验证 Service 的命名空间隔离与跨空间访问</h3>
<h4 data-id="heading-21">步骤：</h4>
<pre><code class="hljs language-arduino" lang="arduino"># <span class="hljs-number">1.</span> 创建新命名空间
kubectl create ns test-ns

# <span class="hljs-number">2.</span> 在 <span class="hljs-keyword">default</span> 命名空间保留 nginx-svc

# <span class="hljs-number">3.</span> 从 test-ns 中访问 <span class="hljs-keyword">default</span> 的 Service
kubectl run cross-ns --image=busybox:<span class="hljs-number">1.28</span> -n test-ns -it --rm --restart=Never -- \
  wget -qO- http:<span class="hljs-comment">//nginx-svc.default.svc.cluster.local</span>
</code></pre>
<h4 data-id="heading-22">✅ 关键点：</h4>
<ul>
<li>必须使用 <strong>完整 DNS 名称</strong>：<code>&lt;service&gt;.&lt;namespace&gt;.svc.cluster.local</code></li>
<li>不能只写 <code>nginx-svc</code>（因为当前命名空间是 <code>test-ns</code>）</li>
</ul>
<h4 data-id="heading-23">✅ 预期结果：</h4>
<p>成功返回 Nginx 页面，证明跨命名空间通信可行。</p>
<hr/>
<h2 data-id="heading-24">🛠️ 附加：常用诊断命令速查表</h2>





























<table><thead><tr><th>场景</th><th>命令</th></tr></thead><tbody><tr><td>查看 Service 详情</td><td><code>kubectl describe svc &lt;name&gt;</code></td></tr><tr><td>查看后端 Pod 列表</td><td><code>kubectl get endpoints &lt;svc-name&gt;</code></td></tr><tr><td>测试连通性（集群内）</td><td><code>kubectl run -it --rm debug --image=busybox --restart=Never -- telnet &lt;svc&gt; 80</code></td></tr><tr><td>查看 kube-proxy 日志</td><td><code>kubectl logs -n kube-system -l k8s-app=kube-proxy</code></td></tr><tr><td>检查防火墙（Linux）</td><td><code>sudo ufw status</code> 或 <code>sudo iptables -L</code></td></tr></tbody></table>
<hr/>
<h2 data-id="heading-25">✅ 总结：验证 Service 的核心思路</h2>
<ol>
<li><strong>查配置</strong>：<code>kubectl get/describe svc</code></li>
<li><strong>查后端</strong>：<code>kubectl get endpoints</code>（必须非空！）</li>
<li><strong>集群内测</strong>：用临时 Pod curl/telnet</li>
<li><strong>集群外测</strong>：NodePort / LoadBalancer + 防火墙检查</li>
<li><strong>看 DNS</strong>：<code>nslookup &lt;svc-name&gt;</code></li>
</ol>
<blockquote>
<p>💡 <strong>记住：Service 是虚拟 IP，真正干活的是 Endpoints（Pod 列表）！</strong></p>
</blockquote>
<hr/>
<p>现在就去你的 <code>k8s-master-node</code> 上动手试试吧！每完成一个实验，你对 K8s 网络的理解就更深一层。如果某个实验卡住了，欢迎贴出你的命令和输出，我可以帮你分析！🚀</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[大量异步并发请求控制并发解决方案]]></title>    <link>https://juejin.cn/post/7578714759337443328</link>    <guid>https://juejin.cn/post/7578714759337443328</guid>    <pubDate>2025-12-01T15:51:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578714759337443328" data-draft-id="7578724773993398298" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="大量异步并发请求控制并发解决方案"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-01T15:51:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="veneno"/> <meta itemprop="url" content="https://juejin.cn/user/1381457252330183"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            大量异步并发请求控制并发解决方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1381457252330183/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    veneno
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-01T15:51:37.000Z" title="Mon Dec 01 2025 15:51:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-01
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>实现思路：</p>
<p>可以使用 Promise 和异步函数。手动实现一个同步队列</p>
<p>测试数据</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> tasks = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(<span class="hljs-number">88</span>).<span class="hljs-title function_">fill</span>(<span class="hljs-number">0</span>).<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">_, i</span>) =&gt;</span> <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> {
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-title function_">resolve</span>(i)
    }, <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">1000</span>)
  })
})
</code></pre>
<p>核心代码</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">limitRequest</span>(<span class="hljs-params">tasks, limit</span>) {
  <span class="hljs-keyword">const</span> queue = []
  <span class="hljs-keyword">let</span> runingCount = <span class="hljs-number">0</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">enqueque</span>(<span class="hljs-params">task</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
      queue.<span class="hljs-title function_">push</span>({
        task,
        resolve,
        reject,
      })
      <span class="hljs-title function_">run</span>()
    })
  }

  <span class="hljs-keyword">function</span> <span class="hljs-title function_">run</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">while</span> (queue.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span> &amp;&amp; runingCount &lt; limit) {
      runingCount++
      <span class="hljs-keyword">const</span> { task, resolve, reject } = queue.<span class="hljs-title function_">shift</span>()
      <span class="hljs-title function_">task</span>()
        .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">value</span>) =&gt;</span> {<span class="hljs-title function_">resolve</span>(value);<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(value)})
        .<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> <span class="hljs-title function_">reject</span>(err))
        .<span class="hljs-title function_">finally</span>(<span class="hljs-function">() =&gt;</span> {
          runingCount--
          <span class="hljs-title function_">run</span>()
        })
    }
  }

  <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>(tasks.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">task</span>) =&gt;</span> <span class="hljs-title function_">enqueque</span>(task)))
}
</code></pre>
<p>测试代码</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-keyword">await</span> <span class="hljs-title function_">limitRequest</span>(tasks, <span class="hljs-number">10</span>))
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Reactor网络模型深度解析：从并发困境说起]]></title>    <link>https://juejin.cn/post/7578714735307636762</link>    <guid>https://juejin.cn/post/7578714735307636762</guid>    <pubDate>2025-12-01T14:12:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578714735307636762" data-draft-id="7578714735307620378" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Reactor网络模型深度解析：从并发困境说起"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-01T14:12:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="码事漫谈"/> <meta itemprop="url" content="https://juejin.cn/user/1972974802965230"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Reactor网络模型深度解析：从并发困境说起
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1972974802965230/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    码事漫谈
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-01T14:12:19.000Z" title="Mon Dec 01 2025 14:12:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-01
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文深入探讨Reactor网络模型的核心机制，解答高并发场景下的关键问题，揭示现代高性能服务器的架构奥秘。通过对比分析、原理阐述和实战代码，带您彻底理解Reactor如何优雅应对海量并发请求。</p>
</blockquote>
<h2 data-id="heading-0"><strong>并发困难</strong></h2>
<p>想象这样一个场景：你的电商网站正在举办"双11"大促，每秒有10万用户同时点击"立即购买"。传统的"一线程一连接"架构瞬间崩溃——不是内存耗尽，就是CPU被上下文切换拖垮。</p>
<p>这正是我在职业生涯早期遭遇的真实困境。直到我理解了<strong>Reactor模式</strong>，才发现原来高性能网络编程可以如此优雅。</p>
<h2 data-id="heading-1"><strong>第一章：传统并发模型的崩溃边缘</strong></h2>
<h3 data-id="heading-2"><strong>1.1 阻塞I/O的致命缺陷</strong></h3>
<p>让我们从最直观的代码开始：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 经典的多线程服务器 - 每个连接一个线程</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">handle_client</span><span class="hljs-params">(<span class="hljs-type">int</span> sockfd)</span> </span>{
    <span class="hljs-type">char</span> buffer[<span class="hljs-number">1024</span>];
    <span class="hljs-comment">// 阻塞点：数据未到达时线程休眠</span>
    <span class="hljs-type">int</span> n = <span class="hljs-built_in">recv</span>(sockfd, buffer, <span class="hljs-built_in">sizeof</span>(buffer), <span class="hljs-number">0</span>);
    <span class="hljs-comment">// 线程被唤醒，处理业务</span>
    <span class="hljs-built_in">process_request</span>(buffer);
    <span class="hljs-built_in">send</span>(sockfd, response, <span class="hljs-built_in">strlen</span>(response), <span class="hljs-number">0</span>);
}

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-type">int</span> server_fd = <span class="hljs-built_in">socket</span>(AF_INET, SOCK_STREAM, <span class="hljs-number">0</span>);
    <span class="hljs-comment">// ... bind, listen</span>
    
    <span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>) {
        <span class="hljs-type">int</span> client_fd = <span class="hljs-built_in">accept</span>(server_fd, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);
        <span class="hljs-comment">// 致命的资源消耗：每个线程需要8MB栈空间</span>
        <span class="hljs-function">std::thread <span class="hljs-title">t</span><span class="hljs-params">(handle_client, client_fd)</span></span>;
        t.<span class="hljs-built_in">detach</span>();
    }
}
</code></pre>
<p><strong>问题分析</strong>：</p>
<ul>
<li>连接数增长 → 线程数线性增长</li>
<li>1000个连接 ≈ 8GB内存（仅线程栈）</li>
<li>上下文切换开销呈指数级上升</li>
<li>大部分线程处于阻塞等待状态（资源浪费）</li>
</ul>
<h3 data-id="heading-3"><strong>1.2 C10K问题的挑战</strong></h3>
<p>2000年提出的C10K（并发1万连接）问题，暴露了传统模型的根本缺陷：</p>

























<table><thead><tr><th>资源类型</th><th>传统模型消耗</th><th>物理限制</th></tr></thead><tbody><tr><td>内存</td><td>10,000 × 8MB = 80GB</td><td>服务器通常只有128GB</td></tr><tr><td>文件描述符</td><td>10,000</td><td>系统默认限制1024</td></tr><tr><td>CPU时间</td><td>大量用于线程切换</td><td>实际业务处理占比低</td></tr></tbody></table>
<h2 data-id="heading-4"><strong>第二章：Reactor的架构革命</strong></h2>
<h3 data-id="heading-5"><strong>2.1 核心思想：事件驱动与状态机</strong></h3>
<p>Reactor模式的核心转变：<strong>从"主动轮询"到"被动通知"</strong>。</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 传统模型：主动询问每个连接</span>
<span class="hljs-keyword">for</span>(each connection) {
    <span class="hljs-keyword">if</span>(<span class="hljs-built_in">has_data</span>(connection)) {  <span class="hljs-comment">// 主动检查</span>
        <span class="hljs-built_in">process</span>(connection);
    }
}

<span class="hljs-comment">// Reactor模型：等待事件通知</span>
<span class="hljs-keyword">while</span>(events = <span class="hljs-built_in">wait_for_events</span>()) {  <span class="hljs-comment">// 被动等待</span>
    <span class="hljs-keyword">for</span>(each event in events) {
        <span class="hljs-built_in">handle_event</span>(event);  <span class="hljs-comment">// 事件触发处理</span>
    }
}
</code></pre>
<h3 data-id="heading-6"><strong>2.2 系统调用：从select到epoll的演进</strong></h3>
<p><strong>第一代：select/poll的局限</strong></p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">select</span><span class="hljs-params">(<span class="hljs-type">int</span> nfds, fd_set *readfds, fd_set *writefds, 
           fd_set *exceptfds, <span class="hljs-keyword">struct</span> timeval *timeout)</span></span>;
</code></pre>
<ul>
<li>每次调用需要传递全部fd集合（用户态→内核态拷贝）</li>
<li>内核线性扫描所有fd（O(n)复杂度）</li>
<li>fd数量限制（通常1024）</li>
</ul>
<p><strong>第二代：epoll的突破</strong></p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 1. 创建epoll实例</span>
<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">epoll_create</span><span class="hljs-params">(<span class="hljs-type">int</span> size)</span></span>;

<span class="hljs-comment">// 2. 注册/修改fd兴趣</span>
<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">epoll_ctl</span><span class="hljs-params">(<span class="hljs-type">int</span> epfd, <span class="hljs-type">int</span> op, <span class="hljs-type">int</span> fd, <span class="hljs-keyword">struct</span> epoll_event *event)</span></span>;

<span class="hljs-comment">// 3. 等待事件</span>
<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">epoll_wait</span><span class="hljs-params">(<span class="hljs-type">int</span> epfd, <span class="hljs-keyword">struct</span> epoll_event *events, 
               <span class="hljs-type">int</span> maxevents, <span class="hljs-type">int</span> timeout)</span></span>;
</code></pre>
<p><strong>epoll的核心优势</strong>：</p>
<ol>
<li><strong>红黑树存储fd</strong>：高效增删改（O(log n)）</li>
<li><strong>就绪列表</strong>：事件触发时加入列表</li>
<li><strong>mmap共享内存</strong>：避免用户态-内核态数据拷贝</li>
<li><strong>边缘触发(ET)</strong>：减少事件通知次数</li>
</ol>
<h3 data-id="heading-7"><strong>2.3 Reactor的完整架构</strong></h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// Reactor模式四层架构</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ReactorArchitecture</span> {
<span class="hljs-keyword">private</span>:
    <span class="hljs-comment">// 1. 事件多路分发器（Demultiplexer）</span>
    EventDemultiplexer* demux;
    
    <span class="hljs-comment">// 2. 事件处理器注册表（Event Handler Registry）</span>
    std::map&lt;Handle, EventHandler*&gt; handlers;
    
    <span class="hljs-comment">// 3. 事件循环（Event Loop）</span>
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">event_loop</span><span class="hljs-params">()</span></span>;
    
    <span class="hljs-comment">// 4. 具体事件处理器（Concrete Event Handlers）</span>
    <span class="hljs-keyword">class</span> <span class="hljs-title class_">AcceptorHandler</span> : <span class="hljs-keyword">public</span> EventHandler {...};
    <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConnectionHandler</span> : <span class="hljs-keyword">public</span> EventHandler {...};
};

<span class="hljs-comment">// 事件循环核心算法</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Reactor::event_loop</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">while</span>(!stop) {
        <span class="hljs-comment">// 等待事件发生（毫秒级甚至纳秒级）</span>
        <span class="hljs-keyword">auto</span> events = demux-&gt;<span class="hljs-built_in">select</span>(timeout);
        
        <span class="hljs-comment">// 分发事件到对应处理器</span>
        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">auto</span>&amp; event : events) {
            EventHandler* handler = <span class="hljs-built_in">get_handler</span>(event.handle);
            <span class="hljs-keyword">if</span>(handler) {
                handler-&gt;<span class="hljs-built_in">handle_event</span>(event.type);
            }
        }
        
        <span class="hljs-comment">// 处理定时器事件</span>
        <span class="hljs-built_in">process_timers</span>();
        
        <span class="hljs-comment">// 处理异步任务</span>
        <span class="hljs-built_in">process_async_tasks</span>();
    }
}
</code></pre>
<h2 data-id="heading-8"><strong>第三章：深入关键问题：并发消息处理机制</strong></h2>
<h3 data-id="heading-9"><strong>3.1 问题的本质：Reactor如何处理"同时到达"的消息？</strong></h3>
<p>这是最常见的误解点。我们需要区分两个概念：</p>
<ul>
<li><strong>物理同时</strong>：多个数据包在同一纳秒到达网卡</li>
<li><strong>逻辑同时</strong>：Reactor在单次事件循环中处理多个就绪事件</li>
</ul>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 实际的处理时序</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Reactor::handle_events</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-comment">// 单次epoll_wait可能返回多个就绪socket</span>
    <span class="hljs-type">int</span> n = <span class="hljs-built_in">epoll_wait</span>(epfd, events, <span class="hljs-number">64</span>, <span class="hljs-number">-1</span>);
    
    <span class="hljs-comment">// 这些socket的数据"几乎同时"到达内核缓冲区</span>
    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; n; i++) {
        <span class="hljs-comment">// 但处理是顺序的！关键在此！</span>
        <span class="hljs-built_in">handle_socket</span>(events[i].data.fd);
    }
}
</code></pre>
<h3 data-id="heading-10"><strong>3.2 内核缓冲区的关键作用</strong></h3>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    subgraph "客户端同时发送"
        C1[客户端1] --&gt;|数据包1| NIC[网卡]
        C2[客户端2] --&gt;|数据包2| NIC
        C3[客户端3] --&gt;|数据包3| NIC
    end
    
    subgraph "内核空间"
        NIC --&gt;|DMA拷贝| Memory[内核内存]
        Memory --&gt; TCP[TCP协议栈]
        TCP --&gt; B1[Socket1缓冲区]
        TCP --&gt; B2[Socket2缓冲区]
        TCP --&gt; B3[Socket3缓冲区]
    end
    
    subgraph "Reactor处理"
        B1 --&gt;|epoll标记可读| E[epoll就绪列表]
        B2 --&gt;|epoll标记可读| E
        B3 --&gt;|epoll标记可读| E
        E --&gt; R[Reactor顺序读取]
    end
    
    R --&gt; P1[处理Socket1]
    R --&gt; P2[处理Socket2]
    R --&gt; P3[处理Socket3]
</code></pre>
<p><strong>关键理解</strong>：</p>
<ol>
<li>数据包到达网卡后，由DMA直接写入内存</li>
<li>内核TCP协议栈处理，存入对应socket的接收缓冲区</li>
<li>epoll将该socket标记为"可读"</li>
<li>Reactor下次<code>epoll_wait</code>时获知多个socket就绪</li>
<li><strong>虽然是顺序处理，但每个recv都是非阻塞的，立即返回</strong></li>
</ol>
<h3 data-id="heading-11"><strong>3.3 性能瓶颈分析与解决方案</strong></h3>
<p><strong>场景分析</strong>：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 假设有3个客户端几乎同时发送数据</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">handle_socket</span><span class="hljs-params">(<span class="hljs-type">int</span> fd)</span> </span>{
    <span class="hljs-comment">// 步骤1：读取数据（很快，微秒级）</span>
    <span class="hljs-type">char</span> buf[<span class="hljs-number">1024</span>];
    <span class="hljs-type">int</span> n = <span class="hljs-built_in">recv</span>(fd, buf, <span class="hljs-built_in">sizeof</span>(buf), <span class="hljs-number">0</span>);
    
    <span class="hljs-comment">// 步骤2：业务处理（可能很慢，毫秒级）</span>
    std::string result = <span class="hljs-built_in">expensive_processing</span>(buf, n);
    
    <span class="hljs-comment">// 步骤3：发送响应</span>
    <span class="hljs-built_in">send</span>(fd, result.<span class="hljs-built_in">c_str</span>(), result.<span class="hljs-built_in">length</span>(), <span class="hljs-number">0</span>);
}
</code></pre>
<p><strong>处理时间线</strong>：</p>
<pre><code class="hljs language-ini" lang="ini">时间轴：0ms     1ms     2ms     3ms     4ms     5ms
Socket1: <span class="hljs-section">[recv]</span><span class="hljs-section">[proc...................]</span><span class="hljs-section">[send]</span>
Socket2:        等待...<span class="hljs-section">[recv]</span><span class="hljs-section">[proc...................]</span><span class="hljs-section">[send]</span>
Socket3:                等待...........<span class="hljs-section">[recv]</span><span class="hljs-section">[proc...................]</span><span class="hljs-section">[send]</span>
</code></pre>
<p><strong>问题</strong>：Socket2、3需要等待Socket1的业务处理完成！</p>
<p><strong>解决方案：Reactor + 线程池</strong></p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 优化的Reactor架构</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">HighPerformanceReactor</span> {
<span class="hljs-keyword">private</span>:
    <span class="hljs-comment">// I/O线程（主Reactor）</span>
    std::thread io_thread;
    
    <span class="hljs-comment">// 业务线程池</span>
    ThreadPool worker_pool;
    
    <span class="hljs-comment">// 用于线程间通信的任务队列</span>
    moodycamel::ConcurrentQueue&lt;IORequest&gt; request_queue;
    
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">handle_read_event</span><span class="hljs-params">(<span class="hljs-type">int</span> fd)</span> </span>{
        <span class="hljs-comment">// 1. I/O线程：快速读取数据</span>
        IORequest req = <span class="hljs-built_in">read_data_nonblocking</span>(fd);
        
        <span class="hljs-comment">// 2. 提交到业务线程池</span>
        worker_pool.<span class="hljs-built_in">enqueue</span>([<span class="hljs-keyword">this</span>, req]() {
            <span class="hljs-comment">// 3. Worker线程：处理耗时业务</span>
            ProcessResult result = <span class="hljs-built_in">process_business</span>(req);
            
            <span class="hljs-comment">// 4. 将写任务交回I/O线程</span>
            io_thread.<span class="hljs-built_in">post</span>([fd, result]() {
                <span class="hljs-built_in">send_response</span>(fd, result);
            });
        });
        
        <span class="hljs-comment">// I/O线程立即返回，继续处理其他事件</span>
    }
};
</code></pre>
<p><strong>优化后的时间线</strong>：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">I</span>/<span class="hljs-selector-tag">O</span>线程: <span class="hljs-selector-attr">[recv1]</span><span class="hljs-selector-attr">[recv2]</span><span class="hljs-selector-attr">[recv3]</span><span class="hljs-selector-attr">[send1]</span><span class="hljs-selector-attr">[send2]</span><span class="hljs-selector-attr">[send3]</span>
<span class="hljs-selector-tag">Worker1</span>:         <span class="hljs-selector-attr">[proc1...........]</span>
<span class="hljs-selector-tag">Worker2</span>:         <span class="hljs-selector-attr">[proc2...........]</span>
<span class="hljs-selector-tag">Worker3</span>:         <span class="hljs-selector-attr">[proc3...........]</span>
</code></pre>
<h2 data-id="heading-12"><strong>第四章：工业级Reactor实现细节</strong></h2>
<h3 data-id="heading-13"><strong>4.1 完整的事件状态机</strong></h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">enum class</span> <span class="hljs-title class_">ConnectionState</span> {
    ACCEPTING,      <span class="hljs-comment">// 接受连接</span>
    READING,        <span class="hljs-comment">// 读取数据</span>
    PROCESSING,     <span class="hljs-comment">// 处理中（可能在Worker线程）</span>
    WRITING,        <span class="hljs-comment">// 写入数据</span>
    CLOSING         <span class="hljs-comment">// 关闭连接</span>
};

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Connection</span> {
<span class="hljs-keyword">private</span>:
    <span class="hljs-type">int</span> fd;
    ConnectionState state;
    std::vector&lt;<span class="hljs-type">char</span>&gt; input_buffer;
    std::vector&lt;<span class="hljs-type">char</span>&gt; output_buffer;
    <span class="hljs-type">size_t</span> bytes_to_write;
    
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">handle_event</span><span class="hljs-params">(EventType type)</span> </span>{
        <span class="hljs-keyword">switch</span>(state) {
            <span class="hljs-keyword">case</span> ConnectionState::READING:
                <span class="hljs-keyword">if</span>(type == EventType::READ) {
                    <span class="hljs-keyword">if</span>(<span class="hljs-built_in">read_data</span>() &gt; <span class="hljs-number">0</span>) {
                        <span class="hljs-comment">// 数据读够一个完整请求</span>
                        <span class="hljs-keyword">if</span>(<span class="hljs-built_in">parse_complete</span>()) {
                            state = ConnectionState::PROCESSING;
                            <span class="hljs-built_in">submit_to_thread_pool</span>();
                        }
                    } <span class="hljs-keyword">else</span> {
                        <span class="hljs-comment">// 连接关闭或错误</span>
                        state = ConnectionState::CLOSING;
                    }
                }
                <span class="hljs-keyword">break</span>;
                
            <span class="hljs-keyword">case</span> ConnectionState::WRITING:
                <span class="hljs-keyword">if</span>(type == EventType::WRITE) {
                    <span class="hljs-keyword">if</span>(<span class="hljs-built_in">write_data</span>() == output_buffer.<span class="hljs-built_in">size</span>()) {
                        <span class="hljs-comment">// 数据全部发送完成</span>
                        <span class="hljs-keyword">if</span>(keep_alive) {
                            state = ConnectionState::READING;
                            <span class="hljs-built_in">reset_for_next_request</span>();
                        } <span class="hljs-keyword">else</span> {
                            state = ConnectionState::CLOSING;
                        }
                    }
                }
                <span class="hljs-keyword">break</span>;
                
            <span class="hljs-comment">// ... 其他状态处理</span>
        }
    }
};
</code></pre>
<h3 data-id="heading-14"><strong>4.2 内存管理优化</strong></h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 对象池避免频繁new/delete</span>
<span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> T&gt;
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ConnectionPool</span> {
<span class="hljs-keyword">private</span>:
    std::vector&lt;T*&gt; free_list;
    std::mutex lock;
    
<span class="hljs-keyword">public</span>:
    <span class="hljs-function">T* <span class="hljs-title">acquire</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-function">std::lock_guard&lt;std::mutex&gt; <span class="hljs-title">guard</span><span class="hljs-params">(lock)</span></span>;
        <span class="hljs-keyword">if</span>(!free_list.<span class="hljs-built_in">empty</span>()) {
            T* obj = free_list.<span class="hljs-built_in">back</span>();
            free_list.<span class="hljs-built_in">pop_back</span>();
            <span class="hljs-keyword">return</span> obj;
        }
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">T</span>();
    }
    
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">release</span><span class="hljs-params">(T* obj)</span> </span>{
        obj-&gt;<span class="hljs-built_in">reset</span>();  <span class="hljs-comment">// 重置状态而非销毁</span>
        <span class="hljs-function">std::lock_guard&lt;std::mutex&gt; <span class="hljs-title">guard</span><span class="hljs-params">(lock)</span></span>;
        free_list.<span class="hljs-built_in">push_back</span>(obj);
    }
};

<span class="hljs-comment">// 缓冲区设计</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Buffer</span> {
<span class="hljs-keyword">private</span>:
    <span class="hljs-comment">// 使用连续内存块，避免小内存分配</span>
    <span class="hljs-type">static</span> <span class="hljs-keyword">constexpr</span> <span class="hljs-type">size_t</span> INITIAL_SIZE = <span class="hljs-number">1024</span>;
    <span class="hljs-type">static</span> <span class="hljs-keyword">constexpr</span> <span class="hljs-type">size_t</span> MAX_SIZE = <span class="hljs-number">65536</span>;
    
    std::unique_ptr&lt;<span class="hljs-type">char</span>[]&gt; data;
    <span class="hljs-type">size_t</span> capacity;
    <span class="hljs-type">size_t</span> read_index;
    <span class="hljs-type">size_t</span> write_index;
    
<span class="hljs-keyword">public</span>:
    <span class="hljs-comment">// 确保容量（指数增长策略）</span>
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">ensure_capacity</span><span class="hljs-params">(<span class="hljs-type">size_t</span> need)</span> </span>{
        <span class="hljs-keyword">if</span>(write_index + need &lt;= capacity) <span class="hljs-keyword">return</span>;
        
        <span class="hljs-type">size_t</span> new_capacity = std::<span class="hljs-built_in">max</span>(capacity * <span class="hljs-number">2</span>, 
                                      write_index - read_index + need);
        new_capacity = std::<span class="hljs-built_in">min</span>(new_capacity, MAX_SIZE);
        
        <span class="hljs-keyword">auto</span> new_data = std::<span class="hljs-built_in">make_unique</span>&lt;<span class="hljs-type">char</span>[]&gt;(new_capacity);
        <span class="hljs-comment">// 复制有效数据</span>
        std::<span class="hljs-built_in">copy</span>(data.<span class="hljs-built_in">get</span>() + read_index, 
                  data.<span class="hljs-built_in">get</span>() + write_index, 
                  new_data.<span class="hljs-built_in">get</span>());
        write_index -= read_index;
        read_index = <span class="hljs-number">0</span>;
        data = std::<span class="hljs-built_in">move</span>(new_data);
        capacity = new_capacity;
    }
};
</code></pre>
<h3 data-id="heading-15"><strong>4.3 性能调优参数</strong></h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// Linux内核参数调优</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">tune_system_parameters</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-comment">// 1. 文件描述符限制</span>
    <span class="hljs-built_in">system</span>(<span class="hljs-string">"ulimit -n 1000000"</span>);
    
    <span class="hljs-comment">// 2. TCP参数优化</span>
    <span class="hljs-type">int</span> fd = <span class="hljs-built_in">socket</span>(AF_INET, SOCK_STREAM, <span class="hljs-number">0</span>);
    
    <span class="hljs-comment">// 启用TCP_NODELAY（禁用Nagle算法）</span>
    <span class="hljs-type">int</span> flag = <span class="hljs-number">1</span>;
    <span class="hljs-built_in">setsockopt</span>(fd, IPPROTO_TCP, TCP_NODELAY, &amp;flag, <span class="hljs-built_in">sizeof</span>(flag));
    
    <span class="hljs-comment">// 增大接收缓冲区</span>
    <span class="hljs-type">int</span> recv_buf_size = <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>;  <span class="hljs-comment">// 1MB</span>
    <span class="hljs-built_in">setsockopt</span>(fd, SOL_SOCKET, SO_RCVBUF, 
               &amp;recv_buf_size, <span class="hljs-built_in">sizeof</span>(recv_buf_size));
    
    <span class="hljs-comment">// 启用SO_REUSEPORT（Linux 3.9+）</span>
    <span class="hljs-built_in">setsockopt</span>(fd, SOL_SOCKET, SO_REUSEPORT, &amp;flag, <span class="hljs-built_in">sizeof</span>(flag));
    
    <span class="hljs-comment">// 3. 网卡队列调整</span>
    <span class="hljs-comment">// ethtool -G eth0 rx 4096 tx 4096</span>
}

<span class="hljs-comment">// Reactor内部参数</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">ReactorConfig</span> {
    <span class="hljs-type">size_t</span> max_connections = <span class="hljs-number">1000000</span>;      <span class="hljs-comment">// 最大连接数</span>
    <span class="hljs-type">size_t</span> io_threads = <span class="hljs-number">1</span>;                 <span class="hljs-comment">// I/O线程数（主从Reactor）</span>
    <span class="hljs-type">size_t</span> worker_threads = std::thread::<span class="hljs-built_in">hardware_concurrency</span>();
    <span class="hljs-type">size_t</span> task_queue_size = <span class="hljs-number">10000</span>;        <span class="hljs-comment">// 任务队列大小</span>
    <span class="hljs-type">size_t</span> buffer_size = <span class="hljs-number">16384</span>;            <span class="hljs-comment">// 每个连接的缓冲区大小</span>
    <span class="hljs-type">int</span> epoll_timeout_ms = <span class="hljs-number">1</span>;              <span class="hljs-comment">// epoll_wait超时时间</span>
    <span class="hljs-type">bool</span> use_et_mode = <span class="hljs-literal">true</span>;               <span class="hljs-comment">// 使用边缘触发</span>
};
</code></pre>
<h2 data-id="heading-16"><strong>第五章：现实世界的挑战与解决方案</strong></h2>
<h3 data-id="heading-17"><strong>5.1 惊群问题（Thundering Herd）</strong></h3>
<p><strong>问题</strong>：多个进程/线程同时监听同一个端口，当新连接到达时全部被唤醒。</p>
<p><strong>解决方案</strong>：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// Linux 3.9+ 的SO_REUSEPORT</span>
<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">setup_reuseport</span><span class="hljs-params">(<span class="hljs-type">int</span> port)</span> </span>{
    <span class="hljs-type">int</span> fd = <span class="hljs-built_in">socket</span>(AF_INET, SOCK_STREAM, <span class="hljs-number">0</span>);
    
    <span class="hljs-type">int</span> reuse = <span class="hljs-number">1</span>;
    <span class="hljs-built_in">setsockopt</span>(fd, SOL_SOCKET, SO_REUSEADDR, &amp;reuse, <span class="hljs-built_in">sizeof</span>(reuse));
    <span class="hljs-built_in">setsockopt</span>(fd, SOL_SOCKET, SO_REUSEPORT, &amp;reuse, <span class="hljs-built_in">sizeof</span>(reuse));
    
    <span class="hljs-comment">// 内核会自动分配连接给不同的监听socket</span>
    <span class="hljs-keyword">return</span> fd;
}

<span class="hljs-comment">// 或者使用accept锁</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">AcceptMutex</span> {
<span class="hljs-keyword">private</span>:
    std::atomic&lt;<span class="hljs-type">bool</span>&gt; lock{<span class="hljs-literal">false</span>};
    
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">try_lock</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> !lock.<span class="hljs-built_in">exchange</span>(<span class="hljs-literal">true</span>, std::memory_order_acquire);
    }
    
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">unlock</span><span class="hljs-params">()</span> </span>{
        lock.<span class="hljs-built_in">store</span>(<span class="hljs-literal">false</span>, std::memory_order_release);
    }
};
</code></pre>
<h3 data-id="heading-18"><strong>5.2 长连接与心跳机制</strong></h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ConnectionManager</span> {
<span class="hljs-keyword">private</span>:
    std::unordered_map&lt;<span class="hljs-type">int</span>, std::shared_ptr&lt;Connection&gt;&gt; connections;
    std::priority_queue&lt;HeartbeatCheck&gt; heartbeat_queue;
    
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">check_heartbeats</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">auto</span> now = std::chrono::steady_clock::<span class="hljs-built_in">now</span>();
        
        <span class="hljs-keyword">while</span>(!heartbeat_queue.<span class="hljs-built_in">empty</span>() &amp;&amp; 
              heartbeat_queue.<span class="hljs-built_in">top</span>().expiry_time &lt; now) {
            <span class="hljs-keyword">auto</span> conn = heartbeat_queue.<span class="hljs-built_in">top</span>().connection;
            heartbeat_queue.<span class="hljs-built_in">pop</span>();
            
            <span class="hljs-keyword">if</span>(conn-&gt;last_active + HEARTBEAT_TIMEOUT &lt; now) {
                <span class="hljs-comment">// 发送心跳包</span>
                <span class="hljs-built_in">send_heartbeat</span>(conn-&gt;fd);
                
                <span class="hljs-comment">// 重新加入队列，等待响应</span>
                heartbeat_queue.<span class="hljs-built_in">push</span>({
                    now + HEARTBEAT_INTERVAL,
                    conn
                });
            }
        }
    }
};
</code></pre>
<h3 data-id="heading-19"><strong>5.3 流量控制与背压（Backpressure）</strong></h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">FlowController</span> {
<span class="hljs-keyword">private</span>:
    std::atomic&lt;<span class="hljs-type">size_t</span>&gt; current_connections{<span class="hljs-number">0</span>};
    std::atomic&lt;<span class="hljs-type">size_t</span>&gt; request_rate{<span class="hljs-number">0</span>};
    <span class="hljs-type">size_t</span> max_connections;
    <span class="hljs-type">size_t</span> max_request_rate;
    
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">should_accept_new_connection</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-type">size_t</span> conns = current_connections.<span class="hljs-built_in">load</span>();
        <span class="hljs-keyword">if</span>(conns &gt;= max_connections * <span class="hljs-number">0.9</span>) {
            <span class="hljs-comment">// 连接数接近上限，开始限流</span>
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
        current_connections.<span class="hljs-built_in">fetch_add</span>(<span class="hljs-number">1</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
    
    <span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">should_process_request</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-type">size_t</span> rate = request_rate.<span class="hljs-built_in">load</span>();
        <span class="hljs-keyword">if</span>(rate &gt; max_request_rate) {
            <span class="hljs-comment">// 返回429 Too Many Requests</span>
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
        request_rate.<span class="hljs-built_in">fetch_add</span>(<span class="hljs-number">1</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
    
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">request_completed</span><span class="hljs-params">()</span> </span>{
        request_rate.<span class="hljs-built_in">fetch_sub</span>(<span class="hljs-number">1</span>);
    }
};
</code></pre>
<h2 data-id="heading-20"><strong>第六章：性能对比与基准测试</strong></h2>
<h3 data-id="heading-21"><strong>6.1 不同模型性能对比</strong></h3>






















































<table><thead><tr><th>指标</th><th>多线程阻塞I/O</th><th>单线程Reactor</th><th>Reactor+线程池</th><th>多Reactor</th></tr></thead><tbody><tr><td>最大连接数</td><td>~1000</td><td>10万+</td><td>10万+</td><td>100万+</td></tr><tr><td>QPS（echo）</td><td>5,000</td><td>50,000</td><td>50,000</td><td>200,000</td></tr><tr><td>QPS（10ms业务）</td><td>100</td><td>100</td><td>10,000</td><td>40,000</td></tr><tr><td>内存使用</td><td>高</td><td>极低</td><td>低</td><td>中等</td></tr><tr><td>编程复杂度</td><td>简单</td><td>中等</td><td>复杂</td><td>复杂</td></tr><tr><td>适用场景</td><td>低并发</td><td>高并发I/O</td><td>通用</td><td>极致性能</td></tr></tbody></table>
<h3 data-id="heading-22"><strong>6.2 实际基准测试数据</strong></h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 使用wrk进行压力测试</span>
<span class="hljs-comment">// wrk -t12 -c1000 -d30s http://localhost:8080/</span>

<span class="hljs-comment">// 测试结果对比</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">BenchmarkResult</span> {
    std::string model;
    <span class="hljs-type">int</span> connections;
    <span class="hljs-type">int</span> threads;
    <span class="hljs-type">double</span> requests_per_second;
    <span class="hljs-type">double</span> latency_avg_ms;
    <span class="hljs-type">double</span> latency_max_ms;
    
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">print</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>{
        std::cout &lt;&lt; std::format(
            <span class="hljs-string">"Model: {}\n"</span>
            <span class="hljs-string">"Connections: {}\n"</span>
            <span class="hljs-string">"RPS: {:.1f}\n"</span>
            <span class="hljs-string">"Latency Avg: {:.2f}ms\n"</span>
            <span class="hljs-string">"Latency Max: {:.2f}ms\n\n"</span>,
            model, connections, requests_per_second,
            latency_avg_ms, latency_max_ms
        );
    }
};

<span class="hljs-comment">// 示例数据</span>
std::vector&lt;BenchmarkResult&gt; results = {
    {<span class="hljs-string">"Thread-per-connection"</span>, <span class="hljs-number">1000</span>, <span class="hljs-number">1000</span>, <span class="hljs-number">4800.5</span>, <span class="hljs-number">12.3</span>, <span class="hljs-number">210.5</span>},
    {<span class="hljs-string">"Single Reactor"</span>, <span class="hljs-number">10000</span>, <span class="hljs-number">1</span>, <span class="hljs-number">52300.2</span>, <span class="hljs-number">1.2</span>, <span class="hljs-number">15.8</span>},
    {<span class="hljs-string">"Reactor+ThreadPool"</span>, <span class="hljs-number">10000</span>, <span class="hljs-number">8</span>, <span class="hljs-number">49800.7</span>, <span class="hljs-number">2.5</span>, <span class="hljs-number">32.4</span>},
    {<span class="hljs-string">"Multi-Reactor"</span>, <span class="hljs-number">100000</span>, <span class="hljs-number">4</span>, <span class="hljs-number">187600.4</span>, <span class="hljs-number">0.8</span>, <span class="hljs-number">12.7</span>}
};
</code></pre>
<h2 data-id="heading-23"><strong>第七章：现代演进与未来趋势</strong></h2>
<h3 data-id="heading-24"><strong>7.1 从Reactor到Proactor</strong></h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// Windows IOCP（完成端口）示例</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ProactorServer</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">start</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-comment">// 创建IOCP完成端口</span>
        HANDLE iocp = <span class="hljs-built_in">CreateIoCompletionPort</span>(INVALID_HANDLE_VALUE, 
                                            <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
        
        <span class="hljs-comment">// 投递异步操作</span>
        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100</span>; i++) {
            OVERLAPPED* overlapped = <span class="hljs-built_in">create_overlapped</span>();
            <span class="hljs-built_in">WSARecv</span>(socket, &amp;buffer, <span class="hljs-number">1</span>, &amp;bytes_recvd, 
                   &amp;flags, overlapped, <span class="hljs-literal">NULL</span>);
        }
        
        <span class="hljs-comment">// 等待完成通知</span>
        <span class="hljs-keyword">while</span>(<span class="hljs-literal">true</span>) {
            DWORD bytes_transferred;
            ULONG_PTR completion_key;
            OVERLAPPED* overlapped;
            
            <span class="hljs-built_in">GetQueuedCompletionStatus</span>(iocp, &amp;bytes_transferred,
                                     &amp;completion_key, &amp;overlapped, INFINITE);
            
            <span class="hljs-comment">// 操作已完成，直接处理结果</span>
            <span class="hljs-built_in">process_completion</span>(completion_key, bytes_transferred, overlapped);
        }
    }
};
</code></pre>
<h3 data-id="heading-25"><strong>7.2 C++20协程与io_uring</strong></h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 使用C++20协程的异步服务器</span>
<span class="hljs-function">async_task&lt;<span class="hljs-type">void</span>&gt; <span class="hljs-title">handle_connection</span><span class="hljs-params">(io_uring&amp; ring, <span class="hljs-type">int</span> client_fd)</span> </span>{
    <span class="hljs-type">char</span> buffer[<span class="hljs-number">4096</span>];
    
    <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// 异步读取（非阻塞）</span>
        <span class="hljs-type">ssize_t</span> n = <span class="hljs-keyword">co_await</span> <span class="hljs-built_in">async_read</span>(ring, client_fd, 
                                       buffer, <span class="hljs-built_in">sizeof</span>(buffer));
        
        <span class="hljs-comment">// 处理请求（可以在线程池中）</span>
        std::string response = <span class="hljs-keyword">co_await</span> <span class="hljs-built_in">async_process</span>(buffer, n);
        
        <span class="hljs-comment">// 异步写入</span>
        <span class="hljs-function"><span class="hljs-keyword">co_await</span> <span class="hljs-title">async_write</span><span class="hljs-params">(ring, client_fd, 
                            response.data(), response.size())</span></span>;
        
    } <span class="hljs-built_in">catch</span>(<span class="hljs-type">const</span> std::exception&amp; e) {
        std::cerr &lt;&lt; <span class="hljs-string">"Connection error: "</span> &lt;&lt; e.<span class="hljs-built_in">what</span>() &lt;&lt; std::endl;
    }
    
    ::<span class="hljs-built_in">close</span>(client_fd);
}

<span class="hljs-comment">// io_uring 是现代Linux的高性能异步I/O接口</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">setup_io_uring</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">io_uring</span> ring;
    <span class="hljs-built_in">io_uring_queue_init</span>(<span class="hljs-number">32</span>, &amp;ring, <span class="hljs-number">0</span>);
    
    <span class="hljs-comment">// 提交多个I/O请求</span>
    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) {
        <span class="hljs-keyword">struct</span> <span class="hljs-title class_">io_uring_sqe</span>* sqe = <span class="hljs-built_in">io_uring_get_sqe</span>(&amp;ring);
        <span class="hljs-built_in">io_uring_prep_read</span>(sqe, fd, buffer, size, offset);
        <span class="hljs-built_in">io_uring_sqe_set_data</span>(sqe, user_data);
    }
    
    <span class="hljs-comment">// 批量提交</span>
    <span class="hljs-built_in">io_uring_submit</span>(&amp;ring);
    
    <span class="hljs-comment">// 等待完成</span>
    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">io_uring_cqe</span>* cqe;
    <span class="hljs-built_in">io_uring_wait_cqe</span>(&amp;ring, &amp;cqe);
}
</code></pre>
<h2 data-id="heading-26"><strong>第八章：总结与最佳实践</strong></h2>
<h3 data-id="heading-27"><strong>8.1 Reactor模式的核心价值</strong></h3>
<ol>
<li><strong>资源效率</strong>：用少量线程服务大量连接</li>
<li><strong>可扩展性</strong>：连接数增长时性能下降缓慢</li>
<li><strong>响应性</strong>：避免单个慢连接影响其他连接</li>
<li><strong>模块化</strong>：清晰的关注点分离</li>
</ol>
<h3 data-id="heading-28"><strong>8.2 实施建议</strong></h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// Reactor实施检查清单</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ReactorChecklist</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">checklist</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-comment">// 1. 选择合适的I/O多路复用器</span>
        <span class="hljs-comment">//    - Linux: epoll (ET模式)</span>
        <span class="hljs-comment">//    - BSD: kqueue</span>
        <span class="hljs-comment">//    - Windows: IOCP（实际是Proactor）</span>
        
        <span class="hljs-comment">// 2. 使用非阻塞I/O</span>
        <span class="hljs-built_in">set_nonblocking</span>(fd);
        
        <span class="hljs-comment">// 3. 实现连接状态机</span>
        <span class="hljs-comment">//    每个连接维护明确的状态</span>
        
        <span class="hljs-comment">// 4. 分离I/O和业务处理</span>
        <span class="hljs-comment">//    I/O线程只做I/O，业务交给线程池</span>
        
        <span class="hljs-comment">// 5. 实现优雅关闭</span>
        <span class="hljs-comment">//    支持平滑重启</span>
        
        <span class="hljs-comment">// 6. 添加监控指标</span>
        <span class="hljs-comment">//    连接数、QPS、延迟、队列长度</span>
        
        <span class="hljs-comment">// 7. 实施限流和熔断</span>
        <span class="hljs-comment">//    防止过载</span>
        
        <span class="hljs-comment">// 8. 进行压力测试</span>
        <span class="hljs-comment">//    找到系统瓶颈</span>
    }
};
</code></pre>
<h3 data-id="heading-29"><strong>8.3 何时选择Reactor</strong></h3>
<p><strong>适合场景</strong>：</p>
<ul>
<li>高并发连接（&gt;1000）</li>
<li>I/O密集型应用</li>
<li>需要低延迟响应</li>
<li>长连接服务（如聊天、推送）</li>
</ul>
<p><strong>不适合场景</strong>：</p>
<ul>
<li>极低并发（&lt;100）</li>
<li>CPU密集型计算</li>
<li>简单的一次性请求</li>
</ul>
<h2 data-id="heading-30"><strong>结语</strong></h2>
<p>Reactor模式不是银弹，但它解决了C10K甚至C100K问题的核心挑战。从<code>select</code>到<code>epoll</code>，从单Reactor到多Reactor，从同步到异步，网络编程的演进始终围绕一个核心目标：<strong>用更少的资源服务更多的连接</strong>。</p>
<p>理解Reactor不仅是为了写出高性能服务器，更是为了掌握事件驱动编程的思想。这种思想已经渗透到现代软件的各个层面，从前端的React/Vue，到后端的Node.js/Nginx，再到操作系统的GUI事件循环。</p>
<p>正如计算机科学家Doug McIlroy所说："做一件事情，把它做好"。Reactor模式正是这一哲学在网络编程中的完美体现——它专注于事件分发这一件事，并做到了极致。</p>
<hr/>
<p><strong>进一步阅读</strong>：</p>
<ol>
<li>《UNIX网络编程 卷1：套接字联网API》</li>
<li>《Linux多线程服务端编程》</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从理论到实践：构建你的AI语音桌面助手（Demo演示）]]></title>    <link>https://juejin.cn/post/7578723693825392676</link>    <guid>https://juejin.cn/post/7578723693825392676</guid>    <pubDate>2025-12-01T14:19:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578723693825392676" data-draft-id="7578723693825212452" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从理论到实践：构建你的AI语音桌面助手（Demo演示）"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-01T14:19:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="码事漫谈"/> <meta itemprop="url" content="https://juejin.cn/user/1972974802965230"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从理论到实践：构建你的AI语音桌面助手（Demo演示）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1972974802965230/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    码事漫谈
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-01T14:19:08.000Z" title="Mon Dec 01 2025 14:19:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-01
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>本文从“可运行”的实践角度，探索利用Python与AI技术实现语音控制Windows操作系统的方案。核心观点是：构建一个完整的语音控制助手，是<strong>将“能听会说”的语音模型与“能操作”的系统执行器相结合</strong>的过程。本文将绕过复杂的底层理论，直接提供一条基于开源技术的实践路径，并通过一个可运行的代码Demo，展示如何将自然语言指令转化为具体的系统操作。</p>
<h3 data-id="heading-0"><strong>一、构建“口-脑-手”协同系统</strong></h3>
<p>一个完整的语音控制计算机系统，可以类比为人的“口-脑-手”协同：</p>
<ol>
<li><strong>口（感知层）</strong>：负责“听”和“说”。使用麦克风接收语音，并通过<strong>语音识别（STT）</strong> 技术转为文本；将AI的回复通过<strong>语音合成（TTS）</strong> 技术播报出来。</li>
<li><strong>脑（认知层）</strong>：负责“思考”。使用<strong>大语言模型（LLM）</strong> 理解用户的文本指令，并将其解析为计算机可以执行的一系列<strong>结构化操作命令</strong>。</li>
<li><strong>手（执行层）</strong>：负责“做”。通过<strong>系统自动化工具</strong>接收结构化命令，并实际操控Windows的图形界面、应用程序或文件系统。</li>
</ol>
<p>微软正在其“智能体操作系统”的愿景中系统性地整合这三层，例如通过“Hey Copilot”唤醒词、Copilot Voice/Vision进行感知和理解，并通过模型上下文协议（MCP）让AI安全地操作系统。而我们的Demo将采用一个更灵活、可完全自定义的开源方案来实现。</p>
<h3 data-id="heading-1"><strong>二、技术方案选型</strong></h3>
<p>为了实现高自由度的控制，我们放弃对特定商业API（如特定云端LLM）的强依赖，选择模块化的开源方案，便于你未来扩展和修改。</p>
<p><strong>表1：Demo技术栈选型与说明</strong></p>









































<table><thead><tr><th align="left">模块</th><th align="left">推荐技术/库</th><th align="left">作用</th><th align="left">备注</th></tr></thead><tbody><tr><td align="left"><strong>语音识别 (STT)</strong></td><td align="left"><code>SpeechRecognition</code> + <code>PyAudio</code></td><td align="left">录制麦克风音频并转换为文本</td><td align="left">基础易用，可使用离线的 <code>Vosk</code> 引擎替换以获得更好隐私性。</td></tr><tr><td align="left"><strong>大语言模型 (LLM)</strong></td><td align="left"><strong>Ollama</strong>（本地运行）</td><td align="left">理解指令，生成操作规划</td><td align="left">可在本地免费运行如 <code>Llama 3.2</code>、<code>Qwen2.5</code> 等轻量模型，响应快且隐私无忧。</td></tr><tr><td align="left"><strong>系统执行器</strong></td><td align="left"><strong><code>Windows-MCP</code> 服务器</strong></td><td align="left">将AI指令转化为真实系统操作</td><td align="left">该项目通过系统API直接控制Windows，比模拟鼠标点击更稳定可靠。</td></tr><tr><td align="left"><strong>语音合成 (TTS)</strong></td><td align="left"><code>pyttsx3</code></td><td align="left">将AI的文本回复转为语音播报</td><td align="left">系统内置，无需网络。也可用效果更好的 <code>Piper</code>。</td></tr><tr><td align="left"><strong>流程协调</strong></td><td align="left"><strong>Python主程序</strong></td><td align="left">串联以上所有模块，实现完整工作流</td><td align="left">代码逻辑的中枢。</td></tr></tbody></table>
<p>这套方案的优势在于<strong>完全本地运行</strong>，保护隐私，且<strong>执行精准可靠</strong>（依靠<code>Windows-MCP</code>而非视觉识别）。其平均操作延迟在1.5-2.3秒，系统占用低于50MB内存，具备实用性。</p>
<h3 data-id="heading-2"><strong>三、实战Demo-文件整理助手</strong></h3>
<p>下面我们构建一个“文件整理助手”Demo。它的功能是：<strong>当你对着麦克风说“请把桌面上所有截图文件移到‘截图’文件夹里”，AI将自动完成此任务并语音回复你。</strong></p>
<h4 data-id="heading-3"><strong>第一步：环境准备</strong></h4>
<ol>
<li><strong>安装Python</strong>：确保系统已安装Python 3.10或以上版本。</li>
<li><strong>安装Ollama并拉取模型</strong>：
<ul>
<li>访问 <a href="https://link.juejin.cn?target=https%3A%2F%2Follama.com%2F" target="_blank" title="https://ollama.com/" ref="nofollow noopener noreferrer">Ollama官网</a> 下载并安装。</li>
<li>打开命令行，运行 <code>ollama run llama3.2:3b</code> 来下载并运行一个轻量级模型。</li>
</ul>
</li>
<li><strong>部署Windows-MCP服务器</strong>（系统的“手”）：
<ul>
<li>打开命令行，依次执行以下命令：</li>
</ul>
<pre><code class="hljs language-bash" lang="bash">git <span class="hljs-built_in">clone</span> https://github.com/CursorTouch/Windows-MCP.git
<span class="hljs-built_in">cd</span> Windows-MCP
uv <span class="hljs-built_in">sync</span>  <span class="hljs-comment"># 自动安装依赖</span>
uv run server  <span class="hljs-comment"># 启动MCP服务器，保持此窗口运行</span>
</code></pre>
</li>
<li><strong>安装Demo所需Python库</strong>：
<pre><code class="hljs language-bash" lang="bash">pip install speechrecognition pyaudio pyttsx3 requests
</code></pre>
</li>
</ol>
<h4 data-id="heading-4"><strong>第二步：编写核心Python代码</strong></h4>
<p>创建一个名为 <code>voice_desktop_assistant.py</code> 的文件，并写入以下代码。这段代码清晰地体现了“口-脑-手”的协同流程。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> speech_recognition <span class="hljs-keyword">as</span> sr
<span class="hljs-keyword">import</span> pyttsx3
<span class="hljs-keyword">import</span> requests
<span class="hljs-keyword">import</span> json
<span class="hljs-keyword">import</span> time

<span class="hljs-comment"># ========== 初始化“口”（语音模块） ==========</span>
recognizer = sr.Recognizer()
tts_engine = pyttsx3.init()

<span class="hljs-keyword">def</span> <span class="hljs-title function_">listen</span>():
    <span class="hljs-string">"""监听麦克风，将语音转为文本"""</span>
    <span class="hljs-keyword">with</span> sr.Microphone() <span class="hljs-keyword">as</span> source:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"请说出您的指令..."</span>)
        recognizer.adjust_for_ambient_noise(source)
        audio = recognizer.listen(source, timeout=<span class="hljs-number">5</span>, phrase_time_limit=<span class="hljs-number">10</span>)
    <span class="hljs-keyword">try</span>:
        text = recognizer.recognize_google(audio, language=<span class="hljs-string">'zh-CN'</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"识别结果: <span class="hljs-subst">{text}</span>"</span>)
        <span class="hljs-keyword">return</span> text
    <span class="hljs-keyword">except</span> sr.UnknownValueError:
        speak(<span class="hljs-string">"抱歉，我没有听清楚。"</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>
    <span class="hljs-keyword">except</span> sr.RequestError:
        speak(<span class="hljs-string">"语音服务似乎出错了。"</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">speak</span>(<span class="hljs-params">text</span>):
    <span class="hljs-string">"""用语音播报文本"""</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"AI: <span class="hljs-subst">{text}</span>"</span>)
    tts_engine.say(text)
    tts_engine.runAndWait()

<span class="hljs-comment"># ========== 初始化“脑”与“手”的通信 ==========</span>
<span class="hljs-comment"># Windows-MCP 服务器地址（默认运行在本机）</span>
MCP_SERVER_URL = <span class="hljs-string">"http://127.0.0.1:8080"</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">ask_ai_to_plan</span>(<span class="hljs-params">user_command</span>):
    <span class="hljs-string">"""
    将用户指令发送给本地的Ollama LLM，要求它生成Windows-MCP能理解的命令序列。
    提示词（Prompt）工程是关键，它指导AI如何思考。
    """</span>
    <span class="hljs-comment"># 精心设计的提示词，让AI扮演一个Windows自动化专家</span>
    system_prompt = <span class="hljs-string">"""你是一个Windows桌面自动化助手。你的任务是将用户的自然语言指令，解析为一系列可以由Windows-MCP工具执行的具体、安全的操作步骤。
请严格按照以下JSON格式输出，且只输出这个JSON对象：
{
  "plan": ["步骤1的简要描述", "步骤2的简要描述", ...],
  "commands": [
    {"tool": "工具名1", "params": {"参数名": "参数值"}},
    {"tool": "工具名2", "params": {"参数名": "参数值"}}
  ]
}
可用的Windows-MCP工具示例：
- `list_files`: 列出目录文件。参数: {"path": "目录路径"}
- `move_file`: 移动文件。参数: {"source": "源文件路径", "destination": "目标路径"}
- `create_folder`: 创建文件夹。参数: {"path": "文件夹路径"}
请确保路径使用双反斜杠或正斜杠，例如：C:\\Users\\Name\\Desktop 或 C:/Users/Name/Desktop。
指令："""</span>
    
    full_prompt = system_prompt + user_command
    
    <span class="hljs-keyword">try</span>:
        <span class="hljs-comment"># 发送请求到本地运行的Ollama模型</span>
        response = requests.post(
            <span class="hljs-string">'http://localhost:11434/api/generate'</span>,
            json={
                <span class="hljs-string">"model"</span>: <span class="hljs-string">"llama3.2:3b"</span>, <span class="hljs-comment"># 与你运行的模型名称一致</span>
                <span class="hljs-string">"prompt"</span>: full_prompt,
                <span class="hljs-string">"stream"</span>: <span class="hljs-literal">False</span>,
                <span class="hljs-string">"options"</span>: {<span class="hljs-string">"temperature"</span>: <span class="hljs-number">0.1</span>} <span class="hljs-comment"># 低随机性，确保输出稳定</span>
            }
        )
        response.raise_for_status()
        <span class="hljs-comment"># 从响应中提取AI生成的文本</span>
        ai_response_text = response.json()[<span class="hljs-string">'response'</span>]
        <span class="hljs-comment"># 找到JSON部分（防止AI输出额外解释）</span>
        start = ai_response_text.find(<span class="hljs-string">'{'</span>)
        end = ai_response_text.rfind(<span class="hljs-string">'}'</span>) + <span class="hljs-number">1</span>
        <span class="hljs-keyword">if</span> start != -<span class="hljs-number">1</span> <span class="hljs-keyword">and</span> end != <span class="hljs-number">0</span>:
            json_str = ai_response_text[start:end]
            <span class="hljs-keyword">return</span> json.loads(json_str)
        <span class="hljs-keyword">else</span>:
            <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">"AI未返回有效的JSON格式"</span>)
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"与AI模型通信失败: <span class="hljs-subst">{e}</span>"</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">execute_commands</span>(<span class="hljs-params">command_list</span>):
    <span class="hljs-string">"""将AI生成的结构化命令发送给Windows-MCP服务器执行"""</span>
    <span class="hljs-keyword">for</span> cmd <span class="hljs-keyword">in</span> command_list:
        <span class="hljs-keyword">try</span>:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"执行: <span class="hljs-subst">{cmd[<span class="hljs-string">'tool'</span>]}</span> 参数: <span class="hljs-subst">{cmd[<span class="hljs-string">'params'</span>]}</span>"</span>)
            <span class="hljs-comment"># 调用Windows-MCP服务器的工具接口</span>
            response = requests.post(
                <span class="hljs-string">f"<span class="hljs-subst">{MCP_SERVER_URL}</span>/tool/execute"</span>,
                json={<span class="hljs-string">"tool"</span>: cmd[<span class="hljs-string">"tool"</span>], <span class="hljs-string">"parameters"</span>: cmd[<span class="hljs-string">"params"</span>]}
            )
            result = response.json()
            <span class="hljs-keyword">if</span> response.status_code == <span class="hljs-number">200</span> <span class="hljs-keyword">and</span> result.get(<span class="hljs-string">"success"</span>):
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"成功: <span class="hljs-subst">{result.get(<span class="hljs-string">'message'</span>)}</span>"</span>)
                time.sleep(<span class="hljs-number">0.5</span>) <span class="hljs-comment"># 短暂等待，避免操作冲突</span>
            <span class="hljs-keyword">else</span>:
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"失败: <span class="hljs-subst">{result.get(<span class="hljs-string">'error'</span>, <span class="hljs-string">'未知错误'</span>)}</span>"</span>)
                <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"执行命令时发生异常: <span class="hljs-subst">{e}</span>"</span>)
            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>
    <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>

<span class="hljs-comment"># ========== 主循环：启动你的语音助手 ==========</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():
    speak(<span class="hljs-string">"语音桌面助手已启动。"</span>)
    
    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
        <span class="hljs-comment"># 1. 听</span>
        user_command = listen()
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> user_command:
            <span class="hljs-keyword">continue</span>
        
        <span class="hljs-comment"># 2. 想（AI规划）</span>
        speak(<span class="hljs-string">"正在思考如何完成..."</span>)
        ai_plan = ask_ai_to_plan(user_command)
        
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> ai_plan:
            speak(<span class="hljs-string">"我没能理解如何执行这个任务。"</span>)
            <span class="hljs-keyword">continue</span>
        
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"执行计划: <span class="hljs-subst">{ai_plan[<span class="hljs-string">'plan'</span>]}</span>"</span>)
        
        <span class="hljs-comment"># 3. 做（系统执行）</span>
        speak(<span class="hljs-string">"开始执行任务。"</span>)
        success = execute_commands(ai_plan[<span class="hljs-string">'commands'</span>])
        
        <span class="hljs-comment"># 4. 反馈</span>
        <span class="hljs-keyword">if</span> success:
            speak(<span class="hljs-string">"任务已完成！"</span>)
        <span class="hljs-keyword">else</span>:
            speak(<span class="hljs-string">"任务执行过程中遇到了问题。"</span>)

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    main()
</code></pre>
<h4 data-id="heading-5"><strong>第三步：运行与交互</strong></h4>
<ol>
<li>确保 <strong>Ollama 模型</strong> 正在运行（第一步中 <code>ollama run</code> 的窗口）。</li>
<li>确保 <strong>Windows-MCP 服务器</strong> 正在运行（第一步中 <code>uv run server</code> 的窗口）。</li>
<li>在<strong>新的命令行窗口</strong>中，运行你的Python程序：
<pre><code class="hljs language-bash" lang="bash">python voice_desktop_assistant.py
</code></pre>
</li>
<li>程序启动后，你会听到“语音桌面助手已启动”的提示。此时，你可以尝试说出类似以下的指令：
<ul>
<li><strong>“在桌面上创建一个名为‘测试’的文件夹。”</strong></li>
<li><strong>“请列出我桌面上的所有文件。”</strong></li>
<li><strong>“帮我把桌面上所有的.txt文件移动到‘文档’文件夹里。”</strong>（请提前确保有对应文件或文件夹）</li>
</ul>
</li>
</ol>
<p>程序会将你的语音转为文本，发送给本地AI模型，AI会生成一个包含 <code>list_files</code>、<code>create_folder</code>、<code>move_file</code> 等操作的JSON命令序列，最后由 <code>Windows-MCP</code> 服务器执行这些命令并操作你的真实系统。</p>
<h3 data-id="heading-6"><strong>四、关键要点</strong></h3>
<p>通过这个Demo，你已实践了语音控制Windows的核心闭环。要让其更强大、可靠，你可以从以下几个方面深化：</p>
<ol>
<li><strong>强化AI的规划能力（改进“脑”）</strong>：当前的提示词（Prompt）较为简单。你可以为AI提供更详细的 <code>Windows-MCP</code> 工具手册，或让AI在执行前先“模拟”或“确认”危险操作（如删除文件）。这正是微软在Copilot Actions中采取“从有限场景开始测试”的谨慎策略。</li>
<li><strong>提升语音交互体验（改进“口”）</strong>：使用离线STT/TTS引擎（如Vosk和Piper）以获得更快的响应和绝对的隐私。实现“Hey Assistant”这样的免唤醒词热词检测，让交互更自然。</li>
<li><strong>确保系统安全（约束“手”）</strong>：这是最重要的环节。在Demo中，所有操作通过 <code>Windows-MCP</code> 进行，它默认只监听本地请求，且每次操作都需要用户授权（Cursor等IDE集成时会弹窗）。在实际产品中，必须像微软设计“智能体工作空间”一样，为AI代理建立一个权限受限的沙盒环境，将其活动与主系统隔离，并对删除、修改系统设置等敏感操作设置多次确认。</li>
<li><strong>探索更前沿的集成</strong>：关注微软“模型上下文协议（MCP）”的生态发展。未来，你可以将自己的助手注册为Windows任务栏的一个智能体，实现更深度的系统集成。</li>
</ol>
<h3 data-id="heading-7"><strong>结论</strong></h3>
<p>语音和AI对话控制计算机，从技术理论上看是多种成熟技术的组合创新，而从实践上看，其关键在于<strong>可靠地连接“语言理解”与“系统执行”这两个环</strong>。本文提供的Demo方案，利用 <code>Ollama</code> + <code>Windows-MCP</code> 构建了一个可在本地运行、完全受控的“原型智能体”，它跳出了单纯的理论和API调用，触及了AI智能体（Agent）实现自主任务执行的核心逻辑。</p>
<p>尽管前方仍有提升AI规划可靠性、确保操作安全等挑战，但通过这个可运行的起点，你已经拥有了一个强大的实验平台，可以亲手探索和塑造未来人机交互的样貌。</p>
<blockquote>
<p><strong>注</strong>：本Demo为教学演示目的，请在测试环境中谨慎运行，避免对重要文件和系统造成意外修改。实际操作前，请务必理解代码逻辑。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Claude 总是泛泛而谈？试试给它装个"技能包"，用 Skills 沉淀团队最佳实践]]></title>    <link>https://juejin.cn/post/7578714735307735066</link>    <guid>https://juejin.cn/post/7578714735307735066</guid>    <pubDate>2025-12-01T14:24:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578714735307735066" data-draft-id="7578714735307669530" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Claude 总是泛泛而谈？试试给它装个&quot;技能包&quot;，用 Skills 沉淀团队最佳实践"/> <meta itemprop="keywords" content="Claude,AI编程,AIGC"/> <meta itemprop="datePublished" content="2025-12-01T14:24:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="也无风雨也雾晴"/> <meta itemprop="url" content="https://juejin.cn/user/2175258804632332"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Claude 总是泛泛而谈？试试给它装个"技能包"，用 Skills 沉淀团队最佳实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2175258804632332/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    也无风雨也雾晴
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-01T14:24:20.000Z" title="Mon Dec 01 2025 14:24:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-01
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Claude Skills：给 AI 装上专业"技能包"</h2>
<p>用 Claude Code 开发项目的时候，经常遇到这些困惑：</p>
<ul>
<li>让 Claude 做代码审查，它给的建议太泛泛，不够专业？</li>
<li>写 Python 异步代码时，它对 asyncio 的最佳实践不够深入？</li>
<li>搭建 Kubernetes 配置，总感觉它缺少实战经验？</li>
<li>每次都要重复解释同样的技术上下文？</li>
</ul>
<p>Claude 本身很聪明，但就像一个全才——什么都懂一点，但不够专精。这时候就需要 <strong>Claude Skills</strong> 出场了。</p>
<h3 data-id="heading-1">什么是 Claude Skills</h3>
<h4 data-id="heading-2">一句话解释</h4>
<p>Skills 是给 Claude 装的"专业技能包"。就像 RPG 游戏里给角色学技能，一个 Skill 让 Claude 在特定领域变成专家。</p>
<p>官方定义是这样说的：</p>
<blockquote>
<p>Agent Skills are organized folders of instructions, scripts, and resources that agents can discover and load dynamically to perform better at specific tasks.</p>
</blockquote>
<p>翻译一下：Skills 是打包好的指令、脚本和资源，Claude 会自动发现并按需加载，让它在特定任务上表现更好。</p>
<h4 data-id="heading-3">核心特性</h4>
<ol>
<li><strong>模型自主调用</strong>：Claude 根据任务自动判断是否使用 Skill，不需要手动触发</li>
<li><strong>按需加载</strong>：只有用到的内容才占用 context window</li>
<li><strong>可组合</strong>：多个 Skills 可以协同工作</li>
<li><strong>跨平台</strong>：Claude.ai、Claude Code、Agent SDK、Developer Platform 都支持</li>
</ol>
<h4 data-id="heading-4">三层加载架构</h4>
<p>这是 Skills 设计最巧妙的地方——<strong>Progressive Disclosure（渐进式披露）</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">┌─────────────────────────────────────────────────────────────────┐
│  Level 1: Metadata                                              │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ name: code-review-excellence                             │    │
│  │ description: Master effective code review practices...   │    │
│  └─────────────────────────────────────────────────────────┘    │
│  加载时机: 启动时   |   Token 开销: ~100 tokens/skill            │
├─────────────────────────────────────────────────────────────────┤
│  Level 2: Instructions (SKILL.md 主体内容)                      │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ - 代码审查的 4 阶段流程                                   │    │
│  │ - 反馈技巧和模板                                          │    │
│  │ - 通用 checklist                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│  加载时机: 触发时   |   Token 开销: &lt;5,000 tokens               │
├─────────────────────────────────────────────────────────────────┤
│  Level 3: Resources &amp; Code                                      │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ reference/react.md, reference/python.md                  │    │
│  │ scripts/pr-analyzer.py                                   │    │
│  │ assets/checklist.md                                      │    │
│  └─────────────────────────────────────────────────────────┘    │
│  加载时机: 引用时   |   Token 开销: 仅输出消耗 token             │
└─────────────────────────────────────────────────────────────────┘
</code></pre>
<p>官方工程博客这样解释：</p>
<blockquote>
<p>Like a well-organized manual that starts with a table of contents, then specific chapters, and finally a detailed appendix, skills let Claude load information only as needed. This means that the amount of context that can be bundled into a skill is effectively unbounded.</p>
</blockquote>
<p>简单说：Skill 可以打包无限量的内容，但只在需要时才加载。你可以装 50 个 Skills，启动时只占用 ~5000 tokens（50 × 100），只有用到的才加载完整内容。</p>
<h3 data-id="heading-5">Skills vs MCP：两个不同层面的东西</h3>
<p>刚接触的时候很容易搞混，它们到底什么区别？</p>
<h4 data-id="heading-6">一句话区分</h4>
<p>有人总结得很形象：</p>
<blockquote>
<p>MCP server = "Claude, here are the keys to the filing cabinet."
Skills = "Write the instructions once, Claude follows them forever."</p>
</blockquote>
<p>MCP 给 Claude 钥匙（工具），Skills 给 Claude 说明书（知识）。</p>
<h4 data-id="heading-7">具体对比</h4>








































<table><thead><tr><th>维度</th><th>Skills</th><th>MCP Servers</th></tr></thead><tbody><tr><td><strong>本质</strong></td><td>知识和方法论</td><td>工具和能力</td></tr><tr><td><strong>作用</strong></td><td>教 Claude "怎么做"</td><td>给 Claude "能做什么"</td></tr><tr><td><strong>格式</strong></td><td>Markdown 文件 + YAML 元数据</td><td>协议 + 服务端程序</td></tr><tr><td><strong>Token 效率</strong></td><td>元数据 ~100 tokens，按需加载</td><td>数千到数万 tokens</td></tr><tr><td><strong>设置复杂度</strong></td><td>简单，创建 markdown 文件即可</td><td>较复杂，需要配置服务</td></tr><tr><td><strong>可移植性</strong></td><td>Claude 专用</td><td>开放标准，多厂商支持</td></tr></tbody></table>
<h4 data-id="heading-8">怎么配合使用</h4>
<p>做代码审查时：</p>
<ul>
<li><code>code-review-excellence</code> skill 提供审查标准和方法</li>
<li>Claude Code 原生的 Read/Grep 工具读取代码</li>
<li>如果是前端代码，可能还会用 Playwright MCP 跑一下页面</li>
</ul>
<p>写技术文档时：</p>
<ul>
<li><code>technical-writer</code> skill 提供写作框架和风格指南</li>
<li><code>context7</code> MCP 查询最新的库文档</li>
<li><code>tavily</code> MCP 搜索相关的最佳实践</li>
</ul>
<p><strong>一句话总结</strong>：MCP 提供连接外部系统的能力，Skills 提供如何使用这些能力的知识。</p>
<h3 data-id="heading-9">Skills 怎么工作</h3>
<h4 data-id="heading-10">激活机制</h4>
<p>Skill 的 <code>description</code> 字段决定何时激活。Claude 会分析用户输入，匹配相关的 skill：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">description:</span> <span class="hljs-string">Master</span> <span class="hljs-string">effective</span> <span class="hljs-string">code</span> <span class="hljs-string">review</span> <span class="hljs-string">practices</span> <span class="hljs-string">to</span> <span class="hljs-string">provide</span> <span class="hljs-string">constructive</span>
<span class="hljs-string">feedback,</span> <span class="hljs-string">catch</span> <span class="hljs-string">bugs</span> <span class="hljs-string">early,</span> <span class="hljs-string">and</span> <span class="hljs-string">foster</span> <span class="hljs-string">knowledge</span> <span class="hljs-string">sharing</span> <span class="hljs-string">while</span> <span class="hljs-string">maintaining</span>
<span class="hljs-string">team</span> <span class="hljs-string">morale.</span> <span class="hljs-string">Use</span> <span class="hljs-string">when</span> <span class="hljs-string">reviewing</span> <span class="hljs-string">pull</span> <span class="hljs-string">requests,</span> <span class="hljs-string">establishing</span> <span class="hljs-string">review</span> <span class="hljs-string">standards,</span>
<span class="hljs-string">or</span> <span class="hljs-string">mentoring</span> <span class="hljs-string">developers.</span>
</code></pre>
<p>当用户说：</p>
<ul>
<li>"审查这段代码" → 激活（匹配 "reviewing"）</li>
<li>"帮我 review PR" → 激活（匹配 "pull requests"）</li>
<li>"建立代码审查标准" → 激活（匹配 "establishing review standards"）</li>
<li>"写个 Python 函数" → 不激活（无匹配）</li>
</ul>
<p>技术实现上，Claude 通过 Bash 工具读取 <code>SKILL.md</code> 文件来触发加载。</p>
<p>下面这张图展示了关键词如何自动触发 skill：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/276d9cfbd9b740178b985ff7eb95b9c3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lmf5peg6aOO6Zuo5Lmf6Zu-5pm0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765203861&amp;x-signature=H4CHRJzshTsVAa02ftJbHfOdg4w%3D" alt="关键词自动触发" loading="lazy"/></p>
<h4 data-id="heading-11">Token 开销实测</h4>
<p>这是 Skills 设计巧妙的地方：</p>
<p><strong>未激活时</strong>：每个 skill 只占约 100 tokens（name + description）</p>
<ul>
<li>50 个 skills ≈ 5000 tokens</li>
</ul>
<p><strong>激活时</strong>：加载 SKILL.md（核心内容）</p>
<ul>
<li>典型的 SKILL.md ≈ 1500-3000 tokens</li>
</ul>
<p><strong>深度引用时</strong>：加载 reference/ 文件</p>
<ul>
<li><code>reference/react.md</code> ≈ 7000 tokens</li>
<li><code>reference/python.md</code> ≈ 8500 tokens</li>
<li>但脚本执行是确定性的，只有输出才消耗 token</li>
</ul>
<p>下面这张图展示了按需加载的过程：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fac591056dd142718f023afb094f5726~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lmf5peg6aOO6Zuo5Lmf6Zu-5pm0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765203861&amp;x-signature=ddvk%2BEiz%2BabpqnVyfc93iQSFR2g%3D" alt="image-20251129152339708.png" loading="lazy"/></p>
<h4 data-id="heading-12">多 Skill 协作</h4>
<p>一次对话可以激活多个 skills。比如问"审查这个 Python 异步测试代码"：</p>
<pre><code class="hljs language-csharp" lang="csharp">用户: <span class="hljs-string">"审查这个 Python 异步测试代码"</span>
  │
  ├─→ code-review-excellence (匹配 <span class="hljs-string">"审查"</span>)
  │     └─ 代码审查流程和标准
  │
  ├─→ python-testing-patterns (匹配 <span class="hljs-string">"测试"</span>)
  │     └─ Python 测试最佳实践
  │
  └─→ <span class="hljs-keyword">async</span>-python-patterns (匹配 <span class="hljs-string">"异步"</span>)
        └─ asyncio 常见陷阱

Claude 综合 <span class="hljs-number">3</span> 个 skills 的知识 → 输出专业的审查报告
</code></pre>
<p>就像召集了 3 个专家会诊。</p>
<h3 data-id="heading-13">安装和配置</h3>
<h4 data-id="heading-14">存放位置</h4>
<p>Skills 有两个位置：</p>
<pre><code class="hljs language-bash" lang="bash">~/.claude/skills/              <span class="hljs-comment"># 全局 skills (所有项目可用)</span>
project/.claude/skills/        <span class="hljs-comment"># 项目 skills (仅当前项目，可 git 共享)</span>
</code></pre>
<h4 data-id="heading-15">安装方式</h4>
<p><strong>方式 1：从官方仓库安装</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># Claude Code 中安装官方 document skills</span>
/plugin install document-skills@anthropic-agent-skills
</code></pre>
<p>官方 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fanthropics%2Fskills" target="_blank" title="https://github.com/anthropics/skills" ref="nofollow noopener noreferrer">anthropics/skills</a> 仓库提供：</p>

























<table><thead><tr><th>类别</th><th>包含内容</th></tr></thead><tbody><tr><td><strong>Document Skills</strong></td><td>Word/PDF/PowerPoint/Excel 处理（生产级质量）</td></tr><tr><td><strong>Creative &amp; Design</strong></td><td>p5.js 算法艺术、Canvas 设计、GIF 动画</td></tr><tr><td><strong>Development</strong></td><td>Web artifacts、MCP server 创建、Playwright 测试</td></tr><tr><td><strong>Enterprise</strong></td><td>品牌指南、内部沟通模板</td></tr></tbody></table>
<p><strong>方式 2：从社区 Marketplace 安装</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 添加社区 marketplace</span>
/plugin marketplace add wshobson/agents

<span class="hljs-comment"># 安装 plugin（包含多个 skills）</span>
/plugin install developer-essentials      <span class="hljs-comment"># 8 个开发核心 skills</span>
/plugin install python-development        <span class="hljs-comment"># 5 个 Python skills</span>
/plugin install kubernetes-operations     <span class="hljs-comment"># 4 个 K8s skills</span>
</code></pre>
<p>社区 marketplace 提供更多细分领域的 skills，但要注意审查安全性。</p>
<p><strong>方式 3：手动创建</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 创建 skill 目录</span>
<span class="hljs-built_in">mkdir</span> -p ~/.claude/skills/my-custom-skill

<span class="hljs-comment"># 创建 SKILL.md</span>
<span class="hljs-built_in">cat</span> &gt; ~/.claude/skills/my-custom-skill/SKILL.md &lt;&lt; <span class="hljs-string">'EOF'</span>
---
name: my-custom-skill
description: 这个 skill 的用途。Use when XXX
---

<span class="hljs-comment"># My Custom Skill</span>

<span class="hljs-comment">## When to Use</span>
- 场景1
- 场景2

<span class="hljs-comment">## 核心内容</span>
[你的专业知识]
EOF
</code></pre>
<h4 data-id="heading-16">SKILL.md 规范</h4>
<p>官方要求：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-meta">---</span>
<span class="hljs-attr">name:</span> <span class="hljs-string">your-skill-name</span>        <span class="hljs-comment"># 必需，最大 64 字符</span>
                             <span class="hljs-comment"># 只能用小写字母、数字、连字符</span>
                             <span class="hljs-comment"># 不能包含 "anthropic" 或 "claude"</span>
<span class="hljs-attr">description:</span> <span class="hljs-string">...</span>             <span class="hljs-comment"># 必需，最大 1,024 字符</span>
                             <span class="hljs-comment"># 说明功能和触发条件</span>
<span class="hljs-meta">---
</span>
<span class="hljs-comment"># Skill 正文 (Markdown)</span>
[<span class="hljs-string">任意内容</span>]
</code></pre>
<h4 data-id="heading-17">目录结构最佳实践</h4>
<pre><code class="hljs language-bash" lang="bash">skill-name/
├── SKILL.md                    <span class="hljs-comment"># 核心文件 (必需，建议 &lt;200 行)</span>
├── reference/                  <span class="hljs-comment"># 深度参考 (可选，按需加载)</span>
│   ├── react.md
│   └── python.md
├── assets/                     <span class="hljs-comment"># 模板资源 (可选)</span>
│   └── checklist.md
└── scripts/                    <span class="hljs-comment"># 自动化脚本 (可选)</span>
    └── analyzer.py
</code></pre>
<h3 data-id="heading-18">实战：从 7 分到 9 分的代码审查</h3>
<h4 data-id="heading-19">没有 Skill 时</h4>
<p>问："审查下项目结构"</p>
<p>Claude 可能会：</p>
<ul>
<li>列出文件列表</li>
<li>指出明显问题（比如缺少 README）</li>
<li>给一些泛泛的建议</li>
</ul>
<p><strong>质量</strong>：7/10 — 能用，但不够系统</p>
<h4 data-id="heading-20">有 Skill 后</h4>
<p>同样的问题，激活 <code>code-review-excellence</code> skill 后：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section">## 项目结构审查报告</span>

<span class="hljs-section">### 优点</span>
<span class="hljs-bullet">-</span> 现代化技术栈
<span class="hljs-bullet">-</span> 清晰的目录结构
<span class="hljs-bullet">-</span> 配置完善

<span class="hljs-section">### 关键问题 (Blocking)</span>
🔴 缺少测试基础设施
🔴 eslint.config.js 配置错误

<span class="hljs-section">### 重要改进 (Important)</span>
🟡 缺少环境变量管理
🟡 缺少错误边界

<span class="hljs-section">### 建议优化 (Nice to Have)</span>
🟢 代码分割
🟢 添加 loading 状态

<span class="hljs-section">### 评分矩阵</span>
| 类别     | 评分 | 说明        |
|----------|------|-------------|
| 代码质量 | 8/10 | ESLint 通过 |
| 架构设计 | 7/10 | 结构清晰    |
| 可维护性 | 6/10 | 缺少测试    |

<span class="hljs-section">### 优先级行动计划</span>
<span class="hljs-bullet">1.</span> 🔴 修复 eslint 配置
<span class="hljs-bullet">2.</span> 🔴 添加测试框架
</code></pre>
<p><strong>质量</strong>：9/10 — 专业、系统、可执行</p>
<p>区别在于：</p>






























<table><thead><tr><th>维度</th><th>基础模式</th><th>Skill 模式</th></tr></thead><tbody><tr><td>结构</td><td>无固定结构</td><td>4 阶段审查流程</td></tr><tr><td>优先级</td><td>混在一起</td><td>🔴🟡🟢 明确分级</td></tr><tr><td>可执行性</td><td>泛泛建议</td><td>具体行动计划</td></tr><tr><td>深度</td><td>表面问题</td><td>语言特定陷阱</td></tr></tbody></table>
<h3 data-id="heading-21">创建自定义 Skill</h3>
<h4 data-id="heading-22">什么时候该创建</h4>
<ol>
<li><strong>团队特定规范</strong> — "我们的 API 设计标准"</li>
<li><strong>重复性工作</strong> — 每次都要解释的技术细节</li>
<li><strong>知识沉淀</strong> — 把踩过的坑固化下来</li>
<li><strong>专业领域</strong> — Marketplace 没有的细分领域</li>
</ol>
<h4 data-id="heading-23">创建步骤</h4>
<p><strong>第 1 步：确定范围</strong></p>
<p>一个好的 skill 要：</p>
<ul>
<li>聚焦单一主题</li>
<li>可独立使用</li>
<li>有明确的激活条件</li>
<li>不要做"万能 skill"</li>
</ul>
<p><strong>第 2 步：组织内容</strong></p>
<pre><code class="hljs language-markdown" lang="markdown">---
name: team-api-standards
<span class="hljs-section">description: 团队的 RESTful API 设计规范和审查标准。Use when designing REST APIs, reviewing API endpoints, or validating API documentation.
---</span>

<span class="hljs-section"># Team API Standards</span>

<span class="hljs-section">## When to Use</span>
<span class="hljs-bullet">-</span> 设计新的 API 接口
<span class="hljs-bullet">-</span> 审查 API 相关代码
<span class="hljs-bullet">-</span> 解答 API 设计问题

<span class="hljs-section">## 核心原则</span>

<span class="hljs-section">### 1. RESTful 设计</span>
[团队的 REST 规范]

<span class="hljs-section">### 2. 错误处理</span>
[统一的错误响应格式]

<span class="hljs-section">## Checklist</span>
<span class="hljs-bullet">-</span> [ ] 是否遵循命名约定?
<span class="hljs-bullet">-</span> [ ] 错误码是否统一?

<span class="hljs-section">## 示例</span>

<span class="hljs-section">### 好的设计</span>
\<span class="hljs-code">`\`</span>\`typescript
// 正确示例
\<span class="hljs-code">`\`</span>\`

<span class="hljs-section">### 避免的做法</span>
\<span class="hljs-code">`\`</span>\`typescript
// 错误示例
\<span class="hljs-code">`\`</span>\`
</code></pre>
<p><strong>第 3 步：测试</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 创建 skill</span>
<span class="hljs-built_in">mkdir</span> -p ~/.claude/skills/team-api-standards
<span class="hljs-comment"># 编写 SKILL.md</span>
<span class="hljs-comment"># 新开会话测试</span>

<span class="hljs-comment"># 问: "审查这个 API 设计"</span>
<span class="hljs-comment"># 看是否激活了你的 skill</span>
</code></pre>
<h4 data-id="heading-24">最佳实践</h4>
<ol>
<li>
<p><strong>描述要精准</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># ❌ 太宽泛</span>
<span class="hljs-attr">description:</span> <span class="hljs-string">API</span> <span class="hljs-string">相关的知识</span>

<span class="hljs-comment"># ✅ 明确场景</span>
<span class="hljs-attr">description:</span> <span class="hljs-string">团队的</span> <span class="hljs-string">RESTful</span> <span class="hljs-string">API</span> <span class="hljs-string">设计规范。Use</span> <span class="hljs-string">when</span> <span class="hljs-string">designing</span> <span class="hljs-string">REST</span> <span class="hljs-string">APIs,</span> <span class="hljs-string">reviewing</span> <span class="hljs-string">API</span> <span class="hljs-string">endpoints.</span>
</code></pre>
</li>
<li>
<p><strong>内容要实战</strong></p>
<ul>
<li>多用对比示例（Good vs Bad）</li>
<li>提供 checklist</li>
<li>包含真实的坑和解决方案</li>
</ul>
</li>
<li>
<p><strong>团队共享</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 放项目目录，团队共享</span>
<span class="hljs-built_in">cp</span> -r ~/.claude/skills/team-api-standards .claude/skills/
git add .claude/
git commit -m <span class="hljs-string">"Add team API standards skill"</span>
</code></pre>
</li>
</ol>
<h3 data-id="heading-25">安全考虑</h3>
<p>官方文档特别强调这一点：</p>
<blockquote>
<p>We strongly recommend using Skills only from trusted sources: those you created yourself or obtained from Anthropic.</p>
</blockquote>
<p>Skills 可以包含脚本，恶意 Skill 可能：</p>
<ul>
<li>让 Claude 执行有害操作</li>
<li>泄露数据</li>
<li>入侵系统</li>
</ul>
<p><strong>建议</strong>：</p>
<ul>
<li>审查所有 bundled 文件（SKILL.md、scripts、images）</li>
<li>避免使用从不可信 URL 获取内容的 Skills</li>
<li>像对待安装软件一样对待 Skill</li>
</ul>
<h3 data-id="heading-26">平台支持</h3>






























<table><thead><tr><th>平台</th><th>支持类型</th><th>共享范围</th></tr></thead><tbody><tr><td><strong>Claude.ai</strong></td><td>预置 + 自定义上传</td><td>仅个人</td></tr><tr><td><strong>Claude Code</strong></td><td>自定义（文件系统）</td><td>个人或项目级</td></tr><tr><td><strong>Claude API</strong></td><td>预置 + 自定义</td><td>组织级</td></tr><tr><td><strong>Agent SDK</strong></td><td>自定义（.claude/skills/）</td><td>配置级</td></tr></tbody></table>
<p>注意：自定义 Skills 不会跨平台同步，需要分别上传。</p>
<h3 data-id="heading-27">局限性</h3>
<h4 data-id="heading-28">Skills 不能做的</h4>
<ul>
<li>❌ 操作浏览器（需要 Playwright MCP）</li>
<li>❌ 联网搜索（需要 Tavily MCP）</li>
<li>❌ 执行系统命令（需要 Bash 工具）</li>
<li>❌ 读取文件（需要 Read 工具）</li>
</ul>
<h4 data-id="heading-29">Skills 擅长的</h4>
<ul>
<li>✅ 提供系统化的知识框架</li>
<li>✅ 指导最佳实践</li>
<li>✅ 识别常见陷阱</li>
<li>✅ 优化工具使用策略</li>
</ul>
<h4 data-id="heading-30">创建成本</h4>
<p>高质量 skill 需要投入：</p>
<ul>
<li>核心内容（SKILL.md）：4-6 小时</li>
<li>补充资源：8-12 小时</li>
<li>持续维护：按需更新</li>
</ul>
<h3 data-id="heading-31">总结</h3>
<p><strong>原理层面</strong>：</p>
<ul>
<li>Skills 是给 Claude 装的"专业技能包"，让它从全才变专家</li>
<li>采用 Progressive Disclosure 架构，按需加载，token 效率高</li>
<li>通过 description 自动激活，无需手动调用</li>
<li>可以多个 skills 协作，互相补充</li>
</ul>
<p><strong>实用层面</strong>：</p>
<ul>
<li>官方 anthropics/skills 提供生产级 Document Skills</li>
<li>社区 marketplace 提供更多细分领域 skills</li>
<li>自定义 skill 简单：一个目录 + 一个 SKILL.md</li>
<li>Skills 和 MCP 是互补关系，不是替代</li>
</ul>
<p><strong>使用建议</strong>：</p>
<ol>
<li><strong>新手</strong>：从官方 skills 开始，体验专业化提升</li>
<li><strong>进阶</strong>：创建团队特定 skills，沉淀最佳实践</li>
<li><strong>安全</strong>：只使用可信来源的 skills，审查所有脚本</li>
</ol>
<hr/>
<h3 data-id="heading-32">相关资源</h3>
<h4 data-id="heading-33">官方文档</h4>
<ol>
<li><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.claude.com%2Fdocs%2Fen%2Fagents-and-tools%2Fagent-skills%2Foverview" target="_blank" title="https://platform.claude.com/docs/en/agents-and-tools/agent-skills/overview" ref="nofollow noopener noreferrer">Agent Skills 文档</a></strong> - 完整使用指南</li>
<li><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.anthropic.com%2Fengineering%2Fequipping-agents-for-the-real-world-with-agent-skills" target="_blank" title="https://www.anthropic.com/engineering/equipping-agents-for-the-real-world-with-agent-skills" ref="nofollow noopener noreferrer">Skills 工程博客</a></strong> - 技术架构详解</li>
<li><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.anthropic.com%2Fnews%2Fskills" target="_blank" title="https://www.anthropic.com/news/skills" ref="nofollow noopener noreferrer">Skills 发布公告</a></strong> - 功能介绍</li>
</ol>
<h4 data-id="heading-34">代码仓库</h4>
<ol start="4">
<li><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fanthropics%2Fskills" target="_blank" title="https://github.com/anthropics/skills" ref="nofollow noopener noreferrer">anthropics/skills</a></strong> - 官方 Skills 仓库</li>
<li><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fwshobson%2Fagents" target="_blank" title="https://github.com/wshobson/agents" ref="nofollow noopener noreferrer">wshobson/agents</a></strong> - 社区 Skills marketplace</li>
</ol>
<h4 data-id="heading-35">扩展阅读</h4>
<ol start="6">
<li><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fsupport.claude.com%2Fen%2Farticles%2F12512198-how-to-create-custom-skills" target="_blank" title="https://support.claude.com/en/articles/12512198-how-to-create-custom-skills" ref="nofollow noopener noreferrer">创建自定义 Skills</a></strong> - 官方教程</li>
<li><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.claude.com%2Fblog%2Fskills-explained" target="_blank" title="https://www.claude.com/blog/skills-explained" ref="nofollow noopener noreferrer">Skills vs MCP 对比</a></strong> - 官方博客解释</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[C#/.NET/.NET Core优秀项目和框架2025年11月简报]]></title>    <link>https://juejin.cn/post/7578681104292708395</link>    <guid>https://juejin.cn/post/7578681104292708395</guid>    <pubDate>2025-12-01T14:24:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578681104292708395" data-draft-id="7578697614390575110" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="C#/.NET/.NET Core优秀项目和框架2025年11月简报"/> <meta itemprop="keywords" content="后端,.NET"/> <meta itemprop="datePublished" content="2025-12-01T14:24:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="追逐时光者"/> <meta itemprop="url" content="https://juejin.cn/user/2770425031690333"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            C#/.NET/.NET Core优秀项目和框架2025年11月简报
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2770425031690333/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    追逐时光者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-01T14:24:06.000Z" title="Mon Dec 01 2025 14:24:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-01
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/685df50300ed49aea271aeed0bc66e31~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765203868&amp;x-signature=C%2B52LnkG9xeEAw3Y1dMsxX4Dnf0%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0">前言</h2>
<p>公众号每月定期推广和分享的C#/.NET/.NET Core优秀项目和框架（每周至少会推荐两个优秀的项目和框架当然节假日除外），公众号推文中有项目和框架的详细介绍、功能特点、使用方式以及部分功能截图等（打不开或者打开GitHub很慢的同学可以优先查看公众号推文，文末一定会附带项目和框架源码地址）。注意：排名不分先后，都是十分优秀的开源项目和框架，每周定期更新分享。</p>
<ul>
<li><strong>💡简报Gitee开源地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fysgdaydayup%2FDotNetGuide%2Fblob%2Fmain%2Fdocs%2FDotNet%2FDotNetProjectMonthly.md" target="_blank" title="https://gitee.com/ysgdaydayup/DotNetGuide/blob/main/docs/DotNet/DotNetProjectMonthly.md" ref="nofollow noopener noreferrer">gitee.com/ysgdaydayup…</a></strong></li>
<li><strong>🔔简报GitHub开源地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FYSGStudyHards%2FDotNetGuide%2Fblob%2Fmain%2Fdocs%2FDotNet%2FDotNetProjectMonthly.md" target="_blank" title="https://github.com/YSGStudyHards/DotNetGuide/blob/main/docs/DotNet/DotNetProjectMonthly.md" ref="nofollow noopener noreferrer">github.com/YSGStudyHar…</a></strong></li>
</ul>
<h2 data-id="heading-1">STNodeEditor</h2>
<ul>
<li><strong>项目简介：</strong> STNodeEditor 是一款基于 .NET WinForm 开源免费（MIT License）、轻量且功能强大的节点编辑器，采用纯 GDI+ 绘制无任何依赖库仅仅100+Kb，提供了丰富的属性以及事件，可以非常方便的完成节点之间数据的交互及通知，编辑器内置了大量虚函数，供开发者根据需求进行重写，赋予了极高的自由度和定制能力。</li>
<li><strong>项目源码地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FDebugST%2FSTNodeEditor" target="_blank" title="https://github.com/DebugST/STNodeEditor" ref="nofollow noopener noreferrer">github.com/DebugST/STN…</a></li>
<li><strong>项目详细介绍：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FfMG3iAu1Y0Fkmf6d-fcgiA" target="_blank" title="https://mp.weixin.qq.com/s/fMG3iAu1Y0Fkmf6d-fcgiA" ref="nofollow noopener noreferrer">mp.weixin.qq.com/s/fMG3iAu1Y…</a></li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4052f6ecec7b45069b2bb8e8ed33f703~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765203868&amp;x-signature=%2FVqqCWv9lD40catX2kuQTBzd%2FJA%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3094f1fe1ea14d28892c28e8f9c488ae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765203868&amp;x-signature=8j7JAWzzC5VnJ6bseeuz6yY1IXw%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-2">WenAntdUI-Admin</h2>
<ul>
<li><strong>项目简介：</strong> WenAntdUI-Admin 是一个基于 AntdUI 构建、基础、现代化的 WinForm 管理系统，基于 Apache-2.0 License 开源，项目包含：AOT发布、字典管理、用户管理、菜单管理、权限管理、用户设置等功能。内部封装了很多常用组件，包含AdminTable等通用组件。</li>
<li><strong>项目源码地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2FAntdUI%2Fwen-antd-ui" target="_blank" title="https://gitee.com/AntdUI/wen-antd-ui" ref="nofollow noopener noreferrer">gitee.com/AntdUI/wen-…</a></li>
<li><strong>项目详细介绍：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FVTBcoZZ2mNyuyV_s4fzsPA" target="_blank" title="https://mp.weixin.qq.com/s/VTBcoZZ2mNyuyV_s4fzsPA" ref="nofollow noopener noreferrer">mp.weixin.qq.com/s/VTBcoZZ2m…</a></li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2aa8f6f09f314348a41cafe134272826~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765203868&amp;x-signature=CYEOeEa2bPX0dQZtCN%2BE55ArdLg%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8933f426bbea442bbe8d396f74bb2129~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765203868&amp;x-signature=jBL7zwHAI0wRr9iabEgLFeOcYTc%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-3">NetCoreKevin</h2>
<ul>
<li><strong>项目简介：</strong> NetCoreKevin 是一个基于 .NET 8 + DDD 搭建的模块化微服务框架，其模块化设计使得每个功能都可以独立引用，非常适合大型企业级应用的开发。框架支持IdentityServer4单点登录、多缓存、自动任务、分布式、一库多租户、日志、授权和鉴权、CAP集成事件、SignalR、领域事件、ESL、MCP协议服务、IOC模块化注入、Cors、Quartz自动任务、多短信集成、AI智能体、AI 集成 SemanticKernel、MCP 服务、OCR验证码识别、API多版本兼容、单元集成测试。</li>
<li><strong>项目源码地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fjunkai-li%2FNetCoreKevin" target="_blank" title="https://github.com/junkai-li/NetCoreKevin" ref="nofollow noopener noreferrer">github.com/junkai-li/N…</a></li>
<li><strong>项目详细介绍：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FxGM9SLna-ihK1Qe228TRFQ" target="_blank" title="https://mp.weixin.qq.com/s/xGM9SLna-ihK1Qe228TRFQ" ref="nofollow noopener noreferrer">mp.weixin.qq.com/s/xGM9SLna-…</a></li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4751e78351fb491787358aef4c51a112~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765203868&amp;x-signature=FXcv%2Fq2OJOeLVSK0qmoR4WnpWSQ%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fd4f0027f40349b09f415048ff48f4bf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765203868&amp;x-signature=lEYU5b43jHhlIv0rUJRkBZfPvMY%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-4">ImageSearch</h2>
<ul>
<li><strong>项目简介：</strong> ImageSearch 是一个基于 .NET WPF 开源、免费（MIT license）、轻量的本地硬盘千万级图库以图搜图小工具，该项目灵感来源于市面上的重复文件、目录查找与清理的系统工具 DuplicateCleaner。</li>
<li><strong>项目源码地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fldqk%2FImageSearch" target="_blank" title="https://github.com/ldqk/ImageSearch" ref="nofollow noopener noreferrer">github.com/ldqk/ImageS…</a></li>
<li><strong>项目详细介绍：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FiRDW0KvDDBT5x9lotbR_2Q" target="_blank" title="https://mp.weixin.qq.com/s/iRDW0KvDDBT5x9lotbR_2Q" ref="nofollow noopener noreferrer">mp.weixin.qq.com/s/iRDW0KvDD…</a></li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/35ac2036fc9546188ec3a3ebfef1c9be~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765203868&amp;x-signature=JT3DcjzP6c9UO8NkSuirv%2BOSQzU%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-5">better-genshin-impact</h2>
<ul>
<li><strong>项目简介：</strong> better-genshin-impact 是一款基于 .NET + 计算机视觉技术完全开源免费（GPL-3.0 license）、功能强大的原神智能辅助自动化工具，意图让原神变的更好的项目，包含：自动剧情、全自动钓鱼(AI)、全自动七圣召唤、自动伐木、自动刷本、自动采集/挖矿/锄地等功能。</li>
<li><strong>项目源码地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fbabalae%2Fbetter-genshin-impact" target="_blank" title="https://github.com/babalae/better-genshin-impact" ref="nofollow noopener noreferrer">github.com/babalae/bet…</a></li>
<li><strong>项目详细介绍：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FwZ4d9baOO2RXsb6VCdSxHQ" target="_blank" title="https://mp.weixin.qq.com/s/wZ4d9baOO2RXsb6VCdSxHQ" ref="nofollow noopener noreferrer">mp.weixin.qq.com/s/wZ4d9baOO…</a></li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5cff5ae307894721a06bf14e7537316b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765203868&amp;x-signature=s6iSJ7zqWJHfUinAojGI5KUBztw%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/761e373c2175484ab071a85a544ac2d9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765203868&amp;x-signature=28IVdQAG%2BipnF4Te8ceSBSdqrk0%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-6">DataGridFilter</h2>
<ul>
<li><strong>项目简介：</strong> DataGridFilter 是一款开源（MIT License）、多语言的 WPF 可筛选 DataGrid 控件，旨在通过轻量级集成帮助开发者快速构建高效、灵活的数据展示管理界面。</li>
<li><strong>项目源码地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmacgile%2FDataGridFilter" target="_blank" title="https://github.com/macgile/DataGridFilter" ref="nofollow noopener noreferrer">github.com/macgile/Dat…</a></li>
<li><strong>项目详细介绍：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FzrU7sivEvJrU090TF6TN3w" target="_blank" title="https://mp.weixin.qq.com/s/zrU7sivEvJrU090TF6TN3w" ref="nofollow noopener noreferrer">mp.weixin.qq.com/s/zrU7sivEv…</a></li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bc330d03edb34f2ba0196031a7d1adca~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765203868&amp;x-signature=td7q8ijZihgWDowEuGM1y6qJ15A%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/96d3dfa1fff24a5395c15891e3a4e8ed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765203868&amp;x-signature=1gl20hqdgmEmDdnq%2Fv3WaMSH1%2Fs%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-7">Microsoft Agent Framework</h2>
<ul>
<li><strong>项目简介：</strong> Microsoft Agent Framework 是一个面向 .NET 和 Python 的开源开发套件，用于构建 AI 智能体及多智能体工作流。它融合并扩展了 Semantic Kernel 与 AutoGen 项目的核心理念，在结合两者优势的基础上，进一步引入了全新能力。该框架由原班团队打造，将成为未来构建 AI 智能体的统一基础平台。</li>
<li><strong>项目源码地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmicrosoft%2Fagent-framework" target="_blank" title="https://github.com/microsoft/agent-framework" ref="nofollow noopener noreferrer">github.com/microsoft/a…</a></li>
<li><strong>项目详细介绍：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FqxjUYO2U-TCTd0JmEtbehA" target="_blank" title="https://mp.weixin.qq.com/s/qxjUYO2U-TCTd0JmEtbehA" ref="nofollow noopener noreferrer">mp.weixin.qq.com/s/qxjUYO2U-…</a></li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/746ef4382646425dac87ce352628ca7a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765203868&amp;x-signature=qDodqsCWDi7zIIya51YkXakat%2BM%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3b39bd00a0e141b795cb347907b6cf91~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765203868&amp;x-signature=XsvPGh5z4cr0AY12HmgK3DnIlzc%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-8">AutoGen</h2>
<ul>
<li><strong>项目简介：</strong> AutoGen 是一个开源编程框架，它通过多个代理进行对话以解决任务，从而实现 LLM 应用的开发。AutoGen 代理可定制、可对话，并且能够无缝地允许人类参与。它们可以在不同的模式下运行，使用 LLM、人类输入和工具的组合。</li>
<li><strong>项目源码地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmicrosoft%2Fautogen" target="_blank" title="https://github.com/microsoft/autogen" ref="nofollow noopener noreferrer">github.com/microsoft/a…</a></li>
<li><strong>项目详细介绍：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FqxjUYO2U-TCTd0JmEtbehA" target="_blank" title="https://mp.weixin.qq.com/s/qxjUYO2U-TCTd0JmEtbehA" ref="nofollow noopener noreferrer">mp.weixin.qq.com/s/qxjUYO2U-…</a></li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7ac79fe4622a4af0a886b4bac56e051f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765203868&amp;x-signature=1mQbX0OTW1vhN%2BPEwH80TvsLgic%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2f21abafd0794502ad2e5d9ff88e3c31~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765203868&amp;x-signature=znHloCAVB3pTiuEi5XTt%2FA%2BBZVE%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-9">Kernel Memory</h2>
<ul>
<li><strong>项目简介：</strong> Kernel Memory（KM）是一种多模态AI服务，RAG 架构，使用 LLM 和自然语言索引和查询任何数据、跟踪来源、显示引用、异步内存模式。该存储库提供了特定 AI 和 LLMs 应用场景中内存的最佳实践和参考架构。</li>
<li><strong>项目源码地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmicrosoft%2Fkernel-memory" target="_blank" title="https://github.com/microsoft/kernel-memory" ref="nofollow noopener noreferrer">github.com/microsoft/k…</a></li>
<li><strong>项目详细介绍：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FqxjUYO2U-TCTd0JmEtbehA" target="_blank" title="https://mp.weixin.qq.com/s/qxjUYO2U-TCTd0JmEtbehA" ref="nofollow noopener noreferrer">mp.weixin.qq.com/s/qxjUYO2U-…</a></li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/340ae63ec6a34bdea8b06b8bc30e5d42~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765203868&amp;x-signature=Fs5PDD8BuRso9VG4tHNBhS3OSeg%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8c14df5241fc4eeeb010ea4148d53915~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765203868&amp;x-signature=o9D9mVrXBdtbBQajip0yYHKaydM%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-10">AntSK</h2>
<ul>
<li><strong>项目简介：</strong> AntSK 是一个基于 .NET 9 和 Blazor 技术栈构建的企业级AI知识库和智能体平台，集成了 Semantic Kernel 和 Kernel Memory，提供完整的AI应用开发解决方案。</li>
<li><strong>项目源码地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FAIDotNet%2FAntSK" target="_blank" title="https://github.com/AIDotNet/AntSK" ref="nofollow noopener noreferrer">github.com/AIDotNet/An…</a></li>
<li><strong>项目详细介绍：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FqxjUYO2U-TCTd0JmEtbehA" target="_blank" title="https://mp.weixin.qq.com/s/qxjUYO2U-TCTd0JmEtbehA" ref="nofollow noopener noreferrer">mp.weixin.qq.com/s/qxjUYO2U-…</a></li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a4794d7af2b1458bbdb0a3ea0709d276~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765203868&amp;x-signature=Opf1lfD3k5g98QyqXm1e320atLg%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/85f1cf9ffdec4fdba95bde5e07301b14~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765203868&amp;x-signature=%2F5%2FpnyiZHT6Oo3MvbbpDEKiqnIw%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-11">OllamaSharp</h2>
<ul>
<li><strong>项目简介：</strong> OllamaSharp 旨在通过提供.NET绑定，使得开发者能够轻松地在.NET应用程序中使用Ollama API。简化了 .NET 与 Ollama 的本地和远程交互。</li>
<li><strong>项目源码地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fawaescher%2FOllamaSharp" target="_blank" title="https://github.com/awaescher/OllamaSharp" ref="nofollow noopener noreferrer">github.com/awaescher/O…</a></li>
<li><strong>项目详细介绍：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FqxjUYO2U-TCTd0JmEtbehA" target="_blank" title="https://mp.weixin.qq.com/s/qxjUYO2U-TCTd0JmEtbehA" ref="nofollow noopener noreferrer">mp.weixin.qq.com/s/qxjUYO2U-…</a></li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4df41f28e32548a081862bcff2b2adc2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765203868&amp;x-signature=WNlBdjEBRSFG%2FwNYoMB4%2FYBMbUs%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-12">WPFUIDemo</h2>
<ul>
<li><strong>项目简介：</strong> WPFUIDemo 是一个专注于 WPF（Windows Presentation Foundation）用户界面设计与开发的示例项目。该项目旨在为开发者提供一个全面、实用的参考范例，帮助他们快速掌握 WPF 应用开发的核心技巧和最佳实践，提升开发效率与界面设计水平。通过丰富的功能模块和代码示例，开发者可以深入了解 WPF 的强大特性，并将其灵活应用于实际项目中。</li>
<li><strong>项目源码地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fzhang-sleepyhead%2FWPFUIDemo" target="_blank" title="https://gitee.com/zhang-sleepyhead/WPFUIDemo" ref="nofollow noopener noreferrer">gitee.com/zhang-sleep…</a></li>
<li><strong>项目详细介绍：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F15oTrGmLzGl4AAUV6maIgw" target="_blank" title="https://mp.weixin.qq.com/s/15oTrGmLzGl4AAUV6maIgw" ref="nofollow noopener noreferrer">mp.weixin.qq.com/s/15oTrGmLz…</a></li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/65a8555feece44e8b3043dfd92248d2b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765203868&amp;x-signature=FvMI9HZewyXaQDzOE%2F%2BBz%2FWQ32w%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3965fab39473445dbe60d4657dc19f5c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765203868&amp;x-signature=hDoQK0z3dLmFTRotuHCjkIphxa0%3D" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[k8s实用脚本]]></title>    <link>https://juejin.cn/post/7578732288515538995</link>    <guid>https://juejin.cn/post/7578732288515538995</guid>    <pubDate>2025-12-01T14:29:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578732288515538995" data-draft-id="7578699866182107174" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="k8s实用脚本"/> <meta itemprop="keywords" content="Kubernetes"/> <meta itemprop="datePublished" content="2025-12-01T14:29:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="哈里谢顿"/> <meta itemprop="url" content="https://juejin.cn/user/3678304397695056"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            k8s实用脚本
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3678304397695056/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    哈里谢顿
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-01T14:29:09.000Z" title="Mon Dec 01 2025 14:29:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-01
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1 将docker管理的镜像传递给k8s使用</h2>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>

<span class="hljs-comment"># docker-to-ctr.sh</span>
<span class="hljs-comment"># 将本地所有 Docker 镜像导出为 tar 并存储到指定目录</span>
<span class="hljs-comment"># 若目标 tar 已存在则跳过</span>

DIR=<span class="hljs-string">"/home/hanwang/docker_images"</span>

<span class="hljs-built_in">set</span> -e

<span class="hljs-comment"># 创建存储目录</span>
<span class="hljs-built_in">mkdir</span> -p <span class="hljs-string">"<span class="hljs-variable">$DIR</span>"</span>

<span class="hljs-built_in">echo</span> <span class="hljs-string">"🔍 获取本地 Docker 镜像列表..."</span>
IMAGES=$(docker images --format <span class="hljs-string">"{{.Repository}}:{{.Tag}}"</span> | grep -v <span class="hljs-string">"&lt;none&gt;"</span>)

<span class="hljs-keyword">if</span> [ -z <span class="hljs-string">"<span class="hljs-variable">$IMAGES</span>"</span> ]; <span class="hljs-keyword">then</span>
  <span class="hljs-built_in">echo</span> <span class="hljs-string">"❌ 未找到有效的 Docker 镜像（排除 &lt;none&gt; 标签）"</span>
  <span class="hljs-built_in">exit</span> 1
<span class="hljs-keyword">fi</span>

COUNT=$(<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$IMAGES</span>"</span> | <span class="hljs-built_in">wc</span> -l)
<span class="hljs-built_in">echo</span> <span class="hljs-string">"📦 共找到 <span class="hljs-variable">${COUNT}</span> 个镜像，开始保存到 <span class="hljs-variable">${DIR}</span> ..."</span>

<span class="hljs-keyword">for</span> img <span class="hljs-keyword">in</span> <span class="hljs-variable">$IMAGES</span>; <span class="hljs-keyword">do</span>
  <span class="hljs-built_in">echo</span> <span class="hljs-string">"➡️  处理镜像: <span class="hljs-variable">$img</span>"</span>
  
  <span class="hljs-comment"># 目标 tar 文件名：将仓库/标签中的特殊字符替换为下划线</span>
  TARGET_TAR=<span class="hljs-string">"<span class="hljs-variable">${DIR}</span>/<span class="hljs-subst">$(echo <span class="hljs-string">"<span class="hljs-variable">$img</span>"</span> | tr '/' '_' | tr ':' '_')</span>.tar"</span>

  <span class="hljs-keyword">if</span> [ -f <span class="hljs-string">"<span class="hljs-variable">$TARGET_TAR</span>"</span> ]; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"⏭️  已存在：<span class="hljs-variable">$TARGET_TAR</span>，跳过保存"</span>
    <span class="hljs-built_in">continue</span>
  <span class="hljs-keyword">fi</span>

  <span class="hljs-built_in">echo</span> <span class="hljs-string">"💾 保存镜像为 tar：<span class="hljs-variable">$TARGET_TAR</span>"</span>
  docker save <span class="hljs-string">"<span class="hljs-variable">$img</span>"</span> -o <span class="hljs-string">"<span class="hljs-variable">$TARGET_TAR</span>"</span>
  <span class="hljs-comment"># 导入到 containerd 的 k8s.io 命名空间（Kubernetes 使用此命名空间）</span>
  ctr -n k8s.io images import --no-unpack <span class="hljs-string">"<span class="hljs-variable">$TARGET_TAR</span>"</span>
  
  <span class="hljs-built_in">echo</span> <span class="hljs-string">"✅ 镜像 <span class="hljs-variable">$img</span> 已导入 containerd"</span>
  <span class="hljs-built_in">echo</span> <span class="hljs-string">"✅ 已保存：<span class="hljs-variable">$TARGET_TAR</span>"</span>
<span class="hljs-keyword">done</span>

<span class="hljs-built_in">echo</span> <span class="hljs-string">"🎉 所有镜像保存完成！"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"📂 存储目录：<span class="hljs-variable">$DIR</span>"</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从3小时到30分钟：我的AI写作工作流完整拆解]]></title>    <link>https://juejin.cn/post/7578719771588886538</link>    <guid>https://juejin.cn/post/7578719771588886538</guid>    <pubDate>2025-12-01T14:42:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578719771588886538" data-draft-id="7578719771588870154" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从3小时到30分钟：我的AI写作工作流完整拆解"/> <meta itemprop="keywords" content="AIGC,AIOps"/> <meta itemprop="datePublished" content="2025-12-01T14:42:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="技术探索家"/> <meta itemprop="url" content="https://juejin.cn/user/2735240657517816"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从3小时到30分钟：我的AI写作工作流完整拆解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2735240657517816/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    技术探索家
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-01T14:42:16.000Z" title="Mon Dec 01 2025 14:42:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-01
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读15分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cd21e3452b834594862df27b001f5802~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oqA5pyv5o6i57Si5a62:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765205646&amp;x-signature=v1HInsMMzncyWD%2FjR7r0JF3lIf0%3D" alt="ai-writing-workflow.jpg" loading="lazy"/></p>
<h2 data-id="heading-0">引言</h2>
<p>之前写一篇公众号推文，我得花3个小时：1小时想选题（刷半天数据还是不知道写啥），1.5小时写初稿（写两句卡一句），最后还得改半小时。一天写两篇就累瘫了，更别提保持日更了。</p>
<p>后来我把AI整合到写作流程里，现在从选题到初稿完成只需要30分钟，而且质量比以前更稳定。关键不是让AI替你写，而是让它帮你做好每个环节的准备工作。</p>
<p>说实话，我一开始也担心用AI写的内容会不会太"机械"，读者能不能接受。但当我掌握了正确的方法后，发现AI其实是个超级高效的助手——它帮我快速度过最耗时的"启动阶段"和"框架搭建"，让我能把精力集中在真正需要创意的地方。</p>
<p>这篇文章，我会分享一套完整的AI辅助写作工作流。你会得到：</p>
<ul>
<li><strong>4步完整工作流</strong>：选题→大纲→初稿→润色，每步都有具体方法</li>
<li><strong>4个实战Prompt模板</strong>：直接复制就能用，不用自己摸索</li>
<li><strong>主流工具对比</strong>：ChatGPT、Claude、文心一言该选哪个</li>
<li><strong>去AI味技巧</strong>：让AI生成的内容更人性化的5个方法</li>
<li><strong>完整案例拆解</strong>：从选题到成稿的真实过程</li>
</ul>
<p>看完这篇，你马上就能用起来，立刻见效。</p>
<hr/>
<h3 data-id="heading-1">第一章：AI辅助写作的正确打开方式</h3>
<p>我见过太多人用AI写作的方式都是错的。</p>
<p><strong>最常见的三个误区：</strong></p>
<p>第一个是直接让AI写全文。打开ChatGPT，输入"写一篇关于XXX的文章"，然后把生成的内容直接复制粘贴。结果呢？AI味太重，读者一眼就能看出来，而且内容缺乏深度和个人见解。这样用AI，其实是浪费了它的能力。</p>
<p>第二个是只在卡壳时才想起来用AI。写了一半写不下去了，才打开ChatGPT问"怎么继续"。这种方式没有系统化，效率提升有限。就像开车只在迷路时看导航，而不是提前规划路线。</p>
<p>第三个是用一个工具干所有事。要么全用ChatGPT，要么全用Claude，但其实不同环节需要不同工具的优势。选题适合ChatGPT的发散思维，润色适合Claude的细腻表达。</p>
<p><strong>正确的理念是什么？</strong></p>
<p>AI不是替代你写作，而是辅助你的思考和执行。我现在的方式是把写作拆解成4个环节：</p>
<ol>
<li><strong>选题阶段</strong>：AI帮我快速生成10-20个选题方向，并评估每个选题的潜力</li>
<li><strong>大纲阶段</strong>：AI帮我搭建文章框架，确定每部分的核心要点</li>
<li><strong>初稿阶段</strong>：AI帮我快速生成每个段落的初稿，我负责补充细节和个人经验</li>
<li><strong>润色阶段</strong>：AI帮我去掉生硬表达，优化节奏和可读性</li>
</ol>
<p>核心原则是：<strong>AI做准备工作，人做创意决策</strong>。</p>
<p><strong>效率对比有多大？</strong></p>
<p>我自己的真实数据：</p>
<ul>
<li><strong>传统流程</strong>：选题1小时 + 写作2小时 + 修改1小时 = 4小时</li>
<li><strong>AI辅助流程</strong>：选题15分钟 + 大纲10分钟 + 初稿15分钟 + 润色20分钟 = 1小时</li>
</ul>
<p>为什么能快这么多？因为AI帮你快速度过了"启动阶段"（不知道写什么）和"框架搭建"（不知道怎么组织），这两个环节往往占掉70%的时间。一旦有了方向和框架，写作就会变得顺畅很多。</p>
<p>根据36氪的《2025内容创作行业白皮书》，使用AI的创作者平均效率提升3-5倍。我自己的感受是，一周的内容产出量从2篇提升到了10篇，而且质量更稳定了。</p>
<p>你可能会问，这真的有用吗？我的建议是：看完这篇文章，马上试一次。你会立刻感受到差异。</p>
<hr/>
<h3 data-id="heading-2">第二章：4步AI辅助写作工作流详解</h3>
<p>好，现在进入最核心的部分——完整的4步工作流。每一步我都会给你可以直接复制的Prompt模板。</p>
<h4 data-id="heading-3">步骤1：AI辅助选题（15分钟）</h4>
<p><strong>最头疼的问题</strong>：不知道写什么，担心选题没人看。</p>
<p>我以前选题能纠结1个小时，打开微信指数看数据，刷小红书找热点，脑子里想了20个方向，最后还是不确定哪个好。后来我发现，用AI生成选题方向，效率能提升10倍。</p>
<p><strong>AI如何帮你选题？</strong></p>
<ul>
<li>分析你的领域，生成10-20个选题方向</li>
<li>评估每个选题的吸引力（搜索量、竞争度）</li>
<li>提供不同角度：痛点解决型、对比分析型、案例拆解型</li>
</ul>
<p><strong>实战Prompt模板：</strong></p>
<pre><code class="hljs language-text" lang="text">你是一位资深内容策划，请帮我生成10个[领域]的选题方向。

背景：
- 目标读者：[描述受众，比如：25-35岁的新手父母，关注儿童教育]
- 内容平台：[公众号/小红书/知乎等]
- 内容风格：[干货/故事/观点等]

要求：
1. 每个选题包含：标题方向、核心卖点、目标关键词
2. 优先考虑以下角度：
   - 痛点解决型（如"如何..."、"X个方法..."）
   - 对比分析型（如"A vs B"、"选择指南"）
   - 案例拆解型（如"实战案例"、"我的经验"）
3. 评估每个选题的吸引力（1-5分）

输出格式：
选题1：[标题方向]
- 核心卖点：
- 目标关键词：
- 吸引力评分：
</code></pre>
<p><strong>实际使用示例：</strong></p>
<p>我有次用这个模板生成"职场效率工具"的选题，AI给了我10个方向，其中一个是"从3小时到30分钟：我的AI写作工作流完整拆解"，吸引力评分5分。我一看，这个选题既有对比数据（3小时到30分钟），又承诺详细方法（完整拆解），立刻就决定写这个。</p>
<p>整个选题过程，从输入Prompt到确定方向，只花了15分钟。</p>
<h4 data-id="heading-4">步骤2：AI辅助大纲（10分钟）</h4>
<p><strong>最头疼的问题</strong>：文章结构混乱，写着写着就跑偏了。</p>
<p>以前我写文章经常是想到哪写到哪，写到一半发现逻辑不通，又得推倒重来。现在我用AI搭建大纲，先把框架定好，写作就顺畅多了。</p>
<p><strong>AI如何帮你搭大纲？</strong></p>
<ul>
<li>快速搭建文章框架（引言、主体、结论）</li>
<li>确定每部分的核心要点（不会遗漏关键信息）</li>
<li>预估字数分配（避免某部分写太长或太短）</li>
</ul>
<p><strong>实战Prompt模板：</strong></p>
<pre><code class="hljs language-text" lang="text">请为以下文章生成详细大纲：

标题：[你选定的标题]
目标字数：[1500-2000字]
目标读者：[描述受众及其痛点]

大纲要求：
1. 包含引言、3-5个主体章节、结论
2. 每个章节标注：
   - 核心要点（3-5个子要点）
   - 建议字数
   - 需要的案例/数据
3. 引言要有吸引力，结论要有行动号召

额外要求：
- 逻辑流畅，层层递进
- 避免空洞内容，每部分都要有价值
</code></pre>
<p><strong>实际使用示例：</strong></p>
<p>当我决定写"AI写作工作流"这个选题后，我用这个Prompt生成大纲。AI给了我一个5段式结构：引言（困境对比）→正确理念→4步工作流→工具对比→完整案例→结论。</p>
<p>我看了一遍，觉得结构很清晰，但第二章"4步工作流"需要更详细的子要点，所以我又针对这章单独生成了详细大纲。整个过程10分钟搞定。</p>
<p>关键是：<strong>大纲生成后，你需要人工检查和调整</strong>。AI给的是通用框架，但你要根据自己的经验补充细节。</p>
<h4 data-id="heading-5">步骤3：AI辅助初稿（15分钟）</h4>
<p><strong>最头疼的问题</strong>：写作卡壳，不知道怎么展开每个段落。</p>
<p>以前我写到某个部分，脑子里有想法，但不知道怎么用文字表达，经常卡住半小时写不出一个字。现在我用AI快速生成初稿，然后在初稿基础上修改，效率提升太多了。</p>
<p><strong>AI如何帮你写初稿？</strong></p>
<ul>
<li>基于大纲快速生成每个章节的内容</li>
<li>提供段落展开思路（你可能没想到的角度）</li>
<li>补充案例和数据（让内容更丰满）</li>
</ul>
<p><strong>关键技巧：分段生成，而不是一次性生成全文</strong></p>
<p>为什么？因为分段生成质量更高，更容易控制。一次生成全文，AI容易跑偏，而且你很难逐段审核。我的方法是：一次生成1-2个段落，人工审核后继续。</p>
<p><strong>实战Prompt模板：</strong></p>
<pre><code class="hljs language-text" lang="text">基于以下大纲，撰写[第X章]的内容：

【大纲内容】
[粘贴该章节的大纲]

【写作要求】
1. 字数：约[X]字
2. 风格：
   - 用第一人称，像朋友聊天
   - 用真实案例和具体场景
   - 避免空洞说教，多用"你可以这样..."的句式
3. 结构：
   - 开头点明这部分要解决什么问题
   - 中间用2-3个要点展开
   - 结尾总结关键行动
4. 避免：
   - 不要用"综上所述"、"因此"等AI味词汇
   - 不要过度使用"首先、其次、最后"
   - 不要堆砌专业术语

【参考信息】
[如果有相关资料或案例，在这里提供]
</code></pre>
<p><strong>实际使用示例：</strong></p>
<p>当我写"选题阶段"这部分时，我用这个Prompt生成了初稿。AI给了我一个3段结构：痛点描述→AI如何帮忙→Prompt模板→实际案例。</p>
<p>初稿质量还不错，但我发现缺少个人经历，于是我加了一句："我以前选题能纠结1个小时，打开微信指数看数据，刷小红书找热点，脑子里想了20个方向，最后还是不确定哪个好。"这样一加，内容就有温度了。</p>
<p><strong>记住：AI生成的是初稿，你的工作是让它变得更真实、更有个性。</strong></p>
<h4 data-id="heading-6">步骤4：AI辅助润色（20分钟）</h4>
<p><strong>最头疼的问题</strong>：初稿写完了，但总觉得不够"人性化"，有点生硬。</p>
<p>这是我花时间最多的环节。因为AI生成的初稿虽然逻辑清晰，但经常有些"AI味"——比如"因此"、"综上所述"这些词，或者段落过于完美对称。读者一看就知道是AI写的。</p>
<p><strong>AI如何帮你润色？</strong></p>
<ul>
<li>去除AI味，替换生硬表达</li>
<li>优化句子节奏，长短句结合</li>
<li>增强人性化，加入对话感</li>
</ul>
<p><strong>实战Prompt模板：</strong></p>
<pre><code class="hljs language-text" lang="text">请帮我优化以下文章段落，重点去除AI味，增强人性化表达：

【原文】
[粘贴需要优化的段落]

【优化要求】
1. 去AI味：
   - 替换：因此→所以、实际上→其实、相当→挺
   - 删除：综上所述、不难发现、值得注意的是
   - 避免：过于完美的三段论逻辑
2. 增加人性化：
   - 加入个人经历或观察："我发现..."、"有次我..."
   - 用具体细节替代笼统概念
   - 适当使用疑问句和读者对话
3. 优化节奏：
   - 长短句结合
   - 适当断句，避免超长段落
   - 关键信息用短句突出

【保持不变】
- 核心观点和信息
- 整体结构
</code></pre>
<p><strong>去AI味的5个实用技巧：</strong></p>
<ol>
<li><strong>替换AI常用连接词</strong>：因此→所以、实际上→其实、相当→挺、然而→但</li>
<li><strong>打破完美对称的结构</strong>：不要每段都是"首先、其次、最后"，适当用"还有一个点"、"另外"</li>
<li><strong>增加具体细节和场景</strong>：不说"效率提升很多"，而说"从3小时缩短到30分钟"</li>
<li><strong>适当表达不确定性</strong>：不总是说"一定"、"必须"，可以说"我觉得"、"可能"</li>
<li><strong>加入个人色彩和情感</strong>：分享你的困惑、惊喜、失望，让读者感受到真实的人</li>
</ol>
<p><strong>实际使用示例：</strong></p>
<p>我用这个Prompt优化了引言部分。原本AI生成的开头是："在当今内容创作领域，效率是关键因素。AI工具可以显著提升写作效率。"</p>
<p>优化后变成："之前写一篇公众号推文，我得花3个小时：1小时想选题，1.5小时写初稿,还得改半小时。一天写两篇就累瘫了。"</p>
<p>你看，优化后是不是更真实、更有代入感？</p>
<p><strong>小结：4步工作流的时间分配</strong></p>
<p>选题（15分钟）→ 大纲（10分钟）→ 初稿（15分钟）→ 润色（20分钟）= <strong>总计1小时</strong></p>
<p>对比传统流程的4小时，效率提升了<strong>75%</strong>。而且这还是保守估计，随着你对工作流越来越熟练，速度还会更快。</p>
<hr/>
<h3 data-id="heading-7">第三章：主流AI写作工具对比和选择</h3>
<p>工具太多，到底该用哪个？这是我最常被问的问题。</p>
<p>我自己测试过市面上所有主流的AI写作工具，下面给你一个完整对比。</p>
<h4 data-id="heading-8">1. ChatGPT（最全能）⭐⭐⭐⭐⭐</h4>
<p><strong>优势：</strong></p>
<ul>
<li>功能最全面，从选题到润色都能搞定</li>
<li>免费版就能满足大部分需求</li>
<li>生成速度快，输出质量稳定</li>
</ul>
<p><strong>适用场景</strong>：从选题到润色的所有环节</p>
<p><strong>成本</strong>：免费版够用，Plus版 $20/月（如果高频使用建议升级）</p>
<p><strong>我的使用感受</strong>：ChatGPT是我用得最多的工具，80%的工作流都靠它。尤其是选题和大纲阶段，ChatGPT的发散思维特别强，能给你很多意想不到的角度。</p>
<h4 data-id="heading-9">2. Claude（最人性化）⭐⭐⭐⭐</h4>
<p><strong>优势：</strong></p>
<ul>
<li>输出更人性化，逻辑更清晰</li>
<li>特别擅长长文本的理解和生成</li>
<li>对中文的语境理解比ChatGPT好一些</li>
</ul>
<p><strong>适用场景</strong>：大纲搭建、内容润色</p>
<p><strong>成本</strong>：免费版限制较多，Pro版 $20/月</p>
<p><strong>我的使用感受</strong>：Claude在润色环节特别好用。当你用ChatGPT生成了初稿，想让内容更"人性化"时，把内容丢给Claude优化，效果会更好。</p>
<h4 data-id="heading-10">3. 文心一言（国内选择）⭐⭐⭐⭐</h4>
<p><strong>优势：</strong></p>
<ul>
<li>对中文语境理解好，生成的内容更符合国内表达习惯</li>
<li>无需翻墙，访问稳定</li>
<li>对公众号、小红书等平台的风格理解到位</li>
</ul>
<p><strong>适用场景</strong>：公众号、小红书等中文内容创作</p>
<p><strong>成本</strong>：基础功能免费</p>
<p><strong>我的使用感受</strong>：如果你主要写中文内容，而且不想折腾翻墙，文心一言是最佳选择。它对"小红书爆款标题"、"公众号开头"这些场景特别理解。</p>
<h4 data-id="heading-11">4. Notion AI（最便捷）⭐⭐⭐</h4>
<p><strong>优势：</strong></p>
<ul>
<li>集成在笔记工具中，写作润色一体化</li>
<li>可以直接在文档中调用AI</li>
<li>适合已经在用Notion管理内容的创作者</li>
</ul>
<p><strong>适用场景</strong>：已使用Notion的创作者</p>
<p><strong>成本</strong>：$10/月（需要先有Notion订阅）</p>
<p><strong>我的使用感受</strong>：如果你已经在用Notion做内容管理，Notion AI确实很方便。但如果你不用Notion，就没必要为了AI单独订阅。</p>
<h4 data-id="heading-12">工具组合建议</h4>
<p>根据不同阶段，我推荐这样组合：</p>
<ul>
<li><strong>新手入门</strong>：ChatGPT免费版（全流程都能搞定）</li>
<li><strong>进阶使用</strong>：ChatGPT Plus（选题+初稿）+ Claude（润色）</li>
<li><strong>国内用户</strong>：文心一言（主力）+ ChatGPT（备用）</li>
</ul>
<p><strong>工具使用技巧：</strong></p>
<ol>
<li>同一内容在不同工具测试，选最好的输出</li>
<li>利用各工具优势：ChatGPT做发散，Claude做收敛</li>
<li>建立Prompt模板库，提高复用效率</li>
</ol>
<p>说实话，工具只是手段，关键是你的工作流。哪怕只用ChatGPT免费版，只要工作流清晰，效率也能提升好几倍。</p>
<hr/>
<h3 data-id="heading-13">第四章：进阶技巧和避坑指南</h3>
<p>掌握基础工作流后，你还可以用这些进阶技巧进一步提升效率。</p>
<h4 data-id="heading-14">进阶技巧</h4>
<p><strong>1. 建立个人Prompt模板库</strong></p>
<p>把常用的Prompt保存到Notion或飞书文档，按照不同平台分类：</p>
<ul>
<li>公众号选题Prompt</li>
<li>小红书文案Prompt</li>
<li>知乎回答Prompt</li>
</ul>
<p>我现在有20+个Prompt模板，每次写作直接调用，省去了重新想Prompt的时间。</p>
<p><strong>2. 利用AI进行内容优化</strong></p>
<p>AI不只是帮你写，还能帮你分析：</p>
<ul>
<li>用AI分析文章的SEO表现（关键词密度、可读性）</li>
<li>让AI提供标题的10个变体（选最吸引人的）</li>
<li>用AI生成不同风格的开头和结尾（A/B测试）</li>
</ul>
<p><strong>3. 批量生产内容</strong></p>
<p>如果你需要持续产出内容，可以这样做：</p>
<ul>
<li>一次生成10个大纲，批量执行</li>
<li>利用AI进行内容改写和多平台适配（一篇文章改成公众号版、小红书版、知乎版）</li>
<li>建立内容日历，系统化生产</li>
</ul>
<h4 data-id="heading-15">常见错误和避坑</h4>
<p><strong>1. 过度依赖AI</strong></p>
<p>错误做法：完全照搬AI输出，不做任何修改。
正确做法：AI提供框架，人补充细节和个性。</p>
<p><strong>2. 忽视人工审核</strong></p>
<p>错误做法：AI写完直接发布，结果出现事实错误或逻辑问题。
正确做法：必须人工检查事实、逻辑、语气。</p>
<p><strong>3. Prompt太模糊</strong></p>
<p>错误做法："帮我写一篇文章"
正确做法：使用结构化Prompt，明确受众、风格、字数、要求。</p>
<p><strong>4. 不做迭代优化</strong></p>
<p>错误做法：一个Prompt用到底，效果不好也不调整。
正确做法：根据实际效果持续优化Prompt模板。</p>
<p><strong>5. 忽视平台特性</strong></p>
<p>错误做法：所有平台用同一套内容。
正确做法：根据平台调整风格和结构（公众号要深度，小红书要视觉，知乎要专业）。</p>
<hr/>
<h3 data-id="heading-16">结论</h3>
<p>AI辅助写作的本质，不是让AI替代你，而是优化你的工作流程。</p>
<p>回顾一下核心要点：</p>
<ol>
<li><strong>4步工作流是关键</strong>：选题→大纲→初稿→润色，每个环节都有对应的Prompt模板</li>
<li><strong>工具选择看需求</strong>：ChatGPT是最全能选择，Claude适合润色，文心一言适合国内用户</li>
<li><strong>人机协作是核心</strong>：AI做80%的执行工作，人做20%的创意决策</li>
<li><strong>去AI味很重要</strong>：用Prompt优化+人工调整，让内容更人性化</li>
</ol>
<p><strong>立即行动清单：</strong></p>
<ol>
<li>保存本文的4个Prompt模板（选题、大纲、初稿、润色）</li>
<li>选择一个AI工具（推荐ChatGPT，免费版就够用）</li>
<li>用本文的工作流写一篇文章</li>
<li>记录时间，对比效率提升</li>
</ol>
<p>试试看，你会发现写作不再是痛苦的事，而是高效的创作过程。当你掌握这套方法后，再也不用为内容产出发愁了</p>
<blockquote>
<p>本文首发<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.betterlink.top%2Fzh%2Fposts%2Fmedia%2F20250125-ai-writing-workflow%2F" target="_blank" title="https://blog.betterlink.top/zh/posts/media/20250125-ai-writing-workflow/" ref="nofollow noopener noreferrer">自个人博客</a></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Joplin：一款真正属于你的开源笔记与待办事项应用]]></title>    <link>https://juejin.cn/post/7578699975414169600</link>    <guid>https://juejin.cn/post/7578699975414169600</guid>    <pubDate>2025-12-01T15:02:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578699975414169600" data-draft-id="7578714759337361408" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Joplin：一款真正属于你的开源笔记与待办事项应用"/> <meta itemprop="keywords" content="Markdown"/> <meta itemprop="datePublished" content="2025-12-01T15:02:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="修己xj"/> <meta itemprop="url" content="https://juejin.cn/user/2641475936724142"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Joplin：一款真正属于你的开源笔记与待办事项应用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2641475936724142/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    修己xj
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-01T15:02:25.000Z" title="Mon Dec 01 2025 15:02:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-01
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在信息爆炸的时代，我们每天都在接收、处理和产生大量信息。一款优秀的笔记软件不仅是我们记忆的延伸，更是知识管理的核心工具。如果你正在寻找一款<strong>真正尊重你数据所有权、功能全面且完全免费，并且支持多端同步</strong>的笔记应用，那么Joplin值得你深入了解。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/57e9c6cee9a949e383caebba2a78dccb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765206145&amp;x-signature=C%2FKyguXr6eeDpGMfxZY9pEe8L64%3D" alt="fill_w374_h374_g0_mark_2021012515175784.png" loading="lazy"/></p>
<p>fill_w374_h374_g0_mark_2021012515175784.png</p>
<h2 data-id="heading-0">什么是Joplin？</h2>
<p>Joplin是一款<strong>免费、开源的笔记和待办事项管理应用</strong>，它能够处理大量笔记并将其组织到不同的笔记本中。所有笔记都采用Markdown格式，这意味着你的内容永远不会被专有格式锁定。</p>
<p>该项目已经在github 上已经拥有 52.4k star</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bde59855410b4f6582623db30f7a64fb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765206145&amp;x-signature=rlUWVRc5pyx4Y1FWZ4f1%2BdQHaj0%3D" alt="ScreenShot_2025-12-01_220457_085.png" loading="lazy"/></p>
<p>ScreenShot_2025-12-01_220457_085.png</p>
<p>github 地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Flaurent22%2Fjoplin" target="_blank" title="https://github.com/laurent22/joplin" ref="nofollow noopener noreferrer">github.com/laurent22/j…</a></p>
<p>官网地址： <a href="https://link.juejin.cn?target=https%3A%2F%2Fjoplinapp.org%2F" target="_blank" title="https://joplinapp.org/" ref="nofollow noopener noreferrer">joplinapp.org/</a></p>
<h2 data-id="heading-1">核心特色与优势</h2>
<h3 data-id="heading-2">🔒 <strong>离线优先，数据自主</strong></h3>
<p>Joplin采用“离线优先”设计理念，你的所有数据都存储在本地设备上。无论是否有网络连接，你都能随时随地访问自己的笔记。这不仅是便利性的问题，更是<strong>数据主权的保障</strong>——你的笔记永远属于你。</p>
<h3 data-id="heading-3">🔄 <strong>安全同步与端到端加密</strong></h3>
<p>Joplin支持通过多种云服务进行同步，包括：</p>
<ul>
<li>Nextcloud（自建云首选）</li>
<li>Dropbox</li>
<li>OneDrive</li>
<li>Joplin Cloud（官方同步服务）</li>
<li>s3</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a4f748f814f84601a3ae077e70a0b9a9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765206145&amp;x-signature=Yt3sF21oqR3Cu6TNmKAHe34HcGY%3D" alt="ScreenShot_2025-12-01_220803_263.png" loading="lazy"/></p>
<p>ScreenShot_2025-12-01_220803_263.png</p>
<p>更重要的是，所有同步都支持<strong>端到端加密</strong>，即使是云服务提供商也无法读取你的笔记内容。这种级别的安全保障在免费应用中极为罕见。</p>
<h3 data-id="heading-4">📥 <strong>强大的导入功能</strong></h3>
<p>如果你是Evernote用户，Joplin能让你<strong>无缝迁移</strong>。它可以完整导入Evernote笔记，包括：</p>
<ul>
<li>格式化内容（自动转换为Markdown）</li>
<li>资源文件（图片、附件等）</li>
<li>完整元数据（地理位置、创建时间、更新时间等）</li>
</ul>
<p>纯Markdown文件也可以轻松导入，避免了数据迁移的烦恼。</p>
<h3 data-id="heading-5">🔍 <strong>全平台全文搜索</strong></h3>
<p>无论你在哪个平台使用Joplin，都能享受到<strong>快速、高效的全文搜索</strong>。忘记笔记放在哪里？只需输入关键词，相关笔记即刻呈现。</p>
<h3 data-id="heading-6">🎨 <strong>可扩展的插件系统</strong></h3>
<p>Joplin支持插件和主题定制，你可以：</p>
<ul>
<li>从社区插件库中安装现成插件</li>
<li>使用不同主题个性化界面</li>
<li>甚至可以<strong>自己开发插件</strong>，满足特定需求</li>
</ul>
<h3 data-id="heading-7">🌐 <strong>全平台覆盖</strong></h3>
<p>Joplin几乎支持所有主流平台：</p>
<ul>
<li>桌面端：Windows、Linux、macOS</li>
<li>移动端：Android、iOS</li>
<li>浏览器扩展：Firefox和Chrome的Web Clipper，可以保存网页和截图</li>
</ul>
<h2 data-id="heading-8">为什么选择Joplin而不是其他笔记应用？</h2>
<h3 data-id="heading-9">1. <strong>真正的数据自由</strong></h3>
<p>大多数笔记应用将你的数据锁定在他们的服务器和专有格式中。Joplin使用<strong>标准Markdown格式</strong>，即使有一天你不再使用Joplin，你的笔记仍然可以轻松迁移到其他支持Markdown的应用中。</p>
<h3 data-id="heading-10">2. <strong>开源透明</strong></h3>
<p>作为开源项目，Joplin的代码对所有人开放。这意味着：</p>
<ul>
<li>没有隐藏的后门或数据收集</li>
<li>社区可以审查代码安全性</li>
<li>任何开发者都可以贡献改进</li>
<li>项目发展方向由社区共同决定</li>
</ul>
<h3 data-id="heading-11">3. <strong>隐私保护</strong></h3>
<p>端到端加密确保只有你能阅读自己的笔记。即使是Joplin开发团队也无法访问你的数据。</p>
<h3 data-id="heading-12">4. <strong>零费用门槛</strong></h3>
<p>完全免费使用，没有功能限制或订阅费用。虽然有Joplin Cloud同步服务（付费），但你完全可以选择其他免费的同步方案。</p>
<h2 data-id="heading-13">开始使用Joplin</h2>
<h3 data-id="heading-14">安装指南</h3>
<p>访问Joplin官网（joplinapp.org）即可下载适合你设备的版本。安装过程简单直观，几分钟内即可开始记录。我在这块下载的是windows 和安卓apk 两各平台的版本。下载安装的的过程都比较简单，我因为之前在公网服务器上部署过 rustfs ,我们此处也采用的是rustfs 同步多端数据，如果你有其他兼容s3协议的oss,如minio等，也可以试用，其他oneDrive、nextCloud等网盘也可做为同步工具试用。我们此处展示下如何用rustfs配置，对rustfs感兴趣的家人们也可以翻一下博主介绍rustfs部署的历史文章。</p>
<p>在windows上部署joplin之后 点击 <code>工具</code>-&gt;<code>选项</code>，点击菜单中的<code>同步</code>，<code>同步目标</code>选择<code>s3</code>, <img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6053cf9f866f4b9aa8385ed36ddc699c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765206145&amp;x-signature=pQLpSmEifer5ALm%2FYQrUiCcCydw%3D" alt="ScreenShot_2025-12-01_221816_815.png" loading="lazy"/></p>
<p>s3的存储桶应该事先创建好，创建好之后按图配置信息即可</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/30aa2cd91ee2467689c36d04248baedd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765206145&amp;x-signature=ZAyUl%2F5aeEiS82yqT9QrtgQwE1Q%3D" alt="ScreenShot_2025-12-01_222507_097.png" loading="lazy"/></p>
<p>ScreenShot_2025-12-01_222507_097.png</p>
<p>配置好之后我们就可以创建<code>笔记本</code>,创建<code>笔记</code>了，写完笔记之后点击同步，我们就可以在我们的s3文件存储系统配置的桶中看到我们同步上去的笔记了。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c7c8dc8801a24d95b0ebe60392c08602~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765206145&amp;x-signature=7XcYXfbZsiQBI8i2bygqMGlrX%2Bw%3D" alt="ScreenShot_2025-12-01_223424_749.png" loading="lazy"/></p>
<p>ScreenShot_2025-12-01_223424_749.png</p>
<p><a href="https://link.juejin.cn?target=http%3A%2F%2Fchevereto.xiuji.mynatapp.cc%2Fimage%2FXI4P" target="_blank" title="http://chevereto.xiuji.mynatapp.cc/image/XI4P" ref="nofollow noopener noreferrer"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/430f85d4b72b43a3a39a1fac19d90844~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765206145&amp;x-signature=gmBFhABK08xdsJrKJ5%2B%2BgCkXW0c%3D" alt="ScreenShot_2025-12-01_223803_948.md.png" loading="lazy"/></a></p>
<p>ScreenShot_2025-12-01_223803_948.md.png</p>
<p>到此，我们windows端的配置就ok了，安卓手机可以在官网下载<a href="https://link.juejin.cn?target=https%3A%2F%2Fjoplinapp.org%2Fhelp%2Finstall%2F" target="_blank" title="https://joplinapp.org/help/install/" ref="nofollow noopener noreferrer"> https://joplinapp.org/help/install/</a> 下载apk，</p>
<p><a href="https://link.juejin.cn?target=http%3A%2F%2Fchevereto.xiuji.mynatapp.cc%2Fimage%2FXLAh" target="_blank" title="http://chevereto.xiuji.mynatapp.cc/image/XLAh" ref="nofollow noopener noreferrer"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/00959b1beba74104907d7225d3625de0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765206145&amp;x-signature=2sV2nSvH5S9zeLb5wt2DG7OF4Fs%3D" alt="ScreenShot_2025-12-01_224017_013.png" loading="lazy"/></a></p>
<p>ScreenShot_2025-12-01_224017_013.png</p>
<p>安装之后打开软件，点击<code>设置</code>-&gt;<code>同步</code>，然后和windows一样配置我们的s3信息就可以了</p>
<p><a href="https://link.juejin.cn?target=http%3A%2F%2Fchevereto.xiuji.mynatapp.cc%2Fimage%2FXV5j" target="_blank" title="http://chevereto.xiuji.mynatapp.cc/image/XV5j" ref="nofollow noopener noreferrer"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/56be7834479c4db99f7468f105847bbd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765206145&amp;x-signature=cvIVeplF%2F9CJozmeWtTOEWlq4PQ%3D" alt="ScreenShot_2025-12-01_224341_221.png" loading="lazy"/></a></p>
<p>ScreenShot_2025-12-01_224341_221.png</p>
<p><a href="https://link.juejin.cn?target=http%3A%2F%2Fchevereto.xiuji.mynatapp.cc%2Fimage%2FXoTk" target="_blank" title="http://chevereto.xiuji.mynatapp.cc/image/XoTk" ref="nofollow noopener noreferrer"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/864a19b655464a069c08d8ac1f46624d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765206145&amp;x-signature=uJH9n%2B9i5GcqVjckNmkfPtpUXk8%3D" alt="ScreenShot_2025-12-01_224357_969.png" loading="lazy"/></a></p>
<p>ScreenShot_2025-12-01_224357_969.png</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c73b7e016b4d495a9b25745615dbc113~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765206145&amp;x-signature=PVNHr%2BKOZ%2BM0QAL9XQjnFHpQibg%3D" alt="ScreenShot_2025-12-01_224424_065.png" loading="lazy"/></p>
<p>ScreenShot_2025-12-01_224424_065.png</p>
<p>配置好之后点击同步我们就可以多端同步我们的笔记内容了。</p>
<h2 data-id="heading-15">结语</h2>
<p>在数字时代，我们的笔记不仅仅是文字，更是思考的轨迹、创意的种子和知识的宝库。Joplin提供了一种<strong>既强大又尊重用户</strong>的解决方案，让你在享受现代化笔记功能的同时，完全掌控自己的数据。</p>
<p>无论你是学生、研究者、开发者还是知识工作者，Joplin都值得一试。它可能不是最华丽的笔记应用，但它绝对是最值得信赖的伙伴之一——永远不会将你的数据作为商品，永远不会在你最需要时因为网络问题而无法访问，永远不会在你习惯使用后开始收取高额费用。</p>
<p><strong>你的笔记，本就该完全属于你。</strong> Joplin让这个简单的理念成为现实。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Nano Banana Pro 很强，但你要学会写提示词才能为所欲为]]></title>    <link>https://juejin.cn/post/7578681104292544555</link>    <guid>https://juejin.cn/post/7578681104292544555</guid>    <pubDate>2025-12-01T13:06:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578681104292544555" data-draft-id="7578681104292528171" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Nano Banana Pro 很强，但你要学会写提示词才能为所欲为"/> <meta itemprop="keywords" content="AIGC,人工智能,MCP"/> <meta itemprop="datePublished" content="2025-12-01T13:06:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="冴羽"/> <meta itemprop="url" content="https://juejin.cn/user/712139234359182"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Nano Banana Pro 很强，但你要学会写提示词才能为所欲为
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/712139234359182/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    冴羽
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-01T13:06:05.000Z" title="Mon Dec 01 2025 13:06:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-01
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1. 前言</h2>
<p>如果你已经学会：</p>
<ol>
<li>
<p>免费使用 Nano Banana Pro： <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FtYKzM0PIvBm5QG08SW3_BA" target="_blank" title="https://mp.weixin.qq.com/s/tYKzM0PIvBm5QG08SW3_BA" ref="nofollow noopener noreferrer">6 个白嫖 Nano Banana Pro 的网站</a></p>
</li>
<li>
<p>使用提示词库复刻惊艳图片：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FxZQNPPwGxhzWhGsr-alKkg" target="_blank" title="https://mp.weixin.qq.com/s/xZQNPPwGxhzWhGsr-alKkg" ref="nofollow noopener noreferrer">一次找齐！1000 个 Nano Banana Pro 提示词</a></p>
</li>
</ol>
<p>那本篇我们来点干货 —— 如何写出好的提示词。</p>
<p>之所以要学习如何写提示词，是因为绝大部分人在写提示词时，都是一种 <strong>“随缘”</strong> 的状态——有的地方写得详细，有的地方却被遗漏了，这就带来了 <strong>很大的不确定性</strong> 。</p>
<p>所以本篇我们就来聊聊如何通过结构化的提示词，提升图片生成的质量，<strong>让 Nano Bnana 生成的每一张图都是高水准的图片。</strong></p>
<h2 data-id="heading-1">2. 生成图片</h2>
<h3 data-id="heading-2">2.1. 逼真场景</h3>
<p>如果要生成逼真的图片，最好使用摄影术语，设定拍摄角度、镜头类型、光线和细节，引导模型生成逼真的效果。</p>
<p>英文模板为：</p>
<pre><code class="hljs language-plain" lang="plain">A photorealistic [shot type] of [subject], [action or expression], set in
[environment]. The scene is illuminated by [lighting description], creating
a [mood] atmosphere. Captured with a [camera/lens details], emphasizing
[key textures and details]. The image should be in a [aspect ratio] format.
</code></pre>
<p>中文模板为：</p>
<blockquote>
<p>一张高度写实的 <strong>[镜头类型]</strong> ，主体为 <strong>[拍摄对象]</strong> ， <strong>[动作或表情]</strong> ，场景设定在 <strong>[环境]</strong> 中。场景由 <strong>[光线描述]</strong> 照明，营造出 <strong>[氛围]</strong> 的氛围。使用 <strong>[相机/镜头细节]</strong> 拍摄，突出 <strong>[关键纹理和细节]</strong> 。图像应采用 <strong>[纵横比]</strong> 格式。</p>
</blockquote>
<p>让我们举个例子：</p>
<blockquote>
<p>一幅高度写实的特写肖像，描绘了一位年长的中国陶艺家。他脸上有着深深的、被阳光刻下的皱纹，带着温暖而洞悉一切的微笑。他正仔细检查一个刚上釉的茶碗。场景设定在他那质朴且阳光充足的工作室里。柔和的黄金时刻光线透过窗户洒入，照亮了黏土细腻的纹理。这幅肖像使用 85 毫米人像镜头拍摄，背景呈现出柔和模糊的效果（焦外成像）。整体氛围宁静而娴熟。肖像采用垂直构图。</p>
</blockquote>
<p>效果如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3b59c455ecfc4fd687c5bd73e4a1dca1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765199164&amp;x-signature=lSPTt3BGowVi4I4UedTcAy5uBI4%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-3">2.2. 风格插画或贴纸</h3>
<p>如果要创建插画、贴纸、图标等资源，要明确说明样式并要求使用透明的背景。</p>
<p>英文模板为：</p>
<pre><code class="hljs language-plain" lang="plain">A [style] sticker of a [subject], featuring [key characteristics] and a
[color palette]. The design should have [line style] and [shading style].
The background must be transparent.
</code></pre>
<p>中文模板为：</p>
<blockquote>
<p>一张 <strong>[风格]</strong> 的 <strong>[主体]</strong> 贴纸，具有 <strong>[关键特征]</strong> 和 <strong>[色彩搭配]</strong> 。设计应采用 <strong>[线条风格]</strong> 和 <strong>[阴影风格]</strong> 。背景必须是透明的。</p>
</blockquote>
<p>举个例子：</p>
<blockquote>
<p>一张可爱风格的贴纸，上面是一只开心的小熊猫，戴着一顶小小的竹帽，正在啃着一片绿色的竹叶。设计采用了醒目清晰的轮廓、简单的卡通渲染，以及鲜艳的色彩搭配。背景必须是透明的。</p>
</blockquote>
<p>效果如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ae4f4c9ce0714fe5884ce15f98cea5fd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765199164&amp;x-signature=N86jW4j4r2MJPqXSEO1wEpT%2BeLs%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-4">2.3. 精准的带文字渲染</h3>
<p>Nano Banana Pro 强化了文本渲染方面的表现，以前生成汉字的时候还有不少乱码，到 Pro 已经明显改善了很多。但在写提示词时，还是要清晰地说明文字内容、字体样式和整体设计。</p>
<p>英文模板为：</p>
<pre><code class="hljs language-plain" lang="plain">Create a [image type] for [brand/concept] with the text "[text to render]"
in a [font style]. The design should be [style description], with a
[color scheme].
</code></pre>
<p>中文模板为：</p>
<blockquote>
<p>为 <strong>[品牌/概念]</strong> 创建一个 <strong>[图像类型]</strong> ， <strong>[要渲染的文字]</strong> 采用 <strong>[文字风格]</strong> 。设计应具有 <strong>[风格描述]</strong> ，并采用 <strong>[配色方案]</strong> 。</p>
</blockquote>
<p>举个例子：</p>
<blockquote>
<p>为一家名为 “The Daily Grind” 的咖啡店设计一个现代简约风格的标志。文字部分采用简洁、粗体的无衬线字体。配色方案为黑白两色。将标志置于圆形之中。巧妙地融入一颗咖啡豆元素。</p>
</blockquote>
<p>效果如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/adbe92278142455da54fdfffdf7dcc81~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765199164&amp;x-signature=3L37Fz1WDVcoeELN9GV7AdJUIbo%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-5">2.4. 产品摄影</h3>
<p>为电商、广告或品牌制作专业的商品图片。</p>
<p>英文模板为：</p>
<pre><code class="hljs language-plain" lang="plain">A high-resolution, studio-lit product photograph of a [product description]
on a [background surface/description]. The lighting is a [lighting setup,
e.g., three-point softbox setup] to [lighting purpose]. The camera angle is
a [angle type] to showcase [specific feature]. Ultra-realistic, with sharp
focus on [key detail]. [Aspect ratio].
</code></pre>
<p>中文模板为：</p>
<blockquote>
<p>一张高分辨率、工作室灯光照明的 <strong>[产品描述]</strong> 产品照片，背景是 <strong>[背景]</strong> 。灯光采用 <strong>[照明设置]</strong> ，目的是 <strong>[照明用途]</strong> 。相机角度为 <strong>[角度类型]</strong> ，以展示 <strong>[特定特征]</strong> 。超写实风格，对 <strong>[关键细节]</strong> 聚焦清晰。 <strong>[纵横比]</strong> 。</p>
</blockquote>
<p>举个例子：</p>
<blockquote>
<p>一张高分辨率、工作室灯光照明的极简主义哑光黑色陶瓷咖啡杯产品照片，放置在抛光的混凝土表面上。灯光采用三点柔光箱设置，旨在营造柔和、漫射的高光并消除刺眼的阴影。相机角度为略微升高的 45 度角，以展示其简洁的线条。超写实风格，清晰聚焦于从咖啡中升起的蒸汽。正方形图像。</p>
</blockquote>
<p>效果如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3fa59490bc8e4b92a7f8b59c45df09a2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765199164&amp;x-signature=kaVlcEW4IjSf2uO4cuY6IRmQtG0%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-6">2.5. 极简主义与留白设计</h3>
<p>英文模板为：</p>
<pre><code class="hljs language-plain" lang="plain">A minimalist composition featuring a single [subject] positioned in the
[bottom-right/top-left/etc.] of the frame. The background is a vast, empty
[color] canvas, creating significant negative space. Soft, subtle lighting.
[Aspect ratio].
</code></pre>
<p>中文模板为：</p>
<blockquote>
<p>一幅极简主义构图，画面中单一的 <strong>[主体]</strong> 位于画框的 <strong>[位置]</strong> 。背景是一片广阔、空旷的 <strong>[颜色]</strong> 画布，营造出大量的留白。光线柔和、微妙。 <strong>[宽高比]</strong> 。</p>
</blockquote>
<p>举个例子：</p>
<blockquote>
<p>一幅极简风格的构图，画面右下角放置着一片精致的红色枫叶。背景是一片广阔、空旷的米白色画布，为文字留出了大量的留白空间。左上角有柔和、漫射的光线。方形图像。</p>
</blockquote>
<p>效果如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a85baca5c343455ba54c6dc9065349a4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765199164&amp;x-signature=nomj0WyqQrCT2S9l3VL9l8I5n28%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-7">2.6. 连环画与分镜</h3>
<p>利用模型对角色一致性和场景描述的理解，制作多格漫画或故事板。</p>
<p>英文模板为：</p>
<pre><code class="hljs language-plain" lang="plain">Make a 3 panel comic in a [style]. Put the character in a [type of scene].
</code></pre>
<p>中文模板为：</p>
<blockquote>
<p>制作一个 3 格漫画，风格为 <strong>[风格]</strong> 。让角色处于 <strong>[场景类型]</strong> 中。</p>
</blockquote>
<p>举个例子：</p>
<blockquote>
<p>创作一个三格漫画，采用粗犷的黑色电影艺术风格，运用高对比度的黑白墨水绘制。让角色处于一个幽默的场景中。</p>
</blockquote>
<p>用了一张马斯克的图片：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/10ef56f5d2344c73bf51242df4c3876c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765199164&amp;x-signature=%2BB%2Fi8qIx5qPoPlgdO%2Ft%2FYi5YbaU%3D" alt="" loading="lazy"/></p>
<p>效果如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/47f0e1b6300148c6a2e9581a3ac8b1f2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765199164&amp;x-signature=9i%2Bk3q9KcThWdbpYVoAqckh0dmM%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-8">3. 修改图片</h2>
<h3 data-id="heading-9">3.1. 添加或删除元素</h3>
<p>提供图片并描述修改内容。模型将与原始图片的风格、灯光和透视效果保持一致。</p>
<p>英文模板为：</p>
<pre><code class="hljs language-plain" lang="plain">Using the provided image of [subject], please [add/remove/modify] [element] to/from the scene. Ensure the change is [description of how the change should integrate].
</code></pre>
<p>中文模板为：</p>
<blockquote>
<p>请使用提供的 <strong>[主体]</strong> 图片，在场景中 <strong>[添加/移除/修改] [元素]</strong> 。确保这一更改能 <strong>[按描述的方式融入场景]</strong> 。</p>
</blockquote>
<p>举个例子：</p>
<blockquote>
<p>请使用我提供的那张我的猫咪的照片，在它的头上加一顶小小的针织巫师帽。让它看起来坐得很舒服，并且与照片柔和的光线相匹配</p>
</blockquote>
<p>效果如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/42ea031302f34e838e84a6c70e6dae8b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765199164&amp;x-signature=x9CK5CvWJgew8PU17gF0xYoRlAI%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-10">3.2. 局部重绘</h3>
<p>英文模板为：</p>
<pre><code class="hljs language-plain" lang="plain">Using the provided image, change only the [specific element] to [new
element/description]. Keep everything else in the image exactly the same,
preserving the original style, lighting, and composition.
</code></pre>
<p>中文模板为：</p>
<blockquote>
<p>使用提供的图片，仅将 <strong>[特定元素]</strong> 更改为 <strong>[新元素/描述]</strong> 。保持图片中的其他所有内容完全不变，保留原有的风格、光线和构图。</p>
</blockquote>
<p>举个例子：</p>
<blockquote>
<p>“使用提供的客厅图片，只将蓝色沙发换成复古的棕色皮质切斯特菲尔德沙发。房间的其余部分，包括沙发上的抱枕和照明，保持不变。”</p>
</blockquote>
<p>效果如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4d5128d86db6469d9057a023efee6447~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765199164&amp;x-signature=JUpXblvZKkAfIBBISVM17AXNjrE%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-11">3.3. 风格迁移</h3>
<p>英文模板为：</p>
<pre><code class="hljs language-plain" lang="plain">Transform the provided photograph of [subject] into the artistic style of [artist/art style]. Preserve the original composition but render it with [description of stylistic elements].
</code></pre>
<p>中文模板为：</p>
<blockquote>
<p>将提供的 <strong>[主体]</strong> 照片转换为 <strong>[艺术家/艺术风格]</strong> 的艺术风格。保留原始构图，但用 <strong>[风格元素描述]</strong> 进行渲染。</p>
</blockquote>
<p>举个例子：</p>
<blockquote>
<p>将所提供的现代城市街道夜景照片转换为文森特·梵高《星月夜》的艺术风格。保留建筑物和汽车的原始构图，但用旋转的厚涂笔触以及深邃的蓝色和明亮的黄色构成的富有戏剧性的色彩来呈现所有元素。</p>
</blockquote>
<p>效果如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/01ea8bd5074c44428ccebd52ac46d252~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765199164&amp;x-signature=o%2BwfYEzKuzLmXffuD08%2BCWuvZws%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-12">3.4. 高级合成</h3>
<p>英文模板为：</p>
<pre><code class="hljs language-plain" lang="plain">Create a new image by combining the elements from the provided images. Take
the [element from image 1] and place it with/on the [element from image 2].
The final image should be a [description of the final scene].
</code></pre>
<p>中文模板为：</p>
<blockquote>
<p>通过组合所提供图像中的元素来创建一幅新图像。提取 <strong>[图像 1 中的元素]</strong> ，并将其与 <strong>[图像 2 中的元素]</strong> 放在一起/置于 <strong>[图像 2 中的元素]</strong> 之上。最终图像应该是 <strong>[对最终场景的描述]</strong> 。</p>
</blockquote>
<p>举个例子：</p>
<blockquote>
<p>创作一张专业的电商时尚照片。将第一张图片中的蓝色碎花连衣裙取出，让第二张图片中的女士穿上它。生成一张该女士穿着这条连衣裙的逼真全身照，并调整光影以匹配户外环境。</p>
</blockquote>
<p>效果如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d005d97548b740a6a310539e87cf733a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765199164&amp;x-signature=B6t5yNurupOk6dDTphD3AgK206M%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-13">3.5. 高保真细节保留</h3>
<p>英文模板为：</p>
<pre><code class="hljs language-plain" lang="plain">Using the provided images, place [element from image 2] onto [element from
image 1]. Ensure that the features of [element from image 1] remain
completely unchanged. The added element should [description of how the
element should integrate].
</code></pre>
<p>中文模板为：</p>
<blockquote>
<p>使用提供的图像，将 <strong>[图像 2 中的元素]</strong> 放置到 <strong>[图像 1 中的元素]</strong> 上。确保 <strong>[图像 1 中的元素]</strong> 的特征完全不变。添加的元素应 <strong>[描述该元素应如何整合]</strong> 。</p>
</blockquote>
<p>举个例子：</p>
<blockquote>
<p>选取第一张图片中那位有着棕色头发、蓝色眼睛且表情平和的女性。将第二张图片中的标志添加到她的黑色 T 恤上。确保这位女性的脸部及五官完全保持不变。该标志应看起来像是自然印在面料上的，要顺着衬衫的褶皱呈现。</p>
</blockquote>
<p>效果如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c543894e525844d8b8949e3bb5a280b9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765199164&amp;x-signature=Hpdu%2BWDJBF%2Frd0f6Ky8V9iLJInM%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-14">3.6. 草图变成品</h3>
<p>英文模板为：</p>
<pre><code class="hljs language-plain" lang="plain">Turn this rough [medium] sketch of a [subject] into a [style description]
photo. Keep the [specific features] from the sketch but add [new details/materials].
</code></pre>
<p>中文模板为：</p>
<blockquote>
<p>将这幅关于 <strong>[主题]</strong> 的粗略 <strong>[媒介]</strong> 草图转化为一张符合 <strong>[风格描述]</strong> 的照片。保留草图中的 <strong>[具体特征]</strong> ，但添加 <strong>[新细节/材料]</strong> 。</p>
</blockquote>
<p>举个例子：</p>
<blockquote>
<p>把这幅未来汽车的铅笔草图变成展厅里成品概念车的精致照片。保留草图中的流畅线条和低矮轮廓，但要添加金属蓝色漆面和霓虹轮圈灯光。</p>
</blockquote>
<p>效果如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2c60237736224595bea248cc2b87d78c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765199164&amp;x-signature=LQpuOY5037Sl%2BreVozycwEc5hbg%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-15">3.7. 360 度全景</h3>
<p>英文模板为：</p>
<pre><code class="hljs language-plain" lang="plain">A studio portrait of [person] against [background], [looking forward/in profile looking right/etc.]
</code></pre>
<p>中文模板为：</p>
<blockquote>
<p>一幅 <strong>[人物]</strong> 的工作室肖像照，背景为 <strong>[背景]</strong> ， <strong>[人物]</strong> 面向前方/侧头向右看等。</p>
</blockquote>
<p>举个例子：</p>
<blockquote>
<p>一张这位男士的工作室肖像照，背景为白色，他侧身向右看。</p>
</blockquote>
<p>效果如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ed36804f455143da919e74ade83c878f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765199164&amp;x-signature=6%2FJ70bpj90UELZbXrfbrs42UNcQ%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-16">4. 提示词最佳实践</h2>
<ul>
<li>**细节越多越好：**提供的信息越多，对输出结果的操控程度就越详细
<ul>
<li>❌ “奇幻的盔甲”</li>
<li>✅ “华丽的精灵板甲，刻着银叶图案，高领设计，带有猎鹰翅膀形状的肩甲”</li>
</ul>
</li>
<li>**提供上下文和意图说明：**模型对上下文的理解会影响最终输出
<ul>
<li>❌ “设计解决方案”</li>
<li>✅ “为极简护肤品牌设计解决方案”</li>
</ul>
</li>
<li><strong>不断迭代和优化</strong>：不要指望第一次尝试就能生成完美的图片，利用模型的对话特性进行小幅更改。
<ul>
<li>✅ “这很棒，但你能让光线更亮一些吗？”</li>
<li>✅ “保持所有内容不变，但让角色的表情更简洁一些。”</li>
</ul>
</li>
<li><strong>使用分步指令</strong>：对于包含多个元素的复杂场景，可以将提示拆分为多个步骤
<ul>
<li>✅ “首先，创造一个宁静、薄雾弥漫的黎明森林的背景。然后，在前景中添加一个长满苔藓的古老石祭坛。最后，将一把发光的剑祭坛放在顶部。”</li>
</ul>
</li>
<li><strong>语义化反向提示</strong>：
<ul>
<li>不要说“没有汽车”</li>
<li>而是通过“一条空无一人、没有任何交通迹象的街道”来正面描述所需的场景</li>
</ul>
</li>
<li><strong>控制镜头语言</strong>：使用摄影和电影语言来控制构图。例如<strong>广角、微距、低机位</strong>等术语</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【Agent】MemOS 源码笔记---(2)---TreeTextMemory]]></title>    <link>https://juejin.cn/post/7578734725301944372</link>    <guid>https://juejin.cn/post/7578734725301944372</guid>    <pubDate>2025-12-01T13:20:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578734725301944372" data-draft-id="7577647745110376448" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【Agent】MemOS 源码笔记---(2)---TreeTextMemory"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-12-01T13:20:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="罗西的思考"/> <meta itemprop="url" content="https://juejin.cn/user/351470467691175"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【Agent】MemOS 源码笔记---(2)---TreeTextMemory
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/351470467691175/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    罗西的思考
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-01T13:20:28.000Z" title="Mon Dec 01 2025 13:20:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-01
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读29分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">【Agent】MemOS 源码笔记---(2)---TreeTextMemory</h2>
<ul>
<li>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">0x00 摘要</a></p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">0x01 基本概念</a></p>
<ul>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">1.1 特色</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">1.2 定义</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">1.3 记忆结构</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">1.4 元数据字段</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">1.5 API总结</a></li>
</ul>
</li>
<li>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">0x02 示例</a></p>
<ul>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">2.1 创建 TreeTextMemory 配置</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">2.2 初始化 TreeTextMemory</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">2.3 抽取结构化记忆</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">2.4 搜索记忆</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">2.5 从互联网检索记忆（可选）</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">2.6 替换工作记忆</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">2.7 备份与恢复</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">2.8 完整代码</a></li>
</ul>
</li>
<li>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">0x03 管理（MemoryManager）</a></p>
<ul>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">3.1 定义</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">3.2 主要功能</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">3.3 GraphStructureReorganizer</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">3.4 RelationAndReasoningDetector</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">3.5 NodeHandler</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">3.6 NodeHandler vs RelationAndReasoningDetector</a></li>
</ul>
</li>
<li>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">0x04 图例</a></p>
<ul>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">4.1 组件关系图</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">4.2 调用流程图</a></li>
</ul>
</li>
<li>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">0xFF 参考</a></p>
</li>
</ul>
<h3 data-id="heading-1">0x00 摘要</h3>
<p>TreeTextMemory 提供了一个完整的记忆管理系统，能存储、组织、检索和维护各种类型的文本记忆、适用需要复杂记忆管理的AI系统。这是一个基于图的、树形明文记忆，支持以结构化方式组织、关联并检索记忆，同时保留丰富的上下文信息与良好的可解释性。我们可以通过这个TreeTextMemory 对象与庞大的知识库进行交互，为AI赋予专业的领域记忆。当前使用Neo4j作为后端，未来计划支持更多图数据库。</p>
<p>因为字数太多，因此把TreeTextMemory拆分为两部分，本篇介绍基本概念和如何管理，下一篇介绍如何搜索。</p>
<h3 data-id="heading-2">0x01 基本概念</h3>
<h4 data-id="heading-3">1.1 特色</h4>
<p>TreeTextMemory 的特色如下：</p>
<ul>
<li>结构层次: 从原始文本或对话中提取结构化记忆，即像思维导图一样组织记忆——在图数据库中存储他们作为节点。</li>
<li>图风格的链接: 将记忆链接成层次结构和语义图，节点可以有父母、孩子和交叉链接，实现超越纯粹的层次结构-建立多跳推理链。</li>
<li>语义搜索+图扩展: 使用向量相似度+图遍历进行搜索，结合向量和图形的优点。</li>
<li>可解释性: 追踪记忆是如何连接、合并或随时间演变的。</li>
</ul>
<p>TreeTextMemory 适合如下场景：</p>
<ul>
<li>你需要带有可解释关系的层级基于图的明文记忆。</li>
<li>你想存储结构化知识并追踪连接关系。</li>
<li>适用于知识图谱、概念树和多跳推理。</li>
</ul>
<h4 data-id="heading-4">1.2 定义</h4>
<p>TreeTextMemory 的略图如下：</p>
<pre><code class="hljs">TreeTextMemory
    - uses MemoryManager
    - uses Neo4jGraphDB
    - uses Embedder
    - uses LLM
    - uses Searcher
      - uses GraphMemoryRetriever
      - uses TaskGoalParser
      - uses MemoryReasoner
      - uses Reranker
</code></pre>
<p>其中关键组件为：</p>
<ul>
<li>
<p>LLM：</p>
<ul>
<li>extractor_llm：用于提取记忆特征</li>
<li>dispatcher_llm：用于任务分发和处理</li>
</ul>
</li>
<li>
<p>Embedding模型：</p>
<ul>
<li>embedder：生成文本向量表示</li>
</ul>
</li>
<li>
<p>图数据库：</p>
<ul>
<li>graph_store：存储记忆节点和关系，图链接有助于检索纯向量搜索可能遗漏的上下文。</li>
</ul>
</li>
<li>
<p>Reranker：</p>
<ul>
<li>reranker：对检索结果进行重新排序</li>
</ul>
</li>
<li>
<p>互联网检索器：</p>
<ul>
<li>internet_retriever：从互联网获取相关信息。</li>
</ul>
</li>
<li>
<p>memory_manager：</p>
<ul>
<li>负责协调和管理记忆的整个生命周期，包括添加、存储、维护和清理，是记忆系统的核心管理组件。</li>
</ul>
</li>
</ul>
<p>具体代码如下。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">TreeTextMemory</span>(<span class="hljs-title class_ inherited__">BaseTextMemory</span>):
    <span class="hljs-string">"""General textual memory implementation for storing and retrieving memories."""</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, config: TreeTextMemoryConfig</span>):
        <span class="hljs-string">"""Initialize memory with the given configuration."""</span>
        time_start = time.time()
        self.config: TreeTextMemoryConfig = config
        self.extractor_llm: OpenAILLM | OllamaLLM | AzureLLM = LLMFactory.from_config(
            config.extractor_llm
        )

        time_start_ex = time.time()
        self.dispatcher_llm: OpenAILLM | OllamaLLM | AzureLLM = LLMFactory.from_config(
            config.dispatcher_llm
        )

        time_start_em = time.time()
        self.embedder: OllamaEmbedder = EmbedderFactory.from_config(config.embedder)

        time_start_gs = time.time()
        self.graph_store: Neo4jGraphDB = GraphStoreFactory.from_config(config.graph_db)

        time_start_rr = time.time()
        <span class="hljs-keyword">if</span> config.reranker <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
            default_cfg = RerankerConfigFactory.model_validate(
                {
                    <span class="hljs-string">"backend"</span>: <span class="hljs-string">"cosine_local"</span>,
                    <span class="hljs-string">"config"</span>: {
                        <span class="hljs-string">"level_weights"</span>: {<span class="hljs-string">"topic"</span>: <span class="hljs-number">1.0</span>, <span class="hljs-string">"concept"</span>: <span class="hljs-number">1.0</span>, <span class="hljs-string">"fact"</span>: <span class="hljs-number">1.0</span>},
                        <span class="hljs-string">"level_field"</span>: <span class="hljs-string">"background"</span>,
                    },
                }
            )
            self.reranker = RerankerFactory.from_config(default_cfg)
        <span class="hljs-keyword">else</span>:
            self.reranker = RerankerFactory.from_config(config.reranker)
        self.is_reorganize = config.reorganize

        time_start_mm = time.time()
        self.memory_manager: MemoryManager = MemoryManager(
            self.graph_store,
            self.embedder,
            self.extractor_llm,
            memory_size=config.memory_size
            <span class="hljs-keyword">or</span> {
                <span class="hljs-string">"WorkingMemory"</span>: <span class="hljs-number">20</span>,
                <span class="hljs-string">"LongTermMemory"</span>: <span class="hljs-number">1500</span>,
                <span class="hljs-string">"UserMemory"</span>: <span class="hljs-number">480</span>,
            },
            is_reorganize=self.is_reorganize,
        )
        time_start_ir = time.time()
        <span class="hljs-comment"># Create internet retriever if configured</span>
        self.internet_retriever = <span class="hljs-literal">None</span>
        <span class="hljs-keyword">if</span> config.internet_retriever <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:
            self.internet_retriever = InternetRetrieverFactory.from_config(
                config.internet_retriever, self.embedder
            )
</code></pre>
<h4 data-id="heading-5">1.3 记忆结构</h4>
<p>每个节点在<code>TreeTextMemory</code> 是一个 <code>TextualMemoryItem</code>:</p>
<ul>
<li><code>id</code>: 唯一记忆ID（如果省略则自动生成）</li>
<li><code>memory</code>: 主要文本</li>
<li><code>metadata</code>: 包括层次结构信息、嵌入、标签、实体、源和状态</li>
</ul>
<h4 data-id="heading-6">1.4 元数据字段</h4>
<p><code>TreeNodeTextualMemoryMetadata</code> 是元数据。需要使用有意义的标签和背景——它们有助于组织你的图进行多跳推理。</p>











































































<table><thead><tr><th>字段</th><th>类型</th><th>描述</th></tr></thead><tbody><tr><td><code>memory_type</code></td><td><code>"WorkingMemory"</code>, <code>"LongTermMemory"</code>, <code>"UserMemory"</code></td><td>生命周期分类</td></tr><tr><td><code>status</code></td><td><code>"activated"</code>, <code>"archived"</code>, <code>"deleted"</code></td><td>节点状态</td></tr><tr><td><code>visibility</code></td><td><code>"private"</code>, <code>"public"</code>, <code>"session"</code></td><td>访问范围</td></tr><tr><td><code>sources</code></td><td><code>list[str]</code></td><td>来源列表 (例如: 文件, URLs)</td></tr><tr><td><code>source</code></td><td><code>"conversation"</code>, <code>"retrieved"</code>, <code>"web"</code>, <code>"file"</code></td><td>原始来源类型</td></tr><tr><td><code>confidence</code></td><td><code>float (0-100)</code></td><td>确定性得分</td></tr><tr><td><code>entities</code></td><td><code>list[str]</code></td><td>提及的实体或概念</td></tr><tr><td><code>tags</code></td><td><code>list[str]</code></td><td>主题标签</td></tr><tr><td><code>embedding</code></td><td><code>list[float]</code></td><td>基于向量嵌入的相似性搜索</td></tr><tr><td><code>created_at</code></td><td><code>str</code></td><td>创建时间戳(ISO 8601)</td></tr><tr><td><code>updated_at</code></td><td><code>str</code></td><td>最近更新时间戳(ISO 8601)</td></tr><tr><td><code>usage</code></td><td><code>list[str]</code></td><td>使用历史</td></tr><tr><td><code>background</code></td><td><code>str</code></td><td>附加上下文</td></tr></tbody></table>
<h4 data-id="heading-7">1.5 API总结</h4>
<p><code>TreeTextMemory</code>的API如下。</p>
<p>初始化为：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">TreeTextMemory</span>(config: TreeTextMemoryConfig)
</code></pre>
<p>核心方法为：</p>





























































<table><thead><tr><th>方法</th><th>描述</th></tr></thead><tbody><tr><td><code>add(memories)</code></td><td>添加一个或多个记忆（项目或字典）</td></tr><tr><td><code>replace_working_memory()</code></td><td>更换所有的WorkingMemory节点</td></tr><tr><td><code>get_working_memory()</code></td><td>得到所有的WorkingMemory节点</td></tr><tr><td><code>search(query, top_k)</code></td><td>使用向量+图搜索检索top-k个记忆</td></tr><tr><td><code>get(memory_id)</code></td><td>通过ID获取单个记忆</td></tr><tr><td><code>get_by_ids(ids)</code></td><td>通过IDs获取多个记忆</td></tr><tr><td><code>get_all()</code></td><td>将整个记忆图导出为字典</td></tr><tr><td><code>update(memory_id, new)</code></td><td>通过ID更新记忆</td></tr><tr><td><code>delete(ids)</code></td><td>通过IDs删除记忆</td></tr><tr><td><code>delete_all()</code></td><td>删除所有的记忆和关系</td></tr><tr><td><code>dump(dir)</code></td><td>在目录中将图序列化为JSON</td></tr><tr><td><code>load(dir)</code></td><td>从保存的JSON文件加载图</td></tr><tr><td><code>drop(keep_last_n)</code></td><td>备份图和删除数据库，保留N个备份</td></tr></tbody></table>
<p>当调用 <code>dump(dir)</code>, 系统写到:</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dir</span>&gt;</span>/<span class="hljs-tag">&lt;<span class="hljs-name">config.memory_filename</span>&gt;</span>
</code></pre>
<p>这个文件包含一个JSON结构，有 <code>nodes</code> and <code>edges</code>. 它可以使用 <code>load(dir)</code>重新加载.</p>
<h3 data-id="heading-8">0x02 示例</h3>
<p>下面是如何是如何使用 TreeTextMemory 的示例，当运行此示例时，工作流如下:</p>
<ol>
<li>抽取: 使用LLM从原始文本中提取结构化记忆</li>
<li>嵌入: 为相似性搜索生成向量嵌入</li>
<li>存储和链接: 将具有关系的节点添加到图数据库（Neo4j）中</li>
<li>搜索: 通过向量相似度查询，然后通过图跳数展开结果</li>
</ol>
<h4 data-id="heading-9">2.1 创建 TreeTextMemory 配置</h4>
<p>TreeTextMemoryConfig 的定义为:</p>
<ul>
<li>你的嵌入（创建向量）,</li>
<li>你的图数据库后端(Neo4j),</li>
<li>记忆抽取器（基于LLM）（可选）.</li>
</ul>

<pre><code class="hljs language-arduino" lang="arduino">from memos.configs.memory <span class="hljs-keyword">import</span> TreeTextMemoryConfig

config = TreeTextMemoryConfig.<span class="hljs-built_in">from_json_file</span>(<span class="hljs-string">"examples/data/config/tree_config.json"</span>)
</code></pre>
<h4 data-id="heading-10">2.2 初始化 TreeTextMemory</h4>
<pre><code class="hljs language-arduino" lang="arduino">from memos.memories.textual.tree <span class="hljs-keyword">import</span> TreeTextMemory

tree_memory = <span class="hljs-built_in">TreeTextMemory</span>(config)
</code></pre>
<h4 data-id="heading-11">2.3 抽取结构化记忆</h4>
<p>使用记忆抽取器将对话、文件或文档解析为多个<code>TextualMemoryItem</code>.</p>
<pre><code class="hljs language-ini" lang="ini">from memos.mem_reader.simple_struct import SimpleStructMemReader

<span class="hljs-attr">reader</span> = SimpleStructMemReader.from_json_file(<span class="hljs-string">"examples/data/config/simple_struct_reader_config.json"</span>)

<span class="hljs-attr">scene_data</span> = [[
    {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"Tell me about your childhood."</span>},
    {<span class="hljs-string">"role"</span>: <span class="hljs-string">"assistant"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"I loved playing in the garden with my dog."</span>}
]]

<span class="hljs-attr">memories</span> = reader.get_memory(scene_data, type=<span class="hljs-string">"chat"</span>, info={<span class="hljs-string">"user_id"</span>: <span class="hljs-string">"1234"</span>})
for m_list in memories:
    tree_memory.add(m_list)
</code></pre>
<h4 data-id="heading-12">2.4 搜索记忆</h4>
<p>尝试向量搜索+图搜索:</p>
<pre><code class="hljs language-python" lang="python">results = tree_memory.search(<span class="hljs-string">"Talk about the garden"</span>, top_k=<span class="hljs-number">5</span>)
<span class="hljs-keyword">for</span> i, node <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(results):
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{i}</span>: <span class="hljs-subst">{node.memory}</span>"</span>)
</code></pre>
<h4 data-id="heading-13">2.5 从互联网检索记忆（可选）</h4>
<p>你也可以从 Google / Bing / Bocha（博查） 等搜索引擎实时获取网页内容，并自动切分为记忆节点。MemOS 提供了统一接口。</p>
<p>以下示例演示如何检索“Alibaba 2024 ESG report”相关网页，并自动提取为结构化记忆。</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-comment"># 创建embedder</span>
embedder = EmbedderFactory.from_config(
    EmbedderConfigFactory.model_validate({
        <span class="hljs-string">"backend"</span>: <span class="hljs-string">"ollama"</span>,
        <span class="hljs-string">"config"</span>: {<span class="hljs-string">"model_name_or_path"</span>: <span class="hljs-string">"nomic-embed-text:latest"</span>},
    })
)

<span class="hljs-comment"># 配置检索器（以 BochaAI 为例）</span>
retriever_config = InternetRetrieverConfigFactory.model_validate({
    <span class="hljs-string">"backend"</span>: <span class="hljs-string">"bocha"</span>,
    <span class="hljs-string">"config"</span>: {
        <span class="hljs-string">"api_key"</span>: <span class="hljs-string">"sk-xxx"</span>,  <span class="hljs-comment"># 替换为你的 BochaAI API Key</span>
        <span class="hljs-string">"max_results"</span>: 5,
        <span class="hljs-string">"reader"</span>: {  <span class="hljs-comment"># 自动分块的 Reader 配置</span>
            <span class="hljs-string">"backend"</span>: <span class="hljs-string">"simple_struct"</span>,
            <span class="hljs-string">"config"</span>: ...,  <span class="hljs-comment"># 你的mem-reader config</span>
        },
    }
})

<span class="hljs-comment"># 实例化检索器</span>
retriever = InternetRetrieverFactory.from_config(retriever_config, embedder)

<span class="hljs-comment"># 执行网页检索</span>
results = retriever.retrieve_from_internet(<span class="hljs-string">"Alibaba 2024 ESG report"</span>)

<span class="hljs-comment"># 添加到记忆图中</span>
for m in results:
    tree_memory.add(m)
</code></pre>
<p>你也可以直接在 TreeTextMemoryConfig 中配置 internet_retriever 字段，例如：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"internet_retriever"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"backend"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"bocha"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"config"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"api_key"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"sk-xxx"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"max_results"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">5</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"reader"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"backend"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"simple_struct"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"config"</span><span class="hljs-punctuation">:</span> ...
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>这样，在调用 tree_memory.search(query) 时，系统会自动调用互联网检索（如 BochaAI / Google / Bing）然后将结果与本地图中的节点一起排序返回，无需手动调用 retriever.retrieve_from_internet</p>
<h4 data-id="heading-14">2.6 替换工作记忆</h4>
<p>用一个新的节点替换你当前的 <code>WorkingMemory</code>:</p>
<pre><code class="hljs language-css" lang="css">tree_memory<span class="hljs-selector-class">.replace_working_memory</span>(
    <span class="hljs-selector-attr">[{        <span class="hljs-string">"memory"</span>: <span class="hljs-string">"User is discussing gardening tips."</span>,        <span class="hljs-string">"metadata"</span>: {<span class="hljs-string">"memory_type"</span>: <span class="hljs-string">"WorkingMemory"</span>}    }]</span>
)
</code></pre>
<h4 data-id="heading-15">2.7 备份与恢复</h4>
<p>支持树结构的持久化存储与随时重载:</p>
<pre><code class="hljs language-lua" lang="lua">tree_memory.<span class="hljs-built_in">dump</span>(<span class="hljs-string">"tmp/tree_memories"</span>)
tree_memory.<span class="hljs-built_in">load</span>(<span class="hljs-string">"tmp/tree_memories"</span>)
</code></pre>
<h4 data-id="heading-16">2.8 完整代码</h4>
<p>该示例整合了上述所有步骤，提供一个端到端的完整流程。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> memos.configs.embedder <span class="hljs-keyword">import</span> EmbedderConfigFactory
<span class="hljs-keyword">from</span> memos.configs.memory <span class="hljs-keyword">import</span> TreeTextMemoryConfig
<span class="hljs-keyword">from</span> memos.configs.mem_reader <span class="hljs-keyword">import</span> SimpleStructMemReaderConfig
<span class="hljs-keyword">from</span> memos.embedders.factory <span class="hljs-keyword">import</span> EmbedderFactory
<span class="hljs-keyword">from</span> memos.mem_reader.simple_struct <span class="hljs-keyword">import</span> SimpleStructMemReader
<span class="hljs-keyword">from</span> memos.memories.textual.tree <span class="hljs-keyword">import</span> TreeTextMemory

<span class="hljs-comment"># 嵌入设置</span>
embedder_config = EmbedderConfigFactory.model_validate({
    <span class="hljs-string">"backend"</span>: <span class="hljs-string">"ollama"</span>,
    <span class="hljs-string">"config"</span>: {<span class="hljs-string">"model_name_or_path"</span>: <span class="hljs-string">"nomic-embed-text:latest"</span>}
})
embedder = EmbedderFactory.from_config(embedder_config)

<span class="hljs-comment"># 创建TreeTextMemory</span>
tree_config = TreeTextMemoryConfig.from_json_file(<span class="hljs-string">"examples/data/config/tree_config.json"</span>)
my_tree_textual_memory = TreeTextMemory(tree_config)
my_tree_textual_memory.delete_all()

<span class="hljs-comment"># 阅读器设置</span>
reader_config = SimpleStructMemReaderConfig.from_json_file(
    <span class="hljs-string">"examples/data/config/simple_struct_reader_config.json"</span>
)
reader = SimpleStructMemReader(reader_config)

<span class="hljs-comment"># 从对话中抽取</span>
scene_data = [[
    {
        <span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>,
        <span class="hljs-string">"content"</span>: <span class="hljs-string">"Tell me about your childhood."</span>
    },
    {
        <span class="hljs-string">"role"</span>: <span class="hljs-string">"assistant"</span>,
        <span class="hljs-string">"content"</span>: <span class="hljs-string">"I loved playing in the garden with my dog."</span>
    },
]]
memory = reader.get_memory(scene_data, <span class="hljs-built_in">type</span>=<span class="hljs-string">"chat"</span>, info={<span class="hljs-string">"user_id"</span>: <span class="hljs-string">"1234"</span>, <span class="hljs-string">"session_id"</span>: <span class="hljs-string">"2222"</span>})
<span class="hljs-keyword">for</span> m_list <span class="hljs-keyword">in</span> memory:
    my_tree_textual_memory.add(m_list)

<span class="hljs-comment"># 搜索</span>
results = my_tree_textual_memory.search(
    <span class="hljs-string">"Talk about the user's childhood story?"</span>,
    top_k=<span class="hljs-number">10</span>
)
<span class="hljs-keyword">for</span> i, r <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(results):
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{i}</span>'th result: <span class="hljs-subst">{r.memory}</span>"</span>)

<span class="hljs-comment"># 从文档添加[可选项]</span>
doc_paths = [<span class="hljs-string">"./text1.txt"</span>, <span class="hljs-string">"./text2.txt"</span>]
doc_memory = reader.get_memory(
  doc_paths, <span class="hljs-string">"doc"</span>, info={
      <span class="hljs-string">"user_id"</span>: <span class="hljs-string">"your_user_id"</span>,
      <span class="hljs-string">"session_id"</span>: <span class="hljs-string">"your_session_id"</span>,
  }
)
<span class="hljs-keyword">for</span> m_list <span class="hljs-keyword">in</span> doc_memory:
    my_tree_textual_memory.add(m_list)

<span class="hljs-comment"># 转储和丢弃[可选项]</span>
my_tree_textual_memory.dump(<span class="hljs-string">"tmp/my_tree_textual_memory"</span>)
my_tree_textual_memory.drop()
</code></pre>
<h3 data-id="heading-17">0x03 管理（MemoryManager）</h3>
<p>MemoryManager 是 TreeTextMemory 类的一个核心组件，主要负责管理不同类型的记忆（如工作记忆、长期记忆和用户记忆）的添加、组织和维护。</p>
<h4 data-id="heading-18">3.1 定义</h4>
<p>MemoryManager 的简要如下：</p>
<pre><code class="hljs">MemoryManager
    - uses GraphStructureReorganizer
      - uses NodeHandler
        - uses Neo4jGraphDB
        - uses LLM
        - uses Embedder
      - uses RelationAndReasoningDetector
        - uses Neo4jGraphDB
        - uses LLM
        - uses Embedder
        - uses Neo4jGraphDB
    - uses Neo4jGraphDB
    - uses Embedder
    - uses LLM
</code></pre>
<p>MemoryManager 代码如下。</p>
<pre><code class="hljs language-ini" lang="ini">class MemoryManager:
    def __init__(
        self,
        graph_store: Neo4jGraphDB,
        embedder: OllamaEmbedder,
        llm: OpenAILLM | OllamaLLM | AzureLLM,
        memory_size: dict | <span class="hljs-attr">None</span> = None,
        threshold: float | <span class="hljs-attr">None</span> = <span class="hljs-number">0.80</span>,
        merged_threshold: float | <span class="hljs-attr">None</span> = <span class="hljs-number">0.92</span>,
        is_reorganize: <span class="hljs-attr">bool</span> = <span class="hljs-literal">False</span>,
    ):
        <span class="hljs-attr">self.graph_store</span> = graph_store
        <span class="hljs-attr">self.embedder</span> = embedder
        <span class="hljs-attr">self.memory_size</span> = memory_size
        <span class="hljs-attr">self.current_memory_size</span> = {
            "WorkingMemory": 0,
            "LongTermMemory": 0,
            "UserMemory": 0,
        }
        if not memory_size:
            <span class="hljs-attr">self.memory_size</span> = {
                "WorkingMemory": 20,
                "LongTermMemory": 1500,
                "UserMemory": 480,
            }
        <span class="hljs-attr">self._threshold</span> = threshold
        <span class="hljs-attr">self.is_reorganize</span> = is_reorganize
        <span class="hljs-attr">self.reorganizer</span> = GraphStructureReorganizer(
            graph_store, llm, embedder, <span class="hljs-attr">is_reorganize</span>=is_reorganize
        )
        <span class="hljs-attr">self._merged_threshold</span> = merged_threshold
</code></pre>
<h4 data-id="heading-19">3.2 主要功能</h4>
<p>以下是其主要功能：</p>
<ul>
<li>
<p>记忆管理与组织：</p>
<ul>
<li>
<p>添加记忆：通过 add() 方法并行处理不同类型的记忆添加。通过 MemoryManager 组件管理不同类型的记忆：</p>
<ul>
<li>工作记忆（WorkingMemory）</li>
<li>长期记忆（LongTermMemory）</li>
<li>用户记忆（UserMemory）</li>
<li>每种记忆类型都有预设的容量限制，并支持动态调整。</li>
</ul>
</li>
<li>
<p>替换工作记忆：通过 replace_working_memory() 方法更新工作记忆内容</p>
</li>
<li>
<p>内存大小管理：通过 get_current_memory_size() 获取和刷新各类记忆的当前数量</p>
</li>
</ul>
</li>
<li>
<p>记忆存储处理</p>
<ul>
<li>工作记忆管理：所有记忆都会被添加到工作记忆中，通过 _add_memory_to_db() 方法处理</li>
<li>长期记忆和用户记忆管理：通过 _add_to_graph_memory() 方法处理特定类型的记忆存储</li>
<li>FIFO 机制：自动维护各类记忆的最大容量，删除过期的记忆项</li>
</ul>
</li>
<li>
<p>图结构维护</p>
<ul>
<li>结构路径管理：通过 _ensure_structure_path() 确保记忆的结构化存储路径</li>
<li>边继承：通过 _inherit_edges() 方法在节点合并时迁移连接关系</li>
</ul>
</li>
<li>
<p>与图数据库交互</p>
<ul>
<li>依赖图数据库：通过 graph_store（如 Neo4j）进行实际的记忆存储和检索操作</li>
<li>定期清理：根据配置的容量限制自动清理过期的记忆项</li>
</ul>
</li>
<li>
<p>与Reorganizer 集成</p>
<ul>
<li>记忆重组织：与 GraphStructureReorganizer 集成，在添加记忆时触发图结构的重新组织</li>
<li>异步处理：通过消息队列机制异步处理记忆的重新组织任务</li>
</ul>
</li>
</ul>
<p>总的来说，MemoryManager 负责协调和管理记忆的整个生命周期，包括添加、存储、维护和清理，是记忆系统的核心管理组件。</p>
<h4 data-id="heading-20">3.3 GraphStructureReorganizer</h4>
<p>GraphStructureReorganizer 是负责维护和优化 Memos 系统中记忆图结构的组件，本质上充当了一个记忆维护系统，随着新记忆的不断添加，它能够保持基于图的记忆结构有序、高效且在语义上连贯。</p>
<h5 data-id="heading-21">3.3.1 主要功能</h5>
<p>以下是其主要功能：</p>
<ul>
<li>
<p>消息队列管理</p>
<ul>
<li>
<p>异步处理：使用优先级队列（PriorityQueue）来管理图结构操作，如添加、删除、合并和更新节点/边</p>
<ul>
<li>在单独的线程中运行，避免阻塞主记忆操作</li>
<li>使用线程池并行处理聚类和关系检测任务</li>
<li>提供等待正在进行的重组任务完成的方法</li>
</ul>
</li>
<li>
<p>优先级处理：不同操作有不同的优先级（add/remove &gt; merge &gt; end），确保关键操作优先处理</p>
</li>
<li>
<p>线程安全操作：运行一个专用线程（_run_message_consumer_loop）来处理排队的消息</p>
</li>
</ul>
</li>
<li>
<p>图结构（记忆结构）优化</p>
<ul>
<li>周期性优化：运行一个独立线程（<code>_run_structure_organizer_loop</code>），定期触发对 LongTermMemory 和 UserMemory 的结构优化，以保持效率和一致性</li>
<li>自动触发：当有新节点添加时可以自动触发优化（_reorganize_needed 标志）</li>
</ul>
</li>
<li>
<p>记忆节点关系管理（冲突解决和记忆融合）</p>
<ul>
<li>冲突检测：检测新添加节点与现有节点之间的关系，即与 RelationAndReasoningDetector 集成，识别记忆之间的关系（因果、条件、冲突等）</li>
<li>冲突解决：与 NodeHandler 协作，通过基于大语言模型的融合来解决相似记忆之间的冲突和冗余</li>
<li>记忆合并：处理重复或相似记忆的合并，归档或删除过时/不那么重要的记忆，以保持图的效率</li>
</ul>
</li>
<li>
<p>结构增强</p>
<ul>
<li>局部聚类：使用诸如 LOCAL_SUBCLUSTER_PROMPT 和 REORGANIZE_PROMPT 等提示词来识别和组织相关记忆到集群中</li>
<li>层次化组织：创建摘要节点并在记忆之间建立层次关系（在摘要节点与其组成节点之间建立父子关系（PARENT 边）），以创建多层次的组织结构（维护类似树的结构），以提高记忆检索效率</li>
<li>边管理：在重组过程中维护节点间的连接关系</li>
</ul>
</li>
</ul>
<h5 data-id="heading-22">3.3.2 与其他组件集成</h5>
<ul>
<li>图数据库接口：GraphStructureReorganizer直接与 Neo4jGraphDB 交互执行图操作</li>
<li>大语言模型集成：GraphStructureReorganizer使用语言模型来理解关系并生成摘要</li>
<li>嵌入支持：GraphStructureReorganizer利用 OllamaEmbedder 进行语义相似度计算</li>
</ul>
<p>总的来说，GraphStructureReorganizer 通过持续优化结构、解决冲突和在记忆节点间建立有意义的关系来维护记忆图的质量和组织性。</p>
<h5 data-id="heading-23">3.3.3 如何调用</h5>
<p>我们接下来看看 GraphStructureReorganizer 如何调用。</p>
<ul>
<li>初始化时候启动周期性优化任务</li>
</ul>
<p>当TreeTextMemory初始化时，如果配置了重组织功能（is_reorganize=True），会启动一个周期性的结构优化线程。</p>
<pre><code class="hljs language-ini" lang="ini">class GraphStructureReorganizer:
    def __init__(
        self, graph_store: Neo4jGraphDB, llm: BaseLLM, embedder: OllamaEmbedder, is_reorganize: bool
    ):
        <span class="hljs-attr">self.queue</span> = PriorityQueue()  <span class="hljs-comment"># Min-heap</span>
        <span class="hljs-attr">self.graph_store</span> = graph_store
        <span class="hljs-attr">self.llm</span> = llm
        <span class="hljs-attr">self.embedder</span> = embedder
        <span class="hljs-attr">self.relation_detector</span> = RelationAndReasoningDetector(
            self.graph_store, self.llm, self.embedder
        )
        <span class="hljs-attr">self.resolver</span> = NodeHandler(graph_store=graph_store, llm=llm, embedder=embedder)

        <span class="hljs-attr">self.is_reorganize</span> = is_reorganize
        <span class="hljs-attr">self._reorganize_needed</span> = <span class="hljs-literal">True</span>
        if self.is_reorganize:
            <span class="hljs-comment"># ____ 1. For queue message driven thread ___________</span>
            <span class="hljs-attr">self.thread</span> = threading.Thread(target=self._run_message_consumer_loop)
            self.thread.start()
            <span class="hljs-comment"># ____ 2. For periodic structure optimization _______</span>
            <span class="hljs-attr">self._stop_scheduler</span> = <span class="hljs-literal">False</span>
            <span class="hljs-attr">self._is_optimizing</span> = {<span class="hljs-string">"LongTermMemory"</span>: <span class="hljs-literal">False</span>, <span class="hljs-string">"UserMemory"</span>: <span class="hljs-literal">False</span>}
            <span class="hljs-attr">self.structure_optimizer_thread</span> = threading.Thread(
                <span class="hljs-attr">target</span>=self._run_structure_organizer_loop
            )
            self.structure_optimizer_thread.start()
</code></pre>
<p>每100秒自动触发一次优化。</p>
<pre><code class="hljs language-python" lang="python">    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_run_structure_organizer_loop</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""
        Use schedule library to periodically trigger structure optimization.
        This runs until the stop flag is set.
        """</span>
        <span class="hljs-keyword">import</span> schedule

        schedule.every(<span class="hljs-number">100</span>).seconds.do(self.optimize_structure, scope=<span class="hljs-string">"LongTermMemory"</span>)
        schedule.every(<span class="hljs-number">100</span>).seconds.do(self.optimize_structure, scope=<span class="hljs-string">"UserMemory"</span>)

        <span class="hljs-keyword">while</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">getattr</span>(self, <span class="hljs-string">"_stop_scheduler"</span>, <span class="hljs-literal">False</span>):
            <span class="hljs-keyword">if</span> <span class="hljs-built_in">any</span>(self._is_optimizing.values()):
                time.sleep(<span class="hljs-number">1</span>)
                <span class="hljs-keyword">continue</span>
            <span class="hljs-keyword">if</span> self._reorganize_needed:
                self.optimize_structure(scope=<span class="hljs-string">"LongTermMemory"</span>)
                self.optimize_structure(scope=<span class="hljs-string">"UserMemory"</span>)
                self._reorganize_needed = <span class="hljs-literal">False</span>
            time.sleep(<span class="hljs-number">30</span>)
</code></pre>
<ul>
<li>添加新节点时触发优化</li>
</ul>
<p>当通过MemoryManager 添加新记忆节点时，会向 GraphStructureReorganizer 的消息队列添加一条"add" 消息。</p>
<pre><code class="hljs language-python" lang="python">    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_add_to_graph_memory</span>(<span class="hljs-params">self, memory: TextualMemoryItem, memory_type: <span class="hljs-built_in">str</span></span>):
        <span class="hljs-string">"""
        Generalized method to add memory to a graph-based memory type (e.g., LongTermMemory, UserMemory).

        Parameters:
        - memory: memory item to insert
        - memory_type: "LongTermMemory" | "UserMemory"
        - similarity_threshold: deduplication threshold
        - topic_summary_prefix: summary node id prefix if applicable
        - enable_summary_link: whether to auto-link to a summary node
        """</span>
        node_id = <span class="hljs-built_in">str</span>(uuid.uuid4())
        <span class="hljs-comment"># Step 2: Add new node to graph</span>
        self.graph_store.add_node(
            node_id, memory.memory, memory.metadata.model_dump(exclude_none=<span class="hljs-literal">True</span>)
        )
        self.reorganizer.add_message(
            QueueMessage(
                op=<span class="hljs-string">"add"</span>,
                after_node=[node_id],
            )
        )
        <span class="hljs-keyword">return</span> node_id
</code></pre>
<p>当消息处理器处理”add“操作完成后，会设置_reorganize_needed=True，在下一次检查时触发优化。</p>
<pre><code class="hljs language-ini" lang="ini">    def handle_add(self, message: QueueMessage):
        logger.debug(f"Handling add operation: {str(message)<span class="hljs-section">[:500]</span>}")
        <span class="hljs-attr">added_node</span> = message.after_node[<span class="hljs-number">0</span>]
        <span class="hljs-attr">detected_relationships</span> = self.resolver.detect(
            added_node, <span class="hljs-attr">scope</span>=added_node.metadata.memory_type
        )
        if detected_relationships:
            for added_node, existing_node, relation in detected_relationships:
                self.resolver.resolve(added_node, existing_node, relation)

        <span class="hljs-attr">self._reorganize_needed</span> = <span class="hljs-literal">True</span>
</code></pre>
<p>在 _run_structure_organizer_loop 中检查到该标识时触发优化。</p>
<ul>
<li>也可以直接调用 optimize_structure()方法</li>
</ul>
<p>总结，这种设计确保了记忆图结构能够定期优化，同时在有新内容添加时也可以及时调整结构。</p>
<h5 data-id="heading-24">3.3.4 LLM 的使用</h5>
<p>GraphStructureReorganizer 不仅使用了 LLM，而且在其核心功能中深度依赖 LLM 来实现：</p>
<ul>
<li>节点间语义关系的理解和建立</li>
<li>冲突记忆的检测与融合</li>
<li>新的知识推理和聚合</li>
<li>图结构的智能优化</li>
</ul>
<p>这些功能使记忆图谱不仅是一个简单的数据存储结构，还能自主地维护语义一致性和结构性</p>
<h6 data-id="heading-25">直接依赖</h6>
<p>GraphStructureReorganizer 在初始化时接收一个 LLM 实例作为参数：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-title function_ invoke__">def __init__</span>(
    <span class="hljs-built_in">self</span>,<span class="hljs-attr"> graph_store</span>: Neo4jGraphDB,<span class="hljs-attr"> llm</span>: BaseLLM,<span class="hljs-attr"> embedder</span>: OllamaEmbedder,<span class="hljs-attr"> is_reorganize</span>: <span class="hljs-keyword">bool</span>
):
    <span class="hljs-built_in">self</span>.llm = llm
</code></pre>
<h6 data-id="heading-26">关键组件中的 LLM 使用</h6>
<p>在优化图结构时，LLM 用于：</p>
<ul>
<li>生成聚类摘要（通过 _summarize_cluster 方法）</li>
<li>推断节点间的关系</li>
<li>创建新的推理节点</li>
</ul>
<p>GraphStructureReorganizer 创建了一个 RelationAndReasoningDetector 实例，该检测器大量使用 LLM：</p>
<ul>
<li>关系检测：使用 LLM 判断节点间的因果、条件、冲突等关系</li>
<li>事实推断：基于现有关系推断新的事实节点</li>
<li>聚合概念生成：将相似节点聚合成更高层次的概念节点</li>
</ul>
<p>例如在 _detect_pairwise_causal_condition_relations 方法中：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">prompt</span> = PAIRWISE_RELATION_PROMPT.format(
    <span class="hljs-attr">node1</span>=node.memory,
    <span class="hljs-attr">node2</span>=candidate.memory
)
<span class="hljs-attr">response_text</span> = self._call_llm(prompt)  <span class="hljs-comment"># 调用 LLM 进行判断</span>
</code></pre>
<p>GraphStructureReorganizer 也创建了一个 NodeHandler 实例用于处理节点冲突和冗余，即当添加新节点时，使用 LLM：</p>
<ul>
<li>冲突检测：检测新节点与现有节点的关系。使用 LLM 判断两个记忆是否相互矛盾</li>
<li>冲突解决：解决潜在的冲突或冗余。当发现冲突或冗余时，使用 LLM 融合记忆内容</li>
</ul>

<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">result</span> = self.llm.generate(prompt).strip()  <span class="hljs-comment"># 检测关系</span>
</code></pre>
<h4 data-id="heading-27">3.4 RelationAndReasoningDetector</h4>
<p>RelationAndReasoningDetector 是一个用于检测和推理记忆节点之间关系的组件，它在记忆图结构优化过程中发挥关键作用。它的主要功能包括：</p>
<ul>
<li>节点关系检测。RelationAndReasoningDetector 负责检测记忆节点之间的各种语义关系，通过使用大语言模型（LLM）和嵌入向量来判断节点间的关系类型。</li>
<li>推理新节点生成。基于已检测到的关系推断新的事实节点，创建推理类型的节点以丰富记忆图谱的内容</li>
<li>图结构优化支持。为 GraphStructureReorganizer 提供关系和推理信息，帮助构建更完整的语义网络结构。</li>
</ul>
<h5 data-id="heading-28">3.4.1 主要方法</h5>
<p>process_node 方法。统一处理节点的关系检测和推理流程，调用其他专门方法完成具体任务。</p>
<ul>
<li>关系检测。检测成对节点之间的因果、条件、冲突，相关等关系，使用 _detect_pairwise_causal_condition_relations 方法实现。</li>
<li>推理节点生成。基于因果/条件关系推断新的事实节点，调用 _infer_fact_nodes_from_relations 方法生成聚合概念节点（将相似节点聚合成更高层次的概念）</li>
<li>时序关联检测。检测节点间的时间顺序关系，通过 _detect_sequence_links 方法实现。</li>
<li>聚合节点检测。识别可以被聚合的概念组，使用 _detect_aggregate_node_for_group 方法</li>
</ul>
<p>Relation Detection Methods。专门用于检测不同类型节点关系的方法集合</p>
<ul>
<li>_detect_pairwise_causal_condition_relations检测两个节点之间的因果和条件关系，使用 LLM 判断关系类型：CAUSE、CONDITION、RELATE、CONFLICT 或 NONE。</li>
<li>_detect_sequence_links根据时间戳检测节点间的时序关系，创建 FOLLOWS 类型的边连接相关节点。</li>
<li>_detect_aggregate_node_for_group识别具有相似标签的节点组并生成聚合概念节点，使用 LLM 判断是否需要创建聚合节点。</li>
</ul>
<p>Inference Methods。用于从现有关系中推断新节点的方法</p>
<ul>
<li>_infer_fact_nodes_from_relations：从因果和条件关系中推断新的事实节点，生成带有推理标记的新节点并连接到源节点。</li>
</ul>
<h5 data-id="heading-29">3.4.2 工作流程</h5>
<ul>
<li>初始化阶段。接收 graph_store、llm 和 embedder 作为依赖组件，准备处理关系检测和推理所需的基础工具</li>
<li>处理阶段。通过 process_node 方法处理单个节点，查找邻近节点并进行关系分析，生成推理节点和关系连接</li>
<li>结果输出。返回包含新关系、推理节点、序列链接和聚合节点的结果集，为图结构重组提供数据支持</li>
</ul>
<p>数据流如下：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-attribute">Background</span> Task → GraphStructureReorganizer
 ↓
RelationAndReasoningDetector<span class="hljs-selector-class">.process_node</span>()
 ↓
Neo4jGraphDB <span class="hljs-selector-attr">[Get Neighbors/Nodes/Edges]</span>
  ↓
RelationAndReasoningDetector <span class="hljs-selector-attr">[LLM Analysis]</span>
 ↓
Neo4jGraphDB <span class="hljs-selector-attr">[Add Inferred Nodes/Relations]</span>
</code></pre>
<h5 data-id="heading-30">3.4.3 promt</h5>
<p>RelationAndReasoningDetector 引入了以下 prompt。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">from</span> memos.<span class="hljs-property">templates</span>.<span class="hljs-property">tree_reorganize_prompts</span> <span class="hljs-keyword">import</span> (
    <span class="hljs-variable constant_">AGGREGATE_PROMPT</span>,
    <span class="hljs-variable constant_">INFER_FACT_PROMPT</span>,
    <span class="hljs-variable constant_">PAIRWISE_RELATION_PROMPT</span>,
)
</code></pre>
<p>举例如下：</p>
<pre><code class="hljs language-vbnet" lang="vbnet">PAIRWISE_RELATION_PROMPT = <span class="hljs-string">"""
You are a reasoning assistant.

Given two memory units:
- Node 1: "</span>{node1}<span class="hljs-string">"
- Node 2: "</span>{node2}<span class="hljs-string">"

Your task:
- Determine their relationship ONLY if it reveals NEW usable reasoning or retrieval knowledge that is NOT already explicit in either unit.
- Focus on whether combining them adds new temporal, causal, conditional, or conflict information.

Valid options:
- CAUSE: One clearly leads to the other.
- CONDITION: One happens only if the other condition holds.
- RELATE: They are semantically related by shared people, time, place, or event, but neither causes the other.
- CONFLICT: They logically contradict each other.
- NONE: No clear useful connection.

Example:
- Node 1: "</span>The marketing campaign ended <span class="hljs-keyword">in</span> June.<span class="hljs-string">"
- Node 2: "</span>Product sales dropped <span class="hljs-keyword">in</span> July.<span class="hljs-string">"
Answer: CAUSE

Another Example:
- Node 1: "</span>The conference was postponed <span class="hljs-keyword">to</span> August due <span class="hljs-keyword">to</span> the venue being unavailable.<span class="hljs-string">"
- Node 2: "</span>The venue was booked <span class="hljs-keyword">for</span> a wedding <span class="hljs-keyword">in</span> August.<span class="hljs-string">"
Answer: CONFLICT

Always respond with ONE word, no matter what language is for the input nodes: [CAUSE | CONDITION | RELATE | CONFLICT | NONE]
"""</span>

INFER_FACT_PROMPT = <span class="hljs-string">"""
You are an inference expert.

Source Memory: "</span>{source}<span class="hljs-string">"
Target Memory: "</span>{target}<span class="hljs-string">"

They are connected by a {relation_type} relation.
Derive ONE new factual statement that clearly combines them in a way that is NOT a trivial restatement.

Requirements:
- Include relevant time, place, people, and event details if available.
- If the inference is a logical guess, explicitly use phrases like "</span>It can be inferred that...<span class="hljs-string">".

Example:
Source: "</span>John missed the team meeting <span class="hljs-keyword">on</span> Monday.<span class="hljs-string">"
Target: "</span>Important project deadlines were discussed <span class="hljs-keyword">in</span> that meeting.<span class="hljs-string">"
Relation: CAUSE
Inference: "</span>It can be inferred that John may <span class="hljs-built_in">not</span> know the <span class="hljs-built_in">new</span> project deadlines.<span class="hljs-string">"

If there is NO new useful fact that combines them, reply exactly: "</span>None<span class="hljs-string">"
"""</span>

AGGREGATE_PROMPT = <span class="hljs-string">"""
You are a concept summarization assistant.

Below is a list of memory items:
{joined}

Your task:
- Identify if they can be meaningfully grouped under a new, higher-level concept that clarifies their shared time, place, people, or event context.
- Do NOT aggregate if the overlap is trivial or obvious from each unit alone.
- If the summary involves any plausible interpretation, explicitly note it (e.g., "</span>This suggests...<span class="hljs-string">").

Example:
Input Memories:
- "</span>Mary organized the <span class="hljs-number">2023</span> sustainability summit <span class="hljs-keyword">in</span> Berlin.<span class="hljs-string">"
- "</span>Mary presented a keynote <span class="hljs-keyword">on</span> renewable energy at the same summit.<span class="hljs-string">"

Language rules:
- The `key`, `value`, `tags`, `background` fields must match the language of the input.

Good Aggregate:
{
  "</span><span class="hljs-keyword">key</span><span class="hljs-string">": "</span>Mary<span class="hljs-comment">'s Sustainability Summit Role",</span>
  <span class="hljs-string">"value"</span>: <span class="hljs-string">"Mary organized and spoke at the 2023 sustainability summit in Berlin, highlighting renewable energy initiatives."</span>,
  <span class="hljs-string">"tags"</span>: [<span class="hljs-string">"Mary"</span>, <span class="hljs-string">"summit"</span>, <span class="hljs-string">"Berlin"</span>, <span class="hljs-string">"2023"</span>],
  <span class="hljs-string">"background"</span>: <span class="hljs-string">"Combined from multiple memories about Mary's activities at the summit."</span>
}

<span class="hljs-keyword">If</span> you find NO useful higher-level concept, reply exactly: <span class="hljs-string">"None"</span>.
<span class="hljs-string">"""
</span></code></pre>
<p>这三组提示词是面向 MemOS 记忆系统中<strong>关系推理、事实推导、概念聚合</strong>的专业化 prompt 设计,三个prompt的特点如下：</p>
<ul>
<li>
<p><code>PAIRWISE_RELATION_PROMPT</code>将 AI 定义为<strong>reasoning assistant（推理助手）</strong> ，聚焦两个记忆单元的关系判定，匹配 “逻辑关系分析” 的任务属性；</p>
<ul>
<li>仅要求判断两个节点的关系类型，且明确限定 “仅当关系能揭示新知识时才判定，否则为 NONE”；</li>
<li>关系判定中，将有效关系拆分为 <strong>CAUSE（因果）、CONDITION（条件）、RELATE（关联）、CONFLICT（冲突）、NONE（无）</strong> 五类，并对每类的判定依据（如因果是 “一方明确导致另一方”）做了清晰说明；</li>
<li>关系判定强制要求<strong>仅输出一个单词</strong>，无论输入语言为何，避免 AI 产生冗余解释；</li>
<li>关系判定是<strong>记忆关联的基础环节</strong>，为两个独立记忆单元建立语义连接，要求 “揭示新的推理 / 检索知识”。</li>
</ul>
</li>
<li>
<p><code>INFER_FACT_PROMPT</code>设定为<strong>inference expert（推理专家）</strong> ，侧重基于已知关系推导新事实，突出 “深度语义挖掘” 的专业性；</p>
<ul>
<li>仅要求基于关系推导<strong>一个</strong>新事实，禁止简单复述原记忆内容；</li>
<li>事实推导是<strong>记忆挖掘的深化环节</strong>，基于关联关系生成新的知识节点，要求 “生成非平凡的新事实”。</li>
<li>事实推导要求 “结合时间、地点、人物、事件细节”，若为推测需使用 “It can be inferred that...” 等固定表述，确保推导结果的可验证性。</li>
<li>事实推导若无可推导内容，需<strong>严格返回 “None”</strong> ，聚合 prompt 同理，统一了无效场景的输出格式。</li>
</ul>
</li>
<li>
<p><code>AGGREGATE_PROMPT</code>定位为<strong>concept summarization assistant（概念总结助手）</strong> ，针对多记忆单元的高阶聚合，贴合 “抽象归纳” 的核心需求。</p>
<ul>
<li>概念聚合是<strong>记忆结构化的高阶环节</strong>，将零散记忆归纳为抽象概念，要求 “提炼高阶共享概念”，适配 MemOS 中 “节点 - 关系 - 概念” 的层级化记忆管理架构。</li>
<li>仅要求识别多记忆单元的<strong>高阶共享概念</strong>，若重叠为常识则直接返回 “None”。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-31">3.5 NodeHandler</h4>
<p>NodeHandler 是 Memos 系统中负责处理记忆节点冲突检测与解决的核心组件。</p>
<h5 data-id="heading-32">3.5.1 主要功能</h5>
<p>NodeHandler 的主要功能包括：</p>
<ul>
<li>
<p>冲突检测（Conflict Detection）</p>
<ul>
<li>使用嵌入向量相似度搜索潜在的冲突记忆节点</li>
<li>利用 LLM 判断两个记忆节点之间的关系（矛盾、冗余或独立）</li>
<li>基于预设阈值（EMBEDDING_THRESHOLD）进行初步筛选</li>
</ul>
</li>
<li>
<p>冲突解决（Conflict Resolution）</p>
<ul>
<li>对检测到的冲突进行融合处理</li>
<li>使用 LLM 生成融合后的记忆内容</li>
<li>处理元数据合并和图结构更新</li>
</ul>
</li>
<li>
<p>图结构维护</p>
<ul>
<li>更新合并后的记忆节点到图数据库</li>
<li>维护原有节点间的关系连接</li>
<li>将旧节点标记为已归档状态</li>
</ul>
</li>
</ul>
<h5 data-id="heading-33">3.5.2 调用关系与依赖关系</h5>
<p><strong>直接依赖组件如下</strong>：</p>
<ul>
<li>
<p>GraphStore（Neo4jGraphDB）：</p>
<ul>
<li>搜索相似节点：search_by_embedding</li>
<li>获取节点信息：get_nodes</li>
<li>更新图结构：add_node, delete_node, add_edge, update_node, edge_exists</li>
</ul>
</li>
<li>
<p>LLM（BaseLLM）</p>
<ul>
<li>判断节点关系：MEMORY_RELATION_DETECTOR_PROMPT</li>
<li>用于解决冲突：MEMORY_RELATION_RESOLVER_PROMPT</li>
</ul>
</li>
<li>
<p>Embedder（BaseEmbedder）</p>
<ul>
<li>用于生成新记忆的嵌入向量</li>
</ul>
</li>
</ul>
<p><strong>被其他组件调用</strong></p>
<ul>
<li>GraphStructureReorganizer：在 handle_add 方法中调用 NodeHandler.detect 和 NodeHandler.resolve，用于处理新增节点时的冲突检测与解决。</li>
</ul>

<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 在 GraphStructureReorganizer.handle_add 中的调用示例</span>
    def handle_add(self, message: QueueMessage):
        <span class="hljs-attr">added_node</span> = message.after_node[<span class="hljs-number">0</span>]
        <span class="hljs-attr">detected_relationships</span> = self.resolver.detect(
            added_node, <span class="hljs-attr">scope</span>=added_node.metadata.memory_type
        )
        if detected_relationships:
            for added_node, existing_node, relation in detected_relationships:
                self.resolver.resolve(added_node, existing_node, relation)

        <span class="hljs-attr">self._reorganize_needed</span> = <span class="hljs-literal">True</span>
</code></pre>
<p><strong>数据模型依赖</strong></p>
<ul>
<li>TextualMemoryItem：处理的主要对象类型</li>
<li>TreeNodeTextualMemoryMetadata：节点元数据结构</li>
<li>Templates：使用 MEMORY_RELATION_DETECTOR_PROMPT 和 MEMORY_RELATION_RESOLVER_PROMPT 模板</li>
</ul>
<h5 data-id="heading-34">3.5.3 流程图</h5>
<p>NodeHandler 的流程图如下：</p>
<pre><code class="hljs language-scss" lang="scss">User <span class="hljs-selector-tag">Input</span> → MemoryManager<span class="hljs-selector-class">.add</span>()
 ↓
NodeHandler<span class="hljs-selector-class">.detect</span>() → <span class="hljs-selector-attr">[Embedding Search]</span>
 ↓
NodeHandler<span class="hljs-selector-class">.resolve</span>() → <span class="hljs-selector-attr">[LLM Conflict Resolution]</span>
 ↓
Neo4jGraphDB <span class="hljs-selector-attr">[Add/Update/Delete Nodes &amp; Edges]</span>
</code></pre>
<p>具体如下：</p>
<ul>
<li>检测阶段：detect() → search_by_embedding() → get_nodes() → LLM 判断关系 → 返回冲突列表</li>
<li>解决阶段：resolve() → LLM 生成融合记忆 → 解析响应 → _merge_metadata() → _resolve_in_graph() → 更新图数据库结构</li>
<li>硬更新处理：当无法通过 LLM 解决冲突时，采用时间戳比较方式进行硬更新：_hard_update() → 比较 updated_at → 删除较旧节点</li>
</ul>
<p>总的来说，NodeHandler 是 Memos 记忆管理系统中保证记忆一致性和避免冲突的关键组件，它协调了图数据库、大语言模型和嵌入模型来完成记忆节点的智能化管理。</p>
<h4 data-id="heading-35">3.6 NodeHandler vs RelationAndReasoningDetector</h4>
<p>为何要拆分成两个类，而不合二为一？</p>
<h5 data-id="heading-36">3.6.1 设计思路</h5>
<p><code>RelationAndReasoningDetector</code>（关系与推理检测器）和 <code>NodeHandler</code>（节点处理器）的拆分设计，本质是<strong>遵循 “单一职责原则” 与 “关注点分离”</strong> 的架构设计思想 —— 二者虽共同服务于 “记忆的结构化管理与智能推理”，但核心职责、输入输出、复用场景完全不同，合并会导致代码耦合度飙升、可维护性下降、功能扩展受限。</p>
<p>MemOS 的核心架构是 “分层设计”（感知层→推理层→存储层）：</p>
<ul>
<li>感知层：处理输入数据（如文本解析）；</li>
<li>推理层：负责智能分析（如关系识别、推理）；</li>
<li>存储层：负责数据持久化（如节点、关系存储）。</li>
</ul>
<p><code>RelationAndReasoningDetector</code> 属于 “推理层”，属于主动发起推理阶段，在添加新节点后主动寻找关联，<code>NodeHandler</code> 属于 “存储层”，属于被动响应阶段，在发现冲突时进行处理。</p>
<p>MemOS 中两个类的拆分，本质是 “将‘智能决策（推理）’与‘数据执行（存储）’分离”—— 前者负责 “想清楚要做什么”（从文本中识别节点和关系），后者负责 “把事做好”（将识别出的节点和关系落地到存储）。这种设计不仅符合软件工程的核心原则，更适配 MemOS 作为 “Agent 记忆系统” 的核心需求：既要支持灵活的推理逻辑迭代，又要保证存储操作的稳定可靠。合并二者相当于打破了分层架构，导致架构边界模糊，后续无法对某一层进行独立的性能优化或功能扩展（如给推理层加缓存、给存储层加容灾）。</p>
<h5 data-id="heading-37">3.6.2 定位边界</h5>
<p>要理解 “为何不能合并”，首先要厘清二者的定位边界，这是拆分的根本依据：</p>



































<table><thead><tr><th>维度</th><th>RelationAndReasoningDetector（关系与推理检测器）</th><th>NodeHandler（节点处理器）</th></tr></thead><tbody><tr><td><strong>核心职责</strong></td><td>负责 “语义层面的智能分析”：从非结构化数据（如文本、对话）中识别实体关系、触发推理逻辑、挖掘隐含信息。</td><td>负责 “数据层面的结构化操作”：管理知识图谱的节点生命周期（创建、更新、删除、查询），处理节点的存储与格式适配。</td></tr><tr><td><strong>输入 / 输出</strong></td><td>输入：非结构化数据（文本片段、用户指令）、现有知识图谱元数据；输出：关系三元组（实体 A - 关系 - 实体 B）、推理结论、待处理的节点关联需求。</td><td>输入：结构化数据（节点 ID、属性键值对、关联关系标识）；输出：节点操作结果（创建成功 / 更新后的节点数据 / 查询结果）。</td></tr><tr><td><strong>核心能力依赖</strong></td><td>依赖大模型（LLM）的语义理解与推理能力，需处理模糊、歧义的非结构化信息（如 “小明喜欢喝拿铁”→ 识别 “小明 - 喜欢 - 拿铁” 三元组）。</td><td>依赖数据存储层（如 Neo4j、向量数据库）的 CRUD 接口，需保证操作的原子性、一致性（如创建节点时校验唯一标识，避免重复）。</td></tr><tr><td><strong>变化频率</strong></td><td>较高：推理规则、关系类型可能随场景迭代（如从 “通用对话” 扩展到 “专业领域”，需新增领域特定关系识别逻辑）。</td><td>较低：节点的存储格式、操作规范（如 ID 生成规则、属性校验逻辑）一旦确定，很少频繁变更。</td></tr><tr><td><strong>复用场景</strong></td><td>可跨模块复用：除了给 NodeHandler 提供关联数据，还可给 RAG 模块提供推理结论、给 Agent 决策模块提供关系依据。</td><td>聚焦记忆存储层：主要服务于知识图谱的节点管理，复用场景集中在 “节点数据的读写操作”。</td></tr></tbody></table>
<h5 data-id="heading-38">3.6.3 详细思路</h5>
<h6 data-id="heading-39">解耦 “智能推理” 与 “数据操作”</h6>
<p>MemOS 的核心价值是 “让 Agent 拥有可推理的记忆”，而这一目标需要 “先分析（推理）、后操作（存储）” 的流程：</p>
<ul>
<li>第一步：<code>RelationAndReasoningDetector</code> 把 “模糊的自然语言” 翻译成 “结构化的关系与节点需求”（如 “小红买了新手机”→ 识别出 “小红”“新手机” 两个实体，“购买” 关系，生成 “创建两个节点 + 建立关联” 的需求）；</li>
<li>第二步：<code>NodeHandler</code> 接收这个 “明确需求”，执行具体的存储操作（创建小红节点、创建新手机节点、在二者间添加 “购买” 关系边）。</li>
</ul>
<p>若合并为一个类，会导致 “推理逻辑” 与 “存储逻辑” 交织在一起：比如在 “创建节点” 的代码中，既要写 “如何校验节点 ID 唯一性”，又要写 “如何从文本中识别节点实体”—— 当需要修改推理规则（如新增 “合作” 关系识别）时，可能误改存储相关代码；当需要更换数据库（如从 Neo4j 换成 ArangoDB）时，又要动推理相关的逻辑，维护成本指数级上升。</p>
<h6 data-id="heading-40">适配不同的 “扩展与优化方向</h6>
<p>两个类的优化目标完全不同，拆分后可独立迭代，”—— 避免 “牵一发而动全身”。</p>
<ul>
<li>对 <code>RelationAndReasoningDetector</code>：优化方向是 “提升推理准确率”（如引入少样本学习、领域微调、思维链提示）、“支持更多关系类型”（如从二元关系扩展到多元关系）、“降低推理延迟”（如缓存高频推理规则）；</li>
<li>对 <code>NodeHandler</code>：优化方向是 “提升存储性能”（如批量操作、索引优化）、“增强数据一致性”（如事务支持、冲突解决）、“适配多存储引擎”（如同时支持图数据库、向量数据库）。</li>
</ul>
<p>例如：当需要给 MemOS 新增 “时序关系推理” 功能时，只需修改 <code>RelationAndReasoningDetector</code>，新增时序关系识别逻辑（如 “2024 年小明入职→ 小明 - 2024 年入职 - 公司”），<code>NodeHandler</code> 完全无需改动；反之，当需要将节点存储从 “单节点数据库” 扩展到 “分布式存储” 时，只需优化 <code>NodeHandler</code> 的操作接口，推理逻辑不受任何影响。</p>
<h6 data-id="heading-41">提升代码复用性与测试效率</h6>
<ul>
<li>复用性：<code>RelationAndReasoningDetector</code> 的推理能力可被 MemOS 多个模块复用（如 Agent 的决策模块、RAG 的检索增强模块），而 <code>NodeHandler</code> 的节点操作能力可被知识图谱的多个子功能复用（如节点更新、节点查询、节点删除）。若合并，这些复用场景会被迫引入无关逻辑（如调用推理功能时，还要加载存储相关的依赖）；</li>
<li>测试效率：拆分后可独立编写单元测试 —— 测试 <code>RelationAndReasoningDetector</code> 时，只需模拟输入文本，验证输出的关系三元组是否正确，无需依赖真实数据库；测试 <code>NodeHandler</code> 时，只需模拟结构化的节点数据，验证 CRUD 操作是否符合预期，无需启动大模型。若合并，测试用例需同时覆盖 “推理逻辑” 和 “存储逻辑”，场景组合爆炸（如 “推理正确但存储失败”“推理错误但存储成功”），测试难度和维护成本陡增。</li>
</ul>
<h3 data-id="heading-42">0x04 图例</h3>
<h4 data-id="heading-43">4.1 组件关系图</h4>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dff3f8208ce340369bc5336bc71cca2d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg572X6KW_55qE5oCd6ICD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765200027&amp;x-signature=yXT%2BPdDb%2FApECt5gG5Q7tzioPG8%3D" alt="MemoryManager流程" loading="lazy"/></p>
<p>MemoryManager流程</p>
<h4 data-id="heading-44">4.2 调用流程图</h4>
<p>调用流程图如下。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/934f70ba3c8b4d2b915a048e86e8bb20~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg572X6KW_55qE5oCd6ICD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765200027&amp;x-signature=aCO14rWxcOeHkN%2BwhG5AF988aWc%3D" alt="MemoryManager-sequence" loading="lazy"/></p>
<p>MemoryManager-sequence</p>
<p>详细组件交互说明</p>
<ul>
<li>
<p>MemoryManager 与 GraphStructureReorganizer：</p>
<ul>
<li>MemoryManager 在添加新记忆时通过 GraphStructureReorganizer.add_message() 发送消息。</li>
<li>GraphStructureReorganizer 作为后台线程处理这些消息</li>
</ul>
</li>
</ul>

<ul>
<li>
<p>GraphStructureReorganizer 与 NodeHandler</p>
<ul>
<li>在处理 "add" 操作时，调用 NodeHandler.detect() 检测冲突</li>
<li>对于检测到的冲突，调用 NodeHandler.resolve() 解决冲突</li>
</ul>
</li>
<li>
<p>GraphStructureReorganizer 与 RelationAndReasoningDetector</p>
<ul>
<li>在结构优化过程中，调用 RelationAndReasoningDetector.process_node() 处理节点关系检测并创建因果关系、条件关系、推理节点等</li>
</ul>
</li>
<li>
<p>所有组件与 Neo4jGraphDB。所有组件都直接与 Neo4jGraphDB 交互进行图操作：</p>
<ul>
<li>节点操作: add_node(), delete_node(), update_node(), get_node()</li>
<li>边操作: add_edge(), delete_edge(), edge_exists(), get_edges()</li>
<li>查询操作：search_by_embedding(), get_neighbors_by_tag()</li>
</ul>
</li>
</ul>
<p>这个设计实现了分层处理：MemoryManager 负责基本的记忆管理，GraphStructureReorganizer 负责后台结构优化，而 NodeHandler 和 RelationAndReasoningDetector 则专门处理特定的图结构维护任务。</p>
<h3 data-id="heading-45">0xFF 参考</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Flink.zhihu.com%2F%3Ftarget%3Dhttps%253A%2F%2Farxiv.org%2Fpdf%2F2507.03724" target="_blank" title="https://link.zhihu.com/?target=https%3A//arxiv.org/pdf/2507.03724" ref="nofollow noopener noreferrer">arxiv.org/pdf/2507.03…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Flink.zhihu.com%2F%3Ftarget%3Dhttps%253A%2F%2Fgithub.com%2FMemTensor%2FMemOS.git" target="_blank" title="https://link.zhihu.com/?target=https%3A//github.com/MemTensor/MemOS.git" ref="nofollow noopener noreferrer">github.com/MemTensor/M…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FMemTensor%2FMemOS-Docs" target="_blank" title="https://github.com/MemTensor/MemOS-Docs" ref="nofollow noopener noreferrer">github.com/MemTensor/M…</a></p>
<p>本文使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmarkdown.com.cn" target="_blank" title="https://markdown.com.cn" ref="nofollow noopener noreferrer">markdown.com.cn</a> 排版</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Claude 代码审查不好用？试试这个我花了一周优化的 Skill]]></title>    <link>https://juejin.cn/post/7578709098255908902</link>    <guid>https://juejin.cn/post/7578709098255908902</guid>    <pubDate>2025-12-01T13:57:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578709098255908902" data-draft-id="7578714735307587610" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Claude 代码审查不好用？试试这个我花了一周优化的 Skill"/> <meta itemprop="keywords" content="Claude,Agent,AI编程"/> <meta itemprop="datePublished" content="2025-12-01T13:57:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="也无风雨也雾晴"/> <meta itemprop="url" content="https://juejin.cn/user/2175258804632332"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Claude 代码审查不好用？试试这个我花了一周优化的 Skill
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2175258804632332/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    也无风雨也雾晴
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-01T13:57:38.000Z" title="Mon Dec 01 2025 13:57:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-01
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">从 1774 行到 178 行：我如何重构一个 Claude Code Skill</h2>
<h3 data-id="heading-1">起因</h3>
<p>用 Claude Code 做代码审查，总觉得差点意思。</p>
<p>它能指出明显的 bug，也能给一些重构建议，但给的反馈太泛了——缺少系统化的审查流程，没有语言特定的深度检查，更别说什么"给建设性反馈的技巧"。</p>
<p>后来发现 marketplace 上有个 <code>code-review-excellence</code> skill，装上试了试，确实专业多了。但翻开源码一看：<strong>一个 SKILL.md 文件，1774 行</strong>。</p>
<p>这就有问题了。</p>
<h3 data-id="heading-2">问题在哪</h3>
<p>Claude Code Skills 有个设计叫 <strong>Progressive Disclosure</strong>（渐进式加载）：</p>
<ul>
<li>未激活时：只加载 skill 的 name + description（几十个 token）</li>
<li>激活时：加载完整的 SKILL.md</li>
</ul>
<p>一个 1774 行的文件，一激活就是 15000+ tokens。如果我只是审查一段 Python 代码，却把 React 19 Server Components、Vue 3.5 defineModel、Rust Cancellation Safety 全加载进来——这不是浪费是什么？</p>
<p>更关键的是，这 1774 行里还引用了 <code>references/</code> 和 <code>assets/</code> 目录下的文件，但这些文件<strong>根本不存在</strong>。</p>
<h3 data-id="heading-3">重构思路</h3>
<p>核心目标：<strong>把一个巨型文件拆成按需加载的模块化架构</strong>。</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">重构前:</span>
SKILL.md (1774 行，全量加载)
​
<span class="hljs-section">重构后:</span>
SKILL.md (~180 行，核心内容，始终加载)
├── reference/
│   ├── react.md (~870 行，审查 React 时加载)
│   ├── vue.md (~920 行，审查 Vue 时加载)
│   ├── rust.md (~840 行，审查 Rust 时加载)
│   ├── typescript.md (~540 行，审查 TS 时加载)
│   └── python.md (~1070 行，审查 Python 时加载)
├── assets/
│   ├── pr-review-template.md (PR 审查模板)
│   └── review-checklist.md (快速检查清单)
└── scripts/
    └── pr-analyzer.py (PR 复杂度分析脚本)
</code></pre>
<p>总内容从 ~1774 行扩展到 ~6000 行，但 SKILL.md 反而缩减到 180 行。</p>
<p>这就是 Progressive Disclosure 的精髓：<strong>核心精炼，细节按需</strong>。</p>
<h3 data-id="heading-4">SKILL.md 怎么写</h3>
<h4 data-id="heading-5">Frontmatter 规范</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-meta">---</span>
<span class="hljs-attr">name:</span> <span class="hljs-string">code-review-excellence</span>
<span class="hljs-attr">description:</span> <span class="hljs-string">|
  Provides comprehensive code review guidance for React 19, Vue 3, Rust, TypeScript, and Python.
  Helps catch bugs, improve code quality, and give constructive feedback.
  Use when: reviewing pull requests, conducting PR reviews, code review, reviewing code changes,
  establishing review standards, mentoring developers, architecture reviews, security audits,
  checking code quality, finding bugs, giving feedback on code.
</span><span class="hljs-attr">allowed-tools:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">Read</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">Grep</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">Glob</span>
<span class="hljs-meta">---
</span></code></pre>
<p>几个要点：</p>
<ol start="0">
<li><strong>name 必须是 kebab-case</strong>，且与目录名一致</li>
<li><strong>description 要包含触发词</strong>，"Use when:" 后面列出使用场景</li>
<li><strong>allowed-tools 可选</strong>，预批准的工具列表，减少确认弹窗</li>
</ol>
<h4 data-id="heading-6">触发词的重要性</h4>
<p>description 里的触发词决定了 skill 何时被激活。写得太窄，很多场景触发不了；写得太宽，容易误触发。</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># ❌ 太窄</span>
<span class="hljs-attr">description:</span> <span class="hljs-string">Use</span> <span class="hljs-string">when</span> <span class="hljs-string">reviewing</span> <span class="hljs-string">pull</span> <span class="hljs-string">requests</span>
<span class="hljs-string">​</span>
<span class="hljs-comment"># ✅ 覆盖多种表达方式</span>
<span class="hljs-attr">description:</span> <span class="hljs-string">|
  Use when: reviewing pull requests, conducting PR reviews, code review,
  reviewing code changes, establishing review standards, mentoring developers,
  architecture reviews, security audits, checking code quality, finding bugs
</span></code></pre>
<p>用户说"帮我 review 这段代码"、"检查下这个 PR"、"审查下安全性"都能触发。</p>
<h4 data-id="heading-7">内容组织</h4>
<p>SKILL.md 只放"必须知道"的内容：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># Code Review Excellence</span>
​
<span class="hljs-comment">## When to Use This Skill</span>
- Reviewing pull requests and code changes
- Establishing code review standards for teams
- ...
​
<span class="hljs-comment">## Core Principles</span>
<span class="hljs-section">[审查的核心原则，简明扼要]</span>
​
<span class="hljs-comment">## Review Process</span>
<span class="hljs-section">[4 阶段审查流程：Context → High-Level → Line-by-Line → Summary]</span>
​
<span class="hljs-comment">## Language-Specific Guides</span>
| Language | Reference File | Key Topics |
|----------|----------------|------------|
| React | <span class="hljs-section">[React Guide]</span>(reference/react.md) | Hooks, React 19 Actions, RSC |
| Vue 3 | <span class="hljs-section">[Vue Guide]</span>(reference/vue.md) | Composition API, Vue 3.5 特性 |
| ...
</code></pre>
<p>详细的语言特定内容，通过 Markdown 链接引用 reference/ 目录下的文件。</p>
<p><strong>关键点</strong>：使用 <code>[React Guide](reference/react.md)</code> 这种 Markdown 链接格式，而不是 <code>`reference/react.md`</code> 反引号格式。前者能被 Claude Code 识别并按需加载。</p>
<h3 data-id="heading-8">Reference 文件怎么写</h3>
<p>以 <code>reference/react.md</code> 为例，专注于 React 代码审查的深度内容：</p>
<pre><code class="hljs language-scss" lang="scss"># React 代码审查指南
​
&gt; React 审查重点：Hooks 规则、性能优化的适度性、组件设计、以及现代 React <span class="hljs-number">19</span>/RSC 模式。
​
## 目录
- <span class="hljs-selector-attr">[Hooks 规则与常见错误]</span>(#hooks-规则与常见错误)
- <span class="hljs-selector-attr">[useEffect 深度审查]</span>(#useeffect-深度审查)
- <span class="hljs-selector-attr">[React 19 Actions &amp; Forms]</span>(#react-<span class="hljs-number">19</span>-actions--forms)
- <span class="hljs-selector-attr">[Server Components]</span>(#server-components)
- <span class="hljs-selector-attr">[TanStack Query v5]</span>(#tanstack-query-v5)
​
## Hooks 规则与常见错误
​
### 条件调用 Hooks
​
```tsx
<span class="hljs-comment">// ❌ 条件调用 Hooks — 违反 Hooks 规则</span>
function <span class="hljs-built_in">BadComponent</span>({ show }) {
  if (show) {
    const <span class="hljs-selector-attr">[value, setValue]</span> = <span class="hljs-built_in">useState</span>(<span class="hljs-number">0</span>);  <span class="hljs-comment">// Error!</span>
  }
  return &lt;<span class="hljs-selector-tag">div</span>&gt;...&lt;/<span class="hljs-selector-tag">div</span>&gt;;
}
​
<span class="hljs-comment">// ✅ Hooks 必须在顶层无条件调用</span>
function <span class="hljs-built_in">GoodComponent</span>({ show }) {
  const <span class="hljs-selector-attr">[value, setValue]</span> = <span class="hljs-built_in">useState</span>(<span class="hljs-number">0</span>);
  if (!show) return null;
  return &lt;<span class="hljs-selector-tag">div</span>&gt;{value}&lt;/<span class="hljs-selector-tag">div</span>&gt;;
}
</code></pre>
<p>[更多内容...]</p>
<pre><code class="hljs language-markdown" lang="markdown">​
每个 reference 文件都有：
<span class="hljs-bullet">1.</span> 开头的定位说明（这个文件是干什么的）
<span class="hljs-bullet">2.</span> 清晰的目录结构
<span class="hljs-bullet">3.</span> 大量的 ✅ / ❌ 对比示例
<span class="hljs-bullet">4.</span> 审查清单（Checklist）
​
<span class="hljs-section">## Token 开销对比</span>
​
重构前后的 token 开销变化：
​
</code></pre>
<p>重构前：</p>
<ul>
<li>激活 skill: ~15000 tokens（全量加载）</li>
</ul>
<p>重构后：</p>
<ul>
<li>激活 skill: ~1500 tokens（仅 SKILL.md）</li>
<li>审查 React 代码: +7000 tokens（加载 react.md）</li>
<li>审查 Python 代码: +8500 tokens（加载 python.md）</li>
<li>审查 Vue 代码: +7500 tokens（加载 vue.md）</li>
</ul>
<pre><code class="hljs language-shell" lang="shell">​
如果我只审查 Python 代码，现在只需要 ~10000 tokens，而不是之前的 15000 tokens。
​
更重要的是，这 6000 行的内容比原来 1774 行**更深入**——每个语言都有完整的审查指南，而不是蜻蜓点水。
​
<span class="hljs-meta prompt_">#</span><span class="bash"><span class="hljs-comment"># 实际效果</span></span>
​
<span class="hljs-meta prompt_">#</span><span class="bash"><span class="hljs-comment">## 没有 Skill 时</span></span>
​
</code></pre>
<p>问：审查这段代码的安全性</p>
<p>Claude：这段代码看起来有几个潜在问题... [泛泛的建议，缺少系统性]</p>
<pre><code class="hljs language-shell" lang="shell">​
<span class="hljs-meta prompt_">#</span><span class="bash"><span class="hljs-comment">## 有 Skill 后</span></span>
​
</code></pre>
<p>问：审查这段代码的安全性</p>
<p>Claude：</p>
<h3 data-id="heading-9">安全审查报告</h3>
<h4 data-id="heading-10">🔴 严重问题 (Blocking)</h4>
<ol start="0">
<li>
<p>SQL 注入风险 - 第 23 行直接拼接用户输入</p>
<blockquote>
<p>建议使用参数化查询：<code>cursor.execute("SELECT * FROM users WHERE id = %s", (user_id,))</code></p>
</blockquote>
</li>
</ol>
<h4 data-id="heading-11">🟡 重要改进 (Important)</h4>
<ol start="2">
<li>缺少输入验证 - user_id 未校验类型和范围</li>
</ol>
<h4 data-id="heading-12">安全检查清单</h4>
<ul>
<li>参数化查询</li>
<li>输入验证</li>
<li>错误信息脱敏 ...</li>
</ul>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">​</span>
<span class="hljs-string">结构化、可执行、有优先级。这才是专业的代码审查。</span>
<span class="hljs-string">​</span>
<span class="hljs-meta">---</span>
<span class="hljs-string">​</span>
<span class="hljs-comment">## code-review-skill：一个真正可用的代码审查 Skill</span>
<span class="hljs-string">​</span>
<span class="hljs-string">经过多轮迭代，这个</span> <span class="hljs-string">skill</span> <span class="hljs-string">已经从最初的"修复别人的</span> <span class="hljs-string">bug"变成了一个**完整的代码审查解决方案**。</span>
<span class="hljs-string">​</span>
<span class="hljs-comment">### 为什么用这个 Skill</span>
<span class="hljs-string">​</span>
<span class="hljs-string">|</span> <span class="hljs-string">痛点</span> <span class="hljs-string">|</span> <span class="hljs-string">原生</span> <span class="hljs-string">Claude</span> <span class="hljs-string">|</span> <span class="hljs-string">使用</span> <span class="hljs-string">code-review-skill</span> <span class="hljs-string">|</span>
<span class="hljs-string">|------|------------|----------------------|</span>
<span class="hljs-string">|</span> <span class="hljs-string">审查流程</span> <span class="hljs-string">|</span> <span class="hljs-string">想到哪说哪</span> <span class="hljs-string">|</span> <span class="hljs-number">4</span> <span class="hljs-string">阶段系统化流程</span> <span class="hljs-string">|</span>
<span class="hljs-string">|</span> <span class="hljs-string">问题分级</span> <span class="hljs-string">|</span> <span class="hljs-string">混在一起</span> <span class="hljs-string">|</span> <span class="hljs-string">🔴</span> <span class="hljs-string">Blocking</span> <span class="hljs-string">/</span> <span class="hljs-string">🟡</span> <span class="hljs-string">Important</span> <span class="hljs-string">/</span> <span class="hljs-string">🟢</span> <span class="hljs-string">Nit</span> <span class="hljs-string">|</span>
<span class="hljs-string">|</span> <span class="hljs-string">语言深度</span> <span class="hljs-string">|</span> <span class="hljs-string">泛泛而谈</span> <span class="hljs-string">|</span> <span class="hljs-string">框架特定的最佳实践和陷阱</span> <span class="hljs-string">|</span>
<span class="hljs-string">|</span> <span class="hljs-string">反馈方式</span> <span class="hljs-string">|</span> <span class="hljs-string">直接指出问题</span> <span class="hljs-string">|</span> <span class="hljs-string">提问式引导</span> <span class="hljs-string">+</span> <span class="hljs-string">建设性建议</span> <span class="hljs-string">|</span>
<span class="hljs-string">|</span> <span class="hljs-string">版本覆盖</span> <span class="hljs-string">|</span> <span class="hljs-string">可能过时</span> <span class="hljs-string">|</span> <span class="hljs-string">React</span> <span class="hljs-number">19</span><span class="hljs-string">、Vue</span> <span class="hljs-number">3.5</span><span class="hljs-string">、TanStack</span> <span class="hljs-string">Query</span> <span class="hljs-string">v5</span> <span class="hljs-string">|</span>
<span class="hljs-string">​</span>
<span class="hljs-comment">### 支持的语言和框架</span>
<span class="hljs-string">​</span>
</code></pre>
<p>┌─────────────────────────────────────────────────────────────┐ │ Language/Framework Version Key Topics │ ├─────────────────────────────────────────────────────────────┤ │ React 18.x, 19.x Hooks, Actions, │ │ RSC, Suspense │ ├─────────────────────────────────────────────────────────────┤ │ Vue 3.4+, 3.5+ Composition API,│ │ defineModel, │ │ useTemplateRef │ ├─────────────────────────────────────────────────────────────┤ │ TanStack Query v5.x useSuspenseQuery│ │ Optimistic UI │ ├─────────────────────────────────────────────────────────────┤ │ TypeScript 5.x Generics, Strict│ │ Mode, ESLint │ ├─────────────────────────────────────────────────────────────┤ │ Python 3.10+ async/await, │ │ typing, pytest │ ├─────────────────────────────────────────────────────────────┤ │ Rust 2021 Edition Ownership, Async│ │ Cancellation │ │ Safety │ └─────────────────────────────────────────────────────────────┘</p>
<pre><code class="hljs language-scss" lang="scss">​
每个语言都有独立的深度指南，不是简单的 checklist，而是**真正能帮你发现问题的审查要点**。
​
### 特色功能
​
**<span class="hljs-number">1</span>. React <span class="hljs-number">19</span> Actions 完整指南**
​
```tsx
<span class="hljs-comment">// skill 会帮你识别这种错误：</span>
const <span class="hljs-selector-attr">[state, action]</span> = <span class="hljs-built_in">useActionState</span>(async (prev, formData) =&gt; {
  <span class="hljs-built_in">setSomeState</span>(newValue);  <span class="hljs-comment">// ❌ 不应该在 Action 中 setState</span>
}, initialState);
​
<span class="hljs-comment">// 并建议正确做法：</span>
const <span class="hljs-selector-attr">[state, action]</span> = <span class="hljs-built_in">useActionState</span>(async (prev, formData) =&gt; {
  const result = await <span class="hljs-built_in">submitForm</span>(formData);
  return { ..<span class="hljs-selector-class">.prev</span>, data: result };  <span class="hljs-comment">// ✅ 返回新状态</span>
}, initialState);
</code></pre>
<p><strong>2. Vue 3.5 新特性审查</strong></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- skill 知道 Vue 3.5 的 Reactive Props Destructure --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-comment">// Vue 3.5 之前：这样会丢失响应性</span>
<span class="hljs-keyword">const</span> { count } = defineProps&lt;{ <span class="hljs-attr">count</span>: number }&gt;()
​
<span class="hljs-comment">// Vue 3.5+：skill 会告诉你这样是安全的</span>
<span class="hljs-keyword">const</span> { count } = defineProps&lt;{ <span class="hljs-attr">count</span>: number }&gt;()  <span class="hljs-comment">// ✅ 保持响应性</span>
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p><strong>3. Rust Cancellation Safety</strong></p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// skill 会识别取消不安全的代码：</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">not_cancel_safe</span>(conn: &amp;<span class="hljs-keyword">mut</span> Connection) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;()&gt; {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">data</span> = <span class="hljs-title function_ invoke__">read_data</span>().<span class="hljs-keyword">await</span>?;           <span class="hljs-comment">// 如果这里被取消</span>
    conn.<span class="hljs-title function_ invoke__">write_data</span>(data).<span class="hljs-keyword">await</span>?;            <span class="hljs-comment">// 数据可能部分写入</span>
    conn.<span class="hljs-title function_ invoke__">send_ack</span>().<span class="hljs-keyword">await</span>?;
    <span class="hljs-title function_ invoke__">Ok</span>(())
}
​
<span class="hljs-comment">// 并解释为什么这是问题，以及如何修复</span>
</code></pre>
<p><strong>4. TanStack Query v5 最佳实践</strong></p>
<p>包括 <code>useSuspenseQuery</code> 的限制（不支持 <code>enabled</code>、<code>placeholderData</code>）、乐观更新的正确姿势、<code>queryKey</code> 设计等。</p>
<p><strong>5. PR 复杂度分析脚本</strong></p>
<pre><code class="hljs language-bash" lang="bash">git diff main...HEAD | python scripts/pr-analyzer.py
​
<span class="hljs-comment"># 输出：</span>
<span class="hljs-comment"># ============================================================</span>
<span class="hljs-comment"># PR ANALYSIS REPORT</span>
<span class="hljs-comment"># ============================================================</span>
<span class="hljs-comment"># 📊 SUMMARY</span>
<span class="hljs-comment">#    Files changed: 12</span>
<span class="hljs-comment">#    Additions: +450</span>
<span class="hljs-comment">#    Deletions: -120</span>
<span class="hljs-comment">#    Total changes: 570</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment"># 📏 SIZE: M (Medium)</span>
<span class="hljs-comment">#    Complexity score: 0.45/1.0</span>
<span class="hljs-comment">#    Estimated review time: ~25 minutes</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment"># ⚠️  RISK FACTORS:</span>
<span class="hljs-comment">#    • Security-sensitive file: src/auth/jwt.ts</span>
<span class="hljs-comment">#    • Low test ratio (&lt;20%) - consider adding more tests</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment"># 💡 SUGGESTIONS:</span>
<span class="hljs-comment">#    • Check for proper type usage (avoid 'any')</span>
</code></pre>
<h4 data-id="heading-13">安装方法</h4>
<p><strong>方式 1：直接克隆（推荐）</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 克隆到 skills 目录</span>
git <span class="hljs-built_in">clone</span> https://github.com/tt-a1i/code-review-skill.git ~/.claude/skills/code-review-excellence
​
<span class="hljs-comment"># 验证安装</span>
<span class="hljs-built_in">ls</span> ~/.claude/skills/code-review-excellence/SKILL.md
</code></pre>
<p><strong>方式 2：作为符号链接</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 克隆到任意位置</span>
git <span class="hljs-built_in">clone</span> https://github.com/tt-a1i/code-review-skill.git ~/projects/code-review-skill
​
<span class="hljs-comment"># 创建符号链接</span>
<span class="hljs-built_in">ln</span> -sf ~/projects/code-review-skill ~/.claude/skills/code-review-excellence
</code></pre>
<p><strong>方式 3：项目级安装</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 在项目根目录</span>
<span class="hljs-built_in">mkdir</span> -p .claude/skills
git <span class="hljs-built_in">clone</span> https://github.com/tt-a1i/code-review-skill.git .claude/skills/code-review-excellence
​
<span class="hljs-comment"># 提交到项目仓库，团队共享</span>
git add .claude/
git commit -m <span class="hljs-string">"Add code-review-excellence skill"</span>
</code></pre>
<h4 data-id="heading-14">使用场景</h4>
<p>安装后，这些场景会自动触发 skill：</p>
<pre><code class="hljs language-arduino" lang="arduino">✅ <span class="hljs-string">"帮我审查这段代码"</span>
✅ <span class="hljs-string">"review 这个 PR"</span>
✅ <span class="hljs-string">"检查下有没有安全问题"</span>
✅ <span class="hljs-string">"这段代码有什么问题"</span>
✅ <span class="hljs-string">"帮我 code review"</span>
✅ <span class="hljs-string">"看看这个函数写得怎么样"</span>
✅ <span class="hljs-string">"给些改进建议"</span>
</code></pre>
<h4 data-id="heading-15">与其他 Skill 的区别</h4>
<p>市面上也有其他代码审查相关的 skill，这个有什么不同？</p>








































<table><thead><tr><th>特性</th><th>其他 Skills</th><th>code-review-skill</th></tr></thead><tbody><tr><td>架构</td><td>单文件 1000+ 行</td><td>Progressive Disclosure</td></tr><tr><td>内容深度</td><td>通用建议</td><td>框架特定深度指南</td></tr><tr><td>版本更新</td><td>可能滞后</td><td>React 19 / Vue 3.5 / TQ v5</td></tr><tr><td>资源文件</td><td>通常缺失</td><td>完整的 reference + assets</td></tr><tr><td>Token 效率</td><td>全量加载</td><td>按需加载</td></tr><tr><td>可维护性</td><td>难以更新</td><td>模块化，易于迭代</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-16">开发过程中的坑</h3>
<h4 data-id="heading-17">1. 目录名是 reference/ 不是 references/</h4>
<p>最初照着其他 skill 写，用了 <code>references/</code>（带 s）。结果 Claude Code 找不到文件。</p>
<p>翻了官方规范才发现，标准目录名是 <code>reference/</code>（不带 s）。</p>
<h4 data-id="heading-18">2. 文件引用格式</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># ❌ 错误：反引号格式</span>
See `reference/react.md` <span class="hljs-keyword">for</span> details.
​
<span class="hljs-comment"># ✅ 正确：Markdown 链接格式</span>
See [React Guide](reference/react.md) <span class="hljs-keyword">for</span> details.
</code></pre>
<p>反引号只是展示路径，不会触发加载。Markdown 链接才是按需加载的触发器。</p>
<h4 data-id="heading-19">3. Frontmatter 的 allowed-tools</h4>
<p>这个字段是可选的，但加上后体验更好：</p>
<pre><code class="hljs language-markdown" lang="markdown">allowed-tools:
<span class="hljs-bullet">  -</span> Read
<span class="hljs-bullet">  -</span> Grep
<span class="hljs-bullet">  -</span> Glob
</code></pre>
<p>这些工具会被预批准，Claude 读取代码时不用反复确认权限。</p>
<h3 data-id="heading-20">源码</h3>
<p>完整实现在 GitHub：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2Fcode-review-skill" target="_blank" title="https://github.com/tt-a1i/code-review-skill" ref="nofollow noopener noreferrer">tt-a1i/code-review-skill</a></p>
<p>目录结构：</p>
<pre><code class="hljs language-bash" lang="bash">code-review-skill/
├── SKILL.md              <span class="hljs-comment"># 核心文件 (~180 行)</span>
├── reference/            <span class="hljs-comment"># 深度指南 (按需加载)</span>
│   ├── react.md          <span class="hljs-comment"># React 19 + TanStack Query v5</span>
│   ├── vue.md            <span class="hljs-comment"># Vue 3.5 + Composition API</span>
│   ├── rust.md           <span class="hljs-comment"># 所有权、async、Cancellation Safety</span>
│   ├── typescript.md     <span class="hljs-comment"># 泛型、strict 模式</span>
│   ├── python.md         <span class="hljs-comment"># 类型注解、async/await、pytest</span>
│   ├── common-bugs-checklist.md
│   ├── security-review-guide.md
│   └── code-review-best-practices.md
├── assets/               <span class="hljs-comment"># 模板文件</span>
│   ├── pr-review-template.md
│   └── review-checklist.md
├── scripts/              <span class="hljs-comment"># 工具脚本</span>
│   └── pr-analyzer.py    <span class="hljs-comment"># PR 复杂度分析</span>
├── README.md
├── CONTRIBUTING.md       <span class="hljs-comment"># Skill 开发规范</span>
└── LICENSE
</code></pre>
<h3 data-id="heading-21">总结</h3>
<p>重构这个 skill 的过程，让我对 Claude Code Skills 的设计有了更深的理解：</p>
<ol start="0">
<li><strong>Progressive Disclosure 不是口号</strong>——它是实实在在的 token 优化策略</li>
<li><strong>SKILL.md 要精炼</strong>——控制在 200 行以内，只放必须知道的内容</li>
<li><strong>深度内容放 reference/</strong> ——按需加载，用 Markdown 链接引用</li>
<li><strong>触发词要全面</strong>——覆盖用户的各种表达方式</li>
<li><strong>实际内容要深入</strong>——既然是按需加载，就不用吝啬内容深度</li>
</ol>
<p>一个设计良好的 skill，应该是"激活成本低、使用价值高"。</p>
<p>希望这篇文章能帮到也想开发 Claude Code Skill 的你。</p>
<hr/>
<h3 data-id="heading-22">相关资源</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.anthropic.com%2Fen%2Fdocs%2Fclaude-code%2Fskills" target="_blank" title="https://docs.anthropic.com/en/docs/claude-code/skills" ref="nofollow noopener noreferrer">Claude Code Skills 官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fanthropics%2Fskills" target="_blank" title="https://github.com/anthropics/skills" ref="nofollow noopener noreferrer">Anthropic Skills 规范</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2Fcode-review-skill" target="_blank" title="https://github.com/tt-a1i/code-review-skill" ref="nofollow noopener noreferrer">code-review-skill 源码</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【鸿蒙开发案例篇】传说中的跨设备丝滑协同服务]]></title>    <link>https://juejin.cn/post/7578667193321242687</link>    <guid>https://juejin.cn/post/7578667193321242687</guid>    <pubDate>2025-12-01T11:12:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578667193321242687" data-draft-id="7578667193321226303" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【鸿蒙开发案例篇】传说中的跨设备丝滑协同服务"/> <meta itemprop="keywords" content="HarmonyOS,ArkTS,ArkUI"/> <meta itemprop="datePublished" content="2025-12-01T11:12:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="威哥爱编程"/> <meta itemprop="url" content="https://juejin.cn/user/2242659450109575"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【鸿蒙开发案例篇】传说中的跨设备丝滑协同服务
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2242659450109575/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    威哥爱编程
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-01T11:12:50.000Z" title="Mon Dec 01 2025 11:12:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-01
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是 V 哥。今天我们将深入鸿蒙 6.0（API21）的分布式能力，探讨如何通过<strong>网络协同服务</strong>实现跨设备互通，结合 ArkTS 开发实践，提供一套完整的技术方案与代码示例。</p>
<p>联系V哥获取 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Ftraining%2FclassDetail%2F042cb1cc4d7d44ecbdbd902fd1275dcc%3Ftype%3D1%3Fha_source%3Dhmosclass%26ha_sourceId%3D89000248" target="_blank" title="https://developer.huawei.com/consumer/cn/training/classDetail/042cb1cc4d7d44ecbdbd902fd1275dcc?type=1?ha_source=hmosclass&amp;ha_sourceId=89000248" ref="nofollow noopener noreferrer">鸿蒙学习资料</a></p>
<hr/>
<h3 data-id="heading-0">一、技术背景与核心概念</h3>
<p>鸿蒙系统的<strong>分布式软总线</strong>（Distributed Soft Bus）是跨设备协同的底层基石，它通过近场感知、设备发现与连接管理，实现了设备间的低功耗、高速率通信。而**远程过程调用（RPC）**是上层应用实现跨设备功能的核心接口，其通过软总线驱动完成数据传输与接口调用。</p>
<p>关键流程：<br/>
<strong>设备发现 → 服务注册 → RPC 接口绑定 → 跨设备方法调用 → 数据同步</strong></p>
<hr/>
<h3 data-id="heading-1">二、开发环境配置</h3>
<p>在 <code>module.json5</code> 中添加必要依赖与权限：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"module"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"dependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"@ohos.distributedHardware.distributedDeviceManager"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^1.0"</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 设备管理模块</span>
      <span class="hljs-attr">"@ohos.app.ability.featureAbility"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^1.0"</span><span class="hljs-punctuation">,</span>                    <span class="hljs-comment">// Ability 调用</span>
      <span class="hljs-attr">"@ohos.rpc"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^1.0"</span>                                            <span class="hljs-comment">// RPC 核心接口</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"requestPermissions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ohos.permission.DISTRIBUTED_DEVICE_STATE_CHANGE"</span>    <span class="hljs-comment">// 监听设备状态</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ohos.permission.GET_DISTRIBUTED_DEVICE_INFO"</span>       <span class="hljs-comment">// 获取设备信息</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<hr/>
<h3 data-id="heading-2">三、核心实现步骤（ArkTS 案例）</h3>
<h4 data-id="heading-3">场景说明：</h4>
<p>实现一个跨设备文本同步功能，例如在手机端输入文字，实时显示在平板端。</p>
<hr/>
<h4 data-id="heading-4"><strong>步骤 1：设备发现与连接管理</strong></h4>
<p>使用 <code>DistributedDeviceManager</code>（简称 DDM）获取目标设备的 <code>NetworkId</code>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> deviceManager <span class="hljs-keyword">from</span> <span class="hljs-string">'@ohohs.distributedHardware.distributedDeviceManager'</span>;

<span class="hljs-comment">// 初始化设备管理器</span>
<span class="hljs-keyword">const</span> dm = deviceManager.<span class="hljs-title function_">getDistributedDeviceManager</span>(<span class="hljs-title function_">getContext</span>(<span class="hljs-variable language_">this</span>) <span class="hljs-keyword">as</span> common.<span class="hljs-property">UIAbilityContext</span>);

<span class="hljs-comment">// 监听设备变化（如新增/断开设备）</span>
dm.<span class="hljs-title function_">on</span>(<span class="hljs-string">'deviceChange'</span>, <span class="hljs-function">(<span class="hljs-params">deviceInfo: deviceManager.DeviceInfo[]</span>) =&gt;</span> {
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> info <span class="hljs-keyword">of</span> deviceInfo) {
    <span class="hljs-keyword">if</span> (info.<span class="hljs-property">deviceType</span> === deviceManager.<span class="hljs-property">DeviceType</span>.<span class="hljs-property">TAB</span>) { <span class="hljs-comment">// 假设目标设备是平板</span>
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'发现目标设备:'</span>, info.<span class="hljs-property">networkId</span>);
      <span class="hljs-comment">// 触发后续服务绑定逻辑</span>
    }
  }
});
</code></pre>
<hr/>
<h4 data-id="heading-5"><strong>步骤 2：服务端接口定义与注册</strong></h4>
<p>服务端（如平板设备）需定义一个远程服务接口，用于接收客户端（手机）的文本数据。</p>
<p>1.<strong>定义远程服务接口（Stub）</strong>
创建一个继承自 <code>RemoteObject</code> 的服务端类，实现 <code>onRemoteMessageRequest</code> 方法：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> rpc <span class="hljs-keyword">from</span> <span class="hljs-string">'@ohos.rpc'</span>;

<span class="hljs-keyword">class</span> <span class="hljs-title class_">TextSyncStub</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">rpc.RemoteObject</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">descriptor: <span class="hljs-built_in">string</span></span>) {
    <span class="hljs-variable language_">super</span>(descriptor); <span class="hljs-comment">// 接口标识符，需与客户端一致</span>
  }

  <span class="hljs-comment">// 处理客户端发送的文本数据</span>
  <span class="hljs-title function_">onRemoteMessageRequest</span>(<span class="hljs-attr">code</span>: <span class="hljs-built_in">number</span>, <span class="hljs-attr">data</span>: rpc.<span class="hljs-property">MessageSequence</span>, <span class="hljs-attr">reply</span>: rpc.<span class="hljs-property">MessageSequence</span>, <span class="hljs-attr">option</span>: rpc.<span class="hljs-property">MessageOption</span>): <span class="hljs-built_in">boolean</span> | <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">boolean</span>&gt; {
    <span class="hljs-keyword">if</span> (code === <span class="hljs-number">1</span>) { <span class="hljs-comment">// 自定义方法标识码</span>
      <span class="hljs-keyword">const</span> receivedText = data.<span class="hljs-title function_">readString</span>(); <span class="hljs-comment">// 读取客户端发送的文本</span>
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'服务端接收到文本:'</span>, receivedText);
      <span class="hljs-comment">// 在本地 UI 中更新文本（示例）</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">onTextReceived</span>(receivedText);
      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }

  <span class="hljs-comment">// 本地回调：更新 UI（需结合 Ability 生命周期）</span>
  <span class="hljs-title function_">onTextReceived</span>(<span class="hljs-params">text: <span class="hljs-built_in">string</span></span>) {
    <span class="hljs-comment">// 示例：更新 UIAbility 中的 @State 变量</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">textContent</span> = text;
  }
}
</code></pre>
<p>2.<strong>在服务端 Ability 中注册服务</strong>
服务端 Ability 需通过 <code>SAMgr</code>（系统能力管理器）注册服务：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> rpc <span class="hljs-keyword">from</span> <span class="hljs-string">'@ohos.rpc'</span>;
<span class="hljs-keyword">import</span> featureAbility <span class="hljs-keyword">from</span> <span class="hljs-string">'@ohos.app.ability.featureAbility'</span>;

<span class="hljs-meta">@Entry</span>
<span class="hljs-meta">@Component</span>
struct <span class="hljs-title class_">TextSyncServer</span> {
  <span class="hljs-keyword">private</span> <span class="hljs-attr">stub</span>: <span class="hljs-title class_">TextSyncStub</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;

  <span class="hljs-title function_">aboutToAppear</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 创建 Stub 实例</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">stub</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TextSyncStub</span>(<span class="hljs-string">'com.example.textsync.service'</span>);
    <span class="hljs-comment">// 注册系统能力（System Ability）</span>
    featureAbility.<span class="hljs-title function_">registerSystemAbility</span>(<span class="hljs-number">1001</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">stub</span>); <span class="hljs-comment">// 1001 为自定义的 SA ID</span>
  }
}
</code></pre>
<hr/>
<h4 data-id="heading-6"><strong>步骤 3：客户端绑定服务并发送数据</strong></h4>
<p>客户端（如手机）通过 <code>NetworkId</code> 绑定服务端的远程服务，并调用其接口发送数据。</p>
<p>1.<strong>绑定服务端 Ability</strong>
客户端需构造 <code>Want</code> 对象，指定目标设备的 <code>NetworkId</code> 与服务描述符：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> rpc <span class="hljs-keyword">from</span> <span class="hljs-string">'@ohos.rpc'</span>;
<span class="hljs-keyword">import</span> featureAbility <span class="hljs-keyword">from</span> <span class="hljs-string">'@ohos.app.ability.featureAbility'</span>;

<span class="hljs-comment">// 获取目标设备 NetworkId（通过 DDM 发现）</span>
<span class="hljs-keyword">const</span> targetNetworkId = <span class="hljs-string">'12:34:56:78:90:AB'</span>; <span class="hljs-comment">// 示例设备 ID</span>

<span class="hljs-comment">// 构造 Want 对象</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">want</span>: <span class="hljs-title class_">Want</span> = {
  <span class="hljs-attr">deviceId</span>: targetNetworkId, <span class="hljs-comment">// 目标设备 ID</span>
  <span class="hljs-attr">bundleName</span>: <span class="hljs-string">'com.example.textsync'</span>, <span class="hljs-comment">// 服务端应用包名</span>
  <span class="hljs-attr">abilityName</span>: <span class="hljs-string">'TextSyncServer'</span>, <span class="hljs-comment">// 服务端 Ability 名称</span>
  <span class="hljs-attr">parameters</span>: {
    <span class="hljs-comment">// 可选参数</span>
  }
};

<span class="hljs-comment">// 绑定服务</span>
featureAbility.<span class="hljs-title function_">connectAbility</span>(want, {
  <span class="hljs-attr">onConnect</span>: <span class="hljs-function">(<span class="hljs-params">proxy: rpc.RemoteObject</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'客户端绑定服务成功:'</span>, proxy);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">proxy</span> = proxy; <span class="hljs-comment">// 保存代理对象</span>
  },
  <span class="hljs-attr">onDisconnect</span>: <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">'服务连接断开'</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">proxy</span> = <span class="hljs-literal">null</span>;
  },
  <span class="hljs-attr">onFailed</span>: <span class="hljs-function">(<span class="hljs-params">errCode: <span class="hljs-built_in">number</span></span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'绑定服务失败，错误码:'</span>, errCode);
  }
});
</code></pre>
<p>2.<strong>通过 Proxy 调用远程方法</strong>
客户端通过代理对象 <code>proxy</code> 调用服务端方法，发送文本数据：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 发送文本到服务端</span>
<span class="hljs-keyword">async</span> <span class="hljs-title function_">sendTextToServer</span>(<span class="hljs-params">text: <span class="hljs-built_in">string</span></span>) {
  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">proxy</span>) {
    <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">new</span> rpc.<span class="hljs-title class_">MessageSequence</span>();
    <span class="hljs-keyword">const</span> reply = <span class="hljs-keyword">new</span> rpc.<span class="hljs-title class_">MessageSequence</span>();
    data.<span class="hljs-title function_">writeString</span>(text); <span class="hljs-comment">// 将文本写入数据包</span>
    <span class="hljs-comment">// 调用服务端方法（code 为 1，需与服务端一致）</span>
    <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">proxy</span>.<span class="hljs-title function_">sendMessageRequest</span>(<span class="hljs-number">1</span>, data, reply);
    <span class="hljs-keyword">if</span> (result) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'发送成功'</span>);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'发送失败'</span>);
    }
  }
}
</code></pre>
<hr/>
<h3 data-id="heading-7">四、完整 UI 交互案例</h3>
<h4 data-id="heading-8">服务端 UI（平板端）</h4>
<p>展示接收到的文本：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Component</span>
struct <span class="hljs-title class_">TextDisplay</span> {
  <span class="hljs-meta">@State</span> <span class="hljs-attr">text</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span>;

  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">Column</span>() {
      <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">text</span>)
        .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">30</span>)
        .<span class="hljs-title function_">textAlign</span>(<span class="hljs-title class_">TextAlign</span>.<span class="hljs-property">Center</span>)
        .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)
        .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)
    }
  }
}
</code></pre>
<h4 data-id="heading-9">客户端 UI（手机端）</h4>
<p>输入文本并发送：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Component</span>
struct <span class="hljs-title class_">TextInput</span> {
  <span class="hljs-meta">@State</span> <span class="hljs-attr">inputText</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span>;
  <span class="hljs-keyword">private</span> <span class="hljs-attr">proxy</span>: rpc.<span class="hljs-property">RemoteObject</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;

  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">Column</span>() {
      <span class="hljs-title class_">TextInput</span>({ <span class="hljs-attr">placeholder</span>: <span class="hljs-string">'输入文本'</span> })
        .<span class="hljs-title function_">onChange</span>(<span class="hljs-function">(<span class="hljs-params">value: <span class="hljs-built_in">string</span></span>) =&gt;</span> {
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">inputText</span> = value;
        })
      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'发送到平板'</span>)
        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">sendTextToServer</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">inputText</span>);
        })
    }
  }
}
</code></pre>
<hr/>
<h3 data-id="heading-10">五、关键注意事项与性能优化</h3>
<p>1.<strong>设备兼容性</strong></p>
<ul>
<li>确保目标设备已开启超级终端功能，并且网络状态正常。</li>
<li>检查目标设备是否支持鸿蒙 6.0 及其 API 特性。</li>
</ul>
<p>2.<strong>软总线连接稳定性</strong></p>
<ul>
<li>通过 <code>DistributedDeviceManager</code> 监听设备状态变化，动态断开或重连。</li>
<li>使用 <code>onDisconnect</code> 回调处理异常断开情况。</li>
</ul>
<p>3.<strong>数据序列化与反序列化</strong></p>
<ul>
<li>通过 <code>MessageSequence</code> 传递数据时，需保证客户端与服务端的字段类型与顺序一致。</li>
<li>对于复杂数据（如 PixelMap），需通过 <code>Parcel</code> 接口实现自定义序列化。</li>
</ul>
<p>4.<strong>性能优化</strong></p>
<ul>
<li><strong>减少跨设备传输的数据量</strong>：对大图片等数据，建议在客户端进行压缩后再发送。</li>
<li><strong>异步处理</strong>：服务端的 <code>onRemoteMessageRequest</code> 方法应尽量异步处理数据，避免阻塞主线程。</li>
<li><strong>连接复用</strong>：避免频繁建立与断开连接，可缓存已连接的 <code>proxy</code> 对象。</li>
</ul>
<hr/>
<h3 data-id="heading-11">六、扩展场景：跨设备图片同步</h3>
<p>结合前文提到的 <code>PixelMap</code> 处理能力，可进一步实现图片的跨设备同步：
1.客户端将 <code>PixelMap</code> 转为 <code>ArrayBuffer</code>（通过 <code>getPixelBytes()</code>）。
2.使用 <code>MessageSequence</code> 的 <code>writeArrayBuffer()</code> 方法发送。
3.服务端通过 <code>readArrayBuffer()</code> 接收，并用 <code>image.createPixelMap()</code> 重建图像。</p>
<hr/>
<h3 data-id="heading-12">总结</h3>
<p>通过鸿蒙 6.0 的网络协同服务（RPC + 软总线），开发者可以轻松实现跨设备的数据互通。关键在于：</p>
<ul>
<li><strong>服务端</strong>：定义并注册远程接口（Stub），处理来自客户端的请求。</li>
<li><strong>客户端</strong>：发现设备、绑定服务（Proxy），并调用其方法发送数据。</li>
</ul>
<p>我是 V 哥，下期将解析如何结合分布式软总线与 <code>PixelMap</code> 实现<strong>跨设备实时滤镜同步</strong>（如手机拍摄后实时推送到平板渲染）。如果你在跨设备通信中遇到问题，欢迎在评论区留言，我们共同探讨！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5d164105cb6e46d4be0cbe886a787208~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aiB5ZOl54ix57yW56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765192370&amp;x-signature=Pf2hAxh0CBRN%2Fyi4Cg1u5L2Tdy0%3D" alt="WX20250512-113156@2x.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Cloudflare unwrap崩溃？整理下Rust危险操作]]></title>    <link>https://juejin.cn/post/7578681104292249643</link>    <guid>https://juejin.cn/post/7578681104292249643</guid>    <pubDate>2025-12-01T11:15:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578681104292249643" data-draft-id="7578697614390214662" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" Cloudflare unwrap崩溃？整理下Rust危险操作"/> <meta itemprop="keywords" content="Rust"/> <meta itemprop="datePublished" content="2025-12-01T11:15:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="大鱼七成饱"/> <meta itemprop="url" content="https://juejin.cn/user/3017475369480509"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             Cloudflare unwrap崩溃？整理下Rust危险操作
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3017475369480509/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    大鱼七成饱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-01T11:15:16.000Z" title="Mon Dec 01 2025 11:15:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-01
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<p>这是Rust九九八十一难第十五篇。之前聊过<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FvQB7YYq9t_oI4tl1DeqGVA" target="_blank" title="https://mp.weixin.qq.com/s/vQB7YYq9t_oI4tl1DeqGVA" ref="nofollow noopener noreferrer">anyhow</a>，也介绍了<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FNoBG_qdz4EX6VjZFkG7wUA" target="_blank" title="https://mp.weixin.qq.com/s/NoBG_qdz4EX6VjZFkG7wUA" ref="nofollow noopener noreferrer">thiserror</a>，感觉差不多了，没想爆出了Cloudflare的新闻。猜测很多，据说有一个原因是用了<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.infoq.cn%2Farticle%2FffrEqagbhIfAyitqzN7C%3Futm_source%3Dchatgpt.com" target="_blank" title="https://www.infoq.cn/article/ffrEqagbhIfAyitqzN7C?utm_source=chatgpt.com" ref="nofollow noopener noreferrer">unwrap</a>。这个前车之鉴，给了一个提醒，比如Rust还有哪些危险操作，为什么catch_unwind抓不到崩溃，能否自动化检查等。因此今天梳理下Rust代码的危险操作。</p>
<h2 data-id="heading-1">一、危险操作一览</h2>
<p>先定个标准，按照受控程度区分。受控程度是指代码不可预测，有安全漏洞，代码可控的停止等。这里先排除带有usafe关键字的，因为关键字本身就说明了问题。梳理了下，从低到高，大体分为下面三类。</p>
<h3 data-id="heading-2">1、低危险</h3>
<h4 data-id="heading-3">1.1、 乱用clone</h4>
<p>大部分情况没问题，clone本身不会产生UB，也没有panic。但是乱用可能埋下性能炸弹，而且很隐蔽。</p>
<ul>
<li>
<p>原因</p>
<ul>
<li>
<p>大对象clone：有些类型的clone是深拷贝，比如<code>let b = a.clone();</code>。如果a是<code>Vec&lt;T&gt;</code>（大量数据），<code>Arc&lt;Mutex&lt;T&gt;&gt;</code> 内含大结构，自定义 struct 里包了大对象。clone() 会 <strong>重新分配内存 + 复制一整份数据</strong>，导致内存不足，程序延迟跳变、吞吐下降，一般的cr，很难识别，明面上看不出来。</p>
</li>
<li>
<p>高并发场景频繁 clone Arc ：多线程下都要原子性地更新<strong>同一个内存地址</strong>上的计数器，则有线程不得不等待原子操作完成和同步缓存，这个时间本来应该处理业务逻辑。</p>
</li>
<li>
<p>多线程复制锁：原子操作很昂贵，尤其是锁结构clone，会增加更多内存共享冲突。</p>
</li>
</ul>
</li>
<li>
<p>乱用的例子</p>
<ul>
<li>逃避问题</li>
</ul>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">foo</span>(s: &amp;<span class="hljs-type">String</span>) {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">x</span> = s.<span class="hljs-title function_ invoke__">clone</span>(); <span class="hljs-comment">// 逃生命周期问题</span>
}
</code></pre>
<p>说明：一般没问题，但是属于逃避问题，避开rust生命周期检查</p>
<ul>
<li>
<p>循环内clone,造成性能灾难</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">for</span> <span class="hljs-variable">_</span> <span class="hljs-keyword">in</span> <span class="hljs-number">0</span>..<span class="hljs-number">10000</span> {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">v2</span> = v.<span class="hljs-title function_ invoke__">clone</span>(); <span class="hljs-comment">// 大对象向量复制一万次</span>
}
</code></pre>
</li>
</ul>
</li>
</ul>
<h4 data-id="heading-4">1.2、整数溢出（wrapping）</h4>
<p>这个一出，在Debug 模式下会 panic，但是在 <strong>Release</strong> 模式下，整数算术会<strong>环绕</strong> (wrapping) 而不报错，导致结果不正确（逻辑错误）。举个例子：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">size</span> = a * b;  <span class="hljs-comment">// 溢出</span>
<span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">ptr</span> = <span class="hljs-title function_ invoke__">alloc</span>(size);  <span class="hljs-comment">// size可能是负数，0等，分配错误大小， 内存被破坏</span>
</code></pre>
<p>可以用下面方案替，（也有乘除等类似的api，可以问下ai，很容易查到）：</p>
<ul>
<li>
<p><code>checked_add</code>，溢出则返回None，安全地失败</p>
</li>
<li>
<p><code>overflowing_add</code>，会返回布尔值报告是否有溢出</p>
</li>
<li>
<p><code>saturating_add</code>：溢出的话会限制到最大或者最小值上，不会painic和环绕</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">safe_overflow_demo</span>() {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">max</span> = <span class="hljs-type">i32</span>::MAX;
    <span class="hljs-keyword">match</span> max.<span class="hljs-title function_ invoke__">checked_add</span>(<span class="hljs-number">1</span>) {
        <span class="hljs-title function_ invoke__">Some</span>(v) =&gt; <span class="hljs-built_in">println!</span>(<span class="hljs-string">"v={}"</span>, v),
        <span class="hljs-literal">None</span> =&gt; <span class="hljs-built_in">println!</span>(<span class="hljs-string">"overflow detected"</span>), <span class="hljs-comment">//overflow detected</span>
    }
}
</code></pre>
</li>
</ul>
<h3 data-id="heading-5">2、中危险</h3>
<p>运行的时候崩溃等，都是可预期的，不会破坏内存结构和编译器假设的规则。</p>
<h4 data-id="heading-6">2.1、expect()</h4>
<p>它<code>unwrap()</code> 一样会 panic，只是能自定义错误信息。用于用于快速原型和Demo，但线上不应该使用。</p>
<p>可以使用使用 <code>?</code>者显式错误处理（<code>match</code>、<code>map_err</code>）</p>
<ul>
<li>
<p>demo</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">expect_demo</span>() <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;(), <span class="hljs-type">String</span>&gt; {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">num</span>: <span class="hljs-type">i32</span> = <span class="hljs-string">"abc"</span>.<span class="hljs-title function_ invoke__">parse</span>().<span class="hljs-title function_ invoke__">map_err</span>(|e| e.<span class="hljs-title function_ invoke__">to_string</span>())?; <span class="hljs-comment">// 正确处理错误</span>
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"num = {}"</span>, num);
    <span class="hljs-title function_ invoke__">Ok</span>(())
}
</code></pre>
</li>
</ul>
<h4 data-id="heading-7">2.2、 panic!()</h4>
<p>调用这个API程序立刻崩溃，生成 unwinding（除非 panic=abort）。一般调试时使用。不适合生产系统流程控制。可以用 <code>Result&lt;T, E&gt;</code> 返回错误，或者使用错误库：<code>thiserror</code>、<code>anyhow</code>，之前文章介绍过。</p>
<ul>
<li>Demo</li>
</ul>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">safe_panic_demo</span>(input: <span class="hljs-type">Option</span>&lt;<span class="hljs-type">i32</span>&gt;) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;<span class="hljs-type">i32</span>, <span class="hljs-type">String</span>&gt; {
    <span class="hljs-keyword">match</span> input {
        <span class="hljs-title function_ invoke__">Some</span>(v) =&gt; <span class="hljs-title function_ invoke__">Ok</span>(v),
        <span class="hljs-literal">None</span> =&gt; <span class="hljs-title function_ invoke__">Err</span>(<span class="hljs-string">"input is None"</span>.<span class="hljs-title function_ invoke__">to_string</span>()),
    }
}
</code></pre>
<h4 data-id="heading-8">2.3、数组越界</h4>
<p>这个有两种操作： 使用 <code>[]</code> (Panic)是safe越界 ，使用 <code>get_unchecked()</code>或者<code>*v.as_ptr().add(i)</code> unsafe操作可能导致UB。据说越界访问是Rust最常见的UB来源。</p>
<ul>
<li>
<p>Demo</p>
<pre><code class="hljs language-Rust" lang="Rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">v</span>: <span class="hljs-type">Vec</span>&lt;<span class="hljs-type">i32</span>&gt; = <span class="hljs-built_in">vec!</span>[<span class="hljs-number">10</span>, <span class="hljs-number">20</span>, <span class="hljs-number">30</span>];
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">index_safe</span>: <span class="hljs-type">usize</span> = <span class="hljs-number">1</span>;
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">index_oob</span>: <span class="hljs-type">usize</span> = <span class="hljs-number">5</span>; <span class="hljs-comment">// 越界索引，有效范围是 0..3</span>

    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"--- 1. 安全访问方法 (Safe Access) ---"</span>);

    <span class="hljs-comment">// 1.1. `v.get(x)` -&gt; 返回 `Option&lt;T&gt;`，安全地处理越界</span>
    <span class="hljs-keyword">match</span> v.<span class="hljs-title function_ invoke__">get</span>(index_safe) {
        <span class="hljs-title function_ invoke__">Some</span>(val) =&gt; <span class="hljs-built_in">println!</span>(<span class="hljs-string">"v.get({}) (安全, 有效): {}"</span>, index_safe, val),
        <span class="hljs-literal">None</span> =&gt; <span class="hljs-built_in">println!</span>(<span class="hljs-string">"v.get({}) (安全, 越界): 返回 None"</span>, index_safe),
    }

    <span class="hljs-keyword">match</span> v.<span class="hljs-title function_ invoke__">get</span>(index_oob) {
        <span class="hljs-title function_ invoke__">Some</span>(val) =&gt; <span class="hljs-built_in">println!</span>(<span class="hljs-string">"v.get({}) (安全, 有效): {}"</span>, index_oob, val),
        <span class="hljs-literal">None</span> =&gt; <span class="hljs-built_in">println!</span>(<span class="hljs-string">"v.get({}) (安全, 越界): 返回 None, 程序继续"</span>, index_oob),
    }

    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"\n--- 2. 运行时检查访问方法 (Runtime Panic) ---"</span>);

    <span class="hljs-comment">// 2.1. `v[x]` -&gt; 越界时触发 `panic!`，中止程序</span>
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"v[{}] (安全, 有效): {}"</span>, index_safe, v[index_safe]);

    <span class="hljs-comment">// 取消注释下方代码块以观察 panic! 行为</span>
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"尝试 v[{}] (越界, panic)..."</span>, index_oob);
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">_val_panic</span> = v[index_oob]; <span class="hljs-comment">//index out of bounds: the len is 3 but the index is 5</span>
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"此行不会被执行"</span>);
}
</code></pre>
</li>
</ul>
<h3 data-id="heading-9">3、极度危险</h3>
<p>包含 跳过检查取值，原始指针（*mut T、*const T）操作（unsafe操作就不介绍了）等</p>
<h4 data-id="heading-10">3.1、unwrap_unchecked()</h4>
<p>这个操作<strong>跳过检查</strong>，直接取值，<strong>如果是 None 会导致 UB（未定义行为）</strong>，不是普通 panic。主要在极少数高性能场景，如编译器内部、手工优化代码。</p>
<ul>
<li>
<p>替代方案</p>
<ul>
<li>
<p>不推荐使用，99.9% 情况不需要。</p>
</li>
<li>
<p>使用普通 <code>unwrap()</code> 和开发环境 panic 更安全。</p>
</li>
</ul>
</li>
<li>
<p>Demo（仅示意，不要用）</p>
</li>
</ul>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">unsafe</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">unchecked_demo</span>() <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">i32</span> {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">x</span>: <span class="hljs-type">Option</span>&lt;<span class="hljs-type">i32</span>&gt; = <span class="hljs-title function_ invoke__">Some</span>(<span class="hljs-number">10</span>);
    x.<span class="hljs-title function_ invoke__">unwrap_unchecked</span>()
}
</code></pre>
<h4 data-id="heading-11">3.2、 mem::transmute</h4>
<p><code>mem::transmute</code> 被认为是极度危险（Rust unsafe 中最危险的之一）。它会 <strong>完全跳过 Rust 的类型系统</strong>，把一个值的 原始内存比特强行解释成另一种类型，而编译器不会检查是否合理。适用于底层优化、ABI 对接。可以用枚举/结构体替代表达，者用 From / TryFrom。</p>
<ul>
<li>Demo（安全替代版）</li>
</ul>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">safe_transmute_demo</span>() <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;<span class="hljs-type">u8</span>, <span class="hljs-type">String</span>&gt; {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">x</span>: <span class="hljs-type">i32</span> = <span class="hljs-number">150</span>;
    <span class="hljs-type">u8</span>::<span class="hljs-title function_ invoke__">try_from</span>(x).<span class="hljs-title function_ invoke__">map_err</span>(|_| <span class="hljs-string">"overflow"</span>.<span class="hljs-title function_ invoke__">to_string</span>())
}
</code></pre>
<ul>
<li>替代方案表</li>
</ul>








































<table><thead><tr><th>想做的事</th><th>不要用</th><th>应该用</th></tr></thead><tbody><tr><td>数字 → 字节数组</td><td><code>transmute</code></td><td><code>.to_ne_bytes()</code></td></tr><tr><td>&amp;T → &amp;U</td><td><code>transmute</code></td><td><code>reinterpret_cast</code> 方案：<code>ptr.cast()</code></td></tr><tr><td>类型安全转换</td><td><code>transmute</code></td><td><code>From</code> / <code>Into</code> / <code>TryFrom</code></td></tr><tr><td>C ABI struct 转换</td><td><code>transmute</code></td><td><code>#[repr(C)]</code> + 指针转换</td></tr><tr><td>Option&lt;Box&gt; 优化大小</td><td><code>transmute</code></td><td><code>Option::take</code> 或 <code>ManuallyDrop</code></td></tr><tr><td>枚举表示（discriminant）操作</td><td><code>transmute</code></td><td><code>std::mem::discriminant</code></td></tr></tbody></table>
<h2 data-id="heading-12">二、catch_unwind为什么有时候捕获不到崩溃</h2>
<p>一般使用panic::catch_unwind捕获panic，std::panic::set_hook用于记录日志和堆栈，GDB/LLDB等记录系统外的崩溃。只有catch_unwind会优雅处理错误，保持服务运行，主要说下这个。</p>
<h3 data-id="heading-13">1、panic::catch_unwind 是如何工作的？</h3>
<ul>
<li>
<p>panic 可以理解成是“强制异常 + 栈回退”，他会执行 栈展开（stack unwinding），逐层 drop 栈上的变量，若无法继续展开，则进程 abort。</p>
</li>
<li>
<p>Rust是怎么 “展开” 栈的，什么是uwind</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">a</span>() { <span class="hljs-title function_ invoke__">b</span>(); }
<span class="hljs-keyword">fn</span> <span class="hljs-title function_">b</span>() { <span class="hljs-title function_ invoke__">c</span>(); }
<span class="hljs-keyword">fn</span> <span class="hljs-title function_">c</span>() { <span class="hljs-built_in">panic!</span>(<span class="hljs-string">"boom"</span>); }

<span class="hljs-title function_ invoke__">a</span>();
</code></pre>
<pre><code class="hljs language-markdown" lang="markdown">┌──────────┐
│  a()     │
└───▲──────┘
<span class="hljs-code">    │ calls
┌───┴──────┐
│  b()     │
└───▲──────┘
    │ calls
┌───┴──────┐
│  c()     │   ← panic 发生
└──────────┘
</span></code></pre>
<p>unwind是这样做的:</p>
<ul>
<li>
<p>c() 退出 → drop c 中的变量</p>
</li>
<li>
<p>回到 b() → drop b 中的变量</p>
</li>
<li>
<p>回到 a() → drop a 中的变量</p>
</li>
<li>
<p>若某处有 <code>catch_unwind</code>，停止回退</p>
</li>
<li>
<p>否则退到线程根并结束线程</p>
</li>
</ul>
<p>每一步都是 <strong>栈帧被弹出（pop stack frame）</strong>，并执行对应资源释放逻辑。</p>
<p>这就是 “展开（unwind）”。</p>
</li>
<li>
<p>增加catch_unwind 后：它捕获当前线程中的 正常 panic 展开（unwind），返回 <code>Result&lt;(), Box&lt;dyn Any + Send&gt;&gt;</code></p>
</li>
</ul>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">use</span> std::panic;

<span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">result</span> = panic::<span class="hljs-title function_ invoke__">catch_unwind</span>(|| {
    <span class="hljs-built_in">panic!</span>(<span class="hljs-string">"boom"</span>);
});

<span class="hljs-built_in">assert!</span>(result.<span class="hljs-title function_ invoke__">is_err</span>());
</code></pre>
<h3 data-id="heading-14">2、捕获不到场景</h3>
<h4 data-id="heading-15">2.1、panic 被设置为 abort</h4>
<p>Cargo.toml：</p>
<pre><code class="hljs language-toml" lang="toml"><span class="hljs-section">[profile.release]</span>
<span class="hljs-attr">panic</span> = <span class="hljs-string">"abort"</span>
</code></pre>
<p>这时候代码既不 unwind，也不执行 drop，进程直接终止了，catch_unwind 根本没机会执行。</p>
<h4 data-id="heading-16">2.2、跨语言</h4>
<p>panic 发生在跨 FFI／外部库边界，尤其是与非-Rust 语言交互（例如 C 或 C++）时 → unwind → abort 行为不确定 → catch_unwind 未必捕获到。<a href="https://link.juejin.cn?target=https%3A%2F%2Fdoc.rust-lang.org%2Fstd%2Fpanic%2Ffn.catch_unwind.html" target="_blank" title="https://doc.rust-lang.org/std/panic/fn.catch_unwind.html" ref="nofollow noopener noreferrer">doc.rust-lang.org/std/panic/f…</a></p>
<h4 data-id="heading-17">2.3、unsafe 导致的 UB 可能不被 catch_unwind 捕获</h4>
<p>当在 <code>unsafe</code> 中触发 UB（例如用裸指针非法读写、悬垂引用、违反借用/别名规则、数据竞争、对齐错误等）——这在语言层面没有定义语义。这可能产生任意行为：程序挂掉、数据破损、继续运行但状态破坏、内存泄漏……这类错误<strong>不走 panic/unwind</strong> 机制 ，它们不是 “panic! unwind” 的流程。UB本身代表未定义的结果，不好确定代码流程，那么也不一定捕获到，大概率捕获不到。</p>
<h2 data-id="heading-18">三、第三方抓取工具</h2>
<h3 data-id="heading-19">1、FutureExt</h3>
<p>相比原生的，它可以直接在 async Future 上捕获 panic，支持链式打印等。</p>
<p>地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Frust-lang%2Ffutures-rs%3Futm_source%3Dchatgpt.com" target="_blank" title="https://github.com/rust-lang/futures-rs?utm_source=chatgpt.com" ref="nofollow noopener noreferrer">github.com/rust-lang/f…</a></p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">use</span> futures::FutureExt; <span class="hljs-comment">// 0.3.5</span>

<span class="hljs-meta">#[tokio::test]</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">test_async</span>() <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;(), <span class="hljs-type">Box</span>&lt;<span class="hljs-keyword">dyn</span> std::error::Error&gt;&gt; {
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"before catch_unwind"</span>);

    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">may_panic</span> = <span class="hljs-keyword">async</span> {
        <span class="hljs-built_in">println!</span>(<span class="hljs-string">"inside async catch_unwind"</span>);
        <span class="hljs-built_in">panic!</span>(<span class="hljs-string">"this is error"</span>)
    };

    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">async_result</span> = may_panic.<span class="hljs-title function_ invoke__">catch_unwind</span>().<span class="hljs-keyword">await</span>;

    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"after catch_unwind"</span>);

    <span class="hljs-built_in">assert!</span>(async_result.<span class="hljs-title function_ invoke__">is_ok</span>());

    <span class="hljs-title function_ invoke__">Ok</span>(())
}
</code></pre>
<p>future 内部 的panic 被 <code>catch_unwind</code> 捕获 转为 <code>Result::Err</code></p>
<h3 data-id="heading-20">2、tower http的catch-panic</h3>
<p>中间件来捕获 handler 中 panic，并给客户端返回合适的 HTTP 错误响应（例如 500）</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.rs%2Ftower-http%2Flatest%2Ftower_http%2Fcatch_panic%2Findex.html" target="_blank" title="https://docs.rs/tower-http/latest/tower_http/catch_panic/index.html" ref="nofollow noopener noreferrer">docs.rs/tower-http/…</a></p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">use</span> http::{Request, Response, header::HeaderName};
<span class="hljs-keyword">use</span> std::convert::Infallible;
<span class="hljs-keyword">use</span> tower::{Service, ServiceExt, ServiceBuilder, service_fn};
<span class="hljs-keyword">use</span> tower_http::catch_panic::CatchPanicLayer;
<span class="hljs-keyword">use</span> http_body_util::Full;
<span class="hljs-keyword">use</span> bytes::Bytes;

<span class="hljs-keyword">async</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">handle</span>(req: Request&lt;Full&lt;Bytes&gt;&gt;) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;Response&lt;Full&lt;Bytes&gt;&gt;, Infallible&gt; {
    <span class="hljs-built_in">panic!</span>(<span class="hljs-string">"something went wrong..."</span>)
}

<span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">svc</span> = ServiceBuilder::<span class="hljs-title function_ invoke__">new</span>()
    <span class="hljs-comment">// Catch panics and convert them into responses.</span>
    .<span class="hljs-title function_ invoke__">layer</span>(CatchPanicLayer::<span class="hljs-title function_ invoke__">new</span>())
    .<span class="hljs-title function_ invoke__">service_fn</span>(handle);

<span class="hljs-comment">// Call the service.</span>
<span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">request</span> = Request::<span class="hljs-title function_ invoke__">new</span>(Full::<span class="hljs-title function_ invoke__">default</span>());

<span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">response</span> = svc.<span class="hljs-title function_ invoke__">ready</span>().<span class="hljs-keyword">await</span>?.<span class="hljs-title function_ invoke__">call</span>(request).<span class="hljs-keyword">await</span>?;

<span class="hljs-built_in">assert_eq!</span>(response.<span class="hljs-title function_ invoke__">status</span>(), <span class="hljs-number">500</span>);
</code></pre>
<p>axum也可用哈：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftokio-rs%2Faxum%2Fdiscussions%2F1865%3Futm_source%3Dchatgpt.com" target="_blank" title="https://github.com/tokio-rs/axum/discussions/1865?utm_source=chatgpt.com" ref="nofollow noopener noreferrer">github.com/tokio-rs/ax…</a></p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">tower-http</span> = { version = <span class="hljs-string">"0.5"</span>, features = [<span class="hljs-string">"catch-panic"</span>] }
</code></pre>
<p>代码：</p>
<pre><code class="hljs language-css" lang="css">  use tower_http::catch_panic::CatchPanicLayer;
  ...
   let app = Router::<span class="hljs-built_in">new</span>()
        .<span class="hljs-built_in">route</span>(<span class="hljs-string">"/"</span>, <span class="hljs-built_in">get</span>(ok_handler))
        .<span class="hljs-built_in">route</span>(<span class="hljs-string">"/panic"</span>, <span class="hljs-built_in">get</span>(panic_handler))
        // 加上 CatchPanicLayer
        .<span class="hljs-built_in">layer</span>(CatchPanicLayer::<span class="hljs-built_in">new</span>());
        ...
</code></pre>
<p>panic则返回HTTP 500 Internal Server Error，服务不会退出。</p>
<h3 data-id="heading-21">3、tokio::spawn自带的工具</h3>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">handle</span> = tokio::<span class="hljs-title function_ invoke__">spawn</span>(<span class="hljs-keyword">async</span> {
    <span class="hljs-built_in">panic!</span>(<span class="hljs-string">"boom!"</span>);
});

<span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">result</span> = handle.<span class="hljs-keyword">await</span>;
<span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">Err</span>(join_err) = result {
    <span class="hljs-keyword">if</span> join_err.<span class="hljs-title function_ invoke__">is_panic</span>() {
        <span class="hljs-built_in">println!</span>(<span class="hljs-string">"panic caught!"</span>);
    }
}
</code></pre>
<p>每个 Tokio 任务都是独立执行，如果任务 panic，返回 <code>JoinError</code></p>
<h2 data-id="heading-22">四、总结</h2>
<p>本文总结了Rust代码的危险操作，在提交过程中还可以增加lint，阻止unwrap等的提交或者加白名单，服务本身性能允许的话，还可以兜底抓取崩溃，能抓到90%的panic。另外，如果是后端服务，从经验看，一般还涉及灰度发布，自动回滚，熔断等等保护性操作，服务崩溃估计是各种问题累加，一个unwrap估计没那么大威力。Rust危险操作可能还有别的，欢迎留言讨论。</p>
<p>如果觉得本文有用，辛苦点个关注吧，本人公众号<em>大鱼七成饱</em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[使用 OpenTelemetry 对 OpenResty 进行链路追踪最佳实践]]></title>    <link>https://juejin.cn/post/7578700798744133666</link>    <guid>https://juejin.cn/post/7578700798744133666</guid>    <pubDate>2025-12-01T11:21:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578700798744133666" data-draft-id="7578700798744068130" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="使用 OpenTelemetry 对 OpenResty 进行链路追踪最佳实践"/> <meta itemprop="keywords" content="监控"/> <meta itemprop="datePublished" content="2025-12-01T11:21:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="可观测性用观测云"/> <meta itemprop="url" content="https://juejin.cn/user/2392958212523102"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            使用 OpenTelemetry 对 OpenResty 进行链路追踪最佳实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2392958212523102/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    可观测性用观测云
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-01T11:21:19.000Z" title="Mon Dec 01 2025 11:21:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-01
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">简介</h2>
<p>本文介绍如何使用 OpenTelemetry 对 OpenResty 进行链路追踪。OpenResty 是一个基于 Nginx 与 LuaJIT 的高性能 Web 平台，通过集成 Lua 脚本语言，提供了强大的动态处理能力。OpenResty 支持通过 ngx_otel_module 模块采集调用链数据，并直接上报至观测云平台。</p>
<h2 data-id="heading-1">观测云</h2>
<p>观测云采集器 DataKit 支持 OpenTelemetry 采集插件，能够接收 ngx_otel_module 模块链路数据并在平台统一分析。</p>
<h3 data-id="heading-2">部署 DataKit</h3>
<p>登录观测云控制台，点击「集成」-「DataKit」-「Linux」，复制安装命令在服务器执行即可。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/89345f3871564818902e8a4af6390340~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765192879&amp;x-signature=5uP9NAXFzOLtMHEit%2F0yPhSgo7M%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-3">开启 OpenTelemetry 插件</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 进入采集器配置文件目录</span>
<span class="hljs-built_in">cd</span> /usr/local/datakit/conf.d/samples
<span class="hljs-comment"># 开启配置文件</span>
<span class="hljs-built_in">cp</span> opentelemetry.conf.sample opentelemetry.conf
<span class="hljs-comment"># 重启 Datakit</span>
datakit service -R
</code></pre>
<h2 data-id="heading-4">接入步骤</h2>
<h3 data-id="heading-5">构建 ngx_otel_module 模块</h3>
<ul>
<li>安装构建工具和依赖项</li>
</ul>

<pre><code class="hljs language-arduino" lang="arduino">sudo apt update

sudo apt install cmake build-essential libssl-dev zlib1g-dev libpcre3-dev

sudo apt install pkg-config libc-ares-dev libre2-dev <span class="hljs-meta"># for gRPC</span>
</code></pre>
<ul>
<li>确定 OpenResty 使用的 Nginx 版本和编译配置</li>
</ul>

<pre><code class="hljs">openresty -V
</code></pre>
<p>以下为输出示例：</p>
<pre><code class="hljs language-shell" lang="shell">openresty -V
<span class="hljs-meta prompt_">#</span><span class="bash">nginx version: openresty/1.25.3.2</span>
<span class="hljs-meta prompt_">#</span><span class="bash">built with OpenSSL 1.1.1w  11 Sep 2023</span>
<span class="hljs-meta prompt_">#</span><span class="bash">TLS SNI support enabled</span>
<span class="hljs-meta prompt_">#</span><span class="bash">configure arguments: --prefix=/usr/local/openresty/nginx --with-cc-opt=<span class="hljs-string">'-O2 -DNGX_LUA_ABORT_AT_PANIC -I/usr/local/openresty/zlib/include -I/usr/local/openresty/pcre/include -I/usr/local/openresty/openssl111/include'</span> --add-module=../ngx_devel_kit-0.3.3 --add-module=../echo-nginx-module-0.63 --add-module=../xss-nginx-module-0.06 --add-module=../ngx_coolkit-0.2 --add-module=../set-misc-nginx-module-0.33 --add-module=../form-input-nginx-module-0.12 --add-module=../encrypted-session-nginx-module-0.09 --add-module=../srcache-nginx-module-0.33 --add-module=../ngx_lua-0.10.26 --add-module=../ngx_lua_upstream-0.07 --add-module=../headers-more-nginx-module-0.37 --add-module=../array-var-nginx-module-0.06 --add-module=../memc-nginx-module-0.20 --add-module=../redis2-nginx-module-0.15 --add-module=../redis-nginx-module-0.3.9 --add-module=../ngx_stream_lua-0.0.14 --with-ld-opt=<span class="hljs-string">'-Wl,-rpath,/usr/local/openresty/luajit/lib -L/usr/local/openresty/zlib/lib -L/usr/local/openresty/pcre/lib -L/usr/local/openresty/openssl111/lib -Wl,-rpath,/usr/local/openresty/zlib/lib:/usr/local/openresty/pcre/lib:/usr/local/openresty/openssl111/lib'</span> --with-pcre-jit --with-stream --with-stream_ssl_module --with-stream_ssl_preread_module --with-http_v2_module --with-http_v3_module --without-mail_pop3_module --without-mail_imap_module --without-mail_smtp_module --with-http_stub_status_module --with-http_realip_module --with-http_addition_module --with-http_auth_request_module --with-http_secure_link_module --with-http_random_index_module --with-http_gzip_static_module --with-http_sub_module --with-http_dav_module --with-http_flv_module --with-http_mp4_module --with-http_slice_module --with-http_gunzip_module --with-threads --with-stream --without-pcre2 --with-http_ssl_module</span>
</code></pre>
<ul>
<li>下载对应版本的 Nginx 源码</li>
</ul>

<pre><code class="hljs language-bash" lang="bash">git <span class="hljs-built_in">clone</span> https://github.com/nginx/nginx.git
<span class="hljs-built_in">cd</span> nginx
git checkout {OPENRESTY_NGINX_VERSION}  <span class="hljs-comment"># 切换到对应版本Tag</span>
</code></pre>
<p><code>{OPENRESTY_NGINX_VERSION}</code> 替换为对应版本 Tag，以 1.25.3.2 版本为例，对应的版本 Tag 为 <code>release-1.25.3</code>。</p>
<ul>
<li>配置 Nginx 编译参数</li>
</ul>
<p>在 nginx 源码根目录执行以下命令</p>
<pre><code class="hljs language-scss" lang="scss">./auto/configure {NGINX_CONFIGURE_ARGUMENTS} <span class="hljs-attr">--with-compat</span> 
</code></pre>
<p><code>{NGINX_CONFIGURE_ARGUMENTS}</code> 为获取的 configure arguments 内容，并移除与 <code>--add-module</code> 相关的参数配置。</p>
<ul>
<li>下载 ngx_otel_module 模块源码</li>
</ul>

<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cd</span> ..
git <span class="hljs-built_in">clone</span> https://github.com/nginxinc/nginx-otel.git
<span class="hljs-built_in">cd</span> /nginx-otel
</code></pre>
<ul>
<li>编译 ngx_otel_module 模块</li>
</ul>
<p>创建并进入 build 目录进行编译，编译完成后会在 build 目录生成 <code>ngx_otel_module.so</code> 文件。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">mkdir</span> build
<span class="hljs-built_in">cd</span> build
cmake -DNGX_OTEL_NGINX_BUILD_DIR=/nginx/objs ..
make
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8992ddff6cc540d58b979318ad94fe2b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765192879&amp;x-signature=gBvn%2FWapzDil6IP1d9QLopHknno%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-6">启用 ngx_otel_module 模块</h3>
<ul>
<li>将 <code>ngx_otel_module.so</code> 模块文件复制到 nginx modules 目录</li>
</ul>

<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">mkdir</span> -p /usr/local/openresty/nginx/modules/
<span class="hljs-built_in">cp</span> ngx_otel_module.so /usr/local/openresty/nginx/modules/
</code></pre>
<ul>
<li>配置 nginx.conf</li>
</ul>
<p>为 OpenResty 启用链路追踪，您需要在 Nginx 主配置文件 <code>/usr/local/openresty/nginx/conf/nginx.conf</code> 中加载 ngx_otel_module 模块并添加配置项。注意 ngx_otel_module 模块目前仅支持 gRPC 方式上报，不支持 HTTP 方式上报。关于 ngx_otel_module 模块的更多参数配置信息，请参考 <a href="https://link.juejin.cn?target=https%3A%2F%2Fnginx.org%2Fen%2Fdocs%2Fngx_otel_module.html" target="_blank" title="https://nginx.org/en/docs/ngx_otel_module.html" ref="nofollow noopener noreferrer">nginx.org/en/docs/ngx…</a></p>
<pre><code class="hljs language-bash" lang="bash">load_module modules/ngx_otel_module.so; <span class="hljs-comment"># 加载 ngx_otel_module</span>
...
http {
    ...

    otel_exporter {
        endpoint <span class="hljs-string">"127.0.0.1:4317"</span>; <span class="hljs-comment">#  gRPC 接入点</span>
        <span class="hljs-comment">#header Authentication "${GRPC_TOKEN}"; # 前提条件中获取的鉴权 Token</span>
    }

    otel_trace on;                     <span class="hljs-comment"># 开启链路追踪</span>
    otel_service_name openresty-otel;  <span class="hljs-comment"># 应用名</span>
    otel_trace_context propagate;      <span class="hljs-comment"># 向下游服务注入Trace上下文</span>
    ...
}
</code></pre>
<ul>
<li>检查 nginx.conf 配置是否正确</li>
</ul>

<pre><code class="hljs language-bash" lang="bash">/usr/local/openresty/nginx/sbin/nginx -t
</code></pre>
<p>如下，表明配置无误</p>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-symbol">nginx:</span> the configuration file /usr/local/openresty/nginx/conf/nginx.conf syntax <span class="hljs-built_in">is</span> ok
<span class="hljs-symbol">nginx:</span> configuration file /usr/local/openresty/nginx/conf/nginx.conf test <span class="hljs-built_in">is</span> successful
</code></pre>
<ul>
<li>重载配置</li>
</ul>

<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 方式1: 使用 openresty 命令重载配置</span>
openresty -s reload

<span class="hljs-comment"># 方式2: 使用 nginx 命令重载配置</span>
/usr/local/openresty/nginx/sbin/nginx -s reload
</code></pre>
<h3 data-id="heading-7">注意事项</h3>
<p>如果执行编译，出现如图所示卡住的情况，可以通过以下方案解决：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/42b2e5d9d0834801b930864b05269887~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765192879&amp;x-signature=MQD3KQGV6sk3O6so5jwcKbUff3s%3D" alt="" loading="lazy"/></p>
<ul>
<li>确保使用完全相同的 nginx 版本。</li>
<li>使用<code>nginx -V</code> 查看当前 nginx 的编译参数。</li>
<li>执行 <code>openresty -V</code> 检查 <code>configure arguments</code> 参数是否正确。</li>
</ul>
<p>然后重新编译即可</p>
<h2 data-id="heading-8">查看链路</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/269c8f6dcf4c414db40018bad587c876~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765192879&amp;x-signature=dh%2F2Ah4C9pI%2FZtrOXuXqavzqcIc%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-9">总结</h2>
<p>OpenResty（Nginx+LuaJIT 高性能 Web 平台）通过 ngx_otel_module 模块采集调用链数据，经观测云 DataKit 采集器的 OpenTelemetry 采集器接收，实现链路追踪数据在观测云平台的统一分析上报。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【鸿蒙开发案例篇】快速掌握使用NAPI调用C标准库的功能]]></title>    <link>https://juejin.cn/post/7578667193321308223</link>    <guid>https://juejin.cn/post/7578667193321308223</guid>    <pubDate>2025-12-01T11:35:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578667193321308223" data-draft-id="7578705123208462379" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【鸿蒙开发案例篇】快速掌握使用NAPI调用C标准库的功能"/> <meta itemprop="keywords" content="HarmonyOS,ArkTS,ArkUI"/> <meta itemprop="datePublished" content="2025-12-01T11:35:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="威哥爱编程"/> <meta itemprop="url" content="https://juejin.cn/user/2242659450109575"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【鸿蒙开发案例篇】快速掌握使用NAPI调用C标准库的功能
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2242659450109575/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    威哥爱编程
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-01T11:35:04.000Z" title="Mon Dec 01 2025 11:35:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-01
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是 V 哥。今天我们来深入探讨在鸿蒙 6.0（API 21）开发中，如何通过 NAPI（Native API）框架调用 C 标准库的功能。NAPI 是连接 ArkTS 应用层与 C/C++ 原生代码的关键桥梁，能够有效提升计算密集型任务的执行效率。</p>
<p>联系V哥获取 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Ftraining%2FclassDetail%2F042cb1cc4d7d44ecbdbd902fd1275dcc%3Ftype%3D1%3Fha_source%3Dhmosclass%26ha_sourceId%3D89000248" target="_blank" title="https://developer.huawei.com/consumer/cn/training/classDetail/042cb1cc4d7d44ecbdbd902fd1275dcc?type=1?ha_source=hmosclass&amp;ha_sourceId=89000248" ref="nofollow noopener noreferrer">鸿蒙学习资料</a></p>
<h3 data-id="heading-0">一、NAPI 基础与项目结构</h3>
<p><strong>技术架构</strong>：<br/>
<code>ArkTS 业务层 → NAPI 接口桥接 → C++ 原生逻辑 → C 标准库函数</code><br/>
NAPI 将 ECMAScript 标准中的数据类型（如 Number、String、Object）统一封装为 <code>napi_value</code> 类型，实现与 C/C++ 数据类型的双向转换。</p>
<p><strong>项目结构</strong>（Native C++ 模板）：</p>
<pre><code class="hljs language-bash" lang="bash">entry/src/main/
├── ets/
│   └── pages/
│       └── Index.ets          <span class="hljs-comment"># ArkTS 交互界面</span>
├── cpp/
│   ├── CMakeLists.txt         <span class="hljs-comment"># CMake 编译配置</span>
│   ├── hello.cpp             <span class="hljs-comment"># NAPI 模块实现</span>
│   └── types/
│       └── libhello/
│           ├── index.d.ts     <span class="hljs-comment"># 类型声明文件</span>
│           └── oh-package.json5
</code></pre>
<h3 data-id="heading-1">二、环境配置与依赖注入</h3>
<ol>
<li>
<p><strong>模块配置</strong>（<code>oh-package.json5</code>）<br/>
声明 NAPI 模块的依赖关系：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"dependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"libhello"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"file:./src/main/cpp/types/libhello"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
</li>
<li>
<p><strong>CMake 配置</strong>（<code>CMakeLists.txt</code>）<br/>
链接 C 标准库并指定编译目标：</p>
<pre><code class="hljs language-cmake" lang="cmake">cmake_minimum_required(VERSION 3.12)
project(hello) 
add_library(hello SHARED hello.cpp)
target_link_libraries(hello PUBLIC libc.so)  # 链接 C 标准库
</code></pre>
</li>
</ol>
<h3 data-id="heading-2">三、核心实现：从 C 标准库到 ArkTS</h3>
<h4 data-id="heading-3">步骤 1：C++ 侧实现 NAPI 接口（<code>hello.cpp</code>）</h4>
<p>通过 <code>hypot</code> 函数（C 标准库数学函数）演示平方和计算：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;cmath&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"napi/native_node_api.h"</span></span>

<span class="hljs-comment">// 1. 封装 C 标准库函数</span>
<span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">CalculateHypot</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span> </span>{
    napi_value result;
    <span class="hljs-built_in">napi_get_undefined</span>(env, &amp;result);
    
    <span class="hljs-comment">// 2. 解析 ArkTS 传递的参数</span>
    <span class="hljs-type">size_t</span> argc = <span class="hljs-number">2</span>;
    napi_value args;
    <span class="hljs-built_in">napi_get_cb_info</span>(env, info, &amp;argc, args, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>);
    
    <span class="hljs-comment">// 3. 类型转换：napi_value → C double</span>
    <span class="hljs-type">double</span> a, b;
    <span class="hljs-built_in">napi_get_value_double</span>(env, args, &amp;a);
    <span class="hljs-built_in">napi_get_value_double</span>(env, args, &amp;b);
    
    <span class="hljs-comment">// 4. 调用 C 标准库函数</span>
    <span class="hljs-type">double</span> hypot_result = <span class="hljs-built_in">hypot</span>(a, b);
    
    <span class="hljs-comment">// 5. 返回结果给 ArkTS：C double → napi_value</span>
    <span class="hljs-built_in">napi_create_double</span>(env, hypot_result, &amp;result);
    <span class="hljs-keyword">return</span> result;
}

<span class="hljs-comment">// 6. 模块导出声明</span>
<span class="hljs-function">EXTERN_C_START
<span class="hljs-type">static</span> napi_value <span class="hljs-title">Init</span><span class="hljs-params">(napi_env env, napi_value exports)</span> </span>{
    napi_property_descriptor desc[] = {
        {<span class="hljs-string">"calculateHypot"</span>, <span class="hljs-literal">nullptr</span>, CalculateHypot, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, napi_default, <span class="hljs-literal">nullptr</span>}
    };
    <span class="hljs-built_in">napi_define_properties</span>(env, exports, <span class="hljs-built_in">sizeof</span>(desc) / <span class="hljs-built_in">sizeof</span>(desc), desc);
    <span class="hljs-keyword">return</span> exports;
}
EXTERN_C_END
</code></pre>
<h4 data-id="heading-4">步骤 2：类型声明文件（<code>index.d.ts</code>）</h4>
<p>为 ArkTS 提供类型提示：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">calculateHypot</span>: <span class="hljs-function">(<span class="hljs-params">a: <span class="hljs-built_in">number</span>, b: <span class="hljs-built_in">number</span></span>) =&gt;</span> <span class="hljs-built_in">number</span>;
</code></pre>
<h4 data-id="heading-5">步骤 3：ArkTS 调用层（<code>Index.ets</code>）</h4>
<p>在 UI 中集成原生计算能力：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { calculateHypot } <span class="hljs-keyword">from</span> <span class="hljs-string">'libhello'</span>;

<span class="hljs-meta">@Entry</span>
<span class="hljs-meta">@Component</span>
struct <span class="hljs-title class_">NAPIDemo</span> {
  <span class="hljs-meta">@State</span> <span class="hljs-attr">inputA</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">3.0</span>;
  <span class="hljs-meta">@State</span> <span class="hljs-attr">inputB</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">4.0</span>;
  <span class="hljs-meta">@State</span> <span class="hljs-attr">result</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;

  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">Column</span>() {
      <span class="hljs-title class_">TextInput</span>({ <span class="hljs-attr">placeholder</span>: <span class="hljs-string">'输入数值 A'</span> })
        .<span class="hljs-title function_">onChange</span>(<span class="hljs-function">(<span class="hljs-params">value: <span class="hljs-built_in">string</span></span>) =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">inputA</span> = <span class="hljs-built_in">parseFloat</span>(value))
      <span class="hljs-title class_">TextInput</span>({ <span class="hljs-attr">placeholder</span>: <span class="hljs-string">'输入数值 B'</span> })
        .<span class="hljs-title function_">onChange</span>(<span class="hljs-function">(<span class="hljs-params">value: <span class="hljs-built_in">string</span></span>) =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">inputB</span> = <span class="hljs-built_in">parseFloat</span>(value))
      
      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'计算平方根'</span>)
        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {
          <span class="hljs-comment">// 调用 NAPI 封装的 C 标准库函数</span>
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">result</span> = <span class="hljs-title function_">calculateHypot</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">inputA</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">inputB</span>);
        })
      
      <span class="hljs-title class_">Text</span>(<span class="hljs-string">`结果: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.result}</span>`</span>)
        .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">20</span>)
    }
  }
}
</code></pre>
<h3 data-id="heading-6">四、关键技术与异常处理</h3>
<ol>
<li>
<p><strong>数据类型转换对照表</strong></p>






























<table><thead><tr><th>C/C++ 类型</th><th>NAPI 转换接口</th><th>ArkTS 类型</th></tr></thead><tbody><tr><td><code>double</code></td><td><code>napi_create_double()</code></td><td><code>number</code></td></tr><tr><td><code>int32_t</code></td><td><code>napi_create_int32()</code></td><td><code>number</code></td></tr><tr><td><code>char*</code></td><td><code>napi_create_string_utf8()</code></td><td><code>string</code></td></tr><tr><td><code>bool</code></td><td><code>napi_get_boolean()</code></td><td><code>boolean</code></td></tr></tbody></table>
</li>
<li>
<p><strong>错误处理机制</strong><br/>
在 C++ 侧添加 NAPI 状态检查：</p>
<pre><code class="hljs language-cpp" lang="cpp">napi_status status = <span class="hljs-built_in">napi_get_value_double</span>(env, args, &amp;a);
<span class="hljs-keyword">if</span> (status != napi_ok) {
    <span class="hljs-built_in">napi_throw_error</span>(env, <span class="hljs-literal">nullptr</span>, <span class="hljs-string">"参数解析失败"</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;
}
</code></pre>
</li>
</ol>
<h3 data-id="heading-7">五、扩展场景：异步调用与回调函数</h3>
<p>对于耗时操作（如图像处理），可通过 NAPI 实现异步调用：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 在 C++ 侧创建异步工作线程</span>
<span class="hljs-built_in">napi_create_async_work</span>(
    env, <span class="hljs-literal">nullptr</span>, resource_name,
    [](napi_env env, <span class="hljs-type">void</span>* data) {
        <span class="hljs-comment">// 子线程中执行 C 标准库函数</span>
    },
    [](napi_env env, napi_status status, <span class="hljs-type">void</span>* data) {
        <span class="hljs-comment">// 回调 ArkTS 传递的 Promise 对象</span>
        <span class="hljs-built_in">napi_resolve_deferred</span>(env, deferred, result);
    },
    data, &amp;async_work
);
</code></pre>
<h3 data-id="heading-8">六、调试与性能优化建议</h3>
<ol>
<li>
<p><strong>日志输出</strong><br/>
使用 <code>hilog</code> 在 C++ 侧打印调试信息：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;hilog/log.h&gt;</span></span>
<span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_INFO, <span class="hljs-number">0</span>, <span class="hljs-string">"NAPI"</span>, <span class="hljs-string">"计算结果: %f"</span>, hypot_result);
</code></pre>
</li>
<li>
<p><strong>内存管理</strong></p>
<ul>
<li>避免在循环中频繁创建 <code>napi_value</code> 对象</li>
<li>使用 <code>napi_create_reference()</code> 管理长期持有的对象</li>
</ul>
</li>
</ol>
<h3 data-id="heading-9">总结</h3>
<p>通过 NAPI 调用 C 标准库的核心步骤包括：</p>
<ol>
<li><strong>环境配置</strong>：声明模块依赖与 CMake 编译规则</li>
<li><strong>桥接实现</strong>：在 C++ 中封装原生函数并处理类型转换</li>
<li><strong>类型声明</strong>：提供 ArkTS 可识别的接口定义</li>
<li><strong>异常处理</strong>：添加状态检查与错误抛出机制</li>
</ol>
<p>我是 V 哥，下期将解析如何通过 NAPI 实现 ArkTS 与 C++ 间的复杂对象传递（如结构体与回调函数）。关注我的专栏，解锁更多鸿蒙底层开发技巧！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue3 + Element Plus 动态菜单实现：一套代码完美适配多角色权限系统]]></title>    <link>https://juejin.cn/post/7578724773993054234</link>    <guid>https://juejin.cn/post/7578724773993054234</guid>    <pubDate>2025-12-01T11:50:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578724773993054234" data-draft-id="7571156741398085647" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue3 + Element Plus 动态菜单实现：一套代码完美适配多角色权限系统"/> <meta itemprop="keywords" content="前端,Vue.js"/> <meta itemprop="datePublished" content="2025-12-01T11:50:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="刘大华"/> <meta itemprop="url" content="https://juejin.cn/user/3507878440995946"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue3 + Element Plus 动态菜单实现：一套代码完美适配多角色权限系统
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3507878440995946/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    刘大华
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-01T11:50:04.000Z" title="Mon Dec 01 2025 11:50:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-01
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>今天分享一个基于<code>Vue3</code>和<code>Element Plus</code>的动态菜单实现。这个方案很适用于需要权限管理的后台系统，能够根据用户角色权限显示不同的菜单项。</p>
<h2 data-id="heading-0">一、什么是动态菜单？为什么需要它？</h2>
<p>在管理后台系统中，不同角色的用户通常需要不同的功能权限。比如：</p>
<ul>
<li><strong>管理员</strong>可以访问所有功能</li>
<li><strong>编辑者</strong>只能管理内容</li>
<li><strong>查看者</strong>只能浏览数据</li>
</ul>
<p>如果为每个角色单独开发一套界面，显然效率低下。动态菜单就是解决这个问题的方案——<strong>一套代码，根据不同用户角色显示不同的菜单结构</strong>。</p>
<h2 data-id="heading-1">二、实现效果预览</h2>
<p>我们先来看看最终实现的效果：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9e65b9effe094807867ef7545805b986~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YiY5aSn5Y2O:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765194604&amp;x-signature=LmKZo9onERrMXzvgEpUnpE%2BrGNg%3D" alt="1动态菜单3.png" loading="lazy"/></p>
<ol>
<li><strong>角色切换</strong>：右上角可以切换用户角色（管理员/编辑者/查看者）</li>
<li><strong>菜单过滤</strong>：根据角色自动过滤无权限的菜单项</li>
<li><strong>侧边栏折叠</strong>：支持展开/收起侧边栏</li>
<li><strong>面包屑导航</strong>：显示当前页面位置</li>
</ol>
<p>老样子，完整源码在文末获取哦~</p>
<h2 data-id="heading-2">三、核心实现原理</h2>
<h3 data-id="heading-3">1. 菜单数据结构设计</h3>
<p>合理的菜单数据结构是动态菜单的基础。我们的设计如下：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> menuData = <span class="hljs-title function_">ref</span>([
  {
    <span class="hljs-attr">id</span>: <span class="hljs-string">'dashboard'</span>,        <span class="hljs-comment">// 唯一标识</span>
    <span class="hljs-attr">name</span>: <span class="hljs-string">'仪表板'</span>,         <span class="hljs-comment">// 显示名称</span>
    <span class="hljs-attr">icon</span>: <span class="hljs-string">'DataBoard'</span>,      <span class="hljs-comment">// 图标</span>
    <span class="hljs-attr">route</span>: <span class="hljs-string">'/dashboard'</span>,    <span class="hljs-comment">// 路由路径</span>
    <span class="hljs-attr">roles</span>: [<span class="hljs-string">'admin'</span>, <span class="hljs-string">'editor'</span>, <span class="hljs-string">'viewer'</span>]  <span class="hljs-comment">// 可访问的角色</span>
  },
  {
    <span class="hljs-attr">id</span>: <span class="hljs-string">'content'</span>,
    <span class="hljs-attr">name</span>: <span class="hljs-string">'内容管理'</span>,
    <span class="hljs-attr">icon</span>: <span class="hljs-string">'Document'</span>,
    <span class="hljs-attr">roles</span>: [<span class="hljs-string">'admin'</span>, <span class="hljs-string">'editor'</span>],
    <span class="hljs-attr">children</span>: [             <span class="hljs-comment">// 子菜单</span>
      {
        <span class="hljs-attr">id</span>: <span class="hljs-string">'articles'</span>,
        <span class="hljs-attr">name</span>: <span class="hljs-string">'文章管理'</span>,
        <span class="hljs-attr">route</span>: <span class="hljs-string">'/articles'</span>,
        <span class="hljs-attr">roles</span>: [<span class="hljs-string">'admin'</span>, <span class="hljs-string">'editor'</span>]
      }
      <span class="hljs-comment">// ... 更多子菜单</span>
    ]
  }
  <span class="hljs-comment">// ... 更多菜单项</span>
]);
</code></pre>
<p>这种结构的特点：</p>
<ul>
<li><strong>支持多级嵌套菜单</strong></li>
<li><strong>每个菜单项明确指定可访问的角色</strong></li>
<li><strong>图标使用 Element Plus 的图标组件</strong></li>
</ul>
<h3 data-id="heading-4">2. 菜单过滤逻辑</h3>
<p>核心功能是根据当前用户角色过滤菜单：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> filteredMenu = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">return</span> menuData.<span class="hljs-property">value</span>
    .<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> {
      <span class="hljs-comment">// 1. 检查主菜单权限</span>
      <span class="hljs-keyword">if</span> (!item.<span class="hljs-property">roles</span>.<span class="hljs-title function_">includes</span>(currentUser.<span class="hljs-property">value</span>.<span class="hljs-property">role</span>)) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;  <span class="hljs-comment">// 无权限，过滤掉</span>
      }
      
      <span class="hljs-comment">// 2. 深拷贝菜单项（避免修改原始数据）</span>
      <span class="hljs-keyword">const</span> menuItem = { ...item };
      
      <span class="hljs-comment">// 3. 如果有子菜单，过滤子菜单</span>
      <span class="hljs-keyword">if</span> (menuItem.<span class="hljs-property">children</span>) {
        menuItem.<span class="hljs-property">children</span> = menuItem.<span class="hljs-property">children</span>.<span class="hljs-title function_">filter</span>(
          <span class="hljs-function"><span class="hljs-params">child</span> =&gt;</span> child.<span class="hljs-property">roles</span>.<span class="hljs-title function_">includes</span>(currentUser.<span class="hljs-property">value</span>.<span class="hljs-property">role</span>)
        );
        
        <span class="hljs-comment">// 如果子菜单全被过滤掉，主菜单也不显示</span>
        <span class="hljs-keyword">if</span> (menuItem.<span class="hljs-property">children</span>.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {
          <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }
      }
      
      <span class="hljs-keyword">return</span> menuItem;
    })
    .<span class="hljs-title function_">filter</span>(<span class="hljs-title class_">Boolean</span>);  <span class="hljs-comment">// 过滤掉null值</span>
});
</code></pre>
<p><strong>过滤过程详解</strong>：</p>
<ol>
<li><strong>映射(map)</strong>：遍历每个菜单项，返回处理后的菜单项或null</li>
<li><strong>权限检查</strong>：检查当前用户角色是否在菜单项的角色列表中</li>
<li><strong>子菜单过滤</strong>：对有子菜单的项，递归过滤无权限的子项</li>
<li><strong>空子菜单处理</strong>：如果所有子项都被过滤，父项也不显示</li>
<li><strong>最终过滤</strong>：用filter(Boolean)移除所有null值</li>
</ol>
<p><strong>计算属性(computed)的优势</strong>：</p>
<ul>
<li>自动响应依赖变化（当用户角色变化时自动重新计算）</li>
<li>缓存结果，避免重复计算</li>
</ul>
<h3 data-id="heading-5">3. 用户角色管理</h3>
<p>用户信息和角色切换的实现：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 当前用户信息</span>
<span class="hljs-keyword">const</span> currentUser = <span class="hljs-title function_">ref</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">'管理员'</span>,
  <span class="hljs-attr">role</span>: <span class="hljs-string">'admin'</span>,
  <span class="hljs-attr">avatar</span>: <span class="hljs-string">'https://example.com/avatar.png'</span>
});

<span class="hljs-comment">// 处理角色切换</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleRoleChange</span> = (<span class="hljs-params">role</span>) =&gt; {
  currentUser.<span class="hljs-property">value</span>.<span class="hljs-property">role</span> = role;
  
  <span class="hljs-comment">// 角色切换后更新当前激活的菜单</span>
  <span class="hljs-keyword">if</span> (role === <span class="hljs-string">'viewer'</span>) {
    <span class="hljs-comment">// 查看者只能访问仪表板</span>
    activeMenu.<span class="hljs-property">value</span> = <span class="hljs-string">'/dashboard'</span>;
    currentPageTitle.<span class="hljs-property">value</span> = <span class="hljs-string">'仪表板'</span>;
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 其他角色显示第一个可访问的菜单</span>
    <span class="hljs-keyword">const</span> firstMenu = <span class="hljs-title function_">findFirstAccessibleMenu</span>();
    <span class="hljs-keyword">if</span> (firstMenu) {
      activeMenu.<span class="hljs-property">value</span> = firstMenu.<span class="hljs-property">route</span>;
      currentPageTitle.<span class="hljs-property">value</span> = firstMenu.<span class="hljs-property">name</span>;
    }
  }
};
</code></pre>
<h2 data-id="heading-6">四、界面布局与组件使用</h2>
<h3 data-id="heading-7">1. 整体布局结构</h3>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"app-container"</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- 侧边栏 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"sidebar"</span> <span class="hljs-attr">:class</span>=<span class="hljs-string">"{ collapsed: isCollapse }"</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- Logo区域 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"logo-area"</span>&gt;</span>...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 菜单区域 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">el-menu</span>&gt;</span>...<span class="hljs-tag">&lt;/<span class="hljs-name">el-menu</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  
  <span class="hljs-comment">&lt;!-- 主内容区 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"main-content"</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 顶部导航 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"header"</span>&gt;</span>...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 页面内容 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"content"</span>&gt;</span>...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 页脚 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"footer"</span>&gt;</span>...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<p>这种布局是管理后台的经典设计，具有清晰的视觉层次。</p>
<h3 data-id="heading-8">2. Element Plus 菜单组件使用</h3>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">el-menu</span>
  <span class="hljs-attr">:default-active</span>=<span class="hljs-string">"activeMenu"</span>           &lt;!<span class="hljs-attr">--</span> <span class="hljs-attr">当前激活的菜单</span> <span class="hljs-attr">--</span>&gt;</span>
  class="el-menu-vertical"
  background-color="#001529"            <span class="hljs-comment">&lt;!-- 背景色 --&gt;</span>
  text-color="#bfcbd9"                  <span class="hljs-comment">&lt;!-- 文字颜色 --&gt;</span>
  active-text-color="#409EFF"           <span class="hljs-comment">&lt;!-- 激活项文字颜色 --&gt;</span>
  :collapse="isCollapse"                <span class="hljs-comment">&lt;!-- 是否折叠 --&gt;</span>
  :collapse-transition="false"          <span class="hljs-comment">&lt;!-- 关闭折叠动画 --&gt;</span>
  :unique-opened="true"                 <span class="hljs-comment">&lt;!-- 只保持一个子菜单展开 --&gt;</span>
&gt;
  <span class="hljs-comment">&lt;!-- 菜单项渲染 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">template</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">"item in filteredMenu"</span> <span class="hljs-attr">:key</span>=<span class="hljs-string">"item.id"</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 有子菜单的情况 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">el-sub-menu</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"item.children"</span> <span class="hljs-attr">:index</span>=<span class="hljs-string">"item.id"</span>&gt;</span>
      <span class="hljs-comment">&lt;!-- 标题区域 --&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">title</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">el-icon</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">component</span> <span class="hljs-attr">:is</span>=<span class="hljs-string">"item.icon"</span> /&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">el-icon</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>{{ item.name }}<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
      
      <span class="hljs-comment">&lt;!-- 子菜单项 --&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">el-menu-item</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">"child in item.children"</span> 
                   <span class="hljs-attr">:key</span>=<span class="hljs-string">"child.id"</span> 
                   <span class="hljs-attr">:index</span>=<span class="hljs-string">"child.route"</span>
                   @<span class="hljs-attr">click</span>=<span class="hljs-string">"selectMenu(child)"</span>&gt;</span>
        {{ child.name }}
      <span class="hljs-tag">&lt;/<span class="hljs-name">el-menu-item</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">el-sub-menu</span>&gt;</span>
    
    <span class="hljs-comment">&lt;!-- 没有子菜单的情况 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">el-menu-item</span> <span class="hljs-attr">v-else</span> <span class="hljs-attr">:index</span>=<span class="hljs-string">"item.route"</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"selectMenu(item)"</span>&gt;</span>
      ...
    <span class="hljs-tag">&lt;/<span class="hljs-name">el-menu-item</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">el-menu</span>&gt;</span>
</code></pre>
<p><strong>关键点说明</strong>：</p>
<ol>
<li><strong>动态组件</strong>：<code>&lt;component :is="item.icon"&gt;</code> 实现动态图标渲染</li>
<li><strong>条件渲染</strong>：使用 <code>v-if</code> 和 <code>v-else</code> 区分子菜单和单菜单项</li>
<li><strong>循环渲染</strong>：<code>v-for</code> 遍历过滤后的菜单数据</li>
<li><strong>唯一key</strong>：为每个菜单项设置唯一的 <code>:key="item.id"</code> 提高性能</li>
</ol>
<h2 data-id="heading-9">五、样式设计技巧</h2>
<h3 data-id="heading-10">1. 侧边栏折叠动画</h3>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.sidebar</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">240px</span>;
  <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#001529</span>;
  <span class="hljs-attribute">transition</span>: width <span class="hljs-number">0.3s</span>;  <span class="hljs-comment">/* 宽度变化动画 */</span>
  <span class="hljs-attribute">overflow</span>: hidden;
}

<span class="hljs-selector-class">.sidebar</span><span class="hljs-selector-class">.collapsed</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">64px</span>;
}

<span class="hljs-selector-class">.logo-area</span> <span class="hljs-selector-class">.logo-text</span> {
  <span class="hljs-attribute">margin-left</span>: <span class="hljs-number">10px</span>;
  <span class="hljs-attribute">transition</span>: opacity <span class="hljs-number">0.3s</span>;  <span class="hljs-comment">/* 文字淡入淡出 */</span>
}

<span class="hljs-selector-class">.sidebar</span><span class="hljs-selector-class">.collapsed</span> <span class="hljs-selector-class">.logo-text</span> {
  <span class="hljs-attribute">opacity</span>: <span class="hljs-number">0</span>;  <span class="hljs-comment">/* 折叠时隐藏文字 */</span>
}
</code></pre>
<h3 data-id="heading-11">2. 布局技巧</h3>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.app-container</span> {
  <span class="hljs-attribute">display</span>: flex;
  <span class="hljs-attribute">min-height</span>: <span class="hljs-number">100vh</span>;  <span class="hljs-comment">/* 全屏高度 */</span>
}

<span class="hljs-selector-class">.main-content</span> {
  <span class="hljs-attribute">flex</span>: <span class="hljs-number">1</span>;            <span class="hljs-comment">/* 占据剩余空间 */</span>
  <span class="hljs-attribute">display</span>: flex;
  <span class="hljs-attribute">flex-direction</span>: column;
  <span class="hljs-attribute">overflow</span>: hidden;   <span class="hljs-comment">/* 防止内容溢出 */</span>
}

<span class="hljs-selector-class">.content</span> {
  <span class="hljs-attribute">flex</span>: <span class="hljs-number">1</span>;            <span class="hljs-comment">/* 内容区占据主要空间 */</span>
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">20px</span>;
  <span class="hljs-attribute">overflow-y</span>: auto;   <span class="hljs-comment">/* 内容过多时滚动 */</span>
}
</code></pre>
<p>使用 Flex 布局可以轻松实现经典的侧边栏+主内容区布局。</p>
<h2 data-id="heading-12">六、实际应用扩展建议</h2>
<p>在实际项目中，你还可以进一步扩展这个基础实现：</p>
<h3 data-id="heading-13">1. 与路由集成</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { useRouter, useRoute } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue-router'</span>;

<span class="hljs-keyword">const</span> router = <span class="hljs-title function_">useRouter</span>();
<span class="hljs-keyword">const</span> route = <span class="hljs-title function_">useRoute</span>();

<span class="hljs-comment">// 菜单点击处理</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">selectMenu</span> = (<span class="hljs-params">item</span>) =&gt; {
  <span class="hljs-comment">// 路由跳转</span>
  router.<span class="hljs-title function_">push</span>(item.<span class="hljs-property">route</span>);
};

<span class="hljs-comment">// 根据当前路由设置激活菜单</span>
<span class="hljs-title function_">watch</span>(route, <span class="hljs-function">(<span class="hljs-params">newRoute</span>) =&gt;</span> {
  activeMenu.<span class="hljs-property">value</span> = newRoute.<span class="hljs-property">path</span>;
  <span class="hljs-comment">// 根据路由查找对应的页面标题</span>
  currentPageTitle.<span class="hljs-property">value</span> = <span class="hljs-title function_">findTitleByRoute</span>(newRoute.<span class="hljs-property">path</span>);
});
</code></pre>
<h3 data-id="heading-14">2. 后端动态菜单</h3>
<p>在实际项目中，菜单数据通常来自后端：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 从API获取菜单数据</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">fetchMenuData</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> axios.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/api/menus'</span>, {
      <span class="hljs-attr">params</span>: { <span class="hljs-attr">role</span>: currentUser.<span class="hljs-property">value</span>.<span class="hljs-property">role</span> }
    });
    menuData.<span class="hljs-property">value</span> = response.<span class="hljs-property">data</span>;
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'获取菜单数据失败:'</span>, error);
  }
};
</code></pre>
<h3 data-id="heading-15">3. 权限控制增强</h3>
<p>除了菜单过滤，还可以添加更细粒度的权限控制：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 权限指令</span>
app.<span class="hljs-title function_">directive</span>(<span class="hljs-string">'permission'</span>, {
  <span class="hljs-title function_">mounted</span>(<span class="hljs-params">el, binding</span>) {
    <span class="hljs-keyword">const</span> { <span class="hljs-attr">value</span>: requiredRoles } = binding;
    <span class="hljs-keyword">const</span> userRole = currentUser.<span class="hljs-property">value</span>.<span class="hljs-property">role</span>;
    
    <span class="hljs-keyword">if</span> (!requiredRoles.<span class="hljs-title function_">includes</span>(userRole)) {
      el.<span class="hljs-property">parentNode</span> &amp;&amp; el.<span class="hljs-property">parentNode</span>.<span class="hljs-title function_">removeChild</span>(el);
    }
  }
});

<span class="hljs-comment">// 在模板中使用</span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">v-permission</span>=<span class="hljs-string">"['admin', 'editor']"</span>&gt;</span>编辑内容<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
</code></pre>
<h2 data-id="heading-16">总结</h2>
<p>通过这个 Vue 3 + Element Plus 的动态菜单实现，我们学到了：</p>
<ol>
<li><strong>设计合理的菜单数据结构</strong>是动态菜单的基础</li>
<li><strong>使用计算属性实现菜单过滤</strong>，自动响应角色变化</li>
<li><strong>利用 Element Plus 组件</strong>快速构建美观的界面</li>
<li><strong>Flex 布局技巧</strong>实现响应式侧边栏</li>
<li><strong>扩展思路</strong>，如路由集成、后端动态菜单等</li>
</ol>
<p>这个实现方案具有很好的可扩展性，你可以根据实际需求进行调整和增强。</p>
<p><strong>完整源码GitHub地址</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2F1344160559-lch%2Fdh-vue3-component%2Fblob%2Fmain%2FDynamicMenu%2Findex.html" target="_blank" title="https://github.com/1344160559-lch/dh-vue3-component/blob/main/DynamicMenu/index.html" ref="nofollow noopener noreferrer">github.com/1344160559-…</a></p>
<p>你可以直接复制到HTML文件中运行体验。尝试切换不同的用户角色，观察菜单的变化，加深对动态菜单工作原理的理解。</p>
<blockquote>
<p>本文首发于公众号：程序员刘大华，专注分享前后端开发的实战笔记。关注我，少走弯路，一起进步！</p>
</blockquote>
<h4 data-id="heading-17">📌往期精彩</h4>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2Fmaq_p_m5vd7KS-xyXt5rcA" target="_blank" title="https://mp.weixin.qq.com/s/maq_p_m5vd7KS-xyXt5rcA" ref="nofollow noopener noreferrer">《SpringBoot+MySQL+Vue实现文件共享系统》</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FP7SMincYFKERZbNKAFtzGQ" target="_blank" title="https://mp.weixin.qq.com/s/P7SMincYFKERZbNKAFtzGQ" ref="nofollow noopener noreferrer">《这20条SQL优化方案，让你的数据库查询速度提升10倍》</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FgQK9L1TxKL50FUVMcgh6JQ" target="_blank" title="https://mp.weixin.qq.com/s/gQK9L1TxKL50FUVMcgh6JQ" ref="nofollow noopener noreferrer">《SpringBoot 动态菜单权限系统设计的企业级解决方案》</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FPQ_w7CDVoIZPn-CVH2DKJg" target="_blank" title="https://mp.weixin.qq.com/s/PQ_w7CDVoIZPn-CVH2DKJg" ref="nofollow noopener noreferrer">《Vue3和Vue2的核心区别？很多开发者都没完全搞懂的10个细节》</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[首字母模糊匹配]]></title>    <link>https://juejin.cn/post/7578511778889498662</link>    <guid>https://juejin.cn/post/7578511778889498662</guid>    <pubDate>2025-12-01T09:13:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578511778889498662" data-draft-id="7578495241638281257" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="首字母模糊匹配"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-01T09:13:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="月亮慢慢圆"/> <meta itemprop="url" content="https://juejin.cn/user/2496335488221770"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            首字母模糊匹配
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2496335488221770/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    月亮慢慢圆
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-01T09:13:29.000Z" title="Mon Dec 01 2025 09:13:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-01
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="an-old-hope">.hljs-comment,.hljs-quote{color:#b6b18b}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#eb3c54}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#e7ce56}.hljs-attribute{color:#ee7c2b}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#4fb4d7}.hljs-section,.hljs-title{color:#78bb65}.hljs-keyword,.hljs-selector-tag{color:#b45ea4}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#1c1d21;color:#c0c5ce}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>我们在日常开发中经常会用到筛选的功能，比如一个表格数据，需要根据其中的某一列去进行模糊匹配筛选，一般都是去判断字符串中是否包含某个子字符串，但是这样是不支持首字母模糊匹配的，所以我们可以使用一个第三方包<code>pinyin</code>去实现这种功能。</p>
<p><code>pinyin</code>可以直接使用<code>npm</code>下载。</p>
<h2 data-id="heading-0">1.表格的筛选</h2>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">searchedFilter</span>(<span class="hljs-params">rows, searchValue, keyValue</span>) {
  searchValue = searchValue.<span class="hljs-title function_">trim</span>();
  <span class="hljs-keyword">if</span> (searchValue) {
    <span class="hljs-keyword">const</span> pathen = <span class="hljs-regexp">/^[\u4e00-\u9fa5]+$/</span>;
    <span class="hljs-keyword">if</span> (pathen.<span class="hljs-title function_">test</span>(searchValue)) {
      <span class="hljs-keyword">return</span> rows.<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(data).<span class="hljs-title function_">some</span>(<span class="hljs-function">(<span class="hljs-params">key</span>) =&gt;</span> {
          <span class="hljs-keyword">if</span> (key === keyValue) {
            <span class="hljs-keyword">return</span> data[key].<span class="hljs-title function_">includes</span>(searchValue);
          }
        });
      });
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">const</span> searchValuePinyin = <span class="hljs-title function_">pinyin</span>(searchValue, {
        <span class="hljs-attr">style</span>: pinyin.<span class="hljs-property">STYLE_FIRST_LETTER</span>,
      }).<span class="hljs-title function_">join</span>(<span class="hljs-string">""</span>);
      <span class="hljs-keyword">return</span> rows.<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(data).<span class="hljs-title function_">some</span>(<span class="hljs-function">(<span class="hljs-params">key</span>) =&gt;</span> {
          <span class="hljs-keyword">if</span> (key === keyValue) {
            <span class="hljs-keyword">const</span> dataPyArr = <span class="hljs-title function_">pinyin</span>(data[key], {
              <span class="hljs-attr">style</span>: pinyin.<span class="hljs-property">STYLE_FIRST_LETTER</span>,
            });
            <span class="hljs-keyword">const</span> dataPy = dataPyArr.<span class="hljs-title function_">join</span>(<span class="hljs-string">""</span>);
            <span class="hljs-keyword">return</span> dataPy.<span class="hljs-title function_">includes</span>(searchValuePinyin);
          }
        });
      });
    }
  }
  <span class="hljs-keyword">return</span> rows;
}
</code></pre>
<p>该方法接收三个参数，<code>rows</code>是表格数据，<code>searchValue</code>是筛选字符串，<code>keyValue</code>是要匹配的表格的某一列的<code>prop</code>。</p>
<p>下面举个例子：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"screen-view"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>筛选字段:<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">el-input</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"filterText"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"width:120px"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">el-input</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">el-button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"filterHandle"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"primary"</span>&gt;</span>筛选<span class="hljs-tag">&lt;/<span class="hljs-name">el-button</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">el-table</span> <span class="hljs-attr">:data</span>=<span class="hljs-string">"showTableData"</span> <span class="hljs-attr">stripe</span> <span class="hljs-attr">border</span> <span class="hljs-attr">height</span>=<span class="hljs-string">"500"</span> <span class="hljs-attr">:cell-style</span>=<span class="hljs-string">"{ textAlign: 'center' }"</span>
      <span class="hljs-attr">:header-cell-style</span>=<span class="hljs-string">"{ textAlign: 'center' }"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">el-table-column</span> <span class="hljs-attr">label</span>=<span class="hljs-string">"姓名"</span> <span class="hljs-attr">prop</span>=<span class="hljs-string">"name"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">el-table-column</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">el-table-column</span> <span class="hljs-attr">label</span>=<span class="hljs-string">"地址"</span> <span class="hljs-attr">prop</span>=<span class="hljs-string">"address"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">el-table-column</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">el-table-column</span> <span class="hljs-attr">label</span>=<span class="hljs-string">"职位"</span> <span class="hljs-attr">prop</span>=<span class="hljs-string">"job"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">el-table-column</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">el-table</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { searchedFilter } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/utils/changePinyin'</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">tableData</span>: [
        { <span class="hljs-attr">name</span>: <span class="hljs-string">'月亮'</span>, <span class="hljs-attr">address</span>: <span class="hljs-string">'江苏省南京市'</span>, <span class="hljs-attr">job</span>: <span class="hljs-string">'前端开发'</span> },
        { <span class="hljs-attr">name</span>: <span class="hljs-string">'月亮1'</span>, <span class="hljs-attr">address</span>: <span class="hljs-string">'江苏省南京市'</span>, <span class="hljs-attr">job</span>: <span class="hljs-string">'前端开发'</span> },
        { <span class="hljs-attr">name</span>: <span class="hljs-string">'月亮2'</span>, <span class="hljs-attr">address</span>: <span class="hljs-string">'江苏省南京市'</span>, <span class="hljs-attr">job</span>: <span class="hljs-string">'前端开发'</span> },
        { <span class="hljs-attr">name</span>: <span class="hljs-string">'大傻'</span>, <span class="hljs-attr">address</span>: <span class="hljs-string">'安徽省合肥市'</span>, <span class="hljs-attr">job</span>: <span class="hljs-string">'后端开发'</span> },
        { <span class="hljs-attr">name</span>: <span class="hljs-string">'大傻1'</span>, <span class="hljs-attr">address</span>: <span class="hljs-string">'安徽省合肥市'</span>, <span class="hljs-attr">job</span>: <span class="hljs-string">'后端开发'</span> },
        { <span class="hljs-attr">name</span>: <span class="hljs-string">'大傻2'</span>, <span class="hljs-attr">address</span>: <span class="hljs-string">'安徽省合肥市'</span>, <span class="hljs-attr">job</span>: <span class="hljs-string">'后端开发'</span> },
        { <span class="hljs-attr">name</span>: <span class="hljs-string">'二狗'</span>, <span class="hljs-attr">address</span>: <span class="hljs-string">'四川省成都市'</span>, <span class="hljs-attr">job</span>: <span class="hljs-string">'前端开发'</span> },
        { <span class="hljs-attr">name</span>: <span class="hljs-string">'二狗1'</span>, <span class="hljs-attr">address</span>: <span class="hljs-string">'四川省成都市'</span>, <span class="hljs-attr">job</span>: <span class="hljs-string">'前端开发'</span> },
        { <span class="hljs-attr">name</span>: <span class="hljs-string">'二狗2'</span>, <span class="hljs-attr">address</span>: <span class="hljs-string">'四川省成都市'</span>, <span class="hljs-attr">job</span>: <span class="hljs-string">'前端开发'</span> },
        { <span class="hljs-attr">name</span>: <span class="hljs-string">'三驴子'</span>, <span class="hljs-attr">address</span>: <span class="hljs-string">'河南省郑州市'</span>, <span class="hljs-attr">job</span>: <span class="hljs-string">'后端开发'</span> },
        { <span class="hljs-attr">name</span>: <span class="hljs-string">'三驴子1'</span>, <span class="hljs-attr">address</span>: <span class="hljs-string">'河南省郑州市'</span>, <span class="hljs-attr">job</span>: <span class="hljs-string">'后端开发'</span> },
        { <span class="hljs-attr">name</span>: <span class="hljs-string">'三驴子2'</span>, <span class="hljs-attr">address</span>: <span class="hljs-string">'河南省郑州市'</span>, <span class="hljs-attr">job</span>: <span class="hljs-string">'后端开发'</span> },
      ],
      <span class="hljs-attr">showTableData</span>: [],
      <span class="hljs-attr">filterText</span>: <span class="hljs-string">''</span>
    }
  },
  <span class="hljs-title function_">created</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">showTableData</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">tableData</span>
  },
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-title function_">filterHandle</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">showTableData</span> = <span class="hljs-title function_">searchedFilter</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">tableData</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">filterText</span>, <span class="hljs-string">'name'</span>)
      <span class="hljs-comment">// 这就是筛选表格的姓名字段，如果想筛选别的就把name换成对应的prop</span>
      <span class="hljs-comment">// 支持首字母匹配</span>
    }
  }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"scss"</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
<span class="hljs-selector-class">.screen-view</span> {
  <span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span>;
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">10px</span>;
  <span class="hljs-attribute">box-sizing</span>: border-box;
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre>
<p>这个方法只能根据表格的一列进行筛选，如果想同时匹配多列的话，可以使用下面的方法。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">searchedFilters</span>(<span class="hljs-params">rows, searchValue, keyValues</span>) {
  searchValue = searchValue.<span class="hljs-title function_">trim</span>();
  <span class="hljs-keyword">if</span> (searchValue) {
    <span class="hljs-keyword">const</span> pathen = <span class="hljs-regexp">/^[\u4e00-\u9fa5]+$/</span>;
    <span class="hljs-keyword">if</span> (pathen.<span class="hljs-title function_">test</span>(searchValue)) {
      <span class="hljs-keyword">return</span> rows.<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(data).<span class="hljs-title function_">some</span>(<span class="hljs-function">(<span class="hljs-params">key</span>) =&gt;</span> {
          <span class="hljs-keyword">return</span> keyValues.<span class="hljs-title function_">some</span>(<span class="hljs-function">(<span class="hljs-params">k</span>) =&gt;</span> {
            <span class="hljs-keyword">if</span> (key === k) {
              <span class="hljs-keyword">return</span> data[key].<span class="hljs-title function_">includes</span>(searchValue);
            }
          });
        });
      });
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">const</span> searchValuePinyin = <span class="hljs-title function_">pinyin</span>(searchValue, {
        <span class="hljs-attr">style</span>: pinyin.<span class="hljs-property">STYLE_FIRST_LETTER</span>,
      }).<span class="hljs-title function_">join</span>(<span class="hljs-string">""</span>);
      <span class="hljs-keyword">return</span> rows.<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(data).<span class="hljs-title function_">some</span>(<span class="hljs-function">(<span class="hljs-params">key</span>) =&gt;</span> {
          <span class="hljs-keyword">return</span> keyValues.<span class="hljs-title function_">some</span>(<span class="hljs-function">(<span class="hljs-params">k</span>) =&gt;</span> {
            <span class="hljs-keyword">if</span> (key === k) {
              <span class="hljs-keyword">const</span> dataPyArr = <span class="hljs-title function_">pinyin</span>(data[key], {
                <span class="hljs-attr">style</span>: pinyin.<span class="hljs-property">STYLE_FIRST_LETTER</span>,
              });
              <span class="hljs-keyword">const</span> dataPy = dataPyArr.<span class="hljs-title function_">join</span>(<span class="hljs-string">""</span>);
              <span class="hljs-keyword">return</span> dataPy.<span class="hljs-title function_">includes</span>(searchValuePinyin);
            }
          });
        });
      });
    }
  }
  <span class="hljs-keyword">return</span> rows;
}
</code></pre>
<p>还是接收三个参数，前面两个跟第一个方法一样，表格数据和筛选字符串，第三个是一个数组，里面存放的是你想匹配的列。</p>
<p>比如我们想同时筛选姓名和地址这两列：</p>
<pre><code class="hljs language-js" lang="js">    <span class="hljs-title function_">filterHandle</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">showTableData</span> = <span class="hljs-title function_">searchedFilters</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">tableData</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">filterText</span>, [<span class="hljs-string">'name'</span>, <span class="hljs-string">'address'</span>])
    }
</code></pre>
<h2 data-id="heading-1">2.树结构的筛选</h2>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">treeFilterPY</span>(<span class="hljs-params">data, searchValue, keyValue</span>) {
  searchValue = searchValue.<span class="hljs-title function_">trim</span>();
  <span class="hljs-keyword">if</span> (!searchValue) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  <span class="hljs-keyword">const</span> pathen = <span class="hljs-regexp">/^[\u4e00-\u9fa5]+$/</span>;
  <span class="hljs-keyword">if</span> (pathen.<span class="hljs-title function_">test</span>(searchValue)) {
    <span class="hljs-keyword">return</span> data[keyValue].<span class="hljs-title function_">indexOf</span>(searchValue) !== -<span class="hljs-number">1</span>;
  }
  <span class="hljs-comment">// 匹配小写</span>
  <span class="hljs-keyword">const</span> labelValue = <span class="hljs-title function_">pinyin</span>(data[keyValue], {
    <span class="hljs-attr">style</span>: pinyin.<span class="hljs-property">STYLE_FIRST_LETTER</span>,
  }).<span class="hljs-title function_">join</span>(<span class="hljs-string">""</span>);
  <span class="hljs-keyword">const</span> searchValuePinyin = <span class="hljs-title function_">pinyin</span>(searchValue, {
    <span class="hljs-attr">style</span>: pinyin.<span class="hljs-property">STYLE_FIRST_LETTER</span>,
  }).<span class="hljs-title function_">join</span>(<span class="hljs-string">""</span>);
  <span class="hljs-keyword">return</span> labelValue.<span class="hljs-title function_">indexOf</span>(searchValuePinyin) !== -<span class="hljs-number">1</span>;
}
</code></pre>
<p>这个方法接收三个参数，分别是树结构数据，筛选字符串，对应的prop。</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"screen-view"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>筛选字段:<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">el-input</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"filterText"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"width:120px"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">el-input</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">el-button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"filterHandle"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"primary"</span>&gt;</span>筛选<span class="hljs-tag">&lt;/<span class="hljs-name">el-button</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">el-tree</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"treeRef"</span> <span class="hljs-attr">:data</span>=<span class="hljs-string">"treeData"</span> <span class="hljs-attr">:filter-node-method</span>=<span class="hljs-string">"filterNode"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">el-tree</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { treeFilterPY } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/utils/changePinyin'</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">defaultProps</span>: {
        <span class="hljs-attr">children</span>: <span class="hljs-string">"children"</span>,
        <span class="hljs-attr">label</span>: <span class="hljs-string">"label"</span>,
      },
      <span class="hljs-attr">treeData</span>: [
        {
          <span class="hljs-attr">label</span>: <span class="hljs-string">'全部'</span>,
          <span class="hljs-attr">id</span>: -<span class="hljs-number">1</span>,
          <span class="hljs-attr">children</span>: [
            {
              <span class="hljs-attr">label</span>: <span class="hljs-string">'月亮'</span>,
              <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>
            },
            {
              <span class="hljs-attr">label</span>: <span class="hljs-string">'大傻'</span>,
              <span class="hljs-attr">id</span>: <span class="hljs-number">2</span>
            },
            {
              <span class="hljs-attr">label</span>: <span class="hljs-string">'二狗'</span>,
              <span class="hljs-attr">id</span>: <span class="hljs-number">3</span>
            },
            {
              <span class="hljs-attr">label</span>: <span class="hljs-string">'三驴子'</span>,
              <span class="hljs-attr">id</span>: <span class="hljs-number">4</span>
            },
          ]
        }
      ],
      <span class="hljs-attr">filterText</span>: <span class="hljs-string">''</span>
    }
  },
  <span class="hljs-title function_">created</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">showTableData</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">tableData</span>
  },
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-title function_">filterHandle</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">$refs</span>.<span class="hljs-property">treeRef</span>.<span class="hljs-title function_">filter</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">filterText</span>);
    },
    <span class="hljs-title function_">filterNode</span>(<span class="hljs-params">value, data</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">treeFilterPY</span>(data, value, <span class="hljs-variable language_">this</span>.<span class="hljs-property">defaultProps</span>.<span class="hljs-property">label</span>);
    },
  }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"scss"</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
<span class="hljs-selector-class">.screen-view</span> {
  <span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span>;
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">10px</span>;
  <span class="hljs-attribute">box-sizing</span>: border-box;
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[现代 Nginx 优化实践：架构、配置与性能调优]]></title>    <link>https://juejin.cn/post/7578700798743658530</link>    <guid>https://juejin.cn/post/7578700798743658530</guid>    <pubDate>2025-12-01T09:28:12.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578700798743658530" data-draft-id="7577356848337895459" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="现代 Nginx 优化实践：架构、配置与性能调优"/> <meta itemprop="keywords" content="前端,Nginx"/> <meta itemprop="datePublished" content="2025-12-01T09:28:12.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="车前端"/> <meta itemprop="url" content="https://juejin.cn/user/3889431196213664"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            现代 Nginx 优化实践：架构、配置与性能调优
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3889431196213664/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    车前端
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-01T09:28:12.000Z" title="Mon Dec 01 2025 09:28:12 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-01
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作者：王佳月（汽车之家：APP 架构前端工程师）</p>
<h2 data-id="heading-0">现代 Nginx 优化实践：架构、配置与性能调优</h2>
<p>在当今高并发、高可用的 Web 架构中，Nginx 作为反向代理服务器扮演着至关重要的角色。本文将基于实际项目经验，深入探讨现代 Nginx 的优化策略，从基础配置、性能调优、安全加固到高级功能应用，为您提供一套全面且可落地的优化方案。</p>
<h3 data-id="heading-1">一、基础架构与核心配置优化</h3>
<h4 data-id="heading-2">1.1 进程与连接优化</h4>
<p>Nginx 的工作进程配置直接影响其并发处理能力。在项目中，我们采用了以下配置：</p>
<pre><code class="hljs language-nginx" lang="nginx">worker_processes  1;
worker_rlimit_nofile  65535;

events {
  multi_accept        on;
  worker_connections  65535;
}
</code></pre>
<p><strong>优化说明：</strong></p>
<ul>
<li><code>worker_processes</code>：通常设置为 CPU 核心数，但在容器化环境中需根据实际资源分配调整</li>
<li><code>worker_rlimit_nofile</code>：提高单个进程可打开的最大文件数，解决高并发场景下的文件描述符限制</li>
<li><code>multi_accept on</code>：允许 Nginx 同时接受多个连接，提高连接处理效率</li>
<li><code>worker_connections</code>：每个工作进程可同时处理的最大连接数</li>
</ul>
<p><strong>实际效果：</strong> 在我们的项目中，这组配置使单实例 Nginx 能够稳定处理每秒上万级的请求量，CPU 使用率降低约 30%。</p>
<h4 data-id="heading-3">1.2 HTTP 核心模块优化</h4>
<p>项目中的 HTTP 核心优化配置如下：</p>
<pre><code class="hljs language-nginx" lang="nginx">http {
  etag                   off;
  charset                utf-8;
  sendfile               on;
  tcp_nopush             on;
  server_tokens          off;
  log_not_found          off;
  keepalive_timeout      65;
  keepalive_requests     300;

  proxy_intercept_errors on;
  proxy_ignore_client_abort on;
  subrequest_output_buffer_size 3m;
}
</code></pre>
<p><strong>关键优化点：</strong></p>
<ol>
<li><strong>文件传输优化</strong></li>
</ol>
<ul>
<li><code>sendfile on</code>：启用零拷贝技术，减少内核与用户空间之间的数据拷贝</li>
<li><code>tcp_nopush on</code>：与 sendfile 配合使用，在数据包积累到一定大小后再发送，提高网络效率</li>
</ul>
<ol start="2">
<li><strong>连接复用</strong></li>
</ol>
<ul>
<li><code>keepalive_timeout 65</code>：设置长连接超时时间</li>
<li><code>keepalive_requests 300</code>：每个长连接最多处理的请求数，避免单个连接占用过久</li>
</ul>
<ol start="3">
<li><strong>性能与安全平衡</strong></li>
</ol>
<ul>
<li><code>etag off</code>：禁用 ETag，减少带宽消耗和服务器负载</li>
<li><code>server_tokens off</code>：隐藏 Nginx 版本信息，提高安全性</li>
<li><code>log_not_found off</code>：不记录 404 错误，减少磁盘 I/O 和日志体积</li>
</ul>
<ol start="4">
<li><strong>错误处理优化</strong></li>
</ol>
<ul>
<li><code>proxy_intercept_errors on</code>：允许 Nginx 拦截后端服务器的错误响应</li>
<li><code>proxy_ignore_client_abort on</code>：忽略客户端中断连接，确保后端处理不受影响</li>
</ul>
<h3 data-id="heading-4">二、缓存策略与加速优化</h3>
<h4 data-id="heading-5">2.1 高效缓存配置</h4>
<p>项目中实现了精细化的缓存策略，根据资源类型和版本信息应用不同的缓存规则：</p>
<pre><code class="hljs language-nginx" lang="nginx">proxy_cache_path  /var/cache/nginx/static_temp levels=1:2 keys_zone=static_cache:20m max_size=800m inactive=1d use_temp_path=off;

# 针对不同版本的缓存控制
header_filter_by_lua_block {
  local ver = ngx.var.ver
  local cache_ttl
  if ver and (ver == "latest" or ver:match("^%d+%.x$") or ver:match("^%d+%.%d+%.x$")) then
    cache_ttl = 300
  else
    cache_ttl = 31536000
  end

  ngx.header["Cache-Control"] = "public, max-age=" .. cache_ttl
}

# 缓存配置示例
proxy_cache static_cache;
proxy_cache_min_uses 3;
proxy_cache_valid 200 304 30s;
proxy_cache_valid 404 10s;
proxy_cache_valid any 30s;
proxy_cache_use_stale error timeout updating invalid_header http_500 http_502 http_503 http_504;
</code></pre>
<p><strong>缓存优化策略：</strong></p>
<ol>
<li><strong>缓存路径与键值设计</strong></li>
</ol>
<ul>
<li><code>levels=1:2</code>：创建两级目录结构，提高文件系统查找效率</li>
<li><code>keys_zone=static_cache:20m</code>：分配 20MB 内存用于缓存键和元数据</li>
<li><code>max_size=800m</code>：限制缓存大小，防止磁盘空间耗尽</li>
<li><code>inactive=1d</code>：超过 1 天未访问的缓存项将被清理</li>
<li><code>use_temp_path=off</code>：直接在缓存目录中写入，避免额外的文件移动开销</li>
</ul>
<ol start="2">
<li><strong>智能缓存时间策略</strong></li>
</ol>
<ul>
<li>对稳定版本资源设置长缓存时间（31536000 秒 = 1 年）</li>
<li>对开发版、最新版和版本范围（如 1.x）设置短缓存时间（300 秒 = 5 分钟）</li>
<li>根据 HTTP 状态码设置不同的缓存有效期</li>
</ul>
<ol start="3">
<li><strong>高可用性缓存</strong></li>
</ol>
<ul>
<li><code>proxy_cache_use_stale</code>：在后端错误、超时等情况下使用过期缓存，提高系统可用性</li>
<li><code>proxy_cache_min_uses 3</code>：只有请求达到一定次数才会被缓存，避免缓存低频访问的资源</li>
</ul>
<h4 data-id="heading-6">2.2 响应压缩与资源优化</h4>
<p>项目中启用了 Gzip 压缩并进行了针对性优化：</p>
<pre><code class="hljs language-nginx" lang="nginx">gunzip on;
proxy_method GET;
proxy_pass_request_body off;
proxy_pass_request_headers off;
proxy_set_header Accept-Encoding "";
</code></pre>
<p><strong>优化策略：</strong></p>
<ol>
<li><strong>解压缩支持</strong></li>
</ol>
<ul>
<li><code>gunzip on</code>：自动解压缩来自后端的 gzip 压缩响应</li>
</ul>
<ol start="2">
<li><strong>请求优化</strong></li>
</ol>
<ul>
<li>对静态资源请求移除请求体和非必要请求头，减少数据传输量</li>
<li>清除 Accept-Encoding 头，避免多层压缩带来的性能损耗</li>
</ul>
<h4 data-id="heading-7">2.3 图片资源优化</h4>
<p>在图片服务器配置中，实现了自动格式转换和异步裁切：</p>
<pre><code class="hljs language-nginx" lang="nginx"># 异步 AVIF 转换示例
access_by_lua_block {
  local is_match = "业务逻辑判断"

  if is_match then
    自定义业务逻辑
  end
}

# 异常回退机制
proxy_intercept_errors on;
recursive_error_pages on;
error_page 404 502 504 = @fallback;

# 回退到原始格式
location @fallback {
  rewrite ... break;
  # 其他配置...
}
</code></pre>
<p><strong>图片优化技术要点：</strong></p>
<ol>
<li><strong>现代图片格式自动转换</strong></li>
</ol>
<ul>
<li>根据请求路径自动启用格式转换，减少图片大小 30-50%</li>
<li>实现异步裁切，提高响应速度</li>
</ul>
<ol start="2">
<li><strong>降级机制</strong></li>
</ol>
<ul>
<li>当转换失败时，自动回退到原始图片格式，确保服务可用性</li>
</ul>
<h3 data-id="heading-8">三、高可用与负载均衡</h3>
<h4 data-id="heading-9">3.1 多数据中心部署架构</h4>
<p>项目采用了多数据中心部署策略，提高系统可用性：</p>
<pre><code class="hljs language-nginx" lang="nginx"># 集群A
upstream server_a {
  server xx.xx.x.xxx:xx max_fails=2 fail_timeout=2s;
  server xx.xx.x.xxx:xx max_fails=2 fail_timeout=2s;
  keepalive 320;
}

# 集群B
upstream server_b {
  server xx.xx.x.xxx:xx max_fails=2 fail_timeout=2s;
  server xx.xx.x.xxx:xx max_fails=2 fail_timeout=2s;
  keepalive 320;
}
</code></pre>
<p><strong>高可用配置要点：</strong></p>
<ol>
<li><strong>健康检查机制</strong></li>
</ol>
<ul>
<li><code>max_fails=2</code>：允许的失败次数</li>
<li><code>fail_timeout=2s</code>：失败超时时间，超过该时间后将重新检查服务器健康状态</li>
</ul>
<ol start="2">
<li><strong>连接池复用</strong></li>
</ol>
<ul>
<li><code>keepalive 320</code>：为上游服务器维护的空闲连接数，减少频繁建立连接的开销</li>
</ul>
<ol start="3">
<li><strong>备份服务器</strong></li>
</ol>
<ul>
<li>部分 upstream 配置中添加了 <code>backup</code> 标记的服务器，作为灾难恢复使用</li>
</ul>
<h4 data-id="heading-10">3.2 DNS 解析优化</h4>
<p>针对微服务架构中的服务发现，项目进行了 DNS 解析优化：</p>
<pre><code class="hljs language-nginx" lang="nginx">resolver 127.0.0.11 10.33.3.5 10.33.3.6 10.41.0.254 valid=300s ipv6=off;
resolver_timeout 500ms;
</code></pre>
<p><strong>DNS 优化策略：</strong></p>
<ol>
<li><strong>多 DNS 服务器</strong></li>
</ol>
<ul>
<li>配置多个 DNS 服务器，提高解析可靠性</li>
<li>包含 Docker 内部 DNS (127.0.0.11) 和企业内部 DNS 服务器</li>
</ul>
<ol start="2">
<li><strong>缓存与超时控制</strong></li>
</ol>
<ul>
<li><code>valid=300s</code>：DNS 解析结果缓存时间</li>
<li><code>resolver_timeout 500ms</code>：限制 DNS 解析超时时间，避免长时间阻塞</li>
</ul>
<h3 data-id="heading-11">四、安全加固与监控</h3>
<h4 data-id="heading-12">4.1 安全头配置</h4>
<p>项目中实现了全面的安全头设置，防止常见的 Web 攻击：</p>
<pre><code class="hljs language-nginx" lang="nginx"># 移除可能存在的不安全响应头
proxy_hide_header X-Frame-Options;
proxy_hide_header X-XSS-Protection;
proxy_hide_header X-Content-Type-Options;
proxy_hide_header Content-Security-Policy;
proxy_hide_header Strict-Transport-Security;

# 添加安全头
add_header X-XSS-Protection "1; mode=block" always;
add_header X-Content-Type-Options "nosniff" always;
add_header Strict-Transport-Security "max-age=31536000;" always;
</code></pre>
<p><strong>安全头说明：</strong></p>
<ol>
<li><strong>XSS 防护</strong></li>
</ol>
<ul>
<li><code>X-XSS-Protection "1; mode=block"</code>：启用浏览器内置的 XSS 过滤器，检测到攻击时阻止页面加载</li>
</ul>
<ol start="2">
<li><strong>MIME 类型嗅探防护</strong></li>
</ol>
<ul>
<li><code>X-Content-Type-Options "nosniff"</code>：防止浏览器对响应内容进行 MIME 类型嗅探，减少 XSS 攻击面</li>
</ul>
<ol start="3">
<li><strong>HTTPS 强制</strong></li>
</ol>
<ul>
<li><code>Strict-Transport-Security "max-age=31536000;"</code>：强制使用 HTTPS，防止中间人攻击</li>
</ul>
<h4 data-id="heading-13">4.2 请求限制与访问控制</h4>
<p>项目实现了请求方法限制和访问控制：</p>
<pre><code class="hljs language-nginx" lang="nginx"># 限制请求方法
if ($request_method !~ ^(GET|HEAD|POST)$) {
  return 403;
}

# 内部接口访问控制
location /get_versions/ {
  allow 127.0.0.1;
  deny all;
  # 其他配置...
}
</code></pre>
<p><strong>安全访问控制：</strong></p>
<ol>
<li><strong>请求方法限制</strong>：只允许 GET、HEAD、POST 方法，拒绝其他可能带来风险的方法</li>
<li><strong>内部接口保护</strong>：通过 IP 白名单限制内部接口只能由本地访问</li>
</ol>
<h4 data-id="heading-14">4.3 监控与健康检查</h4>
<p>项目实现了完善的监控和健康检查机制：</p>
<pre><code class="hljs language-nginx" lang="nginx"># 健康检查接口
location = /nginx_health_check {
  access_log off;
  add_header Cache-Control "no-store";
  default_type text/plain;
  return 200 "ok";
}

# 状态监控接口
location = /nginx_basic_status {
  access_log off;
  add_header Cache-Control "no-store";
  stub_status on;
  auth_basic "NginxStatus";
  auth_basic_user_file config/ip_passwdfile;
}
</code></pre>
<p><strong>监控功能说明：</strong></p>
<ol>
<li><strong>健康检查</strong>：提供简单的 <code>/nginx_health_check/</code> 接口，用于容器编排系统的健康检查</li>
<li><strong>状态监控</strong>：启用 <code>stub_status</code> 模块，提供详细的 Nginx 运行状态统计
<ul>
<li>包括活跃连接数、接受连接数、处理请求数等关键指标</li>
<li>通过 HTTP 基本认证保护监控接口</li>
</ul>
</li>
</ol>
<h3 data-id="heading-15">五、高级功能与性能优化</h3>
<h4 data-id="heading-16">5.1 客户端真实 IP 获取</h4>
<p>项目实现了可靠的客户端真实 IP 获取机制：</p>
<pre><code class="hljs language-nginx" lang="nginx"># 获取客户端真实IP
map $http_x_forwarded_for $client_real_ip {
  ~^(?P&lt;firstAddr&gt;[\d\.\:A-f]+),?.*$  $firstAddr;
  ""  $remote_addr;
}

# 在 proxy.conf 中传递真实 IP
proxy_set_header X-Real-IP  $client_real_ip;
proxy_set_header X-Forwarded-For  $proxy_add_x_forwarded_for;
</code></pre>
<p><strong>IP 获取策略：</strong></p>
<ol>
<li><strong>多级代理支持</strong>：通过正则表达式从 <code>X-Forwarded-For</code> 头中提取第一个 IP 地址</li>
<li><strong>IPv4/IPv6 兼容</strong>：正则表达式支持匹配 IPv4 和 IPv6 地址格式</li>
<li><strong>默认值处理</strong>：当没有 <code>X-Forwarded-For</code> 头时，回退到直接连接的 IP</li>
</ol>
<h4 data-id="heading-17">5.2 日志优化</h4>
<p>项目对日志记录进行了优化，减少磁盘 I/O 和提高性能：</p>
<pre><code class="hljs language-nginx" lang="nginx"># 不记录 HTTP 状态码为 2xx/3xx 的请求
map $status $loggable {
  default 1;
  ~^[23]  0;
}

# 使用条件日志
access_log /a-one/log/nginx/access.log alternate if=$loggable;
</code></pre>
<p><strong>日志优化策略：</strong></p>
<ol>
<li><strong>选择性日志记录</strong>：只记录错误和异常请求，减少正常请求的日志记录</li>
<li><strong>自定义日志格式</strong>：通过 NJS 模块实现自定义日志格式，满足特定的日志分析需求</li>
</ol>
<h4 data-id="heading-18">5.3 WebSocket 支持</h4>
<p>项目中实现了 WebSocket 协议的支持，用于实时通信场景：</p>
<pre><code class="hljs language-nginx" lang="nginx"># WebSocket 连接头处理
map $http_upgrade $connection_upgrade {
  default upgrade;
  ""      close;
}

# 在 proxy.conf 中配置 WebSocket 支持
proxy_http_version 1.1;
proxy_set_header Upgrade $http_upgrade;
proxy_set_header Connection $connection_upgrade;
</code></pre>
<p><strong>WebSocket 优化：</strong></p>
<ol>
<li><strong>协议升级支持</strong>：正确处理 HTTP 到 WebSocket 的协议升级</li>
<li><strong>长连接维护</strong>：配置 HTTP/1.1 和相应的连接头，确保 WebSocket 连接稳定</li>
</ol>
<h3 data-id="heading-19">六、容器化环境优化</h3>
<p>在 Docker 环境中，项目进行了针对性的优化：</p>
<pre><code class="hljs language-nginx" lang="nginx"># Docker 容器优化
daemon off;  # 前台运行，便于容器管理

# 容器内部 DNS 优先
resolver 127.0.0.11 ...;
</code></pre>
<p><strong>容器化优化要点：</strong></p>
<ol>
<li><strong>前台运行模式</strong>：<code>daemon off</code> 确保 Nginx 运行在前台，便于 Docker 管理进程生命周期</li>
<li><strong>容器网络适配</strong>：优先使用 Docker 内部 DNS 解析服务，提高容器间通信效率</li>
</ol>
<h3 data-id="heading-20">七、优化效果与最佳实践</h3>
<h4 data-id="heading-21">7.1 性能提升效果</h4>
<p>通过上述优化，项目在以下方面取得了显著提升：</p>









































<table><thead><tr><th>优化维度</th><th>优化前</th><th>优化后</th><th>提升百分比</th></tr></thead><tbody><tr><td>请求处理能力</td><td>5k QPS</td><td>20k QPS</td><td>+300%</td></tr><tr><td>平均响应时间</td><td>100ms</td><td>35ms</td><td>-65%</td></tr><tr><td>CPU 使用率</td><td>70%</td><td>40%</td><td>-43%</td></tr><tr><td>内存占用</td><td>512MB</td><td>256MB</td><td>-50%</td></tr><tr><td>缓存命中率</td><td>60%</td><td>90%</td><td>+50%</td></tr></tbody></table>
<h4 data-id="heading-22">7.2 高可用效果</h4>
<ul>
<li><strong>服务可用性</strong>：从 99.9% 提升到 99.99%，每年减少约 8.76 小时的潜在停机时间</li>
<li><strong>故障自动恢复</strong>：通过 <code>proxy_cache_use_stale</code> 和 <code>proxy_next_upstream</code> 配置，实现了在后端服务异常时的自动恢复</li>
<li><strong>多活架构</strong>：公司异地双数据中心部署，确保单点故障不影响整体服务</li>
</ul>
<h4 data-id="heading-23">7.3 安全加固效果</h4>
<ul>
<li><strong>安全扫描评分</strong>：从 75 分提升到 95 分</li>
<li><strong>XSS 防护</strong>：通过安全头配置，有效防御常见的 XSS 攻击</li>
<li><strong>访问控制</strong>：内部接口访问控制有效阻止了未授权访问</li>
</ul>
<h3 data-id="heading-24">八、总结与未来优化方向</h3>
<p>本文结合实际项目，详细介绍了现代 Nginx 的多维度优化策略，包括基础配置优化、缓存策略、高可用架构、安全加固和高级功能应用。这些优化措施在实际生产环境中取得了显著的性能提升和稳定性改善。</p>
<p>未来的优化方向可以考虑：</p>
<ol>
<li><strong>引入 Nginx Plus 或 OpenResty</strong>：利用更高级的功能如动态配置、健康检查等</li>
<li><strong>实现智能缓存预热</strong>：根据访问模式预测性地缓存热点资源</li>
<li><strong>接入可观测性平台</strong>：整合 Prometheus 和 Grafana，实现更细粒度的监控和告警</li>
<li><strong>探索 QUIC/HTTP3 协议</strong>：利用新一代网络协议进一步提升性能</li>
<li><strong>AI 驱动的自动优化</strong>：基于机器学习分析流量模式，自动调整优化参数</li>
</ol>
<p>通过持续优化和监控，Nginx 服务器可以在不断变化的业务需求和技术环境中保持最佳性能和可靠性。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[解决网页前端中文字体包过大的几种方案]]></title>    <link>https://juejin.cn/post/7578699866181238822</link>    <guid>https://juejin.cn/post/7578699866181238822</guid>    <pubDate>2025-12-01T09:36:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578699866181238822" data-draft-id="7578460753210720283" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="解决网页前端中文字体包过大的几种方案"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-01T09:36:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ChangYo"/> <meta itemprop="url" content="https://juejin.cn/user/1212107722329492"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            解决网页前端中文字体包过大的几种方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1212107722329492/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ChangYo
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-01T09:36:04.000Z" title="Mon Dec 01 2025 09:36:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-01
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读16分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>最近想给<a href="https://link.juejin.cn?target=https%3A%2F%2Fchang-yo.github.io" target="_blank" title="https://chang-yo.github.io" ref="nofollow noopener noreferrer">我的博客</a>的网页换个字体，在修复了历史遗留的一些bug之后，去google fonts上找了自己喜欢的字体，本地测试和自己的设备发现没问题后，便以为OK了。</p>
<p>但是当我接朋友的设备打开时，发现网页依然是默认字体。这时候我才发现，我的设备能够翻墙，所以能够使用Google CDN服务，但是对于我的其他读者们，在大陆内是访问不了Google的，便也无法渲染字体了。</p>
<p>于是为了解决这个问题，我尝试了各种办法比如格式压缩，子集化(Subset)，分包等等，最后考虑到本站的实际情况选用了一种比较<em>邪门</em>的方法，让字体压缩率达到了惊人的<strong>98.5%</strong>！于是，这篇文章就是对这个过程的总结。也希望这篇文章能够帮助到你。😊</p>
<hr/>
<p>想要自定义网站的字体，最重要的其实就是字体包的获取。大体上可以分为两种办法：<strong>在线获取</strong>和<strong>网站本地部署</strong>。</p>
<h2 data-id="heading-0">在线获取──利用 CDN 加速服务</h2>
<p>CDN(Content Delivery Network) 意为内容配送网络。你可以简单理解为是一种“就近给你东西”的互联网加速服务。</p>
<p>传统不使用 CDN 服务的是这样的： <code>User ←→ Server</code>,如果相聚遥远，效果显然很差。</p>
<p>使用了 CDN 服务是这样的： <code>User  ←→ CDN Nodes  ←→ Server</code>，CDN 会提前把你的网站静态资源缓存到各个节点，但你需要时可以直接从最近的节点获取。</p>
<p>全球有多家CDN服务提供商，Google Fonts使用的CDN服务速度很快。所以如果在网络畅通的情况下，使用Google Fonts API是最简单省事的！</p>
<p>你可以直接在文件中导入Google fonts API：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-keyword">@import</span> url(<span class="hljs-string">'https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&amp;family=Merriweather:ital,opsz,wght@0,18..144,733;1,18..144,733&amp;family=Noto+Serif+SC:wght@500&amp;display=swap'</span>);
</code></pre>
<p>这样网站它便会自动向最近的Google CDN节点请求资源。</p>
<p>当然，这些都是建立在网络状态畅通无阻的情况下。大陆用户一般使用不了Google服务，但并不意味着无法使用CDN服务。国内的腾讯云，阿里云同样提供高效的服务，但具体的规则我并不了解，请自行阅读研究。</p>
<h2 data-id="heading-1">本地部署</h2>
<p>既然用不了在线的，那就只能将字体包文件一并上传到服务器上了。</p>
<p>这种做法不需要依赖外部服务，但缺点是字体包的文件往往很大，从进入网站到彻底加载完成的时间会及其漫长！而且这种问题尤其在<strong>中日韩</strong>(CJK)字体上体现的十分明显。</p>
<p>以本站为例，我主要采用了三种字体：Merriweather, Inter, Noto Serif SC. 其中每种字体都包含了Bold和Regular两种格式。前面两种都属于西文字体，每种格式原始文件大小都在200kb-300kb,但是到了思源宋体这里，仅仅一种格式的字体包大小就达到了<strong>足足14M多</strong>。如果全部加载完，恐怕从进入网站到完全渲染成功，需要耽误个2分钟。所以将原始字体包文件上传是<strong>极不可取</strong>的做法！</p>
<p>为了解决这个问题，我在网上查阅资料，找到了三种做法。</p>
<h3 data-id="heading-2">字体格式转换(WOFF2)</h3>
<p><strong>WOFF2 (Web Open Font Format 2.0)</strong> 是一种专为 Web 设计的字体文件格式，旨在提供更高的压缩率和更快的加载速度，也是是目前在 Web 上部署自定义字体的推荐标准。它本质上是一种将 TTF 或 OTF 字体数据进行高度压缩后的格式，目前已经获得了所有主流浏览器的广泛支持。</p>
<p>我们可以找一个在线的字体<a href="https://link.juejin.cn?target=https%3A%2F%2Fcloudconvert.com" target="_blank" title="https://cloudconvert.com" ref="nofollow noopener noreferrer">格式转化网站</a>来实现格式的转化。本文我们以<code>NotoSerifSC-Bold.ttf</code>为例，转换后的<code>NotoSerifSC-Bold.woff2</code>文件只有5.8M左右，压缩率达到了60%!</p>
<p>但是，这仍旧是不够的，仅两个中文字体包加起来也已经快12M,还没有算上其他字体。这对于一个网页来说依然是灾难性的。我们必须寻找另一种方法。</p>
<h3 data-id="heading-3">子集化处理(Subset)</h3>
<p>中国人都知道，虽然中文的字符加起来有2万多个，但是我们平常交流基本只会用到3000多个，范围再大一点,6000多个字符已经可以覆盖99%的使用场景。这意味着：</p>
<p><strong>我们根本不需要保留所有字符，而只需要保留常用的几千个汉字即可。</strong></p>
<p>于是这就给了我们解决问题的思路了。</p>
<p>首先我们可以去寻找中文常用汉字字符表，这里我获取的资源是 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fwy-luke%2FAll-Chinese-Character-Set" target="_blank" title="https://github.com/wy-luke/All-Chinese-Character-Set" ref="nofollow noopener noreferrer">All-Chinese-Character-Set</a>。我们将文件下载解压后，可以在里面找到各种各样按照字频统计的官方文件。这里我们就以《通用规范汉字表》（2013年）一级字和二级字为例。我们创建一个文档<code>char_set.txt</code>并将一级字和二级字的内容全部复制进去。这份文档就是我们子集化的对照表。</p>
<p>接着我们需要下载一个字体子集化工具，这里使用的是Python中的<code>fonttools</code>库，它提供了许多工具(比如我们需要的<code>pyftsubset</code>)可以在命令行中执行子集化、字体转化字体操作。</p>
<p>我们安装一下这个库和对应的依赖（在这之前确保你的电脑上安装了<a href="https://link.juejin.cn?target=https%3A%2F%2Fpython.org" target="_blank" title="https://python.org" ref="nofollow noopener noreferrer">Python</a>和<code>pip</code>，后者一般官方安装会自带）</p>
<pre><code class="hljs language-bash" lang="bash">pip install fonttools brotli zopfli
</code></pre>
<p>然后找到我们字体包对应的文件夹，将原来的<code>char_set.txt</code>复制到该文件夹内，在该文件下打开终端，然后以<code>NotoSerifSC-Bold.ttf</code>为例，输入以下命令：</p>
<pre><code class="hljs language-bash" lang="bash">pyftsubset NotoSerifSC-Bold.ttf --output-file=NotoSerifSC-Bold.subset.woff2 --flavor=woff2 --text-file=char_set.txt --no-hinting --with-zopfli
</code></pre>
<p>过一会就能看到会输出一个<code>NotoSerifSC-Bold.subset.woff2</code>的文件。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e31a5317468648ab8666f6ec86283d40~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ2hhbmdZbw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765186563&amp;x-signature=o6r5Mtd%2BsLcloY5%2FQsM4bmOJpLg%3D" alt="font-pic-1.png" loading="lazy"/>
我们欣喜的发现这个文件的大小竟然只有<strong>980KB</strong>。至此，我们已经已经将压缩率达到了<strong>93%</strong>！到这一步，其实直接部署也并没有十分大问题，不过从加载进去到完全渲染，可能依然需要近十秒左右，我们依然还有优化空间。</p>
<h3 data-id="heading-4">分包处理实现动态加载</h3>
<p>这个方法是我阅读<a href="https://link.juejin.cn?target=https%3A%2F%2Fksw.design.donxj.com%2Fknowledge%2Fchinese-web-font-optimize" target="_blank" title="https://ksw.design.donxj.com/knowledge/chinese-web-font-optimize" ref="nofollow noopener noreferrer">这篇文章</a>了解到的，但是遗憾的是我并没有在自己的网站上实现，不过失败的尝试也让我去寻找其它的方法，最终找到适用本站的一种<strong>极限字体渲染</strong>的方法，比这三种的效果还要好。下面我依然简单介绍一下这个方法的原理，想更了解可以通过看到最后通过参考资料去进一步了解。</p>
<p>在2017年，Google Fonts团队提出切片字体，因为他们发现：绝大部分网站只需要加载CJK字体包的小部分内容即可覆盖大部分场景。基于适用频率统计，他们将字符分成多个切片，再按 Unicode 编码对剩余字符进行分类。</p>
<p>怎么理解呢？他其实就是把所有的字符分成许多个小集合，每个集合里面都包含一定数量的字符，在靠前的一些集合中，都是我们常用的汉字，越到后，字形越复杂，使用频率也越低。当网页需要加载字体文件时，它是以<strong>切片</strong>为单位加载的。这意味，只有当你需要用到某个片区的字符时，这个片区才会被加载。</p>
<p>这种方式的好处时，能够大大加快网站加载速率。我们不用每次都一次性把全部字符加载，而是<strong>按需加载</strong>。这项技术如今已经被Noto Sans字体全面采用。</p>
<p>但是我们需要本地部署的话，需要多费一点功夫。这里我们利用中文网字计划的在线分包网站来实现。</p>
<p>我们将需要的字体上传进行分包，可以观察到输出结果是一系列以哈希值命名的woff2文件。分包其实就是做切分，把每个切分后的区域都转化为一份体积极小的woff2文件。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4d74d36fce784ef48ff03f06680d25a0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ2hhbmdZbw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765186563&amp;x-signature=jg%2FtvRwkcXFE8L2PzZB93HgC3Dk%3D" alt="font-pic-2.png" loading="lazy"/>
下载压缩包，然后可以将里面的文件夹导入你的项目，并引用文件夹下的<code>result.css</code>即可。理论上，当网站需要加载渲染某个字体时，它会根据css里面的规则去寻找到对应的分包再下载。每个包的体积极小，网站加载的速度应该提升的很明显。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/daa091871ba343418bcf8008a5ac8098~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ2hhbmdZbw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765186563&amp;x-signature=ktJvicow%2F5P3McnFuDU%2FtJTv340%3D" alt="font-pic-3.png" loading="lazy"/></p>
<h2 data-id="heading-5">我的实践──将字符压缩到极限</h2>
<p>我的方法可以理解为子集化的一种，只不过我的做法更加的极端一些──<strong>只保留文章出现的字符</strong>！</p>
<p>根据统计结果，截止到这篇post发布，我的文章总共出现的所有字符数不到1200个（数据来源见下文），所以我们可以做的更激进一些，只需将文章出现的中文字符全部记录下来，制成一张专属于自己网站的字符表，然后在每次发布文章时动态更新，这样我们能够保证字体完整渲染，并且处于<strong>边界极限</strong>状态！</p>
<p>实现这个个性化字符表<code>char_set.txt</code>的核心是一个提取文章中文字符的算法。这部分我是通过Gemini生成了一个<code>update_lists.cpp</code>文件，他能够识别<code>_posts/</code>下面所有文章，并输出到根目录的<code>char_set.txt</code>中，你可以根据代码内容进行自定义的修改：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">/**
 * @file update_lists.cpp
 * @brief Scans Markdown files in /_posts/ and updates char_set.txt in root.
 * @author Gemini
 * @date 2025-11-28
 */</span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fstream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;vector&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unordered_set&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;filesystem&gt;</span></span>
<span class="hljs-keyword">namespace</span> fs = std::filesystem;
<span class="hljs-keyword">namespace</span> char_collector {
<span class="hljs-type">const</span> std::string kRegistryFilename = <span class="hljs-string">"char_set.txt"</span>;
<span class="hljs-type">const</span> std::string kMarkdownExt = <span class="hljs-string">".md"</span>;

<span class="hljs-type">const</span> <span class="hljs-type">uint32_t</span> kCJKStart = <span class="hljs-number">0x4E00</span>;
<span class="hljs-type">const</span> <span class="hljs-type">uint32_t</span> kCJKEnd = <span class="hljs-number">0x9FFF</span>;

<span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">NextUtf8Char</span><span class="hljs-params">(std::string::const_iterator&amp; it, 
                  <span class="hljs-type">const</span> std::string::const_iterator&amp; end, 
                  <span class="hljs-type">uint32_t</span>&amp; out_codepoint,
                  std::string&amp; out_bytes)</span> </span>{
  <span class="hljs-keyword">if</span> (it == end) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> c1 = <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span>&gt;(*it);
  out_bytes.<span class="hljs-built_in">clear</span>();
  out_bytes += c1;
  <span class="hljs-keyword">if</span> (c1 &lt; <span class="hljs-number">0x80</span>) { out_codepoint = c1; it++; <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>; }
  <span class="hljs-keyword">if</span> ((c1 &amp; <span class="hljs-number">0xE0</span>) == <span class="hljs-number">0xC0</span>) {
    <span class="hljs-keyword">if</span> (std::<span class="hljs-built_in">distance</span>(it, end) &lt; <span class="hljs-number">2</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> c2 = <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span>&gt;(*(it + <span class="hljs-number">1</span>));
    out_codepoint = ((c1 &amp; <span class="hljs-number">0x1F</span>) &lt;&lt; <span class="hljs-number">6</span>) | (c2 &amp; <span class="hljs-number">0x3F</span>);
    out_bytes += *(it + <span class="hljs-number">1</span>); it += <span class="hljs-number">2</span>; <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  }
  <span class="hljs-keyword">if</span> ((c1 &amp; <span class="hljs-number">0xF0</span>) == <span class="hljs-number">0xE0</span>) {
    <span class="hljs-keyword">if</span> (std::<span class="hljs-built_in">distance</span>(it, end) &lt; <span class="hljs-number">3</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> c2 = <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span>&gt;(*(it + <span class="hljs-number">1</span>));
    <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> c3 = <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span>&gt;(*(it + <span class="hljs-number">2</span>));
    out_codepoint = ((c1 &amp; <span class="hljs-number">0x0F</span>) &lt;&lt; <span class="hljs-number">12</span>) | ((c2 &amp; <span class="hljs-number">0x3F</span>) &lt;&lt; <span class="hljs-number">6</span>) | (c3 &amp; <span class="hljs-number">0x3F</span>);
    out_bytes += *(it + <span class="hljs-number">1</span>); out_bytes += *(it + <span class="hljs-number">2</span>); it += <span class="hljs-number">3</span>; <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  }
  <span class="hljs-keyword">if</span> ((c1 &amp; <span class="hljs-number">0xF8</span>) == <span class="hljs-number">0xF0</span>) {
    <span class="hljs-keyword">if</span> (std::<span class="hljs-built_in">distance</span>(it, end) &lt; <span class="hljs-number">4</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> c2 = <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span>&gt;(*(it + <span class="hljs-number">1</span>));
    <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> c3 = <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span>&gt;(*(it + <span class="hljs-number">2</span>));
    <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> c4 = <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span>&gt;(*(it + <span class="hljs-number">3</span>));
    out_codepoint = ((c1 &amp; <span class="hljs-number">0x07</span>) &lt;&lt; <span class="hljs-number">18</span>) | ((c2 &amp; <span class="hljs-number">0x3F</span>) &lt;&lt; <span class="hljs-number">12</span>) | 
                    ((c3 &amp; <span class="hljs-number">0x3F</span>) &lt;&lt; <span class="hljs-number">6</span>) | (c4 &amp; <span class="hljs-number">0x3F</span>);
    out_bytes += *(it + <span class="hljs-number">1</span>); out_bytes += *(it + <span class="hljs-number">2</span>); out_bytes += *(it + <span class="hljs-number">3</span>); it += <span class="hljs-number">4</span>; <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  }
  it++; <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
}

<span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">IsChineseChar</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> codepoint)</span> </span>{
  <span class="hljs-keyword">return</span> (codepoint &gt;= kCJKStart &amp;&amp; codepoint &lt;= kCJKEnd);
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">CharManager</span> {
 <span class="hljs-keyword">public</span>:
  <span class="hljs-built_in">CharManager</span>() = <span class="hljs-keyword">default</span>;

  <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">LoadExistingChars</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; filepath)</span> </span>{
    <span class="hljs-function">std::ifstream <span class="hljs-title">infile</span><span class="hljs-params">(filepath)</span></span>;
    <span class="hljs-keyword">if</span> (!infile.<span class="hljs-built_in">is_open</span>()) {
      
      std::cout &lt;&lt; <span class="hljs-string">"Info: "</span> &lt;&lt; filepath &lt;&lt; <span class="hljs-string">" not found or empty. Starting fresh."</span> &lt;&lt; std::endl;
      <span class="hljs-keyword">return</span>;
    }
    std::string line;
    <span class="hljs-keyword">while</span> (std::<span class="hljs-built_in">getline</span>(infile, line)) {
      <span class="hljs-built_in">ProcessString</span>(line, <span class="hljs-literal">false</span>);
    }
    std::cout &lt;&lt; <span class="hljs-string">"Loaded "</span> &lt;&lt; existing_chars_.<span class="hljs-built_in">size</span>() 
              &lt;&lt; <span class="hljs-string">" unique characters from "</span> &lt;&lt; filepath &lt;&lt; <span class="hljs-string">"."</span> &lt;&lt; std::endl;
  }

  <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">ScanDirectory</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; directory_path)</span> </span>{
    
    <span class="hljs-keyword">if</span> (!fs::<span class="hljs-built_in">exists</span>(directory_path)) {
        std::cerr &lt;&lt; <span class="hljs-string">"Error: Directory '"</span> &lt;&lt; directory_path &lt;&lt; <span class="hljs-string">"' does not exist."</span> &lt;&lt; std::endl;
        <span class="hljs-keyword">return</span>;
    }
    
    <span class="hljs-keyword">for</span> (<span class="hljs-type">const</span> <span class="hljs-keyword">auto</span>&amp; entry : fs::<span class="hljs-built_in">directory_iterator</span>(directory_path)) {
      <span class="hljs-keyword">if</span> (entry.<span class="hljs-built_in">is_regular_file</span>() &amp;&amp; 
          entry.<span class="hljs-built_in">path</span>().<span class="hljs-built_in">extension</span>() == kMarkdownExt) {
        <span class="hljs-built_in">ProcessFile</span>(entry.<span class="hljs-built_in">path</span>().<span class="hljs-built_in">string</span>());
      }
    }
  }

  <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">SaveNewChars</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; filepath)</span> </span>{
    <span class="hljs-keyword">if</span> (new_chars_list_.<span class="hljs-built_in">empty</span>()) {
      std::cout &lt;&lt; <span class="hljs-string">"No new Chinese characters found."</span> &lt;&lt; std::endl;
      <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-function">std::ofstream <span class="hljs-title">outfile</span><span class="hljs-params">(filepath, std::ios::app)</span></span>;
    <span class="hljs-keyword">if</span> (!outfile.<span class="hljs-built_in">is_open</span>()) {
      std::cerr &lt;&lt; <span class="hljs-string">"Error: Could not open "</span> &lt;&lt; filepath &lt;&lt; <span class="hljs-string">" for writing."</span> &lt;&lt; std::endl;
      <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-keyword">for</span> (<span class="hljs-type">const</span> <span class="hljs-keyword">auto</span>&amp; ch : new_chars_list_) {
      outfile &lt;&lt; ch;
    }
    std::cout &lt;&lt; <span class="hljs-string">"Successfully added "</span> &lt;&lt; new_chars_list_.<span class="hljs-built_in">size</span>() 
              &lt;&lt; <span class="hljs-string">" new characters to "</span> &lt;&lt; filepath &lt;&lt; std::endl;
  }

 <span class="hljs-keyword">private</span>:
  std::unordered_set&lt;std::string&gt; existing_chars_;
  std::vector&lt;std::string&gt; new_chars_list_;

  <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">ProcessFile</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; filepath)</span> </span>{
    <span class="hljs-function">std::ifstream <span class="hljs-title">file</span><span class="hljs-params">(filepath)</span></span>;
    <span class="hljs-keyword">if</span> (!file.<span class="hljs-built_in">is_open</span>()) <span class="hljs-keyword">return</span>;
    
    std::cout &lt;&lt; <span class="hljs-string">"Scanning: "</span> &lt;&lt; fs::<span class="hljs-built_in">path</span>(filepath).<span class="hljs-built_in">filename</span>().<span class="hljs-built_in">string</span>() &lt;&lt; std::endl;
    <span class="hljs-function">std::string <span class="hljs-title">content</span><span class="hljs-params">((std::istreambuf_iterator&lt;<span class="hljs-type">char</span>&gt;(file)), 
                         std::istreambuf_iterator&lt;<span class="hljs-type">char</span>&gt;())</span></span>;
    <span class="hljs-built_in">ProcessString</span>(content, <span class="hljs-literal">true</span>);
  }

  <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">ProcessString</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; content, <span class="hljs-type">bool</span> track_new)</span> </span>{
    <span class="hljs-keyword">auto</span> it = content.<span class="hljs-built_in">begin</span>();
    <span class="hljs-keyword">auto</span> end = content.<span class="hljs-built_in">end</span>();
    <span class="hljs-type">uint32_t</span> codepoint;
    std::string bytes;

    <span class="hljs-keyword">while</span> (<span class="hljs-built_in">NextUtf8Char</span>(it, end, codepoint, bytes)) {
      <span class="hljs-keyword">if</span> (<span class="hljs-built_in">IsChineseChar</span>(codepoint)) {
        <span class="hljs-keyword">if</span> (existing_chars_.<span class="hljs-built_in">find</span>(bytes) == existing_chars_.<span class="hljs-built_in">end</span>()) {
          existing_chars_.<span class="hljs-built_in">insert</span>(bytes);
          <span class="hljs-keyword">if</span> (track_new) {
            new_chars_list_.<span class="hljs-built_in">push_back</span>(bytes);
          }
        }
      }
    }
  }
};

} 

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
  char_collector::CharManager manager;
  manager.<span class="hljs-built_in">LoadExistingChars</span>(char_collector::kRegistryFilename);
  manager.<span class="hljs-built_in">ScanDirectory</span>(<span class="hljs-string">"_posts"</span>);
  manager.<span class="hljs-built_in">SaveNewChars</span>(char_collector::kRegistryFilename);
  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p>然后我们在终端编译一下再运行即可：</p>
<pre><code class="hljs language-bash" lang="bash">clang++ update_lists.cpp -o update_lists  &amp;&amp; ./update_lists
</code></pre>
<p>然后我们就会发现这张独属于本站的字符表生成了！🥳
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/05ffd997f8564bad9d3bb99546a870e8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ2hhbmdZbw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765186563&amp;x-signature=WVMW7pygswbSVf%2BZJ%2FS1%2FG%2Ba0wA%3D" alt="font-pic-6.png" loading="lazy"/>
为了方便操作，我们把原始的ttf文件放入仓库的<code>/FontRepo/</code>下（最后记得在<code>.gitignore</code>添加这个文件夹！），然后稍微修改一下之前子集化的命令就可以了：</p>
<pre><code class="hljs language-bash" lang="bash">pyftsubset /FontRepo/NotoSerifSC-Bold.ttf --output-file=/assets/fonts/noto-serif-sc/NotoSerifSC-Bold.subset.woff2 --flavor=woff2 --text-file=char_set.txt --no-hinting --with-zopfli
</code></pre>
<p>可以看到，最终输出的文件只有200K！压缩率达到了98.5%！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0b25f2bf538841908a3efd579697e8d8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ2hhbmdZbw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765186563&amp;x-signature=iUkbqnYTYnb3lNT6ZnMiBZtcw6M%3D" alt="font-pic-4.png" loading="lazy"/>
但是这个方法就像前面说的，处于字体渲染的边界。但凡多出一个字符表中的符号，那么这个字符就无法渲染，会回退到系统字体，看起来格外别扭。所以，在每次更新文章前，我们都需要运行一下<code>./update_lists</code>。此外，还存在一个问题，每次更新产生新的子集化文件时，都需要把旧的子集化文件删除，防止旧文件堆积。</p>
<p>这些过程十分繁琐而且耗费时间，所以我们可以写一个bash脚本来实现这个过程的自动化。我这里同样是求助了Gemini，写了一个<code>build_fonts.sh</code>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>
<span class="hljs-built_in">set</span> -e  <span class="hljs-comment"># 遇到错误立即停止执行</span>

<span class="hljs-comment"># ================= 配置区域 =================</span>
<span class="hljs-comment"># 字体源文件目录</span>
SRC_DIR=<span class="hljs-string">"FontRepo"</span>
<span class="hljs-comment"># 字体输出目录</span>
OUT_DIR=<span class="hljs-string">"assets/fonts/noto-serif-sc"</span>
<span class="hljs-comment"># 字符列表文件</span>
CHAR_LIST=<span class="hljs-string">"char_set.txt"</span>
<span class="hljs-comment"># C++ 更新工具</span>
UPDATE_TOOL=<span class="hljs-string">"./updateLists"</span>

<span class="hljs-comment"># 确保输出目录存在</span>
<span class="hljs-keyword">if</span> [ ! -d <span class="hljs-string">"<span class="hljs-variable">$OUT_DIR</span>"</span> ]; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"创建输出目录: <span class="hljs-variable">$OUT_DIR</span>"</span>
    <span class="hljs-built_in">mkdir</span> -p <span class="hljs-string">"<span class="hljs-variable">$OUT_DIR</span>"</span>
<span class="hljs-keyword">fi</span>

<span class="hljs-comment"># ================= 第一步：更新字符表 =================</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"========================================"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"&gt;&gt; [1/3] 正在更新字符列表..."</span>
<span class="hljs-keyword">if</span> [ -x <span class="hljs-string">"<span class="hljs-variable">$UPDATE_TOOL</span>"</span> ]; <span class="hljs-keyword">then</span>
    <span class="hljs-variable">$UPDATE_TOOL</span>
<span class="hljs-keyword">else</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"错误: 找不到可执行文件 <span class="hljs-variable">$UPDATE_TOOL</span> 或者没有执行权限。"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"请尝试运行: chmod +x updateLists"</span>
    <span class="hljs-built_in">exit</span> 1
<span class="hljs-keyword">fi</span>
<span class="hljs-comment"># 检查 char_set.txt 是否成功生成</span>
<span class="hljs-keyword">if</span> [ ! -f <span class="hljs-string">"<span class="hljs-variable">$CHAR_LIST</span>"</span> ]; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"错误: <span class="hljs-variable">$CHAR_LIST</span> 未找到，字符表更新可能失败。"</span>
    <span class="hljs-built_in">exit</span> 1
<span class="hljs-keyword">fi</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"字符列表更新完成。"</span>
<span class="hljs-comment"># ================= 定义子集化处理函数 =================</span>
<span class="hljs-function"><span class="hljs-title">process_font</span></span>() {
    <span class="hljs-built_in">local</span> font_name=<span class="hljs-string">"<span class="hljs-variable">$1</span>"</span>    <span class="hljs-comment"># 例如: NotoSerifSC-Regular</span>
    <span class="hljs-built_in">local</span> input_ttf=<span class="hljs-string">"<span class="hljs-variable">$SRC_DIR</span>/<span class="hljs-variable">${font_name}</span>.ttf"</span>
    <span class="hljs-built_in">local</span> final_woff2=<span class="hljs-string">"<span class="hljs-variable">$OUT_DIR</span>/<span class="hljs-variable">${font_name}</span>.woff2"</span>
    <span class="hljs-built_in">local</span> temp_woff2=<span class="hljs-string">"<span class="hljs-variable">$OUT_DIR</span>/<span class="hljs-variable">${font_name}</span>.temp.woff2"</span>

    <span class="hljs-built_in">echo</span> <span class="hljs-string">"----------------------------------------"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"正在处理字体: <span class="hljs-variable">$font_name</span>"</span>
    <span class="hljs-comment"># 检查源文件是否存在</span>
    <span class="hljs-keyword">if</span> [ ! -f <span class="hljs-string">"<span class="hljs-variable">$input_ttf</span>"</span> ]; <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"错误: 源文件 <span class="hljs-variable">$input_ttf</span> 不存在！"</span>
        <span class="hljs-built_in">exit</span> 1
    <span class="hljs-keyword">fi</span>

    <span class="hljs-comment"># 2. 调用 fonttools (pyftsubset) 生成临时子集文件</span>
    <span class="hljs-comment"># 使用 --obfuscate-names 可以进一步减小体积，但这里只用基础参数以保证稳定性</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"正在生成子集 (TTF -&gt; WOFF2)..."</span>
    pyftsubset <span class="hljs-string">"<span class="hljs-variable">$input_ttf</span>"</span> \
        --flavor=woff2 \
        --text-file=<span class="hljs-string">"<span class="hljs-variable">$CHAR_LIST</span>"</span> \
        --output-file=<span class="hljs-string">"<span class="hljs-variable">$temp_woff2</span>"</span>
    <span class="hljs-comment"># 3. &amp; 4. 删除旧文件并重命名 (更新逻辑)</span>
    <span class="hljs-keyword">if</span> [ -f <span class="hljs-string">"<span class="hljs-variable">$temp_woff2</span>"</span> ]; <span class="hljs-keyword">then</span>
        <span class="hljs-keyword">if</span> [ -f <span class="hljs-string">"<span class="hljs-variable">$final_woff2</span>"</span> ]; <span class="hljs-keyword">then</span>
            <span class="hljs-built_in">echo</span> <span class="hljs-string">"删除旧文件: <span class="hljs-variable">$final_woff2</span>"</span>
            <span class="hljs-built_in">rm</span> <span class="hljs-string">"<span class="hljs-variable">$final_woff2</span>"</span>
        <span class="hljs-keyword">fi</span>
        
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"重命名新文件: <span class="hljs-variable">$temp_woff2</span> -&gt; <span class="hljs-variable">$final_woff2</span>"</span>
        <span class="hljs-built_in">mv</span> <span class="hljs-string">"<span class="hljs-variable">$temp_woff2</span>"</span> <span class="hljs-string">"<span class="hljs-variable">$final_woff2</span>"</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"&gt;&gt;&gt; <span class="hljs-variable">$font_name</span> 更新成功！"</span>
    <span class="hljs-keyword">else</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"错误: 子集化失败，未生成目标文件。"</span>
        <span class="hljs-built_in">exit</span> 1
    <span class="hljs-keyword">fi</span>
}
<span class="hljs-comment"># ================= 第二步 &amp; 第三步：执行转换 =================</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"========================================"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"&gt;&gt; [2/3] 开始字体子集化处理..."</span>
<span class="hljs-comment"># 处理 Regular 字体</span>
process_font <span class="hljs-string">"NotoSerifSC-Regular"</span>
<span class="hljs-comment"># 处理 Bold 字体</span>
process_font <span class="hljs-string">"NotoSerifSC-Bold"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"========================================"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"&gt;&gt; [3/3] 所有任务圆满完成！"</span>
</code></pre>
<p>如此一来，以后每次更新完文章，都只需要在终端输入<code>./build_fonts.sh</code>就可以完成字符提取、字体包子集化、清除旧字体包文件的过程了。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2ef48ff2a903442a930779b981b9fae7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ2hhbmdZbw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765186563&amp;x-signature=L%2F8VxkmLFV6H7mXsQzQUuw9n%2Fs4%3D" alt="font-pic-5.png" loading="lazy"/></p>
<h2 data-id="heading-6">一点感想</h2>
<p>在这之前另外讲个小故事，我尝试更换字体之前发现自定义的字体样式根本没有用，后来检查了很久，发现竟然是2个月前AI在我代码里加的一句<code>font-family:'Noto Serif SC'</code>,而刚好他修改的又是优先级最高的文件，所以后面怎么修改字体都没有用。所以有时候让AI写代码前最好先搞清除代码的地位i，并且<strong>做好为AI代码后果负全责</strong>的准备。</p>
<p>更改网站字体其实很多时候属于锦上添花的事情，因为很多读者其实并不会太在意网站的字体。但不幸的是我对细节比较在意，或者说有种敝帚自珍的感觉吧，想慢慢地把网站装饰得舒适一些，所以才总是花力气在一些细枝末节的事情上。更何况，我是懂一点点设计的，有时候看见一些非常丑的Interface心里是很难受的。尽管就像绝大部分人理解不了设计师在细节上的别有用心一样，绝大部分人也不会在意一个网站的字体如何，但是我自己的家，我想装饰地好看些，对我来说就满足了。</p>
<p>更不要说，如果不去折腾这些东西，怎么可能会有这篇文章呢？如果能够帮助到一些人，也算是在世界留下一点价值了。</p>
<h2 data-id="heading-7">参考资料及附录</h2>
<ol>
<li>
<p>参考资料</p>
<p>a. <a href="https://link.juejin.cn?target=https%3A%2F%2Fksw.design.donxj.com%2Fknowledge%2Fchinese-web-font-optimize" target="_blank" title="https://ksw.design.donxj.com/knowledge/chinese-web-font-optimize" ref="nofollow noopener noreferrer">网页中文字体加载速度优化</a></p>
<p>b. <a href="https://link.juejin.cn?target=https%3A%2F%2Fweb.dev%2Farticles%2Freduce-webfont-size%3Fhl%3Dzh-cn" target="_blank" title="https://web.dev/articles/reduce-webfont-size?hl=zh-cn" ref="nofollow noopener noreferrer">缩减网页字体大小</a></p>
<p>c. <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fwy-luke%2FAll-Chinese-Character-Set" target="_blank" title="https://github.com/wy-luke/All-Chinese-Character-Set" ref="nofollow noopener noreferrer">All-Chinese-Character-Set</a></p>
</li>
<li>
<p>让Gemini生成代码时的Prompt:</p>
</li>
</ol>
<pre><code class="hljs language-plaintext" lang="plaintext">---Prompt 1---
# 任务名称：创建脚本实现对字符的收集
请利用C++来完成一下任务要求：
1. 该脚本能够读取项目目录下的markdown文件，并且能够识别当中所有的中文字符，将该中文字符与`/char_test/GeneralUsedChars.txt`的字符表进行查重比较：
   若该字在表中存在，则跳过，处理下一个字；
   若不存在，则将该字添加到表中，然后继续处理下一个字符
2. 请设计一个高效的算法，尤其是在字符查重的过程中，你需要设计一个高效且准确率高的算法
3. 请注意脚本的通用性，你需要考虑到这个项目以后可能会继续增加更多的markdown文件，所以你不应该仅仅只是处理现有的markdown文件，还需要考虑到以后的拓展性
4. 如果可以的话，尽可能使用C++来实现，因为效率更高

---Prompt 2---
可以了，现在我要求你编写一个脚本以实现自动化，要求如下：
1. 脚本运行时，首先会调用项目根目录下的updateLists可执行文件，更新char_set.txt
2. 接着，脚本会调用fonttools工具，对路径在`/FontRepo/`下的两个文件进行ttf到woff2的子集化转化，其中这两个字体文件的名字分别为`NotoSerifSC-Regular.ttf`和`NotoSerifSC-Bold.ttf`。
3. 转化好的子集文件应该输出到 `/assets/fonts/noto-serif-sc/`文件夹下。
4. 将`/assets/fonts/noto-serif-sc/`文件夹下原本已经存在的两个字体文件`NotoSerifSC-Bold.woff2`和`NotoSerifSC-Regular.woff2`删除，然后将新得到子集化文件重新命名为这两个删除了的文件的名字。这一步相当于完成了字体文件的更新

请注意文件的命名，尤其是不要搞错字号，新子集文件和旧子集文件。
请注意在子集化步骤的bash命令，环境已经安装好fonttools及其对应依赖，你可以参考下面这个命令来使用，或者使用更好更稳定的用法：
pyftsubset &lt;path/to/ttf/file&gt; --flavor=woff2 --text-file=&lt;path/to/char_set.txt&gt; --output-file=&lt;the/subset/name&gt;
(再次注意输出路径)
</code></pre>
<ol start="3">
<li>最终实践效果(以<code>NotoSerifSC-Bold</code>为例)



































<table><thead><tr><th align="left">处理方式</th><th align="left">字体包体积</th><th align="left">压缩率</th></tr></thead><tbody><tr><td align="left">无处理</td><td align="left">14.462M</td><td align="left">0%</td></tr><tr><td align="left">格式转化</td><td align="left">5.776M</td><td align="left">60.06%</td></tr><tr><td align="left">子集化处理</td><td align="left">981K</td><td align="left">93.21%</td></tr><tr><td align="left">分包处理</td><td align="left">依据动态加载量而定</td><td align="left">无</td></tr><tr><td align="left">我的实践</td><td align="left">216K</td><td align="left">98.5%</td></tr></tbody></table>
</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Three.js 坐标系完全入门：从“你在哪”到“你爸在哪”都讲清楚了]]></title>    <link>https://juejin.cn/post/7578820431017574415</link>    <guid>https://juejin.cn/post/7578820431017574415</guid>    <pubDate>2025-12-01T09:43:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578820431017574415" data-draft-id="7578683148210585652" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Three.js 坐标系完全入门：从“你在哪”到“你爸在哪”都讲清楚了"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-01T09:43:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="一千柯橘"/> <meta itemprop="url" content="https://juejin.cn/user/2010369939736343"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Three.js 坐标系完全入门：从“你在哪”到“你爸在哪”都讲清楚了
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2010369939736343/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    一千柯橘
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-01T09:43:10.000Z" title="Mon Dec 01 2025 09:43:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-01
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{position:relative;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:30px;margin-bottom:5px}.markdown-body h2{font-size:24px;display:inline-block;font-weight:700;background:#ef7060;color:#fff;padding:6px 8px 0 0;border-top-right-radius:6px;margin-right:2px;box-shadow:6px 3px 0 0 rgba(239,112,96,.2)}.markdown-body h2:before{content:" ";display:inline-block;width:8px}.markdown-body h2:after{content:" ";position:absolute;display:block;width:calc(100% - 50px);border-bottom:3px solid #ef7060}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #3e3e3e;margin-top:32px;margin-bottom:32px;height:1px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(27,31,35,.05);color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:JetBranins Mono,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px;background-color:#fdfdfd}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#fdfdfd}.markdown-body a{text-decoration:none;font-weight:700;color:#ef7060;border-bottom:1px solid #ef7060}.markdown-body a:active,.markdown-body a:hover{color:#ef2d26}.markdown-body table tr td,.markdown-body table tr th{border:1px solid #ccc;padding:5px 10px}.markdown-body table{display:block!important;width:auto;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{background:#f0f0f0;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#f8f8f8}.markdown-body blockquote{margin-inline-start:0;margin-inline-end:0;border-left:3px solid #ef7060;background:#fff9f9;padding:1px 20px;margin-top:20px}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atelier-sulphurpool-dark">.hljs-comment,.hljs-quote{color:#898ea4}.hljs-attribute,.hljs-link,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#c94922}.hljs-built_in,.hljs-builtin-name,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#c76b29}.hljs-bullet,.hljs-string,.hljs-symbol{color:#ac9739}.hljs-section,.hljs-title{color:#3d8fd1}.hljs-keyword,.hljs-selector-tag{color:#6679cc}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#202746;color:#979db4}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>当你打开 Three.js 写 3D 场景时，第一个要搞懂的问题就是：</p>
<p><strong>一个物体到底摆在哪里？</strong></p>
<p>别小看这个问题。你觉得一个立方体在世界坐标 (3,0,0)，结果它移动后出现在奇怪的位置，十次里有九次是因为——</p>
<p>👉 <strong>你忘了它有个“爸爸”。</strong></p>
<p>今天我们就用一个超通俗的方式，把 Three.js 的坐标讲清楚。看完这篇文章，你会明白：</p>
<ul>
<li>世界坐标（World Coordinates）和本地坐标（Local Coordinates）到底怎么回事？
<ul>
<li>世界坐标，基准点为固定原点(0,0,0)，描述物体在<strong>整个场景中的绝对位置</strong></li>
<li>局部/本地坐标，基准点为物体自身的几何中心（中心点），描述子物体相对于<strong>父物体的位置</strong></li>
</ul>
</li>
<li>子对象相对于父对象的坐标是怎么计算的？</li>
<li>为什么把 cube 放进 parentCube 后，位置就“变了”？</li>
<li>实战代码是如何运行的？</li>
</ul>
<p>准备好了吗？开始！</p>
<hr/>
<h2 data-id="heading-0">🧱 1. 世界坐标：整个世界的“绝对地址”</h2>
<p>在 Three.js 中，有一个你永远逃不掉的概念：</p>
<blockquote>
<p><strong>世界坐标（World Coordinates）就是所有物体的绝对位置。</strong></p>
</blockquote>
<p>比如：</p>
<pre><code class="hljs language-js" lang="js">cube.<span class="hljs-property">position</span>.<span class="hljs-title function_">set</span>(<span class="hljs-number">3</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
scene.<span class="hljs-title function_">add</span>(cube);
</code></pre>
<p>意思很简单：</p>
<blockquote>
<p>cube 在世界的 x=3 的位置。</p>
</blockquote>
<p>就像你告诉朋友：“我在北京”。</p>
<p>无论你爸在哪，你都在北京。</p>
<h2 data-id="heading-1">👨‍👦 2. 本地坐标：相对于“父元素”的位置</h2>
<p>但如果你写了：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> parentCube = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Mesh</span>(geometry, parentMaterial);
parentCube.<span class="hljs-title function_">add</span>(cube);
</code></pre>
<p>事情就不一样了。</p>
<p>cube 就有了一个“爸爸” parentCube。</p>
<p>此时你再写：</p>
<pre><code class="hljs language-js" lang="js">cube.<span class="hljs-property">position</span>.<span class="hljs-title function_">set</span>(<span class="hljs-number">3</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
scene.<span class="hljs-title function_">add</span>(parentCube);
</code></pre>
<p>这句话就变成：</p>
<blockquote>
<p>cube 在 <strong>parentCube 的局部空间中</strong>，相对于父物体，往 x 正方向移动 3。</p>
</blockquote>
<p>也就是说：</p>
<ul>
<li>parentCube 就像一个<strong>坐标参照系</strong>。</li>
<li>cube 相当于在这个内部空间里移动。</li>
</ul>
<p>这就好比你说：</p>
<blockquote>
<p>“我离我爸三米远。”</p>
</blockquote>
<p>但你爸在北京，你也就实际上<strong>还是在北京附近</strong>。</p>
<h2 data-id="heading-2">⚙️ 3. 回到你的示例：它到底发生了什么？</h2>
<p>你写的代码如下：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> cube = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Mesh</span>(geometry, material);

<span class="hljs-keyword">const</span> parentCube = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Mesh</span>(geometry, parentMaterial);
parentCube.<span class="hljs-title function_">add</span>(cube);
parentCube.<span class="hljs-property">position</span>.<span class="hljs-title function_">set</span>(-<span class="hljs-number">3</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);

<span class="hljs-comment">// cube.position.x = 1;</span>
<span class="hljs-comment">// cube 的坐标是相对于 parentCube 的，所以在页面上可以看到 cube 相对于 parentCube（父元素）向右移动到了原点坐标处</span>
cube.<span class="hljs-property">position</span>.<span class="hljs-title function_">set</span>(<span class="hljs-number">3</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
</code></pre>
<p>让我们逐步理解发生了什么。</p>
<h3 data-id="heading-3">🟦 第一步：parentCube 放在世界坐标 (-3,0,0)</h3>
<p>这意味着：</p>
<blockquote>
<p>“爸爸站在世界左边 3 单位的位置。”</p>
</blockquote>
<h3 data-id="heading-4">🟦 第二步：cube 相对“爸爸”往右移动 3 个单位</h3>
<p>cube.position.set(3,0,0) 的意思是：</p>
<blockquote>
<p>cube 在父对象内部向右移动 3。</p>
</blockquote>
<p>也就是说：</p>
<p>👉 <strong>cube 的世界坐标 = 父对象世界坐标 + 自己的本地坐标</strong></p>
<p>计算一下：</p>
<ul>
<li>父对象在世界: (-3, 0, 0)</li>
<li>cube 在本地: (+3, 0, 0)</li>
</ul>
<p>所以 cube 在世界中的真实位置：</p>
<pre><code class="hljs language-js" lang="js">世界位置 = (-<span class="hljs-number">3</span>) + <span class="hljs-number">3</span> = <span class="hljs-number">0</span>
</code></pre>
<p>——刚好回到了世界原点！🎯</p>
<p>这就是你看到：</p>
<blockquote>
<p>cube “看起来回到了原点”。</p>
</blockquote>
<h2 data-id="heading-5">🎯 4. 一个超形象的比喻：三.js 坐标 = 现实世界的“你”和“你爸”</h2>
<ul>
<li><strong>世界坐标</strong>：你住在北京就是北京，这是全世界都懂的绝对坐标。</li>
<li><strong>本地坐标</strong>：你说“我离我爸三米远”，那你得先知道你爸在哪。</li>
<li><strong>父对象移动时，子对象跟着被整体移动</strong>：因为你爸挪窝了，你当然也跟着挪了。</li>
</ul>
<p>这就是 parent.add(child) 的意义：</p>
<blockquote>
<p><strong>你把 child 的命运交给了 parent。</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-6">🧪 5. 实战代码：一眼看懂坐标关系</h2>
<p>完整例子如下：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 父立方体</span>
<span class="hljs-keyword">const</span> parentCube = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Mesh</span>(geometry, parentMaterial);
scene.<span class="hljs-title function_">add</span>(parentCube);
parentCube.<span class="hljs-property">position</span>.<span class="hljs-title function_">set</span>(-<span class="hljs-number">3</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);

<span class="hljs-comment">// 子立方体</span>
<span class="hljs-keyword">const</span> cube = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Mesh</span>(geometry, material);
parentCube.<span class="hljs-title function_">add</span>(cube);

<span class="hljs-comment">// cube 不是在世界坐标移动，而是在父坐标系中移动</span>
cube.<span class="hljs-property">position</span>.<span class="hljs-title function_">set</span>(<span class="hljs-number">3</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/95b131c9d0fa47788f4eb75ae8976c74~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5Y2D5p-v5qmY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765186989&amp;x-signature=omf32FmH9zi5Zbgy9%2BD%2BIJot%2B2w%3D" alt="image.png" loading="lazy"/></p>
<p>运行后你会看到：</p>
<ul>
<li>parentCube 在世界左边 (-3,0,0)</li>
<li>cube 在 parentCube 内部向右移动 3( cube 的参考点变成了 parentCube)</li>
<li>所以 cube 的世界位置被“抵消掉”，回到原点</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[同事：架构太复杂了，源码文件找半天。 我：源码溯源了解一下？]]></title>    <link>https://juejin.cn/post/7578460753210966043</link>    <guid>https://juejin.cn/post/7578460753210966043</guid>    <pubDate>2025-12-01T09:52:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578460753210966043" data-draft-id="7578511778889416742" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="同事：架构太复杂了，源码文件找半天。 我：源码溯源了解一下？"/> <meta itemprop="keywords" content="前端,Vue.js"/> <meta itemprop="datePublished" content="2025-12-01T09:52:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="独角仙梦境"/> <meta itemprop="url" content="https://juejin.cn/user/1176897909428464"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            同事：架构太复杂了，源码文件找半天。 我：源码溯源了解一下？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1176897909428464/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    独角仙梦境
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-01T09:52:18.000Z" title="Mon Dec 01 2025 09:52:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-01
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="" data-highlight-key="a11y-light">.hljs-comment,.hljs-quote{color:#696969}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#d91e18}.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#aa5d00}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:green}.hljs-section,.hljs-title{color:#007faa}.hljs-keyword,.hljs-selector-tag{color:#7928a1}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fefefe;color:#545454}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h2 data-id="heading-0">背景</h2>
<hr/>
相信刚入行，或是刚入行的小伙伴们，对于企业级代码与架构，以及扑面而来业务需求。想要在短时间内从对应的页面定位到组件时，是很难办到的事情，尤其是突然交给一个陌生的项目的需求，问题也会比较突出。
<p>尤其是对于鼠鼠我本人来说，也是深有体会：司内的源码架构：<strong>自研微前端+monorepo架构</strong>，本身架构设计本身就比较复杂，在项目规模达到一定程度，或是项目开发时间长，人员变动大，就会导致有很多问题出现，就比如ld统计过 <strong>.vue文件</strong>已经8000个了，代码中有<strong>2250对</strong>重复的源代码文件。总计重复代码行数: <strong>69578</strong> <strong>行</strong> 🤯🤯🤯</p>
<p>在这样的情况下，一款能够快速定位源码的插件呼之欲出🎉🎉🎉</p>
<hr/>
通过本篇文章，大家能学习到：
<blockquote>
<ol>
<li>如何编写一个简易的vite插件</li>
<li>vite插件的生命周期是怎么样的</li>
<li>源码溯源，快速定位：<strong>实现思路，原理</strong></li>
</ol>
</blockquote>
<p>首先准备好实验环境：<strong>vue+vite+pnpm</strong> 让cursor快速生成一个项目即可</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3a20b5707c55461790fa9c0155245445~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54us6KeS5LuZ5qKm5aKD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765187538&amp;x-signature=mc1XxAvuLNjn6U9q%2FIkK3Xa7DQo%3D" alt="image.png" loading="lazy"/></p>
<p>在正式将<strong>源码定位</strong>之前，我想讲讲一个简易的vite插件该如何实现，这对我们后面的学习会有比较有效的帮助</p>
<h2 data-id="heading-1">如何写Vite插件</h2>
<p>再讲如何编写vite插件之前，需要先了解一下如何将自己编写的vite插件在Vite的构建流程中生效：</p>
<p>Vite插件本质是一个对象，通过到处一个对象函数，放入Vite配置项数组中即可实现效果：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0ce09192b6324b73b5673d7543a5881e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54us6KeS5LuZ5qKm5aKD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765187538&amp;x-signature=Qn5FgGQ0LzTGBmX7jmXJeYS2GvQ%3D" alt="" loading="lazy"/></p>
<p>在配置文件中：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/46d4f73c560740debcb791fff45fa8ca~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54us6KeS5LuZ5qKm5aKD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765187538&amp;x-signature=l2wHfQQXBVarVVkQfa%2BZ6lJ%2BDJU%3D" alt="" loading="lazy"/></p>
<p>那么作为Vite的自定义插件，和webpack一样，需要使用各种生命周期钩子，才能实现对应的效果：</p>
<p>这里介绍一下主流的生命周期钩子：</p>
<h3 data-id="heading-2">主流钩子</h3>
<h4 data-id="heading-3">配置阶段：</h4>
<p><strong>config(config,</strong> <strong>env</strong> <strong>):</strong></p>
<ul>
<li>
<p><strong>触发时机：当vite读取配置时触发</strong></p>
</li>
<li>
<p><strong>常用场景：修改或扩展配置对象</strong></p>
</li>
</ul>
<p><strong>configResolved(resolvedConfig):</strong></p>
<ul>
<li>
<p><strong>触发时机：当配置解析完成时触发</strong></p>
</li>
<li>
<p><strong>常用场景：获取最终配置，初始化插件状态</strong></p>
</li>
</ul>
<blockquote>
<p>该阶段主要用于插件初始化或读取用户配置，不是必须</p>
</blockquote>
<h4 data-id="heading-4">构建阶段</h4>
<p><strong>buildStart:</strong></p>
<ul>
<li>
<p><strong>触发时机： 构建开始</strong></p>
</li>
<li>
<p><strong>常用场景： 初始化状态，打印日志，准备数据</strong></p>
</li>
</ul>
<p><strong>buildEnd:</strong></p>
<ul>
<li>
<p><strong>触发时机： 构建结束</strong></p>
</li>
<li>
<p><strong>常用场景：收尾，打印统计</strong></p>
</li>
</ul>
<p><strong>closeBundle：</strong></p>
<ul>
<li>
<p><strong>触发时机：构建完成并生成文件后</strong></p>
</li>
<li>
<p><strong>常用场景：做最终清理或发布的操作</strong></p>
</li>
</ul>
<blockquote>
<p>主要用于插件需要做全局初始化或构建后操作的场景</p>
</blockquote>
<h4 data-id="heading-5">模块解析和加载阶段</h4>
<p><strong>resolveId(id,importer)</strong></p>
<ul>
<li>
<p><strong>触发时机：解析模块路径时</strong></p>
</li>
<li>
<p><strong>常用场景：重写模块路径，生成虚拟模块</strong></p>
</li>
</ul>
<p><strong>load(id)</strong></p>
<ul>
<li>
<p><strong>触发时机：模块加载内容</strong></p>
</li>
<li>
<p><strong>常用场景：返回模块代码，生成虚拟模块</strong></p>
</li>
</ul>
<p><strong>moduleParsed</strong></p>
<ul>
<li>
<p><strong>触发时机：模块</strong> <strong>AST</strong> <strong>解析完成</strong></p>
</li>
<li>
<p><strong>常用场景：分析模块</strong> <strong>AST</strong> <strong>，做统计或收集信息</strong></p>
</li>
</ul>
<blockquote>
<p>核心点：虚拟模块一般用 <code>resolveId</code> + <code>load</code>，处理源码前可以分析 AST。</p>
</blockquote>
<h4 data-id="heading-6">模块transform阶段（最常用）</h4>
<p><strong>thransform(code,id)</strong></p>
<ul>
<li>
<p><strong>触发时机：模块加载后，打包前</strong></p>
</li>
<li>
<p><strong>常用场景：核心 hook，用于修改</strong> <strong>源码</strong> <strong>、注入代码、操作 Vue/</strong> <strong>JSX</strong> ****<strong>AST</strong></p>
</li>
</ul>
<p><strong>transformIndexHtml</strong></p>
<ul>
<li>
<p><strong>触发时机：</strong> <strong>HTML</strong> <strong>文件处理阶段</strong></p>
</li>
<li>
<p><strong>常用场景：修改</strong> <strong>HTML</strong> <strong>模版，例如注入script，link</strong></p>
</li>
</ul>
<blockquote>
<p><strong>transform 是最主流的钩子</strong>，几乎所有插件都至少用它做一次源码修改。</p>
</blockquote>
<p>整个构建生命周期流程图来看是这样的：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d7a3e9a791bf451f88e39234129420f0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54us6KeS5LuZ5qKm5aKD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765187538&amp;x-signature=ZbajEJepcO4Cmb9WXaGNYuv21o8%3D" alt="image.png" loading="lazy"/></p>
<p>针对LLM返回给我们的主流钩子使用频率来看，我们优先掌握的肯定就是：<strong>模块 transform 阶段</strong>，因为这个阶段是能够直接接触的源代码，更容易在源代码上动手脚的阶段。</p>
<h3 data-id="heading-7"><strong>模块 transform 阶段</strong></h3>
<p>好记性不如烂笔头，让我们实战来看看，这个阶段能够做什么呢？</p>
<h4 data-id="heading-8">什么是transform阶段</h4>
<p>在Vite的构建过程中，一个文件会从<strong>源码</strong> <strong>-&gt; 浏览器</strong>可执行文件，会经历很多处理环节。比如：</p>
<ul>
<li>TS-&gt; js</li>
<li>JSX -&gt; JS</li>
<li>VUE单文件组件拆成JS，CSS</li>
<li>去掉console.log</li>
<li>注入HMR代码</li>
<li>压缩</li>
</ul>
<p><strong>而 transform 就是 Vite 插件体系里专门负责“把代码转成新代码”的阶段</strong>。</p>
<h4 data-id="heading-9">transform的函数签名</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title function_">transform</span>(<span class="hljs-params">code, id</span>) {
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">code</span>: <span class="hljs-string">'新的代码'</span>,
    <span class="hljs-attr">map</span>: <span class="hljs-literal">null</span>, <span class="hljs-comment">// 或 sourcemap</span>
  }
}
</code></pre>
<ol>
<li><strong>Code： 当前拿到的文件</strong> <strong>源码</strong></li>
<li><strong>id：当前文件的绝对路径</strong></li>
</ol>
<p><strong>返回值：</strong></p>
<ol>
<li>返回一个字符串：</li>
</ol>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">return</span> transformedCode
</code></pre>
<p>说明只<strong>修改了代码</strong>，不管 source map，由 Vite 自动处理部分情况。</p>
<p>⚠️ 但 source map 会丢失或错误。</p>
<ol start="2">
<li>返回一个包含code+map的对象</li>
</ol>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">return</span> {
  <span class="hljs-attr">code</span>: transformedCode,
  <span class="hljs-attr">map</span>: <span class="hljs-literal">null</span>  <span class="hljs-comment">// 或 SourceMap 对象</span>
}
</code></pre>
<ul>
<li>Vite 会继续把 map 传给下一环</li>
<li>最终映射会合并到 browser source map</li>
<li>对 HMR Debug 友好</li>
</ul>
<p>若map为null时，让vite自己处理</p>
<ol start="3">
<li>返回为null或undefined</li>
</ol>
<ul>
<li>表示我不处理这个模块，让下个插件处理。即：<strong>跳过这个阶段的</strong></li>
</ul>
<h4 data-id="heading-10">何时会触发transform</h4>
<ol>
<li><strong>开发（</strong> <strong>dev</strong> <strong>server）</strong> ：Vite 在浏览器请求模块时，先 <code>resolveId</code> → <code>load</code>（读文件）→ <code>transform</code> → 返回给浏览器（并缓存结果）。</li>
<li><strong>构建（build）</strong> ：Rollup 打包流程，Vite 基于 Rollup 插件接口执行，顺序类似：<code>resolveId</code> → <code>load</code> → <code>transform</code> → 打包。</li>
<li>对于 SFC（例如 Vue 单文件组件），一个 <code>.vue</code> 会被拆成多个请求（script/template/style），每个子模块都会走 <code>transform</code>，因此你会看到同一个文件被多次 <strong>transform</strong>（通过 <code>id</code> 的 query 区分）。</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/321133fe4e2947f1b361c6e62b8bfb22~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54us6KeS5LuZ5qKm5aKD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765187538&amp;x-signature=V8Lr04AKUg8SO3FQt%2BnwBSEiURs%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-11">源码溯源</h2>
<h3 data-id="heading-12">为什么需要源码溯源插件</h3>
<p>谈到为什么需要<strong>源码</strong> <strong>溯源</strong>。就得提到司内的源码架构：<strong>自研微前端+monorepo架构</strong>，本身架构设计本身就比较复杂，在项目规模达到一定程度，或是项目开发时间长，人员变动大，就会导致有很多问题出现，就比如ld统计过 <strong>.vue文件</strong>已经8000个了，代码中有<strong>2250对</strong>重复的源代码文件。总计重复代码行数: <strong>69578</strong> <strong>行，</strong> 所以我们拟设计一款Vite插件配合油猴脚本，能够识别一个页面的所有组件，通过click，能够快速定位到对应的component。</p>
<h3 data-id="heading-13">设计思路是什么？</h3>
<h5 data-id="heading-14">目标：</h5>
<p>我们想要实现一个<strong>所见即所得</strong>模式，即能够清楚的看到一个页面由哪些组件组成，并且可以看到对应的组件渲染了页面的哪些地方，并且点击对应模块后，能够立马弹出组件对应的绝对路径，方便直接去寻找到对应的组件。</p>
<p>具体体现成什么样呢？这里起一个简单的小项目给大家看看</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/582218925347425e9c1110ec0d497eac~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54us6KeS5LuZ5qKm5aKD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765187538&amp;x-signature=JwU5ihukifeHnO6rgwpZ6Bl0exU%3D" alt="image.png" loading="lazy"/></p>
<p>是一个很简单的小架构，当我们想要知道头部组件在对应源代码的哪个位置时，我们点击他：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b08897ca2430454193cd425dee446eb1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54us6KeS5LuZ5qKm5aKD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765187538&amp;x-signature=OXBGZLNAZg6fdAIyS9xoGQx%2BE10%3D" alt="image.png" loading="lazy"/></p>
<p>第一个就是头部组件对应的组件路径，下面的就是其父组件，方便我们了解嵌套关系。</p>
<h5 data-id="heading-15">具体思路：</h5>
<p>首先我们需要知道一件事情，浏览器最后渲染的内容，拿到的源文件是经过<strong>构建工具的转译，压缩，打包</strong>后的<strong>源代码</strong>，与自己实际开发是天壤之别，所以针对<strong>打包后的源代码溯源</strong>是不切实际的。所以我们的思路是：</p>
<ol>
<li>需要在构建阶段，针对<strong>对应文件</strong>进行处理</li>
<li>具体处理就是将对应文件的<strong>绝对路径</strong>，通过某些方式，在构建后，<strong>保存到</strong> <strong>源代码</strong></li>
<li>再通过<strong>油猴插件</strong>，在浏览器中执行脚本，该脚本核心代码就是提取到点击模块对应的保存的绝对路径进行转译渲染出来，成为图片中的样式。</li>
</ol>
<h5 data-id="heading-16">具体实现：</h5>
<ol>
<li>
<p>编写自定义vite插件，插件用处：在每个组件的根元素中添加自定义属性，内容为该文件绝对路径的编码形式存储在此。</p>
</li>
<li>
<p>将根元素的自定义属性值广播到子组件的类型中，任何你想点击/调试的元素都带有足够的信息</p>
</li>
<li>
<p>编写js脚本，核心在于提取到点击对应元素，能够快速识别转译出路径，并渲染到弹窗。</p>
</li>
</ol>
<h4 data-id="heading-17">vite插件如何编写？</h4>
<p>在编写插件前，我们需要明确我们插件需要做什么：</p>
<ul>
<li><strong>每个Vue文件中的根元素，添加对应的自定义属性，属性值填的是对应路径的编码。</strong></li>
</ul>
<p>那么针对这个需求，我们首先需要分析，<strong>要使用哪个生命周期钩子才能实现对应的效果？</strong></p>
<p>搜索过后，发现<strong>thransform(code,id)</strong> 这个钩子能够帮助我们实现我们想要的效果。</p>
<blockquote>
<p>transform 是 Vite 插件体系里的编译钩子。每当 Vite 正在加载某个模块（无论是 .ts、.vue 还是别的可处理资源），都会把“源代码字符串 + 模块 id（含绝对路径/查询参数）”传进每个插件的 <strong>transform(code, id)</strong> ，让插件有机会在官方编译器运行前对<strong>源码</strong> <strong>做一次改写、替换或分析</strong>。</p>
</blockquote>
<p>最后效果如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bb8299cdafe74635ad2b2d2a0407c7f6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54us6KeS5LuZ5qKm5aKD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765187538&amp;x-signature=%2Fyw5M7SN3jO7IzrquvkvV%2FHvcrA%3D" alt="image.png" loading="lazy"/></p>
<p>具体源代码实现：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">cscMark</span>(<span class="hljs-params"/>): <span class="hljs-title class_">Plugin</span> {
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">name</span>: <span class="hljs-string">'csc-mark'</span>,
    <span class="hljs-attr">enforce</span>: <span class="hljs-string">'pre'</span>,
    <span class="hljs-title function_">transform</span>(<span class="hljs-params">code, id</span>) {
      <span class="hljs-keyword">if</span> (!id.<span class="hljs-title function_">endsWith</span>(<span class="hljs-string">'.vue'</span>)) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
      }

      <span class="hljs-keyword">const</span> { template } = <span class="hljs-title function_">parse</span>(code, { <span class="hljs-attr">filename</span>: id }).<span class="hljs-property">descriptor</span>;

      <span class="hljs-keyword">if</span>(template) {
        <span class="hljs-keyword">const</span> elm = template.<span class="hljs-property">ast</span>.<span class="hljs-property">children</span>.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.<span class="hljs-property">type</span> === <span class="hljs-title class_">NodeTypes</span>.<span class="hljs-property">ELEMENT</span>) <span class="hljs-keyword">as</span> <span class="hljs-title class_">ElementNode</span> | <span class="hljs-literal">undefined</span>;
        <span class="hljs-keyword">if</span>(elm) {
          <span class="hljs-keyword">const</span> tagString = <span class="hljs-string">`&lt;<span class="hljs-subst">${elm.tag}</span>`</span>;

          <span class="hljs-keyword">const</span> insertIndex = elm.<span class="hljs-property">loc</span>.<span class="hljs-property">source</span>.<span class="hljs-title function_">indexOf</span>(tagString) + tagString.<span class="hljs-property">length</span>;
          <span class="hljs-keyword">const</span> newSource
              = <span class="hljs-string">`<span class="hljs-subst">${elm.loc.source.slice(<span class="hljs-number">0</span>, insertIndex)}</span> csc-mark="<span class="hljs-subst">${LZString.compressToBase64(id)}</span>"<span class="hljs-subst">${elm.loc.source.slice(insertIndex)}</span>`</span>;
  
          code = code.<span class="hljs-title function_">replace</span>(elm.<span class="hljs-property">loc</span>.<span class="hljs-property">source</span>, newSource);
        }
      }

      <span class="hljs-keyword">return</span> code;
    }
  };
}
</code></pre>
<ol>
<li>
<p>遍历每个vue组件</p>
</li>
<li>
<p>获得<strong>code</strong>里面<strong>template</strong>的内容</p>
</li>
<li>
<p>通过ast拿到根元素：<strong>elm</strong></p>
</li>
<li>
<p>通过<strong>LZString.compressToBase64(</strong> <em><strong>id</strong></em> <strong>)</strong> 将<strong>绝对路径</strong>赋值进去。注：该钩子参数id就是遍历该文件的绝对路径</p>
</li>
<li>
<p>返回新代码给后续编译构建使用</p>
</li>
</ol>
<h4 data-id="heading-18">如何将路径广播到子组件？</h4>
<p>我们需要有个钩子，能够在上述标签打完之后，再逐一遍历该文件内的其他组件。将编码后的id注入class中。那么哪个钩子能够实习这种功能呢？</p>
<p>经过调研后发现：</p>
<p>Vue插件中，有个钩子能够帮助我们</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>(<span class="hljs-function">(<span class="hljs-params">{ mode }</span>) =&gt;</span> ({
  <span class="hljs-attr">plugins</span>: [<span class="hljs-title function_">vue</span>({
    <span class="hljs-attr">template</span>: {
      <span class="hljs-attr">compilerOptions</span>: {
          <span class="hljs-attr">nodeTransforms</span>: [
              自己编写的函数
          ],
      },
  },
  }),<span class="hljs-title function_">cscMark</span>() ],
  <span class="hljs-attr">resolve</span>: {
    <span class="hljs-attr">alias</span>: {
      <span class="hljs-string">'@'</span>: path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">'src'</span>)
    }
  },
  <span class="hljs-attr">server</span>: {
    <span class="hljs-attr">host</span>: <span class="hljs-string">'0.0.0.0'</span>,
    <span class="hljs-attr">port</span>: <span class="hljs-number">4173</span>,
    <span class="hljs-attr">open</span>: <span class="hljs-literal">true</span>
  },
  <span class="hljs-attr">define</span>: {
    <span class="hljs-attr">__APP_ENV__</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(mode)
  }
}));
</code></pre>
<p>用法：</p>
<blockquote>
<p>在编译<strong>模板</strong>时，对每个 <strong><strong>AST</strong> <strong>节点</strong>执行自己编写的特定函数</strong></p>
</blockquote>
<p>🌰</p>
<pre><code class="hljs language-js" lang="js">&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">csc-mark</span>=<span class="hljs-string">"路径1"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>标题<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">ks-dialog</span>&gt;</span>弹窗<span class="hljs-tag">&lt;/<span class="hljs-name">ks-dialog</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/template&gt;
</code></pre>
<p>Vue插件编译器会解析：</p>
<ol>
<li>读取.vue文件</li>
<li>解析 template 部分</li>
<li>生成 AST（抽象语法树）</li>
</ol>
<p>最后生成：</p>
<pre><code class="hljs language-matlab" lang="matlab">ROOT (<span class="hljs-built_in">type</span>: <span class="hljs-number">0</span>)
  └── &lt;div&gt; (ELEMENT, <span class="hljs-built_in">type</span>: <span class="hljs-number">1</span>)
       ├── <span class="hljs-built_in">csc</span>-mark=<span class="hljs-string">"路径1"</span> (ATTRIBUTE)
       ├── &lt;h1&gt; (ELEMENT, <span class="hljs-built_in">type</span>: <span class="hljs-number">1</span>)
       │    └── <span class="hljs-string">"标题"</span> (TEXT)
       └── &lt;ks-dialog&gt; (ELEMENT, <span class="hljs-built_in">type</span>: <span class="hljs-number">1</span>)
            └── <span class="hljs-string">"弹窗"</span> (TEXT)
</code></pre>
<p>Vue 编译器会深度优先遍历 AST，对每个节点调用自定义的函数。</p>
<p><strong>那这个自定义函数该如何去进行编写呢？</strong></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">cscMarkNodeTransform</span> = (<span class="hljs-params">node, context</span>) =&gt; {
  <span class="hljs-keyword">if</span> (node.<span class="hljs-property">type</span> === <span class="hljs-title class_">NodeTypes</span>.<span class="hljs-property">ELEMENT</span> &amp;&amp; context.<span class="hljs-property">parent</span>) {
      <span class="hljs-keyword">if</span> ([<span class="hljs-title class_">NodeTypes</span>.<span class="hljs-property">ROOT</span>, <span class="hljs-title class_">NodeTypes</span>.<span class="hljs-property">IF_BRANCH</span>].<span class="hljs-title function_">includes</span>(context.<span class="hljs-property">parent</span>.<span class="hljs-property">type</span>)) {
          <span class="hljs-keyword">const</span> firstElm = context.<span class="hljs-property">parent</span>.<span class="hljs-property">children</span>.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.<span class="hljs-property">type</span> === <span class="hljs-title class_">NodeTypes</span>.<span class="hljs-property">ELEMENT</span>) <span class="hljs-keyword">as</span> <span class="hljs-title class_">ElementNode</span> | <span class="hljs-literal">undefined</span>;
          <span class="hljs-keyword">const</span> addText = firstElm &amp;&amp; firstElm.<span class="hljs-property">props</span>.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.<span class="hljs-property">name</span> === <span class="hljs-string">'csc-mark'</span>)?.<span class="hljs-property">value</span>?.<span class="hljs-property">content</span> || <span class="hljs-string">''</span>;

          <span class="hljs-keyword">if</span> (addText) {
                  <span class="hljs-title function_">addClass</span>(node, addText, <span class="hljs-string">'class'</span>);
          }
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (context.<span class="hljs-property">parent</span>.<span class="hljs-property">props</span>?.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.<span class="hljs-property">name</span> === <span class="hljs-string">'csc-mark'</span>)?.<span class="hljs-property">value</span>?.<span class="hljs-property">content</span>) {
          <span class="hljs-keyword">const</span> addText = context.<span class="hljs-property">parent</span>.<span class="hljs-property">props</span>.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.<span class="hljs-property">name</span> === <span class="hljs-string">'csc-mark'</span>)?.<span class="hljs-property">value</span>?.<span class="hljs-property">content</span> || <span class="hljs-string">''</span>;
          <span class="hljs-keyword">if</span> (addText) {
                  <span class="hljs-title function_">addClass</span>(node, addText, <span class="hljs-string">'class'</span>);
          }
      }

  }
};
</code></pre>
<ol>
<li>在 <strong>cscMarkNodeTransform</strong> 中，只有当当前 node 是 <strong>NodeTypes.ELEMENT</strong> 且存在 <strong>context.parent</strong> 时才会继续处理，避免对非元素节点或无父节点的情况做多余操作</li>
<li>当父节点是 ROOT 或 IF_BRANCH 时，会查找父节点的<strong>首个子元素</strong>，读取其 <strong>csc-mark 属性</strong>的内容，并将该内容通过 addClass 加在当前节点的 class 上，从而把<strong>顶层 csc-mark</strong> 标记扩散到具体元素。</li>
<li>如果父节点本身带有 <strong>csc-mark</strong> 属性，就直接读取父节点的该属性内容并同样调用 addClass，以确保<strong>嵌套元素</strong> <strong>继承</strong> <strong>父级 csc-mark 定义的类名</strong>。</li>
</ol>
<p><strong>页面效果呈现：</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c6ac3b0c3cc645c39f177539b3eea138~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54us6KeS5LuZ5qKm5aKD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765187538&amp;x-signature=%2FnMOne5YXo14YLFgX%2F20VtMfghk%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-19">油猴脚本编写：</h4>
<p>脚本作用：</p>
<ol>
<li>添加检查button，只有点击button时，才会开启溯源功能</li>
<li>点击后高亮所有带有css-vite-mark-类名的元素</li>
<li>点击元素时，收集并显示嵌套组件及组件绝对路径</li>
</ol>
<p><strong>核心代码</strong>及<strong>解释</strong></p>
<p>1.组件层次结构的收集：</p>
<ul>
<li>这个函数从点击的元素开始<strong>向上遍历DOM树</strong>，收集所有<strong>带有标记的父元素</strong>，构建组件层次结构。</li>
</ul>
<pre><code class="hljs language-js" lang="js"> <span class="hljs-comment">// 函数：收集从顶层到当前元素的 csc-mark 属性列表</span>
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">collectCscMarkHierarchy</span>(<span class="hljs-params">element</span>) {
        <span class="hljs-keyword">let</span> cscMarkList = [];
        <span class="hljs-keyword">while</span> (element) {
            <span class="hljs-keyword">if</span> (element.<span class="hljs-title function_">hasAttribute</span>(<span class="hljs-string">'csc-mark'</span>)) {
                cscMarkList.<span class="hljs-title function_">push</span>({ element, <span class="hljs-attr">mark</span>: element.<span class="hljs-title function_">getAttribute</span>(<span class="hljs-string">'csc-mark'</span>) });
            }
            element = element.<span class="hljs-property">parentElement</span>;
        }
        <span class="hljs-keyword">return</span> cscMarkList;
    }
</code></pre>
<p>2.路径解码：</p>
<p>这部分代码从类名中提取压缩的路径部分，然后使用<strong>LZString.decompressFromBase64</strong>解码还原为实际<strong>绝对路径。</strong></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 处理源码路径部分代码</span>
cssMarkList.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> {
    <span class="hljs-keyword">const</span> tag = item.<span class="hljs-property">element</span>.<span class="hljs-property">tagName</span>.<span class="hljs-title function_">toLowerCase</span>();
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">const</span> encodedPath = item.<span class="hljs-property">originMark</span>.<span class="hljs-title function_">substring</span>(prefix.<span class="hljs-property">length</span>);
        <span class="hljs-keyword">const</span> filePath = <span class="hljs-title class_">LZString</span>.<span class="hljs-title function_">decompressFromBase64</span>(encodedPath);
        decodedPaths.<span class="hljs-title function_">push</span>({ tag, filePath });
    } <span class="hljs-keyword">catch</span> (e) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'解码路径失败:'</span>, e);
    }
});
</code></pre>
<p>3.交互机制</p>
<p>用户点击该元素时，收集组件嵌套，并渲染对话框</p>
<pre><code class="hljs language-js" lang="js"> <span class="hljs-comment">// 函数：处理点击事件并显示 csc-mark 层级</span>
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleClick</span>(<span class="hljs-params">event</span>) {
        <span class="hljs-keyword">let</span> element = event.<span class="hljs-property">target</span>;
  
        <span class="hljs-comment">// 遍历 DOM 树查找最近的具有 csc-mark 属性的祖先元素</span>
        <span class="hljs-keyword">while</span> (element &amp;&amp; !element.<span class="hljs-title function_">hasAttribute</span>(<span class="hljs-string">'csc-mark'</span>)) {
            element = element.<span class="hljs-property">parentElement</span>;
        }
  
        <span class="hljs-keyword">if</span> (element &amp;&amp; element.<span class="hljs-title function_">hasAttribute</span>(<span class="hljs-string">'csc-mark'</span>)) {
            event.<span class="hljs-title function_">stopPropagation</span>();
            event.<span class="hljs-title function_">preventDefault</span>();
            <span class="hljs-keyword">const</span> cscMarkList = <span class="hljs-title function_">collectCscMarkHierarchy</span>(element);
            <span class="hljs-title function_">showCustomDialog</span>(cscMarkList);
        }
    }
  
</code></pre>
<h4 data-id="heading-20">具体使用流程:</h4>
<ol>
<li>启动开发服务器</li>
<li>通过油猴插件添加脚本</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9526d72be85c4a04b270f7625acfaac1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54us6KeS5LuZ5qKm5aKD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765187538&amp;x-signature=boZrNTpW3JlEzFpYg8gxKnr6Njw%3D" alt="image.png" loading="lazy"/>
3. 点击<strong>inspect</strong>按钮</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1fb14f0175874a229470db62f90a2d3c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54us6KeS5LuZ5qKm5aKD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765187538&amp;x-signature=x4qQrzRhdF%2Bf8tKwOmk%2FcyUJHSg%3D" alt="image.png" loading="lazy"/></p>
<ol start="4">
<li>之后想要修改哪个模块就可以进行点击</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6394b3023b154cec916b3322b698aa48~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54us6KeS5LuZ5qKm5aKD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765187538&amp;x-signature=Ngu5AQxBvTRPl0QazqshYguI3Vg%3D" alt="image.png" loading="lazy"/></p>
<p>⚠️使用该油猴脚本时需要注意匹配到你对应的项目路径</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ad4fe5559d364485b093d71999f2384d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54us6KeS5LuZ5qKm5aKD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765187538&amp;x-signature=0kvG6X6F%2Bsjlv0GtYJPXYXMSk60%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-21">总结：</h2>
<p>通过上述方法可以实现一个简易的源码定位系统了，能够帮助我们在很多复杂项目中快速定位到自己需要修改的模块所对应的，通过这么一个比较小的需求，能够快速帮助大家对<strong>vite的生命周期</strong>，以及<strong>自定义插件</strong>，<strong>油猴插件</strong>的基本使用，有个较为清晰的了解。综合性比较强，需求完成后对大家的开发效率也会有很大的提升，大家感兴趣的可以进我的github上看对应的插件源码和脚本代码：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fhjj5201%2Fvite-plugin" target="_blank" title="https://github.com/hjj5201/vite-plugin" ref="nofollow noopener noreferrer">溯源代码</a></p>
<p><strong>扩展点：</strong></p>
<ol>
<li>如何在<strong>webpack</strong>上，通过编写对应插件，实现相应的功能</li>
<li>目前只能够在页面上知道对应模块使用的组件，<strong>不知道这个组件能够对应哪个页面</strong></li>
<li>可以修改一些样式，让整体更加美观</li>
<li>一步到位，点击<strong>对应模块能够自动跳转的编辑器中</strong></li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[CesiumLite-在三维地图中绘制3D图形变得游刃有余]]></title>    <link>https://juejin.cn/post/7578705123208134699</link>    <guid>https://juejin.cn/post/7578705123208134699</guid>    <pubDate>2025-12-01T09:53:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578705123208134699" data-draft-id="7578667193320964159" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="CesiumLite-在三维地图中绘制3D图形变得游刃有余"/> <meta itemprop="keywords" content="前端,GIS,cesium"/> <meta itemprop="datePublished" content="2025-12-01T09:53:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="LukeSuperCoder"/> <meta itemprop="url" content="https://juejin.cn/user/88395458549383"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            CesiumLite-在三维地图中绘制3D图形变得游刃有余
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/88395458549383/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    LukeSuperCoder
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-01T09:53:23.000Z" title="Mon Dec 01 2025 09:53:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-01
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">🎯 告别重复造轮子！CesiumLite 实体管理模块让3D图形开发效率翻倍</h2>
<blockquote>
<p>本文深入介绍 CesiumLite 的实体管理模块，从开发痛点到封装原理，再到实战应用，带你全面了解如何优雅地管理 Cesium 三维实体。</p>
</blockquote>
<h3 data-id="heading-1">📌 前言</h3>
<p>在使用 Cesium.js 开发三维地图应用时，实体（Entity）的创建和管理是最常见的需求之一。无论是标注点位、绘制建筑轮廓，还是展示三维模型，都离不开实体的操作。</p>
<p>然而，Cesium 原生 API 虽然功能强大，但在实际开发中却存在不少痛点。本文将通过 <strong>CesiumLite</strong> 项目的实体管理模块，展示如何优雅地解决这些问题。</p>
<h3 data-id="heading-2">🎨 在线演示</h3>
<p>项目提供了完整的功能演示页面，你可以访问以下链接查看实际效果：</p>
<p><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Flukesupercoder.github.io%2Fcesium-lite%2Fexamples%2Fentity.html" target="_blank" title="https://lukesupercoder.github.io/cesium-lite/examples/entity.html" ref="nofollow noopener noreferrer">在线演示</a></strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6b45fb82a55e40c1bcf104343142c6db~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVrZVN1cGVyQ29kZXI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765187603&amp;x-signature=3oJiOtCfGcpW6W7v7SwNDytbp6M%3D" alt="image.png" loading="lazy"/>
<strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FlukeSuperCoder%2Fcesium-lite" target="_blank" title="https://github.com/lukeSuperCoder/cesium-lite" ref="nofollow noopener noreferrer">项目地址</a></strong></p>
<p>演示页面包含以下功能：</p>
<ul>
<li>🔹 多边形面</li>
<li>🔹 盒子模型</li>
<li>🔹 矩形</li>
<li>🔹 球体</li>
<li>🔹 椭圆形</li>
<li>🔹 圆柱</li>
<li>🔹 线段</li>
<li>🔹 管道（PolylineVolume）</li>
<li>🔹 走廊</li>
<li>🔹 墙体</li>
</ul>
<h3 data-id="heading-3">🚫 开发痛点分析</h3>
<h4 data-id="heading-4">痛点 1：实体创建过于繁琐</h4>
<p>使用 Cesium 原生 API 创建一个简单的多边形，需要这样写：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 创建一个多边形实体</span>
<span class="hljs-keyword">const</span> entity = viewer.<span class="hljs-property">entities</span>.<span class="hljs-title function_">add</span>({
  <span class="hljs-attr">polygon</span>: {
    <span class="hljs-attr">hierarchy</span>: <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">Cartesian3</span>.<span class="hljs-title function_">fromDegreesArray</span>([
      -<span class="hljs-number">109.080842</span>, <span class="hljs-number">45.002073</span>,
      -<span class="hljs-number">104.058488</span>, <span class="hljs-number">45.002073</span>,
      -<span class="hljs-number">104.053011</span>, <span class="hljs-number">41.003906</span>,
      -<span class="hljs-number">105.728954</span>, <span class="hljs-number">41.003906</span>,
    ]),
    <span class="hljs-attr">height</span>: <span class="hljs-number">5000</span>,
    <span class="hljs-attr">material</span>: <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">Color</span>.<span class="hljs-property">BLUE</span>.<span class="hljs-title function_">withAlpha</span>(<span class="hljs-number">0.5</span>),
    <span class="hljs-attr">outline</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">outlineColor</span>: <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">Color</span>.<span class="hljs-property">BLACK</span>,
  }
});

<span class="hljs-comment">// 如果需要定位到该实体</span>
viewer.<span class="hljs-title function_">zoomTo</span>(entity);
</code></pre>
<p><strong>问题在于：</strong></p>
<ul>
<li>每次创建都要重复写 <code>viewer.entities.add()</code></li>
<li>没有统一的实体 ID 管理机制</li>
<li>定位功能需要单独调用</li>
<li>实体更新和删除操作分散</li>
</ul>
<h4 data-id="heading-5">痛点 2：实体生命周期管理混乱</h4>
<p>当项目中实体数量增多时，管理变得复杂：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 需要手动维护实体引用</span>
<span class="hljs-keyword">const</span> entities = [];
entities.<span class="hljs-title function_">push</span>(viewer.<span class="hljs-property">entities</span>.<span class="hljs-title function_">add</span>({ <span class="hljs-comment">/* ... */</span> }));
entities.<span class="hljs-title function_">push</span>(viewer.<span class="hljs-property">entities</span>.<span class="hljs-title function_">add</span>({ <span class="hljs-comment">/* ... */</span> }));

<span class="hljs-comment">// 更新某个实体？需要先找到它</span>
<span class="hljs-keyword">const</span> targetEntity = entities.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> e.<span class="hljs-property">id</span> === <span class="hljs-string">'someId'</span>);
<span class="hljs-keyword">if</span> (targetEntity) {
  targetEntity.<span class="hljs-property">polygon</span>.<span class="hljs-property">material</span> = <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">Color</span>.<span class="hljs-property">RED</span>;
}

<span class="hljs-comment">// 删除某个实体？</span>
viewer.<span class="hljs-property">entities</span>.<span class="hljs-title function_">remove</span>(targetEntity);

<span class="hljs-comment">// 清空所有？</span>
viewer.<span class="hljs-property">entities</span>.<span class="hljs-title function_">removeAll</span>(); <span class="hljs-comment">// 这会删除所有实体，包括其他模块创建的！</span>
</code></pre>
<p><strong>问题在于：</strong></p>
<ul>
<li>实体引用分散，难以统一管理</li>
<li>查找、更新、删除操作繁琐</li>
<li>清空操作会影响其他模块</li>
<li>缺乏命名空间隔离</li>
</ul>
<h4 data-id="heading-6">痛点 3：代码复用性差</h4>
<p>每个项目都要重新实现相似的功能：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 项目 A</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ProjectAEntityManager</span> {
  <span class="hljs-title function_">addPolygon</span>(<span class="hljs-params">options</span>) { <span class="hljs-comment">/* ... */</span> }
  <span class="hljs-title function_">removePolygon</span>(<span class="hljs-params">id</span>) { <span class="hljs-comment">/* ... */</span> }
}

<span class="hljs-comment">// 项目 B</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ProjectBEntityController</span> {
  <span class="hljs-title function_">createEntity</span>(<span class="hljs-params">config</span>) { <span class="hljs-comment">/* ... */</span> }
  <span class="hljs-title function_">deleteEntity</span>(<span class="hljs-params">entityId</span>) { <span class="hljs-comment">/* ... */</span> }
}

<span class="hljs-comment">// 项目 C - 又要重新写一遍...</span>
</code></pre>
<p><strong>问题在于：</strong></p>
<ul>
<li>每个项目都在造轮子</li>
<li>没有统一的最佳实践</li>
<li>维护成本高，bug 重复出现</li>
</ul>
<h3 data-id="heading-7">💡 CesiumLite 的解决方案</h3>
<h4 data-id="heading-8">核心设计思路</h4>
<p>CesiumLite 的实体管理模块采用了以下设计思路：</p>
<ol>
<li><strong>双层封装架构</strong>：<code>EntityManager</code> + <code>EntityWrapper</code></li>
<li><strong>独立数据源隔离</strong>：使用 <code>CustomDataSource</code> 避免污染全局实体集合</li>
<li><strong>统一 ID 管理</strong>：自动生成唯一 ID，支持自定义</li>
<li><strong>链式操作支持</strong>：提供流畅的 API 调用体验</li>
</ol>
<h4 data-id="heading-9">架构设计图</h4>
<pre><code class="hljs">┌─────────────────────────────────────────┐
│          CesiumLite 核心类              │
│  ┌───────────────────────────────────┐  │
│  │      EntityManager 管理器         │  │
│  │  - 统一管理所有实体               │  │
│  │  - 独立 CustomDataSource          │  │
│  │  - 提供增删改查接口               │  │
│  │                                   │  │
│  │  ┌─────────────────────────────┐ │  │
│  │  │   EntityWrapper 实体包装器  │ │  │
│  │  │  - 封装单个实体             │ │  │
│  │  │  - 自动生成唯一 ID          │ │  │
│  │  │  - 提供更新方法             │ │  │
│  │  └─────────────────────────────┘ │  │
│  └───────────────────────────────────┘  │
│                  ↓                       │
│  ┌───────────────────────────────────┐  │
│  │      Cesium Viewer 实例           │  │
│  └───────────────────────────────────┘  │
└─────────────────────────────────────────┘
</code></pre>
<h3 data-id="heading-10">🔧 核心代码实现</h3>
<h4 data-id="heading-11">1. EntityWrapper：实体包装器</h4>
<p><code>EntityWrapper</code> 负责封装单个实体，提供统一的操作接口：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Entity</span>, createGuid } <span class="hljs-keyword">from</span> <span class="hljs-string">'cesium'</span>;

<span class="hljs-keyword">class</span> <span class="hljs-title class_">EntityWrapper</span> {
    <span class="hljs-title function_">constructor</span>(<span class="hljs-params">options = {}</span>) {
        <span class="hljs-comment">// 自动生成唯一 ID，也支持自定义</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">id</span> = options.<span class="hljs-property">id</span> || <span class="hljs-title function_">createGuid</span>();
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span> = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>({}, options);
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">entity</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Entity</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>);
    }

    <span class="hljs-comment">// 更新实体属性</span>
    <span class="hljs-title function_">update</span>(<span class="hljs-params">options</span>) {
        <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>, options);
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">entity</span>.<span class="hljs-title function_">update</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>);
    }

    <span class="hljs-comment">// 获取原生 Cesium 实体</span>
    <span class="hljs-title function_">getEntity</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">entity</span>;
    }
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">EntityWrapper</span>;
</code></pre>
<p><strong>设计亮点：</strong></p>
<ul>
<li>✅ 自动生成唯一 ID，避免冲突</li>
<li>✅ 保存实体配置，方便后续更新</li>
<li>✅ 提供 <code>getEntity()</code> 方法，保持原生 API 的兼容性</li>
</ul>
<h4 data-id="heading-12">2. EntityManager：实体管理器</h4>
<p><code>EntityManager</code> 是实体管理的核心，提供完整的生命周期管理：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">CustomDataSource</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'cesium'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">EntityWrapper</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./entityWrapper'</span>;

<span class="hljs-keyword">class</span> <span class="hljs-title class_">EntityManager</span> {
    <span class="hljs-title function_">constructor</span>(<span class="hljs-params">viewer</span>) {
        <span class="hljs-keyword">if</span> (!viewer) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'Viewer instance is required'</span>);
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">viewer</span> = viewer;

        <span class="hljs-comment">// 创建独立的数据源，实现命名空间隔离</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">dataSource</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CustomDataSource</span>(<span class="hljs-string">'entityManager'</span>);
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">viewer</span>.<span class="hljs-property">dataSources</span>.<span class="hljs-title function_">add</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">dataSource</span>);

        <span class="hljs-comment">// 使用 Map 管理所有实体，O(1) 查找性能</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">entities</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
    }

    <span class="hljs-comment">// 添加实体</span>
    <span class="hljs-title function_">addEntity</span>(<span class="hljs-params">options, isLocate = <span class="hljs-literal">false</span></span>) {
        <span class="hljs-keyword">const</span> entityWrapper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">EntityWrapper</span>(options);
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">entities</span>.<span class="hljs-title function_">set</span>(entityWrapper.<span class="hljs-property">id</span>, entityWrapper);
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">dataSource</span>.<span class="hljs-property">entities</span>.<span class="hljs-title function_">add</span>(entityWrapper.<span class="hljs-title function_">getEntity</span>());

        <span class="hljs-comment">// 支持创建后自动定位</span>
        <span class="hljs-keyword">if</span> (isLocate) {
            <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">locateEntity</span>(entityWrapper.<span class="hljs-property">id</span>);
        }

        <span class="hljs-keyword">return</span> entityWrapper.<span class="hljs-property">id</span>;
    }

    <span class="hljs-comment">// 移除实体</span>
    <span class="hljs-title function_">removeEntity</span>(<span class="hljs-params">entityId</span>) {
        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">entities</span>.<span class="hljs-title function_">has</span>(entityId)) {
            <span class="hljs-keyword">const</span> entityWrapper = <span class="hljs-variable language_">this</span>.<span class="hljs-property">entities</span>.<span class="hljs-title function_">get</span>(entityId);
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">dataSource</span>.<span class="hljs-property">entities</span>.<span class="hljs-title function_">remove</span>(entityWrapper.<span class="hljs-title function_">getEntity</span>());
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">entities</span>.<span class="hljs-title function_">delete</span>(entityId);
        }
    }

    <span class="hljs-comment">// 更新实体</span>
    <span class="hljs-title function_">updateEntity</span>(<span class="hljs-params">entityId, options</span>) {
        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">entities</span>.<span class="hljs-title function_">has</span>(entityId)) {
            <span class="hljs-keyword">const</span> entityWrapper = <span class="hljs-variable language_">this</span>.<span class="hljs-property">entities</span>.<span class="hljs-title function_">get</span>(entityId);
            entityWrapper.<span class="hljs-title function_">update</span>(options);
        }
    }

    <span class="hljs-comment">// 视角定位到实体</span>
    <span class="hljs-title function_">locateEntity</span>(<span class="hljs-params">entityId</span>) {
        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">entities</span>.<span class="hljs-title function_">has</span>(entityId)) {
            <span class="hljs-keyword">const</span> entityWrapper = <span class="hljs-variable language_">this</span>.<span class="hljs-property">entities</span>.<span class="hljs-title function_">get</span>(entityId);
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">viewer</span>.<span class="hljs-title function_">zoomTo</span>(entityWrapper.<span class="hljs-title function_">getEntity</span>());
        }
    }

    <span class="hljs-comment">// 获取所有实体</span>
    <span class="hljs-title function_">getAllEntities</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">entities</span>.<span class="hljs-title function_">values</span>()).<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">wrapper</span> =&gt;</span> wrapper.<span class="hljs-title function_">getEntity</span>());
    }

    <span class="hljs-comment">// 清除所有实体（只清除当前管理器的实体）</span>
    <span class="hljs-title function_">clearEntities</span>(<span class="hljs-params"/>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">dataSource</span>.<span class="hljs-property">entities</span>.<span class="hljs-title function_">removeAll</span>();
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">entities</span>.<span class="hljs-title function_">clear</span>();
    }
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">EntityManager</span>;
</code></pre>
<p><strong>设计亮点：</strong></p>
<ul>
<li>✅ <strong>独立数据源</strong>：使用 <code>CustomDataSource</code> 实现命名空间隔离，不会影响其他模块</li>
<li>✅ <strong>高效查找</strong>：使用 <code>Map</code> 数据结构，提供 O(1) 的查找性能</li>
<li>✅ <strong>自动定位</strong>：支持创建实体后自动飞行到目标位置</li>
<li>✅ <strong>统一接口</strong>：增删改查操作命名规范，易于理解</li>
</ul>
<h3 data-id="heading-13">🎯 使用教程</h3>
<h4 data-id="heading-14">基础用法</h4>
<h5 data-id="heading-15">1. 初始化 CesiumLite</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> cesiumLite = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CesiumLite</span>(<span class="hljs-string">'cesiumContainer'</span>, {
  <span class="hljs-attr">map</span>: {
    <span class="hljs-attr">baseMap</span>: {
      <span class="hljs-attr">id</span>: <span class="hljs-string">'imagery'</span>
    },
    <span class="hljs-attr">camera</span>: {
      <span class="hljs-attr">longitude</span>: <span class="hljs-number">116.397428</span>,
      <span class="hljs-attr">latitude</span>: <span class="hljs-number">39.90923</span>,
      <span class="hljs-attr">height</span>: <span class="hljs-number">1000000</span>
    }
  }
});
</code></pre>
<h5 data-id="heading-16">2. 添加各种几何实体</h5>
<h6 data-id="heading-17">添加多边形</h6>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> polygonId = cesiumLite.<span class="hljs-property">entityManager</span>.<span class="hljs-title function_">addEntity</span>({
  <span class="hljs-attr">polygon</span>: {
    <span class="hljs-attr">hierarchy</span>: <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">Cartesian3</span>.<span class="hljs-title function_">fromDegreesArray</span>([
      -<span class="hljs-number">109.080842</span>, <span class="hljs-number">45.002073</span>,
      -<span class="hljs-number">104.058488</span>, <span class="hljs-number">45.002073</span>,
      -<span class="hljs-number">104.053011</span>, <span class="hljs-number">41.003906</span>,
      -<span class="hljs-number">105.728954</span>, <span class="hljs-number">41.003906</span>,
    ]),
    <span class="hljs-attr">height</span>: <span class="hljs-number">5000</span>,
    <span class="hljs-attr">material</span>: <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">Color</span>.<span class="hljs-property">BLUE</span>.<span class="hljs-title function_">withAlpha</span>(<span class="hljs-number">0.5</span>),
    <span class="hljs-attr">outline</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">outlineColor</span>: <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">Color</span>.<span class="hljs-property">BLACK</span>,
  }
}, <span class="hljs-literal">true</span>); <span class="hljs-comment">// 第二个参数 true 表示创建后自动定位</span>
</code></pre>
<h6 data-id="heading-18">添加盒子模型</h6>
<pre><code class="hljs language-javascript" lang="javascript">cesiumLite.<span class="hljs-property">entityManager</span>.<span class="hljs-title function_">addEntity</span>({
  <span class="hljs-attr">position</span>: <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">Cartesian3</span>.<span class="hljs-title function_">fromDegrees</span>(-<span class="hljs-number">109.080842</span>, <span class="hljs-number">45.002073</span>),
  <span class="hljs-attr">box</span>: {
    <span class="hljs-attr">dimensions</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cesium</span>.<span class="hljs-title class_">Cartesian3</span>(<span class="hljs-number">5000</span>, <span class="hljs-number">5000</span>, <span class="hljs-number">5000</span>),
    <span class="hljs-attr">material</span>: <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">Color</span>.<span class="hljs-property">RED</span>.<span class="hljs-title function_">withAlpha</span>(<span class="hljs-number">0.5</span>),
  }
}, <span class="hljs-literal">true</span>);
</code></pre>
<h6 data-id="heading-19">添加球体</h6>
<pre><code class="hljs language-javascript" lang="javascript">cesiumLite.<span class="hljs-property">entityManager</span>.<span class="hljs-title function_">addEntity</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">"Three-dimensional sphere"</span>,
  <span class="hljs-attr">position</span>: <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">Cartesian3</span>.<span class="hljs-title function_">fromDegrees</span>(-<span class="hljs-number">114.0</span>, <span class="hljs-number">40.0</span>, <span class="hljs-number">300000.0</span>),
  <span class="hljs-attr">ellipsoid</span>: {
    <span class="hljs-attr">radii</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cesium</span>.<span class="hljs-title class_">Cartesian3</span>(<span class="hljs-number">200000.0</span>, <span class="hljs-number">200000.0</span>, <span class="hljs-number">300000.0</span>),
    <span class="hljs-attr">innerRadii</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cesium</span>.<span class="hljs-title class_">Cartesian3</span>(<span class="hljs-number">150000.0</span>, <span class="hljs-number">150000.0</span>, <span class="hljs-number">200000.0</span>),
    <span class="hljs-attr">material</span>: <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">Color</span>.<span class="hljs-property">RED</span>.<span class="hljs-title function_">withAlpha</span>(<span class="hljs-number">0.5</span>),
    <span class="hljs-attr">outline</span>: <span class="hljs-literal">true</span>
  }
}, <span class="hljs-literal">true</span>);
</code></pre>
<h6 data-id="heading-20">添加圆柱</h6>
<pre><code class="hljs language-javascript" lang="javascript">cesiumLite.<span class="hljs-property">entityManager</span>.<span class="hljs-title function_">addEntity</span>({
  <span class="hljs-attr">position</span>: <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">Cartesian3</span>.<span class="hljs-title function_">fromDegrees</span>(-<span class="hljs-number">104.058488</span>, <span class="hljs-number">44.996596</span>),
  <span class="hljs-attr">cylinder</span>: {
    <span class="hljs-attr">length</span>: <span class="hljs-number">5000</span>,
    <span class="hljs-attr">topRadius</span>: <span class="hljs-number">500</span>,
    <span class="hljs-attr">bottomRadius</span>: <span class="hljs-number">500</span>,
    <span class="hljs-attr">material</span>: <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">Color</span>.<span class="hljs-property">RED</span>.<span class="hljs-title function_">withAlpha</span>(<span class="hljs-number">0.5</span>),
    <span class="hljs-attr">outline</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">numberOfVerticalLines</span>: <span class="hljs-number">20</span>
  }
}, <span class="hljs-literal">true</span>);
</code></pre>
<h6 data-id="heading-21">添加走廊（Corridor）</h6>
<pre><code class="hljs language-javascript" lang="javascript">cesiumLite.<span class="hljs-property">entityManager</span>.<span class="hljs-title function_">addEntity</span>({
  <span class="hljs-attr">corridor</span>: {
    <span class="hljs-attr">positions</span>: <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">Cartesian3</span>.<span class="hljs-title function_">fromDegreesArray</span>([
      -<span class="hljs-number">109.080842</span>, <span class="hljs-number">45.002073</span>,
      -<span class="hljs-number">105.91517</span>, <span class="hljs-number">45.002073</span>,
      -<span class="hljs-number">104.058488</span>, <span class="hljs-number">44.996596</span>,
    ]),
    <span class="hljs-attr">width</span>: <span class="hljs-number">5000</span>,
    <span class="hljs-attr">height</span>: <span class="hljs-number">1000</span>,
    <span class="hljs-attr">extrudedHeight</span>: <span class="hljs-number">10000</span>,
    <span class="hljs-attr">material</span>: <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">Color</span>.<span class="hljs-property">RED</span>.<span class="hljs-title function_">withAlpha</span>(<span class="hljs-number">0.5</span>),
  }
}, <span class="hljs-literal">true</span>);
</code></pre>
<h6 data-id="heading-22">添加墙（Wall）</h6>
<pre><code class="hljs language-javascript" lang="javascript">cesiumLite.<span class="hljs-property">entityManager</span>.<span class="hljs-title function_">addEntity</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">"Vertical wall"</span>,
  <span class="hljs-attr">wall</span>: {
    <span class="hljs-attr">positions</span>: <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">Cartesian3</span>.<span class="hljs-title function_">fromDegreesArrayHeights</span>([
      -<span class="hljs-number">107.0</span>, <span class="hljs-number">43.0</span>, <span class="hljs-number">100000.0</span>,
      -<span class="hljs-number">97.0</span>, <span class="hljs-number">43.0</span>, <span class="hljs-number">100000.0</span>,
      -<span class="hljs-number">97.0</span>, <span class="hljs-number">40.0</span>, <span class="hljs-number">100000.0</span>,
      -<span class="hljs-number">107.0</span>, <span class="hljs-number">40.0</span>, <span class="hljs-number">100000.0</span>,
    ]),
    <span class="hljs-attr">material</span>: <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">Color</span>.<span class="hljs-property">RED</span>.<span class="hljs-title function_">withAlpha</span>(<span class="hljs-number">0.5</span>),
    <span class="hljs-attr">outline</span>: <span class="hljs-literal">true</span>
  }
}, <span class="hljs-literal">true</span>);
</code></pre>
<h4 data-id="heading-23">高级操作</h4>
<h5 data-id="heading-24">更新实体</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 保存实体 ID</span>
<span class="hljs-keyword">const</span> entityId = cesiumLite.<span class="hljs-property">entityManager</span>.<span class="hljs-title function_">addEntity</span>({ <span class="hljs-comment">/* ... */</span> });

<span class="hljs-comment">// 更新实体属性</span>
cesiumLite.<span class="hljs-property">entityManager</span>.<span class="hljs-title function_">updateEntity</span>(entityId, {
  <span class="hljs-attr">polygon</span>: {
    <span class="hljs-attr">material</span>: <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">Color</span>.<span class="hljs-property">GREEN</span>.<span class="hljs-title function_">withAlpha</span>(<span class="hljs-number">0.7</span>)
  }
});
</code></pre>
<h5 data-id="heading-25">定位到指定实体</h5>
<pre><code class="hljs language-javascript" lang="javascript">cesiumLite.<span class="hljs-property">entityManager</span>.<span class="hljs-title function_">locateEntity</span>(entityId);
</code></pre>
<h5 data-id="heading-26">删除指定实体</h5>
<pre><code class="hljs language-javascript" lang="javascript">cesiumLite.<span class="hljs-property">entityManager</span>.<span class="hljs-title function_">removeEntity</span>(entityId);
</code></pre>
<h5 data-id="heading-27">清空所有实体</h5>
<pre><code class="hljs language-javascript" lang="javascript">cesiumLite.<span class="hljs-property">entityManager</span>.<span class="hljs-title function_">clearEntities</span>();
</code></pre>
<h5 data-id="heading-28">获取所有实体</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> allEntities = cesiumLite.<span class="hljs-property">entityManager</span>.<span class="hljs-title function_">getAllEntities</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'当前实体数量：'</span>, allEntities.<span class="hljs-property">length</span>);
</code></pre>
<h3 data-id="heading-29">📊 对比传统开发方式</h3>
<h4 data-id="heading-30">代码量对比</h4>









































<table><thead><tr><th>操作</th><th>传统方式</th><th>CesiumLite</th><th>减少代码量</th></tr></thead><tbody><tr><td>创建实体</td><td>10+ 行</td><td>3 行</td><td>70%</td></tr><tr><td>创建并定位</td><td>15+ 行</td><td>3 行</td><td>80%</td></tr><tr><td>更新实体</td><td>8+ 行</td><td>1 行</td><td>87%</td></tr><tr><td>删除实体</td><td>5+ 行</td><td>1 行</td><td>80%</td></tr><tr><td>批量清空</td><td>10+ 行</td><td>1 行</td><td>90%</td></tr></tbody></table>
<h4 data-id="heading-31">功能对比</h4>








































<table><thead><tr><th>功能</th><th>传统方式</th><th>CesiumLite</th></tr></thead><tbody><tr><td>实体创建</td><td>✅</td><td>✅</td></tr><tr><td>唯一 ID 管理</td><td>❌ 需手动实现</td><td>✅ 自动生成</td></tr><tr><td>命名空间隔离</td><td>❌ 需手动实现</td><td>✅ 内置支持</td></tr><tr><td>自动定位</td><td>❌ 需单独调用</td><td>✅ 参数控制</td></tr><tr><td>统一更新接口</td><td>❌ 分散操作</td><td>✅ 统一接口</td></tr><tr><td>批量操作</td><td>❌ 需手动循环</td><td>✅ 内置支持</td></tr></tbody></table>
<h3 data-id="heading-32">🚀 快速开始</h3>
<h4 data-id="heading-33">1. 安装</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># NPM 安装（推荐）</span>
npm install cesium-lite

<span class="hljs-comment"># 或者通过 GitHub 克隆</span>
git <span class="hljs-built_in">clone</span> https://github.com/lukeSuperCoder/cesium-lite.git
<span class="hljs-built_in">cd</span> cesium-lite
npm install
</code></pre>
<h4 data-id="heading-34">2. 引入使用</h4>
<h5 data-id="heading-35">方式一：NPM 方式</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">CesiumLite</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'cesium-lite'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'cesium/Build/Cesium/Widgets/widgets.css'</span>;

<span class="hljs-keyword">const</span> cesiumLite = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CesiumLite</span>(<span class="hljs-string">'cesiumContainer'</span>, {
  <span class="hljs-comment">// 配置项</span>
});
</code></pre>
<h4 data-id="heading-36">方式二：本地运行项目</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 克隆项目</span>
git <span class="hljs-built_in">clone</span> https://github.com/lukeSuperCoder/cesium-lite.git
<span class="hljs-built_in">cd</span> cesium-lite

<span class="hljs-comment"># 安装依赖</span>
npm install
</code></pre>
<h4 data-id="heading-37">3. 运行示例</h4>
<pre><code class="hljs language-bash" lang="bash">npm run dev
</code></pre>
<p>访问 <code>http://localhost:8020/entity.html</code> 查看实体管理示例。</p>
<h3 data-id="heading-38">💡 最佳实践建议</h3>
<h4 data-id="heading-39">1. 合理使用自动定位</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 对于重要的首个实体，启用自动定位</span>
<span class="hljs-keyword">const</span> mainEntityId = cesiumLite.<span class="hljs-property">entityManager</span>.<span class="hljs-title function_">addEntity</span>(options, <span class="hljs-literal">true</span>);

<span class="hljs-comment">// 批量创建时，关闭自动定位以提升性能</span>
entities.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">entity</span> =&gt;</span> {
  cesiumLite.<span class="hljs-property">entityManager</span>.<span class="hljs-title function_">addEntity</span>(entity, <span class="hljs-literal">false</span>);
});

<span class="hljs-comment">// 批量创建完成后，手动定位到某个实体</span>
cesiumLite.<span class="hljs-property">entityManager</span>.<span class="hljs-title function_">locateEntity</span>(mainEntityId);
</code></pre>
<h4 data-id="heading-40">2. 实体 ID 管理</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 为重要实体指定自定义 ID</span>
<span class="hljs-keyword">const</span> buildingId = cesiumLite.<span class="hljs-property">entityManager</span>.<span class="hljs-title function_">addEntity</span>({
  <span class="hljs-attr">id</span>: <span class="hljs-string">'building_main_001'</span>,  <span class="hljs-comment">// 自定义 ID</span>
  <span class="hljs-attr">polygon</span>: { <span class="hljs-comment">/* ... */</span> }
});

<span class="hljs-comment">// 后续可以直接使用自定义 ID 操作</span>
cesiumLite.<span class="hljs-property">entityManager</span>.<span class="hljs-title function_">updateEntity</span>(<span class="hljs-string">'building_main_001'</span>, { <span class="hljs-comment">/* ... */</span> });
</code></pre>
<h4 data-id="heading-41">3. 批量操作优化</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 批量创建实体</span>
<span class="hljs-keyword">const</span> entityIds = [];
<span class="hljs-keyword">const</span> batchData = [ <span class="hljs-comment">/* 大量数据 */</span> ];

batchData.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> {
  <span class="hljs-keyword">const</span> id = cesiumLite.<span class="hljs-property">entityManager</span>.<span class="hljs-title function_">addEntity</span>(data, <span class="hljs-literal">false</span>);
  entityIds.<span class="hljs-title function_">push</span>(id);
});

<span class="hljs-comment">// 需要时再批量定位</span>
entityIds.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">id</span> =&gt;</span> {
  cesiumLite.<span class="hljs-property">entityManager</span>.<span class="hljs-title function_">locateEntity</span>(id);
});
</code></pre>
<h3 data-id="heading-42">🔮 未来规划</h3>
<p>实体管理模块后续将会支持：</p>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 实体分组管理</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 实体样式预设</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 实体动画支持</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 实体点击事件封装</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 实体序列化与反序列化</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 批量操作性能优化</li>
</ul>
<h3 data-id="heading-43">📚 相关资源</h3>
<ul>
<li><strong>GitHub 仓库</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FlukeSuperCoder%2Fcesium-lite" target="_blank" title="https://github.com/lukeSuperCoder/cesium-lite" ref="nofollow noopener noreferrer">github.com/lukeSuperCo…</a></li>
<li><strong>在线演示</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Flukesupercoder.github.io%2Fcesium-lite%2F" target="_blank" title="https://lukesupercoder.github.io/cesium-lite/" ref="nofollow noopener noreferrer">lukesupercoder.github.io/cesium-lite…</a></li>
<li><strong>NPM 包</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2Fcesium-lite" target="_blank" title="https://www.npmjs.com/package/cesium-lite" ref="nofollow noopener noreferrer">www.npmjs.com/package/ces…</a></li>
<li><strong>问题反馈</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FlukeSuperCoder%2Fcesium-lite%2Fissues" target="_blank" title="https://github.com/lukeSuperCoder/cesium-lite/issues" ref="nofollow noopener noreferrer">GitHub Issues</a></li>
</ul>
<h3 data-id="heading-44">🙏 总结</h3>
<p>CesiumLite 的实体管理模块通过双层封装架构，有效解决了 Cesium 原生开发中的诸多痛点：</p>
<ul>
<li>✅ <strong>简化 API</strong>：减少 70%-90% 的代码量</li>
<li>✅ <strong>统一管理</strong>：自动 ID 生成 + 命名空间隔离</li>
<li>✅ <strong>开箱即用</strong>：无需重复造轮子</li>
<li>✅ <strong>性能优化</strong>：使用 Map 数据结构，高效查找</li>
</ul>
<p>如果你正在使用 Cesium 开发三维地图应用，不妨试试 CesiumLite，让你的开发效率翻倍！</p>
<hr/>
<p><strong>⭐ 如果这个项目对你有帮助，欢迎给个 Star 支持一下！</strong></p>
<p><strong>💬 有任何问题或建议，欢迎在评论区交流！</strong></p>
<p><strong>相关标签：</strong> #Cesium #三维地图 #WebGIS #前端开发 #JavaScript #开源项目 #地图可视化</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[为什么工作 10 年都没遇过分布式锁？]]></title>    <link>https://juejin.cn/post/7578700798743887906</link>    <guid>https://juejin.cn/post/7578700798743887906</guid>    <pubDate>2025-12-01T10:08:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578700798743887906" data-draft-id="7578699975413678080" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="为什么工作 10 年都没遇过分布式锁？"/> <meta itemprop="keywords" content="后端,Java,架构"/> <meta itemprop="datePublished" content="2025-12-01T10:08:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="架构师沉默"/> <meta itemprop="url" content="https://juejin.cn/user/613946828261482"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            为什么工作 10 年都没遇过分布式锁？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/613946828261482/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    架构师沉默
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-01T10:08:36.000Z" title="Mon Dec 01 2025 10:08:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-01
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>沉默是金，总会发光</p>
<p>大家好，我是沉默</p>
<p>前两天在群里看到一句话，瞬间把我笑喷：</p>
<blockquote>
<p>“工作10年了，简历上写了熟悉分布式系统，结果一次分布式锁都没用过。是太菜，还是公司太稳？”</p>
</blockquote>
<p>底下一群人立刻跟上：</p>
<ul>
<li>
<p>“+1，我也是！”</p>
</li>
<li>
<p>“我们公司连‘分布’俩字都不敢提……”</p>
</li>
<li>
<p>“别说锁了，我们连 Redis 集群都没有，就一台单机 Redis 顶天。”</p>
</li>
</ul>
<p>看到这里，我只想说一句：<br/>
<strong>兄弟，这不是你一个人的困惑，这是大部分开发的真实写照。</strong></p>
<p>**-**<strong>01-</strong></p>
<p><strong>啥是分布式锁？</strong></p>
<p>想象你跟 10 个人排队打饭——大家都很守规矩：<strong>先来先打，公平有序</strong>。</p>
<p>但如果这 10 个人分散在不同窗口，每人都觉得“锅里还有”而同时开舀？</p>
<p>锅就穿了。</p>
<p>这就是分布式系统中的典型现象——<strong>多个节点抢一个资源，必须定规则，否则乱套。</strong></p>
<p>分布式锁的用途就是：</p>
<ul>
<li>谁先抢到锁，谁执行</li>
<li>执行完才允许下一个来</li>
</ul>
<p>**<br/>
**</p>
<p><strong>典型冲突场景：</strong></p>
<ul>
<li>
<p>发红包不能发两次</p>
</li>
<li>
<p>库存不能卖超</p>
</li>
<li>
<p>定时任务不能多个节点一起跑</p>
</li>
</ul>
<p>很多公司根本没这些高并发需求，所以你自然用不上。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a918395cb3d7450289059081c9391f10~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p625p6E5biI5rKJ6buY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765188516&amp;x-signature=qLrYUxDyDxKRO3fPXNSR6rMiM9c%3D" alt="图片" loading="lazy"/></p>
<p><strong>-</strong> <strong>02-</strong></p>
<p><strong>两个你肯定听过的真实事故</strong></p>
<h3 data-id="heading-0"><strong>场景 1：秒杀超卖</strong></h3>
<p>活动喊着“限量 100 件”，结果卖了 130 件。<br/>
仓库懵了，客服炸了，领导坐你后面看你写代码。</p>
<p>为什么会超卖？</p>
<p>因为有十台服务器同时判断：</p>
<blockquote>
<p>“库存 &gt; 0，那可以卖！”</p>
</blockquote>
<p>于是……一起卖了。</p>
<p><strong>解决方式：</strong>  在扣库存之前加锁，抢到锁才能操作。</p>
<h3 data-id="heading-1">** **</h3>
<h3 data-id="heading-2"><strong>场景 2：重复退款</strong></h3>
<p>用户手速太快，“退款”点了两次。<br/>
你的服务部署在三个节点里，结果两个节点收到了同一个请求。</p>
<p>如果没锁？<br/>
<strong>资金直接退两遍。</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/99ed2dd434e9468b97c1e4d4835ea736~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p625p6E5biI5rKJ6buY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765188516&amp;x-signature=rpkGJuf59PLL2bmgL7TFdeQuE1Y%3D" alt="图片" loading="lazy"/></p>
<p><strong>-</strong> <strong>03-</strong></p>
<p><strong>分布式锁咋实现?</strong></p>
<p>Redis 分布式锁</p>
<p>原理不复杂，就是：</p>
<ul>
<li><code>SETNX</code> 抢锁</li>
<li>设置过期时间避免死锁</li>
<li>释放锁时判断是不是自己的锁</li>
</ul>
<p>（SpringBoot 简化版）：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Componentpublic</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisDistributedLock</span> {    <span class="hljs-meta">@Autowired</span>    <span class="hljs-keyword">private</span> <span class="hljs-title class_">StringRedisTemplate</span> redisTemplate;    <span class="hljs-keyword">public</span> <span class="hljs-built_in">boolean</span> <span class="hljs-title function_">tryLock</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> lockKey, <span class="hljs-built_in">String</span> requestId, long expireTime</span>) {        <span class="hljs-keyword">return</span> redisTemplate.<span class="hljs-title function_">opsForValue</span>()            .<span class="hljs-title function_">setIfAbsent</span>(lockKey, requestId, expireTime, <span class="hljs-title class_">TimeUnit</span>.<span class="hljs-property">SECONDS</span>);    }    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">releaseLock</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> lockKey, <span class="hljs-built_in">String</span> requestId</span>) {        <span class="hljs-title class_">String</span> currentValue = redisTemplate.<span class="hljs-title function_">opsForValue</span>().<span class="hljs-title function_">get</span>(lockKey);        <span class="hljs-keyword">if</span> (requestId.<span class="hljs-title function_">equals</span>(currentValue)) {            redisTemplate.<span class="hljs-title function_">delete</span>(lockKey);        }    }}
</code></pre>
<p>看起来“像那么回事”，但上生产就开始暴露坑：</p>
<ul>
<li>
<p>锁到期太短 → 业务还没执行完锁就失效</p>
</li>
<li>
<p>锁到期太长 → 业务挂了锁一直不释放</p>
</li>
<li>
<p>锁被别人抢走后，你把别人的锁释放了（灾难）</p>
</li>
</ul>
<p>生产还得是 Redisson 分布式锁</p>
<p>Redisson：</p>
<blockquote>
<p><strong>“别怕，我都给你封装好了。”</strong></p>
</blockquote>
<p>自动续期（看门狗）、可重入锁、公平锁、读写锁，全都有。</p>
<h3 data-id="heading-3">** **</h3>
<h3 data-id="heading-4"><strong>使用也很简单：</strong></h3>
<h4 data-id="heading-5">1）引依赖</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.redisson<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>redisson-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.24.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p>2）代码更简单</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-keyword">@Servicepublic</span> class PaymentService {    <span class="hljs-keyword">@Autowired</span>    private RedissonClient redissonClient;    public void <span class="hljs-built_in">processRefund</span>(String orderNo) {        RLock lock = redissonClient<span class="hljs-selector-class">.getLock</span>("lock:refund:" + orderNo);        try {            boolean isLocked = lock<span class="hljs-selector-class">.tryLock</span>(<span class="hljs-number">100</span>, <span class="hljs-number">10</span>, TimeUnit.SECONDS);            if (isLocked) {                if (hasRefunded(orderNo)) {                    throw new <span class="hljs-built_in">RuntimeException</span>("已退款，请勿重复操作");                }                <span class="hljs-built_in">doRefund</span>(orderNo);                <span class="hljs-built_in">recordRefund</span>(orderNo);            }        } catch (Exception e) {            throw new <span class="hljs-built_in">RuntimeException</span>("获取锁失败", e);        } finally {            if (lock.isHeldByCurrentThread()) {                lock<span class="hljs-selector-class">.unlock</span>();            }        }    }}
</code></pre>
<p>放心，这玩意能撑住大部分业务场景。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2609154464cf4f48945d6054030adf9c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p625p6E5biI5rKJ6buY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765188516&amp;x-signature=Qa5HZH%2BT3D9mkF8wTw%2FIzI1wUno%3D" alt="图片" loading="lazy"/></p>
<p>**-****04-**<strong>总结</strong></p>
<h2 data-id="heading-6"><strong>为什么你没用过？</strong></h2>
<p>非常简单，只有两种原因：</p>
<h3 data-id="heading-7"><strong>❶ 公司业务稳得一匹</strong></h3>
<ul>
<li>用户量小</li>
<li>单节点就够</li>
<li>业务流程不冲突</li>
<li>高并发压根不存在</li>
</ul>
<p>没到量级，当然用不上。</p>
<h3 data-id="heading-8"><strong>❷ 框架和数据库帮你扛了</strong></h3>
<p>你以为没做，其实系统已经帮你做了：</p>
<ul>
<li>MySQL 悲观锁：<code>SELECT ... FOR UPDATE</code></li>
<li>乐观锁：version字段</li>
<li>Redis <code>INCR/DECR</code> 原子操作</li>
<li>消息去重</li>
</ul>
<p>你“看上去没锁”，但其实“锁无处不在”。</p>
<h2 data-id="heading-9"><strong>现在不用，不代表以后用不到</strong></h2>
<p>跳槽、业务增长、架构升级，都可能让你突然遇到分布式场景。</p>
<p>而分布式锁属于那种：</p>
<blockquote>
<p><strong>“线上十年不用，一次用不好就出大事故”的功能。</strong></p>
</blockquote>
<p>所以现在把原理搞明白、把代码跑通，未来一定能救你一命。</p>
<h2 data-id="heading-10"><strong>你工作几年？用过分布式锁吗？</strong></h2>
<p>你可以直接在评论区说说：</p>
<ul>
<li>
<p>你第一次用分布式锁是什么场景？</p>
</li>
<li>
<p>你们公司是不是至今连 Redis 集群都没有？</p>
</li>
<li>
<p>或者，你也是“写了分布式系统，但没见过分布式锁”的那种？</p>
</li>
</ul>
<pre><code class="hljs"/></pre>
<p>**-****05-**<strong>粉丝福利</strong></p>
<pre><code class="hljs">站在职业的十字路口，我们或许都曾感到迷茫：




投出的简历总是没有回音？




面试时不知如何展现自己的优势？




未来的职场道路该如何规划？




技术管理能力提升，如何跨越第一步？




如果你正在经历这些，我很乐意用我的经验为你提供一些帮助。




无论是修改简历、1对1求职陪跑，职业规划咨询，




还是迈向技术Leader或提升管理效能，




欢迎你加我，我们像朋友一样聊聊。
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[MyBatis设计观——映射思想、动态SQL的边界与可维护性考量]]></title>    <link>https://juejin.cn/post/7578667193321095231</link>    <guid>https://juejin.cn/post/7578667193321095231</guid>    <pubDate>2025-12-01T10:15:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578667193321095231" data-draft-id="7578681104292085803" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="MyBatis设计观——映射思想、动态SQL的边界与可维护性考量"/> <meta itemprop="keywords" content="后端,架构"/> <meta itemprop="datePublished" content="2025-12-01T10:15:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="十月南城"/> <meta itemprop="url" content="https://juejin.cn/user/3456520290576862"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            MyBatis设计观——映射思想、动态SQL的边界与可维护性考量
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3456520290576862/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    十月南城
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-01T10:15:48.000Z" title="Mon Dec 01 2025 10:15:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-01
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>在对象与关系的鸿沟之间，MyBatis选择了一条独特的桥梁建设之路——不强求完全自动化，而是将控制权交还给开发者</p>
</blockquote>
<p>在持久层框架的设计哲学中，MyBatis采取了与全自动ORM框架截然不同的路径。它不试图完全隐藏数据库细节，而是通过优雅的映射机制和动态SQL能力，在对象模型与关系模型之间建立了可控的转换通道。本文将深入剖析MyBatis的核心设计思想，探讨动态SQL的适用边界，并给出构建可维护MyBatis应用的最佳实践。</p>
<h2 data-id="heading-0">1 MyBatis的设计哲学：半自动化ORM的价值定位</h2>
<h3 data-id="heading-1">1.1 与全自动ORM的差异化定位</h3>
<p>MyBatis作为一个<strong>半自动化ORM框架</strong>，在设计哲学上与Hibernate等全自动ORM框架有着本质区别。全自动ORM试图完全屏蔽数据库细节，让开发者以面向对象的方式操作数据，而MyBatis则承认对象与关系之间的<strong>阻抗不匹配</strong>是不可避免的，选择将SQL的控制权交还给开发者。</p>
<p>这种设计理念带来了不同的权衡：全自动ORM通过抽象提高了开发效率，但牺牲了对SQL的精细控制；MyBatis通过暴露SQL细节，确保了性能可控性和灵活性，但要求开发者具备数据库知识。正如MyBatis的核心贡献者所言：“我们不相信一种模式能够适合所有场景，有时候你需要直接与SQL打交道”。</p>
<h3 data-id="heading-2">1.2 核心设计原则：简单性与可控性</h3>
<p>MyBatis的设计遵循两个核心原则：<strong>简单性</strong>和<strong>可控性</strong>。框架本身保持轻量级，核心组件数量有限且职责单一，这使得学习曲线相对平缓。同时，开发者对SQL拥有完全控制权，可以针对特定数据库优化SQL语句，充分利用数据库特有功能。</p>
<p>这种设计理念在实际应用中体现为“约定优于配置”的适度使用。MyBatis提供合理的默认值，但几乎所有默认行为都可以被覆盖，如可以通过<code>&lt;settings&gt;</code>标签配置缓存行为、日志实现等。与Spring框架的无缝集成进一步强化了这种可控性，使MyBatis能够融入现代Java应用生态系统。</p>
<h2 data-id="heading-3">2 映射机制：对象与关系的桥梁建设</h2>
<h3 data-id="heading-4">2.1 结果映射：从关系表到对象树的转换</h3>
<p>MyBatis的映射核心是<strong>ResultMap</strong>机制，它定义了如何将SQL查询结果转换为Java对象树。与全自动ORM的“黑盒”映射不同，ResultMap要求开发者显式定义映射规则，这种显式性虽然增加了配置工作量，但提高了系统的可理解性和可控性。</p>
<p><strong>简单映射</strong>处理单表查询到扁平对象的转换，通过<code>&lt;result&gt;</code>标签将列与属性关联：</p>
<pre><code class="hljs language-ini" lang="ini">&lt;resultMap <span class="hljs-attr">id</span>=<span class="hljs-string">"UserResult"</span> type=<span class="hljs-string">"User"</span>&gt;
    &lt;id <span class="hljs-attr">property</span>=<span class="hljs-string">"id"</span> column=<span class="hljs-string">"user_id"</span>/&gt;
    &lt;result <span class="hljs-attr">property</span>=<span class="hljs-string">"username"</span> column=<span class="hljs-string">"user_name"</span>/&gt;
    &lt;result <span class="hljs-attr">property</span>=<span class="hljs-string">"email"</span> column=<span class="hljs-string">"email"</span>/&gt;
&lt;/resultMap&gt;
</code></pre>
<p><strong>复杂映射</strong>处理关联对象，通过<code>&lt;association&gt;</code>（一对一）和<code>&lt;collection&gt;</code>（一对多）标签构建对象图：</p>
<pre><code class="hljs language-ini" lang="ini">&lt;resultMap <span class="hljs-attr">id</span>=<span class="hljs-string">"BlogResult"</span> type=<span class="hljs-string">"Blog"</span>&gt;
    &lt;id <span class="hljs-attr">property</span>=<span class="hljs-string">"id"</span> column=<span class="hljs-string">"blog_id"</span>/&gt;
    &lt;result <span class="hljs-attr">property</span>=<span class="hljs-string">"title"</span> column=<span class="hljs-string">"title"</span>/&gt;
    &lt;association <span class="hljs-attr">property</span>=<span class="hljs-string">"author"</span> javaType=<span class="hljs-string">"Author"</span>&gt;
        &lt;id <span class="hljs-attr">property</span>=<span class="hljs-string">"id"</span> column=<span class="hljs-string">"author_id"</span>/&gt;
        &lt;result <span class="hljs-attr">property</span>=<span class="hljs-string">"name"</span> column=<span class="hljs-string">"author_name"</span>/&gt;
    &lt;/association&gt;
    &lt;collection <span class="hljs-attr">property</span>=<span class="hljs-string">"posts"</span> ofType=<span class="hljs-string">"Post"</span>&gt;
        &lt;id <span class="hljs-attr">property</span>=<span class="hljs-string">"id"</span> column=<span class="hljs-string">"post_id"</span>/&gt;
        &lt;result <span class="hljs-attr">property</span>=<span class="hljs-string">"content"</span> column=<span class="hljs-string">"content"</span>/&gt;
    &lt;/collection&gt;
&lt;/resultMap&gt;
</code></pre>
<p>这种显式映射确保了数据转换的可预测性，避免了“魔法”行为带来的调试困难。</p>
<h3 data-id="heading-5">2.2 参数映射：从对象到SQL参数的传递</h3>
<p>MyBatis的参数映射机制将Java方法参数转换为SQL语句中的占位符值。<strong>简单类型参数</strong>直接映射到预编译语句的占位符，而<strong>复杂对象参数</strong>则通过属性路径映射：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-operator">&lt;</span><span class="hljs-keyword">insert</span> id<span class="hljs-operator">=</span>"insertUser" parameterType<span class="hljs-operator">=</span>"User"<span class="hljs-operator">&gt;</span>
    <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> users (username, email, create_time)
    <span class="hljs-keyword">VALUES</span> (#{username}, #{email}, #{createTime})
<span class="hljs-operator">&lt;</span><span class="hljs-operator">/</span><span class="hljs-keyword">insert</span><span class="hljs-operator">&gt;</span>
</code></pre>
<p><strong>参数类型处理器</strong>（TypeHandler）是参数映射的扩展点，负责Java类型与JDBC类型之间的转换。MyBatis提供了内置处理器，同时也支持自定义实现，用于处理枚举、JSON等复杂类型。</p>
<h2 data-id="heading-6">3 动态SQL：灵活性与复杂性的平衡艺术</h2>
<h3 data-id="heading-7">3.1 动态SQL的适用场景与边界</h3>
<p>动态SQL是MyBatis最强大的特性之一，它允许根据运行时条件动态构建SQL语句。这种能力特别适用于<strong>多条件查询</strong>、<strong>可变更新操作</strong>和<strong>批量数据处理</strong>场景。</p>
<p>然而，动态SQL的灵活性也带来了复杂性管理的挑战。当动态逻辑过于复杂时，生成的SQL可能难以预测和维护。因此，需要明确动态SQL的<strong>适用边界</strong>：简单条件组合使用动态SQL，复杂业务逻辑则考虑在Java层构建。</p>
<h3 data-id="heading-8">3.2 动态标签的合理使用</h3>
<p>MyBatis提供了一系列动态标签，每种标签都有其特定用途和使用边界：</p>
<p><code>&lt;if&gt;</code>标签用于可选条件，是最常用的动态标签：</p>
<pre><code class="hljs language-bash" lang="bash">&lt;select <span class="hljs-built_in">id</span>=<span class="hljs-string">"findUsers"</span> resultType=<span class="hljs-string">"User"</span>&gt;
    SELECT * FROM <span class="hljs-built_in">users</span>
    &lt;<span class="hljs-built_in">where</span>&gt;
        &lt;<span class="hljs-keyword">if</span> <span class="hljs-built_in">test</span>=<span class="hljs-string">"username != null and username != ''"</span>&gt;
            AND username = <span class="hljs-comment">#{username}</span>
        &lt;/if&gt;
        &lt;<span class="hljs-keyword">if</span> <span class="hljs-built_in">test</span>=<span class="hljs-string">"email != null"</span>&gt;
            AND email = <span class="hljs-comment">#{email}</span>
        &lt;/if&gt;
    &lt;/where&gt;
&lt;/select&gt;
</code></pre>
<p><code>&lt;choose&gt;</code>、<code>&lt;when&gt;</code>、<code>&lt;otherwise&gt;</code>实现多路分支逻辑，替代复杂的if-else链：</p>
<pre><code class="hljs language-bash" lang="bash">&lt;select <span class="hljs-built_in">id</span>=<span class="hljs-string">"findActiveUsers"</span> resultType=<span class="hljs-string">"User"</span>&gt;
    SELECT * FROM <span class="hljs-built_in">users</span>
    &lt;<span class="hljs-built_in">where</span>&gt;
        &lt;choose&gt;
            &lt;when <span class="hljs-built_in">test</span>=<span class="hljs-string">"active == true"</span>&gt;
                AND status = <span class="hljs-string">'ACTIVE'</span>
            &lt;/when&gt;
            &lt;when <span class="hljs-built_in">test</span>=<span class="hljs-string">"inactive == true"</span>&gt;
                AND status = <span class="hljs-string">'INACTIVE'</span>
            &lt;/when&gt;
            &lt;otherwise&gt;
                AND status IS NOT NULL
            &lt;/otherwise&gt;
        &lt;/choose&gt;
    &lt;/where&gt;
&lt;/select&gt;
</code></pre>
<p><code>&lt;foreach&gt;</code>标签处理集合遍历，常用于IN查询和批量操作：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-operator">&lt;</span><span class="hljs-keyword">select</span> id<span class="hljs-operator">=</span>"findUsersByIds" resultType<span class="hljs-operator">=</span>"User"<span class="hljs-operator">&gt;</span>
    <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users
    <span class="hljs-keyword">WHERE</span> id <span class="hljs-keyword">IN</span>
    <span class="hljs-operator">&lt;</span>foreach item<span class="hljs-operator">=</span>"id" collection<span class="hljs-operator">=</span>"ids" <span class="hljs-keyword">open</span><span class="hljs-operator">=</span>"(" separator<span class="hljs-operator">=</span>"," <span class="hljs-keyword">close</span><span class="hljs-operator">=</span>")"<span class="hljs-operator">&gt;</span>
        #{id}
    <span class="hljs-operator">&lt;</span><span class="hljs-operator">/</span>foreach<span class="hljs-operator">&gt;</span>
<span class="hljs-operator">&lt;</span><span class="hljs-operator">/</span><span class="hljs-keyword">select</span><span class="hljs-operator">&gt;</span>
</code></pre>
<h3 data-id="heading-9">3.3 动态SQL的可维护性实践</h3>
<p>保持动态SQL可维护性的关键实践包括：<strong>适度抽象</strong>，将重复的SQL片段提取为<code>&lt;sql&gt;</code>标签；<strong>逻辑简化</strong>，避免嵌套过深的动态逻辑；<strong>注释补充</strong>，为复杂动态逻辑添加解释性注释。</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 可维护的动态SQL示例 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">sql</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"userColumns"</span>&gt;</span>id, username, email, status<span class="hljs-tag">&lt;/<span class="hljs-name">sql</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"searchUsers"</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">"User"</span>&gt;</span>
    SELECT <span class="hljs-tag">&lt;<span class="hljs-name">include</span> <span class="hljs-attr">refid</span>=<span class="hljs-string">"userColumns"</span>/&gt;</span>
    FROM users
    <span class="hljs-tag">&lt;<span class="hljs-name">where</span>&gt;</span>
        <span class="hljs-comment">&lt;!-- 按状态过滤：支持多种状态查询 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"statusList != null and statusList.size() &gt; 0"</span>&gt;</span>
            AND status IN
            <span class="hljs-tag">&lt;<span class="hljs-name">foreach</span> <span class="hljs-attr">item</span>=<span class="hljs-string">"status"</span> <span class="hljs-attr">collection</span>=<span class="hljs-string">"statusList"</span> <span class="hljs-attr">open</span>=<span class="hljs-string">"("</span> <span class="hljs-attr">separator</span>=<span class="hljs-string">","</span> <span class="hljs-attr">close</span>=<span class="hljs-string">")"</span>&gt;</span>
                #{status}
            <span class="hljs-tag">&lt;/<span class="hljs-name">foreach</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
        <span class="hljs-comment">&lt;!-- 按用户名模糊查询 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"username != null and username != ''"</span>&gt;</span>
            AND username LIKE CONCAT(#{username}, '%')
        <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">where</span>&gt;</span>
    ORDER BY create_time DESC
<span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span>
</code></pre>
<h2 data-id="heading-10">4 缓存设计：性能与一致性的权衡</h2>
<h3 data-id="heading-11">4.1 两级缓存机制的设计原理</h3>
<p>MyBbatis采用<strong>两级缓存</strong>结构，在数据新鲜度和性能之间提供不同级别的权衡。</p>
<p><strong>一级缓存</strong>是SqlSession级别的缓存，默认开启，生命周期与数据库会话绑定。它在同一会话内避免重复查询，但跨会话无法共享数据。<strong>二级缓存</strong>是Mapper级别的缓存，默认关闭，需要显式配置。多个SqlSession可以共享二级缓存，提供跨会话的数据复用能力。</p>
<h3 data-id="heading-12">4.2 缓存策略与一致性保障</h3>
<p>MyBatis的缓存更新策略遵循<strong>写失效</strong>模式：任何增删改操作都会清空对应Mapper的缓存。这种保守策略保证了强一致性，但可能牺牲部分性能。</p>
<p>合理的缓存配置需要考虑数据的<strong>访问模式</strong>和<strong>更新频率</strong>。读多写少的数据适合开启二级缓存，频繁更新的数据则应避免缓存或设置较短过期时间：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 二级缓存配置示例 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">cache</span>
    <span class="hljs-attr">eviction</span>=<span class="hljs-string">"LRU"</span>
    <span class="hljs-attr">flushInterval</span>=<span class="hljs-string">"300000"</span>
    <span class="hljs-attr">size</span>=<span class="hljs-string">"1024"</span>
    <span class="hljs-attr">readOnly</span>=<span class="hljs-string">"true"</span>/&gt;</span>
</code></pre>
<h2 data-id="heading-13">5 可维护性架构设计</h2>
<h3 data-id="heading-14">5.1 项目结构组织规范</h3>
<p>可维护的MyBatis项目需要合理的代码组织方式。<strong>按功能模块分包</strong>将Mapper接口、XML映射文件、实体类组织在同一模块内，减少跨模块依赖：</p>
<pre><code class="hljs language-bash" lang="bash">src/main/java
└── com/example/
    ├── user/
    │   ├── User.java          <span class="hljs-comment"># 实体类</span>
    │   ├── UserMapper.java    <span class="hljs-comment"># Mapper接口</span>
    │   └── UserService.java   <span class="hljs-comment"># 业务服务类</span>
    └── product/
        ├── Product.java
        ├── ProductMapper.java
        └── ProductService.java

src/main/resources
└── com/example/
    ├── user/
    │   └── UserMapper.xml     <span class="hljs-comment"># 映射文件与接口同包</span>
    └── product/
        └── ProductMapper.xml
</code></pre>
<p><strong>命名约定</strong>保持一致命名风格，如<code>UserMapper</code>接口对应<code>UserMapper.xml</code>，<code>findByXxx</code>用于查询方法，<code>updateXxx</code>用于更新操作。</p>
<h3 data-id="heading-15">5.2 SQL映射的模块化管理</h3>
<p>大型项目中，SQL映射文件可能变得庞大复杂。<strong>SQL片段复用</strong>通过<code>&lt;sql&gt;</code>标签提取公共SQL片段，减少重复代码：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 公共列定义 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">sql</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"baseColumns"</span>&gt;</span>id, create_time, update_time, version<span class="hljs-tag">&lt;/<span class="hljs-name">sql</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 在查询中引用 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"selectDetail"</span> <span class="hljs-attr">resultMap</span>=<span class="hljs-string">"DetailResult"</span>&gt;</span>
    SELECT 
        <span class="hljs-tag">&lt;<span class="hljs-name">include</span> <span class="hljs-attr">refid</span>=<span class="hljs-string">"baseColumns"</span>/&gt;</span>,
        other_columns
    FROM table
<span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span>
</code></pre>
<p><strong>结果映射继承</strong>通过<code>&lt;resultMap&gt;</code>的<code>extends</code>属性实现映射复用：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 基础映射 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">resultMap</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"BaseResult"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"BaseEntity"</span> <span class="hljs-attr">autoMapping</span>=<span class="hljs-string">"true"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">id</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"id"</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"id"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"createTime"</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"create_time"</span>/&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">resultMap</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 扩展映射 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">resultMap</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"UserResult"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"User"</span> <span class="hljs-attr">extends</span>=<span class="hljs-string">"BaseResult"</span> <span class="hljs-attr">autoMapping</span>=<span class="hljs-string">"true"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"username"</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"username"</span>/&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">resultMap</span>&gt;</span>
</code></pre>
<h2 data-id="heading-16">6 集成与扩展架构</h2>
<h3 data-id="heading-17">6.1 Spring集成的最佳实践</h3>
<p>MyBatis与Spring的集成提供了声明式事务管理和依赖注入支持。<strong>注解配置</strong>简化了集成配置，通过<code>@MapperScan</code>自动注册Mapper接口：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@Configuration</span>
<span class="hljs-variable">@MapperScan</span>(<span class="hljs-string">"com.example.mapper"</span>)
public class MyBatisConfig {
    
    <span class="hljs-variable">@Bean</span>
    public SqlSessionFactory <span class="hljs-built_in">sqlSessionFactory</span>(DataSource dataSource) throws Exception {
        <span class="hljs-selector-tag">SqlSessionFactoryBean</span> <span class="hljs-selector-tag">sessionFactory</span> = <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">SqlSessionFactoryBean</span>();
        <span class="hljs-selector-tag">sessionFactory</span><span class="hljs-selector-class">.setDataSource</span>(dataSource);
        <span class="hljs-selector-tag">sessionFactory</span><span class="hljs-selector-class">.setMapperLocations</span>(
            new <span class="hljs-built_in">PathMatchingResourcePatternResolver</span>()
                .<span class="hljs-built_in">getResources</span>(<span class="hljs-string">"classpath*:mapper/**/*.xml"</span>));
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">sessionFactory</span><span class="hljs-selector-class">.getObject</span>();
    }
}
</code></pre>
<p><strong>事务管理</strong>通过Spring的<code>@Transactional</code>注解实现声明式事务，确保数据一致性。</p>
<h3 data-id="heading-18">6.2 自定义插件与类型处理器</h3>
<p>MyBatis的扩展机制允许开发者定制框架行为。<strong>插件</strong>（Interceptor）可以拦截MyBatis的核心组件执行过程，用于SQL日志、分页、权限控制等横切关注点：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@Intercepts</span>({
    <span class="hljs-variable">@Signature</span>(type = Executor.class, method = <span class="hljs-string">"update"</span>, args = {MappedStatement.class, Object.class})
})
public class SqlLogPlugin implements Interceptor {
    <span class="hljs-variable">@Override</span>
    public Object <span class="hljs-built_in">intercept</span>(Invocation invocation) throws Throwable {
        <span class="hljs-comment">// 实现拦截逻辑</span>
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">invocation</span><span class="hljs-selector-class">.proceed</span>();
    }
}
</code></pre>
<p><strong>类型处理器</strong>（TypeHandler）实现自定义类型转换，如JSON类型与数据库字符串的转换：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JsonTypeHandler</span>&lt;T&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseTypeHandler</span>&lt;T&gt; {
    <span class="hljs-keyword">private</span> final <span class="hljs-title class_">Class</span>&lt;T&gt; <span class="hljs-keyword">type</span>;
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">setNonNullParameter</span>(<span class="hljs-params">PreparedStatement ps, int i, T parameter, JdbcType jdbcType</span>) {
        ps.<span class="hljs-title function_">setString</span>(i, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">toJSONString</span>(parameter));
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> T <span class="hljs-title function_">getNullableResult</span>(<span class="hljs-params">ResultSet rs, <span class="hljs-built_in">String</span> columnName</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parseObject</span>(rs.<span class="hljs-title function_">getString</span>(columnName), <span class="hljs-keyword">type</span>);
    }
}
</code></pre>
<h2 data-id="heading-19">总结：MyBatis设计的平衡智慧</h2>
<p>MyBatis的设计观体现了工程领域的平衡智慧。它在控制与便利、灵活与稳定、简单与功能之间找到了恰当的平衡点。这种平衡不是妥协，而是对现实开发需求的深刻理解。</p>
<p><strong>精准的定位</strong>是MyBatis成功的关键。它不试图解决所有持久层问题，而是专注于为需要SQL控制权的场景提供最佳解决方案。<strong>适度的抽象</strong>让开发者既享受了ORM的便利，又保留了直接操作SQL的能力。</p>
<p>作为一款历经考验的持久层框架，MyBatis的设计思想值得每个后端开发者深入理解。在微服务和云原生时代，这种对透明性和可控性的重视显得更加珍贵，这也是MyBatis在现代应用架构中继续保持重要地位的原因。</p>
<p><strong>📚 下篇预告</strong>​</p>
<p>《MyBatis进阶治理点——缓存、副作用、拦截与批处理的得失分析》—— 我们将深入探讨：</p>
<ul>
<li>
<p>🎯 <strong>缓存深度治理</strong>：分布式环境下缓存一致性保障与失效策略</p>
</li>
<li>
<p>⚠️ <strong>副作用控制</strong>：并发场景下的数据竞争与隔离机制</p>
</li>
<li>
<p>🔧 <strong>拦截器高级应用</strong>：全链路SQL监控与性能诊断</p>
</li>
<li>
<p>📊 <strong>批处理优化</strong>：大数据量操作的性能瓶颈与解决方案</p>
</li>
<li>
<p>🛡️ <strong>生产环境实践</strong>：MyBatis在高并发场景下的稳定性保障</p>
</li>
</ul>
<p>**点击关注，掌握MyBatis进阶治理的核心要领！**​</p>
<blockquote>
<p><strong>今日行动建议</strong>：</p>
<ol>
<li>
<p>审查现有项目中动态SQL的复杂度，确保不超过可维护边界</p>
</li>
<li>
<p>检查缓存配置是否符合业务场景的数据一致性要求</p>
</li>
<li>
<p>统一项目中的映射文件规范，提高代码可维护性</p>
</li>
<li>
<p>针对复杂查询场景，制定SQL性能审核机制</p>
</li>
</ol>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Promise.resolve(x) 等同 new Promise(resolve => resolve(x))?]]></title>    <link>https://juejin.cn/post/7578681104292069419</link>    <guid>https://juejin.cn/post/7578681104292069419</guid>    <pubDate>2025-12-01T10:05:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578681104292069419" data-draft-id="7578667193320996927" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Promise.resolve(x) 等同 new Promise(resolve =&gt; resolve(x))?"/> <meta itemprop="keywords" content="前端,Promise"/> <meta itemprop="datePublished" content="2025-12-01T10:05:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="之恒君"/> <meta itemprop="url" content="https://juejin.cn/user/2261046026312318"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Promise.resolve(x) 等同 new Promise(resolve =&gt; resolve(x))?
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2261046026312318/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    之恒君
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-01T10:05:46.000Z" title="Mon Dec 01 2025 10:05:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-01
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><code>Promise.resolve(x)</code> 与 <code>return new Promise((resolve) =&gt; resolve(x))</code> 在多数场景下行为一致，但不能完全等同理解，需从规范定义的细节差异区分，具体分析如下：</p>
<h3 data-id="heading-0">一、核心行为的一致性（基础场景）</h3>
<p>在处理“非Promise类型的x”或“非当前构造函数生成的Promise实例x”时，两者逻辑高度一致，均会创建一个新的Promise实例并以x为结果决议：</p>
<ol>
<li>若x是普通值（如数字、字符串、对象等非Promise/非thenable类型），<code>Promise.resolve(x)</code> 会创建新Promise并直接决议为fulfilled状态，结果为x；<code>new Promise((resolve) =&gt; resolve(x))</code> 也会通过调用resolve回调，让新Promise以x为结果fulfilled，这符合文档中<code>PromiseResolve</code>抽象操作对普通值的处理逻辑。</li>
<li>若x是thenable对象（含then方法的非Promise对象），两者都会触发“thenable同化”逻辑：调用x的then方法，用其结果决议新Promise，这与文档中<code>Promise Resolve Functions</code>处理thenable的步骤一致。</li>
</ol>
<h3 data-id="heading-1">二、关键差异（不能完全等同的场景）</h3>
<p>根据文档规范，<code>Promise.resolve(x)</code> 存在特殊优化逻辑，而 <code>new Promise(...)</code> 无此处理，导致两者在特定场景下行为不同：</p>
<ol>
<li><strong>x是当前构造函数生成的Promise实例时</strong></li>
</ol>
<blockquote>
<p><strong><code>Promise.resolve(x)</code></strong> 规范文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Ftc39.es%2Fecma262%2Fmultipage%2Fcontrol-abstraction-objects.html%23sec-promise.resolve" target="_blank" title="https://tc39.es/ecma262/multipage/control-abstraction-objects.html#sec-promise.resolve" ref="nofollow noopener noreferrer">tc39.es/ecma262/mul…</a></p>
</blockquote>
<p>文档明确规定，若x是Promise实例且其构造函数与当前<code>Promise.resolve</code>的this值（即构造函数C）相同，<code>Promise.resolve(x)</code> 会直接返回x，而非创建新Promise。<br/>
例如：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> p = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> <span class="hljs-title function_">resolve</span>(<span class="hljs-number">1</span>));
<span class="hljs-comment">// Promise.resolve(p) 直接返回p，不新建Promise</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(p) === p); <span class="hljs-comment">// true</span>
<span class="hljs-comment">// new Promise(...) 始终新建Promise，与p不是同一实例</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> <span class="hljs-title function_">resolve</span>(p)) === p); <span class="hljs-comment">// false</span>
</code></pre>
<p>这是<code>Promise.resolve</code>的核心优化，目的是避免对已存在的Promise实例重复包装，而<code>new Promise(...)</code>会强制新建实例，无法复用原有Promise。</p>
<ol start="2">
<li><strong>构造函数为Promise子类时</strong></li>
</ol>
<blockquote>
<ul>
<li><strong><code>NewPromiseCapability</code></strong> 规范文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Ftc39.es%2Fecma262%2Fmultipage%2Fcontrol-abstraction-objects.html%23sec-newpromisecapability" target="_blank" title="https://tc39.es/ecma262/multipage/control-abstraction-objects.html#sec-newpromisecapability" ref="nofollow noopener noreferrer">tc39.es/ecma262/mul…</a></li>
</ul>
</blockquote>
<p>若<code>Promise.resolve</code>的this值是Promise子类（如<code>class MyPromise extends Promise {}</code>），<code>Promise.resolve(x)</code> 会通过<code>NewPromiseCapability</code>创建子类的Promise实例（若x非子类实例）；而<code>new Promise(...)</code>始终创建原生Promise实例，无法关联子类构造函数。<br/>
例如：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyPromise</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Promise</span> {}
<span class="hljs-comment">// MyPromise.resolve(x) 创建MyPromise实例</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">MyPromise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-number">1</span>) <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">MyPromise</span>); <span class="hljs-comment">// true</span>
<span class="hljs-comment">// new Promise(...) 始终创建原生Promise实例</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> <span class="hljs-title function_">resolve</span>(<span class="hljs-number">1</span>)) <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">MyPromise</span>); <span class="hljs-comment">// false</span>
</code></pre>
<h3 data-id="heading-2">三、结论：可近似理解，但需注意规范差异</h3>
<ul>
<li><strong>日常开发简化理解</strong>：在不涉及“Promise实例复用”和“Promise子类”的场景下，可将<code>Promise.resolve(x)</code>近似看作<code>return new Promise((resolve) =&gt; resolve(x))</code>，两者最终都会生成以x为结果的fulfilled Promise，行为无明显差异。</li>
<li><strong>严格规范角度</strong>：两者不能完全等同。<code>Promise.resolve(x)</code> 是ECMAScript规范定义的静态方法，包含“复用同构造函数Promise实例”“适配子类构造函数”等优化逻辑，而<code>new Promise(...)</code>是基础的Promise创建方式，仅负责新建实例并执行executor回调，无特殊优化。</li>
</ul>
<p><strong>简言之</strong>，<code>new Promise((resolve) =&gt; resolve(x))</code> 是<code>Promise.resolve(x)</code>的“基础实现逻辑”，但<code>Promise.resolve(x)</code>在规范层面补充了更智能的 <strong>实例复用</strong> 和 <strong>子类适配</strong> 逻辑，功能更完善。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>