<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[拒绝黑产与老赖：Java后端如何接入天远个人风险报告API（COMBTY11）]]></title>    <link>https://juejin.cn/post/7581789701532319786</link>    <guid>https://juejin.cn/post/7581789701532319786</guid>    <pubDate>2025-12-10T06:59:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581789701532319786" data-draft-id="7581751726506573867" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="拒绝黑产与老赖：Java后端如何接入天远个人风险报告API（COMBTY11）"/> <meta itemprop="keywords" content="API,大数据"/> <meta itemprop="datePublished" content="2025-12-10T06:59:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="天远API"/> <meta itemprop="url" content="https://juejin.cn/user/195070305779163"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            拒绝黑产与老赖：Java后端如何接入天远个人风险报告API（COMBTY11）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/195070305779163/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    天远API
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T06:59:00.000Z" title="Wed Dec 10 2025 06:59:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、 打造金融级的数据风控中台</h2>
<p>在信贷审批、保险核保、大额资产租赁以及企业高管背景审查等严谨的业务场景中，单一的数据源往往难以描绘出完整的用户风险画像。企业需要从信用历史、反欺诈评分、司法诉讼记录以及社会安防等多个维度进行交叉验证。<strong>天远个人风险报告API</strong>（接口代码 <code>COMBTY11</code>）正是为此类高净值、高风险场景设计的核心数据产品。</p>
<p>该产品不仅提供了基础的身份核验，更通过AI模型输出了“谛听多维报告”与深度的“司法涉诉”详情。本文将面向Java后端工程师，特别是使用Spring Boot构建微服务架构的开发者，详细阐述如何将此API封装为标准化的RPC服务，解析其复杂的组合包结构，助力企业构建稳健的自动化风控决策引擎。</p>
<h2 data-id="heading-1">二、 API接口调用示例（Java版）</h2>
<p>本接口涉及敏感数据的传输，采用了严格的加密与授权机制，非常适合在Java后端通过 <code>OkHttp</code> 或 <code>RestTemplate</code> 进行安全调用。</p>
<h3 data-id="heading-2">1. 接口配置概览</h3>
<ul>
<li/>
</ul>
<pre><code class="hljs language-ini" lang="ini">**接口地址**：`https://api.tianyuanapi.com/api/v1/COMBTY11?<span class="hljs-attr">t</span>=<span class="hljs-number">13</span>位时间戳` 
</code></pre>
<ul>
<li/>
</ul>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-strong">**请求方式**</span>：POST
</code></pre>
<ul>
<li/>
</ul>
<pre><code class="hljs language-javascript" lang="javascript">**核心安全**：业务参数需序列化为<span class="hljs-title class_">JSON</span>，加密后转<span class="hljs-title class_">Base64</span>，放入 <span class="hljs-string">`data`</span> 字段。请求中必须包含用户的授权书<span class="hljs-variable constant_">URL</span>。
</code></pre>
<h3 data-id="heading-3">2. Curl 命令行预验证</h3>
<p>Bash</p>
<pre><code class="hljs language-jsx" lang="jsx">curl -X <span class="hljs-variable constant_">POST</span> <span class="hljs-string">"https://api.tianyuanapi.com/api/v1/COMBTY11?t=1715068800000"</span> \
-H <span class="hljs-string">"Content-Type: application/json"</span> \
-d <span class="hljs-string">'{
    "data": "eyJpZF9jYXJkIjoiMTEwMTAxMTk5MDAxMDEwMTIzIiwibmFtZSI6IuW8oOSBgSIsIm1vYmlsZV9ubyI6IjEzODAwMTM4MDAwIiwiYXV0aG9yaXphdGlvbl91cmwiOiJodHRwczovL29zcy5leGFtcGxlLmNvbS9hdXRoLmpwZyIsImF1dGhfZGF0ZSI6IjIwMjMwMTAxLTIwMjMxMjMxIn0="
}'</span>
</code></pre>
<h3 data-id="heading-4">3. Java 完整服务封装示例</h3>
<p>以下代码展示了如何在Spring Boot风格的项目中，封装一个强类型的 <code>RiskControlService</code>。本示例使用 <code>OkHttp3</code> 处理网络请求，<code>Fastjson2</code> 处理JSON。</p>
<p>Java</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> okhttp3.*;
<span class="hljs-keyword">import</span> com.<span class="hljs-property">alibaba</span>.<span class="hljs-property">fastjson2</span>.<span class="hljs-property">JSON</span>;
<span class="hljs-keyword">import</span> com.<span class="hljs-property">alibaba</span>.<span class="hljs-property">fastjson2</span>.<span class="hljs-property">JSONObject</span>;
<span class="hljs-keyword">import</span> com.<span class="hljs-property">alibaba</span>.<span class="hljs-property">fastjson2</span>.<span class="hljs-property">JSONArray</span>;
<span class="hljs-keyword">import</span> java.<span class="hljs-property">io</span>.<span class="hljs-property">IOException</span>;
<span class="hljs-keyword">import</span> java.<span class="hljs-property">util</span>.<span class="hljs-property">Base64</span>;
<span class="hljs-keyword">import</span> java.<span class="hljs-property">util</span>.<span class="hljs-property">concurrent</span>.<span class="hljs-property">TimeUnit</span>;

<span class="hljs-comment">/**
 * 天远API - 个人风险报告服务实现
 */</span>
public <span class="hljs-keyword">class</span> <span class="hljs-title class_">RiskControlService</span> {

    <span class="hljs-comment">// API 基础配置</span>
    private <span class="hljs-keyword">static</span> final <span class="hljs-title class_">String</span> <span class="hljs-variable constant_">API_URL</span> = <span class="hljs-string">"https://api.tianyuanapi.com/api/v1/COMBTY11"</span>;
    private <span class="hljs-keyword">static</span> final <span class="hljs-title class_">OkHttpClient</span> client = <span class="hljs-keyword">new</span> <span class="hljs-title class_">OkHttpClient</span>.<span class="hljs-title class_">Builder</span>()
            .<span class="hljs-title function_">connectTimeout</span>(<span class="hljs-number">20</span>, <span class="hljs-title class_">TimeUnit</span>.<span class="hljs-property">SECONDS</span>) <span class="hljs-comment">// 报告生成可能耗时，建议适当延长时间</span>
            .<span class="hljs-title function_">readTimeout</span>(<span class="hljs-number">20</span>, <span class="hljs-title class_">TimeUnit</span>.<span class="hljs-property">SECONDS</span>)
            .<span class="hljs-title function_">build</span>();

    <span class="hljs-comment">/**
     * 模拟加密逻辑
     * 实际生产中请使用天远API提供的AES/RSA工具类
     */</span>
    private <span class="hljs-title class_">String</span> <span class="hljs-title function_">encryptPayload</span>(<span class="hljs-params">JSONObject params</span>) {
        <span class="hljs-title class_">String</span> jsonString = params.<span class="hljs-title function_">toJSONString</span>();
        <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> 在此处实现AES加密：byte[] encrypted = AesUtil.encrypt(jsonString, SECRET_KEY);</span>
        <span class="hljs-comment">// 此处仅演示Base64编码</span>
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Base64</span>.<span class="hljs-title function_">getEncoder</span>().<span class="hljs-title function_">encodeToString</span>(jsonString.<span class="hljs-title function_">getBytes</span>());
    }

    <span class="hljs-comment">/**
     * 获取个人风险报告
     *
     * <span class="hljs-doctag">@param</span> name 姓名
     * <span class="hljs-doctag">@param</span> idCard 身份证号
     * <span class="hljs-doctag">@param</span> mobile 手机号
     * <span class="hljs-doctag">@param</span> authUrl 授权书图片/PDF链接
     * <span class="hljs-doctag">@param</span> authDate 授权周期 "YYYYMMDD-YYYYMMDD"
     * <span class="hljs-doctag">@return</span> JSONObject 解析后的核心风险数据
     */</span>
    public <span class="hljs-title class_">JSON</span><span class="hljs-built_in">Object</span> <span class="hljs-title function_">queryPersonalRisk</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> name, <span class="hljs-built_in">String</span> idCard, <span class="hljs-built_in">String</span> mobile, <span class="hljs-built_in">String</span> authUrl, <span class="hljs-built_in">String</span> authDate</span>) {
        <span class="hljs-comment">// 1. 组装业务参数</span>
        <span class="hljs-title class_">JSON</span><span class="hljs-built_in">Object</span> bizParams = <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSON</span><span class="hljs-built_in">Object</span>();
        bizParams.<span class="hljs-title function_">put</span>(<span class="hljs-string">"name"</span>, name);
        bizParams.<span class="hljs-title function_">put</span>(<span class="hljs-string">"id_card"</span>, idCard);
        bizParams.<span class="hljs-title function_">put</span>(<span class="hljs-string">"mobile_no"</span>, mobile);
        bizParams.<span class="hljs-title function_">put</span>(<span class="hljs-string">"authorization_url"</span>, authUrl); <span class="hljs-comment">// 必填 </span>
        bizParams.<span class="hljs-title function_">put</span>(<span class="hljs-string">"auth_date"</span>, authDate);        <span class="hljs-comment">// 必填 // 2. 加密请求体</span>
        <span class="hljs-title class_">String</span> encryptedData = <span class="hljs-title function_">encryptPayload</span>(bizParams);
        <span class="hljs-title class_">JSON</span><span class="hljs-built_in">Object</span> requestBody = <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSON</span><span class="hljs-built_in">Object</span>();
        requestBody.<span class="hljs-title function_">put</span>(<span class="hljs-string">"data"</span>, encryptedData);

        <span class="hljs-comment">// 3. 构建Request</span>
        long timestamp = <span class="hljs-title class_">System</span>.<span class="hljs-title function_">currentTimeMillis</span>();
        <span class="hljs-title class_">String</span> finalUrl = <span class="hljs-variable constant_">API_URL</span> + <span class="hljs-string">"?t="</span> + timestamp;
        
        <span class="hljs-title class_">RequestBody</span> body = <span class="hljs-title class_">RequestBody</span>.<span class="hljs-title function_">create</span>(
                requestBody.<span class="hljs-title function_">toJSONString</span>(), 
                <span class="hljs-title class_">MediaType</span>.<span class="hljs-title function_">parse</span>(<span class="hljs-string">"application/json; charset=utf-8"</span>)
        );

        <span class="hljs-title class_">Request</span> request = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Request</span>.<span class="hljs-title class_">Builder</span>().<span class="hljs-title function_">url</span>(finalUrl).<span class="hljs-title function_">post</span>(body).<span class="hljs-title function_">build</span>();

        <span class="hljs-comment">// 4. 执行调用与解析</span>
        <span class="hljs-keyword">try</span> (<span class="hljs-title class_">Response</span> response = client.<span class="hljs-title function_">newCall</span>(request).<span class="hljs-title function_">execute</span>()) {
            <span class="hljs-keyword">if</span> (response.<span class="hljs-title function_">isSuccessful</span>() &amp;&amp; response.<span class="hljs-title function_">body</span>() != <span class="hljs-literal">null</span>) {
                <span class="hljs-title class_">String</span> respStr = response.<span class="hljs-title function_">body</span>().<span class="hljs-title function_">string</span>();
                <span class="hljs-title class_">JSON</span><span class="hljs-built_in">Object</span> result = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parseObject</span>(respStr);
                
                <span class="hljs-comment">// 校验组合包响应</span>
                <span class="hljs-keyword">if</span> (result.<span class="hljs-title function_">containsKey</span>(<span class="hljs-string">"responses"</span>)) {
                    <span class="hljs-keyword">return</span> <span class="hljs-title function_">parseRiskData</span>(result.<span class="hljs-title function_">getJSONArray</span>(<span class="hljs-string">"responses"</span>));
                }
            }
            <span class="hljs-comment">// 记录错误日志</span>
            <span class="hljs-title class_">System</span>.<span class="hljs-property">err</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"API Request Failed: "</span> + response.<span class="hljs-title function_">code</span>());
        } <span class="hljs-keyword">catch</span> (<span class="hljs-title class_">IOException</span> e) {
            e.<span class="hljs-title function_">printStackTrace</span>();
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }

    <span class="hljs-comment">/**
     * 解析组合包中的核心风险指标
     */</span>
    private <span class="hljs-title class_">JSON</span><span class="hljs-built_in">Object</span> <span class="hljs-title function_">parseRiskData</span>(<span class="hljs-params">JSONArray responses</span>) {
        <span class="hljs-title class_">JSON</span><span class="hljs-built_in">Object</span> riskSummary = <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSON</span><span class="hljs-built_in">Object</span>();
        
        <span class="hljs-keyword">for</span> (int i = <span class="hljs-number">0</span>; i &lt; responses.<span class="hljs-title function_">size</span>(); i++) {
            <span class="hljs-title class_">JSON</span><span class="hljs-built_in">Object</span> item = responses.<span class="hljs-title function_">getJSONObject</span>(i);
            <span class="hljs-title class_">String</span> apiCode = item.<span class="hljs-title function_">getString</span>(<span class="hljs-string">"api_code"</span>);
            boolean success = item.<span class="hljs-title function_">getBooleanValue</span>(<span class="hljs-string">"success"</span>);
            <span class="hljs-title class_">JSON</span><span class="hljs-built_in">Object</span> data = item.<span class="hljs-title function_">getJSONObject</span>(<span class="hljs-string">"data"</span>);

            <span class="hljs-keyword">if</span> (!success || data == <span class="hljs-literal">null</span>) <span class="hljs-keyword">continue</span>;

            <span class="hljs-comment">// 根据子产品代码提取关键信息</span>
            <span class="hljs-keyword">switch</span> (apiCode) {
                <span class="hljs-keyword">case</span> <span class="hljs-string">"DWBG8B4D"</span>: <span class="hljs-comment">// 谛听多维报告 </span>
                    riskSummary.<span class="hljs-title function_">put</span>(<span class="hljs-string">"fraudScore"</span>, data.<span class="hljs-title function_">getIntValue</span>(<span class="hljs-string">"fraudScore"</span>)); <span class="hljs-comment">// 反欺诈分 </span>
                    riskSummary.<span class="hljs-title function_">put</span>(<span class="hljs-string">"creditScore"</span>, data.<span class="hljs-title function_">getIntValue</span>(<span class="hljs-string">"creditScore"</span>)); <span class="hljs-comment">// 信用分 </span>
                    riskSummary.<span class="hljs-title function_">put</span>(<span class="hljs-string">"riskWarning"</span>, data.<span class="hljs-title function_">getJSONObject</span>(<span class="hljs-string">"riskWarning"</span>)); <span class="hljs-comment">// 风险标签 break;</span>
                <span class="hljs-keyword">case</span> <span class="hljs-string">"FLXG0V4B"</span>: <span class="hljs-comment">// 个人司法涉诉 // 提取失信被执行人列表</span>
                    <span class="hljs-title class_">JSON</span><span class="hljs-built_in">Object</span> sxbzxr = data.<span class="hljs-title function_">getJSONObject</span>(<span class="hljs-string">"sxbzxr"</span>);
                    <span class="hljs-keyword">if</span> (sxbzxr != <span class="hljs-literal">null</span> &amp;&amp; sxbzxr.<span class="hljs-title function_">containsKey</span>(<span class="hljs-string">"data"</span>)) {
                         riskSummary.<span class="hljs-title function_">put</span>(<span class="hljs-string">"dishonestList"</span>, sxbzxr.<span class="hljs-title function_">getJSONObject</span>(<span class="hljs-string">"data"</span>).<span class="hljs-title function_">getJSONArray</span>(<span class="hljs-string">"sxbzxr"</span>));
                    }
                    <span class="hljs-keyword">break</span>;
            }
        }
        <span class="hljs-keyword">return</span> riskSummary;
    }
    
    <span class="hljs-comment">// Test Main</span>
    public <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"><span class="hljs-built_in">String</span>[] args</span>) {
        <span class="hljs-title class_">RiskControlService</span> service = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RiskControlService</span>();
        <span class="hljs-title class_">JSON</span><span class="hljs-built_in">Object</span> report = service.<span class="hljs-title function_">queryPersonalRisk</span>(
            <span class="hljs-string">"张三"</span>, <span class="hljs-string">"110101199001011234"</span>, <span class="hljs-string">"13900000000"</span>, 
            <span class="hljs-string">"http://oss.url/auth.pdf"</span>, <span class="hljs-string">"20230101-20240101"</span>
        );
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"风险报告摘要: "</span> + report);
    }
}
</code></pre>
<h2 data-id="heading-5">三、 核心数据结构解析</h2>
<p><strong>天远API</strong> 的个人风险报告采用“组合模式”设计，这要求Java开发者建立合理的对象模型来接收数据。</p>
<p><strong>数据层级架构：</strong></p>
<ol>
<li><strong>Response Wrapper</strong>: 最外层包含 <code>responses</code> 列表。</li>
<li><strong>Sub-Product Item</strong>: 每个子项包含 <code>api_code</code> 和 <code>data</code>。
<ul>
<li><strong>DWBG8B4D (谛听多维报告)</strong>：核心风控数据源，包含评分、标签和借贷统计。</li>
<li><strong>FLXG0V4B (个人司法涉诉)</strong>：详细法律文书数据源，包含民刑行案件及失信记录。</li>
</ul>
</li>
</ol>
<h2 data-id="heading-6">四、 字段详解</h2>
<p>为了方便Java开发者定义DTO（Data Transfer Object），以下列出需要重点关注的核心字段及其业务含义。</p>
<h3 data-id="heading-7">1. 评分与综合建议 (DWBG8B4D)</h3>
<p>此模块适合映射为 <code>RiskScoreDTO</code>。</p>



































<table><thead><tr><th><strong>字段名</strong></th><th><strong>Java类型</strong></th><th><strong>含义</strong></th><th><strong>业务逻辑说明</strong></th></tr></thead><tbody><tr><td><code>fraudScore</code></td><td><code>Integer</code></td><td>反欺诈评分</td><td>[0,100]，<strong>&gt;80</strong> 为高风险，建议直接拦截。</td></tr><tr><td><code>creditScore</code></td><td><code>Integer</code></td><td>信用评分</td><td>[300,1000]，<strong>&lt;500</strong> 为信用一般，需人工复审。</td></tr><tr><td><code>checkSuggest</code></td><td><code>String</code></td><td>审核建议</td><td>枚举值如 "建议拒绝"、"建议复审"。</td></tr><tr><td><code>fraudRule</code></td><td><code>String</code></td><td>反欺诈规则等级</td><td>枚举值：低风险、中风险、高风险。</td></tr></tbody></table>
<h3 data-id="heading-8">2. 风险预警标签 (DWBG8B4D -&gt; riskWarning)</h3>
<p>此模块包含大量布尔型（0/1）标记，是风控引擎的决策依据。</p>



































<table><thead><tr><th><strong>字段名</strong></th><th><strong>Java类型</strong></th><th><strong>含义</strong></th><th><strong>风险等级</strong></th></tr></thead><tbody><tr><td><code>isKeyPerson</code></td><td><code>Integer</code></td><td>是否重点人员</td><td>高风险 (涉恐/涉稳/涉黑)</td></tr><tr><td><code>hasCriminalRecord</code></td><td><code>Integer</code></td><td>是否有前科</td><td>高风险</td></tr><tr><td><code>hitExecutionCase</code></td><td><code>Integer</code></td><td>命中执行案件</td><td>高风险 (存在未履行的法院判决)</td></tr><tr><td><code>hitCurrentOverdue</code></td><td><code>Integer</code></td><td>命中当前逾期</td><td>中风险 (当前有未结清贷款)</td></tr></tbody></table>
<h3 data-id="heading-9">3. 司法与失信记录 (FLXG0V4B)</h3>
<p>数据结构较深，建议使用 <code>JSONObject</code> 或特定 <code>JudicialDTO</code> 处理。</p>





























<table><thead><tr><th><strong>字段名</strong></th><th><strong>Java类型</strong></th><th><strong>含义</strong></th><th><strong>说明</strong></th></tr></thead><tbody><tr><td><code>sxbzxr</code></td><td><code>List</code></td><td>失信被执行人</td><td>即“老赖”名单，包含 <code>lxqk</code>(履行情况)。</td></tr><tr><td><code>xgbzxr</code></td><td><code>List</code></td><td>限高被执行人</td><td>限制高消费记录。</td></tr><tr><td><code>criminal</code></td><td><code>Object</code></td><td>刑事案件详情</td><td>包含 <code>dzzm</code>(定罪罪名) 如“开设赌场罪”。</td></tr></tbody></table>
<h2 data-id="heading-10">五、 应用价值分析</h2>
<p>将<strong>天远API</strong>集成到Java企业级系统中，可以显著提升以下场景的业务效能：</p>
<ol>
<li>
<p>智能信贷审批引擎</p>
<p>在Spring Batch批处理或实时审批流中，通过调用API获取 fraudScore 和 riskWarning。系统可配置规则引擎（如Drools）：若 fraudScore &gt; 80 或 isKeyPerson == 1，则自动触发 REJECT 动作，无需人工干预，将欺诈风险拦截在放款之前。</p>
</li>
<li>
<p>供应链金融准入</p>
<p>对于申请融资的小微企业主或个体户，利用 overdueRiskProduct（逾期风险）和 leasingRiskAssessment（租赁风险）数据 ，评估其多头借贷压力。如果发现申请人近期在多家租赁机构频繁申请（veryFrequentRentalApplications == 1），系统应提示可能存在骗租或资金链断裂风险。</p>
</li>
<li>
<p>高管与关键岗位背调</p>
<p>在HR系统中集成该接口，针对财务总监、司机等关键岗位进行背景扫描。重点关注 FLXG0V4B 返回的司法数据，排查是否存在“职务侵占”、“危险驾驶”等刑事前科，保障企业合规用人。</p>
</li>
</ol>
<h2 data-id="heading-11">六、 总结</h2>
<p><strong>天远个人风险报告API</strong> 为Java开发者提供了一套标准化的风控数据接入方案。通过一次接口调用，即可获取涵盖征信、司法、社会安全等维度的全量数据。</p>
<p><strong>开发集成建议：</strong></p>
<ul>
<li><strong>数据脱敏</strong>：由于报告包含身份证、案件详情等极度敏感信息，建议在落库（DB）时对关键字段进行加密存储，日志中严禁打印明文。</li>
<li><strong>授权管理</strong>：API强制校验 <code>authorization_url</code> 和 <code>auth_dat</code>，开发者需在前端实现授权书签署与上传功能，确保业务合规。</li>
<li><strong>降级策略</strong>：在解析 <code>responses</code> 数组时，务必判断 <code>success</code> 状态。如果某子产品（如司法信息）偶尔超时，应保证主流程（如基础评分）继续运行，避免因局部异常导致整个业务中断。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端全栈必读：Node.js如何高效接入天远个人风险报告API]]></title>    <link>https://juejin.cn/post/7581858890607050788</link>    <guid>https://juejin.cn/post/7581858890607050788</guid>    <pubDate>2025-12-10T07:21:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581858890607050788" data-draft-id="7581876069608095787" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端全栈必读：Node.js如何高效接入天远个人风险报告API"/> <meta itemprop="keywords" content="API,大数据"/> <meta itemprop="datePublished" content="2025-12-10T07:21:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="天远云服"/> <meta itemprop="url" content="https://juejin.cn/user/590850926340011"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端全栈必读：Node.js如何高效接入天远个人风险报告API
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/590850926340011/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    天远云服
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T07:21:21.000Z" title="Wed Dec 10 2025 07:21:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、 构建实时、轻量级的个人风控网关</h2>
<p>在互联网金融（FinTech）、共享经济（如网约车、房屋短租）以及电商分期等高频交易场景中，用户体验与风险控制往往是一对矛盾体。前端业务需要毫秒级的响应速度，而后台风控却需要查询海量数据。<strong>天远个人风险报告API</strong>（接口代码 <code>COMBTY11</code>）通过聚合谛听多维报告与深度司法数据，为解决这一矛盾提供了完美的“数据中间件”。</p>
<p>该API不仅提供基础的实名与运营商核验，更输出了反欺诈评分、借贷意向分析及详细的司法涉诉记录。对于使用 Node.js 构建 BFF 层或微服务的团队而言，<strong>天远API</strong> 标准化的 JSON 数据结构与高效的响应能力，能够帮助开发者快速搭建起一道轻量级、高并发的人员风险防火墙，在不牺牲用户体验的前提下实现精准拦截。</p>
<h2 data-id="heading-1">二、 API接口调用示例（Node.js版）</h2>
<p>本接口支持 HTTPS POST 请求，数据交互采用 JSON 格式。Node.js 的非阻塞 I/O 特性非常适合处理此类外部 API 的聚合调用。</p>
<h3 data-id="heading-2">1. 接口技术参数</h3>
<ul>
<li><strong>接口地址</strong>：<code>https://api.tianyuanapi.com/api/v1/COMBTY11?t=13位时间戳</code></li>
<li><strong>请求方式</strong>：POST</li>
<li><strong>鉴权与加密</strong>：业务参数（含授权书URL）需序列化后加密，并转为 Base64 字符串放入 <code>data</code> 字段。</li>
</ul>
<h3 data-id="heading-3">2. Curl 命令行测试</h3>
<p>Bash</p>
<pre><code class="hljs language-jsx" lang="jsx">curl -X <span class="hljs-variable constant_">POST</span> <span class="hljs-string">"https://api.tianyuanapi.com/api/v1/COMBTY11?t=1715068800000"</span> \
-H <span class="hljs-string">"Content-Type: application/json"</span> \
-d <span class="hljs-string">'{
    "data": "eyJpZF9jYXJkIjoiNDUyMTIyMjAwMDA4Mjc0MjNYIiwibmFtZSI6IuW8oOS7SiIsIm1vYmlsZV9ubyI6IjEzODAwMTM4MDAwIiwiYXV0aG9yaXphdGlvbl91cmwiOiJodHRwczovL29zcy5leGFtcGxlLmNvbS9hdXRoLnBuZyIsImF1dGhfZGF0ZSI6IjIwMjMwMTAxLTIwMjMxMjMxIn0="
}'</span>
</code></pre>
<h3 data-id="heading-4">3. Node.js (Axios + Async/Await) 调用示例</h3>
<p>以下代码展示了如何在 Node.js 环境中（适用于 Express/Koa/NestJS）封装一个通用的风控查询服务。</p>
<p>JavaScript</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">const</span> axios = <span class="hljs-built_in">require</span>(<span class="hljs-string">'axios'</span>);
<span class="hljs-comment">// const crypto = require('crypto'); // 实际加密需要用到</span>

<span class="hljs-comment">// 1. API 配置</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">API_CONFIG</span> = {
    <span class="hljs-attr">url</span>: <span class="hljs-string">'https://api.tianyuanapi.com/api/v1/COMBTY11'</span>,
    <span class="hljs-attr">timeout</span>: <span class="hljs-number">10000</span> <span class="hljs-comment">// 建议设置较长超时，因为涉及多维数据查询</span>
};

<span class="hljs-comment">/**
 * 模拟加密处理函数
 * 实际接入时，请使用天远API提供的加密算法（通常为AES）替换此函数
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">encryptPayload</span>(<span class="hljs-params">payload</span>) {
    <span class="hljs-keyword">const</span> jsonStr = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(payload);
    <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> 实现真实的加密逻辑</span>
    <span class="hljs-comment">// const encrypted = aesEncrypt(jsonStr, secretKey);</span>
    <span class="hljs-comment">// 这里仅做 Base64 编码演示</span>
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Buffer</span>.<span class="hljs-title function_">from</span>(jsonStr).<span class="hljs-title function_">toString</span>(<span class="hljs-string">'base64'</span>);
}

<span class="hljs-comment">/**
 * 获取个人风险报告
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Object</span>} userInfo 用户信息对象
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">Promise&lt;Object&gt;</span>} 解析后的风险数据
 */</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchRiskReport</span>(<span class="hljs-params">userInfo</span>) {
    <span class="hljs-keyword">const</span> { name, idCard, mobile, authUrl, authDate } = userInfo;
    
    <span class="hljs-comment">// 2. 构建业务参数</span>
    <span class="hljs-keyword">const</span> payload = {
        <span class="hljs-attr">name</span>: name,
        <span class="hljs-attr">id_card</span>: idCard,
        <span class="hljs-attr">mobile_no</span>: mobile,
        <span class="hljs-attr">authorization_url</span>: authUrl, <span class="hljs-comment">// 必须提供授权书 URL auth_date: authDate         // 格式 YYYYMMDD-YYYYMMDD </span>
    };

    <span class="hljs-keyword">const</span> encryptedData = <span class="hljs-title function_">encryptPayload</span>(payload);
    <span class="hljs-keyword">const</span> timestamp = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();

    <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// 3. 发起异步请求</span>
        <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> axios.<span class="hljs-title function_">post</span>(<span class="hljs-string">`<span class="hljs-subst">${API_CONFIG.url}</span>?t=<span class="hljs-subst">${timestamp}</span>`</span>, {
            <span class="hljs-attr">data</span>: encryptedData
        }, {
            <span class="hljs-attr">headers</span>: { <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span> }
        });

        <span class="hljs-keyword">const</span> result = response.<span class="hljs-property">data</span>;

        <span class="hljs-comment">// 4. 处理组合包响应</span>
        <span class="hljs-keyword">if</span> (result &amp;&amp; result.<span class="hljs-property">responses</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-title function_">transformData</span>(result.<span class="hljs-property">responses</span>);
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'API Error:'</span>, result);
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'Risk API response format error'</span>);
        }

    } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Request Failed:'</span>, error.<span class="hljs-property">message</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }
}

<span class="hljs-comment">/**
 * 数据清洗与转换工具函数
 * 将复杂的组合包结构扁平化，便于前端使用
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">transformData</span>(<span class="hljs-params">responses</span>) {
    <span class="hljs-keyword">const</span> report = {
        <span class="hljs-attr">summary</span>: { <span class="hljs-attr">score</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">suggestion</span>: <span class="hljs-string">''</span> },
        <span class="hljs-attr">risks</span>: [],
        <span class="hljs-attr">legal</span>: []
    };

    responses.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> {
        <span class="hljs-keyword">if</span> (!item.<span class="hljs-property">success</span> || !item.<span class="hljs-property">data</span>) <span class="hljs-keyword">return</span>;

        <span class="hljs-comment">// 谛听多维报告 (DWBG8B4D)</span>
        <span class="hljs-keyword">if</span> (item.<span class="hljs-property">api_code</span> === <span class="hljs-string">'DWBG8B4D'</span>) {
            <span class="hljs-keyword">const</span> data = item.<span class="hljs-property">data</span>;
            report.<span class="hljs-property">summary</span>.<span class="hljs-property">fraudScore</span> = data.<span class="hljs-property">fraudScore</span>; <span class="hljs-comment">// 反欺诈分 </span>
            report.<span class="hljs-property">summary</span>.<span class="hljs-property">creditScore</span> = data.<span class="hljs-property">creditScore</span>; <span class="hljs-comment">// 信用分 </span>
            report.<span class="hljs-property">summary</span>.<span class="hljs-property">suggestion</span> = data.<span class="hljs-property">checkSuggest</span>; <span class="hljs-comment">// 审核建议 </span>
            
            <span class="hljs-comment">// 提取高风险项</span>
            <span class="hljs-keyword">if</span> (data.<span class="hljs-property">riskWarning</span>) {
                <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>(data.<span class="hljs-property">riskWarning</span>).<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">[key, value]</span>) =&gt;</span> {
                    <span class="hljs-keyword">if</span> (value === <span class="hljs-number">1</span> &amp;&amp; key !== <span class="hljs-string">'totalRiskCounts'</span>) {
                        report.<span class="hljs-property">risks</span>.<span class="hljs-title function_">push</span>(key); <span class="hljs-comment">// 将命中的风险标签加入数组</span>
                    }
                });
            }
        }
        
        <span class="hljs-comment">// 个人司法涉诉 (FLXG0V4B)</span>
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (item.<span class="hljs-property">api_code</span> === <span class="hljs-string">'FLXG0V4B'</span>) {
            <span class="hljs-keyword">const</span> entout = item.<span class="hljs-property">data</span>.<span class="hljs-property">entout</span>?.<span class="hljs-property">data</span> || {};
            <span class="hljs-keyword">const</span> sxbzxr = item.<span class="hljs-property">data</span>.<span class="hljs-property">sxbzxr</span>?.<span class="hljs-property">data</span>?.<span class="hljs-property">sxbzxr</span> || []; <span class="hljs-comment">// 失信被执行人 </span>
            
            <span class="hljs-keyword">if</span> (sxbzxr.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
                report.<span class="hljs-property">legal</span>.<span class="hljs-title function_">push</span>(...sxbzxr.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">c</span> =&gt;</span> ({
                    <span class="hljs-attr">type</span>: <span class="hljs-string">'失信被执行'</span>,
                    <span class="hljs-attr">court</span>: c.<span class="hljs-property">zxfy</span>, <span class="hljs-comment">// 执行法院 caseNo: c.ah,  // 案号 duty: c.yw     // 义务 </span>
                })));
            }
        }
    });

    <span class="hljs-keyword">return</span> report;
}

<span class="hljs-comment">// 5. 执行调用测试</span>
(<span class="hljs-keyword">async</span> () =&gt; {
    <span class="hljs-keyword">const</span> user = {
        <span class="hljs-attr">name</span>: <span class="hljs-string">"张三"</span>,
        <span class="hljs-attr">idCard</span>: <span class="hljs-string">"110101199001011234"</span>,
        <span class="hljs-attr">mobile</span>: <span class="hljs-string">"13900000000"</span>,
        <span class="hljs-attr">authUrl</span>: <span class="hljs-string">"http://oss.example.com/auth/user_123.jpg"</span>,
        <span class="hljs-attr">authDate</span>: <span class="hljs-string">"20230101-20250101"</span>
    };

    <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchRiskReport</span>(user);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'清洗后的风控报告:'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(result, <span class="hljs-literal">null</span>, <span class="hljs-number">2</span>));
})();
</code></pre>
<h2 data-id="heading-5">三、 核心数据结构解析</h2>
<p><strong>天远API</strong> 的响应设计遵循“组合模式”，这对于 JavaScript 的解构赋值非常友好。</p>
<p><strong>数据层级概览：</strong></p>
<ol>
<li><strong>Response Body</strong>: 包含 <code>responses</code> 数组。</li>
<li><strong>Item Object</strong>: 数组元素，包含 <code>api_code</code> 和 <code>data</code>。
<ul>
<li><strong>DWBG8B4D</strong>: 核心风控数据。重点关注 <code>fraudScore</code>（反欺诈分）、<code>creditScore</code>（信用分）和 <code>riskWarning</code>（风险清单）。</li>
<li><strong>FLXG0V4B</strong>: 司法详情。重点关注 <code>sxbzxr</code>（失信名单）和 <code>entout.data.criminal</code>（刑事案件）。</li>
</ul>
</li>
</ol>
<h2 data-id="heading-6">四、 字段详解</h2>
<p>为了方便 Node.js 开发者在 TypeORM 或 Mongoose 中定义 Schema，以下列出核心字段的详细说明。</p>
<h3 data-id="heading-7">1. 评分与建议 (DWBG8B4D -&gt; data)</h3>





























<table><thead><tr><th><strong>字段名 (JSON)</strong></th><th><strong>JS类型</strong></th><th><strong>含义</strong></th><th><strong>业务逻辑参考</strong></th></tr></thead><tbody><tr><td><code>fraudScore</code></td><td>Number</td><td>反欺诈评分</td><td>范围 [0,100]。<strong>&gt;80</strong> 为高风险，建议前端直接提示拒绝。</td></tr><tr><td><code>creditScore</code></td><td>Number</td><td>信用评分</td><td>范围 [300,1000]。<strong>&lt;500</strong> 为信用一般，建议人工复审。</td></tr><tr><td><code>checkSuggest</code></td><td>String</td><td>审核建议</td><td>值示例："建议拒绝"、"建议复审" 。</td></tr></tbody></table>
<h3 data-id="heading-8">2. 借贷与逾期风险 (DWBG8B4D -&gt; overdueRiskProduct)</h3>
<p>此模块数据适合做贷前评估。</p>





























<table><thead><tr><th><strong>字段名 (JSON)</strong></th><th><strong>JS类型</strong></th><th><strong>含义</strong></th><th><strong>说明</strong></th></tr></thead><tbody><tr><td><code>currentOverdueAmount</code></td><td>String</td><td>当前逾期金额</td><td>如 "(0,1000)"，表示逾期金额区间。</td></tr><tr><td><code>overdueLast30Days</code></td><td>String</td><td>近30天逾期状态</td><td>"逾期" 或 "未逾期"。</td></tr><tr><td><code>totalLoanInstitutions</code></td><td>String</td><td>贷款总机构数</td><td>多头借贷指标，数值过大风险高。</td></tr></tbody></table>
<h3 data-id="heading-9">3. 司法涉诉 (FLXG0V4B)</h3>
<p>重点关注“老赖”和刑事记录。</p>





























<table><thead><tr><th><strong>字段名 (JSON)</strong></th><th><strong>JS类型</strong></th><th><strong>含义</strong></th><th><strong>说明</strong></th></tr></thead><tbody><tr><td><code>sxbzxr</code></td><td>Array</td><td>失信被执行人列表</td><td>包含 <code>xwqx</code> (失信行为具体情形)。</td></tr><tr><td><code>xgbzxr</code></td><td>Array</td><td>限高被执行人列表</td><td>包含 <code>fbrq</code> (发布日期) 。</td></tr><tr><td><code>criminal</code></td><td>Object</td><td>刑事案件</td><td>位于 <code>entout.data</code> 下，包含 <code>dzzm</code> (定罪罪名)。</td></tr></tbody></table>
<h2 data-id="heading-10">五、 应用价值分析</h2>
<p>在 Node.js 生态中，接入 <strong>天远API</strong> 可以为多种互联网业务场景提供强大的风控支持：</p>
<ol>
<li>
<p>电商分期/先用后付 (BNPL)</p>
<p>在用户点击“开通分期”的瞬间，BFF 层异步调用 天远API。通过 creditScore 和 overdueRiskProduct 数据，实时计算用户的信用额度。如果 currentOverdueAmount 不为空，则自动拒绝开通，有效控制坏账率。</p>
</li>
<li>
<p>C2C 租赁平台 (房屋/电子产品)</p>
<p>在租客提交订单时，调用接口检查 leasingRiskAssessment（租赁风险评估）15。如果发现租客在近期频繁申请租赁机构（veryFrequentRentalApplications == 1）16 或存在司法执行记录，系统可自动调整押金比例或要求第三方担保。</p>
</li>
<li>
<p>社交/婚恋平台的高端认证</p>
<p>针对实名认证的高端用户，利用 FLXG0V4B 中的婚姻状况（如有）和司法涉诉记录进行背景核实。若发现用户存在“重婚罪”或严重的“经济诈骗”前科（hasCriminalRecord == 1）17，平台可及时封禁账号，维护社区生态安全。</p>
</li>
</ol>
<h2 data-id="heading-11">六、 总结</h2>
<p><strong>天远个人风险报告API</strong> 为 Node.js 开发者提供了一套高效、全面的数据解决方案。通过一次请求，即可获取横跨征信、司法、社会安全三大领域的全景画像，极大地简化了风控系统的开发复杂度。</p>
<p><strong>集成小贴士：</strong></p>
<ul>
<li><strong>文件上传</strong>：由于接口需要 <code>authorization_url</code>，开发者需先将用户签署的授权书上传至对象存储（如 COS/OSS），再将公网链接传给 API。</li>
<li><strong>数据缓存</strong>：风险报告数据量大且更新频率相对较低，建议在 Redis 中缓存查询结果（如缓存 24 小时），以节省 API 调用成本并提升响应速度。</li>
<li><strong>隐私保护</strong>：在前端展示报告时，务必对敏感信息（如具体案号、涉案金额）进行脱敏处理，仅展示风险等级或建议。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Oracle数据字典深度解析：架构、组件与实践应用]]></title>    <link>https://juejin.cn/post/7581844141669007400</link>    <guid>https://juejin.cn/post/7581844141669007400</guid>    <pubDate>2025-12-10T06:53:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581844141669007400" data-draft-id="7581786379804753955" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Oracle数据字典深度解析：架构、组件与实践应用"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-10T06:53:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="神奇小汤圆"/> <meta itemprop="url" content="https://juejin.cn/user/1151943919285431"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Oracle数据字典深度解析：架构、组件与实践应用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1151943919285431/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    神奇小汤圆
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T06:53:06.000Z" title="Wed Dec 10 2025 06:53:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    9
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、数据字典概述</h2>
<p>Oracle数据字典（Data Dictionary）是数据库的核心元数据仓库，被誉为数据库的“数据库”。它存储了数据库运行所需的关键信息，包括所有Schema对象定义（表、视图、索引、触发器等）、空间分配与使用情况、字段默认值、完整性约束、用户权限与角色、审计信息等。数据字典的核心价值在于实现数据库的“自解释”——用户与DBA通过它可获取数据库对象的完整信息，是数据库管理、维护与优化的基础。</p>
<p>数据字典具有<strong>只读特性</strong>：Oracle严格禁止手工修改数据字典表中的信息，此类操作可能导致数据库紊乱且无法恢复，Oracle公司对此不承担责任。从架构上，数据字典由五部分构成：内部RDBMS（X<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>）表、数据字典表、静态数据字典视图、动态性能（</mtext><mi>V</mi></mrow><annotation encoding="application/x-tex">）表、数据字典表、静态数据字典视图、动态性能（V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord cjk_fallback">）表、数据字典表、静态数据字典视图、动态性能（</span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span></span>）视图，以及辅助管理的同义词（Synonym）。</p>
<h2 data-id="heading-1">二、内部RDBMS（X$）表：数据库的底层核心</h2>
<h3 data-id="heading-2">2.1 核心特性与访问限制</h3>
<p>X$表是Oracle数据库的最底层组件，本质是一系列C结构体，在数据库启动时由Oracle应用程序动态创建，用于跟踪内部运行状态、维持数据库正常工作。其核心特性包括：</p>
<ul>
<li><strong>加密命名与未公开文档</strong>：X<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>表名称加密（如</mtext><mi>X</mi></mrow><annotation encoding="application/x-tex">表名称加密（如X</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord cjk_fallback">表名称加密（如</span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span></span></span></span></span>BH、X$KSMSP），Oracle未提供官方文档，属于技术机密；</li>
<li><strong>访问权限严格</strong>：仅SYSDBA角色可直接访问，普通用户即使获得显式授权也会报错（ORA-02030：仅允许从固定表/视图查询）；</li>
<li><strong>底层依赖</strong>：所有动态性能视图（V<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>、</mtext><mi>G</mi><mi>V</mi></mrow><annotation encoding="application/x-tex">、GV</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord cjk_fallback">、</span><span class="mord mathnormal">G</span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span></span>）均基于X$表构建，是数据库运行的基础。</li>
</ul>
<h3 data-id="heading-3">2.2 实践探索：X$表的应用价值</h3>
<p>通过Oracle的AUTOTRACE功能可间接探索X<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>表的底层关联。例如，查询</mtext><mi mathvariant="normal">‘</mi><mi>v</mi></mrow><annotation encoding="application/x-tex">表的底层关联。例如，查询`v</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord cjk_fallback">表的底层关联。例如，查询</span><span class="mord">‘</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span></span></span></span></span>parameter<code>时，AUTOTRACE的执行计划会显示其依赖</code>X<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi><mi>S</mi><mi>P</mi><mi>P</mi><mi>I</mi><mi mathvariant="normal">‘</mi><mtext>和</mtext><mi mathvariant="normal">‘</mi><mi>X</mi></mrow><annotation encoding="application/x-tex">KSPPI`和`X</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mord mathnormal" style="margin-right:0.13889em;">SPP</span><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="mord">‘</span><span class="mord cjk_fallback">和</span><span class="mord">‘</span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span></span></span></span></span>KSPPCV`两个X$表：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">set</span> autotrace trace explain
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> v$<span class="hljs-keyword">parameter</span>;
Execution Plan
Plan hash <span class="hljs-keyword">value</span>: <span class="hljs-number">1128103955</span>
<span class="hljs-operator">|</span> Id <span class="hljs-operator">|</span> Operation          <span class="hljs-operator">|</span> Name      <span class="hljs-operator">|</span> <span class="hljs-keyword">Rows</span> <span class="hljs-operator">|</span> Bytes <span class="hljs-operator">|</span> Cost (<span class="hljs-operator">%</span>CPU)<span class="hljs-operator">|</span> <span class="hljs-type">Time</span>     <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>  <span class="hljs-number">0</span> <span class="hljs-operator">|</span> <span class="hljs-keyword">SELECT</span> STATEMENT   <span class="hljs-operator">|</span>           <span class="hljs-operator">|</span>   <span class="hljs-number">1</span> <span class="hljs-operator">|</span>  <span class="hljs-number">926</span> <span class="hljs-operator">|</span>     <span class="hljs-number">1</span> (<span class="hljs-number">100</span>)<span class="hljs-operator">|</span> <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">01</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span><span class="hljs-operator">*</span> <span class="hljs-number">1</span> <span class="hljs-operator">|</span> HASH <span class="hljs-keyword">JOIN</span>          <span class="hljs-operator">|</span>           <span class="hljs-operator">|</span>   <span class="hljs-number">1</span> <span class="hljs-operator">|</span>  <span class="hljs-number">926</span> <span class="hljs-operator">|</span>     <span class="hljs-number">1</span> (<span class="hljs-number">100</span>)<span class="hljs-operator">|</span> <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">01</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span><span class="hljs-operator">*</span> <span class="hljs-number">2</span> <span class="hljs-operator">|</span> FIXED <span class="hljs-keyword">TABLE</span> <span class="hljs-keyword">FULL</span>   <span class="hljs-operator">|</span> X$KSPPI   <span class="hljs-operator">|</span>   <span class="hljs-number">1</span> <span class="hljs-operator">|</span>  <span class="hljs-number">249</span> <span class="hljs-operator">|</span>     <span class="hljs-number">0</span> (<span class="hljs-number">0</span>)<span class="hljs-operator">|</span> <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">01</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>  <span class="hljs-number">3</span> <span class="hljs-operator">|</span> FIXED <span class="hljs-keyword">TABLE</span> <span class="hljs-keyword">FULL</span>   <span class="hljs-operator">|</span> X$KSPPCV  <span class="hljs-operator">|</span> <span class="hljs-number">100</span> <span class="hljs-operator">|</span> <span class="hljs-number">67700</span> <span class="hljs-operator">|</span>     <span class="hljs-number">0</span> (<span class="hljs-number">0</span>)<span class="hljs-operator">|</span> <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">01</span> <span class="hljs-operator">|</span>
</code></pre>
<p>X<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>表还可揭示数据库核心机制的底层参数。例如，</mtext><mi mathvariant="normal">‘</mi><mi>X</mi></mrow><annotation encoding="application/x-tex">表还可揭示数据库核心机制的底层参数。例如，`X</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord cjk_fallback">表还可揭示数据库核心机制的底层参数。例如，</span><span class="mord">‘</span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span></span></span></span></span>KVIT`表记录实例级内部参数，其中：</p>
<ul>
<li><code>kcbldq=25</code>：脏缓冲（Dirty Buffers）阈值为25%，触发DBWR进程写动作；</li>
<li><code>kcbfsp=40</code>：前台进程扫描LRU列表的最大比例为40%，未找到足够空闲块时触发DBWR。</li>
</ul>
<p>这些参数与隐含参数直接关联（如<code>_db_writer_scan_depth_pct=25</code>、<code>_db_block_max_scan_pct=40</code>），通过X$表可将抽象的数据库机制具象化。</p>
<h2 data-id="heading-4">三、数据字典表：元数据的持久化存储</h2>
<h3 data-id="heading-5">3.1 定义与创建</h3>
<p>数据字典表是存储数据库结构信息的持久化表，名称通常以<code>$</code>结尾（如OBJ<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>、</mtext><mi>T</mi><mi>A</mi><mi>B</mi></mrow><annotation encoding="application/x-tex">、TAB</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord cjk_fallback">、</span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord mathnormal">A</span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span></span>、COL<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>、</mtext><mi>C</mi><mi>O</mi><mi>N</mi></mrow><annotation encoding="application/x-tex">、CON</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord cjk_fallback">、</span><span class="mord mathnormal" style="margin-right:0.10903em;">CON</span></span></span></span></span>、SEG<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>），在数据库创建时通过</mtext><mi mathvariant="normal">‘</mi></mrow><annotation encoding="application/x-tex">），在数据库创建时通过`</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord cjk_fallback">），在数据库创建时通过</span><span class="mord">‘</span></span></span></span></span>ORACLE_HOME/rdbms/admin/sql.bsq<code>脚本初始化。Oracle 11g后，</code>sql.bsq<code>被拆分为</code>dcore.bsq<code>、</code>dobj.bsq`等多个脚本，便于管理与维护。</p>
<p>数据字典表的核心作用是记录对象的元数据：</p>
<ul>
<li>OBJ$：存储所有数据库对象的基本信息（对象号OBJ#、所有者OWNER#、类型TYPE#等）；</li>
<li>TAB$：记录表的存储属性（表空间、数据文件、块号等）；</li>
<li>COL$：存储字段信息（字段名、数据类型、长度、是否允许为空等）；</li>
<li>CON$：记录完整性约束信息。</li>
</ul>
<h3 data-id="heading-6">3.2 关键特性：TRUNCATE对DATAOBJ#的影响</h3>
<p>OBJ$表中的<code>OBJ#</code>（对应DBA_OBJECTS.OBJECT_ID）是对象的逻辑编号，一旦分配永不改变；而<code>DATAOBJ#</code>（对应DBA_OBJECTS.DATA_OBJECT_ID）是与物理存储关联的编号，会随物理结构变化（如TRUNCATE）而更新。Oracle明确提示“不要在DATAOBJ#上创建索引”，因为TRUNCATE会修改该字段：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 创建测试表</span>
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> test <span class="hljs-keyword">as</span> <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> dba_users;
<span class="hljs-comment">-- 查询初始OBJ#和DATAOBJ#（值相同）</span>
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> object_id,data_object_id <span class="hljs-keyword">from</span> dba_objects <span class="hljs-keyword">where</span> owner<span class="hljs-operator">=</span><span class="hljs-string">'EYGLE'</span> <span class="hljs-keyword">and</span> object_name<span class="hljs-operator">=</span><span class="hljs-string">'TEST'</span>;
OBJECT_ID DATA_OBJECT_ID
<span class="hljs-number">15036</span>        <span class="hljs-number">15036</span>
<span class="hljs-comment">-- 执行TRUNCATE后，DATAOBJ#递增</span>
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">truncate</span> <span class="hljs-keyword">table</span> test;
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> object_id,data_object_id <span class="hljs-keyword">from</span> dba_objects <span class="hljs-keyword">where</span> owner<span class="hljs-operator">=</span><span class="hljs-string">'EYGLE'</span> <span class="hljs-keyword">and</span> object_name<span class="hljs-operator">=</span><span class="hljs-string">'TEST'</span>;
OBJECT_ID DATA_OBJECT_ID
<span class="hljs-number">15036</span>        <span class="hljs-number">15037</span>
</code></pre>
<p>这一特性也解释了TRUNCATE快速回收空间的本质：仅标记空间为可用，不删除数据块内容，通过更新DATAOBJ#重新定位对象，数据在被覆盖前可通过工具恢复。</p>
<h3 data-id="heading-7">3.3 DDL操作的底层实现</h3>
<p>用户执行DDL操作（如CREATE TABLE）时，Oracle会自动将其解析为对数据字典表的DML操作。通过10046事件跟踪（<code>alter session set events '10046 trace name context forever,level 12'</code>），可捕获这些底层动作：</p>
<ul>
<li>向OBJ$插入对象基本信息；</li>
<li>向TAB$记录表的存储属性；</li>
<li>向COL$插入字段信息；</li>
<li>向CON$记录约束信息；</li>
<li>向SEG$插入数据段信息。</li>
</ul>
<p>Oracle 9i后引入的<code>DBMS_METADATA</code>工具包可反向解析这些元数据，还原原始DDL语句：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> dbms_metadata.get_ddl(<span class="hljs-string">'TABLE'</span>,<span class="hljs-string">'EYGLE'</span>) <span class="hljs-keyword">from</span> dual;
</code></pre>
<h2 data-id="heading-8">四、静态数据字典视图：面向用户的访问接口</h2>
<p>由于X$表和数据字典表不可直接访问，Oracle提供了静态数据字典视图，将底层元数据封装为用户友好的接口。静态视图数据相对稳定，按权限分为三类：</p>
<h3 data-id="heading-9">4.1 视图分类与权限控制</h3>

























<table><thead><tr><th>视图前缀</th><th>包含内容</th><th>访问权限</th></tr></thead><tbody><tr><td>USER_</td><td>当前用户拥有的对象</td><td>无需额外权限</td></tr><tr><td>ALL_</td><td>当前用户可访问的对象（自有+授权）</td><td>需对象授权</td></tr><tr><td>DBA_</td><td>数据库中所有对象</td><td>需SELECT ANY TABLE权限或DBA角色</td></tr></tbody></table>
<p>三类视图的权限控制通过WHERE子句实现：</p>
<ul>
<li>USER_TABLES：通过<code>o.owner# = userenv('SCHEMAID')</code>限制返回当前用户对象；</li>
<li>ALL_TABLES：增加权限判断（<code>o.obj# in (select oa.obj# from sys.objauth$ oa ...)</code>或系统权限检查）；</li>
<li>DBA_TABLES：无所有者限制，返回所有对象。</li>
</ul>
<h3 data-id="heading-10">4.2 常用静态视图与同义词</h3>
<h4 data-id="heading-11">（1）DICT/DICTIONARY</h4>
<p>记录当前用户可访问的所有数据字典视图，包含<code>TABLE_NAME</code>（对象名）和<code>COMMENTS</code>（描述）字段，是查询数据字典的“目录”：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> table_name <span class="hljs-keyword">from</span> dict <span class="hljs-keyword">where</span> table_name <span class="hljs-keyword">like</span> <span class="hljs-string">'%TABLES%'</span>;
</code></pre>
<h4 data-id="heading-12">（2）DICT_COLUMNS</h4>
<p>记录数据字典视图的字段信息，可快速查询视图结构：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> column_name,comments <span class="hljs-keyword">from</span> dict_columns <span class="hljs-keyword">where</span> table_name<span class="hljs-operator">=</span><span class="hljs-string">'DICT'</span>;
</code></pre>
<h4 data-id="heading-13">（3）OBJ$/DBA_OBJECTS/OBJ</h4>
<ul>
<li>
<p>OBJ<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>是底层表，</mtext><mi>D</mi><mi>B</mi><msub><mi>A</mi><mi>O</mi></msub><mi>B</mi><mi>J</mi><mi>E</mi><mi>C</mi><mi>T</mi><mi>S</mi><mtext>基于</mtext><mi>O</mi><mi>B</mi><mi>J</mi></mrow><annotation encoding="application/x-tex">是底层表，DBA_OBJECTS基于OBJ</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord cjk_fallback">是底层表，</span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">O</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mord mathnormal" style="margin-right:0.09618em;">J</span><span class="mord mathnormal" style="margin-right:0.05764em;">ECTS</span><span class="mord cjk_fallback">基于</span><span class="mord mathnormal" style="margin-right:0.05017em;">OB</span><span class="mord mathnormal" style="margin-right:0.09618em;">J</span></span></span></span></span>构建；</p>
</li>
<li>
<p>OBJ是USER_OBJECTS的公共同义词，供用户查询自有对象：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> object_name,object_type <span class="hljs-keyword">from</span> obj;
</code></pre>
</li>
</ul>
<h4 data-id="heading-14">（4）*_SOURCE视图</h4>
<p>存储存储过程、函数、包、触发器等对象的源码，如<code>DBA_SOURCE</code>：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> text <span class="hljs-keyword">from</span> dba_source <span class="hljs-keyword">where</span> name<span class="hljs-operator">=</span><span class="hljs-string">'CALLING'</span>;
</code></pre>
<h3 data-id="heading-15">4.3 同义词的作用与类型</h3>
<p>同义词（Synonym）是数据库对象的别名，仅存储定义，无需额外空间，核心作用包括：</p>
<ul>
<li>隐藏对象名称与所有者；</li>
<li>隐藏分布式环境中远程对象的位置；</li>
<li>简化SQL语句；</li>
<li>实现精细访问控制。</li>
</ul>
<p>同义词分为<strong>公共同义词</strong>（PUBLIC所有，所有用户可访问）和<strong>私有同义词</strong>（用户私有，需授权访问）。例如，创建SALES_DATA表的公共同义词：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">create</span> public synonym sales <span class="hljs-keyword">for</span> eygle.sales_data;
<span class="hljs-comment">-- 用户可直接通过同义词访问</span>
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> sales;
</code></pre>
<h2 data-id="heading-16">五、动态性能视图：数据库运行状态的实时窗口</h2>
<p>动态性能视图（V$视图）记录数据库运行时的实时信息（如会话、SGA、进程、锁等），数据随数据库状态动态更新，是DBA监控与诊断的核心工具。</p>
<h3 data-id="heading-17">5.1 GV<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>与</mtext><mi>V</mi></mrow><annotation encoding="application/x-tex">与V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord cjk_fallback">与</span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span></span>的关系</h3>
<ul>
<li>GV<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>（</mtext><mi>G</mi><mi>l</mi><mi>o</mi><mi>b</mi><mi>a</mi><mi>l</mi><mi>V</mi></mrow><annotation encoding="application/x-tex">（Global V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord cjk_fallback">（</span><span class="mord mathnormal" style="margin-right:0.01968em;">Gl</span><span class="mord mathnormal">o</span><span class="mord mathnormal">ba</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span></span>）：适用于RAC环境，返回所有实例的信息；</li>
<li>V<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>：基于</mtext><mi>G</mi><mi>V</mi></mrow><annotation encoding="application/x-tex">：基于GV</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord cjk_fallback">：基于</span><span class="mord mathnormal">G</span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span></span>构建，通过<code>inst_id = USERENV('Instance')</code>限制返回当前实例信息。</li>
</ul>
<p>例如，RAC环境中查询实例信息：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- GV$返回所有实例</span>
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> inst_id,instance_name,status <span class="hljs-keyword">from</span> gv$instance;
INST_ID INSTANCE_NAME STATUS
<span class="hljs-number">1</span>       RACDB1        <span class="hljs-keyword">OPEN</span>
<span class="hljs-number">2</span>       RACDB2        <span class="hljs-keyword">OPEN</span>
<span class="hljs-comment">-- V$仅返回当前实例</span>
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> instance_name,status <span class="hljs-keyword">from</span> v$instance;
INSTANCE_NAME STATUS
RACDB1        <span class="hljs-keyword">OPEN</span>
</code></pre>
<h3 data-id="heading-18">5.2 V_$视图与同义词的关联</h3>
<p>Oracle通过“V<span class="math math-inline"><span class="katex-error" title="ParseError: KaTeX parse error: Expected group after '_' at position 5: 视图→V_̲" style="color:#cc0000"><span class="cjk_fallback">视图→V_</span></span></span>视图→同义词”的层级提供访问：</p>
<ol>
<li>
<p>V<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>视图基于</mtext><mi>X</mi></mrow><annotation encoding="application/x-tex">视图基于X</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord cjk_fallback">视图基于</span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span></span></span></span></span>表构建，仅SYS可直接访问，无法授权；</p>
</li>
<li>
<p>V_<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>视图是</mtext><mi>V</mi></mrow><annotation encoding="application/x-tex">视图是V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord cjk_fallback">视图是</span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span></span>视图的封装（<code>create or replace view v_$fixed_table as select * from v$fixed_table</code>）；</p>
</li>
<li>
<p>公共同义词（如V<span class="math math-inline"><span class="katex-error" title="ParseError: KaTeX parse error: Expected group after '_' at position 16: FIXED_TABLE）指向V_̲" style="color:#cc0000">FIXED_TABLE）指向V_</span></span>视图，普通用户通过同义词访问，需授予V_$视图的查询权限：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 直接授权V$视图报错</span>
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">grant</span> <span class="hljs-keyword">select</span> <span class="hljs-keyword">on</span> v$sga <span class="hljs-keyword">to</span> eygle;
ORA<span class="hljs-number">-02030</span>: can <span class="hljs-keyword">only</span> <span class="hljs-keyword">select</span> <span class="hljs-keyword">from</span> fixed tables<span class="hljs-operator">/</span>views
<span class="hljs-comment">-- 授权V_$视图成功</span>
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">grant</span> <span class="hljs-keyword">select</span> <span class="hljs-keyword">on</span> v_$sga <span class="hljs-keyword">to</span> eygle;
<span class="hljs-keyword">Grant</span> succeeded.
</code></pre>
</li>
</ol>
<h3 data-id="heading-19">5.3 数据库启动各阶段的可访问视图</h3>
<p>动态性能视图的访问依赖数据库启动状态：</p>
<ul>
<li><strong>Nomount阶段</strong>（仅启动实例）：可访问V<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mi>A</mi><mi>R</mi><mi>A</mi><mi>M</mi><mi>E</mi><mi>T</mi><mi>E</mi><mi>R</mi><mtext>、</mtext><mi>V</mi></mrow><annotation encoding="application/x-tex">PARAMETER、V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord mathnormal">A</span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mord mathnormal">A</span><span class="mord mathnormal" style="margin-right:0.00773em;">METER</span><span class="mord cjk_fallback">、</span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span></span>SGA、V$INSTANCE等参数与实例信息；</li>
<li><strong>Mount阶段</strong>（读取控制文件）：新增V<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>C</mi><mi>O</mi><mi>N</mi><mi>T</mi><mi>R</mi><mi>O</mi><mi>L</mi><mi>F</mi><mi>I</mi><mi>L</mi><mi>E</mi><mtext>、</mtext><mi>V</mi></mrow><annotation encoding="application/x-tex">CONTROLFILE、V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">CONTRO</span><span class="mord mathnormal">L</span><span class="mord mathnormal" style="margin-right:0.13889em;">F</span><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="mord mathnormal">L</span><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="mord cjk_fallback">、</span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span></span>DATABASE、V$DATAFILE等控制文件相关视图；</li>
<li><strong>Open阶段</strong>（打开数据文件）：所有动态视图与数据字典均可访问。</li>
</ul>
<h2 data-id="heading-20">六、同义词优化实践：提升数据字典查询性能</h2>
<h3 data-id="heading-21">6.1 问题背景</h3>
<p>某业务系统通过查询<code>all_tab_columns</code>动态拼装SQL，2小时内执行74131次，每次逻辑读517.9，执行计划嵌套多层数据字典表（OBJ<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>、</mtext><mi>U</mi><mi>S</mi><mi>E</mi><mi>R</mi></mrow><annotation encoding="application/x-tex">、USER</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord cjk_fallback">、</span><span class="mord mathnormal" style="margin-right:0.10903em;">U</span><span class="mord mathnormal" style="margin-right:0.00773em;">SER</span></span></span></span></span>、COL$等），性能瓶颈显著。</p>
<h3 data-id="heading-22">6.2 优化方案</h3>
<p>利用同义词替换<code>all_tab_columns</code>视图，通过预建表存储静态字段信息，减少底层表关联：</p>
<ol>
<li>
<p>创建临时表存储目标用户的字段信息：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">copy</span> <span class="hljs-keyword">from</span> oti<span class="hljs-operator">/</span>oti<span class="hljs-variable">@fwx</span> <span class="hljs-keyword">to</span> oti<span class="hljs-operator">/</span>oti<span class="hljs-variable">@fwx</span> <span class="hljs-keyword">create</span> all_tab_columns_temp <span class="hljs-keyword">using</span> <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> all_tab_columns t <span class="hljs-keyword">where</span> t.owner<span class="hljs-operator">=</span><span class="hljs-string">'OTI'</span>;
</code></pre>
</li>
<li>
<p>创建同义词指向临时表：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">create</span> synonym all_tab_columns <span class="hljs-keyword">for</span> oti.all_tab_columns_temp;
</code></pre>
</li>
<li>
<p>建立组合索引优化查询：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">create</span> index oti.all_tab_columns_temp_inx1 <span class="hljs-keyword">on</span> oti.all_tab_columns_temp(owner,table_name,column_name);
</code></pre>
</li>
</ol>
<h3 data-id="heading-23">6.3 优化效果</h3>
<p>优化后，SQL逻辑读从517.9降至4，执行计划简化为“索引范围扫描+表访问”，系统性能大幅提升。</p>
<h2 data-id="heading-24">七、总结与实践建议</h2>
<p>Oracle数据字典的架构层级可概括为：<strong>X$表（底层核心）→ 数据字典表（元数据存储）→ 静态/动态视图（访问接口）→ 同义词（简化与权限控制）</strong> 。理解这一架构对DBA工作至关重要，结合实践给出以下建议：</p>
<ol>
<li><strong>禁止直接操作</strong>：切勿手工修改X$表或数据字典表，避免数据库崩溃；</li>
<li><strong>合理利用视图</strong>：根据权限选择USER_/ALL_/DBA_视图，通过DICT快速定位所需字典；</li>
<li><strong>优化动态查询</strong>：频繁访问的数据字典信息可通过同义词+临时表缓存，减少底层关联；</li>
<li><strong>深入探索底层</strong>：利用AUTOTRACE、10046事件跟踪数据字典的底层关联，辅助故障诊断与性能优化。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[理解 .NET 中的中间件（Middleware）]]></title>    <link>https://juejin.cn/post/7581789701532549162</link>    <guid>https://juejin.cn/post/7581789701532549162</guid>    <pubDate>2025-12-10T07:22:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581789701532549162" data-draft-id="7581858890607067172" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="理解 .NET 中的中间件（Middleware）"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-10T07:22:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="淡定__009"/> <meta itemprop="url" content="https://juejin.cn/user/2999123453676765"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            理解 .NET 中的中间件（Middleware）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2999123453676765/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    淡定__009
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T07:22:48.000Z" title="Wed Dec 10 2025 07:22:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">理解 .NET 中的中间件（Middleware）：请求管道的核心机制</h2>
<p>在 ASP.NET Core 中，中间件（Middleware）是整个 Web 应用的核心机制之一。所有 HTTP 请求都会依次通过一系列中间件处理，这些中间件共同组成了所谓的 <strong>请求管道（Request Pipeline）</strong> 。理解中间件不仅有助于掌握 ASP.NET Core 的工作原理，更能帮助你构建结构清晰、可扩展且易维护的 Web 应用。</p>
<p>本文将从中间件的概念、执行流程、如何编写自定义中间件以及开发中的最佳实践等方面进行介绍。</p>
<hr/>
<h3 data-id="heading-1">一、中间件是什么？</h3>
<p>中间件是用于处理 HTTP 请求和响应的组件。每个中间件在管道中有两个职责：</p>
<ol>
<li><strong>处理当前请求</strong></li>
<li><strong>将请求传递给管道中的下一个中间件（可选）</strong></li>
</ol>
<p>典型逻辑可以概括为：</p>
<pre><code class="hljs language-css" lang="css">Request → <span class="hljs-selector-attr">[Middleware1]</span> → <span class="hljs-selector-attr">[Middleware2]</span> → ... → Endpoint
</code></pre>
<p>中间件既可以选择“继续往下传”，也可以“短路”整个请求。</p>
<p>例如：</p>
<ul>
<li>认证中间件可能会拒绝未授权请求，直接返回 401。</li>
<li>静态文件中间件会直接返回文件内容，不继续传递到 MVC 层。</li>
</ul>
<hr/>
<h3 data-id="heading-2">二、中间件的注册方式</h3>
<p>在 <code>.NET 6+</code> 的程序入口里，你常看到这样的代码：</p>
<pre><code class="hljs language-ini" lang="ini">var <span class="hljs-attr">builder</span> = WebApplication.CreateBuilder(args)<span class="hljs-comment">;</span>
var <span class="hljs-attr">app</span> = builder.Build()<span class="hljs-comment">;</span>

app.UseAuthentication()<span class="hljs-comment">;</span>
app.UseAuthorization()<span class="hljs-comment">;</span>
app.MapControllers()<span class="hljs-comment">;</span>

app.Run()<span class="hljs-comment">;</span>
</code></pre>
<p><code>UseXXX()</code> 即是在管道中注册中间件。</p>
<p>通常中间件的处理顺序非常重要，例如：</p>
<ul>
<li><code>UseRouting()</code> 必须在 <code>UseEndpoints()</code> 前。</li>
<li><code>UseAuthorization()</code> 要在 <code>UseAuthentication()</code> 后。</li>
</ul>
<p>如果顺序错误，可能导致路由不生效或认证失败。</p>
<hr/>
<h3 data-id="heading-3">三、编写一个自定义中间件</h3>
<p>自定义中间件通常有两种方式：类方式与委托方式。</p>
<h4 data-id="heading-4">方式一：通过类编写中间件</h4>
<h5 data-id="heading-5">1. 编写中间件类</h5>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">RequestLogMiddleware</span>
{
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> RequestDelegate _next;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">RequestLogMiddleware</span>(<span class="hljs-params">RequestDelegate next</span>)</span>
    {
        _next = next;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">InvokeAsync</span>(<span class="hljs-params">HttpContext context</span>)</span>
    {
        Console.WriteLine(<span class="hljs-string">$"[Request] <span class="hljs-subst">{context.Request.Method}</span> <span class="hljs-subst">{context.Request.Path}</span>"</span>);

        <span class="hljs-keyword">await</span> _next(context); <span class="hljs-comment">// 继续传递给下一个中间件</span>

        Console.WriteLine(<span class="hljs-string">$"[Response] <span class="hljs-subst">{context.Response.StatusCode}</span>"</span>);
    }
}
</code></pre>
<h5 data-id="heading-6">2. 注册中间件</h5>
<pre><code class="hljs language-ini" lang="ini">app.UseMiddleware&lt;RequestLogMiddleware&gt;()<span class="hljs-comment">;</span>
</code></pre>
<h4 data-id="heading-7">方式二：使用 inline delegate 简写（更轻量）</h4>
<pre><code class="hljs language-python" lang="python">app.Use(<span class="hljs-keyword">async</span> (context, <span class="hljs-built_in">next</span>) =&gt;
{
    Console.WriteLine(<span class="hljs-string">"Before"</span>);
    <span class="hljs-keyword">await</span> <span class="hljs-built_in">next</span>(context);
    Console.WriteLine(<span class="hljs-string">"After"</span>);
});
</code></pre>
<hr/>
<h3 data-id="heading-8">四、中间件执行流程示例</h3>
<p>假设我们有三层中间件：</p>
<pre><code class="hljs language-python" lang="python">app.Use(<span class="hljs-keyword">async</span> (context, <span class="hljs-built_in">next</span>) =&gt;
{
    Console.WriteLine(<span class="hljs-string">"1 - Before"</span>);
    <span class="hljs-keyword">await</span> <span class="hljs-built_in">next</span>();
    Console.WriteLine(<span class="hljs-string">"1 - After"</span>);
});

app.Use(<span class="hljs-keyword">async</span> (context, <span class="hljs-built_in">next</span>) =&gt;
{
    Console.WriteLine(<span class="hljs-string">"2 - Before"</span>);
    <span class="hljs-keyword">await</span> <span class="hljs-built_in">next</span>();
    Console.WriteLine(<span class="hljs-string">"2 - After"</span>);
});

app.Map(<span class="hljs-string">"/hello"</span>, () =&gt; <span class="hljs-string">"Hello"</span>);
</code></pre>
<p>执行顺序会是：</p>
<pre><code class="hljs">1 - Before
2 - Before
（进入 endpoint）
2 - After
1 - After
</code></pre>
<p>这体现了 <strong>洋葱模型（Onion Model）</strong> 的特性。</p>
<hr/>
<h3 data-id="heading-9">五、中间件的典型应用场景</h3>
<p>中间件的应用非常广泛，几乎所有现代 Web 框架都会使用类似的机制。ASP.NET Core 中常见的中间件包括：</p>
<ul>
<li><strong>异常捕获</strong>（UseExceptionHandler）</li>
<li><strong>静态文件处理</strong>（UseStaticFiles）</li>
<li><strong>跨域 CORS</strong>（UseCors）</li>
<li><strong>身份认证 Auth</strong>（UseAuthentication）</li>
<li><strong>压缩响应</strong>（UseResponseCompression）</li>
<li><strong>日志记录与监控</strong>（自定义）</li>
</ul>
<p>例如：要捕获全局异常，可以这样：</p>
<pre><code class="hljs language-arduino" lang="arduino">app.<span class="hljs-built_in">UseExceptionHandler</span>(<span class="hljs-string">"/error"</span>);
</code></pre>
<p>或者写一个自定义全局异常中间件。</p>
<hr/>
<h3 data-id="heading-10">六、开发中常见问题与最佳实践</h3>
<h4 data-id="heading-11">1. 中间件顺序非常关键</h4>
<ul>
<li>错误顺序会导致功能失效</li>
<li>官方文档明确列出了推荐顺序，建议参考</li>
</ul>
<h4 data-id="heading-12">2. 避免在中间件中做耗时操作</h4>
<p>慢中间件会拖垮整个链路。</p>
<h4 data-id="heading-13">3. 如果中止管道，要确保正确设置响应（StatusCode、Header）</h4>
<p>例如，权限不足时返回：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">context.Response.StatusCode</span> = StatusCodes.Status403Forbidden<span class="hljs-comment">;</span>
return<span class="hljs-comment">;</span>
</code></pre>
<h4 data-id="heading-14">4. 避免在中间件中直接访问大量业务逻辑</h4>
<p>业务逻辑应该在 Service 层。</p>
<hr/>
<h3 data-id="heading-15">结语</h3>
<p>中间件是 ASP.NET Core 请求处理的基础结构，掌握中间件可以帮助你：</p>
<ul>
<li>更好地理解框架内部机制</li>
<li>编写可维护的横切逻辑（监控、日志、权限等）</li>
<li>构建复杂的请求管理系统</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Spring AOP底层实现(面试版)]]></title>    <link>https://juejin.cn/post/7581858890607181860</link>    <guid>https://juejin.cn/post/7581858890607181860</guid>    <pubDate>2025-12-10T07:32:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581858890607181860" data-draft-id="7581888578508455963" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Spring AOP底层实现(面试版)"/> <meta itemprop="keywords" content="后端,面试,Java"/> <meta itemprop="datePublished" content="2025-12-10T07:32:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="想用offer打牌"/> <meta itemprop="url" content="https://juejin.cn/user/578781641968972"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Spring AOP底层实现(面试版)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/578781641968972/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    想用offer打牌
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T07:32:56.000Z" title="Wed Dec 10 2025 07:32:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<p>大家好啊，今天我们来讲一下面试中常常遇到的问题--Spring AOP到底是什么，做了什么，使用的好处？许多人就回答一个基于代理模式和JDK动态代理就草草了事，面试官没有得到他想要的答案，自然一直向下深挖,如果面试者无法回答或者突然卡住，给予面试官的感觉就会很差。那么我们下面就来探讨一下吧。</p>
<h2 data-id="heading-1">Spring AOP是什么？好处是什么？</h2>
<p>Spring AOP（面向切面编程）的底层原理主要基于 <strong>代理模式（Proxy Pattern）</strong> ，并结合了 <strong>动态代理技术</strong> 来实现横切关注点（如日志、事务、安全等）与业务逻辑的解耦。其核心思想是在不修改源代码的前提下，对目标方法进行增强。</p>
<p>AOP能够减少重复代码与代码之间的耦合度，而且利于模块未来的扩展性和可维护性。</p>
<h2 data-id="heading-2">Spring AOP的底层原理？</h2>
<p>Spring AOP核心点就是代理模式 + JDK动态代理/CGLIB 动态代理。</p>
<p>其实就两句话：</p>
<p><strong>① 通过“代理对象”拦截方法调用<br/>
② 在方法执行前后织入增强逻辑</strong></p>
<h3 data-id="heading-3">核心流程</h3>
<ul>
<li>
<p><strong>容器启动</strong><br/>
Spring 扫描到你的 <code>@Aspect</code>、<code>@Around</code>、<code>@Before</code> 等增强方法，解析成 <strong>Advisor（通知器）</strong> 。</p>
</li>
<li>
<p><strong>Bean 创建阶段</strong><br/>
当某个 Bean 匹配了 Advisor 的 Pointcut 规则，Spring 会在 <strong>BeanPostProcessor（具体是 <code>AnnotationAwareAspectJAutoProxyCreator</code>）</strong> 中决定 ——  <strong>是否需要为这个 Bean 创建代理对象</strong> 。</p>
</li>
<li>
<p><strong>代理对象创建</strong><br/>
Spring 根据目标类是否有接口，选择：</p>
<ul>
<li>有接口 → <strong>JDK 动态代理</strong></li>
<li>无接口 → <strong>CGLIB 代理（基于子类）</strong></li>
</ul>
</li>
<li>
<p><strong>代理对象拦截方法调用</strong><br/>
当你调用 <code>bean.xxx()</code> 时，其实调用的是代理对象 → 执行增强链 → 最后执行目标方法。</p>
<p>简单来说，就是spring启动的时候会扫一遍那些AOP的切面注解，有bean匹配了相关规则，就会根据是否有实现接口来给他匹配不同的动态代理模式。当该bean调用相关方法，则就会被拦截实现相关增强。</p>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e1413bbbfbb14564b3f70c1ba8e9dde1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oOz55Sob2ZmZXLmiZPniYw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765956776&amp;x-signature=8UP5Vf7tRwEVW6Udqb%2BNiI%2BsNeE%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-4">代理模式的选择</h3>
<h4 data-id="heading-5">1. JDK 动态代理（基于接口）</h4>
<p>要求目标类必须实现至少一个<strong>接口</strong>。Spring 会为目标对象创建一个实现了相同接口的代理对象。使用 <code>java.lang.reflect.Proxy</code> 和 <code>InvocationHandler</code> 实现，<strong>代理类的父类是<code>Proxy</code></strong>。方法调用时，通过 <code>invoke()</code> 方法拦截，并在其中加入切面逻辑。</p>
<p>Java不允许多继承，代理对象的父类是<code>Proxy</code>，所以只能基于接口实现。</p>
<h4 data-id="heading-6">2. CGLIB 动态代理（基于子类）</h4>
<p>当目标类 <strong>没有实现接口</strong> 时，Spring 默认使用 CGLIB。CGLIB 通过继承目标类，生成子类（代理类），并重写其非 final 方法。代理类在重写的方法中插入切面逻辑。需要引入 <code>cglib</code> 依赖（Spring Boot 中已自动包含）。</p>
<p>总的来说，无论是哪种动态代理，执行相关bean的增强方法时，都是执行相关代理对象的方法，里面包含了增强逻辑和原有逻辑。</p>
<h3 data-id="heading-7">Spring AOP的织入时机</h3>
<p>Spring AOP 是 <strong>运行时代理</strong>（Runtime Weaving），不是编译时或类加载时织入（如 AspectJ）。</p>
<p>具体流程：</p>
<ol>
<li>容器启动时，解析所有 <code>@Aspect</code> 切面类。</li>
<li>根据 <code>@Pointcut</code> 表达式匹配目标 Bean 的方法。</li>
<li>对匹配的 Bean 创建代理对象（JDK 或 CGLIB）。</li>
<li>将代理对象注册到 Spring 容器中，后续注入的是代理对象而非原始对象。</li>
<li>调用方法时，通过代理对象触发通知逻辑。</li>
</ol>
<p>这个流程上面说过了，这里再按步骤说一遍，但是重点说的是代理时机，是<strong>运行时代理</strong>！！！！</p>
<h2 data-id="heading-8">总结</h2>
<p>Spring AOP 的底层原理可以概括为：</p>
<blockquote>
<p><strong>通过动态代理（JDK 或 CGLIB）在运行时为目标 Bean 生成代理对象，并在方法调用前后织入切面逻辑，从而实现非侵入式的功能增强。</strong></p>
</blockquote>
<p>这种设计既保持了代码的清晰性，又实现了关注点分离，是 Spring 框架解耦思想的重要体现</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[photo-sphere-viewer实现虚拟漫游功能开发]]></title>    <link>https://juejin.cn/post/7581814484065452084</link>    <guid>https://juejin.cn/post/7581814484065452084</guid>    <pubDate>2025-12-10T06:17:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581814484065452084" data-draft-id="7581664445241049103" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="photo-sphere-viewer实现虚拟漫游功能开发"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-10T06:17:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="L1yuu__"/> <meta itemprop="url" content="https://juejin.cn/user/2560082298812072"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            photo-sphere-viewer实现虚拟漫游功能开发
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2560082298812072/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    L1yuu__
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T06:17:29.000Z" title="Wed Dec 10 2025 06:17:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h2 data-id="heading-0">一、依赖安装</h2>
<p>1、photo-sphere-viewer依赖于threejs开发的所以要安装threejs</p>
<pre><code class="hljs language-bash" lang="bash">    pnpm add @photo-sphere-viewer/core
    pnpm add threejs
</code></pre>
<p><code>@photo-sphere-viewer/core</code> 为核心模块，其他功能需要以插件形式使用。</p>
<h4 data-id="heading-1">其他功能插件官网查看 <a href="https://link.juejin.cn?target=https%3A%2F%2Fphoto-sphere-viewer.js.org%2Fplugins%2F" target="_blank" title="https://photo-sphere-viewer.js.org/plugins/" ref="nofollow noopener noreferrer">Introduction to plugins | Photo Sphere Viewer</a></h4>
<h2 data-id="heading-2">二、初始化使用</h2>
<pre><code class="hljs language-html" lang="html">    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"container"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-javascript" lang="javascript">   <span class="hljs-keyword">const</span> viewer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Viewer</span>({
        <span class="hljs-attr">container</span>: <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'#container'</span>), <span class="hljs-comment">// 容器(必填) 支持传入dom/容器id:'container'</span>
        <span class="hljs-attr">panorama</span>: <span class="hljs-string">'/img.jpg'</span>, <span class="hljs-comment">// 默认加载的全景图路径，</span>
        <span class="hljs-attr">plugins</span>: [<span class="hljs-title class_">MarkersPlugin</span>] <span class="hljs-comment">// 启用插件列表</span>
    })
</code></pre>
<h4 data-id="heading-3">事件绑定</h4>
<pre><code class="hljs language-javascript" lang="javascript">    <span class="hljs-comment">// ready 初始化完成</span>
    viewer.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'ready'</span>, <span class="hljs-function">() =&gt;</span> {})
    <span class="hljs-comment">// click 点击事件</span>
    viewer.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-function">() =&gt;</span> {})
</code></pre>
<h3 data-id="heading-4">三、添加标记插件</h3>
<p>通过<code>viewer.getPlugin(MarkersPlugin)</code>获取初始化时加载的插件</p>
<pre><code class="hljs language-javascript" lang="javascript">    <span class="hljs-keyword">const</span> markersPlugin = viewer.<span class="hljs-title function_">getPlugin</span>(<span class="hljs-title class_">MarkersPlugin</span>)
    markersPlugin.<span class="hljs-title function_">setMarkers</span>(markers)
    markersPlugin.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'select-marker'</span>,<span class="hljs-function">(<span class="hljs-params">{marker}</span>) =&gt;</span> {
        <span class="hljs-comment">// 进行标记点击处理 切换全景图操作等...</span>
        <span class="hljs-keyword">const</span> markerData = marker.<span class="hljs-property">data</span>
    })
</code></pre>
<p><code>marker</code>数据格式：</p>
<pre><code class="hljs language-javascript" lang="javascript">    <span class="hljs-comment">// 单个标记数据格式 个人推荐使用html，可以很方便的自定义想要的标记样式</span>
   <span class="hljs-keyword">const</span> marker = {
        <span class="hljs-attr">id</span>: <span class="hljs-string">'marker-1'</span>,
        <span class="hljs-attr">html</span>: <span class="hljs-string">`&lt;div class="custom-marker"&gt;&lt;/div&gt;`</span>,
        <span class="hljs-attr">position</span>: {
          <span class="hljs-attr">yaw</span>: <span class="hljs-number">5.796742238036393</span>,
          <span class="hljs-attr">pitch</span>: -<span class="hljs-number">0.07873119086209468</span>
        },
        <span class="hljs-attr">data</span>: {
          <span class="hljs-attr">type</span>: <span class="hljs-string">'link'</span>,
          <span class="hljs-attr">linkNodeId</span>: <span class="hljs-string">'scene-2'</span>
        }
      }
</code></pre>
<h3 data-id="heading-5">四、删除标记</h3>
<p><code>markersPlugin.clearMarkers()</code></p>
<h3 data-id="heading-6">五、更换全景图</h3>
<pre><code class="hljs language-javascript" lang="javascript">    viewer.<span class="hljs-title function_">setPanorama</span>(linkNode.<span class="hljs-property">panorama</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-comment">// 更换完成的回调</span>
    })
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[主题切换闪烁问题]]></title>    <link>https://juejin.cn/post/7581779319573413926</link>    <guid>https://juejin.cn/post/7581779319573413926</guid>    <pubDate>2025-12-10T06:29:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581779319573413926" data-draft-id="7581779319573364774" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="主题切换闪烁问题"/> <meta itemprop="keywords" content="前端,Next.js"/> <meta itemprop="datePublished" content="2025-12-10T06:29:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="狐篱"/> <meta itemprop="url" content="https://juejin.cn/user/2568917921575198"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            主题切换闪烁问题
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2568917921575198/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    狐篱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T06:29:34.000Z" title="Wed Dec 10 2025 06:29:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    10
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">现象与解决方案</h2>
<p>现象：把主题保存在 localStorage 中，下次打开页面会自动打开原来的主题，但是刚打开时会有一个闪烁</p>
<p>原因：因为把读取 localStorage 中的主题值的过程放在 useEffect 中了</p>
<p>在 <code>useEffect</code> 中执行的，其执行顺序为</p>
<ul>
<li>HTML 加载 此时是默认主题色或者浏览器默认颜色</li>
<li>React 挂载，渲染页面</li>
<li>执行 useEffect 重新渲染页面，此时应用保存在 localStorage 中的主题变量和主题色</li>
</ul>
<p>正确做法是，应该放在 createRoot 之前同步执行，避免闪烁</p>
<pre><code class="hljs language-js" lang="js">(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>){
	<span class="hljs-keyword">const</span> savedTheme = <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">'theme'</span>);
	<span class="hljs-keyword">const</span> browserTheme = <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">matchMedia</span>(<span class="hljs-string">'(prefers-color-scheme: dark)'</span>).<span class="hljs-property">matches</span> ? <span class="hljs-string">'dark'</span> : <span class="hljs-string">'light'</span>;
	<span class="hljs-variable language_">document</span>.<span class="hljs-property">documentElement</span>.<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">'data-theme'</span>, savedTheme || browserTheme || <span class="hljs-string">'light'</span>);
})();
</code></pre>
<h2 data-id="heading-1">实现过程</h2>
<p>先介绍一下切换主题要用到的知识点</p>
<h3 data-id="heading-2">:root 和 html</h3>
<p><code>:root</code> 这个伪类匹配文档树的根元素，在 HTML 中代表的就是  <code>&lt;html&gt;</code> 标签，但是优先级比 <code>html元素选择器</code> 高</p>
<pre><code class="hljs language-css" lang="css">// demo 中 <span class="hljs-selector-tag">html</span> 选择器写在 <span class="hljs-selector-pseudo">:root</span> 后面，如果同优先级应该是后者优先的，实际上确实红色，说明 <span class="hljs-selector-pseudo">:root</span> 优先
<span class="hljs-selector-pseudo">:root</span> {
	<span class="hljs-attribute">background</span>: red; // 此时页面为红色，注释掉这行时页面呈黄色
}
<span class="hljs-selector-tag">html</span> {
	<span class="hljs-attribute">background</span>: yellow;
}
</code></pre>
<h3 data-id="heading-3">系统主题色</h3>
<p><strong>后面提到的主题都可以理解为模式（参考 Chrome - 设置 - 外观 - 模式 只能选择深色浅色和自动，而主题可以自定义）</strong>
DevTools 中 <code>cmd + shift + p</code> 搜索 <code>dark</code> 或 <code>light</code> 可以模拟对应主题色（搜索不到浏览器当前的主题色）</p>
<h4 data-id="heading-4">color-scheme</h4>
<p>允许元素按照哪些颜色方案呈现，简单来说就是 <strong>按照浏览器模式显示页面</strong>，常见选择为 亮色 light 和 暗色 dark，页面的默认颜色会按照系统模式显示</p>
<pre><code class="hljs language-css" lang="css">注意：
	<span class="hljs-number">1</span>.是按照浏览器的模式，而非主题
	<span class="hljs-number">2</span>.是按照模式显示，而不是给 <span class="hljs-selector-tag">html</span> 元素添加颜色，打开一个空白 <span class="hljs-selector-tag">html</span> 页面可以看到，背景颜色、文字颜色、滚动条颜色都会受到影响(可以视为，只对没有通过 css 设置的样式生效，优先级最低)
</code></pre>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-pseudo">:root</span> {
	<span class="hljs-attribute">color</span>-scheme: ligth dark;
}
</code></pre>
<h4 data-id="heading-5">CSS 媒体查询</h4>
<p>CSS 媒体查询检测系统浏览器主题色是否为深色，<code>prefers-color-scheme</code></p>
<p>html 文件中只写这两个样式，切换浏览器模式，发现不管是 dark 还是 light 模式，都是显示蓝色，说明 <code>@media (prefers-color-scheme: dark)</code> 比 <code>[data-theme='dark']</code> 优先级更低</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-pseudo">:root</span><span class="hljs-selector-attr">[data-theme=<span class="hljs-string">'dark'</span>]</span> {
	<span class="hljs-selector-tag">body</span> {
		<span class="hljs-attribute">background</span>: blue;
	}
}

<span class="hljs-keyword">@media</span> (<span class="hljs-attribute">prefers-color-scheme</span>: dark) {
	<span class="hljs-selector-pseudo">:root</span> {
		<span class="hljs-selector-tag">body</span> {
			<span class="hljs-attribute">background</span>: red;
		}
	}
}
</code></pre>
<p>一般情况下都会使用 JS 来获取 localStorage 或 浏览器主题，不需要使用 <code>@media (prefers-color-scheme: dark)</code> 来实现主题切换, 如果需要纯 CSS 实现颜色变量切换就可以使用了(比如禁用 js 时？)</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-pseudo">:root</span> {
	<span class="hljs-attr">--color-background</span>: <span class="hljs-number">#FFF</span>;
	<span class="hljs-attr">--color-text</span>: <span class="hljs-number">#000</span>;
	<span class="hljs-attr">--size-sm</span>: <span class="hljs-number">12px</span>;
}
<span class="hljs-keyword">@media</span> (<span class="hljs-attribute">prefers-color-scheme</span>: dark) {
	<span class="hljs-selector-pseudo">:root</span> {
		<span class="hljs-attr">--color-background</span>: <span class="hljs-number">#000</span>;
		<span class="hljs-attr">--color-background</span>: <span class="hljs-number">#FFF</span>;
	}
}
</code></pre>
<h4 data-id="heading-6">JS 媒体查询</h4>
<p>JS 查询 <code>window.matchMedia()</code></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> darkModeMediaQuery = <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">matchMedia</span>(<span class="hljs-string">'(prefers-color-scheme: dark)'</span>);
darkModeMediaQuery.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'change'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
	<span class="hljs-keyword">const</span> darkModeOn = e.<span class="hljs-property">matches</span>
	<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Dark Mode is'</span>, darkModeOn);
})
</code></pre>
<p>完整的 CSS 变量声明</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-pseudo">:root</span> {
	<span class="hljs-attr">--color-background</span>: <span class="hljs-number">#FFF</span>;
	<span class="hljs-attr">--color-text</span>: <span class="hljs-number">#000</span>;
	<span class="hljs-attr">--size-sm</span>: <span class="hljs-number">12px</span>;
}
<span class="hljs-keyword">@media</span> (<span class="hljs-attribute">prefers-color-scheme</span>: dark) {
	<span class="hljs-selector-pseudo">:root</span> {
		<span class="hljs-attr">--color-background</span>: <span class="hljs-number">#000</span>;
		<span class="hljs-attr">--color-background</span>: <span class="hljs-number">#FFF</span>;
	}
}
<span class="hljs-selector-pseudo">:root</span> {
	<span class="hljs-attr">--color-background</span>: <span class="hljs-number">#000</span>;
	<span class="hljs-attr">--color-background</span>: <span class="hljs-number">#FFF</span>;
}
</code></pre>
<h3 data-id="heading-7">next.js 项目中保存主题</h3>
<p>为了避免闪烁问题，在 React 项目中应该在 <code>createRoot</code> 之前获取 localStorage 保存的主题，而在 Next.js 项目中，情况又会复杂一些
方案一：在 layout 中使用内联脚本执行
方案二：使用 next-themes 实现，会自动给 html 添加 color-scheme 属性（原理其实一样）</p>
<p>两种方法都很不难，但是按照传统的代码实现中间容易遇到两个问题</p>
<p>传统代码一般是 <code>const [theme, setTheme] = useState('light')</code> 初始化主题变量，<code>useEffect</code> 中读取 localStorage 值并 <code>setTheme</code>，最新版 react 的 eslint 配置会报错 <code>react/set-state-in-effect</code>
可以直接关掉这条规则，但是仔细考虑一下这条规则出现的原因，确实应该尽量遵守，不应该为了读取一个值重复渲染一次，应该在初始化 state 的时候就进行赋值</p>
<p>改成 <code>const [theme, setTheme] = useState(() =&gt; localStorage.getItem('theme'))</code>，eslint 报错没了，但是 next.js 又报错了，大致意思就是 <em>水合过程中发现服务端预渲染的结果和客户端渲染结果不一致</em>，按照 <a href="https://link.juejin.cn?target=https%3A%2F%2Fnextjs.org%2Fdocs%2Fmessages%2Freact-hydration-error" target="_blank" title="https://nextjs.org/docs/messages/react-hydration-error" ref="nofollow noopener noreferrer">官方文档</a> 的解决方案，使用 <code>supressHydrationWarning={true}</code> 或者 <code>dynamic</code>
官方推荐尽量不使用 <code>suppressHydrationWarning</code>，而且实际情况中可能很多地方使用（上一个简单 demo 则只需要在 button 属性上增加即可），所以我们采用 <code>dynamic</code> 方案，官方推荐的是在引入组件时包裹一层，但是考虑到我们是通用组件的话，可以在导出的时候包裹一层即可</p>
<p>解决 <code>react/set-state-in-effect</code> 并保存到 localStorage 代码如下</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Theme</span> = <span class="hljs-string">'dark'</span> | <span class="hljs-string">'light'</span>;
<span class="hljs-keyword">const</span> getBrowserTheme = (): <span class="hljs-function"><span class="hljs-params">Theme</span> =&gt;</span> {
	<span class="hljs-keyword">const</span> isDark =  <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">matchMedia</span>(<span class="hljs-string">'(prefers-color-scheme: dark)'</span>).<span class="hljs-property">matches</span>;
	<span class="hljs-keyword">return</span> isDark ? <span class="hljs-string">'dark'</span> : <span class="hljs-string">'light'</span>;
}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title class_">ToggleTheme</span> {
	<span class="hljs-comment">// 初始化页面主题是通过前面提到过的 createRoot 之前获取，这里只是初始化切换主题的按钮文案</span>
	<span class="hljs-keyword">const</span> [theme, setTheme] = useState&lt;<span class="hljs-title class_">Theme</span>&gt;(<span class="hljs-string">'light'</span>);
	<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleToggleTheme</span> = (<span class="hljs-params">t: Theme</span>) =&gt; {
		<span class="hljs-title function_">setTheme</span>(t);
		<span class="hljs-variable language_">document</span>.<span class="hljs-property">documentElement</span>.<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">'theme'</span>, t);
		<span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-string">'theme'</span>, t);
	}
	<span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
		<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleStorage</span> = (<span class="hljs-params">e: StorageEvent</span>) =&gt; {
			<span class="hljs-keyword">if</span> (e.<span class="hljs-property">key</span> !== <span class="hljs-string">'theme'</span>) <span class="hljs-keyword">return</span>;
			<span class="hljs-keyword">if</span> (!e.<span class="hljs-property">newValue</span>) {
				<span class="hljs-comment">// localStorage 值不存在则获取浏览器模式</span>
				<span class="hljs-title function_">setTheme</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">getBrowserTheme</span>());
			} <span class="hljs-keyword">else</span> {
				<span class="hljs-comment">// 存在则改变 theme</span>
				<span class="hljs-title function_">setTheme</span>(e.<span class="hljs-property">newValue</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">Theme</span>);
			}
		};
		<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'storage'</span>, handleStorage);
		<span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'storage'</span>, handleStorage);
	})

	<span class="hljs-keyword">return</span> (
		<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> handleToggleTheme(theme === 'dark' ? 'light' : 'dark')}&gt;{theme}<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
	)
}
</code></pre>
<p><strong>浏览器监听 storage 事件用于跨标签/窗口同步数据，当前窗口修改 localStorage 时不会触发当前窗口的监听</strong></p>
<p>解决 next.js Hydrate 过程中服务端预渲染和客户端渲染结果不一致方案</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 官方推荐</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Toggle</span>(<span class="hljs-params"/>) {};

<span class="hljs-comment">// 引入的地方动态引入包裹一层，然后使用 DynamicToggle</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">DynamicToggle</span> = <span class="hljs-title function_">dyanmic</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'../componnents/Toggle'</span>), {<span class="hljs-attr">ssr</span>: <span class="hljs-literal">false</span>});

<span class="hljs-comment">// 我的代码</span>
<span class="hljs-keyword">import</span> dynamic <span class="hljs-keyword">from</span> <span class="hljs-string">'next/dynamic'</span>;

<span class="hljs-comment">// 简化的组件 demo，真是情况应该参考上面的 demo</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">Toggle</span> = (<span class="hljs-params"/>) =&gt; {
	<span class="hljs-keyword">const</span> [theme, setTheme] = <span class="hljs-title function_">useTheme</span>();
	<span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setTheme(theme === 'dark' ? 'light' : 'dark')}&gt;{theme}<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
};

<span class="hljs-keyword">const</span> <span class="hljs-title class_">DynamicToggle</span> = <span class="hljs-title function_">dynamic</span>(<span class="hljs-title class_">Toggle</span>, {<span class="hljs-attr">ssr</span>: <span class="hljs-literal">false</span>});
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">DynamicToggle</span>;
</code></pre>
<h3 data-id="heading-8">document.startViewTransition</h3>
<p><code>document.startViewTransition(cb)</code> 开始一个新的视图过渡，可以理解为在 DOM 发生变化的过程中展示一层过渡动效，常见的例子</p>
<ul>
<li>图片预览页切换图片</li>
<li>切换主题按钮点击后整个页面发生一个区域覆盖过程</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-title function_">toggleTheme</span> = (<span class="hljs-params">t</span>) =&gt; {
	<span class="hljs-comment">// ...</span>
}
<span class="hljs-keyword">const</span> <span class="hljs-title function_">toggleWithTransition</span> = (<span class="hljs-params">t</span>) =&gt; {
	<span class="hljs-keyword">if</span> (<span class="hljs-variable language_">document</span>.<span class="hljs-property">startViewTransition</span>) {
		<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">startViewTransition</span>(<span class="hljs-function">() =&gt;</span> {
			<span class="hljs-title function_">toggleTheme</span>(t);
		})
	} <span class="hljs-keyword">else</span> {
		<span class="hljs-title function_">toggleTheme</span>(t);
	}
}
</code></pre>
<p>具体动效由 <code>::viewtransition-new</code> 和 <code>::viewtransition-old</code> 的样式决定</p>
<pre><code class="hljs language-css" lang="css">::<span class="hljs-built_in">view-transition-new</span>(root) {
  <span class="hljs-attribute">mask</span>: <span class="hljs-built_in">url</span>(<span class="hljs-string">'data:image/svg+xml,&lt;svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 40 40"&gt;&lt;circle cx="20" cy="20" r="20" fill="white"/&gt;&lt;/svg&gt;'</span>)
    center / <span class="hljs-number">0</span> no-repeat;
  <span class="hljs-attribute">animation</span>: scale <span class="hljs-number">1s</span>;
  <span class="hljs-attribute">animation-fill-mode</span>: both;
}

::<span class="hljs-built_in">view-transition-old</span>(root),
.dark::<span class="hljs-built_in">view-transition-old</span>(root) {
  <span class="hljs-attribute">animation</span>: none;
  <span class="hljs-attribute">animation-fill-mode</span>: both;
  <span class="hljs-attribute">z-index</span>: -<span class="hljs-number">1</span>;
}
<span class="hljs-selector-class">.dark</span>::<span class="hljs-built_in">view-transition-new</span>(root) {
  <span class="hljs-attribute">animation</span>: scale <span class="hljs-number">1s</span>;
  <span class="hljs-attribute">animation-fill-mode</span>: both;
}

<span class="hljs-keyword">@keyframes</span> scale {
  <span class="hljs-selector-tag">to</span> {
    <span class="hljs-attribute">mask-size</span>: <span class="hljs-number">200vmax</span>;
  }
}
</code></pre>
<p>可以 <a href="https://link.juejin.cn?target=https%3A%2F%2Ftheme-toggle.rdsx.dev%2F" target="_blank" title="https://theme-toggle.rdsx.dev/" ref="nofollow noopener noreferrer">参考开源</a> 的动效，直接 copy 代码进行微调</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[无废话系列之 use client ≠ client only]]></title>    <link>https://juejin.cn/post/7581779319573430310</link>    <guid>https://juejin.cn/post/7581779319573430310</guid>    <pubDate>2025-12-10T06:29:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581779319573430310" data-draft-id="7581888578536898598" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="无废话系列之 use client ≠ client only "/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-10T06:29:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户43466215313"/> <meta itemprop="url" content="https://juejin.cn/user/3071363606385689"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            无废话系列之 use client ≠ client only 
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3071363606385689/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户43466215313
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T06:29:54.000Z" title="Wed Dec 10 2025 06:29:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>今儿部门新人问我：“已经在页面里写明了use client了，为什么还是报错 Hydration failed 啊？”</p>
<p>原因是他在代码里写了<code>typeof window !== 'undefined'</code>。</p>
<p>下面我会把 <strong>为什么 <code>use client</code> 仍然会出现 Hydration failed</strong> 这个问题完整讲清楚，因为这是 Next.js 里非常常见的误解。</p>
<h3 data-id="heading-0">✅ <strong>结论先说：<code>use client</code> ≠ 只在客户端运行</strong></h3>
<p>这是大家最容易误解的点。</p>
<p>✔ <strong><code>use client</code> 的真正含义：</strong></p>
<blockquote>
<p>“让这个组件在客户端 可以使用 React 的交互功能（如 useState/useEffect）”</p>
<p>但 <strong>组件本身仍然会在服务端执行一次来生成 HTML（SSR）</strong> ，然后再在客户端 hydration。</p>
</blockquote>
<p>所以：</p>
<ul>
<li>你写了 <code>use client</code></li>
<li>但组件仍然 <strong>会在服务端运行一次（Node 环境）</strong></li>
<li>服务端渲染出来的 HTML 会发送给浏览器</li>
<li>浏览器再执行相同的 React 代码进行 hydration</li>
</ul>
<p>⚠ 因此，即使是 Client Component，它的 <strong>模块初始化代码（顶层代码）仍然会在服务器跑一次</strong>。</p>
<p>❌ <strong>因此：顶层使用 <code>window</code> 依旧会报错</strong></p>
<p>你写：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-variable language_">window</span> !== <span class="hljs-string">'undefined'</span>) {
  ...
}
</code></pre>
<p>这个语句依旧会被 <strong>服务端执行一次</strong>（因为 SSR 需要它），虽然不会崩溃，但关键问题是</p>
<p>❌ <strong>SSR 输出的 HTML 与 CSR 输出的 HTML 不一致 → hydration fail</strong></p>
<p>示例：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-string">"use client"</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Page</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">let</span> text = <span class="hljs-string">"hello"</span>;

  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-variable language_">window</span> !== <span class="hljs-string">"undefined"</span>) {
    text = <span class="hljs-string">"hello from client"</span>;
  }

  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{text}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
}

</code></pre>
<p>服务器执行时：</p>
<ul>
<li><code>typeof window === 'undefined'</code></li>
<li>text = <code>"hello"</code></li>
</ul>
<p>浏览器执行 hydration 时：</p>
<ul>
<li><code>typeof window !== 'undefined'</code></li>
<li>text = <code>"hello from client"</code></li>
</ul>
<p>最终 HTML 不一致：</p>













<table><thead><tr><th>Server HTML</th><th>Client HTML</th></tr></thead><tbody><tr><td><code>&lt;div&gt;hello&lt;/div&gt;</code></td><td><code>&lt;div&gt;hello from client&lt;/div&gt;</code></td></tr></tbody></table>
<p>➡ <strong>直接导致：Hydration failed</strong></p>
<p>🔥 所以重点：</p>
<p>✔ <strong>Client Component 依然会 SSR，因此不能在渲染逻辑里使用 window。</strong></p>
<p>✔ 但可以在 <code>useEffect</code> 里使用，因为 effect 只在客户端执行。</p>
<h3 data-id="heading-1"><strong>推荐写法（100% 不会 Hydration failed）</strong></h3>
<p>如果你要用 <code>window</code>、<code>document</code>、<code>localStorage</code> 等：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-string">"use client"</span>;

<span class="hljs-keyword">import</span> { useEffect, useState } <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Page</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [text, setText] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">"hello"</span>);

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">setText</span>(<span class="hljs-string">"hello from client"</span>);
  }, []);

  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{text}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
}
</code></pre>
<p>✔ SSR 输出：<code>hello</code></p>
<p>✔ 客户端 hydration 输出：<code>hello</code>（一致）</p>
<p>✔ hydration 后 useEffect 修改内容 → 不会报错</p>
<h3 data-id="heading-2"><strong>那什么时候可以用 <code>typeof window !== 'undefined'</code>？</strong></h3>
<p>✔ <strong>只能在 effect / event handler 里用</strong></p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-variable language_">window</span> !== <span class="hljs-string">'undefined'</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span>);
  }
}, []);
</code></pre>
<p>❌ 不能用于：</p>
<ul>
<li>顶层逻辑</li>
<li>render 逻辑（JSX 里）</li>
<li><code>useState</code> 初始值函数</li>
<li>影响 SSR 输出的地方</li>
</ul>
<h3 data-id="heading-3">如果真的要完全避免 SSR？</h3>
<p>你需要 <strong>动态关闭 SSR</strong>，而不是仅仅 <code>use client</code>：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">const</span> <span class="hljs-title class_">Page</span> = <span class="hljs-title function_">dynamic</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">"./page-client"</span>), {
  <span class="hljs-attr">ssr</span>: <span class="hljs-literal">false</span>
});
</code></pre>
<p>这样组件 <strong>完全在客户端渲染，不再进行 hydration 匹配</strong>。</p>
<h3 data-id="heading-4">总结（重要）</h3>

























<table><thead><tr><th>误解</th><th>正确理解</th></tr></thead><tbody><tr><td><code>use client</code> = only client</td><td>❌ 错</td></tr><tr><td>Client Component 不会在服务器执行</td><td>❌ 会在服务器执行一次（SSR）</td></tr><tr><td>能直接在 JSX 或顶层使用 window</td><td>❌ 会导致 SSR/CSR 内容不一致</td></tr><tr><td>需要浏览器 API → 用 <code>useEffect</code></td><td>✔ 正确做法</td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[package.json中的overrides用法]]></title>    <link>https://juejin.cn/post/7581786379804639267</link>    <guid>https://juejin.cn/post/7581786379804639267</guid>    <pubDate>2025-12-10T06:40:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581786379804639267" data-draft-id="7581786379804606499" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="package.json中的overrides用法"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-10T06:40:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="404号扳手"/> <meta itemprop="url" content="https://juejin.cn/user/1151943919022807"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            package.json中的overrides用法
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1151943919022807/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    404号扳手
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T06:40:29.000Z" title="Wed Dec 10 2025 06:40:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 <code>package.json</code> 中，<code>overrides</code> 是一个非常强大的功能，主要用于<strong>强制覆盖项目依赖树中某些包的版本</strong>。</p>
<p>简单来说，当你遇到“依赖冲突”（比如 A 组件需要 React 17，B 组件需要 React 18）或者需要修复某个深层嵌套的子依赖漏洞时，<code>overrides</code> 可以帮你强制统一版本。</p>
<p>需要注意的是，<strong>不同的包管理工具（npm、pnpm、Yarn）对 <code>overrides</code> 的支持和写法略有不同</strong>。以下我为你详细梳理了它的核心用法、语法格式以及注意事项。</p>
<h3 data-id="heading-0">🛠️ 核心作用：解决什么问题？</h3>
<ol>
<li><strong>解决依赖冲突</strong>：强制将多个版本的同一个包统一为一个版本，减少 <code>node_modules</code> 体积并避免运行时错误。</li>
<li><strong>修复安全漏洞</strong>：当某个深层的子依赖（例如 <code>lodash</code> 或 <code>axios</code> 的某个旧版本）存在安全漏洞时，强制将其升级到安全版本。</li>
<li><strong>强制升级/降级</strong>：在某些库的最新版本有 Bug 时，强制锁定到一个稳定的旧版本。</li>
<li><strong>替换包源</strong>：强制将某个包替换为你自己的 Fork 版本或内网版本。</li>
</ol>
<hr/>
<h3 data-id="heading-1">📜 语法格式详解</h3>
<p><code>overrides</code> 的语法支持<strong>嵌套写法</strong>和<strong>路径写法</strong>，这两种写法在 npm 和 pnpm 中通常都支持。</p>
<h4 data-id="heading-2">1. 基础写法（对象嵌套）</h4>
<p>这种写法层级清晰，适合覆盖特定依赖下的子依赖。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"overrides"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"react"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"18.2.0"</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 全局覆盖：强制所有 react 版本为 18.2.0</span>
    <span class="hljs-attr">"lodash"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"4.17.21"</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 全局覆盖：修复安全漏洞</span>
    <span class="hljs-attr">"some-package"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"react"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"17.0.0"</span> <span class="hljs-comment">// 嵌套覆盖：仅强制 some-package 依赖的 react 为 17.0.0</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"foo"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"bar"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2.0.0"</span> <span class="hljs-comment">// 嵌套覆盖：仅强制 foo 依赖的 bar 子依赖为 2.0.0</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-3">2. 高级写法（路径与通配符）</h4>
<p>这种写法更灵活，支持通配符和更复杂的路径匹配。</p>






























<table><thead><tr><th align="left">工具</th><th align="left">语法示例</th><th align="left">说明</th></tr></thead><tbody><tr><td align="left"><strong>npm / pnpm</strong></td><td align="left"><code>"foo&gt;bar": "2.0.0"</code></td><td align="left">使用 <code>&gt;</code> 表示 foo 的直接依赖 bar</td></tr><tr><td align="left"><strong>npm / pnpm</strong></td><td align="left"><code>"foo&gt;bar&gt;baz": "1.0.0"</code></td><td align="left">支持多级路径</td></tr><tr><td align="left"><strong>pnpm</strong></td><td align="left"><code>"**&gt;foo": "1.0.0"</code></td><td align="left">使用 <code>**</code> 通配符匹配所有层级</td></tr><tr><td align="left"><strong>Yarn</strong></td><td align="left"><code>"foo/bar": "2.0.0"</code></td><td align="left">Yarn v2+ 的路径写法</td></tr></tbody></table>
<h4 data-id="heading-4">3. 特殊操作（仅 pnpm 支持）</h4>
<p>如果你使用的是 <strong>pnpm</strong>，它的 <code>pnpm.overrides</code> 功能最为强大，支持一些特殊操作：</p>
<ul>
<li>
<p><strong>删除依赖</strong>：使用 <code>-</code> 可以删除某个不需要的子依赖（例如删除不必要的日志包）。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"pnpm"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"overrides"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"lodash&gt;request"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"-"</span> 
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
</li>
<li>
<p><strong>引用顶层版本</strong>：使用 <code>$</code> 符号，让子依赖去引用项目顶层安装的版本，而不是自己安装一份。</p>
</li>
</ul>
<hr/>
<h3 data-id="heading-5">🛠️ 不同包管理工具的配置差异</h3>
<p>为了防止配置后不生效，请务必确认你使用的包管理器，并参考下表进行配置：</p>

























<table><thead><tr><th align="left">包管理器</th><th align="left">配置字段</th><th align="left">兼容性/备注</th></tr></thead><tbody><tr><td align="left"><strong>npm</strong></td><td align="left"><code>overrides</code></td><td align="left">需要 <strong>npm v8+</strong> 才支持。</td></tr><tr><td align="left"><strong>pnpm</strong></td><td align="left"><code>pnpm.overrides</code></td><td align="left">功能最强大。同时也支持 <code>resolutions</code> 作为别名。</td></tr><tr><td align="left"><strong>Yarn</strong></td><td align="left"><code>resolutions</code></td><td align="left">Yarn 默认不支持 <code>overrides</code>，使用 <code>resolutions</code>。</td></tr></tbody></table>
<p><strong>示例：pnpm 的配置方式</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"my-project"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1.0.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"pnpm"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"overrides"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"webpack"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"5.75.0"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"react-dom"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"18.2.0"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<hr/>
<h3 data-id="heading-6">⚠️ 注意事项与最佳实践</h3>
<p>虽然 <code>overrides</code> 很好用，但我也建议你谨慎使用：</p>
<ol>
<li><strong>兼容性风险</strong>：强制覆盖版本可能会导致依赖该包的其他库无法正常工作（例如强行给一个需要 React 18 的组件塞入 React 17，可能会报错）。<strong>修改后务必进行充分测试。</strong></li>
<li><strong>版本范围</strong>：你可以使用版本范围（如 <code>^18.0.0</code> 或 <code>&gt;=18</code>），但为了稳定性，建议在解决冲突时直接指定具体的版本号。</li>
<li><strong>清理缓存</strong>：如果配置了 <code>overrides</code> 但发现没生效，通常是因为旧的依赖缓存还在。建议删除 <code>node_modules</code> 和锁文件（<code>package-lock.json</code> 或 <code>pnpm-lock.yaml</code>），然后重新执行 <code>npm install</code> 或 <code>pnpm install</code>。</li>
<li><strong>优先级</strong>：<code>overrides</code> 的优先级高于 <code>dependencies</code> 和 <code>devDependencies</code>。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[优雅实现防抖与节流]]></title>    <link>https://juejin.cn/post/7581752508781150251</link>    <guid>https://juejin.cn/post/7581752508781150251</guid>    <pubDate>2025-12-10T05:54:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581752508781150251" data-draft-id="7581752508781133867" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="优雅实现防抖与节流"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-10T05:54:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="dorisrv"/> <meta itemprop="url" content="https://juejin.cn/user/1522178380270712"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            优雅实现防抖与节流
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1522178380270712/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    dorisrv
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T05:54:53.000Z" title="Wed Dec 10 2025 05:54:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    9
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">优雅实现防抖与节流</h2>
<h3 data-id="heading-1">🤔 为什么需要防抖与节流？</h3>
<p>在前端开发中，我们经常会遇到一些高频触发的事件，比如：</p>
<ul>
<li>窗口缩放（resize）</li>
<li>页面滚动（scroll）</li>
<li>输入框输入（input）</li>
<li>按钮频繁点击（click）</li>
</ul>
<p>这些事件如果不加以控制，会导致大量的函数调用，从而影响页面性能。想象一下：用户在输入框快速输入时，每次按键都触发一次API请求——这不仅浪费带宽，还会导致页面卡顿！</p>
<p>防抖（Debounce）和节流（Throttle）就是为了解决这个问题而生的。它们可以有效地控制函数的执行频率，提升页面性能和用户体验。</p>
<h3 data-id="heading-2">💡 基础概念与实现</h3>
<h4 data-id="heading-3">什么是防抖（Debounce）？</h4>
<p>防抖的核心思想是：<strong>如果一个函数被频繁调用，只有当调用停止一段时间后，才执行最后一次调用</strong>。</p>
<p>形象地说：就像坐电梯，只有当没有人再进入电梯时，电梯才会关门运行。</p>
<h5 data-id="heading-4">防抖的基础实现</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">/**
 * 防抖函数
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Function</span>} <span class="hljs-variable">func</span> - 要执行的函数
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number</span>} <span class="hljs-variable">delay</span> - 延迟时间（毫秒）
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">Function</span>} 防抖处理后的函数
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">debounce</span>(<span class="hljs-params">func, delay</span>) {
  <span class="hljs-keyword">let</span> timeoutId;
  
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params">...args</span>) {
    <span class="hljs-comment">// 清除之前的定时器</span>
    <span class="hljs-built_in">clearTimeout</span>(timeoutId);
    
    <span class="hljs-comment">// 设置新的定时器</span>
    timeoutId = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-comment">// 执行函数，保持this上下文</span>
      func.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, args);
    }, delay);
  };
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">const</span> debouncedSearch = <span class="hljs-title function_">debounce</span>(<span class="hljs-function">(<span class="hljs-params">keyword</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'搜索:'</span>, keyword);
  <span class="hljs-comment">// 这里可以发送API请求</span>
}, <span class="hljs-number">300</span>);

<span class="hljs-comment">// 在输入框事件中使用</span>
<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'searchInput'</span>).<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'input'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
  <span class="hljs-title function_">debouncedSearch</span>(e.<span class="hljs-property">target</span>.<span class="hljs-property">value</span>);
});
</code></pre>
<h4 data-id="heading-5">什么是节流（Throttle）？</h4>
<p>节流的核心思想是：<strong>限制函数在一定时间内只能执行一次</strong>。</p>
<p>形象地说：就像水龙头，即使一直开着，也只会每隔一段时间流出一滴水。</p>
<h5 data-id="heading-6">节流的基础实现</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">/**
 * 节流函数
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Function</span>} <span class="hljs-variable">func</span> - 要执行的函数
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number</span>} <span class="hljs-variable">limit</span> - 时间限制（毫秒）
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">Function</span>} 节流处理后的函数
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">throttle</span>(<span class="hljs-params">func, limit</span>) {
  <span class="hljs-keyword">let</span> inThrottle;
  
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params">...args</span>) {
    <span class="hljs-keyword">if</span> (!inThrottle) {
      <span class="hljs-comment">// 执行函数，保持this上下文</span>
      func.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, args);
      
      <span class="hljs-comment">// 标记为已执行</span>
      inThrottle = <span class="hljs-literal">true</span>;
      
      <span class="hljs-comment">// 一段时间后重置标记</span>
      <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
        inThrottle = <span class="hljs-literal">false</span>;
      }, limit);
    }
  };
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">const</span> throttledScroll = <span class="hljs-title function_">throttle</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'滚动位置:'</span>, <span class="hljs-variable language_">window</span>.<span class="hljs-property">scrollY</span>);
  <span class="hljs-comment">// 这里可以处理滚动事件</span>
}, <span class="hljs-number">200</span>);

<span class="hljs-comment">// 在滚动事件中使用</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'scroll'</span>, throttledScroll);
</code></pre>
<h3 data-id="heading-7">🚀 React中的防抖与节流实现</h3>
<p>在React中，我们可以将防抖和节流封装成自定义Hook，以便在组件中更方便地使用。</p>
<h4 data-id="heading-8">自定义防抖Hook：useDebounce</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { useEffect, useState } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-comment">/**
 * 防抖Hook
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">any</span>} <span class="hljs-variable">value</span> - 要防抖的值
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number</span>} <span class="hljs-variable">delay</span> - 延迟时间（毫秒）
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">any</span>} 防抖后的值
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">useDebounce</span>(<span class="hljs-params">value, delay</span>) {
  <span class="hljs-keyword">const</span> [debouncedValue, setDebouncedValue] = <span class="hljs-title function_">useState</span>(value);

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 设置定时器</span>
    <span class="hljs-keyword">const</span> handler = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-title function_">setDebouncedValue</span>(value);
    }, delay);

    <span class="hljs-comment">// 清理函数：组件卸载或依赖变化时清除定时器</span>
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-built_in">clearTimeout</span>(handler);
    };
  }, [value, delay]);

  <span class="hljs-keyword">return</span> debouncedValue;
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">SearchComponent</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [keyword, setKeyword] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">''</span>);
  <span class="hljs-keyword">const</span> debouncedKeyword = <span class="hljs-title function_">useDebounce</span>(keyword, <span class="hljs-number">300</span>);

  <span class="hljs-comment">// 当防抖后的关键词变化时，发送API请求</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (debouncedKeyword) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'搜索:'</span>, debouncedKeyword);
      <span class="hljs-comment">// 发送API请求</span>
    }
  }, [debouncedKeyword]);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">input</span>
      <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span>
      <span class="hljs-attr">value</span>=<span class="hljs-string">{keyword}</span>
      <span class="hljs-attr">onChange</span>=<span class="hljs-string">{(e)</span> =&gt;</span> setKeyword(e.target.value)}
      placeholder="输入关键词搜索..."
    /&gt;</span>
  );
}
</code></pre>
<h4 data-id="heading-9">自定义节流Hook：useThrottle</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { useRef, useState, useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-comment">/**
 * 节流Hook
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">any</span>} <span class="hljs-variable">value</span> - 要节流的值
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number</span>} <span class="hljs-variable">limit</span> - 时间限制（毫秒）
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">any</span>} 节流后的值
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">useThrottle</span>(<span class="hljs-params">value, limit</span>) {
  <span class="hljs-keyword">const</span> [throttledValue, setThrottledValue] = <span class="hljs-title function_">useState</span>(value);
  <span class="hljs-keyword">const</span> lastRan = <span class="hljs-title function_">useRef</span>(<span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>());

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> handler = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() - lastRan.<span class="hljs-property">current</span> &gt;= limit) {
        <span class="hljs-title function_">setThrottledValue</span>(value);
        lastRan.<span class="hljs-property">current</span> = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
      }
    }, limit - (<span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() - lastRan.<span class="hljs-property">current</span>));

    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-built_in">clearTimeout</span>(handler);
    };
  }, [value, limit]);

  <span class="hljs-keyword">return</span> throttledValue;
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">ScrollComponent</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [scrollY, setScrollY] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);
  <span class="hljs-keyword">const</span> throttledScrollY = <span class="hljs-title function_">useThrottle</span>(scrollY, <span class="hljs-number">200</span>);

  <span class="hljs-comment">// 监听滚动事件</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleScroll</span> = (<span class="hljs-params"/>) =&gt; {
      <span class="hljs-title function_">setScrollY</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">scrollY</span>);
    };

    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'scroll'</span>, handleScroll);
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'scroll'</span>, handleScroll);
  }, []);

  <span class="hljs-comment">// 当节流后的滚动位置变化时，执行处理</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'滚动位置:'</span>, throttledScrollY);
    <span class="hljs-comment">// 处理滚动事件</span>
  }, [throttledScrollY]);

  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>当前滚动位置：{throttledScrollY}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
}
</code></pre>
<h3 data-id="heading-10">🎯 Vue 3中的防抖与节流实现</h3>
<p>在Vue 3中，我们可以使用Composition API来实现防抖和节流功能。</p>
<h4 data-id="heading-11">自定义防抖Composable：useDebounce</h4>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup&gt;
import { ref, watch } from 'vue';

/**
 * 防抖Composable
 * @param {any} initialValue - 初始值
 * @param {number} delay - 延迟时间（毫秒）
 * @returns {Object} 包含原始值和防抖后的值
 */
function useDebounce(initialValue, delay) {
  const value = ref(initialValue);
  const debouncedValue = ref(initialValue);
  let timeoutId;

  // 监听值的变化，设置防抖
  watch(value, (newValue) =&gt; {
    clearTimeout(timeoutId);
    timeoutId = setTimeout(() =&gt; {
      debouncedValue.value = newValue;
    }, delay);
  });

  return {
    value,
    debouncedValue
  };
}

// 使用示例
const { value: keyword, debouncedValue: debouncedKeyword } = useDebounce('', 300);

// 监听防抖后的值变化
watch(debouncedKeyword, (newKeyword) =&gt; {
  if (newKeyword) {
    console.log('搜索:', newKeyword);
    // 发送API请求
  }
});
&lt;/script&gt;

&lt;template&gt;
  &lt;input
    v-model="keyword"
    type="text"
    placeholder="输入关键词搜索..."
  /&gt;
&lt;/template&gt;
</code></pre>
<h4 data-id="heading-12">自定义节流Composable：useThrottle</h4>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup&gt;
import { ref, watch } from 'vue';

/**
 * 节流Composable
 * @param {any} initialValue - 初始值
 * @param {number} limit - 时间限制（毫秒）
 * @returns {Object} 包含原始值和节流后的值
 */
function useThrottle(initialValue, limit) {
  const value = ref(initialValue);
  const throttledValue = ref(initialValue);
  let lastRan = Date.now();
  let timeoutId;

  // 监听值的变化，设置节流
  watch(value, (newValue) =&gt; {
    const now = Date.now();
    if (now - lastRan &gt;= limit) {
      throttledValue.value = newValue;
      lastRan = now;
    } else {
      clearTimeout(timeoutId);
      timeoutId = setTimeout(() =&gt; {
        throttledValue.value = newValue;
        lastRan = Date.now();
      }, limit - (now - lastRan));
    }
  });

  return {
    value,
    throttledValue
  };
}

// 使用示例
import { onMounted, onUnmounted } from 'vue';

const { value: scrollY, throttledValue: throttledScrollY } = useThrottle(0, 200);

// 监听滚动事件
onMounted(() =&gt; {
  const handleScroll = () =&gt; {
    scrollY.value = window.scrollY;
  };
  window.addEventListener('scroll', handleScroll);
  
  onUnmounted(() =&gt; {
    window.removeEventListener('scroll', handleScroll);
  });
});

// 监听节流后的滚动位置变化
watch(throttledScrollY, (newScrollY) =&gt; {
  console.log('滚动位置:', newScrollY);
  // 处理滚动事件
});
&lt;/script&gt;

&lt;template&gt;
  &lt;div&gt;当前滚动位置：{{ throttledScrollY }}&lt;/div&gt;
&lt;/template&gt;
</code></pre>
<h3 data-id="heading-13">⚠️ 注意事项与最佳实践</h3>
<h4 data-id="heading-14">1. 防抖与节流的选择</h4>
<ul>
<li><strong>防抖</strong>适合：输入框搜索、表单验证、窗口大小调整等需要等待用户操作完成后再执行的场景</li>
<li><strong>节流</strong>适合：滚动事件、鼠标移动、按钮点击频率限制等需要限制执行频率的场景</li>
</ul>
<h4 data-id="heading-15">2. 延迟时间的选择</h4>
<ul>
<li>输入框搜索：一般300-500ms</li>
<li>滚动事件：一般200-300ms</li>
<li>窗口调整：一般500-1000ms</li>
<li>按钮点击：一般500-1000ms</li>
</ul>
<h4 data-id="heading-16">3. 内存泄漏问题</h4>
<ul>
<li>确保在组件卸载或不再需要时，清除定时器</li>
<li>使用React的useEffect清理函数或Vue的onUnmounted钩子</li>
</ul>
<h4 data-id="heading-17">4. 函数上下文（this）</h4>
<ul>
<li>在使用防抖和节流时，要注意保持函数的this上下文</li>
<li>使用apply/call/bind来确保this指向正确</li>
</ul>
<h4 data-id="heading-18">5. 传递参数</h4>
<ul>
<li>确保防抖和节流函数能够正确传递参数</li>
<li>在实现时要考虑到不定参数的情况</li>
</ul>
<h3 data-id="heading-19">📝 总结</h3>
<p>防抖和节流是前端开发中非常重要的性能优化手段，它们可以有效地控制函数的执行频率，提升页面性能和用户体验。</p>
<p>通过本文的介绍，我们学习了：</p>
<ol>
<li><strong>基础概念</strong>：防抖（延迟执行）和节流（限制执行频率）</li>
<li><strong>手写实现</strong>：掌握了防抖和节流的核心算法</li>
<li><strong>框架应用</strong>：在React和Vue 3中如何使用自定义Hook/Composable实现</li>
<li><strong>最佳实践</strong>：如何根据场景选择合适的方法，以及使用时的注意事项</li>
</ol>
<p>希望这个小技巧对你有所帮助！下次遇到高频触发的事件时，不妨试试防抖或节流吧～🌸</p>
<hr/>
<p><strong>相关资源：</strong></p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FEvents%2Fresize%23debounce" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/Events/resize#debounce" ref="nofollow noopener noreferrer">MDN - 防抖与节流</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Freact.dev%2Freference%2Freact" target="_blank" title="https://react.dev/reference/react" ref="nofollow noopener noreferrer">React官方文档 - Hooks</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fvuejs.org%2Fguide%2Fextras%2Fcomposition-api-faq.html" target="_blank" title="https://vuejs.org/guide/extras/composition-api-faq.html" ref="nofollow noopener noreferrer">Vue官方文档 - Composition API</a></li>
</ul>
<p><strong>标签：</strong> #前端性能优化 #防抖 #节流 #React #Vue3</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[vxe-table如何实现可编辑下拉框限制唯一选择，就是每一行选择一个选项后，其他行将不可再次选择该选择]]></title>    <link>https://juejin.cn/post/7581779319573332006</link>    <guid>https://juejin.cn/post/7581779319573332006</guid>    <pubDate>2025-12-10T06:20:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581779319573332006" data-draft-id="7581772744376582190" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="vxe-table如何实现可编辑下拉框限制唯一选择，就是每一行选择一个选项后，其他行将不可再次选择该选择"/> <meta itemprop="keywords" content="Vue.js"/> <meta itemprop="datePublished" content="2025-12-10T06:20:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户84179481456"/> <meta itemprop="url" content="https://juejin.cn/user/3921272428567529"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            vxe-table如何实现可编辑下拉框限制唯一选择，就是每一行选择一个选项后，其他行将不可再次选择该选择
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3921272428567529/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户84179481456
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T06:20:31.000Z" title="Wed Dec 10 2025 06:20:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>vxe-table如何实现可编辑下拉框限制唯一选择，就是每一行选择一个选项后，其他行将不可再次选择该选择，实现每行唯一选项效果。</p>
<p>查看官网：<a href="https://link.juejin.cn?target=https%3A%2F%2Fvxetable.cn" target="_blank" title="https://vxetable.cn" ref="nofollow noopener noreferrer">vxetable.cn</a>
gitbub：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fx-extends%2Fvxe-table" target="_blank" title="https://github.com/x-extends/vxe-table" ref="nofollow noopener noreferrer">github.com/x-extends/v…</a>
gitee：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fx-extends%2Fvxe-table" target="_blank" title="https://gitee.com/x-extends/vxe-table" ref="nofollow noopener noreferrer">gitee.com/x-extends/v…</a></p>
<h2 data-id="heading-0">效果</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c5c7f9ebb9c34cf4abab08b16fcf2457~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3ODQxNzk0ODE0NTY=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765952431&amp;x-signature=0%2B%2Bf7JOgDYC9de0L6LMjP%2BIJ3FA%3D" alt="table_edit_unique_select" loading="lazy"/></p>
<p>实现原理就是通过给选项设置 disabled 属性来将已选的设置为禁用状态，也可以直接删除，方式有很多种</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">vxe-toolbar</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">buttons</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">vxe-button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"insertEvent()"</span>&gt;</span>新增<span class="hljs-tag">&lt;/<span class="hljs-name">vxe-button</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">vxe-toolbar</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">vxe-table</span>
      <span class="hljs-attr">border</span>
      <span class="hljs-attr">show-overflow</span>
      <span class="hljs-attr">ref</span>=<span class="hljs-string">"tableRef"</span>
      <span class="hljs-attr">max-height</span>=<span class="hljs-string">"400"</span>
      <span class="hljs-attr">:column-config</span>=<span class="hljs-string">"{resizable: true}"</span>
      <span class="hljs-attr">:data</span>=<span class="hljs-string">"tableData"</span>
      <span class="hljs-attr">:edit-config</span>=<span class="hljs-string">"{trigger: 'click', mode: 'row'}"</span>
      @<span class="hljs-attr">edit-activated</span>=<span class="hljs-string">"editActivatedEvent"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">vxe-column</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"seq"</span> <span class="hljs-attr">width</span>=<span class="hljs-string">"60"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">vxe-column</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">vxe-column</span> <span class="hljs-attr">field</span>=<span class="hljs-string">"name"</span> <span class="hljs-attr">title</span>=<span class="hljs-string">"Name"</span> <span class="hljs-attr">:edit-render</span>=<span class="hljs-string">"{}"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">edit</span>=<span class="hljs-string">"{ row }"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">vxe-input</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"row.name"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">vxe-input</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">vxe-column</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">vxe-column</span> <span class="hljs-attr">field</span>=<span class="hljs-string">"role"</span> <span class="hljs-attr">title</span>=<span class="hljs-string">"Role"</span> <span class="hljs-attr">:edit-render</span>=<span class="hljs-string">"{}"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">default</span>=<span class="hljs-string">"{ row }"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>{{ formatRole(row) }}<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">edit</span>=<span class="hljs-string">"{ row }"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">vxe-select</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"row.role"</span> <span class="hljs-attr">clearable</span> <span class="hljs-attr">transfer</span> @<span class="hljs-attr">change</span>=<span class="hljs-string">"roleChangeEvent"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">vxe-option</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">"item in roleList"</span> <span class="hljs-attr">:key</span>=<span class="hljs-string">"item.value"</span> <span class="hljs-attr">:value</span>=<span class="hljs-string">"item.value"</span> <span class="hljs-attr">:label</span>=<span class="hljs-string">"item.label"</span> <span class="hljs-attr">:disabled</span>=<span class="hljs-string">"item.disabled"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">vxe-option</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">vxe-select</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">vxe-column</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">vxe-column</span> <span class="hljs-attr">field</span>=<span class="hljs-string">"date13"</span> <span class="hljs-attr">title</span>=<span class="hljs-string">"Date"</span> <span class="hljs-attr">:edit-render</span>=<span class="hljs-string">"{}"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">edit</span>=<span class="hljs-string">"{ row }"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">vxe-date-picker</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"row.date13"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"date"</span> <span class="hljs-attr">transfer</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">vxe-date-picker</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">vxe-column</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">vxe-table</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { ref, nextTick } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">const</span> tableRef = <span class="hljs-title function_">ref</span>()

<span class="hljs-keyword">const</span> tableData = <span class="hljs-title function_">ref</span>([
  { <span class="hljs-attr">id</span>: <span class="hljs-number">10001</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'Test1'</span>, <span class="hljs-attr">nickname</span>: <span class="hljs-string">'T1'</span>, <span class="hljs-attr">role</span>: <span class="hljs-string">'1'</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">28</span>, <span class="hljs-attr">address</span>: <span class="hljs-string">'Shenzhen'</span>, <span class="hljs-attr">date12</span>: <span class="hljs-string">''</span>, <span class="hljs-attr">date13</span>: <span class="hljs-string">''</span> },
  { <span class="hljs-attr">id</span>: <span class="hljs-number">10002</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'Test2'</span>, <span class="hljs-attr">nickname</span>: <span class="hljs-string">'T2'</span>, <span class="hljs-attr">role</span>: <span class="hljs-string">'2'</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">22</span>, <span class="hljs-attr">address</span>: <span class="hljs-string">'Guangzhou'</span>, <span class="hljs-attr">date12</span>: <span class="hljs-string">''</span>, <span class="hljs-attr">date13</span>: <span class="hljs-string">'2020-08-20'</span> }
])

<span class="hljs-keyword">const</span> roleList = <span class="hljs-title function_">ref</span>([
  { <span class="hljs-attr">label</span>: <span class="hljs-string">'前端'</span>, <span class="hljs-attr">value</span>: <span class="hljs-string">'1'</span>, <span class="hljs-attr">disabled</span>: <span class="hljs-literal">false</span> },
  { <span class="hljs-attr">label</span>: <span class="hljs-string">'后端'</span>, <span class="hljs-attr">value</span>: <span class="hljs-string">'2'</span>, <span class="hljs-attr">disabled</span>: <span class="hljs-literal">false</span> },
  { <span class="hljs-attr">label</span>: <span class="hljs-string">'项目经理'</span>, <span class="hljs-attr">value</span>: <span class="hljs-string">'3'</span>, <span class="hljs-attr">disabled</span>: <span class="hljs-literal">false</span> },
  { <span class="hljs-attr">label</span>: <span class="hljs-string">'设计师'</span>, <span class="hljs-attr">value</span>: <span class="hljs-string">'4'</span>, <span class="hljs-attr">disabled</span>: <span class="hljs-literal">false</span> },
  { <span class="hljs-attr">label</span>: <span class="hljs-string">'运维'</span>, <span class="hljs-attr">value</span>: <span class="hljs-string">'5'</span>, <span class="hljs-attr">disabled</span>: <span class="hljs-literal">false</span> }
])

<span class="hljs-keyword">const</span> <span class="hljs-title function_">formatRole</span> = (<span class="hljs-params">row</span>) =&gt; {
  <span class="hljs-keyword">const</span> item = roleList.<span class="hljs-property">value</span>.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.<span class="hljs-property">value</span> === row.<span class="hljs-property">role</span>)
  <span class="hljs-keyword">return</span> item ? item.<span class="hljs-property">label</span> : row.<span class="hljs-property">role</span>
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">insertEvent</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> $table = tableRef.<span class="hljs-property">value</span>
  <span class="hljs-keyword">if</span> ($table) {
    <span class="hljs-keyword">const</span> record = {}
    $table.<span class="hljs-title function_">insert</span>(record)
  }
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">updateRoleList</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> $table = tableRef.<span class="hljs-property">value</span>
  <span class="hljs-keyword">if</span> ($table) {
    <span class="hljs-comment">// 获取表格中的全量数据</span>
    <span class="hljs-keyword">const</span> fullData = $table.<span class="hljs-title function_">getFullData</span>()
    roleList.<span class="hljs-property">value</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> {
      <span class="hljs-keyword">if</span> (item.<span class="hljs-property">value</span>) {
        <span class="hljs-comment">// 如果当前选项已经被选过，则禁用</span>
        item.<span class="hljs-property">disabled</span> = fullData.<span class="hljs-title function_">some</span>(<span class="hljs-function"><span class="hljs-params">row</span> =&gt;</span> row.<span class="hljs-property">role</span> === item.<span class="hljs-property">value</span>)
      }
    })
  }
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">roleChangeEvent</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-title function_">updateRoleList</span>()
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">editActivatedEvent</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-comment">// 激活编辑时检查剩余选项是否可选择</span>
  <span class="hljs-title function_">updateRoleList</span>()
}
<span class="hljs-title function_">nextTick</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-title function_">updateRoleList</span>()
})
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fx-extends%2Fvxe-table" target="_blank" title="https://gitee.com/x-extends/vxe-table" ref="nofollow noopener noreferrer">gitee.com/x-extends/v…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[别再猜this指向！JS动态绑定的底层逻辑与实战]]></title>    <link>https://juejin.cn/post/7581752508781363243</link>    <guid>https://juejin.cn/post/7581752508781363243</guid>    <pubDate>2025-12-10T06:56:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581752508781363243" data-draft-id="7581761825483472932" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="别再猜this指向！JS动态绑定的底层逻辑与实战"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-12-10T06:56:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="闲云ing"/> <meta itemprop="url" content="https://juejin.cn/user/2974655942502250"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            别再猜this指向！JS动态绑定的底层逻辑与实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2974655942502250/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    闲云ing
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T06:56:36.000Z" title="Wed Dec 10 2025 06:56:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    10
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">别再猜this指向！JS动态绑定的底层逻辑与实战</h2>
<p><code>this</code> 是JavaScript中最容易让人困惑的概念之一——它既不是静态绑定，也不遵循词法作用域规则，而是<strong>由函数的调用方式决定</strong>。本文将结合实战代码案例，从自由变量、执行上下文、调用方式三个维度，彻底拆解<code>this</code>的设计逻辑、指向规则和常见陷阱，让你从根源理解<code>this</code>的本质。</p>
<h3 data-id="heading-1">一、先理清：this vs 自由变量（词法作用域）</h3>
<p>在讲<code>this</code>之前，必须先区分自由变量和<code>this</code>的核心差异——这是理解<code>this</code>的关键前提。</p>
<h4 data-id="heading-2">1. 自由变量：遵循词法作用域（编译阶段确定）</h4>
<p>自由变量指“函数内部使用，但既不是参数也不是局部变量”的变量，其查找规则是<strong>沿着词法作用域链（Outer）向上找</strong>，由函数<strong>声明的位置</strong>决定，与调用方式无关。</p>
<h5 data-id="heading-3">实战代码解析：自由变量的查找</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-meta">'use strict'</span>
<span class="hljs-comment">// 全局作用域定义对象bar</span>
<span class="hljs-keyword">var</span> bar = { 
  <span class="hljs-attr">myName</span>: <span class="hljs-string">"time.geekbang.com"</span>,
  <span class="hljs-attr">printName</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">//  自由变量：myName既不是参数，也不是局部变量</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(myName); <span class="hljs-comment">// 输出：极客邦（全局作用域的myName）</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(bar.<span class="hljs-property">myName</span>); <span class="hljs-comment">// 输出：time.geekbang.com（对象属性）</span>
    
    <span class="hljs-comment">//  this：与自由变量无关，由调用方式决定</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>); 
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">myName</span>);
  }
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">foo</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">let</span> myName = <span class="hljs-string">'极客时间'</span> <span class="hljs-comment">// 函数内局部变量</span>
  <span class="hljs-keyword">return</span> bar.<span class="hljs-property">printName</span> <span class="hljs-comment">// 返回函数引用</span>
}

<span class="hljs-comment">// 全局作用域定义自由变量myName</span>
<span class="hljs-keyword">var</span> myName = <span class="hljs-string">'极客邦'</span>
<span class="hljs-keyword">var</span> _printName = <span class="hljs-title function_">foo</span>();

<span class="hljs-comment">// 调用场景1：普通函数调用</span>
<span class="hljs-title function_">_printName</span>(); 
<span class="hljs-comment">// 自由变量myName：找全局的「极客邦」（词法作用域决定）</span>
<span class="hljs-comment">// this：指向window（普通函数调用规则）</span>
<span class="hljs-comment">// this.myName：window.myName → 极客邦</span>

<span class="hljs-comment">// 调用场景2：对象方法调用</span>
bar.<span class="hljs-title function_">printName</span>();
<span class="hljs-comment">// 自由变量myName：依然是全局的「极客邦」（词法作用域不变）</span>
<span class="hljs-comment">// this：指向bar对象（方法调用规则）</span>
<span class="hljs-comment">// this.myName：bar.myName → time.geekbang.com</span>
</code></pre>
<h5 data-id="heading-4">核心结论：</h5>
<ul>
<li>自由变量的查找路径在<strong>编译阶段</strong>就已确定（词法作用域），无论函数怎么调用，查找规则不变；</li>
<li><code>this</code>的指向在<strong>执行阶段</strong>确定，由函数的调用方式决定——这是JS设计上的“特殊点”。</li>
</ul>
<h4 data-id="heading-5">2. this的设计背景：为什么需要this？</h4>
<p>JS早期没有<code>class</code>语法，要实现面向对象（OOP），需要一种机制让“对象的方法能访问对象自身的属性”。<code>this</code>就是这个机制：<strong>在对象方法内部，通过this指向对象本身，从而访问对象属性</strong>。</p>
<p>但JS的设计有个“缺陷”：<code>this</code>的指向不是固定的——它不绑定到函数本身，而是绑定到调用上下文，这也是<code>this</code>容易混乱的根源。</p>
<h3 data-id="heading-6">二、this的核心规则：调用方式决定指向</h3>
<p><code>this</code>的指向只有一个核心原则：<strong>谁调用函数，this就指向谁</strong>。以下是5种常见调用场景，结合代码逐一解析。</p>
<h4 data-id="heading-7">场景1：普通函数调用 → this指向全局对象（非严格模式）</h4>
<p>普通函数调用指“直接调用函数名”，非严格模式下<code>this</code>指向全局对象（浏览器中是<code>window</code>），严格模式下<code>this</code>为<code>undefined</code>。</p>
<h5 data-id="heading-8">代码解析：</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">foo</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>); <span class="hljs-comment">// 输出：window（非严格模式）</span>
}
<span class="hljs-title function_">foo</span>() <span class="hljs-comment">// 等价于 window.foo() → 全局对象调用</span>

<span class="hljs-comment">// 严格模式下</span>
<span class="hljs-meta">'use strict'</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">bar</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>); <span class="hljs-comment">// 输出：undefined</span>
}
<span class="hljs-title function_">bar</span>()
</code></pre>
<h5 data-id="heading-9">关键细节：</h5>
<ul>
<li><code>var</code>声明的全局变量会挂载到<code>window</code>上（如<code>var myName = '极客邦'</code> → <code>window.myName = '极客邦'</code>），容易造成全局污染；</li>
<li><code>let/const</code>声明的全局变量不会挂载到<code>window</code>上，这是ES6的优化；</li>
<li>严格模式下禁止“无意义的this指向全局”，直接设为<code>undefined</code>，规避全局污染问题。</li>
</ul>
<h4 data-id="heading-10">场景2：对象方法调用 → this指向调用对象</h4>
<p>当函数作为对象的方法被调用时，<code>this</code>指向该对象（即“调用者”）。</p>
<h5 data-id="heading-11">代码解析：</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">var</span> myObj = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">"极客时间"</span>,
  <span class="hljs-attr">showThis</span>:<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>); <span class="hljs-comment">// 输出：myObj对象</span>
  }
}
myObj.<span class="hljs-title function_">showThis</span>(); <span class="hljs-comment">// myObj调用方法 → this指向myObj</span>

<span class="hljs-comment">// 陷阱：方法被赋值给变量后，变为普通函数调用</span>
<span class="hljs-keyword">var</span> foo = myObj.<span class="hljs-property">showThis</span>;
<span class="hljs-title function_">foo</span>(); <span class="hljs-comment">// 普通函数调用 → this指向window（非严格模式）</span>
</code></pre>
<h5 data-id="heading-12">核心陷阱：</h5>
<ul>
<li>函数的“方法身份”只在调用时生效，一旦将方法赋值给变量，函数就变回“普通函数”，<code>this</code>指向全局；</li>
<li>例：<code>myObj.showThis()</code>是方法调用（this→myObj），<code>foo()</code>是普通调用（this→window）。</li>
</ul>
<h4 data-id="heading-13">场景3：call/apply调用 → this指向第一个参数</h4>
<p><code>call</code>和<code>apply</code>是显式绑定<code>this</code>的方法，第一个参数就是<code>this</code>的指向（若传<code>null/undefined</code>，非严格模式下指向window）。</p>
<h5 data-id="heading-14">代码解析：</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">let</span> bar = {
  <span class="hljs-attr">myName</span>: <span class="hljs-string">"极客邦"</span>,
  <span class="hljs-attr">text1</span>: <span class="hljs-number">1</span>
}
<span class="hljs-keyword">function</span> <span class="hljs-title function_">foo</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">myName</span> = <span class="hljs-string">"极客时间"</span> <span class="hljs-comment">// this指向call/apply的第一个参数</span>
}

<span class="hljs-comment">// 显式绑定this为bar</span>
foo.<span class="hljs-title function_">call</span>(bar); 
<span class="hljs-comment">// 等价写法：foo.apply(bar);</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(bar); <span class="hljs-comment">// 输出：{myName: '极客时间', text1: 1}</span>
</code></pre>
<h5 data-id="heading-15">call vs apply：</h5>
<ul>
<li>相同点：第一个参数都是<code>this</code>指向，都立即执行函数；</li>
<li>不同点：参数传递方式——<code>call</code>传多个参数（<code>foo.call(bar, 1, 2)</code>），<code>apply</code>传数组（<code>foo.apply(bar, [1, 2])</code>）。</li>
</ul>
<h4 data-id="heading-16">场景4：构造函数调用（new）→ this指向实例对象</h4>
<p><code>new</code>运算符会创建一个新对象，构造函数内的<code>this</code>指向这个新实例（模拟<code>new</code>的代码能更直观理解）。</p>
<h5 data-id="heading-17">代码解析：模拟new的this指向</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">CreateObj</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 手动模拟new的核心逻辑</span>
  <span class="hljs-comment">// 1. 创建空对象</span>
  <span class="hljs-keyword">var</span> temObj = {}
  <span class="hljs-comment">// 2. 绑定this为temObj</span>
  <span class="hljs-title class_">CreateObj</span>.<span class="hljs-title function_">call</span>(temObj)
  <span class="hljs-comment">// 3. 关联原型链</span>
  temObj.<span class="hljs-property">__proto__</span> = <span class="hljs-title class_">CreateObj</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>
  <span class="hljs-comment">// 4. 返回实例</span>
  <span class="hljs-keyword">return</span> temObj
  
  <span class="hljs-comment">// 原生new中，构造函数内的this指向新实例</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>); <span class="hljs-comment">// new调用时，this→myObj</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = <span class="hljs-string">'极客时间'</span>
}
<span class="hljs-keyword">var</span> myObj = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CreateObj</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(myObj.<span class="hljs-property">name</span>); <span class="hljs-comment">// 输出：极客时间</span>
</code></pre>
<h5 data-id="heading-18">原生new的this规则：</h5>
<ul>
<li><code>new Constructor()</code>会创建新对象，构造函数内的<code>this</code>指向该对象；</li>
<li>构造函数无需手动返回对象，<code>new</code>会自动返回这个绑定了<code>this</code>的实例。</li>
</ul>
<h4 data-id="heading-19">场景5：事件处理函数 → this指向绑定元素</h4>
<p>DOM事件处理函数中，<code>this</code>指向触发事件的元素（即事件绑定的DOM节点）。</p>
<h5 data-id="heading-20">代码解析：</h5>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Document<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"#"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"link"</span>&gt;</span>点击我<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'link'</span>)
      .<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>,<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>);
      })
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<h5 data-id="heading-21">核心逻辑：</h5>
<ul>
<li>事件处理函数由DOM元素触发调用，因此<code>this</code>指向该元素；</li>
<li>若事件处理函数是箭头函数，<code>this</code>会继承外层作用域的<code>this</code>（箭头函数无自身this）。</li>
</ul>
<h3 data-id="heading-22">三、从执行上下文视角理解this</h3>
<p>JS执行代码时会创建「执行上下文」，每个执行上下文包含：</p>
<ul>
<li>变量环境：存储变量、函数声明；</li>
<li>词法环境：存储let/const声明；</li>
<li><code>this</code>绑定：存储this的指向。</li>
</ul>
<h4 data-id="heading-23">执行上下文的this绑定规则：</h4>
<ol>
<li>
<p>全局执行上下文：<code>this</code>指向全局对象（window）；</p>
</li>
<li>
<p>函数执行上下文：<code>this</code>的绑定在<strong>函数调用时</strong>确定，而非创建时；</p>
<ol>
<li>普通调用：this→window（非严格模式）；</li>
<li>方法调用：this→调用对象；</li>
<li>call/apply调用：this→第一个参数；</li>
<li>new调用：this→新实例。</li>
</ol>
</li>
</ol>
<h4 data-id="heading-24">关键对比：</h4>




















<table><thead><tr><th>概念</th><th>确定阶段</th><th>决定因素</th></tr></thead><tbody><tr><td>词法作用域</td><td>编译阶段</td><td>函数声明的位置</td></tr><tr><td>this绑定</td><td>执行阶段</td><td>函数的调用方式</td></tr></tbody></table>
<h3 data-id="heading-25">四、this的常见陷阱与避坑技巧</h3>
<h4 data-id="heading-26">陷阱1：方法赋值后this指向全局</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">var</span> obj = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'极客时间'</span>,
  <span class="hljs-attr">fn</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span>);
  }
}
<span class="hljs-keyword">var</span> fn = obj.<span class="hljs-property">fn</span>;
<span class="hljs-title function_">fn</span>(); <span class="hljs-comment">// 输出：undefined（this→window，window.name为空）</span>
</code></pre>
<p><strong>避坑</strong>：用<code>bind</code>永久绑定this → <code>var fn = obj.fn.bind(obj)</code>。</p>
<h4 data-id="heading-27">陷阱2：嵌套函数的this指向</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">var</span> obj = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'极客时间'</span>,
  <span class="hljs-attr">fn</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">inner</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span>); <span class="hljs-comment">// this→window</span>
    }
    <span class="hljs-title function_">inner</span>();
  }
}
obj.<span class="hljs-title function_">fn</span>(); <span class="hljs-comment">// 输出：undefined</span>
</code></pre>
<p><strong>避坑</strong>：</p>
<ol>
<li>用变量保存外部this → <code>var that = this; inner中用that.name</code>；</li>
<li>用箭头函数（继承外层this）→ <code>const inner = () =&gt; { console.log(this.name) }</code>。</li>
</ol>
<h4 data-id="heading-28">陷阱3：严格模式下的this</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-meta">'use strict'</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">fn</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>); <span class="hljs-comment">// undefined</span>
}
<span class="hljs-title function_">fn</span>(); <span class="hljs-comment">// 普通调用 → this≠window</span>
</code></pre>
<p><strong>避坑</strong>：严格模式下避免依赖“this指向全局”的逻辑，显式绑定this。</p>
<h3 data-id="heading-29">五、总结：this的核心记忆法则</h3>
<ol>
<li>
<p><strong>核心原则</strong>：谁调用，this指向谁；</p>
</li>
<li>
<p><strong>特殊场景</strong>：</p>
<ol>
<li>普通函数调用：非严格模式→window，严格模式→undefined；</li>
<li>call/apply/bind：显式绑定this，优先级最高；</li>
<li>new调用：this指向新实例；</li>
<li>箭头函数：无自身this，继承外层作用域的this；</li>
</ol>
</li>
<li>
<p><strong>与词法作用域的区别</strong>：</p>
<ol>
<li>自由变量：编译阶段确定，找声明位置的外层作用域；</li>
<li>this：执行阶段确定，看调用方式。</li>
</ol>
</li>
</ol>
<p>理解<code>this</code>的关键是“放弃静态绑定的思维”——不要试图在函数声明时确定<code>this</code>，而是看函数<strong>被调用的那一刻</strong>：谁是调用者，<code>this</code>就指向谁。掌握这一点，就能轻松应对<code>this</code>场景了。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【React Native】渐变骨架屏组件SkeletonElement]]></title>    <link>https://juejin.cn/post/7581876069607997483</link>    <guid>https://juejin.cn/post/7581876069607997483</guid>    <pubDate>2025-12-10T07:08:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581876069607997483" data-draft-id="7581789701532434474" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【React Native】渐变骨架屏组件SkeletonElement"/> <meta itemprop="keywords" content="React Native"/> <meta itemprop="datePublished" content="2025-12-10T07:08:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="冰冷的bin"/> <meta itemprop="url" content="https://juejin.cn/user/3529908468333692"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【React Native】渐变骨架屏组件SkeletonElement
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3529908468333692/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    冰冷的bin
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T07:08:50.000Z" title="Wed Dec 10 2025 07:08:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">React Native 渐变骨架屏组件 <code>SkeletonElement</code> 使用指南</h2>
<h3 data-id="heading-1">一、前言</h3>
<p>在移动端开发中，数据加载过程中的空白等待会显著降低用户体验。<strong>骨架屏（Skeleton Screen）</strong> 是一种广受推崇的加载策略：它通过渲染与真实内容结构一致的灰色占位块，在数据返回前给予用户明确的视觉反馈。</p>
<p>本文提供一个轻量、高性能、支持自定义样式的 <code>SkeletonElement</code> 组件，适用于任何需要占位展示的 UI 元素。</p>
<hr/>
<h3 data-id="heading-2">二、组件特性</h3>
<ul>
<li><strong>完全自定义样式</strong>：通过 <code>style</code> 属性控制尺寸、方向、间距等</li>
<li><strong>流畅渐变动画</strong>：使用 <code>Animated</code> 实现原生驱动的高帧率闪烁效果</li>
<li><strong>轻量无依赖</strong>：仅基于 React Native 内置模块，零第三方依赖</li>
<li><strong>灵活配色</strong>：支持自定义背景色和高亮色</li>
<li><strong>自动清理</strong>：组件卸载时自动停止动画，防止内存泄漏</li>
</ul>
<hr/>
<h3 data-id="heading-3">三、快速上手</h3>
<pre><code class="hljs language-tsx" lang="tsx">&lt;<span class="hljs-title class_">View</span>&gt;
  {<span class="hljs-comment">/* 标题骨架 */</span>}
  &lt;<span class="hljs-title class_">SkeletonElement</span> style={{ <span class="hljs-attr">height</span>: <span class="hljs-number">24</span>, <span class="hljs-attr">width</span>: <span class="hljs-string">'80%'</span>, <span class="hljs-attr">marginBottom</span>: <span class="hljs-number">16</span> }} /&gt;
  
  {<span class="hljs-comment">/* 多行文本骨架 */</span>}
  &lt;<span class="hljs-title class_">SkeletonElement</span> style={{ <span class="hljs-attr">height</span>: <span class="hljs-number">16</span>, <span class="hljs-attr">width</span>: <span class="hljs-string">'100%'</span>, <span class="hljs-attr">marginBottom</span>: <span class="hljs-number">8</span> }} /&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">SkeletonElement</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">height:</span> <span class="hljs-attr">16</span>, <span class="hljs-attr">width:</span> '<span class="hljs-attr">90</span>%', <span class="hljs-attr">marginBottom:</span> <span class="hljs-attr">8</span> }} /&gt;</span></span>
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">SkeletonElement</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">height:</span> <span class="hljs-attr">16</span>, <span class="hljs-attr">width:</span> '<span class="hljs-attr">95</span>%' }} /&gt;</span></span>
  
  {<span class="hljs-comment">/* 按钮骨架 */</span>}
  &lt;<span class="hljs-title class_">SkeletonElement</span> 
    style={{ 
      <span class="hljs-attr">height</span>: <span class="hljs-number">48</span>, 
      <span class="hljs-attr">width</span>: <span class="hljs-string">'50%'</span>, 
      <span class="hljs-attr">borderRadius</span>: <span class="hljs-number">24</span>, 
      <span class="hljs-attr">alignSelf</span>: <span class="hljs-string">'center'</span>,
      <span class="hljs-attr">marginTop</span>: <span class="hljs-number">20</span> 
    }} 
  /&gt;
&lt;/<span class="hljs-title class_">View</span>&gt;
</code></pre>
<hr/>
<h3 data-id="heading-4">四、API 说明</h3>
<h4 data-id="heading-5">Props</h4>



































<table><thead><tr><th>属性</th><th>类型</th><th>默认值</th><th>说明</th></tr></thead><tbody><tr><td><code>style</code></td><td><code>StyleProp&lt;ViewStyle&gt;</code></td><td><code>undefined</code></td><td>自定义骨架样式（宽高、方向、圆角等）</td></tr><tr><td><code>backgroundColor</code></td><td><code>string</code></td><td><code>#E4E4E4</code></td><td>骨架背景色</td></tr><tr><td><code>highlightColor</code></td><td><code>string</code></td><td><code>#D0D0D0</code></td><td>高亮闪烁色（较背景色稍亮）</td></tr><tr><td><code>speed</code></td><td><code>number</code></td><td><code>1600</code></td><td>完整闪烁周期（毫秒），值越小动画越快</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-6">五、源码解析</h3>
<h4 data-id="heading-7">核心逻辑</h4>
<ol>
<li><strong>动画驱动</strong>：使用 <code>useRef(new Animated.Value(0.4))</code> 创建不触发重渲染的动画值</li>
<li><strong>循环闪烁</strong>：通过 <code>Animated.loop + Animated.sequence</code> 实现“暗→亮→暗”的循环</li>
<li><strong>性能优化</strong>：启用 <code>useNativeDriver: true</code>，动画在原生线程运行</li>
<li><strong>资源清理</strong>：<code>useEffect</code> 返回清理函数，确保组件卸载时停止动画</li>
</ol>
<h4 data-id="heading-8">关键代码片段</h4>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> opacityValue = <span class="hljs-title function_">useRef</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Animated</span>.<span class="hljs-title class_">Value</span>(<span class="hljs-number">0.4</span>)).<span class="hljs-property">current</span>;

<span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-title class_">Animated</span>.<span class="hljs-title function_">loop</span>(
    <span class="hljs-title class_">Animated</span>.<span class="hljs-title function_">sequence</span>([
      <span class="hljs-title class_">Animated</span>.<span class="hljs-title function_">timing</span>(opacityValue, { <span class="hljs-attr">toValue</span>: <span class="hljs-number">1</span>, ... }),
      <span class="hljs-title class_">Animated</span>.<span class="hljs-title function_">timing</span>(opacityValue, { <span class="hljs-attr">toValue</span>: <span class="hljs-number">0.4</span>, ... })
    ])
  ).<span class="hljs-title function_">start</span>();

  <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> opacityValue.<span class="hljs-title function_">stopAnimation</span>();
}, [opacityValue, speed]);
</code></pre>
<hr/>
<h3 data-id="heading-9">六、完整源码</h3>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, {useEffect, useRef} <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> {<span class="hljs-title class_">Animated</span>, <span class="hljs-title class_">Easing</span>, <span class="hljs-title class_">StyleProp</span>, <span class="hljs-title class_">View</span>, <span class="hljs-title class_">ViewStyle</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'react-native'</span>;

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">SkeletonElementProps</span> {
  style?: <span class="hljs-title class_">StyleProp</span>&lt;<span class="hljs-title class_">ViewStyle</span>&gt;;
  backgroundColor?: <span class="hljs-built_in">string</span>;
  highlightColor?: <span class="hljs-built_in">string</span>;
  speed?: <span class="hljs-built_in">number</span>;
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">SkeletonElement</span>: <span class="hljs-title class_">React</span>.<span class="hljs-property">FC</span>&lt;<span class="hljs-title class_">SkeletonElementProps</span>&gt; = <span class="hljs-function">(<span class="hljs-params">{
  style,
  backgroundColor = <span class="hljs-string">'#E4E4E4'</span>,
  highlightColor = <span class="hljs-string">'#D0D0D0'</span>,
  speed = <span class="hljs-number">1600</span>,
}</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">useSkeletonAnimation</span> = (<span class="hljs-params">speed: <span class="hljs-built_in">number</span></span>) =&gt; {
    <span class="hljs-keyword">const</span> opacityValue = <span class="hljs-title function_">useRef</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Animated</span>.<span class="hljs-title class_">Value</span>(<span class="hljs-number">0.4</span>)).<span class="hljs-property">current</span>;

    <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-title class_">Animated</span>.<span class="hljs-title function_">loop</span>(
        <span class="hljs-title class_">Animated</span>.<span class="hljs-title function_">sequence</span>([
          <span class="hljs-title class_">Animated</span>.<span class="hljs-title function_">timing</span>(opacityValue, {
            <span class="hljs-attr">toValue</span>: <span class="hljs-number">1</span>,
            <span class="hljs-attr">duration</span>: speed / <span class="hljs-number">2</span>,
            <span class="hljs-attr">easing</span>: <span class="hljs-title class_">Easing</span>.<span class="hljs-title function_">inOut</span>(<span class="hljs-title class_">Easing</span>.<span class="hljs-property">ease</span>),
            <span class="hljs-attr">useNativeDriver</span>: <span class="hljs-literal">true</span>,
          }),
          <span class="hljs-title class_">Animated</span>.<span class="hljs-title function_">timing</span>(opacityValue, {
            <span class="hljs-attr">toValue</span>: <span class="hljs-number">0.4</span>,
            <span class="hljs-attr">duration</span>: speed / <span class="hljs-number">2</span>,
            <span class="hljs-attr">easing</span>: <span class="hljs-title class_">Easing</span>.<span class="hljs-title function_">inOut</span>(<span class="hljs-title class_">Easing</span>.<span class="hljs-property">ease</span>),
            <span class="hljs-attr">useNativeDriver</span>: <span class="hljs-literal">true</span>,
          }),
        ]),
      ).<span class="hljs-title function_">start</span>();

      <span class="hljs-comment">// 返回清理函数</span>
      <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
        opacityValue.<span class="hljs-title function_">stopAnimation</span>();
      };
    }, [opacityValue, speed]);

    <span class="hljs-keyword">return</span> opacityValue;
  };

  <span class="hljs-keyword">const</span> opacityValue = <span class="hljs-title function_">useSkeletonAnimation</span>(speed);

  <span class="hljs-comment">// 合并样式</span>
  <span class="hljs-keyword">const</span> <span class="hljs-attr">skeletonStyle</span>: <span class="hljs-title class_">ViewStyle</span> = {
    backgroundColor,
    <span class="hljs-attr">overflow</span>: <span class="hljs-string">'hidden'</span>,
    <span class="hljs-attr">position</span>: <span class="hljs-string">'relative'</span>,
    ...(style <span class="hljs-keyword">as</span> <span class="hljs-title class_">ViewStyle</span>),
  };

  <span class="hljs-comment">// 添加渐变动画效果</span>
  <span class="hljs-keyword">const</span> highlightOverlay = (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Animated.View</span>
      <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span>
        <span class="hljs-attr">position:</span> '<span class="hljs-attr">absolute</span>',
        <span class="hljs-attr">top:</span> <span class="hljs-attr">0</span>,
        <span class="hljs-attr">left:</span> <span class="hljs-attr">0</span>,
        <span class="hljs-attr">right:</span> <span class="hljs-attr">0</span>,
        <span class="hljs-attr">bottom:</span> <span class="hljs-attr">0</span>,
        <span class="hljs-attr">backgroundColor:</span> <span class="hljs-attr">highlightColor</span>,
        <span class="hljs-attr">opacity:</span> <span class="hljs-attr">opacityValue</span>,
      }}
    /&gt;</span></span>
  );

  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">View</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{skeletonStyle}</span>&gt;</span>{highlightOverlay}<span class="hljs-tag">&lt;/<span class="hljs-name">View</span>&gt;</span></span>;
};
</code></pre>
<blockquote>
<p>💡 <strong>提示</strong>：将此组件与条件渲染结合，即可实现优雅的数据加载过渡：</p>
<pre><code class="hljs language-tsx" lang="tsx">{loading ? <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">SkeletonElement</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">height:</span> <span class="hljs-attr">200</span> }} /&gt;</span></span> : <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">RealContent</span> /&gt;</span></span>}
</code></pre>
</blockquote>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue 3 页面缓存机制深度实践：从原理到落地]]></title>    <link>https://juejin.cn/post/7581828086020210703</link>    <guid>https://juejin.cn/post/7581828086020210703</guid>    <pubDate>2025-12-10T07:08:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581828086020210703" data-draft-id="7581844141669040168" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue 3 页面缓存机制深度实践：从原理到落地"/> <meta itemprop="keywords" content="前端,Vue.js,架构"/> <meta itemprop="datePublished" content="2025-12-10T07:08:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="大象的鼻子那么长"/> <meta itemprop="url" content="https://juejin.cn/user/2277843821926871"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue 3 页面缓存机制深度实践：从原理到落地
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2277843821926871/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    大象的鼻子那么长
  </span> <!----> <!----> <div class="vip-level" data-v-cd7d0a50="" data-v-292f6e48=""><span class="tooltip" data-v-cd7d0a50=""><div class="byte-tooltip byte-tooltip--dark" style="display:none;">
        VIP.4 融会贯通
      </div><span class="byte-tooltip__wrapper"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8AQMAAAAAMksxAAAAA1BMVEUAAACnej3aAAAAAXRSTlMAQObYZgAAAA5JREFUKM9jGAWjAAcAAAIcAAE27nY6AAAAAElFTkSuQmCC" alt="VIP.4 融会贯通" title="VIP.4 融会贯通" class="lazy" style="aspect-ratio:NaN;" data-v-5244ef91="" data-v-cd7d0a50=""/></span></span></div> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T07:08:24.000Z" title="Wed Dec 10 2025 07:08:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><strong>日期</strong>: 2025-12-10<br/>
<strong>标签</strong>: Vue3, Keep-Alive, 性能优化, 用户体验, Composition API</p>
</blockquote>
<hr/>
<h2 data-id="heading-0">📖 引言</h2>
<p>在企业级中后台应用中，用户经常需要在列表页和详情页之间频繁切换。每次返回列表页都要重新加载数据、丢失查询条件，这种体验让人抓狂。</p>
<p>本文将深入探讨 Vue 3 的 <code>keep-alive</code> 机制，并分享一套<strong>完整的页面缓存管理方案</strong>，包含：</p>
<ul>
<li>🎯 keep-alive 的工作原理和核心概念</li>
<li>🛠️ 可复用的 Composable 封装</li>
<li>📊 真实项目中的性能收益数据</li>
<li>⚠️ 常见坑点和解决方案</li>
</ul>
<hr/>
<h2 data-id="heading-1">一、是什么：Keep-Alive 核心概念</h2>
<h3 data-id="heading-2">1.1 什么是 Keep-Alive？</h3>
<p><code>&lt;keep-alive&gt;</code> 是 Vue 内置的抽象组件，用于<strong>缓存不活动的组件实例</strong>，而不是销毁它们。</p>
<pre><code class="hljs language-css" lang="css">普通组件切换流程：
┌─────────┐     ┌─────────┐     ┌─────────┐
│ 组件 <span class="hljs-selector-tag">A</span>  │ ──▶ │ 销毁 <span class="hljs-selector-tag">A</span>  │ ──▶ │ 创建 <span class="hljs-selector-tag">B</span>  │
└─────────┘     └─────────┘     └─────────┘

keep-alive 组件切换流程：
┌─────────┐     ┌─────────┐     ┌─────────┐
│ 组件 <span class="hljs-selector-tag">A</span>  │ ──▶ │ 缓存 <span class="hljs-selector-tag">A</span>  │ ──▶ │ 创建 <span class="hljs-selector-tag">B</span>  │
└─────────┘     └─────────┘     └─────────┘
                     │
                     ▼ 返回时
               ┌─────────┐
               │ 恢复 <span class="hljs-selector-tag">A</span>  │  ← 直接从缓存恢复，无需重新创建
               └─────────┘
</code></pre>
<h3 data-id="heading-3">1.2 生命周期变化</h3>
<p>使用 keep-alive 后，组件会获得两个新的生命周期钩子：</p>




















<table><thead><tr><th>钩子</th><th>触发时机</th><th>典型用途</th></tr></thead><tbody><tr><td><code>onActivated</code></td><td>组件被激活（从缓存恢复）</td><td>刷新数据、恢复滚动位置</td></tr><tr><td><code>onDeactivated</code></td><td>组件被停用（进入缓存）</td><td>保存状态、清理定时器</td></tr></tbody></table>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { onActivated, onDeactivated, onMounted } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-comment">// 首次挂载</span>
<span class="hljs-title function_">onMounted</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'组件首次创建'</span>)
  <span class="hljs-title function_">loadData</span>()
})

<span class="hljs-comment">// 从缓存恢复时触发（首次挂载不触发）</span>
<span class="hljs-title function_">onActivated</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'页面从缓存恢复'</span>)
})

<span class="hljs-comment">// 进入缓存时触发</span>
<span class="hljs-title function_">onDeactivated</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'页面进入缓存'</span>)
})
</code></pre>
<h3 data-id="heading-4">1.3 include/exclude 匹配机制</h3>
<p><code>keep-alive</code> 通过 <code>include</code> 属性控制哪些组件需要缓存，匹配规则是：<strong>组件的 <code>name</code> 属性</strong>。</p>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- 只缓存名为 ListView 和 DetailView 的组件 --&gt;
&lt;keep-alive :include="['ListView', 'DetailView']"&gt;
  &lt;router-view /&gt;
&lt;/keep-alive&gt;
</code></pre>
<p>⚠️ <strong>关键坑点</strong>：Vue 3 <code>&lt;script setup&gt;</code> 组件<strong>默认没有 <code>name</code></strong>，必须使用 <code>defineOptions</code> 显式定义：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- ❌ 错误：没有定义 name，keep-alive 无法匹配 --&gt;
&lt;script setup lang="ts"&gt;
// 组件逻辑...
&lt;/script&gt;

&lt;!-- ✅ 正确：使用 defineOptions 定义组件名称 --&gt;
&lt;script setup lang="ts"&gt;
defineOptions({
  name: 'ListView', // 必须与路由 name 一致
})
// 组件逻辑...
&lt;/script&gt;
</code></pre>
<hr/>
<h2 data-id="heading-5">二、为什么：业务痛点与价值分析</h2>
<h3 data-id="heading-6">2.1 用户体验痛点</h3>
<p>在没有页面缓存的情况下，用户会遇到以下问题：</p>






























<table><thead><tr><th>场景</th><th>痛点</th><th>用户感受</th></tr></thead><tbody><tr><td>列表→详情→返回</td><td>列表重新加载，滚动位置丢失</td><td>😤 每次都要重新翻页</td></tr><tr><td>复杂查询条件</td><td>返回后条件全部丢失</td><td>😤 又要重新选一遍</td></tr><tr><td>大数据量表格</td><td>每次进入等待 1-2 秒</td><td>😤 系统好慢</td></tr><tr><td>Tab 切换</td><td>切换后数据重新加载</td><td>😤 明明刚看过</td></tr></tbody></table>
<h3 data-id="heading-7">2.2 性能收益实测</h3>
<p>基于真实项目的测试数据：</p>





























<table><thead><tr><th>指标</th><th>优化前</th><th>优化后</th><th>提升幅度</th></tr></thead><tbody><tr><td>页面切换时间</td><td>800-1200ms</td><td><strong>&lt; 50ms</strong></td><td><strong>95%+</strong></td></tr><tr><td>API 请求次数</td><td>每次进入都请求</td><td>仅首次请求</td><td><strong>70%+</strong></td></tr><tr><td>用户等待感知</td><td>明显等待</td><td><strong>瞬间切换</strong></td><td>体验质变</td></tr></tbody></table>
<h3 data-id="heading-8">2.3 业务价值</h3>
<ul>
<li><strong>效率提升</strong>：操作人员每天处理数百单，减少等待时间直接提升工作效率</li>
<li><strong>服务器压力降低</strong>：减少 70% 的重复 API 请求</li>
<li><strong>用户满意度</strong>：流畅的操作体验提升系统好评度</li>
</ul>
<hr/>
<h2 data-id="heading-9">三、怎么做：完整实现方案</h2>
<h3 data-id="heading-10">3.1 架构设计</h3>
<pre><code class="hljs language-ruby" lang="ruby">┌─────────────────────────────────────────────────────────────┐
│                    页面缓存管理架构                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   ┌──────────────┐    ┌──────────────┐    ┌──────────────┐ │
│   │   路由配置    │    │ <span class="hljs-title class_">KeepAlive</span>   │    │  usePageCache │ │
│   │ meta.keepAlive│───▶│   <span class="hljs-title class_">Store</span>     │◀───│  <span class="hljs-title class_">Composable</span>   │ │
│   └──────────────┘    └──────────────┘    └──────────────┘ │
│          │                   │                   │         │
│          ▼                   ▼                   ▼         │
│   ┌──────────────────────────────────────────────────────┐ │
│   │                   <span class="hljs-title class_">Layout</span> 组件                         │ │
│   │  &lt;keep-alive <span class="hljs-symbol">:include=<span class="hljs-string">"cachedViews"</span></span> <span class="hljs-symbol">:max=<span class="hljs-string">"15"</span>&gt;</span>       │ │
│   │    &lt;router-view /&gt;                                   │ │
│   │  &lt;<span class="hljs-regexp">/keep-alive&gt;                                       │ │
│   └──────────────────────────────────────────────────────┘ │
│                                                             │
└─────────────────────────────────────────────────────────────┘
</span></code></pre>
<p><strong>核心思路</strong>：</p>
<ol>
<li><strong>路由配置</strong>：通过 <code>meta.keepAlive</code> 声明哪些页面需要缓存</li>
<li><strong>Pinia Store</strong>：集中管理缓存列表，支持动态增删</li>
<li><strong>Composable</strong>：封装缓存相关逻辑，提供便捷 API</li>
<li><strong>Layout</strong>：使用 <code>&lt;keep-alive :include&gt;</code> 实现动态缓存</li>
</ol>
<h3 data-id="heading-11">3.2 核心代码实现</h3>
<h4 data-id="heading-12">步骤 1：创建 KeepAlive Store</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// stores/keepAlive.ts</span>
<span class="hljs-keyword">import</span> { defineStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'pinia'</span>
<span class="hljs-keyword">import</span> { computed, ref } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> useKeepAliveStore = <span class="hljs-title function_">defineStore</span>(<span class="hljs-string">'keep-alive'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">/** 缓存的组件名称列表 */</span>
  <span class="hljs-keyword">const</span> cachedViews = ref&lt;<span class="hljs-built_in">string</span>[]&gt;([])
  
  <span class="hljs-comment">/** 最大缓存数量（防止内存泄漏） */</span>
  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">MAX_CACHE_SIZE</span> = <span class="hljs-number">15</span>

  <span class="hljs-comment">/**
   * 添加组件到缓存列表
   * <span class="hljs-doctag">@param</span> name 组件名称（需与 defineOptions 中的 name 一致）
   */</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">addCachedView</span>(<span class="hljs-params">name: <span class="hljs-built_in">string</span></span>): <span class="hljs-built_in">void</span> {
    <span class="hljs-keyword">if</span> (!name || cachedViews.<span class="hljs-property">value</span>.<span class="hljs-title function_">includes</span>(name)) <span class="hljs-keyword">return</span>
    
    <span class="hljs-comment">// LRU 策略：超过最大数量时，移除最早的</span>
    <span class="hljs-keyword">if</span> (cachedViews.<span class="hljs-property">value</span>.<span class="hljs-property">length</span> &gt;= <span class="hljs-variable constant_">MAX_CACHE_SIZE</span>) {
      cachedViews.<span class="hljs-property">value</span>.<span class="hljs-title function_">shift</span>()
    }
    cachedViews.<span class="hljs-property">value</span>.<span class="hljs-title function_">push</span>(name)
  }

  <span class="hljs-comment">/**
   * 从缓存列表移除组件
   * <span class="hljs-doctag">@param</span> name 组件名称
   */</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">deleteCachedView</span>(<span class="hljs-params">name: <span class="hljs-built_in">string</span></span>): <span class="hljs-built_in">void</span> {
    <span class="hljs-keyword">const</span> index = cachedViews.<span class="hljs-property">value</span>.<span class="hljs-title function_">indexOf</span>(name)
    <span class="hljs-keyword">if</span> (index &gt; -<span class="hljs-number">1</span>) {
      cachedViews.<span class="hljs-property">value</span>.<span class="hljs-title function_">splice</span>(index, <span class="hljs-number">1</span>)
    }
  }

  <span class="hljs-comment">/**
   * 清空所有缓存（用于登出等场景）
   */</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">clearAllCachedViews</span>(<span class="hljs-params"/>): <span class="hljs-built_in">void</span> {
    cachedViews.<span class="hljs-property">value</span> = []
  }

  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">cachedViews</span>: <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> cachedViews.<span class="hljs-property">value</span>),
    addCachedView,
    deleteCachedView,
    clearAllCachedViews,
  }
})

<span class="hljs-comment">// 用于在 setup 外部使用（如路由守卫）</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useKeepAliveStoreWithOut</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">useKeepAliveStore</span>()
}
</code></pre>
<h4 data-id="heading-13">步骤 2：配置 Layout 组件</h4>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- layouts/default.vue --&gt;
&lt;template&gt;
  &lt;div class="layout"&gt;
    &lt;AppHeader /&gt;
    &lt;AppSidebar /&gt;
    &lt;main class="main-content"&gt;
      &lt;router-view v-slot="{ Component }"&gt;
        &lt;transition name="fade" mode="out-in"&gt;
          &lt;keep-alive :include="cachedViews" :max="15"&gt;
            &lt;component :is="Component" :key="$route.name" /&gt;
          &lt;/keep-alive&gt;
        &lt;/transition&gt;
      &lt;/router-view&gt;
    &lt;/main&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script setup lang="ts"&gt;
import { computed } from 'vue'
import { useKeepAliveStore } from '@/stores/keepAlive'

const keepAliveStore = useKeepAliveStore()

// 响应式获取缓存列表
const cachedViews = computed(() =&gt; keepAliveStore.cachedViews)
&lt;/script&gt;

&lt;style scoped&gt;
/* 页面切换过渡动画 */
.fade-enter-active,
.fade-leave-active {
  transition: opacity 0.15s ease;
}
.fade-enter-from,
.fade-leave-to {
  opacity: 0;
}
&lt;/style&gt;
</code></pre>
<h4 data-id="heading-14">步骤 3：路由守卫自动管理</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// router/index.ts</span>
<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">RouteLocationNormalized</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue-router'</span>
<span class="hljs-keyword">import</span> { createRouter, createWebHistory } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue-router'</span>
<span class="hljs-keyword">import</span> { useKeepAliveStoreWithOut } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/stores/keepAlive'</span>

<span class="hljs-keyword">const</span> router = <span class="hljs-title function_">createRouter</span>({
  <span class="hljs-attr">history</span>: <span class="hljs-title function_">createWebHistory</span>(),
  <span class="hljs-attr">routes</span>: [
    <span class="hljs-comment">// ... 路由配置</span>
  ],
})

<span class="hljs-comment">// 路由后置守卫：自动管理缓存</span>
router.<span class="hljs-title function_">afterEach</span>(<span class="hljs-function">(<span class="hljs-params">to: RouteLocationNormalized, <span class="hljs-keyword">from</span>: RouteLocationNormalized</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> keepAliveStore = <span class="hljs-title function_">useKeepAliveStoreWithOut</span>()
  <span class="hljs-keyword">const</span> componentName = to.<span class="hljs-property">name</span> <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span>
  
  <span class="hljs-comment">// 根据路由 meta.keepAlive 自动添加到缓存</span>
  <span class="hljs-keyword">if</span> (to.<span class="hljs-property">meta</span>?.<span class="hljs-property">keepAlive</span> &amp;&amp; componentName) {
    keepAliveStore.<span class="hljs-title function_">addCachedView</span>(componentName)
  }
  
  <span class="hljs-comment">// 如果离开的页面配置了 noCache，则清除缓存</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">from</span>.<span class="hljs-property">meta</span>?.<span class="hljs-property">noCache</span> &amp;&amp; <span class="hljs-keyword">from</span>.<span class="hljs-property">name</span>) {
    keepAliveStore.<span class="hljs-title function_">deleteCachedView</span>(<span class="hljs-keyword">from</span>.<span class="hljs-property">name</span> <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span>)
  }
})

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> router
</code></pre>
<h4 data-id="heading-15">步骤 4：创建 usePageCache Composable</h4>
<p>这是<strong>最核心的封装</strong>，提供了统一的缓存管理 API：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// composables/usePageCache.ts</span>
<span class="hljs-keyword">import</span> { onActivated, onDeactivated, ref } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> { useRoute } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue-router'</span>
<span class="hljs-keyword">import</span> { useKeepAliveStoreWithOut } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/stores/keepAlive'</span>

<span class="hljs-comment">/** 跨页面刷新标记（详情页操作后通知列表页刷新） */</span>
<span class="hljs-keyword">const</span> refreshMarks = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>&lt;<span class="hljs-built_in">string</span>&gt;()

<span class="hljs-comment">/**
 * 标记某个页面需要刷新
 * <span class="hljs-doctag">@param</span> pageName 目标页面的组件名称
 * <span class="hljs-doctag">@example</span>
 * // 详情页保存后，标记列表页需要刷新
 * markPageNeedRefresh('UserList')
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">markPageNeedRefresh</span>(<span class="hljs-params">pageName: <span class="hljs-built_in">string</span></span>): <span class="hljs-built_in">void</span> {
  refreshMarks.<span class="hljs-title function_">add</span>(pageName)
}

<span class="hljs-comment">/**
 * 页面缓存管理选项
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UsePageCacheOptions</span> {
  <span class="hljs-comment">/** 每次激活都刷新（默认 false） */</span>
  refreshOnActivate?: <span class="hljs-built_in">boolean</span>
  <span class="hljs-comment">/** 页面激活时的回调 */</span>
  onActivate?: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>
  <span class="hljs-comment">/** 页面停用时的回调 */</span>
  onDeactivate?: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>
  <span class="hljs-comment">/** 需要刷新数据时的回调（被 markPageNeedRefresh 标记后触发） */</span>
  onRefresh?: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span> | <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt;
}

<span class="hljs-comment">/**
 * 页面缓存管理 Composable
 * 
 * <span class="hljs-doctag">@example</span>
 * ```ts
 * // 列表页
 * const { isActive } = usePageCache({
 *   onActivate: () =&gt; console.log('页面激活'),
 *   onRefresh: () =&gt; loadList(), // 被标记刷新时执行
 * })
 * ```
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">usePageCache</span>(<span class="hljs-params">options: UsePageCacheOptions = {}</span>) {
  <span class="hljs-keyword">const</span> route = <span class="hljs-title function_">useRoute</span>()
  <span class="hljs-keyword">const</span> keepAliveStore = <span class="hljs-title function_">useKeepAliveStoreWithOut</span>()
  
  <span class="hljs-comment">/** 页面是否处于激活状态 */</span>
  <span class="hljs-keyword">const</span> isActive = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">true</span>)
  <span class="hljs-comment">/** 是否需要刷新数据 */</span>
  <span class="hljs-keyword">const</span> needRefresh = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>)
  <span class="hljs-comment">/** 当前页面名称 */</span>
  <span class="hljs-keyword">const</span> currentPageName = route.<span class="hljs-property">name</span> <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span>

  <span class="hljs-comment">// 页面激活时</span>
  <span class="hljs-title function_">onActivated</span>(<span class="hljs-function">() =&gt;</span> {
    isActive.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span>
    
    <span class="hljs-comment">// 检查是否被其他页面标记需要刷新</span>
    <span class="hljs-keyword">if</span> (currentPageName &amp;&amp; refreshMarks.<span class="hljs-title function_">has</span>(currentPageName)) {
      needRefresh.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span>
      refreshMarks.<span class="hljs-title function_">delete</span>(currentPageName) <span class="hljs-comment">// 清除标记</span>
    }
    
    <span class="hljs-comment">// 执行刷新回调</span>
    <span class="hljs-keyword">if</span> ((options.<span class="hljs-property">refreshOnActivate</span> || needRefresh.<span class="hljs-property">value</span>) &amp;&amp; options.<span class="hljs-property">onRefresh</span>) {
      <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(options.<span class="hljs-title function_">onRefresh</span>()).<span class="hljs-title function_">catch</span>(<span class="hljs-variable language_">console</span>.<span class="hljs-property">error</span>)
      needRefresh.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>
    }
    
    options.<span class="hljs-property">onActivate</span>?.()
  })

  <span class="hljs-comment">// 页面停用时</span>
  <span class="hljs-title function_">onDeactivated</span>(<span class="hljs-function">() =&gt;</span> {
    isActive.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>
    options.<span class="hljs-property">onDeactivate</span>?.()
  })

  <span class="hljs-comment">/**
   * 手动从缓存中移除当前页面
   * 适用于表单提交后需要清空状态的场景
   */</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">removeFromCache</span>(<span class="hljs-params"/>): <span class="hljs-built_in">void</span> {
    <span class="hljs-keyword">if</span> (currentPageName) {
      keepAliveStore.<span class="hljs-title function_">deleteCachedView</span>(currentPageName)
    }
  }

  <span class="hljs-keyword">return</span> { 
    isActive, 
    needRefresh, 
    removeFromCache,
  }
}
</code></pre>
<h3 data-id="heading-16">3.3 业务页面接入示例</h3>
<h4 data-id="heading-17">列表页（需要缓存）</h4>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- views/user/list.vue --&gt;
&lt;template&gt;
  &lt;div class="user-list"&gt;
    &lt;!-- 查询条件 --&gt;
    &lt;el-form :model="queryForm" inline&gt;
      &lt;el-form-item label="用户名"&gt;
        &lt;el-input v-model="queryForm.username" /&gt;
      &lt;/el-form-item&gt;
      &lt;el-form-item label="状态"&gt;
        &lt;el-select v-model="queryForm.status"&gt;
          &lt;el-option label="启用" value="active" /&gt;
          &lt;el-option label="禁用" value="inactive" /&gt;
        &lt;/el-select&gt;
      &lt;/el-form-item&gt;
      &lt;el-form-item&gt;
        &lt;el-button type="primary" @click="handleSearch"&gt;查询&lt;/el-button&gt;
        &lt;el-button @click="handleRefresh"&gt;刷新&lt;/el-button&gt;
      &lt;/el-form-item&gt;
    &lt;/el-form&gt;

    &lt;!-- 数据表格 --&gt;
    &lt;el-table :data="tableData" v-loading="loading"&gt;
      &lt;!-- 列定义 --&gt;
    &lt;/el-table&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script setup lang="ts"&gt;
import { onMounted, reactive, ref } from 'vue'
import { usePageCache } from '@/composables/usePageCache'

// ⚠️ 关键：必须定义组件名称，与路由 name 保持一致
defineOptions({
  name: 'UserList',
})

// 查询条件（会被缓存保留）
const queryForm = reactive({
  username: '',
  status: '',
})

const tableData = ref([])
const loading = ref(false)

// 集成缓存管理
const { isActive } = usePageCache({
  onActivate: () =&gt; {
    console.log('[UserList] 页面从缓存恢复')
  },
  onRefresh: async () =&gt; {
    // 当被 markPageNeedRefresh 标记时执行
    console.log('[UserList] 收到刷新通知，重新加载数据')
    await loadData()
  },
})

async function loadData() {
  loading.value = true
  try {
    // const res = await api.getUserList(queryForm)
    // tableData.value = res.data
  } finally {
    loading.value = false
  }
}

function handleSearch() {
  loadData()
}

function handleRefresh() {
  loadData()
}

// 首次加载
onMounted(() =&gt; {
  loadData()
})
&lt;/script&gt;
</code></pre>
<h4 data-id="heading-18">详情页（操作后通知列表刷新）</h4>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- views/user/detail.vue --&gt;
&lt;script setup lang="ts"&gt;
import { useRouter } from 'vue-router'
import { markPageNeedRefresh } from '@/composables/usePageCache'

const router = useRouter()

async function handleSave() {
  // await api.updateUser(form)
  
  // 标记列表页需要刷新
  markPageNeedRefresh('UserList')
  
  // 返回列表页
  router.back()
}

async function handleDelete() {
  // await api.deleteUser(id)
  
  // 标记列表页需要刷新
  markPageNeedRefresh('UserList')
  
  router.back()
}
&lt;/script&gt;
</code></pre>
<h4 data-id="heading-19">路由配置</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// router/modules/user.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> userRoutes = [
  {
    <span class="hljs-attr">path</span>: <span class="hljs-string">'/user/list'</span>,
    <span class="hljs-attr">name</span>: <span class="hljs-string">'UserList'</span>, <span class="hljs-comment">// 必须与 defineOptions 中的 name 一致</span>
    <span class="hljs-attr">component</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'@/views/user/list.vue'</span>),
    <span class="hljs-attr">meta</span>: {
      <span class="hljs-attr">title</span>: <span class="hljs-string">'用户列表'</span>,
      <span class="hljs-attr">keepAlive</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 开启缓存</span>
    },
  },
  {
    <span class="hljs-attr">path</span>: <span class="hljs-string">'/user/detail/:id'</span>,
    <span class="hljs-attr">name</span>: <span class="hljs-string">'UserDetail'</span>,
    <span class="hljs-attr">component</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'@/views/user/detail.vue'</span>),
    <span class="hljs-attr">meta</span>: {
      <span class="hljs-attr">title</span>: <span class="hljs-string">'用户详情'</span>,
      <span class="hljs-comment">// 详情页不缓存</span>
    },
  },
  {
    <span class="hljs-attr">path</span>: <span class="hljs-string">'/user/create'</span>,
    <span class="hljs-attr">name</span>: <span class="hljs-string">'UserCreate'</span>,
    <span class="hljs-attr">component</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'@/views/user/create.vue'</span>),
    <span class="hljs-attr">meta</span>: {
      <span class="hljs-attr">title</span>: <span class="hljs-string">'创建用户'</span>,
      <span class="hljs-attr">noCache</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 离开时清除缓存</span>
    },
  },
]
</code></pre>
<hr/>
<h2 data-id="heading-20">四、常见问题与解决方案</h2>
<h3 data-id="heading-21">4.1 缓存不生效？</h3>
<p><strong>症状</strong>：配置了 <code>keepAlive: true</code>，但页面仍然每次都重新加载</p>
<p><strong>排查清单</strong>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// ✅ 检查点 1：组件是否定义了 name？</span>
<span class="hljs-title function_">defineOptions</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">'MyComponent'</span>, <span class="hljs-comment">// 必须有</span>
})

<span class="hljs-comment">// ✅ 检查点 2：组件 name 是否与路由 name 一致？</span>
<span class="hljs-comment">// 路由配置</span>
{ <span class="hljs-attr">name</span>: <span class="hljs-string">'MyComponent'</span>, <span class="hljs-attr">meta</span>: { <span class="hljs-attr">keepAlive</span>: <span class="hljs-literal">true</span> } }
<span class="hljs-comment">// 组件必须有相同的 name</span>
<span class="hljs-title function_">defineOptions</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">'MyComponent'</span> })

<span class="hljs-comment">// ✅ 检查点 3：Layout 是否正确配置 include？</span>
&lt;keep-alive :include=<span class="hljs-string">"cachedViews"</span>&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">router-view</span> /&gt;</span></span>
&lt;/keep-alive&gt;

<span class="hljs-comment">// ✅ 检查点 4：Store 是否正确添加了组件名？</span>
<span class="hljs-comment">// 在 Vue DevTools 中检查 cachedViews 数组</span>
</code></pre>
<h3 data-id="heading-22">4.2 数据过期怎么办？</h3>
<p><strong>场景</strong>：用户在详情页修改了数据，返回列表页希望看到最新数据</p>
<p><strong>解决方案</strong>：使用 <code>markPageNeedRefresh</code> 跨页面通信</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 详情页</span>
<span class="hljs-keyword">import</span> { markPageNeedRefresh } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/composables/usePageCache'</span>

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleSave</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">await</span> <span class="hljs-title function_">saveData</span>()
  <span class="hljs-title function_">markPageNeedRefresh</span>(<span class="hljs-string">'ListPage'</span>) <span class="hljs-comment">// 标记列表页需要刷新</span>
  router.<span class="hljs-title function_">back</span>()
}

<span class="hljs-comment">// 列表页</span>
<span class="hljs-title function_">usePageCache</span>({
  <span class="hljs-attr">onRefresh</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">loadList</span>(), <span class="hljs-comment">// 被标记时自动执行</span>
})
</code></pre>
<h3 data-id="heading-23">4.3 表单页数据残留？</h3>
<p><strong>场景</strong>：创建表单页被缓存，用户再次进入看到上次填写的数据</p>
<p><strong>解决方案</strong>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 方案1：路由配置 noCache</span>
{
  <span class="hljs-attr">meta</span>: { <span class="hljs-attr">noCache</span>: <span class="hljs-literal">true</span> } <span class="hljs-comment">// 离开时自动清除缓存</span>
}

<span class="hljs-comment">// 方案2：提交成功后手动清除</span>
<span class="hljs-keyword">const</span> { removeFromCache } = <span class="hljs-title function_">usePageCache</span>()

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleSubmit</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">await</span> <span class="hljs-title function_">submitForm</span>()
  <span class="hljs-title function_">removeFromCache</span>() <span class="hljs-comment">// 清除当前页面缓存</span>
  router.<span class="hljs-title function_">back</span>()
}
</code></pre>
<h3 data-id="heading-24">4.4 内存泄漏风险？</h3>
<p><strong>风险</strong>：缓存过多页面导致内存占用过高</p>
<p><strong>缓解措施</strong>：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- 1. 限制最大缓存数 --&gt;
&lt;keep-alive :include="cachedViews" :max="15"&gt;
  &lt;router-view /&gt;
&lt;/keep-alive&gt;

&lt;!-- Store 中也做 LRU 限制 --&gt;
</code></pre>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 2. 登出时清空所有缓存</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">logout</span>(<span class="hljs-params"/>) {
  keepAliveStore.<span class="hljs-title function_">clearAllCachedViews</span>()
  router.<span class="hljs-title function_">push</span>(<span class="hljs-string">'/login'</span>)
}

<span class="hljs-comment">// 3. 敏感页面不缓存</span>
{
  <span class="hljs-attr">meta</span>: { <span class="hljs-attr">keepAlive</span>: <span class="hljs-literal">false</span> }
}
</code></pre>
<hr/>
<h2 data-id="heading-25">五、最佳实践总结</h2>
<h3 data-id="heading-26">✅ 应该做</h3>





























<table><thead><tr><th>实践</th><th>说明</th></tr></thead><tbody><tr><td>列表页开启缓存</td><td>高频访问的列表页配置 <code>keepAlive: true</code></td></tr><tr><td>定义组件名称</td><td>所有缓存页面必须用 <code>defineOptions({ name })</code></td></tr><tr><td>提供刷新入口</td><td>每个缓存页面都应有手动刷新按钮</td></tr><tr><td>详情页触发刷新</td><td>操作后使用 <code>markPageNeedRefresh</code> 通知列表</td></tr><tr><td>限制缓存数量</td><td>使用 <code>:max</code> 和 LRU 策略防止内存泄漏</td></tr></tbody></table>
<h3 data-id="heading-27">❌ 不应该做</h3>

























<table><thead><tr><th>反模式</th><th>原因</th></tr></thead><tbody><tr><td>表单页开启缓存</td><td>用户会看到上次填写的数据</td></tr><tr><td>详情页开启缓存</td><td>数据应始终获取最新</td></tr><tr><td>无限缓存</td><td>导致内存泄漏</td></tr><tr><td>忘记登出清理</td><td>敏感数据可能泄露</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-28">六、API 速查表</h2>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// ================== 路由配置 ==================</span>
<span class="hljs-attr">meta</span>: { 
  <span class="hljs-attr">keepAlive</span>: <span class="hljs-literal">true</span>,   <span class="hljs-comment">// 开启缓存</span>
  <span class="hljs-attr">noCache</span>: <span class="hljs-literal">true</span>,     <span class="hljs-comment">// 离开时清除缓存（二选一）</span>
}

<span class="hljs-comment">// ================== usePageCache ==================</span>
<span class="hljs-keyword">import</span> { markPageNeedRefresh, usePageCache } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/composables/usePageCache'</span>

<span class="hljs-comment">// 列表页使用</span>
<span class="hljs-keyword">const</span> { isActive, needRefresh, removeFromCache } = <span class="hljs-title function_">usePageCache</span>({
  <span class="hljs-attr">refreshOnActivate</span>: <span class="hljs-literal">false</span>,  <span class="hljs-comment">// 每次激活都刷新</span>
  <span class="hljs-attr">onActivate</span>: <span class="hljs-function">() =&gt;</span> {},      <span class="hljs-comment">// 激活回调</span>
  <span class="hljs-attr">onDeactivate</span>: <span class="hljs-function">() =&gt;</span> {},    <span class="hljs-comment">// 停用回调</span>
  <span class="hljs-attr">onRefresh</span>: <span class="hljs-function">() =&gt;</span> {},       <span class="hljs-comment">// 被标记刷新时执行</span>
})

<span class="hljs-comment">// 详情页通知列表刷新</span>
<span class="hljs-title function_">markPageNeedRefresh</span>(<span class="hljs-string">'PageName'</span>)

<span class="hljs-comment">// ================== Store 方法 ==================</span>
<span class="hljs-keyword">const</span> keepAliveStore = <span class="hljs-title function_">useKeepAliveStore</span>()

keepAliveStore.<span class="hljs-title function_">addCachedView</span>(name)       <span class="hljs-comment">// 添加缓存</span>
keepAliveStore.<span class="hljs-title function_">deleteCachedView</span>(name)    <span class="hljs-comment">// 移除缓存</span>
keepAliveStore.<span class="hljs-title function_">clearAllCachedViews</span>()     <span class="hljs-comment">// 清空所有</span>
</code></pre>
<hr/>
<h2 data-id="heading-29">七、总结</h2>
<p>本文介绍了 Vue 3 页面缓存的完整实现方案：</p>
<ol>
<li><strong>原理理解</strong>：keep-alive 缓存组件实例，通过 include 匹配组件 name</li>
<li><strong>架构设计</strong>：Store 集中管理 + Composable 封装 + 路由守卫自动化</li>
<li><strong>核心封装</strong>：<code>usePageCache</code> 提供统一的缓存管理 API</li>
<li><strong>跨页通信</strong>：<code>markPageNeedRefresh</code> 实现详情页→列表页的刷新通知</li>
</ol>
<p>通过这套方案，我们在实际项目中实现了：</p>
<ul>
<li><strong>95%+ 的页面切换性能提升</strong></li>
<li><strong>70%+ 的 API 请求减少</strong></li>
<li><strong>用户体验质的飞跃</strong></li>
</ul>
<p>希望本文对你有所帮助，欢迎交流讨论！</p>
<hr/>
<blockquote>
<p>📝 <strong>本文示例代码基于 Vue 3.5+ / Pinia 3.0+ / Vue Router 4.x</strong></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🌟 React useState 深入理解与最佳实践]]></title>    <link>https://juejin.cn/post/7581769891499950099</link>    <guid>https://juejin.cn/post/7581769891499950099</guid>    <pubDate>2025-12-10T07:02:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581769891499950099" data-draft-id="7581789701532205098" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🌟 React useState 深入理解与最佳实践"/> <meta itemprop="keywords" content="React.js"/> <meta itemprop="datePublished" content="2025-12-10T07:02:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="markyankee101"/> <meta itemprop="url" content="https://juejin.cn/user/71901929541952"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🌟 React useState 深入理解与最佳实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/71901929541952/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    markyankee101
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T07:02:46.000Z" title="Wed Dec 10 2025 07:02:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    11
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言：useState知识要点</h2>
<ol>
<li>
<p><strong>初始状态的传递方式</strong>：useState(initialState) 的参数 initialState 只在组件挂载时（即初次渲染）被使用，之后的状态更新由 setState 函数控制。</p>
<ul>
<li>如果传递的是一个<strong>具体的值</strong>（如数字、字符串、对象等），<strong>React只在初次渲染时使用这个值，后续渲染时忽略。</strong></li>
<li>如果传递的是一个<strong>函数</strong>，React在初次渲染时调用这个函数，并用返回值作为初始状态。但是，如果这个函数是直接在调用useState时定义的，那么每次渲染时都会调用这个函数，不过React只会使用初次渲染时的返回值作为初始状态，后续渲染时虽然调用但会忽略其返回值。但是，如果这个函数是作为惰性初始状态（即函数返回初始状态）的方式传递，那么React只会在初次渲染时调用一次。</li>
<li>如果初始状态来自于 <strong>props</strong>，那么当 props 改变时，useState 的状态不会自动更新，因为它只在初始渲染时使用 props 的值。  也就是说，useState 的状态是独立的，除非你使用 useEffect 来同步 props 的变化，否则状态不会随着 props 的改变而改变。</li>
</ul>
</li>
<li>
<p><strong>状态更新</strong>：</p>
<ul>
<li>调用set函数来更新状态，但要注意，set函数并不会立即改变状态，而是将更新加入队列，等待下一次渲染。</li>
<li>React会批量处理状态更新，这意味着在同一个事件处理函数中多次调用set函数，React会将它们合并，然后进行一次重新渲染。</li>
</ul>
</li>
<li>
<p><strong>状态更新时注意不可变性</strong>：</p>
<ul>
<li>当状态是对象或数组时，应该通过创建新的对象或数组来替换旧的状态，而不是直接修改旧的状态。</li>
</ul>
</li>
<li>
<p><strong>基于先前的状态更新</strong>：</p>
<ul>
<li>如果新的状态依赖于先前的状态，那么应该给set函数传递一个函数，这个函数接收先前的状态，并返回新的状态。</li>
</ul>
</li>
</ol>
<h2 data-id="heading-1">一、初始状态的创建时机</h2>

























<table><thead><tr><th>类型</th><th>创建时机</th><th>性能影响</th></tr></thead><tbody><tr><td>直接值</td><td>只计算一次</td><td>无影响</td></tr><tr><td>函数调用结果</td><td>每次渲染都调用</td><td>可能影响性能</td></tr><tr><td>函数本身</td><td>初次渲染调用</td><td>优化昂贵计算</td></tr></tbody></table>
<h3 data-id="heading-2">1. <strong>值类型初始状态（一次性）</strong></h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);  <span class="hljs-comment">// 只在初次渲染时使用</span>
<span class="hljs-keyword">const</span> [obj, setObj] = <span class="hljs-title function_">useState</span>({ <span class="hljs-attr">a</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">b</span>: <span class="hljs-number">2</span> }); <span class="hljs-comment">// 只创建一次</span>
</code></pre>
<h3 data-id="heading-3">2. <strong>函数调用初始状态（每次渲染都调用）</strong></h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ 每次渲染都会调用 heavyComputation()</span>
<span class="hljs-keyword">const</span> [value, setValue] = <span class="hljs-title function_">useState</span>(<span class="hljs-title function_">heavyComputation</span>());

<span class="hljs-comment">// ✅ 使用函数式初始状态，只在初次渲染时调用</span>
<span class="hljs-keyword">const</span> [value, setValue] = <span class="hljs-title function_">useState</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">heavyComputation</span>());
</code></pre>
<p><strong>关键区别</strong>：当传递函数本身时，React 只在初次渲染时调用它；当传递函数调用结果时，每次渲染都会执行函数（即使返回值被忽略）。</p>
<h3 data-id="heading-4">3. <strong>props作为初始状态</strong></h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">UserProfile</span>(<span class="hljs-params">{ initialName, initialAge }</span>) {
  <span class="hljs-comment">// ❌ 问题：props 变化时，状态不会自动更新</span>
  <span class="hljs-keyword">const</span> [name, setName] = <span class="hljs-title function_">useState</span>(initialName);
  <span class="hljs-keyword">const</span> [age, setAge] = <span class="hljs-title function_">useState</span>(initialAge);
  
  <span class="hljs-comment">// 如果 initialName 从 "John" 变为 "Jane"，</span>
  <span class="hljs-comment">// name 状态仍会保持 "John"，不会自动更新为 "Jane"</span>
}
</code></pre>
<p><strong>核心原则</strong>：<code>useState</code> 的初始值只在组件<strong>首次挂载时</strong>使用一次，后续 props 变化不会自动更新状态。</p>
<h2 data-id="heading-5">二、状态更新的异步性与批处理</h2>
<h3 data-id="heading-6">1. <strong>更新不会立即生效</strong></h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Counter</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);
  
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleClick</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-title function_">setCount</span>(count + <span class="hljs-number">1</span>);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(count); <span class="hljs-comment">// 仍然是旧值，不是立即更新的</span>
  };
}
</code></pre>
<h3 data-id="heading-7">2. <strong>React 18+ 的自动批处理</strong></h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 所有更新都会被批处理，只触发一次重渲染</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleClick</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-title function_">setCount</span>(<span class="hljs-function"><span class="hljs-params">c</span> =&gt;</span> c + <span class="hljs-number">1</span>);
  <span class="hljs-title function_">setName</span>(<span class="hljs-string">'new name'</span>);
  <span class="hljs-title function_">setFlag</span>(<span class="hljs-literal">true</span>);
  <span class="hljs-comment">// 这三行代码只会导致一次重渲染</span>
};
</code></pre>
<h3 data-id="heading-8">3. <strong>同步上下文中的批处理</strong></h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 这些场景下更新是批处理的：</span>
<span class="hljs-comment">// - React 事件处理器（onClick、onChange 等）</span>
<span class="hljs-comment">// - useEffect 回调</span>
<span class="hljs-comment">// - useLayoutEffect 回调</span>
<span class="hljs-comment">// - Promise 回调（React 18+）</span>

<span class="hljs-comment">// 这些场景下可能不是批处理的（React 17 及以前）：</span>
<span class="hljs-comment">// - setTimeout、setInterval</span>
<span class="hljs-comment">// - 原生事件监听器</span>
<span class="hljs-comment">// - Promise 回调</span>
</code></pre>
<h2 data-id="heading-9">三、不可变更新的模式</h2>
<h3 data-id="heading-10">1. <strong>对象更新：替换而非修改</strong></h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> [user, setUser] = <span class="hljs-title function_">useState</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">'John'</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">30</span> });

<span class="hljs-comment">// ❌ 错误：直接修改</span>
user.<span class="hljs-property">age</span> = <span class="hljs-number">31</span>;  <span class="hljs-comment">// 不会触发重新渲染</span>

<span class="hljs-comment">// ✅ 正确：创建新对象</span>
<span class="hljs-title function_">setUser</span>({ ...user, <span class="hljs-attr">age</span>: <span class="hljs-number">31</span> });

<span class="hljs-comment">// ✅ 深层更新</span>
<span class="hljs-title function_">setUser</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> ({
  ...prev,
  <span class="hljs-attr">profile</span>: {
    ...prev.<span class="hljs-property">profile</span>,
    <span class="hljs-attr">address</span>: <span class="hljs-string">'New York'</span>
  }
}));
</code></pre>
<h3 data-id="heading-11">2. <strong>数组更新</strong></h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> [items, setItems] = <span class="hljs-title function_">useState</span>([<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'c'</span>]);

<span class="hljs-comment">// 添加</span>
<span class="hljs-title function_">setItems</span>([...items, <span class="hljs-string">'d'</span>]);
<span class="hljs-title function_">setItems</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> [...prev, <span class="hljs-string">'d'</span>]);

<span class="hljs-comment">// 删除</span>
<span class="hljs-title function_">setItems</span>(items.<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">item, index</span>) =&gt;</span> index !== <span class="hljs-number">0</span>));

<span class="hljs-comment">// 更新</span>
<span class="hljs-title function_">setItems</span>(items.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">item, index</span>) =&gt;</span> 
  index === <span class="hljs-number">1</span> ? <span class="hljs-string">'updated'</span> : item
));
</code></pre>
<h2 data-id="heading-12">四、函数式更新（基于先前状态）</h2>
<h3 data-id="heading-13">1. <strong>为什么需要函数式更新？</strong></h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ 问题：批量更新时会有问题</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">incrementTwice</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-title function_">setCount</span>(count + <span class="hljs-number">1</span>);  <span class="hljs-comment">// 使用当前的 count（比如 0）</span>
  <span class="hljs-title function_">setCount</span>(count + <span class="hljs-number">1</span>);  <span class="hljs-comment">// 仍然使用当前的 count（0）</span>
  <span class="hljs-comment">// 结果：count 变为 1 而不是 2</span>
};

<span class="hljs-comment">// ✅ 解决方案：函数式更新</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">incrementTwice</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-title function_">setCount</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> prev + <span class="hljs-number">1</span>);  <span class="hljs-comment">// prev = 0 → 1</span>
  <span class="hljs-title function_">setCount</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> prev + <span class="hljs-number">1</span>);  <span class="hljs-comment">// prev = 1 → 2</span>
  <span class="hljs-comment">// 结果：count 变为 2</span>
};
</code></pre>
<h3 data-id="heading-14">2. <strong>复杂状态更新的模式</strong></h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 计数器队列更新</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleBatchUpdate</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-title function_">setCount</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> prev + <span class="hljs-number">1</span>);
  <span class="hljs-title function_">setCount</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> prev * <span class="hljs-number">2</span>);
  <span class="hljs-title function_">setCount</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> prev - <span class="hljs-number">1</span>);
  <span class="hljs-comment">// React 会依次执行这些更新函数</span>
};

<span class="hljs-comment">// 基于 props 的更新</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">Counter</span> = (<span class="hljs-params">{ initialValue }</span>) =&gt; {
  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(initialValue);
  
  <span class="hljs-comment">// 重置计数器</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">reset</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-title function_">setCount</span>(initialValue);  <span class="hljs-comment">// ❌ 如果 initialValue 变化，这里不会更新</span>
    
    <span class="hljs-comment">// ✅ 使用函数式更新确保使用最新的 props</span>
    <span class="hljs-title function_">setCount</span>(<span class="hljs-function">() =&gt;</span> initialValue);
  };
};
</code></pre>
<h2 data-id="heading-15">五、高级模式和最佳实践</h2>
<h3 data-id="heading-16">1. <strong>状态分割：提高性能</strong></h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ 将所有状态放在一起</span>
<span class="hljs-keyword">const</span> [state, setState] = <span class="hljs-title function_">useState</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">''</span>,
  <span class="hljs-attr">email</span>: <span class="hljs-string">''</span>,
  <span class="hljs-attr">age</span>: <span class="hljs-number">0</span>,
  <span class="hljs-attr">address</span>: <span class="hljs-string">''</span>
});

<span class="hljs-comment">// ✅ 分割状态，避免不必要的重渲染</span>
<span class="hljs-keyword">const</span> [name, setName] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">''</span>);
<span class="hljs-keyword">const</span> [email, setEmail] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">''</span>);
<span class="hljs-keyword">const</span> [age, setAge] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);
</code></pre>
<h3 data-id="heading-17">2. <strong>自定义 Hook 封装复杂状态逻辑</strong></h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">useUndoState</span>(<span class="hljs-params">initialValue</span>) {
  <span class="hljs-keyword">const</span> [state, setState] = <span class="hljs-title function_">useState</span>(initialValue);
  <span class="hljs-keyword">const</span> [history, setHistory] = <span class="hljs-title function_">useState</span>([initialValue]);
  
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">undo</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">if</span> (history.<span class="hljs-property">length</span> &gt; <span class="hljs-number">1</span>) {
      <span class="hljs-title function_">setHistory</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> prev.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, -<span class="hljs-number">1</span>));
      <span class="hljs-title function_">setState</span>(history[history.<span class="hljs-property">length</span> - <span class="hljs-number">2</span>]);
    }
  };
  
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">updateState</span> = (<span class="hljs-params">newValue</span>) =&gt; {
    <span class="hljs-title function_">setState</span>(newValue);
    <span class="hljs-title function_">setHistory</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> [...prev, newValue]);
  };
  
  <span class="hljs-keyword">return</span> [state, updateState, undo];
}
</code></pre>
<h3 data-id="heading-18">3. <strong>状态依赖更新的优化</strong></h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 使用 useCallback 避免函数重新创建</span>
<span class="hljs-keyword">const</span> increment = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-title function_">setCount</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> prev + <span class="hljs-number">1</span>);
}, []); <span class="hljs-comment">// 空依赖数组，函数只创建一次</span>

<span class="hljs-comment">// 使用 useMemo 避免昂贵计算</span>
<span class="hljs-keyword">const</span> expensiveValue = <span class="hljs-title function_">useMemo</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">heavyComputation</span>(count);
}, [count]); <span class="hljs-comment">// 仅当 count 变化时重新计算</span>
</code></pre>
<h2 data-id="heading-19">六、常见陷阱与解决方案</h2>
<h3 data-id="heading-20">1. <strong>闭包陷阱</strong></h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Timer</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);
  
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> interval = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-comment">// ❌ 总是使用初始的 count（0）</span>
      <span class="hljs-title function_">setCount</span>(count + <span class="hljs-number">1</span>);
    }, <span class="hljs-number">1000</span>);
    
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">clearInterval</span>(interval);
  }, []); <span class="hljs-comment">// 空依赖数组</span>
  
  <span class="hljs-comment">// ✅ 解决方案1：使用函数式更新</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> interval = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-title function_">setCount</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> prev + <span class="hljs-number">1</span>);
    }, <span class="hljs-number">1000</span>);
    
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">clearInterval</span>(interval);
  }, []);
  
  <span class="hljs-comment">// ✅ 解决方案2：将 count 加入依赖数组</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> interval = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-title function_">setCount</span>(count + <span class="hljs-number">1</span>);
    }, <span class="hljs-number">1000</span>);
    
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">clearInterval</span>(interval);
  }, [count]); <span class="hljs-comment">// count 变化时重新创建定时器</span>
}
</code></pre>
<h3 data-id="heading-21">2. <strong>状态依赖其他状态的更新</strong></h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> [firstName, setFirstName] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">''</span>);
<span class="hljs-keyword">const</span> [lastName, setLastName] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">''</span>);
<span class="hljs-keyword">const</span> [fullName, setFullName] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">''</span>);

<span class="hljs-comment">// ❌ 错误：在事件处理器中直接设置</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleFirstNameChange</span> = (<span class="hljs-params">name</span>) =&gt; {
  <span class="hljs-title function_">setFirstName</span>(name);
  <span class="hljs-title function_">setFullName</span>(name + <span class="hljs-string">' '</span> + lastName); <span class="hljs-comment">// 可能使用旧的 lastName</span>
};

<span class="hljs-comment">// ✅ 正确：使用 useEffect 响应状态变化</span>
<span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-title function_">setFullName</span>(firstName + <span class="hljs-string">' '</span> + lastName);
}, [firstName, lastName]);

<span class="hljs-comment">// ✅ 或者：使用 useMemo 计算派生状态</span>
<span class="hljs-keyword">const</span> fullName = <span class="hljs-title function_">useMemo</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">return</span> firstName + <span class="hljs-string">' '</span> + lastName;
}, [firstName, lastName]);
</code></pre>
<h2 data-id="heading-22">七、性能优化技巧</h2>
<ol>
<li><strong>惰性初始状态</strong>：对于昂贵的初始计算</li>
<li><strong>状态提升</strong>：将状态移动到最近的公共祖先</li>
<li><strong>状态降级</strong>：使用 useMemo/useCallback 避免向下传递新的引用</li>
<li><strong>状态合并</strong>：将频繁同时更新的状态放在一个对象中</li>
<li><strong>状态分割</strong>：将不常变化的状态拆分出来</li>
</ol>
<h2 data-id="heading-23">总结</h2>
<p><code>useState</code> 的核心原则：</p>
<ul>
<li><strong>初始状态创建</strong>：函数式初始状态只运行一次</li>
<li><strong>不可变性</strong>：总是创建新的值，而不是修改旧值</li>
<li><strong>函数式更新</strong>：当新状态依赖于旧状态时使用</li>
<li><strong>批处理</strong>：React 自动优化多个状态更新</li>
<li><strong>异步性</strong>：状态更新不会立即反映</li>
</ul>
<p>理解这些概念不仅能帮助你写出正确的 React 代码，还能优化应用性能，避免常见的陷阱。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[优雅实现虚拟表格校验：基于 Proxy 的响应式校验状态追踪]]></title>    <link>https://juejin.cn/post/7581761825483767844</link>    <guid>https://juejin.cn/post/7581761825483767844</guid>    <pubDate>2025-12-10T07:14:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581761825483767844" data-draft-id="7581769891499982867" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="优雅实现虚拟表格校验：基于 Proxy 的响应式校验状态追踪"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-12-10T07:14:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="西瓜树枝"/> <meta itemprop="url" content="https://juejin.cn/user/424827408622238"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            优雅实现虚拟表格校验：基于 Proxy 的响应式校验状态追踪
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/424827408622238/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    西瓜树枝
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T07:14:07.000Z" title="Wed Dec 10 2025 07:14:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">虚拟表格校验的核心突破：基于Proxy的响应式校验状态追踪</h2>
<p>在企业级应用开发中，虚拟表格（Virtual Table）是处理海量数据的标配，但校验状态的实时、高效管理始终是技术难点。传统方案中，校验状态需手动更新、批量遍历计算，不仅代码冗余，还极易因虚拟渲染的「按需加载」特性引发性能问题。</p>
<p>本文以「企业客户资质审核明细校验」场景为落地案例，聚焦讲解如何利用 JavaScript Proxy 特性，实现虚拟表格校验状态的<strong>响应式自动管理</strong>——这也是本方案区别于常规实现的核心突破点，结合 React + Ant Design 技术栈特性，从根本上解决校验状态与数据联动的痛点，同时深度整合动态校验规则适配能力，满足复杂业务场景需求。</p>
<h3 data-id="heading-1">虚拟表格校验的核心痛点：状态同步与规则适配难题</h3>
<p>虚拟表格的「可视行仅渲染」特性，让校验状态管理面临双重核心问题：</p>
<ol>
<li><strong>状态计算成本高</strong>：整行校验状态需依赖所有字段的校验结果，传统方案需手动遍历所有字段更新状态，海量数据下易卡顿；</li>
<li><strong>状态同步易出错</strong>：字段校验状态变更后，需手动同步整行状态，易因遗漏更新导致界面展示与实际状态不一致；</li>
<li><strong>规则适配灵活性差</strong>：不同资质类型、地域的校验规则差异大，传统硬编码方式难以适配动态业务场景；</li>
</ol>
<p>而 Proxy 作为 ES6 核心特性，其「拦截对象访问/修改」的能力，恰好能同时解决「状态响应式计算」和「动态规则适配」两大核心问题——让校验状态的计算从「手动触发」变为「按需响应式计算」，让规则适配从「硬编码」变为「动态推导」。</p>
<h3 data-id="heading-2">核心实现：Proxy 驱动的响应式校验状态设计（整合动态规则）</h3>
<h4 data-id="heading-3">1. 基础架构：校验状态与业务数据解耦</h4>
<p>首先为每一行资质数据创建独立的 <code>_validObj</code> 对象，专门存储校验状态（与原始业务数据解耦），这是 Proxy 能精准拦截、动态规则能灵活适配的前提：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 定义校验规则类型（强化 TypeScript 类型安全）</span>
interface <span class="hljs-title class_">ValidationRule</span> {
    required?: string;
    maxLength?: [number, string];
    pattern?: [<span class="hljs-title class_">RegExp</span>, string];
    custom?: <span class="hljs-function">(<span class="hljs-params">value: any, item: any</span>) =&gt;</span> { <span class="hljs-attr">flag</span>: boolean; <span class="hljs-attr">info</span>: string };
    [<span class="hljs-attr">key</span>: string]: string | [number | <span class="hljs-title class_">RegExp</span>, string] | (<span class="hljs-function">(<span class="hljs-params">value: any, item: any</span>) =&gt;</span> { <span class="hljs-attr">flag</span>: boolean; <span class="hljs-attr">info</span>: string }) | <span class="hljs-literal">undefined</span>;
}

<span class="hljs-comment">// 定义校验状态类型</span>
interface <span class="hljs-title class_">DetailValidObj</span> {
    <span class="hljs-attr">key</span>: string;
    <span class="hljs-attr">message</span>: string[]; <span class="hljs-comment">// 错误提示</span>
    <span class="hljs-attr">valid</span>: boolean;    <span class="hljs-comment">// 字段校验结果</span>
    <span class="hljs-attr">validFn</span>: <span class="hljs-function">(<span class="hljs-params">item: any</span>) =&gt;</span> boolean; <span class="hljs-comment">// 字段校验函数</span>
}

<span class="hljs-comment">// 定义资质明细数据类型</span>
interface <span class="hljs-title class_">CertDetailItem</span> {
    <span class="hljs-attr">certName</span>: string;
    <span class="hljs-attr">certCode</span>: string;
    <span class="hljs-attr">certType</span>: string; <span class="hljs-comment">// 资质类型（如金融/医疗/通用）</span>
    <span class="hljs-attr">regionCode</span>: string; <span class="hljs-comment">// 地域编码（如310000=上海，110000=北京）</span>
    <span class="hljs-attr">expireDate</span>: string;
    <span class="hljs-attr">issuer</span>: string;
    <span class="hljs-attr">_validObj</span>: <span class="hljs-title class_">Record</span>&lt;string, <span class="hljs-title class_">DetailValidObj</span>&gt;;
}

<span class="hljs-comment">// 全局校验规则配置（按场景分类）</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">VALID_RULES</span> = {
    <span class="hljs-comment">// 通用资质规则</span>
    <span class="hljs-attr">normal</span>: {
        <span class="hljs-attr">certName</span>: { <span class="hljs-attr">required</span>: <span class="hljs-string">'资质名称不能为空'</span>, <span class="hljs-attr">maxLength</span>: [<span class="hljs-number">50</span>, <span class="hljs-string">'资质名称长度不能超过50位'</span>] },
        <span class="hljs-attr">certCode</span>: { <span class="hljs-attr">required</span>: <span class="hljs-string">'资质编码不能为空'</span>, <span class="hljs-attr">pattern</span>: [<span class="hljs-regexp">/^[A-Z0-9]{10,20}$/</span>, <span class="hljs-string">'资质编码格式错误'</span>] },
        <span class="hljs-attr">expireDate</span>: { <span class="hljs-attr">required</span>: <span class="hljs-string">'有效期不能为空'</span>, <span class="hljs-attr">custom</span>: <span class="hljs-function">(<span class="hljs-params">v</span>) =&gt;</span> ({ <span class="hljs-attr">flag</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(v) &gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(), <span class="hljs-attr">info</span>: <span class="hljs-string">'资质已过期'</span> }) }
    },
    <span class="hljs-comment">// 金融资质专属规则</span>
    <span class="hljs-attr">finance</span>: {
        <span class="hljs-attr">certName</span>: { <span class="hljs-attr">required</span>: <span class="hljs-string">'金融资质名称不能为空'</span>, <span class="hljs-attr">maxLength</span>: [<span class="hljs-number">80</span>, <span class="hljs-string">'金融资质名称长度不能超过80位'</span>] },
        <span class="hljs-attr">certCode</span>: { <span class="hljs-attr">required</span>: <span class="hljs-string">'金融资质编码不能为空'</span>, <span class="hljs-attr">pattern</span>: [<span class="hljs-regexp">/^JR[A-Z0-9]{8,18}$/</span>, <span class="hljs-string">'金融资质编码格式错误'</span>] },
        <span class="hljs-attr">expireDate</span>: { <span class="hljs-attr">required</span>: <span class="hljs-string">'有效期不能为空'</span>, <span class="hljs-attr">custom</span>: <span class="hljs-function">(<span class="hljs-params">v</span>) =&gt;</span> ({ <span class="hljs-attr">flag</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(v) &gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(<span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() + <span class="hljs-number">30</span> * <span class="hljs-number">24</span> * <span class="hljs-number">3600</span> * <span class="hljs-number">1000</span>), <span class="hljs-attr">info</span>: <span class="hljs-string">'金融资质有效期不足30天'</span> }) },
        <span class="hljs-attr">licenseNo</span>: { <span class="hljs-attr">required</span>: <span class="hljs-string">'金融许可证号不能为空'</span> } <span class="hljs-comment">// 金融资质额外字段</span>
    },
    <span class="hljs-comment">// 地域专属规则（以上海为例）</span>
    <span class="hljs-attr">shanghai</span>: {
        <span class="hljs-attr">certCode</span>: { <span class="hljs-attr">pattern</span>: [<span class="hljs-regexp">/^SH[A-Z0-9]{8,18}$/</span>, <span class="hljs-string">'上海地区资质编码需以SH开头'</span>] }
    }
};

<span class="hljs-comment">// 初始化每行的校验状态容器</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">initValidObj</span> = (<span class="hljs-params">item: CertDetailItem</span>) =&gt; {
    <span class="hljs-keyword">const</span> <span class="hljs-attr">validObj</span>: <span class="hljs-title class_">Record</span>&lt;string, <span class="hljs-title class_">DetailValidObj</span>&gt; = {};
    <span class="hljs-comment">// 先获取当前行的基础校验字段（根据资质类型动态调整）</span>
    <span class="hljs-keyword">const</span> baseFields = <span class="hljs-title function_">getValidFieldsByCertType</span>(item.<span class="hljs-property">certType</span>);
    
    baseFields.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">field</span> =&gt;</span> {
        validObj[field] = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">seal</span>({ <span class="hljs-comment">// 冻结对象防止意外修改</span>
            <span class="hljs-attr">key</span>: field,
            <span class="hljs-attr">message</span>: [],
            <span class="hljs-attr">valid</span>: <span class="hljs-literal">true</span>,
            <span class="hljs-attr">validFn</span>: <span class="hljs-title function_">createFieldValidFn</span>(field, item) <span class="hljs-comment">// 绑定字段专属校验函数（带动态规则）</span>
        });
    });
    <span class="hljs-keyword">return</span> validObj;
};

<span class="hljs-comment">// 根据资质类型获取需校验的字段列表（动态字段适配）</span>
<span class="hljs-keyword">const</span> getValidFieldsByCertType = (<span class="hljs-attr">certType</span>: string): string[] =&gt; {
    <span class="hljs-keyword">switch</span> (certType) {
        <span class="hljs-keyword">case</span> <span class="hljs-string">'finance'</span>: <span class="hljs-comment">// 金融资质</span>
            <span class="hljs-keyword">return</span> [<span class="hljs-string">'certName'</span>, <span class="hljs-string">'certCode'</span>, <span class="hljs-string">'expireDate'</span>, <span class="hljs-string">'issuer'</span>, <span class="hljs-string">'licenseNo'</span>];
        <span class="hljs-keyword">case</span> <span class="hljs-string">'medical'</span>: <span class="hljs-comment">// 医疗资质</span>
            <span class="hljs-keyword">return</span> [<span class="hljs-string">'certName'</span>, <span class="hljs-string">'certCode'</span>, <span class="hljs-string">'expireDate'</span>, <span class="hljs-string">'issuer'</span>, <span class="hljs-string">'approvalNo'</span>];
        <span class="hljs-attr">default</span>: <span class="hljs-comment">// 通用资质</span>
            <span class="hljs-keyword">return</span> [<span class="hljs-string">'certName'</span>, <span class="hljs-string">'certCode'</span>, <span class="hljs-string">'expireDate'</span>, <span class="hljs-string">'issuer'</span>];
    }
};
</code></pre>
<p>解耦设计 + 规则配置化的核心价值：既保证原始业务数据的纯净性，也让 Proxy 仅需聚焦校验状态的拦截，同时通过配置化规则实现动态适配。</p>
<h4 data-id="heading-4">2. Proxy 核心拦截逻辑：按需计算 + 动态规则适配</h4>
<p>为 <code>_validObj</code> 创建 Proxy 代理，核心拦截 <code>valid</code> 属性的访问（整行校验状态的核心标识），在计算整行状态时，动态适配当前行的资质类型、地域规则：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 为校验状态对象绑定 Proxy 代理（整合动态规则）</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">createValidProxy</span> = (<span class="hljs-params">item: CertDetailItem, rawValidObj: Record&lt;string, DetailValidObj&gt;</span>) =&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Proxy</span>(rawValidObj, {
        <span class="hljs-comment">/**
         * 拦截属性访问：核心处理「整行校验状态」的计算 + 动态规则适配
         * <span class="hljs-doctag">@param</span> target 原始校验状态对象
         * <span class="hljs-doctag">@param</span> prop 访问的属性名
         * <span class="hljs-doctag">@returns</span> 按需返回字段状态 / 整行计算后的状态
         */</span>
        <span class="hljs-attr">get</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">target, prop, receiver</span>) {
            <span class="hljs-comment">// 拦截对「整行校验状态」的访问（统一标识为 'valid'）</span>
            <span class="hljs-keyword">if</span> (prop === <span class="hljs-string">'valid'</span>) {
                <span class="hljs-comment">// 第一步：根据当前行资质类型，动态获取需校验的字段列表</span>
                <span class="hljs-keyword">const</span> validFields = <span class="hljs-title function_">getValidFieldsByCertType</span>(item.<span class="hljs-property">certType</span>);
                
                <span class="hljs-comment">// 第二步：遍历动态字段列表，计算整行校验状态</span>
                <span class="hljs-keyword">return</span> validFields.<span class="hljs-title function_">every</span>(<span class="hljs-function"><span class="hljs-params">field</span> =&gt;</span> {
                    <span class="hljs-comment">// 兼容虚拟表格行复用导致的字段未初始化场景</span>
                    <span class="hljs-keyword">return</span> target[field]?.<span class="hljs-property">valid</span> ?? <span class="hljs-literal">false</span>;
                });
            }

            <span class="hljs-comment">// 拦截「动态规则获取」请求（供校验函数调用）</span>
            <span class="hljs-keyword">if</span> (prop === <span class="hljs-string">'getDynamicRules'</span>) {
                <span class="hljs-keyword">return</span> <span class="hljs-function">(<span class="hljs-params">field: string</span>) =&gt;</span> {
                    <span class="hljs-comment">// 基础规则：按资质类型获取</span>
                    <span class="hljs-keyword">let</span> fieldRules = <span class="hljs-variable constant_">VALID_RULES</span>.<span class="hljs-property">normal</span>[field] || {};
                    <span class="hljs-keyword">if</span> (item.<span class="hljs-property">certType</span> === <span class="hljs-string">'finance'</span>) {
                        fieldRules = { ...fieldRules, ...<span class="hljs-variable constant_">VALID_RULES</span>.<span class="hljs-property">finance</span>[field] };
                    }
                    <span class="hljs-comment">// 地域规则：叠加地域专属规则</span>
                    <span class="hljs-keyword">if</span> (item.<span class="hljs-property">regionCode</span> === <span class="hljs-string">'310000'</span>) {
                        fieldRules = { ...fieldRules, ...<span class="hljs-variable constant_">VALID_RULES</span>.<span class="hljs-property">shanghai</span>[field] };
                    }
                    <span class="hljs-keyword">return</span> fieldRules;
                };
            }

            <span class="hljs-comment">// 非整行状态访问：直接返回原始字段状态（如单个字段的 message/valid）</span>
            <span class="hljs-keyword">return</span> <span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">get</span>(target, prop, receiver);
        },
        
        <span class="hljs-comment">/**
         * 拦截属性修改，保证状态更新的可控性
         * 例如禁止直接修改整行 valid 状态，强制通过字段状态推导
         */</span>
        <span class="hljs-attr">set</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">target, prop, value, receiver</span>) {
            <span class="hljs-keyword">if</span> (prop === <span class="hljs-string">'valid'</span>) {
                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">'整行校验状态禁止手动修改，由字段状态自动推导'</span>);
                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>; <span class="hljs-comment">// 拒绝手动修改</span>
            }
            <span class="hljs-comment">// 字段状态修改时，无需额外操作，Proxy 访问时会自动重新计算整行状态</span>
            <span class="hljs-keyword">return</span> <span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">set</span>(target, prop, value, receiver);
        }
    });
};

<span class="hljs-comment">// 生成字段校验函数（整合动态规则）</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">createFieldValidFn</span> = (<span class="hljs-params">field: string, item: CertDetailItem</span>) =&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span> (<span class="hljs-params"><span class="hljs-variable language_">this</span>: DetailValidObj</span>) {
        <span class="hljs-keyword">const</span> value = item[field];
        <span class="hljs-keyword">const</span> validObj = item.<span class="hljs-property">_validObj</span>[field];
        <span class="hljs-comment">// 重置当前字段校验状态</span>
        validObj.<span class="hljs-property">message</span> = [];
        validObj.<span class="hljs-property">valid</span> = <span class="hljs-literal">true</span>;

        <span class="hljs-comment">// 第一步：通过 Proxy 获取当前字段的动态规则</span>
        <span class="hljs-keyword">const</span> getDynamicRules = item.<span class="hljs-property">_validObj</span>.<span class="hljs-property">getDynamicRules</span>;
        <span class="hljs-keyword">const</span> fieldRules = <span class="hljs-title function_">getDynamicRules</span>(field);

        <span class="hljs-comment">// 第二步：执行校验逻辑</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> ruleKey <span class="hljs-keyword">in</span> fieldRules) {
            <span class="hljs-keyword">const</span> ruleValue = fieldRules[ruleKey];
            <span class="hljs-keyword">let</span> isValid = <span class="hljs-literal">true</span>;
            <span class="hljs-keyword">let</span> errorMsg = <span class="hljs-string">''</span>;

            <span class="hljs-keyword">switch</span> (ruleKey) {
                <span class="hljs-keyword">case</span> <span class="hljs-string">'required'</span>:
                    isValid = !!value &amp;&amp; value.<span class="hljs-title function_">trim</span>() !== <span class="hljs-string">''</span>;
                    errorMsg = ruleValue <span class="hljs-keyword">as</span> string;
                    <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">case</span> <span class="hljs-string">'maxLength'</span>:
                    <span class="hljs-keyword">const</span> [max, msg] = ruleValue <span class="hljs-keyword">as</span> [number, string];
                    isValid = (value?.<span class="hljs-property">length</span> || <span class="hljs-number">0</span>) &lt;= max;
                    errorMsg = msg;
                    <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">case</span> <span class="hljs-string">'pattern'</span>:
                    <span class="hljs-keyword">const</span> [reg, msg] = ruleValue <span class="hljs-keyword">as</span> [<span class="hljs-title class_">RegExp</span>, string];
                    isValid = reg.<span class="hljs-title function_">test</span>(value);
                    errorMsg = msg;
                    <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">case</span> <span class="hljs-string">'custom'</span>:
                    <span class="hljs-keyword">const</span> result = (ruleValue <span class="hljs-keyword">as</span> (<span class="hljs-attr">v</span>: any) =&gt; { <span class="hljs-attr">flag</span>: boolean; <span class="hljs-attr">info</span>: string })(value);
                    isValid = result.<span class="hljs-property">flag</span>;
                    errorMsg = result.<span class="hljs-property">info</span>;
                    <span class="hljs-keyword">break</span>;
                <span class="hljs-attr">default</span>:
                    isValid = <span class="hljs-literal">true</span>;
            }

            <span class="hljs-keyword">if</span> (!isValid) {
                validObj.<span class="hljs-property">message</span>.<span class="hljs-title function_">push</span>(errorMsg);
                validObj.<span class="hljs-property">valid</span> = <span class="hljs-literal">false</span>;
                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>; <span class="hljs-comment">// 短路逻辑，提升校验效率</span>
            }
        }

        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    };
};

<span class="hljs-comment">// 初始化资质数据时绑定 Proxy</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">initCertData</span> = (<span class="hljs-params">rawData: CertDetailItem[]</span>) =&gt; {
    <span class="hljs-keyword">return</span> rawData.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> {
        <span class="hljs-keyword">const</span> rawValidObj = <span class="hljs-title function_">initValidObj</span>(item);
        <span class="hljs-comment">// 为校验对象绑定 Proxy，注入响应式能力 + 动态规则能力</span>
        item.<span class="hljs-property">_validObj</span> = <span class="hljs-title function_">createValidProxy</span>(item, rawValidObj);
        <span class="hljs-keyword">return</span> item;
    });
};
</code></pre>
<h4 data-id="heading-5">3. 关键特性：Proxy 响应式 + 动态规则的核心优势（适配 React + Ant Design）</h4>
<h5 data-id="heading-6">（1）按需计算，适配虚拟表格性能特性</h5>
<p>虚拟表格仅渲染可视行，只有当用户操作某行（如编辑字段、触发校验）时，才会访问该行的 <code>_validObj.valid</code> 属性——此时 Proxy 才执行整行状态计算，且计算时会自动适配当前行的资质类型、地域规则，完全避免「非可视行的无效计算」和「规则硬编码的冗余逻辑」。</p>
<h5 data-id="heading-7">（2）动态规则无缝整合，适配复杂业务场景</h5>
<p>通过 Proxy 暴露 <code>getDynamicRules</code> 方法，校验函数可随时获取当前行的专属规则，无需提前预判所有场景：</p>
<ul>
<li>资质类型适配：金融资质自动加载专属规则和额外校验字段；</li>
<li>地域规则适配：上海地区资质编码自动叠加地域格式校验；</li>
<li>规则扩展便捷：新增资质类型/地域规则时，仅需在 <code>VALID_RULES</code> 中添加配置，无需修改核心校验逻辑。</li>
</ul>
<h5 data-id="heading-8">（3）自动同步状态，无需手动维护</h5>
<p>当某个字段的校验状态变更（如 <code>certCode</code> 校验失败），后续访问 <code>_validObj.valid</code> 时，Proxy 会立即重新计算并返回最新结果，无需手动调用 <code>setState</code> 更新整行状态：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// React 组件中处理字段编辑</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleFieldChange</span> = (<span class="hljs-params">record: CertDetailItem, field: string, value: any</span>) =&gt; {
    <span class="hljs-comment">// 更新业务数据</span>
    <span class="hljs-keyword">const</span> newData = certData.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> {
        <span class="hljs-keyword">if</span> (item.<span class="hljs-property">key</span> === record.<span class="hljs-property">key</span>) {
            <span class="hljs-keyword">return</span> { ...item, [field]: value };
        }
        <span class="hljs-keyword">return</span> item;
    });
    <span class="hljs-title function_">setCertData</span>(newData);

    <span class="hljs-comment">// 触发字段校验（仅更新当前字段状态）</span>
    <span class="hljs-keyword">const</span> targetItem = newData.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.<span class="hljs-property">key</span> === record.<span class="hljs-property">key</span>);
    targetItem.<span class="hljs-property">_validObj</span>[field].<span class="hljs-property">validFn</span>.<span class="hljs-title function_">call</span>(targetItem.<span class="hljs-property">_validObj</span>[field]);
    
    <span class="hljs-comment">// 无需手动更新整行状态！访问 targetItem._validObj.valid 时会自动计算</span>
};

<span class="hljs-comment">// React 组件中使用：直接访问即可获取最新整行状态</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">renderTable</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Table</span>
        <span class="hljs-attr">components</span>=<span class="hljs-string">{VirtualTable}</span> // <span class="hljs-attr">Ant</span> <span class="hljs-attr">Design</span> <span class="hljs-attr">虚拟表格配置</span>
        <span class="hljs-attr">dataSource</span>=<span class="hljs-string">{certData}</span>
        <span class="hljs-attr">columns</span>=<span class="hljs-string">{[</span>
            // <span class="hljs-attr">操作列</span>：<span class="hljs-attr">根据整行校验状态禁用提交按钮</span>
            {
                <span class="hljs-attr">title:</span> '<span class="hljs-attr">操作</span>',
                <span class="hljs-attr">render:</span> (<span class="hljs-attr">_</span>, <span class="hljs-attr">record</span>) =&gt;</span> (
                    <span class="hljs-tag">&lt;<span class="hljs-name">Button</span> 
                        <span class="hljs-attr">type</span>=<span class="hljs-string">"primary"</span> 
                        <span class="hljs-attr">disabled</span>=<span class="hljs-string">{!record._validObj.valid}</span> // <span class="hljs-attr">访问时自动计算</span>（<span class="hljs-attr">含动态规则</span>）
                        <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> submitCert(record)}
                    &gt;
                        提交审核
                    <span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span>
                )
            }
        ]}
    /&gt;</span>;
};
</code></pre>
<h5 data-id="heading-9">（4）与 React 响应式生态融合</h5>
<p>Proxy 拦截的是对象属性访问，而非 React 组件状态，因此可完美适配 React 的「状态变更-重新渲染」逻辑：</p>
<ul>
<li>当字段校验状态变更后，组件访问 <code>_validObj.valid</code> 会获取最新值；</li>
<li>结合 React 状态管理（如 useState/useReducer），仅需更新数据引用，即可触发组件精准重渲染；</li>
<li>避免传统方案中「批量更新状态导致的全表重渲染」问题。</li>
</ul>
<h4 data-id="heading-10">4. 完整流程：Proxy 响应式校验 + 动态规则的执行链路</h4>
<p>结合 React + Ant Design 虚拟表格的生命周期，完整执行流程如下：</p>
<ol>
<li><strong>初始化</strong>：遍历原始资质数据，为每行创建 <code>rawValidObj</code>，并基于当前行的资质类型/地域编码绑定 Proxy（注入响应式 + 动态规则能力）；</li>
<li><strong>字段编辑</strong>：用户编辑字段（如修改金融资质编码），触发 <code>handleFieldChange</code> 更新业务数据；</li>
<li><strong>字段校验</strong>：调用该字段的 <code>validFn</code>，通过 Proxy 的 <code>getDynamicRules</code> 获取金融资质 + 地域专属规则，执行校验并更新字段状态；</li>
<li><strong>状态访问</strong>：组件渲染时访问 <code>_validObj.valid</code>（如禁用提交按钮、展示错误提示）；</li>
<li><strong>Proxy 拦截</strong>：自动根据当前行资质类型获取动态字段列表，遍历计算整行状态，返回最新结果；</li>
<li><strong>界面更新</strong>：React 感知到数据变化，仅重渲染当前行（虚拟表格特性），展示最新校验状态。</li>
</ol>
<h3 data-id="heading-11">总结：Proxy 是虚拟表格校验的「响应式+动态规则」核心</h3>
<p>在 React + Ant Design 虚拟表格校验场景中，Proxy 不仅解决了状态响应式计算的核心问题，还成为动态规则适配的「天然载体」：</p>
<ol>
<li><strong>响应式计算</strong>：将整行校验状态从「手动更新」变为「访问时自动推导」，完全适配虚拟表格的按需渲染特性；</li>
<li><strong>动态规则无缝整合</strong>：通过 Proxy 暴露动态规则获取能力，无需硬编码即可适配资质类型、地域等多维度业务场景；</li>
<li><strong>性能最优</strong>：仅在状态被访问时计算，避免非可视行的无效运算，规则缓存进一步降低计算成本；</li>
<li><strong>可维护性提升</strong>：规则配置化、状态管理解耦，新增业务场景仅需扩展配置，无需修改核心逻辑；</li>
<li><strong>React 生态适配</strong>：与 React 响应式理念高度契合，减少 setState 冗余代码，提升组件渲染效率。</li>
</ol>
<p>该方案不仅适用于「客户资质审核」场景，还可无缝迁移至供应链审核、合同管理、设备台账校验等所有虚拟表格校验场景——核心是利用 Proxy 打通「字段校验状态」「整行校验状态」「动态业务规则」三者的响应式联动，这也是企业级 React 应用中虚拟表格校验的最优实践方向。</p>
<h4 data-id="heading-12">最终核心代码（精简版）</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 核心：Proxy 响应式校验状态 + 动态规则实现</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">createValidProxy</span> = (<span class="hljs-params">item: CertDetailItem, rawValidObj: Record&lt;string, DetailValidObj&gt;</span>) =&gt; {
    <span class="hljs-keyword">let</span> <span class="hljs-attr">validCache</span>: boolean | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">let</span> <span class="hljs-attr">ruleCache</span>: <span class="hljs-title class_">Record</span>&lt;string, <span class="hljs-title class_">ValidationRule</span>&gt; = {};

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Proxy</span>(rawValidObj, {
        <span class="hljs-attr">get</span>: <span class="hljs-function">(<span class="hljs-params">target, prop</span>) =&gt;</span> {
            <span class="hljs-comment">// 整行校验状态：动态字段 + 自动计算</span>
            <span class="hljs-keyword">if</span> (prop === <span class="hljs-string">'valid'</span>) {
                <span class="hljs-keyword">const</span> now = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
                <span class="hljs-keyword">if</span> (validCache &amp;&amp; now - cacheTime &lt; <span class="hljs-number">100</span>) <span class="hljs-keyword">return</span> validCache;
                <span class="hljs-keyword">const</span> validFields = <span class="hljs-title function_">getValidFieldsByCertType</span>(item.<span class="hljs-property">certType</span>);
                validCache = validFields.<span class="hljs-title function_">every</span>(<span class="hljs-function"><span class="hljs-params">field</span> =&gt;</span> target[field]?.<span class="hljs-property">valid</span>);
                cacheTime = now;
                <span class="hljs-keyword">return</span> validCache;
            }

            <span class="hljs-comment">// 动态规则获取：适配资质类型/地域</span>
            <span class="hljs-keyword">if</span> (prop === <span class="hljs-string">'getDynamicRules'</span>) {
                <span class="hljs-keyword">return</span> <span class="hljs-function">(<span class="hljs-params">field: string</span>) =&gt;</span> {
                    <span class="hljs-keyword">if</span> (ruleCache[field]) <span class="hljs-keyword">return</span> ruleCache[field];
                    <span class="hljs-keyword">let</span> rules = <span class="hljs-variable constant_">VALID_RULES</span>.<span class="hljs-property">normal</span>[field] || {};
                    <span class="hljs-keyword">if</span> (item.<span class="hljs-property">certType</span> === <span class="hljs-string">'finance'</span>) rules = { ...rules, ...<span class="hljs-variable constant_">VALID_RULES</span>.<span class="hljs-property">finance</span>[field] };
                    <span class="hljs-keyword">if</span> (item.<span class="hljs-property">regionCode</span> === <span class="hljs-string">'310000'</span>) rules = { ...rules, ...<span class="hljs-variable constant_">VALID_RULES</span>.<span class="hljs-property">shanghai</span>[field] };
                    ruleCache[field] = rules;
                    <span class="hljs-keyword">return</span> rules;
                };
            }

            <span class="hljs-comment">// 错误信息聚合</span>
            <span class="hljs-keyword">if</span> (prop === <span class="hljs-string">'allMessage'</span>) {
                <span class="hljs-keyword">const</span> validFields = <span class="hljs-title function_">getValidFieldsByCertType</span>(item.<span class="hljs-property">certType</span>);
                <span class="hljs-keyword">return</span> validFields.<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">msgs, field</span>) =&gt;</span> 
                    target[field]?.<span class="hljs-property">message</span>.<span class="hljs-property">length</span> 
                        ? [...msgs, <span class="hljs-string">`<span class="hljs-subst">${field}</span>: <span class="hljs-subst">${target[field].message.join(<span class="hljs-string">', '</span>)}</span>`</span>] 
                        : msgs, []);
            }

            <span class="hljs-comment">// 字段变更清空缓存</span>
            <span class="hljs-keyword">if</span> (prop !== <span class="hljs-string">'valid'</span> &amp;&amp; prop !== <span class="hljs-string">'getDynamicRules'</span>) {
                validCache = <span class="hljs-literal">null</span>;
                ruleCache = {};
            }
            <span class="hljs-keyword">return</span> <span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">get</span>(target, prop);
        },
        <span class="hljs-attr">set</span>: <span class="hljs-function">(<span class="hljs-params">target, prop, value</span>) =&gt;</span> {
            <span class="hljs-keyword">if</span> (prop === <span class="hljs-string">'valid'</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>; <span class="hljs-comment">// 禁止手动修改整行状态</span>
            <span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">set</span>(target, prop, value);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }
    });
};

<span class="hljs-comment">// React 组件中使用</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">CertTable</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">const</span> [certData, setCertData] = <span class="hljs-title function_">useState</span>(<span class="hljs-function">() =&gt;</span> 
        <span class="hljs-title function_">initCertData</span>(rawData).<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> ({
            ...item,
            <span class="hljs-attr">_validObj</span>: <span class="hljs-title function_">createValidProxy</span>(item, <span class="hljs-title function_">initValidObj</span>(item))
        }))
    );

    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleFieldChange</span> = (<span class="hljs-params">record, field, value</span>) =&gt; {
        <span class="hljs-keyword">const</span> newData = certData.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.<span class="hljs-property">key</span> === record.<span class="hljs-property">key</span> ? { ...item, [field]: value } : item);
        <span class="hljs-title function_">setCertData</span>(newData);
        <span class="hljs-comment">// 触发字段校验</span>
        newData.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.<span class="hljs-property">key</span> === record.<span class="hljs-property">key</span>).<span class="hljs-property">_validObj</span>[field].<span class="hljs-title function_">validFn</span>();
    };

    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Table</span>
            <span class="hljs-attr">components</span>=<span class="hljs-string">{VirtualTable}</span>
            <span class="hljs-attr">dataSource</span>=<span class="hljs-string">{certData}</span>
            <span class="hljs-attr">columns</span>=<span class="hljs-string">{[</span>
                {
                    <span class="hljs-attr">title:</span> '<span class="hljs-attr">资质名称</span>',
                    <span class="hljs-attr">dataIndex:</span> '<span class="hljs-attr">certName</span>',
                    <span class="hljs-attr">editable:</span> <span class="hljs-attr">true</span>,
                    <span class="hljs-attr">onCell:</span> (<span class="hljs-attr">record</span>) =&gt;</span> ({
                        onChange: (e) =&gt; handleFieldChange(record, 'certName', e.target.value)
                    })
                },
                {
                    title: '校验状态',
                    render: (_, record) =&gt; (
                        <span class="hljs-tag">&lt;<span class="hljs-name">Tag</span> <span class="hljs-attr">color</span>=<span class="hljs-string">{record._validObj.valid</span> ? '<span class="hljs-attr">green</span>' <span class="hljs-attr">:</span> '<span class="hljs-attr">red</span>'}&gt;</span>
                            {record._validObj.valid ? '通过' : '失败'}
                        <span class="hljs-tag">&lt;/<span class="hljs-name">Tag</span>&gt;</span>
                    )
                },
                {
                    title: '错误信息',
                    render: (_, record) =&gt; (
                        <span class="hljs-tag">&lt;<span class="hljs-name">Tooltip</span> <span class="hljs-attr">title</span>=<span class="hljs-string">{record._validObj.allMessage.join(</span>'\<span class="hljs-attr">n</span>')}&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">Text</span> <span class="hljs-attr">disabled</span>=<span class="hljs-string">{record._validObj.valid}</span>&gt;</span>查看错误<span class="hljs-tag">&lt;/<span class="hljs-name">Text</span>&gt;</span>
                        <span class="hljs-tag">&lt;/<span class="hljs-name">Tooltip</span>&gt;</span>
                    )
                },
                {
                    title: '操作',
                    render: (_, record) =&gt; (
                        <span class="hljs-tag">&lt;<span class="hljs-name">Button</span> 
                            <span class="hljs-attr">disabled</span>=<span class="hljs-string">{!record._validObj.valid}</span>
                            <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> handleSubmit(record)}
                        &gt;
                            提交
                        <span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span>
                    )
                }
            ]}
        /&gt;</span>
    );
};
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JavaScript 常用数组操作方法完整指南]]></title>    <link>https://juejin.cn/post/7581828086020440079</link>    <guid>https://juejin.cn/post/7581828086020440079</guid>    <pubDate>2025-12-10T07:51:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581828086020440079" data-draft-id="7581814484065861684" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JavaScript 常用数组操作方法完整指南"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-12-10T07:51:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="想赚点零花钱"/> <meta itemprop="url" content="https://juejin.cn/user/2885580832641213"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JavaScript 常用数组操作方法完整指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2885580832641213/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    想赚点零花钱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T07:51:26.000Z" title="Wed Dec 10 2025 07:51:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">📚 核心方法对比总览</h2>





























































<table><thead><tr><th>方法</th><th>功能</th><th>修改原数组</th><th>返回值</th><th>时间复杂度</th><th>记忆技巧</th></tr></thead><tbody><tr><td><strong><code>slice()</code></strong></td><td>切片/提取</td><td>❌ 否</td><td>新数组/字符串</td><td>O(n)</td><td>"切一片蛋糕" - 原蛋糕还在</td></tr><tr><td><strong><code>splice()</code></strong></td><td>剪接/增删改</td><td>✅ 是</td><td>被删除元素数组</td><td>O(n)</td><td>"剪辑电影" - 原片被修改</td></tr><tr><td><strong><code>shift()</code></strong></td><td>移除第一个</td><td>✅ 是</td><td>移除的元素</td><td>O(n)</td><td>"移除队首"</td></tr><tr><td><strong><code>unshift()</code></strong></td><td>前面添加</td><td>✅ 是</td><td>新长度</td><td>O(n)</td><td>"反方向shift"</td></tr><tr><td><strong><code>pop()</code></strong></td><td>移除最后一个</td><td>✅ 是</td><td>移除的元素</td><td>O(1)</td><td>"弹出栈顶"</td></tr><tr><td><strong><code>push()</code></strong></td><td>后面添加</td><td>✅ 是</td><td>新长度</td><td>O(1)</td><td>"推入栈"</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-1">一、🔪 <code>slice()</code> - 切片方法</h2>
<h3 data-id="heading-2">1.1 基本语法</h3>
<pre><code class="hljs language-js" lang="js">
<span class="hljs-comment">// 数组和字符串都可用</span>
array.<span class="hljs-title function_">slice</span>(startIndex, endIndex)  <span class="hljs-comment">// 包含start，不包含end</span>
string.<span class="hljs-title function_">slice</span>(startIndex, endIndex)
</code></pre>
<h3 data-id="heading-3">1.2 参数详解</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> arr = [<span class="hljs-string">'A'</span>, <span class="hljs-string">'B'</span>, <span class="hljs-string">'C'</span>, <span class="hljs-string">'D'</span>, <span class="hljs-string">'E'</span>];

<span class="hljs-comment">// 两个参数</span>
arr.<span class="hljs-title function_">slice</span>(<span class="hljs-number">1</span>, <span class="hljs-number">3</span>);    <span class="hljs-comment">// ['B', 'C']     (索引1到3，不含3)</span>
arr.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, -<span class="hljs-number">1</span>);   <span class="hljs-comment">// ['A', 'B', 'C', 'D']  (0到倒数第1个)</span>

<span class="hljs-comment">// 一个参数</span>
arr.<span class="hljs-title function_">slice</span>(<span class="hljs-number">2</span>);       <span class="hljs-comment">// ['C', 'D', 'E']  (从索引2到末尾)</span>
arr.<span class="hljs-title function_">slice</span>(-<span class="hljs-number">2</span>);      <span class="hljs-comment">// ['D', 'E']       (最后2个)</span>

<span class="hljs-comment">// 无参数 - 浅拷贝</span>
<span class="hljs-keyword">const</span> copy = arr.<span class="hljs-title function_">slice</span>();  <span class="hljs-comment">// 完整浅拷贝</span>
</code></pre>
<h3 data-id="heading-4">1.3 实际应用</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 1. 数组浅拷贝</span>
<span class="hljs-keyword">const</span> original = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, { <span class="hljs-attr">name</span>: <span class="hljs-string">'John'</span> }];
<span class="hljs-keyword">const</span> copy = original.<span class="hljs-title function_">slice</span>();
copy[<span class="hljs-number">0</span>] = <span class="hljs-number">999</span>;           <span class="hljs-comment">// 不影响原数组</span>
copy[<span class="hljs-number">2</span>].<span class="hljs-property">name</span> = <span class="hljs-string">'Jane'</span>;   <span class="hljs-comment">// 影响原数组（对象引用相同）</span>

<span class="hljs-comment">// 2. 分页功能</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">paginate</span>(<span class="hljs-params">items, page = <span class="hljs-number">1</span>, pageSize = <span class="hljs-number">10</span></span>) {
  <span class="hljs-keyword">const</span> start = (page - <span class="hljs-number">1</span>) * pageSize;
  <span class="hljs-keyword">return</span> items.<span class="hljs-title function_">slice</span>(start, start + pageSize);
}

<span class="hljs-comment">// 3. 字符串操作</span>
<span class="hljs-keyword">const</span> url = <span class="hljs-string">'https://api.example.com/users'</span>;
<span class="hljs-keyword">const</span> domain = url.<span class="hljs-title function_">slice</span>(<span class="hljs-number">8</span>, url.<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">'/'</span>, <span class="hljs-number">8</span>));  <span class="hljs-comment">// 'api.example.com'</span>

<span class="hljs-comment">// 4. 获取数组部分</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">getFirstN</span> = (<span class="hljs-params">arr, n</span>) =&gt; arr.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, n);
<span class="hljs-keyword">const</span> <span class="hljs-title function_">getLastN</span> = (<span class="hljs-params">arr, n</span>) =&gt; arr.<span class="hljs-title function_">slice</span>(-n);
</code></pre>
<hr/>
<h2 data-id="heading-5">二、✂️ <code>splice()</code> - 剪接方法</h2>
<h3 data-id="heading-6">2.1 基本语法</h3>
<pre><code class="hljs language-js" lang="js">array.<span class="hljs-title function_">splice</span>(startIndex, deleteCount, item1, item2, ...)
</code></pre>
<h3 data-id="heading-7">2.2 三种主要用途</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> fruits = [<span class="hljs-string">'🍎'</span>, <span class="hljs-string">'🍌'</span>, <span class="hljs-string">'🍊'</span>, <span class="hljs-string">'🍇'</span>];

<span class="hljs-comment">// 1. 删除元素</span>
<span class="hljs-keyword">const</span> removed = fruits.<span class="hljs-title function_">splice</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>);  <span class="hljs-comment">// 从索引1删除2个</span>
<span class="hljs-comment">// removed: ['🍌', '🍊']</span>
<span class="hljs-comment">// fruits: ['🍎', '🍇']</span>

<span class="hljs-comment">// 2. 插入元素</span>
fruits.<span class="hljs-title function_">splice</span>(<span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-string">'🍉'</span>, <span class="hljs-string">'🍓'</span>);  <span class="hljs-comment">// 在索引1插入，不删除</span>
<span class="hljs-comment">// fruits: ['🍎', '🍉', '🍓', '🍇']</span>

<span class="hljs-comment">// 3. 替换元素</span>
fruits.<span class="hljs-title function_">splice</span>(<span class="hljs-number">2</span>, <span class="hljs-number">1</span>, <span class="hljs-string">'🍍'</span>);  <span class="hljs-comment">// 替换索引2的元素</span>
<span class="hljs-comment">// fruits: ['🍎', '🍉', '🍍', '🍇']</span>
</code></pre>
<h3 data-id="heading-8">2.3 实用技巧</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 1. 删除最后一个元素（替代pop）</span>
arr.<span class="hljs-title function_">splice</span>(-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>);

<span class="hljs-comment">// 2. 删除第一个元素（替代shift）</span>
arr.<span class="hljs-title function_">splice</span>(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>);

<span class="hljs-comment">// 3. 清空数组</span>
arr.<span class="hljs-title function_">splice</span>(<span class="hljs-number">0</span>, arr.<span class="hljs-property">length</span>);

<span class="hljs-comment">// 4. 在指定位置插入多个</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">insertAt</span> = (<span class="hljs-params">arr, index, ...items</span>) =&gt; {
  arr.<span class="hljs-title function_">splice</span>(index, <span class="hljs-number">0</span>, ...items);
  <span class="hljs-keyword">return</span> arr;
};
</code></pre>
<hr/>
<h2 data-id="heading-9">三、🔄 <code>shift()</code> / <code>unshift()</code> - 队列前端操作</h2>
<h3 data-id="heading-10">3.1 <code>shift()</code> - 移除第一个</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> queue = [<span class="hljs-string">'任务1'</span>, <span class="hljs-string">'任务2'</span>, <span class="hljs-string">'任务3'</span>];

<span class="hljs-comment">// 先进先出（FIFO）</span>
<span class="hljs-keyword">const</span> currentTask = queue.<span class="hljs-title function_">shift</span>();
<span class="hljs-comment">// currentTask: '任务1'</span>
<span class="hljs-comment">// queue: ['任务2', '任务3']</span>

<span class="hljs-comment">// 处理任务队列</span>
<span class="hljs-keyword">while</span> (queue.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
  <span class="hljs-keyword">const</span> task = queue.<span class="hljs-title function_">shift</span>();
  <span class="hljs-title function_">processTask</span>(task);
}
</code></pre>
<h3 data-id="heading-11">3.2 <code>unshift()</code> - 前面添加</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> history = [<span class="hljs-string">'页面2'</span>, <span class="hljs-string">'页面3'</span>];

<span class="hljs-comment">// 添加浏览历史（最新在最前）</span>
history.<span class="hljs-title function_">unshift</span>(<span class="hljs-string">'页面1'</span>);
<span class="hljs-comment">// history: ['页面1', '页面2', '页面3']</span>

<span class="hljs-comment">// 添加日志前缀</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">addLogPrefix</span>(<span class="hljs-params">logs, prefix</span>) {
  logs.<span class="hljs-title function_">unshift</span>(<span class="hljs-string">`[<span class="hljs-subst">${prefix}</span>]:`</span>);
  <span class="hljs-keyword">return</span> logs;
}
</code></pre>
<h3 data-id="heading-12">3.3 性能注意</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// ❌ shift/unshift 在大型数组上性能较差（需要移动所有元素）</span>
<span class="hljs-keyword">const</span> bigArray = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(<span class="hljs-number">1000000</span>).<span class="hljs-title function_">fill</span>(<span class="hljs-string">'item'</span>);

<span class="hljs-comment">// 如果要频繁操作数组前端，考虑使用双向队列</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Deque</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">items</span> = [];
  }
  
  <span class="hljs-title function_">addFront</span>(<span class="hljs-params">item</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">items</span>.<span class="hljs-title function_">unshift</span>(item);
  }
  
  <span class="hljs-title function_">removeFront</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">items</span>.<span class="hljs-title function_">shift</span>();
  }
}
</code></pre>
<hr/>
<h2 data-id="heading-13">四、📌 <code>pop()</code> / <code>push()</code> - 栈/队列后端操作</h2>
<h3 data-id="heading-14">4.1 <code>push()</code> - 后面添加</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> stack = [];

<span class="hljs-comment">// 入栈（LIFO）</span>
stack.<span class="hljs-title function_">push</span>(<span class="hljs-string">'操作1'</span>);
stack.<span class="hljs-title function_">push</span>(<span class="hljs-string">'操作2'</span>);
stack.<span class="hljs-title function_">push</span>(<span class="hljs-string">'操作3'</span>);
<span class="hljs-comment">// stack: ['操作1', '操作2', '操作3']</span>

<span class="hljs-comment">// 构建路径</span>
<span class="hljs-keyword">const</span> path = [];
path.<span class="hljs-title function_">push</span>(<span class="hljs-string">'users'</span>);
path.<span class="hljs-title function_">push</span>(<span class="hljs-string">'documents'</span>);
path.<span class="hljs-title function_">push</span>(<span class="hljs-string">'file.txt'</span>);
<span class="hljs-comment">// path: ['users', 'documents', 'file.txt']</span>
</code></pre>
<h3 data-id="heading-15">4.2 <code>pop()</code> - 移除最后一个</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 出栈</span>
<span class="hljs-keyword">const</span> lastOperation = stack.<span class="hljs-title function_">pop</span>();
<span class="hljs-comment">// lastOperation: '操作3'</span>
<span class="hljs-comment">// stack: ['操作1', '操作2']</span>

<span class="hljs-comment">// 撤销操作实现</span>
<span class="hljs-keyword">const</span> undoStack = [];
<span class="hljs-keyword">const</span> redoStack = [];

<span class="hljs-keyword">function</span> <span class="hljs-title function_">doAction</span>(<span class="hljs-params">action</span>) {
  undoStack.<span class="hljs-title function_">push</span>(action);
  <span class="hljs-title function_">execute</span>(action);
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">undo</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">if</span> (undoStack.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">const</span> action = undoStack.<span class="hljs-title function_">pop</span>();
    redoStack.<span class="hljs-title function_">push</span>(action);
    <span class="hljs-title function_">revert</span>(action);
  }
}
</code></pre>
<hr/>
<h2 data-id="heading-16">五、🎯 对比总结</h2>
<h3 data-id="heading-17">5.1 读写特性对比</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> arr = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>];

<span class="hljs-comment">// 读操作（不修改原数组）</span>
<span class="hljs-keyword">const</span> sliceResult = arr.<span class="hljs-title function_">slice</span>(<span class="hljs-number">1</span>, <span class="hljs-number">4</span>);  <span class="hljs-comment">// [2, 3, 4]</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arr);  <span class="hljs-comment">// [1, 2, 3, 4, 5] ✅ 不变</span>

<span class="hljs-comment">// 写操作（修改原数组）</span>
<span class="hljs-keyword">const</span> spliceResult = arr.<span class="hljs-title function_">splice</span>(<span class="hljs-number">1</span>, <span class="hljs-number">3</span>);  <span class="hljs-comment">// [2, 3, 4]</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arr);  <span class="hljs-comment">// [1, 5] ❌ 已修改</span>
</code></pre>
<h3 data-id="heading-18">5.2 操作位置对比</h3>
<pre><code class="hljs language-text" lang="text">操作位置         前面          中间          后面
-------------------------------------------------
取出/删除     shift()      splice()      pop()
添加/插入     unshift()    splice()      push()
只读切片      slice()      slice()       slice()
</code></pre>
<h3 data-id="heading-19">5.3 返回值对比</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> arr = [<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'c'</span>, <span class="hljs-string">'d'</span>];

arr.<span class="hljs-title function_">slice</span>(<span class="hljs-number">1</span>, <span class="hljs-number">3</span>);   <span class="hljs-comment">// 返回: ['b', 'c']   (新数组)</span>
arr.<span class="hljs-title function_">splice</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>);  <span class="hljs-comment">// 返回: ['b', 'c']   (删除的元素)</span>
arr.<span class="hljs-title function_">shift</span>();       <span class="hljs-comment">// 返回: 'a'          (移除的元素)</span>
arr.<span class="hljs-title function_">unshift</span>(<span class="hljs-string">'x'</span>);  <span class="hljs-comment">// 返回: 4            (新长度)</span>
</code></pre>
<hr/>
<h2 data-id="heading-20">六、🚀 最佳实践</h2>
<h3 data-id="heading-21">6.1 选择指南</h3>



































<table><thead><tr><th>场景</th><th>推荐方法</th><th>原因</th></tr></thead><tbody><tr><td><strong>需要原数组不变</strong></td><td><code>slice()</code></td><td>创建副本，不影响原始数据</td></tr><tr><td><strong>需要修改原数组</strong></td><td><code>splice()</code></td><td>原地操作，节省内存</td></tr><tr><td><strong>队列操作（先进先出）</strong></td><td><code>push()</code> + <code>shift()</code></td><td>符合队列语义</td></tr><tr><td><strong>栈操作（后进先出）</strong></td><td><code>push()</code> + <code>pop()</code></td><td>符合栈语义</td></tr><tr><td><strong>数组前端操作频繁</strong></td><td>考虑双向链表</td><td><code>shift/unshift</code>性能差</td></tr></tbody></table>
<h3 data-id="heading-22">6.2 性能优化</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// ❌ 避免在大数组上使用 shift/unshift</span>
<span class="hljs-keyword">const</span> largeArray = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(<span class="hljs-number">100000</span>).<span class="hljs-title function_">fill</span>(<span class="hljs-string">'item'</span>);

<span class="hljs-comment">// ✅ 如果需要频繁操作两端，使用链表或双端队列</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">OptimizedArray</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">items</span> = [];
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">frontIndex</span> = <span class="hljs-number">0</span>;
  }
  
  <span class="hljs-title function_">shift</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">frontIndex</span> &gt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">items</span>.<span class="hljs-property">length</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>;
    <span class="hljs-keyword">const</span> item = <span class="hljs-variable language_">this</span>.<span class="hljs-property">items</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">frontIndex</span>];
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">frontIndex</span>++;
    <span class="hljs-comment">// 定期清理前面的空位</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">frontIndex</span> &gt; <span class="hljs-number">1000</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">items</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">items</span>.<span class="hljs-title function_">slice</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">frontIndex</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">frontIndex</span> = <span class="hljs-number">0</span>;
    }
    <span class="hljs-keyword">return</span> item;
  }
}
</code></pre>
<h3 data-id="heading-23">6.3 现代JavaScript替代</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// slice 的现代替代</span>
<span class="hljs-keyword">const</span> arr = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>];
<span class="hljs-keyword">const</span> copy1 = arr.<span class="hljs-title function_">slice</span>();          <span class="hljs-comment">// 传统</span>
<span class="hljs-keyword">const</span> copy2 = [...arr];             <span class="hljs-comment">// ES6扩展运算符 ✅</span>
<span class="hljs-keyword">const</span> copy3 = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(arr);      <span class="hljs-comment">// ES6 Array.from</span>

<span class="hljs-comment">// push 的现代替代</span>
arr.<span class="hljs-title function_">push</span>(<span class="hljs-number">6</span>, <span class="hljs-number">7</span>);                     <span class="hljs-comment">// 传统</span>
<span class="hljs-keyword">const</span> newArr = [...arr, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>];      <span class="hljs-comment">// 扩展运算符（不修改原数组）</span>

<span class="hljs-comment">// unshift 的现代替代</span>
arr.<span class="hljs-title function_">unshift</span>(<span class="hljs-number">0</span>);                     <span class="hljs-comment">// 传统  </span>
<span class="hljs-keyword">const</span> newArr2 = [<span class="hljs-number">0</span>, ...arr];        <span class="hljs-comment">// 扩展运算符（不修改原数组）</span>
</code></pre>
<hr/>
<h2 data-id="heading-24">七、📝 记忆口诀</h2>
<h3 data-id="heading-25">7.1 按功能记忆</h3>
<pre><code class="hljs language-text" lang="text">读操作：slice     (只读不写)
写操作：splice    (增删改查)
队列头：shift/unshift
队列尾：pop/push
</code></pre>
<h3 data-id="heading-26">7.2 按名字记忆</h3>
<ul>
<li><strong><code>slice</code></strong> → "切" → 切一片 → 只读</li>
<li><strong><code>splice</code></strong> → "plice"（连接）→ 修改连接</li>
<li><strong><code>shift</code></strong> → 移动 → 移除第一个</li>
<li><strong><code>unshift</code></strong> → 反移动 → 前面添加</li>
<li><strong><code>pop</code></strong> → "砰" → 弹出最后一个</li>
<li><strong><code>push</code></strong> → 推 → 后面推入</li>
</ul>
<h3 data-id="heading-27">7.3 一句话总结</h3>
<blockquote>
<p><strong>slice切，splice改，shift/unshift动头，pop/push动尾</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-28">八、🔧 实用代码片段</h2>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 1. 安全的数组操作函数</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">ArrayUtils</span> = {
  <span class="hljs-comment">// 安全的slice（处理负数、越界）</span>
  <span class="hljs-attr">safeSlice</span>: <span class="hljs-function">(<span class="hljs-params">arr, start = <span class="hljs-number">0</span>, end = arr.length</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> len = arr.<span class="hljs-property">length</span>;
    start = start &lt; <span class="hljs-number">0</span> ? <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(len + start, <span class="hljs-number">0</span>) : <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(start, len);
    end = end &lt; <span class="hljs-number">0</span> ? <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(len + end, <span class="hljs-number">0</span>) : <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(end, len);
    <span class="hljs-keyword">return</span> arr.<span class="hljs-title function_">slice</span>(start, end);
  },
  
  <span class="hljs-comment">// 批量删除</span>
  <span class="hljs-attr">removeItems</span>: <span class="hljs-function">(<span class="hljs-params">arr, indices</span>) =&gt;</span> {
    <span class="hljs-comment">// 从大到小排序，避免索引变化</span>
    indices.<span class="hljs-title function_">sort</span>(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> b - a);
    indices.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">index</span> =&gt;</span> {
      arr.<span class="hljs-title function_">splice</span>(index, <span class="hljs-number">1</span>);
    });
    <span class="hljs-keyword">return</span> arr;
  },
  
  <span class="hljs-comment">// 插入到排序数组的合适位置</span>
  <span class="hljs-attr">insertSorted</span>: <span class="hljs-function">(<span class="hljs-params">arr, item, compareFn = (a, b) =&gt; a - b</span>) =&gt;</span> {
    <span class="hljs-keyword">let</span> low = <span class="hljs-number">0</span>, high = arr.<span class="hljs-property">length</span>;
    <span class="hljs-keyword">while</span> (low &lt; high) {
      <span class="hljs-keyword">const</span> mid = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>((low + high) / <span class="hljs-number">2</span>);
      <span class="hljs-keyword">if</span> (<span class="hljs-title function_">compareFn</span>(arr[mid], item) &lt; <span class="hljs-number">0</span>) {
        low = mid + <span class="hljs-number">1</span>;
      } <span class="hljs-keyword">else</span> {
        high = mid;
      }
    }
    arr.<span class="hljs-title function_">splice</span>(low, <span class="hljs-number">0</span>, item);
    <span class="hljs-keyword">return</span> arr;
  }
};
</code></pre>
<hr/>
<h2 data-id="heading-29">九、📊 时间复杂度总结</h2>








































<table><thead><tr><th>操作</th><th>时间复杂度</th><th>说明</th></tr></thead><tbody><tr><td><code>slice(start, end)</code></td><td>O(k)</td><td>k = end - start</td></tr><tr><td><code>splice(start, deleteCount, ...items)</code></td><td>O(n)</td><td>需要移动元素</td></tr><tr><td><code>shift()</code></td><td>O(n)</td><td>需要移动所有元素</td></tr><tr><td><code>unshift(...items)</code></td><td>O(n + m)</td><td>n=原长度, m=新增个数</td></tr><tr><td><code>pop()</code></td><td>O(1)</td><td>直接移除最后一个</td></tr><tr><td><code>push(...items)</code></td><td>O(m)</td><td>m=新增个数</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-30">十、✅ 快速参考卡</h2>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 提取部分（不修改原数组）</span>
<span class="hljs-keyword">const</span> part = arr.<span class="hljs-title function_">slice</span>(start, end);

<span class="hljs-comment">// 删除/插入/替换（修改原数组）</span>
<span class="hljs-keyword">const</span> removed = arr.<span class="hljs-title function_">splice</span>(start, deleteCount, ...items);

<span class="hljs-comment">// 队列操作（先进先出）</span>
queue.<span class="hljs-title function_">push</span>(item);          <span class="hljs-comment">// 入队</span>
<span class="hljs-keyword">const</span> item = queue.<span class="hljs-title function_">shift</span>(); <span class="hljs-comment">// 出队</span>

<span class="hljs-comment">// 栈操作（后进先出）</span>
stack.<span class="hljs-title function_">push</span>(item);          <span class="hljs-comment">// 压栈</span>
<span class="hljs-keyword">const</span> item = stack.<span class="hljs-title function_">pop</span>();   <span class="hljs-comment">// 弹栈</span>

<span class="hljs-comment">// 数组前后操作</span>
arr.<span class="hljs-title function_">unshift</span>(...items);     <span class="hljs-comment">// 前面添加</span>
arr.<span class="hljs-title function_">shift</span>();               <span class="hljs-comment">// 移除第一个</span>
arr.<span class="hljs-title function_">push</span>(...items);        <span class="hljs-comment">// 后面添加</span>
arr.<span class="hljs-title function_">pop</span>();                 <span class="hljs-comment">// 移除最后一个</span>
</code></pre>
<hr/>
<p><strong>最后提醒</strong>：</p>
<ul>
<li>✅ 需要<strong>保留原数组</strong>时用 <code>slice()</code></li>
<li>✅ 需要<strong>修改原数组</strong>时用 <code>splice()</code></li>
<li>✅ <strong>队列操作</strong>用 <code>push()</code> + <code>shift()</code></li>
<li>✅ <strong>栈操作</strong>用 <code>push()</code> + <code>pop()</code></li>
<li>❌ 避免在大数组上频繁使用 <code>shift()</code>/<code>unshift()</code></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[javascript面试系列（二）——Promise与async/await]]></title>    <link>https://juejin.cn/post/7581995152189751338</link>    <guid>https://juejin.cn/post/7581995152189751338</guid>    <pubDate>2025-12-10T07:46:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581995152189751338" data-draft-id="7581876069608144939" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="javascript面试系列（二）——Promise与async/await"/> <meta itemprop="keywords" content="JavaScript,面试,前端"/> <meta itemprop="datePublished" content="2025-12-10T07:46:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="西瓜树枝"/> <meta itemprop="url" content="https://juejin.cn/user/424827408622238"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            javascript面试系列（二）——Promise与async/await
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/424827408622238/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    西瓜树枝
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T07:46:10.000Z" title="Wed Dec 10 2025 07:46:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在前端面试的技术环节中，异步编程绝对是绕不开的核心考点，而Promise与async/await作为现代JavaScript异步编程的基石，更是面试官重点考察的内容。从“回调地狱”的痛点出发，到Promise的规范落地，再到async/await的语法优化，这三者的演进脉络不仅体现了JavaScript的发展方向，更藏着前端工程师必备的工程化思维。</p>
<h2 data-id="heading-0">一、为什么需要Promise？—— 从“回调地狱”说起</h2>
<p>在Promise出现之前，JavaScript的异步操作全靠回调函数实现。比如我们需要依次执行“请求用户信息→根据用户ID请求订单→根据订单ID请求商品详情”这一系列异步操作，代码会变成这样：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 回调地狱示例</span>
<span class="hljs-title function_">requestUserInfo</span>(userId, <span class="hljs-keyword">function</span>(<span class="hljs-params">user</span>) {
  <span class="hljs-title function_">requestOrder</span>(user.<span class="hljs-property">orderId</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params">order</span>) {
    <span class="hljs-title function_">requestGoods</span>(order.<span class="hljs-property">goodsId</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params">goods</span>) {
      <span class="hljs-comment">// 业务逻辑</span>
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(goods);
    }, <span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'请求商品失败'</span>, err);
    });
  }, <span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'请求订单失败'</span>, err);
  });
}, <span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'请求用户失败'</span>, err);
});
</code></pre>
<p>这种嵌套层级不断加深的代码被称为“回调地狱”，它存在三个致命问题：<strong>可读性差</strong>（代码呈“金字塔”结构，难以快速梳理执行流程）、<strong>可维护性低</strong>（修改中间某一步逻辑需要逐层定位）、<strong>错误处理混乱</strong>（每个回调都要单独处理错误，无法统一捕获）。</p>
<p>为了解决这些问题，ES6正式引入了Promise规范，它通过“状态管理”的方式将异步操作的结果与后续逻辑解耦，让异步代码变得线性、清晰。</p>
<h2 data-id="heading-1">二、Promise核心解析：状态、方法与原理</h2>
<p>Promise的本质是一个<strong>异步操作的状态管理器</strong>，它用标准化的API封装异步操作，让开发者可以专注于业务逻辑而非异步流程控制。要掌握Promise，首先要吃透它的“状态机制”。</p>
<h3 data-id="heading-2">1. 三个核心状态与状态不可逆性</h3>
<p>Promise有且只有三个状态，且状态一旦改变就会永久固定，无法再修改：</p>
<ul>
<li><strong>pending（等待中）</strong> ：初始状态，异步操作尚未完成。此时Promise既不成功也不失败。</li>
<li><strong>fulfilled（已成功）</strong> ：异步操作完成且结果有效。状态从pending转为fulfilled后，会触发后续的then回调。</li>
<li><strong>rejected（已失败）</strong> ：异步操作失败或结果无效。状态从pending转为rejected后，会触发后续的catch回调。</li>
</ul>
<p>面试高频考点：Promise状态不可逆的特性。比如“状态从fulfilled转为rejected是否可行？”答案是不行，一旦状态确定就无法变更。曾有面试题用setTimeout模拟异步，考察对状态固定的理解，务必注意。</p>
<h3 data-id="heading-3">2. 基本用法：创建与链式调用</h3>
<p>Promise通过构造函数创建，接收一个 executor 函数作为参数，该函数有两个内置参数resolve和reject，分别用于将状态转为fulfilled和rejected：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// Promise基本用法</span>
<span class="hljs-keyword">const</span> promise = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
  <span class="hljs-comment">// 模拟异步操作（比如接口请求）</span>
  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> success = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">if</span> (success) {
      <span class="hljs-comment">// 成功：传递结果给resolve</span>
      <span class="hljs-title function_">resolve</span>(<span class="hljs-string">'异步操作成功的结果'</span>);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// 失败：传递错误信息给reject</span>
      <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'异步操作失败'</span>));
    }
  }, <span class="hljs-number">1000</span>);
});

<span class="hljs-comment">// 链式调用处理结果</span>
promise
  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">result</span> =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'成功接收结果：'</span>, result);
    <span class="hljs-keyword">return</span> result + <span class="hljs-string">'，已处理'</span>; <span class="hljs-comment">// 传递给下一个then</span>
  })
  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">processedResult</span> =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'处理后的结果：'</span>, processedResult);
  })
  .<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'捕获错误：'</span>, error);
  });
</code></pre>
<p>这里有两个关键知识点：</p>
<ol>
<li><strong>then方法的返回值</strong>：then方法会返回一个新的Promise对象，这是链式调用的核心。如果then中返回一个非Promise值，会自动包装成fulfilled状态的Promise；如果返回一个Promise，则后续then会等待该Promise状态变更。</li>
<li><strong>catch的作用</strong>：catch用于捕获前面所有链式调用中的错误，包括Promise构造函数中reject的错误和then回调中抛出的异常，实现“统一错误处理”。</li>
</ol>
<h3 data-id="heading-4">3. 常用静态方法：all、race、allSettled</h3>
<p>除了实例方法，Promise的静态方法在实际开发和面试中都高频出现，重点掌握以下三个：</p>
<h4 data-id="heading-5">（1）Promise.all(iterable)</h4>
<p>接收一个可迭代对象（如数组），里面包含多个Promise。它的核心特性是“<strong>全部成功才成功，一个失败则整体失败</strong>”：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> promise1 = <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-number">1</span>);
<span class="hljs-keyword">const</span> promise2 = <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-number">2</span>);
<span class="hljs-keyword">const</span> promise3 = <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-number">3</span>);

<span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>([promise1, promise2, promise3])
  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">results</span> =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(results); <span class="hljs-comment">// [1, 2, 3]（按传入顺序返回结果）</span>
  })
  .<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(error); <span class="hljs-comment">// 若任意一个Promise reject，立即触发catch</span>
  });
</code></pre>
<p>面试考点：如果Promise.all中某个Promise失败，其他Promise还会继续执行吗？答案是会的。因为Promise状态一旦触发就无法中断，all只是“监听”状态，不会干预单个Promise的执行。</p>
<h4 data-id="heading-6">（2）Promise.race(iterable)</h4>
<p>同样接收可迭代对象，核心特性是“<strong>谁先完成谁生效</strong>”——只要有一个Promise状态变更（成功或失败），就立即返回该结果，忽略其他Promise的后续状态：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 模拟接口请求超时控制</span>
<span class="hljs-keyword">const</span> request = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> {
  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">resolve</span>(<span class="hljs-string">'请求成功'</span>), <span class="hljs-number">3000</span>);
});
<span class="hljs-keyword">const</span> timeout = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">_, reject</span>) =&gt;</span> {
  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'请求超时'</span>)), <span class="hljs-number">2000</span>);
});

<span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">race</span>([request, timeout])
  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">result</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(result))
  .<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(error)); <span class="hljs-comment">// 2秒后输出“请求超时”</span>
</code></pre>
<p>实际用途：常见于接口请求超时控制、资源加载竞争等场景。</p>
<h4 data-id="heading-7">（3）Promise.allSettled(iterable)</h4>
<p>ES2020新增方法，与all的“一错全错”不同，它会等待<strong>所有Promise都完成（无论成功或失败）</strong> ，然后返回一个包含所有结果的数组，每个元素包含对应Promise的状态和结果：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> promise1 = <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-number">1</span>);
<span class="hljs-keyword">const</span> promise2 = <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'失败'</span>));

<span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">allSettled</span>([promise1, promise2])
  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">results</span> =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(results);
    <span class="hljs-comment">// 输出：</span>
    <span class="hljs-comment">// [</span>
    <span class="hljs-comment">//   { status: 'fulfilled', value: 1 },</span>
    <span class="hljs-comment">//   { status: 'rejected', reason: Error: 失败 }</span>
    <span class="hljs-comment">// ]</span>
  });
</code></pre>
<p>适用场景：需要获取所有异步操作的完整结果，比如批量请求数据时，即使部分失败也需要知道失败原因。</p>
<h2 data-id="heading-8">三、async/await：Promise的“语法糖”与最佳实践</h2>
<p>虽然Promise解决了回调地狱，但链式调用过多时，代码依然会存在“then链”的冗余。ES2017引入的async/await，通过“同步语法写异步逻辑”的方式，进一步简化了Promise的使用，成为当前异步编程的首选方案。</p>
<h3 data-id="heading-9">1. 核心语法：async函数与await表达式</h3>
<p>async/await的使用依赖两个关键字，规则非常明确：</p>
<ol>
<li><strong>async关键字</strong>：用于声明一个异步函数，该函数的返回值会自动包装成一个Promise对象。 </li>
</ol>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fn</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>; <span class="hljs-comment">// 等价于 return Promise.resolve(1)</span>
}
<span class="hljs-title function_">fn</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">result</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(result)); <span class="hljs-comment">// 1</span>
</code></pre>
<ol>
<li><strong>await关键字</strong>：只能在async函数内部使用，用于“等待”一个Promise对象的状态变更。它会暂停当前async函数的执行，直到Promise状态变为fulfilled或rejected，然后继续执行函数并返回结果（或抛出错误）。 </li>
</ol>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 用async/await重构Promise链式调用</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getGoodsInfo</span>(<span class="hljs-params">userId</span>) {
    <span class="hljs-keyword">try</span> {
     <span class="hljs-comment">// 等待用户信息请求完成</span>
        <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> <span class="hljs-title function_">requestUserInfo</span>(userId);
        <span class="hljs-comment">// 等待订单请求完成（依赖用户信息）</span>
        <span class="hljs-keyword">const</span> order = <span class="hljs-keyword">await</span> <span class="hljs-title function_">requestOrder</span>(user.<span class="hljs-property">orderId</span>);
        <span class="hljs-comment">// 等待商品请求完成（依赖订单信息）</span>
        <span class="hljs-keyword">const</span> goods = <span class="hljs-keyword">await</span> <span class="hljs-title function_">requestGoods</span>(order.<span class="hljs-property">goodsId</span>);
        <span class="hljs-keyword">return</span> goods;
     } <span class="hljs-keyword">catch</span> (error) {
         <span class="hljs-comment">// 统一捕获所有await的错误</span>
         <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'请求失败：'</span>, error);
         <span class="hljs-keyword">throw</span> error; <span class="hljs-comment">// 可向上层抛出错误</span>
     }
}

 <span class="hljs-comment">// 调用异步函数</span>
<span class="hljs-title function_">getGoodsInfo</span>(<span class="hljs-number">123</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">goods</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(goods));
</code></pre>
<p>对比之前的回调和Promise链式调用，async/await的优势显而易见：代码完全线性化，逻辑清晰如同步代码，错误处理也通过try/catch统一管理，极大提升了可读性和可维护性。</p>
<h3 data-id="heading-10">2. 关键注意点：await的“等待”与并行优化</h3>
<p>async/await虽然好用，但如果使用不当，很容易出现“性能问题”，这也是面试的高频坑点。比如下面的代码：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 错误示例：不必要的串行等待</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getMultiData</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 两个请求无依赖关系，却串行执行，耗时 = 1s + 1s = 2s</span>
  <span class="hljs-keyword">const</span> data1 = <span class="hljs-keyword">await</span> <span class="hljs-title function_">requestData1</span>();
  <span class="hljs-keyword">const</span> data2 = <span class="hljs-keyword">await</span> <span class="hljs-title function_">requestData2</span>();
  <span class="hljs-keyword">return</span> { data1, data2 };
}
</code></pre>
<p>问题在于：requestData1和requestData2之间没有依赖关系，却因为await的串行等待导致总耗时增加。<strong>优化方案</strong>是先同时触发两个异步操作，再用await等待结果，借助Promise.all实现并行：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 优化：并行执行无依赖的异步操作</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getMultiData</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 同时触发两个请求，无等待</span>
  <span class="hljs-keyword">const</span> promise1 = <span class="hljs-title function_">requestData1</span>();
  <span class="hljs-keyword">const</span> promise2 = <span class="hljs-title function_">requestData2</span>();
  <span class="hljs-comment">// 等待两个请求都完成，耗时 = 1s（取最长时间）</span>
  <span class="hljs-keyword">const</span> data1 = <span class="hljs-keyword">await</span> promise1;
  <span class="hljs-keyword">const</span> data2 = <span class="hljs-keyword">await</span> promise2;
  <span class="hljs-keyword">return</span> { data1, data2 };
  <span class="hljs-comment">// 或直接用Promise.all：</span>
  <span class="hljs-comment">// const [data1, data2] = await Promise.all([promise1, promise2]);</span>
}
</code></pre>
<p>面试必考点：async/await的并行优化。核心原则是“无依赖的异步操作尽量并行执行”，通过先创建Promise实例（触发异步操作），再await的方式，或直接结合Promise.all，避免不必要的串行等待。</p>
<h3 data-id="heading-11">3. 错误处理：try/catch与Promise.catch的结合</h3>
<p>await后面的Promise如果变为rejected状态，会抛出一个异常，因此需要用try/catch捕获。但在实际开发中，也可以结合Promise的catch方法，实现更灵活的错误处理：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 方式1：局部try/catch（捕获指定await的错误）</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fn1</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> <span class="hljs-title function_">requestData</span>();
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'requestData失败：'</span>, error);
  }
  <span class="hljs-comment">// 其他逻辑不受影响</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'继续执行'</span>);
}

<span class="hljs-comment">// 方式2：全局catch（捕获async函数的所有错误）</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fn2</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> <span class="hljs-title function_">requestData</span>();
  <span class="hljs-keyword">return</span> data;
}
<span class="hljs-title function_">fn2</span>().<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'fn2执行失败：'</span>, error));
</code></pre>
<p>实际开发中，可根据错误处理的粒度需求选择合适的方式：局部错误用try/catch，全局或跨函数的错误用catch方法。</p>
<h2 data-id="heading-12">四、面试高频题：从原理到实战</h2>
<p>掌握了基础后，我们结合面试真题，强化对核心知识点的理解。</p>
<h3 data-id="heading-13">真题1：Promise的状态变更与then的执行时机</h3>
<p>题目：以下代码的输出顺序是什么？</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'start'</span>);
<span class="hljs-keyword">const</span> promise = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'promise executor'</span>);
  <span class="hljs-title function_">resolve</span>(<span class="hljs-string">'success'</span>);
});
promise.<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">result</span> =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(result);
});
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'end'</span>);
</code></pre>
<p>答案：start → promise executor → end → success</p>
<p>解析：Promise构造函数中的executor是<strong>同步执行</strong>的，因此会先打印“promise executor”；而then方法中的回调是<strong>微任务</strong>，会在同步代码执行完成后、事件循环的微任务阶段执行，因此“success”会在“end”之后打印。</p>
<h3 data-id="heading-14">真题2：async/await与Promise的关系</h3>
<p>题目：async/await是Promise的替代方案吗？为什么？</p>
<p>答案：不是替代方案，而是<strong>语法糖</strong>。原因：</p>
<ul>
<li>async函数的返回值本质是Promise对象，await只能等待Promise对象（如果不是，会自动包装成Promise）。</li>
<li>async/await的底层实现依赖Promise和生成器函数（Generator），它并没有脱离Promise的规范，而是简化了Promise的调用方式。</li>
<li>在需要并行执行异步操作、或使用all/race等静态方法时，依然需要结合Promise的API。</li>
</ul>
<h3 data-id="heading-15">真题3：手写Promise简化版（核心逻辑）</h3>
<p>题目：实现一个简化版Promise，包含基本的状态管理、resolve/reject和then方法。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyPromise</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">executor</span>) {
    <span class="hljs-comment">// 初始状态</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">status</span> = <span class="hljs-string">'pending'</span>;
    <span class="hljs-comment">// 成功结果</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span> = <span class="hljs-literal">undefined</span>;
    <span class="hljs-comment">// 失败原因</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">reason</span> = <span class="hljs-literal">undefined</span>;
    <span class="hljs-comment">// 成功回调队列（支持多个then）</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">onFulfilledCallbacks</span> = [];
    <span class="hljs-comment">// 失败回调队列</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">onRejectedCallbacks</span> = [];

    <span class="hljs-comment">// resolve方法：状态转为成功</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">resolve</span> = (<span class="hljs-params">value</span>) =&gt; {
      <span class="hljs-comment">// 状态不可逆，只有pending才能修改</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">status</span> === <span class="hljs-string">'pending'</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">status</span> = <span class="hljs-string">'fulfilled'</span>;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span> = value;
        <span class="hljs-comment">// 执行所有成功回调</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">onFulfilledCallbacks</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">cb</span> =&gt;</span> <span class="hljs-title function_">cb</span>(value));
      }
    };

    <span class="hljs-comment">// reject方法：状态转为失败</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">reject</span> = (<span class="hljs-params">reason</span>) =&gt; {
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">status</span> === <span class="hljs-string">'pending'</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">status</span> = <span class="hljs-string">'rejected'</span>;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">reason</span> = reason;
        <span class="hljs-comment">// 执行所有失败回调</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">onRejectedCallbacks</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">cb</span> =&gt;</span> <span class="hljs-title function_">cb</span>(reason));
      }
    };

    <span class="hljs-comment">// 执行executor，捕获同步错误</span>
    <span class="hljs-keyword">try</span> {
      <span class="hljs-title function_">executor</span>(resolve, reject);
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-title function_">reject</span>(error);
    }
  }

  <span class="hljs-comment">// then方法：返回新Promise，支持链式调用</span>
  <span class="hljs-title function_">then</span>(<span class="hljs-params">onFulfilled, onRejected</span>) {
    <span class="hljs-comment">// 兼容then未传回调的情况</span>
    onFulfilled = <span class="hljs-keyword">typeof</span> onFulfilled === <span class="hljs-string">'function'</span> ? onFulfilled : <span class="hljs-function"><span class="hljs-params">v</span> =&gt;</span> v;
    onRejected = <span class="hljs-keyword">typeof</span> onRejected === <span class="hljs-string">'function'</span> ? onRejected : <span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> { <span class="hljs-keyword">throw</span> e };

    <span class="hljs-keyword">const</span> newPromise = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyPromise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
      <span class="hljs-comment">// 状态已成功：直接执行回调</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">status</span> === <span class="hljs-string">'fulfilled'</span>) {
        <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> { <span class="hljs-comment">// 模拟微任务异步执行</span>
          <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">const</span> result = <span class="hljs-title function_">onFulfilled</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span>);
            <span class="hljs-comment">// 回调结果传递给新Promise的resolve</span>
            <span class="hljs-title function_">resolve</span>(result);
          } <span class="hljs-keyword">catch</span> (error) {
            <span class="hljs-title function_">reject</span>(error);
          }
        }, <span class="hljs-number">0</span>);
      }

      <span class="hljs-comment">// 状态已失败：直接执行回调</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">status</span> === <span class="hljs-string">'rejected'</span>) {
        <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
          <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">const</span> result = <span class="hljs-title function_">onRejected</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">reason</span>);
            <span class="hljs-title function_">resolve</span>(result);
          } <span class="hljs-keyword">catch</span> (error) {
            <span class="hljs-title function_">reject</span>(error);
          }
        }, <span class="hljs-number">0</span>);
      }

      <span class="hljs-comment">// 状态 pending：将回调存入队列</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">status</span> === <span class="hljs-string">'pending'</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">onFulfilledCallbacks</span>.<span class="hljs-title function_">push</span>(<span class="hljs-function">() =&gt;</span> {
          <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
            <span class="hljs-keyword">try</span> {
              <span class="hljs-keyword">const</span> result = <span class="hljs-title function_">onFulfilled</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span>);
              <span class="hljs-title function_">resolve</span>(result);
            } <span class="hljs-keyword">catch</span> (error) {
              <span class="hljs-title function_">reject</span>(error);
            }
          }, <span class="hljs-number">0</span>);
        });

        <span class="hljs-variable language_">this</span>.<span class="hljs-property">onRejectedCallbacks</span>.<span class="hljs-title function_">push</span>(<span class="hljs-function">() =&gt;</span> {
          <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
            <span class="hljs-keyword">try</span> {
              <span class="hljs-keyword">const</span> result = <span class="hljs-title function_">onRejected</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">reason</span>);
              <span class="hljs-title function_">resolve</span>(result);
            } <span class="hljs-keyword">catch</span> (error) {
              <span class="hljs-title function_">reject</span>(error);
            }
          }, <span class="hljs-number">0</span>);
        });
      }
    });

    <span class="hljs-keyword">return</span> newPromise;
  }
}
</code></pre>
<p>解析：简化版Promise的核心是实现“状态不可逆”和“then链式调用”。关键点包括：用队列存储pending状态时的回调、then返回新Promise以支持链式调用、通过setTimeout模拟微任务异步执行、捕获回调中的错误并传递给下一个Promise的reject。</p>
<h2 data-id="heading-16">五、总结：从入门到面试通关的核心要点</h2>
<p>Promise与async/await的核心是“解决异步编程的流程控制问题”，面试考察的不仅是API用法，更是对底层原理和工程实践的理解。最后梳理核心考点：</p>
<ol>
<li>Promise的三个状态及不可逆性，executor同步执行、then回调异步执行的特性。</li>
<li>then的链式调用原理（返回新Promise）和catch的错误捕获范围。</li>
<li>all/race/allSettled的区别及适用场景，尤其是all的“一错全错”和race的“先到先得”。</li>
<li>async/await的语法规则，与Promise的依赖关系，以及并行优化的技巧。</li>
<li>异步代码的执行顺序（同步→微任务→宏任务），结合Promise和async/await的实际场景分析。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[终于懂了-ARouter原理初探]]></title>    <link>https://juejin.cn/post/7581760987763900467</link>    <guid>https://juejin.cn/post/7581760987763900467</guid>    <pubDate>2025-12-10T06:47:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581760987763900467" data-draft-id="7581872532362362889" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="终于懂了-ARouter原理初探"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2025-12-10T06:47:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="马孔多的炼金术师"/> <meta itemprop="url" content="https://juejin.cn/user/4469974689386972"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            终于懂了-ARouter原理初探
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4469974689386972/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    马孔多的炼金术师
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T06:47:55.000Z" title="Wed Dec 10 2025 06:47:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">ARouter详解</h2>
<blockquote>
<p>ARouter是阿里开源的一个专门用于帮助Android App进行组件化改造的路由框架，其核心定位是解决组件化开发中的跨模块通信和解耦问题，通过路由机制实现模块间的页面跳转、服务调用和参数传递，彻底打破了传统开发中模块间的强依赖关系。它让不同模块的页面、服务能够在不直接依赖对方实现的情况下进行交互。本文主要讲ARouter的原理，适合学会ARouter基础使用还想继续探索深层原理的读者</p>
</blockquote>
<h3 data-id="heading-1">核心设计思想</h3>
<p><strong>ARouter 的本质就是一个专为 Android 设计的路由框架</strong>，通过一个中央系统来管理和分发请求，从而实现不同模块（尤其是相互没有直接依赖关系的模块）之间的顺畅通信和页面跳转。</p>
<p><code>ARouter</code>解决的问题本质就是<strong>模块之间如何做到不依赖实现的情况下在运行时动态定位页面/服务</strong>，基于该问题<code>ARouter</code>设计了编译时，初始化时，运行时的三层核心能力。</p>
<ol start="0">
<li>编译时：通过注解 Processor（注解处理器） 扫描注解（如 <code>@Route</code>），生成 Java 类，用于描述模块中的路由信息。这个过程就是典型的<strong>APT技术应用</strong>，其最大优势在于将耗时的类扫描和映射关系建立工作从App运行时转移到了编译时，避免了在运行时使用反射，从而大大提升了性能，这也是它比其他基于运行时扫描的路由性能更好、启动更快的原因。</li>
<li>初始化时：App启动时，<code>ARouter</code>会加载所有路由表类，构建一个内存中的路由索引。</li>
<li>运行时：根据根据路径创建一个路由信息卡片(<code>PostCard</code>)，核心组件 <code>LogisticsCenter</code>会拿着这个路径到内存仓库 <code>Warehouse</code>中查找对应的 <code>RouteMeta</code>信息（包含目标Class等），并将其补全到Postcard中。最后，根据Postcard中的信息，通过Intent启动Activity或执行其他操作。</li>
</ol>
<p><strong>ARouter 之所以拆成编译、初始化、运行三步，是为了把“路径 → 类”的映射工作尽可能前置到编译期，让 App 在运行过程中不需要扫描 <code>Dex</code>、不需要反射查找目标类，从而实现几乎零成本跳转。</strong> 文章下面主要就围绕着三个时期进行讲解</p>
<h3 data-id="heading-2">预备知识</h3>
<p>讲<code>ARouter</code>的源码前先讲几个比较核心的概念</p>
<h5 data-id="heading-3">PostCard</h5>
<p><code>Postcard</code>（明信片）是一个核心概念，它封装了一次路由跳转所需的全部信息，并负责驱动整个导航流程。</p>
<p>当我们调用 <code>ARouter.getInstance().build("/app/main")</code>时，就对应生成了一个<code>PostCard</code>对象。</p>
<p>它的的本质是一个“未完全解析的跳转请求”，它把跳转路径、携带参数、目标类、拦截器状态等全部统一收敛在一个对象里，方便 <code>ARouter</code> 在运行期逐步补全。真正的 Intent 构造是最后在 <code>_navigation()</code> 才发生。Postcard 是整个路由链的“中间态模型”。</p>
<h5 data-id="heading-4">WareHouse</h5>
<p><code>Warehouse</code>（意为“仓库”）扮演着<strong>中央数据存储库</strong>的角色。它负责在内存中集中管理所有通过注解（如<code>@Route</code>、<code>@Interceptor</code>）注册的路由信息和拦截器信息，是连接编译时生成的索引和运行时实际跳转的关键枢纽，<code>ARouter</code> 能够正常工作的<strong>所有核心映射关系和关键对象</strong>都在<code>WareHouse</code>中存放。</p>
<p>当在<code>Application</code>中调用<code>ARouter.init(...)</code>时，<code>ARouter</code>会扫描这些编译器生成的类。通过反射实例化它们，并调用其<code>loadInto</code>方法，将其中定义的映射关系（例如，组名"app"对应<code>ARouter$$Group$$app.class</code>）填充到<code>Warehouse</code>的静态Map中。具体存储内容如下表</p>








































<table><thead><tr><th>存储区域</th><th>存储内容说明</th><th>关键作用与特点</th></tr></thead><tbody><tr><td><strong><code>routes</code></strong></td><td><strong>详细的路由表</strong>。以<strong>路径（Path）</strong> 为 Key，对应的<strong>路由元信息（RouteMeta）</strong> 为 Value 。</td><td>这是路由跳转的<strong>最终依据</strong>。当根据路径查找目标时，就是查询这个 Map。它采用<strong>按需加载</strong>机制，并非在初始化时就填充所有数据 。</td></tr><tr><td><strong><code>groupsIndex</code></strong></td><td><strong>路由组索引</strong>。以<strong>组名（Group）</strong> 为 Key，对应的<strong>路由组类（如 <code>ARouter$$Group$$home.class</code>）</strong> 为 Value 。</td><td>这是实现按需加载的关键。初始化时只加载这个“组目录”，当某个组下的路径第一次被访问时，才动态加载整个组的所有路由到 <code>routes</code>中 。</td></tr><tr><td><strong><code>providersIndex</code></strong></td><td><strong>服务提供者索引</strong>。通常以<strong>接口的全类名</strong>为 Key，对应的<strong>服务路由元信息（RouteMeta）</strong> 为 Value 。</td><td>记录服务接口与其实现类的映射关系，用于依赖查找和跨模块服务调用 。</td></tr><tr><td><strong><code>providers</code></strong></td><td><strong>服务提供者单例缓存</strong>。以<strong>服务接口的 Class 对象</strong>为 Key，对应的<strong>已实例化的服务实现对象</strong>为 Value 。</td><td>缓存服务实例，确保服务全局唯一，避免重复创建 。</td></tr><tr><td><strong><code>interceptorsIndex</code></strong></td><td><strong>拦截器索引</strong>。以<strong>优先级数字</strong>为 Key，对应的<strong>拦截器类（IInterceptor）</strong> 为 Value 。</td><td>记录所有拦截器及其优先级，在初始化时被加载 。</td></tr><tr><td><strong><code>interceptors</code></strong></td><td><strong>拦截器实例列表</strong>。在 ARouter 初始化完成后，根据 <code>interceptorsIndex</code>创建的<strong>拦截器对象列表</strong> 。</td><td>实际执行拦截逻辑的实例集合 。</td></tr></tbody></table>
<h3 data-id="heading-5">编译时期</h3>
<p><code>ARouter</code>的编译期工作主要由<code>arouter-compiler</code>(编译时处理器)模块完成，是 <code>ARouter</code> 的最关键部分。其中包含了多个注解处理器，它们都继承自<code>BaseProcessor</code>。</p>
<ul>
<li><strong>RouteProcessor</strong>: 处理 <code>@Route</code>注解，这是最核心的处理器，负责生成路由组（<code>Group</code>）和根（<code>Root</code>）映射表。</li>
<li><strong>InterceptorProcessor</strong>: 处理 <code>@Interceptor</code>注解，生成拦截器映射表。</li>
<li><strong>AutowiredProcessor</strong>: 处理 <code>@Autowired</code>注解，生成参数注入辅助类。</li>
</ul>
<p>这里主要讲一下<code>RouteProcessor</code>，<code>RouteProcessor</code>处理器会收集所有被<code>@Route</code>标注的元素（如Activity、Service等），并为每个元素创建一个<code>RouteMeta</code>对象。这个对象包含了该路由的所有关键信息，包括<strong>路径（Path）</strong> ：注解中定义的路径，(如<code>/app/main</code>)。<strong>分组（Group）</strong> ：如果注解中未显式指定，则从路径中提取（如<code>/app/main</code>的分组是<code>app</code>）。<strong>目标类（Destination）</strong> ：被注解的类本身。<strong>路由类型（Type）</strong> ：通过判断目标类是Activity、Service还是实现了<code>IProvider</code>接口等来确定其类型。</p>
<p>我们看下面这样的代码</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Route(path = <span class="hljs-string">"/home/main"</span>)</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">HomeActivity</span> : <span class="hljs-type">AppCompatActivity</span>()
</code></pre>
<p>这里<code>RouteProcessor</code>实际做了三件事</p>
<ol start="0">
<li><code>RouteProcessor</code>的<code>process</code>方法首先会扫描并收集所有被 <code>@Route</code>注解标记的类（如 Activity、Fragment 等）作为一个集合</li>
</ol>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> <span class="hljs-built_in">boolean</span> <span class="hljs-title function_">process</span>(<span class="hljs-params"><span class="hljs-built_in">Set</span>&lt;? <span class="hljs-keyword">extends</span> TypeElement&gt; annotations, RoundEnvironment roundEnv</span>) {
​
    <span class="hljs-keyword">if</span> (<span class="hljs-title class_">CollectionUtils</span>.<span class="hljs-title function_">isNotEmpty</span>(annotations)) {
        <span class="hljs-title class_">Set</span>&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Element</span>&gt; routeElements = roundEnv.<span class="hljs-title function_">getElementsAnnotatedWith</span>(<span class="hljs-title class_">Route</span>.<span class="hljs-property">class</span>);
        <span class="hljs-title function_">parseRoutes</span>(routeElements);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}
</code></pre>
<p>扫描后将@Route注解的集合调用<code>parseRoutes</code>对集合每个元素进行处理</p>
<pre><code class="hljs language-scss" lang="scss">private void <span class="hljs-built_in">parseRoutes</span>(Set&lt;? extends Element&gt; routeElements) {
    for (Element element : routeElements) {
        Route route = element<span class="hljs-selector-class">.getAnnotation</span>(Route.class);
        <span class="hljs-built_in">parseRoute</span>(element, route);
    }
}
</code></pre>
<p>对于每个收集到的元素，它会在<code>parseRoute</code>方法中提取注解中的关键信息（如 <code>path</code>、<code>group</code>），并根据该元素的类型（是 Activity 还是实现了 <code>IProvider</code>接口的服务等），创建一个 <code>RouteMeta</code>对象，该<code>RouteMeta</code>对象包含了该路由节点的所有元数据 , 如下</p>
<pre><code class="hljs language-ini" lang="ini">RouteMeta <span class="hljs-attr">meta</span> = new RouteMeta(
        RouteType.ACTIVITY,
        classElement, 
        routeAnnotation.path(),
        routeAnnotation.group()
)<span class="hljs-comment">;</span>
</code></pre>
<p>其中最重要的是三个信息：<strong>type</strong>（ACTIVITY / FRAGMENT / PROVIDER）、<strong>path</strong>和<strong>group</strong></p>
<ol start="2">
<li>自动创建 Group / Root 类。当所有 <code>@Route</code> 都解析完后，处理器开始生成代码。<code>ARouter</code> 编译期会生成至少两类 java 文件：</li>
</ol>
<p>（1）<code>RouteGroup_xxx.java</code>，描述某 group 下有哪些路由，<strong>负责在编译时生成并在运行时注册路由信息，导航时ARouter通过查找这些注册信息，找到目标类，最终完成跳转。</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ARouter$$Group$$home</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">IRouteGroup</span> {
​
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">loadInto</span>(<span class="hljs-params"><span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, RouteMeta&gt; atlas</span>) {
        atlas.<span class="hljs-title function_">put</span>(<span class="hljs-string">"/home/main"</span>, <span class="hljs-title class_">RouteMeta</span>.<span class="hljs-title function_">build</span>(
            <span class="hljs-title class_">RouteType</span>.<span class="hljs-property">ACTIVITY</span>, 
            <span class="hljs-title class_">MainActivity</span>.<span class="hljs-property">class</span>, 
            <span class="hljs-string">"/home/main"</span>, 
            <span class="hljs-string">"home"</span>
        ));
    }
}
​
</code></pre>
<p>（2）<code>RouteRoot_AROUTER.java</code>，描述所有 <code>group</code>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ARouter$$Root$$app</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">IRouteRoot</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">loadInto</span>(<span class="hljs-params"><span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, Class&lt;? <span class="hljs-keyword">extends</span> IRouteGroup&gt;&gt; routes</span>) {
        routes.<span class="hljs-title function_">put</span>(<span class="hljs-string">"home"</span>, <span class="hljs-title class_">ARouter</span>$$Group$$home.<span class="hljs-property">class</span>);
    }
}
</code></pre>
<p>这两个Java文件共同构成路由表系统，都会被打包到 APK 的 <code>dex</code> 文件中，且固定放在 <code>com.alibaba.android.arouter.routes</code> 包下，为后面的跳转做准备。读者可能会疑惑为什么不直接建一张大表包含所有的路径，<strong><code>ARouter</code> 选择按 group 拆成多个 Java 类，而不是生成一张巨大路由表直接包含所有的路径，是为了避免一次性加载所有路由造成不必要的启动成本。运行期只会按需加载 group，相当于将整张路由表分片加载，这就是 <code>ARouter</code> 的“延迟加载机制”。</strong></p>
<h3 data-id="heading-6">初始化时期</h3>
<p>当应用启动调用 <code>ARouter.init(application)</code>时，就进入了初始化阶段，其核心任务是将编译期生成的各类索引(<strong>编译期间通过注解处理器自动生成的一系列映射表，上面的两个java文件就是其中最重要的索引</strong>)加载到内存中。该阶段的入口在<code>init</code>方法中</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">init</span>(<span class="hljs-params">Application application</span>)</span> {
    ARouter.hasInit = <span class="hljs-literal">true</span>;
    LogisticsCenter.<span class="hljs-keyword">init</span>(application);
}
</code></pre>
<p>通过该入口我们实际可以看出，初始化阶段的核心逻辑在 <code>LogisticsCenter.init()</code>方法中。</p>
<p>初始化的关键工作是：<strong>找到所有编译期生成的 Root 实现类(上面说的RouteRoot_AROUTER.java)，并调用它们把 groups 注册到 Warehouse.groupsIndex</strong>。核心代码如下</p>
<pre><code class="hljs language-ini" lang="ini">public static void init(Context context) {
    ...
        Set&lt;String&gt; <span class="hljs-attr">classNames</span> = ClassUtils.getFileNameByPackageName(context, <span class="hljs-string">"com.alibaba.android.arouter.routes"</span>)<span class="hljs-comment">;</span>
    ...
        for (String className : classNames) {
            if (className.startsWith("ARouter$$Root$$")) {
                Class&lt;?&gt; <span class="hljs-attr">clazz</span> = Class.forName(className, <span class="hljs-literal">false</span>, classLoader)<span class="hljs-comment">;</span>
                IRouteRoot <span class="hljs-attr">root</span> = (IRouteRoot) clazz.newInstance()<span class="hljs-comment">;</span>
                root.loadInto(Warehouse.groupsIndex)<span class="hljs-comment">;  // 填充 group到GroupClass</span>
            }
        }
    }
</code></pre>
<p>这里<code>Class&lt;?&gt; clazz = Class.forName(className, false, classLoader);</code>用反射加载了编译期生成的路由表类，但是但这个 <code>Class.forName()</code> 不是大量反射并且整个过程只执行一次，所以性能几乎没有影响。</p>
<p>这里强调一下，初始化时<strong>只缓存了Group的索引</strong>，仅仅是将编译期生成的路由组索引信息缓存到 <code>Warehouse.groupsIndex</code>，相当于建立了一份总目录，以<strong>组名（Group）</strong> 为 Key，对应的<strong>路由组类（如 <code>ARouter$$Group$$home.class</code>）</strong> 为 Value 。而<strong>每个Group下的具体路由信息，是在该组第一次被访问时才动态加载和缓存的</strong>。这种“分组懒加载”的设计是<code>ARouter</code>在性能优化上的一个关键点，它确保了应用启动速度快，且运行时内存占用合理。</p>
<h3 data-id="heading-7">运行期</h3>
<p>编译期生成了很多 <code>ARouter$$Root$$*</code>、<code>ARouter$$Group$$*</code>、<code>*$$ARouter$$Autowired</code>、<code>ARouter$$Interceptors$$*</code> 类；运行期通过加载这些生成类把路由索引（<code>group</code> → <code>groupClass</code>，<code>path</code> → <code>RouteMeta</code>）填入 <code>Warehouse</code>，<code>ARouter.build(path)</code> 构造 <code>Postcard</code>，<code>navigation()</code> 负责：确保路由已加载、处理拦截器、准备 Intent / 参数、执行跳转或返回 provider/fragment 等。运行期主要分为三大模块，<strong>构建 <code>Postcard</code></strong>、<strong><code>LogisticsCenter.prepareCard()</code>：加载 <code>group</code> 文件</strong>、<strong>跳转与拦截器链</strong></p>
<p>当我们调用 <code>ARouter.getinstance().build()</code> 时，其实是在创建一个明信片 <code>Postcard</code> 对象，<code>withXXX()</code> 和 <code>navigation()</code> 等方法就是它的方法。我们看一下<code>build()</code>的源码</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">public</span> <span class="hljs-title class_">Postcard</span> <span class="hljs-title function_">build</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> path</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Postcard</span>(path, <span class="hljs-title function_">extractGroup</span>(path));
}
</code></pre>
<p><code>Postcard</code> 继承了 <code>RouteMeta</code>，包含了目的地址（路径、分组）以及后续可能添加的参数（Extras）等信息 。但此时明信片上的“收件人 <strong>”目标类</strong>还是未知的。真正的核心逻辑继续看 <code>navigation()</code>方法。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">navigation</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Context context, <span class="hljs-keyword">final</span> Postcard postcard, <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> requestCode, <span class="hljs-keyword">final</span> NavigationCallback callback)</span> {
    .......
    LogisticsCenter.completion(postcard); <span class="hljs-comment">// 解析路由 / 加载 group</span>
    .......
    <span class="hljs-comment">// 执行拦截器链</span>
    <span class="hljs-keyword">if</span> (!postcard.isGreenChannel()) {
        interceptorService.doInterceptions(postcard, <span class="hljs-keyword">new</span> <span class="hljs-title class_">InterceptorCallback</span>() {
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onContinue</span><span class="hljs-params">(Postcard postcard)</span> {
                _navigation()
            }
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onInterrupt</span><span class="hljs-params">(Throwable throwable)</span> {
                callback.onInterrupt()
            }
        });
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">return</span> _navigation();
    }
}
</code></pre>
<p>其中代码<code>LogisticsCenter.completion(postcard)</code><strong>根据路径找到对应的目标类，并将信息填充到Postcard中</strong>。<code>completion</code>的代码如下，就是从缓存中通过 <code>path</code>查找 <code>RouteMeta</code>。</p>
<pre><code class="hljs language-ini" lang="ini">public static void completion(Postcard postcard) {
    RouteMeta <span class="hljs-attr">meta</span> = Warehouse.routes.get(postcard.getPath())<span class="hljs-comment">;</span>
    if (<span class="hljs-attr">meta</span> == null) {
        loadGroupIfNecessary(postcard.getGroup())<span class="hljs-comment">;</span>
        <span class="hljs-attr">meta</span> = Warehouse.routes.get(postcard.getPath())<span class="hljs-comment">;</span>
    }
    postcard.setRouteMeta(meta)<span class="hljs-comment">;</span>
}
</code></pre>
<p>如果没有即<code>meta == null</code>，则延迟加载 <code>group：loadGroupIfNecessary()</code>，核心代码如下。</p>
<p>首先从 <strong>分组索引表</strong> (<code>Warehouse.groupsIndex</code>) 中获取该组对应的“组加载器”的 Class 对象</p>
<p>接着通过<strong>反射</strong>机制<code>groupMeta.getConstructor().newInstance();</code>将上一步获取到的 <strong>Class 对象</strong>实例化，其中<code>group.loadInto(Warehouse.routes)</code>这个方法会一次性将 <code>home</code>分组下的<strong>所有</strong>路由（包括 <code>/home/main</code>和 <code>/home/detail</code>）的 <code>RouteMeta</code>信息都添加到 <code>Warehouse.routes</code>缓存中。</p>
<p>最后再从分组索引表中将该group移除，因为该Group的路由信息已经加载到缓存了，下次再找目标类并填充到Postcard时直接就在缓存中找到了。</p>
<p>这个过程也用到了反射，因为前面初始化阶段为了性能考虑，仅仅缓存了以<strong>组名（Group）</strong> 为 Key，对应的<strong>路由组类（如 <code>ARouter$$Group$$home.class</code>）</strong> 为 Value 的路由组信息，得不到实例类（想得到要么在运行前将所有的routes进行加载然后按需使用，要么对所有routes进行反射遍历，前者费空间后者又费时间）</p>
<pre><code class="hljs language-ini" lang="ini">Class&lt;? extends IRouteGroup&gt; <span class="hljs-attr">groupMeta</span> = Warehouse.groupsIndex.get(groupName)<span class="hljs-comment">;</span>
IRouteGroup <span class="hljs-attr">group</span> =  groupMeta.getConstructor().newInstance()<span class="hljs-comment">;</span>
group.loadInto(Warehouse.routes)<span class="hljs-comment">;</span>
Warehouse.groupsIndex.remove(groupName)<span class="hljs-comment">;</span>
</code></pre>
<p>当 Postcard 填充完 <code>RouteMeta</code> 后，<code>ARouter</code> 会继续执行拦截器链，即下面这段代码。</p>
<pre><code class="hljs language-typescript" lang="typescript">   <span class="hljs-keyword">if</span> (!postcard.<span class="hljs-title function_">isGreenChannel</span>()) {
        interceptorService.<span class="hljs-title function_">doInterceptions</span>(postcard, <span class="hljs-keyword">new</span> <span class="hljs-title class_">InterceptorCallback</span>() {
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">onContinue</span>(<span class="hljs-params">Postcard postcard</span>) {
                <span class="hljs-title function_">_navigation</span>()
            }
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">onInterrupt</span>(<span class="hljs-params">Throwable throwable</span>) {
                callback.<span class="hljs-title function_">onInterrupt</span>()
            }
        });
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">_navigation</span>();
    }
}
</code></pre>
<p>这段代码的逻辑还是比较清楚的，如果这次跳转没有开启“绿色通道”，拦截器链就会被启动。会进行<strong>链式执行</strong>：<code>ARouter</code>会按照优先级顺序，依次调用每个拦截器的 <code>process</code>方法。每个拦截器在执行完自己的逻辑后，<strong>必须</strong>调用以下两个回调函数之一来决定路由的走向</p>
<ul>
<li><strong><code>callback.onContinue(postcard)</code></strong> ：表示放行，流程将继续交给下一个拦截器。</li>
<li><strong><code>callback.onInterrupt(throwable)</code></strong> ：表示中断，整个跳转过程会立即停止，后续拦截器不再执行，并通过 <code>NavigationCallback</code>通知调用者跳转被拦截了。<strong>一旦有一个拦截器interrupt 整个跳转就终止，所有拦截器都通过后才执行真正的跳转</strong></li>
</ul>
<p>最终调用<code>_navigation</code>进行跳转，内部还是利用<code>Intent</code>跳转，结尾整个ARouter的流程</p>
<pre><code class="hljs language-scss" lang="scss">private <span class="hljs-selector-tag">Object</span> <span class="hljs-built_in">_navigation</span>() {
​
    <span class="hljs-built_in">switch</span>(routeMeta.type) {
​
        case ACTIVITY:
            Intent intent = new <span class="hljs-built_in">Intent</span>(context, routeMeta.<span class="hljs-built_in">getDestination</span>());
            postcard<span class="hljs-selector-class">.putExtras</span>(intent);
            
            if (requestCode &gt; <span class="hljs-number">0</span>) {
                ((Activity) context)<span class="hljs-selector-class">.startActivityForResult</span>(intent, requestCode);
            } else {
                context<span class="hljs-selector-class">.startActivity</span>(intent);
            }
            break;
​
        case PROVIDER:
            return <span class="hljs-built_in">getOrCreateProvider</span>(routeMeta);
        
        case FRAGMENT:
            Fragment fragment = routeMeta.<span class="hljs-built_in">getDestination</span>().<span class="hljs-built_in">newInstance</span>();
            fragment<span class="hljs-selector-class">.setArguments</span>(postcard.getExtras());
            return fragment;
​
        <span class="hljs-comment">// 其他类型略...</span>
    }
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vite 插件开发实战：从业务痛点到优雅解决方案]]></title>    <link>https://juejin.cn/post/7581844141669580840</link>    <guid>https://juejin.cn/post/7581844141669580840</guid>    <pubDate>2025-12-10T07:53:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581844141669580840" data-draft-id="7581844141669548072" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vite 插件开发实战：从业务痛点到优雅解决方案"/> <meta itemprop="keywords" content="架构,前端框架,Vue.js"/> <meta itemprop="datePublished" content="2025-12-10T07:53:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="大象的鼻子那么长"/> <meta itemprop="url" content="https://juejin.cn/user/2277843821926871"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vite 插件开发实战：从业务痛点到优雅解决方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2277843821926871/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    大象的鼻子那么长
  </span> <!----> <!----> <div class="vip-level" data-v-cd7d0a50="" data-v-292f6e48=""><span class="tooltip" data-v-cd7d0a50=""><div class="byte-tooltip byte-tooltip--dark" style="display:none;">
        VIP.4 融会贯通
      </div><span class="byte-tooltip__wrapper"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8AQMAAAAAMksxAAAAA1BMVEUAAACnej3aAAAAAXRSTlMAQObYZgAAAA5JREFUKM9jGAWjAAcAAAIcAAE27nY6AAAAAElFTkSuQmCC" alt="VIP.4 融会贯通" title="VIP.4 融会贯通" class="lazy" style="aspect-ratio:NaN;" data-v-5244ef91="" data-v-cd7d0a50=""/></span></span></div> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T07:53:03.000Z" title="Wed Dec 10 2025 07:53:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><strong>日期</strong>: 2025-12-10<br/>
<strong>标签</strong>: Vite, 插件开发, Vue3, 工程化, 性能优化</p>
</blockquote>
<hr/>
<h2 data-id="heading-0">📖 前言</h2>
<p>在企业级 Vue 3 项目开发中，我们经常会遇到一些"小而烦"的问题——它们不复杂，但需要开发者在每个页面重复做同样的事情。这类问题最适合通过工程化手段来解决。</p>
<p>本文将以一个真实的业务需求为例，带你从零开始开发一个 Vite 插件，体验<strong>从痛点发现到优雅解决</strong>的完整过程。</p>
<p><strong>你将学到：</strong></p>
<ul>
<li>🎯 Vite 插件的核心概念和工作原理</li>
<li>🛠️ 如何从零开发一个实用的 Vite 插件</li>
<li>📊 插件开发的调试技巧和最佳实践</li>
<li>💡 工程化思维：如何识别和解决重复性问题</li>
</ul>
<hr/>
<h2 data-id="heading-1">一、业务痛点：Keep-Alive 的"名称陷阱"</h2>
<h3 data-id="heading-2">1.1 问题背景</h3>
<p>在 Vue 3 中，<code>&lt;keep-alive&gt;</code> 通过 <code>include</code> 属性控制哪些组件需要缓存：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;keep-alive :include="['UserList', 'OrderList']"&gt;
  &lt;router-view /&gt;
&lt;/keep-alive&gt;
</code></pre>
<p>问题来了：<strong><code>include</code> 匹配的是组件的 <code>name</code> 属性</strong>。</p>
<p>在 Vue 3 的 <code>&lt;script setup&gt;</code> 语法中，组件默认是没有 <code>name</code> 的！必须手动添加：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup lang="ts"&gt;
// 必须手动添加这段代码，否则 keep-alive 无法匹配
defineOptions({
  name: 'UserList', // 必须与路由 name 一致
})
&lt;/script&gt;
</code></pre>
<h3 data-id="heading-3">1.2 痛点分析</h3>
<p>这看起来只是"加一行代码"的事，但在实际项目中：</p>

























<table><thead><tr><th>问题</th><th>影响</th></tr></thead><tbody><tr><td>容易遗漏</td><td>新页面忘记添加，缓存不生效</td></tr><tr><td>容易写错</td><td>名称与路由 name 不一致，缓存失效</td></tr><tr><td>重复劳动</td><td>每个页面都要写同样的代码</td></tr><tr><td>维护成本</td><td>路由 name 改了，还要同步改组件</td></tr></tbody></table>
<p>在一个有 50+ 页面的项目中，这意味着：</p>
<ul>
<li>50+ 处需要手动添加</li>
<li>50+ 个潜在的出错点</li>
<li>无法自动检测问题</li>
</ul>
<h3 data-id="heading-4">1.3 理想解决方案</h3>
<pre><code class="hljs">既然路由配置中已经有了 name 和 component 的映射关系，
为什么不让构建工具自动帮我们注入呢？
</code></pre>
<p>这就是 Vite 插件大显身手的时候了！</p>
<hr/>
<h2 data-id="heading-5">二、Vite 插件入门</h2>
<h3 data-id="heading-6">2.1 什么是 Vite 插件？</h3>
<p>Vite 插件是一个符合特定接口的 JavaScript 对象，它可以<strong>介入 Vite 的构建流程</strong>，在特定时机执行自定义逻辑。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 最简单的 Vite 插件结构</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">myPlugin</span>(<span class="hljs-params"/>): <span class="hljs-title class_">Plugin</span> {
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">name</span>: <span class="hljs-string">'my-plugin'</span>, <span class="hljs-comment">// 插件名称（必需）</span>
    
    <span class="hljs-comment">// 各种钩子函数</span>
    <span class="hljs-title function_">configResolved</span>(<span class="hljs-params">config</span>) { },  <span class="hljs-comment">// 配置解析完成</span>
    <span class="hljs-title function_">transform</span>(<span class="hljs-params">code, id</span>) { },     <span class="hljs-comment">// 转换模块内容</span>
    <span class="hljs-comment">// ...</span>
  }
}
</code></pre>
<h3 data-id="heading-7">2.2 核心概念</h3>
<h4 data-id="heading-8">钩子函数（Hooks）</h4>
<p>Vite 插件通过钩子函数介入构建流程：</p>
<pre><code class="hljs language-arduino" lang="arduino">配置阶段                    构建阶段                    输出阶段
    │                          │                          │
    ▼                          ▼                          ▼
┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐
│ config  │───▶│ resolve │───▶│transform│───▶│ render  │
└─────────┘    └─────────┘    └─────────┘    └─────────┘
    │              │              │              │
  配置合并      解析模块ID      转换代码        生成输出
</code></pre>
<p>常用钩子：</p>






























<table><thead><tr><th>钩子</th><th>时机</th><th>典型用途</th></tr></thead><tbody><tr><td><code>config</code></td><td>配置合并前</td><td>修改 Vite 配置</td></tr><tr><td><code>configResolved</code></td><td>配置解析完成</td><td>读取最终配置</td></tr><tr><td><code>transform</code></td><td>转换模块时</td><td>修改代码内容</td></tr><tr><td><code>handleHotUpdate</code></td><td>HMR 更新时</td><td>自定义热更新逻辑</td></tr></tbody></table>
<h4 data-id="heading-9">enforce 执行顺序</h4>
<pre><code class="hljs language-typescript" lang="typescript">{
  <span class="hljs-attr">name</span>: <span class="hljs-string">'my-plugin'</span>,
  <span class="hljs-attr">enforce</span>: <span class="hljs-string">'pre'</span>,  <span class="hljs-comment">// 在其他插件之前执行</span>
  <span class="hljs-comment">// enforce: 'post', // 在其他插件之后执行</span>
  <span class="hljs-comment">// 不设置则按默认顺序</span>
}
</code></pre>
<h3 data-id="heading-10">2.3 为什么选择 Vite 插件？</h3>
<p>对比其他方案：</p>

























<table><thead><tr><th>方案</th><th>优点</th><th>缺点</th></tr></thead><tbody><tr><td>ESLint 规则</td><td>可以检测</td><td>只能提醒，无法自动修复</td></tr><tr><td>代码生成脚本</td><td>一次性生成</td><td>需要手动运行，易遗漏</td></tr><tr><td><strong>Vite 插件</strong></td><td>自动、实时、无感知</td><td>需要一定开发成本</td></tr></tbody></table>
<p>Vite 插件的核心优势：<strong>在编译时自动处理，对开发者完全透明</strong>。</p>
<hr/>
<h2 data-id="heading-11">三、实战：开发自动注入插件</h2>
<h3 data-id="heading-12">3.1 设计思路</h3>
<pre><code class="hljs language-bash" lang="bash">┌─────────────────────────────────────────────────────────────┐
│                    插件工作流程                               │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  1. 启动时扫描路由配置                                        │
│     ┌─────────────────────────────────────────────────────┐ │
│     │ src/router/modules/*.ts                             │ │
│     │ ─────────────────────                               │ │
│     │ { name: <span class="hljs-string">'UserList'</span>, component: () =&gt; import(...) }  │ │
│     └─────────────────────────────────────────────────────┘ │
│                         │                                   │
│                         ▼                                   │
│  2. 构建映射表                                               │
│     ┌─────────────────────────────────────────────────────┐ │
│     │ Map&lt;组件路径, 路由名称&gt;                               │ │
│     │ <span class="hljs-string">'src/views/user/list.vue'</span> =&gt; <span class="hljs-string">'UserList'</span>             │ │
│     └─────────────────────────────────────────────────────┘ │
│                         │                                   │
│                         ▼                                   │
│  3. 编译时检测 &amp; 注入                                        │
│     ┌─────────────────────────────────────────────────────┐ │
│     │ 是路由组件？ ──否──▶ 跳过                            │ │
│     │      │                                              │ │
│     │      是                                             │ │
│     │      │                                              │ │
│     │      ▼                                              │ │
│     │ 已有 defineOptions？ ──是──▶ 跳过                   │ │
│     │      │                                              │ │
│     │      否                                             │ │
│     │      │                                              │ │
│     │      ▼                                              │ │
│     │ 自动注入 defineOptions({ name: <span class="hljs-string">'xxx'</span> })             │ │
│     └─────────────────────────────────────────────────────┘ │
│                                                             │
└─────────────────────────────────────────────────────────────┘
</code></pre>
<h3 data-id="heading-13">3.2 完整代码实现</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// build/plugins/vite-plugin-auto-component-name.ts</span>
<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">Plugin</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite'</span>
<span class="hljs-keyword">import</span> fs <span class="hljs-keyword">from</span> <span class="hljs-string">'node:fs'</span>
<span class="hljs-keyword">import</span> path <span class="hljs-keyword">from</span> <span class="hljs-string">'node:path'</span>

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">Options</span> {
  <span class="hljs-comment">/** 路由配置目录 */</span>
  routerDir?: <span class="hljs-built_in">string</span>
  <span class="hljs-comment">/** 是否输出调试日志 */</span>
  debug?: <span class="hljs-built_in">boolean</span>
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">autoComponentName</span>(<span class="hljs-params">options: Options = {}</span>): <span class="hljs-title class_">Plugin</span> {
  <span class="hljs-keyword">const</span> {
    routerDir = <span class="hljs-string">'src/router/modules'</span>,
    debug = <span class="hljs-literal">false</span>,
  } = options

  <span class="hljs-comment">// 组件路径 =&gt; 路由名称 的映射</span>
  <span class="hljs-keyword">const</span> routeMappings = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">string</span>&gt;()
  <span class="hljs-keyword">let</span> projectRoot = <span class="hljs-string">''</span>

  <span class="hljs-comment">// 调试日志</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">log</span>(<span class="hljs-params">...args: <span class="hljs-built_in">any</span>[]</span>) {
    <span class="hljs-keyword">if</span> (debug) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">'[auto-component-name]'</span>, ...args)
    }
  }

  <span class="hljs-comment">// 解析路由文件，提取映射关系</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">parseRouterFile</span>(<span class="hljs-params">filePath: <span class="hljs-built_in">string</span></span>) {
    <span class="hljs-keyword">const</span> content = fs.<span class="hljs-title function_">readFileSync</span>(filePath, <span class="hljs-string">'utf-8'</span>)
    <span class="hljs-keyword">const</span> lines = content.<span class="hljs-title function_">split</span>(<span class="hljs-string">'\n'</span>)
    <span class="hljs-keyword">let</span> currentName = <span class="hljs-string">''</span>

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> line <span class="hljs-keyword">of</span> lines) {
      <span class="hljs-comment">// 匹配 name: 'xxx'</span>
      <span class="hljs-keyword">const</span> nameMatch = line.<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/name:\s*['"`]([^'"`]+)['"`]/</span>)
      <span class="hljs-keyword">if</span> (nameMatch) {
        currentName = nameMatch[<span class="hljs-number">1</span>]
      }

      <span class="hljs-comment">// 匹配 component: () =&gt; import('xxx')</span>
      <span class="hljs-keyword">const</span> componentMatch = line.<span class="hljs-title function_">match</span>(
        <span class="hljs-regexp">/component:\s*(?:async\s*)?\(\)\s*=&gt;\s*import\(['"`]([^'"`]+)['"`]\)/</span>
      )
      <span class="hljs-keyword">if</span> (componentMatch &amp;&amp; currentName) {
        <span class="hljs-keyword">const</span> componentPath = <span class="hljs-title function_">normalizeImportPath</span>(componentMatch[<span class="hljs-number">1</span>])
        routeMappings.<span class="hljs-title function_">set</span>(componentPath, currentName)
        <span class="hljs-title function_">log</span>(<span class="hljs-string">`Found: <span class="hljs-subst">${currentName}</span> =&gt; <span class="hljs-subst">${componentPath}</span>`</span>)
        currentName = <span class="hljs-string">''</span>
      }
    }
  }

  <span class="hljs-comment">// 标准化导入路径</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">normalizeImportPath</span>(<span class="hljs-params">importPath: <span class="hljs-built_in">string</span></span>): <span class="hljs-built_in">string</span> {
    <span class="hljs-keyword">return</span> importPath
      .<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/^~\//</span>, <span class="hljs-string">'src/'</span>)
      .<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/^@\//</span>, <span class="hljs-string">'src/'</span>)
      .<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/\\/g</span>, <span class="hljs-string">'/'</span>)
  }

  <span class="hljs-comment">// 扫描所有路由文件</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">scanRouterModules</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> routerPath = path.<span class="hljs-title function_">resolve</span>(projectRoot, routerDir)
    <span class="hljs-keyword">if</span> (!fs.<span class="hljs-title function_">existsSync</span>(routerPath)) <span class="hljs-keyword">return</span>

    routeMappings.<span class="hljs-title function_">clear</span>()
    <span class="hljs-keyword">const</span> files = fs.<span class="hljs-title function_">readdirSync</span>(routerPath).<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">f</span> =&gt;</span> f.<span class="hljs-title function_">endsWith</span>(<span class="hljs-string">'.ts'</span>))
    
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> file <span class="hljs-keyword">of</span> files) {
      <span class="hljs-title function_">parseRouterFile</span>(path.<span class="hljs-title function_">join</span>(routerPath, file))
    }
    
    <span class="hljs-title function_">log</span>(<span class="hljs-string">`Scanned <span class="hljs-subst">${files.length}</span> files, found <span class="hljs-subst">${routeMappings.size}</span> routes`</span>)
  }

  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">name</span>: <span class="hljs-string">'vite-plugin-auto-component-name'</span>,
    <span class="hljs-attr">enforce</span>: <span class="hljs-string">'pre'</span>, <span class="hljs-comment">// 在 Vue 插件之前执行</span>

    <span class="hljs-comment">// 配置解析完成后，扫描路由</span>
    <span class="hljs-title function_">configResolved</span>(<span class="hljs-params">config</span>) {
      projectRoot = config.<span class="hljs-property">root</span>
      <span class="hljs-title function_">scanRouterModules</span>()
    },

    <span class="hljs-comment">// 路由文件变化时，重新扫描</span>
    <span class="hljs-title function_">handleHotUpdate</span>(<span class="hljs-params">{ file }</span>) {
      <span class="hljs-keyword">if</span> (file.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'router'</span>) &amp;&amp; file.<span class="hljs-title function_">endsWith</span>(<span class="hljs-string">'.ts'</span>)) {
        <span class="hljs-title function_">log</span>(<span class="hljs-string">'Router changed, rescanning...'</span>)
        <span class="hljs-title function_">scanRouterModules</span>()
      }
    },

    <span class="hljs-comment">// 转换 Vue 文件</span>
    <span class="hljs-title function_">transform</span>(<span class="hljs-params">code, id</span>) {
      <span class="hljs-comment">// 只处理 Vue 文件</span>
      <span class="hljs-keyword">if</span> (!id.<span class="hljs-title function_">endsWith</span>(<span class="hljs-string">'.vue'</span>)) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>

      <span class="hljs-comment">// 获取相对路径</span>
      <span class="hljs-keyword">const</span> relativePath = path.<span class="hljs-title function_">relative</span>(projectRoot, id).<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/\\/g</span>, <span class="hljs-string">'/'</span>)
      
      <span class="hljs-comment">// 查找是否为路由组件</span>
      <span class="hljs-keyword">const</span> routeName = routeMappings.<span class="hljs-title function_">get</span>(relativePath)
      <span class="hljs-keyword">if</span> (!routeName) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>

      <span class="hljs-comment">// 已有 defineOptions 则跳过</span>
      <span class="hljs-keyword">if</span> (code.<span class="hljs-title function_">includes</span>(<span class="hljs-params"><span class="hljs-string">'defineOptions('</span></span>)) {
        <span class="hljs-title function_">log</span>(<span class="hljs-string">`Skip <span class="hljs-subst">${relativePath}</span>: already has defineOptions`</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
      }

      <span class="hljs-comment">// 查找 &lt;script setup&gt; 标签</span>
      <span class="hljs-keyword">const</span> match = code.<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/&lt;script\s+setup[^&gt;]*&gt;([\s\S]*?)&lt;\/script&gt;/i</span>)
      <span class="hljs-keyword">if</span> (!match) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>

      <span class="hljs-comment">// 构造注入代码</span>
      <span class="hljs-keyword">const</span> injection = <span class="hljs-string">`
/**
 * 组件名称（由 vite-plugin-auto-component-name 自动注入）
 */
defineOptions({
  name: '<span class="hljs-subst">${routeName}</span>',
})
`</span>
      <span class="hljs-comment">// 在 import 语句之后注入</span>
      <span class="hljs-keyword">const</span> scriptStart = match.<span class="hljs-property">index</span>! + match[<span class="hljs-number">0</span>].<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">'&gt;'</span>) + <span class="hljs-number">1</span>
      <span class="hljs-keyword">const</span> scriptContent = match[<span class="hljs-number">1</span>]
      
      <span class="hljs-comment">// 找到最后一个 import 的位置</span>
      <span class="hljs-keyword">let</span> insertPos = scriptStart
      <span class="hljs-keyword">const</span> lines = scriptContent.<span class="hljs-title function_">split</span>(<span class="hljs-string">'\n'</span>)
      <span class="hljs-keyword">let</span> offset = <span class="hljs-number">0</span>
      
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> line <span class="hljs-keyword">of</span> lines) {
        offset += line.<span class="hljs-property">length</span> + <span class="hljs-number">1</span>
        <span class="hljs-keyword">if</span> (line.<span class="hljs-title function_">trim</span>().<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'import '</span>)) {
          insertPos = scriptStart + offset
        }
      }

      <span class="hljs-keyword">const</span> newCode = code.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, insertPos) + injection + code.<span class="hljs-title function_">slice</span>(insertPos)
      
      <span class="hljs-title function_">log</span>(<span class="hljs-string">`Injected: <span class="hljs-subst">${relativePath}</span> =&gt; <span class="hljs-subst">${routeName}</span>`</span>)
      
      <span class="hljs-keyword">return</span> { <span class="hljs-attr">code</span>: newCode, <span class="hljs-attr">map</span>: <span class="hljs-literal">null</span> }
    },
  }
}
</code></pre>
<h3 data-id="heading-14">3.3 使用方式</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// vite.config.ts</span>
<span class="hljs-keyword">import</span> { autoComponentName } <span class="hljs-keyword">from</span> <span class="hljs-string">'./build/plugins/vite-plugin-auto-component-name'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-attr">plugins</span>: [
    <span class="hljs-title function_">autoComponentName</span>({
      <span class="hljs-attr">routerDir</span>: <span class="hljs-string">'src/router/modules'</span>,
      <span class="hljs-attr">debug</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 开发时开启日志</span>
    }),
    <span class="hljs-title function_">vue</span>(),
    <span class="hljs-comment">// ...其他插件</span>
  ],
})
</code></pre>
<h3 data-id="heading-15">3.4 效果对比</h3>
<p><strong>之前（每个页面手动添加）</strong>：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup lang="ts"&gt;
import { ref } from 'vue'

// 必须手动添加，容易遗漏
defineOptions({
  name: 'UserList',
})

// 业务代码...
&lt;/script&gt;
</code></pre>
<p><strong>之后（自动注入，零成本）</strong>：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup lang="ts"&gt;
import { ref } from 'vue'

// 无需任何代码，插件自动处理！
// 编译后会自动包含 defineOptions({ name: 'UserList' })

// 业务代码...
&lt;/script&gt;
</code></pre>
<hr/>
<h2 data-id="heading-16">四、调试技巧</h2>
<h3 data-id="heading-17">4.1 开启调试日志</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-title function_">autoComponentName</span>({
  <span class="hljs-attr">debug</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 控制台输出注入日志</span>
})
</code></pre>
<p>输出示例：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-section">[auto-component-name]</span> Scanned 12 files, found 48 routes
<span class="hljs-section">[auto-component-name]</span> Injected: src/views/user/<span class="hljs-attr">list.vue</span> =&gt; UserList
<span class="hljs-section">[auto-component-name]</span> Skip src/views/user/detail.vue: already has defineOptions
</code></pre>
<h3 data-id="heading-18">4.2 查看转换后的代码</h3>
<p>在 Chrome DevTools 中：</p>
<ol>
<li>打开 Sources 面板</li>
<li>找到对应的 Vue 文件</li>
<li>查看编译后的代码，确认 <code>defineOptions</code> 已注入</li>
</ol>
<h3 data-id="heading-19">4.3 处理边界情况</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 需要考虑的边界情况：</span>

<span class="hljs-comment">// 1. 组件已有 defineOptions</span>
<span class="hljs-keyword">if</span> (code.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'defineOptions('</span>)) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>

<span class="hljs-comment">// 2. 使用 Options API（有 name 属性）</span>
<span class="hljs-keyword">if</span> (code.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'name:'</span>) &amp;&amp; code.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'export default'</span>)) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>

<span class="hljs-comment">// 3. 非 &lt;script setup&gt; 组件</span>
<span class="hljs-keyword">if</span> (!code.<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/&lt;script\s+setup/</span>)) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
</code></pre>
<hr/>
<h2 data-id="heading-20">五、最佳实践</h2>
<h3 data-id="heading-21">5.1 插件设计原则</h3>

























<table><thead><tr><th>原则</th><th>说明</th></tr></thead><tbody><tr><td><strong>幂等性</strong></td><td>多次执行结果一致，已处理过的跳过</td></tr><tr><td><strong>无侵入</strong></td><td>不影响已有代码，只添加缺失的部分</td></tr><tr><td><strong>可调试</strong></td><td>提供日志开关，方便排查问题</td></tr><tr><td><strong>高性能</strong></td><td>避免不必要的处理，尽早返回</td></tr></tbody></table>
<h3 data-id="heading-22">5.2 性能优化</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 1. 尽早返回</span>
<span class="hljs-keyword">if</span> (!id.<span class="hljs-title function_">endsWith</span>(<span class="hljs-string">'.vue'</span>)) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>

<span class="hljs-comment">// 2. 使用 Map 缓存映射关系</span>
<span class="hljs-keyword">const</span> routeMappings = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">string</span>&gt;()

<span class="hljs-comment">// 3. 避免重复扫描</span>
<span class="hljs-title function_">handleHotUpdate</span>(<span class="hljs-params">{ file }</span>) {
  <span class="hljs-comment">// 只有路由文件变化才重新扫描</span>
  <span class="hljs-keyword">if</span> (file.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'router'</span>) &amp;&amp; file.<span class="hljs-title function_">endsWith</span>(<span class="hljs-string">'.ts'</span>)) {
    <span class="hljs-title function_">scanRouterModules</span>()
  }
}
</code></pre>
<h3 data-id="heading-23">5.3 错误处理</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">parseRouterFile</span>(<span class="hljs-params">filePath: <span class="hljs-built_in">string</span></span>) {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> content = fs.<span class="hljs-title function_">readFileSync</span>(filePath, <span class="hljs-string">'utf-8'</span>)
    <span class="hljs-comment">// ... 解析逻辑</span>
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`[auto-component-name] Failed to parse <span class="hljs-subst">${filePath}</span>:`</span>, error)
  }
}
</code></pre>
<hr/>
<h2 data-id="heading-24">六、业务价值</h2>
<h3 data-id="heading-25">6.1 量化收益</h3>






























<table><thead><tr><th>指标</th><th>优化前</th><th>优化后</th></tr></thead><tbody><tr><td>每页面额外代码</td><td>5-10 行</td><td><strong>0 行</strong></td></tr><tr><td>潜在 Bug 点</td><td>N 个页面</td><td><strong>0</strong></td></tr><tr><td>新人上手成本</td><td>需要了解约定</td><td><strong>无感知</strong></td></tr><tr><td>维护成本</td><td>路由改名需同步</td><td><strong>自动同步</strong></td></tr></tbody></table>
<h3 data-id="heading-26">6.2 延伸价值</h3>
<p>这个插件的设计思路可以复用到其他场景：</p>
<ul>
<li><strong>自动注入页面权限</strong>: 根据路由 meta 注入权限检查代码</li>
<li><strong>自动生成埋点代码</strong>: 根据路由配置注入页面曝光埋点</li>
<li><strong>自动添加 Loading 状态</strong>: 为异步组件添加统一的加载状态</li>
</ul>
<h3 data-id="heading-27">6.3 工程化思维</h3>
<pre><code class="hljs">发现重复劳动 → 分析规律 → 自动化解决 → 沉淀为工具
</code></pre>
<p>这是工程化的核心思维：<strong>用机器代替人做重复的事</strong>。</p>
<hr/>
<h2 data-id="heading-28">七、总结</h2>
<p>本文通过一个真实的业务需求，完整演示了 Vite 插件的开发过程：</p>
<ol>
<li><strong>识别痛点</strong>：keep-alive 需要手动定义组件 name</li>
<li><strong>设计方案</strong>：扫描路由配置，编译时自动注入</li>
<li><strong>实现插件</strong>：利用 <code>configResolved</code> 和 <code>transform</code> 钩子</li>
<li><strong>调试优化</strong>：添加日志、处理边界情况、性能优化</li>
</ol>
<p><strong>关键收获：</strong></p>
<ul>
<li>Vite 插件是介入构建流程的强大工具</li>
<li><code>transform</code> 钩子可以修改任何模块的代码</li>
<li>好的插件应该是无侵入、幂等、可调试的</li>
<li>工程化的核心是用自动化消除重复劳动</li>
</ul>
<hr/>
<h2 data-id="heading-29">附录：Vite 插件开发资源</h2>
<ul>
<li>📚 <a href="https://link.juejin.cn?target=https%3A%2F%2Fcn.vitejs.dev%2Fguide%2Fapi-plugin.html" target="_blank" title="https://cn.vitejs.dev/guide/api-plugin.html" ref="nofollow noopener noreferrer">Vite 插件 API 官方文档</a></li>
<li>📚 <a href="https://link.juejin.cn?target=https%3A%2F%2Frollupjs.org%2Fplugin-development%2F" target="_blank" title="https://rollupjs.org/plugin-development/" ref="nofollow noopener noreferrer">Rollup 插件开发指南</a></li>
<li>🔧 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fantfu%2Fvite-plugin-inspect" target="_blank" title="https://github.com/antfu/vite-plugin-inspect" ref="nofollow noopener noreferrer">vite-plugin-inspect</a> - 调试插件必备</li>
<li>🎨 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fvitejs%2Fawesome-vite" target="_blank" title="https://github.com/vitejs/awesome-vite" ref="nofollow noopener noreferrer">awesome-vite</a> - 优秀插件合集</li>
</ul>
<hr/>
<blockquote>
<p>💬 <strong>欢迎交流</strong>：如果你有更好的想法或遇到问题，欢迎在评论区讨论！</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Gopher 带你学并发计数器：从最快到最慢的性能之旅]]></title>    <link>https://juejin.cn/post/7581786379804426275</link>    <guid>https://juejin.cn/post/7581786379804426275</guid>    <pubDate>2025-12-10T06:02:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581786379804426275" data-draft-id="7581814484065091636" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Gopher 带你学并发计数器：从最快到最慢的性能之旅"/> <meta itemprop="keywords" content="后端,Go"/> <meta itemprop="datePublished" content="2025-12-10T06:02:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="没多少逻辑"/> <meta itemprop="url" content="https://juejin.cn/user/2717648475395325"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Gopher 带你学并发计数器：从最快到最慢的性能之旅
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2717648475395325/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    没多少逻辑
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T06:02:38.000Z" title="Wed Dec 10 2025 06:02:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家是否觉得并发编程中的各种锁和同步机制让人头大？别担心，这篇指南将带你从性能的角度理解不同的并发计数器实现。我们将按照<strong>性能从快到慢</strong>的顺序，探索 6 种不同的实现方式，让你彻底理解并发编程的精髓！</p>
<hr/>
<h2 data-id="heading-0">第一部分：性能金字塔 (Performance Pyramid)</h2>
<p>在并发编程中，不同的同步机制有着天壤之别的性能表现。让我们先建立一个性能认知框架。</p>
<h3 data-id="heading-1">性能等级划分</h3>
<p><strong>一句话概念</strong>：并发计数器的性能取决于竞争激烈程度和同步开销。</p>
<ul>
<li><strong>Level 0 - 最快</strong>：Goroutine-Local（本地计数）</li>
<li><strong>Level 1 - 极快</strong>：Sharded Counter（分片计数器）</li>
<li><strong>Level 2 - 快</strong>：Atomic、CAS、Mutex（原子操作、比较交换、互斥锁）</li>
<li><strong>Level 3 - 中等</strong>：Yielding Ticket Lock（让步票据锁）</li>
<li><strong>Level 4 - 慢</strong>：Blocking Ticket Lock（阻塞票据锁）</li>
<li><strong>Level 5 - 灾难性</strong>：Spinning Ticket Lock（自旋票据锁）</li>
</ul>
<p><strong>核心原理</strong>：</p>
<ul>
<li>竞争越少，性能越好</li>
<li>阻塞越少，性能越好</li>
<li>CPU 缓存友好度越高，性能越好</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2add0342d28243aea308a246a615c85e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rKh5aSa5bCR6YC76L6R:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765951357&amp;x-signature=0IvrhU0RCEpgwTAvR4fBHLIpeYo%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-2">第二部分：高性能计数器 (Level 0-1)</h2>
<h3 data-id="heading-3">① Goroutine-Local Counter</h3>
<p><strong>一句话概念</strong>：每个 goroutine 独立计数，最后汇总。</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">BenchmarkGoroutineLocalCounter</span><span class="hljs-params">(b *testing.B)</span></span> {
    <span class="hljs-keyword">var</span> totalCounter <span class="hljs-type">int64</span>
    b.ResetTimer()
    b.RunParallel(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(pb *testing.PB)</span></span> {
        <span class="hljs-keyword">var</span> localCounter <span class="hljs-type">int64</span>  <span class="hljs-comment">// 本地变量，无竞争</span>
        <span class="hljs-keyword">for</span> pb.Next() {
            localCounter++      <span class="hljs-comment">// 纯本地操作</span>
        }
        <span class="hljs-comment">// 只在最后汇总一次</span>
        atomic.AddInt64(&amp;totalCounter, localCounter)
    })
}
</code></pre>
<p><strong>它是什么？</strong><br/>
每个 goroutine 使用自己的本地变量计数，完全避免了并发竞争。</p>
<p><strong>为什么最快？</strong></p>
<ul>
<li>无锁竞争：99.9% 的操作都是纯本地的</li>
<li>缓存友好：本地变量始终在 CPU 缓存中</li>
<li>只有一次原子操作：最后汇总时</li>
</ul>
<p><strong>适用场景</strong>：</p>
<ul>
<li>统计类场景（如请求计数、错误计数）</li>
<li>可以容忍最终一致性的业务</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/de2f640c165a4898a71b38ab82161cc3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rKh5aSa5bCR6YC76L6R:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765951357&amp;x-signature=Ex8bXAwjlg0245ZcJJio9B62eMI%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-4">② Sharded Counter</h3>
<p><strong>一句话概念</strong>：将竞争分散到多个分片上，降低冲突概率。</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">const</span> numShards = <span class="hljs-number">256</span>

<span class="hljs-keyword">type</span> ShardedCounter <span class="hljs-keyword">struct</span> {
    shards [numShards]<span class="hljs-keyword">struct</span> {
        counter <span class="hljs-type">int64</span>
        _ [<span class="hljs-number">56</span>]<span class="hljs-type">byte</span> <span class="hljs-comment">// 防止伪共享</span>
    }
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *ShardedCounter)</span></span> Inc() {
    idx := rand.Intn(numShards)  <span class="hljs-comment">// 随机选择分片</span>
    atomic.AddInt64(&amp;c.shards[idx].counter, <span class="hljs-number">1</span>)
}
</code></pre>
<p><strong>它是什么？</strong><br/>
将一个计数器拆分成多个独立的分片，随机选择分片进行操作。</p>
<p><strong>为什么极快？</strong></p>
<ul>
<li>降低竞争：256 个分片意味着竞争概率降低 256 倍</li>
<li>防止伪共享：56 字节填充确保每个分片在独立的缓存行</li>
<li>仍然是原子操作：保证线程安全</li>
</ul>
<p><strong>关键技术点</strong>：</p>
<pre><code class="hljs language-go" lang="go">_ [<span class="hljs-number">56</span>]<span class="hljs-type">byte</span> <span class="hljs-comment">// 缓存行填充</span>
</code></pre>
<p>现代 CPU 缓存行通常是 64 字节，int64 占 8 字节，填充 56 字节确保每个计数器独占一个缓存行。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a66cf21ccddd4f70b84ad30128a66312~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rKh5aSa5bCR6YC76L6R:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765951357&amp;x-signature=t2cy47FIXgRye9NgutSRZ5Vut%2Bw%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-5"><strong>第三部分</strong>：经典同步机制（Level 2）</h2>
<h3 data-id="heading-6">③ Atomic Counter</h3>
<p><strong>一句话概念</strong>：使用 CPU 原子指令，硬件级别的线程安全。</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">type</span> AtomicCounter <span class="hljs-keyword">struct</span> {
    counter <span class="hljs-type">int64</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *AtomicCounter)</span></span> Inc() {
    atomic.AddInt64(&amp;c.counter, <span class="hljs-number">1</span>)  <span class="hljs-comment">// 硬件原子操作</span>
}
</code></pre>
<p><strong>为什么快？</strong></p>
<ul>
<li>硬件支持：CPU 直接提供原子操作指令</li>
<li>无锁设计：不需要操作系统调度</li>
<li>缓存一致性：硬件自动处理</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/400e77b16580413c915f1516de9e29e3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rKh5aSa5bCR6YC76L6R:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765951357&amp;x-signature=EmkBt7tKB%2FojtvVMknTcB%2BAzr5A%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-7">④ CAS (Compare-And-Swap) Counter</h3>
<p><strong>一句话概念</strong>：乐观锁思想，失败重试直到成功。</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *CasCounter)</span></span> Inc() {
    <span class="hljs-keyword">for</span> {
        old := atomic.LoadInt64(&amp;c.counter)
        <span class="hljs-keyword">if</span> atomic.CompareAndSwapInt64(&amp;c.counter, old, old+<span class="hljs-number">1</span>) {
            <span class="hljs-keyword">return</span>  <span class="hljs-comment">// 成功则退出</span>
        }
        <span class="hljs-comment">// 失败则重试</span>
    }
}
</code></pre>
<p><strong>工作原理</strong>：</p>
<ol>
<li>读取当前值</li>
<li>尝试将 old 替换为 old+1</li>
<li>如果期间值被其他线程修改，重试</li>
</ol>
<p><strong>性能特点</strong>：</p>
<ul>
<li>低竞争时性能优秀</li>
<li>高竞争时可能频繁重试</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e7e37b3216004928b4ee872990c7b446~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rKh5aSa5bCR6YC76L6R:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765951357&amp;x-signature=BxKw2i3XCfcqYHsaXVrh8hgZhNg%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-8">⑤ Mutex Counter</h3>
<p><strong>一句话概念</strong>：传统互斥锁，简单可靠的同步机制。</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">type</span> MutexCounter <span class="hljs-keyword">struct</span> {
    mu      sync.Mutex
    counter <span class="hljs-type">int64</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *MutexCounter)</span></span> Inc() {
    c.mu.Lock()
    c.counter++    <span class="hljs-comment">// 临界区操作</span>
    c.mu.Unlock()
}
</code></pre>
<p><strong>为什么仍然快？</strong></p>
<ul>
<li>Go 的 Mutex 高度优化</li>
<li>快速路径：无竞争时几乎无开销</li>
<li>自适应：会在自旋和阻塞间切换</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4b606664dc2f481b938514be340eadfd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rKh5aSa5bCR6YC76L6R:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765951357&amp;x-signature=b4Ld0cZuUrDrFi0hnNiWnFP%2Fwmo%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-9"><strong>第四部分</strong>：票据锁机制（Level 3-5）</h2>
<h3 data-id="heading-10">⑥ Yielding Ticket Lock</h3>
<p><strong>一句话概念</strong>：公平排队，但会主动让出 CPU。</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">type</span> YieldingTicketLockCounter <span class="hljs-keyword">struct</span> {
    ticket <span class="hljs-type">uint64</span>  <span class="hljs-comment">// 发号器</span>
    turn   <span class="hljs-type">uint64</span>  <span class="hljs-comment">// 当前服务号</span>
    _      [<span class="hljs-number">48</span>]<span class="hljs-type">byte</span>
    counter <span class="hljs-type">int64</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *YieldingTicketLockCounter)</span></span> Inc() {
    myTurn := atomic.AddUint64(&amp;c.ticket, <span class="hljs-number">1</span>) - <span class="hljs-number">1</span>  <span class="hljs-comment">// 取号</span>
    
    spins := <span class="hljs-number">0</span>
    <span class="hljs-keyword">for</span> atomic.LoadUint64(&amp;c.turn) != myTurn {
        <span class="hljs-keyword">if</span> spins &lt; <span class="hljs-number">10</span> {
            spins++
            runtime.Gosched()  <span class="hljs-comment">// 让出 CPU</span>
        } <span class="hljs-keyword">else</span> {
            time.Sleep(time.Microsecond)  <span class="hljs-comment">// 短暂休眠</span>
        }
    }
    
    atomic.AddInt64(&amp;c.counter, <span class="hljs-number">1</span>)  <span class="hljs-comment">// 临界区</span>
    atomic.AddUint64(&amp;c.turn, <span class="hljs-number">1</span>)    <span class="hljs-comment">// 叫下一号</span>
}
</code></pre>
<p><strong>工作原理</strong>：</p>
<ol>
<li>先取号（ticket++）</li>
<li>等待轮到自己（turn == myTurn）</li>
<li>执行临界区操作</li>
<li>叫下一号（turn++）</li>
</ol>
<p><strong>性能特点</strong>：</p>
<ul>
<li>公平性好：严格按顺序执行</li>
<li>CPU 友好：主动让出 CPU，不浪费资源</li>
<li>延迟较高：需要排队等待</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e0798d89a9b74416b03b4f94979d3589~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rKh5aSa5bCR6YC76L6R:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765951357&amp;x-signature=BVb7PKWu24EOALKoKu%2FizWuEgVo%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-11">⑦ Blocking Ticket Lock</h3>
<p><strong>一句话概念</strong>：公平排队 + 条件变量阻塞等待。</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">type</span> BlockingTicketLockCounter <span class="hljs-keyword">struct</span> {
    mu     sync.Mutex
    cond   *sync.Cond
    ticket <span class="hljs-type">uint64</span>
    turn   <span class="hljs-type">uint64</span>
    counter <span class="hljs-type">int64</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *BlockingTicketLockCounter)</span></span> Inc() {
    c.mu.Lock()
    myTurn := c.ticket
    c.ticket++
    
    <span class="hljs-keyword">for</span> c.turn != myTurn {
        c.cond.Wait()  <span class="hljs-comment">// 阻塞等待</span>
    }
    c.mu.Unlock()
    
    atomic.AddInt64(&amp;c.counter, <span class="hljs-number">1</span>)
    
    c.mu.Lock()
    c.turn++
    c.cond.Broadcast()  <span class="hljs-comment">// 唤醒所有等待者</span>
    c.mu.Unlock()
}
</code></pre>
<p><strong>为什么慢？</strong></p>
<ul>
<li>多次加锁：每次操作需要多次获取锁</li>
<li>系统调用：Wait() 和 Broadcast() 涉及内核调用</li>
<li>上下文切换：线程阻塞和唤醒的开销</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ee70af96c40d429ebd2b278099fdadf9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rKh5aSa5bCR6YC76L6R:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765951357&amp;x-signature=Jc5%2Btg3pQyH83W%2B%2FuzXhD2pY%2F6Q%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-12">第七部分：Level 5 - 自旋票据锁 (灾难性)</h2>
<h3 data-id="heading-13">⑧ Spinning Ticket Lock</h3>
<p><strong>一句话概念</strong>：公平排队 + 忙等待，CPU 杀手。</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *SpinningTicketLockCounter)</span></span> Inc() {
    myTurn := atomic.AddUint64(&amp;c.ticket, <span class="hljs-number">1</span>) - <span class="hljs-number">1</span>
    
    <span class="hljs-keyword">for</span> atomic.LoadUint64(&amp;c.turn) != myTurn {
        <span class="hljs-comment">// 空循环忙等待 - CPU 100% 占用！</span>
    }
    
    c.counter++  <span class="hljs-comment">// 非原子操作！</span>
    atomic.AddUint64(&amp;c.turn, <span class="hljs-number">1</span>)
}
</code></pre>
<p><strong>为什么是灾难？</strong></p>
<ul>
<li>CPU 浪费：空循环消耗 100% CPU</li>
<li>缓存污染：频繁读取 turn 变量</li>
<li>非原子操作：counter++ 不是线程安全的</li>
<li>超订问题：goroutine 数量超过 CPU 核心时性能崩塌</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e995efa45fba4bbdb507b340da615846~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rKh5aSa5bCR6YC76L6R:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765951357&amp;x-signature=daINaU6lNxyK8nt7gLy2dywi688%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-14">-   <strong>第五部分</strong>：性能对比与选择指南</h2>
<h3 data-id="heading-15">性能测试结果</h3>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestOversubscriptionImpact</span><span class="hljs-params">(t *testing.T)</span></span> {
    goroutineCounts := []<span class="hljs-type">int</span>{<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">4</span>, <span class="hljs-number">8</span>, <span class="hljs-number">16</span>, <span class="hljs-number">32</span>}
    
    testCases := []<span class="hljs-keyword">struct</span> {
        name    <span class="hljs-type">string</span>
        counter Counter
    }{
        {<span class="hljs-string">"Atomic"</span>, &amp;AtomicCounter{}},
        {<span class="hljs-string">"Mutex"</span>, &amp;MutexCounter{}},
        {<span class="hljs-string">"Sharded"</span>, &amp;ShardedCounter{}},
    }
    
    <span class="hljs-comment">// 测试不同 goroutine 数量下的性能表现</span>
}
</code></pre>
<h3 data-id="heading-16">选择指南</h3>
<p><strong>高性能场景</strong>：</p>
<ul>
<li>优先选择：Goroutine-Local → Sharded → Atomic</li>
<li>关键考虑：能否接受最终一致性</li>
</ul>
<p><strong>通用场景</strong>：</p>
<ul>
<li>首选：Atomic 或 Mutex</li>
<li>Mutex 在高竞争时表现更稳定</li>
</ul>
<p><strong>公平性要求</strong>：</p>
<ul>
<li>选择：Yielding Ticket Lock</li>
<li>避免：Spinning Ticket Lock（除非 CPU 核心充足）</li>
</ul>
<h3 data-id="heading-17">伪共享问题</h3>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 错误示例：伪共享</span>
<span class="hljs-keyword">type</span> NoPaddingCounter <span class="hljs-keyword">struct</span> {
    counter1 <span class="hljs-type">int64</span>
    counter2 <span class="hljs-type">int64</span>  <span class="hljs-comment">// 与 counter1 在同一缓存行</span>
}

<span class="hljs-comment">// 正确示例：缓存行填充</span>
<span class="hljs-keyword">type</span> WithPaddingCounter <span class="hljs-keyword">struct</span> {
    counter1 <span class="hljs-type">int64</span>
    _        [<span class="hljs-number">56</span>]<span class="hljs-type">byte</span>  <span class="hljs-comment">// 填充到独立缓存行</span>
    counter2 <span class="hljs-type">int64</span>
}
</code></pre>
<p><strong>一句话概念</strong>：不相关的数据共享缓存行会导致性能下降。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1dfc5871fd004fb0a13ed073151e67f7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rKh5aSa5bCR6YC76L6R:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765951357&amp;x-signature=Eky%2BW09XAl5YTQNYcTTn8ggs%2Fbw%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-18">总结</h2>
<h3 data-id="heading-19">核心回顾</h3>
<p><strong>一句话总结</strong>：并发编程的核心是在正确性和性能间找到平衡。</p>
<p><strong>关键原则</strong>：</p>
<ol>
<li><strong>减少竞争</strong>：分片、本地化是性能优化的王道</li>
<li><strong>避免阻塞</strong>：能用原子操作就不用锁</li>
<li><strong>缓存友好</strong>：注意伪共享问题</li>
<li><strong>测试验证</strong>：不同场景下性能表现差异巨大</li>
</ol>
<p><strong>实践建议</strong>：</p>
<ul>
<li>从简单开始：Atomic 或 Mutex</li>
<li>性能不够再优化：考虑 Sharded 或 Goroutine-Local</li>
<li>避免过度设计：复杂的锁机制往往得不偿失</li>
</ul>
<p>记住，最好的并发代码不是最复杂的，而是最适合业务场景的！</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b62af26dce1f48cc90a395e758857fef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rKh5aSa5bCR6YC76L6R:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765951357&amp;x-signature=HoPloSmlDKCo50UrN5yBKljvmCM%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[别再付费生图了！N8N+即梦4.5无限免费用！]]></title>    <link>https://juejin.cn/post/7581786379804475427</link>    <guid>https://juejin.cn/post/7581786379804475427</guid>    <pubDate>2025-12-10T06:04:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581786379804475427" data-draft-id="7581844141668630568" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" 别再付费生图了！N8N+即梦4.5无限免费用！"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-12-10T06:04:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Java中文社群"/> <meta itemprop="url" content="https://juejin.cn/user/61228381386487"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             别再付费生图了！N8N+即梦4.5无限免费用！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/61228381386487/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Java中文社群
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T06:04:40.000Z" title="Wed Dec 10 2025 06:04:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>兄弟们，发现没？<strong>即梦（Jimeng）的4.5图片生成大模型悄悄上线了！</strong></p>
<p>这波更新可不是小打小闹，不仅模型能力大幅提升，更关键的是，我又给大家挖到了一条<strong>免费在工作流中调用它</strong>的路子。</p>
<p>今天这篇文章，咱们就来聊聊即梦 4.5 到底强在哪，以及如何不花一分钱 API 费用，把这波羊毛薅到手！</p>
<hr/>
<h2 data-id="heading-0">🎥 视频展示</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1ub2SB6EBK%2F" target="_blank" title="https://www.bilibili.com/video/BV1ub2SB6EBK/" ref="nofollow noopener noreferrer">www.bilibili.com/video/BV1ub…</a></p>
<hr/>
<h2 data-id="heading-1">🚀 即梦4.5的五大“杀手级”特性</h2>
<p>官方在提示词手册里其实已经明牌了，我也第一时间去实测了一下，总结下来主要有这 5 个质的飞跃。</p>
<h3 data-id="heading-2">1️⃣ 人像一致性 &amp; 美颜美体大幅提升</h3>
<p>玩过AI绘图的都知道，多人场景下的脸部崩坏是常态。<br/>
但在 4.5 版本里，ID 人脸一致性做得非常顶！<br/>
看对比图就能发现，4.0 版本容易出现人物混淆、脸部变形；而 4.5 生成的图片，不仅和原图保持了极高的一致性，自带的美颜美体效果也更自然了。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/25028afa10ee4978b2309f6dcaee8861~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeS4reaWh-ekvue-pA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765951479&amp;x-signature=wZK2IO8stDYTS1NrOmroDblrf5w%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-3">2️⃣ 美学质感升级</h3>
<p>简单来说，就是图更好看了。<br/>
对比 4.0 和 4.5 生成的同款提示词，4.5 在构图、光影和整体氛围感上，明显上了一个台阶。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8a27bc63b83641829908ca5629d299b0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeS4reaWh-ekvue-pA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765951479&amp;x-signature=R410Kk4xXrzRR9c3wrVjv4zTZWo%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-4">3️⃣ 指令遵循更精准</h3>
<p>这在“文生图”里太重要了。<br/>
举个例子，我想要一个“正面”的人物，4.0 可能还会给我出一个侧面的，但在 4.5 里，这种翻车的概率大大降低，模型对这类空间指令的理解力强了很多。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/070b417d11114899bd8899eea4cdd51b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeS4reaWh-ekvue-pA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765951479&amp;x-signature=Syl%2BhNd%2FFn%2BTu6%2B9DzZYFx%2FI32s%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-5">4️⃣ 编辑准确度（图生图）更强</h3>
<p>这里原来文案里有个口误叫“边辑”，其实是<strong>编辑还原度</strong>。<br/>
输入一张原图，4.5 生成的重绘结果，在保留原图特征的基础上，融合得更完美，更接近我们想要的“微调”效果，而不是改得面目全非。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2d04a24c2d5248b1aafec45f34810191~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeS4reaWh-ekvue-pA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765951479&amp;x-signature=U3KBQH9ltUFdK3cZ2lTy1mA5u9U%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-6">5️⃣ 微小文字渲染清晰</h3>
<p>细节控狂喜！以前 4.0 在大图里生成小文字，基本是一坨模糊的像素。<br/>
现在的 4.5，背景里的小字也能做到清晰可辨，这点在做海报或复杂场景时非常实用。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c1a64d9ad5884ceba15c61e73b1e4fb2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeS4reaWh-ekvue-pA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765951479&amp;x-signature=xEObrWgZsoEXfWYUVb9oUEh1Ld4%3D" alt="" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-7">💡 重点来了：如何免费接入工作流？</h2>
<p>大家都知道，如果正儿八经走官方 API 调用即梦，那是按次收费的，用在工作流里成本不低。</p>
<p>之前我分享过白嫖 4.0 的方法，但那个老路子不支持最新的 4.5 模型。<br/>
<strong>别急，新的破局方法找到了！</strong></p>
<p>这次咱们用到的是一个开源项目（基于 Docker 部署），它能完美模拟普通用户的请求。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cd274b65ba064128b31532bce5626070~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeS4reaWh-ekvue-pA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765951479&amp;x-signature=ttN5rwkCh%2FSIiJx2Nz5dzKj5Jjk%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>项目地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fwwwzhouhui%2Fjimeng-free-api-all" target="_blank" title="https://github.com/wwwzhouhui/jimeng-free-api-all" ref="nofollow noopener noreferrer">github.com/wwwzhouhui/…</a></p>
</blockquote>
<h3 data-id="heading-8">✅ 操作逻辑</h3>
<ol>
<li><strong>部署开源项目</strong>：使用 Docker 在本地运行一个 API 封装项目（类似于 <code>Jimeng-API</code> 这种）。</li>
<li><strong>本地端口调用</strong>：运行后，它会开启一个本地端口（比如 8000）。</li>
<li><strong>接入工作流</strong>：在此时，通过工作流调用这个本地接口，把你的 Sessionid 传进去。</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/91cf776f3eb94fe29da7ebbb9f48a75f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeS4reaWh-ekvue-pA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765951479&amp;x-signature=LaNO2hM4qeUZFQN6cjRkkkY94G0%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-9">💰 真正的“0成本”</h3>
<p>这套方案调用的其实是你个人账号的<strong>免费积分</strong>！</p>
<ul>
<li>普通用户每天登录送 <strong>66 积分</strong>。</li>
<li>实测使用 4.5 模型，生成一组（4 张）2K 高清图，普通只扣 <strong>2 积分，会员完全免费</strong>。</li>
<li>也就是说，<strong>普通用户每天可以免费生成 33 组图（132 张）！</strong></li>
</ul>
<p>对于个人玩家和创作者来说，这完全够用了，还要什么自行车？</p>
<hr/>
<h2 data-id="heading-10">👨‍💻 总结一下</h2>
<p>即梦 4.5 这次升级诚意满满，特别是对人像和细节的把控。配合这个本地 Docker 部署的开源方案，直接把“付费API”变成了“每日签到白嫖”，这波羊毛大家赶紧薅起来！</p>
<p>我是磊哥，每天分享一个实用的 AI 干货，咱们下期见！👋</p>
<p><em>(注：本文提及的技术方案仅供学习交流，请合理使用平台资源)</em></p>
<blockquote>
<p>本文已收录到我的技术小站 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.javacn.site" target="_blank" title="https://www.javacn.site" ref="nofollow noopener noreferrer">www.javacn.site</a>，网站包含的内容有：<strong>LangChain/N8N/SpringAI/SpringAIAlibaba/LangChain4j/Dify/Coze/AI实战项目/AI常见面试题</strong>等技术分享，欢迎各位大佬光临指导~</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[隐形追踪者：当你删除了 Cookies，谁还在看着你？——揭秘浏览器指纹]]></title>    <link>https://juejin.cn/post/7581760987763638323</link>    <guid>https://juejin.cn/post/7581760987763638323</guid>    <pubDate>2025-12-10T06:05:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581760987763638323" data-draft-id="7578793960627470362" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="隐形追踪者：当你删除了 Cookies，谁还在看着你？——揭秘浏览器指纹"/> <meta itemprop="keywords" content="前端,面试,算法"/> <meta itemprop="datePublished" content="2025-12-10T06:05:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="吃饺子不吃馅"/> <meta itemprop="url" content="https://juejin.cn/user/1148309742825495"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            隐形追踪者：当你删除了 Cookies，谁还在看着你？——揭秘浏览器指纹
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1148309742825495/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    吃饺子不吃馅
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T06:05:07.000Z" title="Wed Dec 10 2025 06:05:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>韭菜们是否经历过这样的诡异时刻：你在某个购物网站搜索了一双球鞋，仅仅过了一分钟，当你打开新闻网站或社交媒体时，那双球鞋的广告就出现在了显眼的位置。</p>
<p>通常，我们会把这归咎于 <strong>Cookies</strong>。于是，聪明的韭菜打开了“无痕模式”，或者彻底清除了浏览器的缓存和 Cookies，认为这样就能隐身于互联网。</p>
<p><strong>然而，广告依然如影随形。</strong></p>
<p>这是因为，由于 <strong>“浏览器指纹”（Browser Fingerprinting）</strong> 技术的存在，你实际上一直在“裸奔”。</p>
<h2 data-id="heading-0">什么是浏览器指纹？</h2>
<p>在现实生活中，指纹是我们独一无二的生理特征。而在互联网世界中，<strong>浏览器指纹</strong>是指当你访问一个网站时，你的浏览器不仅会请求网页内容，还会无意中暴露一系列关于你设备的软硬件配置信息。</p>
<p>这些信息单独看起来都很普通，比如：</p>
<ul>
<li>你的操作系统（Windows, macOS, Android...）</li>
<li>屏幕分辨率（1920x1080...）</li>
<li>浏览器版本（Chrome 120...）</li>
<li>安装的字体列表</li>
<li>时区和语言设置</li>
<li>显卡型号和电池状态</li>
</ul>
<p><strong>神奇之处在于组合：</strong> 当把这几十甚至上百个特征组合在一起时，它们就形成了一个极高精度的“特征值”。据研究，对于绝大多数互联网用户来说，这个组合是<strong>全球唯一</strong>的</p>
<h2 data-id="heading-1">它是如何工作的？</h2>
<p>为了生成这个指纹，追踪者使用了一些非常巧妙的技术：</p>
<h3 data-id="heading-2">1. Canvas 指纹（画布指纹）</h3>
<p>这是最著名的指纹技术。网站会命令你的浏览器在后台偷偷绘制一张复杂的隐藏图片（包含文字和图形）。</p>
<p>由于不同的操作系统、显卡驱动、字体渲染引擎处理图像的方式有微小的像素级差异，每台电脑画出来的图在哈希值上是完全不同的。</p>
<h3 data-id="heading-3">2. AudioContext 指纹（音频指纹）</h3>
<p>原理类似 Canvas。网站会让浏览器生成一段人耳听不到的音频信号。不同的声卡和音频驱动处理信号的方式不同，生成的数字指纹也就不同</p>
<h3 data-id="heading-4">3. 字体枚举</h3>
<p>你安装了 Photoshop？或者安装了一套冷门的编程字体？网站可以通过脚本检测你系统里安装了哪些字体。安装的字体越独特，你的指纹辨识度就越高</p>
<h2 data-id="heading-5">为什么它比 Cookies 更可怕？</h2>






























<table><thead><tr><th><strong>特性</strong></th><th><strong>Cookies (传统的追踪)</strong></th><th><strong>浏览器指纹 (新型追踪)</strong></th></tr></thead><tbody><tr><td><strong>存储位置</strong></td><td>你的电脑硬盘里</td><td><strong>不需要存储</strong>，实时计算</td></tr><tr><td><strong>用户控制</strong></td><td>你可以随时一键删除</td><td><strong>你无法删除</strong>，它是你设备的属性</td></tr><tr><td><strong>隐身模式</strong></td><td>无效（隐身模式不读旧Cookies）</td><td><strong>依然有效</strong>（隐身模式下设备配置不变）</td></tr><tr><td><strong>持久性</strong></td><td>易丢失</td><td>极难改变，甚至跨浏览器追踪</td></tr></tbody></table>
<p><strong>这就好比：</strong></p>
<ul>
<li><strong>Cookies</strong> 就像是进门时发给你的一张胸牌，你把它扔了，保安就不认识你了</li>
<li><strong>浏览器指纹</strong> 就像是保安记住了你的身高、长相、穿衣风格和走路姿势。这和你戴不戴胸牌没有任何关系</li>
</ul>
<h2 data-id="heading-6">主要用途</h2>
<p>浏览器指纹技术在现代网络中有多种用途，主要可以分为<strong>追踪识别</strong>和<strong>安全防护</strong>两大类：</p>
<h3 data-id="heading-7">追踪与用户画像</h3>
<ul>
<li><strong>跨网站追踪用户</strong>：广告网络会在不同站点嵌入脚本，通过指纹标记“同一访客”，进而在B站推送你在A站浏览过的商品或内容，实现“精准广告”。</li>
<li><strong>绘制用户画像</strong>：即使未登录，只要指纹相同，网站就能合并浏览记录、点击路径、停留时长等数据，推测兴趣偏好、消费水平，再反向优化推荐算法。</li>
<li><strong>“无Cookie” 追踪</strong>：指纹在无痕/隐私模式下依旧存在，且无法像Cookie那样一键清空，因此被视为更顽固的追踪手段。</li>
</ul>
<h3 data-id="heading-8">反欺诈与风控</h3>
<ul>
<li><strong>账号安全</strong>：银行、支付、社交平台把指纹作为“设备信任度”指标。若登录指纹突然大变（新系统、虚拟机、海外设备），可触发二次验证或冻结交易。</li>
<li><strong>薅羊毛/作弊识别</strong>：投票、抽奖、优惠券领取页面用指纹判断“是否同一设备反复参与”，防止批量注册、刷单。</li>
<li><strong>广告反欺诈</strong>：验证广告点击是否来自真实浏览器，而非自动化脚本或虚假流量农场。</li>
</ul>
<h3 data-id="heading-9">多账号管理</h3>
<ul>
<li><strong>跨境电商/社媒运营</strong>：卖家或营销人员需要在一台电脑同时登录几十个Amazon、eBay、Facebook、TikTok账号。若用普通浏览器，平台会因指纹相同判定“关联店铺”并封号。指纹浏览器可为每个账号伪造独立的设备环境（分辨率、字体、Canvas、WebGL、MAC地址、IP等），实现“物理级隔离”。</li>
<li><strong>数据抓取与测试</strong>：爬虫或自动化测试脚本通过切换指纹模拟不同真实用户，降低被目标站点封锁的概率。</li>
</ul>
<h3 data-id="heading-10">合规与隐私保护</h3>
<ul>
<li><strong>反指纹追踪</strong>：隐私插件或“高级指纹保护”功能会故意把Canvas、音频、WebGL结果做随机噪声，或统一返回常见值，削弱指纹的唯一性，减少被跨站跟踪。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[剑指offer-48、不使⽤加减乘除实现加法]]></title>    <link>https://juejin.cn/post/7581760987763654707</link>    <guid>https://juejin.cn/post/7581760987763654707</guid>    <pubDate>2025-12-10T06:08:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581760987763654707" data-draft-id="7580251192331305006" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" 剑指offer-48、不使⽤加减乘除实现加法"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2025-12-10T06:08:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SevenCoding"/> <meta itemprop="url" content="https://juejin.cn/user/3261615728242467"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             剑指offer-48、不使⽤加减乘除实现加法
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3261615728242467/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SevenCoding
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T06:08:49.000Z" title="Wed Dec 10 2025 06:08:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">题⽬描述</h2>
<p>写⼀个函数，求两个整数之和，要求在函数体内不得使⽤ + 、 - 、 * 、 / 四则运算符号。</p>
<p>示例1
输⼊：1,2
返回值：3</p>
<h2 data-id="heading-1">思路及解答</h2>
<h3 data-id="heading-2">位运算迭代法（推荐）</h3>
<p>将加法分解为「无进位和」+「进位值」，循环直到进位为0</p>
<p><strong>位运算加法的数学原理</strong>：</p>
<ul>
<li><strong>异或运算 (^)</strong>：实现无进位加法
<ul>
<li><code>0^0=0</code>, <code>0^1=1</code>, <code>1^0=1</code>, <code>1^1=0</code>（进位丢失）</li>
</ul>
</li>
<li><strong>与运算 (&amp;)</strong>：检测需要进位的位置
<ul>
<li>只有<code>1&amp;1=1</code>，其他情况都为0</li>
</ul>
</li>
<li><strong>左移运算 (&lt;&lt;)</strong>：将进位值移到正确位置</li>
</ul>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">add</span><span class="hljs-params">(<span class="hljs-type">int</span> a, <span class="hljs-type">int</span> b)</span> {
        <span class="hljs-comment">// 循环直到进位为0</span>
        <span class="hljs-keyword">while</span> (b != <span class="hljs-number">0</span>) {
            <span class="hljs-comment">// 计算无进位和：异或运算相当于无进位加法</span>
            <span class="hljs-comment">// 例如：5^3=6 (101^011=110)</span>
            <span class="hljs-type">int</span> <span class="hljs-variable">sum</span> <span class="hljs-operator">=</span> a ^ b;
            
            <span class="hljs-comment">// 计算进位值：与运算后左移1位得到进位</span>
            <span class="hljs-comment">// 例如：(5&amp;3)&lt;&lt;1=2 (101&amp;011=001, 左移1位=010)</span>
            <span class="hljs-type">int</span> <span class="hljs-variable">carry</span> <span class="hljs-operator">=</span> (a &amp; b) &lt;&lt; <span class="hljs-number">1</span>;
            
            <span class="hljs-comment">// 更新a为无进位和，b为进位值</span>
            a = sum;
            b = carry;
            
            <span class="hljs-comment">// 继续下一轮计算，直到进位为0</span>
        }
        <span class="hljs-keyword">return</span> a;
    }
}
</code></pre>
<ul>
<li>时间复杂度：O(1) - 最多循环32次（整数位数）</li>
<li>空间复杂度：O(1) - 只使用常数空间</li>
</ul>
<h3 data-id="heading-3">位运算递归法</h3>
<p>将迭代过程转为递归调用，基础案例是进位为0</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">add</span><span class="hljs-params">(<span class="hljs-type">int</span> a, <span class="hljs-type">int</span> b)</span> {
        <span class="hljs-comment">// 递归终止条件：当进位为0时，直接返回无进位和</span>
        <span class="hljs-keyword">if</span> (b == <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">return</span> a;
        }
        
        <span class="hljs-comment">// 递归过程：计算无进位和与进位值，继续递归相加</span>
        <span class="hljs-keyword">return</span> add(a ^ b, (a &amp; b) &lt;&lt; <span class="hljs-number">1</span>);
    }
}
</code></pre>
<ul>
<li>时间复杂度：O(1) - 递归深度最多32层</li>
<li>空间复杂度：O(1) - 但递归栈有深度限制</li>
</ul>
<p>递归案例：</p>
<pre><code class="hljs language-text" lang="text">add(2, 3)
  → add(2^3, (2&amp;3)&lt;&lt;1) = add(1, 2)
    → add(1^2, (1&amp;2)&lt;&lt;1) = add(3, 0)
      → b=0, 返回3
最终结果：5
</code></pre>
<h3 data-id="heading-4">投机取巧</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.util.concurrent.atomic.AtomicInteger;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> {
    <span class="hljs-comment">// 方法1：使用内置的加法方法</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">add1</span><span class="hljs-params">(<span class="hljs-type">int</span> a, <span class="hljs-type">int</span> b)</span> {
        <span class="hljs-keyword">return</span> Integer.sum(a, b); <span class="hljs-comment">// 内部实现还是用+，不符合要求</span>
    }
    
    <span class="hljs-comment">// 方法2：使用AtomicInteger（实际开发中更不实用）</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">add2</span><span class="hljs-params">(<span class="hljs-type">int</span> a, <span class="hljs-type">int</span> b)</span> {
        <span class="hljs-type">AtomicInteger</span> <span class="hljs-variable">ai</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicInteger</span>(a);
        <span class="hljs-keyword">return</span> ai.addAndGet(b); <span class="hljs-comment">// 内部使用CAS操作</span>
    }
    
    <span class="hljs-comment">// 方法3：使用BigDecimal（过度设计）</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">add3</span><span class="hljs-params">(<span class="hljs-type">int</span> a, <span class="hljs-type">int</span> b)</span> {
        <span class="hljs-comment">// 需要创建对象，性能较差</span>
        <span class="hljs-keyword">return</span> BigDecimal.valueOf(a)
                .add(BigDecimal.valueOf(b))
                .intValue();
    }
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React Native 样式系统详解：与 Web CSS 的“似是而非”]]></title>    <link>https://juejin.cn/post/7581760987763703859</link>    <guid>https://juejin.cn/post/7581760987763703859</guid>    <pubDate>2025-12-10T06:14:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581760987763703859" data-draft-id="7581772744376516654" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React Native 样式系统详解：与 Web CSS 的“似是而非”"/> <meta itemprop="keywords" content="前端,React Native"/> <meta itemprop="datePublished" content="2025-12-10T06:14:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="皮蛋小精灵"/> <meta itemprop="url" content="https://juejin.cn/user/219558056559278"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React Native 样式系统详解：与 Web CSS 的“似是而非”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/219558056559278/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    皮蛋小精灵
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T06:14:48.000Z" title="Wed Dec 10 2025 06:14:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>很多从 Web 转战 React Native 的开发者最先问的问题通常是：“我能直接把 CSS 文件复制进去吗？”</p>
<p>答案是<strong>不能</strong>。虽然 React Native 的样式系统在命名和行为上极力模仿 CSS，但它本质上是<strong>JavaScript 对象</strong>，运行机制也完全不同。以下是关于这两者差异的完整技术总结。</p>
<h2 data-id="heading-0">1. 核心语法：从 Kebab-case 到 CamelCase</h2>
<p>在 Web 中，CSS 是文本；在 RN 中，样式是代码（对象）。由于 JavaScript 对象的属性名不能包含连字符（<code>-</code>），所有 CSS 属性都必须转换为 <strong>小驼峰命名法 (camelCase)</strong> 。</p>






























<table><thead><tr><th><strong>特性</strong></th><th><strong>Web CSS</strong></th><th><strong>React Native Style</strong></th></tr></thead><tbody><tr><td><strong>背景色</strong></td><td><code>background-color: red;</code></td><td><code>backgroundColor: 'red'</code></td></tr><tr><td><strong>字体大小</strong></td><td><code>font-size: 16px;</code></td><td><code>fontSize: 16</code> (注意是数字)</td></tr><tr><td><strong>外边距</strong></td><td><code>margin-top: 20px;</code></td><td><code>marginTop: 20</code></td></tr><tr><td><strong>复合属性</strong></td><td><code>border: 1px solid red;</code></td><td><strong>不支持</strong>。必须拆分为 <code>borderWidth</code>, <code>borderColor</code>, <code>borderStyle</code></td></tr></tbody></table>
<h3 data-id="heading-1">为什么这样做？</h3>
<p>因为样式是 JS 对象，这意味着你可以利用编程语言的所有能力：变量、条件判断、函数计算等。</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-comment">// React Native 允许动态计算样式</span>
&lt;<span class="hljs-title class_">View</span> style={{
  <span class="hljs-attr">backgroundColor</span>: isActive ? <span class="hljs-string">'blue'</span> : <span class="hljs-string">'gray'</span>, <span class="hljs-comment">// 条件样式</span>
  <span class="hljs-attr">width</span>: windowWidth * <span class="hljs-number">0.5</span> <span class="hljs-comment">// 动态计算</span>
}} /&gt;
</code></pre>
<h2 data-id="heading-2">2. 继承与层叠：数组覆盖法</h2>
<p>Web CSS 的全称是“层叠样式表”（Cascading Style Sheets），依赖选择器权重（Specificity）来决定谁生效。</p>
<p>React Native 没有选择器（没有 .class 或 #id），也没有隐式的样式继承（子元素不会自动继承父元素的字体颜色）。</p>
<p>RN 的“层叠”通过数组实现：</p>
<p>RN 允许你给 style 属性传递一个数组。数组中越靠后的样式优先级越高。</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">const</span> styles = {
  <span class="hljs-attr">base</span>: { <span class="hljs-attr">fontSize</span>: <span class="hljs-number">14</span>, <span class="hljs-attr">color</span>: <span class="hljs-string">'black'</span> },
  <span class="hljs-attr">active</span>: { <span class="hljs-attr">color</span>: <span class="hljs-string">'blue'</span> } <span class="hljs-comment">// 激活状态覆盖颜色</span>
};

<span class="hljs-comment">// 数组最后一个生效，最终颜色为 blue</span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Text</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{[styles.base,</span> <span class="hljs-attr">styles.active</span>]}&gt;</span>Hello<span class="hljs-tag">&lt;/<span class="hljs-name">Text</span>&gt;</span></span>
</code></pre>
<p>这种方式让样式覆盖变得<strong>显式且可预测</strong>，彻底消除了 Web 开发中“不知道这个样式是从哪里继承来的”痛苦。</p>
<h2 data-id="heading-3">3. 布局系统：Flexbox 是唯一真理</h2>
<p>React Native 移除了 Web 中复杂的 <code>float</code>, <code>display: block/inline</code>, <code>grid</code> 等布局方式，<strong>只保留并强制使用 Flexbox</strong>。</p>
<p>但有一个巨大的陷阱需要注意：<strong>默认主轴方向不同</strong>。</p>
<ul>
<li>
<p><strong>Web Flexbox:</strong> 默认 <code>flex-direction: row</code> (横向排列)。</p>
</li>
<li>
<p><strong>RN Flexbox:</strong> 默认 <code>flexDirection: 'column'</code> (纵向排列)。</p>
<ul>
<li><em>原因：</em> 手机屏幕是窄长的，垂直滚动是移动端的默认交互模式。</li>
</ul>
</li>
</ul>
<h2 data-id="heading-4">4. 尺寸与单位：没有 <code>px</code>，只有逻辑点</h2>
<p>在 Web 上，我们纠结于 px, em, rem, vw, vh。</p>
<p>在 RN 上，几乎所有尺寸属性（width, height, margin, padding, fontSize）都只接受不带单位的数字。</p>
<ul>
<li>
<p><strong>含义：</strong> 这些数字代表 <strong>逻辑像素 (Logical Pixels / Points)</strong> 。</p>
</li>
<li>
<p><strong>自动适配：</strong> RN 会根据设备的屏幕密度（DPI/PixelRatio）自动将其转换为屏幕上的物理像素。</p>
<ul>
<li>写 <code>width: 100</code>，在普通屏是 100px，在 Retina 屏可能是 200px 或 300px。</li>
<li><em>例外：</em> 也可以使用百分比字符串，如 <code>width: '50%'</code>。</li>
</ul>
</li>
</ul>
<h2 data-id="heading-5">5. 常见痛点与已知限制 (Known Issues)</h2>
<p>根据你提供的文档片段，RN 并不是完美复刻了 CSS 引擎，这里有几个著名的“坑”：</p>
<h3 data-id="heading-6">A. 触摸区域与父级边界 (Parent Bounds)</h3>
<ul>
<li>
<p><strong>Web:</strong> 子元素设为 <code>absolute</code> 并移出父元素框外，通常依然可见且可点击。</p>
</li>
<li>
<p><strong>RN (Android):</strong> 子元素的<strong>触摸事件</strong>无法超出父组件的边界。如果你把按钮用 <code>position: absolute</code> 移到了父 View 的外面，你看着它在那里，但点它没反应。</p>
<ul>
<li><em>注：</em> 视觉上，Android 默认 <code>overflow: hidden</code> 行为较强，虽新版本有改善，但点击判定依然严格遵循父级区域。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-7">B. 负边距 (Negative Margins)</h3>
<ul>
<li><strong>Web:</strong> <code>margin-top: -50px</code> 是常用的重叠布局技巧。</li>
<li><strong>RN:</strong> 文档明确提到 <em>"on Android negative margin is not supported"</em> （或支持受限）。虽然现代 RN 版本对负 margin 的支持已经好转，但在某些复杂嵌套或旧版本 Android 上，它依然会导致布局塌陷或裁剪。</li>
</ul>
<h3 data-id="heading-8">C. 圆角与图片 (Border Radius)</h3>
<p>如前文所述，iOS 的 <code>&lt;Image&gt;</code> 组件对 <code>borderTopLeftRadius</code> 等<strong>单独</strong>圆角属性支持不佳。必须通过包裹一个 <code>&lt;View&gt;</code> 并设置 <code>overflow: 'hidden'</code> 来实现异形图片。</p>
<h3 data-id="heading-9">D. 阴影 (Shadows)</h3>
<p>这是最分裂的地方：</p>
<ul>
<li><strong>iOS:</strong> 使用 <code>shadowColor</code>, <code>shadowOffset</code>, <code>shadowOpacity</code> (类似 CSS)。</li>
<li><strong>Android:</strong> 必须使用 <code>elevation</code> (一个数字，对应 Material Design 的层级高度)。为了跨平台，通常需要根据平台写两套代码。</li>
</ul>
<h2 data-id="heading-10">6. 最佳实践：StyleSheet.create</h2>
<p>虽然你可以直接写内联样式对象 <code>style={{color: 'red'}}</code>，但官方推荐使用 <code>StyleSheet.create</code>。</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">StyleSheet</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'react-native'</span>;

<span class="hljs-keyword">const</span> styles = <span class="hljs-title class_">StyleSheet</span>.<span class="hljs-title function_">create</span>({
  <span class="hljs-attr">container</span>: {
    <span class="hljs-attr">flex</span>: <span class="hljs-number">1</span>,
    <span class="hljs-attr">backgroundColor</span>: <span class="hljs-string">'#fff'</span>,
  },
});
</code></pre>
<p><strong>为什么？</strong></p>
<ol>
<li><strong>性能：</strong> 系统可以将这些样式对象 ID 化并缓存，避免每次渲染组件时都重新创建新的对象。</li>
<li><strong>验证：</strong> 它会在开发阶段检查你的属性名是否合法（比如如果你写了 <code>background-color</code>，它会直接报错提醒你改成 <code>backgroundColor</code>）。</li>
</ol>
<hr/>
<h3 data-id="heading-11">总结</h3>
<p>当你开始在 React Native 中写样式时，请记住：</p>
<ol>
<li>❌ 不要用 Kebab-case (<code>font-size</code>)，要用 <strong>CamelCase</strong> (<code>fontSize</code>)。</li>
<li>❌ 不要加 <code>px</code> 单位，直接写<strong>数字</strong>。</li>
<li>❌ 不要指望样式自动继承（Text 组件内的嵌套除外）。</li>
<li>⚠️ 默认布局是 <strong>纵向 (Column)</strong> 的。</li>
<li>⚠️ 所有的边框、阴影、圆角，在 iOS 和 Android 上可能表现不一致，多真机测试。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[ANSI-Escapes 命令行光标操作完全指南]]></title>    <link>https://juejin.cn/post/7581828086020063247</link>    <guid>https://juejin.cn/post/7581828086020063247</guid>    <pubDate>2025-12-10T06:20:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581828086020063247" data-draft-id="7581828086020030479" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="ANSI-Escapes 命令行光标操作完全指南"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-10T06:20:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="三年三月"/> <meta itemprop="url" content="https://juejin.cn/user/694547078186440"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ANSI-Escapes 命令行光标操作完全指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/694547078186440/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    三年三月
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T06:20:39.000Z" title="Wed Dec 10 2025 06:20:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h2 data-id="heading-0">1. 命令行中光标操作的底层原理</h2>
<p>在命令行界面中，光标操作的底层原理基于<strong>ANSI转义序列</strong>（ANSI Escape Sequences），这是一套标准化的控制字符序列，用于控制终端的各种行为，包括光标移动、文本样式、屏幕清除等。</p>
<h3 data-id="heading-1">1.1 ANSI转义序列基础</h3>
<ul>
<li><strong>转义字符</strong>：所有ANSI转义序列都以转义字符<code>ESC</code>（ASCII码27，十六进制0x1B，通常表示为<code>\033</code>或<code>\u001B</code>）开头</li>
<li><strong>序列格式</strong>：基本格式为 <code>ESC[参数;参数;...命令</code> 或简写为 <code>\033[参数;参数;...命令</code></li>
<li><strong>命令类型</strong>：
<ul>
<li>光标移动命令（如<code>A</code>上移、<code>B</code>下移、<code>C</code>右移、<code>D</code>左移）</li>
<li>屏幕操作命令（如<code>J</code>清除屏幕、<code>K</code>清除行）</li>
<li>样式设置命令（如文本颜色、背景色、粗体等）</li>
</ul>
</li>
</ul>
<h3 data-id="heading-2">1.2 终端解析机制</h3>
<p>当终端接收到包含ANSI转义序列的输出时：</p>
<ol>
<li>识别<code>ESC</code>字符作为转义序列的开始</li>
<li>解析<code>[</code>之后的参数（以分号分隔）</li>
<li>执行参数对应的命令操作</li>
<li>转义序列不会显示在终端上，只会触发相应的控制行为</li>
</ol>
<h3 data-id="heading-3">1.3 光标定位原理</h3>
<ul>
<li>终端屏幕被划分为行列网格，通常从左上角(0,0)或(1,1)开始计数</li>
<li>光标移动命令通过指定行列位置或相对偏移来控制光标位置</li>
<li>不同终端可能有细微差异，但基本遵循ANSI标准</li>
</ul>
<h2 data-id="heading-4">2. ANSI-Escapes 工具介绍</h2>
<p><code>ansi-escapes</code>是一个Node.js库，它提供了一组简洁的API，用于生成各种ANSI转义序列，简化了在命令行应用中控制光标、清除屏幕、操作终端等复杂功能的实现。</p>
<h3 data-id="heading-5">2.1 主要功能分类</h3>
<ol>
<li><strong>光标控制</strong>：移动、定位、保存/恢复位置、隐藏/显示</li>
<li><strong>屏幕操作</strong>：清除行、清除屏幕、滚动</li>
<li><strong>终端控制</strong>：切换屏幕、设置工作目录</li>
<li><strong>实用功能</strong>：创建链接、显示图片、发出蜂鸣</li>
</ol>
<h3 data-id="heading-6">2.2 优势</h3>
<ul>
<li>跨平台兼容性：自动处理不同终端和操作系统的差异</li>
<li>简化API：将复杂的转义序列封装为易记的函数调用</li>
<li>类型安全：提供TypeScript支持，减少使用错误</li>
<li>模块化设计：按需导入所需功能</li>
</ul>
<h2 data-id="heading-7">3. ANSI-Escapes 核心功能详解</h2>
<h3 data-id="heading-8">3.1 光标移动与定位</h3>
<h4 data-id="heading-9">cursorTo(x, y) - 移动光标到指定位置</h4>
<p><strong>功能</strong>：将光标移动到屏幕上的指定坐标位置</p>
<p><strong>Demo代码</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> ansiEscapes <span class="hljs-keyword">from</span> <span class="hljs-string">'ansi-escapes'</span>;
<span class="hljs-keyword">import</span> process <span class="hljs-keyword">from</span> <span class="hljs-string">'process'</span>;

<span class="hljs-comment">// 移动到第2行第6列</span>
process.<span class="hljs-property">stdout</span>.<span class="hljs-title function_">write</span>(<span class="hljs-string">'第一行\n'</span>);
process.<span class="hljs-property">stdout</span>.<span class="hljs-title function_">write</span>(<span class="hljs-string">'第二行\n'</span>);
process.<span class="hljs-property">stdout</span>.<span class="hljs-title function_">write</span>(<span class="hljs-string">'第三行\n'</span>);
process.<span class="hljs-property">stdout</span>.<span class="hljs-title function_">write</span>(ansiEscapes.<span class="hljs-title function_">cursorTo</span>(<span class="hljs-number">5</span>, <span class="hljs-number">1</span>)); <span class="hljs-comment">// x:5, y:1 (行列从0开始)</span>
process.<span class="hljs-property">stdout</span>.<span class="hljs-title function_">write</span>(<span class="hljs-string">'✓ 光标移动到这里了\n'</span>);
</code></pre>
<p><strong>底层实现</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">cursorTo</span> = (<span class="hljs-params">x, y</span>) =&gt; {
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> x !== <span class="hljs-string">'number'</span>) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeError</span>(<span class="hljs-string">'The `x` argument is required'</span>);
    }

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> y !== <span class="hljs-string">'number'</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-variable constant_">ESC</span> + (x + <span class="hljs-number">1</span>) + <span class="hljs-string">'G'</span>; <span class="hljs-comment">// 只指定x坐标</span>
    }

    <span class="hljs-keyword">return</span> <span class="hljs-variable constant_">ESC</span> + (y + <span class="hljs-number">1</span>) + <span class="hljs-variable constant_">SEP</span> + (x + <span class="hljs-number">1</span>) + <span class="hljs-string">'H'</span>; <span class="hljs-comment">// 指定x,y坐标</span>
};
</code></pre>
<p><strong>解析</strong>：</p>
<ul>
<li>当只提供x坐标时，生成序列 <code>\033[6G</code>（移动到第6列）</li>
<li>当提供x和y坐标时，生成序列 <code>\033[2;6H</code>（移动到第2行第6列）</li>
<li>注意：终端通常使用1-based索引，而API使用0-based索引，所以需要+1转换</li>
</ul>
<h4 data-id="heading-10">cursorMove(x, y) - 相对移动光标</h4>
<p><strong>功能</strong>：从当前位置相对移动光标</p>
<p><strong>Demo代码</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> ansiEscapes <span class="hljs-keyword">from</span> <span class="hljs-string">'ansi-escapes'</span>;
<span class="hljs-keyword">import</span> process <span class="hljs-keyword">from</span> <span class="hljs-string">'process'</span>;

process.<span class="hljs-property">stdout</span>.<span class="hljs-title function_">write</span>(<span class="hljs-string">'Hello World'</span>);
process.<span class="hljs-property">stdout</span>.<span class="hljs-title function_">write</span>(ansiEscapes.<span class="hljs-title function_">cursorMove</span>(-<span class="hljs-number">5</span>, -<span class="hljs-number">1</span>)); <span class="hljs-comment">// 左移5字符，上移1行</span>
process.<span class="hljs-property">stdout</span>.<span class="hljs-title function_">write</span>(<span class="hljs-string">'✓ 相对移动到这里'</span>);
</code></pre>
<p><strong>底层实现</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">cursorMove</span> = (<span class="hljs-params">x, y</span>) =&gt; {
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> x !== <span class="hljs-string">'number'</span>) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeError</span>(<span class="hljs-string">'The `x` argument is required'</span>);
    }

    <span class="hljs-keyword">let</span> returnValue = <span class="hljs-string">''</span>;

    <span class="hljs-keyword">if</span> (x &lt; <span class="hljs-number">0</span>) {
        returnValue += <span class="hljs-variable constant_">ESC</span> + (-x) + <span class="hljs-string">'D'</span>; <span class="hljs-comment">// 左移</span>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (x &gt; <span class="hljs-number">0</span>) {
        returnValue += <span class="hljs-variable constant_">ESC</span> + x + <span class="hljs-string">'C'</span>; <span class="hljs-comment">// 右移</span>
    }

    <span class="hljs-keyword">if</span> (y &lt; <span class="hljs-number">0</span>) {
        returnValue += <span class="hljs-variable constant_">ESC</span> + (-y) + <span class="hljs-string">'A'</span>; <span class="hljs-comment">// 上移</span>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (y &gt; <span class="hljs-number">0</span>) {
        returnValue += <span class="hljs-variable constant_">ESC</span> + y + <span class="hljs-string">'B'</span>; <span class="hljs-comment">// 下移</span>
    }

    <span class="hljs-keyword">return</span> returnValue;
};
</code></pre>
<p><strong>解析</strong>：</p>
<ul>
<li>根据x和y的正负值决定移动方向</li>
<li>左移：<code>\033[5D</code></li>
<li>右移：<code>\033[5C</code></li>
<li>上移：<code>\033[1A</code></li>
<li>下移：<code>\033[1B</code></li>
</ul>
<h4 data-id="heading-11">cursorUp(count) / cursorDown(count) - 上下移动光标</h4>
<p><strong>功能</strong>：向上或向下移动指定行数</p>
<p><strong>Demo代码</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> ansiEscapes <span class="hljs-keyword">from</span> <span class="hljs-string">'ansi-escapes'</span>;
<span class="hljs-keyword">import</span> process <span class="hljs-keyword">from</span> <span class="hljs-string">'process'</span>;

process.<span class="hljs-property">stdout</span>.<span class="hljs-title function_">write</span>(<span class="hljs-string">'第一行\n'</span>);
process.<span class="hljs-property">stdout</span>.<span class="hljs-title function_">write</span>(<span class="hljs-string">'第二行\n'</span>);
process.<span class="hljs-property">stdout</span>.<span class="hljs-title function_">write</span>(<span class="hljs-string">'第三行\n'</span>);
process.<span class="hljs-property">stdout</span>.<span class="hljs-title function_">write</span>(ansiEscapes.<span class="hljs-title function_">cursorUp</span>(<span class="hljs-number">2</span>)); <span class="hljs-comment">// 上移2行</span>
process.<span class="hljs-property">stdout</span>.<span class="hljs-title function_">write</span>(<span class="hljs-string">'✓ 上移到第二行'</span>);
</code></pre>
<p><strong>底层实现</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">cursorUp</span> = (<span class="hljs-params">count = <span class="hljs-number">1</span></span>) =&gt; <span class="hljs-variable constant_">ESC</span> + count + <span class="hljs-string">'A'</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">cursorDown</span> = (<span class="hljs-params">count = <span class="hljs-number">1</span></span>) =&gt; <span class="hljs-variable constant_">ESC</span> + count + <span class="hljs-string">'B'</span>;
</code></pre>
<p><strong>解析</strong>：</p>
<ul>
<li>cursorUp：生成 <code>\033[2A</code> 表示上移2行</li>
<li>cursorDown：生成 <code>\033[2B</code> 表示下移2行</li>
<li>默认移动1行</li>
</ul>
<h4 data-id="heading-12">cursorForward(count) / cursorBackward(count) - 左右移动光标</h4>
<p><strong>功能</strong>：向左或向右移动指定字符数</p>
<p><strong>Demo代码</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> ansiEscapes <span class="hljs-keyword">from</span> <span class="hljs-string">'ansi-escapes'</span>;
<span class="hljs-keyword">import</span> process <span class="hljs-keyword">from</span> <span class="hljs-string">'process'</span>;

process.<span class="hljs-property">stdout</span>.<span class="hljs-title function_">write</span>(<span class="hljs-string">'Hello World'</span>);
process.<span class="hljs-property">stdout</span>.<span class="hljs-title function_">write</span>(ansiEscapes.<span class="hljs-title function_">cursorBackward</span>(<span class="hljs-number">6</span>)); <span class="hljs-comment">// 左移6字符</span>
process.<span class="hljs-property">stdout</span>.<span class="hljs-title function_">write</span>(<span class="hljs-string">'✓ 左移到Hello后'</span>);
</code></pre>
<p><strong>底层实现</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">cursorForward</span> = (<span class="hljs-params">count = <span class="hljs-number">1</span></span>) =&gt; <span class="hljs-variable constant_">ESC</span> + count + <span class="hljs-string">'C'</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">cursorBackward</span> = (<span class="hljs-params">count = <span class="hljs-number">1</span></span>) =&gt; <span class="hljs-variable constant_">ESC</span> + count + <span class="hljs-string">'D'</span>;
</code></pre>
<p><strong>解析</strong>：</p>
<ul>
<li>cursorForward：生成 <code>\033[2C</code> 表示右移2字符</li>
<li>cursorBackward：生成 <code>\033[6D</code> 表示左移6字符</li>
<li>默认移动1字符</li>
</ul>
<h3 data-id="heading-13">3.2 光标状态控制</h3>
<h4 data-id="heading-14">cursorHide / cursorShow - 隐藏和显示光标</h4>
<p><strong>功能</strong>：控制光标的可见性</p>
<p><strong>Demo代码</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> ansiEscapes <span class="hljs-keyword">from</span> <span class="hljs-string">'ansi-escapes'</span>;
<span class="hljs-keyword">import</span> process <span class="hljs-keyword">from</span> <span class="hljs-string">'process'</span>;
<span class="hljs-keyword">import</span> { delay } <span class="hljs-keyword">from</span> <span class="hljs-string">'./utils'</span>; <span class="hljs-comment">// 假设存在延迟函数</span>

process.<span class="hljs-property">stdout</span>.<span class="hljs-title function_">write</span>(<span class="hljs-string">'光标可见...'</span>);
<span class="hljs-keyword">await</span> <span class="hljs-title function_">delay</span>(<span class="hljs-number">1500</span>);
process.<span class="hljs-property">stdout</span>.<span class="hljs-title function_">write</span>(ansiEscapes.<span class="hljs-property">cursorHide</span>);
process.<span class="hljs-property">stdout</span>.<span class="hljs-title function_">write</span>(<span class="hljs-string">'\n光标隐藏了...'</span>);
<span class="hljs-keyword">await</span> <span class="hljs-title function_">delay</span>(<span class="hljs-number">2000</span>);
process.<span class="hljs-property">stdout</span>.<span class="hljs-title function_">write</span>(ansiEscapes.<span class="hljs-property">cursorShow</span>);
process.<span class="hljs-property">stdout</span>.<span class="hljs-title function_">write</span>(<span class="hljs-string">'\n光标显示了✓'</span>);
</code></pre>
<p><strong>底层实现</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> cursorHide = <span class="hljs-variable constant_">ESC</span> + <span class="hljs-string">'?25l'</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> cursorShow = <span class="hljs-variable constant_">ESC</span> + <span class="hljs-string">'?25h'</span>;
</code></pre>
<p><strong>解析</strong>：</p>
<ul>
<li>cursorHide：生成 <code>\033[?25l</code> 隐藏光标</li>
<li>cursorShow：生成 <code>\033[?25h</code> 显示光标</li>
<li>常用于需要暂时隐藏光标以提升用户体验的场景</li>
</ul>
<h4 data-id="heading-15">cursorSavePosition / cursorRestorePosition - 保存和恢复光标位置</h4>
<p><strong>功能</strong>：保存当前光标位置，稍后可以恢复到该位置</p>
<p><strong>Demo代码</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> ansiEscapes <span class="hljs-keyword">from</span> <span class="hljs-string">'ansi-escapes'</span>;
<span class="hljs-keyword">import</span> process <span class="hljs-keyword">from</span> <span class="hljs-string">'process'</span>;
<span class="hljs-keyword">import</span> { delay } <span class="hljs-keyword">from</span> <span class="hljs-string">'./utils'</span>;

process.<span class="hljs-property">stdout</span>.<span class="hljs-title function_">write</span>(<span class="hljs-string">'第一行\n'</span>);
process.<span class="hljs-property">stdout</span>.<span class="hljs-title function_">write</span>(<span class="hljs-string">'第二行'</span>);
process.<span class="hljs-property">stdout</span>.<span class="hljs-title function_">write</span>(ansiEscapes.<span class="hljs-property">cursorSavePosition</span>); <span class="hljs-comment">// 保存位置</span>
process.<span class="hljs-property">stdout</span>.<span class="hljs-title function_">write</span>(<span class="hljs-string">'保存点'</span>);
<span class="hljs-keyword">await</span> <span class="hljs-title function_">delay</span>(<span class="hljs-number">1000</span>);
process.<span class="hljs-property">stdout</span>.<span class="hljs-title function_">write</span>(<span class="hljs-string">'\n第三行\n第四行\n'</span>);
<span class="hljs-keyword">await</span> <span class="hljs-title function_">delay</span>(<span class="hljs-number">1000</span>);
process.<span class="hljs-property">stdout</span>.<span class="hljs-title function_">write</span>(ansiEscapes.<span class="hljs-property">cursorRestorePosition</span>); <span class="hljs-comment">// 恢复位置</span>
process.<span class="hljs-property">stdout</span>.<span class="hljs-title function_">write</span>(<span class="hljs-string">'✓ 恢复到保存点'</span>);
</code></pre>
<p><strong>底层实现</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> cursorSavePosition = isTerminalApp ? <span class="hljs-string">'\u001B7'</span> : <span class="hljs-variable constant_">ESC</span> + <span class="hljs-string">'s'</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> cursorRestorePosition = isTerminalApp ? <span class="hljs-string">'\u001B8'</span> : <span class="hljs-variable constant_">ESC</span> + <span class="hljs-string">'u'</span>;
</code></pre>
<p><strong>解析</strong>：</p>
<ul>
<li>针对Apple Terminal使用不同的转义序列 <code>\u001B7</code> 和 <code>\u001B8</code></li>
<li>其他终端使用标准序列 <code>\033[s</code>（保存）和 <code>\033[u</code>（恢复）</li>
</ul>
<h3 data-id="heading-16">3.3 屏幕操作</h3>
<h4 data-id="heading-17">eraseLine / eraseScreen - 清除行和屏幕</h4>
<p><strong>功能</strong>：清除当前行或整个屏幕</p>
<p><strong>Demo代码</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> ansiEscapes <span class="hljs-keyword">from</span> <span class="hljs-string">'ansi-escapes'</span>;
<span class="hljs-keyword">import</span> process <span class="hljs-keyword">from</span> <span class="hljs-string">'process'</span>;

<span class="hljs-comment">// 清除当前行</span>
process.<span class="hljs-property">stdout</span>.<span class="hljs-title function_">write</span>(<span class="hljs-string">'这是一行要清除的文本'</span>);
process.<span class="hljs-property">stdout</span>.<span class="hljs-title function_">write</span>(ansiEscapes.<span class="hljs-property">eraseLine</span>);
process.<span class="hljs-property">stdout</span>.<span class="hljs-title function_">write</span>(<span class="hljs-string">'✓ 行已被清除，在同一位置输出新文本\n'</span>);

<span class="hljs-comment">// 清除屏幕</span>
<span class="hljs-keyword">await</span> <span class="hljs-title function_">delay</span>(<span class="hljs-number">1000</span>);
process.<span class="hljs-property">stdout</span>.<span class="hljs-title function_">write</span>(ansiEscapes.<span class="hljs-property">eraseScreen</span>);
process.<span class="hljs-property">stdout</span>.<span class="hljs-title function_">write</span>(<span class="hljs-string">'✓ 屏幕已被清除\n'</span>);
</code></pre>
<p><strong>底层实现</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> eraseEndLine = <span class="hljs-variable constant_">ESC</span> + <span class="hljs-string">'K'</span>;      <span class="hljs-comment">// 清除从光标到行尾</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> eraseStartLine = <span class="hljs-variable constant_">ESC</span> + <span class="hljs-string">'1K'</span>;   <span class="hljs-comment">// 清除从光标到行首</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> eraseLine = <span class="hljs-variable constant_">ESC</span> + <span class="hljs-string">'2K'</span>;        <span class="hljs-comment">// 清除整行</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> eraseDown = <span class="hljs-variable constant_">ESC</span> + <span class="hljs-string">'J'</span>;         <span class="hljs-comment">// 清除从光标到屏幕底部</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> eraseUp = <span class="hljs-variable constant_">ESC</span> + <span class="hljs-string">'1J'</span>;          <span class="hljs-comment">// 清除从光标到屏幕顶部</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> eraseScreen = <span class="hljs-variable constant_">ESC</span> + <span class="hljs-string">'2J'</span>;      <span class="hljs-comment">// 清除整个屏幕</span>
</code></pre>
<p><strong>解析</strong>：</p>
<ul>
<li><code>eraseLine</code> 生成 <code>\033[2K</code> 清除整行</li>
<li><code>eraseScreen</code> 生成 <code>\033[2J</code> 清除整个屏幕</li>
<li>这些命令不会移动光标位置</li>
</ul>
<h4 data-id="heading-18">clearScreen / clearViewport - 清屏操作</h4>
<p><strong>功能</strong>：更彻底的清屏操作</p>
<p><strong>Demo代码</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> ansiEscapes <span class="hljs-keyword">from</span> <span class="hljs-string">'ansi-escapes'</span>;
<span class="hljs-keyword">import</span> process <span class="hljs-keyword">from</span> <span class="hljs-string">'process'</span>;

<span class="hljs-comment">// 清除屏幕并将光标移到左上角</span>
process.<span class="hljs-property">stdout</span>.<span class="hljs-title function_">write</span>(<span class="hljs-string">'大量输出内容...\n'</span>.<span class="hljs-title function_">repeat</span>(<span class="hljs-number">20</span>));
process.<span class="hljs-property">stdout</span>.<span class="hljs-title function_">write</span>(ansiEscapes.<span class="hljs-property">clearScreen</span>);
process.<span class="hljs-property">stdout</span>.<span class="hljs-title function_">write</span>(<span class="hljs-string">'✓ 屏幕已清除，光标在左上角\n'</span>);
</code></pre>
<p><strong>底层实现</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> clearScreen = <span class="hljs-string">'\u001Bc'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> clearViewport = <span class="hljs-string">`<span class="hljs-subst">${eraseScreen}</span><span class="hljs-subst">${ESC}</span>H`</span>;
</code></pre>
<p><strong>解析</strong>：</p>
<ul>
<li><code>clearScreen</code> 生成 <code>\033c</code> 重置终端（更彻底的清屏）</li>
<li><code>clearViewport</code> 结合了 <code>eraseScreen</code> 和光标移动到左上角 <code>\033[H</code></li>
</ul>
<h3 data-id="heading-19">3.4 终端屏幕控制</h3>
<h4 data-id="heading-20">enterAlternativeScreen / exitAlternativeScreen - 切换屏幕</h4>
<p><strong>功能</strong>：创建一个临时的替代屏幕，退出后恢复原屏幕内容</p>
<p><strong>Demo代码</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> ansiEscapes <span class="hljs-keyword">from</span> <span class="hljs-string">'ansi-escapes'</span>;
<span class="hljs-keyword">import</span> process <span class="hljs-keyword">from</span> <span class="hljs-string">'process'</span>;

<span class="hljs-comment">// 进入替代屏幕</span>
process.<span class="hljs-property">stdout</span>.<span class="hljs-title function_">write</span>(ansiEscapes.<span class="hljs-property">enterAlternativeScreen</span>);
process.<span class="hljs-property">stdout</span>.<span class="hljs-title function_">write</span>(<span class="hljs-string">'这是在替代屏幕中\n'</span>);
process.<span class="hljs-property">stdout</span>.<span class="hljs-title function_">write</span>(<span class="hljs-string">'原屏幕内容被保存\n'</span>);

<span class="hljs-comment">// 等待用户输入后退出</span>
process.<span class="hljs-property">stdin</span>.<span class="hljs-title function_">once</span>(<span class="hljs-string">'data'</span>, <span class="hljs-function">() =&gt;</span> {
    process.<span class="hljs-property">stdout</span>.<span class="hljs-title function_">write</span>(ansiEscapes.<span class="hljs-property">exitAlternativeScreen</span>);
    process.<span class="hljs-property">stdout</span>.<span class="hljs-title function_">write</span>(<span class="hljs-string">'已返回原屏幕\n'</span>);
    process.<span class="hljs-title function_">exit</span>(<span class="hljs-number">0</span>);
});
</code></pre>
<p><strong>底层实现</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> enterAlternativeScreen = <span class="hljs-variable constant_">ESC</span> + <span class="hljs-string">'?1049h'</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> exitAlternativeScreen = <span class="hljs-variable constant_">ESC</span> + <span class="hljs-string">'?1049l'</span>;
</code></pre>
<p><strong>解析</strong>：</p>
<ul>
<li><code>enterAlternativeScreen</code> 生成 <code>\033[?1049h</code> 进入替代屏幕</li>
<li><code>exitAlternativeScreen</code> 生成 <code>\033[?1049l</code> 退出替代屏幕</li>
<li>常用于全屏应用或需要临时切换显示内容的场景</li>
</ul>
<h3 data-id="heading-21">3.5 其他实用功能</h3>
<h4 data-id="heading-22">beep - 发出蜂鸣音</h4>
<p><strong>功能</strong>：让终端发出蜂鸣提示音</p>
<p><strong>Demo代码</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> ansiEscapes <span class="hljs-keyword">from</span> <span class="hljs-string">'ansi-escapes'</span>;
<span class="hljs-keyword">import</span> process <span class="hljs-keyword">from</span> <span class="hljs-string">'process'</span>;

process.<span class="hljs-property">stdout</span>.<span class="hljs-title function_">write</span>(<span class="hljs-string">'即将发出蜂鸣...\n'</span>);
process.<span class="hljs-property">stdout</span>.<span class="hljs-title function_">write</span>(ansiEscapes.<span class="hljs-property">beep</span>);
process.<span class="hljs-property">stdout</span>.<span class="hljs-title function_">write</span>(<span class="hljs-string">'蜂鸣已发出✓'</span>);
</code></pre>
<p><strong>底层实现</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> beep = <span class="hljs-variable constant_">BEL</span>; <span class="hljs-comment">// BEL = '\u0007'</span>
</code></pre>
<p><strong>解析</strong>：</p>
<ul>
<li>生成 <code>\u0007</code> (BEL字符)，大多数终端会将其解释为蜂鸣音</li>
</ul>
<h4 data-id="heading-23">link(text, url) - 创建可点击链接</h4>
<p><strong>功能</strong>：在支持的终端中创建可点击的URL链接</p>
<p><strong>Demo代码</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> ansiEscapes <span class="hljs-keyword">from</span> <span class="hljs-string">'ansi-escapes'</span>;
<span class="hljs-keyword">import</span> process <span class="hljs-keyword">from</span> <span class="hljs-string">'process'</span>;

process.<span class="hljs-property">stdout</span>.<span class="hljs-title function_">write</span>(ansiEscapes.<span class="hljs-title function_">link</span>(<span class="hljs-string">'访问GitHub'</span>, <span class="hljs-string">'https://github.com'</span>) + <span class="hljs-string">'\n'</span>);
process.<span class="hljs-property">stdout</span>.<span class="hljs-title function_">write</span>(<span class="hljs-string">'在支持的终端中，上面的文本是可点击的链接'</span>);
</code></pre>
<p><strong>底层实现</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">link</span> = (<span class="hljs-params">text, url</span>) =&gt; {
    <span class="hljs-keyword">const</span> openLink = <span class="hljs-title function_">wrapOsc</span>(<span class="hljs-string">`<span class="hljs-subst">${OSC}</span>8<span class="hljs-subst">${SEP}</span><span class="hljs-subst">${SEP}</span><span class="hljs-subst">${url}</span><span class="hljs-subst">${BEL}</span>`</span>);
    <span class="hljs-keyword">const</span> closeLink = <span class="hljs-title function_">wrapOsc</span>(<span class="hljs-string">`<span class="hljs-subst">${OSC}</span>8<span class="hljs-subst">${SEP}</span><span class="hljs-subst">${SEP}</span><span class="hljs-subst">${BEL}</span>`</span>);
    <span class="hljs-keyword">return</span> openLink + text + closeLink;
};
</code></pre>
<p><strong>解析</strong>：</p>
<ul>
<li>使用OSC (Operating System Command)序列创建链接</li>
<li>格式为 <code>\033]8;;url\a文本\033]8;;\a</code></li>
<li>在支持的终端（如iTerm2, GNOME Terminal）中，文本会显示为可点击的链接</li>
</ul>
<h2 data-id="heading-24">4. 跨平台兼容性处理</h2>
<p>ansi-escapes库内置了跨平台兼容性处理，确保在不同终端和操作系统上都能正常工作：</p>
<ol>
<li>
<p><strong>终端类型检测</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> isTerminalApp = !isBrowser &amp;&amp; process.<span class="hljs-property">env</span>.<span class="hljs-property">TERM_PROGRAM</span> === <span class="hljs-string">'Apple_Terminal'</span>;
<span class="hljs-keyword">const</span> isWindows = !isBrowser &amp;&amp; process.<span class="hljs-property">platform</span> === <span class="hljs-string">'win32'</span>;
<span class="hljs-keyword">const</span> isTmux = !isBrowser &amp;&amp; (process.<span class="hljs-property">env</span>.<span class="hljs-property">TERM</span>?.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'screen'</span>) || process.<span class="hljs-property">env</span>.<span class="hljs-property">TERM</span>?.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'tmux'</span>) || process.<span class="hljs-property">env</span>.<span class="hljs-property">TMUX</span> !== <span class="hljs-literal">undefined</span>);
</code></pre>
</li>
<li>
<p><strong>Windows特殊处理</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">isOldWindows</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-comment">// 检测旧版Windows系统并返回不同的清屏命令</span>
};
</code></pre>
</li>
<li>
<p><strong>Tmux支持</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">wrapOsc</span> = sequence =&gt; {
    <span class="hljs-keyword">if</span> (isTmux) {
        <span class="hljs-comment">// Tmux需要特殊的OSC序列包装</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">'\u001BPtmux;'</span> + sequence.<span class="hljs-title function_">replaceAll</span>(<span class="hljs-string">'\u001B'</span>, <span class="hljs-string">'\u001B\u001B'</span>) + <span class="hljs-string">'\u001B\\'</span>;
    }
    <span class="hljs-keyword">return</span> sequence;
};
</code></pre>
</li>
</ol>
<h2 data-id="heading-25">5. 最佳实践</h2>
<ol>
<li><strong>资源清理</strong>：使用 <code>cursorShow</code> 确保程序退出时光标可见</li>
<li><strong>异常处理</strong>：在异步操作中处理可能的错误</li>
<li><strong>用户体验</strong>：在长时间操作中隐藏光标，完成后显示</li>
<li><strong>兼容性检查</strong>：对于高级功能，检查终端是否支持</li>
<li><strong>性能考量</strong>：批量执行操作，减少I/O调用</li>
</ol>
<h2 data-id="heading-26">6. 总结</h2>
<p><code>ansi-escapes</code>是一个强大的库，它将复杂的ANSI转义序列封装为简洁易用的API，极大地简化了命令行应用中光标控制、屏幕操作等功能的实现。通过本文的介绍，你应该已经掌握了其核心功能和使用方法。</p>
<p>无论是创建简单的命令行工具还是复杂的交互式终端应用，<code>ansi-escapes</code>都能为你提供强大的支持，帮助你打造出更加专业和友好的用户体验。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[数据标注平台重磅上线 | 标注赚现金 低门槛真收益]]></title>    <link>https://juejin.cn/post/7581807793134108718</link>    <guid>https://juejin.cn/post/7581807793134108718</guid>    <pubDate>2025-12-10T06:19:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581807793134108718" data-draft-id="7581667332306305062" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="数据标注平台重磅上线 | 标注赚现金 低门槛真收益"/> <meta itemprop="keywords" content="前端,后端,人工智能"/> <meta itemprop="datePublished" content="2025-12-10T06:19:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="掘金酱"/> <meta itemprop="url" content="https://juejin.cn/user/1556564194374926"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            数据标注平台重磅上线 | 标注赚现金 低门槛真收益
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1556564194374926/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    掘金酱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T06:19:34.000Z" title="Wed Dec 10 2025 06:19:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    44
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d659d7ae4c1b48d09248cda3382116fb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6YWx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765954781&amp;x-signature=uViSaDOlgMIbUc0QX0uQzlxpkFY%3D" alt="68f71ddf171f8850e881f947f1cfb861.png" loading="lazy"/></p>
<ul>
<li>你是否想亲身体验最前沿的 AI 数据工作，却找不到专业的参与路径？</li>
<li>你是否希望让精通的编程技能，在业余时间创造实实在在的价值？</li>
</ul>
<p>一个多领域的<strong>数据采集与标注服务平台</strong>，为你而来！</p>
<p><strong>低门槛、真收益！</strong> 利用碎片时间，将你的代码洞察力直接<strong>变现</strong>。</p>
<p>这不仅仅是一个任务平台，更是一个专为<strong>资深开发者</strong>打造的、用<strong>技术换取回报</strong>的高价值社区。</p>
<h2 data-id="heading-0">📒 招募介绍</h2>
<h3 data-id="heading-1">我们是谁</h3>
<p><strong>AIDP（AI Data Platform）</strong> 提供完整的 AI 数据解决方案，涵盖：</p>
<ul>
<li>数据采集</li>
<li>数据标注</li>
<li>数据合成</li>
<li>多种数据生产能力</li>
</ul>
<blockquote>
<p>平台支持 <em>Seed、Stone、Flow、头抖、剪映、TT</em> 等核心业务的快速迭代和发展。</p>
</blockquote>
<h3 data-id="heading-2">需要你做什么</h3>
<p>参与后训练高质量代码数据生产，包括但不限于：</p>

























<table><thead><tr><th>任务类型</th><th>说明</th></tr></thead><tbody><tr><td>强化学习数据生产</td><td>为 RLHF 训练提供高质量反馈数据</td></tr><tr><td>监督微调（SFT）</td><td>生产指令-响应对数据</td></tr><tr><td>奖励模型（RM）</td><td>对模型输出进行偏好排序和评分</td></tr><tr><td>数据质检</td><td>审核和优化已有数据质量</td></tr></tbody></table>
<h3 data-id="heading-3">你将获得的回报</h3>
<ul>
<li>💰现金收益：深度参与数据标注的代码专家，月均获取 <strong>¥10000+</strong> 以上回报</li>
</ul>
<blockquote>
<ul>
<li>时薪范围：<strong>50 - 1000</strong> 元，具体以项目最终定价为准，多劳多得，任务明码标价；</li>
<li>计税方式：劳务独立计税，收益清晰透明。</li>
</ul>
</blockquote>
<ul>
<li>参与智能 Agent 调优，掌握前沿技术动态</li>
</ul>
<h3 data-id="heading-4">需要具备的条件</h3>
<ul>
<li><strong>对 AI 有热情，日常高频使用 AI Coding 工具</strong></li>
<li><strong>具备扎实的编程基础和代码理解能力</strong></li>
</ul>
<blockquote>
<p><strong>加分项</strong></p>
<ul>
<li>LeetCode Hard 题目高通过率</li>
<li>GitHub 高星仓库贡献者</li>
<li>开源社区活跃成员</li>
</ul>
</blockquote>
<p>同时欢迎：PM、QA 同学参与，平台同时提供非技术类题目</p>
<h2 data-id="heading-5">👀 我们的目标用户</h2>
<p>我们在寻找这样的你：</p>
<ul>
<li><strong>技术栈</strong>：熟悉大前端、Python、Java、C++、Go 等主流编程语言</li>
<li><strong>质量意识</strong>：熟悉测试与质量保障流程</li>
<li><strong>探索精神</strong>：对前沿技术有自己的理解，乐于探索新知识</li>
<li><strong>社区参与</strong>：有开源贡献、LeetCode 活跃经历者优先</li>
</ul>
<h2 data-id="heading-6">🚀你的专家任务</h2>
<h3 data-id="heading-7">标注实验</h3>
<blockquote>
<p>对代码片段、日志、技术文档等进行精准标注</p>
</blockquote>
<p><strong>具体职责</strong></p>
<ul>
<li>按照项目制定的标注规范，对指定数据（文本、代码片段、日志、技术文档等）进行准确标注</li>
<li>识别并修正数据中存在的歧义、错误或不一致之处</li>
<li>对复杂样本给出专业判断，确保标注结果的准确性与一致性</li>
</ul>
<h3 data-id="heading-8">质量把控</h3>
<blockquote>
<p>互审他人成果，保障数据纯度</p>
</blockquote>
<p><strong>具体职责</strong></p>
<ul>
<li>参与标注标准的制定与完善，提出改进意见</li>
<li>执行专家互审机制，对其他标注结果进行审核和反馈</li>
<li>结合实际经验，对标注样本的合理性和业务适配度进行评估</li>
</ul>
<h3 data-id="heading-9">知识贡献</h3>
<blockquote>
<p>沉淀最佳实践，打造可复用的知识宝库</p>
</blockquote>
<p><strong>具体职责</strong></p>
<ul>
<li>将个人专业知识转化为标注规范、最佳实践或案例，供团队参考</li>
<li>在遇到疑难问题时，作为专家提供判定依据，形成可复用的知识库</li>
<li>协助项目组优化任务分配、质量监控和流程设计</li>
</ul>
<h2 data-id="heading-10">☎️ 社群交流</h2>
<p>参加活动的掘友一定要入群：</p>
<ul>
<li>重要消息不错过</li>
<li>大家互相鼓励</li>
<li>有问题可以在群内咨询</li>
</ul>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7b9ae96e990d47e98940cc4b976a4053~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6YWx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765954781&amp;x-signature=mjhj%2BvYTH1G9pbiEGGwFs3mU6uI%3D" alt="134067c882fcc733a803fb9c71f0d2a6.png" loading="lazy"/></p>
<h2 data-id="heading-11">⁉️ 常见问题 FAQ</h2>
<p><strong>Q1：没有标注经验可以参与吗？</strong></p>
<p>我们需要你具备扎实的编程基础即可快速上手，所以需要你有一定的<em>编程经验</em>。</p>
<p><strong>Q2: 每天需要投入多少时间？</strong></p>
<p>完全灵活，可以根据自己的时间安排参与，充分利用碎片时间。</p>
<p><strong>Q3: 如何保证收益？</strong></p>
<p>任务明码标价，<em>多劳多得</em>，平台提供清晰的计价规则和结算流程。</p>
<p><strong>Q4: 非程序员可以参与吗？</strong></p>
<p>可以。平台同时提供非技术类题目，欢迎 <em>PM、QA</em> 等岗位同学参与。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React Native 交互终极指南：搞定触摸与手势 (Handling Touches)]]></title>    <link>https://juejin.cn/post/7581807793134207022</link>    <guid>https://juejin.cn/post/7581807793134207022</guid>    <pubDate>2025-12-10T06:30:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581807793134207022" data-draft-id="7581807793134174254" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React Native 交互终极指南：搞定触摸与手势 (Handling Touches)"/> <meta itemprop="keywords" content="前端,React Native"/> <meta itemprop="datePublished" content="2025-12-10T06:30:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="皮蛋小精灵"/> <meta itemprop="url" content="https://juejin.cn/user/219558056559278"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React Native 交互终极指南：搞定触摸与手势 (Handling Touches)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/219558056559278/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    皮蛋小精灵
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T06:30:45.000Z" title="Wed Dec 10 2025 06:30:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在移动应用开发中，用户与界面的交互方式与 Web 端截然不同。没有鼠标悬停（Hover），没有右键点击，只有<strong>触摸（Touch）</strong> 。</p>
<p>React Native 提供了一套完整的手势响应系统。从最简单的“点一下”到复杂的“长按”或“滑动”，你都需要选择正确的组件来实现。本文将带你深入了解 RN 的触摸处理机制。</p>
<hr/>
<h2 data-id="heading-0">一、 快速上手：基础组件 <code>&lt;Button /&gt;</code></h2>
<p>如果你只是想快速加一个“提交”按钮，或者你的 App 只需要呈现系统原生的外观，<code>&lt;Button /&gt;</code> 是你的首选。</p>
<h3 data-id="heading-1">特点</h3>
<ul>
<li><strong>开箱即用：</strong> 代码量极少。</li>
<li><strong>跨平台适配：</strong> iOS 上显示为蓝色文字，Android 上显示为圆角矩形按钮。</li>
<li><strong>局限性：</strong> <strong>样式不可定制</strong>。你不能修改它的字体大小、背景形状或内边距，只能修改 <code>color</code> 和 <code>title</code>。</li>
</ul>
<pre><code class="hljs language-TypeScript" lang="TypeScript">&lt;<span class="hljs-title class_">Button</span>
  onPress={<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">alert</span>(<span class="hljs-string">'点击了！'</span>)}
  title=<span class="hljs-string">"点我"</span>
  color=<span class="hljs-string">"#841584"</span>
/&gt;
</code></pre>
<hr/>
<h2 data-id="heading-2">二、 进阶定制：<code>Touchable</code> 系列组件</h2>
<p>当设计稿里的按钮五花八门（比如带图标的按钮、圆形的头像、卡片式列表）时，<code>&lt;Button /&gt;</code> 就无能为力了。这时你需要使用 <strong>"Touchable"（可触摸）</strong> 系列组件。</p>
<p>它们的逻辑是： <strong>“你可以把任何 View 包裹在 Touchable 组件里，让它变得可点击。”</strong></p>
<h3 data-id="heading-3">1. <code>TouchableOpacity</code> (最常用)</h3>
<ul>
<li><strong>效果：</strong> 用户按下时，组件的透明度降低（变淡），松开后恢复。</li>
<li><strong>场景：</strong> 适用于 90% 的自定义按钮场景，尤其是图标按钮或大色块按钮。</li>
<li><strong>优势：</strong> 不会遮挡背景内容，体验轻盈。</li>
</ul>
<h3 data-id="heading-4">2. <code>TouchableHighlight</code> (强调型)</h3>
<ul>
<li><strong>效果：</strong> 用户按下时，背景变暗（通常是变黑或变灰）。</li>
<li><strong>场景：</strong> 适用于列表项（List Item）或原本就有深色背景的实体按钮。</li>
<li><strong>注意：</strong> 使用时通常需要指定 <code>underlayColor</code> 属性（按下去显示的底色）。</li>
</ul>
<h3 data-id="heading-5">3. <code>TouchableNativeFeedback</code> (Android 专属)</h3>
<ul>
<li><strong>效果：</strong> 产生水波纹（Ripple）扩散效果。</li>
<li><strong>场景：</strong> 仅限 <strong>Android</strong>。这是 Material Design 的核心交互规范。</li>
<li><strong>建议：</strong> 如果你想做极致的 Android 体验，可以判断平台，在 Android 上用这个，iOS 上用 Opacity。</li>
</ul>
<h3 data-id="heading-6">4. <code>TouchableWithoutFeedback</code> (无视觉反馈)</h3>
<ul>
<li><strong>效果：</strong> 点击了没有任何视觉变化。</li>
<li><strong>场景：</strong> 点击空白处收起键盘、点击遮罩层关闭弹窗。</li>
<li><strong>警告：</strong> 慎用。用户点击按钮如果没有反应，会以为 App 卡死了。</li>
</ul>
<hr/>
<h2 data-id="heading-7">三、 交互事件：不仅是点击</h2>
<p>所有的 Touchable 组件都支持多种交互阶段的事件回调：</p>
<ul>
<li><code>onPress</code>: 手指按下并松开（由于是一次完整的点击）。</li>
<li><code>onLongPress</code>: 手指按住超过一定时间（长按）。常用于呼出菜单或多选模式。</li>
<li><code>onPressIn</code>: 手指刚接触屏幕。</li>
<li><code>onPressOut</code>: 手指离开屏幕。</li>
</ul>
<pre><code class="hljs language-TypeScript" lang="TypeScript">&lt;<span class="hljs-title class_">TouchableOpacity</span>
  onPress={<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'点了一下'</span>)}
  onLongPress={<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'长按了！！'</span>)}
&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">View</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{styles.button}</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">Text</span>&gt;</span>长按试试<span class="hljs-tag">&lt;/<span class="hljs-name">Text</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">View</span>&gt;</span></span>
&lt;/<span class="hljs-title class_">TouchableOpacity</span>&gt;
</code></pre>
<hr/>
<h2 data-id="heading-8">四、 避坑指南：Web 开发者的常见误区</h2>
<p>在处理触摸时，React Native 有一些底层的物理限制，这与 Web CSS 的行为不同。</p>
<h3 data-id="heading-9">1. 触摸区域无法“越界” (Parent Bounds)</h3>
<p>在 Web 上，如果你用 <code>position: absolute</code> 把一个关闭按钮移到了弹窗容器的<strong>外面</strong>（右上角悬浮），你依然可以点击它。</p>
<p>但在 React Native（尤其是 Android）中：<strong>子元素的触摸区域永远不会超出父元素的边界。</strong></p>
<ul>
<li><strong>现象：</strong> 按钮看得到，但点不到。</li>
<li><strong>解决：</strong> 确保父容器足够大，包含住了所有的子元素；或者不要让按钮完全“飞”出父容器。</li>
</ul>
<h3 data-id="heading-10">2. 负边距 (Negative Margin)</h3>
<ul>
<li><strong>Web：</strong> <code>margin-top: -20px</code> 是常规布局操作。</li>
<li><strong>RN (Android)：</strong> 历史上对负 Margin 支持很差，可能导致元素被裁剪或触摸失效。虽然新版本有所改善，但在涉及点击区域时，尽量使用 <code>position: absolute</code> 代替负边距布局。</li>
</ul>
<hr/>
<h2 data-id="heading-11">五、 总结：决策树</h2>
<p>在开发中，当你需要一个“可点击”的东西时，请按照以下逻辑选择：</p>
<ol>
<li>
<p><strong>是简单的文字按钮，且不在乎样式？</strong></p>
<ul>
<li>👉 用 <code>&lt;Button /&gt;</code></li>
</ul>
</li>
<li>
<p><strong>是 Android 平台且追求原生水波纹？</strong></p>
<ul>
<li>👉 用 <code>&lt;TouchableNativeFeedback /&gt;</code></li>
</ul>
</li>
<li>
<p><strong>是列表项或实心色块？</strong></p>
<ul>
<li>👉 用 <code>&lt;TouchableHighlight /&gt;</code></li>
</ul>
</li>
<li>
<p><strong>不想让用户看到任何点击反应？</strong></p>
<ul>
<li>👉 用 <code>&lt;TouchableWithoutFeedback /&gt;</code></li>
</ul>
</li>
<li>
<p><strong>其他所有情况（默认推荐）：</strong></p>
<ul>
<li>👉 用 <strong><code>&lt;TouchableOpacity /&gt;</code></strong></li>
</ul>
</li>
</ol>
<p>掌握了这些，你就掌握了 React Native 交互体验的基础命脉。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[使用大语言模型从零构建知识图谱（下）]]></title>    <link>https://juejin.cn/post/7581844141668843560</link>    <guid>https://juejin.cn/post/7581844141668843560</guid>    <pubDate>2025-12-10T06:35:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581844141668843560" data-draft-id="7581828086020046863" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="使用大语言模型从零构建知识图谱（下）    "/> <meta itemprop="keywords" content="LLM,人工智能"/> <meta itemprop="datePublished" content="2025-12-10T06:35:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="智见AGI"/> <meta itemprop="url" content="https://juejin.cn/user/4145611877132986"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            使用大语言模型从零构建知识图谱（下）    
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4145611877132986/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    智见AGI
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T06:35:45.000Z" title="Wed Dec 10 2025 06:35:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/66a215430242444d9cbb7fef084d517f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm66KeBQUdJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765953345&amp;x-signature=Cl8quT8Yukb03lAhyUBRpAZrnrs%3D" alt="7c47fe03bcb4867f67ffe4245342b19c_v2-d96f6f520cc63fbbd52ae2fdba1a11dc_1440w.jpg" loading="lazy"/>还没有看过上、中篇的读者可以阅读之前文章了解整个系列的内容：</p>
<p><a href="https://juejin.cn/post/7503536776344944675" target="_blank" title="https://juejin.cn/post/7503536776344944675">《使用大语言模型从零构建知识图谱（上）</a></p>
<p><a href="https://juejin.cn/post/7503536776344944675" target="_blank" title="https://juejin.cn/post/7503536776344944675">《使用大语言模型从零构建知识图谱（中）</a></p>
<p><strong>LangChain 中的 LLMGraphTransformer</strong></p>
<p>为了让我们的图谱更智能,我们使用 LangChain 从文本描述中提取实体(电影、演员等)和关系。LLMGraphTransformer 旨在使用语言模型将基于文本的文档转换为图文档。</p>
<p>让我们从初始化的过程开始：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">llm_transformer</span> = LLMGraphTransformer(
    <span class="hljs-attr">llm</span>=llm,
)
</code></pre>
<p>提供的 LLM 与我们用于自定义图构建器的是同一个。在这种情况下,我们使用默认参数,让模型可以自由地对节点、边和属性进行实验。但是,有几个参数值得了解,可能会进一步提升该算法的性能:</p>
<p>●allowed_nodes 和 allowed_relationships:我们没有指定,所以默认情况下允许所有节点和关系类型。</p>
<p>●strict_mode=True:如果指定了约束,则确保输出中仅包含允许的节点和关系。</p>
<p>●node_properties=False:禁用节点的属性提取。</p>
<p>●relationship_properties=False:禁用关系的属性提取。</p>
<p>●prompt:传入一个 ChatPromptTemplate 来自定义 LLM 的上下文。这与我们在自定义 LLM 中所做的类似。</p>
<p>该算法的一个缺点是速度相当慢,特别是考虑到我们没有提供节点和关系的列表。因此,我们将只使用数据集中 1000 行中的 100 行来加快速度:</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">printfdf_sample</span> = df.head(<span class="hljs-number">100</span>)  <span class="hljs-comment"># 减少样本量以加快处理速度("hello world!");</span>
</code></pre>
<p>接下来,让我们准备数据集。我们说过”LLMGraphTransformer 旨在将基于文本的文档转换为图文档”,这意味着我们需要将 pandas 数据框转换为文本:</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">df_sample</span> = movies.head(<span class="hljs-number">100</span>)

<span class="hljs-attr">documents</span> = []
for _, row in tqdm(df_sample.iterrows(), 
                   <span class="hljs-attr">total</span>=len(df_sample), 
                   <span class="hljs-attr">desc</span>=<span class="hljs-string">"正在创建文档"</span>,
                   <span class="hljs-attr">position</span>=<span class="hljs-number">0</span>, 
                   <span class="hljs-attr">leave</span>=<span class="hljs-literal">True</span>):
    try:
        <span class="hljs-comment"># 使用正确的换行符格式化文本</span>
        <span class="hljs-attr">text</span> = <span class="hljs-string">""</span>

        for col in df.columns:
            text += f"{col}: {row<span class="hljs-section">[col]</span>}\n"
        
        documents.append(Document(<span class="hljs-attr">page_content</span>=text))
        
    except KeyError as e:
        tqdm.write(f"缺失列: {e}")
    except Exception as e:
        tqdm.write(f"处理行时出错: {e}")
</code></pre>
<p>这将把每一行转换为文本并将其添加到 LangChain 的 Document 对象中,该对象与 LangChain 的 LLMGraphTransformer 兼容。</p>
<p>接下来,我们运行 LLM 并开始生成:</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">graph_documents</span> = await llm_transformer.aconvert_to_graph_documents(documents)
</code></pre>
<p>请注意,在这种情况下,我们使用 await 和 aconvert_to_graph_documents 而不是 convert_to_graph_documents 来异步处理文档,从而在大规模应用中实现更快的执行速度。</p>
<p>接下来,请耐心等待,因为这将需要一些时间(在我电脑上花费了大约 20 多分钟)。转换完成后,让我们打印生成的节点和关系:</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-built_in">print</span>(<span class="hljs-string">f"节点:<span class="hljs-subst">{graph_documents[<span class="hljs-number">0</span>].nodes}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"关系:<span class="hljs-subst">{graph_documents[<span class="hljs-number">0</span>].relationships}</span>"</span>)在我这里，我得到了以下结果:
</code></pre>
<p>在我这里，我得到了以下结果:</p>
<pre><code class="hljs language-bash" lang="bash">Nodes:[Node(<span class="hljs-built_in">id</span>=<span class="hljs-string">"Boone's cabin"</span>, <span class="hljs-built_in">type</span>=<span class="hljs-string">'Cabin'</span>, properties={}), Node(<span class="hljs-built_in">id</span>=<span class="hljs-string">'Boone'</span>, <span class="hljs-built_in">type</span>=<span class="hljs-string">'Boone'</span>, properties={}), Node(<span class="hljs-built_in">id</span>=<span class="hljs-string">'Indian maiden'</span>, <span class="hljs-built_in">type</span>=<span class="hljs-string">'Person'</span>, properties={}), Node(<span class="hljs-built_in">id</span>=<span class="hljs-string">'Indian chief'</span>, <span class="hljs-built_in">type</span>=<span class="hljs-string">'Chief'</span>, properties={}), Node(<span class="hljs-built_in">id</span>=<span class="hljs-string">'Florence Lawrence'</span>, <span class="hljs-built_in">type</span>=<span class="hljs-string">'Person'</span>, properties={}), Node(<span class="hljs-built_in">id</span>=<span class="hljs-string">'William Craven'</span>, <span class="hljs-built_in">type</span>=<span class="hljs-string">'Person'</span>, properties={}), Node(<span class="hljs-built_in">id</span>=<span class="hljs-string">'Wallace mccutcheon and ediwin s. porter'</span>, <span class="hljs-built_in">type</span>=<span class="hljs-string">'Director'</span>, properties={}), Node(<span class="hljs-built_in">id</span>=<span class="hljs-string">'Burning arrow'</span>, <span class="hljs-built_in">type</span>=<span class="hljs-string">'Arrow'</span>, properties={}), Node(<span class="hljs-built_in">id</span>=<span class="hljs-string">'Boone'</span>, <span class="hljs-built_in">type</span>=<span class="hljs-string">'Person'</span>, properties={}), Node(<span class="hljs-built_in">id</span>=<span class="hljs-string">'Indian camp'</span>, <span class="hljs-built_in">type</span>=<span class="hljs-string">'Camp'</span>, properties={}), Node(<span class="hljs-built_in">id</span>=<span class="hljs-string">'American'</span>, <span class="hljs-built_in">type</span>=<span class="hljs-string">'Ethnicity'</span>, properties={}), Node(<span class="hljs-built_in">id</span>=<span class="hljs-string">"Boone's horse"</span>, <span class="hljs-built_in">type</span>=<span class="hljs-string">'Horse'</span>, properties={}), Node(<span class="hljs-built_in">id</span>=<span class="hljs-string">'None'</span>, <span class="hljs-built_in">type</span>=<span class="hljs-string">'None'</span>, properties={}), Node(<span class="hljs-built_in">id</span>=<span class="hljs-string">'an indian maiden'</span>, <span class="hljs-built_in">type</span>=<span class="hljs-string">'Maiden'</span>, properties={}), Node(<span class="hljs-built_in">id</span>=<span class="hljs-string">'William craven'</span>, <span class="hljs-built_in">type</span>=<span class="hljs-string">'Cast'</span>, properties={}), Node(<span class="hljs-built_in">id</span>=<span class="hljs-string">'florence lawrence'</span>, <span class="hljs-built_in">type</span>=<span class="hljs-string">'Cast'</span>, properties={}), Node(<span class="hljs-built_in">id</span>=<span class="hljs-string">'Swears vengeance'</span>, <span class="hljs-built_in">type</span>=<span class="hljs-string">'Vengeance'</span>, properties={}), Node(<span class="hljs-built_in">id</span>=<span class="hljs-string">'Daniel Boone'</span>, <span class="hljs-built_in">type</span>=<span class="hljs-string">'Person'</span>, properties={}), Node(<span class="hljs-built_in">id</span>=<span class="hljs-string">'Indians'</span>, <span class="hljs-built_in">type</span>=<span class="hljs-string">'Group'</span>, properties={}), Node(<span class="hljs-built_in">id</span>=<span class="hljs-string">'Daniel boone'</span>, <span class="hljs-built_in">type</span>=<span class="hljs-string">'Title'</span>, properties={}), Node(<span class="hljs-built_in">id</span>=<span class="hljs-string">"Daniel Boone's daughter"</span>, <span class="hljs-built_in">type</span>=<span class="hljs-string">'Person'</span>, properties={})]
Relationships:[Relationship(<span class="hljs-built_in">source</span>=Node(<span class="hljs-built_in">id</span>=<span class="hljs-string">'Daniel Boone'</span>, <span class="hljs-built_in">type</span>=<span class="hljs-string">'Person'</span>, properties={}), target=Node(<span class="hljs-built_in">id</span>=<span class="hljs-string">'Daniel boone'</span>, <span class="hljs-built_in">type</span>=<span class="hljs-string">'Title'</span>, properties={}), <span class="hljs-built_in">type</span>=<span class="hljs-string">'TITLE'</span>, properties={}), Relationship(<span class="hljs-built_in">source</span>=Node(<span class="hljs-built_in">id</span>=<span class="hljs-string">'Daniel Boone'</span>, <span class="hljs-built_in">type</span>=<span class="hljs-string">'Person'</span>, properties={}), target=Node(<span class="hljs-built_in">id</span>=<span class="hljs-string">'American'</span>, <span class="hljs-built_in">type</span>=<span class="hljs-string">'Ethnicity'</span>, properties={}), <span class="hljs-built_in">type</span>=<span class="hljs-string">'ORIGIN_ETHNICITY'</span>, properties={}), Relationship(<span class="hljs-built_in">source</span>=Node(<span class="hljs-built_in">id</span>=<span class="hljs-string">'Daniel Boone'</span>, <span class="hljs-built_in">type</span>=<span class="hljs-string">'Person'</span>, properties={}), target=Node(<span class="hljs-built_in">id</span>=<span class="hljs-string">'Wallace mccutcheon and ediwin s. porter'</span>, <span class="hljs-built_in">type</span>=<span class="hljs-string">'Director'</span>, properties={}), <span class="hljs-built_in">type</span>=<span class="hljs-string">'DIRECTED_BY'</span>, properties={}), Relationship(<span class="hljs-built_in">source</span>=Node(<span class="hljs-built_in">id</span>=<span class="hljs-string">'William Craven'</span>, <span class="hljs-built_in">type</span>=<span class="hljs-string">'Person'</span>, properties={}), target=Node(<span class="hljs-built_in">id</span>=<span class="hljs-string">'William craven'</span>, <span class="hljs-built_in">type</span>=<span class="hljs-string">'Cast'</span>, properties={}), <span class="hljs-built_in">type</span>=<span class="hljs-string">'CAST'</span>, properties={}), Relationship(<span class="hljs-built_in">source</span>=Node(<span class="hljs-built_in">id</span>=<span class="hljs-string">'Florence Lawrence'</span>, <span class="hljs-built_in">type</span>=<span class="hljs-string">'Person'</span>, properties={}), target=Node(<span class="hljs-built_in">id</span>=<span class="hljs-string">'florence lawrence'</span>, <span class="hljs-built_in">type</span>=<span class="hljs-string">'Cast'</span>, properties={}), <span class="hljs-built_in">type</span>=<span class="hljs-string">'CAST'</span>, properties={}), Relationship(<span class="hljs-built_in">source</span>=Node(<span class="hljs-built_in">id</span>=<span class="hljs-string">"Daniel Boone's daughter"</span>, <span class="hljs-built_in">type</span>=<span class="hljs-string">'Person'</span>, properties={}), target=Node(<span class="hljs-built_in">id</span>=<span class="hljs-string">'an indian maiden'</span>, <span class="hljs-built_in">type</span>=<span class="hljs-string">'Maiden'</span>, properties={}), <span class="hljs-built_in">type</span>=<span class="hljs-string">'BEFRIENDS'</span>, properties={}), Relationship(<span class="hljs-built_in">source</span>=Node(<span class="hljs-built_in">id</span>=<span class="hljs-string">'Boone'</span>, <span class="hljs-built_in">type</span>=<span class="hljs-string">'Person'</span>, properties={}), target=Node(<span class="hljs-built_in">id</span>=<span class="hljs-string">'Indian camp'</span>, <span class="hljs-built_in">type</span>=<span class="hljs-string">'Camp'</span>, properties={}), <span class="hljs-built_in">type</span>=<span class="hljs-string">'LEADS_OUT_ON_A_HUNTING_EXPEDITION'</span>, properties={}), Relationship(<span class="hljs-built_in">source</span>=Node(<span class="hljs-built_in">id</span>=<span class="hljs-string">'Indians'</span>, <span class="hljs-built_in">type</span>=<span class="hljs-string">'Group'</span>, properties={}), target=Node(<span class="hljs-built_in">id</span>=<span class="hljs-string">"Boone's cabin"</span>, <span class="hljs-built_in">type</span>=<span class="hljs-string">'Cabin'</span>, properties={}), <span class="hljs-built_in">type</span>=<span class="hljs-string">'ATTACKS'</span>, properties={}), Relationship(<span class="hljs-built_in">source</span>=Node(<span class="hljs-built_in">id</span>=<span class="hljs-string">'Indian maiden'</span>, <span class="hljs-built_in">type</span>=<span class="hljs-string">'Person'</span>, properties={}), target=Node(<span class="hljs-built_in">id</span>=<span class="hljs-string">'None'</span>, <span class="hljs-built_in">type</span>=<span class="hljs-string">'None'</span>, properties={}), <span class="hljs-built_in">type</span>=<span class="hljs-string">'ESCAPES'</span>, properties={}), Relationship(<span class="hljs-built_in">source</span>=Node(<span class="hljs-built_in">id</span>=<span class="hljs-string">'Boone'</span>, <span class="hljs-built_in">type</span>=<span class="hljs-string">'Person'</span>, properties={}), target=Node(<span class="hljs-built_in">id</span>=<span class="hljs-string">'Swears vengeance'</span>, <span class="hljs-built_in">type</span>=<span class="hljs-string">'Vengeance'</span>, properties={}), <span class="hljs-built_in">type</span>=<span class="hljs-string">'RETURNS'</span>, properties={}), Relationship(<span class="hljs-built_in">source</span>=Node(<span class="hljs-built_in">id</span>=<span class="hljs-string">'Boone'</span>, <span class="hljs-built_in">type</span>=<span class="hljs-string">'Person'</span>, properties={}), target=Node(<span class="hljs-built_in">id</span>=<span class="hljs-string">'None'</span>, <span class="hljs-built_in">type</span>=<span class="hljs-string">'None'</span>, properties={}), <span class="hljs-built_in">type</span>=<span class="hljs-string">'HEADS_OUT_ON_THE_TRAIL_TO_THE_INDIAN_CAMP'</span>, properties={}), Relationship(<span class="hljs-built_in">source</span>=Node(<span class="hljs-built_in">id</span>=<span class="hljs-string">'Indians'</span>, <span class="hljs-built_in">type</span>=<span class="hljs-string">'Group'</span>, properties={}), target=Node(<span class="hljs-built_in">id</span>=<span class="hljs-string">'Boone'</span>, <span class="hljs-built_in">type</span>=<span class="hljs-string">'Boone'</span>, properties={}), <span class="hljs-built_in">type</span>=<span class="hljs-string">'ENCOUNTERS'</span>, properties={}), Relationship(<span class="hljs-built_in">source</span>=Node(<span class="hljs-built_in">id</span>=<span class="hljs-string">'Indian camp'</span>, <span class="hljs-built_in">type</span>=<span class="hljs-string">'Camp'</span>, properties={}), target=Node(<span class="hljs-built_in">id</span>=<span class="hljs-string">'Burning arrow'</span>, <span class="hljs-built_in">type</span>=<span class="hljs-string">'Arrow'</span>, properties={}), <span class="hljs-built_in">type</span>=<span class="hljs-string">'SET_ON_FIRE'</span>, properties={}), Relationship(<span class="hljs-built_in">source</span>=Node(<span class="hljs-built_in">id</span>=<span class="hljs-string">'Boone'</span>, <span class="hljs-built_in">type</span>=<span class="hljs-string">'Person'</span>, properties={}), target=Node(<span class="hljs-built_in">id</span>=<span class="hljs-string">'None'</span>, <span class="hljs-built_in">type</span>=<span class="hljs-string">'None'</span>, properties={}), <span class="hljs-built_in">type</span>=<span class="hljs-string">'GETS_TIED_TO_THE_STAKE_AND_TOURED'</span>, properties={}), Relationship(<span class="hljs-built_in">source</span>=Node(<span class="hljs-built_in">id</span>=<span class="hljs-string">'Indian camp'</span>, <span class="hljs-built_in">type</span>=<span class="hljs-string">'Camp'</span>, properties={}), target=Node(<span class="hljs-built_in">id</span>=<span class="hljs-string">'Burning arrow'</span>, <span class="hljs-built_in">type</span>=<span class="hljs-string">'Arrow'</span>, properties={}), <span class="hljs-built_in">type</span>=<span class="hljs-string">'SETS_ON_FIRE'</span>, properties={}), Relationship(<span class="hljs-built_in">source</span>=Node(<span class="hljs-built_in">id</span>=<span class="hljs-string">'Indians'</span>, <span class="hljs-built_in">type</span>=<span class="hljs-string">'Group'</span>, properties={}), target=Node(<span class="hljs-built_in">id</span>=<span class="hljs-string">"Boone's horse"</span>, <span class="hljs-built_in">type</span>=<span class="hljs-string">'Horse'</span>, properties={}), <span class="hljs-built_in">type</span>=<span class="hljs-string">'ENCOUNTERS'</span>, properties={}), Relationship(<span class="hljs-built_in">source</span>=Node(<span class="hljs-built_in">id</span>=<span class="hljs-string">'Boone'</span>, <span class="hljs-built_in">type</span>=<span class="hljs-string">'Person'</span>, properties={}), target=Node(<span class="hljs-built_in">id</span>=<span class="hljs-string">'Indian chief'</span>, <span class="hljs-built_in">type</span>=<span class="hljs-string">'Chief'</span>, properties={}), <span class="hljs-built_in">type</span>=<span class="hljs-string">'HAS_KNIFE_FIGHT_IN_WHICH_HE_KILLS_THE_INDIAN_CHIEF'</span>, properties={})]
</code></pre>
<p>接下来,是时候将生成的图文档添加到我们的知识图谱中了。我们可以通过利用 Neo4j 的 LangChain 集成来实现:</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">graph</span> = Neo4jGraph(url=uri, username=user, password=password, enhanced_schema=<span class="hljs-literal">True</span>)
graph.add_graph_documents(graph_document
</code></pre>
<p>让我们将图连接存储在 graph 变量中,传入您在应用程序开始时使用的相同 URL、用户名和密码。然后,让我们调用 add_graph_documents 方法将所有图文档添加到我们的数据库中。</p>
<p>完成该过程后,让我们最后一次切换到 Neo4j Browser,查看我们的新知识图谱。</p>
<p>像往常一样,运行以下查询来查看知识图谱:</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">MATCH</span> <span class="hljs-selector-tag">p</span>=(<span class="hljs-attribute">m</span>:Movie)<span class="hljs-selector-tag">-</span><span class="hljs-selector-attr">[r]</span><span class="hljs-selector-tag">-</span>(n)
<span class="hljs-selector-tag">RETURN</span> <span class="hljs-selector-tag">p</span>
<span class="hljs-selector-tag">LIMIT</span> <span class="hljs-number">100</span>;
</code></pre>
<p>在我这里，知识图谱看起来像这样：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ef8bde876f84472f8c9703678c185a13~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm66KeBQUdJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765953345&amp;x-signature=V7zfGmZD8gykS9w8PJ%2BPyLxT%2BQ8%3D" alt="" loading="lazy"/></p>
<p>由 LLMGraphTransformer 生成的知识图谱</p>
<p>但我们还没有完成。您可能还记得,我们的任务实际上是查询知识图谱以帮助我们找到电影。在本文中,我将提供一个简单的文本转 Cypher 方法,该方法将利用 LLM 生成 Cypher 查询、运行 Cypher 查询,并使用检索到的信息作为上下文来回答用户查询。但是,请注意这只是一个简单的方法,我们将在后面的文章中探索高级检索方法。 首先,让我们刷新图谱的模式,因为我们将使用它让 LLM 理解我们的知识图谱:</p>
<pre><code class="hljs language-scss" lang="scss">graph<span class="hljs-selector-class">.refresh_schema</span>()
</code></pre>
<p>接下来，我们来配置 QA 链：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">CYPHER_GENERATION_TEMPLATE</span> = <span class="hljs-string">"""任务:生成 Cypher 语句以查询图数据库。
指令:
仅使用模式中提供的关系类型和属性。
不要使用任何未提供的其他关系类型或属性。
模式:
{schema}
{schema}
注意:不要在响应中包含任何解释或道歉。
不要回答任何可能要求您构建 Cypher 语句以外的问题。
除了生成的 Cypher 语句外,不要包含任何文本。
返回完整的节点,不要只返回属性。

问题是:
{question}"""</span>

<span class="hljs-attr">CYPHER_GENERATION_PROMPT</span> = PromptTemplate(
    <span class="hljs-attr">input_variables</span>=[<span class="hljs-string">"schema"</span>, <span class="hljs-string">"question"</span>], template=CYPHER_GENERATION_TEMPLATE
)

<span class="hljs-attr">chain</span> = GraphCypherQAChain.from_llm(
    llm, 
    <span class="hljs-attr">graph</span>=graph, 
    <span class="hljs-attr">verbose</span>=<span class="hljs-literal">True</span>, 
    <span class="hljs-attr">allow_dangerous_requests</span>=<span class="hljs-literal">True</span>, 
    <span class="hljs-attr">return_intermediate_steps</span>=<span class="hljs-literal">True</span>,
    <span class="hljs-attr">cypher_prompt</span>=CYPHER_GENERATION_PROMPT
)
</code></pre>
<p>在上面的代码中,我们向 LLM 提供了一个提示来帮助它进行生成,并传入图变量的模式。 最后,让我们问它一些问题:</p>
<pre><code class="hljs language-arduino" lang="arduino">chain.<span class="hljs-built_in">run</span>(<span class="hljs-string">"请提供一份关于电影《大卫科波菲尔》的电影概述"</span>)
</code></pre>
<p>输出：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">Generated</span> <span class="hljs-selector-tag">Cypher</span>:
<span class="hljs-selector-tag">MATCH</span> <span class="hljs-selector-tag">p</span>=(<span class="hljs-attribute">n</span>:Title {id: 'David Copperfield'})<span class="hljs-selector-tag">-</span><span class="hljs-selector-attr">[*1..2]</span><span class="hljs-selector-tag">-</span>()
<span class="hljs-selector-tag">RETURN</span> <span class="hljs-selector-tag">p</span>
<span class="hljs-selector-tag">Full</span> <span class="hljs-selector-tag">Context</span>:
<span class="hljs-selector-attr">[{<span class="hljs-string">'p'</span>: [{<span class="hljs-string">'id'</span>: <span class="hljs-string">'David Copperfield'</span>}, <span class="hljs-string">'TITLE'</span>, {<span class="hljs-string">'id'</span>: <span class="hljs-string">'David Copperfield'</span>}]</span>}, {'<span class="hljs-selector-tag">p</span>': <span class="hljs-selector-attr">[{<span class="hljs-string">'id'</span>: <span class="hljs-string">'David Copperfield'</span>}, <span class="hljs-string">'TITLE'</span>, {<span class="hljs-string">'id'</span>: <span class="hljs-string">'David Copperfield'</span>}, <span class="hljs-string">'CAST_IN'</span>, {<span class="hljs-string">'id'</span>: <span class="hljs-string">'Florence La Badie'</span>}]</span>}, {'<span class="hljs-selector-tag">p</span>': <span class="hljs-selector-attr">[{<span class="hljs-string">'id'</span>: <span class="hljs-string">'David Copperfield'</span>}, <span class="hljs-string">'TITLE'</span>, {<span class="hljs-string">'id'</span>: <span class="hljs-string">'David Copperfield'</span>}, <span class="hljs-string">'RELEASE_YEAR'</span>, {<span class="hljs-string">'id'</span>: <span class="hljs-string">'1911'</span>}]</span>}, {'<span class="hljs-selector-tag">p</span>': <span class="hljs-selector-attr">[{<span class="hljs-string">'id'</span>: <span class="hljs-string">'David Copperfield'</span>}, <span class="hljs-string">'TITLE'</span>, {<span class="hljs-string">'id'</span>: <span class="hljs-string">'David Copperfield'</span>}, <span class="hljs-string">'GENRE'</span>, {<span class="hljs-string">'id'</span>: <span class="hljs-string">'Drama'</span>}]</span>}, {'<span class="hljs-selector-tag">p</span>': <span class="hljs-selector-attr">[{<span class="hljs-string">'id'</span>: <span class="hljs-string">'David Copperfield'</span>}, <span class="hljs-string">'TITLE'</span>, {<span class="hljs-string">'id'</span>: <span class="hljs-string">'David Copperfield'</span>}, <span class="hljs-string">'DIRECTED'</span>, {<span class="hljs-string">'id'</span>: <span class="hljs-string">'Theodore Marston'</span>}]</span>}, {'<span class="hljs-selector-tag">p</span>': <span class="hljs-selector-attr">[{<span class="hljs-string">'id'</span>: <span class="hljs-string">'David Copperfield'</span>}, <span class="hljs-string">'TITLE'</span>, {<span class="hljs-string">'id'</span>: <span class="hljs-string">'David Copperfield'</span>}, <span class="hljs-string">'ORIGIN_ETHNICITY'</span>, {<span class="hljs-string">'id'</span>: <span class="hljs-string">'American'</span>}]</span>}, {'<span class="hljs-selector-tag">p</span>': <span class="hljs-selector-attr">[{<span class="hljs-string">'id'</span>: <span class="hljs-string">'David Copperfield'</span>}, <span class="hljs-string">'TITLE'</span>, {<span class="hljs-string">'id'</span>: <span class="hljs-string">'David Copperfield'</span>}, <span class="hljs-string">'CAST_IN'</span>, {<span class="hljs-string">'id'</span>: <span class="hljs-string">'Mignon Anderson'</span>}]</span>}, {'<span class="hljs-selector-tag">p</span>': <span class="hljs-selector-attr">[{<span class="hljs-string">'id'</span>: <span class="hljs-string">'David Copperfield'</span>}, <span class="hljs-string">'TITLE'</span>, {<span class="hljs-string">'id'</span>: <span class="hljs-string">'David Copperfield'</span>}, <span class="hljs-string">'CAST_IN'</span>, {<span class="hljs-string">'id'</span>: <span class="hljs-string">'William Russell'</span>}]</span>}, {'<span class="hljs-selector-tag">p</span>': <span class="hljs-selector-attr">[{<span class="hljs-string">'id'</span>: <span class="hljs-string">'David Copperfield'</span>}, <span class="hljs-string">'TITLE'</span>, {<span class="hljs-string">'id'</span>: <span class="hljs-string">'David Copperfield'</span>}, <span class="hljs-string">'CAST_IN'</span>, {<span class="hljs-string">'id'</span>: <span class="hljs-string">'Marie Eline'</span>}]</span>}]
<span class="hljs-selector-tag">INFO</span>:<span class="hljs-selector-tag">httpx</span>:<span class="hljs-selector-tag">HTTP</span> <span class="hljs-selector-tag">Request</span>: <span class="hljs-selector-tag">POST</span> <span class="hljs-selector-tag">http</span>:<span class="hljs-comment">//127.0.0.1:11434/api/generate "HTTP/1.1 200 OK"</span>

&gt; <span class="hljs-selector-tag">Finished</span> <span class="hljs-selector-tag">chain</span>.
'<span class="hljs-selector-tag">David</span> <span class="hljs-selector-tag">Copperfield</span> <span class="hljs-selector-tag">is</span> <span class="hljs-selector-tag">a</span> <span class="hljs-number">1911</span> <span class="hljs-selector-tag">American</span> <span class="hljs-selector-tag">drama</span> <span class="hljs-selector-tag">film</span> <span class="hljs-selector-tag">directed</span> <span class="hljs-selector-tag">by</span> <span class="hljs-selector-tag">Theodore</span> <span class="hljs-selector-tag">Marston</span>. <span class="hljs-selector-tag">The</span> <span class="hljs-selector-tag">movie</span> <span class="hljs-selector-tag">stars</span> <span class="hljs-selector-tag">David</span> <span class="hljs-selector-tag">Copperfield</span>, <span class="hljs-selector-tag">Florence</span> <span class="hljs-selector-tag">La</span> <span class="hljs-selector-tag">Badie</span>, <span class="hljs-selector-tag">Mignon</span> <span class="hljs-selector-tag">Anderson</span>, <span class="hljs-selector-tag">William</span> <span class="hljs-selector-tag">Russell</span>, <span class="hljs-selector-tag">and</span> <span class="hljs-selector-tag">Marie</span> <span class="hljs-selector-tag">Eline</span> <span class="hljs-selector-tag">in</span> <span class="hljs-selector-tag">various</span> <span class="hljs-selector-tag">roles</span>. <span class="hljs-selector-tag">It</span> <span class="hljs-selector-tag">provides</span> <span class="hljs-selector-tag">an</span> <span class="hljs-selector-tag">overview</span> <span class="hljs-selector-tag">of</span> <span class="hljs-selector-tag">the</span> <span class="hljs-selector-tag">life</span> <span class="hljs-selector-tag">and</span> <span class="hljs-selector-tag">adventures</span> <span class="hljs-selector-tag">of</span> <span class="hljs-selector-tag">David</span> <span class="hljs-selector-tag">Copperfield</span> <span class="hljs-selector-tag">through</span> <span class="hljs-selector-tag">the</span> <span class="hljs-selector-tag">eyes</span> <span class="hljs-selector-tag">of</span> <span class="hljs-selector-tag">his</span> <span class="hljs-selector-tag">various</span> <span class="hljs-selector-tag">companions</span> <span class="hljs-selector-tag">and</span> <span class="hljs-selector-tag">experiences</span>.'通过设置 <span class="hljs-selector-tag">verbose</span>=<span class="hljs-selector-tag">True</span>,我们可以输出中间步骤:生成的 <span class="hljs-selector-tag">Cypher</span> 查询和提供的上下文。
</code></pre>
<p><strong>总结</strong></p>
<p>本文作为构建知识图谱的现代方法的入门介绍。首先,我们探索了传统方法并概述了 Cypher 语言,然后创建了一个简单的 LLM 图构建器来自动化图构建过程,其性能与手动过程中实现的性能相匹配。最后,我们更进一步,引入了 LangChain 的 LLMGraphTransformer,它显著改进了我们的知识图谱。然而,这只是我们 Graph RAG 之旅的开始,特别是我们的图构建器之旅。我们还需要探索和从头构建更多现代方法,我们将在未来的文章中完成这些工作。</p>
<p>此外,我们上面讨论的策略仍然没有考虑 Graph-RAG 的第二个组件:图检索器。尽管改进实际的图谱也会提高检索性能,但我们仍然没有从检索的角度进行思考。例如,按照我们目前采取的方向,标签、节点、边和属性越多越好。然而,这实际上使检索器函数更难识别要检索的正确信息。事实上,现代方法还考虑在知识图谱中遵循树形结构,通过创建宏观区域并进一步将其分解为微观区域来帮助检索。</p>
<p>目前,我希望您在不同的数据集上测试所有这些代码,并在扩展我所提供的简单的 LLM 图构建器时发挥创造力。尽管 LLMGraphTransformer 似乎是一个非常方便的选择,可以用最少的代码快速构建灵活的图构建器,但这种方法需要更多时间来构建我们的知识图谱。此外,从头开始构建它将确保您掌握并完全理解 Graph-RAG 背后的每个组件。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[计蒙指北：告别分身乏术，用 TRAE 做智能工具，搭建 “一人公司” 的隐性资产]]></title>    <link>https://juejin.cn/post/7581760987763933235</link>    <guid>https://juejin.cn/post/7581760987763933235</guid>    <pubDate>2025-12-10T06:50:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581760987763933235" data-draft-id="7581760987763310643" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="计蒙指北：告别分身乏术，用 TRAE 做智能工具，搭建 “一人公司” 的隐性资产"/> <meta itemprop="keywords" content="Trae"/> <meta itemprop="datePublished" content="2025-12-10T06:50:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="计蒙不吃鱼"/> <meta itemprop="url" content="https://juejin.cn/user/264296891420920"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            计蒙指北：告别分身乏术，用 TRAE 做智能工具，搭建 “一人公司” 的隐性资产
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/264296891420920/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    计蒙不吃鱼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T06:50:57.000Z" title="Wed Dec 10 2025 06:50:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>11月底，参加了TRAE Triends 南京的一场活动，一番运作下，参与了这场活动的现场支持。现场气氛很好，包括演讲，答疑等。以及各个环节都会有相应的礼品。有点想答疑拿礼品，但是，带着工作人员的牌子，怕被小伙伴误解成是来蹭周边的，哈哈哈哈哈哈 ~~~~~ ~~~~</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/083301cecf2e4db9a6f807f2d20720e1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K6h6JKZ5LiN5ZCD6bG8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765954256&amp;x-signature=efnQapaD9HrDysGYuwZyYOzYvOA%3D" alt="c0ab5b7d2ea1d555870b6a6beb679b2a.jpg" loading="lazy"/></p>
<p>当天发了个朋友圈，有活动现场的小伙伴在底下评论说：现场没有注意，现在才发现是掘金的衣服。晚上打开掘金（很久没有写博客想法了），正巧看到了掘金的活动推送，于是有了这篇文章。</p>
<p>（按照计蒙本人的日常进度。这篇文章本来应该在12月13日整理出来。）</p>
<p>时间线回到2018年底，当时还在大学参加竞赛，偶尔接一些Android私单。其中有一单是关于模拟手机点击的小工具APP。还记得~600块。通过先录制自己的操作，然后在手机上不断的复现其点击动作。</p>
<p>客户对UI没有任何要求，只要保证功能。大概在3天左右，完成了基础的功能。然后就是一些测试环节。在交付后，客户偷摸摸的问一句，有没有可能我发个短信，手机能自动运行这个程序。</p>
<p>很简单，加了一个广播的监听。客户加了200块。</p>
<p>通过触发一个事件，让设备完成一系列的任务。这便是本篇文章的核心思想。</p>
<h4 data-id="heading-1">先看一下效果：</h4>
<p>enmmmm，才发现好像没法放视频，脑瓜疼。（<strong>会把视频链接放在评论区，建议看看视频</strong>）</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c301e286986e45df874da9f0af0abf74~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K6h6JKZ5LiN5ZCD6bG8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765954256&amp;x-signature=IWVwLs3L8FdHCX%2BL4yKossy%2FcOY%3D" alt="aa140efe2c7ea069446186f0046cecc5.png" loading="lazy"/></p>
<h3 data-id="heading-2">简单介绍下自己</h3>
<p>写到这里，还是先给读者介绍一下个人背景。从19年到现在从研发-管理-产品-生态。除去工作上的事情，个人副业没停过，也做了很多的尝试。一直也保持着边工作边学习的一个状态。除去工作内容外。本人尝试过公众号，表情包，各大厂家的手机主题，小说，PPT一键生成的设计，小程序，个人网页等等，还有一些真正在赚钱的还是得藏起来的，就不写在这了，哈哈哈哈。</p>
<p>在接触到AI编程工具至今天，已经写了不下于20个较为完整的小Demo，有前后端的博客网站，静态的个人网页，基于云服务器的微信小程序模糊查询界面，文章展示界面。PPTX相关小工具（保持图层和文字样式的前提下批量换图片和文字内容），表情包gif剪切工具，小说简单润色工具，10余个自动化脚本，md文档转公众号格式工具，md文档转网页工具。嵌入式串口调试可视化工具。Android串口调试开发板相关工具等等。</p>
<p>今天的文章内容与以上无关，却更加有趣：智能点击助手。</p>
<h3 data-id="heading-3">文章灵感来源</h3>
<ul>
<li>
<p>5月中旬，代表总裁去参加某技术的测试认证相关会议。认识了很多公司的业务层的前辈。聊天的时候，偷偷取经，并没有怎么发言，除去一些核心的逻辑（将定制化产品过程中的内容，脱敏后，闭环再卖给客户等），更多的是谈到了个人规划的事情。最后我只在我的手机上记下了一句话---尽量去除重复劳动内容的过程（可复现琐事），以便于更有灵感且能战略决策的智商。</p>
</li>
<li>
<p>8月初，技术支持华为北京的一场师资培训，和几位教授聊了很久。从ai工具的出现到高校学生的培养以及高校老师的一些日常再到对某个事件的看法。也记下了一句话。新时代的杠杆--卖解决方案---标准化产品。</p>
</li>
</ul>
<h3 data-id="heading-4">关于 “一个公司”</h3>
<p>有一个概念，最近很火。”一人公司“，有很多认识的小伙伴，在自己超强的执行力的驱动下，已经有了实践。但是总会在一个阶段后陷入瓶颈以及焦虑。--有点分身乏术。</p>
<p>是不够努力吗？ 显然不是。靠着通过积累时长来实现利益的成倍收入，可能已经过时。</p>
<p>让投入时间做成的内容能被再次利用（复利资产），可能才是新的方向。</p>
<p>于是在各个领域小有所成的他们，尝试将自己的服务标准化。工程师将自己的各个流程标准化，可能是课程，可能是工具，可能是案例。只卖解决方案。实现收入指数级增长。（通过调用API，搭建自动化的流程，将各个模块串起来）</p>
<h4 data-id="heading-5">那么，如果没有API呢，如果是自己的工具呢。能串起来，让程序帮我们完成工作吗？</h4>
<h2 data-id="heading-6">正文</h2>
<p>开始今天的项目,实现一个简单版本的智能点击助手。微调了很多个版本，太过于碎片化。将基础版和一些思路写出来，以便于各位小伙伴发散思维。</p>
<h4 data-id="heading-7">提示词步骤1（思路）</h4>
<ul>
<li>做一个Python键盘鼠标模拟程序，用于自动化重复执行多组固定操作。（本次文章为1.0版本）</li>
</ul>
<h4 data-id="heading-8">提示词</h4>
<pre><code class="hljs language-我需要一个Python键鼠模拟程序，用于自动化重复执行多组固定操作，具体需求如下：" lang="我需要一个Python键鼠模拟程序，用于自动化重复执行多组固定操作，具体需求如下："> 1. 运行环境：Python 3.8+，Windows 10，依赖库优先用pyautogui； 
 2. 多组操作设定（核心）： 
    - 配置区支持添加N组操作（比如3组），每组操作可自由组合： 
      ✅ 鼠标：移动到指定(x,y)坐标（支持平滑移动/瞬间移动）、左键单击/双击、右键单击（可自定义单步延迟）； 
      ✅ 键盘：输入指定字符串（可设置字符间隔，模拟真人打字）、按下/释放单按键（如Enter、Tab）、组合键（如Ctrl+C、Alt+Tab）； 
    - 每组操作执行后，可单独设置“组间间隔”（比如第1组执行完等2秒，第2组执行完等1秒）； 
 3. 循环规则： 
    - 可自定义「整体循环次数」（比如循环20次），若设为0则无限循环； 
    - 循环执行时，按顺序跑完所有组操作→等待“循环间隔”→再从头执行，直到达到循环次数； 
    - 支持手动终止：除了左上角鼠标终止，按Esc键也能立即停止； 
 4. 代码要求： 
    - 分函数编写（比如执行单组操作、整体循环），结构清晰； 
    - 配置区用注释标注每一项的含义（比如# 第1组操作：点击按钮A→输入文字→按Enter）； 
    - 加入异常处理（比如操作失败不崩溃，提示错误位置）； 
    - 启动前加5秒倒计时（方便切换到目标窗口），并打印实时执行状态（比如“正在执行第2组操作，整体循环第3次”）。
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0622da74d50f47b588aadb885dcad92c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K6h6JKZ5LiN5ZCD6bG8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765954256&amp;x-signature=EFyl8c%2FF%2FrejAPEBgEsTXa7j6x0%3D" alt="trae1.png" loading="lazy"/></p>
<h5 data-id="heading-9">SOLO 生成了非常详细的功能说明和使用方法。一次过</h5>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/980ff57b9d064247b0757ad5f6c7d753~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K6h6JKZ5LiN5ZCD6bG8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765954256&amp;x-signature=VI3dar4Z4hJTbQ%2BMRficYxoRk7k%3D" alt="c1e96bbdace816f9c220aa5c2fa5ebf6.png" loading="lazy"/></p>
<h3 data-id="heading-10">提示词步骤2（思路）</h3>
<p>现在我需要一个可视化的界面进行操作</p>
<h4 data-id="heading-11">提示词</h4>
<pre><code class="hljs">现在我要根据电脑屏幕来设定一系列的组操作，你需要给我提供一个可视化界面来调整位置，并保存我的操作。
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a37acd335d184bbfb9545455b9971add~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K6h6JKZ5LiN5ZCD6bG8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765954256&amp;x-signature=Je8iUC3KcAn0h%2BLO9IZUk9SAsZ0%3D" alt="trae2.png" loading="lazy"/></p>
<h5 data-id="heading-12">一次过</h5>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6a50bd4cf41a43cd972f13ad2a757933~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K6h6JKZ5LiN5ZCD6bG8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765954256&amp;x-signature=Z032H%2B5GjjGclHvnnqp7gkBIXtc%3D" alt="630c9c9b6157fe7a97722db23cc5ec44.png" loading="lazy"/></p>
<p>##提示词步骤3（思路）
实现可自命名，以便于后续使用</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1d06806dbb1c4dce9e6ebf99c051c0fd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K6h6JKZ5LiN5ZCD6bG8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765954256&amp;x-signature=e2k2SDTzpAwyvGxvdjaaC83LQqQ%3D" alt="trae3.png" loading="lazy"/></p>
<h3 data-id="heading-13">使用工具</h3>
<p>根据自己需要重复劳动的内容，定制。
如：我这边使用的是我自己设定的公众号编写脚本。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/979f780cce1d43148fbe0994d6658f95~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K6h6JKZ5LiN5ZCD6bG8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765954256&amp;x-signature=5QAkWIDT3zNJg%2F4y5dKX9g6YiTA%3D" alt="20f5a6cd-38e5-4cfd-a4d9-e712a3ae4802.png" loading="lazy"/></p>
<p>导入对应的动作（主要是坐标和相关的鼠标和键盘的操作，我这边用的json数据的格式。）</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/85739254bba345648d863de499134091~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K6h6JKZ5LiN5ZCD6bG8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765954256&amp;x-signature=eO3RsYKHxUIjasnzY71Uuz6Fw0A%3D" alt="2c9e6184-d3a7-4236-983b-228226b6529a.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6edbee9eaee2458c94e0b852d40d6b72~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K6h6JKZ5LiN5ZCD6bG8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765954256&amp;x-signature=BrlS9yFpBF1EfGkBhwVsx%2BBiJ2w%3D" alt="ad665eb855e78537b2b6be6b1a9affab.png" loading="lazy"/></p>
<p>然后执行程序。</p>
<h3 data-id="heading-14">简单技巧</h3>
<p>目前网上技巧很多，计蒙这边就提几句。</p>
<ul>
<li>要让提示词更加详细，可通过反问法：简单告诉AI（如：豆包）你要做什么，并让他系统性的问你一系列的问题后，生成提示词。</li>
<li>每次实现的内容越少，效果越好（每次只实现一个小功能）</li>
<li>搭好基础框架（功能再慢慢加）</li>
</ul>
<p>如在本案例的基础上加上功能（微调版本2），让项目越来越懂你。如果你简单发散一下思维，说不定就能减少很多API的使用量呢（偷笑）</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/30599d1db0b14b2f90b8ad035ae71453~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K6h6JKZ5LiN5ZCD6bG8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765954256&amp;x-signature=y9Csfxk6qd%2B63er3bQVzFC8x9EE%3D" alt="trae4.png" loading="lazy"/></p>
<h3 data-id="heading-15">总结</h3>
<p>文章的结尾，以个人观点写一个大概的使用者进阶的过程，仅供参考。</p>
<p>1.下载几个AI工具，APP，寻找灵感以及解决生活中常见的问题。</p>
<p>2.跟着AI做一些内容的批量生成的内容，创作。</p>
<p>3.精读Transformers相关内容，了解必要知道的逻辑。</p>
<p>4.搭建自动化的流程。把各个模块串起来节约时间。配置结点，调用API。</p>
<p>5.用AI辅助工具写一个可视化界面给客户用以及项目。通过内购和广告实现盈利。（高校的学弟学妹可以从代码里看看逻辑，竞赛的小伙伴也可以找找灵感）。</p>
<p>6.写类似降低你的以上相关的劳动时间的工具。</p>
<h3 data-id="heading-16">欢迎留言，如有问题可私信计蒙。</h3></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2025年 Safari 和 iOS版本检测新思路]]></title>    <link>https://juejin.cn/post/7581844141669023784</link>    <guid>https://juejin.cn/post/7581844141669023784</guid>    <pubDate>2025-12-10T06:58:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581844141669023784" data-draft-id="7581814484065615924" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="2025年 Safari 和 iOS版本检测新思路"/> <meta itemprop="keywords" content="前端,后端,面试"/> <meta itemprop="datePublished" content="2025-12-10T06:58:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Immerse"/> <meta itemprop="url" content="https://juejin.cn/user/2708812817761752"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            2025年 Safari 和 iOS版本检测新思路
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2708812817761752/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Immerse
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T06:58:42.000Z" title="Wed Dec 10 2025 06:58:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是 Immerse，一名独立开发者、内容创作者、AGI 实践者。</p>
<p>关注公众号：<a href="https://link.juejin.cn?target=https%3A%2F%2Fyaolifeng.com%2Fother%2Fwx_public_account.webp" target="_blank" title="https://yaolifeng.com/other/wx_public_account.webp" ref="nofollow noopener noreferrer">沉浸式趣谈</a>，获取最新文章（更多内容只在公众号更新）</p>
<p>个人网站：<a href="https://link.juejin.cn?target=https%3A%2F%2Fyaolifeng.com" target="_blank" title="https://yaolifeng.com" ref="nofollow noopener noreferrer">yaolifeng.com</a> 也同步更新。</p>
<p>转载请在文章开头注明出处和版权信息。</p>
<p>我会在这里分享关于<code>编程</code>、<code>独立开发</code>、<code>AI干货</code>、<code>开源</code>、<code>个人思考</code>等内容。</p>
<p>如果本文对您有所帮助，欢迎动动小手指一键三连(<code>点赞</code>、<code>评论</code>、<code>转发</code>)，给我一些支持和鼓励，谢谢！</p>
<hr/>
<p>最近看到一篇文章，针对于 Safari 和 iOS 版本检测很不错，分享出来给大家。</p>
<p>之前都用 User-Agent 一把嗦，但文章提到检测结果不准确。</p>
<h2 data-id="heading-0">两个方式</h2>
<ol>
<li>User-Agent</li>
<li>特性检测</li>
</ol>
<h3 data-id="heading-1">User-Agent 检测</h3>
<p>这个方法就是获取浏览器的 User-Agent，从里面提取版本信息。</p>
<p>但是有问题，这个结果不准确。</p>
<p>Safari 的 UA 字符串里有两个版本号，一个是技术版本，一个是市场版本。很多脚本会把这俩搞混。</p>
<p>还有一点，从 macOS 11 开始，Safari 的 UA 里系统版本就不更新了，永远显示 10.15.7。</p>
<p>所以想从 UA 里准确获取版本？基本不可能。</p>
<p>MDN 官方都说了，别依赖 UA 字符串做浏览器检测逻辑，这是个常见 bug 源头。</p>
<h3 data-id="heading-2">特性检测</h3>
<p>苹果官方推荐: 特性检测。</p>
<p>就是直接检查浏览器支不支持某个 API 或 CSS 特性。</p>
<p>但它没法区分所有版本，因为很多特性在好几个版本里都有。</p>
<h2 data-id="heading-3">解决思路</h2>
<p>把两种方法结合起来用, 主要靠特性检测，UA 检测作为补充。</p>
<h3 data-id="heading-4">第一步：检测 WebKit 引擎</h3>
<p>在 iOS 上，所有浏览器都必须用 WebKit，包括 Chrome、Firefox 这些。</p>
<p>所以检测 WebKit 能帮我们缩小范围：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 桌面 Safari 和所有 iOS 浏览器</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">isWebkit</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">'GestureEvent'</span> <span class="hljs-keyword">in</span> <span class="hljs-variable language_">window</span>;
}

<span class="hljs-comment">// 所有移动端 WebKit 浏览器</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">isMobileWebKit</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">'ongesturechange'</span> <span class="hljs-keyword">in</span> <span class="hljs-variable language_">window</span>;
}

<span class="hljs-comment">// 只检测桌面 Safari</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">isDesktopWebKit</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">typeof</span> <span class="hljs-variable language_">window</span> !== <span class="hljs-string">'undefined'</span> &amp;&amp; <span class="hljs-string">'safari'</span> <span class="hljs-keyword">in</span> <span class="hljs-variable language_">window</span> &amp;&amp; <span class="hljs-string">'pushNotification'</span> <span class="hljs-keyword">in</span> <span class="hljs-variable language_">window</span>.<span class="hljs-property">safari</span>;
}
</code></pre>
<h3 data-id="heading-5">第二步：检测特定 iOS 版本</h3>
<p>去查 Safari 发布说明或 WebKit 的更新日志，找到某个版本新增的特性。</p>
<p>比如我想检测 iOS 17.0，发现这个版本加入了 <code>contain-intrinsic-size</code> 支持。</p>
<p>那就检测这个特性：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// iOS 17.0+ 返回 true</span>
<span class="hljs-keyword">const</span> isAtLeastiOS17 = <span class="hljs-variable constant_">CSS</span>.<span class="hljs-title function_">supports</span>(<span class="hljs-string">'contain-intrinsic-size'</span>, <span class="hljs-string">'100px'</span>);
</code></pre>
<p>如果要检测具体的小版本，可以配合下一个版本的特性来排除。</p>
<p>比如 <code>ManagedMediaSource</code> 是在 iOS 17.1 才有的：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> supportsManagedMediaSource = <span class="hljs-string">'ManagedMediaSource'</span> <span class="hljs-keyword">in</span> <span class="hljs-variable language_">window</span>;

<span class="hljs-comment">// 只匹配 iOS 17.0</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">isOnlyiOS170</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> isAtLeastiOS17 &amp;&amp; !supportsManagedMediaSource;
}

<span class="hljs-keyword">if</span> (<span class="hljs-title function_">isMobileWebKit</span>()) {
    <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isOnlyiOS170</span>()) {
        <span class="hljs-comment">// 这是 iOS 17.0</span>
    }
}
</code></pre>
<h3 data-id="heading-6">第三步：真机测试</h3>
<p>理论归理论，实际测试才是王道。</p>
<p>踩坑：</p>
<p>iOS 17.6 的发布说明里说支持 CSS 的 <code>safe</code> 关键字，用 <code>@supports</code> 检测也返回 true。</p>
<p>结果真机上一跑，根本不生效。</p>
<p>这种情况下，只能换个思路，检测实际的渲染效果：</p>
<p/>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-title function_">isSafeKeywordSupported</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">const</span> container = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'div'</span>);
    <span class="hljs-keyword">const</span> child = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'span'</span>);

    child.<span class="hljs-property">textContent</span> = <span class="hljs-string">'Evil Martians'</span>;

    container.<span class="hljs-property">style</span>.<span class="hljs-property">display</span> = <span class="hljs-string">'flex'</span>;
    container.<span class="hljs-property">style</span>.<span class="hljs-property">justifyContent</span> = <span class="hljs-string">'safe center'</span>;
    container.<span class="hljs-property">style</span>.<span class="hljs-property">width</span> = <span class="hljs-string">'5%'</span>;
    container.<span class="hljs-property">style</span>.<span class="hljs-property">position</span> = <span class="hljs-string">'absolute'</span>;
    container.<span class="hljs-property">style</span>.<span class="hljs-property">top</span> = <span class="hljs-string">'-9999px'</span>;
    container.<span class="hljs-property">style</span>.<span class="hljs-property">left</span> = <span class="hljs-string">'-9999px'</span>;

    container.<span class="hljs-title function_">appendChild</span>(child);
    <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">appendChild</span>(container);

    <span class="hljs-keyword">const</span> containerRect = container.<span class="hljs-title function_">getBoundingClientRect</span>();
    <span class="hljs-keyword">const</span> childRect = child.<span class="hljs-title function_">getBoundingClientRect</span>();
    <span class="hljs-keyword">const</span> isCroppedOnLeft = childRect.<span class="hljs-property">left</span> &lt; containerRect.<span class="hljs-property">left</span>;

    <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">removeChild</span>(container);
    <span class="hljs-keyword">return</span> !isCroppedOnLeft;
};
</code></pre>
<p>通过检查元素的实际渲染位置，判断特性是不是真的生效了。</p>
<h3 data-id="heading-7">第四步：配合 UA 检测</h3>
<p>有时候特性检测也不够用。</p>
<p>比如要区分 iPad 和其他设备。</p>
<p>iPad 的 UA 字符串跟 macOS 上的 Safari 一模一样。</p>
<p>但如果 UA 显示是 macOS，特性检测又显示是移动端 WebKit，那就能判断出这是 iPad：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 检测 iPadOS</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">isiPad</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">isDesktopWebKit</span>() &amp;&amp; <span class="hljs-title function_">isMobileWebKit</span>();
}
</code></pre>
<h2 data-id="heading-8">几个关键点</h2>
<p>WebKit 不等于 Safari，iOS 上所有浏览器都用 WebKit。</p>
<p>主要用特性检测，UA 检测只是补充。</p>
<p>多看 Safari 和 WebKit 的发布说明，但也别全信，因为有些变更根本没写进去。</p>
<p>真机测试不能省，有些 bug 只有在实际设备上才能发现。</p>
<p>有时候 <code>@supports</code> 会撒谎，浏览器说支持但实际不行，这时候得检查实际渲染效果。</p>
<h2 data-id="heading-9">写在最后</h2>
<p>核心思路就是：特性检测为主，UA 检测为辅，真机测试验证。</p>
<h3 data-id="heading-10">参考资料</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.apple.com%2Fdocumentation%2Fsafari-release-notes" target="_blank" title="https://developer.apple.com/documentation/safari-release-notes" ref="nofollow noopener noreferrer">developer.apple.com/documentati…</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwebkit.org%2F" target="_blank" title="https://webkit.org/" ref="nofollow noopener noreferrer">webkit.org/</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fen-US%2Fdocs%2FWeb%2FHTTP%2FGuides%2FBrowser_detection_using_the_user_agent" target="_blank" title="https://developer.mozilla.org/en-US/docs/Web/HTTP/Guides/Browser_detection_using_the_user_agent" ref="nofollow noopener noreferrer">developer.mozilla.org/en-US/docs/…</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Chrome DevTools MCP 配置指南：让 AI 助手控制你的浏览器]]></title>    <link>https://juejin.cn/post/7581789701532368938</link>    <guid>https://juejin.cn/post/7581789701532368938</guid>    <pubDate>2025-12-10T07:02:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581789701532368938" data-draft-id="7581727073582055475" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Chrome DevTools MCP 配置指南：让 AI 助手控制你的浏览器"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-10T07:02:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="若尘的技术之旅"/> <meta itemprop="url" content="https://juejin.cn/user/2700056286215032"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Chrome DevTools MCP 配置指南：让 AI 助手控制你的浏览器
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2700056286215032/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    若尘的技术之旅
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T07:02:07.000Z" title="Wed Dec 10 2025 07:02:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">🔧 Chrome DevTools MCP 配置指南：让 AI 助手控制你的浏览器</h2>
<h3 data-id="heading-1">前言</h3>
<p>在 AI 编程助手（如 Claude、CodeBuddy、Cursor 等）中，MCP（Model Context Protocol）是一种让 AI 与外部工具交互的协议。<strong>Chrome DevTools MCP</strong> 允许 AI 直接操控 Chrome 浏览器，实现：</p>
<ul>
<li>🖼️ 自动截取网页截图</li>
<li>🔍 获取页面 DOM 结构</li>
<li>⚡ 执行 JavaScript 代码</li>
<li>🌐 监控网络请求</li>
<li>🧪 自动化 UI 测试</li>
</ul>
<p>本文将详细介绍如何在 <strong>macOS</strong> 和 <strong>Windows</strong> 上配置 Chrome DevTools MCP，并创建便捷的启动方式。</p>
<hr/>
<h3 data-id="heading-2">一、原理简介</h3>
<p>Chrome DevTools MCP 的工作原理：</p>
<pre><code class="hljs language-scss" lang="scss">┌─────────────┐     MCP协议      ┌─────────────────────┐     CDP协议      ┌─────────────┐
│   AI 助手   │ ◄──────────────► │ Chrome DevTools MCP │ ◄──────────────► │   Chrome    │
│ (CodeBuddy) │                  │      Server         │                  │  (调试模式)  │
└─────────────┘                  └─────────────────────┘                  └─────────────┘
</code></pre>
<ul>
<li><strong>CDP（Chrome DevTools Protocol）</strong>：Chrome 原生的调试协议</li>
<li><strong>MCP Server</strong>：作为中间层，将 CDP 能力暴露给 AI 助手</li>
</ul>
<hr/>
<h3 data-id="heading-3">二、macOS 配置</h3>
<h4 data-id="heading-4">2.1 创建调试模式 Chrome 快捷方式</h4>
<p>为了让 MCP 能连接 Chrome，需要以 <strong>远程调试模式</strong> 启动浏览器。我们创建一个独立的应用，保持插件和数据持久化。</p>
<h5 data-id="heading-5">方案 A：Automator 应用程序（推荐）</h5>
<ol>
<li><strong>创建用户数据目录</strong></li>
</ol>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">mkdir</span> -p ~/ChromeDebugProfile
</code></pre>
<ol start="2">
<li>
<p><strong>打开 Automator</strong></p>
<ul>
<li>Spotlight 搜索 <code>Automator</code> 并打开</li>
<li>选择 <strong>新建文稿</strong> → <strong>应用程序</strong></li>
</ul>
</li>
<li>
<p><strong>添加 Shell 脚本</strong></p>
<ul>
<li>左侧搜索「运行 Shell 脚本」，双击添加</li>
<li>粘贴以下内容：</li>
</ul>
</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">/Applications/Google\ Chrome.app/Contents/MacOS/Google\ Chrome \
  --remote-debugging-port=9222 \
  --user-data-dir=<span class="hljs-string">"<span class="hljs-variable">$HOME</span>/ChromeDebugProfile"</span> &amp;
</code></pre>
<ol start="4">
<li>
<p><strong>保存应用</strong></p>
<ul>
<li><code>⌘ + S</code> 保存</li>
<li>名称：<code>Chrome Debug</code></li>
<li>位置：<code>应用程序</code> 文件夹</li>
</ul>
</li>
<li>
<p><strong>设置图标（可选）</strong></p>
<ul>
<li>右键 <code>/Applications/Google Chrome.app</code> → 显示简介 → 点击左上角图标 → <code>⌘ + C</code></li>
<li>右键 <code>/Applications/Chrome Debug.app</code> → 显示简介 → 点击左上角图标 → <code>⌘ + V</code></li>
</ul>
</li>
</ol>
<h5 data-id="heading-6">方案 B：命令行脚本</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 创建脚本</span>
<span class="hljs-built_in">cat</span> &gt; ~/Applications/chrome-debug.command &lt;&lt; <span class="hljs-string">'EOF'</span>
<span class="hljs-comment">#!/bin/bash</span>
/Applications/Google\ Chrome.app/Contents/MacOS/Google\ Chrome \
  --remote-debugging-port=9222 \
  --user-data-dir=<span class="hljs-string">"<span class="hljs-variable">$HOME</span>/ChromeDebugProfile"</span> &amp;
<span class="hljs-built_in">exit</span>
EOF

<span class="hljs-comment"># 添加执行权限</span>
<span class="hljs-built_in">chmod</span> +x ~/Applications/chrome-debug.command
</code></pre>
<p>双击 <code>chrome-debug.command</code> 即可启动。</p>
<hr/>
<h4 data-id="heading-7">2.2 配置 MCP Server</h4>
<p>以 CodeBuddy 为例，编辑配置文件：</p>
<p><strong>路径</strong>：<code>~/Library/Application Support/CodeBuddyExtension/Cache/CodeBuddyIDE/CodeBuddy CN/mcp/settings.json</code></p>
<p>添加以下配置：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"mcpServers"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"chrome-devtools"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"stdio"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"command"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"npx"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"args"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-string">"-y"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"chrome-devtools-mcp@latest"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"--browserUrl=http://127.0.0.1:9222"</span>
      <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"timeout"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">60000</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"disabled"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<blockquote>
<p>⚠️ <strong>注意</strong>：如果使用 nvm 管理 Node.js，需要填写 npx 的完整路径：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 获取 npx 路径</span>
<span class="hljs-built_in">which</span> npx
<span class="hljs-comment"># 输出类似：/Users/yourname/.nvm/versions/node/v22.11.0/bin/npx</span>
</code></pre>
<p>将 <code>command</code> 改为完整路径。</p>
</blockquote>
<hr/>
<h3 data-id="heading-8">三、Windows 配置</h3>
<h4 data-id="heading-9">3.1 创建调试模式 Chrome 快捷方式</h4>
<h5 data-id="heading-10">方案 A：桌面快捷方式（推荐）</h5>
<ol>
<li>
<p><strong>右键桌面</strong> → 新建 → 快捷方式</p>
</li>
<li>
<p><strong>输入目标位置</strong>：</p>
</li>
</ol>
<pre><code class="hljs language-ini" lang="ini">"C:\Program Files\Google\Chrome\Application\chrome.exe" <span class="hljs-attr">--remote-debugging-port</span>=<span class="hljs-number">9222</span> --user-data-dir=<span class="hljs-string">"%USERPROFILE%\ChromeDebugProfile"</span>
</code></pre>
<ol start="3">
<li>
<p><strong>命名</strong>：<code>Chrome Debug</code></p>
</li>
<li>
<p><strong>更换图标（可选）</strong>：</p>
<ul>
<li>右键快捷方式 → 属性 → 更改图标</li>
<li>浏览到 <code>C:\Program Files\Google\Chrome\Application\chrome.exe</code></li>
</ul>
</li>
</ol>
<h5 data-id="heading-11">方案 B：批处理脚本</h5>
<p>创建 <code>chrome-debug.bat</code> 文件：</p>
<pre><code class="hljs language-batch" lang="batch">@echo off
start "" "C:\Program Files\Google\Chrome\Application\chrome.exe" ^
  --remote-debugging-port=9222 ^
  --user-data-dir="%USERPROFILE%\ChromeDebugProfile"
</code></pre>
<p>双击运行即可。</p>
<h5 data-id="heading-12">方案 C：PowerShell 脚本</h5>
<p>创建 <code>chrome-debug.ps1</code> 文件：</p>
<pre><code class="hljs language-powershell" lang="powershell">Start-Process "C:\Program Files\Google\Chrome\Application\chrome.exe" `
  -ArgumentList "--remote-debugging-port=9222", "--user-data-dir=$env:USERPROFILE\ChromeDebugProfile"
</code></pre>
<hr/>
<h4 data-id="heading-13">3.2 配置 MCP Server</h4>
<p>以 CodeBuddy 为例，编辑配置文件：</p>
<p><strong>路径</strong>：<code>%APPDATA%\CodeBuddyExtension\Cache\CodeBuddyIDE\CodeBuddy CN\mcp\settings.json</code></p>
<p>添加以下配置：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"mcpServers"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"chrome-devtools"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"stdio"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"command"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"npx"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"args"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-string">"-y"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"chrome-devtools-mcp@latest"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"--browserUrl=http://127.0.0.1:9222"</span>
      <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"timeout"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">60000</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"disabled"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<blockquote>
<p>⚠️ <strong>注意</strong>：如果 <code>npx</code> 不在系统 PATH 中，需要填写完整路径，如：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"command"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"C:\\Program Files\\nodejs\\npx.cmd"</span>
</code></pre>
</blockquote>
<hr/>
<h3 data-id="heading-14">四、验证配置</h3>
<h4 data-id="heading-15">4.1 验证 Chrome 调试模式</h4>
<p>启动调试模式 Chrome 后，浏览器访问：</p>
<pre><code class="hljs language-arduino" lang="arduino">http:<span class="hljs-comment">//127.0.0.1:9222/json</span>
</code></pre>
<p>如果看到类似以下 JSON 输出，说明调试模式启动成功：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">[</span>
  <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">""</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"devtoolsFrontendUrl"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"/devtools/inspector.html?ws=127.0.0.1:9222/devtools/page/..."</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"..."</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"title"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"New Tab"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"page"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"url"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"chrome://newtab/"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"webSocketDebuggerUrl"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ws://127.0.0.1:9222/devtools/page/..."</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">]</span>
</code></pre>
<h4 data-id="heading-16">4.2 验证 MCP 连接</h4>
<p>重启 IDE 后，在 AI 对话中尝试：</p>
<blockquote>
<p>帮我截取当前浏览器页面的截图</p>
</blockquote>
<p>如果 AI 能返回截图，说明配置成功！</p>
<hr/>
<h3 data-id="heading-17">五、常见问题</h3>
<h4 data-id="heading-18">Q1: MCP Server process closed during connection</h4>
<p><strong>原因</strong>：<code>command</code> 字段不支持 shell 命令组合（如 <code>&amp;&amp;</code>）</p>
<p>❌ 错误写法：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"command"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"nvm use 22 &amp;&amp; npx"</span>
</code></pre>
<p>✅ 正确写法：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"command"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"/Users/yourname/.nvm/versions/node/v22.11.0/bin/npx"</span>
</code></pre>
<hr/>
<h4 data-id="heading-19">Q2: 端口 9222 被占用</h4>
<p><strong>解决方案</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># macOS/Linux：查找占用进程</span>
lsof -i :9222

<span class="hljs-comment"># Windows：查找占用进程</span>
netstat -ano | findstr :9222

<span class="hljs-comment"># 杀掉进程或换一个端口（如 9223）</span>
</code></pre>
<hr/>
<h4 data-id="heading-20">Q3: 每次启动都是新的浏览器环境</h4>
<p><strong>原因</strong>：没有指定 <code>--user-data-dir</code> 参数</p>
<p><strong>解决方案</strong>：确保启动命令包含：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">--user-data-dir</span>=<span class="hljs-string">"你的数据目录路径"</span>
</code></pre>
<hr/>
<h4 data-id="heading-21">Q4: 插件无法使用 / 登录状态丢失</h4>
<p><strong>原因</strong>：调试模式 Chrome 使用了独立的用户数据目录</p>
<p><strong>解决方案</strong>：首次启动后，在调试模式 Chrome 中重新安装插件、登录账号，后续会自动保存。</p>
<hr/>
<h3 data-id="heading-22">六、进阶配置</h3>
<h4 data-id="heading-23">6.1 开机自启动</h4>
<h5 data-id="heading-24">macOS</h5>
<p>系统设置 → 通用 → 登录项 → 添加 <code>Chrome Debug.app</code></p>
<h5 data-id="heading-25">Windows</h5>
<ol>
<li><code>Win + R</code> 输入 <code>shell:startup</code></li>
<li>将 <code>Chrome Debug</code> 快捷方式复制到打开的文件夹</li>
</ol>
<hr/>
<h4 data-id="heading-26">6.2 多端口配置</h4>
<p>如果需要同时运行多个调试实例：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 实例 1</span>
chrome --remote-debugging-port=9222 --user-data-dir=<span class="hljs-string">"~/ChromeDebug1"</span>

<span class="hljs-comment"># 实例 2</span>
chrome --remote-debugging-port=9223 --user-data-dir=<span class="hljs-string">"~/ChromeDebug2"</span>
</code></pre>
<hr/>
<h3 data-id="heading-27">七、参数说明</h3>





























<table><thead><tr><th>参数</th><th>说明</th></tr></thead><tbody><tr><td><code>--remote-debugging-port=9222</code></td><td>开启远程调试端口</td></tr><tr><td><code>--user-data-dir="路径"</code></td><td>指定用户数据目录（插件、书签、Cookie 等）</td></tr><tr><td><code>--headless</code></td><td>无头模式（不显示界面）</td></tr><tr><td><code>--disable-gpu</code></td><td>禁用 GPU 加速（解决某些兼容问题）</td></tr><tr><td><code>--no-first-run</code></td><td>跳过首次运行向导</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-28">八、总结</h3>
<p>通过本文的配置，你可以：</p>
<ol>
<li>✅ 创建独立的调试模式 Chrome，不影响日常使用</li>
<li>✅ 保持插件、书签、登录状态持久化</li>
<li>✅ 让 AI 助手通过 MCP 控制浏览器</li>
<li>✅ 实现自动化截图、DOM 分析、UI 测试等功能</li>
</ol>
<p>希望这篇文章对你有帮助！如果遇到问题，欢迎在评论区交流 💬</p>
<hr/>
<p><strong>相关链接</strong>：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fchromedevtools.github.io%2Fdevtools-protocol%2F" target="_blank" title="https://chromedevtools.github.io/devtools-protocol/" ref="nofollow noopener noreferrer">Chrome DevTools Protocol 官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmodelcontextprotocol.io%2F" target="_blank" title="https://modelcontextprotocol.io/" ref="nofollow noopener noreferrer">MCP 协议规范</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Apache RocketMQ Docker 容器化部署指南]]></title>    <link>https://juejin.cn/post/7581760987763114035</link>    <guid>https://juejin.cn/post/7581760987763114035</guid>    <pubDate>2025-12-10T03:34:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581760987763114035" data-draft-id="7581765536372817929" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Apache RocketMQ Docker 容器化部署指南"/> <meta itemprop="keywords" content="RocketMQ,Docker"/> <meta itemprop="datePublished" content="2025-12-10T03:34:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员老赵"/> <meta itemprop="url" content="https://juejin.cn/user/3208848015890347"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Apache RocketMQ Docker 容器化部署指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3208848015890347/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员老赵
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T03:34:03.000Z" title="Wed Dec 10 2025 03:34:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">概述</h2>
<p>Apache RocketMQ是一款分布式消息中间件，由Apache软件基金会开发维护，具有高吞吐量、低延迟、高可靠性等特点，广泛应用于分布式系统中的异步通信、流量削峰、系统解耦等场景。随着容器化技术的普及，采用Docker部署RocketMQ可以显著简化环境配置、提高部署一致性和运维效率。</p>
<p>本文将详细介绍如何通过Docker容器化方式部署Apache RocketMQ，包括环境准备、镜像拉取、容器部署、功能测试、生产环境优化及故障排查等内容，为用户提供一套完整的容器化部署方案。</p>
<h2 data-id="heading-1">环境准备</h2>
<h3 data-id="heading-2">Docker环境安装</h3>
<p>部署RocketMQ容器前，需先确保目标服务器已安装Docker环境。推荐使用以下一键安装脚本快速部署Docker及相关组件：</p>
<pre><code class="hljs language-less" lang="less">  <span class="hljs-selector-tag">bash</span> &lt;(wget -qO- <span class="hljs-attribute">https</span>:<span class="hljs-comment">//xuanyuan.cloud/docker.sh)</span>
</code></pre>
<p>执行完成后，可通过<code>docker --version</code>命令验证安装是否成功，输出类似<code>Docker version x.x.x, build xxxxxxx</code>即表示安装成功。</p>
<h2 data-id="heading-3">镜像准备</h2>
<h3 data-id="heading-4">拉取ROCKETMQ镜像</h3>
<p>使用以下命令通过轩辕镜像加速地址拉取最新版本的ROCKETMQ镜像：</p>
<pre><code class="hljs language-arduino" lang="arduino">  docker pull xxx.xuanyuan.run/apache/rocketmq:latest
</code></pre>
<p>拉取完成后，可通过以下命令验证镜像是否成功下载：</p>
<pre><code class="hljs language-bash" lang="bash">  docker images | grep apache/rocketmq
</code></pre>
<p>若输出包含<code>apache/rocketmq</code>及<code>latest</code>标签的记录，则表示镜像准备完成。</p>
<h2 data-id="heading-5">容器部署</h2>
<h3 data-id="heading-6">基础部署命令</h3>
<p>RocketMQ通常由NameServer和Broker两个核心组件构成，以下是基础的容器部署命令。</p>
<h4 data-id="heading-7">启动NameServer容器</h4>
<pre><code class="hljs language-bash" lang="bash">  docker run -d \  --name rocketmq-nameserver \  -p 9876:9876 \  -v /data/rocketmq/nameserver/logs:/root/logs \  -e <span class="hljs-string">"MAX_HEAP_SIZE=512m"</span> \  -e <span class="hljs-string">"HEAP_NEWSIZE=128m"</span> \  xxx.xuanyuan.run/apache/rocketmq:latest \  sh mqnamesrv
</code></pre>
<p><strong>参数说明</strong>：</p>
<ul>
<li>• <code>-d</code>：后台运行容器</li>
<li>• <code>--name</code>：指定容器名称为<code>rocketmq-nameserver</code></li>
<li>• <code>-p 9876:9876</code>：映射NameServer默认端口（需根据 轩辕镜像文档（ROCKETMQ） <code>https://xuanyuan.cloud/r/apache/rocketmq</code> 确认实际端口）</li>
<li>• <code>-v</code>：挂载日志目录到宿主机，实现数据持久化</li>
<li>• <code>-e</code>：设置JVM内存参数，可根据服务器配置调整</li>
</ul>
<h4 data-id="heading-8">启动Broker容器</h4>
<pre><code class="hljs language-bash" lang="bash">  docker run -d \  --name rocketmq-broker \  -p 10911:10911 \  -p 10909:10909 \  -v /data/rocketmq/broker/logs:/root/logs \  -v /data/rocketmq/broker/store:/root/store \  -e <span class="hljs-string">"NAMESRV_ADDR=nameserver-ip:9876"</span> \  -e <span class="hljs-string">"MAX_HEAP_SIZE=1024m"</span> \  -e <span class="hljs-string">"HEAP_NEWSIZE=256m"</span> \  xxx.xuanyuan.run/apache/rocketmq:latest \  sh mqbroker -c /opt/rocketmq/conf/broker.conf
</code></pre>
<p><strong>参数说明</strong>：</p>
<ul>
<li>• <code>NAMESRV_ADDR</code>：需替换为实际NameServer的IP地址和端口</li>
<li>• 端口映射：根据 轩辕镜像文档（ROCKETMQ） <code>https://xuanyuan.cloud/r/apache/rocketmq</code> 确认Broker的通信端口（如10911为默认监听端口，10909为VIP通道端口）</li>
<li>• 挂载目录：增加存储目录挂载，确保消息数据持久化</li>
</ul>
<h3 data-id="heading-9">容器状态检查</h3>
<p>部署完成后，通过以下命令检查容器运行状态：</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_">  # </span><span class="bash">查看所有RocketMQ相关容器docker ps --filter <span class="hljs-string">"name=rocketmq-"</span><span class="hljs-comment"># 查看容器日志（以Broker为例）docker logs -f rocketmq-broker</span></span>
</code></pre>
<p>若日志中出现<code>The broker[broker-a, xxx.xxx.xxx.xxx:10911] boot success. serializeType=JSON</code>等类似信息，则表示Broker启动成功。</p>
<h2 data-id="heading-10">功能测试</h2>
<h3 data-id="heading-11">基本连通性测试</h3>
<ol>
<li>
<p>1. <strong>进入Broker容器</strong>：</p>
<p>docker exec -it rocketmq-broker sh</p>
</li>
<li>
<p>2. <strong>设置NameServer地址</strong>：</p>
<p>export NAMESRV_ADDR=nameserver-ip:9876</p>
</li>
<li>
<p>3. <strong>发送测试消息</strong>：</p>
<p>sh tools.sh org.apache.rocketmq.example.quickstart.Producer</p>
</li>
</ol>
<p>若输出<code>SendResult [sendStatus=SEND_OK, msgId=...</code>等信息，则表示消息发送成功。</p>
<ol>
<li>
<p>4. <strong>接收测试消息</strong>：</p>
<p>sh tools.sh org.apache.rocketmq.example.quickstart.Consumer</p>
</li>
</ol>
<p>若输出<code>ConsumeMessageThread_%d Receive New Messages: [MessageExt...</code>等信息，则表示消息接收成功。</p>
<h3 data-id="heading-12">外部访问测试</h3>
<p>在宿主机或其他可访问服务器上，通过RocketMQ客户端工具连接部署的服务，验证外部网络连通性。需确保宿主机防火墙已开放相关端口（如9876、10911等）。</p>
<h2 data-id="heading-13">生产环境建议</h2>
<h3 data-id="heading-14">数据持久化</h3>
<ol>
<li>
<p>1. <strong>目录挂载</strong>：生产环境中必须挂载日志和存储目录，避免容器重启导致数据丢失：</p>
<p>-v /data/rocketmq/nameserver/logs:/root/logs -v /data/rocketmq/nameserver/store:/root/store \  # 若NameServer有持久化需求-v /data/rocketmq/broker/logs:/root/logs -v /data/rocketmq/broker/store:/root/store \</p>
</li>
<li>
<p>2. <strong>存储优化</strong>：建议使用高性能存储（如SSD）存放Broker的store目录，提升消息读写性能。</p>
</li>
</ol>
<h3 data-id="heading-15">资源配置</h3>
<ol>
<li>
<p>1. <strong>JVM参数调整</strong>：根据服务器配置合理设置JVM内存，避免OOM或资源浪费：</p>
<p>-e "MAX_HEAP_SIZE=4g" \  # 最大堆内存，建议为物理内存的50%-e "HEAP_NEWSIZE=1g" \   # 新生代内存，建议为最大堆内存的25%</p>
</li>
<li>
<p>2. <strong>容器资源限制</strong>：使用<code>--memory</code>和<code>--cpus</code>限制容器资源使用，避免资源争抢：</p>
<p>--memory=8g --cpus=4 \</p>
</li>
</ol>
<h3 data-id="heading-16">高可用配置</h3>
<ol>
<li>
<p>1. <strong>多节点部署</strong>：部署多个NameServer节点（至少3个），避免单点故障。</p>
</li>
<li>
<p>2. <strong>Broker集群</strong>：采用主从架构或Dledger模式部署Broker集群，确保消息可靠性。</p>
</li>
<li>
<p>3. <strong>网络隔离</strong>：通过Docker网络隔离不同环境（开发/测试/生产），使用自定义网络而非默认bridge网络：</p>
<p>docker network create rocketmq-networkdocker run -d --name rocketmq-nameserver --network rocketmq-network ...</p>
</li>
</ol>
<h3 data-id="heading-17">安全加固</h3>
<ol>
<li>
<p>1. <strong>容器权限</strong>：避免使用root用户运行容器，通过<code>--user</code>指定非特权用户：</p>
<p>--user 1000:1000 \</p>
</li>
<li>
<p>2. <strong>配置文件挂载</strong>：挂载自定义broker.conf配置文件，启用访问控制、TLS等安全特性：</p>
<p>-v /data/rocketmq/conf/broker.conf:/opt/rocketmq/conf/broker.conf \</p>
</li>
<li>
<p>3. <strong>日志轮转</strong>：配置宿主机日志轮转策略，避免日志文件过大占用磁盘空间。</p>
</li>
</ol>
<h2 data-id="heading-18">故障排查</h2>
<h3 data-id="heading-19">容器无法启动</h3>
<ol>
<li>
<p>1. <strong>查看启动日志</strong>：</p>
<p>docker logs --tail=100 rocketmq-broker  # 查看最近100行日志</p>
</li>
<li>
<p>2. <strong>检查端口占用</strong>：</p>
<p>netstat -tulpn | grep 9876  # 检查NameServer端口是否被占用</p>
</li>
<li>
<p>3. <strong>资源限制检查</strong>：若容器因资源不足被系统终止，可通过<code>dmesg | grep -i 'out of memory'</code>查看系统OOM日志。</p>
</li>
</ol>
<h3 data-id="heading-20">消息发送/接收失败</h3>
<ol>
<li>
<p>1. <strong>NameServer连接检查</strong>：确认Broker配置的<code>NAMESRV_ADDR</code>正确，可通过<code>telnet nameserver-ip 9876</code>测试网络连通性。</p>
</li>
<li>
<p>2. <strong>Broker状态检查</strong>：通过RocketMQ控制台或命令行工具查看Broker状态：</p>
<p>sh mqadmin clusterList -n nameserver-ip:9876</p>
</li>
<li>
<p>3. <strong>权限配置检查</strong>：若启用了ACL，检查生产者/消费者的accessKey和secretKey是否正确。</p>
</li>
</ol>
<h3 data-id="heading-21">数据一致性问题</h3>
<ol>
<li>
<p>1. <strong>存储目录权限</strong>：检查宿主机挂载目录权限是否正确，确保容器内用户有读写权限：</p>
<p>ls -ld /data/rocketmq/broker/store  # 权限应为755或容器用户可访问</p>
</li>
<li>
<p>2. <strong>磁盘空间检查</strong>：若磁盘空间不足，可能导致消息写入失败，通过<code>df -h</code>检查磁盘使用情况。</p>
</li>
</ol>
<h2 data-id="heading-22">参考资源</h2>
<ul>
<li>• 轩辕镜像文档（ROCKETMQ）<code>https://xuanyuan.cloud/r/apache/rocketmq</code></li>
<li>• ROCKETMQ镜像标签列表 <code>https://xuanyuan.cloud/r/apache/rocketmq/tags</code></li>
<li>• Docker官方文档： Docker Run Reference <code>https://docs.docker.com/engine/reference/commandline/run</code></li>
</ul>
<h2 data-id="heading-23">总结</h2>
<p>本文详细介绍了Apache RocketMQ的Docker容器化部署方案，包括环境准备、镜像拉取、容器部署、功能测试、生产环境优化及故障排查等内容，为快速搭建RocketMQ服务提供了可参考的实践指南。</p>
<p><strong>关键要点</strong>：</p>
<ul>
<li>• 使用一键脚本快速部署Docker环境，简化前期准备工作</li>
<li>• 通过轩辕镜像加速提升RocketMQ镜像下载速度，缩短部署时间</li>
<li>• 容器部署需注意核心组件（NameServer/Broker）的端口映射和数据持久化配置</li>
<li>• 生产环境中应重点关注高可用架构、资源配置优化和安全加固</li>
</ul>
<p><strong>后续建议</strong>：</p>
<ul>
<li>• 深入学习RocketMQ的集群部署模式（如Dledger主从、多副本等），提升服务可靠性</li>
<li>• 根据业务场景需求调整Broker配置参数（如消息重试策略、存储策略等）</li>
<li>• 部署RocketMQ控制台，实现可视化监控和管理</li>
<li>• 制定完善的运维方案，包括备份策略、扩容机制和故障恢复流程</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java并发核心机制深度拆解——从ConcurrentHashMap到Happens-Before]]></title>    <link>https://juejin.cn/post/7581789701531811882</link>    <guid>https://juejin.cn/post/7581789701531811882</guid>    <pubDate>2025-12-10T04:18:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581789701531811882" data-draft-id="7581702285564821554" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java并发核心机制深度拆解——从ConcurrentHashMap到Happens-Before"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2025-12-10T04:18:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="跳跳鱼"/> <meta itemprop="url" content="https://juejin.cn/user/222556523076779"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java并发核心机制深度拆解——从ConcurrentHashMap到Happens-Before
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/222556523076779/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    跳跳鱼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T04:18:47.000Z" title="Wed Dec 10 2025 04:18:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>第一部分：ConcurrentHashMap的演进与实现原理</strong></h2>
<p><strong>ConcurrentHashMap在JDK 1.7和1.8中有什么重要改进？</strong></p>
<p>ConcurrentHashMap在JDK 1.7到1.8版本有重大重构：</p>
<ul>
<li><strong>数据结构</strong>：由1.7的Segment数组+HashEntry改为Node数组+链表/红黑树</li>
<li><strong>同步策略</strong>：由ReentrantLock锁住整个Segment改为仅对每个桶的头部节点添加synchronized，并配合大量CAS操作</li>
<li><strong>锁粒度</strong>：减小锁竞争的概率</li>
</ul>
<p>除此之外，1.8版本还有其他优化：</p>
<ol>
<li><strong>get()操作无需加锁</strong>：因为Node节点的val和next字段被volatile修饰</li>
<li><strong>多线程扩容</strong>：提升了扩容效率</li>
<li><strong>size()方法优化</strong>：<code>size()</code>方法采用分桶计数（<code>CounterCell</code>），通过累加各部分的计数来获取总量，避免了全局锁，实现了高并发下的精确计数</li>
<li>
<ul>
<li><strong>引入红黑树</strong>：当单个桶内的元素过多时，链表查询会退化为O(n)。1.8版在特定条件下将链表转换为红黑树，将查询复杂度优化为O(log n)，有效解决了哈希冲突严重时的性能问题</li>
</ul>
</li>
</ol>
<hr/>
<h2 data-id="heading-1"><strong>第二部分：volatile与原子操作</strong></h2>
<p><strong><code>volatile</code> 保证了可见性，却无法保证操作的原子性。</strong></p>
<p>以经典的“读-改-写”场景——计数器递增 <code>i++</code> 为例，它实际上包含三个独立步骤：</p>
<ol>
<li><strong>读取</strong>当前值</li>
<li><strong>计算</strong>新值（当前值+1）</li>
<li><strong>写入</strong>新值</li>
</ol>
<p>如果 <code>i</code> 是 <code>volatile</code> 的，两个线程A和B几乎同时执行 <code>i++</code>，可能出现以下交错执行序列：</p>
<ol>
<li>线程A读取 <code>i=0</code></li>
<li>线程B读取 <code>i=0</code> （<strong>因为A还未写入，B读到了旧值</strong>）</li>
<li>线程A计算 <code>0+1=1</code> 并写入，<code>i</code> 变为 <code>1</code>（且立刻对所有线程可见）</li>
<li>线程B计算 <code>0+1=1</code> 并写入，<code>i</code> 再次变为 <code>1</code></li>
</ol>
<p>最终结果 <code>i=1</code>，而不是正确的 <code>2</code>。<strong><code>volatile</code> 保证了B在第4步能立刻看到A在第3步写入的 <code>1</code>，但无法阻止B在第2步已经读取了旧的 <code>0</code></strong>。这就是原子性缺失导致的线程安全问题。</p>
<h3 data-id="heading-2"/>
<p><strong>既然volatile不足以保证复合操作的原子性，那有哪些解决方案？</strong></p>
<p>保证原子性的核心思想是将多个操作捆绑成一个不可分割的整体，方法包括：</p>
<ol>
<li>
<p><strong>加互斥锁</strong>：使用synchronized或ReentrantLock</p>
<ul>
<li>优点：简单安全</li>
<li>缺点：性能消耗相对较大</li>
</ul>
</li>
<li>
<p><strong>Atomic原子类</strong>：如AtomicInteger进行CAS操作</p>
<ul>
<li>优点：性能通常比加锁好</li>
<li>缺点：高并发下CAS自旋可能消耗CPU，且只适用于单个变量</li>
</ul>
</li>
<li>
<p><strong>并发容器提供的原子方法</strong>：如ConcurrentHashMap的putIfAbsent</p>
<ul>
<li>优点：简单高效</li>
<li>缺点：依赖容器，不够灵活</li>
</ul>
</li>
</ol>
<hr/>
<h2 data-id="heading-3"><strong>第三部分：CAS与ABA问题</strong></h2>
<p><strong>什么是ABA问题？如何解决？</strong></p>
<p><strong>ABA问题</strong>是指在CAS操作时，一个值从A变成B又变回A，线程误以为状态没有改变。</p>
<p><strong>示例</strong>：张三借李四的钱，李四账户余额为0。张三还款后改为100，又被王五取走，账户余额归0。张三看到余额为0就判断李四没有还钱。</p>
<p><strong>解决方案</strong>：</p>
<ul>
<li>
<p><strong>添加版本号或时间戳</strong>：每次更改数值必须同步修改版本号</p>
</li>
<li>
<p><strong>JDK工具</strong>：</p>
<ul>
<li>AtomicStampedReference：提供版本号</li>
<li>AtomicMarkableReference：提供boolean值判断状态是否被修改</li>
</ul>
</li>
</ul>
<hr/>
<h2 data-id="heading-4"><strong>第四部分：JMM与Happens-Before规则</strong></h2>
<p><strong>volatile变量如何建立happens-before关系？有什么经典应用？</strong></p>
<p>volatile变量遵循两个原则：</p>
<ol>
<li><strong>写操作时</strong>：所有其他变量的修改也会一起刷新</li>
<li><strong>禁止重排序</strong>：写操作之前的操作不能重排序到写之后，读操作之后的操作不能重排序到读之前</li>
</ol>
<p><strong>经典应用：标志位开关</strong></p>
<pre><code class="hljs language-Java" lang="Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Example</span> {
    <span class="hljs-comment">// 核心：volatile 标志位开关</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">stopRequested</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">someState</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; <span class="hljs-comment">// 一个普通的非volatile变量</span>

    <span class="hljs-comment">// 工作线程</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">Thread</span> <span class="hljs-variable">workerThread</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
        <span class="hljs-keyword">while</span> (!stopRequested) { <span class="hljs-comment">// 【 volatile 读 】- 这里建立了hb关系</span>
            <span class="hljs-comment">// 模拟工作：读取或修改 someState</span>
            someState++;
            <span class="hljs-keyword">try</span> {
                Thread.sleep(<span class="hljs-number">100</span>);
            } <span class="hljs-keyword">catch</span> (InterruptedException ignored) {}
        }
        <span class="hljs-comment">// 循环结束后，能看到主线程在设置stopRequested=true之前修改的所有状态</span>
        System.out.println(<span class="hljs-string">"Worker stopped. Final state: "</span> + someState);
    });

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">start</span><span class="hljs-params">()</span> {
        workerThread.start();
    }

    <span class="hljs-comment">// 主线程调用此方法请求停止</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">stop</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 1. 主线程可以在此更新一些最终状态（例如保存进度）</span>
        someState = <span class="hljs-number">100</span>; <span class="hljs-comment">// 普通写</span>
        <span class="hljs-comment">// 2. 【关键 volatile 写 】</span>
        stopRequested = <span class="hljs-literal">true</span>; <span class="hljs-comment">// 这个写操作与workerThread的读操作建立happens-before</span>
        System.out.println(<span class="hljs-string">"Stop requested sent."</span>);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException {
        <span class="hljs-type">Example</span> <span class="hljs-variable">example</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Example</span>();
        example.start();
        Thread.sleep(<span class="hljs-number">1000</span>); <span class="hljs-comment">// 让工作线程运行1秒</span>
        example.stop(); <span class="hljs-comment">// 发送停止信号</span>
        example.workerThread.join(); <span class="hljs-comment">// 等待工作线程结束</span>
    }
}
</code></pre>
<p><strong>2.双重检查锁定单例模式</strong></p>
<pre><code class="hljs language-Java" lang="Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Singleton</span> {
    <span class="hljs-comment">// 关键：instance必须声明为volatile</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">volatile</span> Singleton instance;
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Config config;
    
    <span class="hljs-keyword">private</span> <span class="hljs-title function_">Singleton</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 这是一个昂贵的初始化过程</span>
        <span class="hljs-built_in">this</span>.config = loadConfigFromDB(); <span class="hljs-comment">// 假设此操作很耗时</span>
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Singleton <span class="hljs-title function_">getInstance</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">if</span> (instance == <span class="hljs-literal">null</span>) {                     <span class="hljs-comment">// 第一次检查（无锁，性能关键）</span>
            <span class="hljs-keyword">synchronized</span> (Singleton.class) {        <span class="hljs-comment">// 加锁</span>
                <span class="hljs-keyword">if</span> (instance == <span class="hljs-literal">null</span>) {             <span class="hljs-comment">// 第二次检查（防止重复创建）</span>
                    <span class="hljs-comment">// 非原子操作：1.分配内存 2.调用构造函数 3.将引用赋给instance</span>
                    <span class="hljs-comment">// 如果没有volatile，步骤2和3可能被重排序，导致其他线程看到未初始化完的对象（config为null）</span>
                    instance = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Singleton</span>();
                }
            }
        }
        <span class="hljs-keyword">return</span> instance;
    }
    
    <span class="hljs-keyword">public</span> Config <span class="hljs-title function_">getConfig</span><span class="hljs-params">()</span> { <span class="hljs-keyword">return</span> config; }
}
</code></pre>
<hr/>
<p><strong>双重检查锁定单例中，为什么instance变量必须用volatile修饰？</strong></p>
<p><code>synchronized</code>保证同一时刻只有一个线程执行实例化代码块，但无法阻止JVM或CPU优化导致的指令重排序。</p>
<p><code>instance = new Singleton()</code>在JVM层面分三步：</p>
<ol>
<li>分配内存空间</li>
<li>初始化对象</li>
<li>将引用指向内存地址</li>
</ol>
<p><strong>没有volatile时可能发生的问题</strong>：</p>
<ol>
<li>线程A执行创建，JVM可能先执行步骤3（引用指向内存），但还未执行步骤2（初始化对象）</li>
<li>此时instance已不是null，但指向的是未初始化完成的半成品对象</li>
<li>线程B执行第一次检查，发现instance不是null，直接返回这个半成品对象</li>
<li>线程B使用这个对象时出错</li>
</ol>
<p><strong>volatile的关键作用</strong>：</p>
<ul>
<li><strong>禁止指令重排序</strong>：强制保证步骤2在步骤3之前执行</li>
<li><strong>保证可见性</strong>：线程A对instance的完整写入能立即被线程B看到</li>
</ul>
<hr/>
<h4 data-id="heading-5">2. 一次性状态发布</h4>
<p>当一个对象构造完成后，其状态不再改变，但需要被多个线程安全地访问。<code>volatile</code>提供了比<code>synchronized</code>更轻量级的发布方式。</p>
<p>java</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EventRouter</span> {
    <span class="hljs-comment">// 保存全局路由配置，启动后加载一次，之后只读。</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> Map&lt;<span class="hljs-type">String</span>, <span class="hljs-type">String</span>&gt; routeConfig;
    
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">void</span> <span class="hljs-title">init</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-comment">// 在单线程中完成所有复杂的、耗时的初始化</span>
        Map&lt;<span class="hljs-type">String</span>, <span class="hljs-type">String</span>&gt; config = <span class="hljs-built_in">heavyWeightInitialization</span>();
        <span class="hljs-comment">// 全部完成后，一次性volatile写入，对所有线程立即可见</span>
        <span class="hljs-keyword">this</span>.routeConfig = config; <span class="hljs-comment">// volatile写</span>
    }
    
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">String</span> <span class="hljs-title">getRoute</span><span class="hljs-params">(<span class="hljs-type">String</span> event)</span> </span>{
        <span class="hljs-comment">// 多线程并发读：volatile读，能立刻看到init线程写入的所有routeConfig内容</span>
        Map&lt;<span class="hljs-type">String</span>, <span class="hljs-type">String</span>&gt; config = <span class="hljs-keyword">this</span>.routeConfig; <span class="hljs-comment">// volatile读</span>
        <span class="hljs-keyword">return</span> config.<span class="hljs-built_in">get</span>(event);
    }
}
</code></pre>
<p><strong>最佳实践</strong>：配合<strong>不可变对象</strong>（如<code>Collections.unmodifiableMap</code>包装的Map）使用，效果最佳。因为发布后状态不可变，读线程无需同步。</p>
<h4 data-id="heading-6">3. 低成本读写锁（读多写少）</h4>
<p>在某些读远多于写、且写操作非常简单的场景，可以用<code>volatile</code>变量配合CAS（如<code>AtomicInteger</code>）模拟一个更轻量的读写锁。</p>
<p>java</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">LightweightCoordinator</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> <span class="hljs-built_in">int</span> epoch = <span class="hljs-number">0</span>; <span class="hljs-comment">// “纪元”版本号</span>
    <span class="hljs-keyword">private</span> final AtomicInteger writeLock = <span class="hljs-keyword">new</span> AtomicInteger(<span class="hljs-number">0</span>);
    
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">beginRead</span>()</span> {
        <span class="hljs-built_in">int</span> snapshotEpoch;
        <span class="hljs-keyword">do</span> {
            snapshotEpoch = epoch; <span class="hljs-comment">// volatile读，获取当前“稳定”版本</span>
            <span class="hljs-comment">// 检查是否有写操作正在进行（通过CAS状态判断，此处简化）</span>
        } <span class="hljs-keyword">while</span> (isWritingInProgress()); <span class="hljs-comment">// 如果正在写，则重试</span>
        <span class="hljs-comment">// 后续读操作基于snapshotEpoch进行</span>
    }
    
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">endRead</span>()</span> {
        <span class="hljs-comment">// 通常无需操作</span>
    }
    
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">beginWrite</span>()</span> {
        <span class="hljs-comment">// 通过CAS获取写锁</span>
        <span class="hljs-keyword">while</span> (!writeLock.compareAndSet(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>)) {
            <span class="hljs-comment">// 自旋或后退</span>
        }
        epoch++; <span class="hljs-comment">// volatile写，递增纪元，强制所有读线程在下一次读取时看到新数据</span>
        <span class="hljs-comment">// ... 执行写操作</span>
    }
    
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">endWrite</span>()</span> {
        writeLock.<span class="hljs-keyword">set</span>(<span class="hljs-number">0</span>); <span class="hljs-comment">// 释放写锁</span>
    }
}
</code></pre>
<p><strong>注意</strong>：这是一种高级模式，仅适用于写操作极快、读操作可以容忍短暂重试的场景。多数情况下，应直接使用<code>ReentrantReadWriteLock</code>或<code>StampedLock</code>。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Spring Boot3 中结合Redis实现分布式锁机制实现并发抢券]]></title>    <link>https://juejin.cn/post/7581870491763474484</link>    <guid>https://juejin.cn/post/7581870491763474484</guid>    <pubDate>2025-12-10T05:26:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581870491763474484" data-draft-id="7581870491763458100" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Spring Boot3 中结合Redis实现分布式锁机制实现并发抢券"/> <meta itemprop="keywords" content="后端,Java,程序员"/> <meta itemprop="datePublished" content="2025-12-10T05:26:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员西西"/> <meta itemprop="url" content="https://juejin.cn/user/326976944214804"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Spring Boot3 中结合Redis实现分布式锁机制实现并发抢券
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/326976944214804/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员西西
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T05:26:57.000Z" title="Wed Dec 10 2025 05:26:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>在当今互联网软件开发领域，随着业务规模的不断扩大和用户数量的急剧增长，高并发场景愈发常见。其中，抢券活动因其能够有效吸引用户参与、提升业务活跃度，成为众多互联网应用的热门功能。然而，在高并发环境下实现抢券逻辑，面临着诸多挑战，尤其是如何确保数据的一致性和避免超卖问题。Spring Boot3 作为一款强大的后端开发框架，结合 Redis 这一高性能的内存数据库，为我们提供了实现分布式锁机制的有效途径，从而保障抢券逻辑的正确执行。本文将深入探讨在 Spring Boot3 中如何利用 Redis 实现分布式锁机制来达成抢券逻辑，并全面解决抢券逻辑中可能出现的各类问题。</p>
<h2 data-id="heading-1">高并发抢券场景的挑战</h2>
<p>以常见的电商平台为例，在促销活动期间，平台发放的优惠券数量有限，而参与抢券的用户可能达到百万甚至千万级别。瞬间产生的高并发请求，对系统的稳定性和性能无疑是巨大的考验。传统的单体应用架构在这种高并发场景下往往力不从心，因为单体应用的资源和处理能力有限，难以应对海量的并发请求。此外，在分布式系统中，多个服务实例并行运行，如何确保它们对共享资源（如优惠券库存）的访问是安全且高效的，成为了亟待解决的问题。</p>
<p>在抢券场景中，最核心的问题便是超卖现象的出现。当多个用户同时请求抢券时，如果系统没有采取有效的并发控制措施，就可能出现多个用户同时查询到有券，都去进行扣减，导致库存出现负数的情况。这不仅会给企业带来经济损失，还会严重影响用户体验，损害企业的声誉。因此，实现一个可靠的分布式锁机制，成为解决高并发抢券问题的关键所在。</p>
<h2 data-id="heading-2">Redis 分布式锁基础</h2>
<p><strong>（一）Redis 简介</strong></p>
<p>Redis 是一个开源的、基于内存的数据结构存储系统，它支持多种数据结构，如字符串（string）、哈希（hash）、列表（list）、集合（set）和有序集合（sorted set）等。Redis 以其高性能、低延迟和丰富的数据结构操作命令，成为了分布式系统中缓存、消息队列、分布式锁等功能的首选技术之一。在分布式锁场景中，Redis 主要利用其原子操作和内存存储的特性，实现高效的锁机制。</p>
<p><strong>（二）基于 Redis 实现分布式锁的基本原理</strong></p>
<p>Redis 分布式锁的基本原理是利用 Redis 的原子操作来实现锁的获取和释放。具体来说，当一个客户端尝试获取锁时，它会向 Redis 发送一个 SET 命令，利用 SET 命令的 NX（即 “不存在则设置”）参数，只有当锁对应的键不存在时，SET 操作才会成功，从而表示该客户端成功获取到了锁。同时，为了避免锁一直被持有而导致死锁，我们还会为锁设置一个过期时间，通过 SET 命令的 EX（即 “过期时间”）参数来指定。例如，以下是使用 Jedis（一个常用的 Redis Java 客户端）实现获取锁的代码示例：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title">tryGetLock</span><span class="hljs-params">(Jedis jedis, <span class="hljs-type">String</span> lockKey, <span class="hljs-type">String</span> uniqueValue, <span class="hljs-type">int</span> expireTime)</span> </span>{
    <span class="hljs-type">String</span> result = jedis.<span class="hljs-built_in">set</span>(lockKey, uniqueValue, <span class="hljs-string">"NX"</span>, <span class="hljs-string">"EX"</span>, expireTime);
    <span class="hljs-keyword">return</span> <span class="hljs-string">"OK"</span>.<span class="hljs-built_in">equals</span>(result);
}
</code></pre>
<p>在上述代码中，lockKey 是锁的唯一标识，uniqueValue 是每个请求的唯一值（比如可以用 UUID 生成），用于防止误删锁，expireTime 是锁的过期时间，单位为秒。当一个客户端成功执行 SET 操作返回 “OK” 时，说明它成功获取到了锁；否则，表示获取锁失败。</p>
<p>当客户端完成业务逻辑后，需要释放锁。释放锁的过程则是通过 DEL 命令删除 Redis 中对应的锁键。不过，在释放锁时，需要注意确保只有锁的持有者才能释放锁，否则可能会出现误释放其他线程锁的情况。为了解决这个问题，我们可以在释放锁时，先判断锁对应的值是否与当前客户端持有的唯一值相同，相同时才执行 DEL 操作。这一操作可以通过 Lua 脚本在 Redis 中实现原子性执行，示例代码如下：</p>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-keyword">if</span> redis.<span class="hljs-keyword">call</span>(<span class="hljs-comment">'GET', KEYS[1]) == ARGV[1] then</span>
    <span class="hljs-keyword">return</span> redis.<span class="hljs-keyword">call</span>(<span class="hljs-comment">'DEL', KEYS[1])</span>
<span class="hljs-keyword">else</span>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>
<span class="hljs-keyword">end</span>
</code></pre>
<p>在 Java 中调用该 Lua 脚本释放锁的代码如下：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">releaseLock</span>(<span class="hljs-params">Jedis jedis, <span class="hljs-built_in">String</span> lockKey, <span class="hljs-built_in">String</span> uniqueValue</span>) {
    <span class="hljs-title class_">String</span> script = <span class="hljs-string">"if redis.call('GET', KEYS[1]) == ARGV[1] then return redis.call('DEL', KEYS[1]) else return 0 end"</span>;
    jedis.<span class="hljs-built_in">eval</span>(script, <span class="hljs-title class_">Collections</span>.<span class="hljs-title function_">singletonList</span>(lockKey), <span class="hljs-title class_">Collections</span>.<span class="hljs-title function_">singletonList</span>(uniqueValue));
}
</code></pre>
<p>通过上述方式，我们实现了一个基本的 Redis 分布式锁，能够在一定程度上满足高并发场景下对共享资源的并发控制需求。</p>
<h2 data-id="heading-3">Spring Boot3 中集成 Redis 实现分布式锁</h2>
<p><strong>（一）引入 Redis 依赖</strong></p>
<p>在 Spring Boot3 项目中，首先需要在 pom.xml 文件中引入 Redis 相关依赖。如果使用 Spring Data Redis 来操作 Redis，可添加如下依赖：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p>此外，如果使用 Jedis 作为 Redis 客户端，还需添加 Jedis 依赖：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>redis.clients<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jedis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p><strong>（二）配置 Redis 连接</strong></p>
<p>在引入依赖后，需要在 application.properties 或 application.yml 文件中配置 Redis 服务器的连接信息。以 application.yml 为例，配置如下：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">redis:</span>
    <span class="hljs-attr">host:</span> <span class="hljs-string">your-redis-host</span>
    <span class="hljs-attr">port:</span> <span class="hljs-number">6379</span>
    <span class="hljs-attr">password:</span> <span class="hljs-string">your-redis-password</span>
</code></pre>
<p>这里的 your-redis-host 需要替换为实际的 Redis 服务器地址，your-redis-password 替换为实际的密码（如果有设置）。</p>
<p><strong>（三）编写获取锁和释放锁的代码</strong></p>
<p>在 Spring Boot3 项目中，我们可以将获取锁和释放锁的逻辑封装成工具类。以下是一个使用 RedisTemplate（Spring Data Redis 提供的操作 Redis 的核心类）实现获取锁和释放锁的示例：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.data.redis.core.RedisTemplate;
<span class="hljs-keyword">import</span> org.springframework.data.redis.core.script.DefaultRedisScript;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Component;
<span class="hljs-keyword">import</span> java.util.Collections;
<span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;

<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisLockUtil</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">LOCK_SUCCESS</span> <span class="hljs-operator">=</span> <span class="hljs-string">"OK"</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">SET_IF_NOT_EXIST</span> <span class="hljs-operator">=</span> <span class="hljs-string">"NX"</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">SET_WITH_EXPIRE_TIME</span> <span class="hljs-operator">=</span> <span class="hljs-string">"EX"</span>;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> RedisTemplate&lt;String, String&gt; redisTemplate;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">RedisLockUtil</span><span class="hljs-params">(RedisTemplate&lt;String, String&gt; redisTemplate)</span> {
        <span class="hljs-built_in">this</span>.redisTemplate = redisTemplate;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryGetLock</span><span class="hljs-params">(String lockKey, String uniqueValue, <span class="hljs-type">long</span> expireTime, TimeUnit timeUnit)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> redisTemplate.execute((RedisCallback&lt;String&gt;) connection -&gt; {
            <span class="hljs-type">JedisCommands</span> <span class="hljs-variable">commands</span> <span class="hljs-operator">=</span> (JedisCommands) connection.getNativeConnection();
            <span class="hljs-keyword">return</span> commands.set(lockKey, uniqueValue, SET_IF_NOT_EXIST, SET_WITH_EXPIRE_TIME, timeUnit.toSeconds(expireTime));
        });
        <span class="hljs-keyword">return</span> LOCK_SUCCESS.equals(result);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">releaseLock</span><span class="hljs-params">(String lockKey, String uniqueValue)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">script</span> <span class="hljs-operator">=</span> <span class="hljs-string">"if redis.call('GET', KEYS[1]) == ARGV[1] then return redis.call('DEL', KEYS[1]) else return 0 end"</span>;
        redisTemplate.execute(<span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultRedisScript</span>&lt;&gt;(script, Long.class), Collections.singletonList(lockKey), Collections.singletonList(uniqueValue));
    }
}
</code></pre>
<p>在上述代码中，tryGetLock 方法尝试获取锁，通过 RedisTemplate 的 execute 方法执行原生的 Jedis 命令，利用 SET 命令结合 NX 和 EX 参数来实现锁的获取。releaseLock 方法则通过执行 Lua 脚本，确保只有锁的持有者才能成功释放锁。</p>
<p><strong>（四）在抢券业务中应用分布式锁</strong></p>
<p>在抢券业务逻辑中，我们可以使用上述封装的 RedisLockUtil 来实现分布式锁。假设我们有一个抢券的 Controller 方法，示例代码如下：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">beans</span>.<span class="hljs-property">factory</span>.<span class="hljs-property">annotation</span>.<span class="hljs-property">Autowired</span>;
<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">web</span>.<span class="hljs-property">bind</span>.<span class="hljs-property">annotation</span>.<span class="hljs-property">GetMapping</span>;
<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">web</span>.<span class="hljs-property">bind</span>.<span class="hljs-property">annotation</span>.<span class="hljs-property">PathVariable</span>;
<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">web</span>.<span class="hljs-property">bind</span>.<span class="hljs-property">annotation</span>.<span class="hljs-property">RestController</span>;

<span class="hljs-keyword">import</span> java.<span class="hljs-property">util</span>.<span class="hljs-property">UUID</span>;

<span class="hljs-meta">@RestController</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CouponController</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">RedisLockUtil</span> redisLockUtil;

    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/coupon/seckill/{couponId}"</span>)
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">seckillCoupon</span>(<span class="hljs-params"><span class="hljs-meta">@PathVariable</span> <span class="hljs-built_in">String</span> couponId</span>) {
        <span class="hljs-title class_">String</span> lockKey = <span class="hljs-string">"coupon:lock:"</span> + couponId;
        <span class="hljs-title class_">String</span> uniqueValue = <span class="hljs-variable constant_">UUID</span>.<span class="hljs-title function_">randomUUID</span>().<span class="hljs-title function_">toString</span>();
        <span class="hljs-built_in">boolean</span> success = redisLockUtil.<span class="hljs-title function_">tryGetLock</span>(lockKey, uniqueValue, <span class="hljs-number">10</span>, <span class="hljs-title class_">TimeUnit</span>.<span class="hljs-property">SECONDS</span>);
        <span class="hljs-keyword">if</span> (success) {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">// 执行抢券业务逻辑，例如检查库存、扣减库存等</span>
                <span class="hljs-built_in">boolean</span> hasCoupon = <span class="hljs-title function_">checkCouponStock</span>(couponId);
                <span class="hljs-keyword">if</span> (hasCoupon) {
                    <span class="hljs-title function_">reduceCouponStock</span>(couponId);
                    <span class="hljs-keyword">return</span> <span class="hljs-string">"抢券成功"</span>;
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-keyword">return</span> <span class="hljs-string">"优惠券已抢完"</span>;
                }
            } <span class="hljs-keyword">finally</span> {
                redisLockUtil.<span class="hljs-title function_">releaseLock</span>(lockKey, uniqueValue);
            }
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-string">"抢券失败，请稍后重试"</span>;
        }
    }

    <span class="hljs-keyword">private</span> <span class="hljs-built_in">boolean</span> <span class="hljs-title function_">checkCouponStock</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> couponId</span>) {
        <span class="hljs-comment">// 这里实现检查优惠券库存的逻辑，例如从数据库或缓存中查询</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }

    <span class="hljs-keyword">private</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">reduceCouponStock</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> couponId</span>) {
        <span class="hljs-comment">// 这里实现扣减优惠券库存的逻辑，例如更新数据库或缓存中的库存数量</span>
    }
}
</code></pre>
<p>在上述代码中，当用户发起抢券请求时，首先生成一个唯一的 uniqueValue，然后尝试通过 RedisLockUtil 获取锁。如果获取锁成功，则执行抢券业务逻辑，包括检查库存和扣减库存；在业务逻辑执行完毕后，无论是否成功抢到券，都通过 RedisLockUtil 释放锁。如果获取锁失败，则直接返回抢券失败提示。</p>
<h2 data-id="heading-4">解决抢券逻辑中可能存在的问题</h2>
<p><strong>（一）性能瓶颈问题</strong></p>
<p>在高并发场景下，大量请求争抢锁可能会导致性能瓶颈。当多个线程同时尝试获取锁时，只有一个线程能够成功，其他线程需要等待。随着并发量的增加，等待锁的线程数量也会增多，这将导致系统的响应时间变长，吞吐量下降。</p>
<p>为了解决性能瓶颈问题，可以采取以下几种策略：</p>
<ol>
<li><strong>减少锁的持有时间</strong>：尽量优化抢券业务逻辑，减少在持有锁期间执行的操作，尽快释放锁，以便其他线程能够更快地获取锁。例如，可以将一些非关键的操作放到获取锁之前或释放锁之后执行。</li>
<li><strong>采用分段锁</strong>：将不同的优惠券分配到不同的锁上，减少锁竞争。例如，可以按照优惠券的类型、面额等维度进行分段，每个分段使用一个独立的锁。这样，不同分段的优惠券抢券请求可以并行处理，提高系统的并发处理能力。</li>
<li><strong>使用缓存预热</strong>：在抢券活动开始前，提前将优惠券库存等相关数据加载到缓存中，减少在抢券过程中对数据库的访问，从而提高系统的响应速度。同时，也可以减少因数据库访问压力过大导致的性能问题。</li>
</ol>
<p><strong>（二）锁过期时间设置不合理问题</strong></p>
<p>锁过期时间设置不合理可能会导致两种情况：一是锁过期时间过长，会导致其他线程长时间等待，降低系统的并发性能；二是锁过期时间过短，可能会出现业务逻辑尚未执行完毕，锁就已经过期，从而导致并发问题，如超卖现象。</p>
<p>为了合理设置锁过期时间，可以通过以下方法：</p>
<ol>
<li><strong>压测确定合适时间</strong>：在正式上线抢券功能之前，通过压测工具模拟高并发场景，测试不同锁过期时间下系统的性能和稳定性，从而确定一个既能满足业务需求，又能保证系统性能的锁过期时间。</li>
<li><strong>动态调整过期时间</strong>：根据实际业务情况，动态调整锁的过期时间。例如，可以根据优惠券的数量、预计参与抢券的用户数量等因素，实时计算并设置合理的锁过期时间。</li>
<li><strong>锁续期机制</strong>：为了防止业务逻辑执行时间超过锁过期时间，可以引入锁续期机制。当持有锁的线程发现锁快要过期时，自动延长锁的过期时间。在 Redisson（一个功能强大的 Redis Java 客户端）中，就提供了锁看门狗机制来实现锁续期。默认情况下，Redisson 的锁看门狗超时为 30 秒，它会在锁持有者处于活动状态时自动延长锁的过期时间。</li>
</ol>
<p><strong>（三）缓存击穿问题</strong></p>
<p>缓存击穿是指当热点 Key 在 Redis 中过期时，大量请求会同时穿透到数据库，导致数据库负载瞬间增大，甚至可能导致数据库崩溃。在抢券场景中，如果某个热门优惠券的库存信息在 Redis 中过期，而此时有大量用户同时请求抢该优惠券，就会出现缓存击穿问题。</p>
<p>为了解决缓存击穿问题，可以采取以下措施：</p>
<ol>
<li><strong>使用互斥锁</strong>：在缓存失效时，通过互斥锁（如 Redis 分布式锁）来保证只有一个线程能够从数据库加载数据并更新缓存，其他线程等待。当第一个线程更新完缓存后，其他线程再从缓存中获取数据，从而避免大量请求同时穿透到数据库。</li>
<li><strong>热点数据永不过期</strong>：对于一些热点数据，如热门优惠券的库存信息，可以设置为永不过期。同时，通过定时任务或其他机制，在后台定期更新这些热点数据，保证数据的一致性。</li>
<li><strong>缓存预热</strong>：在抢券活动开始前，提前将热点优惠券的库存信息加载到 Redis 缓存中，并设置合理的过期时间，避免在活动开始时出现缓存击穿问题。</li>
</ol>
<p><strong>（四）缓存雪崩问题</strong></p>
<p>缓存雪崩是指当缓存中大量 Key 同时失效，或缓存服务器宕机，导致大量请求直接访问数据库，造成数据库负载激增，甚至可能导致数据库崩溃。在抢券场景中，如果大量优惠券的库存信息在 Redis 中设置了相同的过期时间，当这些 Key 同时过期时，就会出现缓存雪崩问题。</p>
<p>为了防止缓存雪崩问题，可以采取以下策略：</p>
<ol>
<li><strong>设置不同的过期时间</strong>：在将优惠券库存信息存入 Redis 时，为每个 Key 设置不同的过期时间，避免大量 Key 同时过期。可以通过在过期时间上添加一个随机值来实现，例如，原本设置过期时间为 60 秒，可以改为设置为 60 + 随机值（0 - 10）秒。</li>
<li><strong>使用多级缓存</strong>：采用多级缓存架构，如在 Redis 之前再添加一层本地缓存（如 Caffeine）。当 Redis 中的缓存失效时，请求可以先从本地缓存中获取数据，如果本地缓存中也没有数据，再去访问 Redis 或数据库。这样可以在一定程度上缓解 Redis 缓存失效对数据库造成的压力。</li>
<li><strong>缓存预热和高可用备份</strong>：在抢券活动开始前，进行充分的缓存预热，确保大部分数据已经加载到缓存中。同时，搭建 Redis 集群，实现高可用备份，当某个 Redis 节点宕机时，其他节点能够继续提供服务，避免因缓存服务器宕机导致的缓存雪崩问题。</li>
</ol>
<p><strong>（五）缓存穿透问题</strong></p>
<p>缓存穿透是指恶意请求或者查询不存在的数据（即缓存和数据库中都没有的数据），导致大量请求直接访问数据库，对系统造成影响。在抢券场景中，如果有人恶意构造不存在的优惠券 ID 进行抢券请求，就可能出现缓存穿透问题。</p>
<p>为了解决缓存穿透问题，可以采取以下方法：</p>
<ol>
<li><strong>使用布隆过滤器</strong>：在系统中引入布隆过滤器，将所有有效的优惠券 ID 提前添加到布隆过滤器中。当有抢券请求时，先通过布隆过滤器判断优惠券 ID 是否有效。如果布隆过滤器判断该 ID 无效，则直接返回，不再访问数据库，从而避免大量无效请求穿透到数据库。</li>
<li><strong>缓存空对象</strong>：当查询数据库发现某个优惠券 ID 不存在时，将一个空对象缓存到 Redis 中，并设置一个较短的过期时间。这样，下次再有相同的请求时，可以直接从缓存中获取空对象，而不需要访问数据库。</li>
<li><strong>对请求参数进行校验</strong>：在接收到抢券请求时，对请求参数进行严格校验，确保优惠券 ID 等参数的合法性。对于非法的请求，直接返回错误提示，不进行后续处理，从而防止恶意请求对系统造成影响。</li>
</ol>
<h2 data-id="heading-5">总结</h2>
<p>通过在 Spring Boot3 项目中结合 Redis 实现分布式锁机制，我们能够有效地解决高并发抢券场景中的诸多问题，确保抢券逻辑的正确执行和数据的一致性。然而，在实际应用中，还需要根据具体的业务需求和系统架构，综合考虑各种因素，选择合适的技术方案和优化策略。</p>
<p>随着互联网技术的不断发展，高并发场景将越来越复杂，对系统性能和稳定性的要求也将越来越高。未来，我们可以进一步探索更高效、更可靠的分布式锁实现方式，如 Redlock 算法（Redis 官方提出的一种基于多节点的分布式锁算法），以及结合其他技术（如消息队列、分布式事务等）来优化抢券业务流程。同时，持续关注性能优化、容灾备份、安全防护等方面的技术发展，不断提升系统的整体性能和可靠性，为用户提供更加优质的服务体验。希望本文能够为广大互联网软件开发人员在实现高并发抢券逻辑时提供有益的参考和帮助。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[简说 Mybatis Dynamic SQL]]></title>    <link>https://juejin.cn/post/7581807793133715502</link>    <guid>https://juejin.cn/post/7581807793133715502</guid>    <pubDate>2025-12-10T05:30:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581807793133715502" data-draft-id="7581888578508029979" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="简说 Mybatis Dynamic SQL "/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-10T05:30:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SnrtIevg"/> <meta itemprop="url" content="https://juejin.cn/user/3087084381015342"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            简说 Mybatis Dynamic SQL 
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3087084381015342/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SnrtIevg
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T05:30:04.000Z" title="Wed Dec 10 2025 05:30:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Mybatis Dynamic SQL 介绍</h2>
<h3 data-id="heading-1">一、MyBatis Dynamic SQL 核心概述与设计哲学</h3>
<p><code>MyBatis Dynamic SQL</code> 是 MyBatis 官方团队在2016年底推出的一个子项目，旨在为 <code>MyBatis 3</code> 提供一种类型安全、纯<code>Java</code>代码的动态SQL构建方式，以彻底摆脱对XML映射文件的依赖。它<strong>并非一个独立的ORM框架</strong>，而是MyBatis的一个SQL构建器库。</p>
<p>其核心设计哲学是：</p>
<ul>
<li><strong>代码即SQL</strong>：将SQL语句的结构通过<code>Java</code>方法调用清晰地表达出来，使SQL逻辑成为编译时可检查的代码的一部分，而非运行时拼接的字符串。</li>
<li><strong>类型安全</strong>：利用<code>Java</code>泛型和强类型，确保表名、列名、条件值等在编译时就被检查，极大减少了因拼写错误或类型不匹配导致的运行时错误。</li>
<li><strong>流畅的API（Fluent API）</strong>：提供链式调用的API，让SQL构建过程读起来像自然语言，提升了代码的可读性和编写体验。</li>
<li><strong>与MyBatis核心无缝集成</strong>：它生成的最终对象（如SelectStatementProvider）可以直接被原生的MyBatis Mapper接口接收和执行，完美融入现有MyBatis生态。</li>
</ul>
<h3 data-id="heading-2">二、MyBatis Dynamic SQL 关键特性详解</h3>
<p><strong>声明式表与列对象</strong>：框架鼓励为每个数据库表生成对应的“支持类”（Support Class），其中包含表的元数据（如表名、列名）作为静态常量。这使得在编写SQL时可以直接引用这些常量，而非字符串，实现了编译时安全。</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 示例：引用生成的列常量</span>
SelectStatementProvider selectStatement = <span class="hljs-built_in">select</span>(id, animalName, bodyWeight, brainWeight)
                                            <span class="hljs-selector-class">.from</span>(animalData)
                                            <span class="hljs-selector-class">.where</span>(id, isEqualTo(<span class="hljs-number">1</span>))
                                            <span class="hljs-selector-class">.build</span>()
                                            <span class="hljs-selector-class">.render</span>(RenderingStrategies.MYBATIS3);
</code></pre>
<p><strong>强大的条件构建（Where Clauses）</strong>：提供了丰富的条件构建方法（如<code>isEqualTo</code>, <code>isGreaterThan</code>, <code>isLike</code>, <code>isIn</code>, <code>isBetween</code>等），并且可以通过<code>and()</code>和<code>or()</code>方法进行灵活的逻辑组合。这解决了传统MyBatis XML中需要手动处理AND/OR逻辑和括号的难题。</p>
<p><strong>全面的SQL语句支持</strong>：官方文档显示，它完整支持所有主要的SQL操作：</p>
<p><strong>查询（SELECT）</strong>：支持连接（JOIN）、子查询、聚合函数、分组（GROUP BY）、排序（ORDER BY）等复杂查询构建。
<strong>数据操作（INSERT, UPDATE, DELETE）</strong>：支持批量插入、根据条件更新和删除，API设计一致。
函数与表达式：支持在SQL中嵌入数据库函数和Case表达式，增强了灵活性。</p>
<p><strong>动态SQL的本质实现</strong>：其“动态”特性体现在，通过<code>Java</code>代码的逻辑判断（if-else、循环等）来决定是否添加某个查询条件或SQL片段。这比XML中的<code>&lt;if&gt;</code>、<code>&lt;choose&gt;</code>标签更为灵活，因为你可以利用完整的<code>Java</code>语言能力。</p>
<p><strong>工作原理</strong>：开发者通过流畅的API构建一个“模型”（<code>Model</code>），然后调用<code>build().render()</code>方法，该库会根据配置的渲染策略（<code>RenderingStrategies.MYBATIS3</code>）将模型转换为<code>MyBatis</code>可执行的Provider SQL语句和参数映射，完全避免了手动拼接SQL字符串和参数索引的麻烦。</p>
<h3 data-id="heading-3">三、与主流动态SQL方案的对比分析</h3>





































































<table><thead><tr><th>特性 / 方案</th><th>MyBatis Dynamic SQL (官方)</th><th>传统MyBatis XML动态SQL</th><th>MyBatis-Plus 条件构造器</th><th>Fluent MyBatis</th><th>JOOQ</th></tr></thead><tbody><tr><td>核心形态</td><td>纯Java代码，类型安全的SQL构建器库</td><td>XML标签 + OGNL表达式</td><td>Java Lambda条件构造器，是MyBatis的增强插件</td><td>基于代码生成的流式API框架</td><td>独立的、类型安全的SQL构建与执行框架</td></tr><tr><td>SQL编写体验</td><td>流畅API，编译时类型检查，IDE支持好（代码补全、导航）。但需手动构建完整SQL</td><td>在XML中写SQL和动态标签，直观但需在Java和XML间切换，类型不安全，易有拼写错误</td><td>单表操作极简，Lambda引用属性，防误写。但多表关联查询支持弱，复杂SQL仍需回退到XML</td><td>流式API，IDE支持极佳，字段和方法提示丰富。但已停止更新，存在社区风险</td><td>体验公认最佳，纯Java类型安全DSL，API设计极其优雅且强大。</td></tr><tr><td>动态SQL能力</td><td>通过Java逻辑实现动态，能力最强最灵活。</td><td>通过<code>&lt;if&gt;</code>, <code>&lt;choose&gt;</code>, <code>&lt;foreach&gt;</code>等标签实现，能力强大，但复杂逻辑可读性下降</td><td>主要针对WHERE条件动态拼接，能力集中于单表简单查询。</td><td>提供丰富的动态查询、更新、删除API，能力较强。</td><td>动态构建能力极强，是原生设计理念。</td></tr><tr><td>学习与迁移成本</td><td>需学习一套新API，但理念现代。从MyBatis迁移方便。</td><td>MyBatis开发者最熟悉，学习成本低，但最佳实践（如防注入）需注意</td><td>对MyBatis用户非常友好，入门简单，符合Java习惯。</td><td>需理解其代码生成和增强机制，有一定学习成本。</td><td>学习曲线较陡，但掌握后效率极高。需处理代码生成步骤。</td></tr><tr><td>性能与安全性</td><td>高安全性，参数均为预编译占位符，从根源杜绝SQL注入。性能与手写SQL无异。</td><td>高安全性，使用#{}预编译。性能良好，但复杂动态SQL的XML解析可能有极微开销。</td><td>高安全性，基于MyBatis。性能好。</td><td>高安全性，基于MyBatis。性能好。</td><td>高安全性，类型安全构建。性能优秀，接近手写JDBC。</td></tr><tr><td>主要优势</td><td>官方出品，类型安全，无XML，与MyBatis生态无缝融合，动态能力最灵活。</td><td>技术成熟，社区庞大，复杂SQL直观可见、便于统一管理和调优</td><td>极大地简化了单表CRUD，开发效率高，国内生态活跃。</td><td>在类型安全和流畅API上取得了很好平衡，开发体验好。</td><td>标准、强大、优雅，被认为是Java中SQL构建的“黄金标准”，支持多数据库方言。</td></tr><tr><td>主要劣势</td><td>手写代码量相对较多，尤其对于简单CRUD；需要额外的代码生成步骤来获得最佳体验</td><td>“XML地狱”，大量XML文件难维护；接口与XML映射易出错；重构不便</td><td>不是通用的动态SQL解决方案，复杂多表查询是其短板；对MyBatis原生功能有一定封装和侵入。</td><td>项目已停更，不适合用于新项目。</td><td>商业许可限制，对Oracle、SQL Server等商用数据库需付费；整体较重。</td></tr></tbody></table>
<p><strong>补充比较</strong>：Spring Data JPA
JPA（如Hibernate）及其扩展Spring Data JPA代表了另一种“对象优先”的范式。其优势在于极致简单的CRUD和标准化的Repository模式。然而，其动态复杂查询的构建非常笨拙（需要拼接JpaSpecificationExecutor或Criteria API），可读性和可维护性在复杂场景下急剧下降，常被戏称为“<strong>初期一时爽，动态SQL火葬场</strong>”。它适合领域驱动设计（DDD）和事务性操作密集的场景，但对于需要复杂、高性能查询的系统，其灵活性和可控性不如MyBatis系方案。</p>
<h3 data-id="heading-4">四、总结与选型建议</h3>
<p>MyBatis Dynamic SQL是MyBatis官方为拥抱“代码化配置”趋势、解决XML繁琐问题而推出的现代化、类型安全的解决方案。它特别适合：</p>
<ul>
<li>追求类型安全和编译时检查的团队。</li>
<li>厌恶XML配置，希望SQL逻辑全部由<code>Java</code>代码管理的项目。</li>
<li>需要构建极其复杂、动态的查询逻辑，且希望拥有完全控制权的场景。</li>
<li>现有MyBatis项目寻求架构升级，希望减少XML而保持技术栈稳定。</li>
</ul>
<p>选型决策树参考：</p>
<ul>
<li>如果项目以简单的单表CRUD为主，追求极致开发速度：MyBatis-Plus是最佳选择。</li>
<li>如果项目充满复杂的、多变的查询逻辑，且团队重视SQL可控性和性能：
<ul>
<li>接受XML：传统MyBatis XML动态SQL仍是久经考验的可靠选择。</li>
<li>拒绝XML，接受一定代码量：MyBatis Dynamic SQL是官方的未来方向。</li>
<li>预算充足，追求顶级开发体验和长期维护：JOOQ值得投资。</li>
</ul>
</li>
<li>如果项目采用严格的DDD架构，且复杂查询不多：Spring Data JPA可能更合适。</li>
<li>对于新启动的项目，应谨慎选择已停止维护的框架，如Fluent MyBatis。</li>
</ul>
<p>总而言之，MyBatis Dynamic SQL在MyBatis生态中填补了“类型安全”和“无XML”的空白，为开发者提供了一个介于传统XML与JOOQ式体验之间的强大选项。它的出现，反映了<code>Java</code>持久层技术向更安全、更现代、更符合开发者编码习惯的方向演进。</p>
<p>但是令人疑惑的是这个项目并没有流行起来， 令人可惜。</p>
<p>参考文档: <a href="https://link.juejin.cn?target=https%3A%2F%2Fmybatis.org%2Fmybatis-dynamic-sql%2Fdocs%2Fintroduction.html" target="_blank" title="https://mybatis.org/mybatis-dynamic-sql/docs/introduction.html" ref="nofollow noopener noreferrer">Mybatis-Dynaimc-SQL</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[vue里的ref和reactive的工作原理是什么？以及它们的区别是什么？为什么有人说reactive“废弃”了？]]></title>    <link>https://juejin.cn/post/7581769891499212819</link>    <guid>https://juejin.cn/post/7581769891499212819</guid>    <pubDate>2025-12-10T03:51:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581769891499212819" data-draft-id="7581752508780806187" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="vue里的ref和reactive的工作原理是什么？以及它们的区别是什么？为什么有人说reactive“废弃”了？"/> <meta itemprop="keywords" content="Vue.js"/> <meta itemprop="datePublished" content="2025-12-10T03:51:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户7700362205757"/> <meta itemprop="url" content="https://juejin.cn/user/1775053506361337"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            vue里的ref和reactive的工作原理是什么？以及它们的区别是什么？为什么有人说reactive“废弃”了？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1775053506361337/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户7700362205757
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T03:51:38.000Z" title="Wed Dec 10 2025 03:51:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>​
这是一个非常硬核且高质量的问题。要理解 Vue 3 的响应式系统，必须深入到源码层面。</p>
<p>首先，我需要纠正一个重要的误区：<strong>Vue 3 并没有“弃用” <code>reactive</code></strong> 。它仍然是 Vue 3 核心 API 的一部分。但是，确实存在一种趋势（包括 Vue 官方团队的建议），<strong>推荐优先使用 <code>ref</code></strong> 。</p>
<p>下面我将从源码级别（基于 Vue 3 <code>packages/reactivity</code> 模块）为你详细剖析两者的原理、区别，以及为什么现在大家更倾向于用 <code>ref</code>。</p>
<hr/>
<h3 data-id="heading-0">一、 <code>reactive</code> 的源码工作原理</h3>
<p><code>reactive</code> 的核心是利用了 ES6 的 <strong><code>Proxy</code></strong> 对象。它拦截对象的操作（增删改查），从而实现依赖收集和触发更新。</p>
<h4 data-id="heading-1">1. 核心流程 (<code>reactive.ts</code>)</h4>
<p>当你调用 <code>reactive(obj)</code> 时，Vue 内部实际上执行了 <code>createReactiveObject</code> 函数。</p>
<p><strong>简化版源码逻辑：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 存放代理对象的缓存，防止同一个对象被代理多次</span>
<span class="hljs-keyword">const</span> reactiveMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WeakMap</span>();

<span class="hljs-keyword">function</span> <span class="hljs-title function_">createReactiveObject</span>(<span class="hljs-params">target</span>) {
  <span class="hljs-comment">// 1. 如果不是对象（是基础类型），直接返回，无法代理</span>
  <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">isObject</span>(target)) {
    <span class="hljs-keyword">return</span> target;
  }

  <span class="hljs-comment">// 2. 检查缓存，如果已经代理过，直接返回缓存的 Proxy</span>
  <span class="hljs-keyword">if</span> (reactiveMap.<span class="hljs-title function_">has</span>(target)) {
    <span class="hljs-keyword">return</span> reactiveMap.<span class="hljs-title function_">get</span>(target);
  }

  <span class="hljs-comment">// 3. 创建 Proxy</span>
  <span class="hljs-keyword">const</span> proxy = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Proxy</span>(target, mutableHandlers);

  <span class="hljs-comment">// 4. 存入缓存</span>
  reactiveMap.<span class="hljs-title function_">set</span>(target, proxy);
  
  <span class="hljs-keyword">return</span> proxy;
}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h4 data-id="heading-2">2. 拦截器 (<code>baseHandlers.ts</code>)</h4>
<p>Proxy 的威力在于第二个参数 <code>mutableHandlers</code>。它定义了 <code>get</code>（读取）和 <code>set</code>（修改）的拦截行为。</p>
<ul>
<li><strong>get (依赖收集)</strong> ：当副作用函数（Effect，如 computed 或 render）读取属性时，触发 <code>track</code> 函数，将当前 Effect 记录下来。</li>
<li><strong>set (派发更新)</strong> ：当修改属性时，触发 <code>trigger</code> 函数，找到之前收集的 Effect 并执行它们。</li>
</ul>
<p><strong>简化版 Handler 逻辑：</strong></p>
<pre><code class="hljs language-scss" lang="scss">const mutableHandlers = {
  <span class="hljs-built_in">get</span>(target, key, receiver) {
    <span class="hljs-comment">// 1. 收集依赖</span>
    <span class="hljs-built_in">track</span>(target, key);
    
    <span class="hljs-comment">// 2. 获取原本的值</span>
    const res = Reflect<span class="hljs-selector-class">.get</span>(target, key, receiver);

    <span class="hljs-comment">// 3. 【深度响应关键点】如果获取到的 res 是对象，递归将其转为 reactive</span>
    <span class="hljs-comment">// 这与 Vue 2 不同，Vue 3 是懒代理（访问时才代理），性能更好</span>
    if (isObject(res)) {
      return <span class="hljs-built_in">reactive</span>(res); 
    }
    
    return res;
  },
  
  <span class="hljs-built_in">set</span>(target, key, value, receiver) {
    <span class="hljs-comment">// 1. 获取旧值</span>
    const oldValue = target<span class="hljs-selector-attr">[key]</span>;
    <span class="hljs-comment">// 2. 设置新值</span>
    const result = Reflect<span class="hljs-selector-class">.set</span>(target, key, value, receiver);
    
    <span class="hljs-comment">// 3. 如果值发生变化，触发更新</span>
    if (hasChanged(value, oldValue)) {
      <span class="hljs-built_in">trigger</span>(target, key);
    }
    
    return result;
  }
};
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-3">二、 <code>ref</code> 的源码工作原理</h3>
<p><code>ref</code> 的设计初衷是为了解决 <strong>基本数据类型（Primitives）</strong> 无法使用 <code>Proxy</code> 代理的问题（Proxy 只能代理对象）。</p>
<h4 data-id="heading-4">1. 核心流程 (<code>ref.ts</code>)</h4>
<p><code>ref</code> 本质上是一个 <strong>对象的包装器</strong>。它通过定义一个类 <code>RefImpl</code>，利用 ES6 的类属性访问器（getter/setter）来拦截 <code>.value</code> 的访问。</p>
<p><strong>简化版源码逻辑：</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin">function ref(value) {
  <span class="hljs-keyword">return</span> createRef(value);
}

function createRef(rawValue) {
  <span class="hljs-keyword">if</span> (isRef(rawValue)) <span class="hljs-keyword">return</span> rawValue;
  <span class="hljs-keyword">return</span> new RefImpl(rawValue);
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">RefImpl</span> {
  <span class="hljs-keyword">public</span> _value; <span class="hljs-comment">// 存储当前值</span>
  <span class="hljs-keyword">public</span> _rawValue; <span class="hljs-comment">// 存储原始值（用于比较）</span>
  <span class="hljs-keyword">public</span> dep; <span class="hljs-comment">// 依赖容器</span>
  <span class="hljs-keyword">public</span> __v_isRef = <span class="hljs-literal">true</span>; <span class="hljs-comment">// 标记这是一个 Ref</span>

  <span class="hljs-keyword">constructor</span>(value) {
    <span class="hljs-keyword">this</span>._rawValue = value;
    <span class="hljs-comment">// 核心差异点：如果传入的是对象，内部会自动调用 reactive()！</span>
    <span class="hljs-keyword">this</span>._value = isObject(value) ? reactive(value) : value;
  }

  <span class="hljs-keyword">get</span> value() {
    <span class="hljs-comment">// 1. 收集依赖</span>
    trackRefValue(<span class="hljs-keyword">this</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._value;
  }

  <span class="hljs-keyword">set</span> value(newVal) {
    <span class="hljs-comment">// 2. 检查值是否变化</span>
    <span class="hljs-keyword">if</span> (hasChanged(newVal, <span class="hljs-keyword">this</span>._rawValue)) {
      <span class="hljs-keyword">this</span>._rawValue = newVal;
      <span class="hljs-comment">// 如果新赋的值是对象，再次转为 reactive</span>
      <span class="hljs-keyword">this</span>._value = isObject(newVal) ? reactive(newVal) : newVal;
      <span class="hljs-comment">// 3. 触发更新</span>
      triggerRefValue(<span class="hljs-keyword">this</span>);
    }
  }
}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p><strong>重点总结</strong>：</p>
<ul>
<li>如果 <code>ref(10)</code>：利用 <code>RefImpl</code> 的 <code>get value</code> 和 <code>set value</code> 进行拦截。</li>
<li>如果 <code>ref({ count: 1 })</code>：<code>RefImpl</code> 会将内部的 <code>value</code> 变成 <code>reactive({ count: 1 })</code> 的 Proxy 对象。</li>
</ul>
<hr/>
<h3 data-id="heading-5">三、 Ref 与 Reactive 的关键区别</h3>



































<table><thead><tr><th>特性</th><th>Ref</th><th>Reactive</th></tr></thead><tbody><tr><td><strong>数据类型</strong></td><td>支持所有类型（基本类型 + 对象）。</td><td><strong>仅支持对象</strong>（Array, Object, Map, Set）。</td></tr><tr><td><strong>底层原理</strong></td><td><code>RefImpl</code> 类（getter/setter）。如果是对象，内部转调 <code>reactive</code>。</td><td>直接使用 <code>Proxy</code>。</td></tr><tr><td><strong>访问方式</strong></td><td>必须通过 <strong><code>.value</code></strong> 访问（模板中自动解包除外）。</td><td>直接访问属性。</td></tr><tr><td><strong>重新赋值</strong></td><td><code>myRef.value = {}</code> 依然保持响应式。</td><td><code>let state = reactive({}); state = {}</code> <strong>会丢失响应性</strong>。</td></tr><tr><td><strong>结构解构</strong></td><td>解构会丢失响应性（需用 <code>toRefs</code>）。</td><td>解构会丢失响应性（需用 <code>toRefs</code>）。</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-6">四、 为什么说 Vue 3 “想弃用” reactive（实际上是推荐 ref）？</h3>
<p>这是一个由 <strong>“开发者体验（DX）”</strong> 驱动的趋势。虽然 <code>reactive</code> 并没有被官方删除，但社区和尤雨溪（Evan You）都倾向于 <strong>“Ref 一把梭”</strong> ，主要原因如下：</p>
<h4 data-id="heading-7">1. <code>reactive</code> 的局限性会导致 Bug</h4>
<p>Vue 新手最常遇到的坑就是 <code>reactive</code> 丢失响应性：</p>
<ul>
<li>
<p><strong>赋值替换问题</strong>：</p>
<pre><code class="hljs language-ini" lang="ini">let <span class="hljs-attr">list</span> = reactive([])<span class="hljs-comment">;</span>
// 错误！这样赋值会切断 Proxy 的连接，页面不会更新
<span class="hljs-attr">list</span> = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>]<span class="hljs-comment">; </span>

// 正确写法（很麻烦）
list.push(...<span class="hljs-section">[1, 2, 3]</span>)<span class="hljs-comment">;</span>
// 或者再包一层
const <span class="hljs-attr">state</span> = reactive({ list: [] })<span class="hljs-comment">;</span>
<span class="hljs-attr">state.list</span> = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>]<span class="hljs-comment">;</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>而 <code>ref</code> 没有这个问题：<code>list.value = [1, 2, 3]</code> 总是安全的。</p>
</li>
<li>
<p><strong>解构丢失问题</strong>：</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">state</span> = reactive({ count: <span class="hljs-number">0</span> })<span class="hljs-comment">;</span>
let { count } = state<span class="hljs-comment">; // count 变成了普通数字，不再是响应式的</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
</li>
</ul>
<h4 data-id="heading-8">2. 类型不一致带来的心智负担</h4>
<p>在一个组件中，如果混用两者：</p>
<ul>
<li>有些变量直接读（reactive）。</li>
<li>有些变量要加 <code>.value</code>（ref）。</li>
<li>有些对象是通过 <code>props</code> 传进来的，你不知道它是普通对象还是 Proxy。</li>
</ul>
<p><strong>使用 <code>ref</code> 可以统一心智模型</strong>：</p>
<ul>
<li>在 JS 代码中，<strong>凡是响应式数据，都要带 <code>.value</code></strong> 。这种显式调用虽然写起来多几个字符，但让代码更清晰，更容易区分哪些是普通变量，哪些是响应式变量。</li>
</ul>
<h4 data-id="heading-9">3. 官方的态度</h4>
<p>尤雨溪曾在社区讨论中表示，如果 Vue 3 重新设计，也许会只保留 <code>ref</code>。虽然 <code>reactive</code> 为了 API 的完整性被保留了，但在实际业务开发中，<strong>全量使用 <code>ref</code></strong> 是目前最推荐的最佳实践。</p>
<h3 data-id="heading-10">总结</h3>
<ul>
<li><strong>Reactive</strong>: 基于 <code>Proxy</code>，只对对象有效，存在解构和重新赋值丢失响应性的风险。</li>
<li><strong>Ref</strong>: 基于 <code>class</code> 的 getter/setter，统一了基本类型和对象的处理（对象内部调用 reactive）。</li>
<li><strong>结论</strong>: 建议在项目中优先使用 <strong><code>ref</code></strong> 。它更加稳健，不易出错，且能够清晰地标识出“这是一个响应式数据”。</li>
</ul>
<p>​</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[详细说说vue2何vue3的工作原理以及区别？为什么vue3会做此升级？]]></title>    <link>https://juejin.cn/post/7581789701531729962</link>    <guid>https://juejin.cn/post/7581789701531729962</guid>    <pubDate>2025-12-10T03:46:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581789701531729962" data-draft-id="7579169543232684032" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="详细说说vue2何vue3的工作原理以及区别？为什么vue3会做此升级？"/> <meta itemprop="keywords" content="Vue.js"/> <meta itemprop="datePublished" content="2025-12-10T03:46:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户7700362205757"/> <meta itemprop="url" content="https://juejin.cn/user/1775053506361337"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            详细说说vue2何vue3的工作原理以及区别？为什么vue3会做此升级？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1775053506361337/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户7700362205757
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T03:46:19.000Z" title="Wed Dec 10 2025 03:46:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    13
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>​这是一个非常有分量的架构级问题。要讲清楚 Vue 2 到 Vue 3 的演进，我们需要从底层的响应式原理、虚拟 DOM (Virtual DOM) 的编译策略以及运行时性能三个维度深入剖析。</p>
<p>以下是从源码和架构设计层面的详细解读：</p>
<hr/>
<h3 data-id="heading-0">一、 什么是虚拟 DOM (Virtual DOM)？</h3>
<p>在理解 Vue 原理之前，必须先理解虚拟 DOM。</p>
<p><strong>1. 定义：</strong><br/>
虚拟 DOM 本质上是一个 <strong>JavaScript 对象（VNode）</strong> ，它是真实 DOM 的“蓝图”或“替身”。</p>
<p><strong>2. 为什么需要它？</strong></p>
<ul>
<li><strong>操作真实 DOM 代价高昂</strong>：真实 DOM 节点非常重（包含大量属性和事件）。频繁操作 DOM 会导致浏览器频繁重排（Reflow）和重绘（Repaint），性能极差。</li>
<li><strong>JS 计算很快</strong>：在 JS 层面通过对比两个对象（新旧 VNode）的差异（Diff），计算出最小的更变操作，然后再去更新真实 DOM，效率最高。</li>
</ul>
<p><strong>3. 结构示例：</strong></p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 真实 DOM: &lt;div class="box"&gt;Hello&lt;/div&gt;</span>
<span class="hljs-comment">// 虚拟 DOM (VNode):</span>
<span class="hljs-type">const</span> vnode = {
  tag: <span class="hljs-string">'div'</span>,
  props: { <span class="hljs-keyword">class</span>: <span class="hljs-string">'box'</span> },
  children: <span class="hljs-string">'Hello'</span>,
  <span class="hljs-comment">// Vue3 新增了 patchFlag 等编译优化标记</span>
}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-1">二、 Vue 2 的工作原理</h3>
<p>Vue 2 的核心是 <strong>Options API</strong> 和基于 <strong><code>Object.defineProperty</code></strong> 的响应式系统。</p>
<h4 data-id="heading-2">1. 响应式原理 (Reactivity)</h4>
<p>Vue 2 在初始化（<code>initState</code>）时，会递归遍历 <code>data</code> 中的所有属性。</p>
<ul>
<li>
<p><strong>核心 API</strong>：<code>Object.defineProperty</code></p>
</li>
<li>
<p><strong>源码逻辑</strong>：</p>
<ul>
<li><strong>Observer（观察者）</strong> ：递归把对象属性转为 getter/setter。</li>
<li><strong>Dep（依赖容器）</strong> ：每个属性闭包里都有一个 <code>Dep</code> 实例，用来存放到到底谁用了我。</li>
<li><strong>Watcher（订阅者）</strong> ：组件渲染函数、computed、watch 都是 Watcher。</li>
</ul>
</li>
</ul>
<pre><code class="hljs language-ini" lang="ini">// Vue 2 响应式简化版
Object.defineProperty(obj, key, {
  get() {
    // 1. 依赖收集：如果当前有正在计算的 Watcher，就把它收集进 Dep
    if (Dep.target) dep.depend()<span class="hljs-comment">;</span>
    return value<span class="hljs-comment">;</span>
  },
  set(newVal) {
    if (<span class="hljs-attr">newVal</span> === value) return<span class="hljs-comment">;</span>
    <span class="hljs-attr">value</span> = newVal<span class="hljs-comment">;</span>
    // 2. 派发更新：通知 Dep 里所有的 Watcher 去 update
    dep.notify()<span class="hljs-comment">;</span>
  }
})<span class="hljs-comment">;</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h4 data-id="heading-3">2. Vue 2 的痛点</h4>
<ol>
<li><strong>初始化慢</strong>：因为是<strong>递归</strong>遍历，如果 <code>data</code> 对象很大，启动（Init）阶段会非常耗时，且内存占用高。</li>
<li><strong>动态性不足</strong>：无法监听对象属性的新增（add）和删除（delete），必须用 <code>$set</code> / <code>$delete</code>。</li>
<li><strong>数组限制</strong>：无法拦截数组索引修改（<code>arr[0] = 1</code>），Vue 2 重写了数组的 7 个变异方法（push, pop...）来实现响应式。</li>
</ol>
<h4 data-id="heading-4">3. 虚拟 DOM 与 Diff (Vue 2)</h4>
<p>Vue 2 的 Diff 算法是 <strong>全量对比</strong>。<br/>
当数据变化时，Vue 2 会重新生成整个组件的 VNode 树，然后和旧的 VNode 树进行对比（双端比较算法）。即使有些节点及其子节点永远不会变（静态节点），Vue 2 依然会去比对它们。</p>
<hr/>
<h3 data-id="heading-5">三、 Vue 3 的工作原理</h3>
<p>Vue 3 在响应式系统和编译优化上做了彻底的重构。</p>
<h4 data-id="heading-6">1. 响应式原理 (Reactivity)</h4>
<p>Vue 3 使用 <strong>Proxy</strong> 替代了 <code>defineProperty</code>。代码位于 <code>packages/reactivity</code>。</p>
<ul>
<li>
<p><strong>核心 API</strong>：<code>Proxy</code> + <code>Reflect</code></p>
</li>
<li>
<p><strong>源码逻辑</strong>：</p>
<ul>
<li>不再需要 <code>Observer</code> 类，直接返回一个 Proxy 代理。</li>
<li><strong>Track（依赖收集）</strong> ：当读取属性时触发 <code>track(target, key)</code>，将副作用函数（Effect）存入全局的 <code>WeakMap</code>。</li>
<li><strong>Trigger（派发更新）</strong> ：当修改属性时触发 <code>trigger(target, key)</code>，从 <code>WeakMap</code> 取出 Effect 执行。</li>
</ul>
</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Vue 3 响应式简化版</span>
<span class="hljs-keyword">new</span> <span class="hljs-title class_">Proxy</span>(target, {
  <span class="hljs-title function_">get</span>(<span class="hljs-params">target, key, receiver</span>) {
    <span class="hljs-title function_">track</span>(target, key); <span class="hljs-comment">// 收集依赖</span>
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">get</span>(target, key, receiver);
  },
  <span class="hljs-title function_">set</span>(<span class="hljs-params">target, key, value, receiver</span>) {
    <span class="hljs-keyword">const</span> res = <span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">set</span>(target, key, value, receiver);
    <span class="hljs-title function_">trigger</span>(target, key); <span class="hljs-comment">// 触发更新</span>
    <span class="hljs-keyword">return</span> res;
  }
})
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<ul>
<li>
<p><strong>优势</strong>：</p>
<ul>
<li><strong>懒代理（Lazy）</strong> ：只有访问到深层对象时，才会将其转为 Proxy，初始化飞快。</li>
<li><strong>全能拦截</strong>：支持新增、删除属性，支持数组索引修改，支持 Map/Set。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-7">2. 编译优化 (Compiler Optimization) —— 核心升级</h4>
<p>Vue 3 的 Diff 算法不仅仅是快，而是**“更聪明”** 。它在<strong>编译阶段（Template -&gt; Render Function）</strong> 做了大量标记，让<strong>运行时（Runtime）</strong> 跑得更快。</p>
<ul>
<li>
<p><strong>PatchFlags (动态标记)</strong> ：<br/>
在编译时，Vue 3 会分析模板，给动态节点打上“二进制标记”。<br/>
比如：<code>&lt;div :class="cls"&gt;123&lt;/div&gt;</code>。<br/>
Vue 3 知道只有 <code>class</code> 是动态的，Diff 时<strong>只对比 <code>class</code></strong> ，完全忽略内容。</p>
</li>
<li>
<p><strong>Block Tree (区块树)</strong> ：<br/>
Vue 3 将模板切分成 Block，配合 PatchFlags，Diff 时<strong>直接跳过静态节点</strong>，只遍历动态节点数组。</p>
<ul>
<li>Vue 2 Diff 复杂度 = 模板总体积</li>
<li>Vue 3 Diff 复杂度 = 动态节点的数量</li>
</ul>
</li>
<li>
<p><strong>Hoist Static (静态提升)</strong> ：<br/>
静态的节点（如 <code>&lt;p&gt;永远不变&lt;/p&gt;</code>）在内存中只创建一次，后续更新直接复用，不再重复创建 VNode。</p>
</li>
</ul>
<hr/>
<h3 data-id="heading-8">四、 Vue 2 和 Vue 3 的比较与区别</h3>


















































<table><thead><tr><th>特性</th><th><strong>Vue 2</strong></th><th><strong>Vue 3</strong></th></tr></thead><tbody><tr><td><strong>响应式底层</strong></td><td><code>Object.defineProperty</code></td><td><code>Proxy</code></td></tr><tr><td><strong>检测能力</strong></td><td>无法检测属性增删、数组索引修改</td><td><strong>完全支持</strong></td></tr><tr><td><strong>初始化性能</strong></td><td><strong>递归</strong>遍历所有属性（慢、内存高）</td><td><strong>懒代理</strong>，访问时才转换（快）</td></tr><tr><td><strong>代码组织</strong></td><td><strong>Options API</strong> (data, methods 分离)</td><td><strong>Composition API</strong> (逻辑关注点聚合)</td></tr><tr><td><strong>Diff 算法</strong></td><td>全量双端比较，静态节点也要比</td><td><strong>静态标记 + Block Tree</strong>，只比动态节点</td></tr><tr><td><strong>TypeScript</strong></td><td>支持较弱，类型推断困难</td><td><strong>核心由 TS 编写</strong>，TS 支持极其友好</td></tr><tr><td><strong>体积</strong></td><td>较大，难以 Tree-shaking</td><td>模块化拆分，支持 <strong>Tree-shaking</strong>，体积更小</td></tr><tr><td><strong>Fragment</strong></td><td>组件只能有一个根节点</td><td>支持多根节点 (Fragment)</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-9">五、 为什么 Vue 3 要做这些升级？</h3>
<p>尤雨溪和团队进行 Vue 3 重构主要为了解决 Vue 2 的三个核心瓶颈：</p>
<h4 data-id="heading-10">1. 性能瓶颈 (Performance)</h4>
<p>Vue 2 的响应式初始化是递归的，对于大数据量的表格或列表，启动非常慢。且 Diff 算法在大型复杂组件中，无谓的静态节点对比消耗了大量 CPU。<br/>
<strong>Vue 3 通过 Proxy 和编译优化（静态标记），实现了“按需响应”和“靶向更新”，性能大幅提升。</strong></p>
<h4 data-id="heading-11">2. 代码组织与复用瓶颈 (Scalability)</h4>
<p>在 Vue 2 的 Options API 中，一个功能的逻辑被拆分到 <code>data</code>, <code>methods</code>, <code>watch</code> 里。当组件变得巨大（几千行代码）时，维护代码需要在文件里上下反复横跳（Jumping）。且 <code>Mixin</code> 代码复用存在命名冲突和来源不清晰的问题。<br/>
<strong>Vue 3 引入 Composition API (组合式 API)</strong> ，允许开发者按“逻辑功能”组织代码，完美解决了大型项目的维护难题，Hooks 更是取代了 Mixin。</p>
<h4 data-id="heading-12">3. TypeScript 支持 (Developer Experience)</h4>
<p>Vue 2 的源码是 JS 写的，通过 Flow 做类型检查，对 TS 的支持是后期补丁（<code>this</code> 指向在 TS 中很难推断）。随着前端工程化对 TS 需求的爆发，Vue 2 显得力不从心。<br/>
<strong>Vue 3 使用 TypeScript 重写</strong>，提供了原生的、极佳的类型推断体验。</p>
<h3 data-id="heading-13">总结</h3>
<ul>
<li><strong>原理层面</strong>：Vue 2 是劫持 setter/getter，Vue 3 是代理整个对象。</li>
<li><strong>更新机制</strong>：Vue 2 是全量树对比，Vue 3 是基于静态标记的动态节点追踪。</li>
<li><strong>目的</strong>：Vue 3 的升级是为了<strong>更快（性能）、更小（体积）、更易维护（组合式 API）以及更好的 TS 支持</strong>。</li>
</ul>
<p>​</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JavaScript 内存机制与闭包解析]]></title>    <link>https://juejin.cn/post/7581828086019702799</link>    <guid>https://juejin.cn/post/7581828086019702799</guid>    <pubDate>2025-12-10T04:22:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581828086019702799" data-draft-id="7581844141668237352" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JavaScript 内存机制与闭包解析"/> <meta itemprop="keywords" content="JavaScript"/> <meta itemprop="datePublished" content="2025-12-10T04:22:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="冻梨政哥"/> <meta itemprop="url" content="https://juejin.cn/user/2373184444182659"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JavaScript 内存机制与闭包解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2373184444182659/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    冻梨政哥
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T04:22:43.000Z" title="Wed Dec 10 2025 04:22:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">JavaScript 内存机制与闭包解析</h2>
<p>JavaScript 作为一门动态弱类型语言，其内存管理机制和闭包特性是理解 JS 运行原理的核心。本文将结合具体代码示例，深入解析 JS 的内存机制以及闭包的工作原理。</p>
<h3 data-id="heading-1">一、JavaScript 内存空间划分</h3>
<p>JavaScript 的内存空间主要分为三大类：</p>
<ol>
<li><strong>代码空间</strong>：用于存储执行的代码</li>
<li><strong>栈内存</strong>：主要存储简单数据类型和引用类型的地址</li>
<li><strong>堆内存</strong>：主要存储复杂数据类型（对象等）</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/43bc3bb3a2fa4113b38cda4dd809054b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya75qKo5pS_5ZOl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765945363&amp;x-signature=GVf4kfg9L%2BPoAIEESnAycUnHzHU%3D" alt="2bad8a6ec6a17f7a384612ea3e0cbdcd.png" loading="lazy"/>
栈内存的特点是操作<strong>速度快、大小固定、存储连续，适合存储体积小</strong>的数据；而堆内存<strong>空间大，可存储大型复杂</strong>对象，但分配和回收内存相对耗时。</p>
<h3 data-id="heading-2">二、数据类型的内存存储</h3>
<h4 data-id="heading-3">1. 简单数据类型的存储</h4>
<p>简单数据类型（如数字、字符串、布尔值等）直接存储在栈内存中，赋值时会进行值拷贝：</p>
<pre><code class="hljs language-ini" lang="ini">// 调用栈在栈内存中
// 体积小
function foo() {
    var <span class="hljs-attr">a</span> = <span class="hljs-number">1</span><span class="hljs-comment">; // 赋值，直接存储在栈内存</span>
    var <span class="hljs-attr">b</span> = a<span class="hljs-comment">; // 拷贝，在栈内存中创建新值</span>
    <span class="hljs-attr">a</span> = <span class="hljs-number">2</span><span class="hljs-comment">;</span>
    console.log(a)<span class="hljs-comment">; // 2</span>
    console.log(b)<span class="hljs-comment">; // 1</span>
}
foo()<span class="hljs-comment">;</span>
</code></pre>
<p>上述代码中，<code>a</code>和<code>b</code>是相互独立的变量，修改<code>a</code>的值不会影响<code>b</code>，因为它们在栈内存中占据不同的空间。</p>
<h4 data-id="heading-4">2. 复杂数据类型的存储</h4>
<p>复杂数据类型（如对象）在栈内存中存储的是指向堆内存的地址，赋值时进行的是引用拷贝：</p>
<pre><code class="hljs language-css" lang="css">function foo() {
    <span class="hljs-selector-tag">var</span> <span class="hljs-selector-tag">a</span> = {name:<span class="hljs-string">"极客时间"</span>}; // 栈内存存储地址，堆内存存储对象
    <span class="hljs-selector-tag">var</span> <span class="hljs-selector-tag">b</span> = <span class="hljs-selector-tag">a</span>; // 引用式拷贝，<span class="hljs-selector-tag">b</span>与<span class="hljs-selector-tag">a</span>指向堆中同一个对象
    <span class="hljs-selector-tag">a</span><span class="hljs-selector-class">.name</span> = "极客邦";
    console<span class="hljs-selector-class">.log</span>(<span class="hljs-selector-tag">a</span>); // {name: <span class="hljs-string">"极客邦"</span>}
    console<span class="hljs-selector-class">.log</span>(<span class="hljs-selector-tag">b</span>); // {name: <span class="hljs-string">"极客邦"</span>}
}
foo();
</code></pre>
<p>这里<code>a</code>和<code>b</code>在栈内存中存储的是同一个地址，指向堆内存中的同一个对象，因此修改<code>a</code>的属性会影响<code>b</code>。</p>
<h3 data-id="heading-5">三、JavaScript 的动态弱类型特性</h3>
<p>JS 作为动态弱类型语言，变量的类型可以在运行过程中动态改变，不需要预先声明类型：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// JS 是动态弱类型语言</span>
<span class="hljs-keyword">var</span> bar; 
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-keyword">typeof</span> bar); <span class="hljs-comment">// undefined</span>
bar = <span class="hljs-number">12</span>; <span class="hljs-comment">// 变为number类型</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-keyword">typeof</span> bar); <span class="hljs-comment">// number</span>
bar = <span class="hljs-string">'极客时间'</span>; <span class="hljs-comment">// 变为string类型</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-keyword">typeof</span> bar); <span class="hljs-comment">// string</span>
bar = <span class="hljs-literal">true</span>; <span class="hljs-comment">// 变为boolean类型</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-keyword">typeof</span> bar); <span class="hljs-comment">// boolean</span>
bar = <span class="hljs-literal">null</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-keyword">typeof</span> bar);  <span class="hljs-comment">// Object (JS设计的bug)</span>
bar = {<span class="hljs-attr">name</span>:<span class="hljs-string">'极客时间'</span>}  <span class="hljs-comment">// 变为Object类型</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-keyword">typeof</span> bar); <span class="hljs-comment">// Object</span>
</code></pre>
<h3 data-id="heading-6">四、执行上下文与调用栈</h3>
<p>JavaScript 引擎通过调用栈来管理执行上下文，每个函数执行时都会创建一个执行上下文，包含：</p>
<ul>
<li>变量环境</li>
<li>词法环境</li>
<li>outer（词法作用域链）</li>
<li>this</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d628b31baa9f404794e21cbae0b31564~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya75qKo5pS_5ZOl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765945363&amp;x-signature=gkmEdLnklEdWV75SPHcfRVrVH8k%3D" alt="lQLPJw1WF0yif-fNAhTNBHawwsioxubOAzAJEmTtM6BTAA_1142_532.png" loading="lazy"/>
执行上下文的切换通过调整调用栈的栈顶指针来实现，这也是栈内存需要高效操作的原因。</p>
<h3 data-id="heading-7">五、闭包的内存机制</h3>
<p>闭包是指内部函数可以访问外部函数作用域中变量的特性，其实现依赖于特殊的内存管理机制。</p>
<h4 data-id="heading-8">闭包示例解析</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">foo</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">var</span> myName = <span class="hljs-string">"极客时间"</span>
    <span class="hljs-keyword">let</span> test1 = <span class="hljs-number">1</span>
    <span class="hljs-keyword">const</span> test2 = <span class="hljs-number">2</span>
    <span class="hljs-keyword">var</span> innerBar = { 
        <span class="hljs-attr">setName</span>:<span class="hljs-keyword">function</span>(<span class="hljs-params">newName</span>){
            myName = newName
        },
        <span class="hljs-attr">getName</span>:<span class="hljs-keyword">function</span>(<span class="hljs-params"/>){
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(test1)
            <span class="hljs-keyword">return</span> myName
        }
    }
    <span class="hljs-keyword">return</span> innerBar
}
<span class="hljs-keyword">var</span> bar = <span class="hljs-title function_">foo</span>()
bar.<span class="hljs-title function_">setName</span>(<span class="hljs-string">"极客邦"</span>)
bar.<span class="hljs-title function_">getName</span>() <span class="hljs-comment">// 输出1</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(bar.<span class="hljs-title function_">getName</span>()) <span class="hljs-comment">// 输出1和"极客邦"</span>
</code></pre>
<h4 data-id="heading-9">闭包的内存工作原理</h4>
<ol>
<li><strong>编译阶段</strong>：JS 引擎编译<code>foo</code>函数时，会扫描内部函数（<code>setName</code>和<code>getName</code>）</li>
<li><strong>识别闭包</strong>：发现内部函数引用了外部函数的变量（<code>myName</code>和<code>test1</code>），判断形成闭包</li>
<li><strong>创建闭包对象</strong>：在堆内存中创建一个<code>closure(foo)</code>对象，用于保存被内部函数引用的外部变量</li>
<li><strong>维持引用</strong>：当<code>foo</code>函数执行完毕后，虽然其执行上下文出栈，但由于<code>bar</code>仍引用着内部函数，而内部函数又引用着<code>closure(foo)</code>，所以这些变量不会被回收</li>
<li><strong>访问变量</strong>：内部函数通过引用<code>closure(foo)</code>来访问外部函数的变量</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/09533f21e0344f518906acf66473d02d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya75qKo5pS_5ZOl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765945363&amp;x-signature=GfZMfMW%2FR%2FdDLzIvsBU4%2FC%2BqP4I%3D" alt="lQLPKGXzE8qWf4fNAjTNBHawul-TTHmpmmMJEm9r57TIAA_1142_564.png" loading="lazy"/></p>
<h3 data-id="heading-10">六、内存管理的特点</h3>
<ul>
<li>JavaScript 不需要手动管理内存（不同于 C/C++ 需要使用<code>malloc</code>和<code>free</code>）</li>
<li>栈内存的回收通过调整栈指针实现，效率高</li>
<li>堆内存的回收通过垃圾回收机制实现，当对象没有任何引用时会被回收</li>
<li>闭包会延长变量的生命周期，可能导致内存占用增加，需要合理使用</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JavaScript 内存机制深度解析：从执行上下文到闭包的内存视角]]></title>    <link>https://juejin.cn/post/7581786379804114979</link>    <guid>https://juejin.cn/post/7581786379804114979</guid>    <pubDate>2025-12-10T04:21:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581786379804114979" data-draft-id="7581844141668302888" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JavaScript 内存机制深度解析：从执行上下文到闭包的内存视角"/> <meta itemprop="keywords" content="前端,JavaScript,操作系统"/> <meta itemprop="datePublished" content="2025-12-10T04:21:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="wwwwW"/> <meta itemprop="url" content="https://juejin.cn/user/631558156323657"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JavaScript 内存机制深度解析：从执行上下文到闭包的内存视角
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/631558156323657/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    wwwwW
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T04:21:22.000Z" title="Wed Dec 10 2025 04:21:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">JavaScript 内存机制深度解析：从执行上下文到闭包的内存视角</h2>
<p>JavaScript 作为一门广泛应用于 Web 开发的动态弱类型语言，其运行机制与内存管理方式对开发者理解程序行为、优化性能以及避免内存泄漏至关重要。本文将从 JavaScript 的执行机制出发，深入剖析其内存模型——包括栈内存与堆内存的分工协作，并结合闭包这一核心特性，揭示 JavaScript 引擎（如 V8）如何高效管理内存。</p>
<hr/>
<h3 data-id="heading-1">一、JavaScript 是什么语言？</h3>
<p>JavaScript 是一门<strong>动态弱类型语言</strong>。所谓“动态”，意味着变量的数据类型在运行时才确定，无需在声明时指定；而“弱类型”则表示不同类型之间可以自动转换（例如 <code>"5" + 3</code> 得到 <code>"53"</code>）。这与 C/C++ 等静态强类型语言形成鲜明对比。</p>
<p>更重要的是，JavaScript <strong>不需要开发者直接操作内存</strong>。在 C/C++ 中，程序员需手动调用 <code>malloc</code> 分配内存、<code>free</code> 释放内存；而在 JavaScript 中，内存的分配与回收完全由引擎自动管理，开发者只需关注逻辑本身。</p>
<hr/>
<h3 data-id="heading-2">二、JavaScript 的八种数据类型与内存分类</h3>
<p>ECMAScript 标准定义了八种数据类型：</p>
<ul>
<li><strong>七种原始类型（简单数据类型）</strong> ：<code>undefined</code>、<code>null</code>、<code>boolean</code>、<code>number</code>、<code>bigint</code>、<code>string</code>、<code>symbol</code></li>
<li><strong>一种引用类型（复杂数据类型）</strong> ：<code>Object</code>（包括数组、函数、日期等）</li>
</ul>
<p>这些类型在内存中的存储方式截然不同：</p>
<ul>
<li><strong>简单数据类型</strong>：存储在<strong>栈内存</strong>中，值直接保存，访问速度快。</li>
<li><strong>复杂数据类型</strong>：实际对象存储在<strong>堆内存</strong>中，栈中仅保存指向堆中对象的<strong>引用地址</strong>（指针）。</li>
</ul>
<p>为何要这样设计？关键在于<strong>效率与灵活性的平衡</strong>。</p>
<hr/>
<h3 data-id="heading-3">三、内存空间的划分：代码空间、栈内存与堆内存</h3>
<p>当 JavaScript 代码从硬盘加载到内存中执行时，会涉及三种主要内存区域：</p>
<h4 data-id="heading-4">1. 代码空间</h4>
<p>存放编译后的字节码或机器码，供引擎执行。</p>
<h4 data-id="heading-5">2. 栈内存（Stack）</h4>
<ul>
<li>用于维护<strong>调用栈（Call Stack）</strong> ，是 JavaScript 执行机制的核心。</li>
<li>特点：<strong>连续、固定大小、分配/释放极快</strong>。</li>
<li>存放内容：<strong>执行上下文（Execution Context）</strong> ，包括变量环境（Variable Environment）、词法环境（Lexical Environment）、<code>this</code> 绑定等。</li>
<li>由于函数调用频繁，上下文切换必须高效。若将大对象也放入栈中，会导致栈帧过大、不连续，严重影响性能。</li>
</ul>
<h4 data-id="heading-6">3. 堆内存（Heap）</h4>
<ul>
<li>用于存储<strong>动态分配的对象</strong>，如对象、数组、函数等。</li>
<li>特点：<strong>空间大、不连续、分配和回收较慢</strong>。</li>
<li>引擎通过垃圾回收机制（如标记-清除算法）自动回收不再被引用的对象。</li>
</ul>
<blockquote>
<p><strong>关键设计思想</strong>：栈负责“轻量级、快速切换”的上下文状态，堆负责“重量级、长期存在”的数据存储。二者协同，既保证执行效率，又支持复杂数据结构。</p>
</blockquote>
<hr/>
<h3 data-id="heading-7">四、执行上下文与作用域链</h3>
<p>每当 JavaScript 执行一段代码（全局代码或函数），引擎会创建一个<strong>执行上下文</strong>，包含：</p>
<ul>
<li><strong>变量环境</strong>：存放 <code>var</code> 声明的变量（函数提升阶段初始化）。</li>
<li><strong>词法环境</strong>：存放 <code>let</code>、<code>const</code> 及函数参数，具有块级作用域。</li>
<li><strong>outer 引用</strong>：指向外层词法环境，构成<strong>词法作用域链</strong>。</li>
<li><strong>this 绑定</strong>：根据调用方式确定。</li>
</ul>
<p>作用域链使得内部函数可以访问外部函数的变量，这是<strong>闭包</strong>的基础。</p>
<hr/>
<h3 data-id="heading-8">五、闭包的内存机制：为什么能“记住”外部变量？</h3>
<p>闭包（Closure）是指<strong>内部函数引用了外部函数的变量，且该内部函数在外部函数执行完毕后仍可被调用</strong>的现象。从内存角度看，闭包的实现依赖于堆内存的特殊处理。</p>
<h4 data-id="heading-9">闭包的执行流程（以 V8 引擎为例）：</h4>
<ol>
<li><strong>编译阶段</strong>：当解析到函数 <code>foo</code> 时，引擎进行词法扫描，发现其内部定义了 <code>getName</code> 和 <code>setName</code> 函数。</li>
<li><strong>变量捕获检测</strong>：引擎检查这些内部函数是否引用了 <code>foo</code> 中的变量（如 <code>myName</code>）。若有，则判定存在闭包。</li>
<li><strong>创建 Closure 对象</strong>：在<strong>堆内存</strong>中为 <code>foo</code> 创建一个特殊的 <code>closure(foo)</code> 对象，用于保存被内部函数引用的<strong>自由变量</strong>（如 <code>myName</code>）。</li>
<li><strong>绑定引用</strong>：<code>getName</code> 和 <code>setName</code> 的词法环境中，<code>outer</code> 指向这个堆中的 <code>closure(foo)</code>，而非原本的栈帧。</li>
<li><strong>函数返回后</strong>：即使 <code>foo</code> 的执行上下文从调用栈弹出（栈内存回收），<code>closure(foo)</code> 仍因被内部函数引用而保留在堆中，直到所有引用消失才被垃圾回收。</li>
</ol>
<blockquote>
<p><strong>关键点</strong>：闭包的本质是<strong>将本应随栈帧销毁的变量，提升到堆中持久化存储</strong>。这打破了“函数执行完即释放局部变量”的常规，但也带来了内存占用增加的风险。</p>
</blockquote>
<hr/>
<h3 data-id="heading-10">六、为什么简单类型放栈、复杂类型放堆？</h3>
<p>这个问题的答案源于计算机体系结构与程序执行效率的权衡：</p>
<ul>
<li><strong>栈的优势</strong>：连续内存、指针偏移即可切换上下文，速度极快。但容量有限，不适合存储大对象。</li>
<li><strong>堆的必要性</strong>：对象大小不确定、生命周期长，需动态分配。虽然管理开销大，但空间几乎无限。</li>
</ul>
<p>若将对象也放入栈中：</p>
<ul>
<li>函数调用时栈帧会变得巨大；</li>
<li>上下文切换成本剧增；</li>
<li>递归或深层调用极易导致栈溢出。</li>
</ul>
<p>因此，JavaScript 引擎采用“<strong>栈存引用，堆存实体</strong>”的策略，既保持执行效率，又支持灵活的数据结构。</p>
<hr/>
<h3 data-id="heading-11">七、内存回收机制</h3>
<ul>
<li>
<p><strong>栈内存</strong>：随函数执行结束自动释放（通过栈顶指针回退）。</p>
</li>
<li>
<p><strong>堆内存</strong>：依赖<strong>垃圾回收器（GC）</strong> 。V8 使用分代式垃圾回收：</p>
<ul>
<li>新生代（小对象，频繁回收）</li>
<li>老生代（长期存活对象，较少回收）</li>
</ul>
</li>
</ul>
<p>当一个对象<strong>没有任何变量或闭包引用它</strong>时，GC 会将其标记为可回收，并在合适时机释放内存。</p>
<blockquote>
<p><strong>注意</strong>：闭包若持有大量数据且未及时解除引用，会导致<strong>内存泄漏</strong>。例如，DOM 事件处理器中使用闭包引用外部大对象，而未在组件卸载时移除监听器。</p>
</blockquote>
<hr/>
<h3 data-id="heading-12">结语</h3>
<p>JavaScript 的内存机制是其高效运行的基石。通过栈与堆的合理分工，引擎在保证执行速度的同时，支持复杂的编程范式如闭包。理解这一机制，不仅能帮助我们写出更高效的代码，还能有效规避内存泄漏等常见问题。作为开发者，虽无需手动管理内存，但“知其所以然”方能游刃有余于现代前端工程的复杂场景之中。</p>
<blockquote>
<p>正如一句老话：“你不需要成为汽车工程师才能开车，但了解引擎原理能让你开得更好。” —— 对 JavaScript 内存机制的理解，正是如此。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[原型-1: 理解 JavaScript 中的 原型]]></title>    <link>https://juejin.cn/post/7581765536373178377</link>    <guid>https://juejin.cn/post/7581765536373178377</guid>    <pubDate>2025-12-10T05:14:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581765536373178377" data-draft-id="7581772744376188974" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="原型-1: 理解 JavaScript 中的 原型"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-12-10T05:14:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="之恒君"/> <meta itemprop="url" content="https://juejin.cn/user/2261046026312318"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            原型-1: 理解 JavaScript 中的 原型
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2261046026312318/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    之恒君
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T05:14:23.000Z" title="Wed Dec 10 2025 05:14:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{position:relative;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:30px;margin-bottom:5px}.markdown-body h2{font-size:24px;display:inline-block;font-weight:700;background:#ef7060;color:#fff;padding:6px 8px 0 0;border-top-right-radius:6px;margin-right:2px;box-shadow:6px 3px 0 0 rgba(239,112,96,.2)}.markdown-body h2:before{content:" ";display:inline-block;width:8px}.markdown-body h2:after{content:" ";position:absolute;display:block;width:calc(100% - 50px);border-bottom:3px solid #ef7060}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #3e3e3e;margin-top:32px;margin-bottom:32px;height:1px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(27,31,35,.05);color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:JetBranins Mono,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px;background-color:#fdfdfd}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#fdfdfd}.markdown-body a{text-decoration:none;font-weight:700;color:#ef7060;border-bottom:1px solid #ef7060}.markdown-body a:active,.markdown-body a:hover{color:#ef2d26}.markdown-body table tr td,.markdown-body table tr th{border:1px solid #ccc;padding:5px 10px}.markdown-body table{display:block!important;width:auto;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{background:#f0f0f0;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#f8f8f8}.markdown-body blockquote{margin-inline-start:0;margin-inline-end:0;border-left:3px solid #ef7060;background:#fff9f9;padding:1px 20px;margin-top:20px}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atelier-heath-light">.hljs-comment,.hljs-quote{color:#776977}.hljs-attribute,.hljs-link,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ca402b}.hljs-built_in,.hljs-builtin-name,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#a65926}.hljs-bullet,.hljs-string,.hljs-symbol{color:#918b3b}.hljs-section,.hljs-title{color:#516aec}.hljs-keyword,.hljs-selector-tag{color:#7b59c0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#f7f3f7;color:#695d69}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>要理解 JavaScript 中的「原型」，首先要跳出其他面向对象语言（如 Java、C#）的「类」思维——JS 是通过 <strong>原型（Prototype）</strong> 实现继承和属性共享的，核心是「对象基于原型关联，而非类的实例化」。</p>
<h3 data-id="heading-0">一、先搞懂：为什么需要原型？</h3>
<p>原型的本质是 <strong>“资源复用工具”</strong> 。它解决了一个核心问题：<strong>避免重复创建相同属性/方法，节省内存</strong>。</p>
<p>举个例子：如果创建 100 个「人」对象，每个对象都需要 <code>sayHello</code> 方法。如果直接在每个对象里定义 <code>sayHello</code>，会生成 100 个完全相同的函数，造成内存浪费。</p>
<p>而原型的思路是：<strong>把</strong> <code>sayHello</code> <strong>放在一个“公共模板”（原型对象）里，所有「人」对象都“关联”这个模板，需要时直接从模板里拿方法</strong>——这样只需要 1 个 <code>sayHello</code> 函数，实现资源复用。</p>
<h3 data-id="heading-1">二、核心概念：3 个关键角色</h3>
<p>理解原型，必须先分清 3 个紧密关联的概念：<strong>原型对象（Prototype）</strong> 、<code>prototype</code> <strong>属性</strong>、<code>__proto__</code> <strong>属性</strong>（或 <code>Object.getPrototypeOf()</code> 方法）。</p>

























<table><thead><tr><th>概念</th><th>作用</th><th>归属</th></tr></thead><tbody><tr><td>原型对象（Prototype）</td><td>存储公共属性/方法的“模板对象”，被其他对象共享</td><td>每个对象都有一个原型对象（除了 <code>Object.prototype</code>）</td></tr><tr><td><code>prototype</code> 属性</td><td><strong>函数特有</strong>，指向该函数创建的「实例对象」的原型对象</td><td>函数（如构造函数、普通函数）</td></tr><tr><td><code>__proto__</code> 属性</td><td><strong>对象特有</strong>，指向该对象的原型对象（非标准，但浏览器普遍支持）</td><td>所有对象（除了 <code>null</code>）</td></tr></tbody></table>
<h3 data-id="heading-2">三、直观理解：原型链的“关联关系”</h3>
<p>所有对象的原型会形成一条「原型链」：对象 → 它的原型对象 → 原型的原型对象 → ... → 最终指向 <code>Object.prototype</code>（原型链的顶端），<code>Object.prototype</code> 的原型是 <code>null</code>（没有更上层的原型）。</p>
<p>我们通过一个具体例子，拆解原型链的关联逻辑：</p>
<h4 data-id="heading-3">1. 用构造函数创建对象（经典场景）</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 1. 定义一个构造函数（首字母大写，约定用于创建对象）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Person</span>(<span class="hljs-params">name</span>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name; <span class="hljs-comment">// 实例属性：每个 Person 实例都有独立的 name</span>
}

<span class="hljs-comment">// 2. 在构造函数的 prototype 上定义“公共方法”</span>
<span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">sayHello</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Hello, I'm <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span>`</span>);
};

<span class="hljs-comment">// 3. 用 new 关键字创建 Person 实例</span>
<span class="hljs-keyword">const</span> zhangsan = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">'张三'</span>);
</code></pre>
<h4 data-id="heading-4">2. 拆解原型关联（关键！）</h4>
<p>上面代码中，<code>zhangsan</code>、<code>Person</code>、<code>Person.prototype</code> 三者的原型关系如下：</p>
<ul>
<li><code>zhangsan</code> <strong>（实例对象）的原型</strong>：<code>zhangsan.__proto__ === Person.prototype</code>（或 <code>Object.getPrototypeOf(zhangsan) === Person.prototype</code>）<br/>
→ 实例的原型，指向构造函数的 <code>prototype</code> 属性。</li>
<li><code>Person.prototype</code> <strong>（原型对象）的原型</strong>：<code>Person.prototype.__proto__ === Object.prototype</code><br/>
→ 所有自定义原型对象，最终都关联到 <code>Object.prototype</code>（JS 内置的顶层原型）。</li>
<li><code>Object.prototype</code> <strong>的原型</strong>：<code>Object.prototype.__proto__ === null</code><br/>
→ 原型链的终点，没有更上层的原型。</li>
<li><code>Person</code> <strong>（构造函数）的原型</strong>：<code>Person.__proto__ === Function.prototype</code><br/>
→ 函数也是对象，所有函数的原型都指向 <code>Function.prototype</code>（<code>Function.prototype.__proto__</code> 最终也指向 <code>Object.prototype</code>）。</li>
</ul>
<h4 data-id="heading-5">3. 原型链的作用：属性查找规则</h4>
<p>当你访问一个对象的属性（如 <code>zhangsan.sayHello</code>）时，JS 会按以下规则查找：</p>
<ol>
<li>先在对象自身查找：如果 <code>zhangsan</code> 自己有 <code>sayHello</code> 方法，直接使用；</li>
<li>自身没有，就去「对象的原型对象」查找：即 <code>Person.prototype</code>，找到 <code>sayHello</code>，使用；</li>
<li>原型对象没有，就去「原型的原型」查找：即 <code>Object.prototype</code>；</li>
<li>一直查到 <code>null</code> 还没找到，就返回 <code>undefined</code>（不会报错）。</li>
</ol>
<p>比如：<code>zhangsan.toString()</code>（<code>toString</code> 是 <code>Object.prototype</code> 的方法，<code>zhangsan</code> 自身没有，但能通过原型链找到）。</p>
<h3 data-id="heading-6">四、原型的核心特性</h3>
<h4 data-id="heading-7">1. 共享性：原型上的属性/方法被所有实例共享</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> lisi = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">'李四'</span>);
zhangsan.<span class="hljs-title function_">sayHello</span>(); <span class="hljs-comment">// Hello, I'm 张三</span>
lisi.<span class="hljs-title function_">sayHello</span>();     <span class="hljs-comment">// Hello, I'm 李四</span>
<span class="hljs-comment">// 两个实例调用的是同一个 sayHello 方法（来自 Person.prototype）</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(zhangsan.<span class="hljs-property">sayHello</span> === lisi.<span class="hljs-property">sayHello</span>); <span class="hljs-comment">// true</span>
</code></pre>
<h4 data-id="heading-8">2. 动态性：原型的修改会影响所有已创建的实例</h4>
<p>即使实例已经创建，修改原型对象的属性/方法，实例也能立即访问到新的内容：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 给 Person.prototype 新增一个方法</span>
<span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">eat</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span> is eating`</span>);
};

<span class="hljs-comment">// 已创建的 zhangsan 能直接调用新方法</span>
zhangsan.<span class="hljs-title function_">eat</span>(); <span class="hljs-comment">// 张三 is eating</span>
</code></pre>
<h4 data-id="heading-9">3. 实例可“覆盖”原型属性（不修改原型本身）</h4>
<p>如果实例自身定义了和原型同名的属性/方法，会优先使用实例自身的（原型链查找时会先找到自身属性，停止向上查找）：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 给 zhangsan 自身定义 sayHello 方法</span>
zhangsan.<span class="hljs-property">sayHello</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Hi, I'm <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span>`</span>);
};

zhangsan.<span class="hljs-title function_">sayHello</span>(); <span class="hljs-comment">// Hi, I'm 张三（用自身的方法）</span>
lisi.<span class="hljs-title function_">sayHello</span>();     <span class="hljs-comment">// Hello, I'm 李四（用原型的方法，不受影响）</span>
</code></pre>
<h3 data-id="heading-10">五、常见误区澄清</h3>
<ol>
<li><strong>“原型是类”？错！</strong><br/>
JS 直到 ES6 才引入 <code>class</code> 语法，但 <code>class</code> 只是「原型的语法糖」——本质还是基于原型实现继承，并非像 Java 那样的“类”。</li>
<li><code>prototype</code> <strong>和</strong> <code>__proto__</code> <strong>分不清？</strong></li>
</ol>
<ul>
<li>
<ul>
<li>记住：<code>prototype</code> 是<strong>函数的属性</strong>，指向实例的原型；<code>__proto__</code> 是<strong>对象的属性</strong>，指向自己的原型。</li>
<li>简单公式：<code>实例.__proto__ === 构造函数.prototype</code>。</li>
</ul>
</li>
</ul>
<ol start="3">
<li><strong>“所有对象都有</strong> <code>__proto__</code> <strong>”？错！</strong><br/>
<code>null</code> 没有 <code>__proto__</code>（<code>Object.getPrototypeOf(null)</code> 会返回 <code>null</code>），它是原型链的终点。</li>
</ol>
<h3 data-id="heading-11">六、总结：原型的本质</h3>
<p>原型的核心是「<strong>对象之间的关联关系</strong>」——每个对象都通过 <code>__proto__</code> 关联到一个原型对象，从而共享原型上的资源。这种关联形成的「原型链」，决定了 JS 中属性查找、继承的逻辑。</p>
<p>理解原型，就能理解 JS 面向对象的底层逻辑（比如 <code>new</code> 关键字的作用、继承的实现方式），也是后续学习 <code>class</code>、<code>extends</code> 等语法的基础。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[原型-2：prototype 和 __proto__ 的区别详解]]></title>    <link>https://juejin.cn/post/7581807793133699118</link>    <guid>https://juejin.cn/post/7581807793133699118</guid>    <pubDate>2025-12-10T05:19:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581807793133699118" data-draft-id="7581888578508537883" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="原型-2：prototype 和 __proto__ 的区别详解"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-12-10T05:19:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="之恒君"/> <meta itemprop="url" content="https://juejin.cn/user/2261046026312318"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            原型-2：prototype 和 __proto__ 的区别详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2261046026312318/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    之恒君
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T05:19:45.000Z" title="Wed Dec 10 2025 05:19:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{position:relative;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:30px;margin-bottom:5px}.markdown-body h2{font-size:24px;display:inline-block;font-weight:700;background:#ef7060;color:#fff;padding:6px 8px 0 0;border-top-right-radius:6px;margin-right:2px;box-shadow:6px 3px 0 0 rgba(239,112,96,.2)}.markdown-body h2:before{content:" ";display:inline-block;width:8px}.markdown-body h2:after{content:" ";position:absolute;display:block;width:calc(100% - 50px);border-bottom:3px solid #ef7060}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #3e3e3e;margin-top:32px;margin-bottom:32px;height:1px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(27,31,35,.05);color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:JetBranins Mono,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px;background-color:#fdfdfd}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#fdfdfd}.markdown-body a{text-decoration:none;font-weight:700;color:#ef7060;border-bottom:1px solid #ef7060}.markdown-body a:active,.markdown-body a:hover{color:#ef2d26}.markdown-body table tr td,.markdown-body table tr th{border:1px solid #ccc;padding:5px 10px}.markdown-body table{display:block!important;width:auto;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{background:#f0f0f0;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#f8f8f8}.markdown-body blockquote{margin-inline-start:0;margin-inline-end:0;border-left:3px solid #ef7060;background:#fff9f9;padding:1px 20px;margin-top:20px}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atelier-heath-light">.hljs-comment,.hljs-quote{color:#776977}.hljs-attribute,.hljs-link,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ca402b}.hljs-built_in,.hljs-builtin-name,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#a65926}.hljs-bullet,.hljs-string,.hljs-symbol{color:#918b3b}.hljs-section,.hljs-title{color:#516aec}.hljs-keyword,.hljs-selector-tag{color:#7b59c0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#f7f3f7;color:#695d69}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>这两个属性都与 JavaScript 的原型系统相关，但扮演完全不同的角色，经常容易混淆。</p>
<h2 data-id="heading-0">1. 核心区别总结</h2>








































<table><thead><tr><th>特性</th><th><code>prototype</code></th><th><code>__proto__</code></th></tr></thead><tbody><tr><td><strong>所有者</strong>​</td><td>函数</td><td>对象</td></tr><tr><td><strong>作用</strong>​</td><td>构造函数创建对象的原型</td><td>对象的原型链引用</td></tr><tr><td><strong>访问</strong>​</td><td>构造函数.prototype</td><td>对象.<strong>proto</strong></td></tr><tr><td><strong>标准</strong>​</td><td>正式标准</td><td>非标准（但被广泛实现）</td></tr><tr><td><strong>推荐访问</strong>​</td><td>Object.getPrototypeOf(obj)</td><td/></tr><tr><td><strong>推荐设置</strong>​</td><td>Object.setPrototypeOf(obj, proto)</td><td/></tr></tbody></table>
<h2 data-id="heading-1">2. 基本概念</h2>
<h3 data-id="heading-2">2.1 prototype 属性</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 构造函数才有 prototype</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Person</span>(<span class="hljs-params">name</span>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
}

<span class="hljs-comment">// prototype 用于定义通过 new 创建的对象共享的属性和方法</span>
<span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">sayHello</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Hello, I'm <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span>`</span>);
};

<span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">species</span> = <span class="hljs-string">'Human'</span>;

<span class="hljs-comment">// 查看 prototype</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-keyword">typeof</span> <span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>);  <span class="hljs-comment">// "object"</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">constructor</span> === <span class="hljs-title class_">Person</span>);  <span class="hljs-comment">// true</span>
</code></pre>
<h3 data-id="heading-3">2.2 <code>__proto__</code>属性</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 对象才有 __proto__</span>
<span class="hljs-keyword">const</span> person = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">'Alice'</span>);

<span class="hljs-comment">// __proto__ 指向创建该对象的构造函数的 prototype</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(person.<span class="hljs-property">__proto__</span> === <span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>);  <span class="hljs-comment">// true</span>

<span class="hljs-comment">// 原型链查找</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(person.<span class="hljs-property">name</span>);        <span class="hljs-comment">// "Alice" - 自有属性</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(person.<span class="hljs-property">species</span>);     <span class="hljs-comment">// "Human" - 从原型找到</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(person.<span class="hljs-title function_">toString</span>());  <span class="hljs-comment">// [object Object] - 从 Object.prototype 找到</span>
</code></pre>
<h2 data-id="heading-4">3. 详细对比</h2>
<h3 data-id="heading-5">3.1 属性所有者</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Animal</span>(<span class="hljs-params"/>) {}

<span class="hljs-comment">// prototype 属于函数</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Animal</span>.<span class="hljs-title function_">hasOwnProperty</span>(<span class="hljs-string">'prototype'</span>));  <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-keyword">typeof</span> <span class="hljs-title class_">Animal</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>);              <span class="hljs-comment">// "object"</span>

<span class="hljs-comment">// __proto__ 属于对象</span>
<span class="hljs-keyword">const</span> dog = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Animal</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(dog.<span class="hljs-title function_">hasOwnProperty</span>(<span class="hljs-string">'__proto__'</span>));      <span class="hljs-comment">// false</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(dog.<span class="hljs-property">__proto__</span> === <span class="hljs-title class_">Animal</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>);   <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-keyword">typeof</span> dog.<span class="hljs-property">__proto__</span>);                 <span class="hljs-comment">// "object"</span>

<span class="hljs-comment">// 函数也是对象，所以函数也有 __proto__</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Animal</span>.<span class="hljs-property">__proto__</span> === <span class="hljs-title class_">Function</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>);  <span class="hljs-comment">// true</span>
</code></pre>
<h3 data-id="heading-6">3.2 创建时的行为</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Car</span>(<span class="hljs-params">brand</span>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">brand</span> = brand;
}

<span class="hljs-comment">// 设置 prototype</span>
<span class="hljs-title class_">Car</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">drive</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.brand}</span> is driving`</span>);
};

<span class="hljs-comment">// 创建实例</span>
<span class="hljs-keyword">const</span> myCar = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Car</span>(<span class="hljs-string">'Toyota'</span>);

<span class="hljs-comment">// 此时发生：</span>
<span class="hljs-comment">// 1. 创建新对象：{}</span>
<span class="hljs-comment">// 2. 设置对象的 __proto__ 指向 Car.prototype</span>
<span class="hljs-comment">// 3. 执行构造函数，this 指向新对象</span>
<span class="hljs-comment">// 4. 返回对象</span>

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(myCar.<span class="hljs-property">__proto__</span> === <span class="hljs-title class_">Car</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>);  <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">getPrototypeOf</span>(myCar) === <span class="hljs-title class_">Car</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>);  <span class="hljs-comment">// true</span>
</code></pre>
<h2 data-id="heading-7">4. 原型链示例</h2>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Vehicle</span>(<span class="hljs-params">type</span>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">type</span> = type;
}
<span class="hljs-title class_">Vehicle</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">move</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.type}</span> is moving`</span>);
};

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Car</span>(<span class="hljs-params">brand</span>) {
  <span class="hljs-title class_">Vehicle</span>.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>, <span class="hljs-string">'car'</span>);
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">brand</span> = brand;
}

<span class="hljs-comment">// 继承 Vehicle</span>
<span class="hljs-title class_">Car</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(<span class="hljs-title class_">Vehicle</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>);
<span class="hljs-title class_">Car</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">constructor</span> = <span class="hljs-title class_">Car</span>;

<span class="hljs-title class_">Car</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">honk</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.brand}</span> honks!`</span>);
};

<span class="hljs-comment">// 创建实例</span>
<span class="hljs-keyword">const</span> toyota = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Car</span>(<span class="hljs-string">'Toyota'</span>);

<span class="hljs-comment">// 原型链：</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(toyota.<span class="hljs-property">__proto__</span> === <span class="hljs-title class_">Car</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>);          <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(toyota.<span class="hljs-property">__proto__</span>.<span class="hljs-property">__proto__</span> === <span class="hljs-title class_">Vehicle</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>);  <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(toyota.<span class="hljs-property">__proto__</span>.<span class="hljs-property">__proto__</span>.<span class="hljs-property">__proto__</span> === <span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>);  <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(toyota.<span class="hljs-property">__proto__</span>.<span class="hljs-property">__proto__</span>.<span class="hljs-property">__proto__</span>.<span class="hljs-property">__proto__</span>);  <span class="hljs-comment">// null</span>

<span class="hljs-comment">// 方法查找：</span>
toyota.<span class="hljs-title function_">honk</span>();   <span class="hljs-comment">// 在 Car.prototype 找到</span>
toyota.<span class="hljs-title function_">move</span>();   <span class="hljs-comment">// 在 Vehicle.prototype 找到</span>
toyota.<span class="hljs-title function_">toString</span>();  <span class="hljs-comment">// 在 Object.prototype 找到</span>
</code></pre>
<h2 data-id="heading-8">5. 标准 vs 非标准</h2>
<h3 data-id="heading-9">5.1 标准访问方法</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Person</span>(<span class="hljs-params"/>) {}
<span class="hljs-keyword">const</span> p = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>();

<span class="hljs-comment">// 标准获取原型的方法</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">getPrototypeOf</span>(p) === <span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>);  <span class="hljs-comment">// true</span>

<span class="hljs-comment">// 标准设置原型的方法</span>
<span class="hljs-keyword">const</span> obj = {};
<span class="hljs-keyword">const</span> newProto = { <span class="hljs-attr">x</span>: <span class="hljs-number">1</span> };
<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">setPrototypeOf</span>(obj, newProto);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">getPrototypeOf</span>(obj) === newProto);  <span class="hljs-comment">// true</span>

<span class="hljs-comment">// 检查是否是原型</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(newProto.<span class="hljs-title function_">isPrototypeOf</span>(obj));  <span class="hljs-comment">// true</span>
</code></pre>
<h3 data-id="heading-10">5.2 <code>__proto__</code>的问题</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// __proto__ 不是标准属性，但被广泛支持</span>
<span class="hljs-keyword">const</span> obj = {};

<span class="hljs-comment">// 在一些环境中可能不可用</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'__proto__'</span> <span class="hljs-keyword">in</span> {});  <span class="hljs-comment">// 大多数是 true</span>

<span class="hljs-comment">// 但可以修改</span>
<span class="hljs-keyword">const</span> originalProto = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">getPrototypeOf</span>(obj);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(obj.<span class="hljs-property">__proto__</span> === originalProto);  <span class="hljs-comment">// true</span>

<span class="hljs-comment">// 修改 __proto__</span>
obj.<span class="hljs-property">__proto__</span> = { <span class="hljs-attr">custom</span>: <span class="hljs-literal">true</span> };
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(obj.<span class="hljs-property">custom</span>);  <span class="hljs-comment">// true</span>

<span class="hljs-comment">// 但性能差，不推荐</span>
<span class="hljs-comment">// Object.setPrototypeOf 是更好的选择</span>
</code></pre>
<h2 data-id="heading-11">6. 特殊情况</h2>
<h3 data-id="heading-12">6.1 箭头函数</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 箭头函数没有 prototype</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">arrow</span> = (<span class="hljs-params"/>) =&gt; {};
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arrow.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>);  <span class="hljs-comment">// undefined</span>

<span class="hljs-comment">// 普通函数有 prototype</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">normal</span>(<span class="hljs-params"/>) {}
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(normal.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>);  <span class="hljs-comment">// { constructor: normal }</span>
</code></pre>
<h3 data-id="heading-13">6.2 内置对象</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 数组的原型链</span>
<span class="hljs-keyword">const</span> arr = [];
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arr.<span class="hljs-property">__proto__</span> === <span class="hljs-title class_">Array</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>);  <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arr.<span class="hljs-property">__proto__</span>.<span class="hljs-property">__proto__</span> === <span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>);  <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arr.<span class="hljs-property">__proto__</span>.<span class="hljs-property">__proto__</span>.<span class="hljs-property">__proto__</span>);  <span class="hljs-comment">// null</span>

<span class="hljs-comment">// 字符串的原型链</span>
<span class="hljs-keyword">const</span> str = <span class="hljs-string">'hello'</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(str.<span class="hljs-property">__proto__</span> === <span class="hljs-title class_">String</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>);  <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(str.<span class="hljs-property">__proto__</span>.<span class="hljs-property">__proto__</span> === <span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>);  <span class="hljs-comment">// true</span>

<span class="hljs-comment">// 函数的原型链</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">fn</span>(<span class="hljs-params"/>) {}
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(fn.<span class="hljs-property">__proto__</span> === <span class="hljs-title class_">Function</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>);  <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(fn.<span class="hljs-property">__proto__</span>.<span class="hljs-property">__proto__</span> === <span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>);  <span class="hljs-comment">// true</span>
</code></pre>
<h3 data-id="heading-14">6.3 Object.create</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 使用 Object.create 创建对象</span>
<span class="hljs-keyword">const</span> proto = { <span class="hljs-attr">x</span>: <span class="hljs-number">10</span> };
<span class="hljs-keyword">const</span> obj = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(proto);

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">getPrototypeOf</span>(obj) === proto);  <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(obj.<span class="hljs-property">__proto__</span> === proto);  <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(obj.<span class="hljs-property">x</span>);  <span class="hljs-comment">// 10，从原型继承</span>

<span class="hljs-comment">// 创建没有原型的对象</span>
<span class="hljs-keyword">const</span> nullObj = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(<span class="hljs-literal">null</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">getPrototypeOf</span>(nullObj));  <span class="hljs-comment">// null</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(nullObj.<span class="hljs-property">__proto__</span>);  <span class="hljs-comment">// undefined</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(nullObj.<span class="hljs-property">toString</span>);  <span class="hljs-comment">// undefined</span>
</code></pre>
<h2 data-id="heading-15">7. 继承机制详解</h2>
<h3 data-id="heading-16">7.1 构造函数继承</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Parent</span>(<span class="hljs-params">name</span>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">parentProperty</span> = <span class="hljs-string">'parent'</span>;
}

<span class="hljs-title class_">Parent</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">parentMethod</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Parent method:'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span>);
};

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Child</span>(<span class="hljs-params">name, age</span>) {
  <span class="hljs-comment">// 1. 构造函数继承（实例属性）</span>
  <span class="hljs-title class_">Parent</span>.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>, name);
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">age</span> = age;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">childProperty</span> = <span class="hljs-string">'child'</span>;
}

<span class="hljs-comment">// 2. 原型继承（方法）</span>
<span class="hljs-title class_">Child</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(<span class="hljs-title class_">Parent</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>);
<span class="hljs-title class_">Child</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">constructor</span> = <span class="hljs-title class_">Child</span>;

<span class="hljs-title class_">Child</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">childMethod</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Child method:'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">age</span>);
};

<span class="hljs-comment">// 创建实例</span>
<span class="hljs-keyword">const</span> child = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Child</span>(<span class="hljs-string">'Alice'</span>, <span class="hljs-number">10</span>);

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(child.<span class="hljs-property">__proto__</span> === <span class="hljs-title class_">Child</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>);  <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(child.<span class="hljs-property">__proto__</span>.<span class="hljs-property">__proto__</span> === <span class="hljs-title class_">Parent</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>);  <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(child.<span class="hljs-title function_">hasOwnProperty</span>(<span class="hljs-string">'name'</span>));  <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(child.<span class="hljs-title function_">hasOwnProperty</span>(<span class="hljs-string">'parentMethod'</span>));  <span class="hljs-comment">// false</span>
</code></pre>
<h3 data-id="heading-17">7.2 ES6 类继承</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Parent</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">name</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
  }
  
  <span class="hljs-title function_">sayHello</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Hello from <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span>`</span>);
  }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Child</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Parent</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">name, age</span>) {
    <span class="hljs-variable language_">super</span>(name);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">age</span> = age;
  }
  
  <span class="hljs-title function_">sayAge</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`I'm <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.age}</span> years old`</span>);
  }
}

<span class="hljs-keyword">const</span> child = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Child</span>(<span class="hljs-string">'Bob'</span>, <span class="hljs-number">12</span>);

<span class="hljs-comment">// 本质上还是原型继承</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(child.<span class="hljs-property">__proto__</span> === <span class="hljs-title class_">Child</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>);  <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(child.<span class="hljs-property">__proto__</span>.<span class="hljs-property">__proto__</span> === <span class="hljs-title class_">Parent</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>);  <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Child</span>.<span class="hljs-property">__proto__</span> === <span class="hljs-title class_">Parent</span>);  <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Child</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">__proto__</span> === <span class="hljs-title class_">Parent</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>);  <span class="hljs-comment">// true</span>
</code></pre>
<h2 data-id="heading-18">8. 性能考虑</h2>
<h3 data-id="heading-19">8.1 原型链查找优化</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// JavaScript 引擎会优化原型链查找</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getProperty</span>(<span class="hljs-params">obj, prop</span>) {
  <span class="hljs-comment">// 1. 检查对象自身属性</span>
  <span class="hljs-keyword">if</span> (obj.<span class="hljs-title function_">hasOwnProperty</span>(prop)) {
    <span class="hljs-keyword">return</span> obj[prop];
  }
  
  <span class="hljs-comment">// 2. 查找原型链</span>
  <span class="hljs-keyword">let</span> proto = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">getPrototypeOf</span>(obj);
  <span class="hljs-keyword">while</span> (proto) {
    <span class="hljs-keyword">if</span> (proto.<span class="hljs-title function_">hasOwnProperty</span>(prop)) {
      <span class="hljs-keyword">return</span> proto[prop];
    }
    proto = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">getPrototypeOf</span>(proto);
  }
  
  <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>;
}
</code></pre>
<h3 data-id="heading-20">8.2 避免修改 <code>__proto__</code></h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// ❌ 不推荐：直接修改 __proto__</span>
<span class="hljs-keyword">const</span> obj = { <span class="hljs-attr">x</span>: <span class="hljs-number">1</span> };
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">time</span>(<span class="hljs-string">'修改 __proto__'</span>);
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10000</span>; i++) {
  obj.<span class="hljs-property">__proto__</span> = { <span class="hljs-attr">y</span>: <span class="hljs-number">2</span> };
}
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">timeEnd</span>(<span class="hljs-string">'修改 __proto__'</span>);

<span class="hljs-comment">// ✅ 推荐：使用 Object.setPrototypeOf</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">time</span>(<span class="hljs-string">'Object.setPrototypeOf'</span>);
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10000</span>; i++) {
  <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">setPrototypeOf</span>(obj, { <span class="hljs-attr">y</span>: <span class="hljs-number">2</span> });
}
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">timeEnd</span>(<span class="hljs-string">'Object.setPrototypeOf'</span>);

<span class="hljs-comment">// 最佳：创建时就确定原型</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">time</span>(<span class="hljs-string">'Object.create'</span>);
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10000</span>; i++) {
  <span class="hljs-keyword">const</span> newObj = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>({ <span class="hljs-attr">y</span>: <span class="hljs-number">2</span> });
  newObj.<span class="hljs-property">x</span> = <span class="hljs-number">1</span>;
}
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">timeEnd</span>(<span class="hljs-string">'Object.create'</span>);


<span class="hljs-comment">// 输出：</span>
<span class="hljs-comment">// 修改 __proto__: 16.87109375 ms</span>
<span class="hljs-comment">// Object.setPrototypeOf: 37.158203125 ms</span>
<span class="hljs-comment">// Object.create: 19.46484375 ms</span>
</code></pre>
<h2 data-id="heading-21">9. 实际应用</h2>
<h3 data-id="heading-22">9.1 对象扩展</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 使用原型扩展内置对象</span>
<span class="hljs-keyword">if</span> (!<span class="hljs-title class_">Array</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">find</span>) {
  <span class="hljs-title class_">Array</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">find</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">predicate</span>) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">length</span>; i++) {
      <span class="hljs-keyword">if</span> (<span class="hljs-title function_">predicate</span>(<span class="hljs-variable language_">this</span>[i], i, <span class="hljs-variable language_">this</span>)) {
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>[i];
      }
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>;
  };
}

<span class="hljs-comment">// 检查是否是自定义扩展</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>([].<span class="hljs-title function_">hasOwnProperty</span>(<span class="hljs-string">'find'</span>));  <span class="hljs-comment">// false</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>([].<span class="hljs-property">__proto__</span>.<span class="hljs-title function_">hasOwnProperty</span>(<span class="hljs-string">'find'</span>));  <span class="hljs-comment">// true</span>
</code></pre>
<h3 data-id="heading-23">9.2 混入模式</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 使用原型实现混入</span>
<span class="hljs-keyword">const</span> canEat = {
  <span class="hljs-title function_">eat</span>(<span class="hljs-params">food</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span> eats <span class="hljs-subst">${food}</span>`</span>);
  }
};

<span class="hljs-keyword">const</span> canSleep = {
  <span class="hljs-title function_">sleep</span>(<span class="hljs-params">hours</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span> sleeps for <span class="hljs-subst">${hours}</span> hours`</span>);
  }
};

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Animal</span>(<span class="hljs-params">name</span>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
}

<span class="hljs-comment">// 混入到原型</span>
<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(<span class="hljs-title class_">Animal</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>, canEat, canSleep);

<span class="hljs-keyword">const</span> dog = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Animal</span>(<span class="hljs-string">'Dog'</span>);
dog.<span class="hljs-title function_">eat</span>(<span class="hljs-string">'meat'</span>);
dog.<span class="hljs-title function_">sleep</span>(<span class="hljs-number">8</span>);

<span class="hljs-comment">// 输出：</span>
<span class="hljs-comment">// Dog eats meat</span>
<span class="hljs-comment">// Dog sleeps for 8 hours</span>
</code></pre>
<h3 data-id="heading-24">9.3 原型检测</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 检测对象关系</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getPrototypeChain</span>(<span class="hljs-params">obj</span>) {
  <span class="hljs-keyword">const</span> chain = [];
  <span class="hljs-keyword">let</span> current = obj;
  
  <span class="hljs-keyword">while</span> (current) {
    chain.<span class="hljs-title function_">push</span>(current.<span class="hljs-property">constructor</span>.<span class="hljs-property">name</span> || <span class="hljs-string">'[Anonymous]'</span>);
    current = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">getPrototypeOf</span>(current);
  }
  
  <span class="hljs-keyword">return</span> chain;
}

<span class="hljs-keyword">const</span> arr = [];
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">getPrototypeChain</span>(arr));  <span class="hljs-comment">// ["Array", "Object", "[Anonymous]"]</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">getPrototypeChain</span>(<span class="hljs-title class_">Function</span>));  <span class="hljs-comment">// ["Function", "Object", "[Anonymous]"]</span>
</code></pre>
<h2 data-id="heading-25">10. 常见误区</h2>
<h3 data-id="heading-26">10.1 混淆 prototype 和 <code>__proto__</code></h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">MyClass</span>(<span class="hljs-params"/>) {}

<span class="hljs-comment">// ❌ 错误理解</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">MyClass</span>.<span class="hljs-property">__proto__</span> === <span class="hljs-title class_">MyClass</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>);  <span class="hljs-comment">// false</span>

<span class="hljs-comment">// ✅ 正确理解</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">MyClass</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">__proto__</span> === <span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>);  <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">MyClass</span>.<span class="hljs-property">__proto__</span> === <span class="hljs-title class_">Function</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>);  <span class="hljs-comment">// true</span>

<span class="hljs-keyword">const</span> instance = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyClass</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(instance.<span class="hljs-property">__proto__</span> === <span class="hljs-title class_">MyClass</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>);  <span class="hljs-comment">// true</span>
</code></pre>
<h3 data-id="heading-27">10.2 修改构造函数的 prototype</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Original</span>(<span class="hljs-params"/>) {}
<span class="hljs-title class_">Original</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">value</span> = <span class="hljs-number">1</span>;

<span class="hljs-keyword">const</span> obj1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Original</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(obj1.<span class="hljs-property">value</span>);  <span class="hljs-comment">// 1</span>

<span class="hljs-comment">// 修改构造函数的 prototype</span>
<span class="hljs-title class_">Original</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> = { <span class="hljs-attr">value</span>: <span class="hljs-number">2</span> };

<span class="hljs-keyword">const</span> obj2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Original</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(obj2.<span class="hljs-property">value</span>);  <span class="hljs-comment">// 2</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(obj1.<span class="hljs-property">value</span>);  <span class="hljs-comment">// 1，已存在的对象不受影响</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(obj1.<span class="hljs-property">__proto__</span> === obj2.<span class="hljs-property">__proto__</span>);  <span class="hljs-comment">// false</span>
</code></pre>
<h3 data-id="heading-28">10.3 原型污染</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 原型污染攻击</span>
<span class="hljs-comment">// ❌ 危险：用户输入控制原型</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">unsafeMerge</span>(<span class="hljs-params">target, source</span>) {
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">in</span> source) {
    target[key] = source[key];
  }
  <span class="hljs-keyword">return</span> target;
}

<span class="hljs-keyword">const</span> userInput = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(<span class="hljs-string">'{"__proto__": {"admin": true}}'</span>);
<span class="hljs-keyword">const</span> config = {};
<span class="hljs-title function_">unsafeMerge</span>(config, userInput);

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>({}.<span class="hljs-property">admin</span>);  <span class="hljs-comment">// true！污染了所有对象</span>

<span class="hljs-comment">// ✅ 安全的方法</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">safeMerge</span>(<span class="hljs-params">target, source</span>) {
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">in</span> source) {
    <span class="hljs-keyword">if</span> (source.<span class="hljs-title function_">hasOwnProperty</span>(key)) {
      target[key] = source[key];
    }
  }
  <span class="hljs-keyword">return</span> target;
}
</code></pre>
<h2 data-id="heading-29">11. 现代最佳实践</h2>
<h3 data-id="heading-30">11.1 使用 ES6 类</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Base</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">name</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
  }
  
  <span class="hljs-title function_">sayHello</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Hello, <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span>`</span>);
  }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Derived</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Base</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">name, value</span>) {
    <span class="hljs-variable language_">super</span>(name);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span> = value;
  }
  
  <span class="hljs-title function_">showValue</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Value: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.value}</span>`</span>);
  }
}

<span class="hljs-comment">// 清晰的继承关系</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">getPrototypeOf</span>(<span class="hljs-title class_">Derived</span>) === <span class="hljs-title class_">Base</span>);  <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">getPrototypeOf</span>(<span class="hljs-title class_">Derived</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>) === <span class="hljs-title class_">Base</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>);  <span class="hljs-comment">// true</span>
</code></pre>
<h3 data-id="heading-31">11.2 使用 Object.create</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 组合式继承</span>
<span class="hljs-keyword">const</span> canFly = {
  <span class="hljs-title function_">fly</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span> is flying`</span>);
  }
};

<span class="hljs-keyword">const</span> canSwim = {
  <span class="hljs-title function_">swim</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span> is swimming`</span>);
  }
};

<span class="hljs-keyword">function</span> <span class="hljs-title function_">createAnimal</span>(<span class="hljs-params">name, abilities</span>) {
  <span class="hljs-keyword">const</span> animal = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(
    abilities.<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">proto, ability</span>) =&gt;</span> {
      <span class="hljs-keyword">return</span> <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(proto), ability);
    }, { name })
  );
  <span class="hljs-keyword">return</span> animal;
}

<span class="hljs-keyword">const</span> duck = <span class="hljs-title function_">createAnimal</span>(<span class="hljs-string">'Duck'</span>, [canFly, canSwim]);
duck.<span class="hljs-title function_">fly</span>();
duck.<span class="hljs-title function_">swim</span>();
</code></pre>
<h3 data-id="heading-32">11.3 使用代理</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 使用 Proxy 控制原型访问</span>
<span class="hljs-keyword">const</span> handler = {
  <span class="hljs-title function_">get</span>(<span class="hljs-params">target, prop</span>) {
    <span class="hljs-keyword">if</span> (prop === <span class="hljs-string">'__proto__'</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'Direct __proto__ access is forbidden'</span>);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">get</span>(target, prop);
  },
  <span class="hljs-title function_">set</span>(<span class="hljs-params">target, prop, value</span>) {
    <span class="hljs-keyword">if</span> (prop === <span class="hljs-string">'__proto__'</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'Direct __proto__ modification is forbidden'</span>);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">set</span>(target, prop, value);
  }
};

<span class="hljs-keyword">const</span> safeObject = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Proxy</span>({}, handler);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(safeObject.<span class="hljs-property">x</span> = <span class="hljs-number">1</span>);  <span class="hljs-comment">// 正常</span>
<span class="hljs-comment">// safeObject.__proto__ = {};  // 抛出错误</span>
</code></pre>
<h2 data-id="heading-33">总结</h2>
<h3 data-id="heading-34">关键点</h3>
<ol>
<li><strong><code>prototype</code>是函数的属性</strong>，用于定义通过该函数作为构造函数创建的对象所共享的属性和方法</li>
<li><strong><code>__proto__</code>是对象的属性</strong>，指向创建该对象的构造函数的 <code>prototype</code></li>
<li><strong>原型链是通过 <code>__proto__</code>链接的</strong>，而不是 <code>prototype</code></li>
<li><strong>使用标准方法</strong>：<code>Object.getPrototypeOf()</code>和 <code>Object.setPrototypeOf()</code></li>
</ol>
<h3 data-id="heading-35">记忆口诀</h3>
<pre><code class="hljs language-js" lang="js">函数有prototype，对象有__proto__

<span class="hljs-keyword">new</span>的时候，对象.<span class="hljs-property">__proto__</span> = 函数.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>

原型链是对象链，函数只在链的开端

标准方法更可靠，__proto__要慎用
</code></pre>
<h3 data-id="heading-36">现代开发建议</h3>
<ul>
<li>使用 ES6 类语法</li>
<li>避免直接操作 <code>__proto__</code></li>
<li>使用 <code>Object.create()</code>创建对象</li>
<li>了解原型机制，但让框架/引擎处理细节</li>
<li>注意原型污染的安全问题</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[unplugin-vue-router文件路由实操]]></title>    <link>https://juejin.cn/post/7581789701531828266</link>    <guid>https://juejin.cn/post/7581789701531828266</guid>    <pubDate>2025-12-10T05:04:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581789701531828266" data-draft-id="7581738974424612883" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="unplugin-vue-router文件路由实操"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-10T05:04:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="LCC"/> <meta itemprop="url" content="https://juejin.cn/user/4226999541563453"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            unplugin-vue-router文件路由实操
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4226999541563453/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    LCC
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T05:04:37.000Z" title="Wed Dec 10 2025 05:04:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><code>unplugin-vue-router</code> 会根据你的文件结构自动生成路由配置。虽然路由是自动生成的，但你仍然可以通过 <strong>路由元信息（meta）</strong> 来对组件做一些特殊处理。</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">&lt;route</span> <span class="hljs-string">lang="yaml"&gt;</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">login</span>
    <span class="hljs-attr">meta:</span>
      <span class="hljs-attr">whiteList:</span> <span class="hljs-literal">true</span>
      <span class="hljs-attr">title:</span> <span class="hljs-string">登录跳转</span>
      <span class="hljs-attr">constant:</span> <span class="hljs-literal">true</span>
      <span class="hljs-attr">layout:</span> <span class="hljs-string">index</span>
<span class="hljs-string">&lt;/route&gt;</span>

</code></pre>
<pre><code class="hljs language-javascript" lang="javascript">安装
pnpm i unplugin-vue-router -D

配置<span class="hljs-comment">// vite.config.js</span>
<span class="hljs-keyword">import</span> { defineConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">"vite"</span>;
<span class="hljs-keyword">import</span> vue <span class="hljs-keyword">from</span> <span class="hljs-string">"@vitejs/plugin-vue"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">VueRouter</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"unplugin-vue-router/vite"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-attr">plugins</span>: [
    <span class="hljs-title class_">VueRouter</span>({ <span class="hljs-attr">routesFolder</span>: <span class="hljs-string">"src/views"</span> }),
    <span class="hljs-title function_">vue</span>(),
  ]
});

使用
<span class="hljs-keyword">import</span> { routes } <span class="hljs-keyword">from</span> <span class="hljs-string">"vue-router/auto/routes"</span> <span class="hljs-comment">// 引入文件路由表</span>
<span class="hljs-keyword">import</span> { createRouter, createWebHistory } <span class="hljs-keyword">from</span> <span class="hljs-string">"vue-router"</span>

<span class="hljs-keyword">const</span> router = <span class="hljs-title function_">createRouter</span>({
  <span class="hljs-attr">routes</span>: routes, <span class="hljs-comment">// 注册文件路由表</span>
  <span class="hljs-attr">history</span>: <span class="hljs-title function_">createWebHistory</span>(),
})

</code></pre>
<p>运行项目打印routes就会看到生成好的路由</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/919d5d0ed6f247039b293af31054c6dc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTEND:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765947876&amp;x-signature=5BOFV%2BdM4TIqBSOOSBfEtxDNh8k%3D" alt="image.png" loading="lazy"/></p>
<p>一般搭配<code>vite-plugin-vue-meta-layouts</code>使用</p>
<pre><code class="hljs language-javascript" lang="javascript">安装
pnpm i vite-plugin-vue-meta-layouts -D

配置<span class="hljs-comment">// vite.config.js</span>
<span class="hljs-keyword">import</span> { defineConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">"vite"</span>;
<span class="hljs-keyword">import</span> vue <span class="hljs-keyword">from</span> <span class="hljs-string">"@vitejs/plugin-vue"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">VueRouter</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"unplugin-vue-router/vite"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">MetaLayouts</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"vite-plugin-vue-meta-layouts"</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-attr">plugins</span>: [
    <span class="hljs-title class_">VueRouter</span>({ <span class="hljs-attr">routesFolder</span>: <span class="hljs-string">"src/views"</span> }),
    <span class="hljs-title class_">Layouts</span>({
      <span class="hljs-attr">target</span>: <span class="hljs-string">"src/layouts"</span>, <span class="hljs-comment">// 布局目录，默认 src/layouts</span>
      <span class="hljs-attr">defaultLayout</span>: <span class="hljs-string">"index"</span>, <span class="hljs-comment">// 默认布局，默认为 default</span>
      <span class="hljs-attr">skipTopLevelRouteLayout</span>: <span class="hljs-literal">true</span>, 
    }),
    <span class="hljs-title function_">vue</span>(),
  ]
});

使用
<span class="hljs-keyword">import</span> { routes } <span class="hljs-keyword">from</span> <span class="hljs-string">"vue-router/auto/routes"</span> <span class="hljs-comment">// 引入文件路由表</span>
<span class="hljs-keyword">import</span> { setupLayouts } <span class="hljs-keyword">from</span> <span class="hljs-string">"virtual:meta-layouts"</span>
<span class="hljs-keyword">import</span> { createRouter, createWebHistory } <span class="hljs-keyword">from</span> <span class="hljs-string">"vue-router"</span>

<span class="hljs-keyword">const</span> router = <span class="hljs-title function_">createRouter</span>({
  <span class="hljs-attr">routes</span>: <span class="hljs-title function_">setupLayouts</span>(routes), <span class="hljs-comment">// 注册文件路由表</span>
  <span class="hljs-attr">history</span>: <span class="hljs-title function_">createWebHistory</span>(),
})

如果你是 <span class="hljs-string">`ts`</span> 项目，还可以在 <span class="hljs-string">`tsconfig.json`</span> 中配置以下声明
{
  <span class="hljs-string">"compilerOptions"</span>: {
    <span class="hljs-string">"types"</span>: [<span class="hljs-string">"vite-plugin-vue-meta-layouts/client"</span>]
  }
}
</code></pre>
<p>在layouts文件夹创建不同的的布局文件</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/66e8b1a345414bf7ae74ebd51aa11b2b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTEND:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765947876&amp;x-signature=pUuyVOKb29XZ%2ByQqlm6Zjy5YkGw%3D" alt="image.png" loading="lazy"/></p>
<p>在页面组件中通过路由元信息配置layout的值来让页面使用哪种布局，一般在<code>vite.config.ts</code>配置默认使用的布局</p>
<pre><code class="hljs language-ini" lang="ini">&lt;route <span class="hljs-attr">lang</span>=<span class="hljs-string">"yaml"</span>&gt;
    meta:
      layout: empty 
&lt;/route&gt;
</code></pre>
<p>然后可以通过createGetRoutes查看生成的路由</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { createGetRoutes } <span class="hljs-keyword">from</span> <span class="hljs-string">"virtual:meta-layouts"</span>

<span class="hljs-keyword">const</span> getRoutes = <span class="hljs-title function_">createGetRoutes</span>(router)

<span class="hljs-comment">// 获取路由表但是不包含布局路由</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">getRoutes</span>())
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bc1e67c0a7614781b6361f085f0e93b4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTEND:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765947876&amp;x-signature=LsCAU%2F7uB8xLhxR3NVbDYkytVsU%3D" alt="image.png" loading="lazy"/></p>
<p>文件路由使用路由query
传参跳转页面需要为 router-view 添加唯一 key
不然就会出现<code>多次跳转同一页面，如果只是参数不同，页面不会重新执行生命周期方法</code></p>
<pre><code class="hljs language-ini" lang="ini">&lt;router-view <span class="hljs-attr">v-slot</span>=<span class="hljs-string">"{ Component, route }"</span>&gt;
   &lt;keep-alive :<span class="hljs-attr">include</span>=<span class="hljs-string">"cachedComponents"</span>&gt;
      &lt;component :<span class="hljs-attr">is</span>=<span class="hljs-string">"Component"</span> :key=<span class="hljs-string">"route.fullPath"</span> /&gt;
   &lt;/keep-alive&gt;
&lt;/router-view&gt;
</code></pre>
<p>当然，如果是使用动态路由就不会有这个问题</p>
<ul>
<li><code>src/views/users/[id].vue</code> → <code>/users/:id</code></li>
<li><code>src/views/posts/[...slug].vue</code> → <code>/posts/:slug(.*)*</code></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[UniApp Workspaces 编译报错（`Invalid pattern ...`）解决办法]]></title>    <link>https://juejin.cn/post/7581844141668483112</link>    <guid>https://juejin.cn/post/7581844141668483112</guid>    <pubDate>2025-12-10T05:36:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581844141668483112" data-draft-id="7581844141668384808" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="UniApp Workspaces 编译报错（`Invalid pattern ...`）解决办法"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-10T05:36:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="heyCHEEMS"/> <meta itemprop="url" content="https://juejin.cn/user/4308367489378780"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            UniApp Workspaces 编译报错（`Invalid pattern ...`）解决办法
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4308367489378780/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    heyCHEEMS
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T05:36:47.000Z" title="Wed Dec 10 2025 05:36:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">问题</h2>
<p>在 Workspaces 组织 UniApp 项目时，编译为 mp-weixin 时出现报错：<code>Invalid pattern "../../....../xxx.js" for "output.chunkFileNames", patterns can be neither absolute nor relative paths. If you want your files to be stored in a subdirectory, write its name without a leading slash like this: subdirectory/pattern."</code>。</p>
<h2 data-id="heading-1">解决办法</h2>
<p>UniApp 编译工具没有正确处理 Workspaces 引入依赖时带有的相对路径 <code>../</code>。可以直接修改utils内的对应函数，将相对路径替换成空。</p>
<p>文件位于：</p>
<pre><code class="hljs language-bash" lang="bash">node_modules/@dcloudio/uni-cli-shared/dist/utils.js
</code></pre>
<p>找到 <strong><code>normalizeNodeModules</code></strong> 函数，修改：</p>
<p><strong>【修改前】</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">normalizeNodeModules</span>(<span class="hljs-params">str</span>) {
  <span class="hljs-comment">// ... 原有代码</span>
  <span class="hljs-keyword">return</span> str;
}
</code></pre>
<p><strong>【修改后】</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">normalizeNodeModules</span>(<span class="hljs-params">str</span>) {
  <span class="hljs-comment">// ... 原有代码</span>

  <span class="hljs-comment">// 匹配删除路径中的所有相对路径标识符 '../'</span>
  str = str.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/\.\.\//g</span>, <span class="hljs-string">''</span>)

  <span class="hljs-keyword">return</span> str;
}
</code></pre>
<p>重启编译即可解决。</p>
<hr/>
<blockquote>
<p><strong>注意：</strong> 这是一个临时补丁。如果运行 <code>npm install</code> 等命令，该文件会被覆盖，需要重新修改。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[vxe-tree 树组件拖拽排序功能的使用教程]]></title>    <link>https://juejin.cn/post/7581807793133781038</link>    <guid>https://juejin.cn/post/7581807793133781038</guid>    <pubDate>2025-12-10T05:39:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581807793133781038" data-draft-id="7581772744376352814" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="vxe-tree 树组件拖拽排序功能的使用教程"/> <meta itemprop="keywords" content="Vue.js"/> <meta itemprop="datePublished" content="2025-12-10T05:39:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户84179481456"/> <meta itemprop="url" content="https://juejin.cn/user/3921272428567529"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            vxe-tree 树组件拖拽排序功能的使用教程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3921272428567529/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户84179481456
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T05:39:50.000Z" title="Wed Dec 10 2025 05:39:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>vxe-tree 树组件拖拽排序功能的使用教程，通过 drag 启用行拖拽排序功能，支持同层级、跨层级、拖拽到子级非常强大的拖拽功能等</p>
<p>官网：<a href="https://link.juejin.cn?target=https%3A%2F%2Fvxeui.com" target="_blank" title="https://vxeui.com" ref="nofollow noopener noreferrer">vxeui.com</a>
github：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fx-extends%2Fvxe-pc-ui" target="_blank" title="https://github.com/x-extends/vxe-pc-ui" ref="nofollow noopener noreferrer">github.com/x-extends/v…</a>
gitee：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fx-extends%2Fvxe-pc-ui" target="_blank" title="https://gitee.com/x-extends/vxe-pc-ui" ref="nofollow noopener noreferrer">gitee.com/x-extends/v…</a></p>
<h2 data-id="heading-0">同层级拖拽</h2>
<p>通过 drag-config.isPeerDrag 启用同层级拖拽</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/939fa9223b1d4946abd3437e1e2acf02~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3ODQxNzk0ODE0NTY=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765949989&amp;x-signature=q1vCFSdLjughWASXHiRuwmTPQhY%3D" alt="image" loading="lazy"/></p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">vxe-tree</span> <span class="hljs-attr">v-bind</span>=<span class="hljs-string">"treeOptions"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">vxe-tree</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { reactive } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">const</span> treeOptions = <span class="hljs-title function_">reactive</span>({
  <span class="hljs-attr">transform</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">drag</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">dragConfig</span>: {
    <span class="hljs-attr">isPeerDrag</span>: <span class="hljs-literal">true</span>
  },
  <span class="hljs-attr">data</span>: [
    { <span class="hljs-attr">title</span>: <span class="hljs-string">'节点2'</span>, <span class="hljs-attr">id</span>: <span class="hljs-string">'2'</span>, <span class="hljs-attr">parentId</span>: <span class="hljs-literal">null</span> },
    { <span class="hljs-attr">title</span>: <span class="hljs-string">'节点3'</span>, <span class="hljs-attr">id</span>: <span class="hljs-string">'3'</span>, <span class="hljs-attr">parentId</span>: <span class="hljs-literal">null</span> },
    { <span class="hljs-attr">title</span>: <span class="hljs-string">'节点3-1'</span>, <span class="hljs-attr">id</span>: <span class="hljs-string">'31'</span>, <span class="hljs-attr">parentId</span>: <span class="hljs-string">'3'</span> },
    { <span class="hljs-attr">title</span>: <span class="hljs-string">'节点3-2'</span>, <span class="hljs-attr">id</span>: <span class="hljs-string">'32'</span>, <span class="hljs-attr">parentId</span>: <span class="hljs-string">'3'</span> },
    { <span class="hljs-attr">title</span>: <span class="hljs-string">'节点3-2-1'</span>, <span class="hljs-attr">id</span>: <span class="hljs-string">'321'</span>, <span class="hljs-attr">parentId</span>: <span class="hljs-string">'32'</span> },
    { <span class="hljs-attr">title</span>: <span class="hljs-string">'节点3-2-2'</span>, <span class="hljs-attr">id</span>: <span class="hljs-string">'322'</span>, <span class="hljs-attr">parentId</span>: <span class="hljs-string">'32'</span> },
    { <span class="hljs-attr">title</span>: <span class="hljs-string">'节点3-3'</span>, <span class="hljs-attr">id</span>: <span class="hljs-string">'33'</span>, <span class="hljs-attr">parentId</span>: <span class="hljs-string">'3'</span> },
    { <span class="hljs-attr">title</span>: <span class="hljs-string">'节点3-3-1'</span>, <span class="hljs-attr">id</span>: <span class="hljs-string">'331'</span>, <span class="hljs-attr">parentId</span>: <span class="hljs-string">'33'</span> },
    { <span class="hljs-attr">title</span>: <span class="hljs-string">'节点3-3-2'</span>, <span class="hljs-attr">id</span>: <span class="hljs-string">'332'</span>, <span class="hljs-attr">parentId</span>: <span class="hljs-string">'33'</span> },
    { <span class="hljs-attr">title</span>: <span class="hljs-string">'节点3-3-3'</span>, <span class="hljs-attr">id</span>: <span class="hljs-string">'333'</span>, <span class="hljs-attr">parentId</span>: <span class="hljs-string">'33'</span> },
    { <span class="hljs-attr">title</span>: <span class="hljs-string">'节点3-4'</span>, <span class="hljs-attr">id</span>: <span class="hljs-string">'34'</span>, <span class="hljs-attr">parentId</span>: <span class="hljs-string">'3'</span> },
    { <span class="hljs-attr">title</span>: <span class="hljs-string">'节点4'</span>, <span class="hljs-attr">id</span>: <span class="hljs-string">'4'</span>, <span class="hljs-attr">parentId</span>: <span class="hljs-literal">null</span> },
    { <span class="hljs-attr">title</span>: <span class="hljs-string">'节点4-1'</span>, <span class="hljs-attr">id</span>: <span class="hljs-string">'41'</span>, <span class="hljs-attr">parentId</span>: <span class="hljs-string">'4'</span> },
    { <span class="hljs-attr">title</span>: <span class="hljs-string">'节点4-1-1'</span>, <span class="hljs-attr">id</span>: <span class="hljs-string">'411'</span>, <span class="hljs-attr">parentId</span>: <span class="hljs-string">'42'</span> },
    { <span class="hljs-attr">title</span>: <span class="hljs-string">'节点4-1-2'</span>, <span class="hljs-attr">id</span>: <span class="hljs-string">'412'</span>, <span class="hljs-attr">parentId</span>: <span class="hljs-string">'42'</span> },
    { <span class="hljs-attr">title</span>: <span class="hljs-string">'节点4-2'</span>, <span class="hljs-attr">id</span>: <span class="hljs-string">'42'</span>, <span class="hljs-attr">parentId</span>: <span class="hljs-string">'4'</span> },
    { <span class="hljs-attr">title</span>: <span class="hljs-string">'节点4-3'</span>, <span class="hljs-attr">id</span>: <span class="hljs-string">'43'</span>, <span class="hljs-attr">parentId</span>: <span class="hljs-string">'4'</span> },
    { <span class="hljs-attr">title</span>: <span class="hljs-string">'节点4-3-1'</span>, <span class="hljs-attr">id</span>: <span class="hljs-string">'431'</span>, <span class="hljs-attr">parentId</span>: <span class="hljs-string">'43'</span> },
    { <span class="hljs-attr">title</span>: <span class="hljs-string">'节点4-3-2'</span>, <span class="hljs-attr">id</span>: <span class="hljs-string">'432'</span>, <span class="hljs-attr">parentId</span>: <span class="hljs-string">'43'</span> },
    { <span class="hljs-attr">title</span>: <span class="hljs-string">'节点5'</span>, <span class="hljs-attr">id</span>: <span class="hljs-string">'5'</span>, <span class="hljs-attr">parentId</span>: <span class="hljs-literal">null</span> }
  ]
})
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<h2 data-id="heading-1">跨层级拖拽</h2>
<p>通过 drag-config.isCrossDrag 启用跨层级拖拽</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a0f7045f254841c0b6e822bd202a7116~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3ODQxNzk0ODE0NTY=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765949989&amp;x-signature=R5oNIodyawsWZPvIMwRe6mxtlQQ%3D" alt="tree_drag_coss_drag" loading="lazy"/></p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">vxe-tree</span> <span class="hljs-attr">v-bind</span>=<span class="hljs-string">"treeOptions"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">vxe-tree</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { reactive } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">const</span> treeOptions = <span class="hljs-title function_">reactive</span>({
  <span class="hljs-attr">transform</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">drag</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">dragConfig</span>: {
    <span class="hljs-attr">isCrossDrag</span>: <span class="hljs-literal">true</span>
  },
  <span class="hljs-attr">data</span>: [
    { <span class="hljs-attr">title</span>: <span class="hljs-string">'节点2'</span>, <span class="hljs-attr">id</span>: <span class="hljs-string">'2'</span>, <span class="hljs-attr">parentId</span>: <span class="hljs-literal">null</span> },
    { <span class="hljs-attr">title</span>: <span class="hljs-string">'节点3'</span>, <span class="hljs-attr">id</span>: <span class="hljs-string">'3'</span>, <span class="hljs-attr">parentId</span>: <span class="hljs-literal">null</span> },
    { <span class="hljs-attr">title</span>: <span class="hljs-string">'节点3-1'</span>, <span class="hljs-attr">id</span>: <span class="hljs-string">'31'</span>, <span class="hljs-attr">parentId</span>: <span class="hljs-string">'3'</span> },
    { <span class="hljs-attr">title</span>: <span class="hljs-string">'节点3-2'</span>, <span class="hljs-attr">id</span>: <span class="hljs-string">'32'</span>, <span class="hljs-attr">parentId</span>: <span class="hljs-string">'3'</span> },
    { <span class="hljs-attr">title</span>: <span class="hljs-string">'节点3-2-1'</span>, <span class="hljs-attr">id</span>: <span class="hljs-string">'321'</span>, <span class="hljs-attr">parentId</span>: <span class="hljs-string">'32'</span> },
    { <span class="hljs-attr">title</span>: <span class="hljs-string">'节点3-2-2'</span>, <span class="hljs-attr">id</span>: <span class="hljs-string">'322'</span>, <span class="hljs-attr">parentId</span>: <span class="hljs-string">'32'</span> },
    { <span class="hljs-attr">title</span>: <span class="hljs-string">'节点3-3'</span>, <span class="hljs-attr">id</span>: <span class="hljs-string">'33'</span>, <span class="hljs-attr">parentId</span>: <span class="hljs-string">'3'</span> },
    { <span class="hljs-attr">title</span>: <span class="hljs-string">'节点3-3-1'</span>, <span class="hljs-attr">id</span>: <span class="hljs-string">'331'</span>, <span class="hljs-attr">parentId</span>: <span class="hljs-string">'33'</span> },
    { <span class="hljs-attr">title</span>: <span class="hljs-string">'节点3-3-2'</span>, <span class="hljs-attr">id</span>: <span class="hljs-string">'332'</span>, <span class="hljs-attr">parentId</span>: <span class="hljs-string">'33'</span> },
    { <span class="hljs-attr">title</span>: <span class="hljs-string">'节点3-3-3'</span>, <span class="hljs-attr">id</span>: <span class="hljs-string">'333'</span>, <span class="hljs-attr">parentId</span>: <span class="hljs-string">'33'</span> },
    { <span class="hljs-attr">title</span>: <span class="hljs-string">'节点3-4'</span>, <span class="hljs-attr">id</span>: <span class="hljs-string">'34'</span>, <span class="hljs-attr">parentId</span>: <span class="hljs-string">'3'</span> },
    { <span class="hljs-attr">title</span>: <span class="hljs-string">'节点4'</span>, <span class="hljs-attr">id</span>: <span class="hljs-string">'4'</span>, <span class="hljs-attr">parentId</span>: <span class="hljs-literal">null</span> },
    { <span class="hljs-attr">title</span>: <span class="hljs-string">'节点4-1'</span>, <span class="hljs-attr">id</span>: <span class="hljs-string">'41'</span>, <span class="hljs-attr">parentId</span>: <span class="hljs-string">'4'</span> },
    { <span class="hljs-attr">title</span>: <span class="hljs-string">'节点4-1-1'</span>, <span class="hljs-attr">id</span>: <span class="hljs-string">'411'</span>, <span class="hljs-attr">parentId</span>: <span class="hljs-string">'42'</span> },
    { <span class="hljs-attr">title</span>: <span class="hljs-string">'节点4-1-2'</span>, <span class="hljs-attr">id</span>: <span class="hljs-string">'412'</span>, <span class="hljs-attr">parentId</span>: <span class="hljs-string">'42'</span> },
    { <span class="hljs-attr">title</span>: <span class="hljs-string">'节点4-2'</span>, <span class="hljs-attr">id</span>: <span class="hljs-string">'42'</span>, <span class="hljs-attr">parentId</span>: <span class="hljs-string">'4'</span> },
    { <span class="hljs-attr">title</span>: <span class="hljs-string">'节点4-3'</span>, <span class="hljs-attr">id</span>: <span class="hljs-string">'43'</span>, <span class="hljs-attr">parentId</span>: <span class="hljs-string">'4'</span> },
    { <span class="hljs-attr">title</span>: <span class="hljs-string">'节点4-3-1'</span>, <span class="hljs-attr">id</span>: <span class="hljs-string">'431'</span>, <span class="hljs-attr">parentId</span>: <span class="hljs-string">'43'</span> },
    { <span class="hljs-attr">title</span>: <span class="hljs-string">'节点4-3-2'</span>, <span class="hljs-attr">id</span>: <span class="hljs-string">'432'</span>, <span class="hljs-attr">parentId</span>: <span class="hljs-string">'43'</span> },
    { <span class="hljs-attr">title</span>: <span class="hljs-string">'节点5'</span>, <span class="hljs-attr">id</span>: <span class="hljs-string">'5'</span>, <span class="hljs-attr">parentId</span>: <span class="hljs-literal">null</span> }
  ]
})
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fx-extends%2Fvxe-pc-ui" target="_blank" title="https://gitee.com/x-extends/vxe-pc-ui" ref="nofollow noopener noreferrer">gitee.com/x-extends/v…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[零基础指南：为您的网站正确配置SSL证书，只需三步]]></title>    <link>https://juejin.cn/post/7581844141668368424</link>    <guid>https://juejin.cn/post/7581844141668368424</guid>    <pubDate>2025-12-10T05:24:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581844141668368424" data-draft-id="7581814484065124404" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="零基础指南：为您的网站正确配置SSL证书，只需三步"/> <meta itemprop="keywords" content="面试,CSS"/> <meta itemprop="datePublished" content="2025-12-10T05:24:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户78236167743"/> <meta itemprop="url" content="https://juejin.cn/user/458937554444512"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            零基础指南：为您的网站正确配置SSL证书，只需三步
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/458937554444512/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户78236167743
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T05:24:36.000Z" title="Wed Dec 10 2025 05:24:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h4 data-id="heading-0"><strong>第一步：申请SSL证书</strong></h4>
<ol>
<li>
<p><strong>选择证书类型</strong></p>
<ul>
<li><strong>个人/小型网站</strong>：选择域名验证证书（DV），仅需验证域名所有权，最快10分钟颁发。</li>
<li><strong>企业/中型网站</strong>：选企业验证证书（OV），需提交营业执照等信息，增强用户信任。</li>
<li><strong>大型电商平台</strong>：选扩展验证证书（EV），地址栏显示企业名称，安全级别最高。</li>
<li><strong>多域名/子域名场景</strong>：可选通配符证书（覆盖主域及所有子域名）或多域名证书（SAN证书）。</li>
</ul>
</li>
<li>
<p><strong>免费申请渠道</strong></p>
<ul>
<li><strong>JoySSL</strong>等平台提供免费DV证书（有效期通常1年），个人用户可直接申请，申请时<strong>必须填写注册码230959</strong>。</li>
</ul>
</li>
<li>
<p><strong>域名验证</strong></p>
<ul>
<li>通过DNS记录添加TXT解析（如阿里云需在域名解析后台添加指定记录）或文件验证（上传指定文件到网站根目录）。</li>
</ul>
</li>
</ol>
<hr/>
<h4 data-id="heading-1"><strong>第二步：安装与配置SSL证书</strong></h4>
<ol>
<li>
<p><strong>上传证书文件</strong></p>
<ul>
<li>
<p>将下载的证书解压后，找到以下文件：</p>
<ul>
<li><strong>证书文件</strong>（.crt或.pem）：包含公钥信息。</li>
<li><strong>私钥文件</strong>（.key）：用于解密数据，需妥善保管。</li>
<li><strong>中间证书</strong>（.crt或.pem）：建立证书链，增强兼容性。</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>服务器配置示例</strong></p>
<ul>
<li>
<p><strong>Nginx</strong>：<br/>
编辑配置文件（如<code>/etc/nginx/sites-available/yourdomain</code>），添加：</p>
<pre><code class="hljs language-ini" lang="ini">        
nginx复制代码
server {
    listen 443 ssl<span class="hljs-comment">;</span>
    server_name yourdomain.com<span class="hljs-comment">;</span>
    ssl_certificate /path/to/yourdomain.crt<span class="hljs-comment">;</span>
    ssl_certificate_key /path/to/yourdomain.key<span class="hljs-comment">;</span>
    ssl_trusted_certificate /path/to/CA_bundle.crt<span class="hljs-comment">;</span>
}


    
</code></pre>
<p>保存后执行 <code>sudo systemctl restart nginx</code> 。</p>
</li>
<li>
<p><strong>Apache</strong>：<br/>
修改配置文件（如<code>/etc/apache2/sites-available/yourdomain.conf</code>），添加：</p>
<pre><code class="hljs language-vbnet" lang="vbnet">        
apache复制代码
SSLEngine <span class="hljs-keyword">on</span>
SSLCertificateFile /path/<span class="hljs-keyword">to</span>/yourdomain.crt
SSLCertificateKeyFile /path/<span class="hljs-keyword">to</span>/yourdomain.<span class="hljs-keyword">key</span>
SSLCertificateChainFile /path/<span class="hljs-keyword">to</span>/CA_bundle.crt


    
</code></pre>
<p>重启服务：<code>sudo systemctl restart apache2</code> 。</p>
</li>
<li>
<p><strong>IIS服务器</strong>：<br/>
通过“Internet信息服务(IIS)管理器”导入PFX格式证书，绑定端口443并选择对应证书。</p>
</li>
</ul>
</li>
<li>
<p><strong>开启HTTPS强制跳转</strong></p>
<ul>
<li>
<p><strong>Nginx</strong>：在80端口配置中添加：</p>
<pre><code class="hljs language-perl" lang="perl">        
nginx复制代码
server {
    <span class="hljs-keyword">listen</span> <span class="hljs-number">80</span>;
    server_name yourdomain.com;
    <span class="hljs-keyword">return</span> <span class="hljs-number">301</span> https:<span class="hljs-regexp">//</span>$server_name$request_uri;
}


    
</code></pre>
</li>
<li>
<p><strong>Apache</strong>：在<code>.htaccess</code>文件中添加：</p>
<pre><code class="hljs language-perl" lang="perl">        
apache复制代码
RewriteEngine On
RewriteCond %{HTTPS} off
RewriteRule ^(.*)$ https:<span class="hljs-regexp">//</span>%<span class="hljs-string">{HTTP_HOST}%{REQUEST_URI}</span> [L,R=<span class="hljs-number">301</span>]


    
</code></pre>
</li>
</ul>
</li>
</ol>
<hr/>
<h4 data-id="heading-2"><strong>第三步：测试与优化</strong></h4>
<ol>
<li>
<p><strong>验证安装</strong></p>
<ul>
<li>浏览器访问<code>https://yourdomain.com</code>，检查地址栏是否显示安全锁图标。</li>
<li>使用在线工具检测漏洞，确保评级为A+。</li>
</ul>
</li>
<li>
<p><strong>修复混合内容问题</strong></p>
<ul>
<li>确保网页内所有图片、脚本、样式表均使用<code>https://</code>链接，避免浏览器警告。</li>
</ul>
</li>
<li>
<p><strong>定期维护</strong></p>
<ul>
<li>设置日历提醒，在证书到期前30天续签（免费证书需每年更新）。</li>
<li>若更换服务器或吊销证书，及时在云平台控制台操作注销旧证书。</li>
</ul>
</li>
</ol>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[石化行业软件公司用 NocoBase 把交付效率提升 70%]]></title>    <link>https://juejin.cn/post/7581751726506213419</link>    <guid>https://juejin.cn/post/7581751726506213419</guid>    <pubDate>2025-12-10T05:43:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581751726506213419" data-draft-id="7581751726506197035" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="石化行业软件公司用 NocoBase 把交付效率提升 70%"/> <meta itemprop="keywords" content="开源,低代码,人工智能"/> <meta itemprop="datePublished" content="2025-12-10T05:43:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="NocoBase"/> <meta itemprop="url" content="https://juejin.cn/user/180779873743566"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            石化行业软件公司用 NocoBase 把交付效率提升 70%
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/180779873743566/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    NocoBase
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T05:43:47.000Z" title="Wed Dec 10 2025 05:43:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>原文链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.nocobase.com%2Fcn%2Fblog%2Fsoftware-vendor-boosts-delivery-efficiency-with-nocobase" target="_blank" title="https://www.nocobase.com/cn/blog/software-vendor-boosts-delivery-efficiency-with-nocobase" ref="nofollow noopener noreferrer">www.nocobase.com/cn/blog/sof…</a></p>
<h2 data-id="heading-0">引言</h2>
<p>本案例展示了 NocoBase 在大型行业软件架构中的<strong>补充能力</strong>。即便是在拥有强大自研能力的软件企业中，轻量级开源无代码/低代码依然是解决长尾交付难题的最佳选择。</p>
<h2 data-id="heading-1">从石化行业到 ToB 软件</h2>
<p>石化行业的数字化有一个非常鲜明的特征：<strong>复杂、差异大、标准难落地、业务变化频繁</strong>。</p>
<p>不同工厂的工艺路线、装置规模、生产组织方式、安全管理体系都可能完全不同。哪怕是同样一条巡检路线、同样一套隐患整改制度，不同企业的执行细节也完全无法统一。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c07d90ea97e64fe78e259cb9ae5116cc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTm9jb0Jhc2U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765950226&amp;x-signature=u7x0E%2BT6UBRrcDymkLP9V1BVT8A%3D" alt="image.png" loading="lazy"/></p>
<p>而实际上，这不仅仅属于石化行业，而是大部分 To B 软件厂商，在实际业务中几乎都会遇到类似的挑战。</p>
<h2 data-id="heading-2">石化行业软件公司面临的挑战</h2>
<p>某科技公司（应客户要求匿名）是一家深耕石化行业的 ToB 软件企业。多年来，他们坚持自主研发，业务覆盖国内外数百家大型石化企业，是行业数字化领域的领先者。他们内部拥有成熟的自研低代码引擎，专门用于承载流程和表单类场景。</p>
<p>在持续推进项目交付的过程中，他们逐渐发现一些在石化行业普遍存在、同时也是许多 ToB 软件公司共同面临的挑战。</p>
<ol>
<li>
<h3 data-id="heading-3"><strong>定制需求成为常态</strong></h3>
</li>
</ol>
<p>无论产品设计多么周全，总会碰到无法满足客户需求的部分。</p>
<p>石化行业更明显：安全管理、隐患流程、承包商管理、作业票审批等场景的差异性极大，导致客户经常提出各种微调或个性化需求。</p>
<p>对软件公司而言，这些需求无法满足很有可能就无法通过招标。</p>
<p>并且，如果将定制功能放进主产品，将会污染产品代码、破坏版本稳定性。而单独开发一套带来的问题则是成本高且可维护性差。</p>
<ol start="2">
<li>
<h3 data-id="heading-4"><strong>自研低代码平台能力有限</strong></h3>
</li>
</ol>
<p>他们对不同低代码产品的能力边界非常清晰。自建的低代码平台定位为解决<strong>基础流程与表单类场景</strong>。但一些数据处理、交互灵活类的个性化需求就无法满足。</p>
<ol start="3">
<li>
<h3 data-id="heading-5"><strong>多系统数据割裂，集成成本高</strong></h3>
</li>
</ol>
<p>石化企业常年累积了大量系统（安环、设备、巡检、DCS、视频等），数据标准不统一、接口差异大，跨系统打通成本远高于应用层开发。</p>
<ol start="4">
<li>
<h3 data-id="heading-6"><strong>研发资源被不断稀释</strong></h3>
</li>
</ol>
<p>项目制交付、小模块补丁式需求持续占用研发时间，使团队难以专注核心能力建设。</p>
<h2 data-id="heading-7"><strong>选择新的低代码产品</strong></h2>
<p>在项目交付不断累积、内部自研平台能力无法满足后，他们开始系统性地评估市场上的各类低代码工具。他们希望找到一种能够：</p>
<ul>
<li>不干扰主产品</li>
<li>承载复杂且差异化场景</li>
<li>支撑跨系统数据整合</li>
<li>降低前后端协作成本</li>
<li>具备长期可扩展性</li>
</ul>
<p>在多轮试用与对比之后，他们最终选择了 <strong>NocoBase</strong>。</p>
<p>主要原因包括：</p>
<p><strong>1. 开源架构，可控性强</strong></p>
<p>对 ToB 软件公司而言，可控性是关键。即使未来场景演变或需求变深，也能够在代码层面进行定制和扩展，而不受平台限制。</p>
<p><strong>2. 多数据源支持，使跨系统贯通成为可能</strong></p>
<p>石化企业系统众多、数据分散，多数据源能力让他们能够在一个应用层中整合外部系统的数据，构建统一的业务视图和流程链路。</p>
<p><strong>3. 插件体系完善，扩展能力强且规范统一</strong></p>
<p>NocoBase 的插件机制，使他们能够为复杂需求快速构建独立模块，而不影响主产品结构。同时扩展逻辑清晰可控，便于长期维护。</p>
<p><strong>4. 权限、API 网关、多语言等底层能力接近企业级应用要求</strong></p>
<p>这些能力让他们能够在同一平台上支撑更复杂的角色体系、安全要求和开放场景，更适合行业级系统建设。</p>
<h2 data-id="heading-8">NocoBase 在企业内的两大核心使用场景</h2>
<h3 data-id="heading-9">场景一：客户需求扩展</h3>
<p>NocoBase 非常适合用来实现客户偶尔提出的一些<strong>与主产品无冲突但需要快速落地</strong>的需求。例如：在原系统菜单下扩展一个小页面，满足特有的业务步骤。</p>
<p>这些需求往往具有几个特点：</p>
<ul>
<li><strong>个性化非常强</strong>，没有可复制性</li>
<li><strong>不适合放进主产品</strong>，否则会破坏版本结构</li>
<li><strong>写代码也不划算</strong>，成本高、维护难</li>
<li>客户却<strong>明确要求必须解决</strong>（招标条款、项目验收或实际生产需要）</li>
</ul>
<p>而使用 NocoBase 后，他们形成了一种新的交付模式：</p>
<ul>
<li>在 NocoBase 中快速构建小模块</li>
<li>将用户体系、权限与数据同步到主产品</li>
<li>将模块无缝嵌入原系统菜单或页面结构</li>
<li>客户看到的是统一体验，而底层完全解耦</li>
</ul>
<p><strong>成果</strong></p>
<ul>
<li><strong>相同规模的需求扩展，人力成本下降约 70%</strong></li>
<li>不再需要前后端配合，大多数扩展由一位技术同事即可独立完成</li>
<li>大幅减少对主产品研发节奏的干扰</li>
</ul>
<h3 data-id="heading-10"><strong>场景二：内部管理工具</strong></h3>
<p>随着公司规模扩大、业务流程演进，内部管理系统的需求不断变化。</p>
<p>但让研发团队为内部需求开发系统，会直接影响主产品迭代；而采购商业 SaaS 又难以匹配公司自身流程。</p>
<p>NocoBase 在这里承担了一个“轻量内部系统平台”的角色：</p>
<ul>
<li>内部业务团队可以直接配置基础结构</li>
<li>多数场景无需前后端协作</li>
<li>小模块可随流程变化灵活调整</li>
<li>完全不占用核心研发产能</li>
</ul>
<p><strong>成果</strong></p>
<ul>
<li>主产品团队保持专注</li>
<li>内部系统建设速度加快</li>
<li>流程管理更贴近实际业务</li>
<li>整体组织效率提升，而研发压力没有增加</li>
</ul>
<h2 data-id="heading-11">结语</h2>
<p>ToB 软件企业的竞争核心始终是<strong>核心能力产品力和健康的项目利润率。</strong></p>
<p>该企业通过引入 NocoBase 明确了这一战略取舍：</p>
<ol>
<li><strong>聚焦核心研发：</strong> 将核心研发团队的精力从长尾需求中解脱出来，确保 100% 专注于高壁垒、高价值的核心系统升级。</li>
<li><strong>确保定制利润：</strong> 将零散的定制化需求转移到低成本、高效率的 NocoBase，极大地提高了项目交付阶段的毛利率。</li>
<li><strong>架构纯粹化：</strong> 实现了<strong>自研核心 + NocoBase 扩展的双模架构</strong>。主产品代码库保持稳定、纯净，产品迭代完全不受定制项目的拖累。</li>
</ol>
<p>在这样的路径下，企业既<strong>能保持产品的长期竞争力，又能以极低成本应对不断变化的一线业务。</strong></p>
<p><strong>更多 NocoBase 的用户故事：</strong></p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.nocobase.com%2Fcn%2Fblog%2Fan-erp-built-with-nocobase" target="_blank" title="https://www.nocobase.com/cn/blog/an-erp-built-with-nocobase" ref="nofollow noopener noreferrer">社区用户分享：用 NocoBase 搭建可落地的 ERP </a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.nocobase.com%2Fcn%2Fblog%2Fshenzhen-chuanglianyun-tech-development-methodology" target="_blank" title="https://www.nocobase.com/cn/blog/shenzhen-chuanglianyun-tech-development-methodology" ref="nofollow noopener noreferrer">8 人团队如何效率拉满？——创联云的开发方法论</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.nocobase.com%2Fcn%2Fblog%2Fai-multimodal-platform" target="_blank" title="https://www.nocobase.com/cn/blog/ai-multimodal-platform" ref="nofollow noopener noreferrer">华数传媒用 NocoBase 快速搭建 AI 多模态研发平台</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.nocobase.com%2Fcn%2Fblog%2Fnocobase-in-russia" target="_blank" title="https://www.nocobase.com/cn/blog/nocobase-in-russia" ref="nofollow noopener noreferrer">俄罗斯合作伙伴 Mobx，用 NocoBase 交付多场景方案</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.nocobase.com%2Fcn%2Fblog%2Funiversity-course" target="_blank" title="https://www.nocobase.com/cn/blog/university-course" ref="nofollow noopener noreferrer">NocoBase 走进德国大学课堂</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.nocobase.com%2Fcn%2Fblog%2Fed" target="_blank" title="https://www.nocobase.com/cn/blog/ed" ref="nofollow noopener noreferrer">NocoBase 如何成为 ED 的技术底座，支撑内部系统到商业化产品？</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.nocobase.com%2Fcn%2Fblog%2Fclassact" target="_blank" title="https://www.nocobase.com/cn/blog/classact" ref="nofollow noopener noreferrer">数十万条数据秒级响应——Classact 在 Kubernetes 上的 NocoBase 应用实践</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.nocobase.com%2Fcn%2Fblog%2Fbielcrystal" target="_blank" title="https://www.nocobase.com/cn/blog/bielcrystal" ref="nofollow noopener noreferrer">年产量 18.5 亿，伯恩光学背后的数字敏捷工厂</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.nocobase.com%2Fcn%2Fblog%2Fdistinct-healthcare" target="_blank" title="https://www.nocobase.com/cn/blog/distinct-healthcare" ref="nofollow noopener noreferrer">卓正医疗如何用 NocoBase 搭建“家庭医生式”服务体系？</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Node.js环境变量配置实战：手把手教你构建高效、安全的开发环境]]></title>    <link>https://juejin.cn/post/7581844141668548648</link>    <guid>https://juejin.cn/post/7581844141668548648</guid>    <pubDate>2025-12-10T05:44:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581844141668548648" data-draft-id="7581870491763540020" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Node.js环境变量配置实战：手把手教你构建高效、安全的开发环境"/> <meta itemprop="keywords" content="后端,Node.js"/> <meta itemprop="datePublished" content="2025-12-10T05:44:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Java水解"/> <meta itemprop="url" content="https://juejin.cn/user/2441349519143037"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Node.js环境变量配置实战：手把手教你构建高效、安全的开发环境
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2441349519143037/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Java水解
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T05:44:32.000Z" title="Wed Dec 10 2025 05:44:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">引言：为什么环境变量如此重要？</h3>
<p>想象一下这个场景：你正在开发一个Node.js应用，需要[连接数据库]。你可能会这样写：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// ❌ 危险！不要这样做！</span>
<span class="hljs-type">const</span> dbConfig = {
    host: <span class="hljs-string">'localhost'</span>,
    port: <span class="hljs-number">3306</span>,
    user: <span class="hljs-string">'root'</span>,
    password: <span class="hljs-string">'mysecretpassword123'</span>,
    database: <span class="hljs-string">'myapp_dev'</span>
};
AI写代码
</code></pre>
<p>这段代码存在几个致命问题：</p>
<ol>
<li><strong>安全风险：</strong> 数据库密码直接暴露在代码中，一旦代码仓库（尤其是公开的GitHub）被泄露，后果不堪设想。</li>
<li><strong>环境耦合：</strong> 开发环境用<code>localhost</code>，生产环境可能用云数据库的公网IP。每次部署都要手动修改代码？</li>
<li><strong>协作困难：</strong> 团队成员的本地开发环境配置各不相同，如何保证每个人都能顺利运行项目？</li>
</ol>
<p><strong>环境变量（Environment Variables）</strong>  正是解决这些问题的“银弹”。它允许我们将配置信息与代码分离，实现：</p>
<ul>
<li><strong>安全性：</strong> 敏感信息（如密钥、密码）不进入代码仓库。</li>
<li><strong>灵活性：</strong> 轻松在不同环境（开发、测试、生产）间切换配置。</li>
<li><strong>可维护性：</strong> 配置集中管理，修改方便。</li>
</ul>
<hr/>
<h3 data-id="heading-1"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>一、 基础篇：理解 <code>process.env</code></h3>
<p>在Node.js中，所有环境变量都存储在全局对象 <code>process.env</code> 中。这是一个类似JavaScript对象的键值对集合。</p>
<h4 data-id="heading-2"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>1. 查看当前环境变量</h4>
<p>在终端中，你可以使用以下命令查看所有环境变量：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># Linux/macOS</span>
<span class="hljs-built_in">printenv</span>
 
<span class="hljs-comment"># Windows</span>
<span class="hljs-built_in">set</span>
AI写代码
</code></pre>
<p>在Node.js代码中，可以这样访问：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 查看所有环境变量</span>
console.<span class="hljs-built_in">log</span>(process.env);
 
<span class="hljs-comment">// 访问特定变量</span>
console.<span class="hljs-built_in">log</span>(process.env.PATH); <span class="hljs-comment">// 输出系统PATH</span>
console.<span class="hljs-built_in">log</span>(process.env.USER); <span class="hljs-comment">// 输出当前用户名</span>
AI写代码
</code></pre>
<h4 data-id="heading-3"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>2. 在运行时设置环境变量</h4>
<p>最简单的方法是在启动Node.js应用时，通过命令行前缀设置：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># Linux/macOS</span>
<span class="hljs-attr">PORT</span>=<span class="hljs-number">3000</span> NODE_ENV=development node app.js
 
<span class="hljs-comment"># Windows (cmd)</span>
set <span class="hljs-attr">PORT</span>=<span class="hljs-number">3000</span> &amp;&amp; set NODE_ENV=development &amp;&amp; node app.js
 
<span class="hljs-comment"># Windows (PowerShell)</span>
$env:<span class="hljs-attr">PORT</span>=<span class="hljs-number">3000</span><span class="hljs-comment">; $env:NODE_ENV="development"; node app.js</span>
AI写代码
</code></pre>
<p>然后在 <code>app.js</code> 中：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-type">const</span> PORT = process.env.PORT || <span class="hljs-number">3000</span>; <span class="hljs-comment">// 如果没有设置PORT，则使用默认值3000</span>
<span class="hljs-type">const</span> NODE_ENV = process.env.NODE_ENV || <span class="hljs-string">'development'</span>;
 
console.<span class="hljs-built_in">log</span>(`<span class="hljs-built_in">Server</span> running on port ${PORT} in ${NODE_ENV} mode`);
AI写代码
</code></pre>
<p><strong>小贴士：</strong>  <code>NODE_ENV</code> 是一个非常重要的环境变量，许多库（如Express）会根据它的值调整行为（例如，生产环境会关闭详细错误信息）。</p>
<hr/>
<h3 data-id="heading-4"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>二、 进阶篇：使用 <code>dotenv</code> 库实现配置文件化</h3>
<p>每次启动都要手动输入环境变量，显然不现实。<code>dotenv</code> 库可以让我们将环境变量存储在 <code>.env</code> 文件中，启动时自动加载。</p>
<h4 data-id="heading-5"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>1. 安装与初始化</h4>
<pre><code class="hljs">npm install dotenv
AI写代码
</code></pre>
<h4 data-id="heading-6"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>2. 创建 <code>.env</code> 文件</h4>
<p>在项目根目录创建 <code>.env</code> 文件：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># .env - 开发环境配置</span>
<span class="hljs-attr">PORT</span>=<span class="hljs-number">3000</span>
<span class="hljs-attr">NODE_ENV</span>=development
<span class="hljs-attr">DB_HOST</span>=localhost
<span class="hljs-attr">DB_PORT</span>=<span class="hljs-number">3306</span>
<span class="hljs-attr">DB_USER</span>=root
<span class="hljs-attr">DB_PASSWORD</span>=mysecretpassword123
<span class="hljs-attr">DB_NAME</span>=myapp_dev
<span class="hljs-attr">API_KEY</span>=sk_test_1234567890abcdef
AI写代码
</code></pre>
<h4 data-id="heading-7"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>3. 加载 <code>dotenv</code></h4>
<p>在应用的<strong>最开始</strong>（通常是 <code>app.js</code> 或 <code>server.js</code> 的第一行）引入并配置 <code>dotenv</code>：</p>
<pre><code class="hljs language-ini" lang="ini">// app.js
require('dotenv').config()<span class="hljs-comment">; // ⚠️ 必须是第一行！</span>
 
const <span class="hljs-attr">express</span> = require(<span class="hljs-string">'express'</span>)<span class="hljs-comment">;</span>
const <span class="hljs-attr">app</span> = express()<span class="hljs-comment">;</span>
 
const <span class="hljs-attr">PORT</span> = process.env.PORT || <span class="hljs-number">3000</span><span class="hljs-comment">;</span>
const <span class="hljs-attr">NODE_ENV</span> = process.env.NODE_ENV<span class="hljs-comment">;</span>
 
// ... 其他代码
AI写代码
</code></pre>
<p><strong>重要：</strong>  <code>dotenv.config()</code> 必须在任何使用 <code>process.env</code> 的代码之前执行。</p>
<h4 data-id="heading-8"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>4. 多环境配置：<code>.env.development</code>, <code>.env.production</code></h4>
<p>为了更好地管理不同环境，我们可以创建多个 <code>.env</code> 文件：</p>
<ul>
<li><code>.env</code> (通用配置，可被覆盖)</li>
<li><code>.env.local</code> (本地覆盖，通常不提交到Git)</li>
<li><code>.env.development</code> (开发环境)</li>
<li><code>.env.test</code> (测试环境)</li>
<li><code>.env.production</code> (生产环境)</li>
</ul>
<p><code>dotenv</code> 会根据 <code>NODE_ENV</code> 的值自动加载对应的文件。例如：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 启动开发环境</span>
<span class="hljs-attr">NODE_ENV</span>=development node app.js <span class="hljs-comment"># 会加载 .env 和 .env.development</span>
 
<span class="hljs-comment"># 启动生产环境</span>
<span class="hljs-attr">NODE_ENV</span>=production node app.js <span class="hljs-comment"># 会加载 .env 和 .env.production</span>
AI写代码
</code></pre>
<p><strong>.env.development 示例：</strong></p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># .env.development</span>
<span class="hljs-attr">NODE_ENV</span>=development
<span class="hljs-attr">PORT</span>=<span class="hljs-number">3000</span>
<span class="hljs-attr">DB_HOST</span>=localhost
<span class="hljs-attr">DB_NAME</span>=myapp_dev
<span class="hljs-comment"># 开发环境可能不需要密码，或使用简单密码</span>
<span class="hljs-attr">DB_PASSWORD</span>=devpass
AI写代码
</code></pre>
<p><strong>.env.production 示例：</strong></p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># .env.production</span>
<span class="hljs-attr">NODE_ENV</span>=production
<span class="hljs-attr">PORT</span>=<span class="hljs-number">8080</span>
<span class="hljs-attr">DB_HOST</span>=prod-db.myapp.com
<span class="hljs-attr">DB_NAME</span>=myapp_prod
<span class="hljs-comment"># 生产环境密码必须复杂，且不应出现在代码中</span>
<span class="hljs-attr">DB_PASSWORD</span>=<span class="hljs-variable">${DB_PROD_PASSWORD}</span> <span class="hljs-comment"># 使用系统环境变量</span>
AI写代码
</code></pre>
<hr/>
<h3 data-id="heading-9"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>三、 实战：构建一个健壮的配置管理模块</h3>
<p>[硬编码] <code>process.env.XXX</code> 在多处使用，既不优雅也容易出错。我们来创建一个专门的配置模块。</p>
<h4 data-id="heading-10"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>1. 创建 <code>config/index.js</code></h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// config/index.js</span>
require(<span class="hljs-string">'dotenv'</span>).config();
 
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Config</span> {
    <span class="hljs-keyword">constructor</span>() {
        <span class="hljs-keyword">this</span>.port = <span class="hljs-keyword">this</span>.<span class="hljs-keyword">get</span>(<span class="hljs-string">'PORT'</span>, <span class="hljs-number">3000</span>);
        <span class="hljs-keyword">this</span>.nodeEnv = <span class="hljs-keyword">this</span>.<span class="hljs-keyword">get</span>(<span class="hljs-string">'NODE_ENV'</span>, <span class="hljs-string">'development'</span>);
        <span class="hljs-keyword">this</span>.isProduction = <span class="hljs-keyword">this</span>.nodeEnv === <span class="hljs-string">'production'</span>;
        <span class="hljs-keyword">this</span>.isDevelopment = <span class="hljs-keyword">this</span>.nodeEnv === <span class="hljs-string">'development'</span>;
        <span class="hljs-keyword">this</span>.isTest = <span class="hljs-keyword">this</span>.nodeEnv === <span class="hljs-string">'test'</span>;
 
        <span class="hljs-keyword">this</span>.db = {
            host: <span class="hljs-keyword">this</span>.<span class="hljs-keyword">get</span>(<span class="hljs-string">'DB_HOST'</span>, <span class="hljs-string">'localhost'</span>),
            port: <span class="hljs-keyword">this</span>.<span class="hljs-keyword">get</span>(<span class="hljs-string">'DB_PORT'</span>, <span class="hljs-number">3306</span>),
            user: <span class="hljs-keyword">this</span>.<span class="hljs-keyword">get</span>(<span class="hljs-string">'DB_USER'</span>),
            password: <span class="hljs-keyword">this</span>.<span class="hljs-keyword">get</span>(<span class="hljs-string">'DB_PASSWORD'</span>),
            database: <span class="hljs-keyword">this</span>.<span class="hljs-keyword">get</span>(<span class="hljs-string">'DB_NAME'</span>)
        };
 
        <span class="hljs-keyword">this</span>.api = {
            key: <span class="hljs-keyword">this</span>.<span class="hljs-keyword">get</span>(<span class="hljs-string">'API_KEY'</span>)
        };
 
        <span class="hljs-comment">// 验证必要配置</span>
        <span class="hljs-keyword">this</span>.validate();
    }
 
    <span class="hljs-comment">/**
     * 获取环境变量，支持默认值
     * <span class="hljs-doctag">@param</span> {string} key - 环境变量键
     * <span class="hljs-doctag">@param</span> {*} defaultValue - 默认值
     * <span class="hljs-doctag">@returns</span> {*}
     */</span>
    <span class="hljs-keyword">get</span>(key, defaultValue = undefined) {
        <span class="hljs-keyword">return</span> process.env[key] || defaultValue;
    }
 
    <span class="hljs-comment">/**
     * 验证必要配置是否存在
     */</span>
    validate() {
        <span class="hljs-keyword">const</span> required = [<span class="hljs-string">'DB_USER'</span>, <span class="hljs-string">'DB_PASSWORD'</span>, <span class="hljs-string">'DB_NAME'</span>, <span class="hljs-string">'API_KEY'</span>];
        <span class="hljs-keyword">const</span> missing = [];
 
        required.forEach(key =&gt; {
            <span class="hljs-keyword">if</span> (!process.env[key]) {
                missing.push(key);
            }
        });
 
        <span class="hljs-keyword">if</span> (missing.length &gt; <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">throw</span> new Error(`Missing required environment variables: ${missing.join(<span class="hljs-string">', '</span>)}`);
        }
    }
}
 
<span class="hljs-comment">// 创建单例</span>
<span class="hljs-keyword">const</span> config = new Config();
module.exports = config;
AI写代码
</code></pre>
<h4 data-id="heading-11"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>2. 在应用中使用</h4>
<pre><code class="hljs language-ini" lang="ini">// app.js
const <span class="hljs-attr">config</span> = require(<span class="hljs-string">'./config'</span>)<span class="hljs-comment">;</span>
const <span class="hljs-attr">express</span> = require(<span class="hljs-string">'express'</span>)<span class="hljs-comment">;</span>
const <span class="hljs-attr">app</span> = express()<span class="hljs-comment">;</span>
 
app.listen(config.port, () =&gt; {
    console.log(`Server running on port ${config.port} in ${config.nodeEnv} mode`)<span class="hljs-comment">;</span>
})<span class="hljs-comment">;</span>
 
// 连接数据库示例
// const <span class="hljs-attr">mysql</span> = require(<span class="hljs-string">'mysql2'</span>)<span class="hljs-comment">;</span>
// const <span class="hljs-attr">connection</span> = mysql.createConnection(config.db)<span class="hljs-comment">;</span>
AI写代码
</code></pre>
<p><strong>优势：</strong></p>
<ul>
<li><strong>集中管理：</strong> 所有配置在一个地方。</li>
<li><strong>类型安全（部分）：</strong> 提供默认值，避免 <code>undefined</code> 错误。</li>
<li><strong>验证：</strong> 启动时检查必要配置，防止运行时崩溃。</li>
<li><strong>语义化：</strong> <code>config.db.host</code> 比 <code>process.env.DB_HOST</code> 更清晰。</li>
</ul>
<hr/>
<h3 data-id="heading-12"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>四、 安全与最佳实践</h3>
<h4 data-id="heading-13"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>1. <code>.gitignore</code> 是你的第一道防线</h4>
<p><strong>绝对不要</strong>将包含敏感信息的 <code>.env</code> 文件提交到版本控制系统！</p>
<p>在 <code>.gitignore</code> 文件中添加：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># Environment variables</span>
.<span class="hljs-built_in">env</span>
.env.local
.<span class="hljs-built_in">env</span>.*.<span class="hljs-built_in">local</span>
*.<span class="hljs-built_in">env</span>
AI写代码
</code></pre>
<p>只提交一个 <code>.env.example</code> 作为模板：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># .env.example - Copy this to .env and fill in your values</span>
<span class="hljs-attr">PORT</span>=<span class="hljs-number">3000</span>
<span class="hljs-attr">NODE_ENV</span>=development
<span class="hljs-attr">DB_HOST</span>=localhost
<span class="hljs-attr">DB_PORT</span>=<span class="hljs-number">3306</span>
<span class="hljs-attr">DB_USER</span>=
<span class="hljs-attr">DB_PASSWORD</span>=
<span class="hljs-attr">DB_NAME</span>=
<span class="hljs-attr">API_KEY</span>=
AI写代码
</code></pre>
<p>新成员只需复制 <code>.env.example</code> 为 <code>.env</code> 并填写自己的值。</p>
<h4 data-id="heading-14"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>2. 生产环境：永远不要依赖 <code>.env</code> 文件</h4>
<p>在生产服务器上，<strong>不要</strong>使用 <code>.env</code> 文件。应该通过以下方式设置环境变量：</p>
<ul>
<li>
<p><strong>操作系统级：</strong> 在服务器的 <code>~/.bashrc</code>, <code>/etc/environment</code> 中设置。</p>
</li>
<li>
<p><strong>容器化 (Docker)：</strong> 在 <code>docker run</code> 命令或 <code>docker-compose.yml</code> 中使用 <code>environment</code> 字段。</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># docker-compose.yml</span>
services:
  app:
    image: myapp:latest
    environment:
      - <span class="hljs-attr">NODE_ENV</span>=production
      - <span class="hljs-attr">PORT</span>=<span class="hljs-number">8080</span>
      - <span class="hljs-attr">DB_HOST</span>=prod-db
      - <span class="hljs-attr">DB_PASSWORD</span>=<span class="hljs-variable">${DB_PASSWORD}</span> <span class="hljs-comment"># 从主机环境或Secret读取</span>
AI写代码
</code></pre>
</li>
<li>
<p><strong>PaaS平台 (如Heroku, Vercel)：</strong> 在平台的控制台中设置环境变量。</p>
</li>
<li>
<p><strong>CI/CD管道：</strong> 在Jenkins、GitHub Actions等工具中配置Secrets。</p>
</li>
</ul>
<h4 data-id="heading-15"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>3. 使用 <code>cross-env</code> 解决跨平台兼容性</h4>
<p>如果你在Windows和Linux/macOS上开发，<code>cross-env</code> 可以让你用统一的命令设置环境变量。</p>
<pre><code class="hljs language-lua" lang="lua">npm install <span class="hljs-comment">--save-dev cross-env</span>
 
# <span class="hljs-built_in">package</span>.json
{
  <span class="hljs-string">"scripts"</span>: {
    <span class="hljs-string">"dev"</span>: <span class="hljs-string">"cross-env NODE_ENV=development node app.js"</span>,
    <span class="hljs-string">"start"</span>: <span class="hljs-string">"cross-env NODE_ENV=production node app.js"</span>
  }
}
AI写代码
</code></pre>
<h4 data-id="heading-16"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>4. 避免在客户端暴露敏感信息</h4>
<p>如果使用Next.js、Nuxt.js等同构框架，注意：</p>
<ul>
<li>以 <code>NEXT_PUBLIC_</code> 开头的环境变量会被暴露到前端。</li>
<li>敏感信息（如数据库密码、API密钥）<strong>绝不能</strong>以 <code>NEXT_PUBLIC_</code> 开头。</li>
</ul>
<hr/>
<h3 data-id="heading-17"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>五、 高级技巧：动态配置与CI/CD集成</h3>
<h4 data-id="heading-18"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>1. 动态加载配置</h4>
<p>有时配置需要根据运行时条件动态生成：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// config/index.js</span>
<span class="hljs-comment">// ...</span>
<span class="hljs-keyword">this</span>.redisUrl = <span class="hljs-keyword">this</span>.isProduction 
    ? `redis:<span class="hljs-comment">//:${process.env.REDIS_PASSWORD}@prod-redis:6379` </span>
    : <span class="hljs-string">'redis://localhost:6379'</span>;
<span class="hljs-comment">// ...</span>
AI写代码
</code></pre>
<h4 data-id="heading-19"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>2. CI/CD中的环境变量</h4>
<p>在GitHub Actions中使用Secrets：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># .github/workflows/deploy.yml</span>
<span class="hljs-attr">jobs:</span>
  <span class="hljs-attr">deploy:</span>
    <span class="hljs-attr">steps:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Set</span> <span class="hljs-string">up</span> <span class="hljs-string">Node.js</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/setup-node@v3</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">node-version:</span> <span class="hljs-string">'18'</span>
      
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Install</span> <span class="hljs-string">dependencies</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">npm</span> <span class="hljs-string">ci</span>
      
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Run</span> <span class="hljs-string">tests</span>
        <span class="hljs-attr">env:</span>
          <span class="hljs-attr">NODE_ENV:</span> <span class="hljs-string">test</span>
          <span class="hljs-attr">DB_PASSWORD:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.DB_TEST_PASSWORD</span> <span class="hljs-string">}}</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">npm</span> <span class="hljs-string">test</span>
      
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Deploy</span> <span class="hljs-string">to</span> <span class="hljs-string">Production</span>
        <span class="hljs-attr">if:</span> <span class="hljs-string">github.ref</span> <span class="hljs-string">==</span> <span class="hljs-string">'refs/heads/main'</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          # 部署命令，使用生产环境变量
          NODE_ENV=production DB_PASSWORD=${{ secrets.DB_PROD_PASSWORD }} npm run deploy
</span>        <span class="hljs-attr">env:</span>
          <span class="hljs-attr">DB_PASSWORD:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.DB_PROD_PASSWORD</span> <span class="hljs-string">}}</span>
<span class="hljs-string">AI写代码</span>
</code></pre>
<hr/>
<h3 data-id="heading-20"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>六、 总结</h3>
<p>通过本文的系统学习，你应该已经掌握了Node.js环境变量配置的核心技能：</p>
<ol>
<li><strong>基础：</strong> 理解 <code>process.env</code> 和命令行设置。</li>
<li><strong>核心：</strong> 使用 <code>dotenv</code> 库和 <code>.env</code> 文件实现配置文件化。</li>
<li><strong>进阶：</strong> 创建健壮的配置模块，实现集中管理与验证。</li>
<li><strong>安全：</strong> 通过 <code>.gitignore</code> 保护敏感信息，生产环境使用系统级变量。</li>
<li><strong>实践：</strong> 将环境变量无缝集成到Docker、CI/CD等现代开发流程中。</li>
</ol>
<p><strong>记住：</strong>  良好的配置管理是构建专业、可维护、安全的Node.js应用的基石。不要再让硬编码的密码和混乱的配置拖慢你的开发效率了！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React Native 图片机制深度解析：设计哲学、性能优化与避坑指南]]></title>    <link>https://juejin.cn/post/7581786379804409891</link>    <guid>https://juejin.cn/post/7581786379804409891</guid>    <pubDate>2025-12-10T06:02:12.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581786379804409891" data-draft-id="7581786379804377123" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React Native 图片机制深度解析：设计哲学、性能优化与避坑指南"/> <meta itemprop="keywords" content="前端,React Native"/> <meta itemprop="datePublished" content="2025-12-10T06:02:12.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="皮蛋小精灵"/> <meta itemprop="url" content="https://juejin.cn/user/219558056559278"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React Native 图片机制深度解析：设计哲学、性能优化与避坑指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/219558056559278/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    皮蛋小精灵
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T06:02:12.000Z" title="Wed Dec 10 2025 06:02:12 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">1. 核心哲学：体验优先于便利 (UX &gt; DX)</h3>
<p>React Native 在图片处理上与 Web 浏览器有着本质的不同。RN 宁愿让开发者多写一点代码，也要保证用户体验的极致顺滑。</p>
<ul>
<li>
<p><strong>拒绝“布局抖动” (No Layout Shift)：</strong></p>
<ul>
<li><strong>Web 痛点：</strong> 浏览器加载图片时默认是 0x0，下载完瞬间撑开，导致页面跳动。</li>
<li><strong>RN 策略：</strong> 强制要求开发者预先指定远程图片的宽高。这意味着图片加载前位置就已留好，加载后只是填空，界面纹丝不动。</li>
</ul>
</li>
<li>
<p><strong>例外：</strong> 本地静态图片（<code>require('./icon.png')</code>）因在编译时已知尺寸，可自动推断宽高。</p>
</li>
</ul>
<h3 data-id="heading-1">2. 底层性能：为了不卡顿 (Performance)</h3>
<p>RN 在幕后做了大量工作，确保即使加载高清大图，App 的 UI 线程（Main Thread）也不会阻塞。</p>
<ul>
<li>
<p><strong>后台解码 (Off-thread Decoding)：</strong></p>
<ul>
<li>图片解码（JPEG/PNG转像素）非常耗时。RN 将其移至后台线程执行，解码完成后再送回主线程显示。这避免了 Web 常见的“滚动时因加载图片导致的掉帧”。</li>
</ul>
</li>
<li>
<p><strong>iOS 智能选图 (The 50% Rule)：</strong></p>
<ul>
<li>从相册加载图片时，RN 不会无脑加载原图（太费内存），也不会选太小的图（太糊）。</li>
<li>它会自动寻找第一张<strong>比显示区域大 50% 以上</strong>的缩略图版本。既保证了清晰度（避免拉伸模糊），又最大程度节省了内存。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-2">3. 架构设计：面向未来的扩展性 (Extensibility)</h3>
<ul>
<li>
<p><strong>Source 是对象而非字符串：</strong></p>
<ul>
<li><code>&lt;Image source={{uri: '...'}} /&gt;</code> 的设计看似繁琐，实则为了扩展。</li>
<li>它允许携带元数据（Metadata），并为未来特性（如雪碧图裁剪 <code>crop</code> 属性）预留了接口，保证了代码的向后兼容性。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-3">4. iOS 实战：避坑与进阶调优 (iOS Specifics)</h3>
<p>针对 iOS 平台，有一些特殊的限制和高级配置需要注意：</p>
<ul>
<li>
<p><strong>圆角样式的坑：</strong></p>
<ul>
<li><strong>问题：</strong> <code>borderTopLeftRadius</code> 等单独圆角属性在 iOS <code>&lt;Image&gt;</code> 上往往不生效。</li>
<li><strong>解法：</strong> 使用“外部裁剪法”。将 Image 包裹在 <code>&lt;View&gt;</code> 中，在 View 上设置圆角并加上 <code>overflow: 'hidden'</code>。</li>
</ul>
</li>
<li>
<p><strong>手动控制缓存 (Cache Limits)：</strong></p>
<ul>
<li><strong>能力：</strong> 可以在 <code>AppDelegate.m</code> 中调用 <code>RCTSetImageCacheLimits</code>。</li>
<li><strong>参数：</strong> 可以设定“单张图片最大体积”（超过不缓存）和“总缓存池上限”（超过踢掉旧图），从而在内存紧张或图片密集的 App 中找到性能平衡点。</li>
</ul>
</li>
</ul>
<hr/>
<h3 data-id="heading-4">总结</h3>
<p>React Native 的 Image 组件不仅仅是一个简单的 UI 元素，它是一个<strong>高度封装的、自带性能优化策略的子系统</strong>。理解这些机制，能帮你写出即便在数千张图片的瀑布流中依然如丝般顺滑的 App。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>