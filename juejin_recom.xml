<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[解析 Temperature 与 Top P：如何掌控大模型的输出随机性]]></title>    <link>https://juejin.cn/post/7605051886435287103</link>    <guid>https://juejin.cn/post/7605051886435287103</guid>    <pubDate>2026-02-11T07:04:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605051886435287103" data-draft-id="7605142381152370751" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="解析 Temperature 与 Top P：如何掌控大模型的输出随机性"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-02-11T07:04:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="奇舞精选"/> <meta itemprop="url" content="https://juejin.cn/user/4388906147515367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            解析 Temperature 与 Top P：如何掌控大模型的输出随机性
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4388906147515367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    奇舞精选
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-11T07:04:47.000Z" title="Wed Feb 11 2026 07:04:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    25
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h4 data-id="heading-0">前言</h4>
<img src="https://p1.ssl.qhimg.com/d/inn/d231d4dc137f/WechatIMG7050.jpg" loading="lazy"/>
<p>在AI时代，大语言模型（LLM）如 <code>ChatGPT</code> 或<code>Gemini </code> 已成为我们的“数字大脑”。如果你经常使用这些大模型，那你肯定见过Temperature 和 TopP 这两个参数。比如 <code>ChatGPT</code> 的API文档就有介绍：</p>
<p>根据描述：</p>
<p><strong>Temperature（温度）：</strong> 取值在 0 到 2 之间。较高的值（如 0.8）将使输出更加随机，而较低的值（如 0.2）将使输出更加集中和确定。</p>
<p><strong>Top P（核采样）：</strong> 温度采样的替代方法。模型仅考虑概率质量排名前 P% 的标记的结果。例如，0.1 表示仅考虑概率排名前 10% 的标记。</p>
<p>看到这里，你可能觉得已经懂了：<em>它们就是控制随机性的开关嘛。值越高越发散，值越低越保守。</em></p>
<p>但仔细一想，问题来了：</p>
<ol>
<li><strong>为什么</strong>值越高越随机，越低越稳定？背后的数学原理是什么？</li>
<li>如果它们控制的都是随机性，<strong>为什么需要两个参数</strong>？</li>
<li>如果把一个调高，另一个调低，效果会中和吗？</li>
<li>它们是协同工作，还是在完全不同的维度产生影响？</li>
</ol>
<p>带着这些问题，我们将拆解这两个“黑盒子”，从大模型的底层生成原理出发，彻底搞懂它们如何掌控 AI 的每一次开口。</p>
<h4 data-id="heading-1">大模型回答的“三步走”流程</h4>
<p>要搞懂这两个参数，必须先看大模型是如何预测下一个字的。本质上，Transformer 的核心任务朴素得像猜谜：<strong>根据上文，预测下一个最有可能出现的词（Token），重复此过程直到生成结束符。</strong></p>
<p>这个过程可以拆解为三个关键步骤：<strong>生成分数 (Logits)</strong> --&gt; <strong>转换概率 (Softmax)</strong>  --&gt;<strong>加权采样 (Sampling)</strong>。</p>
<img src="https://p3.ssl.qhimg.com/d/inn/6ecebc3b945b/resource.png" alt="截屏2025-12-04 11.03.52" loading="lazy"/>
<p><strong>步骤1: 生成分数（<code>Logits</code>）</strong></p>
<p>我们用一个简单例子说明：当用户提问“<strong>帮我推荐一个学习 AI 大模型技术的频道</strong>”时，模型会扫描它词表里成千上万个词，并为每一个词打分。这个分数在 AI 领域被称为 <strong>Logits</strong>。</p>
<p>假设模型打分后，排名前五的词如下：</p>
<ul>
<li>AI：4.2</li>
<li>科技：4.1</li>
<li>奇舞：3.9</li>
<li>自行车：1.8</li>
<li>Hello：1.4</li>
</ul>
<p>打分过程比较复杂，好在跟我们今天的内容关系不大，我们可以暂且忽略。</p>
<blockquote>
<p>需要注意的是，在大模型预测下一个词时，会给它所认识的所有词打分，词的总数量大概是在几万到几十万左右。为了方便理解，我们这里只显示分数最高的前五个，其余的全部省略。</p>
</blockquote>
<p>在大型语言模型（LLM）完成对所有词汇的评分后，下一步的关键在于如何从这些分数中选择最合适的词作为输出。一种直观且常用的方法是选择得分最高的词。</p>
<p>例如，假设模型在预测序列中的下一个词时，对词汇表中的每个词都进行了评分，比如上面例子中的 "AI" 这个词获得了最高分。那么，模型会选择 "AI" 作为当前步骤的输出。</p>
<p>接下来，模型会将 "AI" 这个词添加到输入序列中，并再次进行下一个词的预测。这意味着模型会重新评估词汇表中的每个词，并为它们分配新的分数。同样，模型会选择得分最高的词作为下一个输出。</p>
<p>这个过程会不断重复，模型逐个输出每一个词，并将每个新生成的词添加到输入序列中，以影响后续词的预测。这种迭代式的生成过程会持续进行，直到模型输出一个特殊的结束标识符（例如 ""）为止。结束标识符的出现标志着文本生成的完成。</p>
<p><img src="https://p4.ssl.qhimg.com/d/inn/b5fa6dc9ef61/theory.png" alt="截屏2025-12-08 11.10.08" loading="lazy"/></p>
<p>虽然选择得分最高的词是一种简单直接的解码策略，但它也存在一些局限性：</p>
<ul>
<li><strong>缺乏多样性：</strong> 这种策略倾向于选择最常见的词，导致生成的文本缺乏多样性和创造性。模型可能会陷入重复的模式，生成平淡无奇的内容。</li>
<li><strong>对噪声敏感：</strong> 如果模型在某个步骤中给出了错误的高分，那么这个错误可能会被放大，导致后续生成的文本偏离预期。</li>
<li><strong>忽略上下文：</strong> 虽然模型会将之前生成的词作为输入，但简单地选择最高分可能会忽略更长远的上下文信息，导致生成的文本不连贯或不自然。</li>
</ul>
<p>这样简单的选择分数最高的词显然是不合适的，我们需要给其他词，比如“科技”或“奇舞”一定机会。聪明的你肯定想到了，把这些词的分数转为概率，让模型按照概率来预测下一个词。提到转换概率，这就轮到大名鼎鼎的 <strong>Softmax 函数</strong> 登场了。</p>
<p><strong>步骤2: 转换概率（Softmax函数）</strong></p>
<p><code>Softmax</code> 公式：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>Softmax</mtext><mo stretchy="false">(</mo><msub><mi>z</mi><mi>i</mi></msub><mo stretchy="false">)</mo><mo>=</mo><mfrac><msup><mi>e</mi><mrow><msub><mi>z</mi><mi>i</mi></msub><mi mathvariant="normal">/</mi><mi>T</mi></mrow></msup><mrow><munderover><mo>∑</mo><mrow><mi>j</mi><mo>=</mo><mn>1</mn></mrow><mi>K</mi></munderover><msup><mi>e</mi><mrow><msub><mi>z</mi><mi>j</mi></msub><mi mathvariant="normal">/</mi><mi>T</mi></mrow></msup></mrow></mfrac></mrow><annotation encoding="application/x-tex">\text{Softmax}(z_i) = \frac{e^{z_i/T}}{\sum_{j=1}^{K} e^{z_j/T}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord text"><span class="mord">Softmax</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.044em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.872em;vertical-align:-1.307em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.565em;"><span style="top:-2.1288em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9812em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4358em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8301em;"><span style="top:-3.0051em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3281em;"><span style="top:-2.357em;margin-left:-0.044em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2819em;"><span/></span></span></span></span></span><span class="mord mtight">/</span><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3281em;"><span style="top:-2.357em;margin-left:-0.044em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span/></span></span></span></span></span><span class="mord mtight">/</span><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.307em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span></span></span></span></span></div>
<p>解析一下这个函数，它这里面的 <code>z_i</code> 代表的就是第 <code>i</code> 个词的分数，<code>K</code> 代表的是词的总数量，而这个输出值就代表第 <code>i</code> 个词的概率了。这里的 <code>T</code> 就是 <code>Temperature</code>，可以先把 <code>T</code>设置为默认值 <code>T = 1</code>，那么这个公式就变为了：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>Softmax</mtext><mo stretchy="false">(</mo><msub><mi>z</mi><mi>i</mi></msub><mo stretchy="false">)</mo><mo>=</mo><mfrac><msup><mi>e</mi><msub><mi>z</mi><mi>i</mi></msub></msup><mrow><munderover><mo>∑</mo><mrow><mi>j</mi><mo>=</mo><mn>1</mn></mrow><mi>K</mi></munderover><msup><mi>e</mi><msub><mi>z</mi><mi>j</mi></msub></msup></mrow></mfrac></mrow><annotation encoding="application/x-tex">\text{Softmax}(z_i) = \frac{e^{z_i}}{\sum_{j=1}^{K} e^{z_j}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord text"><span class="mord">Softmax</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.044em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.6484em;vertical-align:-1.307em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3414em;"><span style="top:-2.1288em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9812em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4358em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6065em;"><span style="top:-3.0051em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3281em;"><span style="top:-2.357em;margin-left:-0.044em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2819em;"><span/></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6644em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3281em;"><span style="top:-2.357em;margin-left:-0.044em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span/></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.307em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span></span></span></span></span></div>
<p>还是以上面的词为例，上面五个词的分数为：<code>z_1（AI） = 4.2、z_2（科技）= 4.1、z_3（奇舞）= 3.9、z_4（自行车）= 1.8、z_5（Hello）= 1.4</code>，那么计算 <code>z_1</code>这个词的概率，上面的公式展开为：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>P</mi><mn>1</mn></msub><mo>=</mo><mfrac><msup><mi>e</mi><mn>4.2</mn></msup><mrow><msup><mi>e</mi><mn>4.2</mn></msup><mo>+</mo><msup><mi>e</mi><mn>4.1</mn></msup><mo>+</mo><msup><mi>e</mi><mn>3.9</mn></msup><mo>+</mo><msup><mi>e</mi><mn>1.8</mn></msup><mo>+</mo><msup><mi>e</mi><mn>1.4</mn></msup></mrow></mfrac></mrow><annotation encoding="application/x-tex">P_1 = \frac{e^{4.2}}{e^{4.2} + e^{4.1}+e^{3.9}+e^{1.8}+e^{1.4}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.2604em;vertical-align:-0.7693em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.4911em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7401em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">4.2</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7401em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">4.1</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7401em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3.9</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7401em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1.8</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7401em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1.4</span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">4.2</span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.7693em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span></span></span></span></span></div>
<img src="https://p1.ssl.qhimg.com/d/inn/8022f6754328/formula.png" alt="截屏2025-12-04 21.36.38" loading="lazy"/>
<p><strong>e ≈ 2.718</strong>，大致得到的概率如下：</p>
<ul>
<li><strong>AI</strong>：36%</li>
<li><strong>科技</strong>：32%</li>
<li><strong>奇舞</strong>：26%</li>
<li><strong>自行车</strong>：3%</li>
<li><strong>Hello</strong>：2%</li>
</ul>
<p><code>Softmax</code> 函数会保证所有词的概率相加为100%。</p>
<p><strong>步骤3：加权采样</strong></p>
<p>得到了每个词的概率后，就需要根据概率来生成下一个预测的值。一般称这个通过概率来生成预测值的过程为: <strong>加权采样</strong>。可以用一个从0到100这个区间的横轴来举例。</p>
<p>”AI“这个词的概率为36%，那么在横轴上给它分配0到36这段区间，科技的概率是32%，我们就给它分配随后的长度为32的这段区间，以此类推。</p>
<p><img src="https://p3.ssl.qhimg.com/d/inn/e95dd5159b0f/WechatIMG6955.jpg" alt="WechatIMG6955" loading="lazy"/></p>
<p>然后生成一个0到100的随机数。比如说随机数是8，落到了这个[0,36]这个区间，我们就选择 <code>AI</code>。这个就叫做给每个词分配与概率相等的机会。这意味着，虽然“AI”概率最高，但模型也有机会选择“科技”或“奇舞”。这种机制保证了回答的合理性，同时赋予了 AI 创造力和变化。</p>
<h4 data-id="heading-2">Temperature 对大模型的作用</h4>
<p><img src="https://p1.ssl.qhimg.com/d/inn/d9d7b0cdadfc/resurece_1.png" alt="截屏2025-12-06 15.13.53" loading="lazy"/></p>
<p>在概率转换模块，我们对 <code>Softmax</code> 函数进行了简化，设置了 <code>T(Temperature)</code> 的取值为1，完整版中，所有的 <code>z</code> 值都会先除以 T，再加入到整体的运算过程中。假如调整 T 的值，会发生什么？</p>
<p>我们对比一下 T=0.1（低温）、T=1.0（标准）、T=2.0（高温）时的概率变化：</p>









































<table><thead><tr><th>词</th><th>T=0.1 (低温)</th><th>T=1.0 (中性)</th><th>T=2.0 (高温)</th></tr></thead><tbody><tr><td>AI</td><td>71%</td><td>36%</td><td>30%</td></tr><tr><td>科技</td><td>26%</td><td>32%</td><td>28%</td></tr><tr><td>奇舞</td><td>4%</td><td>26%</td><td>26%</td></tr><tr><td>自行车</td><td>0.0%</td><td>3%</td><td>9%</td></tr><tr><td>Hello</td><td>0.0%</td><td>2%</td><td>7%</td></tr></tbody></table>
<p><strong>核心结论</strong>：</p>
<p><strong>T &lt; 1 (低温状态)：赢家通吃</strong></p>
<ul>
<li><strong>原理</strong>：当 T 很小时（如 0.1），分数被放大（除以小数等于乘以大数）。指数函数 <code>e^x</code> 会急剧放大差异。高分词的优势被无限拔高，低分词的概率被压缩至近乎为 0。</li>
<li><strong>效果</strong>：概率分布变得极度<strong>尖锐</strong>。模型几乎只选第一名，输出极度稳定、保守。</li>
<li><strong>物理比喻</strong>：低温下分子运动缓慢，状态固定（冰）。</li>
<li><strong>适用</strong>：代码生成、数学解题（严谨，不容出错）。</li>
</ul>
<p><strong>T &gt; 1 (高温状态)：众生平等</strong></p>
<ul>
<li><strong>原理</strong>：当 T 很大时（如 2.0），分数被缩小。差异被拉平，指数运算后的结果差别不大。</li>
<li><strong>效果</strong>：概率分布变得<strong>平缓</strong>。高分词优势不再明显，长尾词（如“自行车”）也有了被选中的机会。</li>
<li><strong>物理比喻</strong>：高温下分子运动剧烈，状态混乱且不可预测（沸水）。</li>
<li><strong>适用</strong>：创意写作、头脑风暴（需要惊喜，容忍偏差）。</li>
</ul>
<p>通过上面的计算对比，<strong>一句话总结 Temperature：它控制的是“贫富差距”。低 T 拉大差距，高 T 缩小差距。</strong></p>
<h4 data-id="heading-3">Top P 对大模型的作用</h4>
<p><strong>Top P 并不改变概率本身，而是改变选择的范围</strong>。<code>Top P</code> 作用在上面的采样环节。在加权采样环节，根据每一个词的概率给它们分配了对等的区间，然后生成了一个随机数，随机数落到哪个区间，就输出哪个区间的值，这样回答就会变得多种多样，但是这也埋下了隐患。</p>
<p>虽然"自行车"只有3%的概率，但只要你试的次数足够多，大模型最后还是很有可能输出"自行车"这三个字的。这肯定不是你想要的答案。大模型的词汇表里面有几十万个词，除了头部的几个合理词，后面基本上都是拖着长长的一串低概率的垃圾词。我们管这些词叫做<strong>长尾词</strong>。</p>
<p>比如在上面的例子中："自行车"与 "Hello" 就是长尾词，为了防止模型去选这些长尾词，就需要一个保安, 把这些离谱的选项都拦在门外，这就是 Top P 的作用了。</p>
<p><strong>机制详解：</strong></p>
<p>Top P 的全称为：<strong>Top Cumulative Probability</strong>（最高累加概率），P指的就是一个概率阈值。模型从高分词开始往下累加概率，一旦累加值超过 P，后面的词全部切掉。</p>
<p>假设我们设置 <strong>Top P = 0.9</strong>：</p>
<ol>
<li><strong>AI</strong> (36%) -&gt; 累加 36% (&lt;90%，保留)</li>
<li><strong>科技</strong> (32%) -&gt; 累加 68% (&lt;90%，保留)</li>
<li><strong>奇舞</strong> (26%) -&gt; 累加 94% (<strong>&gt;90%，触发阈值！</strong>) -&gt; <strong>保留“奇舞”，截断后续所有词。</strong></li>
</ol>
<p>结果：“自行车”、“Hello”等长尾词直接被丢弃。剩下的三个词重新归一化概率，然后在它们之间进行采样。</p>
<img src="https://p2.ssl.qhimg.com/d/inn/f0bab89f4759/Wechat.jpg" loading="lazy"/>
<p><strong>核心结论</strong></p>
<p>Top P 就像一个<strong>动态的门槛</strong>。</p>
<ul>
<li><strong>Top P 低 (e.g., 0.1)</strong>：只保留最头部的几个词，极度保守。</li>
<li><strong>Top P 高 (e.g., 0.9)</strong>：允许更多可能性的词进入候选池，保留多样性，同时切除极不靠谱的尾部。</li>
</ul>
<p>所以总结一下：</p>


























<table><thead><tr><th>参数</th><th>低值效果</th><th>高值效果</th><th>适用场景</th><th>与另一参数区别</th></tr></thead><tbody><tr><td>Temperature</td><td>差距放大，赢家通吃，稳定</td><td>差距缩小，均等，多样</td><td>低：代码/数学；高：小说/idea</td><td>全局概率分布</td></tr><tr><td>Top P</td><td>头部窄，切长尾，保守</td><td>门槛宽，兼容，随机</td><td>低：专业Q&amp;A；高：开放讨论</td><td>尾部过滤阈值</td></tr></tbody></table>
<h4 data-id="heading-4">建议</h4>
<ol>
<li><strong>通常只调整其中一个</strong>：虽然可以同时调整，但为了控制变量，主流建议是固定一个（如 Top P = 1），只调另一个。</li>
<li><strong>发散思维场景</strong>（写小说、想点子）：
<ul>
<li><strong>推荐</strong>：设置 <code>0.8 &lt;= T &lt;= 1.2</code> 左右 或 设置 Top P 为 0.9左右。</li>
<li>让模型“发散”一会儿，但别太离谱。</li>
</ul>
</li>
<li><strong>严谨逻辑场景</strong>（写代码、提取数据）：
<ul>
<li><strong>推荐</strong>：设置 <code>0.0 &lt;= T &lt;= 0.2</code>  或  <code>0.1 &lt;= Top P &lt;= 0.2</code> 左右。</li>
<li>确保模型只选概率最高的那个词，保证逻辑的连贯和语法的正确。</li>
</ul>
</li>
</ol>
<p>理解了这两个参数，你就不是在盲目地“炼丹”，而是在精准地调试你的数字引擎。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Spring监听器（ApplicationEvent）：比MQ更轻的异步神器！]]></title>    <link>https://juejin.cn/post/7605136148592394267</link>    <guid>https://juejin.cn/post/7605136148592394267</guid>    <pubDate>2026-02-11T07:11:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605136148592394267" data-draft-id="7605164560711680026" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Spring监听器（ApplicationEvent）：比MQ更轻的异步神器！"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-02-11T07:11:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="神奇小汤圆"/> <meta itemprop="url" content="https://juejin.cn/user/1151943919285431"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Spring监听器（ApplicationEvent）：比MQ更轻的异步神器！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1151943919285431/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    神奇小汤圆
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-11T07:11:09.000Z" title="Wed Feb 11 2026 07:11:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">引言：当咖啡店遭遇程序员</h3>
<blockquote>
<p>“顾客挤爆柜台时，优秀的店长不会催促咖啡师加速，而是启动一套科学的协作机制——<br/>
就像<a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D267240109%26content_type%3DArticle%26match_order%3D1%26q%3DSpring%25E4%25BA%258B%25E4%25BB%25B6%25E9%25A9%25B1%25E5%258A%25A8%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=267240109&amp;content_type=Article&amp;match_order=1&amp;q=Spring%E4%BA%8B%E4%BB%B6%E9%A9%B1%E5%8A%A8&amp;zhida_source=entity" ref="nofollow noopener noreferrer">Spring事件驱动</a>，用**<a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D267240109%26content_type%3DArticle%26match_order%3D1%26q%3D%25E5%258F%2591%25E5%25B8%2583-%25E8%25AE%25A2%25E9%2598%2585%25E6%25A8%25A1%25E5%25BC%258F%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=267240109&amp;content_type=Article&amp;match_order=1&amp;q=%E5%8F%91%E5%B8%83-%E8%AE%A2%E9%98%85%E6%A8%A1%E5%BC%8F&amp;zhida_source=entity" ref="nofollow noopener noreferrer">发布-订阅模式</a>**让系统像顶级咖啡团队般优雅应对洪峰流量”</p>
</blockquote>
<hr/>
<h3 data-id="heading-1">一、咖啡店里的监听器：3位灵魂角色</h3>
<p><strong>真实战场还原</strong>（每秒1000订单的咖啡店）：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6dfd00f842a94dc1afdadf5700036f83~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56We5aWH5bCP5rGk5ZyG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771398668&amp;x-signature=VpRDGs7r7VU1pms23hN7WDGuhuo%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-2">1. 事件定义：咖啡店的「订单小票」</h3>
<pre><code class="hljs language-scala" lang="scala">public <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OrderEvent</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ApplicationEvent</span> </span>{
    <span class="hljs-comment">// final修饰的订单ID：就像咖啡师绝不涂改的订单小票</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> orderId;  
    
    <span class="hljs-comment">// 创建时间：记录订单诞生时刻（线程安全不可变）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">LocalDateTime</span> createTime = <span class="hljs-type">LocalDateTime</span>.now(); 

    <span class="hljs-comment">// 无setter：防止多线程并发篡改订单</span>
}
</code></pre>
<h3 data-id="heading-3">2. 事件发布：店长的「广播系统」</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> {
    <span class="hljs-comment">// 店长的麦克风（构造器注入更优雅）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ApplicationEventPublisher eventPublisher; 

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createOrder</span><span class="hljs-params">(Order order)</span> {
        <span class="hljs-comment">// 核心业务：生成订单（咖啡店接单）</span>
        eventPublisher.publishEvent(<span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderEvent</span>(<span class="hljs-built_in">this</span>, order.getId())); <span class="hljs-comment">// 📢 广播订单</span>
    }
}
</code></pre>
<h3 data-id="heading-4">3. 事件监听：咖啡团队的「技能响应」</h3>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@Component</span>
public class CoffeeMakerListener {
    <span class="hljs-variable">@EventListener</span> 
    <span class="hljs-variable">@Order</span>(<span class="hljs-number">1</span>) <span class="hljs-comment">// 优先级：先做咖啡再推荐甜点</span>
    public void <span class="hljs-built_in">makeCoffee</span>(OrderEvent event) {
        <span class="hljs-comment">// 专注做咖啡，不关心谁结账</span>
        <span class="hljs-selector-tag">log</span><span class="hljs-selector-class">.info</span>(<span class="hljs-string">"咖啡师：开始制作订单{}的拿铁..."</span>, event.<span class="hljs-built_in">getOrderId</span>());
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-5">二、扛住亿级流量的3把利器</h3>
<h3 data-id="heading-6">🔥 <strong>场景1：冷启动缓存预加载（防雪崩）</strong></h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CachePreloader</span> {
    <span class="hljs-comment">// 在Spring容器"开店准备完成"时触发</span>
    <span class="hljs-meta">@EventListener(ContextRefreshedEvent.class)</span> 
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initCache</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 异步加载省时30%（实测数据）</span>
        CompletableFuture.runAsync(() -&gt; {
            provinceService.loadProvincesToCache(); 
            productService.preloadHotProducts();
        });
    }
}
</code></pre>
<h3 data-id="heading-7">💡 <strong>场景2：事务成功后的缓存清理（保一致性）</strong></h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 只在数据库提交成功后执行（避免脏清理）</span>
<span class="hljs-meta">@TransactionalEventListener</span>(phase = <span class="hljs-title class_">TransactionPhase</span>.<span class="hljs-property">AFTER_COMMIT</span>)
<span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">cleanCache</span>(<span class="hljs-params">OrderUpdateEvent event</span>) {
    <span class="hljs-comment">// 异步清理：不阻塞结账队伍</span>
    redisTemplate.<span class="hljs-title function_">executeAsync</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">RedisCallback</span>&lt;&gt;() {
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-title class_">Void</span> <span class="hljs-title function_">doInRedis</span>(<span class="hljs-params">RedisConnection connection</span>) {
            connection.<span class="hljs-title function_">del</span>((<span class="hljs-string">"order:"</span> + event.<span class="hljs-title function_">getId</span>()).<span class="hljs-title function_">getBytes</span>());
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }
    });
}
</code></pre>
<h3 data-id="heading-8">🚀 <strong>场景3：无侵入式功能扩展</strong></h3>
<p><strong>改造前（臃肿的收银台）</strong> ：</p>
<pre><code class="hljs language-scss" lang="scss">public void <span class="hljs-built_in">pay</span>() {
    paymentService<span class="hljs-selector-class">.pay</span>();   <span class="hljs-comment">// 核心支付</span>
    auditService<span class="hljs-selector-class">.log</span>();     <span class="hljs-comment">// 审计代码入侵</span>
    riskService<span class="hljs-selector-class">.check</span>();    <span class="hljs-comment">// 风控代码耦合</span>
    marketingService<span class="hljs-selector-class">.addPoints</span>(); <span class="hljs-comment">// 新增需求污染核心</span>
}
</code></pre>
<p><strong>事件驱动改造后</strong>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 纯净支付核心（专注收钱）</span>
<span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">pay</span>(<span class="hljs-params">Long orderId</span>) {
    paymentService.<span class="hljs-title function_">process</span>(orderId);
    eventPublisher.<span class="hljs-title function_">publishEvent</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">PaymentSuccessEvent</span>(orderId)); <span class="hljs-comment">// 📢 广播支付成功</span>
}

<span class="hljs-comment">// 新增积分模块（无需修改支付代码）</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PointListener</span> {
    <span class="hljs-meta">@EventListener</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">addPoints</span>(<span class="hljs-params">PaymentSuccessEvent event</span>) {
        <span class="hljs-comment">// 积分服务独立演进</span>
        pointService.<span class="hljs-title function_">award</span>(event.<span class="hljs-title function_">getOrderId</span>(), <span class="hljs-number">100</span>); 
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-9">三、血泪教训：3个深夜加班事故</h3>
<h3 data-id="heading-10">🚫 <strong>事故1：多线程篡改事件（订单混乱）</strong></h3>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 错误！事件必须是只读的</span>
@EventListener
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">handle</span>(<span class="hljs-params">OrderEvent <span class="hljs-keyword">event</span></span>)</span> {
    <span class="hljs-keyword">event</span>.setStatus(<span class="hljs-string">"MODIFIED"</span>); <span class="hljs-comment">// ⚠️ 多线程并发修改引发订单错乱</span>
}
</code></pre>
<blockquote>
<p><strong>正确做法</strong>：事件类设计为final字段 + 无setter</p>
</blockquote>
<h3 data-id="heading-11">🚫 <strong>事故2：异步事件丢失（顾客投诉）</strong></h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-meta">@EnableAsync</span> <span class="hljs-comment">// 必须显式开启异步</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Application</span> {
    <span class="hljs-meta">@Bean</span>(<span class="hljs-string">"eventExecutor"</span>) 
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Executor</span> <span class="hljs-title function_">taskExecutor</span>(<span class="hljs-params"/>) {
        <span class="hljs-comment">// 关键参数：拒绝策略用CallerRunsPolicy（避免丢单）</span>
        <span class="hljs-title class_">ThreadPoolTaskExecutor</span> executor = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolTaskExecutor</span>();
        executor.<span class="hljs-title function_">setRejectedExecutionHandler</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>.<span class="hljs-title class_">CallerRunsPolicy</span>());
        <span class="hljs-keyword">return</span> executor;
    }
}

<span class="hljs-comment">// 指定线程池执行</span>
<span class="hljs-meta">@Async</span>(<span class="hljs-string">"eventExecutor"</span>) 
<span class="hljs-meta">@EventListener</span>
<span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">asyncHandle</span>(<span class="hljs-params">OrderEvent event</span>) {...}
</code></pre>
<h3 data-id="heading-12">🚫 <strong>事故3：事件循环调用（咖啡师卡死）</strong></h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 错误：在事件处理中发布新事件</span>
<span class="hljs-meta">@EventListener</span>
<span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">handleA</span>(<span class="hljs-params">EventA a</span>) {
    publisher.<span class="hljs-title function_">publishEvent</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">EventB</span>()); 
}

<span class="hljs-meta">@EventListener</span>
<span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">handleB</span>(<span class="hljs-params">EventB b</span>) {
    publisher.<span class="hljs-title function_">publishEvent</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">EventA</span>()); <span class="hljs-comment">// ♻️ 死循环！</span>
}
</code></pre>
<hr/>
<h3 data-id="heading-13">四、关键抉择：监听器 vs MQ 架构对垒</h3>



































<table><thead><tr><th>维度</th><th>Spring监听器</th><th>MQ消息队列</th></tr></thead><tbody><tr><td>适用场景</td><td>单机事务协作 ✅</td><td>跨服务通信 ✅</td></tr><tr><td>可靠性</td><td>进程宕机事件消失 ❌</td><td>持久化/重试 ✅</td></tr><tr><td>吞吐量</td><td>内存级传输，10w+/s 🚀</td><td>受网络限制，1w/s ⚠️</td></tr><tr><td>开发效率</td><td>免搭建MQ，注解即用 ✅</td><td>需部署中间件 ❌</td></tr><tr><td>数据一致性</td><td>本地事务保障 ✅</td><td>需分布式事务 ⚠️</td></tr></tbody></table>
<blockquote>
<p><strong>黄金决策树</strong>：<br/>
同JVM事务操作 → Spring监听器（开发效率王炸）<br/>
跨服务最终一致 → <a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D267240109%26content_type%3DArticle%26match_order%3D1%26q%3DRocketMQ%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=267240109&amp;content_type=Article&amp;match_order=1&amp;q=RocketMQ&amp;zhida_source=entity" ref="nofollow noopener noreferrer">RocketMQ</a>（可靠性担当）</p>
</blockquote>
<hr/>
<h3 data-id="heading-14">五、性能调优：监听器的涡轮增压</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a85cb1c8bdeb497ab3e4b14d0750168c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56We5aWH5bCP5rGk5ZyG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771398668&amp;x-signature=%2BHQjbpnZkOjLB5Edq7zbCdK4Tnk%3D" alt="" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-15">六、最佳实践：5条生存法则</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5847a6a2c4b14d2ab91a8d04fa665f80~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56We5aWH5bCP5rGk5ZyG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771398668&amp;x-signature=%2BaI6ZNi45bhAMrtniHeoN%2B%2F0v6w%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a21ac721a9da489a9ea6eb6377c3eb60~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56We5aWH5bCP5rGk5ZyG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771398668&amp;x-signature=dW57MkBOc%2BqHAiOjZvQSipC9msY%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-16">结语：事件驱动的艺术</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/495b2972c6ff43ef97da9e139322332e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56We5aWH5bCP5rGk5ZyG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771398668&amp;x-signature=HFTBFBQkZjXr6JRe35Es9ZYAtaI%3D" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深入浅出的聊下MCP]]></title>    <link>https://juejin.cn/post/7605142381152534591</link>    <guid>https://juejin.cn/post/7605142381152534591</guid>    <pubDate>2026-02-11T07:16:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605142381152534591" data-draft-id="7605142381152485439" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深入浅出的聊下MCP"/> <meta itemprop="keywords" content="Cursor,人工智能"/> <meta itemprop="datePublished" content="2026-02-11T07:16:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="前端的阶梯"/> <meta itemprop="url" content="https://juejin.cn/user/2604076678261512"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深入浅出的聊下MCP
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2604076678261512/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    前端的阶梯
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-11T07:16:37.000Z" title="Wed Feb 11 2026 07:16:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、MCP 底层框架全景解读：协议层与传输层如何解耦</h2>
<p>Model Context Protocol（MCP）并不是一个简单的“工具调用协议”，而是一套 面向智能体（Agent）场景的通用通信框架。它通过清晰的分层设计，把「协议语义」与「通信方式」彻底解耦，使同一套 Agent 协议既能跑在本地进程，也能运行在浏览器、微服务乃至实时双向系统中。</p>
<p><strong>1、整体架构：三层解耦设计</strong></p>
<p>从架构上看，MCP 可以清晰拆分为三层：</p>
<p>上层应用层：Agent、Tools、Resources、Prompts 等业务能力</p>
<p>协议层（Protocol Layer）：基于 JSON-RPC 2.0 的会话协议</p>
<p>传输层（Transport Layer）：负责消息在不同通道中的实际传输</p>
<p>这三层的边界非常明确：</p>
<p>协议层只关心「消息语义与会话状态」，</p>
<p>传输层只关心「消息如何收发」，</p>
<p>上层应用完全不需要感知底层通信细节。</p>
<p><strong>2、协议层：把 JSON-RPC 变成“会话协议”</strong></p>
<p>（1）BaseSession：MCP 的通信引擎</p>
<p>协议层的核心是 BaseSession。它并不是简单封装 JSON-RPC，而是解决了 Agent 场景下最关键的几件事：</p>
<ul>
<li>统一请求（Request）、响应（Response）、通知（Notification）模型</li>
<li>自动维护请求–响应的 ID 关联，支持并发调用</li>
<li>屏蔽底层读写流差异（stdio / HTTP / WebSocket）</li>
<li>提供统一的错误与异常处理机制</li>
</ul>
<p>可以理解为：BaseSession 把“字节流通信”升级成了“可靠的会话通信”。</p>
<p>（2）ClientSession 与 ServerSession：角色语义补全</p>
<p>在 BaseSession 之上，MCP 分别为客户端和服务端补齐角色语义：</p>
<p>ClientSession</p>
<ul>
<li>主动发起 <code>initialize</code> 请求</li>
<li>声明自身能力（capabilities）</li>
<li>在握手完成后才能进行正常调用</li>
</ul>
<p>ServerSession</p>
<ul>
<li>内嵌初始化状态机，严格约束交互顺序</li>
<li>校验客户端能力，决定是否允许某些通知或功能</li>
<li>确保协议执行的安全性与一致性</li>
</ul>
<p>这种设计使 MCP 的通信过程具备 明确的生命周期和状态约束，而不是“随便发消息”。</p>
<p><strong>3、标准交互流程：三阶段模型</strong></p>
<p>从通信流程上看，MCP 的完整交互可以抽象为三个阶段：</p>
<p>（1）握手初始化</p>
<p>Client 发送 <code>initialize</code>，双方交换协议版本与能力集，并通过 <code>initialized</code> 确认完成。</p>
<p>（2）正常通信</p>
<p>双方可双向发送 Request–Response（同步调用）或 Notification（异步事件）。</p>
<p>（3）优雅收尾</p>
<p>任意一端可主动关闭会话，或由底层通道断开触发清理。</p>
<p>这一流程确保了 MCP 在复杂 Agent 场景下仍然具备可控的通信秩序。</p>
<p><strong>4、传输层：多形态通信的统一承载</strong></p>
<p>MCP 在传输层提供了多种实现，以适配不同部署与性能需求，但所有传输方式都严格遵循同一套协议层逻辑。</p>
<p>（1）Stdio Transport</p>
<p>基于标准输入/输出的本地进程通信，极其轻量，适合 CLI 工具、编辑器插件和本地 Agent。</p>
<p>（2）HTTP + SSE</p>
<p>通过 HTTP POST 发送消息，SSE 单向推送结果，浏览器友好，适合前后端分离和轻量微服务场景。</p>
<p>（3）Streamable HTTP</p>
<p>在同一路径上混合 POST 与 SSE，支持会话管理、断线重连和流式响应，是更偏生产级的 HTTP 方案。</p>
<p>（4）WebSocket</p>
<p>真正的全双工通道，低延迟、高频交互，适合实时 Agent 与前端嵌入式 Copilot 场景。</p>
<p>可以看到，传输层的差异只影响“怎么连”，不影响“怎么用”。</p>
<p><strong>5、总结：为什么 MCP 适合作为 Agent 通信底座</strong></p>
<p>从整体设计来看，MCP 的核心价值在于：</p>
<ul>
<li>用 JSON-RPC 2.0 构建了有状态、可并发、可扩展的会话协议</li>
<li>通过能力声明与初始化握手，保障交互顺序与安全边界</li>
<li>彻底解耦协议与传输，使 Agent 能在本地、浏览器和生产微服务环境中复用同一通信模型</li>
</ul>
<p>这也是 MCP 能成为 Agent 时代“通用通信底座”的关键原因。</p>
<h2 data-id="heading-1">二、MCP 的三大核心概念：Tools、Resources 与 Prompts</h2>
<p>在 MCP（Model Context Protocol）中，并不是所有能力都通过“工具调用”来完成。为了清晰地划分 谁来控制、谁来决策、谁来执行，MCP 将 Agent 可用的能力抽象为三类核心原语：</p>
<p>Prompt 负责“如何提问”</p>
<p>Resource 负责“提供背景”</p>
<p>Tool 负责“执行操作”</p>
<p>这三者共同构成了 MCP 中 模型、客户端与服务端之间的职责边界。</p>
<p><strong>1、Resources：为模型提供“可控上下文”</strong></p>
<p>资源（Resources） 是 MCP 中用于向 LLM 暴露上下文数据的核心原语之一。</p>
<p>它的本质不是“能力”，而是可被读取的背景信息。</p>
<p>资源可以是任意类型的数据，包括但不限于：</p>
<ul>
<li>文件内容（文档、日志）</li>
<li>数据库记录（结构化数据）</li>
<li>API 响应</li>
<li>实时系统状态</li>
<li>截图、图片、音频、视频等二进制内容</li>
</ul>
<p>（1）资源的核心特征</p>
<p>URI 唯一标识</p>
<p>每个资源都通过 URI 定位，例如：</p>
<p>代码语言：javascript</p>
<hr/>
<p>AI代码解释</p>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-symbol">file:</span>/<span class="hljs-regexp">//home</span><span class="hljs-regexp">/user/docs</span><span class="hljs-regexp">/report.pdfpostgres:/</span><span class="hljs-regexp">/db.example.com/customers</span><span class="hljs-regexp">/schemascreen:/</span><span class="hljs-regexp">/localhost/display</span>
</code></pre>
<p>应用控制（App-controlled）</p>
<p>资源由客户端应用决定：</p>
<ul>
<li>何时暴露</li>
<li>暴露哪些</li>
<li>是否提供给模型作为上下文</li>
</ul>
<p>换句话说：模型不能“主动索取资源”，只能使用 Host 给它的上下文。</p>
<p>（2）静态资源与动态资源</p>
<p>静态资源</p>
<p>URI 在服务提供时已明确，例如某个日志文件、固定路径文档。</p>
<p>动态资源</p>
<p>通过 URI Template（RFC 6570）定义，资源内容随参数变化：</p>
<p>代码语言：javascript</p>
<hr/>
<p>AI代码解释</p>
<pre><code class="hljs language-ini" lang="ini">logs://recent?<span class="hljs-attr">timeframe</span>={duration}
</code></pre>
<p>客户端只需填充参数即可构造具体资源 URI。</p>
<p>（3）资源能力声明（Capabilities）</p>
<p>支持资源的 MCP Server 需要在初始化阶段声明能力，例如：</p>
<p>代码语言：javascript</p>
<hr/>
<p>AI代码解释</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span><span class="hljs-attr">"capabilities"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-attr">"resources"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-attr">"subscribe"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span><span class="hljs-attr">"listChanged"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">}</span>
</code></pre>
<p><code>subscribe</code>：是否支持订阅单个资源的变更</p>
<p><code>listChanged</code>：资源列表变化时是否主动通知客户端</p>
<p>（4）资源的设计定位</p>
<p>资源的设计目标是：</p>
<p>为模型提供“事实背景”，而不是“执行能力”</p>
<p>如果你希望服务端主动驱动模型行为，那么应该使用 Tools，而不是 Resources。</p>
<p><strong>2、Tools：模型可控的“执行能力”</strong></p>
<p>工具（Tools） 是 MCP 中唯一允许模型直接触发“动作”的原语。</p>
<p>与资源不同，工具不是被读取，而是被 调用（call）。</p>
<p>（1）Tool 的核心定位</p>
<p>模型控制（Model-controlled）用于执行：</p>
<p>API 调用</p>
<ul>
<li>数据更新</li>
<li>查询、计算</li>
<li>外部系统操作</li>
</ul>
<p>但需要注意：</p>
<p>模型只是“决定是否调用工具”，真正的调用由客户端完成。</p>
<p>这正是 MCP 所强调的：</p>
<p>模型主控，客户端驱动（Model decides, Client executes）</p>
<p>（2）Tool 的定义结构</p>
<p>每个工具包含以下信息：</p>
<ul>
<li><code>name：唯一标识</code></li>
<li><code>description：功能说明</code></li>
<li><code>inputSchema：参数结构（JSON Schema）</code></li>
<li><code>annotations（可选）：行为说明</code></li>
</ul>
<p>（3）Tool 的调用机制</p>
<p>在 MCP 中：</p>
<ul>
<li>列出工具：<code>tools/list</code></li>
<li>调用工具：<code>tools/call</code></li>
<li>返回结果：标准 JSON-RPC 响应</li>
</ul>
<p>整个过程完全协议化、可审计、可拦截。</p>
<p><strong>3、Prompts：标准化的“提问模板”</strong></p>
<p>在 MCP 中，Prompt 是继 Resources 和 Tools 之后的第三个核心原语，但它关注的不是数据，也不是执行，而是——</p>
<p>如何把用户意图组织成“模型更容易理解和执行”的输入结构</p>
<p>Prompt 本质上是由 <a href="https://link.juejin.cn?target=https%3A%2F%2Fcloud.tencent.com%2Fproduct%2Fcvm%3Ffrom_column%3D20065%26from%3D20065" target="_blank" title="https://cloud.tencent.com/product/cvm?from_column=20065&amp;from=20065" ref="nofollow noopener noreferrer">服务器</a>端预先定义的一组可复用对话模板与交互流程。</p>
<p>（1）Prompt 的设计理念</p>
<p>用户控制（User-controlled）</p>
<p>Prompt 必须由用户或 UI 显式选择触发</p>
<p>协议不绑定交互方式</p>
<p>可以是 Slash 命令、菜单、按钮或表单</p>
<p>强调结构化而非自由发挥</p>
<hr/>
<p>（2）Prompt 的核心能力</p>
<p>参数化：支持动态输入（如时间范围、语言、主题）</p>
<p>资源整合：可嵌入资源作为上下文</p>
<p>多轮交互：适合诊断、教学、引导式任务</p>
<p>统一发现：通过 <code>prompts/list</code>、<code>prompts/get</code> 统一管理</p>
<p>UI 友好：天然适合产品化封装</p>
<p>典型 Prompt 定义结构如下：</p>
<p>代码语言：javascript</p>
<hr/>
<p>AI代码解释</p>
<pre><code class="hljs language-css" lang="css">{  name: string;  description: string;  arguments: [    {      name: string;      description: string;      required: boolean;    }  ];}
</code></pre>
<p>（3）一个典型应用场景</p>
<p>例如在教学或企业知识场景中：</p>
<ul>
<li>教学设计者在 MCP Server 中预置 Prompt 模板</li>
<li>教师通过自然语言或菜单选择 Prompt</li>
<li>系统自动填参并引导多轮对话</li>
<li>即使非技术用户，也能“调动”智能体完成复杂任务</li>
</ul>
<p>Prompt 解决的是 “经验如何被标准化复用” 的问题。</p>
<p><strong>4、三大原语的角色分工</strong></p>
<p>最后，用三句话总结 MCP 的核心原语设计：</p>
<p>Prompt 关注 “如何提问”，让复杂任务变得可复用、可引导</p>
<p>Resource 提供 “背景事实”，让模型有上下文可依</p>
<p>Tool 承担 “执行动作”，让模型真正影响外部世界</p>
<p>这三者共同构成了 MCP 中 安全、可控、可产品化的 Agent 能力体系。</p>
<h2 data-id="heading-2">三、MCP三个核心概念实战演示</h2>
<p>以下是github上大拿编写的测试Demo，代码是claude code用javascripts写的，有兴趣可以看下。代码仓库：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fwangjoey2012-sudo%2Fmcp-demos" target="_blank" title="https://github.com/wangjoey2012-sudo/mcp-demos" ref="nofollow noopener noreferrer">github.com/wangjoey201…</a></p>
<p><strong>1、Tools</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/82faaca76a8a4c6689c981a97db1df24~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv55qE6Zi25qKv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771398997&amp;x-signature=PpQmiLUrAARfdofincpI4q%2FOFZY%3D" alt="" loading="lazy"/></p>
<p><strong>2、Resources</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7a1adaa4d3364ebd94660c5fad3ba61e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv55qE6Zi25qKv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771398997&amp;x-signature=OT6SvjbcA%2Bxcq8oB%2BadLGiP1mZA%3D" alt="" loading="lazy"/></p>
<p><strong>3、Prompts</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/01db62c23eea4cec8465e7fcdf9472dd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv55qE6Zi25qKv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771398997&amp;x-signature=xUdhJXk4MBXG%2BpQipYMTc2izV7s%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-3">四、结语</h2>
<p>本文深入浅出的介绍了MCP底层实现的一些框架及协议，希望对大家了解mcp有帮助。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一看就懂的 Haskell 教程 - 类型类]]></title>    <link>https://juejin.cn/post/7605145921617559604</link>    <guid>https://juejin.cn/post/7605145921617559604</guid>    <pubDate>2026-02-11T06:58:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605145921617559604" data-draft-id="7604574877035986987" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一看就懂的 Haskell 教程 - 类型类"/> <meta itemprop="keywords" content="Haskell"/> <meta itemprop="datePublished" content="2026-02-11T06:58:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Anita_Sun"/> <meta itemprop="url" content="https://juejin.cn/user/1811635884786839"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一看就懂的 Haskell 教程 - 类型类
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1811635884786839/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Anita_Sun
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-11T06:58:58.000Z" title="Wed Feb 11 2026 06:58:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>类型类是Haskell最具辨识度的设计，核心是<strong>把“行为”和“数据”彻底分开</strong>——先定义“能做什么”（行为规则），再给任意类型（内置/自定义）绑定“具体怎么做”（行为实现），完全摆脱面向对象继承的束缚，实现极致灵活的多态。</p>
<h2 data-id="heading-0">一、为什么Haskell需要类型类？——摆脱OOP继承的坑</h2>
<p>Haskell设计类型类的根本目的，是解决面向对象（OOP）继承体系的三大核心问题，让“行为扩展”更灵活。</p>
<h3 data-id="heading-1">1. OOP继承的3个致命问题</h3>
<p>OOP把“行为（方法）”绑死在“数据（类）”上，导致：</p>
<ul>
<li><strong>改不了内置类型</strong>：比如Java想给<code>int</code>加个自定义打印方法，根本改不了<code>int</code>的源码；</li>
<li><strong>类越写越多</strong>：想给“数字”加“负数判断”，得新建<code>NegativeInt</code>、<code>NegativeFloat</code>等子类，类爆炸；</li>
<li><strong>代码重复</strong>：<code>Int</code>和<code>Double</code>都要实现“加法”，得在两个类里各写一遍，没法复用。</li>
</ul>
<h3 data-id="heading-2">2. 类型类的核心思路：先定行为，再绑类型</h3>
<p>类型类反其道而行之，核心是“<strong>行为和数据解耦</strong>”：</p>
<ol>
<li>抽离通用行为：把“能相加”“能打印”“能比较”这类行为做成独立的“规则手册”（类型类）；</li>
<li>灵活绑定类型：给任意类型（比如内置的<code>Int</code>、你写的<code>User</code>）绑定这个规则，不用改类型源码；</li>
<li>无层级束缚：一个类型能绑定多个行为，一个行为能适配多个类型，没有继承的“父子关系”。</li>
</ol>
<h3 data-id="heading-3">3. 类型类≠OOP接口（核心区别）</h3>
<p>很多人会把类型类和接口混淆，其实二者设计逻辑完全不同：</p>






























<table><thead><tr><th>对比维度</th><th>Haskell类型类</th><th>OOP接口</th></tr></thead><tbody><tr><td>核心逻辑</td><td>行为“贴”到任意类型上（无需改类型）</td><td>行为必须由子类继承实现（改不了父类）</td></tr><tr><td>内置类型支持</td><td>直接给<code>Int</code>/<code>String</code>加行为，不用改源码</td><td>必须新建子类（如<code>MyString</code>）才能加行为</td></tr><tr><td>默认实现</td><td>原生支持（写一次，所有类型可复用）</td><td>部分支持（如Java 8后才加默认方法）</td></tr><tr><td>多参数支持</td><td>支持（需解决歧义）</td><td>无原生多参数接口设计</td></tr></tbody></table>
<p><strong>举个直观例子</strong>：</p>
<p>想让字符串能比较大小，OOP要写<code>ComparableString</code>子类并实现接口；Haskell直接给原生<code>String</code>绑定“可比较”行为就行，一步到位。</p>
<h2 data-id="heading-4">二、类型类的3个核心环节：定义→实现→使用</h2>
<p>类型类的使用就三步，每一步都围绕“行为抽象”展开，逻辑清晰且灵活。</p>
<h3 data-id="heading-5">1. 第一步：定义类型类——写“行为规则手册”</h3>
<p>类型类定义是“只说要做什么，不说怎么做”的接口声明，用<code>class</code>关键字实现。</p>
<h4 data-id="heading-6">（1）基础定义：核心方法+默认方法</h4>
<pre><code class="hljs language-rust" lang="rust">-- 定义“可打印”规则手册：a代表任意能实现该行为的类型
class Printable a <span class="hljs-keyword">where</span>
  -- 核心方法：无默认实现，必须由类型实现
  printVal :: a <span class="hljs-punctuation">-&gt;</span> <span class="hljs-title function_ invoke__">IO</span> ()
  
  -- 辅助方法：带默认实现，可复用也可重写
  printWithPrefix :: <span class="hljs-type">String</span> <span class="hljs-punctuation">-&gt;</span> a <span class="hljs-punctuation">-&gt;</span> <span class="hljs-title function_ invoke__">IO</span> ()
  -- 默认逻辑：加前缀后调用核心方法printVal
  printWithPrefix prefix x = <span class="hljs-keyword">do</span>
    putStr prefix
    printVal x
</code></pre>
<ul>
<li><strong>类型变量（a）</strong> ：代表“所有能遵守这个规则的类型”，是多态的核心；</li>
<li><strong>方法签名</strong>：只声明输入输出（比如<code>printVal</code>是“把a类型的值打印出来”），不写具体代码；</li>
<li><strong>默认方法</strong>：避免重复代码——实例只需实现核心方法，就能自动拥有辅助方法的能力。</li>
</ul>
<h4 data-id="heading-7">（2）进阶：解决多参数类型类的“歧义问题”</h4>
<p>有些行为涉及两种类型（比如“把a类型转成b类型”），需要多参数类型类，但会导致编译器“分不清推导方向”，Haskell提供两种解决方案：</p>
<h5 data-id="heading-8">问题场景：编译器不知道目标类型</h5>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 定义“类型转换”规则手册：a=源类型，b=目标类型</span>
class <span class="hljs-keyword">Convert</span> a b <span class="hljs-keyword">where</span>
  <span class="hljs-keyword">convert</span> :: a <span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span> b

<span class="hljs-comment">-- 实例1：Int转String</span>
instance <span class="hljs-keyword">Convert</span> <span class="hljs-type">Int</span> String <span class="hljs-keyword">where</span>
  <span class="hljs-keyword">convert</span> n <span class="hljs-operator">=</span> "数字：" <span class="hljs-operator">+</span><span class="hljs-operator">+</span> <span class="hljs-keyword">show</span> n

<span class="hljs-comment">-- 实例2：Int转Bool</span>
instance <span class="hljs-keyword">Convert</span> <span class="hljs-type">Int</span> Bool <span class="hljs-keyword">where</span>
  <span class="hljs-keyword">convert</span> <span class="hljs-number">0</span> <span class="hljs-operator">=</span> <span class="hljs-literal">False</span>
  <span class="hljs-keyword">convert</span> _ <span class="hljs-operator">=</span> <span class="hljs-literal">True</span>

<span class="hljs-comment">-- 调用时编译器蒙圈：只知道a=Int，不知道b是String还是Bool</span>
<span class="hljs-comment">-- test = convert 123  -- 直接报错：类型歧义</span>
</code></pre>
<h5 data-id="heading-9">解决方案1：函数依赖——告诉编译器“谁决定谁”</h5>
<pre><code class="hljs language-sql" lang="sql">{<span class="hljs-operator">-</span># <span class="hljs-keyword">LANGUAGE</span> FunctionalDependencies #<span class="hljs-operator">-</span>} <span class="hljs-comment">-- 启用扩展（必须加）</span>

<span class="hljs-comment">-- 关键：| a -&gt; b 声明“源类型a唯一决定目标类型b”</span>
class <span class="hljs-keyword">Convert</span> a b <span class="hljs-operator">|</span> a <span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span> b <span class="hljs-keyword">where</span>
  <span class="hljs-keyword">convert</span> :: a <span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span> b

<span class="hljs-comment">-- 合法实例：Int只能对应String（符合a-&gt;b约束）</span>
instance <span class="hljs-keyword">Convert</span> <span class="hljs-type">Int</span> String <span class="hljs-keyword">where</span>
  <span class="hljs-keyword">convert</span> n <span class="hljs-operator">=</span> "数字：" <span class="hljs-operator">+</span><span class="hljs-operator">+</span> <span class="hljs-keyword">show</span> n

<span class="hljs-comment">-- ❌ 报错：同一个a不能对应多个b（Int不能既转String又转Bool）</span>
<span class="hljs-comment">-- instance Convert Int Bool where ...</span>

<span class="hljs-comment">-- ✅ 正常调用：编译器知道a=Int，就能确定b=String</span>
test1 :: String
test1 <span class="hljs-operator">=</span> <span class="hljs-keyword">convert</span> <span class="hljs-number">123</span>  <span class="hljs-comment">-- 输出："数字：123"</span>
</code></pre>
<h5 data-id="heading-10">解决方案2：关联类型——给源类型绑定“专属目标类型”</h5>
<pre><code class="hljs language-sql" lang="sql">{<span class="hljs-operator">-</span># <span class="hljs-keyword">LANGUAGE</span> TypeFamilies #<span class="hljs-operator">-</span>} <span class="hljs-comment">-- 启用扩展（必须加）</span>

<span class="hljs-comment">-- 类型类只有一个参数a，目标类型变成a的“附属品”</span>
class <span class="hljs-keyword">Convert</span> a <span class="hljs-keyword">where</span>
  <span class="hljs-comment">-- 核心：为每个a定义唯一的TargetType（关联类型）</span>
  type TargetType a  
  <span class="hljs-comment">-- 输出类型固定为a的TargetType，无歧义</span>
  <span class="hljs-keyword">convert</span> :: a <span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span> TargetType a

<span class="hljs-comment">-- 实例：Int的专属目标类型是String</span>
instance <span class="hljs-keyword">Convert</span> <span class="hljs-type">Int</span> <span class="hljs-keyword">where</span>
  type TargetType <span class="hljs-type">Int</span> <span class="hljs-operator">=</span> String
  <span class="hljs-keyword">convert</span> n <span class="hljs-operator">=</span> "数字：" <span class="hljs-operator">+</span><span class="hljs-operator">+</span> <span class="hljs-keyword">show</span> n

<span class="hljs-comment">-- ✅ 正常调用：两种写法都可行</span>
test2 :: TargetType <span class="hljs-type">Int</span>  <span class="hljs-comment">-- 等价于 String</span>
test2 <span class="hljs-operator">=</span> <span class="hljs-keyword">convert</span> <span class="hljs-number">123</span>

test3 :: String
test3 <span class="hljs-operator">=</span> <span class="hljs-keyword">convert</span> <span class="hljs-number">123</span>
</code></pre>
<h3 data-id="heading-11">2. 第二步：实现实例——给类型“绑定行为”</h3>
<p>实例（Instance）是类型类的“具体实现”，用<code>instance</code>关键字把“规则手册”落地到具体类型上。</p>
<h4 data-id="heading-12">（1）基础实例：给单个类型绑定行为</h4>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 给Int实现Printable：只实现核心方法，复用默认辅助方法</span>
instance Printable <span class="hljs-type">Int</span> <span class="hljs-keyword">where</span>
  printVal n <span class="hljs-operator">=</span> putStrLn $ "整数：" <span class="hljs-operator">+</span><span class="hljs-operator">+</span> <span class="hljs-keyword">show</span> n

<span class="hljs-comment">-- 给String实现Printable：重写辅助方法，定制逻辑</span>
instance Printable String <span class="hljs-keyword">where</span>
  printVal s <span class="hljs-operator">=</span> putStrLn $ "字符串：" <span class="hljs-operator">+</span><span class="hljs-operator">+</span> s
  <span class="hljs-comment">-- 重写前缀方法：自定义格式</span>
  printWithPrefix prefix s <span class="hljs-operator">=</span> putStrLn $ prefix <span class="hljs-operator">+</span><span class="hljs-operator">+</span> " | " <span class="hljs-operator">+</span><span class="hljs-operator">+</span> s
</code></pre>
<ul>
<li>必须实现：类型类中无默认的核心方法（如<code>printVal</code>）；</li>
<li>可选实现：有默认的辅助方法（如<code>printWithPrefix</code>），需定制才重写。</li>
</ul>
<h4 data-id="heading-13">（2）条件实例：泛型类型的“条件绑定”</h4>
<p>想让列表、<code>Maybe</code>这类泛型类型实现行为，可加“条件约束”——只有满足条件的泛型类型才生效：</p>
<pre><code class="hljs language-ini" lang="ini">-- 约束：只有列表里的元素a能打印，整个列表才能打印
instance Printable <span class="hljs-attr">a</span> =&gt; Printable [a] where
  printVal <span class="hljs-attr">xs</span> = mapM_ printVal xs  -- 遍历列表，逐个打印元素

-- ✅ 合法：Int能打印，所以<span class="hljs-section">[Int]</span>能打印
printVal <span class="hljs-section">[1,2,3]</span>
-- ❌ 报错：Bool没实现Printable，所以<span class="hljs-section">[Bool]</span>不能打印
-- printVal <span class="hljs-section">[True, False]</span>
</code></pre>
<h4 data-id="heading-14">（3）通用/特化实例：覆盖不同场景</h4>
<ul>
<li>
<p><strong>通用实例</strong>：适配所有满足约束的泛型类型（如所有<code>Show a</code>的<code>Maybe a</code>）；</p>
<ul>
<li>
<pre><code class="hljs language-sql" lang="sql">instance <span class="hljs-keyword">Show</span> a <span class="hljs-operator">=</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">Show</span> (Maybe a) <span class="hljs-keyword">where</span>
  <span class="hljs-keyword">show</span> Nothing <span class="hljs-operator">=</span> "Nothing"
  <span class="hljs-keyword">show</span> (Just x) <span class="hljs-operator">=</span> "Just " <span class="hljs-operator">+</span><span class="hljs-operator">+</span> <span class="hljs-keyword">show</span> x
</code></pre>
</li>
</ul>
</li>
<li>
<p><strong>特化实例</strong>：为具体类型定制逻辑（需启用<code>OverlappingInstances</code>扩展），优先级高于通用实例；</p>
<ul>
<li>
<pre><code class="hljs language-ini" lang="ini">{-<span class="hljs-comment"># LANGUAGE OverlappingInstances #-}</span>
-- 只为<span class="hljs-section">[Int]</span>定制打印逻辑，覆盖通用的<span class="hljs-section">[a]</span>实例
instance Printable <span class="hljs-section">[Int]</span> where
  printVal <span class="hljs-attr">xs</span> = putStrLn $ <span class="hljs-string">"整数列表："</span> ++ show xs
</code></pre>
</li>
</ul>
</li>
</ul>
<h3 data-id="heading-15">3. 第三步：使用约束——限制函数“只认有行为的类型”</h3>
<p>用<code>=&gt;</code>给函数加约束，确保传入的类型“有对应的行为资格”，编译期就能校验合法性。</p>
<h4 data-id="heading-16">（1）基础约束：单个/多个约束</h4>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">--</span> 单个约束：<span class="hljs-selector-tag">a</span>必须能打印，才能调用这个函数
<span class="hljs-selector-tag">printAll</span> :: <span class="hljs-selector-tag">Printable</span> <span class="hljs-selector-tag">a</span> =&gt; <span class="hljs-selector-attr">[a]</span> <span class="hljs-selector-tag">-</span>&gt; <span class="hljs-selector-tag">IO</span> ()
<span class="hljs-selector-tag">printAll</span> <span class="hljs-selector-tag">xs</span> = <span class="hljs-selector-tag">mapM_</span> <span class="hljs-selector-tag">printVal</span> <span class="hljs-selector-tag">xs</span>

<span class="hljs-selector-tag">--</span> 多个约束：<span class="hljs-selector-tag">a</span>既要能做数值运算，又要能打印
<span class="hljs-selector-tag">calcAndPrint</span> :: (Num a, Printable a) =&gt; <span class="hljs-selector-tag">a</span> <span class="hljs-selector-tag">-</span>&gt; <span class="hljs-selector-tag">a</span> <span class="hljs-selector-tag">-</span>&gt; <span class="hljs-selector-tag">IO</span> ()
<span class="hljs-selector-tag">calcAndPrint</span> <span class="hljs-selector-tag">x</span> <span class="hljs-selector-tag">y</span> = <span class="hljs-selector-tag">printVal</span> (x + y)

<span class="hljs-selector-tag">--</span> ✅ 合法调用：<span class="hljs-selector-tag">Int</span>同时满足<span class="hljs-selector-tag">Num</span>和<span class="hljs-selector-tag">Printable</span>
<span class="hljs-selector-tag">calcAndPrint</span> <span class="hljs-number">1</span> <span class="hljs-number">2</span>
<span class="hljs-selector-tag">--</span> ❌ 报错：<span class="hljs-selector-tag">String</span>满足<span class="hljs-selector-tag">Printable</span>但不满足<span class="hljs-selector-tag">Num</span>
<span class="hljs-selector-tag">--</span> <span class="hljs-selector-tag">calcAndPrint</span> "<span class="hljs-selector-tag">a</span>" "<span class="hljs-selector-tag">b</span>"
</code></pre>
<h4 data-id="heading-17">（2）约束的继承传递</h4>
<p>如果类型类B继承自类型类A，那么<code>B a</code>会自动包含<code>A a</code>的约束：</p>
<pre><code class="hljs language-rust" lang="rust">-- <span class="hljs-built_in">Ord</span>继承<span class="hljs-built_in">Eq</span>，所以<span class="hljs-built_in">Ord</span> a 等价于 (<span class="hljs-built_in">Ord</span> a, <span class="hljs-built_in">Eq</span> a)
compareAndCheck :: <span class="hljs-built_in">Ord</span> a =&gt; a <span class="hljs-punctuation">-&gt;</span> a <span class="hljs-punctuation">-&gt;</span> Bool
compareAndCheck x y = x &gt; y &amp;&amp; x /= y  -- 同时用<span class="hljs-built_in">Ord</span>的&gt;和<span class="hljs-built_in">Eq</span>的/=
</code></pre>
<h2 data-id="heading-18">三、类型类的避坑指南+最佳实践</h2>
<p>类型类虽灵活，但用不好会导致代码难维护，记住这些“避坑点”和“黄金法则”。</p>
<h3 data-id="heading-19">1. 常见陷阱（别踩！）</h3>
<ul>
<li><strong>孤儿实例</strong>：类型类和类型不在同一个模块（比如在A模块给B模块的<code>User</code>实现C模块的<code>Show</code>）→ 易冲突、难追踪；</li>
<li><strong>重叠实例</strong>：多个实例能匹配同一个类型（比如<code>[a]</code>和<code>[Int]</code>都实现<code>Printable</code>）→ 编译器不知道用哪个；</li>
<li><strong>默认方法误用</strong>：默认方法依赖未实现的方法（比如<code>methodA</code>默认用<code>methodB</code>，但实例只写了<code>methodA</code>）→ 调用时报错。</li>
</ul>
<h3 data-id="heading-20">2. 最佳实践（记这3条就够）</h3>
<ul>
<li><strong>接口要“单一”</strong> ：一个类型类只管一类行为（比如<code>Printable</code>只负责打印，别加计算逻辑）；</li>
<li><strong>实现要“最小”</strong> ：只实现类型类的核心方法，默认方法能复用就复用，别重复写；</li>
<li><strong>别过度抽象</strong>：只有多个类型需要复用同一行为时，才写类型类；优先用标准库的<code>Num</code>/<code>Eq</code>等，别重复造轮子。</li>
</ul>
<h2 data-id="heading-21">总结</h2>
<ol>
<li>类型类的核心是<strong>行为抽象优于数据抽象</strong>：先定“能做什么”（规则），再给任意类型绑定“具体怎么做”（实现），解耦行为和数据；</li>
<li>核心使用流程：定义类型类（规则手册）→ 实现实例（绑定行为）→ 使用约束（校验资格），三者协同实现灵活多态；</li>
<li>标准库核心类型类（Num/Eq/Ord/Functor）覆盖大部分场景，优先直接使用；</li>
<li>避坑关键：避开孤儿实例、重叠实例，遵循“单一职责、最小实现、不过度抽象”的原则。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[OHOS Ace_engine 节点核心类型： UINode]]></title>    <link>https://juejin.cn/post/7605106957134151714</link>    <guid>https://juejin.cn/post/7605106957134151714</guid>    <pubDate>2026-02-11T06:59:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605106957134151714" data-draft-id="7605145921617526836" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="OHOS Ace_engine 节点核心类型： UINode"/> <meta itemprop="keywords" content="HarmonyOS"/> <meta itemprop="datePublished" content="2026-02-11T06:59:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="WeNTaO"/> <meta itemprop="url" content="https://juejin.cn/user/1839932880978572"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            OHOS Ace_engine 节点核心类型： UINode
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1839932880978572/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    WeNTaO
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-11T06:59:52.000Z" title="Wed Feb 11 2026 06:59:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">概述</h2>
<p><code>UINode</code> 是 ACE Engine (ArkUI) 中组件树的基础节点类。它定义了组件树的基本结构（父子关系）和生命周期管理，但<strong>不包含</strong>布局（Layout）和渲染（Render）逻辑（这些由子类 <code>FrameNode</code> 负责）</p>
<ul>
<li>源码位置：
sources/arkui_ace_engine/frameworks/core/components_ng/base/ui_node.h`</li>
<li>继承关系：
<code>AceType</code> -&gt; <code>UINode</code></li>
<li>核心职责：
<ul>
<li>树结构管理**：维护父子节点关系 (<code>AddChild</code>, <code>RemoveChild</code>, <code>parent_</code>, <code>children_</code>)。</li>
<li><strong>生命周期</strong>：挂载/卸载 (<code>AttachToMainTree</code>, <code>DetachFromMainTree</code>)。</li>
<li><strong>上下文关联</strong>：持有 <code>PipelineContext</code>，连接到渲染管线。</li>
</ul>
</li>
</ul>
<h2 data-id="heading-1">类图</h2>
<pre><code class="hljs language-mermaid" lang="mermaid">classDiagram
    class AceType {
        &lt;&lt;abstract&gt;&gt;
        +GetTypeName()
        +InstanceOf()
        +DynamicCast()
    }
    
    class UINode {
        &lt;&lt;核心基类&gt;&gt;
        #children_: list~RefPtr~UINode~~
        #parent_: WeakPtr~UINode~
        #context_: PipelineContext*
        #nodeId_: int32_t
        #tag_: string
        
        +AddChild(child, slot)
        +RemoveChild(child)
        +MountToParent(parent, slot)
        +GetParent() RefPtr~UINode~
        +GetChildren() list~RefPtr~UINode~~
        
        +TouchTest(...) HitTestResult
        +MouseTest(...) HitTestResult
        +AxisTest(...) HitTestResult
        
        +MarkDirtyNode(flag)
        +UpdateLayoutPropertyFlag()
        +CreateLayoutWrapper() RefPtr~LayoutWrapperNode~
        
        +AttachContext(context)
        +DetachContext()
        +OnAttachToMainTree()
        +OnDetachFromMainTree()
        
        +GetContext() PipelineContext*
        +GetId() int32_t
        +GetTag() string
    }
    
    class LayoutWrapper {
        &lt;&lt;布局包装器&gt;&gt;
        +Measure()
        +Layout()
    }
    
    class FrameNode {
        &lt;&lt;实际渲染节点&gt;&gt;
        +pattern_: RefPtr~Pattern~
        +layoutProperty_: RefPtr~LayoutProperty~
        +renderContext_: RefPtr~RenderContext~
        +eventHub_: RefPtr~EventHub~
        
        +GetPattern() RefPtr~Pattern~
        +GetLayoutProperty() RefPtr~LayoutProperty~
        +GetRenderContext() RefPtr~RenderContext~
    }
    
    class GroupNode {
        &lt;&lt;组合节点&gt;&gt;
        +AddChildToGroup(child, slot)
        +DeleteChildFromGroup(slot)
    }
    
    class ForEachNode {
        &lt;&lt;语法节点：循环&gt;&gt;
        +CompareAndUpdateChildren()
        +FlushUpdateAndMarkDirty()
    }
    
    class IfElseNode {
        &lt;&lt;语法节点：条件&gt;&gt;
        +UpdateCondition()
    }
    
    class WithThemeNode {
        &lt;&lt;语法节点：主题&gt;&gt;
        +ApplyTheme()
    }
    
    class PipelineContext {
        &lt;&lt;渲染上下文&gt;&gt;
        +GetRootNode() RefPtr~UINode~
        +FlushPipeline()
    }
    
    class LayoutWrapperNode {
        &lt;&lt;布局包装节点&gt;&gt;
        +Measure()
        +Layout()
    }
    
    class FocusHub {
        &lt;&lt;焦点管理&gt;&gt;
        +RequestFocus()
        +LostFocus()
    }
    
    AceType &lt;|-- UINode : virtual继承
    UINode &lt;|-- FrameNode : 继承
    UINode &lt;|-- ForEachNode : 继承
    UINode &lt;|-- IfElseNode : 继承
    UINode &lt;|-- WithThemeNode : 继承
    FrameNode &lt;|-- GroupNode : 继承
    FrameNode --|&gt; LayoutWrapper : 多重继承
    
    UINode --&gt; PipelineContext : 关联
    UINode --&gt; LayoutWrapperNode : 创建
    FrameNode --&gt; FocusHub : 包含
    UINode "1" *-- "0..*" UINode : children
    UINode "0..1" &lt;-- "1" UINode : parent
</code></pre>
<ul>
<li>层次类型：
第一层：基础类型层</li>
</ul>
<ul>
<li><code>AceType</code>：类型系统基类，提供 RTTI 和智能指针支持</li>
</ul>
<p>第二层：节点基类层</p>
<ul>
<li><code>UINode</code>：节点树管理、事件分发、生命周期</li>
</ul>
<p>第三层：具体节点层</p>
<ul>
<li><code>FrameNode</code>：实际渲染节点，包含 Pattern、LayoutProperty、RenderContext</li>
<li><code>SyntaxNode</code> 系列：语法控制节点（ForEach、IfElse、WithTheme 等）</li>
</ul>
<p>第四层：特殊节点层</p>
<ul>
<li><code>GroupNode</code>：组合节点，用于特殊布局场景</li>
</ul>
<h3 data-id="heading-2">关键设计模式</h3>
<ol>
<li><strong>组合模式</strong>：<code>UINode</code> 通过 <code>children_</code> 管理子节点，形成树结构</li>
<li><strong>模板方法</strong>：<code>UINode</code> 定义骨架，子类实现具体行为（如 <code>IsAtomicNode()</code>）</li>
<li><strong>观察者模式</strong>：通过 <code>PipelineContext</code> 管理节点生命周期</li>
<li><strong>策略模式</strong>：<code>Pattern</code> 决定 <code>FrameNode</code> 的行为</li>
</ol>
<h2 data-id="heading-3">3. 核心成员变量</h2>








































<table><thead><tr><th align="left">变量名</th><th align="left">类型</th><th align="left">作用</th></tr></thead><tbody><tr><td align="left"><code>children_</code></td><td align="left"><code>std::list&lt;RefPtr&lt;UINode&gt;&gt;</code></td><td align="left">存储子节点列表。使用链表是为了高效插入和删除。</td></tr><tr><td align="left"><code>parent_</code></td><td align="left"><code>WeakPtr&lt;UINode&gt;</code></td><td align="left">指向父节点。使用<code>WeakPtr</code> 防止循环引用（父-&gt;子，子-&gt;父）。</td></tr><tr><td align="left"><code>context_</code></td><td align="left"><code>PipelineContext*</code></td><td align="left">指向管线上下文，用于访问全局服务（如主题、任务队列）。</td></tr><tr><td align="left"><code>tag_</code></td><td align="left"><code>std::string</code></td><td align="left">组件标签（如 "Column", "Button"）。</td></tr><tr><td align="left"><code>nodeId_</code></td><td align="left"><code>int32_t</code></td><td align="left">全局唯一的节点 ID。</td></tr><tr><td align="left"><code>onMainTree_</code></td><td align="left"><code>bool</code></td><td align="left">标记节点</td></tr></tbody></table>
<h2 data-id="heading-4">4. 核心机制</h2>
<h3 data-id="heading-5">4.1 树操作</h3>
<p>这里我们可以把<code>UINode</code>理解为前端的<code>DOM</code>节点， 提供了相应的API：</p>
<ul>
<li><code>AddChild(child)</code>: 添加子节点。</li>
<li><code>RemoveChild(child)</code>: 移除子节点。</li>
<li><code>MountToParent(parent)</code>: 将自己挂载到指定父节点。</li>
</ul>
<h3 data-id="heading-6">4.2 语法节点 &amp; 渲染节点</h3>
<p>类似前端操作的<code>visibility</code>操作， 很多时候我们需要依据逻辑来控制组件是否显示。 ohos提供了相应的
<code>if/else</code>语义能力（同时， foreach、lazyForeach ）。 为了从底层支持这个能力， UINode 被拆分为两种：</p>
<ul>
<li><strong>FrameNode</strong>：实体节点，有布局和渲染能力（如 <code>Column</code>, <code>Text</code>）。</li>
<li><strong>SyntaxNode</strong>（及其他非 FrameNode 子类）：语法节点，无渲染实体，仅用于控制流（如 <code>IfElseNode</code>, <code>ForEachNode</code>）。</li>
</ul>
<h3 data-id="heading-7">4.3 渲染流程</h3>
<pre><code class="hljs language-scss" lang="scss">PipelineContext (渲染上下文)
    ↓
UINode Tree (节点树)
    ├── FrameNode (实际渲染节点)
    │   ├── Pattern (行为策略)
    │   ├── LayoutProperty (布局属性)
    │   └── RenderContext (渲染上下文)
    └── SyntaxNode (语法控制节点)
        └── 管理子 FrameNode
    ↓
LayoutWrapper (布局计算)
    ↓
RenderNode (渲染节点)
</code></pre>
<h2 data-id="heading-8">5. 核心函数</h2>
<h3 data-id="heading-9">5.1 节点创建</h3>
<pre><code class="hljs language-cpp" lang="cpp">UINode::<span class="hljs-built_in">UINode</span>(<span class="hljs-type">const</span> std::string&amp; tag, <span class="hljs-type">int32_t</span> nodeId, <span class="hljs-type">bool</span> isRoot)
    : <span class="hljs-built_in">tag_</span>(tag), <span class="hljs-built_in">nodeId_</span>(nodeId), <span class="hljs-built_in">accessibilityId_</span>(currentAccessibilityId_++), <span class="hljs-built_in">isRoot_</span>(isRoot)
{
    ++count_; <span class="hljs-comment">// 全局  用来统计当前存活的UINode 数量， 我也不知为什么统计</span>
    <span class="hljs-keyword">if</span> (MultiThreadBuildManager::<span class="hljs-built_in">IsThreadSafeNodeScope</span>()) {<span class="hljs-comment">// 判断线程安全， 这里1.2 会进来， 增量引擎会存在并行化场景</span>
        isThreadSafeNode_ = <span class="hljs-literal">true</span>;
        <span class="hljs-built_in">SetIsFree</span>(<span class="hljs-literal">true</span>);
    } 
    <span class="hljs-keyword">if</span> (AceChecker::<span class="hljs-built_in">IsPerformanceCheckEnabled</span>()) {<span class="hljs-comment">//  存放js 代码位置信息， 用来调试补充。 这里没有考虑cangjie和其他语言 </span>
        <span class="hljs-keyword">auto</span> pos = EngineHelper::<span class="hljs-built_in">GetPositionOnJsCode</span>();
        nodeInfo_ = std::<span class="hljs-built_in">make_unique</span>&lt;PerformanceCheckNode&gt;();
        nodeInfo_-&gt;codeRow = std::<span class="hljs-built_in">get</span>&lt;<span class="hljs-number">1</span>&gt;(pos);
        nodeInfo_-&gt;codeCol = std::<span class="hljs-built_in">get</span>&lt;<span class="hljs-number">2</span>&gt;(pos);
        nodeInfo_-&gt;pagePath = std::<span class="hljs-built_in">get</span>&lt;<span class="hljs-number">0</span>&gt;(pos);
    }
    apiVersion_ = Container::<span class="hljs-built_in">GetCurrentApiTargetVersion</span>();
<span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> UICAST_COMPONENT_SUPPORTED</span>
    <span class="hljs-keyword">do</span> {
        <span class="hljs-keyword">auto</span> container = Container::<span class="hljs-built_in">Current</span>();
        <span class="hljs-built_in">CHECK_NULL_BREAK</span>(container);
        <span class="hljs-keyword">auto</span> distributedUI = container-&gt;<span class="hljs-built_in">GetDistributedUI</span>();
        <span class="hljs-built_in">CHECK_NULL_BREAK</span>(distributedUI);
        distributedUI-&gt;<span class="hljs-built_in">AddNewNode</span>(nodeId_);
    } <span class="hljs-keyword">while</span> (<span class="hljs-literal">false</span>);
<span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>
    instanceId_ = Container::<span class="hljs-built_in">CurrentId</span>();
    nodeStatus_ = ViewStackProcessor::<span class="hljs-built_in">GetInstance</span>()-&gt;<span class="hljs-built_in">IsBuilderNode</span>() ? NodeStatus::BUILDER_NODE_OFF_MAINTREE
                                                                     : NodeStatus::NORMAL_NODE;
    <span class="hljs-keyword">if</span> (SystemProperties::<span class="hljs-built_in">ConfigChangePerform</span>()) {
        <span class="hljs-keyword">auto</span> currentContainer = Container::<span class="hljs-built_in">GetContainer</span>(instanceId_);
        isDarkMode_ = currentContainer ? (currentContainer-&gt;<span class="hljs-built_in">GetColorMode</span>() == ColorMode::DARK) : <span class="hljs-literal">false</span>;
    }
    uiNodeGcEnable_ = FeatureParam::<span class="hljs-built_in">IsUINodeGcEnabled</span>();
}
</code></pre>
<h3 data-id="heading-10">5.2 节点销毁</h3>
<pre><code class="hljs language-cpp" lang="cpp">UINode::~<span class="hljs-built_in">UINode</span>()
{
    --count_;
<span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> UICAST_COMPONENT_SUPPORTED</span>
    <span class="hljs-keyword">do</span> {
        <span class="hljs-keyword">auto</span> container = Container::<span class="hljs-built_in">Current</span>();
        <span class="hljs-built_in">CHECK_NULL_BREAK</span>(container);
        <span class="hljs-keyword">auto</span> distributedUI = container-&gt;<span class="hljs-built_in">GetDistributedUI</span>();
        <span class="hljs-built_in">CHECK_NULL_BREAK</span>(distributedUI);
        <span class="hljs-keyword">if</span> (hostPageId_ == distributedUI-&gt;<span class="hljs-built_in">GetCurrentPageId</span>()) {
            distributedUI-&gt;<span class="hljs-built_in">AddDeletedNode</span>(nodeId_);
        }
    } <span class="hljs-keyword">while</span> (<span class="hljs-literal">false</span>);
<span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>

    <span class="hljs-keyword">if</span> (!removeSilently_) {
        ElementRegister::<span class="hljs-built_in">GetInstance</span>()-&gt;<span class="hljs-built_in">RemoveItem</span>(nodeId_); <span class="hljs-comment">//RemoveItem(nodeId_)：从 map 里删掉，并且把该 nodeId_ 加入 removedItems_（“已删除 id”集合）</span>
    } <span class="hljs-keyword">else</span> {
        ElementRegister::<span class="hljs-built_in">GetInstance</span>()-&gt;<span class="hljs-built_in">RemoveItemSilently</span>(nodeId_); <span class="hljs-comment">// 只从 map 里删，不加入 removedItems_。用于“这个节点马上会用同一个或新 id 再注册”的场景，避免被误当成“已删除”。</span>
    }
    <span class="hljs-keyword">if</span> (isThreadSafeNode_) {
        ElementRegisterMultiThread::<span class="hljs-built_in">GetInstance</span>()-&gt;<span class="hljs-built_in">RemoveThreadSafeNode</span>(nodeId_);
    }
    <span class="hljs-keyword">if</span> (propInspectorId_.<span class="hljs-built_in">has_value</span>()) {
        ElementRegister::<span class="hljs-built_in">GetInstance</span>()-&gt;<span class="hljs-built_in">RemoveFrameNodeByInspectorId</span>(propInspectorId_.<span class="hljs-built_in">value_or</span>(<span class="hljs-string">""</span>), nodeId_);
    }
    <span class="hljs-keyword">if</span> (!onMainTree_) { 
        <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-keyword">if</span> (context_) {
        context_-&gt;<span class="hljs-built_in">RemoveAttachedNode</span>(<span class="hljs-keyword">this</span>); <span class="hljs-comment">//AttachToMainTree 时会把节点放进 attachedNodeSet_；析构时必须从该集合移除，否则管线会持有已销毁节点的指针，造成悬空引用/未定义行为。</span>
    }
    onMainTree_ = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">if</span> (nodeStatus_ == NodeStatus::BUILDER_NODE_ON_MAINTREE) {
        nodeStatus_ = NodeStatus::BUILDER_NODE_OFF_MAINTREE;
    }
}
</code></pre>
<h2 data-id="heading-11">6. 其他关键功能</h2>
<h3 data-id="heading-12">6.1 线程安全节点机制（Thread-Safe Node）</h3>
<p>支持非 UI 线程操作节点，主要用于后台构建场景。</p>
<h4 data-id="heading-13">核心方法</h4>





























<table><thead><tr><th>方法</th><th>功能说明</th></tr></thead><tbody><tr><td><code>IsThreadSafeNode()</code></td><td>检查是否为线程安全节点</td></tr><tr><td><code>IsFree()</code></td><td>检查节点是否处于"自由"状态</td></tr><tr><td><code>SetIsFree(bool isFree)</code></td><td>设置节点自由状态</td></tr><tr><td><code>PostAfterAttachMainTreeTask()</code></td><td>提交挂载后的任务</td></tr><tr><td><code>ExecuteAfterAttachMainTreeTasks()</code></td><td>执行挂载后的任务</td></tr></tbody></table>
<h4 data-id="heading-14">关键状态</h4>
<ul>
<li><strong><code>isThreadSafeNode_</code></strong>：标识节点是否支持线程安全操作</li>
<li><strong><code>isFree_</code></strong>：节点处于"自由"状态时，非 UI 线程可以安全操作</li>
<li><strong><code>afterAttachMainTreeTasks_</code></strong>：挂载到主树后需要执行的任务列表</li>
</ul>
<h4 data-id="heading-15">使用场景</h4>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 典型场景：LazyForEach 在后台线程构建节点</span>
<span class="hljs-keyword">if</span> (node-&gt;<span class="hljs-built_in">IsFree</span>()) {
    <span class="hljs-comment">// 非 UI 线程可以安全操作</span>
    node-&gt;<span class="hljs-built_in">AddChild</span>(child);
    <span class="hljs-comment">// ...</span>
    node-&gt;<span class="hljs-built_in">PostAfterAttachMainTreeTask</span>([=]() {
        <span class="hljs-comment">// 挂载到主树后执行的任务</span>
    });
}
</code></pre>
<p>补充： 并行化的时候需要关注， 要修改节点状态，不然没法进入渲染流程。</p>
<h3 data-id="heading-16">6.2 BuilderNode 机制（延迟构建）</h3>
<p>支持延迟构建和动态更新，用于 <code>@Builder</code> 装饰的函数。</p>
<h4 data-id="heading-17">核心方法</h4>









































<table><thead><tr><th>方法</th><th>功能说明</th></tr></thead><tbody><tr><td><code>GetNodeStatus()</code></td><td>获取节点状态</td></tr><tr><td><code>UpdateNodeStatus()</code></td><td>更新节点状态</td></tr><tr><td><code>GetIsRootBuilderNode()</code></td><td>检查是否为根 BuilderNode</td></tr><tr><td><code>SetJsBuilderNodeId()</code></td><td>设置 JS BuilderNode ID</td></tr><tr><td><code>SetBuilderFunc()</code></td><td>设置构建函数</td></tr><tr><td><code>GetBuilderFunc()</code></td><td>获取构建函数</td></tr><tr><td><code>SetUpdateNodeFunc()</code></td><td>设置节点更新函数</td></tr><tr><td><code>SetUpdateNodeConfig()</code></td><td>设置配置更新函数</td></tr></tbody></table>
<h4 data-id="heading-18">节点状态</h4>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">enum class</span> <span class="hljs-title class_">NodeStatus</span> : <span class="hljs-type">char</span> {
    NORMAL_NODE = <span class="hljs-number">0</span>,                    <span class="hljs-comment">// 普通节点</span>
    BUILDER_NODE_OFF_MAINTREE = <span class="hljs-number">1</span>,      <span class="hljs-comment">// BuilderNode，脱离主树</span>
    BUILDER_NODE_ON_MAINTREE = <span class="hljs-number">2</span>        <span class="hljs-comment">// BuilderNode，挂载到主树</span>
};
</code></pre>
<h4 data-id="heading-19">工作流程</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-keyword">@Builder</span> 函数调用
    ↓
创建 BuilderNode（OFF_MAINTREE）
    ↓
延迟构建（lazyBuilderFunc_）
    ↓
需要时挂载到主树（ON_MAINTREE）
    ↓
动态更新（updateNodeFunc_）
</code></pre>
<p><strong>设计意图</strong>：<code>@Builder</code> 装饰的函数创建的节点可以延迟构建，节点可以脱离主树（OFF_MAINTREE），需要时再挂载（ON_MAINTREE）。</p>
<h3 data-id="heading-20">6.3 回调机制（Callback System）</h3>
<p>多种回调函数，用于与 JS 层交互和延迟构建。</p>
<h4 data-id="heading-21">回调类型</h4>



































<table><thead><tr><th>回调</th><th>类型</th><th>用途</th></tr></thead><tbody><tr><td><code>updateJSInstanceCallback_</code></td><td><code>std::function&lt;void(int32_t)&gt;</code></td><td>实例更新回调</td></tr><tr><td><code>lazyBuilderFunc_</code></td><td><code>std::function&lt;void()&gt;</code></td><td>延迟构建函数</td></tr><tr><td><code>updateNodeFunc_</code></td><td><code>std::function&lt;void(int32_t, RefPtr&lt;UINode&gt;&amp;)&gt;</code></td><td>节点更新函数</td></tr><tr><td><code>updateNodeConfig_</code></td><td><code>std::function&lt;void()&gt;</code></td><td>配置更新函数</td></tr><tr><td><code>destroyCallback_</code></td><td><code>std::function&lt;void(int32_t)&gt;</code></td><td>销毁回调</td></tr></tbody></table>
<h4 data-id="heading-22">使用示例</h4>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 注册回调</span>
node-&gt;<span class="hljs-built_in">RegisterUpdateJSInstanceCallback</span>([=](<span class="hljs-type">int32_t</span> id) {
    <span class="hljs-comment">//  实例更新逻辑</span>
});

node-&gt;<span class="hljs-built_in">SetBuilderFunc</span>([=]() {
    <span class="hljs-comment">// 延迟构建逻辑</span>
});

node-&gt;<span class="hljs-built_in">SetOnNodeDestroyCallback</span>([=](<span class="hljs-type">int32_t</span> id) {
    <span class="hljs-comment">// 节点销毁逻辑</span>
});
</code></pre>
<p><strong>用途</strong>：与前端语言 层交互、延迟构建、节点更新通知、生命周期管理。</p>
<h3 data-id="heading-23">6.4 内存管理机制</h3>
<p>智能指针 + 引用计数，避免泄漏与循环引用。</p>
<h4 data-id="heading-24">关键设计</h4>
<ul>
<li><strong>父方向用 <code>WeakPtr</code></strong>（不增加父的强引用）：
<pre><code class="hljs language-cpp" lang="cpp">WeakPtr&lt;UINode&gt; parent_;       <span class="hljs-comment">// 父节点，使用前需 Upgrade() 判空</span>
WeakPtr&lt;UINode&gt; adoptParent_;  <span class="hljs-comment">// 收养父（如 overlay）</span>
WeakPtr&lt;UINode&gt; ancestor_;     <span class="hljs-comment">// 祖先，插入去重等用</span>
</code></pre>
</li>
<li><strong>子方向用 <code>RefPtr</code></strong>（父拥有子）：
<pre><code class="hljs language-cpp" lang="cpp">std::list&lt;RefPtr&lt;UINode&gt;&gt; children_;
</code></pre>
</li>
<li><strong>释放钩子</strong>：强引用归零时由基类 <code>Referenced::DecRefCount()</code> 调用，子类可干预是否立即 delete：
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">bool</span> <span class="hljs-title">MaybeRelease</span><span class="hljs-params">()</span> <span class="hljs-keyword">override</span></span>;  <span class="hljs-comment">// true=立即 delete，false=不在这里删（如交给 GC）</span>
</code></pre>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[linux安装xray]]></title>    <link>https://juejin.cn/post/7605114376803418152</link>    <guid>https://juejin.cn/post/7605114376803418152</guid>    <pubDate>2026-02-11T07:07:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605114376803418152" data-draft-id="7605173538417098762" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="linux安装xray"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-02-11T07:07:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小悲伤"/> <meta itemprop="url" content="https://juejin.cn/user/1253916569515143"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            linux安装xray
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1253916569515143/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小悲伤
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-11T07:07:49.000Z" title="Wed Feb 11 2026 07:07:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"/>
<p><strong>前置准备</strong></p>
<p>ubuntu服务器和域名</p>
<ul>
<li>
<h3 data-id="heading-1">下载nginx</h3>
</li>
</ul>
<pre><code class="hljs language-shell" lang="shell">sudo apt install nginx -y
</code></pre>
<h5 data-id="heading-2">修改配置文件</h5>
<pre><code class="hljs language-shell" lang="shell">sudo vim /etc/nginx/sites-available/default
</code></pre>
<p>增加内容如下:</p>
<pre><code class="hljs language-js" lang="js">location /xray {  # 自定义路径
    proxy_redirect off;
    proxy_pass <span class="hljs-attr">http</span>:<span class="hljs-comment">//127.0.0.1:10000;  # xRay监听的端口</span>
    proxy_http_version <span class="hljs-number">1.1</span>;
    proxy_set_header <span class="hljs-title class_">Upgrade</span> $http_upgrade;
    proxy_set_header <span class="hljs-title class_">Connection</span> <span class="hljs-string">"upgrade"</span>;
    proxy_set_header <span class="hljs-title class_">Host</span> $host;
}
</code></pre>
<p>至此，nginx的工作就算做完了</p>
<h3 data-id="heading-3">下载xray</h3>
<pre><code class="hljs language-shell" lang="shell">sudo bash -c "$(curl -L https://github.com/XTLS/Xray-install/raw/main/install-release.sh)" @ install
</code></pre>
<p>修改配置文件</p>
<p>先准备一个uuid，在配置文件与客户端都需要用到</p>
<pre><code class="hljs language-shell" lang="shell">xray uuid
</code></pre>
<p>将返回的uuid复制下来</p>
<pre><code class="hljs language-shell" lang="shell">sudo vim /usr/local/etc/xray/config.json
</code></pre>
<p>以下是全部内容，可以直接复制使用，按需调整port/uuid/path</p>
<pre><code class="hljs language-js" lang="js">{
  <span class="hljs-string">"log"</span>: {
    <span class="hljs-string">"loglevel"</span>: <span class="hljs-string">"warning"</span>
  },
  <span class="hljs-string">"inbounds"</span>: [
    {
      <span class="hljs-string">"port"</span>: <span class="hljs-number">10000</span>, #监听的端口
      <span class="hljs-string">"listen"</span>: <span class="hljs-string">"127.0.0.1"</span>,
      <span class="hljs-string">"protocol"</span>: <span class="hljs-string">"vless"</span>, 
      <span class="hljs-string">"settings"</span>: {
        <span class="hljs-string">"clients"</span>: [
          {
            <span class="hljs-string">"id"</span>: <span class="hljs-string">"UUID"</span> #自定义一个uuid，这里跟客户端一样即可，范围是<span class="hljs-number">1</span>-<span class="hljs-number">30</span>字节的字符（这里就是填刚才获得的uuid，你也可以不使用uuid，随便几个字符串也行）
          }
        ],
        <span class="hljs-string">"decryption"</span>: <span class="hljs-string">"none"</span>
      },
      <span class="hljs-string">"streamSettings"</span>: {
        <span class="hljs-string">"network"</span>: <span class="hljs-string">"ws"</span>,
        <span class="hljs-string">"wsSettings"</span>: {
          <span class="hljs-string">"path"</span>: <span class="hljs-string">"/xray"</span> #nginx的路径
        }
      }
    }
  ],
  <span class="hljs-string">"outbounds"</span>: [
    {
      <span class="hljs-string">"protocol"</span>: <span class="hljs-string">"freedom"</span>,
      <span class="hljs-string">"tag"</span>: <span class="hljs-string">"direct"</span>
    }
  ]
}
</code></pre>
<h3 data-id="heading-4">申请证书</h3>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_">#</span><span class="bash">安装Certbot</span>
sudo apt install certbot python3-certbot-nginx -y
<span class="hljs-meta prompt_">#</span><span class="bash">申请证书</span>
sudo certbot --nginx -d domian.com #填你的域名
<span class="hljs-meta prompt_">#</span><span class="bash">自动续期</span>
sudo systemctl enable certbot.timer
</code></pre>
<h3 data-id="heading-5">开放端口</h3>
<pre><code class="hljs language-shell" lang="shell">sudo ufw allow 22/tcp  # SSH端口
sudo ufw allow 80/tcp   # HTTP
sudo ufw allow 443/tcp  # HTTPS
sudo ufw allow 10000/tcp #xray的端口
sudo ufw enable  #开启防火墙
</code></pre>
<p>所有准备工作都做完了，现在可以启动我们的xray和nginx服务了</p>
<p>如果之前启动了，那么修改了配置文件之后，记得重启</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_">#</span><span class="bash">启动xray</span>
sudo systemctl start xray 
<span class="hljs-meta prompt_">#</span><span class="bash">重启nginx</span>
sudo systemctl start nginx
</code></pre>
<h3 data-id="heading-6">客户端的配置</h3>
<p>下载地址</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2F2dust%2Fv2rayN" target="_blank" title="https://github.com/2dust/v2rayN" ref="nofollow noopener noreferrer">GitHub - 2dust/v2rayN: A GUI client for Windows, Linux and macOS, support Xray and sing-box and others</a></p>
<p>在release下载自己的版本就好了，下面以window版举例。</p>
<p>1-点击配置项，添加一个vless服务</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ce056785bf8b4f5e84a44529b7e79eb6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5oKy5Lyk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771398469&amp;x-signature=WH73tWXEd9fT0z4wqhNzck3voIY%3D" alt="image.png" loading="lazy"/></p>













































<table><thead><tr><th>标题</th><th>值</th></tr></thead><tbody><tr><td>别名</td><td>随便取一个</td></tr><tr><td>地址</td><td>你的服务器域名</td></tr><tr><td>端口</td><td>443</td></tr><tr><td>用户id</td><td>配置文件的uuid</td></tr><tr><td>传输协议</td><td>ws</td></tr><tr><td>伪装域名</td><td>你的服务器域名</td></tr><tr><td>路径</td><td>nginx配置的路径</td></tr><tr><td>传输层安全</td><td>tls</td></tr><tr><td>SNI</td><td>你的服务器域名</td></tr></tbody></table>
<p>至此，服务端与客户端就搭建好了，最后，在网络设置打开代理模式，</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/96e9476495e6496cbd67ca87bdf49bb3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5oKy5Lyk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771398469&amp;x-signature=q%2B6m7nCNiDQA608vUy06cVEN8Iw%3D" alt="image.png" loading="lazy"/></p>
<p>端口为客户端右下角的</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7ea8321bce67454295f2bc736d3b9cf6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5oKy5Lyk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771398469&amp;x-signature=QACwwEwaHaDwOG8hWFAqnPzlcBI%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[连接层里住着一个 HTTP 解析器]]></title>    <link>https://juejin.cn/post/7605105527258136576</link>    <guid>https://juejin.cn/post/7605105527258136576</guid>    <pubDate>2026-02-11T06:41:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605105527258136576" data-draft-id="7605128056485625871" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="连接层里住着一个 HTTP 解析器"/> <meta itemprop="keywords" content="程序员,Nginx"/> <meta itemprop="datePublished" content="2026-02-11T06:41:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员洪志道"/> <meta itemprop="url" content="https://juejin.cn/user/879237481367326"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            连接层里住着一个 HTTP 解析器
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/879237481367326/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员洪志道
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-11T06:41:45.000Z" title="Wed Feb 11 2026 06:41:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>前两篇打磨了引擎层——<code>js_epoll_poll()</code> 封装了事件分发，<code>js_engine_t</code> 组装了 epoll 和定时器。引擎层现在很干净。</p>
<p>但往上看一层，我发现了一个不对劲的东西。</p>
<h2 data-id="heading-0">连接结构体里有什么</h2>
<p>看 <code>js_conn_t</code>——这是 jsbench 连接层的核心结构：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">js_conn</span> {</span>
    <span class="hljs-type">js_event_t</span>           socket;
    <span class="hljs-type">conn_state_t</span>         state;
    SSL                 *ssl;

    <span class="hljs-type">const</span> <span class="hljs-type">char</span>          *req_data;
    <span class="hljs-type">size_t</span>               req_len;
    <span class="hljs-type">size_t</span>               req_sent;

    <span class="hljs-type">js_http_response_t</span>   response;   <span class="hljs-comment">/* ← 这是什么？ */</span>

    <span class="hljs-type">uint64_t</span>             start_ns;
    <span class="hljs-type">int</span>                  req_index;
    <span class="hljs-type">void</span>                *udata;
} <span class="hljs-type">js_conn_t</span>;
</code></pre>
<p>socket、状态、TLS、读写缓冲——这些都是连接该有的。但 <code>js_http_response_t response</code> 是什么？一个 HTTP 响应解析器，直接嵌在连接结构体里。</p>
<p>连接结构体里住着一个 HTTP 解析器。这意味着：<strong>这个"连接"，不能离开 HTTP 独立存在。</strong></p>
<p>再看 <code>conn_do_read()</code>——连接层处理读事件的函数：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">conn_do_read</span><span class="hljs-params">(<span class="hljs-type">js_conn_t</span> *c)</span> {
    <span class="hljs-type">char</span> buf[JS_READ_BUF_SIZE];

    <span class="hljs-keyword">for</span> (;;) {
        <span class="hljs-type">ssize_t</span> n;
        <span class="hljs-keyword">if</span> (c-&gt;ssl) {
            n = js_tls_read(c-&gt;ssl, buf, <span class="hljs-keyword">sizeof</span>(buf));
        } <span class="hljs-keyword">else</span> {
            n = read(c-&gt;socket.fd, buf, <span class="hljs-keyword">sizeof</span>(buf));
        }

        <span class="hljs-comment">/* ... 错误处理 ... */</span>

        <span class="hljs-type">int</span> ret = js_http_response_feed(&amp;c-&gt;response, buf, (<span class="hljs-type">size_t</span>)n);
        <span class="hljs-keyword">if</span> (ret == <span class="hljs-number">1</span>) {
            c-&gt;state = CONN_DONE;    <span class="hljs-comment">/* HTTP 解析完成 → 连接状态变更 */</span>
            <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
        }
    }
}
</code></pre>
<p>读数据是连接层的事，解析 HTTP 是协议层的事。但在这个函数里，两件事混在一起，没有边界。</p>
<p>还有 <code>js_conn_keepalive()</code>：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">bool</span> <span class="hljs-title function_">js_conn_keepalive</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">js_conn_t</span> *c)</span> {
    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *conn_hdr = js_http_response_header(&amp;c-&gt;response, <span class="hljs-string">"Connection"</span>);
    <span class="hljs-keyword">if</span> (conn_hdr &amp;&amp; strcasecmp(conn_hdr, <span class="hljs-string">"close"</span>) == <span class="hljs-number">0</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}
</code></pre>
<p>连接该不该复用，这个函数去读了 HTTP <code>Connection</code> 头。连接层依赖了协议层的知识。</p>
<p>三个地方，同一个问题：<strong>conn 和 http 塌成了一层。</strong></p>
<h2 data-id="heading-1">这意味着什么</h2>
<p>jsbench 从下往上有三层：</p>
<pre><code class="hljs language-markdown" lang="markdown">  ┌─────────────────┐
  │      http        │  协议语义：解析响应、判断 keep-alive
  └────────┬─────────┘
<span class="hljs-code">           │ 依赖
  ┌────────▼─────────┐
  │      conn        │  传输管理：连接、读写、TLS
  └────────┬─────────┘
           │ 依赖
  ┌────────▼─────────┐
  │     engine       │  事件驱动：epoll + timer
  └──────────────────┘
</span></code></pre>
<p>理想状态下，每层做自己的事，依赖方向从上往下。http 用 conn 发数据，conn 用 engine 做 I/O。上层依赖下层，下层不知道上层的存在。</p>
<p>但现在的代码是这样的：</p>
<pre><code class="hljs language-markdown" lang="markdown">  ┌──────────────────────────────┐
  │       conn + http             │
  │                               │
  │  conn 内嵌 http response      │
  │  conn 读 HTTP 头判断 keep-alive│
  │  conn 直接调 http 解析器       │
  └──────────────┬────────────────┘
<span class="hljs-code">                 │
  ┌──────────────▼────────────────┐
  │           engine               │  ← 这层是干净的
  └───────────────────────────────┘
</span></code></pre>
<p>上面两层塌成了一坨。改 HTTP 解析逻辑要动 conn 的代码，改 conn 的读取策略可能碰坏 HTTP 解析。<strong>两层的复杂度不是加在一起，是乘在一起。</strong></p>
<p>对比一下 engine 层。engine 层经过第五、六篇的重构，依赖方向是干净的：<code>js_event_t</code> 不知道上面是谁，通过回调隔离。第六篇引入 <code>js_engine_t</code> 的时候，改 engine 的内部结构（从 thread-local epfd 到显式 engine 参数），上层的连接逻辑完全不受影响。<strong>改下层不影响上层——这就是分层的回报。</strong></p>
<p>conn 层呢？如果你想换一种 HTTP 解析方式，或者想让 jsbench 支持非 HTTP 的协议，你会发现改不动——因为 conn 和 http 的代码纠缠在一起，改哪边都怕碰坏另一边。</p>
<p><strong>分层解决的核心问题是依赖。不是消除依赖，是让依赖单向。</strong> 依赖一旦单向，每层就能独立理解、独立修改、独立演进。</p>
<h2 data-id="heading-2">为什么 AI 会写成这样</h2>
<p>这个问题值得想一想。AI 写代码的目标是"让功能工作"。让一个 HTTP 客户端工作，最直接的方式就是：创建连接、发请求、读数据、解析响应、判断 keep-alive。这些步骤串起来，放在一组函数里，功能确实工作了。</p>
<p>但"让功能工作"和"让系统可演进"是两个不同的目标。分层是为后者服务的。<strong>层间的边界不是功能需求，是架构决策。</strong> AI 不会主动说"这里该切一刀，把传输和协议分开"——因为不切也能工作。</p>
<p>这也是前几篇的经验。第五篇 engine 层的重构，不是因为 AI 改不了 epoll 的代码，而是 AI 不会主动说"epfd 不该是参数，应该是线程的属性"。人给了方向，AI 执行得很好。conn 和 http 的分层也一样：AI 完全有能力做拆分，但"该不该拆、在哪里拆"，是人的判断。</p>
<h2 data-id="heading-3">去掉不合理</h2>
<p>方向明确了：把 conn 和 http 分开。从哪里下手？</p>
<p>改进架构有一个很朴素的方法：<strong>找到不合理的地方，去掉它。</strong> <code>conn_do_read()</code> 不应该做 HTTP 解析——去掉。<code>js_conn_t</code> 不应该内嵌 HTTP 响应——去掉。<code>js_conn_keepalive()</code> 不应该读 HTTP 头——去掉。一个一个去掉，层就自然分开了。</p>
<p>背后的道理很简单：<strong>一个函数做的事越多，它牵扯的概念就越多，改动它的理由也越多。</strong> 这有个经典的名字叫单一职责，但我更愿意用朴素的说法：让每个函数只做一件它该做的事。</p>
<p>当然这不是死规矩。<code>conn_do_write()</code> 写完数据之后设置 <code>c-&gt;state = CONN_READING</code>——写完切换到读，这是连接状态机的自然流转，没必要硬拆。<strong>判断的标准不是"做了几件事"，而是"这些事会不会各自独立变化"。</strong> 读字节和解析 HTTP 显然会——你完全可能换一种协议解析，或者换一种读取策略，它们各自有各自的变化理由。</p>
<h2 data-id="heading-4">第一步：引入 buffer，让读和解析分开</h2>
<p><code>conn_do_read()</code> 要改——让它只做读数据，不做解析。但读到的字节放哪里？</p>
<p>现在用的是栈上临时数组，读完立刻喂给解析器，用完就丢。如果不立刻处理，字节就需要一个地方存着。引入 <code>js_buf_t</code>：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> {</span>
    <span class="hljs-type">char</span>   *data;
    <span class="hljs-type">size_t</span>  len;     <span class="hljs-comment">/* 已有数据的长度 */</span>
    <span class="hljs-type">size_t</span>  cap;     <span class="hljs-comment">/* 分配的容量 */</span>
} <span class="hljs-type">js_buf_t</span>;
</code></pre>
<p>有了 buffer，<code>conn_do_read()</code> 变成了：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">conn_do_read</span><span class="hljs-params">(<span class="hljs-type">js_conn_t</span> *c)</span> {
    <span class="hljs-type">js_buf_t</span> *in = &amp;c-&gt;in;

    <span class="hljs-keyword">for</span> (;;) {
        js_buf_ensure(in, in-&gt;len + JS_READ_BUF_SIZE);

        <span class="hljs-type">ssize_t</span> n;
        <span class="hljs-keyword">if</span> (c-&gt;ssl) {
            n = js_tls_read(c-&gt;ssl, in-&gt;data + in-&gt;len, in-&gt;cap - in-&gt;len);
        } <span class="hljs-keyword">else</span> {
            n = read(c-&gt;socket.fd, in-&gt;data + in-&gt;len, in-&gt;cap - in-&gt;len);
        }

        <span class="hljs-keyword">if</span> (n &lt; <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">if</span> (errno == EAGAIN || errno == EWOULDBLOCK) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
            c-&gt;state = CONN_ERROR;
            <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;
        }
        <span class="hljs-keyword">if</span> (n == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;  <span class="hljs-comment">/* 对端关闭 */</span>

        in-&gt;len += (<span class="hljs-type">size_t</span>)n;
    }
}
</code></pre>
<p>没有 <code>js_http_response_feed</code>，没有 <code>c-&gt;state = CONN_DONE</code>，没有任何协议相关的判断。<strong>只做一件事：把字节从 socket 读到 buffer 里。</strong></p>
<p>HTTP 解析搬到了调用方——worker 和 loop 读完之后，从 <code>c-&gt;in</code> 取数据，自己喂给 HTTP 解析器。不再是 conn 推数据给解析器，而是调用者从 conn 的 buffer 里拉数据。<strong>这是整个分层工作中最关键的一步——conn 不再知道 HTTP 的存在。</strong></p>
<p>代码变更: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fhongzhidao%2Fjsbench%2Fcommit%2F47e4d2c" target="_blank" title="https://github.com/hongzhidao/jsbench/commit/47e4d2c" ref="nofollow noopener noreferrer">47e4d2c</a></p>
<h2 data-id="heading-5">第二步：给 conn 层一个正式的家</h2>
<p>之前连接相关的代码都在 <code>js_http_client.c</code> 里——文件名本身就暴露了问题：一个叫"HTTP 客户端"的文件，怎么能是一个干净的传输层？</p>
<p>新建 <code>js_conn.h</code> 和 <code>js_conn.c</code>，提取 <code>js_conn_read()</code> 作为第一个公开接口。<code>js_http_client.c</code> 里还留着 create、free、write、reuse、reset 这些函数，没有急着一次搬完。</p>
<p>我一直在有意识地避免过度设计。设计不足的代码是诚实的——它告诉你"这里还没想清楚"。过度设计的代码是伪装的——那些抽象可能猜错了未来的方向，等你真的需要改的时候，反而比没有抽象更难动。<strong>在没有足够信息的时候，少做比多做安全。</strong></p>
<p>代码变更: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fhongzhidao%2Fjsbench%2Fcommit%2F5c8c3bc" target="_blank" title="https://github.com/hongzhidao/jsbench/commit/5c8c3bc" ref="nofollow noopener noreferrer">5c8c3bc</a></p>
<h2 data-id="heading-6">第三步：去掉结构体里不该有的字段</h2>
<p>行为解耦了，模块也有了。但 <code>js_conn_t</code> 里还嵌着 <code>js_http_response_t response</code>。行为上分开了，结构上还绑着。</p>
<p>好的结构体应该是简洁的——<strong>它拥有的每个字段都应该是它需要的，而不是别人需要的。</strong></p>
<p>去掉之后，HTTP 响应放哪里？答案在已有的机制里。<code>js_event_t</code> 有一个 <code>void *data</code> 字段，让调用者自己持有 response，通过 <code>socket.data</code> 关联到连接：</p>
<pre><code class="hljs language-c" lang="c">js_http_response_init(&amp;responses[i]);
conns[i]-&gt;socket.data = &amp;responses[i];
</code></pre>
<p>读事件处理里，从 <code>socket.data</code> 取出 response：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">worker_on_read</span><span class="hljs-params">(<span class="hljs-type">js_event_t</span> *ev)</span> {
    <span class="hljs-type">js_conn_t</span> *c = (<span class="hljs-type">js_conn_t</span> *)ev;
    <span class="hljs-type">js_http_response_t</span> *r = c-&gt;socket.data;
    <span class="hljs-comment">/* ... */</span>
}
</code></pre>
<p><code>js_conn_keepalive()</code> 也搬到 worker 里，变成局部函数 <code>worker_keepalive()</code>。连接层不再需要知道 HTTP 协议的任何细节。</p>
<p>去掉 <code>response</code> 之后的 <code>js_conn_t</code>：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">js_conn</span> {</span>
    <span class="hljs-type">js_event_t</span>       socket;
    <span class="hljs-type">conn_state_t</span>     state;
    SSL             *ssl;

    <span class="hljs-type">const</span> <span class="hljs-type">char</span>      *req_data;
    <span class="hljs-type">size_t</span>           req_len;
    <span class="hljs-type">size_t</span>           req_sent;

    <span class="hljs-type">js_buf_t</span>         in;

    <span class="hljs-type">uint64_t</span>         start_ns;
    <span class="hljs-type">int</span>              req_index;
    <span class="hljs-type">void</span>            *udata;
} <span class="hljs-type">js_conn_t</span>;
</code></pre>
<p>没有任何 HTTP 相关的字段。连接就是连接。<strong>结构体的简洁程度，就是分层是否到位的直接体现。</strong></p>
<p>代码变更: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fhongzhidao%2Fjsbench%2Fcommit%2F0bbe6a3" target="_blank" title="https://github.com/hongzhidao/jsbench/commit/0bbe6a3" ref="nofollow noopener noreferrer">0bbe6a3</a></p>
<h2 data-id="heading-7">第四步：把类型搬回它该在的地方</h2>
<p><code>js_conn_t</code> 不再依赖 <code>js_http_response_t</code>，终于可以从 <code>js_main.h</code> 搬到 <code>js_conn.h</code>。之前搬不了，就是因为 <code>js_http_response_t</code> 定义在 <code>js_main.h</code> 中，内嵌了就搬不走。依赖去掉之后，障碍消失了。</p>
<p>conn 层开始有自己的轮廓了：类型在 <code>js_conn.h</code>，读实现在 <code>js_conn.c</code>，不依赖任何协议层的东西。create、free、write 这些函数还留在 <code>js_http_client.c</code> 里，但方向已经很清楚了。不急，一步一步来。</p>
<p>代码变更: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fhongzhidao%2Fjsbench%2Fcommit%2Fedc2859" target="_blank" title="https://github.com/hongzhidao/jsbench/commit/edc2859" ref="nofollow noopener noreferrer">edc2859</a></p>
<h2 data-id="heading-8">回头看</h2>
<p>四步做完，回到开头的问题：连接层里还住着那个 HTTP 解析器吗？</p>
<p>不在了。<code>js_conn_t</code> 里没有任何 HTTP 字段，<code>conn_do_read()</code> 不调任何 HTTP 函数，conn 模块有了自己的头文件和实现文件。conn 不知道 http 的存在——就像 engine 不知道 conn 的存在一样。</p>
<p>每一步做的都是同一件事：<strong>找到不合理的依赖，去掉它。</strong> 不需要提前设计完美的分层方案，不需要一次搬完所有代码。看到一个不合理的地方，去掉它，系统就比之前好一点。积累几步，层就自然分开了。</p>
<p>分层不是一种理论，是一种实用的手段。判断分层是否到位，有几个直观的检验方法：</p>
<ul>
<li><strong>看结构体。</strong> 每个字段都是自己需要的，还是替别人拿着的？</li>
<li><strong>看函数。</strong> 它做的事情是否属于同一层？读字节和解析协议不在同一层。</li>
<li><strong>看依赖方向。</strong> 下层有没有引用上层的类型或调用上层的函数？</li>
<li><strong>看头文件。</strong> 一个模块的 <code>.h</code> 能不能不依赖不相关的类型就编译通过？</li>
</ul>
<p>这些检验不需要画架构图，打开代码就能看到。</p>
<hr/>
<p>GitHub: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fhongzhidao%2Fjsbench" target="_blank" title="https://github.com/hongzhidao/jsbench" ref="nofollow noopener noreferrer">github.com/hongzhidao/…</a></p>
<p>更多文章和后续更新，关注微信公众号：<strong>程序员洪志道</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React Rnd实现自由拖动与边界检测]]></title>    <link>https://juejin.cn/post/7605131777175371839</link>    <guid>https://juejin.cn/post/7605131777175371839</guid>    <pubDate>2026-02-11T07:28:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605131777175371839" data-draft-id="7589052659435700270" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React Rnd实现自由拖动与边界检测"/> <meta itemprop="keywords" content="前端,React.js"/> <meta itemprop="datePublished" content="2026-02-11T07:28:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="码云之上"/> <meta itemprop="url" content="https://juejin.cn/user/1319873957601656"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React Rnd实现自由拖动与边界检测
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1319873957601656/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    码云之上
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-11T07:28:30.000Z" title="Wed Feb 11 2026 07:28:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在<code>AI 问答</code>烂大街的今天，只要是个平台都在搞聊天机器人，主要应用场景无非是问答式的“智能”客服。<br/>
笔者所在小团队维护着一个<code>OA</code>系统(技术栈：<code>react17</code> + <code>webpack5.0</code> + <code>tailwindcss</code> + <code>ArcoDesign</code>)，该系统沉淀了很多知识文档，经过后端同学的努力（据说是用了开源框架实现文档的<code>Embedding</code>）将其文档知识化，搭配司内部署的DeepSeek，基本实现了boss要求的智能问答。</p>
<h2 data-id="heading-0">智能问答UI</h2>
<p>因为是内部OA系统，使用者基本是HR小姐姐，她们给的需求基本是一句话描述，哈哈哈，也挺好，方便笔者自由发挥。
参（抄）考（袭）类似平台的交互，决定采用右侧抽屉的形式底部一个输入框，上方展示消息区：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e80c1fce68e145f2a5c265de3894bb09~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56CB5LqR5LmL5LiK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771399709&amp;x-signature=83kqaCnidEFVMwZ1yNQ72v5HSNI%3D" alt="Clipboard_Screenshot_1767011782.png" loading="lazy"/></p>
<h2 data-id="heading-1">搞事1.0</h2>
<p><strong>HR小姐姐：</strong> 这个对话框挺好用的，只是固定在页面左侧，能不能像微信一样自由拖动到屏幕其他位置？<br/>
我：额，这是前端页面，全屏幕拖动可实现不了，在当前页面拖动还可以努力一下。<br/>
<strong>HR小姐姐：</strong> 当前页面拖动不就是在显示屏上拖动嘛，有什么区别呢~<br/>
我：额...</p>
<h3 data-id="heading-2">实现</h3>
<p>要拖动是吧，那还不简单，都2025年了，拖动还不是随便找个库就可以打发实现。<br/>
首先想到的便是 <a href="https://link.juejin.cn?target=https%3A%2F%2Freact-dnd.github.io%2Freact-dnd%2Fabout" target="_blank" title="https://react-dnd.github.io/react-dnd/about" ref="nofollow noopener noreferrer">react-dnd</a> ，但是吧，这个库能力很强大，用来做单组件的拖动太杀鸡用牛刀了。而且笔者不喜欢重复以往的方案，喜欢用点新玩意儿。<br/>
继续 Searching，啊哈，还真找着了一个轻量且合适的库：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fbokuweb%2Freact-rnd" target="_blank" title="https://github.com/bokuweb/react-rnd" ref="nofollow noopener noreferrer">react-rnd</a><br/>
其文档中的例子和契合本次需求：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2f1e460d3f644a1195e242cf87708cc8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56CB5LqR5LmL5LiK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771399709&amp;x-signature=xVTBVBt8pU5gUVfutBILpzrx3Z4%3D" alt="screenshot.gif" loading="lazy"/></p>
<p>说干就干，引入 <code>react-rnd</code>，按照官方文档进行配置：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Rnd</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"react-rnd"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">DragForm</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Rnd</span>
      <span class="hljs-attr">default</span>=<span class="hljs-string">{{</span>
        <span class="hljs-attr">x:</span> <span class="hljs-attr">0</span>,
        <span class="hljs-attr">y:</span> <span class="hljs-attr">0</span>,
        <span class="hljs-attr">width:</span> <span class="hljs-attr">500</span>,
        <span class="hljs-attr">height:</span> <span class="hljs-attr">190</span>,
      }}
      <span class="hljs-attr">minWidth</span>=<span class="hljs-string">{500}</span>
      <span class="hljs-attr">minHeight</span>=<span class="hljs-string">{190}</span>
      <span class="hljs-attr">bounds</span>=<span class="hljs-string">"window"</span>
    &gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"drag__content"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">MyForm</span> /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">Rnd</span>&gt;</span></span>
  );
}
</code></pre>
<p>优化1完成，交差！</p>
<h2 data-id="heading-3">搞事1.1</h2>
<p><strong>HR小姐姐：</strong> 可以拖动啦，真的很丝滑唉~，能不能支持折叠？有时候我想看页面主体内容但是又不想关掉弹窗，关掉再打开历史记录就没了（当时着急交差，还不支持查看历史会话）。<br/>
好吧，我就知道没那么简单~<br/>
继续优化，折叠嘛，用上 <code>Collapse</code> 组件不就行了。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 下面为 demo 代码，使用简易 Form 代替了 Drawer 内容</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">DragForm</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Rnd</span>
      <span class="hljs-attr">default</span>=<span class="hljs-string">{{</span>
        <span class="hljs-attr">x:</span> <span class="hljs-attr">0</span>,
        <span class="hljs-attr">y:</span> <span class="hljs-attr">0</span>,
        <span class="hljs-attr">width:</span> <span class="hljs-attr">500</span>,
        <span class="hljs-attr">height:</span> <span class="hljs-attr">190</span>,
      }}
      <span class="hljs-attr">minWidth</span>=<span class="hljs-string">{500}</span>
      <span class="hljs-attr">minHeight</span>=<span class="hljs-string">{190}</span>
      <span class="hljs-attr">bounds</span>=<span class="hljs-string">"window"</span>
    &gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"drag__content"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Collapse</span> <span class="hljs-attr">expandIcon</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"collapse__header"</span> <span class="hljs-attr">defaultActiveKey</span>=<span class="hljs-string">"1"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">CollapseItem</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"1"</span> <span class="hljs-attr">header</span>=<span class="hljs-string">"折叠面板"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">MyForm</span> /&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">CollapseItem</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">Collapse</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">Rnd</span>&gt;</span></span>
  );
}
</code></pre>
<p>嗯，能拖动，能折叠，这回够用了吧。</p>
<h2 data-id="heading-4">搞事2.0</h2>
<p><strong>HR小姐姐：</strong> 不对啊，我这边展开内容后，下面部分被挡住了：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6e205483dc1a4d9494642a8d9a458bf9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56CB5LqR5LmL5LiK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771399709&amp;x-signature=otOviD2BlR5J%2F1geTbQ1g9sRe40%3D" alt="Clipboard_Screenshot_1767014151.png" loading="lazy"/></p>
<p>能不能让被挡住部分自动移动上来？不要让我手工调整位置？<br/>
好吧好吧，继续优化~</p>
<h3 data-id="heading-5">初步优化</h3>
<p>首先分析问题原因：</p>
<blockquote>
<p><code>Collapse</code> 展开、收起时会引发容器高度的变化，但是没有触发 <code>rnd</code> 容器的位置变化，造成内容被遮挡了，所以解决办法是监听 <code>Collapse</code> 的 <code>onChange</code> 事件，在回调里重新定位，防止<code>rnd</code> 容器溢出可视范围。</p>
</blockquote>
<p>效果：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/85c2c056bcc7465b9d92aef5989e5634~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56CB5LqR5LmL5LiK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771399709&amp;x-signature=vtWkclYatx26tWxyYskFfc6yFLI%3D" alt="Kapture 2026-02-11 at 15.05.46.gif" loading="lazy"/></p>
<h3 data-id="heading-6">进一步优化</h3>
<p>上面的处理可以解决 <code>Collapse</code> 展开时被遮挡问题，但是用户可以无限制拖动 <code>Collapse</code>，将 <code>Collapse</code> 拖动到视窗之外，所以还需要给拖动加上一个边界，防止内容被拖动到视窗之外。<br/>
这里有两种实现：</p>
<ol>
<li>限定拖动范围，当<code>Collapse</code>离开视窗时禁止拖动</li>
<li>增加兜底逻辑，当最后防止位置不在视窗范围内时，自动将<code>Collapse</code>定位到最低可视范围内</li>
</ol>
<p>综合用户体验，决定采用第二种实现。</p>
<h4 data-id="heading-7">提取工具类</h4>
<p>为了满足拖动后自动定位，需要实现一个工具函数，笔者刚开始写的时候确实是定义了一个function，最后发现内联方法越来越多，最后重构为一个 <code>Class</code>:</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">export</span> interface <span class="hljs-title class_">IPositionData</span> {
  <span class="hljs-attr">x</span>: number;
  <span class="hljs-attr">y</span>: number;
}
<span class="hljs-keyword">export</span> interface <span class="hljs-title class_">ISizeData</span> {
  <span class="hljs-attr">width</span>: number;
  <span class="hljs-attr">height</span>: number;
}

<span class="hljs-keyword">export</span> interface <span class="hljs-title class_">IHelpPanelRectData</span> {
  <span class="hljs-attr">defaultRightOffset</span>: number;
  <span class="hljs-attr">defaultBottomOffset</span>: number;
  <span class="hljs-attr">defaultTopOffset</span>: number;
  <span class="hljs-attr">defaultSize</span>: <span class="hljs-title class_">ISizeData</span>;
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">getDefaultRect</span> = (<span class="hljs-params">data: IHelpPanelRectData</span>) =&gt; {
  <span class="hljs-keyword">const</span> winWidth = <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span>;
  <span class="hljs-keyword">const</span> winHeight = <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span>;
  <span class="hljs-keyword">const</span> width = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(
    winWidth - data.<span class="hljs-property">defaultRightOffset</span>,
    data.<span class="hljs-property">defaultSize</span>.<span class="hljs-property">width</span>
  );
  <span class="hljs-keyword">const</span> height = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(
    winHeight - data.<span class="hljs-property">defaultBottomOffset</span> - data.<span class="hljs-property">defaultTopOffset</span>,
    data.<span class="hljs-property">defaultSize</span>.<span class="hljs-property">height</span>
  );
  <span class="hljs-keyword">const</span> position = {
    <span class="hljs-attr">x</span>: winWidth - width - data.<span class="hljs-property">defaultRightOffset</span>,
    <span class="hljs-attr">y</span>: winHeight - height - data.<span class="hljs-property">defaultBottomOffset</span>,
  };
  <span class="hljs-keyword">return</span> { <span class="hljs-attr">size</span>: { width, height }, position };
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelpPanelRect</span> {
  <span class="hljs-comment">// 拖动容器最小高度</span>
  public minHeight = <span class="hljs-number">100</span>;
  <span class="hljs-comment">// 拖动容器最小宽度</span>
  public minWidth = <span class="hljs-number">400</span>;
  <span class="hljs-comment">// 拖动容器最大高度</span>
  public maxHeight = <span class="hljs-number">1024</span>;
  <span class="hljs-comment">// 拖动容器最大宽度</span>
  public maxWidth = <span class="hljs-number">1024</span>;
  <span class="hljs-comment">// 默认上边距</span>
  public defaultTopOffset = <span class="hljs-number">20</span>;
  <span class="hljs-comment">// 当前上边距</span>
  public topOffset = <span class="hljs-number">20</span>;
  <span class="hljs-comment">// 默认右边距</span>
  public defaultRightOffset = <span class="hljs-number">20</span>;
  <span class="hljs-comment">// 当前右边距</span>
  public rightOffset = <span class="hljs-number">20</span>;
  <span class="hljs-comment">// 默认情况下距底高度，紧贴帮助按钮</span>
  public defaultBottomOffset = <span class="hljs-number">20</span>;
  <span class="hljs-comment">// 面板移动之后底部边距，0 表示紧贴窗口</span>
  public bottomOffset = <span class="hljs-number">20</span>;
  <span class="hljs-comment">// 默认大小</span>
  public defaultSize = {
    <span class="hljs-attr">width</span>: <span class="hljs-number">450</span>,
    <span class="hljs-attr">height</span>: <span class="hljs-number">457</span>,
  };
  <span class="hljs-comment">// 最大大小</span>
  public maxSize = {
    <span class="hljs-attr">width</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxWidth</span>,
    <span class="hljs-attr">height</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxHeight</span>,
  };

  private <span class="hljs-attr">prevSize</span>: <span class="hljs-title class_">ISizeData</span>;
  private <span class="hljs-attr">prevPosition</span>: <span class="hljs-title class_">IPositionData</span>;

  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">data: IHelpPanelRectData</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">defaultRightOffset</span> = data.<span class="hljs-property">defaultRightOffset</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">defaultBottomOffset</span> = data.<span class="hljs-property">defaultBottomOffset</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">defaultTopOffset</span> = data.<span class="hljs-property">defaultTopOffset</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">defaultSize</span> = data.<span class="hljs-property">defaultSize</span>;

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">prevSize</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">defaultSize</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">prevPosition</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getDefaultRect</span>(data).<span class="hljs-property">position</span>;
  }

  <span class="hljs-comment">// 点击入口按钮时的初始状态</span>
  <span class="hljs-title function_">getDefaultRect</span>(<span class="hljs-params">data?: IHelpPanelRectData</span>) {
    <span class="hljs-keyword">const</span> defaultRect = data ? <span class="hljs-title function_">getDefaultRect</span>(data) : <span class="hljs-title function_">getDefaultRect</span>(<span class="hljs-variable language_">this</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">prevSize</span> = defaultRect.<span class="hljs-property">size</span>;
    <span class="hljs-keyword">return</span> {
      ...defaultRect,
    };
  }

  <span class="hljs-comment">/**
   *
   * <span class="hljs-doctag">@param</span> windowIsResize 是否拖动浏览器窗口
   */</span>
  <span class="hljs-title function_">getRectByWindowResize</span>(<span class="hljs-params">windowIsResize = <span class="hljs-literal">false</span></span>) {
    <span class="hljs-keyword">const</span> winWidth = <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span>;
    <span class="hljs-keyword">const</span> winHeight = <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span>;
    <span class="hljs-keyword">let</span> { x, y } = <span class="hljs-variable language_">this</span>.<span class="hljs-property">prevPosition</span>;
    y = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(y, <span class="hljs-variable language_">this</span>.<span class="hljs-property">topOffset</span>);

    <span class="hljs-keyword">const</span> <span class="hljs-title function_">getMaxHeight</span> = (<span class="hljs-params"/>) =&gt;
      <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">minHeight</span>,
        <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(winHeight - y - <span class="hljs-variable language_">this</span>.<span class="hljs-property">bottomOffset</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxHeight</span>)
      );

    <span class="hljs-keyword">let</span> { width, height } = <span class="hljs-variable language_">this</span>.<span class="hljs-property">prevSize</span>;
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">rightOffset</span> + x + width &gt; winWidth) {
      <span class="hljs-keyword">if</span> (x &gt; <span class="hljs-number">0</span>) {
        x = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(winWidth - width - <span class="hljs-variable language_">this</span>.<span class="hljs-property">rightOffset</span>, <span class="hljs-number">0</span>);
      } <span class="hljs-keyword">else</span> {
        width = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">minWidth</span>,
          <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(winWidth - <span class="hljs-variable language_">this</span>.<span class="hljs-property">rightOffset</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxWidth</span>)
        );
      }
    }

    <span class="hljs-keyword">if</span> (y + height + <span class="hljs-variable language_">this</span>.<span class="hljs-property">bottomOffset</span> &gt; winHeight) {
      <span class="hljs-keyword">if</span> (y &gt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">topOffset</span>) {
        y = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">topOffset</span>, winHeight - height - <span class="hljs-variable language_">this</span>.<span class="hljs-property">bottomOffset</span>);
      } <span class="hljs-keyword">else</span> {
        height = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">minHeight</span>,
          <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(
            winHeight - <span class="hljs-variable language_">this</span>.<span class="hljs-property">topOffset</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">bottomOffset</span>,
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxHeight</span>
          )
        );
      }
    } <span class="hljs-keyword">else</span> {
      height = windowIsResize
        ? <span class="hljs-title function_">getMaxHeight</span>()
        : <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(height, winHeight - <span class="hljs-variable language_">this</span>.<span class="hljs-property">bottomOffset</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">topOffset</span>);
    }

    <span class="hljs-keyword">return</span> { <span class="hljs-attr">size</span>: { width, height }, <span class="hljs-attr">position</span>: { x, y } };
  }

  <span class="hljs-comment">/**
   * 尺寸不变，只调整位置
   * <span class="hljs-doctag">@param</span> position 拖动之后的位置
   */</span>
  <span class="hljs-title function_">getRectByPosition</span>(<span class="hljs-params">position: IPositionData</span>) {
    <span class="hljs-keyword">const</span> winWidth = <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span>;
    <span class="hljs-keyword">const</span> winHeight = <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span>;
    <span class="hljs-keyword">const</span> { width, height } = <span class="hljs-variable language_">this</span>.<span class="hljs-property">prevSize</span>;

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">prevPosition</span> = {
      <span class="hljs-attr">x</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">0</span>, position.<span class="hljs-property">x</span>), winWidth - width - <span class="hljs-variable language_">this</span>.<span class="hljs-property">rightOffset</span>),
      <span class="hljs-attr">y</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(
        <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">0</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">topOffset</span>, position.<span class="hljs-property">y</span>),
        winHeight - height - <span class="hljs-variable language_">this</span>.<span class="hljs-property">bottomOffset</span>
      ),
    };

    <span class="hljs-keyword">return</span> { <span class="hljs-attr">size</span>: { width, height }, <span class="hljs-attr">position</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">prevPosition</span> };
  }

  <span class="hljs-title function_">getRectByResize</span>(<span class="hljs-params">pos?: IPositionData, s?: ISizeData</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">prevSize</span> = s ?? <span class="hljs-variable language_">this</span>.<span class="hljs-property">prevSize</span>;

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">prevPosition</span> = pos ?? <span class="hljs-variable language_">this</span>.<span class="hljs-property">prevPosition</span>;

    <span class="hljs-keyword">const</span> { size, position } = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getRectByWindowResize</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">prevSize</span> = size;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">prevPosition</span> = position;
    <span class="hljs-keyword">return</span> { size, position };
  }

  <span class="hljs-title function_">getRect</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">position</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">prevPosition</span>, <span class="hljs-attr">size</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">prevSize</span> };
  }

  <span class="hljs-title function_">setRect</span>(<span class="hljs-params">position?: IPositionData, size?: ISizeData</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">prevPosition</span> = position ?? <span class="hljs-variable language_">this</span>.<span class="hljs-property">prevPosition</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">prevSize</span> = size ?? <span class="hljs-variable language_">this</span>.<span class="hljs-property">prevSize</span>;
  }

  <span class="hljs-title function_">setDefaultSize</span>(<span class="hljs-params">size: ISizeData</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">defaultSize</span> = size;
  }

  <span class="hljs-title function_">setSize</span>(<span class="hljs-params">size: ISizeData</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">prevSize</span> = size;
  }

  <span class="hljs-title function_">resetSize</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">prevSize</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">defaultSize</span>;
  }

  <span class="hljs-title function_">resetPosition</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> winWidth = <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span>;
    <span class="hljs-keyword">const</span> winHeight = <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span>;
    <span class="hljs-keyword">const</span> { height, width } = <span class="hljs-variable language_">this</span>.<span class="hljs-property">prevSize</span>;

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">prevPosition</span> = {
      <span class="hljs-attr">x</span>: winWidth - width - <span class="hljs-variable language_">this</span>.<span class="hljs-property">defaultRightOffset</span>,
      <span class="hljs-attr">y</span>: winHeight - height - <span class="hljs-variable language_">this</span>.<span class="hljs-property">defaultBottomOffset</span>,
    };
  }

  <span class="hljs-comment">/**
   * 重置布局
   */</span>
  <span class="hljs-title function_">resetRect</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">resetSize</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">resetPosition</span>();
  }
}
</code></pre>
<p>使用示例：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Rnd</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"react-rnd"</span>;
<span class="hljs-keyword">import</span> {
  <span class="hljs-title class_">Form</span>,
  <span class="hljs-title class_">Input</span>,
  <span class="hljs-title class_">Checkbox</span>,
  <span class="hljs-title class_">Button</span>,
  <span class="hljs-title class_">Radio</span>,
  <span class="hljs-title class_">Collapse</span>,
} <span class="hljs-keyword">from</span> <span class="hljs-string">"@arco-design/web-react"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">"./DragForm.less"</span>;
<span class="hljs-keyword">import</span> { useRef, useState, useLayoutEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">HelpPanelRect</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"../utils/HelpPanelRect"</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title class_">FormItem</span> = <span class="hljs-title class_">Form</span>.<span class="hljs-property">Item</span>;
<span class="hljs-keyword">const</span> <span class="hljs-title class_">RadioGroup</span> = <span class="hljs-title class_">Radio</span>.<span class="hljs-property">Group</span>;
<span class="hljs-keyword">const</span> <span class="hljs-title class_">CollapseItem</span> = <span class="hljs-title class_">Collapse</span>.<span class="hljs-property">Item</span>;

<span class="hljs-keyword">const</span> helpPanelRect = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HelpPanelRect</span>({
  <span class="hljs-attr">defaultRightOffset</span>: <span class="hljs-number">20</span>,
  <span class="hljs-attr">defaultBottomOffset</span>: <span class="hljs-number">20</span>,
  <span class="hljs-attr">defaultTopOffset</span>: <span class="hljs-number">20</span>,
  <span class="hljs-attr">defaultSize</span>: {
    <span class="hljs-attr">width</span>: <span class="hljs-number">400</span>,
    <span class="hljs-attr">height</span>: <span class="hljs-number">300</span>,
  },
});

<span class="hljs-comment">/**
 *
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">DragForm</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> panelRef = useRef&lt;<span class="hljs-title class_">HTMLDivElement</span>&gt;(<span class="hljs-literal">null</span>);

  <span class="hljs-comment">// 浮窗大小</span>
  <span class="hljs-keyword">const</span> [floatPanelSize, setFloatPanelSize] = <span class="hljs-title function_">useState</span>(
    helpPanelRect.<span class="hljs-property">defaultSize</span>
  );
  <span class="hljs-comment">// 浮窗坐标</span>
  <span class="hljs-keyword">const</span> [floatPanelPosition, setFloatPanelPosition] = <span class="hljs-title function_">useState</span>(
    helpPanelRect.<span class="hljs-title function_">getDefaultRect</span>().<span class="hljs-property">position</span>
  );

  <span class="hljs-title function_">useLayoutEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (!panelRef.<span class="hljs-property">current</span>) {
      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-keyword">const</span> target = panelRef.<span class="hljs-property">current</span>;
    <span class="hljs-keyword">const</span> resizeObserver = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResizeObserver</span>(<span class="hljs-function">(<span class="hljs-params">entries</span>) =&gt;</span> {
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> entry <span class="hljs-keyword">of</span> entries) {
        <span class="hljs-keyword">const</span> { width, height } = entry.<span class="hljs-property">contentRect</span>;
        <span class="hljs-keyword">if</span> (
          width === floatPanelSize.<span class="hljs-property">width</span> &amp;&amp;
          height === floatPanelSize.<span class="hljs-property">height</span>
        ) {
          <span class="hljs-keyword">continue</span>;
        }
        <span class="hljs-title function_">setFloatPanelSize</span>({ width, height });
        helpPanelRect.<span class="hljs-title function_">setDefaultSize</span>({ width, height });
        <span class="hljs-comment">// 更新面板高度</span>
        <span class="hljs-keyword">const</span> newSize = {
          ...floatPanelSize,
          height,
        };

        <span class="hljs-comment">// 获取当前位置并调整，确保面板不会超出视口</span>
        <span class="hljs-keyword">const</span> currentRect = helpPanelRect.<span class="hljs-title function_">getRectByResize</span>(
          floatPanelPosition,
          newSize
        );

        <span class="hljs-title function_">setFloatPanelSize</span>(currentRect.<span class="hljs-property">size</span>);
        <span class="hljs-title function_">setFloatPanelPosition</span>(currentRect.<span class="hljs-property">position</span>);
      }
    });
    <span class="hljs-keyword">if</span> (target) {
      resizeObserver.<span class="hljs-title function_">observe</span>(target);
    }

    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
      resizeObserver.<span class="hljs-title function_">disconnect</span>();
    };
  }, [panelRef, floatPanelSize, floatPanelPosition]);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Rnd</span>
      <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span>
        <span class="hljs-attr">pointerEvents:</span> "<span class="hljs-attr">all</span>",
        <span class="hljs-attr">zIndex:</span> <span class="hljs-attr">101</span>,
      }}
      <span class="hljs-attr">className</span>=<span class="hljs-string">"float-panel"</span>
      <span class="hljs-attr">disableDragging</span>=<span class="hljs-string">{false}</span>
      <span class="hljs-attr">enableResizing</span>=<span class="hljs-string">{{</span>
        <span class="hljs-attr">bottom:</span> <span class="hljs-attr">false</span>,
        <span class="hljs-attr">bottomLeft:</span> <span class="hljs-attr">false</span>,
        <span class="hljs-attr">bottomRight:</span> <span class="hljs-attr">false</span>,
        <span class="hljs-attr">left:</span> <span class="hljs-attr">false</span>,
        <span class="hljs-attr">right:</span> <span class="hljs-attr">false</span>,
        <span class="hljs-attr">top:</span> <span class="hljs-attr">false</span>,
        <span class="hljs-attr">topLeft:</span> <span class="hljs-attr">false</span>,
        <span class="hljs-attr">topRight:</span> <span class="hljs-attr">false</span>,
      }}
      <span class="hljs-attr">position</span>=<span class="hljs-string">{floatPanelPosition}</span>
      <span class="hljs-attr">size</span>=<span class="hljs-string">{floatPanelSize}</span>
      <span class="hljs-attr">maxWidth</span>=<span class="hljs-string">{helpPanelRect.maxWidth}</span>
      <span class="hljs-attr">maxHeight</span>=<span class="hljs-string">{helpPanelRect.maxHeight}</span>
      <span class="hljs-attr">minHeight</span>=<span class="hljs-string">{helpPanelRect.minHeight}</span>
      <span class="hljs-attr">minWidth</span>=<span class="hljs-string">{helpPanelRect.minWidth}</span>
      <span class="hljs-attr">onResizeStop</span>=<span class="hljs-string">{(e,</span> <span class="hljs-attr">direction</span>, <span class="hljs-attr">ref</span>, <span class="hljs-attr">delta</span>, <span class="hljs-attr">position</span>) =&gt;</span> {
        const currentRect = helpPanelRect.getRectByResize(position, {
          width: parseInt(ref.style.width, 10),
          height: parseInt(ref.style.height, 10),
        });
        setFloatPanelSize(currentRect.size);
        setFloatPanelPosition(currentRect.position);
      }}
      onDragStop={(e, data) =&gt; {
        const currentRect = helpPanelRect.getRectByPosition(data);
        setFloatPanelSize(currentRect.size);
        setFloatPanelPosition(currentRect.position);
      }}
      dragHandleClassName="drag__content"
    &gt;
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">{panelRef}</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"drag__content"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">header</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"drag__header"</span>&gt;</span>拖动区域<span class="hljs-tag">&lt;/<span class="hljs-name">header</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Collapse</span> <span class="hljs-attr">expandIcon</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"collapse__header"</span> <span class="hljs-attr">defaultActiveKey</span>=<span class="hljs-string">"1"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">CollapseItem</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"1"</span> <span class="hljs-attr">header</span>=<span class="hljs-string">"折叠面板"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">MyForm</span> /&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">CollapseItem</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">Collapse</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">Rnd</span>&gt;</span></span>
  );
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">MyForm</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Form</span>
      <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span>
        <span class="hljs-attr">maxWidth:</span> <span class="hljs-attr">600</span>,
      }}
      <span class="hljs-attr">autoComplete</span>=<span class="hljs-string">"off"</span>
      <span class="hljs-attr">layout</span>=<span class="hljs-string">{</span>"<span class="hljs-attr">vertical</span>"}
    &gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">FormItem</span> <span class="hljs-attr">label</span>=<span class="hljs-string">"Layout"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">RadioGroup</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"button"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"layout"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">Radio</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"horizontal"</span>&gt;</span>horizontal<span class="hljs-tag">&lt;/<span class="hljs-name">Radio</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">Radio</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"vertical"</span>&gt;</span>vertical<span class="hljs-tag">&lt;/<span class="hljs-name">Radio</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">Radio</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"inline"</span>&gt;</span>inline<span class="hljs-tag">&lt;/<span class="hljs-name">Radio</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">RadioGroup</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">FormItem</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">FormItem</span>
        <span class="hljs-attr">label</span>=<span class="hljs-string">"Username"</span>
        <span class="hljs-attr">field</span>=<span class="hljs-string">"username"</span>
        <span class="hljs-attr">tooltip</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">div</span>&gt;</span>Username is required <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>}
        rules={[{ required: true }]}
      &gt;
        <span class="hljs-tag">&lt;<span class="hljs-name">Input</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">width:</span> <span class="hljs-attr">270</span> }} <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"please enter your name"</span> /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">FormItem</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">FormItem</span> <span class="hljs-attr">label</span>=<span class="hljs-string">"Post"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Input</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">width:</span> <span class="hljs-attr">270</span> }} <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"please enter your post"</span> /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">FormItem</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">FormItem</span> <span class="hljs-attr">wrapperCol</span>=<span class="hljs-string">{{}}</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Checkbox</span>&gt;</span>I have read the manual<span class="hljs-tag">&lt;/<span class="hljs-name">Checkbox</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">FormItem</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">FormItem</span> <span class="hljs-attr">wrapperCol</span>=<span class="hljs-string">{{}}</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"primary"</span> <span class="hljs-attr">htmlType</span>=<span class="hljs-string">"submit"</span>&gt;</span>
          Submit
        <span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">FormItem</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">Form</span>&gt;</span></span>
  );
}
</code></pre>
<p>上面的代码基本演示了 <code>HelpPanelRect</code> 的使用。</p>
<blockquote>
<p>PS: 第一步优化中监听 <code>Collapse</code> 的 <code>onChange</code> 事件来重新定位的实现被我改成了监听 ResizeObserver，这样可以解决真正展开、收起 <code>Collapse</code> 后误触发重新定位的bug</p>
</blockquote>
<h3 data-id="heading-8">最终效果</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/08ebcd5e26dc4e979e7be900d93c5c2a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56CB5LqR5LmL5LiK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771399709&amp;x-signature=%2F2sxcZGv2yAKvP%2FmI8t0xFDoNfo%3D" alt="Kapture 2026-02-11 at 15.19.58.gif" loading="lazy"/></p>
<h2 data-id="heading-9">小结</h2>
<ol>
<li>全屏拖拽应该是很常见的功能，社区里也有很多好的实现，但是有特殊位置要求时就需要有额外开发；</li>
<li>文中的工具函数结合<code>react-rnd</code>可以适配很多拖拽时有边界控制的场景，希望给大家带来一点帮助。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Agent开发应知应会(Langfuse)：1.Langfuse的两种使用方式]]></title>    <link>https://juejin.cn/post/7605135197166272562</link>    <guid>https://juejin.cn/post/7605135197166272562</guid>    <pubDate>2026-02-11T06:04:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605135197166272562" data-draft-id="7605164560711122970" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Agent开发应知应会(Langfuse)：1.Langfuse的两种使用方式"/> <meta itemprop="keywords" content="LangChain,AI编程,AIGC"/> <meta itemprop="datePublished" content="2026-02-11T06:04:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="zaizaizhao"/> <meta itemprop="url" content="https://juejin.cn/user/906425682113933"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Agent开发应知应会(Langfuse)：1.Langfuse的两种使用方式
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/906425682113933/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    zaizaizhao
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-11T06:04:08.000Z" title="Wed Feb 11 2026 06:04:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><blockquote>
<p>最近在做一个 Text-to-SQL 的 Agent 项目 <strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fzaizaizhao%2Feasysql" target="_blank" title="https://github.com/zaizaizhao/easysql" ref="nofollow noopener noreferrer">EasySQL</a></strong>，用 LangGraph 搭的状态机，跑通之后遇到一个头疼的问题：Agent 内部 LLM 调了几轮、每轮花了多少 Token、SQL 生成到底在哪一步挂的……全是黑盒，日志翻到眼花也拼不出完整链路。后来接了 Langfuse，瞬间清爽了。这篇文章就把我踩过的坑和两种接入方式整理一下，代码都是从项目里直接搬的。</p>
</blockquote>
<h4 data-id="heading-0">什么是langfuse</h4>
<p>Langfuse 是一个开源的 LLM 可观测性平台（LLM Observability Platform），专门为LLM 应用设计。它能自动捕获：</p>
<ul>
<li>每次 LLM 调用的输入/输出/Token 用量/延迟/成本</li>
<li>Agent 工具调用的完整链路追踪（Trace）</li>
<li>多步骤 Pipeline 中每个节点的耗时和状态</li>
</ul>
<p>可以把 Langfuse 理解为：给你的 AI Agent 装一个"黑匣子记录仪"。它主要做以下四件事</p>
<ol>
<li>Tracing:看到你的 Agent 每一步做了什么、花了多久、用了多少 Token</li>
<li>Evaluation:给每次调用打分——自动(LLM-as-Judge)、手动、或代码评分</li>
<li>Prompt Management:版本控制 prompt，A/B 测试不同 prompt 效果</li>
<li>Metrics &amp; Dashboards:聚合看成本、延迟、质量趋势</li>
</ol>
<p>核心数据模型（这是理解 Langfuse 一切的基础）：</p>
<h4 data-id="heading-1">langfuse核心数据模型</h4>
<p>Langfuse 的可观测性数据模型：</p>






























<table><thead><tr><th>SESSION</th><th>一个用户的多轮对话会话（可选）</th><th>用户打开聊天窗口到关闭的整个过程</th></tr></thead><tbody><tr><td>TRACE</td><td>一次完整的端到端请求</td><td>用户问"查询本月订单"，从接收到返回结果</td></tr><tr><td>SPAN</td><td>一个有开始/结束时间的工作单元</td><td>Schema 检索、Neo4j 查询、Prompt 构建</td></tr><tr><td>GENERATION</td><td>一次 LLM API 调用（最核心的观测类型）</td><td>调用 genimi-3-flash 生成 SQL</td></tr><tr><td>EVENT</td><td>一个时间点事件（无持续时间）</td><td>日志记录、异常捕获</td></tr></tbody></table>
<p>GENERATION 自动捕获的信息：</p>
<ul>
<li>
<p>输入/输出 Token 数</p>
</li>
<li>
<p>成本（$）</p>
</li>
<li>
<p>延迟（ms）</p>
</li>
<li>
<p>使用的模型名称</p>
</li>
<li>
<p>完整的 prompt 和 completion</p>
</li>
</ul>
<p>Observations 可以无限嵌套——一个 SPAN 内可以包含子 SPAN、GENERATION、EVENT 等，形成树状结构。SCORE（评分） 可以附加在 TRACE 或 OBSERVATION 上，支持 NUMERIC（数值）、BOOLEAN（布尔）、CATEGORICAL（分类）三种类型，用于评估质量。</p>
<h3 data-id="heading-2">一. 自动callback实现Langfuse集成</h3>
<h5 data-id="heading-3">原理</h5>
<p>利用 LangChain 框架内置的 callback 机制，Langfuse 提供一个 CallbackHandler，传入 invoke() 的 config 中。LangChain/LangGraph执行过程中的每个事件（LLM 调用、工具调用、链执行等）都会自动触发 callback，Langfuse 据此构建完整的 Trace 树。</p>
<h4 data-id="heading-4">项目使用</h4>
<h5 data-id="heading-5">配置层</h5>
<p>定义配置类</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">LangfuseConfig</span>(<span class="hljs-title class_ inherited__">BaseSettings</span>):
    <span class="hljs-string">"""
    Configuration for LangFuse observability.

    LangFuse provides tracing and monitoring for LLM applications.
    All settings can be overridden via LANGFUSE_* environment variables.
    """</span>

    model_config = SettingsConfigDict(env_file=<span class="hljs-string">".env"</span>, env_file_encoding=<span class="hljs-string">"utf-8"</span>, extra=<span class="hljs-string">"ignore"</span>)

    enabled: <span class="hljs-built_in">bool</span> = Field(
        default=<span class="hljs-literal">False</span>, alias=<span class="hljs-string">"langfuse_enabled"</span>, description=<span class="hljs-string">"Enable LangFuse tracing"</span>
    )
    public_key: <span class="hljs-built_in">str</span> | <span class="hljs-literal">None</span> = Field(
        default=<span class="hljs-literal">None</span>, alias=<span class="hljs-string">"langfuse_public_key"</span>, description=<span class="hljs-string">"LangFuse public key"</span>
    )
    secret_key: <span class="hljs-built_in">str</span> | <span class="hljs-literal">None</span> = Field(
        default=<span class="hljs-literal">None</span>, alias=<span class="hljs-string">"langfuse_secret_key"</span>, description=<span class="hljs-string">"LangFuse secret key"</span>
    )
    host: <span class="hljs-built_in">str</span> = Field(
        default=<span class="hljs-string">"https://cloud.langfuse.com"</span>,
        alias=<span class="hljs-string">"langfuse_host"</span>,
        description=<span class="hljs-string">"LangFuse host URL (cloud or self-hosted)"</span>,
    )

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">is_configured</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-built_in">bool</span>:
        <span class="hljs-string">"""Check if LangFuse is properly configured with required credentials."""</span>
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">bool</span>(self.enabled <span class="hljs-keyword">and</span> self.public_key <span class="hljs-keyword">and</span> self.secret_key)
</code></pre>
<ul>
<li>enabled：总开关，读取环境变量 LANGFUSE_ENABLED，默认 false</li>
<li>public_key / secret_key：Langfuse 项目的 API 密钥对，在 Langfuse 仪表盘的 Settings → API Keys 中生成</li>
<li>host：Langfuse 服务地址。如果用 Langfuse Cloud 就是 <a href="https://link.juejin.cn?target=https%3A%2F%2Fcloud.langfuse.com%25EF%25BC%259B%25E5%25A6%2582%25E6%259E%259C%25E8%2587%25AA%25E5%25BB%25BA%25E5%25B0%25B1%25E5%25A1%25AB%25E4%25BD%25A0%25E8%2587%25AA%25E5%25B7%25B1%25E7%259A%2584%25E5%259C%25B0%25E5%259D%2580%25E5%25A6%2582" target="_blank" title="https://cloud.langfuse.com%EF%BC%9B%E5%A6%82%E6%9E%9C%E8%87%AA%E5%BB%BA%E5%B0%B1%E5%A1%AB%E4%BD%A0%E8%87%AA%E5%B7%B1%E7%9A%84%E5%9C%B0%E5%9D%80%E5%A6%82" ref="nofollow noopener noreferrer">cloud.langfuse.com如果自建就填你自己的地址如</a> <a href="https://link.juejin.cn?target=http%3A%2F%2Flocalhost%3A3000" target="_blank" title="http://localhost:3000" ref="nofollow noopener noreferrer">http://localhost:3000</a></li>
<li>is_configured()：三个条件全满足才算配置完成——enabled=true 且两个 key 都有值</li>
</ul>
<p>代码中通过 get_settings().langfuse.is_configured() 来判断是否启用。</p>
<h5 data-id="heading-6">callback工厂函数</h5>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_langfuse_callbacks</span>() -&gt; <span class="hljs-built_in">list</span>[<span class="hljs-type">Any</span>]:
    <span class="hljs-string">"""Get LangFuse callback handlers if configured."""</span>
    settings = get_settings()
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> settings.langfuse.is_configured():
        <span class="hljs-keyword">return</span> []                          <span class="hljs-comment"># ← 未配置则返回空列表，不影响正常运行</span>
    <span class="hljs-keyword">try</span>:
        <span class="hljs-keyword">import</span> os
        <span class="hljs-keyword">from</span> langfuse.langchain <span class="hljs-keyword">import</span> CallbackHandler   <span class="hljs-comment"># ← 关键：LangChain 回调处理器</span>
        os.environ.setdefault(<span class="hljs-string">"LANGFUSE_PUBLIC_KEY"</span>, settings.langfuse.public_key <span class="hljs-keyword">or</span> <span class="hljs-string">""</span>)
        os.environ.setdefault(<span class="hljs-string">"LANGFUSE_SECRET_KEY"</span>, settings.langfuse.secret_key <span class="hljs-keyword">or</span> <span class="hljs-string">""</span>)
        os.environ.setdefault(<span class="hljs-string">"LANGFUSE_HOST"</span>, settings.langfuse.host)
        <span class="hljs-keyword">return</span> [CallbackHandler()]         <span class="hljs-comment"># ← 返回一个 CallbackHandler 实例</span>
    <span class="hljs-keyword">except</span> ImportError:
        logger.warning(<span class="hljs-string">"langfuse package not installed, tracing disabled"</span>)
        <span class="hljs-keyword">return</span> []
</code></pre>
<p>这里发生了什么？</p>
<ol>
<li>先检查配置是否完整，不完整就返回空 []</li>
<li>将配置中的密钥写入环境变量（os.environ.setdefault）。这是因为 CallbackHandler() 在实例化时会自动从环境变量读取 LANGFUSE_PUBLIC_KEY、LANGFUSE_SECRET_KEY、LANGFUSE_HOST</li>
<li>创建 CallbackHandler() 实例并返回。这个 Handler 实现了 LangChain 的 BaseCallbackHandler 接口，会自动拦截所有 LangChain/LangGraph 的事件（LLM 调用开始/结束、工具调用、链执行等）</li>
</ol>
<p>CallbackHandler 能自动捕获什么？</p>
<ul>
<li>每个 LLM 调用的 prompt、completion、model name、token 数、延迟</li>
<li>每个 tool 调用的输入输出</li>
<li>LangGraph 中每个 node 的执行流程</li>
<li>错误和异常</li>
</ul>
<h5 data-id="heading-7">注入到 LangGraph 执行</h5>
<p>首先需要在将上面的callbacks写入到agent调用的传参RunnableConfig对象中。也就是RunnableConfig源码定义中的callbacks中</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">RunnableConfig</span>(TypedDict, total=<span class="hljs-literal">False</span>):
    <span class="hljs-string">"""Configuration for a `Runnable`.

    See the [reference docs](https://reference.langchain.com/python/langchain_core/runnables/#langchain_core.runnables.RunnableConfig)
    for more details.
    """</span>

    tags: <span class="hljs-built_in">list</span>[<span class="hljs-built_in">str</span>]
    <span class="hljs-string">"""Tags for this call and any sub-calls (e.g. a Chain calling an LLM).

    You can use these to filter calls.
    """</span>

    metadata: <span class="hljs-built_in">dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]
    <span class="hljs-string">"""Metadata for this call and any sub-calls (e.g. a Chain calling an LLM).

    Keys should be strings, values should be JSON-serializable.
    """</span>

    callbacks: Callbacks
    <span class="hljs-string">"""Callbacks for this call and any sub-calls (e.g. a Chain calling an LLM).

    Tags are passed to all callbacks, metadata is passed to handle*Start callbacks.
    """</span>

    run_name: <span class="hljs-built_in">str</span>
    <span class="hljs-string">"""Name for the tracer run for this call.

    Defaults to the name of the class."""</span>
</code></pre>
<p>项目代码抽取了一层专门做RunnableConfig配置的构建</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">QueryService</span>:

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, repository: SessionRepository</span>) -&gt; <span class="hljs-literal">None</span>:
        self._graph: <span class="hljs-type">Any</span> = <span class="hljs-literal">None</span>
        self._repo = repository
        self._callbacks: <span class="hljs-built_in">list</span>[<span class="hljs-type">Any</span>] | <span class="hljs-literal">None</span> = <span class="hljs-literal">None</span>

<span class="hljs-meta">    @property</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">callbacks</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-built_in">list</span>[<span class="hljs-type">Any</span>]:
        <span class="hljs-keyword">if</span> self._callbacks <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
            self._callbacks = get_langfuse_callbacks()   <span class="hljs-comment"># ← 懒加载，只初始化一次</span>
        <span class="hljs-keyword">return</span> self._callbacks

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_make_config</span>(<span class="hljs-params">self, session_id: <span class="hljs-built_in">str</span>, thread_id: <span class="hljs-built_in">str</span> | <span class="hljs-literal">None</span> = <span class="hljs-literal">None</span></span>) -&gt; RunnableConfig:
        effective_thread_id = thread_id <span class="hljs-keyword">or</span> session_id
        config: RunnableConfig = {<span class="hljs-string">"configurable"</span>: {<span class="hljs-string">"thread_id"</span>: effective_thread_id}}
        <span class="hljs-keyword">if</span> self.callbacks:
            config[<span class="hljs-string">"callbacks"</span>] = self.callbacks
            logger.debug(<span class="hljs-string">f"LangFuse callbacks attached: <span class="hljs-subst">{<span class="hljs-built_in">len</span>(self.callbacks)}</span> handler(s)"</span>)
        <span class="hljs-keyword">return</span> config
</code></pre>
<p>agent调用的时候传入</p>
<pre><code class="hljs language-python" lang="python">            <span class="hljs-keyword">async</span> <span class="hljs-keyword">for</span> chunk <span class="hljs-keyword">in</span> self.graph.astream(
                input_state,
                self._make_config(session.session_id, effective_thread_id),
                stream_mode=[<span class="hljs-string">"updates"</span>, <span class="hljs-string">"custom"</span>],
            ):
</code></pre>
<p>graph.astream会发生如下流程</p>
<ol>
<li>LangGraph 内部读取 config["callbacks"]</li>
<li>每个 node/LLM 调用都触发 CallbackHandler 的回调方法</li>
<li>CallbackHandler 将事件发送到 Langfuse 服务</li>
</ol>
<h5 data-id="heading-8">缺点：</h5>
<ul>
<li>只能追踪 LangChain/LangGraph 内部 —— 框架外的自定义 Python 代码（如 Milvus 查询、Neo4j 查询）不可见</li>
<li>Trace 结构由框架决定 —— 控制力有限，命名和层级结构取决于 LangChain 的回调事件</li>
</ul>
<h3 data-id="heading-9">二. 手动Span追踪</h3>
<h4 data-id="heading-10">原理：</h4>
<p>直接使用 Langfuse SDK，通过 <code>@observe()</code> 装饰器或 <code>start_as_current_observation() </code>上下文管理器，手动控制 Trace 和 Span的创建。被装饰的函数自动形成父子嵌套关系。</p>
<h4 data-id="heading-11">我这里为什么需要手动Span</h4>
<p>Agent 内部的多轮迭代中每一步（LLM 调用、工具调用）已经被 CallbackHandler 自动追踪。手动 Span的目的不是追踪这些步骤本身，而是在这些细粒度追踪之上添加一个业务语义的汇总节点——直接记录最终 SQL、是否通过验证、总共迭代了几轮，这样Langfuse UI 中不需要逐条翻看就能快速了解这次 Agent 执行的结果。</p>
<p>也就是说，我希望提供一个结果汇总层，而非追踪流程本身，成功时展示如下</p>
<pre><code class="hljs language-python" lang="python">span.update(output={
      <span class="hljs-string">"sql"</span>: last_sql,
      <span class="hljs-string">"success"</span>: validation_passed,
      <span class="hljs-string">"iterations"</span>: iteration,
  })
</code></pre>
<p>失败时展示如下</p>
<pre><code class="hljs language-python" lang="python">span.update(output={<span class="hljs-string">"error"</span>: <span class="hljs-built_in">str</span>(e)}, level=<span class="hljs-string">"ERROR"</span>)
</code></pre>
<p>因此手动创建 span 可以：</p>
<ul>
<li>自定义记录初始输入（用户查询、数据库名）</li>
<li>在 Langfuse UI 中清晰地看到"SQL Agent 执行"这个整体以及自定义的信息，而不仅仅是零散的 LLM 调用</li>
</ul>
<h4 data-id="heading-12">项目使用</h4>
<ol>
<li>获取langfuse客户端</li>
</ol>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">_get_langfuse_client</span>():
    <span class="hljs-string">"""获取 Langfuse 全局客户端（单例模式）"""</span>
    settings = get_settings()
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> settings.langfuse.is_configured():
        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>
    <span class="hljs-keyword">try</span>:
        <span class="hljs-keyword">from</span> langfuse <span class="hljs-keyword">import</span> get_client       <span class="hljs-comment"># ← v3 SDK 的单例获取方法</span>
        <span class="hljs-keyword">return</span> get_client()
    <span class="hljs-keyword">except</span> ImportError:
        logger.debug(<span class="hljs-string">"Langfuse not installed, skipping tracing"</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        logger.debug(<span class="hljs-string">f"Failed to get Langfuse client: <span class="hljs-subst">{e}</span>"</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>
</code></pre>
<ol start="2">
<li>创建Span类型的观察对象</li>
</ol>
<pre><code class="hljs language-python" lang="python"><span class="hljs-meta">@contextmanager</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">_langfuse_span</span>(<span class="hljs-params">name: <span class="hljs-built_in">str</span>, **kwargs</span>):
    <span class="hljs-string">"""创建一个 Langfuse Span 的上下文管理器"""</span>
    langfuse = _get_langfuse_client()
    <span class="hljs-keyword">if</span> langfuse <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
        <span class="hljs-keyword">yield</span> <span class="hljs-literal">None</span>                             <span class="hljs-comment"># ← 未配置时优雅退化，不影响业务</span>
        <span class="hljs-keyword">return</span>
    <span class="hljs-keyword">try</span>:
        <span class="hljs-keyword">with</span> langfuse.start_as_current_observation(
            as_type=<span class="hljs-string">"span"</span>,                    <span class="hljs-comment"># ← 创建 SPAN 类型的观察</span>
            name=name,                         <span class="hljs-comment"># ← Span 名称，如 "sql-agent-execution"</span>
            **kwargs,                          <span class="hljs-comment"># ← 额外参数如 input</span>
        ) <span class="hljs-keyword">as</span> span:
            <span class="hljs-keyword">yield</span> span
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        logger.debug(<span class="hljs-string">f"Langfuse span creation failed: <span class="hljs-subst">{e}</span>"</span>)
        <span class="hljs-keyword">yield</span> <span class="hljs-literal">None</span>
</code></pre>
<ol start="3">
<li>使用</li>
</ol>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">__call__</span>(<span class="hljs-params">self, state, config, *, writer=<span class="hljs-literal">None</span></span>):
    <span class="hljs-comment"># ...</span>
    <span class="hljs-keyword">with</span> _langfuse_span(
        <span class="hljs-string">"sql-agent-execution"</span>,                              <span class="hljs-comment"># ← Span 名称</span>
        <span class="hljs-built_in">input</span>={<span class="hljs-string">"query"</span>: raw_query, <span class="hljs-string">"db_name"</span>: db_name},     <span class="hljs-comment"># ← 记录输入</span>
    ) <span class="hljs-keyword">as</span> span:
        <span class="hljs-comment"># ... SQL Agent 的整个迭代循环在这个 span 内 ...</span>
        <span class="hljs-comment"># 每次迭代：LLM 调用 → 工具调用 → 验证 → 可能修复</span>
        <span class="hljs-comment"># 成功时更新 Span 输出：</span>
        <span class="hljs-keyword">if</span> span:
            span.update(
                output={
                    <span class="hljs-string">"sql"</span>: last_sql,               <span class="hljs-comment"># 最终生成的 SQL</span>
                    <span class="hljs-string">"success"</span>: validation_passed,   <span class="hljs-comment"># 验证是否通过</span>
                    <span class="hljs-string">"iterations"</span>: iteration,        <span class="hljs-comment"># 迭代了几轮</span>
                }
            )
        <span class="hljs-comment"># 异常时标记为错误：</span>
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-keyword">if</span> span:
                span.update(output={<span class="hljs-string">"error"</span>: <span class="hljs-built_in">str</span>(e)}, level=<span class="hljs-string">"ERROR"</span>)
</code></pre>
<p>这段代码做了什么？<br/>
它为整个 SQL Agent 的执行创建了一个命名为 "sql-agent-execution" 的 SPAN。这个 Span：</p>
<ul>
<li>输入：记录用户的原始问题和目标数据库名</li>
<li>输出：记录最终 SQL、是否验证通过、总共迭代了多少轮</li>
<li>错误：如果出异常，标记为 ERROR 级别</li>
</ul>
<p>手动 Span 的价值不在于追踪链路本身（CallbackHandler 已经覆盖了），而在于提供一个汇总视图：在 Langfuse UI 中点开一个 Trace，直接在sql-agent-execution 这个 Span 的 output 里就能看到 {sql: "...", success: true, iterations: 2}，不需要逐个翻看子节点去拼凑结论。</p>
<h4 data-id="heading-13">langfuse界面</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/15646f4c4eb64c78af4a76e5570848b1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgemFpemFpemhhbw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771399753&amp;x-signature=%2BuYYTU12LsZG0goVsHVHUcYUy3A%3D" alt="d6daef7046e4b00482ec778023509c8a.png" loading="lazy"/></p>
<ol>
<li>在 sql_agent 节点下多了一个并列的 Span，携带了 input={query, db_name} 和 output={sql, success, iterations} 的汇总信息</li>
<li>但它没有包裹住 LLM 调用和 Tool 调用，所以不构成层级关系</li>
<li>它只是一个独立的"信息标注节点"，挂在 sql_agent 下面</li>
</ol>
<p>如果想让手动 Span 真正成为 LLM 调用和 Tool 调用（如以上validate_sql）的父级，需要让 CallbackHandler 感知到手动 Span 的上下文。Langfuse官方文档中给出的做法是结合 propagate_attributes 使用：</p>
<pre><code class="hljs language-python" lang="python">  <span class="hljs-keyword">from</span> langfuse <span class="hljs-keyword">import</span> get_client, propagate_attributes
  <span class="hljs-keyword">from</span> langfuse.langchain <span class="hljs-keyword">import</span> CallbackHandler
  langfuse = get_client()
  <span class="hljs-keyword">with</span> langfuse.start_as_current_observation(as_type=<span class="hljs-string">"span"</span>, name=<span class="hljs-string">"sql-agent-execution"</span>):
      <span class="hljs-keyword">with</span> propagate_attributes():
          handler = CallbackHandler()  <span class="hljs-comment"># 在这里创建 handler，它会继承当前 span 作为 parent</span>
          <span class="hljs-comment"># 然后把 handler 传入 LLM 调用...</span>
</code></pre>
<p>但我的项目中 CallbackHandler() 是在 get_langfuse_callbacks() 中提前创建好的，然后通过 config["callbacks"] 传入 LangGraph，并非在手动Span 上下文内创建，所以两者无法建立父子关系，而是自定义的Span自动使用了根CallbackHandler()创建的上下文 ，这里就涉及到OpenTelemetry (OTEL)了，OpenTelemetry 是一个厂商中立的开源可观测性框架，它解决问题就是在分布式系统中，把散落在各处的监控数据关联起来，还原出完整的请求路径。</p>
<h6 data-id="heading-14">完整官方示例</h6>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langfuse <span class="hljs-keyword">import</span> observe, get_client, propagate_attributes
<span class="hljs-keyword">from</span> langfuse.langchain <span class="hljs-keyword">import</span> CallbackHandler
<span class="hljs-keyword">from</span> langchain_openai <span class="hljs-keyword">import</span> ChatOpenAI
<span class="hljs-keyword">from</span> langchain_core.prompts <span class="hljs-keyword">import</span> ChatPromptTemplate

<span class="hljs-meta">@observe() </span><span class="hljs-comment"># Automatically log function as a trace to Langfuse</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">process_user_query</span>(<span class="hljs-params">user_input: <span class="hljs-built_in">str</span></span>):
    langfuse = get_client()

    <span class="hljs-comment"># Propagate trace attributes to all child observations</span>
    <span class="hljs-keyword">with</span> propagate_attributes(
        session_id=<span class="hljs-string">"session-1234"</span>,
        user_id=<span class="hljs-string">"user-5678"</span>,
    ):

      <span class="hljs-comment"># Initialize the Langfuse handler - automatically inherits the current trace context</span>
      langfuse_handler = CallbackHandler()

      <span class="hljs-comment"># Your Langchain code - will be nested under the @observe trace</span>
      llm = ChatOpenAI(model_name=<span class="hljs-string">"gpt-4o"</span>)
      prompt = ChatPromptTemplate.from_template(<span class="hljs-string">"Respond to: {input}"</span>)
      chain = prompt | llm

      result = chain.invoke({<span class="hljs-string">"input"</span>: user_input}, config={<span class="hljs-string">"callbacks"</span>: [langfuse_handler]})

      <span class="hljs-comment"># Update trace with input and final output</span>
      langfuse.update_current_trace(
        name=<span class="hljs-string">"user-query-processing"</span>,
        <span class="hljs-built_in">input</span>={<span class="hljs-string">"query"</span>: user_input},
        output={<span class="hljs-string">"response"</span>: result.content},
        )

    <span class="hljs-keyword">return</span> result.content

<span class="hljs-comment"># Usage</span>
answer = process_user_query(<span class="hljs-string">"What is the capital of France?"</span>)
</code></pre>
<h4 data-id="heading-15">总结</h4>
<p>本文介绍了在 Agent 开发中集成 Langfuse 可观测性的两种方式：</p>























<table><thead><tr><th>方式</th><th>适用场景</th><th>优点</th><th>局限</th></tr></thead><tbody><tr><td><strong>自动 Callback</strong></td><td>快速接入，追踪 LangChain/LangGraph 内部链路</td><td>零侵入、开箱即用</td><td>只能追踪框架内部，自定义逻辑不可见</td></tr><tr><td><strong>手动 Span</strong></td><td>需要业务语义汇总、追踪框架外逻辑</td><td>完全可控，可自定义输入输出</td><td>需要手动管理上下文</td></tr></tbody></table>
<p>实际项目中，<strong>两者结合使用</strong>是最佳实践：Callback 负责自动追踪 LLM 调用和工具调用的细粒度链路，手动 Span 负责在此之上附加业务维度的汇总信息（如最终 SQL、验证结果、迭代轮次），让 Langfuse Dashboard 既有深度又有概览。</p>
<p>以上所有代码示例均来自我的开源项目 <strong>EasySQL</strong> —— 一个 Text-to-SQL 智能体分析应用，项目地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fzaizaizhao%2Feasysql" target="_blank" title="https://github.com/zaizaizhao/easysql" ref="nofollow noopener noreferrer">github.com/zaizaizhao/…</a>。项目主要技术栈包括：</p>
<ul>
<li><strong>LangGraph</strong>：构建多步骤 Agent 状态机，支持条件路由、Human-in-the-Loop 澄清、SQL 生成→验证→修复的迭代循环</li>
<li><strong>LangChain</strong>：LLM 调用抽象与 RunnableConfig 配置传递</li>
<li><strong>Langfuse</strong>：Callback + 手动 Span 双模式可观测性，实现全链路追踪与业务汇总</li>
<li><strong>PostgreSQL + AsyncPostgresSaver</strong>：LangGraph Checkpointer 状态持久化，支持多轮对话上下文</li>
<li><strong>FastAPI + Uvicorn</strong>：异步 API 服务层，提供流式 SSE 响应</li>
<li><strong>Milvus</strong>：向量数据库，用于 Schema 语义检索</li>
<li><strong>Neo4j</strong>： 图数据库，用于知识图谱构建</li>
<li><strong>Pydantic Settings</strong>：类型安全的配置管理，支持环境变量覆盖</li>
</ul>
<p>欢迎 Star ⭐ 和交流！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Claude Agent Teams使用方法]]></title>    <link>https://juejin.cn/post/7605131777175388223</link>    <guid>https://juejin.cn/post/7605131777175388223</guid>    <pubDate>2026-02-11T07:30:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605131777175388223" data-draft-id="7605051886435188799" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Claude Agent Teams使用方法"/> <meta itemprop="keywords" content="Claude"/> <meta itemprop="datePublished" content="2026-02-11T07:30:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="anjushi"/> <meta itemprop="url" content="https://juejin.cn/user/3479331676363320"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Claude Agent Teams使用方法
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3479331676363320/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    anjushi
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-11T07:30:50.000Z" title="Wed Feb 11 2026 07:30:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Agent Teams</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fcode.claude.com%2Fdocs%2Fzh-CN%2Fagent-teams" target="_blank" title="https://code.claude.com/docs/zh-CN/agent-teams" ref="nofollow noopener noreferrer">code.claude.com/docs/zh-CN/…</a></p>
<p>和 subagent 最本质的区别是：<strong>teammate 之间可以直接通信</strong>。subagent 只能把结果报告给主 Agent，是单向的上报关系；而 Agent Teams 里的队员可以互相发消息</p>
<h3 data-id="heading-1">开启</h3>
<p>设置环境变量： <code>/Users/xxx/.claude/settings.json</code></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"env"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-2">tmux分屏</h3>
<p>官方文档提供了两种使用方式：</p>
<ul>
<li><strong>In-process 模式</strong></li>
<li><strong>Split-pane 模式</strong>（更友好，推荐）</li>
</ul>
<p>默认为 <code>"auto"</code> ——</p>
<ul>
<li>如果在 tmux 会话内：自动使用分屏模式</li>
<li>如果不在 tmux 内：使用 in-process 模式</li>
</ul>
<p>可通过以下方式强制指定：</p>
<ul>
<li>settings.json：<code>"teammateMode": "in-process"</code> 或 <code>"tmux"</code></li>
<li>命令行：<code>claude --teammate-mode in-process</code></li>
</ul>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftmux%2Ftmux%2Fwiki%2FInstalling" target="_blank" title="https://github.com/tmux/tmux/wiki/Installing" ref="nofollow noopener noreferrer">github.com/tmux/tmux/w…</a></p>
<p>安装tmux</p>
<pre><code class="hljs">brew install tmux
</code></pre>
<p>新建session</p>
<pre><code class="hljs language-arduino" lang="arduino">tmux <span class="hljs-keyword">new</span> -s team
</code></pre>
<p>重新进入</p>
<pre><code class="hljs language-arduino" lang="arduino">tmux attach -t team
</code></pre>
<p>切换窗格有一个需要注意的地方，Ctrl+B 之后需要<strong>松开键盘</strong>，再通过⬆️⬇️⬅️➡️来选择当前窗格</p>
<h3 data-id="heading-3">使用</h3>
<p>使用如下提示词</p>
<pre><code class="hljs language-diff" lang="diff">创建一个 agent team
<span class="hljs-deletion">- 一个需求分析和提供 </span>
<span class="hljs-deletion">- 一个进行前端开发 </span>
<span class="hljs-deletion">- 一个进行后端开发 </span>
让他们各自开发前后端并进行接口对接，帮我完善我的agent team创建
</code></pre>
<p>需要注意的是，分屏是claudecode自行创建的，不需要手动创建</p>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d7bb5faeb16245e0980a2baeecc98777~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYW5qdXNoaQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771399849&amp;x-signature=IMjOmwIDSOZm84JWSOjmeb9ZLrw%3D" alt="" width="100%" align="center" loading="lazy"/>
<p>可以在team leader中调用，也可以直接和单个agent对话完成任务 <img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c409a712f05d428cbf69cf4438ad24c7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYW5qdXNoaQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771399849&amp;x-signature=hUVcWlarCuJOLVsMBs%2BirZTG4N4%3D" alt="" width="40%" align="center" loading="lazy"/></p>
<p>team生成后会存储在 <code>~/.claude/teams/{team-name}/config.json</code> <img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/632e62f043d748f7b89065aa60631fc9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYW5qdXNoaQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771399849&amp;x-signature=nAt%2B5dwKhBnvDtNb7RsKSEl2888%3D" alt="" width="60%" align="center" loading="lazy"/></p>
<h3 data-id="heading-4">退出agent team</h3>
<p>在team leader也就是主窗口要求关闭，其他分窗口会逐个关闭 <img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3c678ae6e5e0449f84404ec6a13c2887~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYW5qdXNoaQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771399849&amp;x-signature=z4Xw%2BfKdgG9sVazQfpnH3l8TciM%3D" alt="" width="40%" align="center" loading="lazy"/></p>
<p>关闭前的分窗口会显示如下 <img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/34400a5d8ad14203b465568ba29b2898~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYW5qdXNoaQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771399849&amp;x-signature=YxZKE6iPPDqhNcrVr%2FB3dRi7%2F6E%3D" alt="" width="80%" align="center" loading="lazy"/></p>
<p>agentteam本质是一次 <strong>workflow run</strong>，不是长期在线团队
最好的使用方法是：<strong>声明仅启动agent但不声明任务，不自动结束</strong>，也就是让这次任务一直在进行中，然后在team leader 或 agent 中下发任务</p>
<p>claude对话也可以暂存，使用如下命令可以重新进入</p>
<pre><code class="hljs language-css" lang="css">claude <span class="hljs-attr">--resume</span>
</code></pre>
<p>需要注意的是，agentteam模式对token的消耗要比普通模式多很多</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[mac端为claude code配置ida mcp]]></title>    <link>https://juejin.cn/post/7605140481488306217</link>    <guid>https://juejin.cn/post/7605140481488306217</guid>    <pubDate>2026-02-11T07:23:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605140481488306217" data-draft-id="7605150769008181291" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="mac端为claude code配置ida mcp"/> <meta itemprop="keywords" content="macOS,Claude"/> <meta itemprop="datePublished" content="2026-02-11T07:23:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="逆向APP"/> <meta itemprop="url" content="https://juejin.cn/user/2999123452370679"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            mac端为claude code配置ida mcp
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2999123452370679/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    逆向APP
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-11T07:23:17.000Z" title="Wed Feb 11 2026 07:23:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>（1）在终端进入ida的路径 </p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cd</span> /Applications/IDA\ Professional\ 9.0.app/Contents/MacOS 

</code></pre>
<p> （2）为ida设置python </p>
<pre><code class="hljs language-bash" lang="bash">./idapyswitch --force-path /opt/homebrew/Cellar/python@3.11/3.11.12/Frameworks/Python.framework/Versions/3.11/Python 
</code></pre>
<p> （3）在终端执行安装ida mcp </p>
<pre><code class="hljs language-arduino" lang="arduino">pip3<span class="hljs-number">.11</span> install --upgrade git+https:<span class="hljs-comment">//github.com/mrexodia/ida-pro-mcp </span>

</code></pre>
<p> 验证：</p>
<pre><code class="hljs language-bash" lang="bash">ida-pro-mcp --<span class="hljs-built_in">help</span> 

</code></pre>
<p> （4）安装Ida插件 </p>
<pre><code class="hljs language-css" lang="css"> ida-pro-mcp <span class="hljs-attr">--install</span> 

</code></pre>
<p>（5）配置ida mcp的信息</p>
<pre><code class="hljs language-css" lang="css">% ida-pro-mcp <span class="hljs-attr">--config</span>
<span class="hljs-selector-attr">[HTTP MCP CONFIGURATION]</span>
{
  "mcpServers": {
    "ida-pro-mcp": {
      "type": <span class="hljs-string">"http"</span>,
      <span class="hljs-string">"url"</span>: <span class="hljs-string">"http://127.0.0.1:13337/mcp"</span>
    }
  }
}

<span class="hljs-selector-attr">[STDIO MCP CONFIGURATION]</span>
{
  "mcpServers": {
    "ida-pro-mcp": {
      "command": <span class="hljs-string">"/opt/homebrew/opt/python@3.11/bin/python3.11"</span>,
      <span class="hljs-string">"args"</span>: [
        <span class="hljs-string">"/opt/homebrew/lib/python3.11/site-packages/ida_pro_mcp/server.py"</span>,
        <span class="hljs-string">"--ida-rpc"</span>,
        <span class="hljs-string">"http://127.0.0.1:13337"</span>
      ]
    }
  }
}
</code></pre>
<p> （6）IDA中启动MCP</p>
<p>插件只是加载了，但默认不会自动启动 RPC。 </p>
<p>你需要在 IDA 里手动启动一次 MCP 插件，端口才会监听。 </p>
<p> 请在 IDA 执行：</p>
<pre><code class="hljs language-rust" lang="rust"> 菜单：Edit <span class="hljs-punctuation">-&gt;</span> Plugins <span class="hljs-punctuation">-&gt;</span> MCP 

</code></pre>
<p>或者快捷键：Ctrl-Alt-M（mac 上 Alt 通常是 Option）</p>
<p>(7)重启Claude Code后，查看可用的MCP列表</p>
<p>输入命令：</p>
<pre><code class="hljs language-arduino" lang="arduino">List available MCP tools

</code></pre>
<p>输出：</p>
<pre><code class="hljs language-arduino" lang="arduino">❯ List available MCP tools                                                                 
                                                                                           
⏺ 以下是当前会话中可用的 IDA Pro MCP 工具列表：                                            
                                                                                           
  查找与导航工具                                                                           
  ┌──────────────────────────────────┬────────────────────────────────┐                    
  │              工具名              │              功能              │                    
  ├──────────────────────────────────┼────────────────────────────────┤                    
  │ mcp__ida-pro-mcp__lookup_funcs   │ 按地址或名称查找函数           │                    
  ├──────────────────────────────────┼────────────────────────────────┤                    
  │ mcp__ida-pro-mcp__list_funcs     │ 列出函数（支持过滤和分页）     │                    
  ├──────────────────────────────────┼────────────────────────────────┤                    
  │ mcp__ida-pro-mcp__list_globals   │ 列出全局变量（支持过滤和分页） │                    
  ├──────────────────────────────────┼────────────────────────────────┤                    
  │ mcp__ida-pro-mcp__imports        │ 列出导入函数                   │                    
  ├──────────────────────────────────┼────────────────────────────────┤                    
  │ mcp__ida-pro-mcp__basic_blocks   │ 获取函数的基本块用于控制流图   │                    
  ├──────────────────────────────────┼────────────────────────────────┤                    
  │ mcp__ida-pro-mcp__search_structs │ 搜索结构体                     │                    
  └──────────────────────────────────┴────────────────────────────────┘                    
  反编译与汇编工具                                                                         
  ┌────────────────────────────────┬────────────────────────┐                              
  │             工具名             │          功能          │                              
  ├────────────────────────────────┼────────────────────────┤                              
  │ mcp__ida-pro-mcp__decompile    │ 将函数反编译为伪代码   │                              
  ├────────────────────────────────┼────────────────────────┤                              
  │ mcp__ida-pro-mcp__disasm       │ 将函数反汇编为汇编指令 │                              
  ├────────────────────────────────┼────────────────────────┤                              
  │ mcp__ida-pro-mcp__declare_type │ 声明类型               │                              
  ├────────────────────────────────┼────────────────────────┤                              
  │ mcp__ida-pro-mcp__infer_types  │ 推断类型               │                              
  └────────────────────────────────┴────────────────────────┘                              
  交叉引用与调用图                                                                         
  ┌──────────────────────────────────┬────────────────────────────┐                        
  │              工具名              │            功能            │                        
  ├──────────────────────────────────┼────────────────────────────┤                        
  │ mcp__ida-pro-mcp__xrefs_to       │ 获取到指定地址的交叉引用   │                        
  ├──────────────────────────────────┼────────────────────────────┤                        
  │ mcp__ida-pro-mcp__xrefs_to_field │ 获取到结构体字段的交叉引用 │                        
  ├──────────────────────────────────┼────────────────────────────┤                        
  │ mcp__ida-pro-mcp__callees        │ 获取指定函数调用的函数     │                        
  ├──────────────────────────────────┼────────────────────────────┤                        
  │ mcp__ida-pro-mcp__callgraph      │ 从根函数构建调用图         │                        
  └──────────────────────────────────┴────────────────────────────┘                        
  搜索工具                                                                                 
  ┌──────────────────────────────┬────────────────────────────┐                            
  │            工具名            │            功能            │                            
  ├──────────────────────────────┼────────────────────────────┤                            
  │ mcp__ida-pro-mcp__find       │ 搜索字节数据               │                            
  ├──────────────────────────────┼────────────────────────────┤                            
  │ mcp__ida-pro-mcp__find_regex │ 使用正则表达式搜索字符串   │                            
  ├──────────────────────────────┼────────────────────────────┤                            
  │ mcp__ida-pro-mcp__find_bytes │ 搜索字节模式（支持通配符） │                            
  └──────────────────────────────┴────────────────────────────┘                            
  内存读取与数据获取                                                                       
  ┌────────────────────────────────────┬────────────────────────────┐                      
  │               工具名               │            功能            │                      
  ├────────────────────────────────────┼────────────────────────────┤                      
  │ mcp__ida-pro-mcp__get_bytes        │ 从内存地址读取字节         │                      
  ├────────────────────────────────────┼────────────────────────────┤                      
  │ mcp__ida-pro-mcp__get_int          │ 从内存地址读取整数值       │                      
  ├────────────────────────────────────┼────────────────────────────┤                      
  │ mcp__ida-pro-mcp__get_string       │ 从内存地址读取字符串       │                      
  ├────────────────────────────────────┼────────────────────────────┤                      
  │ mcp__ida-pro-mcp__get_global_value │ 按地址或名称读取全局变量值 │                      
  ├────────────────────────────────────┼────────────────────────────┤                      
  │ mcp__ida-pro-mcp__read_struct      │ 读取结构体类型并解析内存值 │                      
  └────────────────────────────────────┴────────────────────────────┘                      
  修改与编辑工具                                                                           
  ┌────────────────────────────────┬────────────────────────────────────────────┐          
  │             工具名             │                    功能                    │          
  ├────────────────────────────────┼────────────────────────────────────────────┤          
  │ mcp__ida-pro-mcp__patch        │ 用十六进制数据在内存地址打补丁             │          
  ├────────────────────────────────┼────────────────────────────────────────────┤          
  │ mcp__ida-pro-mcp__patch_asm    │ 用汇编指令在地址打补丁                     │          
  ├────────────────────────────────┼────────────────────────────────────────────┤          
  │ mcp__ida-pro-mcp__put_int      │ 将整数值写入内存地址                       │          
  ├────────────────────────────────┼────────────────────────────────────────────┤          
  │ mcp__ida-pro-mcp__set_type     │ 应用类型（函数/全局/局部/栈变量）          │          
  ├────────────────────────────────┼────────────────────────────────────────────┤          
  │ mcp__ida-pro-mcp__set_comments │ 在地址设置注释                             │          
  ├────────────────────────────────┼────────────────────────────────────────────┤          
  │ mcp__ida-pro-mcp__rename       │ 统一重命名函数、全局变量、局部变量和栈变量 │          
  └────────────────────────────────┴────────────────────────────────────────────┘          
  函数与代码定义                                                                           
  ┌───────────────────────────────┬──────────────────────────────┐                         
  │            工具名             │             功能             │                         
  ├───────────────────────────────┼──────────────────────────────┤                         
  │ mcp__ida-pro-mcp__define_func │ 在地址定义函数               │                         
  ├───────────────────────────────┼──────────────────────────────┤                         
  │ mcp__ida-pro-mcp__define_code │ 将字节转换为地址处的代码指令 │                         
  ├───────────────────────────────┼──────────────────────────────┤                         
  │ mcp__ida-pro-mcp__undefine    │ 取消定义项目，转换回原始字节 │                         
  └───────────────────────────────┴──────────────────────────────┘                         
  栈变量工具                                                                               
  ┌─────────────────────────────────┬────────────┐                                         
  │             工具名              │    功能    │                                         
  ├─────────────────────────────────┼────────────┤                                         
  │ mcp__ida-pro-mcp__stack_frame   │ 获取栈变量 │                                         
  ├─────────────────────────────────┼────────────┤                                         
  │ mcp__ida-pro-mcp__declare_stack │ 创建栈变量 │                                         
  ├─────────────────────────────────┼────────────┤                                         
  │ mcp__ida-pro-mcp__delete_stack  │ 删除栈变量 │                                         
  └─────────────────────────────────┴────────────┘                                         
  导出工具                                                                                 
  ┌────────────────────────────────┬────────────────────────┐                              
  │             工具名             │          功能          │                              
  ├────────────────────────────────┼────────────────────────┤                              
  │ mcp__ida-pro-mcp__export_funcs │ 以各种格式导出函数数据 │                              
  └────────────────────────────────┴────────────────────────┘                              
  Python 执行                                                                              
  ┌───────────────────────────┬─────────────────────────────────────────────────────┐      
  │          工具名           │                        功能                         │      
  ├───────────────────────────┼─────────────────────────────────────────────────────┤      
  │ mcp__ida-pro-mcp__py_eval │ 在 IDA 上下文中执行 Python 代码（访问所有 IDA API） │      
  └───────────────────────────┴─────────────────────────────────────────────────────┘      
  数字转换                                                                                 
  工具名: mcp__ida-pro-mcp__int_convert                                                    
  功能: 将数字转换为不同格式（十六进制、十进制、二进制、ASCII）                            
  ---                                                                                      
  总计: <span class="hljs-number">34</span> 个 MCP 工具可用
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[MCP (Model Context Protocol) 技术理解 - 第四篇]]></title>    <link>https://juejin.cn/post/7605145921617723444</link>    <guid>https://juejin.cn/post/7605145921617723444</guid>    <pubDate>2026-02-11T07:34:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605145921617723444" data-draft-id="7605106957133873186" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="MCP (Model Context Protocol) 技术理解 - 第四篇"/> <meta itemprop="keywords" content="后端,MCP,AIGC"/> <meta itemprop="datePublished" content="2026-02-11T07:34:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="想用offer打牌"/> <meta itemprop="url" content="https://juejin.cn/user/578781641968972"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            MCP (Model Context Protocol) 技术理解 - 第四篇
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/578781641968972/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    想用offer打牌
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-11T07:34:44.000Z" title="Wed Feb 11 2026 07:34:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.8;font-weight:400;font-size:16px;word-spacing:2px;letter-spacing:2px;overflow-x:hidden;color:#3e3e3e;background-image:linear-gradient(90deg,rgba(50,0,0,.05) 3%,transparent 0),linear-gradient(1turn,rgba(50,0,0,.05) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:30px;margin-bottom:5px}.markdown-body h2{padding-bottom:12px;font-size:24px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:1.2em;border-bottom:2px solid #ef7060;word-spacing:0!important;letter-spacing:0!important;font-size:inherit;line-height:inherit;display:block;font-weight:400;background:#ef7060;color:#fff;padding:10px;border-top-right-radius:3px;border-top-left-radius:3px;margin-right:3px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="monokai">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#272822;color:#ddd}.hljs-keyword,.hljs-literal,.hljs-name,.hljs-selector-tag,.hljs-strong,.hljs-tag{color:#f92672}.hljs-code{color:#66d9ef}.hljs-class .hljs-title{color:#fff}.hljs-attribute,.hljs-link,.hljs-regexp,.hljs-symbol{color:#bf79db}.hljs-addition,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-emphasis,.hljs-section,.hljs-selector-attr,.hljs-selector-pseudo,.hljs-string,.hljs-subst,.hljs-template-tag,.hljs-template-variable,.hljs-title,.hljs-type,.hljs-variable{color:#a6e22e}.hljs-comment,.hljs-deletion,.hljs-meta,.hljs-quote{color:#75715e}.hljs-doctag,.hljs-keyword,.hljs-literal,.hljs-section,.hljs-selector-id,.hljs-selector-tag,.hljs-title,.hljs-type{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<p>在第三篇文章中，我们讲了<strong>MCP服务端的三个核心原语</strong>。在上一篇我其实忘记解释原语到底是什么，这里补充一下吧。</p>
<p><strong>原语</strong>指的是<strong>最基本的、不可再分的操作单元</strong>，是构建更复杂功能的基础构建块（building blocks）。我们讲的服务端的三个核心原语，其实就是MCP服务器能提供的三种<strong>基本交互模式</strong>。那么类比到其他方面，比如<strong>HTTP 的原语</strong>：GET、POST、PUT、DELETE（基本操作），数据库的基本原语是CRUD等等。</p>
<p>那么这一篇我们就开始讲<strong>客户端的核心原语</strong></p>
<p>如果你对前面的内容感兴趣，可以点击这里跳转</p>
<p><a href="https://juejin.cn/post/7604037348607082534" target="_blank" title="https://juejin.cn/post/7604037348607082534">MCP (Model Context Protocol) 技术理解 - 第一篇</a></p>
<p><a href="https://juejin.cn/post/7603721514204495881" target="_blank" title="https://juejin.cn/post/7603721514204495881">MCP (Model Context Protocol) 技术理解 - 第二篇</a></p>
<p><a href="https://juejin.cn/post/7605042079668518927" target="_blank" title="https://juejin.cn/post/7605042079668518927">MCP (Model Context Protocol) 技术理解 - 第三篇</a></p>
<h2 data-id="heading-1">MCP客户端是什么</h2>
<p>其实我们在前面的架构讲解的时候有讲过MCP的客户端是什么，但是这里就顺带再讲一遍吧。</p>
<p>MCP 客户端由AI应用程序实例化，用于与特定的 MCP 服务器通信。AI应用（例如 Cursor或者Claude Code）负责管理整体用户体验并协调多个客户端。每个客户端处理与一个服务器的直接通信。<strong>理清这里非常重要，不要把AI应用(host宿主)和MCP客户端混为一谈噢</strong></p>
<p>根本区别就是host是用户与之交互的应用程序，而客户端是实现服务器连接的协议级组件</p>
<h2 data-id="heading-2">MCP客户端的核心原语</h2>
<p>上面讲了概念，我们现在再来讲讲客户端的核心原语有什么，一般有下面的三种：</p>

























<table><thead><tr><th>特征</th><th>解释</th><th>例子</th></tr></thead><tbody><tr><td><strong>Elicitation</strong></td><td>信息获取使服务器能够在交互过程中向用户请求特定信息，为服务器按需收集信息提供了一种结构化的方法。</td><td>服务器在预订旅行时可能会询问用户对飞机座位、房间类型或联系电话的偏好，以完成预订。</td></tr><tr><td><strong>Roots</strong></td><td>根目录允许客户端指定服务器应该关注哪些目录，并通过协调机制传达预期范围。</td><td>旅行预订服务器可以被授予对特定目录的访问权限，从而可以从中读取用户的日历。</td></tr><tr><td><strong>Sampling</strong></td><td>采样允许服务器通过客户端请求 LLM 完成，从而实现代理工作流。这种方法使客户端完全掌控用户权限和安全措施。</td><td>旅行预订服务器可以向 LLM 发送航班列表，并请求 LLM 为用户选择最佳航班。</td></tr></tbody></table>
<h3 data-id="heading-3">Elicitation</h3>
<p>Elicitation，翻译过来意思是引导。它的作用和它的翻译意思一样，<strong>为服务器提供了一种结构化的方法，使其能够按需收集必要信息</strong>。服务器无需预先获取所有信息，也无需在数据缺失时失败，而是可以暂停操作，向用户请求特定输入。这创造了更灵活的交互方式，服务器能够适应用户需求，而不是遵循僵化的模式</p>
<p>这是它的时序图</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b36919872052408f8d2f7f9979504516~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oOz55Sob2ZmZXLmiZPniYw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771400084&amp;x-signature=uFewuwc%2B2AlYvnuQplAxkKB4RNI%3D" alt="image.png" loading="lazy"/></p>
<p>该流程支持动态信息收集。服务器可以根据需要请求特定数据，用户通过相应的用户界面提供信息，服务器则根据新获取的上下文继续处理数据。</p>
<p><strong>举个例子来说明白</strong>，我们使用claude code的时候，如果你的prompts不够清晰明了，CC会问你是否要xx，或者问xx这样做您满意吗？逐渐引导到你想要的结果。</p>
<p>又说到最近很火的千问送奶茶活动，你说的prompt是“我要喝xx的xx款奶茶”，但是它不知道你要大杯还是中杯，几分糖，所以会返回不同规格的同款奶茶给你(同家奶茶店，但是不同地点，大杯或中杯)，等你选定再返回给千问下单。</p>
<p>来个数据流示意？</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  method<span class="hljs-punctuation">:</span> <span class="hljs-string">"elicitation/requestInput"</span><span class="hljs-punctuation">,</span>
  params<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    message<span class="hljs-punctuation">:</span> <span class="hljs-string">"Please confirm your Barcelona vacation booking details:"</span><span class="hljs-punctuation">,</span>
    schema<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      type<span class="hljs-punctuation">:</span> <span class="hljs-string">"object"</span><span class="hljs-punctuation">,</span>
      properties<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        confirmBooking<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
          type<span class="hljs-punctuation">:</span> <span class="hljs-string">"boolean"</span><span class="hljs-punctuation">,</span>
          description<span class="hljs-punctuation">:</span> <span class="hljs-string">"Confirm the booking (Flights + Hotel = $3,000)"</span>
        <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
        seatPreference<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
          type<span class="hljs-punctuation">:</span> <span class="hljs-string">"string"</span><span class="hljs-punctuation">,</span>
          enum<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"window"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"aisle"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"no preference"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
          description<span class="hljs-punctuation">:</span> <span class="hljs-string">"Preferred seat type for flights"</span>
        <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
        roomType<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
          type<span class="hljs-punctuation">:</span> <span class="hljs-string">"string"</span><span class="hljs-punctuation">,</span>
          enum<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"sea view"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"city view"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"garden view"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
          description<span class="hljs-punctuation">:</span> <span class="hljs-string">"Preferred room type at hotel"</span>
        <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
        travelInsurance<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
          type<span class="hljs-punctuation">:</span> <span class="hljs-string">"boolean"</span><span class="hljs-punctuation">,</span>
          default<span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>
          description<span class="hljs-punctuation">:</span> <span class="hljs-string">"Add travel insurance ($150)"</span>
        <span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      required<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"confirmBooking"</span><span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-4">Roots</h3>
<p>Roots,直译过来是根的意思，也就是根目录。<strong>根目录是客户端向服务器传达文件系统访问边界的一种机制</strong>。它们由文件 URI 组成，指示服务器可以操作的目录，帮助服务器了解可用文件和文件夹的范围。虽然根目录传达了预期的边界，但它们并不强制执行安全限制。实际的安全措施必须在操作系统层面通过文件权限和/或沙箱机制来实施</p>
<p>那么Roots可以规定MCP服务端可以访问的文件，要求不能越过越过这条边界(但是不能强制要求，因为服务器运行的代码是客户端无法控制的)。</p>
<p>下面是Roots的结构：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"uri"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"file:///Users/agent/travel-planning"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Travel Planning Workspace"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>根目录是文件系统路径，始终使用<code>file://</code>URI 方案。它们帮助服务器理解项目边界、工作区组织结构和可访问目录。根目录列表会随着用户使用不同的项目或文件夹而动态更新，服务器会在<code>roots/list_changed</code>边界发生变化时收到通知。</p>
<p>不理解？我们来一个示例：</p>
<p>旅行社agent需要处理多个客户的行程，因此可以利用Roots来组织文件系统访问。可以考虑创建一个工作区，其中包含用于旅行计划各个方面的不同目录。客户端向旅行规划服务器提供文件系统根目录：</p>
<ul>
<li><code>file:///Users/agent/travel-planning</code>- 包含所有旅行文件的主工作区</li>
<li><code>file:///Users/agent/travel-templates</code>- 可重复使用的行程模板和资源</li>
<li><code>file:///Users/agent/client-documents</code>- 客户护照和旅行证件</li>
</ul>
<p>当agent创建巴塞罗那行程时，运行良好的服务器会遵守这些边界——访问模板、保存新行程以及引用指定根目录下的客户文档。服务器通常通过使用根目录的相对路径或利用遵循根目录边界的文件搜索工具来访问根目录中的文件。如果代理打开一个类似这样的归档文件夹<code>file:///Users/agent/archive/2023-trips</code>，客户端会通过更新根列表<code>roots/list_changed</code></p>
<h3 data-id="heading-5">Sampling</h3>
<p>Sampling，直译过来是采样。采样允许服务器通过客户端请求语言模型补全，从而实现代理行为，同时保持安全性和用户控制。服务器可以请求已拥有 AI 模型访问权限的客户端代表其处理这些任务。这种方法使客户端完全掌控用户权限和安全措施。由于采样请求发生在其他操作（例如数据分析工具）的上下文中，并作为独立的模型调用进行处理，因此它们能够清晰地划分不同上下文，从而更有效地利用上下文窗口。</p>
<p>不理解？来个例子，平时使用Cursor的时候，如果要执行某个文件命令又或者执行maven命令，如果你没有设置Agent全自动运行，那么Agent在运行前的时候肯定会先来问你，是否执行这个命令或者skip(跳过)。</p>
<p>下面是采样的时序图，该流程通过多重人为干预检查点确保安全性。用户可以在请求返回服务器之前，查看并修改初始请求和生成的响应。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/21af1ba41de74c089a2745e44b686c9a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oOz55Sob2ZmZXLmiZPniYw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771400084&amp;x-signature=cURyREPjSGK0swIBflPojzDxLBg%3D" alt="image.png" loading="lazy"/></p>
<p>下面是请求参数示例：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  messages<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      role<span class="hljs-punctuation">:</span> <span class="hljs-string">"user"</span><span class="hljs-punctuation">,</span>
      content<span class="hljs-punctuation">:</span> <span class="hljs-string">"Analyze these flight options and recommend the best choice:\n"</span> +
               <span class="hljs-string">"[47 flights with prices, times, airlines, and layovers]\n"</span> +
               <span class="hljs-string">"User preferences: morning departure, max 1 layover"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  modelPreferences<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    hints<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">{</span>
      name<span class="hljs-punctuation">:</span> <span class="hljs-string">"claude-sonnet-4-20250514"</span>  <span class="hljs-comment">// Suggested model</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    costPriority<span class="hljs-punctuation">:</span> <span class="hljs-number">0.3</span><span class="hljs-punctuation">,</span>      <span class="hljs-comment">// Less concerned about API cost</span>
    speedPriority<span class="hljs-punctuation">:</span> <span class="hljs-number">0.2</span><span class="hljs-punctuation">,</span>     <span class="hljs-comment">// Can wait for thorough analysis</span>
    intelligencePriority<span class="hljs-punctuation">:</span> <span class="hljs-number">0.9</span>  <span class="hljs-comment">// Need complex trade-off evaluation</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  systemPrompt<span class="hljs-punctuation">:</span> <span class="hljs-string">"You are a travel expert helping users find the best flights based on their preferences"</span><span class="hljs-punctuation">,</span>
  maxTokens<span class="hljs-punctuation">:</span> <span class="hljs-number">1500</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>Sampling本质就是想实现人机协同。采样请求可能需要用户明确同意。客户端可以说明服务器想要分析的内容及其原因。用户可以批准、拒绝或修改请求。</p>
<h2 data-id="heading-6">小结</h2>
<p>这篇我们运用了很多例子来讲解MCP客户端三种原语，相信大家都有不错的体感。下一篇，我们会讲解MCP实战开发。</p>
<p>如果你觉得MCP技术讲解系列非常不错，可以点赞+收藏+关注，谢谢。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[慎用mysqldump与GTID自动定位：一次备份数据"丢失"的排查]]></title>    <link>https://juejin.cn/post/7605145921617707060</link>    <guid>https://juejin.cn/post/7605145921617707060</guid>    <pubDate>2026-02-11T07:34:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605145921617707060" data-draft-id="7605114376803467304" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="慎用mysqldump与GTID自动定位：一次备份数据&quot;丢失&quot;的排查"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-02-11T07:34:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="GreatSQL"/> <meta itemprop="url" content="https://juejin.cn/user/2859169627508573"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            慎用mysqldump与GTID自动定位：一次备份数据"丢失"的排查
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2859169627508573/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    GreatSQL
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-11T07:34:08.000Z" title="Wed Feb 11 2026 07:34:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">慎用mysqldump与GTID自动定位：一次备份数据"丢失"的排查</h2>
<h4 data-id="heading-1">本文摘要</h4>
<p>导入<code>mysqldump</code>的备份数据，并通过<code>MASTER_AUTO_POSITION=1</code>配置从节点，启动复制后，出现1032错误（行不存在）。经排查发现，MySQL 5.7.38的mysqldump备份文件内部存在逻辑矛盾：其记录的起始复制位置与GTID集存在时间差，导致使用<code>MASTER_AUTO_POSITION=1</code>配置从节点时，会丢失备份期间的数据。而mysqldump5.7.36之前和mysqldump8.0.31之后的版本不存在此问题。</p>
<p>本文记录完整的复现、分析和解决方案。</p>
<h3 data-id="heading-2">背景</h3>
<p>某业务系统使用的是MySQL 5.7.38，计划将数据库替换为国产数据库GreatSQL，使用mysqldump从MySQL 5.7.38备份了一份数据，导入到GreatSQL之后，将GreatSQL配置为MySQL 5.7.38的从库，系统运行一段时间后，<code>SHOW SLAVE STATUS</code>检查复制状态，发现复制链路报错， Last_Errno: 1032。</p>
<p>搭建了MySQL 5.7.38和GreatSQL对该场景进行了模拟。</p>
<h3 data-id="heading-3">安装MySQL 5.7.38</h3>
<pre><code class="hljs language-Bash" lang="Bash">$ <span class="hljs-built_in">cd</span> /gdb/mysqldb
$ tar -xvf  mysql-5.7.38-linux-glibc2.12-x86_64.tar.gz
$ <span class="hljs-built_in">mv</span> mysql-5.7.38-linux-glibc2.12-x86_64 mysql-5.7.38
$ <span class="hljs-built_in">mkdir</span> -p /gdb/mysqldb/5738/{data,tmp,binlog}
<span class="hljs-variable">$chown</span> -R  greatsql:greatsql   /gdb/mysqldb
$ ./mysqld --initialize-insecure    --user=greatsql --basedir=/gdb/mysqldb/mysql-5.7.38 --datadir=/gdb/mysqldb/5738/data
...<span class="hljs-comment">#输出省略</span>
password ! Please consider switching off the --initialize-insecure option.
</code></pre>
<h4 data-id="heading-4">创建用户</h4>
<p>在MySQL中创建用户：</p>
<pre><code class="hljs language-Bash" lang="Bash">mysql&gt;CREATE USER admin@<span class="hljs-string">'%'</span> IDENTIFIED WITH MYSQL_NATIVE_PASSWORD BY <span class="hljs-string">'admin'</span> ;
mysql&gt;GRANT ALL PRIVILEGES ON . TO admin@<span class="hljs-string">'%'</span>  WITH GRANT OPTION;
mysql&gt;FLUSH PRIVILEGES;
</code></pre>
<h4 data-id="heading-5">创建测试库及测试表</h4>
<p>在MySQL中创建测试库及测试表：</p>
<pre><code class="hljs language-Bash" lang="Bash">mysql&gt;CREATE DATABASE sbtest;
Query OK, 1 row affected (0.01 sec)
mysql&gt;USE sbtest;
Reading table information <span class="hljs-keyword">for</span> completion of table and column names
You can turn off this feature to get a quicker startup with -A
Database changed
mysql&gt;CREATE TABLE t_keep_alive( name varchar(20),  create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP);
Query OK, 0 rows affected (0.08 sec)
</code></pre>
<h4 data-id="heading-6">使用 Sysbench 构造数据</h4>
<pre><code class="hljs language-Bash" lang="Bash">$ sysbench /usr/local/share/sysbench/oltp_read_write.lua  --mysql-db=sbtest --mysql-host=192.168.18.2 --mysql-port=5738 --mysql-user=admin  --mysql-password=admin --tables=3 --table_size=3000000 --report-interval=2 --threads=4 --db-driver=mysql --skip-trx=off --db-ps-mode=<span class="hljs-built_in">disable</span> --create-secondary=off --time=0 --simple-ranges=0 --sum-ranges=0 --order-ranges=0 --distinct-ranges=0 --mysql-ignore-errors=9001,9002,9000,1062 prepare
WARNING: Both event and time limits are disabled, running an endless <span class="hljs-built_in">test</span>
sysbench 1.1.0-df89d34 (using bundled LuaJIT 2.1.0-beta3)

Initializing worker threads...

Creating table <span class="hljs-string">'sbtest2'</span>...
Creating table <span class="hljs-string">'sbtest1'</span>...
Creating table <span class="hljs-string">'sbtest3'</span>...
Inserting 3000000 records into <span class="hljs-string">'sbtest2'</span>
Inserting 3000000 records into <span class="hljs-string">'sbtest3'</span>
Inserting 3000000 records into <span class="hljs-string">'sbtest1'</span>
</code></pre>
<h4 data-id="heading-7">插入数据脚本</h4>
<p>计划在备份期间，每秒插入一条测试数据</p>
<pre><code class="hljs language-Bash" lang="Bash">$ more t_keep.sh 
<span class="hljs-comment">#!/bin/bash</span>
USER=<span class="hljs-string">"admin"</span>
PASSWORD=<span class="hljs-string">"admin"</span>
HOST=<span class="hljs-string">"192.168.18.2"</span>
PORT=5738
DBNAME=<span class="hljs-string">"sbtest"</span>
<span class="hljs-keyword">while</span> <span class="hljs-literal">true</span> 
<span class="hljs-keyword">do</span>
  /gdb/mysqldb/mysql-5.7.38/bin/mysql -u<span class="hljs-string">"<span class="hljs-variable">$USER</span>"</span> -p<span class="hljs-string">"<span class="hljs-variable">$PASSWORD</span>"</span> -h<span class="hljs-string">"<span class="hljs-variable">$HOST</span>"</span> -P<span class="hljs-string">"<span class="hljs-variable">$PORT</span>"</span> <span class="hljs-string">"<span class="hljs-variable">$DBNAME</span>"</span>  -e <span class="hljs-string">"INSERT INTO t_keep_alive(name) SELECT SUBSTRING(UUID(), 1, 8) ;SELECT sleep(1);"</span>
<span class="hljs-keyword">done</span>
</code></pre>
<p>GTID信息</p>
<pre><code class="hljs language-Bash" lang="Bash">sysbench 插入数据后：

mysql&gt;SHOW MASTER STATUS;
+---------------+----+---------------------------------------------+
| File          | Position  | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |
+---------------+--+---------------------------------------------+
| binlog.000004 | 643592650 |    |  | e9ceeaef-ed3d-11f0-893c-00163ed468c9:1-3366 |
+---------------+---+---------------------------------------------+
1 row <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)

备份完成：

mysql&gt;SHOW MASTER STATUS;
+---------------+-----------+----+---------------------------------------------+
| File          | Position  | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set|
+---------------+------+---------------------------------------------+
| binlog.000004 | 643622680 |   | | e9ceeaef-ed3d-11f0-893c-00163ed468c9:1-3471 |
+---------------+-----------+---+---------------------------------------------+
1 row <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)
</code></pre>
<h4 data-id="heading-8">开始插入数据</h4>
<pre><code class="hljs language-Bash" lang="Bash">$ bash t_keep.sh 
mysql: [Warning] Using a password on the <span class="hljs-built_in">command</span> line interface can be insecure.
+----------+
| <span class="hljs-built_in">sleep</span>(1) |
+----------+
|        0 |
+----------+
mysql: [Warning] Using a password on the <span class="hljs-built_in">command</span> line interface can be insecure.
+----------+
| <span class="hljs-built_in">sleep</span>(1) |
+----------+
|        0 |
+----------+
</code></pre>
<h4 data-id="heading-9">备份数据</h4>
<pre><code class="hljs language-Shell" lang="Shell">/gdb/mysqldb/mysql-5.7.38/bin/mysqldump -uadmin -h192.168.18.2 -P5738 -padmin --single-transaction --set-gtid-purged=ON --master-data=2 --routines --events --triggers --databases sbtest    --force &gt; /tmp/sbtest.sql
</code></pre>
<h4 data-id="heading-10">停止数据写入</h4>
<p>备份完成后，kill 掉写入数据的t_keep.sh 进程</p>
<h4 data-id="heading-11">GreatSQL导入备份文件</h4>
<pre><code class="hljs language-Bash" lang="Bash">$ <span class="hljs-built_in">du</span> -sh sbtest.sql 
1.7G    sbtest.sql

登录GreatSQL数据库，将备份文件导入到GreatSQL数据库
GreatSQL&gt;SOURCE /tmp/sbtest.sql;
</code></pre>
<h3 data-id="heading-12">基于GTID模式配置从库</h3>
<p>将GreatSQL配置为基于GTID模式的MySQL从库</p>
<pre><code class="hljs language-Bash" lang="Bash">GreatSQL&gt;CHANGE MASTER TO MASTER_HOST=<span class="hljs-string">'192.168.18.2'</span>,MASTER_USER=<span class="hljs-string">"ADMIN"</span>,MASTER_PASSWORD=<span class="hljs-string">'ADMIN'</span>,MASTER_PORT=5738,MASTER_AUTO_POSITION=1;
Query OK, 0 rows affected, 2 warnings (0.02 sec)

GreatSQL&gt;SHOW MASTER STATUS;
+---------------+--+---------------------------------------------+
| File          | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set                           |
+---------------+--+---------------------------------------------+
| binlog.000001 |      154 |   |   | e9ceeaef-ed3d-11f0-893c-00163ed468c9:1-3466 |
+---------------+--+---------------------------------------------+
1 row <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)

GreatSQL&gt;START SLAVE;
Query OK, 0 rows affected (0.00 sec)
</code></pre>
<h3 data-id="heading-13">主从数据对比</h3>
<p>gtid信息对比：对比主库和从库的gtid信息，两个库是一致的，都是1-3537</p>
<pre><code class="hljs language-Bash" lang="Bash">主库:
mysql&gt;SHOW MASTER STATUS;
+---------------+------------------+---------------------------------------------+
| File          | Position  | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |
+---------------+------------+---------------------------------------------+
| binlog.000004 | 643641556 |   |   | e9ceeaef-ed3d-11f0-893c-00163ed468c9:1-3537 |
+---------------+-----+---------------------------------------------+
1 row <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)
从库:
GreatSQL&gt;SHOW MASTER STATUS;
+---------------+---+------------------+---------------------------------------------+
| File          | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set                           |
+---------------+--+------------------+---------------------------------------------+
| binlog.000001 |   154 |      |    | e9ceeaef-ed3d-11f0-893c-00163ed468c9:1-3537 |
+---------------+---+------------------+---------------------------------------------+
1 row <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)
</code></pre>
<p>表数据对比：t_keep_alive表数据不一致，主库比从库多</p>
<pre><code class="hljs language-Bash" lang="Bash">主库:
mysql&gt;SELECT count(*) FROM t_keep_alive;
+----------+
| count(*) |
+----------+
|      171 |
+----------+
1 row <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.01 sec)

从库:
GreatSQL&gt;SELECT count(*) FROM t_keep_alive;
+----------+
| count(*) |
+----------+
|      120 |
+----------+
1 row <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.01 sec)

差异数据分析：从库11:10:36到11:11:37之间，没有数据写入从库。在主库更新备份期间产生的数据，
从库就会出现1032错误，SQL线程状态变为NO
| 41f01fcf | 2026-01-12 11:10:33 | 2026-01-12 11:10:33 |
| 428b22d3 | 2026-01-12 11:10:34 | 2026-01-12 11:10:34 |
| 43266c4c | 2026-01-12 11:10:35 | 2026-01-12 11:10:35 |
| 43c105c5 | 2026-01-12 11:10:36 | 2026-01-12 11:10:36 |

| 68155846 | 2026-01-12 11:11:37 | 2026-01-12 11:11:37 |
| 68b0b70c | 2026-01-12 11:11:38 | 2026-01-12 11:11:38 |
| 694b88d8 | 2026-01-12 11:11:39 | 2026-01-12 11:11:39 |
</code></pre>
<h3 data-id="heading-14">基于LOG_FILE+LOG_POS搭建主从</h3>
<pre><code class="hljs language-Bash" lang="Bash">GreatSQL&gt; STOP SLAVE;
Query OK, 0 rows affected (0.01 sec)

GreatSQL&gt; RESET SLAVE all;
Query OK, 0 rows affected (0.01 sec)

GreatSQL&gt; DROP DATABASE sbtest;
Query OK, 4 rows affected (0.92 sec)

GreatSQL&gt; RESET MASTER;
Query OK, 0 rows affected (0.01 sec)

GreatSQL&gt; SOURCE /tmp/sbtest.sql;


GreatSQL&gt; SHOW MASTER STATUS;
+---------------+------+---------------------------------------------+
| File          | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set|
+---------------+------+---------------------------------------------+
| binlog.000001 |      154 |   |  | e9ceeaef-ed3d-11f0-893c-00163ed468c9:1-3466 |
+---------------+------+---------------------------------------------+
1 row <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)

GreatSQL&gt; SELECT *  FROM  t_keep_alive;
...........
| 43c105c5 | 2026-01-12 11:10:36 | 2026-01-12 11:10:36 |
+----------+---------------------+---------------------+
49 rows <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)

GreatSQL&gt; RESET MASTER;
Query OK, 0 rows affected (0.02 sec)

GreatSQL&gt; SHOW MASTER STATUS;
+---------------+----------+--------------+------------------+-------------------+
| File          | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |
+---------------+----------+--------------+------------------+-------------------+
| binlog.000001 |      154 |              |                  |                   |
+---------------+----------+--------------+------------------+-------------------+
1 row <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)

GreatSQL&gt; CHANGE MASTER   TO MASTER_HOST=<span class="hljs-string">'192.168.18.2'</span>,MASTER_USER=<span class="hljs-string">"ADMIN"</span>,MASTER_PASSWORD=<span class="hljs-string">'ADMIN'</span>,MASTER_PORT=5738,MASTER_LOG_FILE=<span class="hljs-string">'BINLOG.000004'</span>, MASTER_LOG_POS=643606664;

Query OK, 0 rows affected, 2 warnings (0.02 sec)

GreatSQL&gt; START SLAVE;
Query OK, 0 rows affected (0.00 sec)

GreatSQL&gt; SELECT * FROM t_keep_alive;
........
| 92abaf1c | 2026-01-12 11:12:48 | 2026-01-12 11:12:48 |
+----------+---------------------+---------------------+
171 rows <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)


GreatSQL&gt; SHOW MASTER STATUS;
+---------------+--+------------------------------------------------+
| File          | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set    |
+---------------+--+------------------------------------------------+
| binlog.000001 |      154 |    |  | e9ceeaef-ed3d-11f0-893c-00163ed468c9:3416-3537 |
+---------------+--+------------------------------------------------+
1 row <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)
</code></pre>
<ul>
<li>通过<code>LOG_FILE、LOG_POS</code>配置主从同步，gtid同步范围为:3416-3537,</li>
<li>通过<code>master_auto_position</code>配置主从同步，gtid同步范围为:3467-3537。</li>
</ul>
<h3 data-id="heading-15">问题分析</h3>
<p>查看备份文件</p>
<pre><code class="hljs language-Bash" lang="Bash">--
-- Position to start replication or point-in-time recovery from
--
文件的开头部分
-- CHANGE MASTER TO MASTER_LOG_FILE=<span class="hljs-string">'binlog.000004'</span>, MASTER_LOG_POS=643606664;
--
-- Current Database: `sbtest`
--
CREATE DATABASE /*!32312 IF NOT EXISTS*/ `sbtest` /*!40100 DEFAULT CHARACTER SET utf8 */;

USE `sbtest`;

--
-- Table structure <span class="hljs-keyword">for</span> table `sbtest1`

....... 略

UNLOCK TABLES;
--
-- Dumping events <span class="hljs-keyword">for</span> database <span class="hljs-string">'sbtest'</span>
--

--
-- Dumping routines <span class="hljs-keyword">for</span> database <span class="hljs-string">'sbtest'</span>
--

--
-- GTID state at the end of the backup 
--
-- 文件结尾部分
SET @@GLOBAL.GTID_PURGED=<span class="hljs-string">'e9ceeaef-ed3d-11f0-893c-00163ed468c9:1-3466'</span>;
/*!40103 SET TIME_ZONE=@OLD_TIME_ZONE */;

/*!40101 SET SQL_MODE=@OLD_SQL_MODE */;
/*!40014 SET FOREIGN_KEY_CHECKS=@OLD_FOREIGN_KEY_CHECKS */;
/*!40014 SET UNIQUE_CHECKS=@OLD_UNIQUE_CHECKS */;
/*!40101 SET CHARACTER_SET_CLIENT=@OLD_CHARACTER_SET_CLIENT */;
/*!40101 SET CHARACTER_SET_RESULTS=@OLD_CHARACTER_SET_RESULTS */;
/*!40101 SET COLLATION_CONNECTION=@OLD_COLLATION_CONNECTION */;
/*!40111 SET SQL_NOTES=@OLD_SQL_NOTES */;

-- Dump completed on 2026-01-12 11:11:36
SET @@GLOBAL.GTID_PURGED=<span class="hljs-string">'e9ceeaef-ed3d-11f0-893c-00163ed468c9:1-3466'</span>;
</code></pre>
<p>备份文件认为1-3466这些事务的数据已经写入到数据库。</p>
<p>实际情况情况呢？</p>
<p>解析备份文件LOG_FILE、LOG_POS相邻的数据。</p>
<p>解析binlog.000004 ，MASTER_LOG_POS=643606664后的下一个事务是<code>'e9ceeaef-ed3d-11f0-893c-00163ed468c9:3416'</code></p>
<pre><code class="hljs language-Bash" lang="Bash">SET @@SESSION.GTID_NEXT= <span class="hljs-string">'e9ceeaef-ed3d-11f0-893c-00163ed468c9:3416'</span>/*!*/;
<span class="hljs-comment"># at 643606729</span>
<span class="hljs-comment">#260112 11:10:37 server id 425738  end_log_pos 643606803 CRC32 0x7f5398a1</span>
</code></pre>
<p><code>LOG_FILE、LOG_POS</code>  对应的下一个事务是'e9ceeaef-ed3d-11f0-893c-00163ed468c9:3416'，这种同步方式是从3416开始同步数据。</p>
<p>而通过MASTER_AUTO_POSITION=1的方式同步数据，由于备份文件最后是</p>
<p><code>SET @@GLOBAL.GTID_PURGED='e9ceeaef-ed3d-11f0-893c-00163ed468c9:1-3466';</code> (MySQL 5.7.38的mysqldump在备份完成时才获取gtid信息) ，这条语句写入数据库后，数据库认为<code>1-3466</code>的数据已经写入到数据库了，这些数据不需要进行同步。</p>
<p>配置MASTER_AUTO_POSITION=1后，从3467开始同步新的数据。两种同步方式差异就是备份期间产生的51条数据(3467-3416=51 )，在主库UPDATE备份期间产生的数据，从库就会出现1032错误，导致主从复制链路失败。</p>
<h3 data-id="heading-16">问题总结</h3>
<p>1、使用MySQL 5.7.38的mysqldump进行数据备份，备份数据导入从库，通过MASTER_AUTO_POSITION=1配置主从后，主从数据库数据不一致，从库开始从备份完成时生成GTID信息开始同步，主库备份期间产生的数据没有同步到从库。备份参数<code>--single-transaction</code>在备份开始前,先执行<code>START TRANSACTION</code>命令,以此来获得备份的一致性，备份程序应该获取此时的GTID信息。</p>
<p>2、通过LOG_FILE、LOG_POS方式搭建从库可以正常进行主从数据同步。</p>
<p>3、使用MySQL 5.7.30、MySQL 8.0.32、GreatSQL8.0.32 的mysqldump程序进行备份，程序获取的LOG_FILE、LOG_POS和GTID信息都在备份文件头记录，这两者对应的日志文件位置是一样的，使用GTID搭建主从后，数据是一致的。MySQL 5.7.38的mysqldump程序MASTER_LOG_FILE和MASTER_LOG_POS在备份文件头，GTID_PURGED在文件尾。</p>
<pre><code class="hljs language-Bash" lang="Bash">用 MySQL 5.7.30、 MySQL 8.0.32、GreatSQL8.0.32 进行备份测试， 备份的时候GTID和文件点位都在备份文件头
SET @@GLOBAL.GTID_PURGED=<span class="hljs-string">'e9ceeaef-ed3d-11f0-893c-00163ed468c9:1-3537'</span>;
-- Position to start replication or point-in-time recovery from
--
-- CHANGE MASTER TO MASTER_LOG_FILE=<span class="hljs-string">'binlog.000004'</span>, MASTER_LOG_POS=643641556;
</code></pre>
<p>4、经过测试验证，mysqldump5.7.36之前和mysqldump8.0.31之后的版本不存在此问题。</p>
<h3 data-id="heading-17">参考文章</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fcloud.tencent.com%2Fdeveloper%2Farticle%2F1915277%3FshareByChannel%3Dlink" target="_blank" title="https://cloud.tencent.com/developer/article/1915277?shareByChannel=link" ref="nofollow noopener noreferrer">cloud.tencent.com/developer/a…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fbugs.mysql.com%2Fbug.php%3Fid%3D105761" target="_blank" title="https://bugs.mysql.com/bug.php?id=105761" ref="nofollow noopener noreferrer">bugs.mysql.com/bug.php?id=…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[别再折腾配置了！OpenCloudOS推出OpenClaw“极速版”脚本]]></title>    <link>https://juejin.cn/post/7605131777175404607</link>    <guid>https://juejin.cn/post/7605131777175404607</guid>    <pubDate>2026-02-11T07:33:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605131777175404607" data-draft-id="7605140481488322601" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="别再折腾配置了！OpenCloudOS推出OpenClaw“极速版”脚本"/> <meta itemprop="keywords" content="开源,操作系统"/> <meta itemprop="datePublished" content="2026-02-11T07:33:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="OpenCloudOS"/> <meta itemprop="url" content="https://juejin.cn/user/3584869265591367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            别再折腾配置了！OpenCloudOS推出OpenClaw“极速版”脚本
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3584869265591367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    OpenCloudOS
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-11T07:33:37.000Z" title="Wed Feb 11 2026 07:33:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">别再折腾配置了！OpenCloudOS推出OpenClaw“极速版”脚本</h2>
<p>在上篇文章<a href="https://juejin.cn/post/7602252722372542515" target="_blank" title="https://juejin.cn/post/7602252722372542515">你的 7x24 “AI 运维同事”，OC 9 + OpenClaw 部署及实战指南OpenClaw </a>中，我们介绍了如何基于OpenCloudOS 9 安装配置OpenClaw，并接入企业微信等IM，让你最终拥有一位 7x24 的“AI全能助理”。一些用户看完文章后跃跃欲试，但一上手实操，却被繁琐的配置劝退了：</p>
<p>● “Node.js 版本不对，报错了……”</p>
<p>● “GitHub 连不上，插件装不下来……”</p>
<p>● “我想接企业微信，怎么还得手动改配置文件？”</p>
<p>大家的痛点，OpenCloudOS社区听到了！</p>
<p>为了让大家把精力从“装环境”转移到“用 AI”上，带来了 OpenClaw x OpenCloudOS 2.0 部署方案 。这一次，我们推出了一键安装脚本，用户只要一条命令就能极速体验OpenClaw。</p>
<h4 data-id="heading-1">一、  新版“极速部署脚本”做了什么？</h4>
<ol>
<li>
<p>环境全自动适配 ：自动检测系统环境，帮你搞定 Node.js 24 等所有底层依赖，不再担心版本冲突。</p>
</li>
<li>
<p>国内 IM 原生支持 ：不再需要满世界找插件。 企业微信、QQ、飞书、钉钉 ，你想用哪个，脚本直接帮你装好。</p>
</li>
<li>
<p>网络与源优化 ：针对国内网络环境做了深度适配，下载更稳、速度更快。</p>
</li>
</ol>
<p>简单来说：以前需要 30 分钟的手工操作，现在只需要 1 分钟等待。</p>
<h4 data-id="heading-2">二、  极速版上手指南</h4>
<h5 data-id="heading-3">2.1 安装 Openclaw 及IM相关插件</h5>
<h6 data-id="heading-4">场景A：我全都要（推荐）</h6>
<p>如果你希望 OpenClaw 能连接企业微信、QQ、飞书、钉钉等所有国内主流 IM，可直接运行如下脚本。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 默认完整安装所有国内 IM 插件</span>
curl -fsSL https://opencloudos.org/extra/deploy_openclaw.sh | bash
</code></pre>
<p>备注：因一键安装脚本会执行较多依赖并启动OpenClaw安装，所以整个安装过程大概耗时15-20min左右，中途请不要终止或推出。</p>
<p>一键安装脚本代码请见：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2FOpenCloudOS%2Fweb-extra%2Fblob%2Fmaster%2Fscripts%2Fdeploy_opneclaw.sh" target="_blank" title="https://gitee.com/OpenCloudOS/web-extra/blob/master/scripts/deploy_opneclaw.sh" ref="nofollow noopener noreferrer">scripts/deploy_opneclaw.sh · OpenCloudOS/web-extra - Gitee.com</a></p>
<h6 data-id="heading-5">场景B：我只需要特定渠道</h6>
<p>如果你只想安装某个指定IM（如企业微信和QQ），不想安装多余插件，可直接运行如下脚本。安装耗时：5-10min</p>
<pre><code class="hljs language-perl" lang="perl"><span class="hljs-comment"># 安装指定IM（下方以同时安装企业微信和QQ为例）：</span>
curl -fsSL https:<span class="hljs-regexp">//</span>opencloudos.org/extra/deploy_openclaw.sh | bash -s -- --plugins wecom,<span class="hljs-keyword">qq</span>
</code></pre>
<h6 data-id="heading-6">场景C：纯净版安装</h6>
<p>如果你只需要 OpenClaw 的核心功能（比如只在终端使用，或者通过 Web 界面交互），不需要连接任何国内IM，可直接运行如下脚本。安装耗时：2-3min</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 跳过所有 IM 插件安装：</span>
curl -fsSL https://opencloudos.org/extra/deploy_openclaw.sh | bash -s -- --skip-plugins
</code></pre>

<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 手动打开交互命令</span>
openclaw onboard
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/59cee61f39bd43778974d0e3dfecb945~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT3BlbkNsb3VkT1M=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771400017&amp;x-signature=Af7fVyHJcczKuH1AqNd5O5oVBl4%3D" alt="" loading="lazy"/></p>
<h5 data-id="heading-7">2.2 配置 OpenClaw</h5>
<p>OpenClaw配置流程较多，OpenCloudOS已在上篇内容<a href="https://juejin.cn/post/7602252722372542515" target="_blank" title="https://juejin.cn/post/7602252722372542515">你的 7x24 “AI 运维同事”，OC 9 + OpenClaw 部署及实战指南OpenClaw </a>进行了详细展示，这篇不再赘述。唯一不同的是，如您在2.1章节中执行了指定IM安装（如企业微信、飞书等），则会在IM配置环节的列表中，看见该可选项。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/86bbb2dacc674cbbbde3a611deba431e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT3BlbkNsb3VkT1M=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771400017&amp;x-signature=RvQbPmpBm%2BtTDZB%2FuGTLbdP%2BLyY%3D" alt="" loading="lazy"/></p>
<h5 data-id="heading-8">2.3 OpenClaw 运行状态确认</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看openclaw是否在后台运行</span>
openclaw health
<span class="hljs-comment"># 查看模型状态，是否连上了大模型</span>
openclaw models list
<span class="hljs-comment"># 查看聊天通道,比如qq，企业微信等</span>
openclaw channels list
</code></pre>
<h4 data-id="heading-9">三、  接入IM及实际应用演示</h4>
<p>接下来，我们将详解如何配置企业微信、QQ、飞书、钉钉.</p>
<h5 data-id="heading-10">3.1 接入企业微信</h5>
<p>OpenClaw 原生基本只支持国外社交软件，可以通过插件的方式来支持国内的社交软件。这里我们以企业微信为例，演示接入教程。</p>
<p>注意要接入企业微信有两个条件，首先你的clawdbot安装在有公网ip的机器上，2.你是企业管理员能创建APP或者机器人</p>
<pre><code class="hljs language-perl" lang="perl"><span class="hljs-comment"># 查看企业微信插件运行是否加载</span>
openclaw plugins list | <span class="hljs-keyword">grep</span> -i wecom
</code></pre>
<p>企业微信插件使用目录</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2F%40marshulll%2Fopenclaw-wecom" target="_blank" title="https://www.npmjs.com/package/@marshulll/openclaw-wecom" ref="nofollow noopener noreferrer">@marshulll/openclaw-wecom - npm</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a60947d20fc9461fb14ecfeb773d4f0c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT3BlbkNsb3VkT1M=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771400017&amp;x-signature=bE6nUy1wF24TZe65Pp3f%2Fi9p%2BxQ%3D" alt="" loading="lazy"/></p>
<p>接下来需要在企业微信里创建一个一个应用，这一步需要<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.work.weixin.qq.com%2F" target="_blank" title="https://developer.work.weixin.qq.com/" ref="nofollow noopener noreferrer">首页 - 企业微信开发者中心</a>先在这里创建一个应用。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2b98d4ab4d294cf9b1e66ab9c63a38a4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT3BlbkNsb3VkT1M=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771400017&amp;x-signature=rqfjD5NagyGq%2Ffc6YE7LEcgVR5k%3D" alt="" loading="lazy"/></p>
<p>选择个人</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ed25de8b9f2a4ea89dbd4c15c1819d4b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT3BlbkNsb3VkT1M=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771400017&amp;x-signature=UYD8PFwlj%2B00UV9ItyQ5RlQXEvc%3D" alt="" loading="lazy"/></p>
<p>配置企业微信应用相关信息</p>
<p>首先获取如下信息</p>
<p>1.  登录 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwork.weixin.qq.com%2Fwework_admin%2Fframe%23%2F" target="_blank" title="https://work.weixin.qq.com/wework_admin/frame#/" ref="nofollow noopener noreferrer">企业微信管理员后台</a></p>
<p>2.  在"我的企业"中查看 企业ID (CorpID)</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/918a217c62dd4df884b05ec1ddaf2c74~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT3BlbkNsb3VkT1M=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771400017&amp;x-signature=pPx2fykxVH0DmHfbtcFmlbtf3i8%3D" alt="" loading="lazy"/></p>
<p>3.  进入"应用管理" → 选择或创建应用</p>
<p>4.  在应用详情页获取：AgentId：应用ID</p>
<p>Secret(corpsecret)：点击"查看Secret"获取</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/80a29177bc264565be057b56d1353322~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT3BlbkNsb3VkT1M=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771400017&amp;x-signature=54zTgdMdhXwBVamqTC2Lw0E1EAo%3D" alt="" loading="lazy"/></p>
<p>5.  在"接收消息"设置中获取：Token：点击"随机获取"</p>
<p>EncodingAESKey：点击"随机获取"</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fba4fd92c53546fbab3cdeae6af201c1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT3BlbkNsb3VkT1M=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771400017&amp;x-signature=DGshq9%2F4U3LAJcC6DkN0El1dcDA%3D" alt="" loading="lazy"/></p>
<p>然后在部署了openclaw的服务器上输入如下命令：</p>
<pre><code class="hljs language-arduino" lang="arduino"># 企业微信应用配置（必需）
# 这里配置的是 app 模式，可以参考插件使用指南换成bot或者both模式
openclaw config set channels.wecom.mode <span class="hljs-string">"app"</span>
openclaw config set channels.wecom.defaultAccount <span class="hljs-string">"app"</span>
openclaw config set channels.wecom.accounts.app.mode <span class="hljs-string">"app"</span>
openclaw config set channels.wecom.accounts.app.webhookPath <span class="hljs-string">"/wecom/app"</span>
openclaw config set channels.wecom.accounts.app.corpId <span class="hljs-string">"你企业ID"</span>
openclaw config set channels.wecom.accounts.app.corpSecret <span class="hljs-string">"应用secret"</span>
openclaw config set channels.wecom.accounts.app.agentId <span class="hljs-string">"你的应用ID"</span>
openclaw config set channels.wecom.accounts.app.callbackToken <span class="hljs-string">"你设置的应用的token"</span>
openclaw config set channels.wecom.accounts.app.callbackAesKey <span class="hljs-string">"你设置的应用的aes-key"</span>
openclaw config set channels.wecom.enabled <span class="hljs-literal">true</span>
 
# 设置openclaw链接公网
openclaw config set gateway.bind lan
 
openclaw gateway restart
# 查看相关配置
openclaw channels list
openclaw config get channels
</code></pre>
<p>配置应该是这样的，我只配置了app，如果你配置了bot会更丰富一点</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/22db44a755dc4ba6a990cd6ce3d5b229~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT3BlbkNsb3VkT1M=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771400017&amp;x-signature=%2FTW3eneTBV%2BaAZTEBe8y2LtEvo8%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dcb068bdf98f4c3587644bdf3b4f4936~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT3BlbkNsb3VkT1M=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771400017&amp;x-signature=StAtBGQc3XZGRgGe1Jcx5OU7JWg%3D" alt="" loading="lazy"/></p>
<p>如上执行后，回到企业微信app管理界面，点击保存，企业微信会回发送token和AESKey去和openclaw服务器进行匹配</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0ff889903fc7428c83e04288a11f26d9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT3BlbkNsb3VkT1M=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771400017&amp;x-signature=8fV8U2spR9r0rah8j%2FRBFcDd5qU%3D" alt="" loading="lazy"/></p>
<p>如果匹配成功界面如下</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1e03dfe505834e2f87d1d301df1b9e39~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT3BlbkNsb3VkT1M=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771400017&amp;x-signature=xZzvBWsg%2BUj23H7k24yNWy44bp8%3D" alt="" loading="lazy"/></p>
<p>在企业微信里找到相关应用，直接和他聊天</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/244c734331ed422ea68812817b6ff163~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT3BlbkNsb3VkT1M=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771400017&amp;x-signature=aaXyWSuf1R6eEL0zb26gpr8aseI%3D" alt="" loading="lazy"/></p>
<p>可以看到 Clawdbot 确实识别到了相关的用户和请求</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a4366701656a442f8161e4991de40ec5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT3BlbkNsb3VkT1M=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771400017&amp;x-signature=c%2BD16XWAav9O3dOBbFrO%2BILvAvg%3D" alt="" loading="lazy"/></p>
<p>让 ClawdBot 创建一个定时任务：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3e9d51e9dd7e435f9920fafd93269836~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT3BlbkNsb3VkT1M=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771400017&amp;x-signature=YQ2BIBlQ6qq%2Fji3lmWZ58HcCgzw%3D" alt="" loading="lazy"/></p>
<p>可以看到确实创建完成了。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/58f1c5bd53d04674919f35ab89ba4e58~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT3BlbkNsb3VkT1M=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771400017&amp;x-signature=4Hp3pB9MltfG6oz1J3Ml26hb1vE%3D" alt="" loading="lazy"/></p>
<h5 data-id="heading-11">3.2 接入QQ</h5>
<p>QQ更方便个人用户使用，OpenCloudOS也提供一个接入QQ的场景。</p>
<p>QQ插件地址<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fsliverp%2Fqqbot%23" target="_blank" title="https://github.com/sliverp/qqbot#" ref="nofollow noopener noreferrer">github.com/sliverp/qqb…</a></p>
<pre><code class="hljs language-perl" lang="perl"><span class="hljs-comment"># 一件安装脚本已经安装了qq相关插件</span>
<span class="hljs-comment"># 查看当前的脚本</span>
openclaw plugins list | <span class="hljs-keyword">grep</span> <span class="hljs-keyword">qq</span>
 
<span class="hljs-comment"># 如果你开始没安装qq插件可以执行如下命令安装</span>
openclaw plugins install https:<span class="hljs-regexp">//gi</span>thub.com/sliverp/qqbot.git
</code></pre>
<p>创建QQ机器人：</p>
<p>访问 <a href="https://link.juejin.cn?target=https%3A%2F%2Fq.qq.com%2F" target="_blank" title="https://q.qq.com/" ref="nofollow noopener noreferrer">QQ 开放平台</a></p>
<p>创建机器人应用</p>
<p>获取 AppID 和 AppSecret（ClientSecret）</p>
<p>Token 格式为 AppID:AppSecret，例如 102146862:Xjv7JVhu7KXkxANbp3HVjxCRgvAPeuAQ</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7e6638e9501f4934b8bec83e79bd4703~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT3BlbkNsb3VkT1M=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771400017&amp;x-signature=abizBKkY8c8urykmO9OBYb3awpI%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9deea50cf82842bdb40dcd6d02fedc03~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT3BlbkNsb3VkT1M=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771400017&amp;x-signature=nRIABmm4Hwx3%2BYVk4pruf9g4lrc%3D" alt="" loading="lazy"/></p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-meta">#方式一：交互式配置,选择 qqbot，按提示输入 Token</span>
openclaw channels <span class="hljs-keyword">add</span>
<span class="hljs-meta">#方式二：命令行配置</span>
openclaw channels <span class="hljs-keyword">add</span> --channel qqbot --token <span class="hljs-string">"AppID:AppSecret"</span>
<span class="hljs-meta"># 示例</span>
openclaw channels <span class="hljs-keyword">add</span> --channel qqbot --token <span class="hljs-string">"102146862:xxxxxxxx"</span>
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eda00df79ee842bbb180604df074625f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT3BlbkNsb3VkT1M=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771400017&amp;x-signature=07rANA3aIWylHuC%2FK1n4f5iXLJ4%3D" alt="" loading="lazy"/></p>
<p>配置好后在qq开发平台里的，沙箱配置里先点击添加成员再扫描二维码就能和ClawdBot沟通，并安排他工作了</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/82aaf4abf430488a8f2686aba728dabf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT3BlbkNsb3VkT1M=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771400017&amp;x-signature=nYu6h3bEz9WrzBDY2Zn0Kgw5SDQ%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d2b7af988c8a4693a7a18d388668e6e9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT3BlbkNsb3VkT1M=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771400017&amp;x-signature=%2FS3skvcwCJXe9hLlDc2MMZDnynA%3D" alt="" loading="lazy"/></p>
<h5 data-id="heading-12">3.3 接入飞书</h5>
<p>飞书插件地址</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fm1heng%2Fclawdbot-feishu" target="_blank" title="https://github.com/m1heng/clawdbot-feishu" ref="nofollow noopener noreferrer">GitHub - m1heng/clawdbot-feishu</a></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 一件安装脚本已经安装了飞书，查看飞书插件运行是否加载</span>
openclaw channels list
<span class="hljs-comment"># 如果没看到飞书执行如下命令</span>
openclaw plugins <span class="hljs-built_in">enable</span> feishu
openclaw gateway restart
<span class="hljs-comment"># 如果没有安装飞书，那么执行如下命令</span>
openclaw plugins install @m1heng-clawd/feishu
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b240752b5db047a99ff36519b0899d4b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT3BlbkNsb3VkT1M=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771400017&amp;x-signature=gryXlBykO3T69GhsERMv75fGv7g%3D" alt="" loading="lazy"/></p>
<p>飞书应用（机器人）配置</p>
<p>进入飞书应用中心：<a href="https://link.juejin.cn?target=https%3A%2F%2Fopen.feishu.cn%2Fapp" target="_blank" title="https://open.feishu.cn/app" ref="nofollow noopener noreferrer">开发者后台 - 飞书开放平台</a></p>
<p>创建企业自建应用</p>
<p>路径： 创建应用 → 企业自建应用</p>
<p>  基础信息按提示填写即可（名称、描述等），完成后进入应用详情页。</p>
<p>配置应用权限</p>
<p>进入 权限管理，添加以下权限（按插件文档要求）：</p>
<p>必要权限</p>



































<table><thead><tr><th>权限</th><th>范围</th><th>说明</th></tr></thead><tbody><tr><td>im:message</td><td>消息</td><td>发送和接收消息</td></tr><tr><td>im:message.p2p_msg:readonly</td><td>私聊</td><td>读取发给机器人的私聊消息</td></tr><tr><td>im:message.group_at_msg:readonly</td><td>群聊</td><td>接收群内 @机器人 的消息</td></tr><tr><td>im:message:send_as_bot</td><td>发送</td><td>以机器人身份发送消息</td></tr><tr><td>im:resource</td><td>媒体</td><td>上传和下载图片/文件</td></tr></tbody></table>
<p>可直接复制如下配置直接导入</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"scopes"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"tenant"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-string">"bitable:app:readonly"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"contact:user.base:readonly"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"docx:document"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"docx:document.block:convert"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"docx:document:create"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"docx:document:readonly"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"drive:drive"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"drive:drive:readonly"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"im:chat:readonly"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"im:message"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"im:message.group_at_msg:readonly"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"im:message.group_msg"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"im:message.p2p_msg:readonly"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"im:message:send_as_bot"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"im:resource"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"wiki:wiki:readonly"</span>
    <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"user"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-string">"contact:contact.base:readonly"</span>
    <span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d56a9f6691404dd8a7fd051a444050dc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT3BlbkNsb3VkT1M=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771400017&amp;x-signature=1FYyDYWRp0Io2lQ8sEgVwUs4PMQ%3D" alt="" loading="lazy"/></p>
<p>进入凭证与基础信息 页面，记录 App ID / App Secret 同步更新到 openclaw 配置中</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9c7ea8716448407dbfeb5df5f0203a2f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT3BlbkNsb3VkT1M=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771400017&amp;x-signature=LKIeqcZFYvjbldOfNZradbRGpEE%3D" alt="" loading="lazy"/></p>
<pre><code class="hljs language-arduino" lang="arduino">openclaw config set channels.feishu.appId <span class="hljs-string">"你的appid"</span>
openclaw config set channels.feishu.appSecret <span class="hljs-string">"你的app_secret"</span>
openclaw config set channels.feishu.enabled <span class="hljs-literal">true</span>
 
openclaw gateway restart
# 查看相关配置
openclaw channels list
openclaw config get channels
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3a35948885324304b64ca7a843e351ee~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT3BlbkNsb3VkT1M=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771400017&amp;x-signature=Of846DfMQwvLA5i%2BpDItW1N30%2BE%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a508318e96a148028e865b98e3f62005~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT3BlbkNsb3VkT1M=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771400017&amp;x-signature=tloBYcEaDRCZyN1JQS8Dk57ZHQc%3D" alt="" loading="lazy"/></p>
<p>然后进入事件与回调界面，订阅方式选择长链接</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c49034c61b0d476ba5bf8e364c1ced59~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT3BlbkNsb3VkT1M=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771400017&amp;x-signature=K49HIzVM3RT%2BZmhbLVCyH6c9qec%3D" alt="" loading="lazy"/></p>
<p>之后点击右下角的添加事件</p>
<p>添加如下事件</p>






























<table><thead><tr><th>权限</th><th>范围</th><th>说明</th></tr></thead><tbody><tr><td>im.message.receive_v1</td><td>接收消息（必需）</td><td>发送和接收消息</td></tr><tr><td>im.message.message_read_v1</td><td>消息已读回执</td><td>读取发给机器人的私聊消息</td></tr><tr><td>im.chat.member.bot.added_v1</td><td>机器人进群</td><td>接收群内 @机器人 的消息</td></tr><tr><td>im.chat.member.bot.deleted_v1</td><td>机器人被移出群</td><td>以机器人身份发送消息</td></tr></tbody></table>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b0154fecc5894c809c75af8e28675fc9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT3BlbkNsb3VkT1M=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771400017&amp;x-signature=dzLqqxUEd7QlDr7GU9P%2FhRR3rSs%3D" alt="" loading="lazy"/></p>
<p>之后点击发布</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/059b0af7fe534e159cf0808c1ca32a2e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT3BlbkNsb3VkT1M=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771400017&amp;x-signature=oScshJmJ8HBs2ySiN%2F0EgvbhmlE%3D" alt="" loading="lazy"/></p>
<p>在飞书里直接搜索 你机器人的名字就能和他聊天了。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2b5a0984e094435e94d0711abfb534a5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT3BlbkNsb3VkT1M=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771400017&amp;x-signature=3IKH%2FZZabz1qhw6TZVe78WadGLs%3D" alt="" loading="lazy"/></p>
<h5 data-id="heading-13">3.4 接入钉钉</h5>
<p>钉钉插件地址</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fsoimy%2Fclawdbot-channel-dingtalk.git" target="_blank" title="https://github.com/soimy/clawdbot-channel-dingtalk.git" ref="nofollow noopener noreferrer">GitHub - soimy/openclaw-channel-dingtalk: A dingtalk bot channel plugin for clawdbot</a></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 一件安装脚本已经安装了飞书，查看飞书插件运行是否加载</span>
openclaw channels list
<span class="hljs-comment"># 如果没看到飞书执行如下命令</span>
openclaw plugins <span class="hljs-built_in">enable</span> dingtalk
openclaw gateway restart
<span class="hljs-comment"># 如果没有安装飞书，那么执行如下命令</span>
openclaw plugins install https://github.com/soimy/clawdbot-channel-dingtalk.git
</code></pre>
<p>前往<a href="https://link.juejin.cn?target=https%3A%2F%2Fopen-dev.dingtalk.com%2F" target="_blank" title="https://open-dev.dingtalk.com/" ref="nofollow noopener noreferrer">钉钉开发者后台</a>，使用具有管理员权限的账号进行登录。选择</p>
<p>创建应用-&gt;填写应用名称 和 描述 -&gt; 再点击左侧“添加应用能力” -&gt; 选择 “机器人"-&gt;完善机器人配置 -&gt; 消息接受模式选择 stream模式 -&gt; 点击发布</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4a4f4150a11e40b08c1fe25797b04610~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT3BlbkNsb3VkT1M=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771400017&amp;x-signature=KTuy02HS3XXJpH3nd8kjAfkIprY%3D" alt="" loading="lazy"/></p>
<p>然后点击坐上角的 "凭证与基础信息" 找到Client ID与Client Secret两个参数</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9891060d27424f1a96d3638a65cb3c43~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT3BlbkNsb3VkT1M=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771400017&amp;x-signature=p4lXwbCIeFC6f240HWxGoXUT52E%3D" alt="" loading="lazy"/></p>
<p>然后再进入发布界面，点击保存</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/72c93ad6b9324278bb72de2e556ebce7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT3BlbkNsb3VkT1M=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771400017&amp;x-signature=Ulb3sW6KqnbOdt2ed%2FHjcsp3Vwo%3D" alt="" loading="lazy"/></p>
<p>然后在服务器上输入</p>
<pre><code class="hljs language-arduino" lang="arduino">openclaw config set channels.dingtalk.clientId <span class="hljs-string">"你的ClientID"</span>
openclaw config set channels.dingtalk.clientSecret <span class="hljs-string">"你的Client Secret"</span>
openclaw config set channels.dingtalk.enabled <span class="hljs-literal">true</span>
openclaw gateway restart
# 查看相关配置
openclaw channels list
openclaw config get channels.dingtalk
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/71e78234c5ca404e88829b4663bdf5ce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT3BlbkNsb3VkT1M=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771400017&amp;x-signature=nOB5r9fPurftNfTUAyaxUoyrzAg%3D" alt="" loading="lazy"/></p>
<p>接着你就可以在钉钉里搜索到你的应用并让他给你干活了。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9bf11ccea3fb4e0e91addbdc7d76ee31~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT3BlbkNsb3VkT1M=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771400017&amp;x-signature=T56OGT2jl30%2FtbTFKKTb2bVw7c4%3D" alt="" loading="lazy"/></p>
<p>参考链接</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fnodejs.org%2Fzh-cn%2Fdownload" target="_blank" title="https://nodejs.org/zh-cn/download" ref="nofollow noopener noreferrer">Node.js — 下载 Node.js®</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.molt.bot%2F" target="_blank" title="https://www.molt.bot/" ref="nofollow noopener noreferrer">Moltbot — Personal AI Assistant</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2F%40marshulll%2Fopenclaw-wecom" target="_blank" title="https://www.npmjs.com/package/@marshulll/openclaw-wecom" ref="nofollow noopener noreferrer">openclaw企业微信插件</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.clawhub.ai%2F" target="_blank" title="https://www.clawhub.ai/" ref="nofollow noopener noreferrer">MoltHub</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Flinux.do%2Ft%2Ftopic%2F1518570" target="_blank" title="https://linux.do/t/topic/1518570" ref="nofollow noopener noreferrer">linux.do/t/topic/151…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fcloud.tencent.com%2Fdeveloper%2Farticle%2F2624973" target="_blank" title="https://cloud.tencent.com/developer/article/2624973" ref="nofollow noopener noreferrer">🚀 云上Moltbot（原Clawdbot）最全实践指南合辑-腾讯云开发者社区-腾讯云</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fsliverp%2Fqqbot" target="_blank" title="https://github.com/sliverp/qqbot" ref="nofollow noopener noreferrer">openclaw的QQ机器人插件</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.hubwiz.com%2Fblog%2Fclawdbot-comprehensive-guide%2F" target="_blank" title="https://www.hubwiz.com/blog/clawdbot-comprehensive-guide/" ref="nofollow noopener noreferrer">Clawdbot 全面指南 - 汇智网</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[设计模式-结构型]]></title>    <link>https://juejin.cn/post/7605174711181393983</link>    <guid>https://juejin.cn/post/7605174711181393983</guid>    <pubDate>2026-02-11T08:00:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605174711181393983" data-draft-id="7605142381152682047" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="设计模式-结构型"/> <meta itemprop="keywords" content="前端,后端,设计模式"/> <meta itemprop="datePublished" content="2026-02-11T08:00:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="牛奶"/> <meta itemprop="url" content="https://juejin.cn/user/1169536100866487"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            设计模式-结构型
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1169536100866487/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    牛奶
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-11T08:00:45.000Z" title="Wed Feb 11 2026 08:00:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">设计模式-结构型</h2>
<blockquote>
<p>本文主要介绍下结构型设计模式，包括<code>适配器模式</code>、<code>装饰器模式</code>、<code>代理模式</code>、<code>外观模式</code>、<code>桥接模式</code>、<code>组合模式</code>和<code>享元模式</code>，提供前端场景和 ES6 代码的实现过程。
供自己以后查漏补缺，也欢迎同道朋友交流学习。</p>
</blockquote>
<h3 data-id="heading-1">引言</h3>
<p>最近在梳理前端的一些知识体系，发现漏掉了比较重要的设计模式，所以打算整理下，方便以后查漏补缺。</p>
<p><code>设计模式</code>也是面试中比较常问的知识点，根据分类主要分为<code>创建型</code>、<code>结构型</code>和<code>行为型</code>。通过这些模式，开发者可以更好地理解问题，并找到合适的解决方案。</p>
<p>本文主要介绍下结构型设计模式，包括<code>适配器模式</code>、<code>装饰器模式</code>、<code>代理模式</code>、<code>外观模式</code>、<code>桥接模式</code>、<code>组合模式</code>和<code>享元模式</code>，提供前端场景和 ES6 代码的实现过程。</p>
<h3 data-id="heading-2">什么是结构型</h3>
<p>结构型模式（<code>Structural Patterns</code>）主要关注<code>类</code>和<code>对象</code>的<code>组合</code>。这些模式描述了如何将类或对象<code>结合</code>在一起形成更大的结构，同时保持结构的<code>灵活</code>和<code>高效</code>。结构型模式通过<code>继承</code>或<code>组合</code>的方式来简化系统的设计，解决对象之间的<code>耦合</code>问题，使得系统更加容易扩展和维护。</p>
<h3 data-id="heading-3">适配器模式（Adapter）</h3>
<p>适配器模式（<code>Adapter Pattern</code>）将一个类的<code>接口转换</code>成客户希望的另一个接口，使原本因接口不兼容而不能一起工作的类可以一起工作。</p>
<p>适配器模式通常用于<code>包装</code>现有的类，以便与新的接口或系统进行交互。</p>
<h4 data-id="heading-4">前端中的适配器模式场景</h4>
<ul>
<li><strong>接口数据适配</strong>：后端返回的数据结构可能与前端组件需要的数据结构不一致，可以使用适配器模式进行转换。</li>
<li><strong>旧接口兼容</strong>：在系统重构或升级时，保持对旧接口的兼容性，使用适配器模式将新接口映射到旧接口。</li>
<li><strong>Vue计算属性</strong>：Vue 中的 <code>computed</code> 属性可以看作是一种适配器，将原始数据转换为视图需要的数据格式。</li>
</ul>
<h4 data-id="heading-5">适配器模式-JS实现</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 旧接口</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">OldCalculator</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">operations</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">term1, term2, operation</span>) {
      <span class="hljs-keyword">switch</span> (operation) {
        <span class="hljs-keyword">case</span> <span class="hljs-string">'add'</span>:
          <span class="hljs-keyword">return</span> term1 + term2;
        <span class="hljs-keyword">case</span> <span class="hljs-string">'sub'</span>:
          <span class="hljs-keyword">return</span> term1 - term2;
        <span class="hljs-attr">default</span>:
          <span class="hljs-keyword">return</span> <span class="hljs-title class_">NaN</span>;
      }
    };
  }
}

<span class="hljs-comment">// 新接口</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">NewCalculator</span> {
  <span class="hljs-title function_">add</span>(<span class="hljs-params">term1, term2</span>) {
    <span class="hljs-keyword">return</span> term1 + term2;
  }

  <span class="hljs-title function_">sub</span>(<span class="hljs-params">term1, term2</span>) {
    <span class="hljs-keyword">return</span> term1 - term2;
  }
}

<span class="hljs-comment">// 适配器类</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">CalculatorAdapter</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">calculator</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">NewCalculator</span>();
  }

  <span class="hljs-title function_">operations</span>(<span class="hljs-params">term1, term2, operation</span>) {
    <span class="hljs-keyword">switch</span> (operation) {
      <span class="hljs-keyword">case</span> <span class="hljs-string">'add'</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">calculator</span>.<span class="hljs-title function_">add</span>(term1, term2);
      <span class="hljs-keyword">case</span> <span class="hljs-string">'sub'</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">calculator</span>.<span class="hljs-title function_">sub</span>(term1, term2);
      <span class="hljs-attr">default</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">NaN</span>;
    }
  }
}

<span class="hljs-comment">// 客户端调用</span>
<span class="hljs-keyword">const</span> oldCalc = <span class="hljs-keyword">new</span> <span class="hljs-title class_">OldCalculator</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(oldCalc.<span class="hljs-title function_">operations</span>(<span class="hljs-number">10</span>, <span class="hljs-number">5</span>, <span class="hljs-string">'add'</span>)); <span class="hljs-comment">// 15</span>

<span class="hljs-keyword">const</span> newCalc = <span class="hljs-keyword">new</span> <span class="hljs-title class_">NewCalculator</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(newCalc.<span class="hljs-title function_">add</span>(<span class="hljs-number">10</span>, <span class="hljs-number">5</span>)); <span class="hljs-comment">// 15</span>

<span class="hljs-keyword">const</span> adapter = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CalculatorAdapter</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(adapter.<span class="hljs-title function_">operations</span>(<span class="hljs-number">10</span>, <span class="hljs-number">5</span>, <span class="hljs-string">'add'</span>)); <span class="hljs-comment">// 15</span>
</code></pre>
<h3 data-id="heading-6">装饰器模式（Decorator）</h3>
<p>装饰器模式（<code>Decorator Pattern</code>）<code>动态</code>地给一个对象添加一些额外的职责，而不影响该对象所属类的其他实例。</p>
<p>装饰器模式提供了一种灵活的替代继承方案，用于扩展对象的功能。</p>
<h4 data-id="heading-7">前端中的装饰器模式场景</h4>
<ul>
<li><strong>高阶组件（HOC）</strong>：在 <code>React</code> 中，高阶组件本质上就是装饰器模式的应用，用于复用组件逻辑。</li>
<li><strong>类装饰器</strong>：在 <code>ES7</code> 装饰器语法或 <code>TypeScript</code> 中，可以使用装饰器来增强类或类的方法，例如用于日志记录、性能监控、权限控制等。</li>
</ul>
<h4 data-id="heading-8">装饰器模式-JS实现</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 原始对象</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Circle</span> {
  <span class="hljs-title function_">draw</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"画一个圆形"</span>);
  }
}

<span class="hljs-comment">// 装饰器基类</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Decorator</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">circle</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">circle</span> = circle;
  }

  <span class="hljs-title function_">draw</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">circle</span>.<span class="hljs-title function_">draw</span>();
  }
}

<span class="hljs-comment">// 具体装饰器：添加红色边框</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">RedBorderDecorator</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Decorator</span> {
  <span class="hljs-title function_">draw</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">circle</span>.<span class="hljs-title function_">draw</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setRedBorder</span>();
  }

  <span class="hljs-title function_">setRedBorder</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"添加红色边框"</span>);
  }
}

<span class="hljs-comment">// 客户端调用</span>
<span class="hljs-keyword">const</span> circle = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Circle</span>();
circle.<span class="hljs-title function_">draw</span>();
<span class="hljs-comment">// 输出：</span>
<span class="hljs-comment">// 画一个圆形</span>

<span class="hljs-keyword">const</span> redCircle = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RedBorderDecorator</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Circle</span>());
redCircle.<span class="hljs-title function_">draw</span>();
<span class="hljs-comment">// 输出：</span>
<span class="hljs-comment">// 画一个圆形</span>
<span class="hljs-comment">// 添加红色边框</span>
</code></pre>
<h3 data-id="heading-9">代理模式（Proxy）</h3>
<p>代理模式（<code>Proxy Pattern</code>）为其他对象提供一种<code>代理</code>以控制对这个对象的访问。</p>
<p>代理模式可以在访问对象之前或之后执行额外的操作，如权限验证、延迟加载、缓存等。</p>
<h4 data-id="heading-10">前端中的代理模式场景</h4>
<ul>
<li><strong>数据响应式</strong>：<code>Vue 3</code> 使用 <code>Proxy</code> 对象来实现数据的响应式系统，拦截对象的读取和修改操作。</li>
<li><strong>网络请求代理</strong>：在开发环境中，配置代理服务器（如 <code>webpack-dev-server</code> 的 proxy）解决跨域问题。</li>
<li><strong>虚拟代理</strong>：例如图片懒加载，先显示占位图，等图片加载完成后再替换为真实图片。</li>
<li><strong>缓存代理</strong>：对于开销较大的计算结果或网络请求结果进行缓存，下次请求时直接返回缓存结果。</li>
</ul>
<h4 data-id="heading-11">代理模式-JS实现</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 真实图片加载类</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">RealImage</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">fileName</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">fileName</span> = fileName;
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">loadFromDisk</span>(fileName);
  }

  <span class="hljs-title function_">loadFromDisk</span>(<span class="hljs-params">fileName</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"正在从磁盘加载 "</span> + fileName);
  }

  <span class="hljs-title function_">display</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"显示 "</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">fileName</span>);
  }
}

<span class="hljs-comment">// 代理图片类</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ProxyImage</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">fileName</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">fileName</span> = fileName;
  }

  <span class="hljs-title function_">display</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">realImage</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">realImage</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RealImage</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">fileName</span>);
    }
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">realImage</span>.<span class="hljs-title function_">display</span>();
  }
}

<span class="hljs-comment">// 客户端调用</span>
<span class="hljs-keyword">const</span> image = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProxyImage</span>(<span class="hljs-string">"test.jpg"</span>);

<span class="hljs-comment">// 第一次调用，加载图片</span>
image.<span class="hljs-title function_">display</span>();
<span class="hljs-comment">// 输出：</span>
<span class="hljs-comment">// 正在从磁盘加载 test.jpg</span>
<span class="hljs-comment">// 显示 test.jpg</span>

<span class="hljs-comment">// 第二次调用，直接显示</span>
image.<span class="hljs-title function_">display</span>();
<span class="hljs-comment">// 输出：</span>
<span class="hljs-comment">// 显示 test.jpg</span>
</code></pre>
<h3 data-id="heading-12">外观模式（Facade）</h3>
<p>外观模式（<code>Facade Pattern</code>）提供一个<code>统一的接口</code>，用来访问子系统中的一群接口。外观模式定义了一个高层接口，让子系统更容易使用。</p>
<h4 data-id="heading-13">前端中的外观模式场景</h4>
<ul>
<li><strong>浏览器兼容性封装</strong>：封装不同浏览器的 <code>API</code> 差异，提供统一的接口。例如，封装事件监听函数，统一处理 <code>addEventListener</code> 和 <code>attachEvent</code>。</li>
<li><strong>简化复杂库的使用</strong>：例如 <code>jQuery</code> 或 <code>Axios</code>，它们为复杂的原生 DOM 操作或 XMLHttpRequest 提供了简单易用的接口。</li>
</ul>
<h4 data-id="heading-14">外观模式-JS实现</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 子系统1：灯光</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Light</span> {
  <span class="hljs-title function_">on</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"开灯"</span>);
  }
  <span class="hljs-title function_">off</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"关灯"</span>);
  }
}

<span class="hljs-comment">// 子系统2：电视</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">TV</span> {
  <span class="hljs-title function_">on</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"打开电视"</span>);
  }
  <span class="hljs-title function_">off</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"关闭电视"</span>);
  }
}

<span class="hljs-comment">// 子系统3：音响</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">SoundSystem</span> {
  <span class="hljs-title function_">on</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"打开音响"</span>);
  }
  <span class="hljs-title function_">off</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"关闭音响"</span>);
  }
}

<span class="hljs-comment">// 外观类：家庭影院</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">HomeTheaterFacade</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">light, tv, sound</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">light</span> = light;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tv</span> = tv;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">sound</span> = sound;
  }

  <span class="hljs-title function_">watchMovie</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"--- 准备看电影 ---"</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">light</span>.<span class="hljs-title function_">off</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tv</span>.<span class="hljs-title function_">on</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">sound</span>.<span class="hljs-title function_">on</span>();
  }

  <span class="hljs-title function_">endMovie</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"--- 结束看电影 ---"</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">light</span>.<span class="hljs-title function_">on</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tv</span>.<span class="hljs-title function_">off</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">sound</span>.<span class="hljs-title function_">off</span>();
  }
}

<span class="hljs-comment">// 客户端调用</span>
<span class="hljs-keyword">const</span> light = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Light</span>();
<span class="hljs-keyword">const</span> tv = <span class="hljs-keyword">new</span> <span class="hljs-title function_">TV</span>();
<span class="hljs-keyword">const</span> sound = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SoundSystem</span>();
<span class="hljs-keyword">const</span> homeTheater = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HomeTheaterFacade</span>(light, tv, sound);

homeTheater.<span class="hljs-title function_">watchMovie</span>();
<span class="hljs-comment">// 输出：</span>
<span class="hljs-comment">// --- 准备看电影 ---</span>
<span class="hljs-comment">// 关灯</span>
<span class="hljs-comment">// 打开电视</span>
<span class="hljs-comment">// 打开音响</span>

homeTheater.<span class="hljs-title function_">endMovie</span>();
<span class="hljs-comment">// 输出：</span>
<span class="hljs-comment">// --- 结束看电影 ---</span>
<span class="hljs-comment">// 开灯</span>
<span class="hljs-comment">// 关闭电视</span>
<span class="hljs-comment">// 关闭音响</span>
</code></pre>
<h3 data-id="heading-15">桥接模式（Bridge）</h3>
<p>桥接模式（<code>Bridge Pattern</code>）将<code>抽象部分</code>与它的<code>实现部分</code>分离，使它们可以独立地变化。</p>
<h4 data-id="heading-16">前端中的桥接模式场景</h4>
<ul>
<li><strong>UI组件与渲染引擎分离</strong>：例如，一个通用的图表库，可以将图表的<code>逻辑</code>（抽象部分）与具体的<code>渲染方式</code>（实现部分，如 Canvas、SVG、WebGL）分离。</li>
<li><strong>事件监听</strong>：在绑定事件时，将<code>回调函数</code>（实现部分）与<code>事件绑定</code>（抽象部分）分离，使得回调函数可以复用。</li>
</ul>
<h4 data-id="heading-17">桥接模式-JS实现</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 实现部分接口：颜色</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Color</span> {
  <span class="hljs-title function_">fill</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"抽象方法不能调用"</span>);
  }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Red</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Color</span> {
  <span class="hljs-title function_">fill</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">"红色"</span>;
  }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Green</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Color</span> {
  <span class="hljs-title function_">fill</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">"绿色"</span>;
  }
}

<span class="hljs-comment">// 抽象部分：形状</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Shape</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">color</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">color</span> = color;
  }

  <span class="hljs-title function_">draw</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"抽象方法不能调用"</span>);
  }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Circle</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Shape</span> {
  <span class="hljs-title function_">draw</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`画一个<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.color.fill()}</span>的圆形`</span>);
  }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Square</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Shape</span> {
  <span class="hljs-title function_">draw</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`画一个<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.color.fill()}</span>的正方形`</span>);
  }
}

<span class="hljs-comment">// 客户端调用</span>
<span class="hljs-keyword">const</span> redCircle = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Circle</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Red</span>());
redCircle.<span class="hljs-title function_">draw</span>(); <span class="hljs-comment">// 画一个红色的圆形</span>

<span class="hljs-keyword">const</span> greenSquare = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Square</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Green</span>());
greenSquare.<span class="hljs-title function_">draw</span>(); <span class="hljs-comment">// 画一个绿色的正方形</span>
</code></pre>
<h3 data-id="heading-18">组合模式（Composite）</h3>
<p>组合模式（<code>Composite Pattern</code>）将对象组合成<code>树形结构</code>以表示“部分-整体”的层次结构。组合模式使得用户对单个对象和组合对象的使用具有一致性。</p>
<h4 data-id="heading-19">前端中的组合模式场景</h4>
<ul>
<li><strong>DOM树</strong>：DOM 树本身就是一个典型的组合模式结构，既包含具体的节点（如 <code>div</code>、<code>span</code>），也包含包含其他节点的容器。</li>
<li><strong>虚拟DOM</strong>：<code>Virtual DOM</code> 也是树形结构，组件可以包含其他组件或原生元素。</li>
<li><strong>文件目录系统</strong>：文件夹可以包含文件或子文件夹。</li>
<li><strong>级联菜单</strong>：多级菜单的展示和操作。</li>
</ul>
<h4 data-id="heading-20">组合模式-JS实现</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 组件基类</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Component</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">name</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
  }

  <span class="hljs-title function_">add</span>(<span class="hljs-params">component</span>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"不支持该操作"</span>);
  }

  <span class="hljs-title function_">remove</span>(<span class="hljs-params">component</span>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"不支持该操作"</span>);
  }

  <span class="hljs-title function_">print</span>(<span class="hljs-params">indent = <span class="hljs-string">""</span></span>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"不支持该操作"</span>);
  }
}

<span class="hljs-comment">// 叶子节点：文件</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">File</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Component</span> {
  <span class="hljs-title function_">print</span>(<span class="hljs-params">indent = <span class="hljs-string">""</span></span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${indent}</span>- <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span>`</span>);
  }
}

<span class="hljs-comment">// 组合节点：文件夹</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Folder</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Component</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">name</span>) {
    <span class="hljs-variable language_">super</span>(name);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">children</span> = [];
  }

  <span class="hljs-title function_">add</span>(<span class="hljs-params">component</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">children</span>.<span class="hljs-title function_">push</span>(component);
  }

  <span class="hljs-title function_">remove</span>(<span class="hljs-params">component</span>) {
    <span class="hljs-keyword">const</span> index = <span class="hljs-variable language_">this</span>.<span class="hljs-property">children</span>.<span class="hljs-title function_">indexOf</span>(component);
    <span class="hljs-keyword">if</span> (index &gt; -<span class="hljs-number">1</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">children</span>.<span class="hljs-title function_">splice</span>(index, <span class="hljs-number">1</span>);
    }
  }

  <span class="hljs-title function_">print</span>(<span class="hljs-params">indent = <span class="hljs-string">""</span></span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${indent}</span>+ <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span>`</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">children</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">child</span> =&gt;</span> {
      child.<span class="hljs-title function_">print</span>(indent + <span class="hljs-string">"  "</span>);
    });
  }
}

<span class="hljs-comment">// 客户端调用</span>
<span class="hljs-keyword">const</span> root = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Folder</span>(<span class="hljs-string">"根目录"</span>);
<span class="hljs-keyword">const</span> folder1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Folder</span>(<span class="hljs-string">"文档"</span>);
<span class="hljs-keyword">const</span> folder2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Folder</span>(<span class="hljs-string">"图片"</span>);

<span class="hljs-keyword">const</span> file1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">"简历.doc"</span>);
<span class="hljs-keyword">const</span> file2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">"照片.jpg"</span>);
<span class="hljs-keyword">const</span> file3 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">"logo.png"</span>);

root.<span class="hljs-title function_">add</span>(folder1);
root.<span class="hljs-title function_">add</span>(folder2);
folder1.<span class="hljs-title function_">add</span>(file1);
folder2.<span class="hljs-title function_">add</span>(file2);
folder2.<span class="hljs-title function_">add</span>(file3);

root.<span class="hljs-title function_">print</span>();
<span class="hljs-comment">// 输出：</span>
<span class="hljs-comment">// + 根目录</span>
<span class="hljs-comment">//   + 文档</span>
<span class="hljs-comment">//     - 简历.doc</span>
<span class="hljs-comment">//   + 图片</span>
<span class="hljs-comment">//     - 照片.jpg</span>
<span class="hljs-comment">//     - logo.png</span>
</code></pre>
<h3 data-id="heading-21">享元模式（Flyweight）</h3>
<p>享元模式（<code>Flyweight Pattern</code>）通过<code>共享</code>来高效地支持大量细粒度的对象。</p>
<h4 data-id="heading-22">前端中的享元模式场景</h4>
<ul>
<li><strong>事件委托</strong>：在父元素上绑定事件监听器，通过事件冒泡处理子元素的事件，避免为每个子元素绑定监听器，节省内存。</li>
<li><strong>对象池</strong>：在游戏开发或复杂动画中，预先创建一组对象放入池中，使用时取出，用完归还，避免频繁创建和销毁对象。</li>
<li><strong>DOM复用</strong>：在长列表滚动（虚拟滚动）中，只渲染可视区域的 DOM 节点，回收并复用移出可视区域的节点。</li>
</ul>
<h4 data-id="heading-23">享元模式-JS实现</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 享元工厂</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ShapeFactory</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">circleMap</span> = {};
  }

  <span class="hljs-title function_">getCircle</span>(<span class="hljs-params">color</span>) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">circleMap</span>[color]) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">circleMap</span>[color] = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Circle</span>(color);
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`创建新的 <span class="hljs-subst">${color}</span> 圆形`</span>);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">circleMap</span>[color];
  }
}

<span class="hljs-comment">// 具体享元类</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Circle</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">color</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">color</span> = color;
  }

  <span class="hljs-title function_">draw</span>(<span class="hljs-params">x, y</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`在 (<span class="hljs-subst">${x}</span>, <span class="hljs-subst">${y}</span>) 画一个 <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.color}</span> 的圆形`</span>);
  }
}

<span class="hljs-comment">// 客户端调用</span>
<span class="hljs-keyword">const</span> factory = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ShapeFactory</span>();

<span class="hljs-keyword">const</span> redCircle1 = factory.<span class="hljs-title function_">getCircle</span>(<span class="hljs-string">"红色"</span>);
redCircle1.<span class="hljs-title function_">draw</span>(<span class="hljs-number">10</span>, <span class="hljs-number">10</span>);

<span class="hljs-keyword">const</span> redCircle2 = factory.<span class="hljs-title function_">getCircle</span>(<span class="hljs-string">"红色"</span>);
redCircle2.<span class="hljs-title function_">draw</span>(<span class="hljs-number">20</span>, <span class="hljs-number">20</span>);

<span class="hljs-keyword">const</span> blueCircle = factory.<span class="hljs-title function_">getCircle</span>(<span class="hljs-string">"蓝色"</span>);
blueCircle.<span class="hljs-title function_">draw</span>(<span class="hljs-number">30</span>, <span class="hljs-number">30</span>);

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(redCircle1 === redCircle2); <span class="hljs-comment">// true</span>
<span class="hljs-comment">// 输出：</span>
<span class="hljs-comment">// 创建新的 红色 圆形</span>
<span class="hljs-comment">// 在 (10, 10) 画一个 红色 的圆形</span>
<span class="hljs-comment">// 在 (20, 20) 画一个 红色 的圆形</span>
<span class="hljs-comment">// 创建新的 蓝色 圆形</span>
<span class="hljs-comment">// 在 (30, 30) 画一个 蓝色 的圆形</span>
<span class="hljs-comment">// true</span>
</code></pre>
<h3 data-id="heading-24">项目地址</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fcangnaiwen%2Fdesign-patterns-study" target="_blank" title="https://gitee.com/cangnaiwen/design-patterns-study" ref="nofollow noopener noreferrer">design-patterns-study</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[MySQL高可用终极指南：Keepalived实战精讲，从VIP漂移到主从切换，一篇搞定！]]></title>    <link>https://juejin.cn/post/7605173538417033226</link>    <guid>https://juejin.cn/post/7605173538417033226</guid>    <pubDate>2026-02-11T06:10:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605173538417033226" data-draft-id="7605164560711237658" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="MySQL高可用终极指南：Keepalived实战精讲，从VIP漂移到主从切换，一篇搞定！"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-02-11T06:10:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Java编程爱好者"/> <meta itemprop="url" content="https://juejin.cn/user/819554264300154"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            MySQL高可用终极指南：Keepalived实战精讲，从VIP漂移到主从切换，一篇搞定！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/819554264300154/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Java编程爱好者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-11T06:10:30.000Z" title="Wed Feb 11 2026 06:10:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读18分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>兄弟们，高可用这东西，不出事时岁月静好，一出事就是P1级故障。还记得那次吗？某核心交易系统，MySQL主库的存储IOPS突然飙到100%，整个实例hang死，别说交易了，连登录都登不上去。按理说，咱们的<a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D269081829%26content_type%3DArticle%26match_order%3D1%26q%3DMySQL%25E4%25B8%25BB%25E4%25BB%258E%25E5%25A4%258D%25E5%2588%25B6%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=269081829&amp;content_type=Article&amp;match_order=1&amp;q=MySQL%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6&amp;zhida_source=entity" ref="nofollow noopener noreferrer">MySQL主从复制</a>是配了的，备库数据也跟得紧紧的。但最要命的是，业务访问的那个VIP（虚拟IP），像被502胶水焊死了一样，还死死地钉在故障机上，导致业务全断。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D269081829%26content_type%3DArticle%26match_order%3D1%26q%3D%25E9%25A1%25B9%25E7%259B%25AE%25E7%25BB%258F%25E7%2590%2586%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=269081829&amp;content_type=Article&amp;match_order=1&amp;q=%E9%A1%B9%E7%9B%AE%E7%BB%8F%E7%90%86&amp;zhida_source=entity" ref="nofollow noopener noreferrer">项目经理</a>的电话比闹钟还准时，三点准时响起，那语气，恨不得从电话线里爬过来掐我脖子。</p>
<p>查了半天，根源找到了：只做了数据层的高可用（主从复制），却忽略了<strong>服务层的高可用（VIP自动漂移）</strong> 。高可用是个“木桶”，最短的那块板决定你的睡眠质量。你的数据同步得再快，应用访问不到也是白搭。</p>
<p>今天这篇，就是要把这块最短的板补上。我带你用<a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D269081829%26content_type%3DArticle%26match_order%3D1%26q%3DKeepalived%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=269081829&amp;content_type=Article&amp;match_order=1&amp;q=Keepalived&amp;zhida_source=entity" ref="nofollow noopener noreferrer">Keepalived</a>这个“神器”，从零开始搭建一个真正能自动切换、让你睡得安稳的MySQL高可用架构。</p>
<h3 data-id="heading-0">1 Keepalived是个啥？</h3>
<p>别被那些复杂的文档吓到，这玩意的原理其实很简单。</p>
<p><strong>通俗解释:</strong>  你可以把Keepalived比作两个时刻准备“抢公章”（也就是我们的VIP）的办公室主任（两台MySQL服务器）。谁的“声望”（<code>priority</code> 优先级）高，默认就由谁拿着公章对外提供服务。这个拿着公章的主任，为了证明自己还活着，会定期在办公室里“吼一嗓子”（发送VRRP心跳通告），告诉另一位主任：“我还行，公章还在我这！” 如果大家在规定时间内没听到他吼，那么另一位主任就会立刻站出来，把公章抢过来，继续对外服务。</p>
<p><strong>核心概念:</strong></p>
<ul>
<li>
<p><strong>VRRP协议 (Virtual Router Redundancy Protocol):</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D269081829%26content_type%3DArticle%26match_order%3D1%26q%3D%25E8%2599%259A%25E6%258B%259F%25E8%25B7%25AF%25E7%2594%25B1%25E5%2586%2597%25E4%25BD%2599%25E5%258D%258F%25E8%25AE%25AE%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=269081829&amp;content_type=Article&amp;match_order=1&amp;q=%E8%99%9A%E6%8B%9F%E8%B7%AF%E7%94%B1%E5%86%97%E4%BD%99%E5%8D%8F%E8%AE%AE&amp;zhida_source=entity" ref="nofollow noopener noreferrer">虚拟路由冗余协议</a>，这就是Keepalived实现高可用的技术基础，刚才说的“吼一嗓子”就是通过这个协议来的。</p>
</li>
<li>
<p><strong>VIP (<a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D269081829%26content_type%3DArticle%26match_order%3D2%26q%3D%25E8%2599%259A%25E6%258B%259FIP%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=269081829&amp;content_type=Article&amp;match_order=2&amp;q=%E8%99%9A%E6%8B%9FIP&amp;zhida_source=entity" ref="nofollow noopener noreferrer">虚拟IP</a>):</strong>  对外统一的服务入口，高可用的灵魂。应用程序连接的是这个永不改变的IP，它底下是哪台机器在干活，<a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D269081829%26content_type%3DArticle%26match_order%3D1%26q%3D%25E5%25BA%2594%25E7%2594%25A8%25E5%25B1%2582%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=269081829&amp;content_type=Article&amp;match_order=1&amp;q=%E5%BA%94%E7%94%A8%E5%B1%82&amp;zhida_source=entity" ref="nofollow noopener noreferrer">应用层</a>完全无感。</p>
</li>
<li>
<p><strong>MASTER/BACKUP 角色:</strong>  一个VRRP实例中，同一时间只有一台是MASTER（主），负责持有VIP。其他都是BACKUP（备），时刻准备接管。这个角色是根据<code>priority</code>值动态选举出来的。</p>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/90cc9274ba03461983b94d8132f5ccf7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2Yee8lueoi-eIseWlveiAhQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771395031&amp;x-signature=ACzgg%2BOLzruO0krI3reEkIzEvTI%3D" alt="" loading="lazy"/></p>
<p>这张图把关系说透了：客户端只认VIP。VIP平时在MASTER身上。MASTER和BACKUP之间通过VRRP心跳互相知晓对方的存活状态。一旦MASTER挂了，心跳中断，BACKUP就会把VIP“抢”过来。</p>
<h3 data-id="heading-1">2 环境准备与安装</h3>
<p>光说不练假把式，开整！</p>
<p><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D269081829%26content_type%3DArticle%26match_order%3D1%26q%3D%25E7%258E%25AF%25E5%25A2%2583%25E8%25A7%2584%25E5%2588%2592%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=269081829&amp;content_type=Article&amp;match_order=1&amp;q=%E7%8E%AF%E5%A2%83%E8%A7%84%E5%88%92&amp;zhida_source=entity" ref="nofollow noopener noreferrer">环境规划</a>:</strong></p>
<ul>
<li>服务器A (主节点): <code>mysql-node1</code>，物理IP <code>192.168.31.101</code></li>
<li>服务器B (备节点): <code>mysql-node2</code>，物理IP <code>192.168.31.102</code></li>
<li>虚拟IP (VIP): <code>192.168.31.1010</code></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D269081829%26content_type%3DArticle%26match_order%3D1%26q%3D%25E6%2593%258D%25E4%25BD%259C%25E7%25B3%25BB%25E7%25BB%259F%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=269081829&amp;content_type=Article&amp;match_order=1&amp;q=%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F&amp;zhida_source=entity" ref="nofollow noopener noreferrer">操作系统</a>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D269081829%26content_type%3DArticle%26match_order%3D1%26q%3DRed%2BHat%2B8.2%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=269081829&amp;content_type=Article&amp;match_order=1&amp;q=Red+Hat+8.2&amp;zhida_source=entity" ref="nofollow noopener noreferrer">Red Hat 8.2</a></li>
<li>Keepalived版本: 2.0.10 (RHEL 8 自带)</li>
</ul>
<p><strong>安装步骤 (RHEL 8):</strong>  这个简单，两台机器上都执行就行了，属于“抄作业”环节。</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># dnf -y install keepalived</span>

<span class="hljs-comment"># 执行结果如下</span>
<span class="hljs-string">Local</span> <span class="hljs-string">Repository</span>                                                                                      <span class="hljs-number">2.7</span> <span class="hljs-string">MB/s</span> <span class="hljs-string">|</span> <span class="hljs-number">2.8</span> <span class="hljs-string">kB</span>     <span class="hljs-number">00</span><span class="hljs-string">:00</span>    
<span class="hljs-string">Local</span> <span class="hljs-string">Repository</span>                                                                                      <span class="hljs-number">3.1</span> <span class="hljs-string">MB/s</span> <span class="hljs-string">|</span> <span class="hljs-number">3.2</span> <span class="hljs-string">kB</span>     <span class="hljs-number">00</span><span class="hljs-string">:00</span>    
<span class="hljs-string">Dependencies</span> <span class="hljs-string">resolved.</span>
<span class="hljs-string">======================================================================================================================================</span>
 <span class="hljs-string">Package</span>                        <span class="hljs-string">Architecture</span>   <span class="hljs-string">Version</span>                               <span class="hljs-string">Repository</span>                                  <span class="hljs-string">Size</span>
<span class="hljs-string">======================================================================================================================================</span>
<span class="hljs-attr">Installing:</span>
 <span class="hljs-string">keepalived</span>                     <span class="hljs-string">x86_64</span>         <span class="hljs-number">2.0</span><span class="hljs-number">.10</span><span class="hljs-number">-10.</span><span class="hljs-string">el8</span>                         <span class="hljs-string">local-AppStream</span>                            <span class="hljs-number">466</span> <span class="hljs-string">k</span>
<span class="hljs-attr">Installing dependencies:</span>
 <span class="hljs-string">lm_sensors-libs</span>                <span class="hljs-string">x86_64</span>         <span class="hljs-number">3.4</span><span class="hljs-number">.0</span><span class="hljs-number">-21.</span><span class="hljs-string">20180522git70f7e08.el8</span>       <span class="hljs-string">local</span>                                       <span class="hljs-number">59</span> <span class="hljs-string">k</span>
 <span class="hljs-string">mariadb-connector-c</span>            <span class="hljs-string">x86_64</span>         <span class="hljs-number">3.0</span><span class="hljs-number">.7</span><span class="hljs-number">-1.</span><span class="hljs-string">el8</span>                           <span class="hljs-string">local-AppStream</span>                            <span class="hljs-number">148</span> <span class="hljs-string">k</span>
 <span class="hljs-string">net-snmp-agent-libs</span>            <span class="hljs-string">x86_64</span>         <span class="hljs-number">1</span><span class="hljs-string">:5.8-14.el8</span>                          <span class="hljs-string">local-AppStream</span>                            <span class="hljs-number">747</span> <span class="hljs-string">k</span>
 <span class="hljs-string">net-snmp-libs</span>                  <span class="hljs-string">x86_64</span>         <span class="hljs-number">1</span><span class="hljs-string">:5.8-14.el8</span>                          <span class="hljs-string">local</span>                                      <span class="hljs-number">821</span> <span class="hljs-string">k</span>

<span class="hljs-string">Transaction</span> <span class="hljs-string">Summary</span>
<span class="hljs-string">======================================================================================================================================</span>
<span class="hljs-string">Install</span>  <span class="hljs-number">5</span> <span class="hljs-string">Packages</span>

<span class="hljs-attr">Total size:</span> <span class="hljs-number">2.2</span> <span class="hljs-string">M</span>
<span class="hljs-attr">Installed size:</span> <span class="hljs-number">7.2</span> <span class="hljs-string">M</span>
<span class="hljs-attr">Downloading Packages:</span>
<span class="hljs-string">Running</span> <span class="hljs-string">transaction</span> <span class="hljs-string">check</span>
<span class="hljs-string">Transaction</span> <span class="hljs-string">check</span> <span class="hljs-string">succeeded.</span>
<span class="hljs-string">Running</span> <span class="hljs-string">transaction</span> <span class="hljs-string">test</span>
<span class="hljs-string">Transaction</span> <span class="hljs-string">test</span> <span class="hljs-string">succeeded.</span>
<span class="hljs-string">Running</span> <span class="hljs-string">transaction</span>
  <span class="hljs-attr">Running scriptlet:</span> <span class="hljs-string">mariadb-connector-c-3.0.7-1.el8.x86_64</span>                            <span class="hljs-number">1</span><span class="hljs-string">/1</span> 
  <span class="hljs-attr">Preparing        :</span>                                                                   <span class="hljs-number">1</span><span class="hljs-string">/1</span> 
  <span class="hljs-attr">Installing       :</span> <span class="hljs-string">net-snmp-libs-1:5.8-14.el8.x86_64</span>                                 <span class="hljs-number">1</span><span class="hljs-string">/5</span> 
  <span class="hljs-attr">Installing       :</span> <span class="hljs-string">mariadb-connector-c-3.0.7-1.el8.x86_64</span>                            <span class="hljs-number">2</span><span class="hljs-string">/5</span> 
  <span class="hljs-attr">Installing       :</span> <span class="hljs-string">lm_sensors-libs-3.4.0-21.20180522git70f7e08.el8.x86_64</span>            <span class="hljs-number">3</span><span class="hljs-string">/5</span> 
  <span class="hljs-attr">Running scriptlet:</span> <span class="hljs-string">lm_sensors-libs-3.4.0-21.20180522git70f7e08.el8.x86_64</span>            <span class="hljs-number">3</span><span class="hljs-string">/5</span> 
  <span class="hljs-attr">Installing       :</span> <span class="hljs-string">net-snmp-agent-libs-1:5.8-14.el8.x86_64</span>                           <span class="hljs-number">4</span><span class="hljs-string">/5</span> 
  <span class="hljs-attr">Installing       :</span> <span class="hljs-string">keepalived-2.0.10-10.el8.x86_64</span>                                   <span class="hljs-number">5</span><span class="hljs-string">/5</span> 
  <span class="hljs-attr">Running scriptlet:</span> <span class="hljs-string">keepalived-2.0.10-10.el8.x86_64</span>                                   <span class="hljs-number">5</span><span class="hljs-string">/5</span> 
  <span class="hljs-attr">Verifying        :</span> <span class="hljs-string">lm_sensors-libs-3.4.0-21.20180522git70f7e08.el8.x86_64</span>            <span class="hljs-number">1</span><span class="hljs-string">/5</span> 
  <span class="hljs-attr">Verifying        :</span> <span class="hljs-string">net-snmp-libs-1:5.8-14.el8.x86_64</span>                                 <span class="hljs-number">2</span><span class="hljs-string">/5</span> 
  <span class="hljs-attr">Verifying        :</span> <span class="hljs-string">keepalived-2.0.10-10.el8.x86_64</span>                                   <span class="hljs-number">3</span><span class="hljs-string">/5</span> 
  <span class="hljs-attr">Verifying        :</span> <span class="hljs-string">mariadb-connector-c-3.0.7-1.el8.x86_64</span>                            <span class="hljs-number">4</span><span class="hljs-string">/5</span> 
  <span class="hljs-attr">Verifying        :</span> <span class="hljs-string">net-snmp-agent-libs-1:5.8-14.el8.x86_64</span>                           <span class="hljs-number">5</span><span class="hljs-string">/5</span> 
<span class="hljs-string">Installed</span> <span class="hljs-string">products</span> <span class="hljs-string">updated.</span>

<span class="hljs-attr">Installed:</span>
  <span class="hljs-string">keepalived-2.0.10-10.el8.x86_64</span>        <span class="hljs-string">lm_sensors-libs-3.4.0-21.20180522git70f7e08.el8.x86_64</span>      
  <span class="hljs-string">mariadb-connector-c-3.0.7-1.el8.x86_64</span>      <span class="hljs-string">net-snmp-agent-libs-1:5.8-14.el8.x86_64</span>     
  <span class="hljs-string">net-snmp-libs-1:5.8-14.el8.x86_64</span>     

<span class="hljs-string">Complete!</span>


<span class="hljs-comment">## 确认版本</span>
[<span class="hljs-string">root@node101</span> <span class="hljs-string">~</span>]<span class="hljs-comment"># keepalived --version</span>
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c7767d4f16974a659a7d778019b39999~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2Yee8lueoi-eIseWlveiAhQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771395031&amp;x-signature=b3GvGTNPANejf2CZspd7rbUDQ2g%3D" alt="" loading="lazy"/></p>
<p><strong>防火墙配置:</strong></p>
<blockquote>
<p>⚠️ <strong>生产大坑:</strong>  兄弟们注意了，这是我踩过最大的坑！必须放行VRRP协议！Keepalived主备节点之间靠VRRP<a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D269081829%26content_type%3DArticle%26match_order%3D1%26q%3D%25E5%258D%258F%25E8%25AE%25AE%25E9%2580%259A%25E4%25BF%25A1%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=269081829&amp;content_type=Article&amp;match_order=1&amp;q=%E5%8D%8F%E8%AE%AE%E9%80%9A%E4%BF%A1&amp;zhida_source=entity" ref="nofollow noopener noreferrer">协议通信</a>，你把防火墙挡住了，它俩就成了“聋子和瞎子”，互相都以为对方挂了，结果就是两边都抢着声明自己是MASTER，都去绑定VIP。这就是传说中的“<a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D269081829%26content_type%3DArticle%26match_order%3D1%26q%3D%25E8%2584%2591%25E8%25A3%2582%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=269081829&amp;content_type=Article&amp;match_order=1&amp;q=%E8%84%91%E8%A3%82&amp;zhida_source=entity" ref="nofollow noopener noreferrer">脑裂</a>”！业务流量一会打到A，一会打到B，数据不一致，等着背锅吧。</p>
</blockquote>
<p>如果服务器上防火墙是开着的，得在两台机器上都执行：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-meta"># firewall-cmd --add-rich-rule=<span class="hljs-string">'rule protocol value="vrrp" accept'</span> --permanent</span>
<span class="hljs-meta"># firewall-cmd --reload</span>
</code></pre>
<p><strong>内核参数调整:</strong>  Keepalived需要把一个不属于本机网卡的IP（也就是VIP）绑定上来，默认Linux内核是不允许的。所以需要调整一个内核参数。</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># echo "net.ipv4.ip_nonlocal_bind = 1" &gt;&gt; /etc/sysctl.conf</span>
<span class="hljs-comment"># sysctl -p</span>

<span class="hljs-comment">## 结果如下</span>
<span class="hljs-section">[root@node101 ~]</span><span class="hljs-comment"># sysctl -p</span>
<span class="hljs-attr">net.ipv4.ip_nonlocal_bind</span> = <span class="hljs-number">1</span>
</code></pre>
<p>这个操作也是两台机器都要做。</p>
<h2 data-id="heading-2">3 高可用方案对决：自动 vs 手动</h2>
<p>讲到这里，就到了十字路口。Keepalived给我们提供了能力，但怎么用这个能力，是门大学问。下面我给你端上两盘菜，一盘是“入门级自动切换”，另一盘是“生产级手动切换”，咱们把优缺点掰扯清楚了，你再决定在你的环境里用哪一盘。</p>
<h3 data-id="heading-3"><strong>方案一：入门级自动切换 (Keepalived + Notify脚本)</strong></h3>
<p>这个方案追求的是“<a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D269081829%26content_type%3DArticle%26match_order%3D1%26q%3D%25E6%2597%25A0%25E4%25BA%25BA%25E5%2580%25BC%25E5%25AE%2588%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=269081829&amp;content_type=Article&amp;match_order=1&amp;q=%E6%97%A0%E4%BA%BA%E5%80%BC%E5%AE%88&amp;zhida_source=entity" ref="nofollow noopener noreferrer">无人值守</a>”，一旦MySQL出问题，系统自动完成VIP和<a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D269081829%26content_type%3DArticle%26match_order%3D1%26q%3D%25E6%2595%25B0%25E6%258D%25AE%25E5%25BA%2593%25E8%25A7%2592%25E8%2589%25B2%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=269081829&amp;content_type=Article&amp;match_order=1&amp;q=%E6%95%B0%E6%8D%AE%E5%BA%93%E8%A7%92%E8%89%B2&amp;zhida_source=entity" ref="nofollow noopener noreferrer">数据库角色</a>的切换。</p>
<p><strong>A. 核心思路</strong></p>
<p>咱们利用Keepalived的<code>notify_*</code>系列指令。当Keepalived的状态从<code>BACKUP</code>变成<code>MASTER</code>时，就自动触发一个我们写好的<code>mysql_role_switch.sh</code>脚本，让这个脚本去完成数据库的<code>read_only</code>状态切换。</p>
<p><strong>B. <a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D269081829%26content_type%3DArticle%26match_order%3D1%26q%3D%25E9%2585%258D%25E7%25BD%25AE%25E6%2596%2587%25E4%25BB%25B6%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=269081829&amp;content_type=Article&amp;match_order=1&amp;q=%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6&amp;zhida_source=entity" ref="nofollow noopener noreferrer">配置文件</a> (主备有别)</strong></p>
<p><code>vi /etc/keepalived/keepalived.conf</code></p>
<p><strong>主节点 <code>mysql-node1</code> (192.168.31.101):</strong></p>
<pre><code class="hljs language-csharp" lang="csharp">! <span class="hljs-function">Configuration File <span class="hljs-keyword">for</span> <span class="hljs-title">keepalived</span> (<span class="hljs-params">Auto-Switch MASTER</span>)

global_defs</span> {
   <span class="hljs-meta"># 路由ID，在一个局域网内，这个ID必须是唯一的，相当于Keepalived的身份证</span>
   router_id MYSQL_HA_01
}

vrrp_script chk_mysql {
    script <span class="hljs-string">"/etc/keepalived/check_mysql.sh"</span>  <span class="hljs-meta"># 脚本路径</span>
    interval <span class="hljs-number">2</span>                                <span class="hljs-meta"># 每2秒执行一次</span>
    weight <span class="hljs-number">-20</span>                                <span class="hljs-meta"># 如果脚本失败（退出码非0），则当前节点的优先级降低20</span>
    fall <span class="hljs-number">2</span>                                    <span class="hljs-meta"># 连续2次失败，才认为是真的失败</span>
    rise <span class="hljs-number">3</span>                                    <span class="hljs-meta"># 连续3次成功，才认为是真的恢复</span>
}

vrrp_instance VI_MYSQL {
    state MASTER
    <span class="hljs-keyword">interface</span> <span class="hljs-title">ens18</span>
    <span class="hljs-title">virtual_router_id</span> 51
    <span class="hljs-title">priority</span> 101
    <span class="hljs-title">advert_int</span> 1
    <span class="hljs-title">authentication</span> { 
		auth_type PASS
		auth_pass <span class="hljs-number">1111</span> 
	}
    virtual_ipaddress { 
		<span class="hljs-number">192.168</span><span class="hljs-number">.31</span><span class="hljs-number">.100</span>/<span class="hljs-number">24</span> dev ens18 label ens18:vip
	}
    track_script { 
		chk_mysql
	}

    <span class="hljs-meta"># 状态变更时触发总司令脚本</span>
    notify_master <span class="hljs-string">"/etc/keepalived/mysql_role_switch.sh MASTER"</span>
    notify_backup <span class="hljs-string">"/etc/keepalived/mysql_role_switch.sh BACKUP"</span>
    notify_fault <span class="hljs-string">"/etc/keepalived/mysql_role_switch.sh BACKUP"</span>
}
</code></pre>
<p><strong>备节点 <code>mysql-node2</code> (192.168.31.102):</strong></p>
<pre><code class="hljs language-csharp" lang="csharp">! <span class="hljs-function">Configuration File <span class="hljs-keyword">for</span> <span class="hljs-title">keepalived</span> (<span class="hljs-params">Auto-Switch BACKUP</span>)

global_defs</span> {
   router_id MYSQL_HA_02
}

vrrp_script chk_mysql {
    <span class="hljs-meta"># ... 配置与主节点完全一样 ...</span>
}

vrrp_instance VI_MYSQL {
    state BACKUP
    <span class="hljs-keyword">interface</span> <span class="hljs-title">ens18</span>
    <span class="hljs-title">virtual_router_id</span> 51
    <span class="hljs-title">priority</span> 100
    <span class="hljs-title">advert_int</span> 1
    <span class="hljs-title">nopreempt</span>  # 关键！防止主库恢复后<span class="hljs-title">VIP</span>来回抖动
    <span class="hljs-title">authentication</span> { 
		auth_type PASS
		auth_pass <span class="hljs-number">1111</span> 
	}
    virtual_ipaddress { 
		<span class="hljs-number">192.168</span><span class="hljs-number">.31</span><span class="hljs-number">.100</span>/<span class="hljs-number">24</span> dev ens18 label ens18:vip
	}
    track_script { 
		chk_mysql
	}

    <span class="hljs-meta"># 状态变更时触发总司令脚本</span>
    notify_master <span class="hljs-string">"/etc/keepalived/mysql_role_switch.sh MASTER"</span>
    notify_backup <span class="hljs-string">"/etc/keepalived/mysql_role_switch.sh BACKUP"</span>
    notify_fault <span class="hljs-string">"/etc/keepalived/mysql_role_switch.sh BACKUP"</span>
}
</code></pre>
<p><strong>核心参数讲解:</strong></p>
<ul>
<li><code>virtual_router_id</code>: 主备的“接头暗号”，必须一样，不然它俩不在一个频道，各玩各的。</li>
<li><code>priority</code>: 选举的核心，谁的数字大谁就是MASTER。</li>
<li><code>vrrp_script</code> &amp; <code>track_script</code>: 这两个是黄金搭档。前者定义了“怎么检查”，后者负责“把检查结果用起来”。当<code>chk_mysql</code>脚本执行失败，<code>track_script</code>就会让当前节点的<code>priority</code>减去<code>weight</code>定义的值（101 - 20 = 81）。81比备机的100低，于是VIP就漂移了。</li>
<li><code>nopreempt</code>: <strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D269081829%26content_type%3DArticle%26match_order%3D1%26q%3D%25E6%259C%2580%25E4%25BD%25B3%25E5%25AE%259E%25E8%25B7%25B5%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=269081829&amp;content_type=Article&amp;match_order=1&amp;q=%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5&amp;zhida_source=entity" ref="nofollow noopener noreferrer">最佳实践</a>！</strong>  这个参数只在<code>BACKUP</code>节点上配。意思是“不抢占”。假设原来的主库<code>mysql-node1</code>只是网络抖动了一下，导致VIP切到了<code>mysql-node2</code>。几秒后<code>mysql-node1</code>恢复了，如果没有<code>nopreempt</code>，它的优先级（101）还是比<code>mysql-node2</code>（100）高，它会立刻把VIP抢回来。这一来一回的切换，对业务可能是致命的抖动。配置了<code>nopreempt</code>，就意味着只要<code>mysql-node2</code>还活着，即使<code>mysql-node1</code>恢复了，也得“靠边站”，VIP不会切回去。这大大减少了不必要的切换，生产环境更稳定。</li>
</ul>
<p><strong>C. 核心脚本 (侦察兵 + 总司令)</strong></p>
<p><code>check_mysql.sh</code>负责高频侦察，<code>mysql_role_switch.sh</code>负责在收到Keepalived命令后，执行数据库角色切换的重操作。</p>
<p><code>/etc/keepalived/check_mysql.sh</code></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>

<span class="hljs-comment"># 使用mysqladmin工具检查MySQL服务的可用性</span>
mysqladmin ping -u root -p<span class="hljs-string">'YourComplexP@ssw0rd!_2025'</span> &gt; /dev/null 2&gt;&amp;1
<span class="hljs-comment"># 检查上一条命令的退出码</span>
<span class="hljs-keyword">if</span> [ $? -eq 0 ]; <span class="hljs-keyword">then</span>
    <span class="hljs-comment"># 如果ping通，说明MySQL服务正常，脚本以退出码0结束</span>
    <span class="hljs-built_in">exit</span> 0
<span class="hljs-keyword">else</span>
    <span class="hljs-comment"># 如果ping不通，说明MySQL服务异常，脚本以退出码1结束</span>
    <span class="hljs-built_in">exit</span> 1
<span class="hljs-keyword">fi</span>
</code></pre>
<p><code>/etc/keepalived/mysql_role_switch.sh</code></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>

STATE=<span class="hljs-variable">$1</span>
LOG_FILE=<span class="hljs-string">"/var/log/keepalived-mysql-state.log"</span>

<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-subst">$(date)</span>: Script called with state <span class="hljs-variable">$STATE</span>"</span> &gt;&gt; <span class="hljs-variable">$LOG_FILE</span>

<span class="hljs-keyword">case</span> <span class="hljs-variable">$STATE</span> <span class="hljs-keyword">in</span>
    <span class="hljs-string">"MASTER"</span>)
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"Transitioning to MASTER..."</span> &gt;&gt; <span class="hljs-variable">$LOG_FILE</span>
        <span class="hljs-comment"># 1. 停止从属关系</span>
        mysql -u root -p<span class="hljs-string">'YourComplexP@ssw0rd!_2025'</span> -e <span class="hljs-string">"STOP SLAVE;"</span>
        
        <span class="hljs-comment"># 2. 将数据库设置为可写</span>
        mysql -u root -p<span class="hljs-string">'YourComplexP@ssw0rd!_2025'</span> -e <span class="hljs-string">"SET GLOBAL read_only = OFF;"</span>
        
        <span class="hljs-comment"># 3. 如果需要，可以重置主库信息（在某些场景下需要）</span>
        <span class="hljs-comment"># mysql -u root -p'YourComplexP@ssw0rd!_2025' -e "RESET MASTER;"</span>

        <span class="hljs-built_in">echo</span> <span class="hljs-string">"Transition to MASTER finished."</span> &gt;&gt; <span class="hljs-variable">$LOG_FILE</span>
        ;;
    <span class="hljs-string">"BACKUP"</span>)
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"Transitioning to BACKUP..."</span> &gt;&gt; <span class="hljs-variable">$LOG_FILE</span>
        <span class="hljs-comment"># 1. 将数据库设置为只读</span>
        mysql -u root -p<span class="hljs-string">'YourComplexP@ssw0rd!_2025'</span> -e <span class="hljs-string">"SET GLOBAL read_only = ON;"</span>
        
        <span class="hljs-comment"># 2. (可选但推荐) 尝试重新配置并启动与新主库的同步</span>
        <span class="hljs-comment"># 这一步比较复杂，通常需要外部脚本或人工介入来获取新主库的binlog位点</span>
        <span class="hljs-comment"># 在一个简单的自动切换场景中，可以暂时只做降级为只读的操作</span>
        <span class="hljs-comment"># mysql -u root -p'YourComplexP@ssw0rd!_2025' -e "START SLAVE;"</span>

        <span class="hljs-built_in">echo</span> <span class="hljs-string">"Transition to BACKUP finished."</span> &gt;&gt; <span class="hljs-variable">$LOG_FILE</span>
        ;;
    *)
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"Unknown state. No action taken."</span> &gt;&gt; <span class="hljs-variable">$LOG_FILE</span>
        <span class="hljs-built_in">exit</span> 1
        ;;
<span class="hljs-keyword">esac</span>

<span class="hljs-built_in">exit</span> 0
</code></pre>
<blockquote>
<p>注意：这两个脚本的权限和属主是否正确？脚本里的<a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D269081829%26content_type%3DArticle%26match_order%3D1%26q%3D%25E6%2595%25B0%25E6%258D%25AE%25E5%25BA%2593%25E5%25AF%2586%25E7%25A0%2581%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=269081829&amp;content_type=Article&amp;match_order=1&amp;q=%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AF%86%E7%A0%81&amp;zhida_source=entity" ref="nofollow noopener noreferrer">数据库密码</a>是否做了安全处理？</p>
</blockquote>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">chmod</span> +x /etc/keepalived/check_mysql.sh /etc/keepalived/mysql_role_switch.sh
<span class="hljs-built_in">ls</span> -l /etc/keepalived/check_mysql.sh /etc/keepalived/mysql_role_switch.sh

<span class="hljs-comment">## 启动服务</span>
systemctl <span class="hljs-built_in">enable</span> --now keepalived
systemctl start keepalived
systemctl status keepalived


<span class="hljs-comment">## 确认vip地址</span>
ip addr dev ens18

<span class="hljs-comment">## 查看日志</span>
<span class="hljs-built_in">tail</span> -f /var/log/messages | grep Keepalived
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5f04f3ec480e47c8bb8a7f1be5f26c6c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2Yee8lueoi-eIseWlveiAhQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771395031&amp;x-signature=MsQ54tikBWGJ16n0YNo%2Fv7AhtAU%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/126c272b001248e5a106f00c9c4b28a1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2Yee8lueoi-eIseWlveiAhQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771395031&amp;x-signature=ohFv%2FqiCZdhB94bZpR2NR7XFmLU%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8cb4ec7babd14711b9e524379ceba3c8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2Yee8lueoi-eIseWlveiAhQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771395031&amp;x-signature=XNdiPtcimly9WEBumavX0jX7lK4%3D" alt="" loading="lazy"/></p>
<p><strong>D. 切换演练</strong></p>
<p>在主节点<code>mysql-node1</code>上执行<code>systemctl stop mysqld</code>，你会观察到VIP在几秒内自动漂移到<code>mysql-node2</code>，同时<code>mysql-node2</code>的数据库<code>read_only</code>状态自动变为<code>OFF</code>。</p>
<p>运行脚本”<a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D269081829%26content_type%3DArticle%26match_order%3D1%26q%3D%25E6%25A8%25A1%25E6%258B%259F%25E4%25BA%25A4%25E6%2598%2593%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=269081829&amp;content_type=Article&amp;match_order=1&amp;q=%E6%A8%A1%E6%8B%9F%E4%BA%A4%E6%98%93&amp;zhida_source=entity" ref="nofollow noopener noreferrer">模拟交易</a>往数据库中插入数据，并检查vip飘逸情况</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment">## 模拟交易，连接100</span>
<span class="hljs-section">[root@node101 ~]</span><span class="hljs-comment"># ./simulate_trx.sh </span>
开始模拟交易，按 CTRL+C 停止...
插入新交易: <span class="hljs-attr">trx_id</span> = <span class="hljs-number">15048884</span>, cust_id = <span class="hljs-number">674</span>, amt = <span class="hljs-number">232.11</span>,  耗时: .<span class="hljs-number">037132763</span>s
插入新交易: <span class="hljs-attr">trx_id</span> = <span class="hljs-number">15048885</span>, cust_id = <span class="hljs-number">752</span>, amt = <span class="hljs-number">116.62</span>,  耗时: .<span class="hljs-number">035379153</span>s

<span class="hljs-comment">## 停止节点1 mysqld</span>
<span class="hljs-section">[root@node101 ~]</span><span class="hljs-comment"># systemctl stop mysqld</span>


<span class="hljs-comment">## 节点2上监听 VRRP协议的包</span>
<span class="hljs-section">[root@node102 ~]</span><span class="hljs-comment"># tcpdump -i any -n vrrp</span>
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on any, link-type LINUX_SLL (Linux cooked), capture size 262144 bytes
19:05:29.651565 IP 192.168.31.101 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 51, prio 81, authtype simple, intvl 1s, length 20
19:05:30.651689 IP 192.168.31.101 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 51, prio 81, authtype simple, intvl 1s, length 20
19:05:31.651886 IP 192.168.31.101 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 51, prio 81, authtype simple, intvl 1s, length 20

<span class="hljs-comment">## 观察节点1 keepalived日志</span>
Nov 15 19:00:00 node101 Keepalived_vrrp<span class="hljs-section">[48612]</span>: Script `chk_mysql` now returning 1
Nov 15 19:00:02 node101 Keepalived_vrrp<span class="hljs-section">[48612]</span>: VRRP_Script(chk_mysql) failed (exited with status 1)
Nov 15 19:00:02 node101 Keepalived_vrrp<span class="hljs-section">[48612]</span>: (VI_MYSQL) Changing effective priority from 101 to 81

<span class="hljs-comment">## 观察节点2 keepalived日志</span>
Nov 15 19:09:53 node102 Keepalived_vrrp<span class="hljs-section">[13558]</span>: (VI_MYSQL) Backup received priority 0 advertisement
Nov 15 19:09:53 node102 Keepalived_vrrp<span class="hljs-section">[13558]</span>: (VI_MYSQL) Receive advertisement timeout
Nov 15 19:09:53 node102 Keepalived_vrrp<span class="hljs-section">[13558]</span>: (VI_MYSQL) Entering MASTER STATE
Nov 15 19:09:53 node102 Keepalived_vrrp<span class="hljs-section">[13558]</span>: (VI_MYSQL) setting VIPs.
Nov 15 19:09:53 node102 Keepalived_vrrp<span class="hljs-section">[13558]</span>: Sending gratuitous ARP on ens18 for 192.168.31.100
Nov 15 19:09:53 node102 Keepalived_vrrp<span class="hljs-section">[13558]</span>: (VI_MYSQL) Sending/queueing gratuitous ARPs on ens18 for 192.168.31.100
Nov 15 19:09:53 node102 Keepalived_vrrp<span class="hljs-section">[13558]</span>: Sending gratuitous ARP on ens18 for 192.168.31.100
Nov 15 19:09:53 node102 Keepalived_vrrp<span class="hljs-section">[13558]</span>: Sending gratuitous ARP on ens18 for 192.168.31.100
Nov 15 19:09:53 node102 Keepalived_vrrp<span class="hljs-section">[13558]</span>: Sending gratuitous ARP on ens18 for 192.168.31.100
Nov 15 19:09:53 node102 Keepalived_vrrp<span class="hljs-section">[13558]</span>: Sending gratuitous ARP on ens18 for 192.168.31.100
Nov 15 19:09:58 node102 Keepalived_vrrp<span class="hljs-section">[13558]</span>: Sending gratuitous ARP on ens18 for 192.168.31.100
Nov 15 19:09:58 node102 Keepalived_vrrp<span class="hljs-section">[13558]</span>: (VI_MYSQL) Sending/queueing gratuitous ARPs on ens18 for 192.168.31.100
Nov 15 19:09:58 node102 Keepalived_vrrp<span class="hljs-section">[13558]</span>: Sending gratuitous ARP on ens18 for 192.168.31.100
Nov 15 19:09:58 node102 Keepalived_vrrp<span class="hljs-section">[13558]</span>: Sending gratuitous ARP on ens18 for 192.168.31.100
Nov 15 19:09:58 node102 Keepalived_vrrp<span class="hljs-section">[13558]</span>: Sending gratuitous ARP on ens18 for 192.168.31.100
Nov 15 19:09:58 node102 Keepalived_vrrp<span class="hljs-section">[13558]</span>: Sending gratuitous ARP on ens18 for 192.168.31.100

<span class="hljs-comment">## 查看vip情况</span>
<span class="hljs-section">[root@node101 ~]</span><span class="hljs-comment"># ip addr show dev ens18</span>
2: ens18: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000
    link/ether bc:24:11:33:db:80 brd ff:ff:ff:ff:ff:ff
    inet 192.168.31.101/24 brd 192.168.31.255 scope global noprefixroute ens18
       valid_lft forever preferred_lft forever
    inet6 240e:3a1:4a76:d360:9017:c87b:599f:5/128 scope global dynamic noprefixroute 
       valid_lft 6744sec preferred_lft 3144sec
    inet6 240e:3a1:4a76:d360:4360:afd0:895b:8930/64 scope global dynamic noprefixroute 
       valid_lft 7006sec preferred_lft 3406sec
    inet6 fe80::6bfb:14c8:d785:33ba/64 scope link noprefixroute 
       valid_lft forever preferred_lft forever

<span class="hljs-section">[root@node102 ~]</span><span class="hljs-comment"># ip addr show dev ens18</span>
2: ens18: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000
    link/ether bc:24:11:70:62:0d brd ff:ff:ff:ff:ff:ff
    inet 192.168.31.102/24 brd 192.168.31.255 scope global noprefixroute ens18
       valid_lft forever preferred_lft forever
    inet 192.168.31.100/24 scope global secondary ens18:vip
       valid_lft forever preferred_lft forever
    inet6 240e:3a1:4a76:d360:766b:5fde:6699:9c81/64 scope global dynamic noprefixroute 
       valid_lft 7021sec preferred_lft 3421sec
    inet6 fe80::6bfb:14c8:d785:33ba/64 scope link dadfailed tentative noprefixroute 
       valid_lft forever preferred_lft forever
    inet6 fe80::dd3d:a0e0:db46:cca0/64 scope link noprefixroute 
       valid_lft forever preferred_lft forever

<span class="hljs-comment">## 查看节点2的状态</span>
mysql&gt; show variables like 'read_only'<span class="hljs-comment">;</span>
+---------------+-------+
| Variable_name | Value |
+---------------+-------+
| read_only     | OFF   |
+---------------+-------+
1 row in set (0.00 sec)
</code></pre>
<p><strong>E. 方案弱点 (一针见血)</strong></p>
<blockquote>
<p>⚠️ <strong>老兵提醒:</strong>  这个方案看起来很美，但在复杂的生产环境，它的“自动”可能会变成“自动惹祸”：</p>
</blockquote>
<ol>
<li>
<p><strong>没有“仲裁”机制：</strong>  如果主备之间的心跳网络断了（比如交换机故障），但两台服务器都活着，就会导致“脑裂”。双方都认为对方挂了，都抢着当<code>MASTER</code>，都会把自己变成可写，<strong>数据会彻底写乱</strong>！</p>
</li>
<li>
<p><strong>数据一致性隐患：</strong>  切换只依赖于简单的健康检查，没有MHA那种“捞数据”的过程。如果主库宕机前有一笔事务的binlog没来得及传到备库，这笔数据就<strong>永久丢失</strong>了。</p>
</li>
<li>
<p><strong>恢复流程复杂：</strong>  老的主库修好后，怎么让它重新以<code>SLAVE</code>的身份加入集群？这个过程自动化脚本很难做得完美，大概率需要DBA手动介入，反而增加了操作风险。</p>
</li>
</ol>
<p>正是因为有这些“坑”，所以很多严谨的团队，特别是金融行业，会选择下面这种看起来“笨”，但实际上更稳妥的方案。</p>
<h3 data-id="heading-4"><strong>方案二：生产级手动切换 (SOP保障)</strong></h3>
<p>这个方案的哲学是：<strong>机器负责监控和漂移VIP，但切换决策由人来做。</strong>  我们把Keepalived当成一个手动的、高效率的VIP切换工具，而不是一个自动决策系统。</p>
<p><strong>A. 核心思路</strong></p>
<p>两台服务器上的Keepalived配置文件<strong>完全一样</strong>！并且，<strong>在任何时候，只允许一台服务器上的Keepalived服务是运行状态</strong>。切换时，我们严格按照标准操作流程（SOP），先手动完成数据库角色的确认和变更，然后再“一停一启”Keepalived服务，完成VIP的切换。</p>
<p><strong>B. 统一配置文件 (两边完全一样)</strong></p>
<p>把下面这份配置原封不动地放到<code>mysql-node1</code>和<code>mysql-node2</code>的<code>/etc/keepalived/keepalived.conf</code>。</p>
<pre><code class="hljs language-perl" lang="perl">! Configuration File <span class="hljs-keyword">for</span> keepalived (Manual-Switch)

global_defs {
   <span class="hljs-comment"># 名字可以根据你的业务来，但两边要一样</span>
   router_id MYSQL_HA_CLUSTER
}

vrrp_instance VI_MYSQL {
    <span class="hljs-comment"># 默认都写MASTER，谁先启动谁就是MASTER</span>
    <span class="hljs-keyword">state</span> MASTER
    interface ens192             <span class="hljs-comment"># 根据你的实际网卡修改</span>
    virtual_router_id <span class="hljs-number">51</span>         <span class="hljs-comment"># 必须一样</span>
    priority <span class="hljs-number">100</span>                 <span class="hljs-comment"># 优先级一样，谁先启动谁优先</span>
    advert_int <span class="hljs-number">1</span>
    authentication {
        auth_type PASS
        auth_pass <span class="hljs-number">1111</span>
    }
    virtual_ipaddress {
        <span class="hljs-number">192.168</span>.<span class="hljs-number">31.100</span>       <span class="hljs-comment"># 根据你的VIP修改</span>
    }
    <span class="hljs-comment"># 注意！这个方案里，我们不使用任何的track_script或notify脚本！</span>
}
</code></pre>
<blockquote>
<p>⚠️ <strong>关键点:</strong>  这个配置里没有<code>track_script</code>！Keepalived不再关心MySQL的死活，它只做一个纯粹的VIP管理工具。它的启停，完全由DBA掌控。</p>
</blockquote>
<p><strong>C. 标准切换流程</strong></p>
<p>假设当前主库是<code>mysql-node1</code>，我们要切换到<code>mysql-node2</code>。</p>
<p><strong>第1步：在旧主库 <code>mysql-node1</code> 上操作</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 停止Keepalived服务，释放VIP</span>
systemctl stop keepalived
<span class="hljs-built_in">echo</span> <span class="hljs-string">"Keepalived on old master stopped."</span>

<span class="hljs-comment"># 2. 确认VIP已释放</span>
ip a | grep <span class="hljs-string">"192.168.31.100"</span>  <span class="hljs-comment"># 确保这条命令没有任何输出</span>

<span class="hljs-comment"># 3. 将旧主库设置为只读，防止新数据写入</span>
mysql -e <span class="hljs-string">"SET GLOBAL read_only = ON;"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"Old master is now read-only."</span>
</code></pre>
<p><strong>第2步：在新主库 <code>mysql-node2</code> 上操作</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 确认与旧主库的数据同步已完成 (非常重要！)</span>
<span class="hljs-comment"># 登录MySQL，执行 SHOW SLAVE STATUS\G，查看 Seconds_Behind_Master 是否为 0</span>
<span class="hljs-comment"># 在确认同步无延迟后，再进行下一步</span>

<span class="hljs-comment"># 2. 停止同步并提升为新主</span>
mysql -e <span class="hljs-string">"STOP SLAVE; SET GLOBAL read_only = OFF;"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"New master promoted."</span>

<span class="hljs-comment"># 3. 启动Keepalived服务，接管VIP</span>
systemctl start keepalived
<span class="hljs-built_in">echo</span> <span class="hljs-string">"Keepalived on new master started."</span>
</code></pre>
<p><strong>第3步：验证</strong></p>
<pre><code class="hljs language-perl" lang="perl"><span class="hljs-comment"># 1. 在新主库 `mysql-node2` 上确认VIP已绑定</span>
ip a | <span class="hljs-keyword">grep</span> <span class="hljs-string">"192.168.31.100"</span>  <span class="hljs-comment"># 应该能看到VIP</span>

<span class="hljs-comment"># 2. 尝试用VIP连接数据库，并执行写操作，确认服务正常</span>
<span class="hljs-comment"># mysql -h 192.168.31.100 -u ... -p... -e "CREATE TABLE test_switch (id int); INSERT INTO test_switch VALUES (1);"</span>
</code></pre>
<p>这个流程清晰、可控，每一步都有明确的检查点，最大限度地避免了自动切换带来的不确定性。</p>
<h2 data-id="heading-5">4 运维最佳实践</h2>
<p>针对上面两种方案，我们的运维监控重点也不同。</p>
<p><strong>监控:</strong></p>
<ul>
<li><strong>对于方案一 (自动):</strong>  必须重点监控<code>/var/log/keepalived-mysql-state.log</code>这个自定义<a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D269081829%26content_type%3DArticle%26match_order%3D1%26q%3D%25E6%2597%25A5%25E5%25BF%2597%25E6%2596%2587%25E4%25BB%25B6%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=269081829&amp;content_type=Article&amp;match_order=1&amp;q=%E6%97%A5%E5%BF%97%E6%96%87%E4%BB%B6&amp;zhida_source=entity" ref="nofollow noopener noreferrer">日志文件</a>。任何状态切换都应该触发最高级别的告警，通知DBA立即介入检查。同时，要监控主备两边<code>read_only</code>的状态是否符合预期。</li>
<li><strong>对于方案二 (手动):</strong>  监控的重点是  <strong>“Keepalived进程的唯一性”</strong> 。必须有一个监控项，确保集群中永远只有一个<code>keepalived</code>进程在运行。一旦发现两个都在运行，必须立即告警，这是脑裂的前兆！</li>
<li><strong>通用监控:</strong>  VIP的归属、MySQL主从复制延迟（<code>Seconds_Behind_Master</code>）是两种方案都必须死盯的指标。</li>
</ul>
<p><strong>日志分析:</strong></p>
<ul>
<li><code>tail -f /var/log/messages | grep Keepalived</code> 依然是排错第一神器。要学会看懂<code>Entering MASTER state</code>、<code>Entering BACKUP state</code>等关键日志。</li>
<li>在方案一中，<code>mysql_role_switch.sh</code>脚本的输出日志是判断切换是否成功、哪里卡住的关键依据。</li>
</ul>
<p><strong>“脑裂” (Split-Brain) 防治:</strong></p>
<ul>
<li><strong>方案一 (自动):</strong>  脑裂风险较高，唯一的物理缓解措施就是<strong>使用独立、可靠的心跳网络</strong>，比如两台服务器用一根网线直连，专门跑VRRP协议。</li>
<li><strong>方案二 (手动):</strong> <strong>从机制上杜绝了脑裂的发生</strong>。因为我们严格遵守“只启一个”的原则，只要SOP被严格执行，就不会出现两个节点都认为自己是主的混乱局面。这就是它“笨”却“稳”的核心优势。</li>
</ul>
<h2 data-id="heading-6">5 总结</h2>
<p>好了，兄弟们，今天我们把Keepalived配合MySQL的两种玩法都掰扯清楚了。</p>
<ul>
<li><strong>方案一 (自动切换):</strong>  像一辆“<a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D269081829%26content_type%3DArticle%26match_order%3D1%26q%3D%25E8%2587%25AA%25E5%258A%25A8%25E9%25A9%25BE%25E9%25A9%25B6%25E6%25B1%25BD%25E8%25BD%25A6%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=269081829&amp;content_type=Article&amp;match_order=1&amp;q=%E8%87%AA%E5%8A%A8%E9%A9%BE%E9%A9%B6%E6%B1%BD%E8%BD%A6&amp;zhida_source=entity" ref="nofollow noopener noreferrer">自动驾驶汽车</a>”。适合那些对RTO（恢复时间目标）要求极高，但对数据一致性容忍度稍高（比如允许丢失几秒数据）的非核心业务。优点是快，缺点是“方向盘”不在你手里，极端情况下可能失控。</li>
<li><strong>方案二 (手动切换):</strong>  像一辆“手动挡的越野车”。它把切换的最终决定权牢牢地交还给了DBA。每一步操作都在你的掌控之中。它牺牲了一点点切换速度，但换来的是<strong>极高的可靠性和数据安全性</strong>。这在金融、核心交易等场景，是毋庸置疑的选择。</li>
</ul>
<p>技术方案没有绝对的“最好”，只有“最合适”。你问我推荐哪个？<strong>在你不完全确定你的业务能承受自动切换带来的风险之前，我强烈建议你从方案二开始。</strong>  先用最稳的方法把高可用搭起来，把SOP流程跑到滚瓜烂熟。等你对整个系统的脾气都摸透了，再考虑是否需要向自动化演进。</p>
<p>记住，作为一个生产环境的DBA，“稳”字永远是第一位的。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Maven 4 官宣：历时15年，Java构建工具迎来彻底重构]]></title>    <link>https://juejin.cn/post/7605164560711286810</link>    <guid>https://juejin.cn/post/7605164560711286810</guid>    <pubDate>2026-02-11T06:12:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605164560711286810" data-draft-id="7605173538417082378" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Maven 4 官宣：历时15年，Java构建工具迎来彻底重构"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-02-11T06:12:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="神奇小汤圆"/> <meta itemprop="url" content="https://juejin.cn/user/1151943919285431"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Maven 4 官宣：历时15年，Java构建工具迎来彻底重构
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1151943919285431/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    神奇小汤圆
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-11T06:12:58.000Z" title="Wed Feb 11 2026 06:12:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>自 <strong>2010 年 Maven 3 发布</strong> 以来，Maven 对 Java 构建生态的整体支持方式，几乎没有发生过颠覆性的变化。</p>
<p>然而在这 15 年里，Java 世界早已天翻地覆：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D269646962%26content_type%3DArticle%26match_order%3D1%26q%3D%25E6%25A8%25A1%25E5%259D%2597%25E5%258C%2596%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=269646962&amp;content_type=Article&amp;match_order=1&amp;q=%E6%A8%A1%E5%9D%97%E5%8C%96&amp;zhida_source=entity" ref="nofollow noopener noreferrer">模块化</a>成为标配</li>
<li>并行构建成为刚需</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D269646962%26content_type%3DArticle%26match_order%3D1%26q%3D%25E4%25BA%2591%25E5%258E%259F%25E7%2594%259F%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=269646962&amp;content_type=Article&amp;match_order=1&amp;q=%E4%BA%91%E5%8E%9F%E7%94%9F&amp;zhida_source=entity" ref="nofollow noopener noreferrer">云原生</a>与<a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D269646962%26content_type%3DArticle%26match_order%3D1%26q%3D%25E5%25AE%25B9%25E5%2599%25A8%25E5%258C%2596%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=269646962&amp;content_type=Article&amp;match_order=1&amp;q=%E5%AE%B9%E5%99%A8%E5%8C%96&amp;zhida_source=entity" ref="nofollow noopener noreferrer">容器化</a>成为主流</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D269646962%26content_type%3DArticle%26match_order%3D1%26q%3DJDK%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=269646962&amp;content_type=Article&amp;match_order=1&amp;q=JDK&amp;zhida_source=entity" ref="nofollow noopener noreferrer">JDK</a> 以一年两个大版本的节奏持续快速演进</li>
</ul>
<p>相比之下，Maven 本身却显得有些“老态”。</p>
<p>Maven 4 的出现，正是为了解决这些长期积累的历史包袱。</p>
<p>虽然 Maven 4 仍未公布正式 GA 发布日期，但目前已经迭代到 <strong>第五个发布候选版本</strong>（RC5），从项目成熟度和变更稳定性来看，距离正式发布已相当接近。</p>
<blockquote>
<p><strong>“</strong> 现在正是提前了解、评估和准备升级的合适时机。</p>
</blockquote>
<h3 data-id="heading-0"><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D269646962%26content_type%3DArticle%26match_order%3D1%26q%3DPOM%2B%25E6%25A8%25A1%25E5%259E%258B%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=269646962&amp;content_type=Article&amp;match_order=1&amp;q=POM+%E6%A8%A1%E5%9E%8B&amp;zhida_source=entity" ref="nofollow noopener noreferrer">POM 模型</a>升级：从 4.0.0 到 4.1.0</strong></h3>
<p>Maven 4 将 POM 的模型版本升级为 4.1.0：</p>
<pre><code class="hljs language-ini" lang="ini">&lt;project
    <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://maven.apache.org/POM/4.1.0"</span>
    xmlns:<span class="hljs-attr">xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span>
    xsi:<span class="hljs-attr">schemaLocation</span>=<span class="hljs-string">"http://maven.apache.org/POM/4.1.0
                        http://maven.apache.org/xsd/maven-4.1.0.xsd"</span>&gt;
  &lt;modelVersion&gt;4.1.0&lt;/modelVersion&gt;
&lt;/project&gt;
</code></pre>
<ul>
<li>向后兼容：Maven 4 仍然可以构建 4.0.0 的 POM</li>
<li>新能力只对 4.1.0 生效</li>
<li>modelVersion 理论上可以省略，Maven 会从 schema 推导</li>
</ul>
<p>也就是说：</p>
<blockquote>
<p><strong>“</strong> 不升级 POM 也能用 Maven 4，但升级后才能真正“吃到红利”。</p>
</blockquote>
<h3 data-id="heading-1"><strong>Build POM / Consumer POM 分离：终于解决“POM 污染”</strong></h3>
<p>这是 Maven 4 最重要、也是最颠覆性 的变化之一。</p>
<p>在 Maven 3 中，发布到仓库的 POM 同时包含：</p>
<ul>
<li>插件配置</li>
<li>构建细节</li>
<li>父 POM 引用</li>
<li>各种属性</li>
</ul>
<p>依赖使用者会被迫解析大量 “与我无关” 的信息。</p>
<p>Maven 4 的解决方法是 POM 扁平化（<a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D269646962%26content_type%3DArticle%26match_order%3D1%26q%3DFlattening%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=269646962&amp;content_type=Article&amp;match_order=1&amp;q=Flattening&amp;zhida_source=entity" ref="nofollow noopener noreferrer">Flattening</a>）。</p>
<p>Maven 4 正式区分：</p>

















<table><thead><tr><th>类型</th><th>用途</th></tr></thead><tbody><tr><td>Build POM</td><td>项目自身构建</td></tr><tr><td>Consumer POM</td><td>提供给<a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D269646962%26content_type%3DArticle%26match_order%3D1%26q%3D%25E4%25BE%259D%25E8%25B5%2596%25E6%2596%25B9%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=269646962&amp;content_type=Article&amp;match_order=1&amp;q=%E4%BE%9D%E8%B5%96%E6%96%B9&amp;zhida_source=entity" ref="nofollow noopener noreferrer">依赖方</a></td></tr></tbody></table>
<p>Consumer POM 具备以下特征：</p>
<ul>
<li>不包含插件配置</li>
<li>不包含父 POM</li>
<li>不包含未使用依赖</li>
<li>只保留真实传递依赖</li>
<li>属性已被解析为具体值</li>
</ul>
<p>开启方式：</p>
<pre><code class="hljs language-ini" lang="ini">mvn clean install <span class="hljs-attr">-Dmaven.consumer.pom.flatten</span>=<span class="hljs-literal">true</span>
</code></pre>
<blockquote>
<p><strong>“</strong> Maven 3 时代需要额外的 <code>Flatten Maven Plugin</code>，Maven 4 中已成为 原生能力。</p>
</blockquote>
<p>这一步，直接让依赖解析更快、更干净、更可预测。</p>
<h3 data-id="heading-2"><strong>新 <a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D269646962%26content_type%3DArticle%26match_order%3D1%26q%3DArtifact%2BType%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=269646962&amp;content_type=Article&amp;match_order=1&amp;q=Artifact+Type&amp;zhida_source=entity" ref="nofollow noopener noreferrer">Artifact Type</a>：显式控制 classpath / module path</strong></h3>
<p>在 Maven 3 中：</p>
<ul>
<li>普通 JAR → classpath</li>
<li>含 <code>module-info.class</code> → <code>module path</code>（自动推断）</li>
</ul>
<p>这种“隐式规则”在 Java 模块化时代并不够清晰。</p>
<p>Maven 4 新增类型：</p>
<pre><code class="hljs language-lua" lang="lua">&lt;<span class="hljs-built_in">type</span>&gt;classpath-jar&lt;/<span class="hljs-built_in">type</span>&gt;
&lt;<span class="hljs-built_in">type</span>&gt;<span class="hljs-built_in">module</span>-jar&lt;/<span class="hljs-built_in">type</span>&gt;
</code></pre>
<p>开发者终于可以 <strong>显式声明依赖放在哪里。</strong></p>
<p>Maven 4 还新增了专门的注解处理器类型：</p>
<ul>
<li><code>processor</code></li>
<li><code>classpath-processor</code></li>
<li><code>modular-processor</code></li>
</ul>
<p>以 Lombok 为例：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>${lombok.version}<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">type</span>&gt;</span>classpath-processor<span class="hljs-tag">&lt;/<span class="hljs-name">type</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>${lombok.version}<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>provided<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
</code></pre>
<p>Maven 4 <strong>明确区分了 API classpath 与 processor classpath</strong>，构建语义更清晰，也更利于<a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D269646962%26content_type%3DArticle%26match_order%3D1%26q%3D%25E5%25B7%25A5%25E5%2585%25B7%25E9%2593%25BE%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=269646962&amp;content_type=Article&amp;match_order=1&amp;q=%E5%B7%A5%E5%85%B7%E9%93%BE&amp;zhida_source=entity" ref="nofollow noopener noreferrer">工具链</a>优化。</p>
<h3 data-id="heading-3"><strong>Modules 改名为 Subprojects：为 Java 9 “让路”</strong></h3>
<p>Java 9 引入模块系统后：</p>
<ul>
<li>Maven Modules</li>
<li>Java Modules</li>
</ul>
<p>长期让新手和工具“集体懵逼”。</p>
<p>Maven 4 的选择是：</p>
<ul>
<li>modules → subprojects</li>
<li>modules 标记为 deprecated</li>
</ul>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">subprojects</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">subproject</span>&gt;</span>project-a<span class="hljs-tag">&lt;/<span class="hljs-name">subproject</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">subproject</span>&gt;</span>project-b<span class="hljs-tag">&lt;/<span class="hljs-name">subproject</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">subprojects</span>&gt;</span>
</code></pre>
<p>同时还支持：</p>
<ul>
<li><strong>Parent 推断：</strong>  空 <code>&lt;parent /&gt;</code> 自动识别</li>
<li><strong>子项目自动发现：</strong>  无需显式声明</li>
<li><strong>统一构建<a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D269646962%26content_type%3DArticle%26match_order%3D1%26q%3D%25E6%2597%25B6%25E9%2597%25B4%25E6%2588%25B3%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=269646962&amp;content_type=Article&amp;match_order=1&amp;q=%E6%97%B6%E9%97%B4%E6%88%B3&amp;zhida_source=entity" ref="nofollow noopener noreferrer">时间戳</a></strong></li>
<li><strong>安全发布：</strong>  子项目失败 → 全部不发布</li>
</ul>
<p>这是一次 <strong>语义层面 + 工程实践层面</strong> 的双重升级。</p>
<h3 data-id="heading-4"><strong>树形生命周期：并行构建终于“名正言顺”</strong></h3>
<p>Maven 3 的生命周期是 线性的，即使多模块，也很难高效并行。</p>
<p>Maven 4 引入 <code>Tree-based Lifecycle</code>：</p>
<ul>
<li>每个子项目独立推进生命周期</li>
<li>依赖就绪即可启动</li>
<li>大型多模块构建速度显著提升</li>
</ul>
<p>开启方式：</p>
<pre><code class="hljs language-css" lang="css">mvn -<span class="hljs-selector-tag">b</span> concurrent verify
</code></pre>
<h3 data-id="heading-5"><strong>配置能力显著增强的“小变化”</strong></h3>
<h3 data-id="heading-6"><strong>1. <a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D269646962%26content_type%3DArticle%26match_order%3D1%26q%3D%25E6%259D%25A1%25E4%25BB%25B6%25E8%25A1%25A8%25E8%25BE%25BE%25E5%25BC%258F%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=269646962&amp;content_type=Article&amp;match_order=1&amp;q=%E6%9D%A1%E4%BB%B6%E8%A1%A8%E8%BE%BE%E5%BC%8F&amp;zhida_source=entity" ref="nofollow noopener noreferrer">条件表达式</a> Profile</strong></h3>
<pre><code class="hljs language-scss" lang="scss">&lt;condition&gt;
  <span class="hljs-built_in">exists</span>('${project.basedir}/src/**/*.xsd')
  &amp;&amp; <span class="hljs-built_in">length</span>(${user.name}) &gt; <span class="hljs-number">5</span>
&lt;/condition&gt;   
</code></pre>
<p>不再只是 <code>os.name</code>、<a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D269646962%26content_type%3DArticle%26match_order%3D1%26q%3Djdk%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=269646962&amp;content_type=Article&amp;match_order=1&amp;q=jdk&amp;zhida_source=entity" ref="nofollow noopener noreferrer">jdk</a> 这种基础判断，而是 真正的表达式系统。</p>
<h3 data-id="heading-7"><strong>2. 统一的 Sources 模型</strong></h3>
<p>Maven 3：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">sourceDirectory</span>&gt;</span>...<span class="hljs-tag">&lt;/<span class="hljs-name">sourceDirectory</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">testSourceDirectory</span>&gt;</span>...<span class="hljs-tag">&lt;/<span class="hljs-name">testSourceDirectory</span>&gt;</span>
</code></pre>
<p>Maven 4：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">sources</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">source</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>main<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">directory</span>&gt;</span>my-custom-dir/foo<span class="hljs-tag">&lt;/<span class="hljs-name">directory</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">source</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">source</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">directory</span>&gt;</span>my-custom-dir/bar<span class="hljs-tag">&lt;/<span class="hljs-name">directory</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">source</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">sources</span>&gt;</span>
</code></pre>
<p>更适合：</p>
<ul>
<li>多目录</li>
<li>多版本</li>
<li>模块化项目</li>
<li>无插件配置场景</li>
</ul>
<p>Maven 4 还提供了官方升级工具：</p>
<pre><code class="hljs language-bash" lang="bash">mvnup check   <span class="hljs-comment"># 只生成报告</span>
mvnup apply   <span class="hljs-comment"># 自动修改</span>
</code></pre>
<p>它会分析：</p>
<ul>
<li>POM</li>
<li>插件</li>
<li>项目结构</li>
</ul>
<p>并给出 可执行的升级建议。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Wujie 微前端架构下的跨应用状态管理实践：Props + Bus 双通道方案]]></title>    <link>https://juejin.cn/post/7605157203590905883</link>    <guid>https://juejin.cn/post/7605157203590905883</guid>    <pubDate>2026-02-11T05:38:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605157203590905883" data-draft-id="7605107459066724398" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Wujie 微前端架构下的跨应用状态管理实践：Props + Bus 双通道方案"/> <meta itemprop="keywords" content="前端,架构"/> <meta itemprop="datePublished" content="2026-02-11T05:38:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="大象的鼻子那么长"/> <meta itemprop="url" content="https://juejin.cn/user/2277843821926871"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Wujie 微前端架构下的跨应用状态管理实践：Props + Bus 双通道方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2277843821926871/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    大象的鼻子那么长
  </span> <!----> <!----> <div class="vip-level" data-v-cd7d0a50="" data-v-292f6e48=""><span class="tooltip" data-v-cd7d0a50=""><div class="byte-tooltip byte-tooltip--dark" style="display:none;">
        VIP.4 融会贯通
      </div><span class="byte-tooltip__wrapper"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8AQMAAAAAMksxAAAAA1BMVEUAAACnej3aAAAAAXRSTlMAQObYZgAAAA5JREFUKM9jGAWjAAcAAAIcAAE27nY6AAAAAElFTkSuQmCC" alt="VIP.4 融会贯通" title="VIP.4 融会贯通" class="lazy" style="aspect-ratio:NaN;" data-v-5244ef91="" data-v-cd7d0a50=""/></span></span></div> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-11T05:38:30.000Z" title="Wed Feb 11 2026 05:38:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    18
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>在基于 Wujie 的微前端架构中，主应用与子应用之间的状态同步是一个绑不开的难题。本文分享我们在生产项目中的实践：如何用最简洁的方式，实现系统级数据的单一可信源和实时同步，同时避免过度设计的陷阱。</p>
</blockquote>
<h2 data-id="heading-0">背景</h2>
<p>我们的项目是一个典型的企业级 B 端系统，采用 <strong>Vue 3 + Pinia + Wujie</strong> 的微前端架构：</p>
<ul>
<li><strong>1 个主应用</strong>：负责登录、菜单、布局、系统级数据管理</li>
<li><strong>6+ 个子应用</strong>：各自独立开发部署，通过 Wujie 嵌入主应用运行</li>
</ul>
<p>技术栈：Vue 3.5 / Pinia 3 / Vite 7 / TypeScript 5 / Wujie 1.0</p>
<h2 data-id="heading-1">问题：6 个子应用，6 份重复数据</h2>
<p>随着子应用数量增长，我们遇到了一系列状态管理问题：</p>
<p><strong>1. 字典数据 N+1 次请求</strong></p>
<p>主应用启动时请求一次全量字典，但每个子应用启动后又各自请求一次。6 个子应用 = 7 次相同的接口调用。</p>
<p><strong>2. 语言切换不同步</strong></p>
<p>用户在主应用切换语言后，已加载的子应用仍然显示旧语言，必须刷新页面才能生效。</p>
<p><strong>3. Token 刷新断裂</strong></p>
<p>主应用静默刷新 Token 后，子应用持有的旧 Token 继续发请求，触发 401 错误。</p>
<p><strong>4. 用户信息传递不完整</strong></p>
<p>主应用通过 Wujie props 只传了 <code>token</code> 和 <code>userInfo</code>，但子应用还需要 <code>permissions</code>（权限列表）和 <code>roles</code>（角色树），只能自己再请求一次。</p>
<p><strong>5. 数据源不唯一</strong></p>
<p>同一份用户数据，在主应用的 Pinia Store 里有一份，在每个子应用的 Pinia Store 里又各有一份。数据不一致的风险始终存在。</p>
<p>归结为一句话：<strong>缺少一个统一的跨应用状态分发机制</strong>。</p>
<h2 data-id="heading-2">方案选型：我们踩过的坑</h2>
<h3 data-id="heading-3">尝试一：封装 npm 包（过度设计）</h3>
<p>最初我们的方案是创建一个 <code>@cmclink/shared-stores</code> 基础包：</p>
<pre><code class="hljs language-scss" lang="scss">packages/shared-stores/
├── <span class="hljs-attribute">src</span>/
│   ├── auth<span class="hljs-selector-class">.ts</span>        # <span class="hljs-built_in">useSharedAuth</span>() composable
│   ├── dict<span class="hljs-selector-class">.ts</span>        # <span class="hljs-built_in">useSharedDict</span>() composable
│   ├── locale<span class="hljs-selector-class">.ts</span>      # <span class="hljs-built_in">useSharedLocale</span>() composable
│   ├── provider<span class="hljs-selector-class">.ts</span>    # <span class="hljs-built_in">createSharedStoreProvider</span>()
│   ├── utils<span class="hljs-selector-class">.ts</span>       # <span class="hljs-built_in">isInWujie</span>() / <span class="hljs-built_in">getWujieBus</span>()
│   ├── types<span class="hljs-selector-class">.ts</span>       # <span class="hljs-number">12</span> 个类型定义
│   └── constants<span class="hljs-selector-class">.ts</span>   # 事件常量
</code></pre>
<p>看起来很"工程化"，但实际落地后发现几个问题：</p>
<ol>
<li><strong>增加了复杂度却没带来多少收益</strong>。系统级数据本就由主应用维护，子应用只需要只读消费，多一个包多一层抽象，反而增加了理解成本和维护负担。</li>
<li><strong>Provider 的 watch 机制失效</strong>。我们设计了 <code>createSharedStoreProvider(bus, source)</code> 来监听 Store 变化，但 <code>source.auth()</code> 每次返回新的普通对象，Vue 的 <code>watch</code> 根本追踪不到响应式变化——整个广播机制是失效的。</li>
<li><strong>子应用被迫依赖这个包</strong>。本来子应用只需要读 props 和监听 bus，现在还要安装一个额外的 npm 包。</li>
</ol>
<h3 data-id="heading-4">最终方案：回归简洁</h3>
<p>反思后我们确立了核心原则：</p>
<blockquote>
<p><strong>系统级数据由主应用独占维护，通过 Wujie 原生机制（props + bus）只读分发给子应用。不引入额外的包，不搞抽象层。</strong></p>
</blockquote>
<h2 data-id="heading-5">架构设计</h2>
<h3 data-id="heading-6">Store 三层分类</h3>
<pre><code class="hljs">┌─────────────────────────────────────────────────┐
│  Layer 0 — 系统级（主应用独占维护，子应用只读）     │
│  userStore / dictStore / localeStore             │
├─────────────────────────────────────────────────┤
│  Layer 1 — 应用级（主应用独有）                    │
│  tabsStore / messageStore / historyStore         │
├─────────────────────────────────────────────────┤
│  Layer 2 — 业务级（各子应用独有）                   │
│  orderStore / routeStore / blStore ...           │
└─────────────────────────────────────────────────┘
</code></pre>
<p>关键区分：<strong>Layer 0 的数据需要跨应用共享，Layer 1 和 Layer 2 不需要</strong>。只对 Layer 0 做状态分发，保持最小化。</p>
<h3 data-id="heading-7">双通道通信协议</h3>
<p>利用 Wujie 自带的两个通信机制：</p>























<table><thead><tr><th>通道</th><th>机制</th><th>用途</th><th>特点</th></tr></thead><tbody><tr><td><strong>Channel 1</strong></td><td>wujie props</td><td>冷启动初始快照</td><td>同步、可靠、子应用启动即可用</td></tr><tr><td><strong>Channel 2</strong></td><td>wujie bus</td><td>运行时增量同步</td><td>异步、实时、事件驱动</td></tr></tbody></table>
<p><strong>props 结构：</strong></p>
<pre><code class="hljs language-typescript" lang="typescript">{
  <span class="hljs-attr">$shared</span>: {
    <span class="hljs-attr">auth</span>: { token, refreshToken, userId, permissions, roles, userInfo },
    <span class="hljs-attr">dict</span>: { dictMap },
    <span class="hljs-attr">locale</span>: { lang }
  },
  <span class="hljs-comment">// 向后兼容旧字段</span>
  <span class="hljs-attr">token</span>: <span class="hljs-string">'...'</span>,
  <span class="hljs-attr">userInfo</span>: { ... }
}
</code></pre>
<p><strong>bus 事件：</strong></p>



































<table><thead><tr><th>事件</th><th>载荷</th><th>触发时机</th></tr></thead><tbody><tr><td><code>SHARED:AUTH_UPDATED</code></td><td><code>{ token, permissions, roles, userInfo }</code></td><td>权限/角色/用户信息变更</td></tr><tr><td><code>SHARED:TOKEN_REFRESHED</code></td><td><code>{ token, refreshToken }</code></td><td>Token 静默刷新后</td></tr><tr><td><code>SHARED:DICT_UPDATED</code></td><td><code>{ dictMap, version }</code></td><td>字典数据加载完成</td></tr><tr><td><code>SHARED:LOCALE_CHANGED</code></td><td><code>{ lang }</code></td><td>语言切换</td></tr><tr><td><code>SHARED:LOGOUT</code></td><td><code>void</code></td><td>用户登出</td></tr></tbody></table>
<p>两者互补：<strong>props 解决冷启动，bus 解决热更新</strong>。</p>
<h2 data-id="heading-8">核心实现</h2>
<p>整个方案的核心就一个文件：主应用的 <code>shared-provider.ts</code>。</p>
<h3 data-id="heading-9">主应用侧：Provider</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// apps/main/src/stores/shared-provider.ts</span>
<span class="hljs-keyword">import</span> { watch } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> { bus } <span class="hljs-keyword">from</span> <span class="hljs-string">'wujie'</span>

<span class="hljs-comment">// 事件常量就地定义，不引入额外包</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">SHARED_EVENTS</span> = {
  <span class="hljs-attr">AUTH_UPDATED</span>: <span class="hljs-string">'SHARED:AUTH_UPDATED'</span>,
  <span class="hljs-attr">TOKEN_REFRESHED</span>: <span class="hljs-string">'SHARED:TOKEN_REFRESHED'</span>,
  <span class="hljs-attr">DICT_UPDATED</span>: <span class="hljs-string">'SHARED:DICT_UPDATED'</span>,
  <span class="hljs-attr">LOCALE_CHANGED</span>: <span class="hljs-string">'SHARED:LOCALE_CHANGED'</span>,
  <span class="hljs-attr">LOGOUT</span>: <span class="hljs-string">'SHARED:LOGOUT'</span>,
} <span class="hljs-keyword">as</span> <span class="hljs-keyword">const</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">setupSharedStoreProvider</span>(<span class="hljs-params"/>): <span class="hljs-built_in">void</span> {
  <span class="hljs-keyword">const</span> userStore = <span class="hljs-title function_">useUserStoreWithOut</span>()
  <span class="hljs-keyword">const</span> dictStore = <span class="hljs-title function_">useDictStoreWithOut</span>()
  <span class="hljs-keyword">const</span> localeStore = <span class="hljs-title function_">useLocaleStoreWithOut</span>()

  <span class="hljs-comment">// 直接 watch Pinia store 的响应式属性</span>
  <span class="hljs-title function_">watch</span>(
    <span class="hljs-function">() =&gt;</span> ({
      <span class="hljs-attr">permissions</span>: userStore.<span class="hljs-property">permissions</span>,
      <span class="hljs-attr">roles</span>: userStore.<span class="hljs-property">roles</span>,
      <span class="hljs-attr">roleId</span>: userStore.<span class="hljs-property">roleId</span>,
      <span class="hljs-attr">userInfo</span>: userStore.<span class="hljs-property">user</span>,
    }),
    <span class="hljs-function">(<span class="hljs-params">newVal</span>) =&gt;</span> {
      bus.$emit(<span class="hljs-variable constant_">SHARED_EVENTS</span>.<span class="hljs-property">AUTH_UPDATED</span>, {
        <span class="hljs-attr">token</span>: <span class="hljs-title function_">getAccessToken</span>(),
        ...newVal,
      })
    },
    { <span class="hljs-attr">deep</span>: <span class="hljs-literal">true</span> },
  )

  <span class="hljs-comment">// 字典加载完成后广播</span>
  <span class="hljs-title function_">watch</span>(
    <span class="hljs-function">() =&gt;</span> dictStore.<span class="hljs-property">isSetDict</span>,
    <span class="hljs-function">(<span class="hljs-params">isSet</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (isSet) {
        bus.$emit(<span class="hljs-variable constant_">SHARED_EVENTS</span>.<span class="hljs-property">DICT_UPDATED</span>, {
          <span class="hljs-attr">dictMap</span>: <span class="hljs-title function_">dictMapToRecord</span>(dictStore.<span class="hljs-property">dictMap</span>),
          <span class="hljs-attr">version</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>(),
        })
      }
    },
  )

  <span class="hljs-comment">// 语言切换</span>
  <span class="hljs-title function_">watch</span>(
    <span class="hljs-function">() =&gt;</span> localeStore.<span class="hljs-property">currentLocale</span>.<span class="hljs-property">lang</span>,
    <span class="hljs-function">(<span class="hljs-params">lang</span>) =&gt;</span> bus.$emit(<span class="hljs-variable constant_">SHARED_EVENTS</span>.<span class="hljs-property">LOCALE_CHANGED</span>, { lang }),
  )

  <span class="hljs-comment">// $subscribe 兜底检测登出</span>
  userStore.$subscribe(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (!userStore.<span class="hljs-property">isSetUser</span> &amp;&amp; userStore.<span class="hljs-property">permissions</span>.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {
      bus.$emit(<span class="hljs-variable constant_">SHARED_EVENTS</span>.<span class="hljs-property">LOGOUT</span>)
    }
  })
}
</code></pre>
<p><strong>关键细节：直接 watch Pinia store 的响应式属性</strong>，而不是通过 getter 函数间接访问。这是我们踩过的坑——如果 <code>watch(() =&gt; source.auth().token, ...)</code> 中的 <code>source.auth()</code> 每次返回新对象，Vue 的响应式追踪会完全失效。</p>
<h3 data-id="heading-10">非响应式数据的处理</h3>
<p>Token 存储在 <code>sessionStorage</code>（通过 <code>wsCache</code>），不是 Pinia 的响应式状态，无法用 <code>watch</code> 监听。我们的做法是<strong>在写入点主动广播</strong>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// apps/main/src/utils/auth.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">setToken</span> = (<span class="hljs-params">token: TokenType</span>) =&gt; {
  wsCache.<span class="hljs-title function_">set</span>(<span class="hljs-variable constant_">CACHE_KEY</span>.<span class="hljs-property">REFRESH_TOKEN</span>, token.<span class="hljs-property">refreshToken</span>)
  wsCache.<span class="hljs-title function_">set</span>(<span class="hljs-variable constant_">CACHE_KEY</span>.<span class="hljs-property">ACCESS_TOKEN</span>, token.<span class="hljs-property">accessToken</span>)
  <span class="hljs-comment">// Token 写入后主动广播（动态 import 避免循环依赖）</span>
  <span class="hljs-keyword">import</span>(<span class="hljs-string">'@/stores/shared-provider'</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">{ emitTokenRefreshed }</span>) =&gt;</span> {
    <span class="hljs-title function_">emitTokenRefreshed</span>()
  })
}
</code></pre>
<p>Logout 同理，在 <code>user.ts</code> 的 <code>logout()</code> action 中主动调用：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">async</span> <span class="hljs-title function_">logout</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">await</span> <span class="hljs-title function_">logout</span>()
  <span class="hljs-title function_">removeToken</span>()
  <span class="hljs-title function_">emitSharedLogout</span>()  <span class="hljs-comment">// 主动广播，确保子应用收到</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">resetState</span>()
}
</code></pre>
<h3 data-id="heading-11">初始快照注入</h3>
<p>主应用的 <code>App.vue</code> 通过 computed 构建 props，每次 Store 变化自动更新：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;WujieVue
  v-for="app in loadedApps"
  :key="app.name"
  :props="sharedProps"
  :alive="true"
/&gt;

&lt;script setup&gt;
const sharedProps = computed(() =&gt; ({
  $shared: {
    auth: { token, permissions, roles, userInfo, ... },
    dict: { dictMap },
    locale: { lang },
  },
  // 向后兼容旧子应用
  token: getAccessToken(),
  userInfo: userStore.user,
}))
&lt;/script&gt;
</code></pre>
<h3 data-id="heading-12">子应用侧：只读消费</h3>
<p>子应用<strong>不需要安装任何额外依赖</strong>，直接用 Wujie 原生 API：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 冷启动：从 props 获取初始数据</span>
<span class="hljs-keyword">const</span> wujie = (<span class="hljs-variable language_">window</span> <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>).<span class="hljs-property">__WUJIE</span>
<span class="hljs-keyword">const</span> shared = wujie?.<span class="hljs-property">props</span>?.<span class="hljs-property">$shared</span>

<span class="hljs-keyword">if</span> (shared) {
  <span class="hljs-comment">// 微前端环境：使用主应用的数据</span>
  authStore.<span class="hljs-title function_">setToken</span>(shared.<span class="hljs-property">auth</span>.<span class="hljs-property">token</span>)
  authStore.<span class="hljs-title function_">setPermissions</span>(shared.<span class="hljs-property">auth</span>.<span class="hljs-property">permissions</span>)
  dictStore.<span class="hljs-title function_">setDictMap</span>(shared.<span class="hljs-property">dict</span>.<span class="hljs-property">dictMap</span>)
  i18n.<span class="hljs-property">global</span>.<span class="hljs-property">locale</span>.<span class="hljs-property">value</span> = shared.<span class="hljs-property">locale</span>.<span class="hljs-property">lang</span>
} <span class="hljs-keyword">else</span> {
  <span class="hljs-comment">// 独立运行：走本地 API</span>
  <span class="hljs-keyword">await</span> authStore.<span class="hljs-title function_">fetchUserInfo</span>()
  <span class="hljs-keyword">await</span> dictStore.<span class="hljs-title function_">fetchDictData</span>()
}

<span class="hljs-comment">// 热更新：监听 bus 事件</span>
wujie?.<span class="hljs-property">bus</span>?.$on(<span class="hljs-string">'SHARED:TOKEN_REFRESHED'</span>, <span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {
  authStore.<span class="hljs-title function_">setToken</span>(data.<span class="hljs-property">token</span>)
})
wujie?.<span class="hljs-property">bus</span>?.$on(<span class="hljs-string">'SHARED:LOCALE_CHANGED'</span>, <span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {
  i18n.<span class="hljs-property">global</span>.<span class="hljs-property">locale</span>.<span class="hljs-property">value</span> = data.<span class="hljs-property">lang</span>
})
wujie?.<span class="hljs-property">bus</span>?.$on(<span class="hljs-string">'SHARED:LOGOUT'</span>, <span class="hljs-function">() =&gt;</span> {
  authStore.<span class="hljs-title function_">clearLocal</span>()
  router.<span class="hljs-title function_">push</span>(<span class="hljs-string">'/login'</span>)
})
</code></pre>
<p>通过 <code>__WUJIE</code> 是否存在来判断运行环境，<strong>微前端环境走 props/bus，独立运行走本地 API</strong>，子应用始终保持独立可运行。</p>
<h2 data-id="heading-13">数据流全景</h2>
<pre><code class="hljs language-ruby" lang="ruby">┌──────────────────────────────────────────────────────────┐
│                        主应用                              │
│                                                          │
│  <span class="hljs-variable constant_">API</span> 请求 → userStore / dictStore / localeStore          │
│                        │                                  │
│              shared-provider.ts                           │
│              (watch 响应式属性 → bus.<span class="hljs-variable">$emit</span>)                │
│                        │                                  │
│            ┌───────────┼───────────┐                      │
│            ▼           ▼           ▼                      │
│       wujie props   wujie bus   tabsStore 等              │
│       (<span class="hljs-variable">$shared</span>)     (<span class="hljs-variable constant_">SHARED</span><span class="hljs-symbol">:*</span>)                            │
│            │           │                                  │
└────────────┼───────────┼──────────────────────────────────┘
             │           │
   ┌─────────┼───────────┼─────────┐
   ▼         ▼           ▼         ▼
┌──────┐ ┌──────┐ ┌──────┐ ┌──────┐
│ doc  │ │ ibs  │ │ mkt  │ │ ...  │
│      │ │      │ │      │ │      │
│ 只读 │ │ 只读 │ │ 只读 │ │ 只读 │
│ 消费 │ │ 消费 │ │ 消费 │ │ 消费 │
└──────┘ └──────┘ └──────┘ └──────┘
</code></pre>
<h2 data-id="heading-14">踩坑记录</h2>
<h3 data-id="heading-15">坑 1：watch getter 返回新对象导致响应式失效</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// ❌ 错误：每次调用 source.auth() 返回新对象，watch 追踪不到变化</span>
<span class="hljs-title function_">watch</span>(<span class="hljs-function">() =&gt;</span> source.<span class="hljs-title function_">auth</span>().<span class="hljs-property">token</span>, <span class="hljs-function">(<span class="hljs-params">token</span>) =&gt;</span> { ... })

<span class="hljs-comment">// ✅ 正确：直接 watch Pinia store 的响应式属性</span>
<span class="hljs-title function_">watch</span>(<span class="hljs-function">() =&gt;</span> userStore.<span class="hljs-property">permissions</span>, <span class="hljs-function">(<span class="hljs-params">permissions</span>) =&gt;</span> { ... })
</code></pre>
<p>这是 Vue 响应式系统的基本原理，但在抽象层过多时很容易忽略。<strong>getter 函数如果每次返回新的普通对象，Vue 无法建立依赖追踪</strong>。</p>
<h3 data-id="heading-16">坑 2：dictStore.dictMap 是 Map 不是 Object</h3>
<p>Pinia store 中字典数据用 <code>Map&lt;string, any&gt;</code> 存储，但跨 iframe context 传输时 Map 无法正确序列化。需要转换为普通 Record：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">dictMapToRecord</span>(<span class="hljs-params">dictMap: <span class="hljs-built_in">any</span></span>): <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">any</span>[]&gt; {
  <span class="hljs-keyword">const</span> <span class="hljs-attr">result</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">any</span>[]&gt; = {}
  <span class="hljs-keyword">if</span> (dictMap <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Map</span>) {
    dictMap.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">value, key</span>) =&gt;</span> { result[key] = value })
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(result, dictMap)
  }
  <span class="hljs-keyword">return</span> result
}
</code></pre>
<h3 data-id="heading-17">坑 3：Token 存在 sessionStorage 中，不是响应式的</h3>
<p>Token 通过 <code>wsCache</code>（封装的 <code>web-storage-cache</code>）存储在 sessionStorage 中，不在 Pinia state 里，<code>watch</code> 监听不到。</p>
<p>解决方案：<strong>在写入点主动广播</strong>，而不是试图监听存储变化。用动态 <code>import()</code> 避免循环依赖。</p>
<h3 data-id="heading-18">坑 4：过度抽象的代价</h3>
<p>最初我们设计了完整的 composable 层（<code>useSharedAuth</code>、<code>useSharedDict</code>、<code>useSharedLocale</code>），每个都有 fallback 机制、readonly 包装、onScopeDispose 清理。</p>
<p>看起来很优雅，但实际上：</p>
<ul>
<li>子应用只需要读 props + 监听 bus，10 行代码的事</li>
<li>多了一个 npm 包依赖，子应用的 package.json 要加，CI 要装</li>
<li>composable 内部的 wujie 环境检测逻辑和子应用自己写没区别</li>
<li>维护成本远大于收益</li>
</ul>
<p><strong>最终我们删掉了整个包</strong>，回归最简方案。</p>
<h2 data-id="heading-19">设计原则总结</h2>

































<table><thead><tr><th>原则</th><th>说明</th></tr></thead><tbody><tr><td><strong>主应用独占维护</strong></td><td>系统级数据只在主应用写入，子应用只读</td></tr><tr><td><strong>不过度设计</strong></td><td>不搞 composable 抽象层、不搞额外 npm 包</td></tr><tr><td><strong>用平台能力</strong></td><td>Wujie 自带 props + bus，够用就不造轮子</td></tr><tr><td><strong>在写入点广播</strong></td><td>非响应式数据（Token）在写入时主动 emit</td></tr><tr><td><strong>向后兼容</strong></td><td>新增 <code>$shared</code> 字段，保留旧的 <code>token</code>/<code>userInfo</code></td></tr><tr><td><strong>独立可运行</strong></td><td>子应用通过 <code>__WUJIE__</code> 环境检测，非微前端环境走本地 API</td></tr></tbody></table>
<h2 data-id="heading-20">效果</h2>
<ul>
<li><strong>接口调用</strong>：字典请求从 N+1 次降为 1 次</li>
<li><strong>语言切换</strong>：实时同步，无需刷新</li>
<li><strong>Token 刷新</strong>：主应用刷新后 50ms 内所有子应用同步</li>
<li><strong>代码量</strong>：主应用新增 1 个文件（~180 行），子应用各减少 3 个冗余 Store</li>
<li><strong>依赖</strong>：零新增 npm 包</li>
</ul>
<h2 data-id="heading-21">适用场景</h2>
<p>这个方案适用于：</p>
<ul>
<li>基于 Wujie（或类似 iframe 沙箱方案）的微前端架构</li>
<li>主应用是唯一的系统级数据管理者</li>
<li>子应用数量 &gt; 2，且共享用户/权限/字典/语言等全局数据</li>
<li>团队希望保持架构简洁，避免过度工程化</li>
</ul>
<p>不适用于：</p>
<ul>
<li>子应用之间需要双向通信的场景（本方案是单向只读分发）</li>
<li>子应用需要修改系统级数据的场景（应该通过 bus 事件请求主应用修改）</li>
</ul>
<hr/>
<p><em>本文基于 Wujie 1.0 + Vue 3.5 + Pinia 3 的生产实践，如有问题欢迎交流。</em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React Hooks 在 Table Column Render 回调中的使用陷阱]]></title>    <link>https://juejin.cn/post/7605164560711155738</link>    <guid>https://juejin.cn/post/7605164560711155738</guid>    <pubDate>2026-02-11T06:01:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605164560711155738" data-draft-id="7605164560711139354" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React Hooks 在 Table Column Render 回调中的使用陷阱"/> <meta itemprop="keywords" content="前端,面试,React.js"/> <meta itemprop="datePublished" content="2026-02-11T06:01:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="刀疤"/> <meta itemprop="url" content="https://juejin.cn/user/2546894374183677"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React Hooks 在 Table Column Render 回调中的使用陷阱
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2546894374183677/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    刀疤
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-11T06:01:33.000Z" title="Wed Feb 11 2026 06:01:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">📋 问题描述</h2>
<p>在使用 Ant Design Table 组件时，尝试将包含 <code>useState</code> Hook 的代码从子组件内联到 <code>Column</code> 的 <code>render</code> 回调中，导致页面黑屏。</p>
<h3 data-id="heading-1">场景还原</h3>
<p><strong>原始实现（正常工作）：</strong></p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-comment">// editButton.tsx - 独立子组件</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Button</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"antd"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">EditModal</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"./edit"</span>;
<span class="hljs-keyword">import</span> { useState } <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">EditButton</span>(<span class="hljs-params">{ data }</span>) {
  <span class="hljs-keyword">const</span> [editOpen, setEditOpen] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">onEdit</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-title function_">setEditOpen</span>(<span class="hljs-literal">true</span>);
  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"link"</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{onEdit}</span>&gt;</span>
        编辑
      <span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">EditModal</span> <span class="hljs-attr">isModalOpen</span>=<span class="hljs-string">{editOpen}</span> <span class="hljs-attr">setIsModalOpen</span>=<span class="hljs-string">{setEditOpen}</span> /&gt;</span>
    <span class="hljs-tag">&lt;/&gt;</span></span>
  );
}
</code></pre>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-comment">// index.tsx - 父组件中使用</span>
&lt;<span class="hljs-title class_">Column</span>
  title=<span class="hljs-string">"操作"</span>
  dataIndex=<span class="hljs-string">"action"</span>
  key=<span class="hljs-string">"action"</span>
  render={<span class="hljs-function">(<span class="hljs-params">_: <span class="hljs-built_in">any</span>, record: <span class="hljs-built_in">any</span></span>) =&gt;</span> {
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">EditButton</span> <span class="hljs-attr">data</span>=<span class="hljs-string">{record}</span> /&gt;</span></span>; <span class="hljs-comment">// ✅ 正常工作</span>
  }}
/&gt;
</code></pre>
<p><strong>错误实现（导致黑屏）：</strong></p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-comment">// index.tsx - 直接在 render 回调中使用 Hook</span>
&lt;<span class="hljs-title class_">Column</span>
  title=<span class="hljs-string">"操作"</span>
  dataIndex=<span class="hljs-string">"action"</span>
  key=<span class="hljs-string">"action"</span>
  render={<span class="hljs-function">(<span class="hljs-params">_: <span class="hljs-built_in">any</span>, record: <span class="hljs-built_in">any</span></span>) =&gt;</span> {
    <span class="hljs-comment">// ❌ 错误：在回调函数中使用 Hook</span>
    <span class="hljs-keyword">const</span> [editOpen, setEditOpen] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);

    <span class="hljs-keyword">const</span> <span class="hljs-title function_">onEdit</span> = (<span class="hljs-params"/>) =&gt; {
      <span class="hljs-title function_">setEditOpen</span>(<span class="hljs-literal">true</span>);
    };

    <span class="hljs-keyword">return</span> (
      <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"link"</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{onEdit}</span>&gt;</span>
          编辑
        <span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">EditModal</span> <span class="hljs-attr">isModalOpen</span>=<span class="hljs-string">{editOpen}</span> <span class="hljs-attr">setIsModalOpen</span>=<span class="hljs-string">{setEditOpen}</span> /&gt;</span>
      <span class="hljs-tag">&lt;/&gt;</span></span>
    );
  }}
/&gt;
</code></pre>
<h2 data-id="heading-2">🔍 问题原因分析</h2>
<h3 data-id="heading-3">根本原因</h3>
<p><strong>违反了 React Hooks 的使用规则：Hooks 只能在 React 函数组件的顶层调用，不能在普通函数、回调函数、循环或条件语句中调用。</strong></p>
<h3 data-id="heading-4">技术细节</h3>
<ol>
<li>
<p><strong><code>render</code> 回调的本质</strong></p>
<ul>
<li><code>Table.Column</code> 的 <code>render</code> 属性接收的是一个<strong>普通函数</strong>，不是 React 组件函数</li>
<li>这个函数在每次渲染时被调用，用于生成每一行的渲染内容</li>
<li>React 无法在这个函数执行上下文中追踪 Hook 的调用顺序</li>
</ul>
</li>
<li>
<p><strong>React Hooks 的工作原理</strong></p>
<ul>
<li>Hooks 依赖于 React 的内部机制来维护状态和副作用</li>
<li>React 通过<strong>调用顺序</strong>来识别和管理每个 Hook</li>
<li>当 Hook 在非组件函数中调用时，React 无法正确建立 Hook 的调用链，导致运行时错误</li>
</ul>
</li>
<li>
<p><strong>错误表现</strong></p>
<ul>
<li>开发环境：控制台报错 <code>Invalid hook call. Hooks can only be called inside the body of a function component.</code></li>
<li>页面表现：白屏/黑屏（React 错误边界捕获错误，导致整个组件树崩溃）</li>
</ul>
</li>
</ol>
<h3 data-id="heading-5">错误信息示例</h3>
<pre><code class="hljs language-sql" lang="sql">Error: Invalid hook call. Hooks can <span class="hljs-keyword">only</span> be <span class="hljs-keyword">called</span> inside the body <span class="hljs-keyword">of</span> a <span class="hljs-keyword">function</span> component.
This could happen <span class="hljs-keyword">for</span> <span class="hljs-keyword">one</span> <span class="hljs-keyword">of</span> the following reasons:
<span class="hljs-number">1.</span> You might have mismatching versions <span class="hljs-keyword">of</span> React <span class="hljs-keyword">and</span> the renderer (such <span class="hljs-keyword">as</span> React DOM)
<span class="hljs-number">2.</span> You might be breaking the Rules <span class="hljs-keyword">of</span> Hooks
<span class="hljs-number">3.</span> You might have more than <span class="hljs-keyword">one</span> <span class="hljs-keyword">copy</span> <span class="hljs-keyword">of</span> React <span class="hljs-keyword">in</span> the same app
</code></pre>
<h2 data-id="heading-6">✅ 解决方案</h2>
<h3 data-id="heading-7">方案一：保持子组件独立（推荐）</h3>
<p><strong>优点：</strong></p>
<ul>
<li>符合 React 组件化设计原则</li>
<li>每行数据拥有独立的状态管理</li>
<li>代码清晰，易于维护和测试</li>
<li>性能优化：可以单独对子组件进行 memo 优化</li>
</ul>
<p><strong>实现：</strong></p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-comment">// editButton.tsx</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">EditButton</span>(<span class="hljs-params">{ data }</span>) {
  <span class="hljs-keyword">const</span> [editOpen, setEditOpen] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);
  <span class="hljs-comment">// ... 其他逻辑</span>
  <span class="hljs-keyword">return</span> (<span class="hljs-comment">/* ... */</span>);
}

<span class="hljs-comment">// index.tsx</span>
&lt;<span class="hljs-title class_">Column</span>
  title=<span class="hljs-string">"操作"</span>
  render={<span class="hljs-function">(<span class="hljs-params">_: <span class="hljs-built_in">any</span>, record: <span class="hljs-built_in">any</span></span>) =&gt;</span> {
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">EditButton</span> <span class="hljs-attr">data</span>=<span class="hljs-string">{record}</span> /&gt;</span></span>; <span class="hljs-comment">// ✅ 正确</span>
  }}
/&gt;
</code></pre>
<h3 data-id="heading-8">方案二：在父组件顶层管理状态</h3>
<p>如果需要在父组件层面统一管理弹窗状态（例如：同一时间只允许打开一个弹窗），可以在父组件顶层使用 Hook：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-comment">// index.tsx</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">PolicyTextConfig</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// ✅ 在组件顶层声明状态</span>
  <span class="hljs-keyword">const</span> [editingRecord, setEditingRecord] = useState&lt;<span class="hljs-built_in">any</span>&gt;(<span class="hljs-literal">null</span>);
  <span class="hljs-keyword">const</span> [editOpen, setEditOpen] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleEdit</span> = (<span class="hljs-params">record: <span class="hljs-built_in">any</span></span>) =&gt; {
    <span class="hljs-title function_">setEditingRecord</span>(record);
    <span class="hljs-title function_">setEditOpen</span>(<span class="hljs-literal">true</span>);
  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Table</span> <span class="hljs-attr">dataSource</span>=<span class="hljs-string">{tableData}</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Column</span>
          <span class="hljs-attr">title</span>=<span class="hljs-string">"操作"</span>
          <span class="hljs-attr">render</span>=<span class="hljs-string">{(_:</span> <span class="hljs-attr">any</span>, <span class="hljs-attr">record:</span> <span class="hljs-attr">any</span>) =&gt;</span> {
            // ✅ render 回调中只调用普通函数，不使用 Hook
            return (
              <span class="hljs-tag">&lt;<span class="hljs-name">Button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"link"</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> handleEdit(record)}&gt;
                编辑
              <span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span>
            );
          }}
        /&gt;
      <span class="hljs-tag">&lt;/<span class="hljs-name">Table</span>&gt;</span>

      {/* ✅ 弹窗放在组件顶层 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">EditModal</span>
        <span class="hljs-attr">isModalOpen</span>=<span class="hljs-string">{editOpen}</span>
        <span class="hljs-attr">setIsModalOpen</span>=<span class="hljs-string">{setEditOpen}</span>
        <span class="hljs-attr">data</span>=<span class="hljs-string">{editingRecord}</span>
      /&gt;</span>
    <span class="hljs-tag">&lt;/&gt;</span></span>
  );
}
</code></pre>
<h2 data-id="heading-9">📚 知识点总结</h2>
<h3 data-id="heading-10">React Hooks 规则</h3>
<ol>
<li>
<p><strong>只在顶层调用 Hook</strong></p>
<ul>
<li>✅ 在函数组件的最顶层</li>
<li>✅ 在自定义 Hook 的最顶层</li>
<li>❌ 不在循环、条件或嵌套函数中</li>
<li>❌ 不在普通回调函数中</li>
</ul>
</li>
<li>
<p><strong>只在 React 函数中调用 Hook</strong></p>
<ul>
<li>✅ React 函数组件</li>
<li>✅ 自定义 Hook</li>
<li>❌ 普通 JavaScript 函数</li>
<li>❌ 事件处理函数</li>
<li>❌ 渲染回调函数（如 <code>render</code>、<code>map</code> 回调等）</li>
</ul>
</li>
</ol>
<h3 data-id="heading-11">常见陷阱场景</h3>








































<table><thead><tr><th>场景</th><th>是否正确</th><th>说明</th></tr></thead><tbody><tr><td>组件顶层 <code>useState</code></td><td>✅</td><td>正确用法</td></tr><tr><td>自定义 Hook 中 <code>useState</code></td><td>✅</td><td>正确用法</td></tr><tr><td><code>map</code> 回调中 <code>useState</code></td><td>❌</td><td>错误：普通函数</td></tr><tr><td><code>onClick</code> 中 <code>useState</code></td><td>❌</td><td>错误：事件处理函数</td></tr><tr><td><code>Table.Column render</code> 中 <code>useState</code></td><td>❌</td><td>错误：渲染回调函数</td></tr><tr><td>条件语句中 <code>useState</code></td><td>❌</td><td>错误：违反调用顺序规则</td></tr></tbody></table>
<h2 data-id="heading-12">🎯 最佳实践</h2>
<ol>
<li>
<p><strong>组件化优先</strong></p>
<ul>
<li>需要状态管理的 UI 片段，优先提取为独立组件</li>
<li>保持组件的单一职责原则</li>
</ul>
</li>
<li>
<p><strong>状态提升 vs 状态下沉</strong></p>
<ul>
<li>如果多个组件需要共享状态 → 状态提升到父组件</li>
<li>如果状态只属于单个组件 → 保持在组件内部</li>
</ul>
</li>
<li>
<p><strong>代码审查检查点</strong></p>
<ul>
<li>检查所有 Hook 调用是否在组件顶层</li>
<li>检查是否有在回调函数中使用 Hook 的情况</li>
<li>使用 ESLint 插件 <code>eslint-plugin-react-hooks</code> 自动检测</li>
</ul>
</li>
</ol>
<h2 data-id="heading-13">🔧 调试技巧</h2>
<ol>
<li>
<p><strong>查看控制台错误</strong></p>
<ul>
<li>React 开发模式会给出明确的错误提示</li>
<li>关注 "Invalid hook call" 相关错误</li>
</ul>
</li>
<li>
<p><strong>使用 React DevTools</strong></p>
<ul>
<li>检查组件树结构</li>
<li>查看 Hook 调用情况</li>
</ul>
</li>
<li>
<p><strong>ESLint 配置</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"plugins"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"react-hooks"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"rules"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"react-hooks/rules-of-hooks"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"error"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"react-hooks/exhaustive-deps"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"warn"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
</li>
</ol>
<h2 data-id="heading-14">📝 总结</h2>
<p>这次踩坑的核心教训是：<strong>React Hooks 有严格的调用规则，任何违反规则的使用都会导致运行时错误。</strong> 在 Ant Design Table 的 <code>render</code> 回调中，应该只返回 JSX 或调用普通函数，而将需要 Hook 的逻辑封装在独立的组件中。</p>
<p>通过这次问题，我们更加理解了：</p>
<ul>
<li>React Hooks 的设计原理和限制</li>
<li>组件化设计的重要性</li>
<li>代码重构时需要保持对 Hook 规则的敏感性</li>
</ul>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[字节跳动Java岗面试常见题]]></title>    <link>https://juejin.cn/post/7605135197166354482</link>    <guid>https://juejin.cn/post/7605135197166354482</guid>    <pubDate>2026-02-11T06:10:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605135197166354482" data-draft-id="7605173538416984074" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="字节跳动Java岗面试常见题"/> <meta itemprop="keywords" content="后端,面试,Java"/> <meta itemprop="datePublished" content="2026-02-11T06:10:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Java水解"/> <meta itemprop="url" content="https://juejin.cn/user/2441349519143037"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            字节跳动Java岗面试常见题
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2441349519143037/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Java水解
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-11T06:10:17.000Z" title="Wed Feb 11 2026 06:10:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读23分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>1.####  <strong>、什么情况下会产生StackOverflowError（栈溢出）和OutOfMemoryError（堆溢出）怎么排查    难度系数：⭐⭐</strong></p>
<ol>
<li>
<p>引发 StackOverFlowError 的常见原因有以下几种</p>
<ul>
<li>无限递归循环调用（最常见）</li>
<li>执行了大量方法，导致线程栈空间耗尽</li>
<li>方法内声明了海量的局部变量</li>
<li>native 代码有栈上分配的逻辑，并且要求的内存还不小，比如 java.net.SocketInputStream.read0 会在栈上要求分配一个 64KB 的缓存（64位 Linux）。</li>
</ul>
</li>
<li>
<p>引发 OutOfMemoryError的常见原因有以下几种</p>
<ul>
<li>内存中加载的数据量过于庞大，如一次从数据库取出过多数据</li>
<li>集合类中有对对象的引用，使用完后未清空，使得JVM不能回收</li>
<li>代码中存在死循环或循环产生过多重复的对象实体</li>
<li>启动参数内存值设定的过小</li>
</ul>
</li>
<li>
<p>排查：可以通过jvisualvm进行内存快照分析</p>
</li>
<li>
<p>栈溢出、堆溢出案例演示</p>
</li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/da6e8025bafb467390fd14f56ab290d0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771396836&amp;x-signature=Vdre2PriOkM4TAS7Gvn1%2BZHZmrU%3D" alt="" loading="lazy"/></p>
<p> public class StackOverFlowTest {<br/>
private static int count = 1;<br/>
public static void main(String[] args) {<br/>
//模拟栈溢出<br/>
//getDieCircle();</p>
<p>//模拟堆溢出<br/>
getOutOfMem();<br/>
}</p>
<p>  public static void getDieCircle(){<br/>
System.out.println(count++);<br/>
getDieCircle();<br/>
}</p>
<p>  public static void getOutOfMem(){<br/>
while (true) {<br/>
Object o = new Object();<br/>
System.out.println(o);<br/>
}<br/>
}<br/>
}</p>
<p>Java</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d73fbb8fdb1a4cecb8d4bbbd25ae878d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771396836&amp;x-signature=A6M59y3Uinvu%2BeC5ad1kyrAQ%2FHA%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/923e3f9edb76499e98af86775b1fe53a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771396836&amp;x-signature=z35LDQ9lOREOFy2zjFWMFC%2FvFUs%3D" alt="" loading="lazy"/></p>
<blockquote>
<blockquote>
<p><strong>篇幅限制下面就只能给大家展示小册部分内容了。整理了一份核心面试笔记包括了：Java面试、Spring、JVM、MyBatis、Redis、MySQL、并发编程、微服务、Linux、Springboot、SpringCloud、MQ、Kafka 面试专题</strong></p>
<blockquote>
</blockquote>
<p><strong>需要全套面试笔记及答案【扫一扫】</strong>                           即可免费获取**</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/659d8d32094f4d318d5cafb036712d11~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771396836&amp;x-signature=q6S%2Bt08A2wQGWu5bzK7gs7ttKlM%3D" alt="8fbf1ef8b61e2dbbb33b7690a41d12e.png" loading="lazy"/></p>
</blockquote>
<h4 data-id="heading-0"><a href="https://link.juejin.cn/?target=" target="_blank" title="https://link.juejin.cn/?target="/><strong>6、什么是线程池，线程池有哪些（创建）    难度系数：⭐</strong></h4>
<p>线程池就是事先将多个线程对象放到一个容器中，当使用的时候就不用 new 线程而是直接去池中拿线程即可，节省了开辟子线程的时间，提高的代码执行效率</p>
<p>在 JDK 的 java.util.concurrent.Executors 中提供了生成多种线程池的静态方法。</p>
<p>ExecutorService newCachedThreadPool = Executors.newCachedThreadPool();</p>
<p>ExecutorService newFixedThreadPool = Executors.newFixedThreadPool(4);</p>
<p>ScheduledExecutorService newScheduledThreadPool = Executors.newScheduledThreadPool(4);</p>
<p>ExecutorService newSingleThreadExecutor = Executors.newSingleThreadExecutor();</p>
<p>然后调用他们的 execute 方法即可。</p>
<p>这4种线程池底层 全部是ThreadPoolExecutor对象的实现，阿里规范手册中规定线程池采用ThreadPoolExecutor自定义的，实际开发也是。</p>
<ol>
<li><strong>newCachedThreadPool</strong></li>
</ol>
<p>创建一个可缓存线程池，如果线程池长度超过处理需要，可灵活回收空闲线程，若无可回收，则新建线程。这种类型的线程池特点是：</p>
<p>工作线程的创建数量几乎没有限制(其实也有限制的,数目为Interger. MAX_VALUE), 这样可灵活的往线程池中添加线程。</p>
<p>如果长时间没有往线程池中提交任务，即如果工作线程空闲了指定的时间(默认为1分钟)，则该工作线程将自动终止。终止后，如果你又提交了新的任务，则线程池重新创建一个工作线程。</p>
<p>在使用CachedThreadPool时，一定要注意控制任务的数量，否则，由于大量线程同时运行，很有会造成系统瘫痪。</p>
<ol>
<li><strong>newFixedThreadPool</strong></li>
</ol>
<p>创建一个指定工作线程数量的线程池。每当提交一个任务就创建一个工作线程，如果工作线程数量达到线程池初始的最大数，则将提交的任务存入到池队列中。FixedThreadPool是一个典型且优秀的线程池，它具有线程池提高程序效率和节省创建线程时所耗的开销的优点。但是，在线程池空闲时，即线程池中没有可运行任务时，它不会释放工作线程，还会占用一定的系统资源。</p>
<ol>
<li><strong>newSingleThreadExecutor</strong></li>
</ol>
<p>创建一个单线程化的Executor，即只创建唯一的工作者线程来执行任务，它只会用唯一的工作线程来执行任务，保证所有任务按照指定顺序(FIFO, LIFO, 优先级)执行。如果这个线程异常结束，会有另一个取代它，保证顺序执行。单工作线程最大的特点是可保证顺序地执行各个任务，并且在任意给定的时间不会有多个线程是活动的。</p>
<ol>
<li><strong>newScheduleThreadPool</strong></li>
</ol>
<p>创建一个定长的线程池，而且支持定时的以及周期性的任务执行。例如延迟3秒执行。</p>
<h4 data-id="heading-1"><a href="https://link.juejin.cn/?target=" target="_blank" title="https://link.juejin.cn/?target="/><strong>7、为什么要使用线程池    难度系数：⭐</strong></h4>
<ol>
<li>线程池做的工作主要是控制运行的线程数量，处理过程中将任务放入队列，然后在线程创建后启动这些任务，如果线程数量超过了最 大数量，超出数量的线程排队等候，等其它线程执行完毕，再从队列中取出任务来执行。</li>
<li>主要特点:线程复用;控制最大并发数:管理线程。</li>
</ol>
<p>第一:降低资源消耗。通过重复利用己创建的线程降低线程创建和销毁造成的消耗。</p>
<p>第二:提高响应速度。当任务到达时，任务可以不需要的等到线程创建就能立即执行。</p>
<p>第三:提高线程的可管理性。线程是稀缺资源，如果无限制的创建，不仅会消耗系统资源，还会降低系统的稳定性，使用线程池可以进 行统一的分配，调优和监控</p>
<h4 data-id="heading-2"><a href="https://link.juejin.cn/?target=" target="_blank" title="https://link.juejin.cn/?target="/><strong>8、线程池底层工作原理    难度系数：⭐</strong></h4>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/44ee815034be4be48226be1219e73109~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771396836&amp;x-signature=FF1uZ7wv3hC3Lt69gEq88aj81c8%3D" alt="" loading="lazy"/></p>
<ol>
<li>第一步：线程池刚创建的时候，里面没有任何线程，等到有任务过来的时候才会创建线程。当然也可以调用 prestartAllCoreThreads() 或者 prestartCoreThread() 方法预创建corePoolSize个线程</li>
<li>第二步：调用execute()提交一个任务时，如果当前的工作线程数&lt;corePoolSize，直接创建新的线程执行这个任务</li>
<li>第三步：如果当时工作线程数量&gt;=corePoolSize，会将任务放入任务队列中缓存</li>
<li>第四步：如果队列已满，并且线程池中工作线程的数量&lt;maximumPoolSize，还是会创建线程执行这个任务</li>
<li>第五步：如果队列已满，并且线程池中的线程已达到maximumPoolSize，这个时候会执行拒绝策略，JAVA线程池默认的策略是AbortPolicy，即抛出RejectedExecutionException异常</li>
</ol>
<h4 data-id="heading-3"><a href="https://link.juejin.cn/?target=" target="_blank" title="https://link.juejin.cn/?target="/><strong>9、ThreadPoolExecutor对象有哪些参数 怎么设定核心线程数和最大线程数 拒绝策略有哪些    难度系数：⭐</strong></h4>
<p><strong>参数与作用：</strong>  共7个参数</p>
<ol>
<li><strong>corePoolSize：</strong>  核心线程数，</li>
</ol>
<p>在ThreadPoolExecutor中有一个与它相关的配置：allowCoreThreadTimeOut（默认为false），当allowCoreThreadTimeOut为false时，核心线程会一直存活，哪怕是一直空闲着。而当allowCoreThreadTimeOut为true时核心线程空闲时间超过keepAliveTime时会被回收。</p>
<ol>
<li><strong>maximumPoolSize：</strong>  最大线程数</li>
</ol>
<p>线程池能容纳的最大线程数，当线程池中的线程达到最大时，此时添加任务将会采用拒绝策略，默认的拒绝策略是抛出一个运行时错误（RejectedExecutionException）。值得一提的是，当初始化时用的工作队列为LinkedBlockingDeque时，这个值将无效。</p>
<ol>
<li><strong>keepAliveTime：</strong>  存活时间，</li>
</ol>
<p>当非核心空闲超过这个时间将被回收，同时空闲核心线程是否回收受allowCoreThreadTimeOut影响。</p>
<ol>
<li><strong>unit：</strong>  keepAliveTime的单位。</li>
<li><strong>workQueue：</strong>  任务队列</li>
</ol>
<p>常用有三种队列，即SynchronousQueue,LinkedBlockingDeque（无界队列）,ArrayBlockingQueue（有界队列）。</p>
<ol>
<li><strong>threadFactory：</strong>  线程工厂，</li>
</ol>
<p>ThreadFactory是一个接口，用来创建worker。通过线程工厂可以对线程的一些属性进行定制。默认直接新建线程。</p>
<ol>
<li><strong>RejectedExecutionHandler：</strong>  拒绝策略</li>
</ol>
<p>也是一个接口，只有一个方法，当线程池中的资源已经全部使用，添加新线程被拒绝时，会调用RejectedExecutionHandler的rejectedExecution法。默认是抛出一个运行时异常。</p>
<p><strong>线程池大小设置：</strong></p>
<ol>
<li>需要分析线程池执行的任务的特性： CPU 密集型还是 IO 密集型</li>
<li>每个任务执行的平均时长大概是多少，这个任务的执行时长可能还跟任务处理逻辑是否涉及到网络传输以及底层系统资源依赖有关系</li>
</ol>
<p>如果是 CPU 密集型，主要是执行计算任务，响应时间很快，cpu 一直在运行，这种任务 cpu的利用率很高，那么线程数的配置应该根据 CPU 核心数来决定，CPU 核心数=最大同时执行线程数，加入 CPU 核心数为 4，那么服务器最多能同时执行 4 个线程。过多的线程会导致上下文切换反而使得效率降低。那线程池的最大线程数可以配置为 cpu 核心数+1 如果是 IO 密集型，主要是进行 IO 操作，执行 IO 操作的时间较长，这是 cpu 出于空闲状态，导致 cpu 的利用率不高，这种情况下可以增加线程池的大小。这种情况下可以结合线程的等待时长来做判断，等待时间越高，那么线程数也相对越多。一般可以配置 cpu 核心数的 2 倍。</p>
<p>一个公式：线程池设定最佳线程数目 = （（线程池设定的线程等待时间+线程 CPU 时间）/<br/>
线程 CPU 时间 ）* CPU 数目</p>
<p>这个公式的线程 cpu 时间是预估的程序单个线程在 cpu 上运行的时间（通常使用 loadrunner测试大量运行次数求出平均值）</p>
<p><strong>拒绝策略：</strong></p>
<ol>
<li>AbortPolicy：直接抛出异常，默认策略；</li>
<li>CallerRunsPolicy：用调用者所在的线程来执行任务；</li>
<li>DiscardOldestPolicy：丢弃阻塞队列中靠最前的任务，并执行当前任务；</li>
<li>DiscardPolicy：直接丢弃任务；当然也可以根据应用场景实现 RejectedExecutionHandler 接口，自定义饱和策略，如记录日志或持久化存储不能处理的任务</li>
</ol>
<h4 data-id="heading-4"><a href="https://link.juejin.cn/?target=" target="_blank" title="https://link.juejin.cn/?target="/><strong>10、常见线程安全的并发容器有哪些    难度系数：⭐</strong></h4>
<ol>
<li>CopyOnWriteArrayList、CopyOnWriteArraySet、ConcurrentHashMap</li>
<li>CopyOnWriteArrayList、CopyOnWriteArraySet采用写时复制实现线程安全</li>
<li>ConcurrentHashMap采用分段锁的方式实现线程安全</li>
</ol>
<h4 data-id="heading-5"><a href="https://link.juejin.cn/?target=" target="_blank" title="https://link.juejin.cn/?target="/><strong>11、Atomic原子类了解多少 原理是什么    难度系数：⭐</strong></h4>
<p>Java 的原子类都存放在并发包 java.util.concurrent.atomic下，如下图：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c77627faf93a431eb7e32570e52ce7c7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771396836&amp;x-signature=UDnfr3XC3tPZ18YipDpA7dBNs8k%3D" alt="" loading="lazy"/></p>
<p><strong>基本类型</strong></p>
<ul>
<li>使用原子的方式更新基本类型</li>
<li>AtomicInteger：整型原子类</li>
<li>AtomicLong：长整型原子类</li>
<li>AtomicBoolean：布尔型原子类</li>
</ul>
<p><strong>数组类型</strong></p>
<ul>
<li>使用原子的方式更新数组里的某个元素</li>
<li>AtomicIntegerArray：整形数组原子类</li>
<li>AtomicLongArray：长整形数组原子类</li>
<li>AtomicReferenceArray：引用类型数组原子类</li>
</ul>
<p><strong>引用类型</strong></p>
<ul>
<li>AtomicReference：引用类型原子类</li>
<li>AtomicStampedReference：原子更新引用类型里的字段原子类</li>
<li>AtomicMarkableReference ：原子更新带有标记位的引用类型</li>
<li>AtomicIntegerFieldUpdater：原子更新整形字段的更新器</li>
<li>AtomicLongFieldUpdater：原子更新长整形字段的更新器</li>
<li>AtomicStampedReference：原子更新带有版本号的引用类型。该类将整数值与引用关联起来，可用于解决原子的更新数据和数据的版本号，以及解决使用 CAS 进行原子更新时可能出现的 ABA 问题</li>
</ul>
<ol>
<li>AtomicInteger 类利用 CAS (Compare and Swap) + volatile + native 方法来保证原子操作，从而避免 synchronized 的高开销，执行效率大为提升。</li>
<li>CAS 的原理，是拿期望值和原本的值作比较，如果相同，则更新成新的值。UnSafe 类的 objectFieldOffset() 方法是个本地方法，这个方法是用来拿“原值”的内存地址，返回值是 valueOffset；另外，value 是一个 volatile 变量，因此 JVM 总是可以保证任意时刻的任何线程总能拿到该变量的最新值。</li>
</ol>
<h4 data-id="heading-6"><a href="https://link.juejin.cn/?target=" target="_blank" title="https://link.juejin.cn/?target="/><strong>12、synchronized底层实现是什么 lock底层是什么 有什么区别    难度系数：⭐⭐⭐</strong></h4>
<p><strong>Synchronized原理：</strong></p>
<p>方法级的同步是隐式，即无需通过字节码指令来控制的，它实现在方法调用和返回操作之中。JVM可以从方法常量池中的方法表结构(method_info Structure) 中的 ACC_SYNCHRONIZED 访问标志区分一个方法是否同步方法。当方法调用时，调用指令将会 检查方法的 ACC_SYNCHRONIZED 访问标志是否被设置，如果设置了，执行线程将先持有monitor（虚拟机规范中用的是管程一词），然后再执行方法，最后再方法完成(无论是正常完成还是非正常完成)时释放monitor。</p>
<p>代码块的同步是利用monitorenter和monitorexit这两个字节码指令。它们分别位于同步代码块的开始和结束位置。当jvm执行到monitorenter指令时，当前线程试图获取monitor对象的所有权，如果未加锁或者已经被当前线程所持有，就把锁的计数器+1；当执行monitorexit指令时，锁计数器-1；当锁计数器为0时，该锁就被释放了。如果获取monitor对象失败，该线程则会进入阻塞状态，直到其他线程释放锁。</p>
<p><strong>Lock原理：</strong></p>
<ol>
<li>Lock的存储结构：一个int类型状态值（用于锁的状态变更），一个双向链表（用于存储等待中的线程）</li>
<li>Lock获取锁的过程：本质上是通过CAS来获取状态值修改，如果当场没获取到，会将该线程放在线程等待链表中。</li>
<li>Lock释放锁的过程：修改状态值，调整等待链表。</li>
<li>Lock大量使用CAS+自旋。因此根据CAS特性，lock建议使用在低锁冲突的情况下。</li>
</ol>
<blockquote>
<blockquote>
<p><strong>篇幅限制下面就只能给大家展示小册部分内容了。整理了一份核心面试笔记包括了：Java面试、Spring、JVM、MyBatis、Redis、MySQL、并发编程、微服务、Linux、Springboot、SpringCloud、MQ、Kafka 面试专题</strong></p>
<blockquote>
</blockquote>
<p><strong>需要全套面试笔记及答案【扫一扫】</strong>                           即可免费获取**</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/23b61036f41c4fda9246292304671768~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771396836&amp;x-signature=s3TdBL41MXP%2FgGIA2%2FWTdXpRUDI%3D" alt="8fbf1ef8b61e2dbbb33b7690a41d12e.png" loading="lazy"/></p>
</blockquote>
<p><strong>Lock与synchronized的区别：</strong></p>
<ol>
<li>Lock的加锁和解锁都是由java代码配合native方法（调用操作系统的相关方法）实现的，而synchronize的加锁和解锁的过程是由JVM管理的</li>
<li>当一个线程使用synchronize获取锁时，若锁被其他线程占用着，那么当前只能被阻塞，直到成功获取锁。而Lock则提供超时锁和可中断等更加灵活的方式，在未能获取锁的     条件下提供一种退出的机制。</li>
<li>一个锁内部可以有多个Condition实例，即有多路条件队列，而synchronize只有一路条件队列；同样Condition也提供灵活的阻塞方式，在未获得通知之前可以通过中断线程以    及设置等待时限等方式退出条件队列。</li>
<li>synchronize对线程的同步仅提供独占模式，而Lock即可以提供独占模式，也可以提供共享模式</li>
</ol>

































<table><thead><tr><th>synchronized  </th><th>Lock  </th></tr></thead><tbody><tr><td>关键字  </td><td>类  </td></tr><tr><td>自动加锁和释放锁  </td><td>需要手动调用unlock方法释放锁  </td></tr><tr><td>jvm层面的锁  </td><td>API层面的锁  </td></tr><tr><td>非公平锁  </td><td>可以选择公平或者非公平锁  </td></tr><tr><td>锁是一个对象,并且锁的信息保存在了对象中  </td><td>代码中通过int类型的state标识  </td></tr><tr><td>有一个锁升级的过程  </td><td>无  </td></tr></tbody></table>
<h4 data-id="heading-7"><a href="https://link.juejin.cn/?target=" target="_blank" title="https://link.juejin.cn/?target="/><strong>13、了解ConcurrentHashMap吗 为什么性能比HashTable高，说下原理    难度系数：⭐⭐</strong></h4>
<p>ConcurrentHashMap是线程安全的Map容器，JDK8之前，ConcurrentHashMap使用锁分段技术，将数据分成一段段存储，每个数据段配置一把锁，即segment类，这个类继承ReentrantLock来保证线程安全，JKD8的版本取消Segment这个分段锁数据结构，底层也是使用Node数组+链表+红黑树，从而实现对每一段数据就行加锁，也减少了并发冲突的概率。</p>
<p>hashtable类基本上所有的方法都是采用synchronized进行线程安全控制，高并发情况下效率就降低 ，ConcurrentHashMap是采用了分段锁的思想提高性能，锁粒度更细化</p>
<h4 data-id="heading-8"><a href="https://link.juejin.cn/?target=" target="_blank" title="https://link.juejin.cn/?target="/><strong>14、ConcurrentHashMap底层原理    难度系数：⭐⭐⭐</strong></h4>
<ol>
<li>
<p>Java7 中 ConcurrentHashMap 使用的分段锁，也就是每一个 Segment 上同时只有一个线程可以操作，每一个 Segment 都是一个类似 HashMap 数组的结构，它可以扩容，它的冲突会转化为链表。但是 Segment 的个数一但初始化就不能改变。</p>
<p> </p>
</li>
</ol>

<pre><code class="hljs language-ini" lang="ini">public V put(K key, V value) {
    Segment&lt;K,V&gt; s<span class="hljs-comment">;</span>
    if (<span class="hljs-attr">value</span> == null)
        throw new NullPointerException()<span class="hljs-comment">;</span>
    int <span class="hljs-attr">hash</span> = hash(key)<span class="hljs-comment">;</span>
    // hash 值无符号右移 28位（初始化时获得），然后与 <span class="hljs-attr">segmentMask</span>=<span class="hljs-number">15</span> 做与运算
    // 其实也就是把高4位与segmentMask（1111）做与运算
 
  // <span class="hljs-attr">this.segmentMask</span> = ssize - <span class="hljs-number">1</span><span class="hljs-comment">;</span>
   //对hash值进行右移segmentShift位，计算元素对应segment中数组下表的位置
   //把hash右移segmentShift，相当于只要hash值的高32-segmentShift位，右移的目的是保留了hash值的高位。然后和segmentMask与操作计算元素在segment数组中的下表
    int <span class="hljs-attr">j</span> = (hash &gt;&gt;&gt; segmentShift) &amp; segmentMask<span class="hljs-comment">;</span>
   //使用unsafe对象获取数组中第j个位置的值，后面加上的是偏移量
    if ((<span class="hljs-attr">s</span> = (Segment&lt;K,V&gt;)UNSAFE.getObject          // nonvolatile<span class="hljs-comment">; recheck</span>
         (segments, (j &lt;&lt; SSHIFT) + SBASE)) == null) //  in ensureSegment
        // 如果查找到的 Segment 为空，初始化
        <span class="hljs-attr">s</span> = ensureSegment(j)<span class="hljs-comment">;</span>
   //插入segment对象
    return s.put(key, hash, value, false)<span class="hljs-comment">;</span>
}
 
/**
 * Returns the segment for the given index, creating it and
 * recording in segment table (via CAS) if not already present.
 *
 * @param k the index
 * @return the segment
 */
@SuppressWarnings("unchecked")
private Segment&lt;K,V&gt; ensureSegment(int k) {
    final Segment&lt;K,V&gt;<span class="hljs-section">[]</span> <span class="hljs-attr">ss</span> = this.segments<span class="hljs-comment">;</span>
    long <span class="hljs-attr">u</span> = (k &lt;&lt; SSHIFT) + SBASE<span class="hljs-comment">; // raw offset</span>
    Segment&lt;K,V&gt; seg<span class="hljs-comment">;</span>
    // 判断 u 位置的 Segment 是否为null
    if ((<span class="hljs-attr">seg</span> = (Segment&lt;K,V&gt;)UNSAFE.getObjectVolatile(ss, u)) == null) {
        Segment&lt;K,V&gt; <span class="hljs-attr">proto</span> = ss[<span class="hljs-number">0</span>]<span class="hljs-comment">; // use segment 0 as prototype</span>
        // 获取0号 segment 里的 HashEntry&lt;K,V&gt; 初始化长度
        int <span class="hljs-attr">cap</span> = proto.table.length<span class="hljs-comment">;</span>
        // 获取0号 segment 里的 hash 表里的扩容负载因子，所有的 segment 的 loadFactor 是相同的
        float <span class="hljs-attr">lf</span> = proto.loadFactor<span class="hljs-comment">;</span>
        // 计算扩容阀值
        int <span class="hljs-attr">threshold</span> = (int)(cap * lf)<span class="hljs-comment">;</span>
        // 创建一个 cap 容量的 HashEntry 数组
        HashEntry&lt;K,V&gt;<span class="hljs-section">[]</span> <span class="hljs-attr">tab</span> = (HashEntry&lt;K,V&gt;[])new HashEntry[cap]<span class="hljs-comment">;</span>
        if ((<span class="hljs-attr">seg</span> = (Segment&lt;K,V&gt;)UNSAFE.getObjectVolatile(ss, u)) == null) { // recheck
            // 再次检查 u 位置的 Segment 是否为null，因为这时可能有其他线程进行了操作
            Segment&lt;K,V&gt; <span class="hljs-attr">s</span> = new Segment&lt;K,V&gt;(lf, threshold, tab)<span class="hljs-comment">;</span>
            // 自旋检查 u 位置的 Segment 是否为null
            while ((<span class="hljs-attr">seg</span> = (Segment&lt;K,V&gt;)UNSAFE.getObjectVolatile(ss, u))
                   == null) {
                // 使用CAS 赋值，只会成功一次
                if (UNSAFE.compareAndSwapObject(ss, u, null, <span class="hljs-attr">seg</span> = s))
                    break<span class="hljs-comment">;</span>
            }
        }
    }
    return seg<span class="hljs-comment">;</span>
}
 
final V put(K key, int hash, V value, boolean onlyIfAbsent) {
    // 获取 ReentrantLock 独占锁，获取不到，scanAndLockForPut 获取。
    HashEntry&lt;K,V&gt; <span class="hljs-attr">node</span> = tryLock() ? null : scanAndLockForPut(key, hash, value)<span class="hljs-comment">;</span>
    V oldValue<span class="hljs-comment">;</span>
    try {
        HashEntry&lt;K,V&gt;<span class="hljs-section">[]</span> <span class="hljs-attr">tab</span> = table<span class="hljs-comment">;</span>
        // 计算要put的数据位置
        int <span class="hljs-attr">index</span> = (tab.length - <span class="hljs-number">1</span>) &amp; hash<span class="hljs-comment">;</span>
        // CAS 获取 index 坐标的值
        HashEntry&lt;K,V&gt; <span class="hljs-attr">first</span> = entryAt(tab, index)<span class="hljs-comment">;</span>
        for (HashEntry&lt;K,V&gt; <span class="hljs-attr">e</span> = first<span class="hljs-comment">;;) {</span>
            if (e != null) {
                // 检查是否 key 已经存在，如果存在，则遍历链表寻找位置，找到后替换 value
                K k<span class="hljs-comment">;</span>
                if ((<span class="hljs-attr">k</span> = e.key) == key ||
                    (<span class="hljs-attr">e.hash</span> == hash &amp;&amp; key.equals(k))) {
                    <span class="hljs-attr">oldValue</span> = e.value<span class="hljs-comment">;</span>
                    if (!onlyIfAbsent) {
                        <span class="hljs-attr">e.value</span> = value<span class="hljs-comment">;</span>
                        ++modCount<span class="hljs-comment">;</span>
                    }
                    break<span class="hljs-comment">;</span>
                }
                <span class="hljs-attr">e</span> = e.next<span class="hljs-comment">;</span>
            }
            else {
                // first 有值没说明 index 位置已经有值了，有冲突，链表头插法。
                if (node != null)
                    node.setNext(first)<span class="hljs-comment">;</span>
                else
                    <span class="hljs-attr">node</span> = new HashEntry&lt;K,V&gt;(hash, key, value, first)<span class="hljs-comment">;</span>
                int <span class="hljs-attr">c</span> = count + <span class="hljs-number">1</span><span class="hljs-comment">;</span>
                // 容量大于扩容阀值，小于最大容量，进行扩容
                if (c &gt; threshold &amp;&amp; tab.length &lt; MAXIMUM_CAPACITY)
                    rehash(node)<span class="hljs-comment">;</span>
                else
                    // index 位置赋值 node，node 可能是一个元素，也可能是一个链表的表头
                    setEntryAt(tab, index, node)<span class="hljs-comment">;</span>
                ++modCount<span class="hljs-comment">;</span>
                <span class="hljs-attr">count</span> = c<span class="hljs-comment">;</span>
                <span class="hljs-attr">oldValue</span> = null<span class="hljs-comment">;</span>
                break<span class="hljs-comment">;</span>
            }
        }
    } finally {
        unlock()<span class="hljs-comment">;</span>
    }
    return oldValue<span class="hljs-comment">;</span>
}
运行项目并下载源码
</code></pre>
<p>Java</p>
<ol>
<li>Java8 中的 ConcurrentHashMap 使用的 Synchronized 锁加 CAS 的机制。结构Node 数组 + 链表 / 红黑树，Node 是类似于一个 HashEntry 的结构。它的冲突再达到一定大小时会转化成红黑树，在冲突小于一定数量时又退回链表。</li>
</ol>

<pre><code class="hljs language-ini" lang="ini">public V put(K key, V value) {
    return putVal(key, value, false)<span class="hljs-comment">;</span>
}
 
/** Implementation for put and putIfAbsent */
final V putVal(K key, V value, boolean onlyIfAbsent) {
    // key 和 value 不能为空
    if (<span class="hljs-attr">key</span> == null || value == null) throw new NullPointerException()<span class="hljs-comment">;</span>
    int <span class="hljs-attr">hash</span> = spread(key.hashCode())<span class="hljs-comment">;</span>
    int <span class="hljs-attr">binCount</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>
    for (Node&lt;K,V&gt;<span class="hljs-section">[]</span> <span class="hljs-attr">tab</span> = table<span class="hljs-comment">;;) {</span>
        // <span class="hljs-attr">f</span> = 目标位置元素
        Node&lt;K,V&gt; f<span class="hljs-comment">; int n, i, fh;// fh 后面存放目标位置的元素 hash 值</span>
        if (<span class="hljs-attr">tab</span> == null || (n = tab.length) == <span class="hljs-number">0</span>)
            // 数组桶为空，初始化数组桶（自旋+CAS)
            <span class="hljs-attr">tab</span> = initTable()<span class="hljs-comment">;</span>
        else if ((<span class="hljs-attr">f</span> = tabAt(tab, i = (n - <span class="hljs-number">1</span>) &amp; hash)) == null) {
            // 桶内为空，CAS 放入，不加锁，成功了就直接 break 跳出
            if (casTabAt(tab, i, null,new Node&lt;K,V&gt;(hash, key, value, null)))
                break<span class="hljs-comment">;  // no lock when adding to empty bin</span>
        }
        else if ((<span class="hljs-attr">fh</span> = f.hash) == MOVED)
            <span class="hljs-attr">tab</span> = helpTransfer(tab, f)<span class="hljs-comment">;</span>
        else {
            V <span class="hljs-attr">oldVal</span> = null<span class="hljs-comment">;</span>
            // 使用 synchronized 加锁加入节点
            synchronized (f) {
                if (tabAt(tab, i) == f) {
                    // 说明是链表
                    if (fh &gt;= 0) {
                        <span class="hljs-attr">binCount</span> = <span class="hljs-number">1</span><span class="hljs-comment">;</span>
                        // 循环加入新的或者覆盖节点
                        for (Node&lt;K,V&gt; <span class="hljs-attr">e</span> = f<span class="hljs-comment">;; ++binCount) {</span>
                            K ek<span class="hljs-comment">;</span>
                            if (<span class="hljs-attr">e.hash</span> == hash &amp;&amp;
                                ((<span class="hljs-attr">ek</span> = e.key) == key ||
                                 (ek != null &amp;&amp; key.equals(ek)))) {
                                <span class="hljs-attr">oldVal</span> = e.val<span class="hljs-comment">;</span>
                                if (!onlyIfAbsent)
                                    <span class="hljs-attr">e.val</span> = value<span class="hljs-comment">;</span>
                                break<span class="hljs-comment">;</span>
                            }
                            Node&lt;K,V&gt; <span class="hljs-attr">pred</span> = e<span class="hljs-comment">;</span>
                            if ((<span class="hljs-attr">e</span> = e.next) == null) {
                                <span class="hljs-attr">pred.next</span> = new Node&lt;K,V&gt;(hash, key,
                                                          value, null)<span class="hljs-comment">;</span>
                                break<span class="hljs-comment">;</span>
                            }
                        }
                    }
                    else if (f instanceof TreeBin) {
                        // 红黑树
                        Node&lt;K,V&gt; p<span class="hljs-comment">;</span>
                        <span class="hljs-attr">binCount</span> = <span class="hljs-number">2</span><span class="hljs-comment">;</span>
                        if ((<span class="hljs-attr">p</span> = ((TreeBin&lt;K,V&gt;)f).putTreeVal(hash, key,
                                                       value)) != null) {
                            <span class="hljs-attr">oldVal</span> = p.val<span class="hljs-comment">;</span>
                            if (!onlyIfAbsent)
                                <span class="hljs-attr">p.val</span> = value<span class="hljs-comment">;</span>
                        }
                    }
                }
            }
            if (binCount != 0) {
                if (binCount &gt;= TREEIFY_THRESHOLD)
                    treeifyBin(tab, i)<span class="hljs-comment">;</span>
                if (oldVal != null)
                    return oldVal<span class="hljs-comment">;</span>
                break<span class="hljs-comment">;</span>
            }
        }
    }
    addCount(1L, binCount)<span class="hljs-comment">;</span>
    return null<span class="hljs-comment">;</span>
}
运行项目并下载源码
</code></pre>
<p>Java</p>
<h4 data-id="heading-9"><a href="https://link.juejin.cn/?target=" target="_blank" title="https://link.juejin.cn/?target="/><strong>15、了解volatile关键字不    难度系数：⭐</strong></h4>
<ol>
<li>volatile是Java提供的最轻量级的同步机制，保证了共享变量的可见性，被volatile关键字修饰的变量，如果值发生了变化，其他线程立刻可见，避免出现脏读现象。</li>
<li>volatile禁止了指令重排，可以保证程序执行的有序性，但是由于禁止了指令重排，所以JVM相关的优化没了，效率会偏弱</li>
</ol>
<h4 data-id="heading-10"><a href="https://link.juejin.cn/?target=" target="_blank" title="https://link.juejin.cn/?target="/><strong>16、synchronized和volatile有什么区别    难度系数：⭐⭐</strong></h4>
<ol>
<li>volatile本质是告诉JVM当前变量在寄存器中的值是不确定的，需要从主存中读取，synchronized则是锁定当前变量，只有当前线程可以访问该变量，其他线程被阻塞住。</li>
<li>volatile仅能用在变量级别，而synchronized可以使用在变量、方法、类级别。</li>
<li>volatile仅能实现变量的修改可见性，不能保证原子性；而synchronized则可以保证变量的修改可见性和原子性。</li>
<li>volatile不会造成线程阻塞，synchronized可能会造成线程阻塞。</li>
<li>volatile标记的变量不会被编译器优化，synchronized标记的变量可以被编译器优化。</li>
</ol>
<h4 data-id="heading-11"><a href="https://link.juejin.cn/?target=" target="_blank" title="https://link.juejin.cn/?target="/><strong>17、Java类加载过程    难度系数：⭐</strong></h4>
<ol>
<li>加载 加载时类加载的第一个过程，在这个阶段，将完成一下三件事情：</li>
</ol>
<p>通过一个类的全限定名获取该类的二进制流。</p>
<p>将该二进制流中的静态存储结构转化为方法去运行时数据结构。 </p>
<p>在内存中生成该类的Class对象，作为该类的数据访问入口。</p>
<ol>
<li>验证 验证的目的是为了确保Class文件的字节流中的信息不回危害到虚拟机.在该阶段主要完成以下四钟验证:</li>
</ol>
<p>文件格式验证：验证字节流是否符合Class文件的规范，如主次版本号是否在当前虚拟机范围内，常量池中的常量是否有不被支持的类型.</p>
<p>元数据验证:对字节码描述的信息进行语义分析，如这个类是否有父类，是否集成了不被继承的类等。</p>
<p>字节码验证：是整个验证过程中最复杂的一个阶段，通过验证数据流和控制流的分析，确定程序语义是否正确，主要针对方法体的验证。如：方法中的类型转换是否正确，跳转指令是否正确等。</p>
<p>符号引用验证：这个动作在后面的解析过程中发生，主要是为了确保解析动作能正确执行。</p>
<ol>
<li>准备</li>
</ol>
<p>准备阶段是为类的静态变量分配内存并将其初始化为默认值，这些内存都将在方法区中进行分配。准备阶段不分配类中的实例变量的内存，实例变量将会在对象实例化时随着对象一起分配在Java堆中。</p>
<ol>
<li>解析</li>
</ol>
<p>该阶段主要完成符号引用到直接引用的转换动作。解析动作并不一定在初始化动作完成之前，也有可能在初始化之后。</p>
<ol>
<li>初始化</li>
</ol>
<p>初始化时类加载的最后一步，前面的类加载过程，除了在加载阶段用户应用程序可以通过自定义类加载器参与之外，其余动作完全由虚拟机主导和控制。到了初始化阶段，才真正开始执行类中定义的</p>
<h4 data-id="heading-12"><a href="https://link.juejin.cn/?target=" target="_blank" title="https://link.juejin.cn/?target="/><strong>18、什么是类加载器，类加载器有哪些  难度系数：⭐</strong></h4>
<p>类加载器就是把类文件加载到虚拟机中，也就是说通过一个类的全限定名来获取描述该类的二进制字节流。</p>
<ol>
<li>主要有以下四种类加载器</li>
</ol>
<p>启动类加载器(Bootstrap ClassLoader)用来加载java核心类库，无法被java程序直接引用</p>
<p>扩展类加载器(extension class loader):它用来加载 Java 的扩展库。Java 虚拟机的实现会提供一个扩展库目录。该类加载器在此目录里面查找并加载 Java 类</p>
<p>系统类加载器（system class loader）也叫应用类加载器：它根据 Java 应用的类路径（CLASSPATH）来加载 Java 类。一般来说，Java 应用的类都是由它来完成加载的。可以通过 ClassLoader.getSystemClassLoader()来获取它</p>
<p>用户自定义类加载器，通过继承 java.lang.ClassLoader类的方式实现</p>
<ol>
<li>
<p>什么时候会使用到加载器？java中的加载器是按需加载，什么时候用到，什么时候加载</p>
<ul>
<li>new对象的时候</li>
<li>访问某个类或者接口的静态变量，或者对该静态变量赋值时</li>
<li>调用类的静态方法时</li>
<li>反射</li>
<li>初始化一个类的子类时，其父类首先会被加载</li>
<li>JVM启动时标明的启动类，也就是文件名和类名相同的那个类</li>
</ul>
</li>
</ol>
<h4 data-id="heading-13"><a href="https://link.juejin.cn/?target=" target="_blank" title="https://link.juejin.cn/?target="/><strong>19、简述java内存分配与回收策略以及Minor GC和Major GC（full GC）     难度系数：⭐⭐</strong></h4>
<ol>
<li><strong>内存分配</strong></li>
</ol>
<p><strong>栈区</strong>：栈分为java虚拟机栈和本地方法栈</p>
<p><strong>堆区</strong>：堆被所有线程共享区域，在虚拟机启动时创建，唯一目的存放对象实例。堆区是gc的主要区域，通常情况下分为两个区块年轻代和年老代。更细一点年轻代又分为Eden区，主要放新创建对象，From survivor 和 To survivor 保存gc后幸存下的对象，默认情况下各自占比 8:1:1。</p>
<p><strong>方法区</strong>：被所有线程共享区域，用于存放已被虚拟机加载的类信息，常量，静态变量等数据。被Java虚拟机描述为堆的一个逻辑部分。习惯是也叫它永久代（permanment generation）</p>
<p><strong>程序计数器</strong>：当前线程所执行的行号指示器。通过改变计数器的值来确定下一条指令，比如循环，分支，跳转，异常处理，线程恢复等都是依赖计数器来完成。线程私有的。</p>
<ol>
<li>
<p><strong>回收策略以及Minor GC和Major GC</strong></p>
<ul>
<li>对象优先在堆的Eden区分配</li>
<li>大对象直接进入老年代</li>
<li>长期存活的对象将直接进入老年代</li>
</ul>
</li>
</ol>
<p>当Eden区没有足够的空间进行分配时，虚拟机会执行一次Minor GC.Minor GC通常发生在新生代的Eden区，在这个区的对象生存期短，往往发生GC的频率较高，回收速度比较快;Full Gc/Major GC 发生在老年代，一般情况下，触发老年代GC的时候不会触发Minor GC,但是通过配置，可以在Full GC之前进行一次Minor GC这样可以加快老年代的回收速度。</p>
<h4 data-id="heading-14"><a href="https://link.juejin.cn/?target=" target="_blank" title="https://link.juejin.cn/?target="/><strong>20、如何查看java死锁     难度系数：⭐</strong></h4>
<pre><code class="hljs language-java" lang="java">####演示死锁
<span class="hljs-keyword">package</span> com.ssg.mst;
<span class="hljs-keyword">public</span> class 死锁 {
 
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">lock1</span> <span class="hljs-operator">=</span> <span class="hljs-string">"lock1"</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">lock2</span> <span class="hljs-operator">=</span> <span class="hljs-string">"lock2"</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">Thread</span> <span class="hljs-variable">thread1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
            <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
                <span class="hljs-keyword">synchronized</span> (lock1) {
                    <span class="hljs-keyword">try</span> {
                        System.out.println(Thread.currentThread().getName() + lock1);
                        Thread.sleep(<span class="hljs-number">1000</span>);
                        <span class="hljs-keyword">synchronized</span> (lock2){
                            System.out.println(Thread.currentThread().getName() + lock2);
                        }
                    } <span class="hljs-keyword">catch</span> (InterruptedException e) {
                        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);
                    }
                }
            }
        });
 
        <span class="hljs-type">Thread</span> <span class="hljs-variable">thread2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
            <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
                <span class="hljs-keyword">synchronized</span> (lock2) {
                    <span class="hljs-keyword">try</span> {
                        System.out.println(Thread.currentThread().getName() + lock2);
                        Thread.sleep(<span class="hljs-number">1000</span>);
                        <span class="hljs-keyword">synchronized</span> (lock1){
                            System.out.println(Thread.currentThread().getName() + lock1);
                        }
                    } <span class="hljs-keyword">catch</span> (InterruptedException e) {
                        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);
                    }
                }
            }
        });
 
        thread1.start();
        thread2.start();
    }
}
运行项目并下载源码
</code></pre>
<p>Java</p>
<p>死锁代码演示</p>
<ol>
<li>程序运行，进程没有停止。</li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/343ad9d79ff14f2fbdbf68bc38b6fc53~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771396836&amp;x-signature=xzSs8A3XgfGEQ0LpCeYG178XNXQ%3D" alt="" loading="lazy"/></p>
<ol>
<li>通过jps查看java进程，找到没有停止的进程</li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f4ba1cd42c0f42ecbe6c238e08fd3b4c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771396836&amp;x-signature=8eDpN2xxdS%2BZLyJ6EIUf%2FK%2BwhTA%3D" alt="" loading="lazy"/></p>
<ol>
<li>通过jstack 9060 查看进程具体执行信息</li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7ec5cebfa4ec4a97915de5351069759b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771396836&amp;x-signature=EANngeE2XklCTGDJpav7qZRsxPk%3D" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深入理解 INP：从原理到实战的前端交互性能优化]]></title>    <link>https://juejin.cn/post/7605106957133856802</link>    <guid>https://juejin.cn/post/7605106957133856802</guid>    <pubDate>2026-02-11T06:20:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605106957133856802" data-draft-id="7601374137412829219" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深入理解 INP：从原理到实战的前端交互性能优化"/> <meta itemprop="keywords" content="前端,JavaScript,性能优化"/> <meta itemprop="datePublished" content="2026-02-11T06:20:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="浏览器API调用工程师_Taylor"/> <meta itemprop="url" content="https://juejin.cn/user/3104676568630520"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深入理解 INP：从原理到实战的前端交互性能优化
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3104676568630520/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    浏览器API调用工程师_Taylor
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-11T06:20:50.000Z" title="Wed Feb 11 2026 06:20:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    10
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">背景</h2>
<p>最近有做一些INP优化相关，简单记录一下。</p>
<p>INP高的重灾区就是手机端， 手机 CPU 弱、线程紧张，INP 高基本都出在移动端。</p>
<h2 data-id="heading-1">什么是 INP？</h2>
<p><strong>INP（Interaction to Next Paint，交互到下一次绘制）</strong> 是 Google Core Web Vitals 中评估网页交互响应性的核心指标。自 2024 年 3 月起，INP 正式取代了旧的 FID（First Input Delay），成为衡量用户交互体验的主要标准。</p>
<h2 data-id="heading-2">优化INP有什么用？</h2>
<ul>
<li>
<p>📱 <strong>体验层面</strong>：解决移动端点击卡顿、无响应，让交互秒反馈，大幅提升流畅度。</p>
</li>
<li>
<p>🔍 <strong>SEO 层面</strong>：INP 是 Google Core Web Vitals 核心指标，达标有利于搜索排名与流量。</p>
</li>
<li>
<p>💰 <strong>业务层面</strong>：交互更流畅，用户流失更少，留存、转化率更高。</p>
</li>
<li>
<p>🛠 <strong>技术层面</strong>：拆分长任务、优化主线程，让项目整体架构更轻、更快、更易维护。</p>
</li>
</ul>
<h2 data-id="heading-3">INP vs FID：为什么要换？</h2>






























<table><thead><tr><th>对比维度</th><th>FID (旧指标)</th><th>INP (新指标)</th></tr></thead><tbody><tr><td>测量范围</td><td>仅第一次交互</td><td><strong>全生命周期所有交互</strong></td></tr><tr><td>测量内容</td><td>仅输入延迟</td><td><strong>输入 + 处理 + 渲染</strong> 全链路</td></tr><tr><td>真实性</td><td>片面</td><td>更全面、更真实</td></tr><tr><td>优化指导</td><td>只关注首次交互</td><td>关注所有交互场景</td></tr></tbody></table>
<p><strong>简单来说</strong>：FID 只是"开胃菜"，INP 才是"全席宴"——它能真正反映用户在使用过程中的完整体验。</p>
<hr/>
<h2 data-id="heading-4">INP 测量的是什么？</h2>
<p>INP 测量的是：<strong>用户进行一次有效交互（点击、点按、键盘输入）后，到浏览器完成下一次视觉更新（paint）所花费的总时间。</strong></p>
<h3 data-id="heading-5">时序图解</h3>
<pre><code class="hljs language-plaintext" lang="plaintext">用户交互（click/tap/keypress）
        │
        ▼
   ┌─────────────┐    ┌─────────────┐    ┌─────────────────────────┐
   │  输入延迟   │ → │  事件处理   │ → │ 样式计算 + 布局 + 绘制  │ → 下一帧 paint
   └─────────────┘    └─────────────┘    └─────────────────────────┘
   ◀──────────────────── INP 完整耗时 ────────────────────────────▶


</code></pre>
<blockquote>
<p>📌 <strong>关键点</strong>：INP 的最终值 = 页面生命周期中所有有效交互里<strong>最慢的那一次</strong>（取第 75 百分位）</p>
</blockquote>
<h2 data-id="heading-6">评分标准（2025–2026）</h2>
<p>根据 Google 官方标准，INP 以第 75 百分位（P75）进行评估：</p>

























<table><thead><tr><th>等级</th><th>阈值</th><th>含义</th></tr></thead><tbody><tr><td>🟢 <strong>良好</strong> (Good)</td><td>≤ 200 ms</td><td>响应迅速，用户体验优秀</td></tr><tr><td>🟡 <strong>需改进</strong> (Needs Improvement)</td><td>200–500 ms</td><td>有明显延迟感，需要优化</td></tr><tr><td>🔴 <strong>较差</strong> (Poor)</td><td>&gt; 500 ms</td><td>严重卡顿，体验糟糕</td></tr></tbody></table>
<p><strong>优化目标</strong>：确保 75% 以上的用户交互响应时间控制在 <strong>200 ms 以内</strong>。</p>
<h2 data-id="heading-7">如下是谷歌搜索控制台看到的INP高的页面，提示咱需要优化提升呢</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3f28c94c680e4d9ba760936d853a7cc2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rWP6KeI5ZmoQVBJ6LCD55So5bel56iL5biIX1RheWxvcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771396370&amp;x-signature=os6YipZtG7CbC13fh8S1%2Bt9ybg8%3D" alt="1770779737686_00af473a3546431c8782fc39930c2adb.png" loading="lazy"/></p>
<h2 data-id="heading-8">为什么 INP 会变差？</h2>
<h3 data-id="heading-9">核心原因</h3>
<p><strong>主线程上存在长任务（Long Task &gt; 50 ms）</strong>，阻塞了浏览器处理后续交互和渲染。</p>
<h3 data-id="heading-10">典型场景</h3>
<pre><code class="hljs language-plaintext" lang="plaintext">用户点击按钮 
    → setLoading(true) 
    → 立即执行 200–500 ms 的重计算/网络请求/复杂 DOM 操作 
    → 用户迟迟看不到 loading 状态
    → 感觉卡顿、无响应


</code></pre>
<p>问题在于：<strong>setLoading(true) 虽然调用了，但由于主线程被长任务占用，浏览器根本没机会渲染这个状态变化！</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5a3e57c4af114983955e8b69f3921213~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rWP6KeI5ZmoQVBJ6LCD55So5bel56iL5biIX1RheWxvcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771396370&amp;x-signature=z%2FtS8DqtRAR6%2BUCODf%2FIkn1TXNo%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-11">三个阶段的问题分布</h3>
<p>根据实际项目经验，三个阶段的问题分布大致如下：</p>
<ul>
<li>
<p><strong>输入延迟</strong>：30% - 通常是第三方脚本、初始化任务</p>
</li>
<li>
<p><strong>事件处理</strong>：50% - 最常见的问题，业务逻辑复杂</p>
</li>
<li>
<p><strong>呈现延迟</strong>：20% - DOM 操作、布局计算</p>
</li>
</ul>
<hr/>
<h2 data-id="heading-12">INP 的三个阶段详解</h2>
<p>INP 的测量范围涵盖三个关键阶段，每个阶段都可能成为性能瓶颈。深入理解这三个阶段，是优化 INP 的基础。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7d468f757de14221935dcfce22c01a29~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rWP6KeI5ZmoQVBJ6LCD55So5bel56iL5biIX1RheWxvcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771396370&amp;x-signature=VkyBxZ3W2V17OYPTdQq0FOC5PAI%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-13">阶段一：输入延迟（Input Delay）</h3>
<p><strong>定义</strong>：从用户触发交互到事件处理器开始执行之间的等待时间。</p>
<p><strong>原因</strong>：主线程被其他任务占用（长任务 &gt; 50ms、同步渲染、第三方脚本、垃圾回收），浏览器无法立即响应交互。</p>
<p><strong>案例</strong>：<strong>比如如下，输入延迟348ms，脚本加载阻塞了交互</strong>
导致用户交互卡顿</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/64821c46b4a24ccb9ca03f1f1e04e22e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rWP6KeI5ZmoQVBJ6LCD55So5bel56iL5biIX1RheWxvcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771396370&amp;x-signature=LAgGThGZ50xGTipgjixCAnPahIQ%3D" alt="f41ca817c123575b3394dbeab12da896.png" loading="lazy"/></p>
<h4 data-id="heading-14">优化策略</h4>
<ul>
<li>
<p>拆分长任务：使用 <code>scheduler.yield()</code> 或 scheduler.postTask 让出主线程</p>
</li>
<li>
<p>延迟非关键任务：使用 <code>requestIdleCallback</code> 在空闲时执行</p>
</li>
<li>
<p>优化第三方脚本：异步加载、延迟执行</p>
</li>
</ul>
<hr/>
<h3 data-id="heading-15">阶段二：事件处理（Processing Time）</h3>
<p><strong>定义</strong>：事件处理器从开始执行到执行完成所花费的时间。</p>
<p><strong>原因</strong>：处理器内部执行耗时操作（复杂计算、大量 DOM 操作、同步网络请求、强制同步布局），阻塞主线程。</p>
<h4 data-id="heading-16">实际案例</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// ❌ 问题：用户点击更换背景，但画布操作耗时，看不到即时反馈</span>
<span class="hljs-comment">// 来源：src/core/FTCanvasRenderer.ts - updateBackground</span>
<span class="hljs-keyword">async</span> <span class="hljs-title function_">updateBackground</span>(<span class="hljs-params">{ bgUrl, bgColor, size, callback }</span>) {
  <span class="hljs-title class_">FTBgremoveStore</span>.<span class="hljs-property">changeBackgroundLoading</span> = <span class="hljs-literal">true</span>;  <span class="hljs-comment">// 状态已更新，但浏览器还没渲染</span>
  
  <span class="hljs-comment">// 同步执行耗时操作，阻塞主线程</span>
  <span class="hljs-keyword">const</span> blobUrl = <span class="hljs-keyword">await</span> <span class="hljs-title class_">FTBlobCacheManager</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-title function_">addCache</span>(bgUrl);  <span class="hljs-comment">// 100-200ms</span>
  bg.<span class="hljs-title function_">setSource</span>(blobUrl, <span class="hljs-string">"imageUrl"</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">blurBackground</span>(currentPageData.<span class="hljs-property">blurValue</span> || <span class="hljs-number">0</span>);  <span class="hljs-comment">// 50-100ms 模糊处理</span>
    fabricCanvas.<span class="hljs-title function_">requestRenderAll</span>();  <span class="hljs-comment">// 触发重绘</span>
    <span class="hljs-title class_">FTBgremoveStore</span>.<span class="hljs-property">changeBackgroundLoading</span> = <span class="hljs-literal">false</span>;
  });
}

<span class="hljs-comment">// ✅ 优化：先让浏览器渲染反馈，再执行耗时操作</span>
<span class="hljs-keyword">import</span> { nextTick } <span class="hljs-keyword">from</span> <span class="hljs-string">'src/utils'</span>;

<span class="hljs-keyword">async</span> <span class="hljs-title function_">updateBackground</span>(<span class="hljs-params">{ bgUrl, bgColor, size, callback }</span>) {
  <span class="hljs-title class_">FTBgremoveStore</span>.<span class="hljs-property">changeBackgroundLoading</span> = <span class="hljs-literal">true</span>;
  
  <span class="hljs-comment">// 让出主线程，确保浏览器先渲染 loading 状态</span>
  <span class="hljs-keyword">await</span> <span class="hljs-title function_">nextTick</span>();
  
  <span class="hljs-comment">// 现在执行耗时操作</span>
  <span class="hljs-keyword">const</span> blobUrl = <span class="hljs-keyword">await</span> <span class="hljs-title class_">FTBlobCacheManager</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-title function_">addCache</span>(bgUrl);
  bg.<span class="hljs-title function_">setSource</span>(blobUrl, <span class="hljs-string">"imageUrl"</span>, <span class="hljs-keyword">async</span> () =&gt; {
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">nextTick</span>();  <span class="hljs-comment">// 再次让出，确保模糊处理不阻塞</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">blurBackground</span>(currentPageData.<span class="hljs-property">blurValue</span> || <span class="hljs-number">0</span>);
    fabricCanvas.<span class="hljs-title function_">requestRenderAll</span>();
    <span class="hljs-title class_">FTBgremoveStore</span>.<span class="hljs-property">changeBackgroundLoading</span> = <span class="hljs-literal">false</span>;
  });
}


</code></pre>
<h4 data-id="heading-17">优化策略</h4>
<ul>
<li>
<p>先反馈再处理：使用 <code>nextTick()</code> 让浏览器先渲染状态变化</p>
</li>
<li>
<p>拆分长任务：将耗时操作拆成多个小任务</p>
</li>
<li>
<p>使用 Web Worker：将计算密集型任务移到 Worker 线程</p>
</li>
</ul>
<hr/>
<h3 data-id="heading-18">阶段三：呈现延迟（Presentation Delay）</h3>
<p><strong>定义</strong>：从事件处理器执行完成，到浏览器完成下一次 paint（绘制）之间的时间。</p>
<p><strong>原因</strong>：浏览器渲染管道（样式计算 → 布局 → 绘制 → 合成）耗时过长，常见问题包括强制同步布局、大量重排、复杂 CSS 选择器。</p>
<h4 data-id="heading-19">优化策略</h4>
<ul>
<li>
<p>避免强制同步布局：先批量读取布局属性，再批量写入 DOM</p>
</li>
<li>
<p>减少重排重绘</p>
</li>
<li>
<p>优化 CSS 选择器：避免深层嵌套，使用类选择器</p>
</li>
</ul>
<hr/>
<h2 data-id="heading-20">INP优化核心思路</h2>
<blockquote>
<p>🎯 <strong>核心原则</strong>：<strong>让用户交互后的第一个 paint 尽快发生，把重的、非必须立即执行的工作延迟或拆分</strong>。</p>
</blockquote>
<p>这样做能让你推迟执行的任务不算在INP时间计算内</p>
<h3 data-id="heading-21">❌ 错误示范：阻塞渲染</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 来源：src/store/FTBgremoveStore.tsx - handleLoadSimplifyCanvas</span>
<span class="hljs-keyword">async</span> <span class="hljs-title function_">handleLoadSimplifyCanvas</span>(<span class="hljs-params">imgUrl, id, closeLoading = <span class="hljs-literal">true</span></span>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">cutoutLoading</span> = <span class="hljs-literal">true</span>;  <span class="hljs-comment">// 调用了，但...</span>
  
  <span class="hljs-comment">// 立即执行耗时操作，阻塞主线程</span>
  <span class="hljs-keyword">const</span> img = <span class="hljs-keyword">await</span> <span class="hljs-title function_">loadImageByUrl</span>(imgUrl);  <span class="hljs-comment">// 100ms 加载图片</span>
  <span class="hljs-keyword">await</span> <span class="hljs-title class_">FTSimpleCanvasRenderInstance</span>.<span class="hljs-title function_">uploadTop</span>(imgUrl);  <span class="hljs-comment">// 80ms 上传到画布</span>
  <span class="hljs-keyword">await</span> <span class="hljs-title class_">FTSimpleCanvasRenderInstance</span>.<span class="hljs-title function_">uploadBack</span>(page.<span class="hljs-property">backgroundColor</span>);  <span class="hljs-comment">// 50ms 设置背景</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setCurrentPage</span>({ <span class="hljs-attr">cutOriginUrl</span>: imgUrl, <span class="hljs-attr">cropImage</span>: image, ... });  <span class="hljs-comment">// 同步更新状态</span>
  
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">cutoutLoading</span> = <span class="hljs-literal">false</span>;
}


</code></pre>
<h3 data-id="heading-22">✅ 正确示范：先反馈，再干活</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { nextTick } <span class="hljs-keyword">from</span> <span class="hljs-string">'src/utils'</span>;

<span class="hljs-keyword">async</span> <span class="hljs-title function_">handleLoadSimplifyCanvas</span>(<span class="hljs-params">imgUrl, id, closeLoading = <span class="hljs-literal">true</span></span>) {
  <span class="hljs-comment">// 1. 同步更新状态</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">cutoutLoading</span> = <span class="hljs-literal">true</span>;

  <span class="hljs-comment">// 2. 关键：让出主线程，给浏览器渲染机会</span>
  <span class="hljs-keyword">await</span> <span class="hljs-title function_">nextTick</span>();  <span class="hljs-comment">// 浏览器有机会渲染 loading 状态</span>

  <span class="hljs-comment">// 3. 现在才开始执行重任务</span>
  <span class="hljs-keyword">const</span> img = <span class="hljs-keyword">await</span> <span class="hljs-title function_">loadImageByUrl</span>(imgUrl);
  <span class="hljs-keyword">await</span> <span class="hljs-title class_">FTSimpleCanvasRenderInstance</span>.<span class="hljs-title function_">uploadTop</span>(imgUrl);
  <span class="hljs-keyword">await</span> <span class="hljs-title class_">FTSimpleCanvasRenderInstance</span>.<span class="hljs-title function_">uploadBack</span>(page.<span class="hljs-property">backgroundColor</span>);
  
  <span class="hljs-comment">// 再次让出，确保状态更新能及时渲染</span>
  <span class="hljs-keyword">await</span> <span class="hljs-title function_">nextTick</span>();
  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setCurrentPage</span>({ <span class="hljs-attr">cutOriginUrl</span>: imgUrl, <span class="hljs-attr">cropImage</span>: image, ... });
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">cutoutLoading</span> = <span class="hljs-literal">false</span>;
}


</code></pre>
<p><strong>拆分和调度任务、让事件能快速响应。</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/20b8357657954e3e947f2ec77d863bc5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rWP6KeI5ZmoQVBJ6LCD55So5bel56iL5biIX1RheWxvcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771396370&amp;x-signature=2ycukGcd%2FKvHwLg26cescNignhY%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-23">工具函数：nextTick 实现</h2>
<p>项目中已经实现了优化的 <code>nextTick</code> 函数（<code>src/utils/index.ts</code>），通过让出主线程控制权，确保浏览器有机会完成渲染和响应用户交互：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">/**
 * nextTick - 将任务推迟执行，优化 INP (Interaction to Next Paint)
 *
 * 改进点：
 * 1. 优先使用 scheduler.postTask (如果可用) 来更好地控制任务优先级
 * 2. 使用 MessageChannel 确保任务在下一个事件循环执行，不阻塞渲染
 * 3. 双重 requestAnimationFrame 作为降级方案，确保 DOM 更新后执行
 *
 * <span class="hljs-doctag">@param</span> callBack 要执行的回调函数
 * <span class="hljs-doctag">@returns</span> Promise&lt;void&gt;
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">nextTick</span>(<span class="hljs-params">callBack?: () =&gt; <span class="hljs-keyword">void</span></span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-keyword">void</span>&gt;(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> {
    <span class="hljs-comment">// 优先使用 scheduler.postTask (Chrome 94+, 更好的任务调度)</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> (<span class="hljs-variable language_">window</span> <span class="hljs-keyword">as</span> any).<span class="hljs-property">scheduler</span> !== <span class="hljs-string">'undefined'</span> &amp;&amp; (<span class="hljs-variable language_">window</span> <span class="hljs-keyword">as</span> any).<span class="hljs-property">scheduler</span>.<span class="hljs-property">postTask</span>) {
      (<span class="hljs-variable language_">window</span> <span class="hljs-keyword">as</span> any).<span class="hljs-property">scheduler</span>.<span class="hljs-title function_">postTask</span>(<span class="hljs-function">() =&gt;</span> {
        callBack?.();
        <span class="hljs-title function_">resolve</span>();
      }, { <span class="hljs-attr">priority</span>: <span class="hljs-string">'user-blocking'</span> });
      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-comment">// 使用 MessageChannel 确保在下一个事件循环执行，不阻塞渲染</span>
    <span class="hljs-comment">// 这对于 INP 优化很重要，因为它让浏览器有机会处理用户交互</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-title class_">MessageChannel</span> !== <span class="hljs-string">'undefined'</span>) {
      <span class="hljs-keyword">const</span> channel = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MessageChannel</span>();
      channel.<span class="hljs-property">port1</span>.<span class="hljs-property">onmessage</span> = <span class="hljs-function">() =&gt;</span> {
        callBack?.();
        <span class="hljs-title function_">resolve</span>();
      };
      channel.<span class="hljs-property">port2</span>.<span class="hljs-title function_">postMessage</span>(<span class="hljs-literal">null</span>);
      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-comment">// 降级方案：双重 requestAnimationFrame</span>
    <span class="hljs-comment">// 第一个 rAF 确保在浏览器重绘之前，第二个 rAF 确保在重绘之后</span>
    <span class="hljs-comment">// 这样可以确保 DOM 更新已经完成</span>
    <span class="hljs-keyword">if</span> (requestAnimationFrame) {
      <span class="hljs-title function_">requestAnimationFrame</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-title function_">requestAnimationFrame</span>(<span class="hljs-function">() =&gt;</span> {
          callBack?.();
          <span class="hljs-title function_">resolve</span>();
        });
      });
      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-comment">// 最后的降级方案</span>
    <span class="hljs-keyword">if</span> (setImmediate) {
      <span class="hljs-title function_">setImmediate</span>(<span class="hljs-function">() =&gt;</span> {
        callBack?.();
        <span class="hljs-title function_">resolve</span>();
      });
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
        callBack?.();
        <span class="hljs-title function_">resolve</span>();
      }, <span class="hljs-number">0</span>);
    }
  });
}


</code></pre>
<h3 data-id="heading-24">使用示例</h3>
<p>使用 <code>nextTick()</code> 主动让步。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 使用项目中的 nextTick 函数</span>
<span class="hljs-keyword">import</span> { nextTick } <span class="hljs-keyword">from</span> <span class="hljs-string">'src/utils'</span>;

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">processHeavyCanvas</span>(<span class="hljs-params"/>) {
  <span class="hljs-title function_">doLightWork</span>();
  
  <span class="hljs-comment">// 让浏览器有机会处理待渲染的帧和用户交互</span>
  <span class="hljs-keyword">await</span> <span class="hljs-title function_">nextTick</span>();
  <span class="hljs-comment">// 这样doHeavyWork会被拆分成单独任务延迟执行</span>
  <span class="hljs-title function_">doHeavyWork</span>();
}


</code></pre>
<h3 data-id="heading-25">为什么选择这些 API？</h3>






























<table><thead><tr><th>API</th><th>优点</th><th>兼容性</th></tr></thead><tbody><tr><td><code>scheduler.postTask</code></td><td>支持优先级控制，专为任务调度设计</td><td>Chrome 94+</td></tr><tr><td><code>MessageChannel</code></td><td>宏任务，确保在渲染后执行</td><td>广泛支持</td></tr><tr><td>双重 <code>rAF</code></td><td>确保在下一帧渲染完成后执行</td><td>广泛支持</td></tr><tr><td><code>setTimeout(0)</code></td><td>最终兜底方案</td><td>全平台</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-26">实战检测与调试</h2>
<h3 data-id="heading-27">使用 Chrome DevTools 分析 INP</h3>
<p>cpu 4 - 6倍降速，模拟低性能设备。 对比本地和线上</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f1b7101b35d0435eb70f3e1f4e2c87b4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rWP6KeI5ZmoQVBJ6LCD55So5bel56iL5biIX1RheWxvcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771396370&amp;x-signature=t7A02hpLoSso1HajyRFaokKah5M%3D" alt="image.png" loading="lazy"/></p>
<p>点点功能，观察<code>Performace</code>面板实时的INP</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f1dd8810e3714d6cac92f90cd87f4f77~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rWP6KeI5ZmoQVBJ6LCD55So5bel56iL5biIX1RheWxvcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771396370&amp;x-signature=ZN9t0qiW%2Fa%2Fb3mWsVnzfyAysNs4%3D" alt="image.png" loading="lazy"/></p>
<p>每次交互的实时INP都会记录在这里。
多点点自己的项目，顺着INP变高的那一步操作找问题即可。</p>
<h3 data-id="heading-28">使用 Web Vitals 库监控</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { onINP } <span class="hljs-keyword">from</span> <span class="hljs-string">'web-vitals'</span>;

<span class="hljs-title function_">onINP</span>(<span class="hljs-function">(<span class="hljs-params">metric</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'INP:'</span>, metric.<span class="hljs-property">value</span>);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Entries:'</span>, metric.<span class="hljs-property">entries</span>);
  
  <span class="hljs-comment">// 上报到分析平台</span>
  <span class="hljs-keyword">if</span> (metric.<span class="hljs-property">value</span> &gt; <span class="hljs-number">200</span>) {
    analytics.<span class="hljs-title function_">track</span>(<span class="hljs-string">'slow_interaction'</span>, {
      <span class="hljs-attr">value</span>: metric.<span class="hljs-property">value</span>,
      <span class="hljs-attr">entries</span>: metric.<span class="hljs-property">entries</span>,
      <span class="hljs-attr">target</span>: metric.<span class="hljs-property">entries</span>[<span class="hljs-number">0</span>]?.<span class="hljs-property">target</span>,
    });
  }
});


</code></pre>
<h3 data-id="heading-29">分析线上用户真实指标</h3>
<p>查看线上真实用户指标</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fpagespeed.web.dev%2F" target="_blank" title="https://pagespeed.web.dev/" ref="nofollow noopener noreferrer">pagespeed.web.dev/</a></p>
<p>Chrome 用户体验报告(crux)</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fcruxvis.withgoogle.com%2F" target="_blank" title="https://cruxvis.withgoogle.com/" ref="nofollow noopener noreferrer">cruxvis.withgoogle.com/</a></p>
<hr/>
<h2 data-id="heading-30">总结</h2>
<h3 data-id="heading-31">核心要点</h3>
<ol>
<li>
<p><strong>INP 测量三个阶段</strong>：输入延迟、事件处理、呈现延迟</p>
</li>
<li>
<p><strong>优化目标</strong>：确保 75% 的交互在 200ms 内完成</p>
</li>
<li>
<p><strong>核心策略</strong>：先反馈，再处理；拆分长任务；让出主线程</p>
</li>
<li>
<p><strong>工具支持</strong>：使用 <code>nextTick</code>、<code>scheduler.yield()</code>、Web Worker</p>
</li>
<li>
<p><strong>真实用户INP观察</strong>: crux查看用户真实INP变化，持续优化。</p>
</li>
</ol>
<blockquote>
<p><strong>INP 优化的本质是：让用户"感觉"交互是即时响应的，哪怕后台还在默默干活。</strong></p>
</blockquote>
<p><strong>参考资料</strong>：</p>
<ul>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fweb.dev%2Finp%2F" target="_blank" title="https://web.dev/inp/" ref="nofollow noopener noreferrer">Web.dev - INP</a></p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.chrome.com%2Fdocs%2Fdevtools%2Fperformance%2F" target="_blank" title="https://developer.chrome.com/docs/devtools/performance/" ref="nofollow noopener noreferrer">Chrome DevTools Performance</a></p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fweb.dev%2Fvitals%2F" target="_blank" title="https://web.dev/vitals/" ref="nofollow noopener noreferrer">Web Vitals</a></p>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Swift 并发编程深度解析：从 async/await 到智能调度]]></title>    <link>https://juejin.cn/post/7605164560711401498</link>    <guid>https://juejin.cn/post/7605164560711401498</guid>    <pubDate>2026-02-11T06:23:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605164560711401498" data-draft-id="7605041556657127433" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Swift 并发编程深度解析：从 async/await 到智能调度"/> <meta itemprop="keywords" content="Swift"/> <meta itemprop="datePublished" content="2026-02-11T06:23:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="sweet丶"/> <meta itemprop="url" content="https://juejin.cn/user/3227821869921646"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Swift 并发编程深度解析：从 async/await 到智能调度
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3227821869921646/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    sweet丶
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-11T06:23:21.000Z" title="Wed Feb 11 2026 06:23:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>深入理解 Swift 5.5+ 的现代并发模型，掌握如何编写安全高效的多线程代码</p>
</blockquote>
<hr/>
<h2 data-id="heading-0">引言：为什么需要新的并发模型？</h2>
<p>在传统 iOS/macOS 开发中，我们使用 GCD（Grand Central Dispatch）或 OperationQueue 来处理并发任务。然而，这些技术存在一些痛点：</p>
<ol>
<li><strong>回调地狱</strong>：多层嵌套的回调难以阅读和维护</li>
<li><strong>手动内存管理</strong>：容易忘记 weak self 导致内存泄漏</li>
<li><strong>线程爆炸</strong>：过度创建线程消耗系统资源</li>
<li><strong>数据竞争</strong>：共享状态需要手动加锁，容易出错</li>
</ol>
<p>Swift 5.5 引入的 async/await 和结构化并发解决了这些问题，提供了更安全、更简洁的并发编程方式，iOS 13以上是支持的。</p>
<hr/>
<h2 data-id="heading-1">第一部分：async/await 基础语法</h2>
<h3 data-id="heading-2">1.1 异步函数声明</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 传统回调方式</span>
<span class="hljs-keyword">func</span> <span class="hljs-title function_">fetchUser</span>(<span class="hljs-params">completion</span>: <span class="hljs-keyword">@escaping</span> (<span class="hljs-type">Result</span>&lt;<span class="hljs-type">User</span>, <span class="hljs-type">Error</span>&gt;) -&gt; <span class="hljs-type">Void</span>)

<span class="hljs-comment">// 异步函数方式</span>
<span class="hljs-keyword">func</span> <span class="hljs-title function_">fetchUser</span>() <span class="hljs-keyword">async</span> <span class="hljs-keyword">throws</span> -&gt; <span class="hljs-type">User</span>
</code></pre>
<h3 data-id="heading-3">1.2 异步函数调用</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 使用 await 调用异步函数</span>
<span class="hljs-keyword">do</span> {
    <span class="hljs-keyword">let</span> user <span class="hljs-operator">=</span> <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> fetchUser()
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"用户: <span class="hljs-subst">\(user.name)</span>"</span>)
} <span class="hljs-keyword">catch</span> {
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"错误: <span class="hljs-subst">\(error)</span>"</span>)
}
</code></pre>
<hr/>
<h2 data-id="heading-4">第二部分：async let 与结构化并发</h2>
<h3 data-id="heading-5">2.1 并发启动多个任务</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 同时启动多个异步任务</span>
<span class="hljs-keyword">func</span> <span class="hljs-title function_">loadDashboard</span>() <span class="hljs-keyword">async</span> <span class="hljs-keyword">throws</span> -&gt; <span class="hljs-type">Dashboard</span> {
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">let</span> user <span class="hljs-operator">=</span> fetchUser()          <span class="hljs-comment">// 立即开始</span>
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">let</span> orders <span class="hljs-operator">=</span> fetchOrders()      <span class="hljs-comment">// 立即开始</span>
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">let</span> messages <span class="hljs-operator">=</span> fetchMessages()  <span class="hljs-comment">// 立即开始</span>
    
    <span class="hljs-comment">// 等待所有任务完成</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> <span class="hljs-type">Dashboard</span>(
        user: user,
        orders: orders,
        messages: messages
    )
}
</code></pre>
<h3 data-id="heading-6">2.2 与顺序执行的对比</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 并发执行（总耗时 ≈ 最慢的任务）</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">let</span> a <span class="hljs-operator">=</span> taskA()  <span class="hljs-comment">// 0-1秒</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">let</span> b <span class="hljs-operator">=</span> taskB()  <span class="hljs-comment">// 0-2秒</span>
<span class="hljs-keyword">let</span> results <span class="hljs-operator">=</span> <span class="hljs-keyword">await</span> (a, b)  <span class="hljs-comment">// 总耗时: 2秒</span>

<span class="hljs-comment">// 顺序执行（总耗时 = 所有任务时间之和）</span>
<span class="hljs-keyword">let</span> a <span class="hljs-operator">=</span> <span class="hljs-keyword">await</span> taskA()  <span class="hljs-comment">// 0-1秒</span>
<span class="hljs-keyword">let</span> b <span class="hljs-operator">=</span> <span class="hljs-keyword">await</span> taskB()  <span class="hljs-comment">// 1-3秒（等A完成后才开始）</span>
<span class="hljs-comment">// 总耗时: 3秒</span>
</code></pre>
<h3 data-id="heading-7">2.3 重要概念澄清</h3>
<p><strong>Q: <code>async let user = fetchUser()</code> 立即返回什么？</strong>
A: 它不立即返回数据，而是返回一个<strong>异步任务句柄</strong>。实际数据在 <code>await</code> 时获取。</p>
<p><strong>Q: 多个 <code>async let</code> 相当于 GCD 的异步任务吗？</strong>
A: 相似但有重要区别。<code>async let</code> 是结构化并发的一部分，任务生命周期自动管理，支持取消和错误传播。</p>
<hr/>
<h2 data-id="heading-8">第三部分：数据安全与线程调度</h2>
<h3 data-id="heading-9">3.1 数据竞争的解决方案</h3>
<h4 data-id="heading-10">方案一：使用 Actor（银行柜台模型）</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">actor</span> <span class="hljs-title class_">UserCache</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> storage: [<span class="hljs-type">String</span>: <span class="hljs-type">User</span>] <span class="hljs-operator">=</span> [:]
    
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">getUser</span>(<span class="hljs-params">id</span>: <span class="hljs-type">String</span>) -&gt; <span class="hljs-type">User</span>? {
        <span class="hljs-keyword">return</span> storage[id]
    }
    
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">setUser</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">user</span>: <span class="hljs-type">User</span>, <span class="hljs-params">for</span> <span class="hljs-params">id</span>: <span class="hljs-type">String</span>) {
        storage[id] <span class="hljs-operator">=</span> user
    }
}

<span class="hljs-comment">// 使用时自动序列化访问</span>
<span class="hljs-keyword">let</span> cache <span class="hljs-operator">=</span> <span class="hljs-type">UserCache</span>()
<span class="hljs-keyword">let</span> user <span class="hljs-operator">=</span> <span class="hljs-keyword">await</span> cache.getUser(id: <span class="hljs-string">"123"</span>)  <span class="hljs-comment">// 自动排队等待</span>
</code></pre>
<p><strong>原理</strong>：编译器强制同一时间只有一个任务能访问 Actor 内部状态，通过消息传递模型确保安全。</p>
<h4 data-id="heading-11">方案二：使用值语义（发复印件模型）</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">UserProfile</span> {
    <span class="hljs-keyword">let</span> user: <span class="hljs-type">User</span>
    <span class="hljs-keyword">var</span> settings: <span class="hljs-type">Settings</span>
    <span class="hljs-comment">// 结构体是值类型，复制安全</span>
}

<span class="hljs-keyword">func</span> <span class="hljs-title function_">processProfile</span>(<span class="hljs-params">profile</span>: <span class="hljs-type">UserProfile</span>) <span class="hljs-keyword">async</span> {
    <span class="hljs-comment">// 每个任务获取独立的副本</span>
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">let</span> task1 <span class="hljs-operator">=</span> {
        <span class="hljs-keyword">var</span> copy <span class="hljs-operator">=</span> profile
        copy.settings.theme <span class="hljs-operator">=</span> .dark
        <span class="hljs-keyword">return</span> copy
    }()
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">let</span> task2 <span class="hljs-operator">=</span> {
        <span class="hljs-keyword">var</span> copy <span class="hljs-operator">=</span> profile
        copy.settings.fontSize <span class="hljs-operator">=</span> <span class="hljs-number">16</span>
        <span class="hljs-keyword">return</span> copy
    }()
    
    <span class="hljs-keyword">let</span> results <span class="hljs-operator">=</span> <span class="hljs-keyword">await</span> (task1, task2)  <span class="hljs-comment">// 独立修改，互不影响</span>
}
</code></pre>
<p><strong>原理</strong>：通过复制而非共享，从根本上消除数据竞争的可能性。</p>
<h3 data-id="heading-12">3.2 智能线程调度</h3>
<p><strong>Q: <code>async let</code> 任务在哪个线程执行？</strong>
A: Swift 并发运行时<strong>智能决定</strong>，基于以下因素：</p>
<ol>
<li><strong>当前线程负载</strong> - 太忙就调度到其他线程</li>
<li><strong>任务类型</strong> - I/O密集型 vs CPU密集型</li>
<li><strong>优先级</strong> - 高优先级任务可能更快执行</li>
<li><strong>硬件资源</strong> - CPU核心数、当前负载</li>
<li><strong>执行器约束</strong> - 如 <code>@MainActor</code> 强制主线程</li>
</ol>
<p><strong>智能调度的具体表现：</strong></p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-meta">@MainActor</span>
<span class="hljs-keyword">func</span> <span class="hljs-title function_">updateUIWithData</span>() <span class="hljs-keyword">async</span> {
    <span class="hljs-comment">// 从主线程调用，但会自动优化</span>
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">let</span> data <span class="hljs-operator">=</span> fetchHeavyData()  <span class="hljs-comment">// 运行时：这个会阻塞 → 调度到后台线程</span>
    
    <span class="hljs-keyword">let</span> processed <span class="hljs-operator">=</span> <span class="hljs-keyword">await</span> process(data)  <span class="hljs-comment">// 可能在后台线程继续处理</span>
    
    <span class="hljs-comment">// 更新UI时自动回到主线程</span>
    <span class="hljs-keyword">self</span>.label.text <span class="hljs-operator">=</span> processed.title
}
</code></pre>
<h3 data-id="heading-13">3.3 什么时候需要显式控制线程？</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 1. UI操作必须主线程</span>
<span class="hljs-meta">@MainActor</span>
<span class="hljs-keyword">func</span> <span class="hljs-title function_">updateUI</span>() {
    <span class="hljs-comment">// 编译时确保在主线程</span>
}

<span class="hljs-comment">// 2. CPU密集型长时间计算</span>
<span class="hljs-keyword">func</span> <span class="hljs-title function_">processImage</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">image</span>: <span class="hljs-type">UIImage</span>) <span class="hljs-keyword">async</span> -&gt; <span class="hljs-type">UIImage</span> {
    <span class="hljs-comment">// 明确指定在独立线程执行</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-type">Task</span>.detached {
        <span class="hljs-keyword">return</span> image.applyFilters()  <span class="hljs-comment">// 耗时的图像处理</span>
    }.value
}

<span class="hljs-comment">// 3. 不应该干预的案例</span>
<span class="hljs-comment">// ❌ 不要这样：破坏了智能调度</span>
<span class="hljs-type">Task</span> {
    <span class="hljs-type">DispatchQueue</span>.global().async {
        <span class="hljs-keyword">await</span> someAsyncWork()
    }
}

<span class="hljs-comment">// ✅ 应该这样：信任运行时</span>
<span class="hljs-type">Task</span> {
    <span class="hljs-keyword">await</span> someAsyncWork()  <span class="hljs-comment">// 让系统决定最佳执行方式</span>
}
</code></pre>
<hr/>
<h2 data-id="heading-14">第四部分：实际应用模式</h2>
<h3 data-id="heading-15">4.1 网络请求组合</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">loadFullProfile</span>(<span class="hljs-params">userId</span>: <span class="hljs-type">String</span>) <span class="hljs-keyword">async</span> <span class="hljs-keyword">throws</span> -&gt; <span class="hljs-type">FullProfile</span> {
        <span class="hljs-comment">// 并发获取所有数据</span>
        <span class="hljs-keyword">async</span> <span class="hljs-keyword">let</span> userInfo <span class="hljs-operator">=</span> fetchUserInfo(userId)
        <span class="hljs-keyword">async</span> <span class="hljs-keyword">let</span> posts <span class="hljs-operator">=</span> fetchUserPosts(userId)
        <span class="hljs-keyword">async</span> <span class="hljs-keyword">let</span> friends <span class="hljs-operator">=</span> fetchUserFriends(userId)
        <span class="hljs-keyword">async</span> <span class="hljs-keyword">let</span> preferences <span class="hljs-operator">=</span> fetchUserPreferences(userId)
        
        <span class="hljs-comment">// 等待所有结果</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> <span class="hljs-type">FullProfile</span>(
            info: userInfo,
            posts: posts,
            friends: friends,
            preferences: preferences
        )
    }
    
    <span class="hljs-comment">// 对比传统回调方式</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">loadFullProfileOld</span>(<span class="hljs-params">userId</span>: <span class="hljs-type">String</span>, 
                           <span class="hljs-params">completion</span>: <span class="hljs-keyword">@escaping</span> (<span class="hljs-type">Result</span>&lt;<span class="hljs-type">FullProfile</span>, <span class="hljs-type">Error</span>&gt;) -&gt; <span class="hljs-type">Void</span>) {
        fetchUserInfo(userId) { result1 <span class="hljs-keyword">in</span>
            <span class="hljs-keyword">switch</span> result1 {
            <span class="hljs-keyword">case</span> .success(<span class="hljs-keyword">let</span> userInfo):
                <span class="hljs-keyword">self</span>.fetchUserPosts(userId) { result2 <span class="hljs-keyword">in</span>
                    <span class="hljs-keyword">switch</span> result2 {
                    <span class="hljs-keyword">case</span> .success(<span class="hljs-keyword">let</span> posts):
                        <span class="hljs-comment">// 更多嵌套...</span>
                    <span class="hljs-keyword">case</span> .failure(<span class="hljs-keyword">let</span> error):
                        completion(.failure(error))
                    }
                }
            <span class="hljs-keyword">case</span> .failure(<span class="hljs-keyword">let</span> error):
                completion(.failure(error))
            }
        }
    }
}
</code></pre>
<h3 data-id="heading-16">4.2 限制并发数量</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">func</span> <span class="hljs-title function_">downloadMultipleFiles</span>(<span class="hljs-params">urls</span>: [<span class="hljs-type">URL</span>], <span class="hljs-params">maxConcurrent</span>: <span class="hljs-type">Int</span> <span class="hljs-operator">=</span> <span class="hljs-number">4</span>) <span class="hljs-keyword">async</span> <span class="hljs-keyword">throws</span> -&gt; [<span class="hljs-type">Data</span>] {
    <span class="hljs-comment">// 使用 TaskGroup 控制并发数</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> withThrowingTaskGroup(of: <span class="hljs-type">Data</span>.<span class="hljs-keyword">self</span>) { group <span class="hljs-keyword">in</span>
        <span class="hljs-keyword">var</span> results: [<span class="hljs-type">Data</span>] <span class="hljs-operator">=</span> []
        results.reserveCapacity(urls.count)
        
        <span class="hljs-comment">// 分批处理，限制并发数</span>
        <span class="hljs-keyword">for</span> index <span class="hljs-keyword">in</span> urls.indices {
            <span class="hljs-keyword">if</span> group.taskCount <span class="hljs-operator">&gt;=</span> maxConcurrent {
                <span class="hljs-comment">// 等待一个任务完成再添加新的</span>
                <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> result <span class="hljs-operator">=</span> <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> group.next() {
                    results.append(result)
                }
            }
            
            group.addTask {
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> downloadFile(from: urls[index])
            }
        }
        
        <span class="hljs-comment">// 收集剩余结果</span>
        <span class="hljs-keyword">for</span> <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> result <span class="hljs-keyword">in</span> group {
            results.append(result)
        }
        
        <span class="hljs-keyword">return</span> results
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-17">第五部分：与系统框架的集成</h2>
<h3 data-id="heading-18">5.1 iOS 13+ 的系统 API 更新</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// iOS 13+ 提供了异步版本的 openURL</span>
<span class="hljs-keyword">func</span> <span class="hljs-title function_">openSettings</span>() <span class="hljs-keyword">async</span> -&gt; <span class="hljs-type">Bool</span> {
    <span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> url <span class="hljs-operator">=</span> <span class="hljs-type">URL</span>(string: <span class="hljs-type">UIApplication</span>.openSettingsURLString) <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
    }
    
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-type">UIApplication</span>.shared.open(url)
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-type">Task</span> {
    <span class="hljs-keyword">let</span> success <span class="hljs-operator">=</span> <span class="hljs-keyword">await</span> openSettings()
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"设置应用打开<span class="hljs-subst">\(success <span class="hljs-operator">?</span> <span class="hljs-string">"成功"</span> : <span class="hljs-string">"失败"</span>)</span>"</span>)
}

<span class="hljs-comment">// 为什么使用Task？</span>
<span class="hljs-comment">// ❌ 错误：不能在同步函数中直接使用 await</span>
<span class="hljs-keyword">func</span> <span class="hljs-title function_">buttonTapped</span>() {
    <span class="hljs-keyword">let</span> success <span class="hljs-operator">=</span> <span class="hljs-keyword">await</span> openSettings()  <span class="hljs-comment">// 编译错误！</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"结果: <span class="hljs-subst">\(success)</span>"</span>)
}

<span class="hljs-comment">// ✅ 正确：需要 Task 包装</span>
<span class="hljs-keyword">func</span> <span class="hljs-title function_">buttonTapped</span>() {
    <span class="hljs-type">Task</span> {  <span class="hljs-comment">// 创建异步执行环境</span>
        <span class="hljs-keyword">let</span> success <span class="hljs-operator">=</span> <span class="hljs-keyword">await</span> openSettings()
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"结果: <span class="hljs-subst">\(success)</span>"</span>)
    }
}
</code></pre>
<h3 data-id="heading-19">5.2 适配旧版本系统</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 为 iOS 13+ 提供兼容方案</span>
<span class="hljs-keyword">func</span> <span class="hljs-title function_">openURL</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">url</span>: <span class="hljs-type">URL</span>) <span class="hljs-keyword">async</span> -&gt; <span class="hljs-type">Bool</span> {
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">#available</span>(<span class="hljs-keyword">iOS</span> <span class="hljs-number">13.0</span>, <span class="hljs-operator">*</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-type">UIApplication</span>.shared.open(url)
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 使用 continuation 桥接到 async/await</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> withCheckedContinuation { continuation <span class="hljs-keyword">in</span>
            <span class="hljs-type">UIApplication</span>.shared.open(url) { success <span class="hljs-keyword">in</span>
                continuation.resume(returning: success)
            }
        }
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-20">第六部分：最佳实践总结</h2>
<h3 data-id="heading-21">6.1 代码组织原则</h3>
<ol>
<li><strong>优先使用 async/await</strong> 替代回调</li>
<li><strong>合理使用 async let</strong> 进行并发，但注意数量控制</li>
<li><strong>使用 Actor 保护共享状态</strong>，避免手动锁</li>
<li><strong>尽量使用值类型</strong>，减少共享可变状态</li>
</ol>
<h3 data-id="heading-22">6.2 架构设计建议</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 推荐的层次结构：</span>
<span class="hljs-comment">// UI层 (@MainActor) - 处理用户交互和界面更新</span>
<span class="hljs-comment">// 业务层 (混合) - 协调数据流，处理业务逻辑</span>
<span class="hljs-comment">// 数据层 (async/await) - 网络请求、数据库操作</span>
<span class="hljs-comment">// 工具层 (值类型) - 纯函数计算、数据处理</span>

<span class="hljs-meta">@MainActor</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ViewController</span>: <span class="hljs-title class_">UIViewController</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">let</span> viewModel: <span class="hljs-type">UserViewModel</span>
    
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">loadData</span>() <span class="hljs-keyword">async</span> {
        <span class="hljs-keyword">await</span> viewModel.loadUserData()
        updateUI()
    }
}

<span class="hljs-keyword">actor</span> <span class="hljs-title class_">UserViewModel</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">let</span> repository: <span class="hljs-type">UserRepository</span>
    
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">loadUserData</span>() <span class="hljs-keyword">async</span> {
        <span class="hljs-keyword">let</span> user <span class="hljs-operator">=</span> <span class="hljs-keyword">await</span> repository.fetchUser()
        <span class="hljs-comment">// 处理业务逻辑</span>
    }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserRepository</span> {
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">fetchUser</span>() <span class="hljs-keyword">async</span> <span class="hljs-keyword">throws</span> -&gt; <span class="hljs-type">User</span> {
        <span class="hljs-comment">// 数据层操作</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> apiClient.fetchUser()
    }
}
</code></pre>
<h2 data-id="heading-23">第七部分：内部原理机制</h2>
<p>Swift的async/await基于协程实现：
技术关系：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 1个线程上可以运行多个协程</span>
<span class="hljs-title class_">Thread</span> <span class="hljs-attr">A</span>: [协程<span class="hljs-number">1</span>运行] → [协程<span class="hljs-number">2</span>运行] → [协程<span class="hljs-number">1</span>恢复] → [协程<span class="hljs-number">3</span>运行]
                ↑           ↑           ↑           ↑
           遇到<span class="hljs-keyword">await</span>挂起 遇到<span class="hljs-keyword">await</span>挂起 结果返回恢复 遇到<span class="hljs-keyword">await</span>挂起

<span class="hljs-comment">// 协程在挂起时释放线程，让其他协程使用</span>

<span class="hljs-comment">// 传统线程 vs 协程</span>

<span class="hljs-comment">// 线程：操作系统调度，上下文切换成本高</span>
<span class="hljs-title class_">Thread</span> <span class="hljs-number">1</span>: [运行] → [阻塞等待I/O] → [运行]
<span class="hljs-title class_">Thread</span> <span class="hljs-number">2</span>: [等待] → [运行] → [等待]

<span class="hljs-comment">// 协程：用户态调度，轻量级</span>
协程 <span class="hljs-attr">A</span>: [运行] → [挂起] → [运行]
协程 <span class="hljs-attr">B</span>:     [运行] → [挂起]
<span class="hljs-comment">// 在同一线程上交替执行，没有线程切换开销</span>
</code></pre>
<p>结合实际代码说明：</p>
<pre><code class="hljs language-Swift" lang="Swift"><span class="hljs-comment">// 规则1：一个协程必须在一个线程上运行</span>
<span class="hljs-comment">// 规则2：协程只能在特定点挂起（await处）</span>
<span class="hljs-comment">// 规则3：挂起的协程不占用线程</span>

<span class="hljs-comment">// 示例：</span>
<span class="hljs-keyword">func</span> <span class="hljs-title function_">fetchMultipleResources</span>() <span class="hljs-keyword">async</span> {
    <span class="hljs-comment">// 开始：在主线程运行（如果从@MainActor调用）</span>
    
    <span class="hljs-keyword">let</span> data1 <span class="hljs-operator">=</span> <span class="hljs-keyword">await</span> fetchData()  <span class="hljs-comment">// 挂起点1</span>
    <span class="hljs-comment">// 挂起：释放主线程，其他协程可用</span>
    
    <span class="hljs-comment">// 恢复：可能在任意线程（不一定是主线程）</span>
    process(data1)  <span class="hljs-comment">// 在某个后台线程执行</span>
    
    <span class="hljs-keyword">let</span> data2 <span class="hljs-operator">=</span> <span class="hljs-keyword">await</span> fetchData()  <span class="hljs-comment">// 挂起点2</span>
    <span class="hljs-comment">// 再次挂起...</span>
    
    <span class="hljs-comment">// 最后如果需要更新UI，要确保在主线程</span>
    <span class="hljs-keyword">await</span> <span class="hljs-type">MainActor</span>.run {
        updateUI(data1, data2)
    }
}
</code></pre>
<h2 data-id="heading-24">结语</h2>
<p>Swift 的现代并发模型代表了并发编程的范式转变：</p>
<ol>
<li><strong>从手动调度到智能调度</strong> - 信任运行时做出最优决策</li>
<li><strong>从回调地狱到线性代码</strong> - 使用 async/await 简化异步流程</li>
<li><strong>从容易出错到内存安全</strong> - 通过 Actor 和值语义避免数据竞争</li>
<li><strong>从复杂管理到结构化</strong> - 自动处理任务生命周期和取消</li>
</ol>
<p>虽然学习曲线比 GCD 更陡峭，但一旦掌握，你将能编写出更安全、更简洁、更高效的并发代码。</p>
<hr/>
<p><strong>进一步学习资源：</strong></p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.swift.org%2Fswift-book%2FLanguageGuide%2FConcurrency.html" target="_blank" title="https://docs.swift.org/swift-book/LanguageGuide/Concurrency.html" ref="nofollow noopener noreferrer">Swift 官方并发指南</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.apple.com%2Fvideos%2Fplay%2Fwwdc2021%2F10132%2F" target="_blank" title="https://developer.apple.com/videos/play/wwdc2021/10132/" ref="nofollow noopener noreferrer">Apple 的 Swift 并发视频系列</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fapple%2Fswift-evolution%2Fblob%2Fmain%2Fproposals%2F0296-async-await.md" target="_blank" title="https://github.com/apple/swift-evolution/blob/main/proposals/0296-async-await.md" ref="nofollow noopener noreferrer">Swift 并发设计模式</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AgentTeams 与 Subagents：多智能体系统的最佳实践]]></title>    <link>https://juejin.cn/post/7605164560711073818</link>    <guid>https://juejin.cn/post/7605164560711073818</guid>    <pubDate>2026-02-11T05:47:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605164560711073818" data-draft-id="7605164560711024666" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AgentTeams 与 Subagents：多智能体系统的最佳实践"/> <meta itemprop="keywords" content="AI编程,Claude"/> <meta itemprop="datePublished" content="2026-02-11T05:47:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小碗细面"/> <meta itemprop="url" content="https://juejin.cn/user/1618104611770958"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AgentTeams 与 Subagents：多智能体系统的最佳实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1618104611770958/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小碗细面
  </span> <!----> <!----> <div class="vip-level" data-v-cd7d0a50="" data-v-292f6e48=""><span class="tooltip" data-v-cd7d0a50=""><div class="byte-tooltip byte-tooltip--dark" style="display:none;">
        VIP.5 如鱼得水
      </div><span class="byte-tooltip__wrapper"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8AQMAAAAAMksxAAAAA1BMVEUAAACnej3aAAAAAXRSTlMAQObYZgAAAA5JREFUKM9jGAWjAAcAAAIcAAE27nY6AAAAAElFTkSuQmCC" alt="VIP.5 如鱼得水" title="VIP.5 如鱼得水" class="lazy" style="aspect-ratio:NaN;" data-v-5244ef91="" data-v-cd7d0a50=""/></span></span></div> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-11T05:47:40.000Z" title="Wed Feb 11 2026 05:47:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="vs2015">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#1e1e1e;color:#dcdcdc}.hljs-keyword,.hljs-link,.hljs-literal,.hljs-name,.hljs-symbol{color:#569cd6}.hljs-link{text-decoration:underline}.hljs-built_in,.hljs-type{color:#4ec9b0}.hljs-class,.hljs-number{color:#b8d7a3}.hljs-meta-string,.hljs-string{color:#d69d85}.hljs-regexp,.hljs-template-tag{color:#9a5334}.hljs-formula,.hljs-function,.hljs-params,.hljs-subst,.hljs-title{color:#dcdcdc}.hljs-comment,.hljs-quote{color:#57a64a;font-style:italic}.hljs-doctag{color:#608b4e}.hljs-meta,.hljs-meta-keyword,.hljs-tag{color:#9b9b9b}.hljs-template-variable,.hljs-variable{color:#bd63c5}.hljs-attr,.hljs-attribute,.hljs-builtin-name{color:#9cdcfe}.hljs-section{color:gold}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-bullet,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-id,.hljs-selector-pseudo,.hljs-selector-tag{color:#d7ba7d}.hljs-addition{background-color:#144212}.hljs-addition,.hljs-deletion{display:inline-block;width:100%}.hljs-deletion{background-color:#600}</style><h2 data-id="heading-0">AgentTeams 与 Subagents：多智能体系统的最佳实践</h2>
<blockquote>
<p>原创技术文章，首发于掘金
作者：Asher | 阅读时间：10 分钟 | 难度：中级</p>
</blockquote>
<h3 data-id="heading-1">前言</h3>
<p>随着大语言模型（LLM）技术的快速发展，<strong>AI Agent</strong> 正在从单一智能体向<strong>多智能体协作系统</strong>演进。在实际应用中，我们经常面临这样的问题：</p>
<ul>
<li>什么时候应该用多个 Agent 协作？什么时候用单个 Agent 就够了？</li>
<li>AgentTeams 和 Subagents 有什么本质区别？如何正确选择？</li>
<li>如何设计高效的多智能体系统？有哪些最佳实践？</li>
</ul>
<p>本文基于 BMAD（Build, Monitor, Analyze, Deploy）框架的实战经验，深入解析 <strong>AgentTeams</strong> 和 <strong>Subagents</strong> 的核心差异、使用方法和应用场景，并提供一套完整的设计决策框架。</p>
<hr/>
<h3 data-id="heading-2">一、核心概念：什么是 AgentTeams 和 Subagents？</h3>
<h4 data-id="heading-3">1.1 AgentTeams：协作型智能体团队</h4>
<p><strong>AgentTeams（智能体团队）</strong> 是由多个<strong>具有独立人格、专业领域和沟通风格</strong>的 Agent 组成的协作系统。它们通过一个**协调器（Orchestrator）**来管理对话流程，实现自然的多智能体讨论。</p>
<p><strong>核心特征：</strong></p>
<pre><code class="hljs">🎭 独立人格  每个 Agent 有独特的个性、说话方式和专业视角
🎯 专业分工  不同 Agent 负责不同领域（分析师、架构师、设计师等）
🔄 对话协作  Agent 之间可以相互对话、辩论、补充
🧠 集体智慧  通过多视角碰撞产生超越单 Agent 的洞见
</code></pre>
<p><strong>架构示意：</strong></p>
<pre><code class="hljs language-markdown" lang="markdown">用户请求
<span class="hljs-code">    ↓
┌─────────────────────────────┐
│   Orchestrator (协调器)    │
│  - 理解用户意图             │
│  - 选择相关 Agent            │
│  - 管理对话流程             │
└───────────┬─────────────────┘
            │
    ┌───────┼───────────┐
    ↓       ↓           ↓
┌─────┐ ┌─────┐   ┌─────┐
│分析 │ │架构 │   │设计 │
│ Agent│ │Agent│   │Agent│
└──┬──┘ └──┬──┘   └──┬──┘
   │        │          │
   └────────┼──────────┘
            ↓
    协同讨论/辩论
            ↓
        综合输出
</span></code></pre>
<p><strong>实际案例：BMAD 的 Party Mode</strong></p>
<p>BMAD 框架中的 <strong>Party Mode</strong> 是 AgentTeams 的典型实现：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># _bmad/core/workflows/party-mode/workflow.md</span>
<span class="hljs-string">**Goal:**</span> <span class="hljs-string">Orchestrates</span> <span class="hljs-string">group</span> <span class="hljs-string">discussions</span> <span class="hljs-string">between</span> <span class="hljs-string">all</span> <span class="hljs-string">installed</span> <span class="hljs-string">BMAD</span> <span class="hljs-string">agents,</span>
<span class="hljs-string">enabling</span> <span class="hljs-string">natural</span> <span class="hljs-string">multi-agent</span> <span class="hljs-string">conversations</span>

<span class="hljs-string">**Agent</span> <span class="hljs-string">Selection</span> <span class="hljs-string">Intelligence:**</span>
<span class="hljs-bullet">-</span> <span class="hljs-string">Analyze</span> <span class="hljs-string">user's</span> <span class="hljs-string">message</span> <span class="hljs-string">for</span> <span class="hljs-string">domain</span> <span class="hljs-string">and</span> <span class="hljs-string">expertise</span> <span class="hljs-string">requirements</span>
<span class="hljs-bullet">-</span> <span class="hljs-string">Select</span> <span class="hljs-number">2</span><span class="hljs-number">-3</span> <span class="hljs-string">most</span> <span class="hljs-string">relevant</span> <span class="hljs-string">agents</span> <span class="hljs-string">for</span> <span class="hljs-string">balanced</span> <span class="hljs-string">perspective</span>
<span class="hljs-bullet">-</span> <span class="hljs-string">Enable</span> <span class="hljs-string">natural</span> <span class="hljs-string">cross-talk</span> <span class="hljs-string">and</span> <span class="hljs-string">agent-to-agent</span> <span class="hljs-string">interactions</span>
</code></pre>
<p>当用户发起 Party Mode 时，所有专业 Agent（分析师、架构师、设计师、开发人员、QA 等）会聚在一起，针对用户的问题进行<strong>多视角讨论</strong>。</p>
<hr/>
<h4 data-id="heading-4">1.2 Subagents：任务型子智能体</h4>
<p><strong>Subagents（子智能体）</strong> 是从主 Agent 派生出来的、用于<strong>隔离特定任务</strong>的功能模块。它们通常没有独立人格，而是作为主 Agent 的"工具"来执行具体任务。</p>
<p><strong>核心特征：</strong></p>
<pre><code class="hljs">🔧 功能导向  专注于特定任务，不具备独立人格
🧩 模块化设计  作为功能模块被主 Agent 调用
📦 上下文隔离  每个子 Agent 有独立的上下文空间
⚡ 任务专一  处理完后返回结果，不参与持久对话
</code></pre>
<p><strong>架构示意：</strong></p>
<pre><code class="hljs language-css" lang="css">主 Agent (Context Window)
├── 任务 <span class="hljs-selector-tag">A</span>
│   └── 调用 Subagent <span class="hljs-selector-tag">A</span> (独立上下文)
│       └── 返回结果 <span class="hljs-selector-tag">A</span>
├── 任务 <span class="hljs-selector-tag">B</span>
│   └── 调用 Subagent <span class="hljs-selector-tag">B</span> (独立上下文)
│       └── 返回结果 <span class="hljs-selector-tag">B</span>
└── 综合结果 <span class="hljs-selector-tag">A</span> + <span class="hljs-selector-tag">B</span>
</code></pre>
<p><strong>实际案例：BMAD 的 PRD 创建流程</strong></p>
<p>在创建产品需求文档（PRD）时，主 Agent 会将不同章节的处理委托给 Subagents：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># _bmad/bmm/workflows/2-plan-workflows/create-prd/steps-e/step-e-01b-legacy-conversion.md</span>

<span class="hljs-string">**Try</span> <span class="hljs-string">to</span> <span class="hljs-string">use</span> <span class="hljs-string">Task</span> <span class="hljs-string">tool</span> <span class="hljs-string">with</span> <span class="hljs-string">sub-agent:**</span>

<span class="hljs-string">当处理复杂章节时，主</span> <span class="hljs-string">Agent</span> <span class="hljs-string">会：</span>
<span class="hljs-number">1</span><span class="hljs-string">.</span> <span class="hljs-string">识别需要深度处理的章节</span>
<span class="hljs-number">2</span><span class="hljs-string">.</span> <span class="hljs-string">创建</span> <span class="hljs-string">Subagent</span> <span class="hljs-string">专门处理该章节</span>
<span class="hljs-number">3</span><span class="hljs-string">.</span> <span class="hljs-string">Subagent</span> <span class="hljs-string">拥有独立的上下文和知识库</span>
<span class="hljs-number">4</span><span class="hljs-string">.</span> <span class="hljs-string">处理完成后返回结果给主</span> <span class="hljs-string">Agent</span>
<span class="hljs-number">5</span><span class="hljs-string">.</span> <span class="hljs-string">主</span> <span class="hljs-string">Agent</span> <span class="hljs-string">整合所有</span> <span class="hljs-string">Subagent</span> <span class="hljs-string">的输出</span>
</code></pre>
<p>这种方式的优势是<strong>防止上下文雪球</strong>（context snowball），避免单一 Agent 的上下文被过多信息污染。</p>
<hr/>
<h3 data-id="heading-5">二、核心差异对比表</h3>


















































<table><thead><tr><th>维度</th><th>AgentTeams</th><th>Subagents</th></tr></thead><tbody><tr><td><strong>定义</strong></td><td>多个独立人格的 Agent 协作</td><td>单一 Agent 的功能模块</td></tr><tr><td><strong>人格</strong></td><td>✅ 每个有独立人格和沟通风格</td><td>❌ 无独立人格，作为工具存在</td></tr><tr><td><strong>关系</strong></td><td>平等协作，相互对话</td><td>主从关系，主 Agent 调用</td></tr><tr><td><strong>上下文</strong></td><td>共享对话历史</td><td>独立上下文空间</td></tr><tr><td><strong>交互方式</strong></td><td>自然对话、辩论、补充</td><td>函数调用、任务委托</td></tr><tr><td><strong>生命周期</strong></td><td>持续存在，随时可唤醒</td><td>按需创建，用完即销</td></tr><tr><td><strong>输出形式</strong></td><td>多视角的综合结论</td><td>任务执行结果</td></tr><tr><td><strong>适用规模</strong></td><td>3-10 个 Agent（最佳实践）</td><td>不限，按需创建</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-6">三、使用场景深度解析</h3>
<h4 data-id="heading-7">3.1 AgentTeams 适用场景</h4>
<h5 data-id="heading-8">✅ 场景 1：需要多专业视角的复杂决策</h5>
<p><strong>案例：技术方案评审</strong></p>
<pre><code class="hljs language-arduino" lang="arduino">用户：<span class="hljs-string">"我们正在设计一个分布式缓存系统，需要技术方案建议"</span>

Party Mode 激活：
┌─────────────────────────────────────────────────┐
| 🔷 <span class="hljs-built_in">Winston</span> (Architect)                  |
| <span class="hljs-string">"从系统架构角度，我建议用一致性哈希..."</span>    │
└─────────────────────────────────────────────────┘
         ↓
┌─────────────────────────────────────────────────┐
| 📊 <span class="hljs-built_in">Mary</span> (Business Analyst)                |
| <span class="hljs-string">"但成本如何？是否能满足业务 SLA？"</span>           │
└─────────────────────────────────────────────────┘
         ↓
┌─────────────────────────────────────────────────┐
| 💻 <span class="hljs-built_in">Dev</span> (Developer)                       |
| <span class="hljs-string">"实现复杂度如何？团队有没有相关经验？"</span>        │
└─────────────────────────────────────────────────┘
         ↓
┌─────────────────────────────────────────────────┐
| ✅ <span class="hljs-built_in">QA</span> (Quality Assurance)                 |
| <span class="hljs-string">"我需要考虑可测试性和监控..."</span>              │
└─────────────────────────────────────────────────┘
</code></pre>
<p><strong>为什么适合：</strong></p>
<ul>
<li>需要架构、业务、开发、测试多个视角</li>
<li>Agent 之间可以相互质疑和补充</li>
<li>最终结论是集体智慧的综合</li>
</ul>
<hr/>
<h5 data-id="heading-9">✅ 场景 2：创意头脑风暴</h5>
<p><strong>案例：新产品功能设计</strong></p>
<pre><code class="hljs language-vbnet" lang="vbnet">用户：<span class="hljs-string">"我们想设计一个智能日程推荐功能"</span>

Mary (BA): <span class="hljs-string">"用户痛点是什么？现有方案有什么不足？"</span>
Zara (UX): <span class="hljs-string">"UI/UX 应该怎么设计？交互流程？"</span>
Winston (Architect): <span class="hljs-string">"技术上如何实现？推荐算法？"</span>
<span class="hljs-symbol">Dev:</span> <span class="hljs-string">"工程可行性如何？需要哪些 API？"</span>
</code></pre>
<p><strong>为什么适合：</strong></p>
<ul>
<li>创意需要碰撞</li>
<li>不同角色贡献不同维度的想法</li>
<li>自然对话更容易激发灵感</li>
</ul>
<hr/>
<h5 data-id="heading-10">✅ 场景 3：争议性问题讨论</h5>
<p><strong>案例：技术选型决策</strong></p>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-symbol">Winston:</span> <span class="hljs-string">"从架构角度，我选方案 A..."</span>
<span class="hljs-symbol">Dev:</span> <span class="hljs-string">"但方案 A 的性能有问题，我建议方案 B..."</span>
<span class="hljs-symbol">QA:</span> <span class="hljs-string">"两个方案的可测试性都不太理想..."</span>
<span class="hljs-symbol">Mary:</span> <span class="hljs-string">"成本和收益呢？时间成本如何？"</span>
</code></pre>
<p><strong>为什么适合：</strong></p>
<ul>
<li>Agent 之间可以辩论</li>
<li>避免"一言堂"</li>
<li>最终决策更全面</li>
</ul>
<hr/>
<h4 data-id="heading-11">3.2 Subagents 适用场景</h4>
<h5 data-id="heading-12">✅ 场景 1：深度文档分析</h5>
<p><strong>案例：分析大型 PRD 文档</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 主 Agent 上下文（空间有限）</span>
主 Agent 需要分析 <span class="hljs-number">5000</span> 行的 PRD 文档

❌ 如果直接全部加载：
    → 上下文爆炸
    → 关键信息被淹没
    → 难以聚焦

✅ 使用 Subagents:
    <span class="hljs-keyword">for</span> chapter <span class="hljs-keyword">in</span> prd.chapters:
        subagent = create_subagent(chapter)
        result = subagent.analyze()
        results.append(result)

    主 Agent 整合 results，提取关键信息
</code></pre>
<p><strong>为什么适合：</strong></p>
<ul>
<li>避免上下文雪球</li>
<li>每个 Subagent 专注分析特定章节</li>
<li>提高分析深度和准确性</li>
</ul>
<hr/>
<h5 data-id="heading-13">✅ 场景 2：并行处理独立任务</h5>
<p><strong>案例：代码审查的多维度分析</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 同时调用多个 Subagents 并行处理</span>
results = parallel_execute([
    create_subagent(<span class="hljs-string">"security_check"</span>, code),
    create_subagent(<span class="hljs-string">"performance_check"</span>, code),
    create_subagent(<span class="hljs-string">"style_check"</span>, code),
    create_subagent(<span class="hljs-string">"test_coverage_check"</span>, code)
])

<span class="hljs-comment"># 主 Agent 综合结果</span>
final_report = consolidate(results)
</code></pre>
<p><strong>为什么适合：</strong></p>
<ul>
<li>任务之间相互独立</li>
<li>可以并行执行，提高效率</li>
<li>结果标准化，易于整合</li>
</ul>
<hr/>
<h5 data-id="heading-14">✅ 场景 3：工具封装和复用</h5>
<p><strong>案例：数据库查询工具</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 主 Agent 定义一个 Subagent 作为工具</span>
<span class="hljs-meta">@subagent</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">query_database</span>(<span class="hljs-params">query</span>):
    <span class="hljs-comment"># 执行数据库查询</span>
    <span class="hljs-comment"># 返回结果</span>
    <span class="hljs-keyword">pass</span>

<span class="hljs-comment"># 主 Agent 在需要时调用</span>
主 Agent: <span class="hljs-string">"查询过去 30 天的销售额"</span>
    ↓
调用 query_database Subagent
    ↓
返回数据
    ↓
主 Agent 进行分析和展示
</code></pre>
<p><strong>为什么适合：</strong></p>
<ul>
<li>将复杂操作封装为 Subagent</li>
<li>主 Agent 不需要知道实现细节</li>
<li>提高代码复用性</li>
</ul>
<hr/>
<h3 data-id="heading-15">四、设计决策框架</h3>
<h4 data-id="heading-16">4.1 选择流程图</h4>
<pre><code class="hljs language-scss" lang="scss">开始
    ↓
任务是否需要**多个专业视角**？
    ├─ 是 → AgentTeams
    │   └─ Agent 之间需要**相互对话/辩论**？
    │       ├─ 是 → 🎯 **AgentTeams** (Party Mode)
    │       └─ 否 → 考虑是否应该用单一 Agent
    │
    └─ 否 → 单一 Agent 足够
        └─ 任务是否会导致**上下文爆炸**？
            ├─ 是 → 🧩 **Subagents** (任务拆分 + 上下文隔离)
            └─ 否 → 单一 Agent 直接处理
</code></pre>
<h4 data-id="heading-17">4.2 检查清单</h4>
<h5 data-id="heading-18">AgentTeams 检查清单</h5>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 需要 <strong>2 个以上专业角色</strong>的输入</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> Agent 之间需要<strong>相互对话或辩论</strong></li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 输出需要<strong>多视角综合</strong></li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> Agent 数量在 <strong>3-10 个</strong>之间（最佳实践）</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 有明确的<strong>协调器</strong>（Orchestrator）</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> Agent 之间有<strong>互补性</strong>（而非重复）</li>
</ul>
<h5 data-id="heading-19">Subagents 检查清单</h5>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 任务可以<strong>模块化拆分</strong></li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 子任务之间<strong>相互独立</strong></li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 需要<strong>防止上下文雪球</strong></li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 子任务有<strong>标准化输出格式</strong></li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 可以<strong>并行执行</strong></li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> Subagent 不需要<strong>独立人格</strong></li>
</ul>
<hr/>
<h3 data-id="heading-20">五、最佳实践与陷阱</h3>
<h4 data-id="heading-21">5.1 AgentTeams 最佳实践</h4>
<h5 data-id="heading-22">✅ 实践 1：合理控制团队规模</h5>
<p><strong>反模式：</strong></p>
<pre><code class="hljs language-markdown" lang="markdown">❌ 创建 20 个 Agent 的超大团队
<span class="hljs-code">    → 对话混乱，难以协调
    → 响应时间长
    → 信息过载
</span></code></pre>
<p><strong>最佳实践：</strong></p>
<pre><code class="hljs language-markdown" lang="markdown">✅ 3-5 个核心 Agent，按需扩展
<span class="hljs-bullet">    -</span> 核心团队：分析师 + 架构师 + 开发
<span class="hljs-bullet">    -</span> 按需补充：QA、设计师、PM
<span class="hljs-bullet">    -</span> 避免冗余角色
</code></pre>
<hr/>
<h5 data-id="heading-23">✅ 实践 2：设计明确的协调逻辑</h5>
<p><strong>BMAD Party Mode 的协调规则：</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># Agent Selection Intelligence</span>
<span class="hljs-bullet">-</span> <span class="hljs-string">分析用户消息的领域和专长需求</span>
<span class="hljs-bullet">-</span> <span class="hljs-string">根据角色、能力和原则选择</span> <span class="hljs-number">2</span><span class="hljs-number">-3</span> <span class="hljs-string">个最相关的</span> <span class="hljs-string">Agent</span>
<span class="hljs-bullet">-</span> <span class="hljs-string">考虑对话上下文和之前</span> <span class="hljs-string">Agent</span> <span class="hljs-string">的贡献</span>
<span class="hljs-bullet">-</span> <span class="hljs-string">确保视角的平衡性</span>

<span class="hljs-comment"># Priority Handling</span>
<span class="hljs-bullet">-</span> <span class="hljs-string">如果用户点名某个</span> <span class="hljs-string">Agent，优先该</span> <span class="hljs-string">Agent</span> <span class="hljs-string">+</span> <span class="hljs-number">1</span><span class="hljs-number">-2</span> <span class="hljs-string">个互补</span> <span class="hljs-string">Agent</span>
<span class="hljs-bullet">-</span> <span class="hljs-string">轮换</span> <span class="hljs-string">Agent</span> <span class="hljs-string">选择，确保多元参与</span>
<span class="hljs-bullet">-</span> <span class="hljs-string">启用自然的跨对话和</span> <span class="hljs-string">Agent</span> <span class="hljs-string">间互动</span>
</code></pre>
<hr/>
<h5 data-id="heading-24">✅ 实践 3：保持 Agent 个性一致性</h5>
<p><strong>示例：BMAD Agent 个性定义</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># Winston (Architect)</span>
<span class="hljs-attr">role:</span> <span class="hljs-string">System</span> <span class="hljs-string">Architect</span> <span class="hljs-string">+</span> <span class="hljs-string">Technical</span> <span class="hljs-string">Design</span> <span class="hljs-string">Leader</span>
<span class="hljs-attr">communication_style:</span> <span class="hljs-string">"Speaks in calm, pragmatic tones,
                    balancing 'what could be' with 'what should be'"</span>
<span class="hljs-attr">principles:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">"Embrace boring technology for stability"</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">"Design simple solutions that scale when needed"</span>

<span class="hljs-comment"># Mary (Business Analyst)</span>
<span class="hljs-attr">communication_style:</span> <span class="hljs-string">"Speaks with the excitement of a treasure hunter
                      - thrilled by every clue"</span>
<span class="hljs-attr">principles:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">"Ground findings in verifiable evidence"</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">"Every business challenge has root causes waiting to be discovered"</span>
</code></pre>
<p><strong>为什么重要：</strong></p>
<ul>
<li>让用户产生信任感和代入感</li>
<li>不同视角的碰撞更有价值</li>
<li>避免"千人一面"</li>
</ul>
<hr/>
<h4 data-id="heading-25">5.2 Subagents 最佳实践</h4>
<h5 data-id="heading-26">✅ 实践 1：任务拆分要合理</h5>
<p><strong>反模式：</strong></p>
<pre><code class="hljs language-markdown" lang="markdown">❌ 过度拆分
<span class="hljs-code">    主 Agent 调用 50 个 Subagents
    → 调度开销过大
    → 通信成本高
    → 难以调试
</span></code></pre>
<p><strong>最佳实践：</strong></p>
<pre><code class="hljs language-markdown" lang="markdown">✅ 合理拆分（3-7 个 Subagents）
<span class="hljs-bullet">    -</span> 按功能模块拆分
<span class="hljs-bullet">    -</span> 按数据维度拆分
<span class="hljs-bullet">    -</span> 确保每个 Subagent 有明确价值
</code></pre>
<hr/>
<h5 data-id="heading-27">✅ 实践 2：标准化输出格式</h5>
<p><strong>BMAD 的 Subagent 输出模板：</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 每个 Subagent 返回结构化结果</span>
<span class="hljs-attr">subagent_output:</span>
  <span class="hljs-attr">summary:</span> <span class="hljs-string">"简要总结"</span>
  <span class="hljs-attr">details:</span> <span class="hljs-string">"详细信息"</span>
  <span class="hljs-attr">findings:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">"发现 1"</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">"发现 2"</span>
  <span class="hljs-attr">recommendations:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">"建议 1"</span>
  <span class="hljs-attr">confidence:</span> <span class="hljs-number">0.85</span>  <span class="hljs-comment"># 置信度</span>
</code></pre>
<p><strong>为什么重要：</strong></p>
<ul>
<li>主 Agent 容易整合结果</li>
<li>可以自动化处理</li>
<li>便于质量评估</li>
</ul>
<hr/>
<h5 data-id="heading-28">✅ 实践 3：合理利用并行能力</h5>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 并行调用多个 Subagents</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">parallel_analysis</span>(<span class="hljs-params">code</span>):
    results = <span class="hljs-keyword">await</span> asyncio.gather(
        security_check(code),
        performance_check(code),
        style_check(code),
        test_coverage_check(code)
    )
    <span class="hljs-keyword">return</span> consolidate(results)
</code></pre>
<p><strong>性能提升：</strong></p>
<ul>
<li>串行执行：4 个任务 × 10 秒 = 40 秒</li>
<li>并行执行：max(10, 10, 10, 10) = 10 秒</li>
<li><strong>提升 4 倍！</strong></li>
</ul>
<hr/>
<h4 data-id="heading-29">5.3 常见陷阱</h4>
<h5 data-id="heading-30">⚠️ 陷阱 1：混淆 AgentTeams 和 Subagents</h5>
<p><strong>错误理解：</strong></p>
<pre><code class="hljs language-arduino" lang="arduino">❌ <span class="hljs-string">"我用 10 个 Subagents，这就是 AgentTeams 吧？"</span>
    → 错！Subagents 没有独立人格，不能对话
</code></pre>
<p><strong>正确理解：</strong></p>
<pre><code class="hljs language-ini" lang="ini">✅ <span class="hljs-attr">AgentTeams</span> = 多个有独立人格的 Agent 协作
✅ <span class="hljs-attr">Subagents</span> = 单一 Agent 的功能模块
</code></pre>
<hr/>
<h5 data-id="heading-31">⚠️ 陷阱 2：过度使用 AgentTeams</h5>
<p><strong>反模式：</strong></p>
<pre><code class="hljs language-erlang" lang="erlang">❌ 简单任务也用 Party Mode
    用户：<span class="hljs-string">"怎么用 Git 提交代码？"</span>
    → 调用 <span class="hljs-number">5</span> 个 Agent 讨论...
    → 浪费资源，响应慢
</code></pre>
<p><strong>正确做法：</strong></p>
<pre><code class="hljs">✅ 简单问题用单一 Agent
✅ 复杂问题才用 AgentTeams
</code></pre>
<hr/>
<h5 data-id="heading-32">⚠️ 陷阱 3：忽视上下文管理</h5>
<p><strong>反模式：</strong></p>
<pre><code class="hljs language-markdown" lang="markdown">❌ Subagents 共享上下文
<span class="hljs-code">    → 信息泄露
    → 污染主 Agent 的上下文
</span></code></pre>
<p><strong>正确做法：</strong></p>
<pre><code class="hljs">✅ 每个 Subagent 有独立上下文
✅ 只返回关键结果给主 Agent
✅ 及时清理无用上下文
</code></pre>
<hr/>
<h3 data-id="heading-33">六、实战案例：BMAD 框架的应用</h3>
<h4 data-id="heading-34">6.1 BMAD AgentTeams：Party Mode 实现</h4>
<p><strong>架构图：</strong></p>
<pre><code class="hljs language-scss" lang="scss">Party Mode Orchestrator
         ↓
    ┌────┴────┬─────┬────┬─────┐
    ↓         ↓     ↓    ↓     ↓
 📊Mary    🏗️Winston  💻Dev  ✅QA  🎨Zara
 Analyst   Architect  Dev    QA   Designer
 (BA)       (Arch)          (Test)  (UX)
</code></pre>
<h4 data-id="heading-35">6.2 BMAD Subagents：PRD 创建流程</h4>
<p><strong>流程图：</strong></p>
<pre><code class="hljs language-scss" lang="scss">主 Agent (Create PRD Workflow)
         ↓
    ┌────┴────────┬────────────┬──────────┐
    ↓            ↓            ↓          ↓
Subagent <span class="hljs-number">1</span>   Subagent <span class="hljs-number">2</span>   Subagent <span class="hljs-number">3</span>   ...
(分析需求)   (编写功能)   (评审质量)
    ↓            ↓            ↓
    └────────────┴────────────┘
              ↓
       整合所有结果
              ↓
        生成最终 PRD
</code></pre>
<hr/>
<h3 data-id="heading-36">七、总结与展望</h3>
<h4 data-id="heading-37">7.1 核心要点回顾</h4>






























<table><thead><tr><th>维度</th><th>AgentTeams</th><th>Subagents</th></tr></thead><tbody><tr><td><strong>核心价值</strong></td><td>集体智慧、多视角碰撞</td><td>模块化、上下文隔离</td></tr><tr><td><strong>适用场景</strong></td><td>复杂决策、头脑风暴、争议讨论</td><td>深度分析、并行处理、工具封装</td></tr><tr><td><strong>关键特征</strong></td><td>独立人格、相互对话、协调器</td><td>功能导向、按需调用、独立上下文</td></tr><tr><td><strong>设计原则</strong></td><td>控制规模（3-10 个）、明确协调、保持个性</td><td>合理拆分、标准化输出、利用并行</td></tr></tbody></table>
<hr/>
<h4 data-id="heading-38">7.2 选择决策矩阵</h4>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-code">                    任务复杂度
                      ↗      ↘
                   简单          复杂
                    ↓            ↓
             单一 Agent      AgentTeams
                    ↓
            是否需要上下文隔离？
                 ↓
           是 → Subagents
           否 → 单一 Agent
</span></code></pre>
<hr/>
<h4 data-id="heading-39">7.3 未来展望</h4>
<p><strong>趋势 1：更智能的协调算法</strong></p>
<ul>
<li>基于强化学习的 Agent 选择</li>
<li>动态调整团队规模</li>
<li>个性化协作模式</li>
</ul>
<p><strong>趋势 2：跨 Agent 的知识共享</strong></p>
<ul>
<li>Agent 之间的经验积累</li>
<li>共享知识图谱</li>
<li>集体学习机制</li>
</ul>
<p><strong>趋势 3：混合模式</strong></p>
<ul>
<li>AgentTeams 内部使用 Subagents</li>
<li>灵活切换协作模式</li>
<li>更高效的资源利用</li>
</ul>
<h3 data-id="heading-40">结语</h3>
<p>AgentTeams 和 Subagents 是多智能体系统中的两种核心模式，它们各有侧重、互补性强。<strong>AgentTeams 适合需要集体智慧的场景，Subagents 适合需要模块化隔离的场景。</strong></p>
<p>正确理解并应用这两种模式，可以显著提升 AI Agent 系统的能力上限和开发效率。希望本文能帮助你在实际项目中做出更好的技术决策！</p>
<hr/>
<p><strong>如果这篇文章对你有帮助，欢迎点赞、收藏、评论！有任何问题，欢迎在评论区讨论～</strong></p>
<hr/>
<p><strong>全文完！</strong></p>
<blockquote>
<p>Happy Coding! 🚀</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🚀 Vercel AI SDK 使用指南：Nuxt 3 + Element Plus 实现第一个AI 聊天应用]]></title>    <link>https://juejin.cn/post/7605114266024001587</link>    <guid>https://juejin.cn/post/7605114266024001587</guid>    <pubDate>2026-02-11T06:12:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605114266024001587" data-draft-id="7605136148592066587" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🚀 Vercel AI SDK 使用指南：Nuxt 3 + Element Plus 实现第一个AI 聊天应用"/> <meta itemprop="keywords" content="Vue.js,Agent"/> <meta itemprop="datePublished" content="2026-02-11T06:12:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ZaneAI"/> <meta itemprop="url" content="https://juejin.cn/user/186266444380203"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🚀 Vercel AI SDK 使用指南：Nuxt 3 + Element Plus 实现第一个AI 聊天应用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/186266444380203/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ZaneAI
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-11T06:12:13.000Z" title="Wed Feb 11 2026 06:12:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>Vercel AI SDK 是目前前端圈最火的 AI 开发库之一，它提供了一套统一的接口来对接各种大模型（OpenAI, Anthropic, Mistral 等）。但是，官方文档主要以 OpenAI 或 Vercel AI Gateway 为例，对于国内开发者来说，网络连接和支付往往是最大的痛点。</p>
<p>今天这篇教程，我们将使用 <strong>Nuxt 3</strong> 结合 <strong>Vercel AI SDK</strong>，并接入国内强大的 <strong>DeepSeek（深度求索）</strong> API，手把手带你开发一个丝滑的 AI 聊天应用。</p>
<p><strong>为什么选择这套技术栈？</strong></p>
<ul>
<li><strong>Nuxt 3</strong>: Vue 3 的最佳全栈框架，开发体验极佳。</li>
<li><strong>Vercel AI SDK (Core + Vue)</strong>: 处理流式传输（Streaming）和状态管理的神器，省去自己写 WebSocket 或 SSE 的麻烦。</li>
<li><strong>DeepSeek</strong>: 国内顶尖大模型，API 完全兼容 OpenAI 格式，价格亲民且无需复杂的网络配置。</li>
</ul>
<hr/>
<h2 data-id="heading-1">准备工作</h2>
<ol>
<li><strong>Node.js 环境</strong>: 建议 v18 或更高版本。</li>
<li><strong>DeepSeek API Key</strong>: 去 <a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.deepseek.com%2F" target="_blank" title="https://platform.deepseek.com/" ref="nofollow noopener noreferrer">DeepSeek 开放平台</a> 申请一个 API Key。（你也可以用 Moonshot/Kimi、阿里通义千问等支持 OpenAI 兼容协议的国内模型，配置方法类似）。</li>
</ol>
<hr/>
<h2 data-id="heading-2">第一步：初始化 Nuxt 项目</h2>
<p>打开终端，使用 <code>nuxi</code> 创建一个新的 Nuxt 项目。</p>
<pre><code class="hljs language-bash" lang="bash">npx nuxi@latest init my-ai-app
<span class="hljs-built_in">cd</span> my-ai-app

</code></pre>
<p>安装依赖（建议使用 pnpm 或 npm）：</p>
<pre><code class="hljs language-bash" lang="bash">npm install

</code></pre>
<hr/>
<h2 data-id="heading-3">第二步：安装 AI SDK 和相关依赖</h2>
<p>我们需要安装 <code>ai</code> 核心库、<code>@ai-sdk/core</code> 核心模块、Vue 适配库以及 OpenAI 适配器。同时安装 <code>zod</code> 用于定义数据结构。</p>
<pre><code class="hljs language-bash" lang="bash">npm install ai @ai-sdk/core @ai-sdk/vue @ai-sdk/openai zod

</code></pre>
<blockquote>
<p><strong>注意</strong>：这里我们虽然用的是 DeepSeek，但因为通过 OpenAI 协议调用，所以安装 <code>@ai-sdk/openai</code> 是正确的做法。</p>
</blockquote>
<hr/>
<h2 data-id="heading-4">第三步：配置环境变量</h2>
<p>在项目根目录下创建一个 <code>.env</code> 文件，填入你的 DeepSeek API Key。</p>
<pre><code class="hljs language-env" lang="env"># .env 文件
NUXT_DEEPSEEK_API_KEY=sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

</code></pre>
<p>接下来，为了让 Nuxt 能读取到这个变量，我们需要修改 <code>nuxt.config.ts</code>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// nuxt.config.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineNuxtConfig</span>({
  <span class="hljs-attr">compatibilityDate</span>: <span class="hljs-string">'2024-11-01'</span>,
  <span class="hljs-attr">devtools</span>: { <span class="hljs-attr">enabled</span>: <span class="hljs-literal">true</span> },
  
  <span class="hljs-comment">// 将环境变量暴露给服务端运行时</span>
  <span class="hljs-attr">runtimeConfig</span>: {
    <span class="hljs-attr">deepseekApiKey</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">NUXT_DEEPSEEK_API_KEY</span>,
  },
})

</code></pre>
<hr/>
<h2 data-id="heading-5">第四步：创建后端 API 路由 (核心)</h2>
<p>这是最关键的一步。我们需要在 Nuxt 的服务端创建一个 API 接口，用来处理前端发来的消息，并调用 DeepSeek 模型，最后将结果以**流（Stream）**的形式返回给前端。</p>
<p>创建文件 <code>server/api/chat.ts</code>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// server/api/chat.ts</span>
<span class="hljs-keyword">import</span> { createOpenAI } <span class="hljs-keyword">from</span> <span class="hljs-string">'@ai-sdk/openai'</span>;
<span class="hljs-keyword">import</span> { streamText } <span class="hljs-keyword">from</span> <span class="hljs-string">'ai'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineLazyEventHandler</span>(<span class="hljs-keyword">async</span> () =&gt; {
  <span class="hljs-keyword">const</span> config = <span class="hljs-title function_">useRuntimeConfig</span>();
  <span class="hljs-keyword">const</span> apiKey = config.<span class="hljs-property">deepseekApiKey</span>;

  <span class="hljs-keyword">if</span> (!apiKey) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'未找到 DeepSeek API Key'</span>);

  <span class="hljs-comment">// 1. 初始化 OpenAI 客户端，但在 baseURL 中指向 DeepSeek 的地址</span>
  <span class="hljs-keyword">const</span> deepseek = <span class="hljs-title function_">createOpenAI</span>({
    <span class="hljs-attr">apiKey</span>: apiKey,
    <span class="hljs-attr">baseURL</span>: <span class="hljs-string">'https://api.deepseek.com'</span>, <span class="hljs-comment">// DeepSeek 的官方 API 地址</span>
  });

  <span class="hljs-keyword">return</span> <span class="hljs-title function_">defineEventHandler</span>(<span class="hljs-keyword">async</span> (event) =&gt; {
    <span class="hljs-comment">// 2. 解析前端传来的请求体</span>
    <span class="hljs-keyword">const</span> { messages } = <span class="hljs-keyword">await</span> <span class="hljs-title function_">readBody</span>(event);

    <span class="hljs-comment">// 3. 调用模型</span>
    <span class="hljs-keyword">const</span> result = <span class="hljs-title function_">streamText</span>({
      <span class="hljs-comment">// 使用 deepseek-chat 模型</span>
      <span class="hljs-attr">model</span>: <span class="hljs-title function_">deepseek</span>(<span class="hljs-string">'deepseek-chat'</span>),
      <span class="hljs-comment">// 直接使用 messages（AI SDK v4+ 已内置转换）</span>
      messages,
      <span class="hljs-comment">// 可选：设置系统提示词</span>
      <span class="hljs-attr">system</span>: <span class="hljs-string">'你是一个乐于助人的中文 AI 助手。'</span>,
    });

    <span class="hljs-comment">// 4. 将流式响应返回给前端</span>
    <span class="hljs-keyword">return</span> result.<span class="hljs-title function_">toDataStreamResponse</span>();
  });
});

</code></pre>
<p><strong>代码解析：</strong></p>
<ul>
<li><code>createOpenAI</code>: 我们利用这个工厂函数创建了一个自定义的 provider，将 <code>baseURL</code> 指向 DeepSeek，从而完美复用 OpenAI 的 SDK 逻辑。</li>
<li><code>streamText</code>: 这是 AI SDK 的核心函数，负责向模型发起流式请求。</li>
<li><code>toDataStreamResponse()</code>: 将 AI 的回复通过 HTTP Response Stream 实时推流给前端，实现“打字机”效果。</li>
</ul>
<hr/>
<h2 data-id="heading-6">第五步：构建前端 UI</h2>
<p>现在回到前端，使用 <code>@ai-sdk/vue</code> 提供的 <code>useChat</code> 钩子，它帮我们封装了发送消息、加载状态、自动追加消息列表等所有逻辑。</p>
<p>修改 <code>app.vue</code> (或者 <code>pages/index.vue</code>)：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup lang="ts"&gt;
import { useChat } from '@ai-sdk/vue';

// 使用 useChat 钩子
// 它会自动调用 /api/chat 接口
const { messages, input, handleInputChange, handleSubmit, isLoading } = useChat();
&lt;/script&gt;

&lt;template&gt;
  &lt;div class="container"&gt;
    &lt;header&gt;
      &lt;h1&gt;DeepSeek AI 助手&lt;/h1&gt;
    &lt;/header&gt;

    &lt;div class="chat-box"&gt;
      &lt;div v-for="m in messages" :key="m.id" class="message" :class="m.role"&gt;
        &lt;div class="role-label"&gt;{{ m.role === 'user' ? '我' : 'DeepSeek' }}:&lt;/div&gt;
        &lt;div class="content"&gt;{{ m.content }}&lt;/div&gt;
      &lt;/div&gt;
      
      &lt;div v-if="isLoading &amp;&amp; messages[messages.length - 1]?.role === 'user'" class="loading"&gt;
        思考中...
      &lt;/div&gt;
    &lt;/div&gt;

    &lt;form @submit="handleSubmit" class="input-area"&gt;
      &lt;input
        class="input-box"
        :value="input"
        placeholder="输入你想问的问题..."
        @change="handleInputChange"
      /&gt;
      &lt;button type="submit" :disabled="isLoading"&gt;发送&lt;/button&gt;
    &lt;/form&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;style scoped&gt;
/* 简单的样式美化 */
.container {
  max-width: 800px;
  margin: 0 auto;
  padding: 20px;
  font-family: sans-serif;
  height: 100vh;
  display: flex;
  flex-direction: column;
}

header {
  text-align: center;
  margin-bottom: 20px;
  border-bottom: 1px solid #eee;
}

.chat-box {
  flex: 1;
  overflow-y: auto;
  padding: 10px;
  border: 1px solid #ddd;
  border-radius: 8px;
  margin-bottom: 20px;
  background-color: #f9f9f9;
}

.message {
  margin-bottom: 15px;
  padding: 10px;
  border-radius: 6px;
}

.message.user {
  background-color: #e3f2fd;
  align-self: flex-end;
}

.message.assistant {
  background-color: #fff;
  border: 1px solid #eee;
}

.role-label {
  font-weight: bold;
  font-size: 0.8rem;
  margin-bottom: 4px;
  color: #666;
}

.content {
  white-space: pre-wrap; /* 保留换行格式 */
  line-height: 1.6;
}

.input-area {
  display: flex;
  gap: 10px;
}

.input-box {
  flex: 1;
  padding: 12px;
  border: 1px solid #ccc;
  border-radius: 4px;
  font-size: 16px;
}

button {
  padding: 0 20px;
  background-color: #1976d2;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-size: 16px;
}

button:disabled {
  background-color: #ccc;
  cursor: not-allowed;
}

.loading {
  font-size: 0.8rem;
  color: #999;
  margin-left: 10px;
}
&lt;/style&gt;

</code></pre>
<hr/>
<h2 data-id="heading-7">第六步：运行测试</h2>
<p>一切就绪！运行项目：</p>
<pre><code class="hljs language-bash" lang="bash">npm run dev

</code></pre>
<p>打开浏览器访问 <code>http://localhost:3000</code>。</p>
<ol>
<li>在输入框输入“你好，请介绍一下你自己”。</li>
<li>点击发送。</li>
<li>你应该能看到 DeepSeek 几乎瞬间开始逐字输出回复，体验非常流畅。</li>
</ol>
<hr/>
<h2 data-id="heading-8">进阶：如何集成组件库（如 Element Plus）</h2>
<p>如果要在实际项目中使用，我们通常会配合国内常用的组件库 <strong>Element Plus</strong>。</p>
<ol>
<li>安装 Element Plus: <code>npm install element-plus</code> (并按 Nuxt 官方文档配置)。</li>
<li>替换 <code>app.vue</code> 中的原生标签：</li>
</ol>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup lang="ts"&gt;
import { useChat } from '@ai-sdk/vue';

// 使用 useChat 钩子，并指定 API 端点
const { messages, input, handleInputChange, handleSubmit, isLoading } = useChat({
  api: '/api/chat',
});
&lt;/script&gt;

&lt;template&gt;
  &lt;div class="chat-container"&gt;
    &lt;el-scrollbar height="600px"&gt;
      &lt;div v-for="m in messages" :key="m.id"&gt;
        &lt;el-card shadow="hover" :style="{ marginBottom: '10px', marginLeft: m.role === 'user' ? '50px' : '0', marginRight: m.role === 'user' ? '0' : '50px' }"&gt;
          &lt;template #header&gt;
             &lt;el-tag :type="m.role === 'user' ? 'primary' : 'success'"&gt;{{ m.role === 'user' ? 'User' : 'AI' }}&lt;/el-tag&gt;
          &lt;/template&gt;
          &lt;div style="white-space: pre-wrap;"&gt;{{ m.content }}&lt;/div&gt;
        &lt;/el-card&gt;
      &lt;/div&gt;
    &lt;/el-scrollbar&gt;
    
    &lt;div style="margin-top: 20px; display: flex;"&gt;
      &lt;!-- 注意：input 是 Ref，需要用 :modelValue 而不是 v-model --&gt;
      &lt;el-input 
        :modelValue="input" 
        @update:modelValue="input = $event"
        placeholder="请输入内容" 
        @keydown.enter="handleSubmit" 
      /&gt;
      &lt;el-button type="primary" @click="handleSubmit" :loading="isLoading" style="margin-left: 10px;"&gt;发送&lt;/el-button&gt;
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/template&gt;

</code></pre>
<p><em>注意：<code>useChat</code> 返回的 <code>input</code> 是一个 Ref 响应式对象，在 Element Plus 中需要使用 <code>:modelValue</code> + <code>@update:modelValue</code> 的方式来实现双向绑定，或者直接绑定事件。</em></p>
<hr/>
<h2 data-id="heading-9">总结</h2>
<p>通过这篇教程，我们成功实现了：</p>
<ol>
<li><strong>Nuxt 3</strong> 全栈框架搭建。</li>
<li><strong>Vercel AI SDK</strong> 接入标准 OpenAI 协议。</li>
<li><strong>DeepSeek</strong> 国内 API 的无缝集成。</li>
</ol>
<p>快去试试吧！如果觉得有用，记得点赞收藏哦。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[万字长文之——AI落地规范]]></title>    <link>https://juejin.cn/post/7605105527257759744</link>    <guid>https://juejin.cn/post/7605105527257759744</guid>    <pubDate>2026-02-11T05:49:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605105527257759744" data-draft-id="7605106957133709346" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="万字长文之——AI落地规范 "/> <meta itemprop="keywords" content="AI编程"/> <meta itemprop="datePublished" content="2026-02-11T05:49:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="codingWhat"/> <meta itemprop="url" content="https://juejin.cn/user/2189882895642728"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            万字长文之——AI落地规范 
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2189882895642728/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    codingWhat
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-11T05:49:55.000Z" title="Wed Feb 11 2026 05:49:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    41
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读15分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>这几天，不知道你喝没喝到千问app请客的奶茶，反正我是喝到了，而且一边喝一边在写文章~<br/>
<br/>
AI已经走入普通大众的生活，那么在程序员的世界中呢？只会更激烈！随着AI的浪潮滚滚前进，我们的工作中一定或多或少使用到了AI工具。比如一开始的vscode中的代码提示插件，如GitHub Copilot、通义灵码等，到现在的代码生成编辑器，如Cursor、Trae等。<br/>
<br/>
一开始尝试使用如Cursor时，会不禁感叹，<code>这个真牛啊！</code><strong>眼看AI写代码，眼看我要失业？“不管”，让我来挑挑刺：</strong><br/>
<br/>
<em>你看，他生成的代码风格和现有工程不一致；<br/>你看，你看，他需求理解歪了啊，需求你来看看，是不是理解错了；<br/>你看，你看，你看，他每次生成的代码都不一致啊，这怎么维护啊，ababab~ ~ ~</em><br/>
<br/>
那么，真要放弃AI吗？那肯定不能，毕竟能干活啊；那问题来了，怎么让他更趁手些呢？在努力近一年后，我尝试写一写在现有工程中让 AI 辅助开发能够稳定落地的一些规范与实践。</p>
</blockquote>
<hr/>
<h2 data-id="heading-0">一、为什么需要「AI 落地规范」</h2>
<p>在真实业务项目里引入 AI（如 Cursor、Claude Code、Trae）写代码时，常遇到：</p>
<ul>
<li><strong>生成代码风格与现有工程不一致</strong>：目录、命名、组件结构各写各的。</li>
<li><strong>需求理解偏差</strong>：缺少结构化需求与接口说明，AI 只能“猜业务”，更容易出现幻觉。</li>
<li><strong>可维护性差</strong>：没有统一规则，后人或 AI 难以在既有约定下续写。</li>
</ul>
<p>要解决这些问题，需要两件事同时到位：</p>
<ol>
<li><strong>输入规范</strong>：需求、接口、配置等写成「AI 可读、可执行」的结构化文档。</li>
<li><strong>输出规范</strong>：用项目规则（如 Cursor Rules）约束 AI 的目录、命名、组件与接口写法。</li>
</ol>
<p>下面以一个vue项目中的模块「xxxx缴费记录查询」和 <code>xxx-xxx-h5-rules</code> 为例，说说我们团队是如何做的。</p>
<hr/>
<h2 data-id="heading-1">二、输入规范：把需求写成 AI 读得懂的语言</h2>
<p>AI 落地的前提是：<strong>需求与接口被清晰、结构化地写出来</strong>，而不是只存在于口头上或零散的聊天里（比如多轮对话，这样只会让代码成为一坨，，，）。</p>
<h3 data-id="heading-2">2.1 功能文档结构</h3>
<pre><code class="hljs language-bash" lang="bash">xxxx缴费记录查询/
├── xxxx缴费记录查询-需求.md         <span class="hljs-comment"># 功能概述、流程、页面与规则</span>
├── xxxx缴费记录查询接口-需求.md     <span class="hljs-comment"># 接口入参、出参、取值与规则</span>
├── 系统参数配置.md                <span class="hljs-comment"># 提示信息、开关等可配置项</span>
└── 原型文件/                     <span class="hljs-comment"># HTML/CSS/JS 原型</span>
</code></pre>
<ul>
<li><strong>需求文档(前端用)</strong>：功能概述、流程图（如 Mermaid）、页面分区（导航栏、查询区、列表区）、控件表（名称、类型、必录、规则、数据元）、页面规则（如 4.1 页面初始化、4.2 xx数据查询规则）。</li>
<li><strong>接口需求文档（后端用）</strong>：接口概述、入参/出参表（含数据元标识、字段名、类型、是否可空）、接口规则（入参校验、表来源、取值规则）。</li>
<li><strong>系统参数配置（共用）</strong>：按模块/页面列出可配置项（如主页面提示信息），便于前端从配置读取而非写死。</li>
</ul>
<p>这类结构让 AI 能够：按「页面 + 控件 + 规则」生成页面与交互；按「入参/出参 + 规则」生成 API 调用与 DTO；按「配置项」生成从 store/config 读取的提示或开关。</p>
<hr/>
<h3 data-id="heading-3">2.2 AI下的需求文档该怎么写</h3>
<h3 data-id="heading-4"><code>统一使用对AI更友好的.md文档编写需求，这对需求侧的同学也是一个不小的挑战，但我们认为这是很有必要的！</code></h3>
<p><strong>一、功能概述</strong></p>
<p>用一两句话说明功能面向谁、做什么、范围是什么。例如：</p>
<blockquote>
<p>本功能支持xxx</p>
</blockquote>
<ul>
<li><strong>对 AI 的用途</strong>：确定模块边界、页面标题、路由命名。</li>
</ul>
<p><strong>二、详细流程</strong></p>
<p>先画流程图（建议用 Mermaid），再配简短流程说明。例如：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    actor 用户
    participant 本功能 as 本功能
    participant 外部系统 as 外部系统
    rect rgba(135, 206, 250, 0.4)
        Note over 用户,外部系统: 1. 【页面初始化】
        用户-&gt;&gt;本功能: 1) 访问xxxx缴费记录查询页面
        本功能-&gt;&gt;外部系统: 引用4.1规则初始化
        外部系统--&gt;&gt;本功能: 返回初始化配置及数据
        本功能--&gt;&gt;用户: 展示xxxx缴费记录
    end
</code></pre>
<p>流程说明示例：</p>
<blockquote>
<ol>
<li>【页面初始化】访问功能后，系统获取个人信息及缴费列表数据，展示xxxx缴费记录查询主页。引用 4.1 规则初始化。</li>
</ol>
</blockquote>
<ul>
<li><strong>写法要点</strong>：流程与后文「四、页面规则说明」中的规则编号对应（如“引用 4.1”），便于实现时按规则写初始化逻辑。</li>
<li><strong>对 AI 的用途</strong>：生成 mounted/created 中的调用顺序，知道先取配置再取列表。</li>
</ul>
<p><strong>三、页面需求分析</strong></p>
<p>按<strong>页面 → 区域 → 控件</strong>分层，用表格把每个区域的控件写清楚。</p>
<ul>
<li>
<p><strong>导航栏</strong>：操作按钮 + 标题。用表格式列出控件名称、可操作、控件类型、交互事件及规则；标题单独一行说明。</p>
</li>
<li>
<p><strong>页面提示区域</strong>：不写死文案，而是<strong>引用配置</strong>。例如：</p>
<blockquote>
<p>提示内容取自「系统参数配置.md」，具体路径：xxxx缴费记录查询 → 主页面提示信息参数配置，若未配置则不显示。</p>
</blockquote>
<p>这样 AI 会生成「从配置读取，未配置则不展示」的逻辑，而不是写死一段文字。</p>
</li>
<li>
<p><strong>查询条件选择区域</strong>：用<strong>一张表</strong>统一描述控件，列建议包含：</p>

































<table><thead><tr><th>列名</th><th>说明与示例</th></tr></thead><tbody><tr><td>控件名称</td><td>xxx</td></tr><tr><td>控件类型</td><td>年度选择框、下拉框</td></tr><tr><td>可操作/必录/是否可见</td><td>Y/N，便于做校验与展示</td></tr><tr><td>初始状态/数据</td><td>默认当前系统年度、暗文「请选择」</td></tr><tr><td>操作规则及取数口径</td><td>格式 YYYY、最大不超过当前年度、下拉选项：xxxx；引用“xx数据查询规则”</td></tr><tr><td>数据元字段名</td><td>与接口对齐</td></tr></tbody></table>
<p>示例（节选）：</p>
































<table><thead><tr><th align="left">控件名称</th><th align="left">控件类型</th><th align="left">可操作</th><th align="left">必录</th><th align="left">是否可见</th><th align="left">初始状态/数据</th><th align="left">操作规则及取数口径</th></tr></thead><tbody><tr><td align="left">年度</td><td align="left">年度选择框</td><td align="left">Y</td><td align="left">Y</td><td align="left">Y</td><td align="left">默认显示当前系统年度</td><td align="left">格式 YYYY；最大不能超过当前系统年度。引用“xx数据查询规则、xx组件”</td></tr><tr><td align="left">xx</td><td align="left">下拉框</td><td align="left">Y</td><td align="left">N</td><td align="left">Y</td><td align="left">暗文：请选择</td><td align="left">下拉选项：xxx。引用“xx数据查询规则”</td></tr></tbody></table>
</li>
<li>
<p><strong>列表区域</strong>：同样用表列出「展示项 + 取数口径 + 数据元」。例如缴费金额写清单位、格式（￥、保留两位小数）。<br/>
这样 AI 能直接生成列表列定义和格式化逻辑。</p>
</li>
</ul>
<p><strong>四、页面规则说明</strong></p>
<p>用<strong>编号规则</strong>把「页面初始化」「查询规则」等说清楚，并与前文引用一致。</p>
<ul>
<li>
<p><strong>4.1 页面初始化</strong>：逐条写“根据哪份配置做哪件事”“根据哪条规则初始化数据”。例如：</p>
<ul>
<li>根据《系统参数配置.md》对“页面提示区域”进行初始展示。</li>
<li>根据“xx数据查询规则”初始化展示页面数据。</li>
</ul>
</li>
<li>
<p><strong>4.2 缴费数据查询规则</strong>：</p>
<ul>
<li>先写<strong>查询条件转换</strong>；</li>
<li>再写调用哪个接口。<br/>
AI 可根据规则生成查询参数组装和接口调用。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-5">2.3 我们为什么规定这样写需求文档？</h3>








































<table><thead><tr><th>维度</th><th>写法</th><th>好处</th></tr></thead><tbody><tr><td><strong>结构化</strong></td><td>功能概述 → 流程 → 页面分析 → 规则说明；接口概述 → 入参/出参 → 接口规则</td><td>层次清晰，AI 和人都能按章节定位；先“做什么”再“怎么做”，减少遗漏。</td></tr><tr><td><strong>表格化</strong></td><td>控件表、入参表、出参表、代码映射表</td><td>机器可读性强，AI 可直接用于生成表单字段、请求参数、列表列、常量映射；前后端对齐同一张表，字段名和类型一致。</td></tr><tr><td><strong>引用与编号</strong></td><td>“引用 4.1 规则”“<code>引用xxxz组件</code>”“引用xx数据查询规则”“根据系统参数配置.md”</td><td>需求内可追溯，实现时按编号找到对应规则及组件；提示区、查询逻辑等不写死，便于多地区配置。</td></tr><tr><td><strong>数据元与取数口径</strong></td><td>数据元标识符、字段名、取数口径、格式备注</td><td>与标准数据元一致，利于对接；取数口径让前端知道哪些字段是后端计算、如何展示。</td></tr><tr><td><strong>流程 + 规则</strong></td><td>Mermaid 流程图 + 规则编号</td><td>先有时序再有条文，AI 能生成正确的调用顺序和初始化逻辑；规则可单独实现、单独测试。</td></tr><tr><td><strong>配置与代码分离</strong></td><td>提示内容取自系统参数配置、若未配置则不显示</td><td>文案和开关可配置，AI 生成“读配置再展示”的代码，避免硬编码，便于多环境。</td></tr></tbody></table>
<p>整体上，<strong>需求文档按“概述 → 流程 → 页面/接口表格 → 规则说明”来写，并用表格和编号把控件、字段、映射、规则、组件编号固定下来</strong>，既能让人一眼看懂，也能让 AI 按表生成代码、按规则生成逻辑，减少歧义和返工，也方便后续的1—N迭代。</p>
<hr/>
<h3 data-id="heading-6">2.4 需求文档中建议包含的要素</h3>








































<table><thead><tr><th>要素</th><th>说明</th><th>对 AI 的用途</th></tr></thead><tbody><tr><td>功能概述</td><td>一两句话说清功能做什么、谁用</td><td>确定模块边界、路由/菜单命名</td></tr><tr><td>流程图</td><td>用 Mermaid 等画清主流程</td><td>生成顺序逻辑、调用关系</td></tr><tr><td>页面分区</td><td>导航栏、提示区、查询区、列表区等</td><td>对应 template 区块与组件</td></tr><tr><td>控件表</td><td>控件名称、类型、必录、可见性、初始值、操作规则、数据元</td><td>生成表单项、校验、字段绑定</td></tr><tr><td>数据元</td><td>中文名、标识符、字段名、类型、长度</td><td>与接口字段、DTO 对齐</td></tr><tr><td>页面规则</td><td>如「4.1 页面初始化」「4.2 xx数据查询规则」</td><td>生成 mounted/created 逻辑与查询条件转换</td></tr></tbody></table>
<p>接口需求文档中则建议包含：</p>
<ul>
<li>接口概述、入参/出参表（含数据元与检索策略）；</li>
<li>入参校验、涉及表、关键取值规则。</li>
</ul>
<p>这样 AI 生成的 API 封装、请求参数和 DTO 才能与后端约定一致。</p>
<h3 data-id="heading-7">2.5 系统参数配置的用法（可选）</h3>
<p>「系统参数配置.md」中按模块列出「主页面提示信息参数配置」等，并说明使用场景、配置项、默认值。<br/>
前端应：<strong>从配置读取提示语等</strong>，而不是在页面里写死。这样 AI 生成的代码会去读 <code>state.configs</code> 或等价配置，便于多地区/多环境差异化。</p>
<hr/>
<h2 data-id="heading-8">三、输出规范：用项目规则约束 AI 的代码</h2>
<p>有了清晰输入，还需要<strong>统一输出</strong>：目录、命名、组件结构、API 与状态管理方式都要和现有项目一致。本项目中通过 <strong>xxx-xxx-h5-rules</strong> 承担这一角色。</p>
<h3 data-id="heading-9">3.1 规则体系概览（xxx-xxx-h5-rules）</h3>








































<table><thead><tr><th>规则文件</th><th>作用</th><th>对 AI 的约束</th></tr></thead><tbody><tr><td>project-structure.mdc</td><td>项目结构、入口、路由位置</td><td>新模块放在哪、如何拆目录</td></tr><tr><td>vue-coding-standards.mdc</td><td>Vue 组件顺序、JS 规范、路由/Vuex/API 约定</td><td>组件结构、命名、mapState/mapMutations 用法</td></tr><tr><td>component-development.mdc</td><td>通用/业务组件、标准父/子页面结构</td><td>页面用 xxx + keep-alive、子页面 name 与 class 命名</td></tr><tr><td>api-integration.mdc</td><td>HTTP 封装、接口组织、错误与加密</td><td>api 模块写法、http 使用方式</td></tr><tr><td>business-modules.mdc</td><td>业务模块列表、新增模块步骤</td><td>路由/store/api 注册顺序与命名</td></tr><tr><td>build-deployment.mdc</td><td>构建、环境、部署</td><td>不随意改构建与公共路径</td></tr></tbody></table>
<p>这些规则应被 Cursor 等工具识别（如通过 <code>.cursor/rules</code> 或说明中引用），让 AI 在生成代码时默认遵循。</p>
<h3 data-id="heading-10">3.2 部分 mdc 文档说明</h3>
<p>规则文件不只有代码，而是「说明 + 列表 + 目录树 + 代码块」组合。下面按文件摘录部分原文，供大家参考。</p>
<hr/>
<p><strong>README.mdc（总览）</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-meta">---</span>
<span class="hljs-attr">alwaysApply:</span> <span class="hljs-literal">true</span>
<span class="hljs-attr">description:</span> <span class="hljs-string">xxx-xxx-h5</span> <span class="hljs-string">项目规则总览</span>
<span class="hljs-meta">---
</span>
<span class="hljs-comment"># xxx-xxx-h5 项目规则总览</span>

<span class="hljs-comment">## 规则文件说明</span>

<span class="hljs-string">本目录包含</span> <span class="hljs-string">xxx-xxx-h5</span> <span class="hljs-string">项目的所有</span> <span class="hljs-string">Cursor</span> <span class="hljs-string">规则文件，用于指导</span> <span class="hljs-string">AI</span> <span class="hljs-string">助手更好地理解和开发该项目。</span>

<span class="hljs-comment">### 规则文件列表</span>

<span class="hljs-number">1</span><span class="hljs-string">.</span> <span class="hljs-string">**project-structure.mdc**</span> <span class="hljs-bullet">-</span> <span class="hljs-string">项目结构指南</span>
   <span class="hljs-bullet">-</span> <span class="hljs-string">项目概述和核心目录结构</span>
   <span class="hljs-bullet">-</span> <span class="hljs-string">模块化架构特点说明</span>
   <span class="hljs-bullet">-</span> <span class="hljs-string">主要入口文件和配置文件位置</span>

<span class="hljs-number">2</span><span class="hljs-string">.</span> <span class="hljs-string">**vue-coding-standards.mdc**</span> <span class="hljs-bullet">-</span> <span class="hljs-string">Vue</span> <span class="hljs-number">2.</span><span class="hljs-string">x</span> <span class="hljs-string">编码规范</span>
   <span class="hljs-bullet">-</span> <span class="hljs-string">Vue</span> <span class="hljs-string">组件开发规范</span>
   <span class="hljs-bullet">-</span> <span class="hljs-string">JavaScript</span> <span class="hljs-string">编码标准</span>
   <span class="hljs-bullet">-</span> <span class="hljs-string">路由和状态管理规范</span>
   <span class="hljs-string">...</span>
</code></pre>
<ul>
<li>用 <strong>frontmatter</strong> 声明 <code>alwaysApply: true</code>、<code>description</code>，便于 Cursor 按需加载或常驻。</li>
<li>用 <strong>编号列表 + 子项</strong> 说清每个规则文件负责什么，AI 能快速判断该查哪个文件。</li>
</ul>
<hr/>
<p><strong>project-structure.mdc（结构说明）</strong></p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># xxx-xxx-h5 项目结构指南</span>

<span class="hljs-section">## 项目概述</span>
xxx-xxx-h5 是一个基于 Vue 2.x 的 H5 应用，采用模块化架构设计。

<span class="hljs-section">## 核心目录结构</span>

<span class="hljs-section">### 主要入口文件</span>
<span class="hljs-bullet">-</span> main.js - 应用主入口，配置 Vue 实例和全局插件
<span class="hljs-bullet">-</span> App.vue - 根组件
<span class="hljs-bullet">-</span> vue.config.js - Vue CLI 配置文件

<span class="hljs-section">### 路由系统</span>
<span class="hljs-bullet">-</span> router/index.js - 主路由配置，包含所有模块路由
<span class="hljs-bullet">-</span> router/ - 各功能模块的路由配置
...

<span class="hljs-section">## 模块化架构特点</span>
项目采用功能模块化设计，每个业务功能都有对应的：
<span class="hljs-bullet">-</span> 路由配置 (router/)
<span class="hljs-bullet">-</span> 状态管理 (store/)
<span class="hljs-bullet">-</span> API 接口 (api/)
<span class="hljs-bullet">-</span> 页面组件 (views/)

这种设计便于维护和扩展新功能。
</code></pre>
<ul>
<li><strong>先概述再拆目录</strong>，<code>AI 能建立「模块 = router + store + api + views」的心智模型</code>。</li>
<li>无代码也可约束「新模块该建哪些目录、放在哪」。</li>
</ul>
<hr/>
<p><strong>vue-coding-standards.mdc</strong></p>
<pre><code class="hljs language-markdown" lang="markdown">---
globs: <span class="hljs-emphasis">*.vue,*</span>.js
<span class="hljs-section">description: Vue 2.x 编码规范和最佳实践
---</span>

<span class="hljs-section">### 组件命名</span>
<span class="hljs-bullet">-</span> 组件名使用 PascalCase
<span class="hljs-bullet">-</span> 文件名与组件名保持一致

<span class="hljs-section">### 路由命名</span>
<span class="hljs-bullet">-</span> 路由名称使用 camelCase
<span class="hljs-bullet">-</span> 路径使用 kebab-case
<span class="hljs-bullet">-</span> 模块路由统一导入到主路由
<span class="hljs-bullet">-</span> 使用常量导出路由名称，便于维护
</code></pre>
<ul>
<li><strong>globs</strong> 限定只在 <code>*.vue,*.js</code> 下生效，避免在无关文件中误用。</li>
<li><strong>条文式约定</strong>（命名、路径、常量）无需代码也能约束生成结果。</li>
</ul>
<p>同一文件内再配「获取系统配置」的<strong>说明 + 注意事项 + 代码</strong>：规则里先写「在组件中获取系统配置必须使用以下方式」，再贴代码；接着用<strong>注意事项</strong>列出四条（用户信息走 getters、系统配置走 state、箭头函数、避免在 methods 里访问 store）。示例代码：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// vue-coding-standards.mdc 中规定的方式</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">computed</span>: {
    <span class="hljs-attr">sbfConfigs</span>: <span class="hljs-function">(<span class="hljs-params">vm</span>) =&gt;</span> {
      <span class="hljs-keyword">return</span> vm.<span class="hljs-property">$store</span>.<span class="hljs-property">state</span>.<span class="hljs-property">configs</span>.<span class="hljs-property">xxx</span>
    }
  }
}
</code></pre>
<ul>
<li><strong>先写「必须使用以下方式」再贴代码</strong>，AI 会优先采用该写法。</li>
<li><strong>注意事项</strong> 能减少「能跑但不符合项目习惯」的生成（如把 config 放在 methods 里）。</li>
</ul>
<hr/>
<p><strong>component-development.mdc</strong></p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section">### 组件设计原则</span>
<span class="hljs-bullet">-</span> 单一职责：每个组件只负责一个功能
<span class="hljs-bullet">-</span> 可复用性：组件应该可以在不同场景下复用
<span class="hljs-bullet">-</span> 可配置性：通过 props 提供灵活的配置选项
<span class="hljs-bullet">-</span> 可扩展性：支持插槽和事件扩展

<span class="hljs-section">### 标准页面组件结构</span>
<span class="hljs-bullet">-</span> 页面组件放在 <span class="hljs-code">`views/`</span> 目录
<span class="hljs-bullet">-</span> 按功能模块组织子目录
<span class="hljs-bullet">-</span> 组件名使用 <span class="hljs-code">`moduleName.pageName`</span> 格式
<span class="hljs-bullet">-</span> 父级组件使用 <span class="hljs-code">`xxTransition`</span> 和 <span class="hljs-code">`keep-alive`</span>
</code></pre>
<ul>
<li><strong>设计原则</strong> 是纯文字，但能引导 AI 不写「大而全」的单文件页面。</li>
<li><strong>标准页面组件结构</strong> 四条直接对应「放哪、怎么命名、用什么包裹」，和后面的代码块一致。</li>
</ul>
<hr/>
<p><strong>api-integration.mdc</strong></p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section">### 模块化 API 结构</span>
api/
├── index.js              # API 主入口
├── account.js            # 账户相关接口
├── apply.js              # 申请相关接口
├── basecode.js           # 基础代码接口
├── pay.js                # 支付相关接口
└── ...                   # 其他业务模块接口

<span class="hljs-section">### 核心 HTTP 配置</span>
<span class="hljs-bullet">-</span> core/http.js - 基础 HTTP 配置
<span class="hljs-bullet">-</span> core/httpEncrypt.js - 加密 HTTP 配置
<span class="hljs-bullet">-</span> core/BusinessError.js - 业务错误处理
</code></pre>
<ul>
<li><strong>目录树</strong> 让 AI 知道新模块的 api 文件应放在哪、如何与 index 挂载。</li>
<li><strong>核心 HTTP 配置</strong> 列出文件与职责，生成请求代码时会联想到用 <code>@/core/http</code>、BusinessError。</li>
</ul>
<hr/>
<h3 data-id="heading-11">3.3 这样写 mdc 规则的好处</h3>

































<table><thead><tr><th>写法</th><th>好处</th></tr></thead><tbody><tr><td><strong>frontmatter（alwaysApply / globs / description）</strong></td><td>工具可按路径或全局决定何时注入规则，减少无关上下文；description 便于人和 AI 快速理解文件用途。</td></tr><tr><td><strong>分文件（结构 / Vue / 组件 / API / 业务 / 构建）</strong></td><td>单文件短小、职责清晰，AI 检索时容易命中「路由」「组件」「API」等关键词；后续增删规则不影响其他领域。</td></tr><tr><td><strong>说明 + 列表 + 代码一起写</strong></td><td>既有「必须」「应」等约束性文字，又有可复制的模板代码，AI 既知道「为什么这样」又知道「长什么样」，生成时更少偏离。</td></tr><tr><td><strong>注意事项 / 命名规范等条文</strong></td><td>不依赖代码也能约束命名、数据来源（如 config 只从 computed 取）、错误处理方式，避免「风格正确但细节不符合项目习惯」。</td></tr><tr><td><strong>目录树与入口说明</strong></td><td>明确新模块该建哪些目录、在 index 里如何挂载，AI 生成的目录和 import 关系更一致。</td></tr><tr><td><strong>标准模式 + 复杂模式并存</strong></td><td>简单业务用标准模式（reset/set、queryList），复杂业务用 actions/getters，AI 能按需求选模板，而不是自己发明一套。</td></tr></tbody></table>
<p><code>整体上，**把规则写成「可执行的说明 + 可粘贴的代码」**，并配合 frontmatter 与分文件组织，能让 AI 在正确时机、正确范围内套用约定，减少反复修改和风格漂移，也便于新人或后续 AI 继承同一套规范。</code></p>
<h2 data-id="heading-12">四、总结</h2>
<ol>
<li>
<p><strong>新功能先写清需求与接口</strong><br/>
至少具备：功能需求（含流程与页面分析）、接口需求（入参/出参/规则）、与前端相关的系统参数配置。</p>
</li>
<li>
<p><strong>把项目规则显式化</strong><br/>
像 xxx-xxx-h5-rules 一样，把结构、Vue、组件、API、业务模块、构建拆成独立规则文件，并让 AI 在上下文中能读到这些规则。</p>
</li>
<li>
<p><strong>模块命名与注册统一</strong><br/>
业务模块用拼音首字母；新增模块严格按 router → store → api → views 的顺序注册，并在主入口中挂载。</p>
</li>
<li>
<p><strong>配置与数据元不写死</strong><br/>
提示语、开关等走系统参数配置；字段名、数据元与接口文档一致，便于前后端联调与 AI 二次修改。</p>
</li>
<li>
<p><strong>用现有模块当模板</strong><br/>
让 AI 参考历史模块的 router/store/api/views 实现方式，再结合需求与接口文档生成新模块，可减少风格偏差。</p>
</li>
</ol>
<hr/>
<h2 data-id="heading-13">五、结语</h2>
<p>AI 要在现有工程里稳定落地，不能只靠「说人话」提需求，而要：</p>
<ul>
<li><strong>输入侧</strong>：<code>把需求、接口、配置写成结构化、可检索的文档，后期可引入向量库编排</code>；</li>
<li><strong>输出侧</strong>：<code>用项目规则（如 xxx-xxx-h5-rules）约束目录、命名、组件、API 和状态管理</code>。</li>
</ul>
<p><strong>AI 落地规范</strong>是一个系统化工程，本文仅介绍了需求侧和代码生成侧部分，还有很多地方没有提到，谨供大家参考。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SpringBoot + 规则执行沙箱 + 超时熔断：防止脚本死循环拖垮整个服务]]></title>    <link>https://juejin.cn/post/7605051886435090495</link>    <guid>https://juejin.cn/post/7605051886435090495</guid>    <pubDate>2026-02-11T06:25:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605051886435090495" data-draft-id="7605142381152190527" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="SpringBoot + 规则执行沙箱 + 超时熔断：防止脚本死循环拖垮整个服务"/> <meta itemprop="keywords" content="后端,Java"/> <meta itemprop="datePublished" content="2026-02-11T06:25:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="what丶k"/> <meta itemprop="url" content="https://juejin.cn/user/2578801884147418"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            SpringBoot + 规则执行沙箱 + 超时熔断：防止脚本死循环拖垮整个服务
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2578801884147418/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    what丶k
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-11T06:25:04.000Z" title="Wed Feb 11 2026 06:25:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读20分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">SpringBoot + 规则执行沙箱 + 超时熔断：防止脚本死循环拖垮整个服务</h2>
<p>在后端服务开发中，动态规则执行是一个非常常见的场景——比如风控规则、定价规则、流程跳转规则等。为了提升灵活性，我们通常会允许业务人员通过脚本（如 Groovy、QLExpress）动态配置规则，而非每次都修改代码、重启服务。但随之而来的一个致命风险是：如果脚本中出现死循环、无限递归，或者执行时间过长，会直接耗尽服务线程池资源，导致整个服务雪崩，甚至宕机。</p>
<p>本文将分享一套基于 SpringBoot 的解决方案：通过「规则执行沙箱」实现脚本与主服务的隔离，结合「超时熔断机制」强制中断异常脚本，双重保障服务稳定性，彻底解决脚本异常拖垮服务的问题。方案兼顾实用性和可扩展性，可直接应用于生产环境。</p>
<h2 data-id="heading-1">一、核心痛点：为什么脚本异常会拖垮整个服务？</h2>
<p>在没有隔离和熔断机制的情况下，脚本执行的风险主要集中在 3 个方面，最终都会指向服务不可用：</p>
<ol>
<li>​<strong>线程资源耗尽</strong>​：SpringBoot 默认使用 Tomcat 线程池处理请求，线程数量有限（默认核心线程 10 个，最大线程 200 个）。如果脚本出现死循环，执行线程会一直被占用，无法释放；当这类异常请求增多时，线程池会快速被占满，新的请求无法处理，服务直接卡死。</li>
<li>​<strong>资源泄露</strong>​：异常脚本可能会频繁创建对象、占用 IO 资源，且无法正常释放，长期运行会导致 JVM 内存溢出（OOM），最终服务宕机。</li>
<li>​<strong>无边界影响</strong>​：脚本执行与主服务共用一个 JVM 进程，脚本中的恶意代码（或误写代码）可能会直接操作主服务的核心资源（如修改静态变量、调用危险方法），引发不可控的线上事故。</li>
</ol>
<p>举个真实案例：某风控系统中，业务人员配置的 Groovy 脚本因逻辑疏漏出现死循环，单个请求执行时间超过 10 分钟，导致 Tomcat 线程池被占满，整个风控服务瘫痪，影响了核心交易流程，造成了严重的经济损失。</p>
<p>因此，对于动态脚本执行场景，「隔离」和「熔断」缺一不可——沙箱负责隔离，防止脚本影响主服务；熔断负责兜底，防止异常脚本长期占用资源。</p>
<h2 data-id="heading-2">二、方案设计：SpringBoot + 沙箱 + 超时熔断 三重保障</h2>
<p>本次方案的核心思路是「分层隔离、超时兜底、异常熔断」，整体架构分为 3 层，各层职责清晰，协同工作：</p>
<h3 data-id="heading-3">2.1 架构分层说明</h3>
<ol>
<li>​**应用层（SpringBoot）**​：负责接收请求、参数校验、结果返回，以及整合沙箱和熔断组件，提供统一的规则执行入口。</li>
<li>​**隔离层（规则执行沙箱）**​：采用「轻量级沙箱框架」，为脚本执行提供独立的运行环境——包括独立的类加载器、线程池、资源限制，确保脚本执行不会影响主服务的 JVM 进程和线程资源。</li>
<li>​**兜底层（超时熔断）**​：基于 Resilience4j 实现超时控制和熔断机制，当脚本执行超时或异常频率过高时，直接中断执行并返回降级结果，避免资源浪费。</li>
</ol>
<h3 data-id="heading-4">2.2 核心组件选型</h3>
<p>选型原则：轻量、易集成、生产可用，避免引入过重的依赖导致服务性能损耗。</p>
<ul>
<li>​<strong>基础框架</strong>​：SpringBoot 2.7.x（稳定版，兼容性好，生态完善）。</li>
<li>​<strong>脚本引擎</strong>​：Groovy（动态性强，语法接近 Java，与 SpringBoot 集成友好，适合业务规则编写）。</li>
<li>​<strong>规则沙箱</strong>​：Alibaba Sandbox4J（轻量级 Java 沙箱，无需修改 JVM 参数，支持类加载隔离、资源限制，性能损耗低）。</li>
<li>​<strong>超时熔断</strong>​：Resilience4j（轻量级熔断框架，基于 Java 8，支持超时、熔断、限流等功能，比 Hystrix 更轻量，更适合 SpringBoot 2.x 版本）。</li>
</ul>
<h2 data-id="heading-5">三、实操实现：从零搭建可落地的解决方案</h2>
<p>下面我们一步步实现整个方案，从环境搭建、核心代码开发，到测试验证，确保每一步都可复制、可落地。</p>
<h3 data-id="heading-6">3.1 环境搭建：引入依赖</h3>
<p>在 SpringBoot 项目的 pom.xml 中引入核心依赖，注意版本兼容性（已验证以下版本可正常运行）：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- SpringBoot 基础依赖 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

<span class="hljs-comment">&lt;!-- Groovy 脚本引擎 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.codehaus.groovy<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>groovy-all<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.0.17<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">type</span>&gt;</span>pom<span class="hljs-tag">&lt;/<span class="hljs-name">type</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

<span class="hljs-comment">&lt;!-- Alibaba Sandbox4J 沙箱 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>sandbox4j-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

<span class="hljs-comment">&lt;!-- Resilience4j 超时熔断 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.github.resilience4j<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>resilience4j-spring-boot2<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.9.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 测试依赖 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<h3 data-id="heading-7">3.2 核心开发：沙箱配置与脚本执行封装</h3>
<p>沙箱的核心作用是「隔离」，我们需要配置沙箱的运行环境，包括类加载隔离、线程池隔离、资源限制（如 CPU、内存），然后封装脚本执行的统一入口。</p>
<h4 data-id="heading-8">3.2.1 沙箱配置类</h4>
<p>通过 Sandbox4J 的 API 配置沙箱，确保脚本执行在独立的环境中，禁止访问主服务的核心类和方法：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> com.alibaba.sandbox4j.api.Sandbox;
<span class="hljs-keyword">import</span> com.alibaba.sandbox4j.api.SandboxConfig;
<span class="hljs-keyword">import</span> com.alibaba.sandbox4j.api.SandboxFactory;
<span class="hljs-keyword">import</span> com.alibaba.sandbox4j.enums.IsolationLevel;
<span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;
<span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;

<span class="hljs-keyword">import</span> java.util.concurrent.LinkedBlockingQueue;
<span class="hljs-keyword">import</span> java.util.concurrent.ThreadPoolExecutor;
<span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;

<span class="hljs-comment">/**
 * 规则执行沙箱配置类：实现脚本与主服务的隔离
 */</span>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RuleSandboxConfig</span> {

    <span class="hljs-comment">/**
     * 配置沙箱：隔离级别为THREAD（线程隔离），并指定独立线程池
     */</span>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> Sandbox <span class="hljs-title function_">ruleSandbox</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 1. 配置沙箱基础参数</span>
        <span class="hljs-type">SandboxConfig</span> <span class="hljs-variable">config</span> <span class="hljs-operator">=</span> SandboxConfig.builder()
                <span class="hljs-comment">// 隔离级别：THREAD（线程隔离），支持类加载、线程、资源的完全隔离</span>
                .isolationLevel(IsolationLevel.THREAD)
                <span class="hljs-comment">// 禁止脚本访问主服务的核心包（可根据实际情况调整）</span>
                .denyPackages(<span class="hljs-string">"com.example.demo.service"</span>, <span class="hljs-string">"com.example.demo.mapper"</span>)
                <span class="hljs-comment">// 允许脚本访问的基础包（如工具类）</span>
                .allowPackages(<span class="hljs-string">"java.lang"</span>, <span class="hljs-string">"java.util"</span>, <span class="hljs-string">"groovy.lang"</span>)
                <span class="hljs-comment">// 脚本执行超时时间（默认1000ms，这里先配置，最终以熔断超时为准）</span>
                .timeout(<span class="hljs-number">1000</span>)
                .timeUnit(TimeUnit.MILLISECONDS)
                <span class="hljs-comment">// 配置沙箱独立线程池（避免占用主服务线程池）</span>
                .threadPool(ruleSandboxThreadPool())
                .build();

        <span class="hljs-comment">// 2. 创建沙箱实例（单例，全局复用）</span>
        <span class="hljs-keyword">return</span> SandboxFactory.createSandbox(config);
    }

    <span class="hljs-comment">/**
     * 沙箱独立线程池：与主服务线程池隔离，防止脚本异常占用主服务线程
     */</span>
    <span class="hljs-keyword">private</span> ThreadPoolExecutor <span class="hljs-title function_">ruleSandboxThreadPool</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>(
                <span class="hljs-number">5</span>, <span class="hljs-comment">// 核心线程数（根据脚本执行并发量调整）</span>
                <span class="hljs-number">10</span>, <span class="hljs-comment">// 最大线程数</span>
                <span class="hljs-number">60</span>, <span class="hljs-comment">// 空闲线程存活时间</span>
                TimeUnit.SECONDS,
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedBlockingQueue</span>&lt;&gt;(<span class="hljs-number">20</span>), <span class="hljs-comment">// 任务队列（避免任务堆积）</span>
                <span class="hljs-comment">// 线程命名前缀（便于日志排查）</span>
                r -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(r, <span class="hljs-string">"rule-sandbox-thread-"</span>),
                <span class="hljs-comment">// 任务拒绝策略：当线程池满时，拒绝任务并抛出异常（避免资源耗尽）</span>
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>.AbortPolicy()
        );
    }
}
</code></pre>
<h4 data-id="heading-9">3.2.2 脚本执行器封装</h4>
<p>封装脚本执行的统一入口，整合沙箱和 Groovy 脚本引擎，提供脚本编译、执行、结果处理的一站式方法，并处理沙箱执行过程中的异常：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> com.alibaba.sandbox4j.api.Sandbox;
<span class="hljs-keyword">import</span> com.alibaba.sandbox4j.exception.SandboxTimeoutException;
<span class="hljs-keyword">import</span> groovy.lang.GroovyClassLoader;
<span class="hljs-keyword">import</span> groovy.lang.GroovyObject;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Component;

<span class="hljs-keyword">import</span> java.util.Map;

<span class="hljs-comment">/**
 * 规则脚本执行器：封装沙箱执行逻辑，提供统一的脚本执行入口
 */</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RuleScriptExecutor</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> Sandbox ruleSandbox;

    <span class="hljs-comment">// Groovy类加载器（与沙箱类加载器隔离）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">GroovyClassLoader</span> <span class="hljs-variable">groovyClassLoader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">GroovyClassLoader</span>();

    <span class="hljs-comment">/**
     * 执行规则脚本
     * <span class="hljs-doctag">@param</span> script 规则脚本内容（Groovy）
     * <span class="hljs-doctag">@param</span> paramMap 脚本执行参数
     * <span class="hljs-doctag">@return</span> 脚本执行结果
     * <span class="hljs-doctag">@throws</span> Exception 执行异常（超时、语法错误、权限异常等）
     */</span>
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">executeScript</span><span class="hljs-params">(String script, Map&lt;String, Object&gt; paramMap)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 1. 编译Groovy脚本（生成Class对象）</span>
            Class&lt;?&gt; scriptClass = groovyClassLoader.parseClass(script);
            <span class="hljs-comment">// 2. 创建脚本实例</span>
            <span class="hljs-type">GroovyObject</span> <span class="hljs-variable">groovyObject</span> <span class="hljs-operator">=</span> (GroovyObject) scriptClass.newInstance();

            <span class="hljs-comment">// 3. 在沙箱中执行脚本（核心：脚本运行在沙箱隔离环境中）</span>
            <span class="hljs-comment">// 沙箱执行逻辑：将脚本执行任务提交到沙箱线程池，由沙箱控制超时和资源</span>
            <span class="hljs-keyword">return</span> ruleSandbox.execute(() -&gt; {
                <span class="hljs-comment">// 获取脚本的main方法（约定脚本必须有main方法，接收paramMap参数）</span>
                <span class="hljs-keyword">return</span> groovyObject.invokeMethod(<span class="hljs-string">"main"</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]{paramMap});
            });
        } <span class="hljs-keyword">catch</span> (SandboxTimeoutException e) {
            <span class="hljs-comment">// 沙箱超时异常（会被熔断机制兜底，但这里提前捕获，便于日志排查）</span>
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Exception</span>(<span class="hljs-string">"规则脚本执行超时，已被沙箱中断"</span>, e);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-comment">// 其他异常（语法错误、权限不足、死循环等）</span>
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Exception</span>(<span class="hljs-string">"规则脚本执行失败："</span> + e.getMessage(), e);
        }
    }
}
</code></pre>
<h3 data-id="heading-10">3.3 核心开发：超时熔断配置</h3>
<p>沙箱虽然提供了超时控制，但熔断机制能提供更全面的兜底——比如当脚本频繁超时、异常时，直接触发熔断，拒绝执行后续请求，避免资源持续浪费。这里使用 Resilience4j 的 @TimeLimiter（超时控制）和 @CircuitBreaker（熔断）注解。</p>
<h4 data-id="heading-11">3.3.1 熔断配置文件</h4>
<p>在 application.yml 中配置 Resilience4j 的超时和熔断参数，按需调整：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">resilience4j:</span>
  <span class="hljs-comment"># 超时控制配置</span>
  <span class="hljs-attr">timelimiter:</span>
    <span class="hljs-attr">instances:</span>
      <span class="hljs-comment"># 规则脚本执行超时配置（与沙箱超时保持一致，双重保障）</span>
      <span class="hljs-attr">ruleScriptExecutor:</span>
        <span class="hljs-attr">timeoutDuration:</span> <span class="hljs-string">1000ms</span> <span class="hljs-comment"># 超时时间（核心：超过该时间直接中断执行）</span>
        <span class="hljs-attr">cancelRunningFuture:</span> <span class="hljs-literal">true</span> <span class="hljs-comment"># 超时后取消正在运行的任务（关键：中断死循环脚本）</span>
  <span class="hljs-comment"># 熔断配置</span>
  <span class="hljs-attr">circuitbreaker:</span>
    <span class="hljs-attr">instances:</span>
      <span class="hljs-comment"># 规则脚本熔断配置</span>
      <span class="hljs-attr">ruleScriptExecutor:</span>
        <span class="hljs-attr">slidingWindowSize:</span> <span class="hljs-number">10</span> <span class="hljs-comment"># 滑动窗口大小（统计10个请求）</span>
        <span class="hljs-attr">failureRateThreshold:</span> <span class="hljs-number">50</span> <span class="hljs-comment"># 熔断阈值：失败率超过50%触发熔断</span>
        <span class="hljs-attr">waitDurationInOpenState:</span> <span class="hljs-string">5000ms</span> <span class="hljs-comment"># 熔断开放时间：5秒后尝试恢复</span>
        <span class="hljs-attr">permittedNumberOfCallsInHalfOpenState:</span> <span class="hljs-number">3</span> <span class="hljs-comment"># 半开状态允许的请求数：3个请求都成功则关闭熔断</span>
        <span class="hljs-attr">registerHealthIndicator:</span> <span class="hljs-literal">true</span> <span class="hljs-comment"># 注册健康指标，便于监控</span>
        <span class="hljs-comment"># 触发熔断的异常类型（超时、沙箱异常、脚本执行异常）</span>
        <span class="hljs-attr">recordExceptions:</span>
          <span class="hljs-bullet">-</span> <span class="hljs-string">java.lang.Exception</span>
        <span class="hljs-comment"># 不触发熔断的异常类型（按需配置）</span>
        <span class="hljs-attr">ignoreExceptions:</span>
          <span class="hljs-bullet">-</span> <span class="hljs-string">java.lang.IllegalArgumentException</span>
</code></pre>
<h4 data-id="heading-12">3.3.2 熔断服务封装</h4>
<p>封装规则执行服务，添加超时和熔断注解，实现兜底逻辑（当熔断触发或执行超时时，返回降级结果）：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> io.github.resilience4j.circuitbreaker.annotation.CircuitBreaker;
<span class="hljs-keyword">import</span> io.github.resilience4j.timelimiter.annotation.TimeLimiter;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Service;

<span class="hljs-keyword">import</span> java.util.Map;
<span class="hljs-keyword">import</span> java.util.concurrent.CompletableFuture;

<span class="hljs-comment">/**
 * 规则执行服务：整合熔断机制，提供熔断兜底
 */</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RuleExecuteService</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RuleScriptExecutor ruleScriptExecutor;

    <span class="hljs-comment">/**
     * 执行规则脚本：添加超时熔断注解
     * <span class="hljs-doctag">@param</span> script 规则脚本
     * <span class="hljs-doctag">@param</span> paramMap 执行参数
     * <span class="hljs-doctag">@return</span> 执行结果（CompletableFuture：支持异步执行，适配Resilience4j超时控制）
     */</span>
    <span class="hljs-meta">@TimeLimiter(name = "ruleScriptExecutor")</span> <span class="hljs-comment">// 关联超时配置</span>
    <span class="hljs-meta">@CircuitBreaker(
            name = "ruleScriptExecutor", // 关联熔断配置
            fallbackMethod = "executeScriptFallback" // 熔断/超时兜底方法
    )</span>
    <span class="hljs-keyword">public</span> CompletableFuture&lt;Object&gt; <span class="hljs-title function_">executeRule</span><span class="hljs-params">(String script, Map&lt;String, Object&gt; paramMap)</span> {
        <span class="hljs-comment">// 异步执行脚本（Resilience4j的超时控制基于异步任务）</span>
        <span class="hljs-keyword">return</span> CompletableFuture.supplyAsync(() -&gt; {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-keyword">return</span> ruleScriptExecutor.executeScript(script, paramMap);
            } <span class="hljs-keyword">catch</span> (Exception e) {
                <span class="hljs-comment">// 抛出异常，让熔断机制捕获并触发兜底</span>
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);
            }
        });
    }

    <span class="hljs-comment">/**
     * 熔断/超时兜底方法：当脚本执行超时、熔断触发时，返回默认结果
     * 注意：方法参数、返回值必须与被熔断方法一致，最后添加一个Exception参数
     */</span>
    <span class="hljs-keyword">public</span> CompletableFuture&lt;Object&gt; <span class="hljs-title function_">executeScriptFallback</span><span class="hljs-params">(String script, Map&lt;String, Object&gt; paramMap, Exception e)</span> {
        <span class="hljs-comment">// 日志记录异常信息（便于排查）</span>
        System.err.println(<span class="hljs-string">"规则脚本执行异常（熔断/超时）："</span> + e.getMessage());
        <span class="hljs-comment">// 返回降级结果（可根据实际业务调整，比如返回默认规则结果、提示系统繁忙等）</span>
        <span class="hljs-keyword">return</span> CompletableFuture.completedFuture(<span class="hljs-string">"规则执行异常，请稍后重试（兜底返回）"</span>);
    }
}
</code></pre>
<h3 data-id="heading-13">3.4 接口开发：提供外部访问入口</h3>
<p>开发一个接口，接收前端传递的规则脚本和参数，调用规则执行服务，返回执行结果：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.PostMapping;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestBody;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;

<span class="hljs-keyword">import</span> java.util.Map;
<span class="hljs-keyword">import</span> java.util.concurrent.CompletableFuture;

<span class="hljs-comment">/**
 * 规则执行接口：提供外部访问入口
 */</span>
<span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("/rule")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RuleExecuteController</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RuleExecuteService ruleExecuteService;

    <span class="hljs-comment">/**
     * 执行规则脚本接口
     * <span class="hljs-doctag">@param</span> request 包含脚本内容和执行参数
     * <span class="hljs-doctag">@return</span> 脚本执行结果
     */</span>
    <span class="hljs-meta">@PostMapping("/execute")</span>
    <span class="hljs-keyword">public</span> CompletableFuture&lt;Object&gt; <span class="hljs-title function_">executeRule</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> RuleExecuteRequest request)</span> {
        <span class="hljs-comment">// 参数校验（简化，实际生产需完善）</span>
        <span class="hljs-keyword">if</span> (request.getScript() == <span class="hljs-literal">null</span> || request.getParamMap() == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> CompletableFuture.completedFuture(<span class="hljs-string">"脚本内容和执行参数不能为空"</span>);
        }
        <span class="hljs-comment">// 调用规则执行服务</span>
        <span class="hljs-keyword">return</span> ruleExecuteService.executeRule(request.getScript(), request.getParamMap());
    }

    <span class="hljs-comment">// 请求参数封装</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RuleExecuteRequest</span> {
        <span class="hljs-keyword">private</span> String script; <span class="hljs-comment">// 规则脚本（Groovy）</span>
        <span class="hljs-keyword">private</span> Map&lt;String, Object&gt; paramMap; <span class="hljs-comment">// 执行参数</span>

        <span class="hljs-comment">// getter/setter 省略</span>
        <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getScript</span><span class="hljs-params">()</span> { <span class="hljs-keyword">return</span> script; }
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setScript</span><span class="hljs-params">(String script)</span> { <span class="hljs-built_in">this</span>.script = script; }
        <span class="hljs-keyword">public</span> Map&lt;String, Object&gt; <span class="hljs-title function_">getParamMap</span><span class="hljs-params">()</span> { <span class="hljs-keyword">return</span> paramMap; }
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setParamMap</span><span class="hljs-params">(Map&lt;String, Object&gt; paramMap)</span> { <span class="hljs-built_in">this</span>.paramMap = paramMap; }
    }
}
</code></pre>
<h2 data-id="heading-14">四、测试验证：模拟异常场景，验证方案有效性</h2>
<p>方案搭建完成后，我们需要模拟 3 种异常场景，验证沙箱 + 熔断是否能有效保护服务：正常脚本、死循环脚本、频繁超时脚本。</p>
<h3 data-id="heading-15">4.1 测试准备</h3>
<p>启动 SpringBoot 服务，使用 Postman 调用接口：<a href="https://link.juejin.cn?target=http%3A%2F%2Flocalhost%3A8080%2Frule%2Fexecute%25EF%25BC%258C%25E8%25AF%25B7%25E6%25B1%2582%25E4%25BD%2593%25E6%25A0%25BC%25E5%25BC%258F%25E5%25A6%2582%25E4%25B8%258B%25EF%25BC%259A" target="_blank" title="http://localhost:8080/rule/execute%EF%BC%8C%E8%AF%B7%E6%B1%82%E4%BD%93%E6%A0%BC%E5%BC%8F%E5%A6%82%E4%B8%8B%EF%BC%9A" ref="nofollow noopener noreferrer">http://localhost:8080/rule/execute，请求体格式如下：</a></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"script"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"此处填写Groovy脚本"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"paramMap"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"num1"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">10</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"num2"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">20</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-16">4.2 场景 1：正常脚本（验证基础功能）</h3>
<p>脚本内容（计算两个数的和）：</p>
<pre><code class="hljs language-groovy" lang="groovy">// 约定的main方法，接收paramMap参数
def main(Map paramMap) {
    def num1 = paramMap.get("num1")
    def num2 = paramMap.get("num2")
    return num1 + num2
}
</code></pre>
<p>测试结果：接口返回 30，执行时间约 50ms，沙箱和熔断均未触发，服务正常。</p>
<h3 data-id="heading-17">4.3 场景 2：死循环脚本（验证超时熔断）</h3>
<p>脚本内容（死循环，无法正常结束）：</p>
<pre><code class="hljs language-groovy" lang="groovy">def main(Map paramMap) {
    // 死循环，模拟异常脚本
    while (true) {
        println("死循环执行中...")
    }
}
</code></pre>
<p>测试结果：</p>
<ol>
<li>脚本执行 1000ms 后，超时熔断触发，接口返回兜底结果：「规则执行异常，请稍后重试（兜底返回）」。</li>
<li>查看日志：沙箱抛出超时异常，Resilience4j 触发熔断，死循环脚本被强制中断，沙箱线程池线程正常释放。</li>
<li>服务状态：主服务线程池无占用，接口可正常接收其他请求，服务稳定。</li>
</ol>
<h3 data-id="heading-18">4.4 场景 3：频繁超时脚本（验证熔断降级）</h3>
<p>连续调用 10 次死循环脚本（触发熔断阈值），测试结果：</p>
<ol>
<li>前 5 次调用：触发超时，返回兜底结果，失败率 50%。</li>
<li>第 6 次调用：熔断触发（失败率超过 50%），直接返回兜底结果，不执行脚本（避免资源浪费）。</li>
<li>5 秒后（熔断开放时间）：尝试调用，若脚本恢复正常，则熔断关闭；若仍异常，则继续保持熔断状态。</li>
</ol>
<p>结论：方案能有效处理频繁异常的脚本，避免服务资源被持续占用。</p>
<h2 data-id="heading-19">五、原理剖析：沙箱隔离与熔断机制的核心逻辑</h2>
<p>很多开发者会疑惑：沙箱和熔断都有超时控制，为什么需要双重配置？两者的核心逻辑是什么？下面我们简单剖析，帮助大家理解方案的设计思路。</p>
<h3 data-id="heading-20">5.1 沙箱隔离的核心原理</h3>
<p>本次使用的 Sandbox4J 沙箱，核心是「线程隔离 + 类加载隔离」：</p>
<ul>
<li>​<strong>线程隔离</strong>​：沙箱使用独立的线程池执行脚本，与主服务的 Tomcat 线程池完全隔离，即使脚本死循环，占用的也是沙箱线程池的线程，不会影响主服务的请求处理。</li>
<li>​<strong>类加载隔离</strong>​：沙箱拥有独立的类加载器，脚本编译生成的 Class 对象只存在于沙箱的类加载器中，不会污染主服务的类加载器；同时，通过 allowPackages/denyPackages 配置，限制脚本的访问权限，防止脚本调用主服务的核心资源。</li>
<li>​<strong>资源限制</strong>​：沙箱可以限制脚本的 CPU、内存占用，避免脚本过度消耗服务器资源。</li>
</ul>
<h3 data-id="heading-21">5.2 超时熔断的核心原理</h3>
<p>Resilience4j 的超时和熔断机制，核心是「异步任务控制 + 失败率统计」：</p>
<ul>
<li>​<strong>超时控制</strong>​：通过 @TimeLimiter 注解，将脚本执行任务封装为 CompletableFuture 异步任务，当任务执行时间超过配置的 timeoutDuration 时，自动取消任务（cancelRunningFuture=true），中断脚本执行。</li>
<li>​<strong>熔断机制</strong>​：通过滑动窗口统计脚本执行的失败率（超时、异常均视为失败），当失败率超过阈值时，触发熔断，进入开放状态；开放状态下，所有请求直接返回兜底结果，不执行脚本；经过指定时间后，进入半开状态，尝试执行少量请求，若全部成功则关闭熔断，否则继续保持开放状态。</li>
</ul>
<h3 data-id="heading-22">5.3 为什么需要双重超时配置？</h3>
<p>沙箱的超时是「沙箱层面的兜底」，Resilience4j 的超时是「应用层面的兜底」，两者协同工作：</p>
<ul>
<li>沙箱超时：防止沙箱线程被长期占用，即使 Resilience4j 出现异常，沙箱也能自行中断脚本。</li>
<li>Resilience4j 超时：触发熔断机制，实现请求级别的兜底，避免频繁调用异常脚本。</li>
</ul>
<p>两者保持超时时间一致，确保无论哪一层先触发超时，都能快速中断脚本，释放资源。</p>
<h2 data-id="heading-23">六、生产环境优化建议</h2>
<p>上述方案已能满足基础需求，但在生产环境中，还需要进行以下优化，提升稳定性和可维护性：</p>
<h3 data-id="heading-24">6.1 脚本预校验</h3>
<p>在脚本执行前，添加预校验逻辑：</p>
<ul>
<li>​<strong>语法校验</strong>​：使用 Groovy 的语法解析器，校验脚本语法是否正确，避免因语法错误导致的异常。</li>
<li>​<strong>危险方法校验</strong>​：禁止脚本使用 System.exit()、Runtime.getRuntime().exec()等危险方法，防止脚本恶意破坏服务。</li>
<li>​<strong>逻辑校验</strong>​：简单校验脚本是否存在明显的死循环（如 while(true)无退出条件），可通过静态代码分析实现。</li>
</ul>
<p>以下是脚本预校验的具体实现代码，整合为工具类，可直接注入使用，校验失败直接抛出异常，阻断脚本执行：</p>
<h4 data-id="heading-25">6.1.1 脚本预校验工具类（核心代码）</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> groovy.lang.GroovyCodeSource;
<span class="hljs-keyword">import</span> groovy.lang.GroovyShell;
<span class="hljs-keyword">import</span> org.codehaus.groovy.control.CompilationFailedException;
<span class="hljs-keyword">import</span> org.codehaus.groovy.control.CompilerConfiguration;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Component;

<span class="hljs-keyword">import</span> java.util.regex.Matcher;
<span class="hljs-keyword">import</span> java.util.regex.Pattern;

<span class="hljs-comment">/**
 * 生产环境脚本预校验工具类：语法校验、危险方法校验、逻辑校验
 */</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ScriptPreCheckUtil</span> {

    <span class="hljs-comment">// 危险方法正则：禁止System.exit、Runtime.exec等破坏服务的方法</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Pattern</span> <span class="hljs-variable">DANGEROUS_METHOD_PATTERN</span> <span class="hljs-operator">=</span> Pattern.compile(
            <span class="hljs-string">"(System\\.exit\\(|Runtime\\.getRuntime\\(\\)\\.exec\\(|ProcessBuilder\\()"</span>,
            Pattern.CASE_INSENSITIVE
    );

    <span class="hljs-comment">// 死循环正则：匹配 while(true)、for(;;) 等明显死循环（简单校验，复杂场景需结合AST分析）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Pattern</span> <span class="hljs-variable">DEAD_LOOP_PATTERN</span> <span class="hljs-operator">=</span> Pattern.compile(
            <span class="hljs-string">"(while\\s*\\(\\s*true\\s*\\)|for\\s*\\(\\s*;\\s*;\\s*\\))"</span>,
            Pattern.CASE_INSENSITIVE
    );

    <span class="hljs-comment">// Groovy脚本解析器（单例复用，提升性能）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> GroovyShell GROOVY_SHELL;

    <span class="hljs-keyword">static</span> {
        <span class="hljs-comment">// 配置Groovy编译器：仅允许基础语法，禁止动态加载危险类</span>
        <span class="hljs-type">CompilerConfiguration</span> <span class="hljs-variable">config</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CompilerConfiguration</span>();
        config.setDisabledGlobalASTTransformations(<span class="hljs-literal">null</span>);
        GROOVY_SHELL = <span class="hljs-keyword">new</span> <span class="hljs-title class_">GroovyShell</span>(config);
    }

    <span class="hljs-comment">/**
     * 脚本预校验入口：顺序执行语法校验、危险方法校验、逻辑校验
     * <span class="hljs-doctag">@param</span> script 待校验的Groovy脚本
     * <span class="hljs-doctag">@throws</span> IllegalArgumentException 校验失败抛出异常，包含具体失败原因
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">preCheckScript</span><span class="hljs-params">(String script)</span> {
        <span class="hljs-comment">// 1. 语法校验</span>
        checkScriptSyntax(script);
        <span class="hljs-comment">// 2. 危险方法校验</span>
        checkDangerousMethod(script);
        <span class="hljs-comment">// 3. 明显死循环校验</span>
        checkDeadLoop(script);
    }

    <span class="hljs-comment">/**
     * 语法校验：使用Groovy编译器解析脚本，判断是否存在语法错误
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">checkScriptSyntax</span><span class="hljs-params">(String script)</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 包装脚本为Groovy代码源，指定名称便于排查</span>
            <span class="hljs-type">GroovyCodeSource</span> <span class="hljs-variable">codeSource</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">GroovyCodeSource</span>(script, <span class="hljs-string">"PreCheckScript.groovy"</span>, GroovyShell.DEFAULT_CODE_BASE);
            <span class="hljs-comment">// 编译脚本，若语法错误会抛出CompilationFailedException</span>
            GROOVY_SHELL.parse(codeSource);
        } <span class="hljs-keyword">catch</span> (CompilationFailedException e) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"脚本语法校验失败："</span> + e.getMessage().split(<span class="hljs-string">"\\n"</span>)[<span class="hljs-number">0</span>], e);
        }
    }

    <span class="hljs-comment">/**
     * 危险方法校验：使用正则匹配禁止的危险方法，防止脚本破坏服务
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">checkDangerousMethod</span><span class="hljs-params">(String script)</span> {
        <span class="hljs-type">Matcher</span> <span class="hljs-variable">matcher</span> <span class="hljs-operator">=</span> DANGEROUS_METHOD_PATTERN.matcher(script);
        <span class="hljs-keyword">if</span> (matcher.find()) {
            <span class="hljs-type">String</span> <span class="hljs-variable">dangerousMethod</span> <span class="hljs-operator">=</span> matcher.group(<span class="hljs-number">1</span>);
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"脚本包含禁止使用的危险方法："</span> + dangerousMethod);
        }
    }

    <span class="hljs-comment">/**
     * 明显死循环校验：使用正则匹配无退出条件的死循环，简单拦截常见异常场景
     * 说明：复杂死循环（如while(flag)但flag始终为true）需结合AST分析，此处为基础校验
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">checkDeadLoop</span><span class="hljs-params">(String script)</span> {
        <span class="hljs-type">Matcher</span> <span class="hljs-variable">matcher</span> <span class="hljs-operator">=</span> DEAD_LOOP_PATTERN.matcher(script);
        <span class="hljs-keyword">if</span> (matcher.find()) {
            <span class="hljs-type">String</span> <span class="hljs-variable">deadLoopCode</span> <span class="hljs-operator">=</span> matcher.group(<span class="hljs-number">1</span>);
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"脚本包含明显死循环，禁止执行："</span> + deadLoopCode);
        }
    }
}
</code></pre>
<h4 data-id="heading-26">6.1.2 校验工具类调用方式（整合到脚本执行器）</h4>
<p>在之前实现的 RuleScriptExecutor 中，执行脚本前调用预校验方法，阻断异常脚本执行，修改后的核心代码如下（仅展示修改部分）：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Component;

<span class="hljs-keyword">import</span> java.util.Map;

<span class="hljs-comment">/**
 * 规则脚本执行器：封装沙箱执行逻辑，提供统一的脚本执行入口
 */</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RuleScriptExecutor</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> Sandbox ruleSandbox;

    <span class="hljs-comment">// 注入脚本预校验工具类</span>
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ScriptPreCheckUtil scriptPreCheckUtil;

    <span class="hljs-comment">// Groovy类加载器（与沙箱类加载器隔离）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">GroovyClassLoader</span> <span class="hljs-variable">groovyClassLoader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">GroovyClassLoader</span>();

    <span class="hljs-comment">/**
     * 执行规则脚本（新增预校验步骤）
     * <span class="hljs-doctag">@param</span> script 规则脚本内容（Groovy）
     * <span class="hljs-doctag">@param</span> paramMap 脚本执行参数
     * <span class="hljs-doctag">@return</span> 脚本执行结果
     * <span class="hljs-doctag">@throws</span> Exception 执行异常（超时、语法错误、权限异常等）
     */</span>
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">executeScript</span><span class="hljs-params">(String script, Map&lt;String, Object&gt; paramMap)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 新增：脚本预校验（校验失败直接抛出异常，不进入后续执行）</span>
            scriptPreCheckUtil.preCheckScript(script);
            
            <span class="hljs-comment">// 1. 编译Groovy脚本（生成Class对象）</span>
            Class&lt;?&gt; scriptClass = groovyClassLoader.parseClass(script);
            <span class="hljs-comment">// 2. 创建脚本实例</span>
            <span class="hljs-type">GroovyObject</span> <span class="hljs-variable">groovyObject</span> <span class="hljs-operator">=</span> (GroovyObject) scriptClass.newInstance();

            <span class="hljs-comment">// 3. 在沙箱中执行脚本（核心：脚本运行在沙箱隔离环境中）</span>
            <span class="hljs-comment">// 沙箱执行逻辑：将脚本执行任务提交到沙箱线程池，由沙箱控制超时和资源</span>
            <span class="hljs-keyword">return</span> ruleSandbox.execute(() -&gt; {
                <span class="hljs-comment">// 获取脚本的main方法（约定脚本必须有main方法，接收paramMap参数）</span>
                <span class="hljs-keyword">return</span> groovyObject.invokeMethod(<span class="hljs-string">"main"</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]{paramMap});
            });
        } <span class="hljs-keyword">catch</span> (IllegalArgumentException e) {
            <span class="hljs-comment">// 捕获预校验失败异常，单独处理（便于日志区分）</span>
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Exception</span>(<span class="hljs-string">"脚本预校验失败："</span> + e.getMessage(), e);
        } <span class="hljs-keyword">catch</span> (SandboxTimeoutException e) {
            <span class="hljs-comment">// 沙箱超时异常（会被熔断机制兜底，但这里提前捕获，便于日志排查）</span>
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Exception</span>(<span class="hljs-string">"规则脚本执行超时，已被沙箱中断"</span>, e);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-comment">// 其他异常（语法错误、权限不足、死循环等）</span>
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Exception</span>(<span class="hljs-string">"规则脚本执行失败："</span> + e.getMessage(), e);
        }
    }
}
</code></pre>
<p>补充说明：</p>
<ul>
<li>校验工具类采用单例 GroovyShell，避免频繁创建编译器导致的性能损耗，适配生产环境高并发场景。</li>
<li>危险方法校验可根据实际业务扩展正则表达式，比如禁止文件操作（new File()）、网络请求等，按需调整。</li>
<li>死循环校验为基础版本，若需拦截复杂死循环（如动态变量控制的循环），可引入 Groovy AST 分析框架（如 groovy-ast），进一步完善校验逻辑。</li>
<li>校验失败会直接抛出异常，被脚本执行器捕获后，最终由 Resilience4j 熔断机制兜底，返回降级结果，形成完整的异常闭环。</li>
</ul>
<h3 data-id="heading-27">6.2 日志与监控</h3>
<p>添加完善的日志和监控，便于排查问题：</p>
<ul>
<li>日志记录：记录脚本执行的详细信息（脚本内容、参数、执行时间、结果、异常信息），尤其是熔断和超时场景的日志。</li>
<li>监控指标：通过 Resilience4j 的监控功能，收集熔断状态、失败率、超时次数等指标；通过 Prometheus+Grafana 可视化监控，设置告警（如熔断触发、沙箱线程池满）。</li>
</ul>
<h3 data-id="heading-28">6.3 线程池优化</h3>
<p>根据生产环境的并发量，调整沙箱线程池参数：</p>
<ul>
<li>核心线程数和最大线程数：根据脚本执行的并发量调整，避免线程数过多导致资源浪费，或过少导致任务堆积。</li>
<li>任务队列：使用有界队列，避免无界队列导致任务堆积，最终引发 OOM。</li>
<li>拒绝策略：根据业务需求选择拒绝策略，如 AbortPolicy（直接拒绝）、CallerRunsPolicy（由调用线程执行，兜底）。</li>
</ul>
<h3 data-id="heading-29">6.4 沙箱资源限制优化</h3>
<p>在生产环境中，进一步限制沙箱的资源占用：</p>
<ul>
<li>CPU 限制：通过 Sandbox4J 的 cpuQuota 配置，限制沙箱线程的 CPU 使用率（如 10%）。</li>
<li>内存限制：限制沙箱执行脚本时的堆内存占用，避免脚本创建大量对象导致 OOM。</li>
</ul>
<h2 data-id="heading-30">七、总结</h2>
<p>动态规则执行虽然提升了业务灵活性，但也带来了脚本异常拖垮服务的风险。本文提出的「SpringBoot + 规则执行沙箱 + 超时熔断」方案，通过分层隔离、双重兜底，完美解决了这一痛点：</p>
<ol>
<li>​<strong>沙箱隔离</strong>​：实现脚本与主服务的线程、类加载、资源隔离，防止脚本异常影响主服务。</li>
<li>​<strong>超时熔断</strong>​：对异常脚本进行超时中断和熔断降级，避免资源持续浪费，保障服务稳定性。</li>
<li>​<strong>实操性强</strong>​：方案基于主流框架，代码可直接复用，测试验证简单，适合快速落地到生产环境。</li>
</ol>
<p>在实际生产中，可根据业务场景调整沙箱隔离级别、熔断参数、线程池配置，同时配合脚本预校验、日志监控，形成一套完整的动态规则执行安全体系。希望本文能为后端开发者提供参考，帮助大家在提升业务灵活性的同时，守住服务稳定性的底线。</p>
<p>关注我的CSDN：<a href="https://link.juejin.cn?target=https%3A%2F%2F" target="_blank" title="https://" ref="nofollow noopener noreferrer">blog.csdn.net/qq_30095907…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JDK源码深潜(二)：ScheduledExecutorService核心实现机制]]></title>    <link>https://juejin.cn/post/7605136148592230427</link>    <guid>https://juejin.cn/post/7605136148592230427</guid>    <pubDate>2026-02-11T06:34:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605136148592230427" data-draft-id="7605114266024067123" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JDK源码深潜(二)：ScheduledExecutorService核心实现机制"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-02-11T06:34:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Shepherd"/> <meta itemprop="url" content="https://juejin.cn/user/3415500769991869"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JDK源码深潜(二)：ScheduledExecutorService核心实现机制
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3415500769991869/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Shepherd
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-11T06:34:06.000Z" title="Wed Feb 11 2026 06:34:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1.概述</h2>
<p>在现代分布式系统与高并发应用的构建过程中，任务的<strong>定时触发</strong>与<strong>周期性调度</strong>是不可或缺的基础能力。从简单的<strong>缓存过期清理</strong>、<strong>心跳检测信号</strong>，到<strong>复杂的分布式任务重试机制</strong>，开发者对调度器的精度、吞吐量以及异常容错能力提出了极高的要求。</p>
<p>在Java并发工具包（java.util.concurrent）中，<code>ScheduledExecutorService</code>及其核心实现类<code>ScheduledThreadPoolExecutor</code>（以下简称STPE）代表了JDK在时间驱动任务管理领域的最高演进成就 。这一架构不仅克服了早期<code>java.util.Timer</code>在多线程协作与异常处理上的结构性缺陷，更通过集成线程池技术、优先队列算法以及复杂的线程协调模式（如Leader-Follower模式），为开发者提供了一个工业级的调度基石</p>
<p><code>ScheduledExecutorService</code>在我们之前总结分享的：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F2wPSbkvIzRYE4xPrYcQKhw" target="_blank" title="https://mp.weixin.qq.com/s/2wPSbkvIzRYE4xPrYcQKhw" ref="nofollow noopener noreferrer">破局延时任务(下)：Spring Boot + DelayQueue 优雅实现分布式延时队列（实战篇）</a>就有大量应用，感兴趣的可以跳转查看。</p>
<h2 data-id="heading-1">2.从Timer到ScheduledThreadPoolExecutor</h2>
<p>古老的<code>Timer</code>的缺陷痛点：一个<code>Timer</code>实例仅由一个后台线程驱动，这意味着如果某个定时任务执行时间过长，后续所有任务的调度都会被推迟，产生显著的任务堆积效应 。更致命的是，<code>Timer</code>缺乏基本的异常隔离机制，若任一<code>TimerTask</code>抛出未捕获的运行时异常，唯一的后台线程将直接终止，导致整个<code>Timer</code>失效，所有后续任务彻底停摆。</p>
<p>为了彻底解决这些痛点，JDK 5.0引入了<code>ScheduledThreadPoolExecutor</code>。作为<code>ThreadPoolExecutor</code>（TPE）的子类，STPE继承了强大的线程池管理能力，允许通过多线程并行处理任务，从而消除了单线程阻塞带来的风险 。在时间精度上，STPE摒弃了易受系统时钟调整影响的<code>System.currentTimeMillis()</code>，转而采用基于纳秒的单调时钟<code>System.nanoTime()</code>，极大地提升了任务触发的稳定性。</p>
<p>关于<code>Timer</code>的使用痛点和<code>ScheduledExecutorService</code>的使用示例，请看之前我们总结的：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F_-Bu8qWOgskorMNnjyS5DA" target="_blank" title="https://mp.weixin.qq.com/s/_-Bu8qWOgskorMNnjyS5DA" ref="nofollow noopener noreferrer">详解Spring Boot定时任务的几种实现方案</a></p>
<p>这里就不再详解介绍了。接下来我们来详解看看<code>ScheduledExecutorService</code>与<code>ScheduledThreadPoolExecutor</code>的架构演进与核心源码，深入了解实现机制与原理。</p>
<h2 data-id="heading-2">3.ScheduledExecutorService接口定义</h2>
<p><code>ScheduledExecutorService</code>接口通过扩展<code>ExecutorService</code>，不仅继承了任务提交、关闭管理等基础API，还定义了四种专门针对时间调度的契约方法</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">public</span> interface ScheduledExecutorService extends ExecutorService {
​
    <span class="hljs-comment">/**
     * 一次性延时执行
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> ScheduledFuture&lt;?&gt; <span class="hljs-title">schedule</span><span class="hljs-params">(Runnable command, <span class="hljs-type">long</span> delay, TimeUnit unit)</span></span>;
​
    <span class="hljs-comment">/**
     * 一次性延时执行，返回的ScheduledFuture允许调用者异步获取执行结果
     */</span>
    <span class="hljs-keyword">public</span> &lt;V&gt; <span class="hljs-function">ScheduledFuture&lt;V&gt; <span class="hljs-title">schedule</span><span class="hljs-params">(Callable&lt;V&gt; callable, <span class="hljs-type">long</span> delay, TimeUnit unit)</span></span>;
​
    <span class="hljs-comment">/**
     * 固定频率调度
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> ScheduledFuture&lt;?&gt; <span class="hljs-title">scheduleAtFixedRate</span><span class="hljs-params">(Runnable command, <span class="hljs-type">long</span> initialDelay, <span class="hljs-type">long</span> period, TimeUnit unit)</span></span>;
​
    <span class="hljs-comment">/**
     * 固定延迟调度
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> ScheduledFuture&lt;?&gt; <span class="hljs-title">scheduleWithFixedDelay</span><span class="hljs-params">(Runnable command, <span class="hljs-type">long</span> initialDelay, <span class="hljs-type">long</span> delay, TimeUnit unit)</span></span>;
​
}
</code></pre>
<p>一次性延时执行的方法没啥好说的，就是等到延时时间到了，就执行任务，这里重点说一下后面两个方法：</p>
<p><strong>固定频率调度：scheduleAtFixedRate</strong></p>
<p>该方法旨在以恒定的频率执行任务。其调度基准是任务的开始时间。具体而言，如果初始延迟为 d，周期为 p，则任务的理论执行时间点序列为：</p>
<p>T_n = startTime + d + n*p</p>
<p>该方法的关键特征在于其“赶工”机制：如果某次任务执行耗时超过了周期 p，下一次任务会在当前任务完成后立即开始，以尽可能贴合预定的频率序列 。然而，STPE保证同一任务的不同执行不会重叠，即前一次执行未结束，后一次执行不会启动 。</p>
<p><strong>固定延迟调度：scheduleWithFixedDelay</strong></p>
<p>与固定频率不同，<code>scheduleWithFixedDelay</code>关注的是任务执行结束与下一次执行开始之间的间隔。其调度基准是前一次任务的结束时间。如果任务执行耗时为 E，指定的延迟为 p，则两次任务开始的时间间隔实际为 E + p 。这种模式特别适用于那些对资源独占有严格要求，或需要确保任务之间有稳定“冷却期”的场景</p>
<h2 data-id="heading-3">4.ScheduledThreadPoolExecutor核心实现</h2>
<p>STPE的架构设计体现了极高的代码复用与扩展性。它在继承<code>ThreadPoolExecutor</code>的基础上，通过内部类<code>ScheduledFutureTask</code>和<code>DelayedWorkQueue</code>重构了任务提交与存储逻辑</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b3c39175c1cc4aa6aefb4c3c6d02715c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2hlcGhlcmQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771396445&amp;x-signature=JMEcwktdViEcxpqzRcImxo7HX74%3D" alt="" loading="lazy"/></p>
<p><strong>注意</strong>：在标准的<code>ThreadPoolExecutor</code>中，线程池的大小在<code>corePoolSize</code>与<code>maximumPoolSize</code>之间动态波动。然而，由于STPE使用了一个理论上无界的优先队列<code>DelayedWorkQueue</code>，根据TPE的执行规则，只有在队列满时才会创建超过<code>corePoolSize</code>的线程 。在STPE的上下文中，<code>DelayedWorkQueue</code>永远不会报满，因此<code>maximumPoolSize</code>参数在实际运行中变得毫无意义，线程池的大小实际上被锚定在<code>corePoolSize</code>上 。这一设计权衡确保了调度器拥有稳定的工作线程数，避免了在高负载调度下的线程频繁创建与销毁。</p>
<h4 data-id="heading-4">4.1 任务包装器：ScheduledFutureTask</h4>
<p>所有提交给STPE的任务都会被包装成<code>ScheduledFutureTask</code>对象。该类不仅保存了原始的<code>Runnable</code>或<code>Callable</code>，还维护了调度所需的元数据 ：</p>
<ul>
<li><strong>time</strong>：任务下一次应当被触发的绝对时间点（纳秒单位） 。</li>
<li><strong>period</strong>：调度周期。正数表示固定频率，负数表示固定延迟，零表示一次性任务 。</li>
<li><strong>sequenceNumber</strong>：用于在相同触发时间下打破僵局的序列号，确保调度满足FIFO原则 。</li>
</ul>
<h4 data-id="heading-5">4.2 扩展机制：decorateTask</h4>
<p>为了支持拦截器模式或监控增强，STPE提供了<code>decorateTask</code>保护方法。子类可以重写此方法，在任务进入队列前对其进行二次包装或附加监控指标 。这在复杂的微服务架构中非常有用，例如可以将分布式追踪的TraceId自动透传到定时任务的执行上下文中。</p>
<h4 data-id="heading-6">4.3 核心数据结构：DelayedWorkQueue的深潜分析</h4>
<p>STPE之所以能高效管理海量定时任务，核心功臣是其内部实现的<code>DelayedWorkQueue</code>。这是一个基于二叉最小堆（Binary Min-Heap）结构的阻塞优先队列 。</p>
<p><strong>二叉堆的数学特征与性能</strong></p>
<p>在<code>DelayedWorkQueue</code>中，每个节点代表一个任务，其排序基准是任务的<code>time</code>属性。堆顶（index 0）始终存放着离当前时间最近、即最先需要执行的任务 。</p>
<ul>
<li><strong>查询效率</strong>：获取最近任务的时间复杂度为 O(1) 。</li>
<li><strong>插入与删除</strong>：通过<code>siftUp</code>和<code>siftDown</code>操作，维护堆平衡的复杂度为 O(\log n) 。</li>
<li><strong>空间优化</strong>：为了提高删除性能，任务内部维护了一个<code>heapIndex</code>字段，使得在任务被取消（cancel）时，可以绕过全量扫描，直接定位并进行堆重构 。</li>
</ul>
<p><strong>动态扩容策略</strong></p>
<p><code>DelayedWorkQueue</code>虽然逻辑上无界，但物理内存是有限的。其底层采用数组存储，初始容量通常较小。当任务数超过当前数组长度时，它会触发扩容操作，通常将容量增加约50% 。这种分级扩容策略在内存占用与操作开销之间取得了平衡</p>
<p><strong>Leader-Follower模式：解决线程饥饿与惊群效应</strong></p>
<p>在多工作线程环境下，如何协调多个线程竞争堆顶任务是一个性能挑战。如果所有空闲线程都调用<code>available.awaitNanos(delay)</code>等待堆顶任务，那么当任务时间到达时，所有线程都会被同时唤醒。然而，只有一个线程能成功夺取任务，其余线程又不得不重新进入睡眠状态，造成了大量的无意义上下文切换 。</p>
<p>为了优化这一点，STPE引入了<strong>Leader-Follower</strong>模式的一种变体 。</p>
<p><strong>领导者（Leader）的角色定义</strong></p>
<p>在<code>take()</code>方法的实现逻辑中，专门设立了一个<code>leader</code>变量（类型为<code>Thread</code>）。当队列首个任务尚未到期时：</p>
<ol>
<li>如果当前已经存在<code>leader</code>线程，新进入的线程（Follower）将直接调用<code>available.await()</code>进行无限期等待，不消耗计时资源 。</li>
<li>如果没有<code>leader</code>线程，当前线程将自荐成为<code>leader</code>，并调用<code>available.awaitNanos(delay)</code>进行限时等待 。</li>
</ol>
<p><strong>权力的更迭与信号传递</strong></p>
<p>这种设计确保了在任何时刻，只有一个线程（Leader）在监控时间的流逝。当该线程醒来并成功获取任务后，它在退出<code>take()</code>方法前，必须负责通过<code>available.signal()</code>唤醒一个新的Follower线程，让其接替自己成为新的Leader 。 如果在此期间有新的、更早触发的任务被加入堆顶，插入操作（offer）会通过设置<code>leader = null</code>并发送唤醒信号，强制当前的Leader-Follower结构进行重新洗牌，确保新任务能及时得到响应</p>
<p>个人感觉<code>DelayedWorkQueue</code>和之前分析的<code>DelayQueue</code>是差不多的，相关文章：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F06g4jWt0iN9tHNnVzcVkcQ" target="_blank" title="https://mp.weixin.qq.com/s/06g4jWt0iN9tHNnVzcVkcQ" ref="nofollow noopener noreferrer">⏰ 一招鲜吃遍天！详解Java延时队列DelayQueue，从此延时任务不再难!</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F_apbmRphCNbj6v7wIJZ-kQ" target="_blank" title="https://mp.weixin.qq.com/s/_apbmRphCNbj6v7wIJZ-kQ" ref="nofollow noopener noreferrer">JDK源码深潜(一)：从源码看透DelayQueue实现</a></p>
<p>那为啥<code>ScheduledThreadPoolExecutor</code> 选择自己实现一个内部类呢？</p>
<p>主要是基于<strong>性能优化</strong>和<strong>架构耦合</strong>的考量：</p>
<p><strong>任务取消的高效移除</strong>，在普通的 <code>DelayQueue</code> 中，如果需要移除一个指定的任务（例如用户调用了 <code>future.cancel()</code>），队列必须遍历内部数组来寻找该对象，时间复杂度是 O(n)。</p>
<p>而 <code>DelayedWorkQueue</code> 配合其存储的任务类型 <code>ScheduledFutureTask</code> 做了特殊优化：</p>
<ul>
<li><strong>heapIndex 索引：</strong> 每个 <code>ScheduledFutureTask</code> 内部维护了一个 <code>heapIndex</code> 字段，记录了该任务在二叉堆数组中的当前下标 。</li>
<li><strong>快速定位：</strong> 当任务被取消并触发移除操作时，<code>DelayedWorkQueue</code> 可以通过这个索引以 O(1) 的时间直接定位到任务在堆中的位置，然后通过 O(\log n) 的堆重构操作将其移除 。对于高并发且频繁取消任务的场景，这种性能提升是巨大的。</li>
</ul>
<p><strong>类型适配：</strong> <code>DelayedWorkQueue</code> 专门为 <code>RunnableScheduledFuture</code> 类型设计，确保了队列中的元素都具备调度所需的元数据（如 <code>time</code> 和 <code>period</code>），这比泛型的 <code>DelayQueue</code> 在内部处理上更加紧凑高效</p>
<p>总的来说，<code>DelayedWorkQueue</code> 是一个<strong>为了 STPE 特殊调度需求而高度定制化</strong>的“高性能版 DelayQueue”，它牺牲了通用性，换取了在任务取消和多线程协作上的极致性能。</p>
<h2 data-id="heading-7">5.任务调度</h2>
<h4 data-id="heading-8">5.1 提交任务</h4>
<p>这里以固定频率调度任务为例展开说说：</p>
<pre><code class="hljs language-scss" lang="scss">    public ScheduledFuture&lt;?&gt; <span class="hljs-built_in">scheduleAtFixedRate</span>(Runnable command,
                                                  long initialDelay,
                                                  long period,
                                                  TimeUnit unit) {
        <span class="hljs-comment">// 任务和单位不能为空</span>
        if (command == null || unit == null)
            throw new <span class="hljs-built_in">NullPointerException</span>();
        <span class="hljs-comment">// 周期不能小于0</span>
        if (period &lt;= <span class="hljs-number">0</span>)
            throw new <span class="hljs-built_in">IllegalArgumentException</span>();
        <span class="hljs-comment">// 通过内部的任务包装器创建一个任务</span>
        ScheduledFutureTask&lt;Void&gt; sft =
            new ScheduledFutureTask&lt;Void&gt;(command,
                                          null,
                                          triggerTime(initialDelay, unit),
                                          unit<span class="hljs-selector-class">.toNanos</span>(period));
        <span class="hljs-comment">// 扩展点：可以重写decorateTask，在任务放入延时队列之前做一些处理，增强任务</span>
        <span class="hljs-comment">// decorateTask()默认不做任何处理，返回sft，也就是 sft == t</span>
        RunnableScheduledFuture&lt;Void&gt; t = <span class="hljs-built_in">decorateTask</span>(command, sft);
        <span class="hljs-comment">// 周期执行重新排队的任务指向增强后的任务</span>
        sft<span class="hljs-selector-class">.outerTask</span> = t;
        <span class="hljs-comment">// 延时执行任务</span>
        <span class="hljs-built_in">delayedExecute</span>(t);
        return t;
    }
</code></pre>
<p>延时执行任务方法<code>#delayedExecute()</code></p>
<pre><code class="hljs language-scss" lang="scss">    private void <span class="hljs-built_in">delayedExecute</span>(RunnableScheduledFuture&lt;?&gt; task) {
        <span class="hljs-comment">// 线程池关闭，拒绝任务</span>
        if (isShutdown())
            <span class="hljs-built_in">reject</span>(task);
        else {
            <span class="hljs-comment">// 将任务加入delayworkQueue队列中</span>
            super<span class="hljs-selector-class">.getQueue</span>()<span class="hljs-selector-class">.add</span>(task);
            <span class="hljs-comment">// 再次判断线程池关闭，根据状态和关机后运行参数的要求取消并删除它</span>
            if (isShutdown() &amp;&amp;
                !<span class="hljs-built_in">canRunInCurrentRunState</span>(task.isPeriodic()) &amp;&amp;
                <span class="hljs-built_in">remove</span>(task))
                task<span class="hljs-selector-class">.cancel</span>(false);
            else
                <span class="hljs-comment">// 启动线程, 确保线程池中至少有足够的工作线程来处理（或等待）新提交到队列中的任务</span>
                <span class="hljs-comment">// 只要队列里有任务，线程池里就必须至少有一个线程在 take() 上阻塞等待，或者线程数已经达到了 corePoolSize 的上限</span>
                <span class="hljs-built_in">ensurePrestart</span>();
        }
    }
</code></pre>
<p>但在 STPE 中，任务往往是“延时”的， 如果你提交了一个 10 分钟后执行的任务，而此时线程池里一个线程都没有（比如刚初始化），如果没有 <code>ensurePrestart()</code>，这个任务会静静地躺在 <code>DelayedWorkQueue</code> 里。</p>
<p><code>ensurePrestart()</code> 会检查当前运行的线程数。如果线程数小于 <code>corePoolSize</code>，它会启动一个新的核心线程 。这个线程启动后会立即调用队列的 <code>take()</code> 方法，发现任务未到期，从而进入 <code>awaitNanos(delay)</code> 状态，实际上充当了该任务的“定时监听器”</p>
<p>根据 <code>ThreadPoolExecutor</code> 的默认策略，只有在调用 <code>execute()</code> 提交任务时才会创建线程。</p>
<ul>
<li><code>ensurePrestart()</code> 内部通常会调用 <code>addWorker(null, true)</code>（或者类似的 <code>prestartCoreThread()</code> 逻辑）。</li>
<li>它的目标是保证：只要队列里有任务，池子里就必须至少有一个线程在 <code>take()</code> 上阻塞等待，或者线程数已经达到了 <code>corePoolSize</code> 的上限</li>
</ul>
<h4 data-id="heading-9">5.2 任务执行与重调度的闭环逻辑</h4>
<p>STPE的任务执行并非一次性的简单调用，而是一个涉及状态转换、计算、再入队的闭环过程。</p>
<p>当一个工作线程从<code>DelayedWorkQueue</code>中获取任务后，它会调用<code>ScheduledFutureTask</code>的<code>run()</code>方法。其内部执行逻辑如下 ：</p>
<pre><code class="hljs language-scss" lang="scss">        public void <span class="hljs-built_in">run</span>() {
            <span class="hljs-comment">// 判断是不是周期性任务</span>
            boolean periodic = <span class="hljs-built_in">isPeriodic</span>();
            <span class="hljs-comment">// 判断当前任务是否可以运行</span>
            if (!canRunInCurrentRunState(periodic))
                <span class="hljs-built_in">cancel</span>(false);
            else if (!periodic)
                <span class="hljs-comment">// 一次性任务直接执行</span>
                ScheduledFutureTask<span class="hljs-selector-class">.super</span><span class="hljs-selector-class">.run</span>();
            else if (ScheduledFutureTask.super.runAndReset()) {
                <span class="hljs-comment">// 周期性任务处理</span>
                <span class="hljs-comment">// 设置下一次执行时间</span>
                <span class="hljs-built_in">setNextRunTime</span>();
                <span class="hljs-comment">// 重新加入任务队列</span>
                <span class="hljs-built_in">reExecutePeriodic</span>(outerTask);
            }
        }
</code></pre>
<p><strong>执行流程解析:</strong></p>
<ol>
<li>
<p><strong>状态检查</strong>：确认当前线程池状态允许任务运行。</p>
</li>
<li>
<p><strong>一次性任务处理</strong>：如果不是周期性任务，直接调用父类的<code>FutureTask.run()</code>执行。</p>
</li>
<li>
<p><strong>周期性任务处理</strong>：调用<code>runAndReset()</code>。这是一个关键方法，它执行任务逻辑但不设置最终状态，从而使任务能够多次复用。</p>
</li>
<li>
<p><strong>计算下次时间</strong>：任务成功完成后，根据<code>period</code>的正负号调用<code>setNextRunTime()</code> 。</p>
<ul>
<li><strong>Fixed Rate</strong>: time = time + period。</li>
<li><strong>Fixed Delay</strong>: time = triggerTime(-period)。</li>
</ul>
</li>
<li>
<p><strong>再入队（reExecutePeriodic）</strong> ：将更新了<code>time</code>的任务重新插入<code>DelayedWorkQueue</code>中，并调用<code>ensurePrestart()</code>确保有足够的线程来处理它</p>
</li>
</ol>
<p><strong>异常的“静默死亡”风险</strong></p>
<p>值得注意的是，如果任务在执行过程中抛出异常且未被内部捕获，<code>runAndReset()</code>将返回<code>false</code>，导致后续的再入队步骤被跳过 。对于调用者而言，这意味着周期性任务突然“消失”了，且由于STPE不会主动向控制台打印异常栈，这种故障极具隐蔽性。因此，<strong>生产环境下的任务逻辑必须包裹在严密的<code>try-catch</code>块中</strong></p>
<h2 data-id="heading-10">6.总结</h2>
<p><code>ScheduledThreadPoolExecutor</code>不仅是JDK中一个简单的并发工具，它是对计算机科学中时间管理、任务调度以及同步理论的深度实践。从基于堆的优先队列设计，到精巧的Leader-Follower同步模型，每一个设计细节都指向了高性能、高可靠与高扩展性的终极目标。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Python 实战：调用 RPA 接口实现外部群成员自动邀请]]></title>    <link>https://juejin.cn/post/7605128056485543951</link>    <guid>https://juejin.cn/post/7605128056485543951</guid>    <pubDate>2026-02-11T06:34:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605128056485543951" data-draft-id="7605106957133905954" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" Python 实战：调用 RPA 接口实现外部群成员自动邀请"/> <meta itemprop="keywords" content="API"/> <meta itemprop="datePublished" content="2026-02-11T06:34:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="企微支持1"/> <meta itemprop="url" content="https://juejin.cn/user/626071981280944"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             Python 实战：调用 RPA 接口实现外部群成员自动邀请
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/626071981280944/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    企微支持1
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-11T06:34:01.000Z" title="Wed Feb 11 2026 06:34:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<h2 data-id="heading-0"><strong>​</strong> <strong>​</strong> <strong>QiWe开放平台 · 个人名片</strong></h2>
<p><strong>API驱动企微</strong> <strong>外部群</strong> <strong>自动化，让开发更高效</strong></p>
<p>        官方站点：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.qiweapi.com%2F" title="https://www.qiweapi.com/" target="_blank" ref="nofollow noopener noreferrer">www.qiweapi.com</a></p>
<p>        对接通道：进入官方站点联系客服</p>
<p>        团队定位：企微生态深度服务，专注 API+RPA 融合技术方案</p>
</blockquote>
<p>在企业微信官方 API 中，邀请外部联系人入群有诸多限制（如必须是好友、需要用户手动确认等）。基于 RPA 协议的接口则可以通过模拟操作，实现更高效的<strong>主动邀请</strong>。</p>
<h4 data-id="heading-1">1. 接口准备</h4>
<p>根据文档，我们需要关注以下两个核心动作：</p>
<ul>
<li><strong>获取群列表/详情</strong>：确定目标外部群的 <code>room_id</code>。</li>
<li><strong>发送外部群邀请</strong>：调用拉人接口。</li>
</ul>
<h4 data-id="heading-2">2. 基础请求类实现</h4>
<p>首先，我们利用 <code>requests</code> 库（或异步的 <code>aiohttp</code>）封装一个基础类，处理文档中要求的 <code>Content-Type: application/json</code> 和鉴权。</p>
<pre><code class="hljs language-Python" lang="Python"><span class="hljs-keyword">import</span> requests
<span class="hljs-keyword">import</span> json

<span class="hljs-keyword">class</span> <span class="hljs-title class_">QiWeApiConnector</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, server_url, api_key</span>):
        self.server_url = server_url
        self.headers = {
            <span class="hljs-string">"Authorization"</span>: <span class="hljs-string">f"Bearer <span class="hljs-subst">{api_key}</span>"</span>,
            <span class="hljs-string">"Content-Type"</span>: <span class="hljs-string">"application/json"</span>
        }

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_post</span>(<span class="hljs-params">self, method, data</span>):
        url = <span class="hljs-string">f"<span class="hljs-subst">{self.server_url}</span>/api/<span class="hljs-subst">{method}</span>"</span>
        <span class="hljs-keyword">try</span>:
            response = requests.post(url, headers=self.headers, data=json.dumps(data))
            <span class="hljs-keyword">return</span> response.json()
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-keyword">return</span> {<span class="hljs-string">"status"</span>: <span class="hljs-string">"error"</span>, <span class="hljs-string">"message"</span>: <span class="hljs-built_in">str</span>(e)}
</code></pre>
<h4 data-id="heading-3">3. 功能开发：主动拉人入外部群</h4>
<p>在 <code>doc.qiweapi.com</code> 的文档中，拉人接口通常定义为 <code>AddSceneGroupMember</code>。以下是 Python 实现逻辑：</p>
<pre><code class="hljs language-Python" lang="Python">    <span class="hljs-keyword">def</span> <span class="hljs-title function_">invite_to_external_group</span>(<span class="hljs-params">self, room_id, wxids</span>):
        <span class="hljs-string">"""
        主动拉人进入外部群
        :param room_id: 外部群ID
        :param wxids: 待加入成员的微信号/wxid列表 (List)
        """</span>
        payload = {
            <span class="hljs-string">"room_id"</span>: room_id,
            <span class="hljs-string">"wxids"</span>: wxids,
            <span class="hljs-string">"reason"</span>: <span class="hljs-string">"欢迎加入技术交流群"</span>  <span class="hljs-comment"># 部分版本支持设置邀请理由</span>
        }
        <span class="hljs-keyword">return</span> self._post(<span class="hljs-string">"AddSceneGroupMember"</span>, payload)

<span class="hljs-comment"># 实例化调用</span>
api = QiWeApiConnector(<span class="hljs-string">"http://127.0.0.1:8888"</span>, <span class="hljs-string">"your_admin_token"</span>)

<span class="hljs-comment"># 示例：将两名新客户拉入指定的外部交流群</span>
result = api.invite_to_external_group(
    room_id=<span class="hljs-string">"210xxxxxxxx@chatroom"</span>, 
    wxids=[<span class="hljs-string">"wxid_user123"</span>, <span class="hljs-string">"wxid_user456"</span>]
)

<span class="hljs-built_in">print</span>(<span class="hljs-string">f"执行结果: <span class="hljs-subst">{result}</span>"</span>)
</code></pre>
<h4 data-id="heading-4">4. 深度解析：如何获取外部群的 <code>room_id</code>？</h4>
<p>很多开发者卡在“不知道群 ID”这一步。在 RPA 体系下，你可以通过 Python 脚本实现<strong>实时同步</strong>：</p>
<pre><code class="hljs language-Python" lang="Python">    <span class="hljs-keyword">def</span> <span class="hljs-title function_">sync_external_chat_rooms</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""
        获取当前账号加入的所有外部群聊列表
        """</span>
        res = self._post(<span class="hljs-string">"GetChatList"</span>, {<span class="hljs-string">"type"</span>: <span class="hljs-number">2</span>}) <span class="hljs-comment"># 2 通常代表外部群</span>
        <span class="hljs-keyword">if</span> res.get(<span class="hljs-string">"code"</span>) == <span class="hljs-number">200</span>:
            <span class="hljs-keyword">for</span> room <span class="hljs-keyword">in</span> res.get(<span class="hljs-string">"data"</span>, []):
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"群名: <span class="hljs-subst">{room[<span class="hljs-string">'nickname'</span>]}</span> | ID: <span class="hljs-subst">{room[<span class="hljs-string">'room_id'</span>]}</span>"</span>)
        <span class="hljs-keyword">return</span> res
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e96af14c24664728a973a6f4afa96ef4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LyB5b6u5pSv5oyBMQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771396441&amp;x-signature=l%2FbOg2QMlZB3Vzp18K10%2F17XxaY%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-5">5. 技术难点与避坑指南</h4>
<ul>
<li><strong>wxid 转换</strong>：确保你传入的是企业微信内部的 <code>wxid</code>。如果只有手机号，需要先调用 <code>SearchContactByPhone</code> 接口转换。</li>
<li><strong>群类型校验</strong>：外部群（External Group）与内部群在底层协议上有本质区别，调用接口时需确认 <code>room_id</code> 的后缀是否符合外部群特征（通常包含 <code>@chatroom</code> 或 <code>@external</code>）。</li>
<li><strong>频率控制</strong>：虽然 RPA 接口没有官方 API 那样的严格配额，但 Python 脚本执行速度极快。建议在批量拉人时加入 <code>time.sleep(2)</code>，模拟人工操作间隔，规避风控。</li>
</ul>
<hr/>
<h4 data-id="heading-6">总结</h4>
<p>通过 Python 对 <code>doc.qiweapi.com</code> 接口的二次封装，开发者可以将原本复杂的底层协议操作简化为几行逻辑代码。这为构建自动化营销系统、社群管理机器人提供了极大的灵活性。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[教程上新｜微信AI团队提出扩散语言模型WeDLM，相较vLLM部署AR模型实现3倍推理加速]]></title>    <link>https://juejin.cn/post/7605136148592279579</link>    <guid>https://juejin.cn/post/7605136148592279579</guid>    <pubDate>2026-02-11T06:37:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605136148592279579" data-draft-id="7605114266024116275" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="教程上新｜微信AI团队提出扩散语言模型WeDLM，相较vLLM部署AR模型实现3倍推理加速"/> <meta itemprop="keywords" content="深度学习,人工智能,腾讯"/> <meta itemprop="datePublished" content="2026-02-11T06:37:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="OpenBayes贝式计算"/> <meta itemprop="url" content="https://juejin.cn/user/2793222200375607"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            教程上新｜微信AI团队提出扩散语言模型WeDLM，相较vLLM部署AR模型实现3倍推理加速
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2793222200375607/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    OpenBayes贝式计算
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-11T06:37:49.000Z" title="Wed Feb 11 2026 06:37:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在规模化部署和商业落地场景中，推理速度的权重日益提升，甚至在许多情况下超过了单纯的模型参数量，成为决定其工程价值的关键因素。尽管自回归（Autoregressive，AR）生成范式凭借稳定性和成熟生态，仍是当前主流解码方式，<strong>但其逐 token 生成的内在机制，使模型在推理阶段几乎无法充分利用并行计算资源。</strong> 这一限制在长文本生成、复杂推理和高并发服务场景中尤为突出，也直接推高了推理延迟与算力成本。</p>
<p>为突破这一瓶颈，研究界近年来不断探索并行解码路径，<strong>其中扩散语言模型（Diffusion Language Models，DLMs）因其「每步生成多个 token」的特性，被视为最具潜力的替代方案之一。</strong> 然而，理想与现实之间仍存在明显鸿沟：在真实部署环境中，许多 DLLMs 并未展现出预期中的速度优势，甚至在性能上难以超越高度优化的 AR 推理引擎（如 vLLM）。问题并非源于并行本身，而是隐藏在模型结构与系统层面的深层冲突之中——<strong>大量现有扩散方法依赖双向注意力机制，破坏了前缀 KV 缓存这一现代推理系统的效率基石，迫使模型反复重算上下文，抵消了并行带来的潜在收益。</strong></p>
<p>在此背景下，<strong>腾讯微信 AI 团队提出了 WeDLM（WeChat Diffusion Language Model），</strong> 这是首个在工业级推理引擎（vLLM）优化条件下，推理速度超越同等 AR 模型的扩散语言模型。其核心思想是在保持严格因果掩码的前提下，让每个被掩码位置都能够条件化于当前所有已观测的 token。为此，研究人员引入了一种拓扑重排（Topological Reordering）方法，在不改变 token 逻辑位置的情况下，将已观测 token 移动到物理上的前缀区域。</p>
<p>实验结果表明，WeDLM 在保持强自回归 backbones 生成质量的同时，实现了显著的推理加速，具体而言，其在数学推理等任务上相较 vLLM 部署的 AR 模型实现了 3 倍以上加速，低熵场景的推理效率提速更是达到 10 倍以上。</p>
<p>目前，「WeDLM 高效大语言模型解码框架」已上线 OpenBayes 官网的教程版块，点击下方链接即可体验一键部署教程 ⬇️</p>
<p><strong>教程链接：</strong></p>
<p><em><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fgo.openbayes.com%2F9ooQJ" target="_blank" title="https://go.openbayes.com/9ooQJ" ref="nofollow noopener noreferrer">go.openbayes.com/9ooQJ</a></strong></em></p>
<p><strong>Demo 运行</strong></p>
<p><strong>01</strong></p>
<p><strong>Demo 运行阶段</strong></p>
<p>1.登录 OpenBayes.com，在「公共教程」页面，选择「WeDLM 高效大语言模型解码框架」教程。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4ba12501e86c4a0fb9bc2df216bc5044~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT3BlbkJheWVz6LSd5byP6K6h566X:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771396669&amp;x-signature=Qxz5WukftafNFd1Qq9c9QxXgtEE%3D" alt="图片" loading="lazy"/></p>
<p>2.页面跳转后，点击右上角「克隆」，将该教程克隆至自己的容器中。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4727f3045b1c4d6d96f1d0e49c48cb52~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT3BlbkJheWVz6LSd5byP6K6h566X:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771396669&amp;x-signature=3dSBSZcYV4%2FGPuAE085maf1x9X8%3D" alt="图片" loading="lazy"/></p>
<p>3.选择「NVIDIA GeForce RTX 5090」以及「PyTorch」镜像，按照需求选择「按量付费」或「包日/周/月」，点击「继续执行」。新用户使用下方邀请链接注册，即可获得满 ¥10 赠 ¥10 优惠券，更有机会获得 ¥15 赠金！</p>
<p>小贝总专属邀请链接（直接复制到浏览器打开）：</p>
<p><strong><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fgo.openbayes.com%2F9S6D******r" target="_blank" title="https://go.openbayes.com/9S6D******r" ref="nofollow noopener noreferrer">go.openbayes.com/9S6D******r</a></strong></strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d952164b764d4666a8068476e69c0a5b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT3BlbkJheWVz6LSd5byP6K6h566X:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771396669&amp;x-signature=9EtIZ7mPINwlePxg8VVxd4cJKTU%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cd938dfd5db140f3921f8cfb0089b9f6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT3BlbkJheWVz6LSd5byP6K6h566X:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771396669&amp;x-signature=Ykwy%2BGEjI2TZQPa45d7B73vhp5Q%3D" alt="图片" loading="lazy"/></p>
<p>4.等待分配资源，当状态变为「运行中」后，点击「打开工作空间」进入 Jupyter Workspace。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/336725070bd74f52a8765d2d28dddff9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT3BlbkJheWVz6LSd5byP6K6h566X:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771396669&amp;x-signature=ma35YJ54syg63h6ux3IlKInhDLA%3D" alt="图片" loading="lazy"/></p>
<p><strong>02</strong></p>
<p><strong>效果演示</strong></p>
<p>页面跳转后，点击左侧 README 页面，进入后点击上方「运行」。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1806815fa1d449e3ae0fdfaaa255516b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT3BlbkJheWVz6LSd5byP6K6h566X:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771396669&amp;x-signature=VKYM%2B%2B5P%2FLGJ9WHUuqE2CWzBysA%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/820b3fca18c94e5cb02dc40ec1386d52~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT3BlbkJheWVz6LSd5byP6K6h566X:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771396669&amp;x-signature=kEMYjIYeFmbtB7aLEa1RXgs6rms%3D" alt="图片" loading="lazy"/></p>
<p>待运行完成，即可点击右侧 API 地址跳转至 demo 页面。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5596b32541fb448ca50f05fe520f1ad4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT3BlbkJheWVz6LSd5byP6K6h566X:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771396669&amp;x-signature=HfuGhNlsjTKOLrAH82kA0%2BNo13Q%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/880889fb142843f0ad6c2947cac53df6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT3BlbkJheWVz6LSd5byP6K6h566X:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771396669&amp;x-signature=5igAYDz3an%2BKy5ZN4hajD9U6U%2FM%3D" alt="图片" loading="lazy"/></p>
<p><strong>教程链接：</strong></p>
<p><em><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fgo.openbayes.com%2F9ooQJ" target="_blank" title="https://go.openbayes.com/9ooQJ" ref="nofollow noopener noreferrer">go.openbayes.com/9ooQJ</a></strong></em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[实力领跑！ManageEngine卓豪终端管理荣获 2026 Gartner双料认可]]></title>    <link>https://juejin.cn/post/7605051886435172415</link>    <guid>https://juejin.cn/post/7605051886435172415</guid>    <pubDate>2026-02-11T06:38:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605051886435172415" data-draft-id="7605041451329159211" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="实力领跑！ManageEngine卓豪终端管理荣获 2026 Gartner双料认可"/> <meta itemprop="keywords" content="后端,JavaScript,面试"/> <meta itemprop="datePublished" content="2026-02-11T06:38:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ManageEngine卓豪官方账号"/> <meta itemprop="url" content="https://juejin.cn/user/1146167600363959"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            实力领跑！ManageEngine卓豪终端管理荣获 2026 Gartner双料认可
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1146167600363959/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ManageEngine卓豪官方账号
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-11T06:38:20.000Z" title="Wed Feb 11 2026 06:38:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/825e0156e5764a34afc82f9faa2e2ed2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFuYWdlRW5naW5l5Y2T6LGq5a6Y5pa56LSm5Y-3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771396700&amp;x-signature=Kr82KjTkARH56l13ALUHNjkgqKE%3D" alt="" loading="lazy"/></p>
<p><strong>ManageEngine卓豪跻身2026年Gartner终端管理工具魔力象限，并入选Gartner终端管理工具关键能力评估报告！</strong></p>
<p>终端设备数量持续增长、操作系统类型不断丰富、部署场景日趋多元，终端管理行业已迈入全新发展阶段。对于企业 IT 团队而言，终端管理已成为企业内部最复杂、最耗费资源的核心工作之一。如今，行业面临的挑战早已不只是单纯的设备管理，而是要以主动化、安全化的方式实现规模化终端管理，同时有效降低企业运维成本。</p>
<p>我们认为，2026 年Gartner的相关评估结果印证了这一行业变革趋势。<strong>ManageEngine卓豪获评 2026年Gartner魔力象限™挑战者象限，且在Gartner终端管理工具关键能力评估报告的四大使用场景中，所有维度评分均超 4 分。</strong> 在我们看来，这一成绩充分彰显了 Endpoint Central 产品实现终端管理与安全一体化的核心能力，也体现出其在向自动化、可规模化的管理平台迈进过程中取得的阶段性成果。本篇文章将深入解析Gartner的此次认可对我们的重要意义，以及对于正迈入终端管理新阶段的各企业而言，这一认可具备怎样的参考价值。</p>
<h2 data-id="heading-0"><strong>获评挑战者象限：Gartner评估的深层价值</strong></h2>
<p>本年度，Gartner首次发布终端管理市场魔力象限报告，本次评估围绕市场格局展开分析，并对各厂商的愿景完整性与执行能力进行了综合评判。我们认为，此次跻身挑战者象限，不仅印证了 Endpoint Central 已升级为一体化、自动化的管理平台，更彰显了产品的强劲执行实力、以自动化为核心的产品战略，以及出色的业务韧性。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/04629426c196421cae10dc99800f4046~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFuYWdlRW5naW5l5Y2T6LGq5a6Y5pa56LSm5Y-3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771396700&amp;x-signature=ovvxvil4fjew2V4iDNIADT8KFUQ%3D" alt="" loading="lazy"/></p>
<p><strong>ManageEngine卓豪在各使用场景的评分</strong></p>
<p>在配套发布的《2026 年Gartner终端管理工具关键能力评估报告》中，卓豪在<strong>自主终端管理、统一终端管理、安全中心式管理、一线设备管理</strong>四大核心使用场景的评分均超 4 分：</p>
<p>卓豪Endpoint Central 在自主终端管理场景中斩获 4.40/5 的高分；安全中心式管理场景评分为 4.36/5，一线设备管理场景评分为 4.25/5；统一终端管理场景的评分为 4.1/5。</p>
<h3 data-id="heading-1"><strong>统一终端管理</strong></h3>
<p>将设备从部署配置、监控排障到报废淘汰的完整生命周期管理功能，整合至单一统一控制台，减少工具冗余，实现跨不同操作系统及设备类型的标准化统一管理。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/323feb4bb7a44de3bbb8ec3a827c4cdf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFuYWdlRW5naW5l5Y2T6LGq5a6Y5pa56LSm5Y-3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771396700&amp;x-signature=68mudjcKiCfGwk0fZTPskQV5D4Q%3D" alt="" loading="lazy"/></p>
<p><strong>自主终端管理</strong></p>
<p>融合终端分析、自动化与可视化工作流能力，助力 IT 团队提前预判问题、统筹故障修复，并推动运维模式从被动响应式，逐步升级为规模化的主动式、自主化终端管理。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/93c5da4f2de4464fbbe3468c0bc503a0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFuYWdlRW5naW5l5Y2T6LGq5a6Y5pa56LSm5Y-3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771396700&amp;x-signature=jl0n5B6I95f4vA2nz13YO4ns3EY%3D" alt="" loading="lazy"/></p>
<p><strong>安全中心式管理</strong></p>
<p>通过策略驱动的管控机制、配置强制落地与及时补丁修复，整合终端管理与安全运维流程，助力企业降低安全风险、筑牢安全防护体系，并在分布式环境中持续满足合规要求。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/65dcac7049bf42b7b829c4c2c04f1ff4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFuYWdlRW5naW5l5Y2T6LGq5a6Y5pa56LSm5Y-3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771396700&amp;x-signature=2CyenMnm0FoUKug2HwiesTG%2FD2Q%3D" alt="" loading="lazy"/></p>
<p><strong>一线设备管理</strong></p>
<p>将集中化管控能力延伸至共享设备、自助服务终端、工业加固设备及任务专用设备，实现基于角色的管理、策略强制落地与全局可视管控，助力一线业务在保障可靠、安全运行的同时，不增加管理复杂度。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b42e72720018403289a3ebe928ce3ebb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFuYWdlRW5naW5l5Y2T6LGq5a6Y5pa56LSm5Y-3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771396700&amp;x-signature=3xDjSQOWcFyBaBD8yCBhLfbZSNA%3D" alt="" loading="lazy"/></p>
<p>在我们看来，此次评估也折射出终端管理平台评估维度的整体变革趋势。如今，企业需依靠精简的IT 团队，管理数量持续增长的设备、各类操作系统及分布式办公团队，其对终端管理的需求早已超越基础的设备管理范畴。企业 IT 管理者如今更需要一体化、自动化驱动的管理平台，能够减少运维工作量、避免业务中断，并为主动式、自主化的运维工作提供支撑。</p>
<p>为响应这一系列需求变化，企业也在重新定义终端管理的价值定位。而卓豪Endpoint Central 能够助力企业 IT 团队实现以下目标：</p>
<ul>
<li><strong>一体化精简终端运维工作</strong></li>
</ul>
<p>通过单一集成控制台，对设备从部署配置、监控排障到报废淘汰的完整生命周期进行全流程管理。卓豪 Endpoint Central 消除了工具碎片化问题，以单一统一控制台替代多款独立分散的管理工具，精简 IT 运维流程，实现对 Windows、macOS、Linux、ChromeOS、移动设备及各类专用终端的标准化统一管理。</p>
<ul>
<li><strong>依托自动化、流程编排与智能洞察提升运维效率</strong></li>
</ul>
<p>将日常运维任务自动化，规模化部署补丁与软件，并借助数据分析实现问题早发现。可视化工作流助力 IT 团队统筹编排主动式、响应式及预测式运维操作，减少人工工作量，提升整体运营效率。</p>
<ul>
<li><strong>规模化筑牢安全防护体系并持续满足合规要求</strong></li>
</ul>
<p>依托智能洞察与策略化管控机制，精准识别漏洞、强制落地配置策略、保障补丁及时修复。卓豪 Endpoint Central 打通运维与安全流程，实现终端管理模式升级，填补安全管理漏洞、降低安全风险，打造标准化、合规化的终端运行环境。</p>
<h2 data-id="heading-2"><strong>关于 Endpoint Central 终端管理平台</strong></h2>
<p><strong>Endpoint Central是一款一体化的终端管理与安全平台，企业可通过统一控制台和代理程序，对多元设备类型、各类操作系统下的现代化数字办公环境进行统一管理与安全防护。</strong> 平台为设备提供端到端的全生命周期管理能力，并配套搭载攻击面管理、威胁检测与响应、合规管理等安全功能，同时内置数字化员工体验洞察能力。强大的远程故障排查、自助服务功能，结合主动式分析能力，有效减少设备停机时间，全面提升终端用户体验。<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.manageengine.cn%2Fproducts%2Fdesktop-central%2Fdownload.html%3Futm_source%3Druanwen%26utm_platform%3Djuejin%26utm_medium%3Duem%26utm_campaign%3D20260211" target="_blank" title="https://www.manageengine.cn/products/desktop-central/download.html?utm_source=ruanwen&amp;utm_platform=juejin&amp;utm_medium=uem&amp;utm_campaign=20260211" ref="nofollow noopener noreferrer">立即下载</a></p>
<h2 data-id="heading-3"><strong>免责声明</strong></h2>
<p>Gartner《终端管理工具魔力象限报告》，作者：汤姆・西波拉、莉娜・阿尔・达纳、苏尼尔・库马尔、罗宾・米尔顿 - 舍内曼、托德・拉里维、克雷格・菲斯勒，2026 年 1 月 5 日Gartner《终端管理工具关键能力评估报告》，作者：莉娜・阿尔・达纳、汤姆・西波拉、苏尼尔・库马尔、罗宾・米尔顿 - 舍内曼、克雷格・菲斯勒、托德・拉里维，2026 年 1 月 5 日</p>
<p>Gartner（Gartner）与魔力象限（Magic Quadrant）为Gartner公司及其关联机构的商标。Gartner并未认可其出版物中提及的任何企业、厂商、产品或服务，亦未建议技术使用者仅选择评分最高或获得其他特定评级的厂商。Gartner出版物所载内容均为Gartner商业与技术洞察部门的观点，不应被视作事实陈述。Gartner对本出版物不作任何明示或暗示的担保，包括适销性或针对特定用途的适用性担保。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[击穿膨胀痛点：OpenTeleDB 源码编译与 XStore 引擎极限抗压实录]]></title>    <link>https://juejin.cn/post/7605142381152239679</link>    <guid>https://juejin.cn/post/7605142381152239679</guid>    <pubDate>2026-02-11T06:41:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605142381152239679" data-draft-id="7605049329779785769" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="击穿膨胀痛点：OpenTeleDB 源码编译与 XStore 引擎极限抗压实录"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-02-11T06:41:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="无爱如何释怀"/> <meta itemprop="url" content="https://juejin.cn/user/4158824111150512"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            击穿膨胀痛点：OpenTeleDB 源码编译与 XStore 引擎极限抗压实录
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4158824111150512/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    无爱如何释怀
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-11T06:41:15.000Z" title="Wed Feb 11 2026 06:41:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">击穿膨胀痛点：OpenTeleDB 源码编译与 XStore 引擎百万级数据抗压实录</h2>
<p>长期以来，PostgreSQL 凭借其强大的 SQL 兼容性和插件生态稳坐开源数据库的头把交椅。然而，对于经历过高并发写入场景的 DBA 而言，PG 也是让人“爱恨交织”的。其基于 MVCC（多版本并发控制）的 Append-only 存储机制，在高频更新下极易引发表空间膨胀（Bloat）。在生产环境中，逻辑数据只有 100GB，物理文件却肿胀到 500GB 的怪象并不罕见，运维人员不得不半夜起来跑 <code>VACUUM FULL</code> 锁表救命。</p>
<p>最近关注到 OpenTeleDB 开源项目，其核心卖点之一就是通过 XStore 存储引擎实现“原位更新”，号称能从根源解决膨胀问题。耳听为虚，为了验证这一特性是否具备生产级的抗压能力，我决定从源码构建开始，构建一个包含百万级数据的极限压测场景，看看它在“更新风暴”下的真实表现。</p>
<h3 data-id="heading-1">一、 极速构建：从源码到服务</h3>
<p>为了获得最纯净的测试环境，我选择直接从 Gitee 拉取 OpenTeleDB 的源码进行编译。对于熟悉 C/C++ 构建流程的开发者来说，这种方式虽然繁琐，但能确保对环境的绝对掌控。</p>
<p>首先，将代码仓库克隆到本地。</p>
<pre><code class="hljs language-Bash" lang="Bash">git <span class="hljs-built_in">clone</span> https://gitee.com/teledb/openteledb.git
</code></pre>
<p>代码拉取速度很快，目录结构展现了标准的 Postgres 风格。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7188224050bd4655a6a359ba67781327~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg54ix5aaC5L2V6YeK5oCA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771396874&amp;x-signature=u%2Fd0iGSbTONa2e1xmgDPfecwC2I%3D" alt="image.png" loading="lazy"/></p>
<p>数据库作为底层系统软件，对编译工具链和基础库有着严格要求。除了常规的 gcc 和 make，还需要 bison、flex 用于语法分析，以及 readline、zstd、lz4、ssl 等基础库的支持。我通过 apt 包管理器一次性安装了所有必要的依赖。</p>
<pre><code class="hljs language-Plaintext" lang="Plaintext">sudo apt update &amp;&amp; sudo apt install -y build-essential gcc g++ make bison flex libreadline-dev libzstd-dev liblz4-dev libssl-dev
</code></pre>
<p>依赖安装过程平稳，没有出现版本冲突。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1c60484e1f674b0483c61ced6722b079~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg54ix5aaC5L2V6YeK5oCA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771396874&amp;x-signature=ShCmLQCTJv7wtQPh5Vhxlg9%2BmyA%3D" alt="image.png" loading="lazy"/></p>
<p>为了避免在编译中途因为环境问题报错，我编写了一个环境验证脚本。这个脚本会逐一检查编译器版本、关键库的 pkg-config 信息，确保当前系统满足编译的最低门槛。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>
<span class="hljs-comment"># ... (脚本内容略，用于检查 GCC, Make, Flex, Bison 等版本) ...</span>
</code></pre>
<p>首次运行脚本时，检测结果并不完美。脚本敏锐地指出了系统中缺失 <code>CMake</code> 组件，这是部分构建工具链所依赖的。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c3f51f4a851e4430b7982ee7d7c161a7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg54ix5aaC5L2V6YeK5oCA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771396874&amp;x-signature=okAfehWd1pseeMkurgBsD7MUubs%3D" alt="image.png" loading="lazy"/></p>
<p>赋予脚本执行权限并再次确认。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aff9ba1745d849a5b23db7de245f23c4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg54ix5aaC5L2V6YeK5oCA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771396874&amp;x-signature=MHclKAwn2GzTkwy%2Boahf0mJ%2BK8g%3D" alt="image.png" loading="lazy"/></p>
<p>根据提示补全 <code>cmake</code>。</p>
<pre><code class="hljs language-bash" lang="bash">sudo apt-get install -y cmake
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f60f2c34031a4ec2a0e98c5f95b59250~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg54ix5aaC5L2V6YeK5oCA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771396874&amp;x-signature=gyldE2MWzmPUpn%2FXASzQC4JMTd0%3D" alt="image.png" loading="lazy"/></p>
<p>再次运行检测脚本，所有指标均显示绿色的“[通过]”。这意味着编译的前置障碍已被彻底扫除，可以进入核心构建阶段。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9549c21805aa496b8f31b7b4ef699671~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg54ix5aaC5L2V6YeK5oCA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771396874&amp;x-signature=NDkEF5CIqvaJ07KZqvaOijvGf1Q%3D" alt="image.png" loading="lazy"/></p>
<p>遵循最佳实践，我将数据库的安装目录与数据存储目录物理分离。<code>/opt/openteledb</code> 用于存放二进制文件，<code>/opt/openteledb_data</code> 用于存放业务数据。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">mkdir</span> -p /opt/openteledb
<span class="hljs-built_in">mkdir</span> -p /opt/openteledb_data
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4fd8d5b20f5e42f19c6232cad0d4446c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg54ix5aaC5L2V6YeK5oCA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771396874&amp;x-signature=zl5B8uTeROVxe0yST5dvVdcJewA%3D" alt="image.png" loading="lazy"/></p>
<p>配置环境变量，指定安装路径和数据路径，方便后续操作。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">export</span> pg_install_dir=/opt/openteledb 
<span class="hljs-built_in">export</span> pg_data_dir=/opt/openteledb_data
</code></pre>
<p>通过 echo 命令验证变量已正确加载。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4ea983f4d3b1498b8aa068e30dd246a5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg54ix5aaC5L2V6YeK5oCA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771396874&amp;x-signature=LACPa6OTzxcrYLMbrt8%2F1fYOR0g%3D" alt="image.png" loading="lazy"/></p>
<p>为了持久化配置，将其写入 bashrc 文件。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bcebcf6d823b41bb8a654dccb7097365~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg54ix5aaC5L2V6YeK5oCA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771396874&amp;x-signature=sA2SybVywLa5H9JZOPtWkS%2FK45M%3D" alt="image.png" loading="lazy"/></p>
<p>进入源码目录执行 <code>./configure</code>。这一步会根据系统环境生成定制化的 Makefile。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cd</span> openteledb/
./configure --prefix=/opt/openteledb
</code></pre>
<p>配置过程中抛出了 <code>library 'icuuc' is required</code> 的错误。OpenTeleDB 默认开启了 ICU（International Components for Unicode）支持，以处理复杂的多语言字符集排序和转换，这是企业级数据库的标配。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dd3e4d1cf40c41918016e9e5ee499d16~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg54ix5aaC5L2V6YeK5oCA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771396874&amp;x-signature=Bn1GvMZRhH73k85s8ICLy3%2FqFrU%3D" alt="image.png" loading="lazy"/></p>
<p>安装 <code>libicu-dev</code> 开发包解决此依赖。</p>
<pre><code class="hljs language-bash" lang="bash">apt update &amp;&amp; apt install -y libicu-dev
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6a2ab5cef03749c6a26e93b83a7b219d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg54ix5aaC5L2V6YeK5oCA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771396874&amp;x-signature=YIWbaR9fmNvvLXPl8xkLqN%2FKOqA%3D" alt="image.png" loading="lazy"/></p>
<p>重新配置，顺利通过。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/be94fb84afcc42288ec0fa30cf99cb34~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg54ix5aaC5L2V6YeK5oCA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771396874&amp;x-signature=dzquDk8cCa0%2FiUrcYzZ8SWLretM%3D" alt="image.png" loading="lazy"/></p>
<p>执行 <code>make &amp;&amp; make install</code> 进行编译和安装。这需要几分钟时间，直到看到安装成功的提示。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aef7872d543c42a299f5d9dfb8e12711~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg54ix5aaC5L2V6YeK5oCA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771396874&amp;x-signature=CLL1k%2FEJ409VPWlNORDOcVoSJ4w%3D" alt="image.png" loading="lazy"/></p>
<p>初始化数据库集群时，系统出于安全考虑拦截了 root 用户的操作。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1714ada8c8ee46c391bba10487bd9410~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg54ix5aaC5L2V6YeK5oCA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771396874&amp;x-signature=rr2xrjFZwUbdSabd%2Fc%2BiCcuPa3Q%3D" alt="image.png" loading="lazy"/></p>
<p>我创建了一个专用用户 <code>openteledb</code>，并将数据目录权限移交给他，随即以该用户身份成功完成初始化。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/555625b18e984f169046442c9520537d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg54ix5aaC5L2V6YeK5oCA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771396874&amp;x-signature=cF%2B2fBqt1UleChZHacXajh1c0Q4%3D" alt="image.png" loading="lazy"/></p>
<p>启动数据库服务。</p>
<pre><code class="hljs language-bash" lang="bash">/opt/openteledb/bin/pg_ctl -D /opt/openteledb_data -l /opt/openteledb_data/logfile start
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7890b760881c442cbd3a254627022821~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg54ix5aaC5L2V6YeK5oCA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771396874&amp;x-signature=x0O83xAIX4ISG3mO8%2FS%2Fvd%2FdzG4%3D" alt="image.png" loading="lazy"/></p>
<p>查看进程状态，主进程已在后台运行。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/773af2a2a7ae4f1ab36ae0627b8aca4c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg54ix5aaC5L2V6YeK5oCA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771396874&amp;x-signature=bPwFXmNMJraT9A9Z59fjDRLNKck%3D" alt="image.png" loading="lazy"/></p>
<p>通过 netstat 确认 5432 端口已被监听。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ca837b2b80cc4b8ba7bc62c5ada55eae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg54ix5aaC5L2V6YeK5oCA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771396874&amp;x-signature=dqIcm8fv3SfRLzVpE%2FaUt1lHvT4%3D" alt="image.png" loading="lazy"/></p>
<p>最后，使用客户端登录数据库，并加载核心扩展 <code>xstore</code>。至此，测试环境搭建完毕。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ce82639f2cde48a8a060a70069e2971b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg54ix5aaC5L2V6YeK5oCA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771396874&amp;x-signature=0t0bntBG%2FWaFv6r238JCrc9W7cA%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1036354d136b4550992ed440f99f563f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg54ix5aaC5L2V6YeK5oCA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771396874&amp;x-signature=02JKitlWuThsGs4i1x61QyExk6c%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-2">二、 深度原理解析：为何 PG 会“虚胖”？</h3>
<p>在开始压测前，有必要从底层原理层面理解为什么我们需要 XStore。</p>
<p>PostgreSQL 原生的 <strong>Heap 引擎</strong> 采用“追加写”模式。当你执行 <code>UPDATE user SET balance = 100</code> 时，PG 并不会修改原有的行，而是把旧行标记为“死元组”（Dead Tuple），并在新位置插入一行数据。</p>
<ul>
<li><strong>后果</strong>：一次更新 = 一次删除 + 一次插入。</li>
<li><strong>代价</strong>：如果 Autovacuum 来不及清理，这些死元组就会永久占用磁盘空间，导致查询时 I/O 效率大幅下降。</li>
</ul>
<p>而 OpenTeleDB 的 <strong>XStore 引擎</strong> 引入了类似 Oracle 和 MySQL InnoDB 的 <strong>Undo Log（回滚段）</strong> 机制。</p>
<ul>
<li><strong>机制</strong>：更新时，直接修改数据页上的记录（In-place Update），将旧版本数据写入 Undo 空间。</li>
<li><strong>优势</strong>：数据页不会因为版本堆积而分裂，从物理层面斩断了膨胀的根源。</li>
</ul>
<h3 data-id="heading-3">三、 极限压测：百万行数据的“更新风暴”</h3>
<p>为了验证上述理论，我没有使用只有几千行的小打小闹，而是直接构建了<strong>百万级数据</strong>的测试场景。</p>
<p><strong>1. 构建对照组</strong>
创建两张结构完全相同的表：<code>bench_heap</code> 使用原生引擎，<code>bench_xstore</code> 使用 XStore 引擎。为了模拟最极端的生产压力，我暂时关闭了两张表的自动清理（Autovacuum），让膨胀效应暴露无遗。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 创建原生 Heap 表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> bench_heap (id <span class="hljs-type">int</span>, payload text, update_cnt <span class="hljs-type">int</span>);
<span class="hljs-comment">-- 创建 XStore 表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> bench_xstore (id <span class="hljs-type">int</span>, payload text, update_cnt <span class="hljs-type">int</span>) <span class="hljs-keyword">USING</span> xstore;
<span class="hljs-comment">-- 关闭自动清理，模拟极端高压下的来不及清理的情况</span>
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> bench_heap <span class="hljs-keyword">SET</span> (autovacuum_enabled <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>);
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> bench_xstore <span class="hljs-keyword">SET</span> (autovacuum_enabled <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>);
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4057d4c3ab1d40f8948414ca001cd107~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg54ix5aaC5L2V6YeK5oCA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771396874&amp;x-signature=tz4i6wIHL4gG%2FBJIz4JDgxlCKIo%3D" alt="image.png" loading="lazy"/></p>
<p><strong>2. 注入基准数据</strong>
向两张表中各插入 <strong>100 万行</strong> 随机数据。这个量级足以体现出存储引擎在处理大规模数据时的真实表现。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> bench_heap <span class="hljs-keyword">SELECT</span> generate_series(<span class="hljs-number">1</span>, <span class="hljs-number">1000000</span>), md5(random()::text), <span class="hljs-number">0</span>;
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> bench_xstore <span class="hljs-keyword">SELECT</span> generate_series(<span class="hljs-number">1</span>, <span class="hljs-number">1000000</span>), md5(random()::text), <span class="hljs-number">0</span>;
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2c4496769f2343429baee61f94231fa6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg54ix5aaC5L2V6YeK5oCA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771396874&amp;x-signature=tfRA1gXUwxPDK38wwT7X2hTttuw%3D" alt="image.png" loading="lazy"/></p>
<p>此时，查看两张表的初始大小。可以看到，在纯插入场景下，两者的存储效率相当，均在 <strong>65MB</strong> 左右。这是我们测试的基准线，表明 XStore 在静态存储上没有额外的开销。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/622054ac497d4fd6ad70b19bec6fa08d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg54ix5aaC5L2V6YeK5oCA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771396874&amp;x-signature=x1ju3FYAMF7PDSatYBWg5B1pgHQ%3D" alt="image.png" loading="lazy"/></p>
<p><strong>3. 发起更新风暴（Update Storm）</strong>
接下来是本次测评的重头戏。我对这两张百万级大表进行了 <strong>5 轮全量更新</strong>。这意味着数据库需要处理 <strong>500 万次</strong> 写操作。</p>
<p>在原生 PG 的机制下，这理论上会产生 500 万个死元组。如果是原生引擎，表体积预计会发生剧烈膨胀。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 对 Heap 表进行 5 轮全表更新</span>
<span class="hljs-keyword">UPDATE</span> bench_heap <span class="hljs-keyword">SET</span> payload <span class="hljs-operator">=</span> md5(random()::text), update_cnt <span class="hljs-operator">=</span> update_cnt <span class="hljs-operator">+</span> <span class="hljs-number">1</span>;
... (执行<span class="hljs-number">5</span>次)
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1b8c143da0a34826a76b2cd67c4e19f9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg54ix5aaC5L2V6YeK5oCA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771396874&amp;x-signature=dTzR7Xw3XsX18K14jVPI4JTR6a0%3D" alt="image.png" loading="lazy"/></p>
<p>同样的压力给到 XStore 表。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 对 XStore 表进行 5 轮全表更新</span>
<span class="hljs-keyword">UPDATE</span> bench_xstore <span class="hljs-keyword">SET</span> payload <span class="hljs-operator">=</span> md5(random()::text), update_cnt <span class="hljs-operator">=</span> update_cnt <span class="hljs-operator">+</span> <span class="hljs-number">1</span>;
... (执行<span class="hljs-number">5</span>次)
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1ca58c4ad2564b209c5eaad1d85fdd9e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg54ix5aaC5L2V6YeK5oCA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771396874&amp;x-signature=Gi4c9VD12HndULvpYjC5IpE60NM%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-4">四、 结果剖析：云泥之别的存储表现</h3>
<p>测试结束后的查询结果令人震撼。这不仅仅是数字的差异，更是两种存储架构设计理念的直接碰撞。</p>
<p><strong>1. 空间膨胀率对比</strong></p>
<p>我查询了 <code>pg_relation_size</code> 来查看膨胀后的物理大小。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/32302ecc1e6943f5aadfb74759d08df4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg54ix5aaC5L2V6YeK5oCA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771396874&amp;x-signature=3bfML%2BPZ9ZRLAzT2K1l0nS9dso4%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li><strong>原生 Heap 表（bench_heap）</strong>：从初始的 73MB 暴涨到了 <strong>438MB</strong>。<strong>膨胀率高达 549%</strong>。这意味着磁盘上有 85% 的空间存储的是无用的垃圾数据。在生产环境中，如果这是一张 1TB 的表，经过几轮业务更新后，它会迅速吞噬掉 5TB 的磁盘空间，不仅造成存储成本的浪费，更会因为数据稀疏导致缓存命中率下降，拖慢全表扫描性能。</li>
<li><strong>XStore 表（bench_xstore）</strong>：依然维持在 <strong>71MB</strong>。<strong>膨胀率为 0%</strong>。无论更新多少轮，表的大小始终如一。这证明了 XStore 的“原位更新”机制成功生效——新数据直接覆盖了旧数据，而没有产生任何新的物理页。</li>
</ul>
<p><strong>2. 死元组（Dead Tuple）统计</strong></p>
<p>如果说表大小是表象，那么 <code>pg_stat_user_tables</code> 视图则揭示了本质。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/29c4513d96dd4de0bf9a86572fdae46a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg54ix5aaC5L2V6YeK5oCA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771396874&amp;x-signature=UEPWzcWJOdjPDlegRzEl1Y9QMLk%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li><strong>bench_heap</strong>：赫然显示着4999,992** 个死元组（n_dead_tup）。这正是我们执行那 500 万次更新留下的“尸体”。在真实场景中，这些死元组必须等待 Vacuum 进程消耗大量 CPU 和 I/O 资源来回收，这往往是数据库性能抖动的元凶。</li>
<li><strong>bench_xstore</strong>：死元组数量为 <strong>0</strong>。这不仅意味着节省了磁盘，更意味着数据库在运行期间<strong>彻底免除了 Vacuum 带来的计算开销</strong>。对于金融核心交易、物联网高频采集等写敏感型业务，这一特性具有极高的实战价值。</li>
</ul>
<h3 data-id="heading-5">五、 结语</h3>
<p>OpenTeleDB 并非 PostgreSQL 的简单分支，而是针对 PG 生态中 “数据膨胀” 这一核心痛点，在底层存储架构上进行了深度优化。</p>
<p>在本次从源码编译到百万级压测的全流程验证中，XStore 引擎在 100% 写入负载下展现出的零膨胀特性，以及稳定线性的 TPS 性能表现，充分证明了其架构设计的成熟度。这一特性对于长期受困于 PG 膨胀告警、业务高峰期性能波动的数据库运维团队而言，具有显著的实践价值。</p>
<p>对于以高频更新为核心业务模式，同时又希望保留 PostgreSQL 强大生态能力的技术团队，OpenTeleDB 提供了极具吸引力的技术选型。它基于 PG 生态进行演进，在保留其核心能力的同时，通过存储层的创新实现了性能突破，是一次务实且有效的技术迭代，值得行业持续关注。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[马年新春半价开跑！RTX 5090 低至 ¥1.45/时！]]></title>    <link>https://juejin.cn/post/7605164560711598106</link>    <guid>https://juejin.cn/post/7605164560711598106</guid>    <pubDate>2026-02-11T06:56:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605164560711598106" data-draft-id="7605136148592328731" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="马年新春半价开跑！RTX 5090 低至 ¥1.45/时！"/> <meta itemprop="keywords" content="深度学习,机器学习,人工智能"/> <meta itemprop="datePublished" content="2026-02-11T06:56:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="OpenBayes贝式计算"/> <meta itemprop="url" content="https://juejin.cn/user/2793222200375607"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            马年新春半价开跑！RTX 5090 低至 ¥1.45/时！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2793222200375607/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    OpenBayes贝式计算
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-11T06:56:37.000Z" title="Wed Feb 11 2026 06:56:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>策马扬鞭启新岁，乘势而上赴新程。新年将至，你是不是已经开始为这一年立下新的 Flag？</p>
<ul>
<li>
<p>今年要把拖了很久的项目落地交付！</p>
</li>
<li>
<p>今年要完整跑通那个大模型从训练到部署的全流程！</p>
</li>
<li>
<p>今年要做出有分量的研究成果，在顶刊上写下自己的名字！</p>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a6502c321ce246c4bcdbe1e2024afc26~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT3BlbkJheWVz6LSd5byP6K6h566X:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771397796&amp;x-signature=ccRq%2FbzXrosGZON9KkB2005QXUo%3D" alt="ee0f07cf82cd95f7700971ef0e1ddc1b.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/718643a924cf4a87be35f0105cee52fa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT3BlbkJheWVz6LSd5byP6K6h566X:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771397796&amp;x-signature=e87BvIb2xIU%2FkbXlFiUHtbvAsx0%3D" alt="c7d71c9bb45c11643f05ed0125edc1d7.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端都能看懂的Rust入门教程（四）——struct和trait]]></title>    <link>https://juejin.cn/post/7605105527258365952</link>    <guid>https://juejin.cn/post/7605105527258365952</guid>    <pubDate>2026-02-11T07:03:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605105527258365952" data-draft-id="7605107459066298414" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端都能看懂的Rust入门教程（四）——struct和trait"/> <meta itemprop="keywords" content="Rust,前端,后端"/> <meta itemprop="datePublished" content="2026-02-11T07:03:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="布列瑟农的星空"/> <meta itemprop="url" content="https://juejin.cn/user/976022056218471"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端都能看懂的Rust入门教程（四）——struct和trait
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/976022056218471/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    布列瑟农的星空
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-11T07:03:41.000Z" title="Wed Feb 11 2026 07:03:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>本节介绍Rust中的struct和trait。</p>
<p>这两者类似js或java中的class和interface，但概念上并不等同。可以用三句话概括Rust中的struct和trait设计理念：sturct主要关注数据的组织，trait主要关注行为的抽象，组合优于继承。</p>
<h2 data-id="heading-0">struct（结构体）</h2>
<p>Struct 是 Rust 中定义自定义数据类型的主要方式，它允许你将多个相关的值组合在一起，形成一个有意义的组合。</p>
<h3 data-id="heading-1">1. <strong>基本定义和使用</strong></h3>
<h4 data-id="heading-2">定义结构体</h4>
<p>使用 <code>struct</code> 关键字后跟结构体名称，接着用花括号 <code>{}</code> 包裹字段声明。每个字段都需要指定类型。</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// 定义一个结构体</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">User</span> {
    username: <span class="hljs-type">String</span>,
    email: <span class="hljs-type">String</span>,
    sign_in_count: <span class="hljs-type">u64</span>,
    active: <span class="hljs-type">bool</span>,
}
</code></pre>
<h4 data-id="heading-3">创建实例和访问属性</h4>
<p>使用结构体名称后跟带有初始化值的花括号 <code>{}</code> 来创建实例，每个字段必须被显式地赋予一个值。</p>
<p>使用 <code>pub</code> 关键字可以控制结构体及其字段的可见性。默认情况下，结构体和其字段是模块内部可见的。</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-comment">// 创建结构体实例</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">user1</span> = User {
        email: <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">"someone@example.com"</span>),
        <span class="hljs-keyword">pub</span> username: <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">"someusername123"</span>),
        active: <span class="hljs-literal">true</span>,
        sign_in_count: <span class="hljs-number">1</span>,
    };
    
    <span class="hljs-comment">// 访问字段</span>
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"用户名: {}"</span>, user1.username);
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"邮箱: {}"</span>, user1.email);
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"活跃状态: {}"</span>, user1.active);
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"登录次数: {}"</span>, user1.sign_in_count);
    
    <span class="hljs-comment">// 修改字段（需要 mut）</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">user2</span> = User {
        email: <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">"another@example.com"</span>),
        username: <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">"anotheruser"</span>),
        active: <span class="hljs-literal">true</span>,
        sign_in_count: <span class="hljs-number">0</span>,
    };
    
    user2.sign_in_count = <span class="hljs-number">1</span>;  <span class="hljs-comment">// 可以修改</span>
    user2.active = <span class="hljs-literal">false</span>;
}
</code></pre>
<h3 data-id="heading-4">2. <strong>结构体更新语法</strong></h3>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// 使用已有实例创建新实例</span>
<span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">user3</span> = User {
    email: <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">"third@example.com"</span>),
    username: <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">"thirduser"</span>),
    ..user1  <span class="hljs-comment">// 使用 user1 的其他字段值</span>
};

<span class="hljs-comment">// 等价于：</span>
<span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">user4</span> = User {
    email: <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">"fourth@example.com"</span>),
    username: <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">"fourthuser"</span>),
    active: user1.active,
    sign_in_count: user1.sign_in_count,
};
</code></pre>
<h3 data-id="heading-5">3. <strong>元组结构体</strong></h3>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// 元组结构体：有名字的元组</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Color</span>(<span class="hljs-type">i32</span>, <span class="hljs-type">i32</span>, <span class="hljs-type">i32</span>);
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Point</span>(<span class="hljs-type">i32</span>, <span class="hljs-type">i32</span>, <span class="hljs-type">i32</span>);

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">black</span> = <span class="hljs-title function_ invoke__">Color</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">origin</span> = <span class="hljs-title function_ invoke__">Point</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
    
    <span class="hljs-comment">// 通过索引访问</span>
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"黑色的红色分量: {}"</span>, black.<span class="hljs-number">0</span>);
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"原点的 x 坐标: {}"</span>, origin.<span class="hljs-number">0</span>);
    
    <span class="hljs-comment">// 即使字段类型相同，也是不同的类型</span>
    <span class="hljs-comment">// let color_point: Color = origin;  // 错误！类型不匹配</span>
}
</code></pre>
<h3 data-id="heading-6">4. impl方法定义</h3>
<p>上面的结构体更接近js中的interface，其本身只定义结构而无实现，因此也无法使用new来创建实例。</p>
<p>在Rust中要通过new创建实例，就需要对该结构体实现构造函数。</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// 定义一个Person结构体</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Person</span> {
    name: <span class="hljs-type">String</span>,
    age: <span class="hljs-type">u32</span>,
}

<span class="hljs-comment">// 为Person实现构造函数</span>
<span class="hljs-keyword">impl</span> <span class="hljs-title class_">Person</span> {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">new</span>(name: <span class="hljs-type">String</span>, age: <span class="hljs-type">u32</span>) <span class="hljs-punctuation">-&gt;</span> Person {
        Person { name, age }
    }
}

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-comment">// 使用new方法创建一个Person实例</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">person</span> = Person::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-string">"Alice"</span>.<span class="hljs-title function_ invoke__">to_string</span>(), <span class="hljs-number">30</span>);
    
    <span class="hljs-comment">// 访问结构体的字段</span>
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"Name: {}, Age: {}"</span>, person.name, person.age);
}
</code></pre>
<h4 data-id="heading-7">使用 <code>impl</code> 块定义结构体静态方法和成员方法</h4>
<p>通过<code>impl</code>块为结构体定义方法时，可以根据方法的第一个参数是否为<code>&amp;self</code>或<code>&amp;mut self</code>来区分静态方法和成员方法。</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Rectangle</span> {
    width: <span class="hljs-type">u32</span>,
    height: <span class="hljs-type">u32</span>,
}

<span class="hljs-comment">// 为 Rectangle 实现方法</span>
<span class="hljs-keyword">impl</span> <span class="hljs-title class_">Rectangle</span> {
    <span class="hljs-comment">// 关联函数（类似静态方法）</span>
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">square</span>(size: <span class="hljs-type">u32</span>) <span class="hljs-punctuation">-&gt;</span> Rectangle {
        Rectangle {
            width: size,
            height: size,
        }
    }
    
    <span class="hljs-comment">// 方法：第一个参数是 self</span>
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">area</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">u32</span> {
        <span class="hljs-keyword">self</span>.width * <span class="hljs-keyword">self</span>.height
    }
    
    <span class="hljs-comment">// 可变方法</span>
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">double</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>) {
        <span class="hljs-keyword">self</span>.width *= <span class="hljs-number">2</span>;
        <span class="hljs-keyword">self</span>.height *= <span class="hljs-number">2</span>;
    }
    
  
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">can_hold</span>(&amp;<span class="hljs-keyword">self</span>, other: &amp;Rectangle) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">bool</span> {
        <span class="hljs-keyword">self</span>.width &gt; other.width &amp;&amp; <span class="hljs-keyword">self</span>.height &gt; other.height
    }
}

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">rect1</span> = Rectangle {
        width: <span class="hljs-number">30</span>,
        height: <span class="hljs-number">50</span>,
    };
    
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"面积: {}"</span>, rect1.<span class="hljs-title function_ invoke__">area</span>());
    
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">rect2</span> = Rectangle {
        width: <span class="hljs-number">10</span>,
        height: <span class="hljs-number">40</span>,
    };
    
    rect2.<span class="hljs-title function_ invoke__">double</span>();
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"加倍后的面积: {}"</span>, rect2.<span class="hljs-title function_ invoke__">area</span>());
    
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"rect1 能包含 rect2 吗? {}"</span>, rect1.<span class="hljs-title function_ invoke__">can_hold</span>(&amp;rect2));
    
    <span class="hljs-comment">// 调用关联函数</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">square</span> = Rectangle::<span class="hljs-title function_ invoke__">square</span>(<span class="hljs-number">10</span>);
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"正方形的面积: {}"</span>, square.<span class="hljs-title function_ invoke__">area</span>());
}
</code></pre>
<h3 data-id="heading-8">5. <strong>多个 <code>impl</code> 块</strong></h3>
<p>在Rust中，struct可以有多个impl块，这带来了几个好处：</p>
<ol>
<li><strong>灵活性</strong>：可以在不同的地方、不同的模块中为同一个struct添加方法。例如，可以在定义struct的同一个文件中添加多个impl块，也可以在不同的文件中为struct实现方法（前提是struct和trait在同一个crate中，或者满足孤儿规则）。</li>
<li><strong>组织代码</strong>：可以将相关的方法分组到不同的impl块中，提高代码的可读性。例如，可以将实现某个trait的方法放在一个impl块中，而将struct自身的方法放在另一个impl块中。</li>
<li><strong>条件编译</strong>：可以为不同的编译条件提供不同的实现。例如，可以使用<code>#[cfg(target_os = "linux")]</code>属性为Linux系统提供特定的实现，而将其他系统的实现放在另一个impl块中。</li>
<li><strong>泛型特化</strong>：虽然Rust目前不支持完整的泛型特化，但通过多个impl块可以为不同的泛型参数提供不同的实现。例如，可以为某些特定的类型提供优化的实现。</li>
<li><strong>扩展性</strong>：可以在不修改原有impl块的情况下，为struct添加新的方法。这在编写库代码时尤其有用，因为可以在后续的版本中添加新的方法而不会破坏现有的代码。</li>
<li><strong>实现多个trait</strong>：每个trait的实现通常放在独立的impl块中，这样结构清晰，易于管理。</li>
</ol>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Counter</span> {
    count: <span class="hljs-type">u32</span>,
}

<span class="hljs-keyword">impl</span> <span class="hljs-title class_">Counter</span> {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">new</span>() <span class="hljs-punctuation">-&gt;</span> Counter {
        Counter { count: <span class="hljs-number">0</span> }
    }
}

<span class="hljs-keyword">impl</span> <span class="hljs-title class_">Counter</span> {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">increment</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>) {
        <span class="hljs-keyword">self</span>.count += <span class="hljs-number">1</span>;
    }
    
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">current</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">u32</span> {
        <span class="hljs-keyword">self</span>.count
    }
}
</code></pre>
<p><strong>注：多个impl块并不意味着同一个方法可以有不同的实现（即不允许重复定义相同签名的方法）。每个方法在一个struct中只能有一个实现。</strong></p>
<h3 data-id="heading-9">6. 泛型结构体</h3>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// 泛型结构体</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Point</span>&lt;T&gt; {
    x: T,
    y: T,
}

<span class="hljs-comment">// 为泛型结构体实现方法</span>
<span class="hljs-keyword">impl</span>&lt;T&gt; Point&lt;T&gt; {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">x</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> &amp;T {
        &amp;<span class="hljs-keyword">self</span>.x
    }
}

<span class="hljs-comment">// 可以为特定类型实现特定方法</span>
<span class="hljs-keyword">impl</span> <span class="hljs-title class_">Point</span>&lt;<span class="hljs-type">f32</span>&gt; {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">distance_from_origin</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">f32</span> {
        (<span class="hljs-keyword">self</span>.x.<span class="hljs-title function_ invoke__">powi</span>(<span class="hljs-number">2</span>) + <span class="hljs-keyword">self</span>.y.<span class="hljs-title function_ invoke__">powi</span>(<span class="hljs-number">2</span>)).<span class="hljs-title function_ invoke__">sqrt</span>()
    }
}

<span class="hljs-comment">// 多个泛型参数</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Pair</span>&lt;T, U&gt; {
    first: T,
    second: U,
}

<span class="hljs-keyword">impl</span>&lt;T, U&gt; Pair&lt;T, U&gt; {
    <span class="hljs-comment">// 关联函数可以返回不同类型的 Pair</span>
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">mixup</span>&lt;V, W&gt;(<span class="hljs-keyword">self</span>, other: Pair&lt;V, W&gt;) <span class="hljs-punctuation">-&gt;</span> Pair&lt;T, W&gt; {
        Pair {
            first: <span class="hljs-keyword">self</span>.first,
            second: other.second,
        }
    }
}

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">integer_point</span> = Point { x: <span class="hljs-number">5</span>, y: <span class="hljs-number">10</span> };
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">float_point</span> = Point { x: <span class="hljs-number">1.0</span>, y: <span class="hljs-number">4.0</span> };
    
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"整数点的 x: {}"</span>, integer_point.<span class="hljs-title function_ invoke__">x</span>());
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"浮点点的距离: {}"</span>, float_point.<span class="hljs-title function_ invoke__">distance_from_origin</span>());
    
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">pair1</span> = Pair { first: <span class="hljs-number">5</span>, second: <span class="hljs-number">10.4</span> };
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">pair2</span> = Pair { first: <span class="hljs-string">"Hello"</span>, second: <span class="hljs-string">'c'</span> };
    
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">mixed</span> = pair1.<span class="hljs-title function_ invoke__">mixup</span>(pair2);
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"混合后: {}, {}"</span>, mixed.first, mixed.second); <span class="hljs-comment">// 5, 'c'</span>
}
</code></pre>
<h2 data-id="heading-10">trait（派生）</h2>
<p>Rust中的trait是定义共享行为的一种方式。它类似ts中的interface，但更强大。trait定义了一组方法，这些方法可以被不同类型实现，从而允许不同类型共享相同的行为。</p>
<h2 data-id="heading-11">1. <strong>基本概念</strong></h2>
<h3 data-id="heading-12">定义 Trait</h3>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// 定义一个简单的 trait</span>
<span class="hljs-keyword">pub</span> <span class="hljs-keyword">trait</span> <span class="hljs-title class_">Summary</span> {
    <span class="hljs-comment">// 方法签名（没有默认实现）</span>
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">summarize</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">String</span>;
    
    <span class="hljs-comment">// 方法签名（有默认实现）</span>
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">summarize_short</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">String</span> {
        <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">"(Read more...)"</span>)
    }
}
</code></pre>
<h3 data-id="heading-13">实现 Trait</h3>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// 为结构体实现 trait</span>
<span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">NewsArticle</span> {
    <span class="hljs-keyword">pub</span> headline: <span class="hljs-type">String</span>,
    <span class="hljs-keyword">pub</span> location: <span class="hljs-type">String</span>,
    <span class="hljs-keyword">pub</span> author: <span class="hljs-type">String</span>,
    <span class="hljs-keyword">pub</span> content: <span class="hljs-type">String</span>,
}

<span class="hljs-keyword">impl</span> <span class="hljs-title class_">Summary</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">NewsArticle</span> {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">summarize</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">String</span> {
        <span class="hljs-built_in">format!</span>(<span class="hljs-string">"{}, by {} ({})"</span>, <span class="hljs-keyword">self</span>.headline, <span class="hljs-keyword">self</span>.author, <span class="hljs-keyword">self</span>.location)
    }
}

<span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">Tweet</span> {
    <span class="hljs-keyword">pub</span> username: <span class="hljs-type">String</span>,
    <span class="hljs-keyword">pub</span> content: <span class="hljs-type">String</span>,
    <span class="hljs-keyword">pub</span> reply: <span class="hljs-type">bool</span>,
    <span class="hljs-keyword">pub</span> retweet: <span class="hljs-type">bool</span>,
}

<span class="hljs-keyword">impl</span> <span class="hljs-title class_">Summary</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">Tweet</span> {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">summarize</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">String</span> {
        <span class="hljs-built_in">format!</span>(<span class="hljs-string">"{}: {}"</span>, <span class="hljs-keyword">self</span>.username, <span class="hljs-keyword">self</span>.content)
    }
    
    <span class="hljs-comment">// 覆盖默认实现</span>
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">summarize_short</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">String</span> {
        <span class="hljs-built_in">format!</span>(<span class="hljs-string">"Tweet by @{}"</span>, <span class="hljs-keyword">self</span>.username)
    }
}
</code></pre>
<h3 data-id="heading-14">使用 Trait</h3>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">article</span> = NewsArticle {
        headline: <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">"Penguins win the Stanley Cup Championship!"</span>),
        location: <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">"Pittsburgh, PA, USA"</span>),
        author: <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">"Iceburgh"</span>),
        content: <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">"The Pittsburgh Penguins once again are the best hockey team in the NHL."</span>),
    };
    
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">tweet</span> = Tweet {
        username: <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">"horse_ebooks"</span>),
        content: <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">"of course, as you probably already know, people"</span>),
        reply: <span class="hljs-literal">false</span>,
        retweet: <span class="hljs-literal">false</span>,
    };
    
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"Article summary: {}"</span>, article.<span class="hljs-title function_ invoke__">summarize</span>());
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"Tweet summary: {}"</span>, tweet.<span class="hljs-title function_ invoke__">summarize</span>());
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"Tweet short: {}"</span>, tweet.<span class="hljs-title function_ invoke__">summarize_short</span>());
}
</code></pre>
<h2 data-id="heading-15">2. Trait 作为参数类型</h2>
<h3 data-id="heading-16"><code>impl Trait</code> 语法</h3>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// 接受实现了 Summary trait 的类型</span>
<span class="hljs-keyword">fn</span> <span class="hljs-title function_">notify</span>(item: &amp;<span class="hljs-keyword">impl</span> <span class="hljs-title class_">Summary</span>) {
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"Breaking news! {}"</span>, item.<span class="hljs-title function_ invoke__">summarize</span>());
}

<span class="hljs-comment">// 使用</span>
<span class="hljs-title function_ invoke__">notify</span>(&amp;article);
<span class="hljs-title function_ invoke__">notify</span>(&amp;tweet);
</code></pre>
<h3 data-id="heading-17"><code>Trait Bound</code> 语法</h3>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// 更明确的写法</span>
<span class="hljs-keyword">fn</span> <span class="hljs-title function_">notify</span>&lt;T: Summary&gt;(item: &amp;T) {
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"Breaking news! {}"</span>, item.<span class="hljs-title function_ invoke__">summarize</span>());
}

<span class="hljs-comment">// 多个 trait bound</span>
<span class="hljs-keyword">fn</span> <span class="hljs-title function_">notify_multiple</span>&lt;T: Summary + Display&gt;(item: &amp;T) {
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"{}"</span>, item);
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"Summary: {}"</span>, item.<span class="hljs-title function_ invoke__">summarize</span>());
}
</code></pre>
<h2 data-id="heading-18">3. Trait 作为返回值类型</h2>
<h3 data-id="heading-19">返回实现了 Trait 的类型</h3>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// 返回实现了 Summary 的类型</span>
<span class="hljs-keyword">fn</span> <span class="hljs-title function_">returns_summarizable</span>() <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">impl</span> <span class="hljs-title class_">Summary</span> {
    Tweet {
        username: <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">"horse_ebooks"</span>),
        content: <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">"of course, as you probably already know, people"</span>),
        reply: <span class="hljs-literal">false</span>,
        retweet: <span class="hljs-literal">false</span>,
    }
}
</code></pre>
<h2 data-id="heading-20">组合优于继承</h2>
<p>Rust 语言没有传统面向对象语言中的继承（inheritance）概念，而是推崇组合（composition）和 trait 对象（trait objects）来实现代码复用和多态。</p>
<h3 data-id="heading-21">1. 成员属性组合</h3>
<p>在传统面向对象语言中，使用组合一般通过成员属性来实现，即<code>has-a</code>，这一点在Rust中也一样。</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// 基本的组合：一个结构体包含另一个结构体</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Engine</span> {
    horsepower: <span class="hljs-type">u32</span>,
    fuel_type: <span class="hljs-type">String</span>,
}

<span class="hljs-keyword">impl</span> <span class="hljs-title class_">Engine</span> {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">start</span>(&amp;<span class="hljs-keyword">self</span>) {
        <span class="hljs-built_in">println!</span>(<span class="hljs-string">"引擎启动，马力: {}"</span>, <span class="hljs-keyword">self</span>.horsepower);
    }
}

<span class="hljs-comment">// Car 包含 Engine，而不是继承自 Engine</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Car</span> {
    brand: <span class="hljs-type">String</span>,
    model: <span class="hljs-type">String</span>,
    engine: Engine,  <span class="hljs-comment">// 组合：Car 有一个 Engine</span>
}
</code></pre>
<h3 data-id="heading-22">2. trai实现多态</h3>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// 定义行为接口</span>
<span class="hljs-keyword">trait</span> <span class="hljs-title class_">Drawable</span> {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">draw</span>(&amp;<span class="hljs-keyword">self</span>);
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">area</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">f64</span>;
}

<span class="hljs-comment">// 多个类型实现相同的 trait</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Circle</span> {
    radius: <span class="hljs-type">f64</span>,
}

<span class="hljs-keyword">impl</span> <span class="hljs-title class_">Drawable</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">Circle</span> {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">draw</span>(&amp;<span class="hljs-keyword">self</span>) {
        <span class="hljs-built_in">println!</span>(<span class="hljs-string">"绘制圆形，半径: {}"</span>, <span class="hljs-keyword">self</span>.radius);
    }
    
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">area</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">f64</span> {
        std::<span class="hljs-type">f64</span>::consts::PI * <span class="hljs-keyword">self</span>.radius * <span class="hljs-keyword">self</span>.radius
    }
}

<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Square</span> {
    side: <span class="hljs-type">f64</span>,
}

<span class="hljs-keyword">impl</span> <span class="hljs-title class_">Drawable</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">Square</span> {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">draw</span>(&amp;<span class="hljs-keyword">self</span>) {
        <span class="hljs-built_in">println!</span>(<span class="hljs-string">"绘制正方形，边长: {}"</span>, <span class="hljs-keyword">self</span>.side);
    }
    
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">area</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">f64</span> {
        <span class="hljs-keyword">self</span>.side * <span class="hljs-keyword">self</span>.side
    }
}

<span class="hljs-comment">// 使用 trait 对象实现多态</span>
<span class="hljs-keyword">fn</span> <span class="hljs-title function_">render_all</span>(shapes: &amp;[&amp;<span class="hljs-keyword">dyn</span> Drawable]) {
    <span class="hljs-keyword">for</span> <span class="hljs-variable">shape</span> <span class="hljs-keyword">in</span> shapes {
        shape.<span class="hljs-title function_ invoke__">draw</span>();
        <span class="hljs-built_in">println!</span>(<span class="hljs-string">"面积: {}"</span>, shape.<span class="hljs-title function_ invoke__">area</span>());
    }
}
</code></pre>
<p>注：<code>dyn Drawable</code>：这是一个 trait 对象，表示任何实现了 <code>Drawable</code> trait 的类型。它是一个动态类型，在编译时不知道具体类型，但知道它实现了 <code>Drawable</code>。`</p>
<h3 data-id="heading-23">3. 使用 derive 自动实现 trait</h3>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// 使用 derive 自动实现 trait</span>
<span class="hljs-meta">#[derive(Debug, Clone, Copy, PartialEq, Eq, Hash)]</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Point</span> {
    x: <span class="hljs-type">i32</span>,
    y: <span class="hljs-type">i32</span>,
}
</code></pre>
<p>注：在Rust中，<code>#[derive(...)]</code>是一种属性（attribute），用于自动为结构体或枚举实现某些trait。这些trait通常是标准库中定义的一些常用trait，通过derive属性，编译器可以自动生成这些trait的实现代码，从而避免手动编写重复的代码。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[高性能 CSS 技术揭秘：Paint Worklet 与 Typed OM 应用]]></title>    <link>https://juejin.cn/post/7605142381152354367</link>    <guid>https://juejin.cn/post/7605142381152354367</guid>    <pubDate>2026-02-11T07:03:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605142381152354367" data-draft-id="7605142381152337983" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="高性能 CSS 技术揭秘：Paint Worklet 与 Typed OM 应用"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-02-11T07:03:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="火车叼位"/> <meta itemprop="url" content="https://juejin.cn/user/1345457960792808"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            高性能 CSS 技术揭秘：Paint Worklet 与 Typed OM 应用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1345457960792808/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    火车叼位
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-11T07:03:58.000Z" title="Wed Feb 11 2026 07:03:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body .octicon{display:inline-block;fill:currentColor;vertical-align:text-bottom}.markdown-body .anchor{float:left;line-height:1;margin-left:-20px;padding-right:4px}.markdown-body .anchor:focus{outline:none}.markdown-body h1 .octicon-link,.markdown-body h2 .octicon-link,.markdown-body h3 .octicon-link,.markdown-body h4 .octicon-link,.markdown-body h5 .octicon-link,.markdown-body h6 .octicon-link{color:#1b1f23;vertical-align:middle;visibility:hidden}.markdown-body h1:hover .anchor,.markdown-body h2:hover .anchor,.markdown-body h3:hover .anchor,.markdown-body h4:hover .anchor,.markdown-body h5:hover .anchor,.markdown-body h6:hover .anchor{text-decoration:none}.markdown-body h1:hover .anchor .octicon-link,.markdown-body h2:hover .anchor .octicon-link,.markdown-body h3:hover .anchor .octicon-link,.markdown-body h4:hover .anchor .octicon-link,.markdown-body h5:hover .anchor .octicon-link,.markdown-body h6:hover .anchor .octicon-link{visibility:visible}.markdown-body h1:hover .anchor .octicon-link:before,.markdown-body h2:hover .anchor .octicon-link:before,.markdown-body h3:hover .anchor .octicon-link:before,.markdown-body h4:hover .anchor .octicon-link:before,.markdown-body h5:hover .anchor .octicon-link:before,.markdown-body h6:hover .anchor .octicon-link:before{width:16px;height:16px;content:" ";display:inline-block;background-image:url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' aria-hidden='true'%3E%3Cpath fill-rule='evenodd' d='M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z'/%3E%3C/svg%3E")}.markdown-body{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;color:#24292e;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,sans-serif,Apple Color Emoji,Segoe UI Emoji;font-size:16px;line-height:1.5;word-wrap:break-word}.markdown-body details{display:block}.markdown-body summary{display:list-item}.markdown-body a{background-color:initial}.markdown-body a:active,.markdown-body a:hover{outline-width:0}.markdown-body strong{font-weight:inherit;font-weight:bolder}.markdown-body h1{margin:.67em 0}.markdown-body img{border-style:none}.markdown-body code,.markdown-body kbd,.markdown-body pre{font-family:monospace,monospace;font-size:1em}.markdown-body hr{box-sizing:initial;overflow:visible}.markdown-body input{font:inherit;margin:0;overflow:visible}.markdown-body [type=checkbox]{box-sizing:border-box;padding:0}.markdown-body *{box-sizing:border-box}.markdown-body input{font-family:inherit;font-size:inherit;line-height:inherit}.markdown-body a{color:#0366d6;text-decoration:none}.markdown-body a:hover{text-decoration:underline}.markdown-body strong{font-weight:600}.markdown-body hr{height:0;margin:15px 0;overflow:hidden;background:transparent;border-bottom:1px solid #dfe2e5}.markdown-body hr:after,.markdown-body hr:before{display:table;content:""}.markdown-body hr:after{clear:both}.markdown-body table{border-spacing:0;border-collapse:collapse}.markdown-body td,.markdown-body th{padding:0}.markdown-body details summary{cursor:pointer}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin-top:0;margin-bottom:0}.markdown-body h1{font-size:32px}.markdown-body h1,.markdown-body h2{font-weight:600}.markdown-body h2{font-size:24px}.markdown-body h3{font-size:20px}.markdown-body h3,.markdown-body h4{font-weight:600}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:14px}.markdown-body h5,.markdown-body h6{font-weight:600}.markdown-body h6{font-size:12px}.markdown-body p{margin-top:0;margin-bottom:10px}.markdown-body blockquote{margin:0}.markdown-body ol,.markdown-body ul{padding-left:0;margin-top:0;margin-bottom:0}.markdown-body ol ol,.markdown-body ul ol{list-style-type:lower-roman}.markdown-body ol ol ol,.markdown-body ol ul ol,.markdown-body ul ol ol,.markdown-body ul ul ol{list-style-type:lower-alpha}.markdown-body dd{margin-left:0}.markdown-body code,.markdown-body pre{font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px}.markdown-body pre{margin-top:0;margin-bottom:0}.markdown-body input::-webkit-inner-spin-button,.markdown-body input::-webkit-outer-spin-button{margin:0;-webkit-appearance:none;appearance:none}.markdown-body :checked+.radio-label{position:relative;z-index:1;border-color:#0366d6}.markdown-body .border{border:1px solid #e1e4e8!important}.markdown-body .border-0{border:0!important}.markdown-body .border-bottom{border-bottom:1px solid #e1e4e8!important}.markdown-body .rounded-1{border-radius:3px!important}.markdown-body .bg-white{background-color:#fff!important}.markdown-body .bg-gray-light{background-color:#fafbfc!important}.markdown-body .text-gray-light{color:#6a737d!important}.markdown-body .pl-3,.markdown-body .px-3{padding-left:16px!important}.markdown-body .px-3{padding-right:16px!important}.markdown-body .f6{font-size:12px!important}.markdown-body .lh-condensed{line-height:1.25!important}.markdown-body .text-bold{font-weight:600!important}.markdown-body .pl-c{color:#6a737d}.markdown-body .pl-c1,.markdown-body .pl-s .pl-v{color:#005cc5}.markdown-body .pl-e,.markdown-body .pl-en{color:#6f42c1}.markdown-body .pl-s .pl-s1,.markdown-body .pl-smi{color:#24292e}.markdown-body .pl-ent{color:#22863a}.markdown-body .pl-k{color:#d73a49}.markdown-body .pl-pds,.markdown-body .pl-s,.markdown-body .pl-s .pl-pse .pl-s1,.markdown-body .pl-sr,.markdown-body .pl-sr .pl-cce,.markdown-body .pl-sr .pl-sra,.markdown-body .pl-sr .pl-sre{color:#032f62}.markdown-body .pl-smw,.markdown-body .pl-v{color:#e36209}.markdown-body .pl-bu{color:#b31d28}.markdown-body .pl-ii{color:#fafbfc;background-color:#b31d28}.markdown-body .pl-c2{color:#fafbfc;background-color:#d73a49}.markdown-body .pl-c2:before{content:"^M"}.markdown-body .pl-sr .pl-cce{font-weight:700;color:#22863a}.markdown-body .pl-ml{color:#735c0f}.markdown-body .pl-mh,.markdown-body .pl-mh .pl-en,.markdown-body .pl-ms{font-weight:700;color:#005cc5}.markdown-body .pl-mi{font-style:italic;color:#24292e}.markdown-body .pl-mb{font-weight:700;color:#24292e}.markdown-body .pl-md{color:#b31d28;background-color:#ffeef0}.markdown-body .pl-mi1{color:#22863a;background-color:#f0fff4}.markdown-body .pl-mc{color:#e36209;background-color:#ffebda}.markdown-body .pl-mi2{color:#f6f8fa;background-color:#005cc5}.markdown-body .pl-mdr{font-weight:700;color:#6f42c1}.markdown-body .pl-ba{color:#586069}.markdown-body .pl-sg{color:#959da5}.markdown-body .pl-corl{text-decoration:underline;color:#032f62}.markdown-body .mb-0{margin-bottom:0!important}.markdown-body .my-2{margin-bottom:8px!important;margin-top:8px!important}.markdown-body .pl-0{padding-left:0!important}.markdown-body .py-0{padding-top:0!important;padding-bottom:0!important}.markdown-body .pl-1{padding-left:4px!important}.markdown-body .pl-2{padding-left:8px!important}.markdown-body .py-2{padding-top:8px!important;padding-bottom:8px!important}.markdown-body .pl-3{padding-left:16px!important}.markdown-body .pl-4{padding-left:24px!important}.markdown-body .pl-5{padding-left:32px!important}.markdown-body .pl-6{padding-left:40px!important}.markdown-body .pl-7{padding-left:48px!important}.markdown-body .pl-8{padding-left:64px!important}.markdown-body .pl-9{padding-left:80px!important}.markdown-body .pl-10{padding-left:96px!important}.markdown-body .pl-11{padding-left:112px!important}.markdown-body .pl-12{padding-left:128px!important}.markdown-body hr{border-bottom-color:#eee}.markdown-body kbd{display:inline-block;padding:3px 5px;font:11px SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;line-height:10px;color:#444d56;vertical-align:middle;background-color:#fafbfc;border:1px solid #d1d5da;border-radius:3px;box-shadow:inset 0 -1px 0 #d1d5da}.markdown-body:after,.markdown-body:before{display:table;content:""}.markdown-body:after{clear:both}.markdown-body&gt;:first-child{margin-top:0!important}.markdown-body&gt;:last-child{margin-bottom:0!important}.markdown-body a:not([href]){color:inherit;text-decoration:none}.markdown-body blockquote,.markdown-body details,.markdown-body dl,.markdown-body ol,.markdown-body p,.markdown-body pre,.markdown-body table,.markdown-body ul{margin-top:0;margin-bottom:16px}.markdown-body hr{height:.25em;padding:0;margin:24px 0;background-color:#e1e4e8;border:0}.markdown-body blockquote{padding:0 1em;color:#6a737d;border-left:.25em solid #dfe2e5}.markdown-body blockquote&gt;:first-child{margin-top:0}.markdown-body blockquote&gt;:last-child{margin-bottom:0}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin-top:24px;margin-bottom:16px;font-weight:600;line-height:1.25}.markdown-body h1{font-size:2em}.markdown-body h1,.markdown-body h2{padding-bottom:.3em;border-bottom:1px solid #eaecef}.markdown-body h2{font-size:1.5em}.markdown-body h3{font-size:1.25em}.markdown-body h4{font-size:1em}.markdown-body h5{font-size:.875em}.markdown-body h6{font-size:.85em;color:#6a737d}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:0;margin-bottom:0}.markdown-body li{word-wrap:break-all}.markdown-body li&gt;p{margin-top:16px}.markdown-body li+li{margin-top:.25em}.markdown-body dl{padding:0}.markdown-body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:600}.markdown-body dl dd{padding:0 16px;margin-bottom:16px}.markdown-body table{display:block;width:100%;overflow:auto}.markdown-body table th{font-weight:600}.markdown-body table td,.markdown-body table th{padding:6px 13px;border:1px solid #dfe2e5}.markdown-body table tr{background-color:#fff;border-top:1px solid #c6cbd1}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}.markdown-body img{max-width:100%;box-sizing:initial;background-color:#fff}.markdown-body img[align=right]{padding-left:20px}.markdown-body img[align=left]{padding-right:20px}.markdown-body code{padding:.2em .4em;margin:0;font-size:85%;background-color:rgba(27,31,35,.05);border-radius:3px}.markdown-body pre{word-wrap:normal}.markdown-body pre&gt;code{padding:0;margin:0;font-size:100%;word-break:normal;white-space:pre;background:transparent;border:0}.markdown-body .highlight{margin-bottom:16px}.markdown-body .highlight pre{margin-bottom:0;word-break:normal}.markdown-body .highlight pre,.markdown-body pre{padding:16px;overflow:auto;font-size:85%;line-height:1.45;background-color:#f6f8fa;border-radius:3px}.markdown-body pre code{display:inline;max-width:auto;padding:0;margin:0;overflow:visible;line-height:inherit;word-wrap:normal;background-color:initial;border:0}.markdown-body .commit-tease-sha{display:inline-block;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:90%;color:#444d56}.markdown-body .full-commit .btn-outline:not(:disabled):hover{color:#005cc5;border-color:#005cc5}.markdown-body .blob-wrapper{overflow-x:auto;overflow-y:hidden}.markdown-body .blob-wrapper-embedded{max-height:240px;overflow-y:auto}.markdown-body .blob-num{width:1%;min-width:50px;padding-right:10px;padding-left:10px;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px;line-height:20px;color:rgba(27,31,35,.3);text-align:right;white-space:nowrap;vertical-align:top;cursor:pointer;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-body .blob-num:hover{color:rgba(27,31,35,.6)}.markdown-body .blob-num:before{content:attr(data-line-number)}.markdown-body .blob-code{position:relative;padding-right:10px;padding-left:10px;line-height:20px;vertical-align:top}.markdown-body .blob-code-inner{overflow:visible;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px;color:#24292e;word-wrap:normal;white-space:pre}.markdown-body .pl-token.active,.markdown-body .pl-token:hover{cursor:pointer;background:#ffea7f}.markdown-body .tab-size[data-tab-size="1"]{-moz-tab-size:1;tab-size:1}.markdown-body .tab-size[data-tab-size="2"]{-moz-tab-size:2;tab-size:2}.markdown-body .tab-size[data-tab-size="3"]{-moz-tab-size:3;tab-size:3}.markdown-body .tab-size[data-tab-size="4"]{-moz-tab-size:4;tab-size:4}.markdown-body .tab-size[data-tab-size="5"]{-moz-tab-size:5;tab-size:5}.markdown-body .tab-size[data-tab-size="6"]{-moz-tab-size:6;tab-size:6}.markdown-body .tab-size[data-tab-size="7"]{-moz-tab-size:7;tab-size:7}.markdown-body .tab-size[data-tab-size="8"]{-moz-tab-size:8;tab-size:8}.markdown-body .tab-size[data-tab-size="9"]{-moz-tab-size:9;tab-size:9}.markdown-body .tab-size[data-tab-size="10"]{-moz-tab-size:10;tab-size:10}.markdown-body .tab-size[data-tab-size="11"]{-moz-tab-size:11;tab-size:11}.markdown-body .tab-size[data-tab-size="12"]{-moz-tab-size:12;tab-size:12}.markdown-body .task-list-item{list-style-type:none}.markdown-body .task-list-item+.task-list-item{margin-top:3px}.markdown-body .task-list-item input{margin:0 .2em .25em -1.6em;vertical-align:middle}</style><style data-highlight="" data-highlight-key="a11y-light">.hljs-comment,.hljs-quote{color:#696969}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#d91e18}.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#aa5d00}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:green}.hljs-section,.hljs-title{color:#007faa}.hljs-keyword,.hljs-selector-tag{color:#7928a1}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fefefe;color:#545454}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h2 data-id="heading-0">一、什么是 CSS Houdini？</h2>
<p>CSS Houdini 是 W3C 发起的一项规范集合，目标是<strong>开放浏览器渲染管线能力给开发者</strong>。传统 CSS 属于“声明式黑盒”，开发者无法干预底层渲染逻辑；而 Houdini 允许 JavaScript 在特定阶段参与样式计算与绘制。</p>
<p>根据 W3C 官方定义，Houdini 包含多个模块，其中较具实用价值的包括：</p>
<ul>
<li><strong>CSS Paint API（Paint Worklet）</strong></li>
<li><strong>CSS Typed Object Model（Typed OM）</strong></li>
</ul>
<p>官方规范来源：</p>
<ul>
<li>W3C CSS Houdini Task Force</li>
<li>Drafts: <a href="https://link.juejin.cn?target=https%3A%2F%2Fdrafts.css-houdini.org%2F" target="_blank" title="https://drafts.css-houdini.org/" ref="nofollow noopener noreferrer">drafts.css-houdini.org/</a></li>
</ul>
<hr/>
<h2 data-id="heading-1">二、CSS Paint API：让 JS 参与浏览器绘制</h2>
<h3 data-id="heading-2">1️⃣ 它是什么？</h3>
<p><strong>CSS Paint API</strong> 允许开发者使用 JavaScript 编写自定义绘制逻辑，并在 CSS 中像使用 <code>background</code> 一样调用。</p>
<p>它本质是：</p>
<blockquote>
<p>一个通过 JavaScript 生成 CSS 图像的 API
运行在浏览器渲染引擎的 Paint Worklet 中（脱离主线程）</p>
</blockquote>
<hr/>
<h3 data-id="heading-3">2️⃣ 为什么要使用 Paint API？</h3>
<p>典型收益包括：</p>
<ul>
<li>✅ 减少 DOM 节点</li>
<li>✅ 替代静态图片资源（减少体积）</li>
<li>✅ 实现原生 CSS 难以实现的视觉效果</li>
<li>✅ 高性能动态背景与交互</li>
</ul>
<p>特别适用于：</p>
<ul>
<li>动态背景</li>
<li>复杂边框</li>
<li>渐变动画</li>
<li>噪声纹理</li>
<li>高性能视觉系统</li>
</ul>
<hr/>
<h3 data-id="heading-4">3️⃣ 如何实现？</h3>
<h4 data-id="heading-5">Step 1：定义 Worklet</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// paint.js</span>
<span class="hljs-title function_">registerPaint</span>(<span class="hljs-string">'circle-bg'</span>, <span class="hljs-keyword">class</span> {
  <span class="hljs-title function_">paint</span>(<span class="hljs-params">ctx, size, properties</span>) {
    <span class="hljs-keyword">const</span> radius = size.<span class="hljs-property">width</span> / <span class="hljs-number">2</span>;
    ctx.<span class="hljs-property">fillStyle</span> = <span class="hljs-string">'blue'</span>;
    ctx.<span class="hljs-title function_">beginPath</span>();
    ctx.<span class="hljs-title function_">arc</span>(radius, radius, radius, <span class="hljs-number">0</span>, <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> * <span class="hljs-number">2</span>);
    ctx.<span class="hljs-title function_">fill</span>();
  }
});
</code></pre>
<h4 data-id="heading-6">Step 2：注册模块</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-variable constant_">CSS</span>.<span class="hljs-property">paintWorklet</span>.<span class="hljs-title function_">addModule</span>(<span class="hljs-string">'paint.js'</span>);
</code></pre>
<h4 data-id="heading-7">Step 3：CSS 中调用</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.box</span> {
  <span class="hljs-attribute">background</span>: <span class="hljs-built_in">paint</span>(circle-bg);
}
</code></pre>
<hr/>
<h3 data-id="heading-8">4️⃣ 运行机制与限制</h3>
<ul>
<li>
<p>运行环境：<strong>Paint Worklet</strong></p>
</li>
<li>
<p>不可访问：</p>
<ul>
<li>DOM</li>
<li>window</li>
<li>document</li>
</ul>
</li>
<li>
<p>属于独立线程执行（提升性能）</p>
</li>
</ul>
<p>兼容性说明：</p>
<ul>
<li>目前主要在 <strong>Chromium 系浏览器</strong> 中支持较好</li>
<li>Safari 与 Firefox 支持有限（需关注 MDN 更新）</li>
</ul>
<p>来源：MDN Web Docs – CSS Paint API</p>
<hr/>
<h3 data-id="heading-9">5️⃣ 最佳实践</h3>
<h4 data-id="heading-10">性能优化</h4>
<ul>
<li>避免在 <code>paint()</code> 中执行复杂计算</li>
<li>不要进行大规模循环或随机生成</li>
</ul>
<h4 data-id="heading-11">兼容处理</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-keyword">@supports</span> (<span class="hljs-attribute">background</span>: paint(circle-bg)) {
  <span class="hljs-selector-class">.box</span> {
    <span class="hljs-attribute">background</span>: <span class="hljs-built_in">paint</span>(circle-bg);
  }
}
</code></pre>
<h4 data-id="heading-12">动态参数控制</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.box</span> {
  <span class="hljs-attr">--circle-color</span>: red;
  <span class="hljs-attribute">background</span>: <span class="hljs-built_in">paint</span>(circle-bg);
}
</code></pre>
<p>通过 CSS 自定义属性触发重绘。</p>
<hr/>
<h2 data-id="heading-13">三、CSS Typed OM：高性能 CSS-in-JS 新方式</h2>
<h3 data-id="heading-14">1️⃣ 它是什么？</h3>
<p>Typed OM 的核心目标：</p>
<blockquote>
<p>将 CSS 属性值映射为 JS 对象，而不是字符串</p>
</blockquote>
<p>例如：</p>
<p>传统方式：</p>
<pre><code class="hljs language-js" lang="js">element.<span class="hljs-property">style</span>.<span class="hljs-property">width</span> = <span class="hljs-string">"100px"</span>;
</code></pre>
<p>Typed OM：</p>
<pre><code class="hljs language-js" lang="js">element.<span class="hljs-property">attributeStyleMap</span>.<span class="hljs-title function_">set</span>(<span class="hljs-string">'width'</span>, <span class="hljs-variable constant_">CSS</span>.<span class="hljs-title function_">px</span>(<span class="hljs-number">100</span>));
</code></pre>
<hr/>
<h3 data-id="heading-15">2️⃣ 为什么需要 Typed OM？</h3>
<p>传统 CSS 操作存在问题：</p>
<ul>
<li>字符串拼接易出错</li>
<li>单位转换复杂</li>
<li>频繁解析影响性能</li>
<li>无类型安全</li>
</ul>
<p>Typed OM 优势：</p>
<ul>
<li>✅ 类型安全</li>
<li>✅ 支持数学运算</li>
<li>✅ 避免重复解析</li>
<li>✅ 更高性能</li>
</ul>
<hr/>
<h3 data-id="heading-16">3️⃣ 如何使用？</h3>
<h4 data-id="heading-17">读取样式</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> styles = element.<span class="hljs-title function_">computedStyleMap</span>();
<span class="hljs-keyword">const</span> width = styles.<span class="hljs-title function_">get</span>(<span class="hljs-string">'width'</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(width.<span class="hljs-property">value</span>); <span class="hljs-comment">// 数值</span>
</code></pre>
<h4 data-id="heading-18">写入样式</h4>
<pre><code class="hljs language-js" lang="js">element.<span class="hljs-property">attributeStyleMap</span>.<span class="hljs-title function_">set</span>(<span class="hljs-string">'height'</span>, <span class="hljs-variable constant_">CSS</span>.<span class="hljs-title function_">px</span>(<span class="hljs-number">200</span>));
</code></pre>
<h4 data-id="heading-19">单位运算</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> newWidth = <span class="hljs-variable constant_">CSS</span>.<span class="hljs-title function_">px</span>(<span class="hljs-number">100</span>).<span class="hljs-title function_">add</span>(<span class="hljs-variable constant_">CSS</span>.<span class="hljs-title function_">px</span>(<span class="hljs-number">50</span>));
</code></pre>
<hr/>
<h3 data-id="heading-20">4️⃣ 运行位置与限制</h3>
<ul>
<li>运行在线程：主线程 JS 引擎</li>
<li>Computed Map 通常为只读</li>
<li>某些特殊属性支持不完整</li>
</ul>
<p>兼容性：</p>
<ul>
<li>主流 Chromium、Safari 已支持主要功能</li>
<li>仍需检测支持情况</li>
</ul>
<p>参考：
MDN – CSS Typed Object Model</p>
<hr/>
<h2 data-id="heading-21">四、Paint API 与 Typed OM 的协同价值</h2>
<p>二者结合可以构建：</p>
<ul>
<li>高性能动画系统</li>
<li>复杂可配置视觉组件</li>
<li>可参数化视觉设计系统</li>
</ul>
<p>例如：</p>
<ul>
<li>使用 Typed OM 控制尺寸</li>
<li>使用 Paint API 绘制自定义视觉</li>
<li>利用 CSS 变量触发 Worklet 重绘</li>
</ul>
<p>这是一种<strong>渲染管线级别的扩展能力</strong>。</p>
<hr/>
<h2 data-id="heading-22">五、什么时候应该使用？</h2>
<p>适合使用场景：</p>

























<table><thead><tr><th>场景</th><th>建议</th></tr></thead><tbody><tr><td>高频动画</td><td>使用 Typed OM</td></tr><tr><td>自定义背景绘制</td><td>使用 Paint API</td></tr><tr><td>复杂视觉组件</td><td>两者结合</td></tr><tr><td>传统业务后台系统</td><td>不建议引入</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-23">六、三条可执行建议</h2>
<p>1️⃣ 如果项目存在大量字符串拼接样式更新，可优先迁移至 Typed OM。
2️⃣ 若需要复杂视觉背景，优先考虑 Paint API 替代图片资源。
3️⃣ 必须添加 <code>@supports</code> 作为兼容降级策略。</p>
<hr/>
<h2 data-id="heading-24">七、技术成本评估</h2>





















<table><thead><tr><th>项目</th><th>成本</th></tr></thead><tbody><tr><td>学习成本</td><td>需理解 Canvas API 与 Worklet</td></tr><tr><td>兼容处理</td><td>必须做降级</td></tr><tr><td>架构调整</td><td>可能影响现有样式管理方式</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-25">八、结论</h2>
<p>CSS Houdini 的 Paint API 与 Typed OM 代表了浏览器渲染能力的开放趋势。它们不是“炫技工具”，而是：</p>
<ul>
<li>更少 DOM</li>
<li>更低资源消耗</li>
<li>更高渲染控制权</li>
<li>更优性能路径</li>
</ul>
<p>对于追求性能极限和视觉创新的前端团队来说，这是值得投入的方向。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Cursor 里的模型介绍：区别与使用场景]]></title>    <link>https://juejin.cn/post/7605164560710795290</link>    <guid>https://juejin.cn/post/7605164560710795290</guid>    <pubDate>2026-02-11T04:06:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605164560710795290" data-draft-id="7605135197165928498" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Cursor 里的模型介绍：区别与使用场景"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-02-11T04:06:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="兔子零1024"/> <meta itemprop="url" content="https://juejin.cn/user/3743194047592062"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Cursor 里的模型介绍：区别与使用场景
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3743194047592062/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    兔子零1024
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-11T04:06:45.000Z" title="Wed Feb 11 2026 04:06:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    13
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{line-height:1.75;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;letter-spacing:2px;background-image:linear-gradient(90deg,rgba(50,0,0,.05) 3%,transparent 0),linear-gradient(1turn,rgba(50,0,0,.05) 3%,transparent 0);background-size:20px 20px;background-position:50%;word-break:break-word;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body h1{font-size:23px;margin-bottom:5px;font-weight:700;padding-left:10px;border-left:5px solid #773098}.markdown-body h2{font-size:19px;font-weight:700;padding-left:10px;border-left:5px solid #916dd5}.markdown-body h3{font-size:17px;font-weight:700;padding-left:10px;border-left:5px solid #d89cf6}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{font-size:14px;margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{display:block;max-width:100%;margin:1em 0;border-radius:6px;box-shadow:2px 4px 7px #999;user-select:none}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{padding:.2em .5em;font-weight:700;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-size:1em;color:#916dd5;word-break:break-word;overflow-x:auto;background-color:none;border-radius:2px}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-weight:400;font-size:.9em;padding:16px 12px;margin:0;color:#333;word-break:normal;overflow-x:auto;background:#f8f8f8;scroll-behavior:smooth}.markdown-body a{text-decoration:none;color:#916dd5;font-weight:700;border-bottom:1px solid #916dd5}.markdown-body a:active,.markdown-body a:hover{color:#773098}.markdown-body table{display:inline-block!important;font-size:14px;width:auto;max-width:100%;overflow:auto;border:1px solid #916dd5;border-collapse:collapse}.markdown-body thead{background-color:#916dd5;color:#fff;text-align:left}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px;border:1px solid #916dd5}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #d89cf6;background-color:#f4eeff}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0;line-height:26px}.markdown-body ol,.markdown-body ul{padding-left:28px;list-style-type:circle}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body b,.markdown-body strong{color:#916dd5;font-weight:700}.markdown-body b:before,.markdown-body strong:before{content:"「"}.markdown-body b:after,.markdown-body strong:after{content:"」"}.markdown-body em,.markdown-body i{color:#916dd5}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="github-gist">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fff;color:#333}.hljs-comment,.hljs-meta{color:#969896}.hljs-emphasis,.hljs-quote,.hljs-strong,.hljs-template-variable,.hljs-variable{color:#df5000}.hljs-keyword,.hljs-selector-tag,.hljs-type{color:#d73a49}.hljs-attribute,.hljs-bullet,.hljs-literal,.hljs-symbol{color:#0086b3}.hljs-name,.hljs-section{color:#63a35c}.hljs-tag{color:#333}.hljs-attr,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-id,.hljs-selector-pseudo,.hljs-title{color:#6f42c1}.hljs-addition{color:#55a532;background-color:#eaffea}.hljs-deletion{color:#bd2c00;background-color:#ffecec}.hljs-link{text-decoration:underline}.hljs-number{color:#005cc5}.hljs-string{color:#032f62}</style><p>Cursor 里可选模型很多，按「能力档位」和「速度档位」分成多档。下面按类型说明各自区别和适合场景。</p>
<hr/>
<h2 data-id="heading-0">一、Claude 系（Anthropic）</h2>
<h3 data-id="heading-1">Claude Opus 4.6</h3>
<ul>
<li><strong>定位</strong>：默认首选，复杂任务和 Agent 场景表现最好。</li>
<li><strong>特点</strong>：SWE-Bench 等编码基准领先，多步工具调用稳，架构设计、安全审计、代码审查、复杂业务测试生成都适合。</li>
<li><strong>成本</strong>：约 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>5</mn><mi mathvariant="normal">/</mi></mrow><annotation encoding="application/x-tex">5 / </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">5/</span></span></span></span></span>25 每 100 万 token（输入/输出），相对最贵。</li>
<li><strong>适用</strong>：多文件重构、架构设计、安全审计、需要「一次做对」的重要任务。</li>
</ul>
<h3 data-id="heading-2">Claude Sonnet 4.5</h3>
<ul>
<li><strong>定位</strong>：日常主力、省预算的均衡选择。</li>
<li><strong>特点</strong>：比 Opus 便宜约 40%，常规编码（工具函数、表单、CRUD、明确需求）质量差距不大。</li>
<li><strong>成本</strong>：约 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>3</mn><mi mathvariant="normal">/</mi></mrow><annotation encoding="application/x-tex">3 / </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">3/</span></span></span></span></span>15 每 100 万 token。</li>
<li><strong>适用</strong>：可一句话说清、输出可预期的任务；预算紧张或长对话时用 Sonnet + Max 模式控成本。</li>
</ul>
<h3 data-id="heading-3">Sonnet 4 1M Max Only</h3>
<ul>
<li><strong>定位</strong>：<strong>只用大上下文</strong>的 Sonnet 4，不拼深度推理。</li>
<li><strong>特点</strong>：支持约 <strong>100 万 token</strong> 上下文（需开 Max 模式），能一次看大量文件/文档；常规模式下 Cursor 会把上下文压到约 1～1.5 万 token，此模式把「完整上下文」交给模型。</li>
<li><strong>适用</strong>：超大代码库分析、跨模块理解、长文档/多文件同屏理解，<strong>要的是「看得全」而不是「想得深」</strong>。</li>
</ul>
<h3 data-id="heading-4">Sonnet 4 1M Max Only 深度思考</h3>
<ul>
<li><strong>定位</strong>：在 1M 上下文基础上，<strong>开启深度推理/扩展思考</strong>。</li>
<li><strong>特点</strong>：在 Agent Max 模式下，模型有完整上下文 + 更长推理链（数百步思考），适合需要「边看全库边深度推演」的任务；成本比普通 Sonnet 高。</li>
<li><strong>适用</strong>：既要大代码库全局视野，又要复杂逻辑推演、多步规划时的 Sonnet 选项。</li>
</ul>
<h3 data-id="heading-5">Haiku 4.5</h3>
<ul>
<li><strong>定位</strong>：轻量、快速、便宜。</li>
<li><strong>特点</strong>：响应快、单价低，适合简单补全、小改、格式整理等。</li>
<li><strong>适用</strong>：简单编辑、批量小改、对质量要求不高的日常零碎任务。</li>
</ul>
<hr/>
<h2 data-id="heading-6">二、OpenAI / Codex 系（GPT-5.3）</h2>
<h3 data-id="heading-7">GPT-5.3</h3>
<ul>
<li><strong>定位</strong>：通用平衡档，能力与速度折中。</li>
<li><strong>特点</strong>：默认上下文约 200k+ token，适合大多数对话与编码任务。</li>
<li><strong>适用</strong>：不特别强调「极简」或「极深」时的默认选择。</li>
</ul>
<h3 data-id="heading-8">GPT-5.3 Codex（及 Low / High / Extra High）</h3>
<ul>
<li><strong>定位</strong>：<strong>面向编码优化的 GPT-5.3 系列</strong>，按「推理深度」分档。</li>
<li><strong>Codex</strong>：编码特化，找 bug、修代码库、产品化代码往往优于同代通用模型；支持基本 git 等操作。</li>
<li><strong>Codex Low</strong>：轻量推理，成本低，适合简单重写、批量处理；细节和鲁棒性相对弱。</li>
<li><strong>Codex High</strong>：深度推理，适合复杂架构、算法设计；速度慢、成本高。</li>
<li><strong>Codex Extra High</strong>：最高推理档，适合最难的设计与推理任务。</li>
<li><strong>适用</strong>：Codex = 日常编码；Low = 省成本/简单任务；High / Extra High = 架构与难题。</li>
</ul>
<h3 data-id="heading-9">GPT-5.3 Codex Fast / Low Fast / High Fast / Extra High Fast</h3>
<ul>
<li><strong>定位</strong>：在对应「深度档」基础上<strong>优先速度、降低延迟</strong>。</li>
<li><strong>Codex Fast</strong>：类似 Codex 但更快，适合聊天和快速迭代。</li>
<li><strong>Codex Low Fast</strong>：低成本 + 高速度，适合批量、简单任务。</li>
<li><strong>Codex High Fast</strong>：强推理但延迟较低，介于「High」和「Fast」之间。</li>
<li><strong>Codex Extra High Fast</strong>：Extra High 的加速版。</li>
<li><strong>适用</strong>：同一档能力下，当你更在意响应速度或迭代次数时选对应 Fast 版本。</li>
</ul>
<hr/>
<h2 data-id="heading-10">三、Cursor 自研</h2>
<h3 data-id="heading-11">Composer 1.5</h3>
<ul>
<li><strong>定位</strong>：Cursor 自研的<strong>速度优先</strong>编码模型。</li>
<li><strong>特点</strong>：多数回合 <strong>30 秒内</strong>完成，约 250 token/s，比同级别模型快约 4 倍；针对代码库语义搜索、多步工程任务优化；驱动 Cursor 2.0 多 Agent 界面。</li>
<li><strong>成本</strong>：约 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1.25</mn><mi mathvariant="normal">/</mi></mrow><annotation encoding="application/x-tex">1.25 / </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">1.25/</span></span></span></span></span>10 每 100 万 token，比 Opus/Sonnet 便宜。</li>
<li><strong>适用</strong>：快速改样式、小重构、需要多次来回迭代、对「秒级响应」敏感的场景。</li>
</ul>
<hr/>
<h2 data-id="heading-12">四、Google 系（Gemini）</h2>
<h3 data-id="heading-13">Gemini 3 Pro</h3>
<ul>
<li><strong>定位</strong>：<strong>大上下文 + 多模态</strong>专家。</li>
<li><strong>特点</strong>：默认约 200k，Max 模式可到 <strong>1M token</strong>；原生支持图片（截图、Figma、架构图），可直接在对话里分析 UI、设计稿、图表。</li>
<li><strong>成本</strong>：约 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn><mi mathvariant="normal">/</mi></mrow><annotation encoding="application/x-tex">2 / </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">2/</span></span></span></span></span>12 每 100 万 token。</li>
<li><strong>适用</strong>：超大代码库一次分析、贴截图修 UI、按设计稿实现、图表/文档中的视觉信息理解。</li>
</ul>
<h3 data-id="heading-14">Gemini 3 Flash</h3>
<ul>
<li><strong>定位</strong>：Gemini 3 的<strong>快速版</strong>。</li>
<li><strong>特点</strong>：延迟更低、单价通常更友好，能力略逊于 Pro。</li>
<li><strong>适用</strong>：需要 Gemini 系能力（大上下文/多模态）但更看重速度和成本的场景。</li>
</ul>
<hr/>
<h2 data-id="heading-15">五、xAI 系</h2>
<h3 data-id="heading-16">Grok Code</h3>
<ul>
<li><strong>定位</strong>：<strong>极致省钱</strong>的编码选项。</li>
<li><strong>特点</strong>：约 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0.20</mn><mi mathvariant="normal">/</mi></mrow><annotation encoding="application/x-tex">0.20 / </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">0.20/</span></span></span></span></span>1.50 每 100 万 token，上下文约 256k。</li>
<li><strong>适用</strong>：简单、重复、对质量要求不高的任务；预算非常紧时的备选。</li>
</ul>
<hr/>
<h2 data-id="heading-17">六、怎么选（速查）</h2>









































<table><thead><tr><th>需求</th><th>建议模型</th></tr></thead><tbody><tr><td>复杂架构 / 多文件重构 / 安全审计 / 一次做对</td><td><strong>Opus 4.6</strong></td></tr><tr><td>日常编码、省预算、可预期任务</td><td><strong>Sonnet 4.5</strong> 或 <strong>Composer 1.5</strong></td></tr><tr><td>超大代码库、要「看全」</td><td><strong>Sonnet 4 1M Max Only</strong> 或 <strong>Gemini 3 Pro (Max)</strong></td></tr><tr><td>大库 + 深度推理</td><td><strong>Sonnet 4 1M Max Only 深度思考</strong> 或 <strong>Opus 4.6 Max</strong></td></tr><tr><td>贴图修 UI、按设计实现、分析图表</td><td><strong>Gemini 3 Pro</strong></td></tr><tr><td>编码特化、找 bug、修库</td><td><strong>GPT-5.3 Codex</strong>（复杂用 High/Extra High）</td></tr><tr><td>要快、多轮小改</td><td><strong>Composer 1.5</strong> 或 <strong>Codex Fast</strong> 系列</td></tr><tr><td>极简任务、省成本</td><td><strong>Haiku 4.5</strong> 或 <strong>Grok Code</strong></td></tr></tbody></table>
<p><strong>实用技巧</strong>：</p>
<ul>
<li>用 <code>Cmd+.</code> / <code>Ctrl+.</code> 可快速切换模式；在 Agent 面板点模型名可换模型，对话中可随时切换。</li>
<li>若某模型总在同一个问题上犯错，可换一档（如从 Sonnet 换到 Codex 或 Opus）换思路。</li>
<li>长对话会堆上下文、烧钱快；日常多用 <code>@</code> 引用文件，少贴大段代码；Max/深度思考只在需要时开。</li>
</ul>
<hr/>
<p><em>说明：具体模型名称与档位以 Cursor 当前界面为准；定价与上下文上限可能随版本更新，以官方为准。</em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[CSS自适应屏幕]]></title>    <link>https://juejin.cn/post/7605051886434746431</link>    <guid>https://juejin.cn/post/7605051886434746431</guid>    <pubDate>2026-02-11T03:46:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605051886434746431" data-draft-id="7604964464690954303" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="CSS自适应屏幕"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2026-02-11T03:46:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="青屿ovo"/> <meta itemprop="url" content="https://juejin.cn/user/2080706144515166"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            CSS自适应屏幕
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2080706144515166/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    青屿ovo
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-11T03:46:54.000Z" title="Wed Feb 11 2026 03:46:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    9
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">CSS自适应屏幕代码教程</h2>
<h2 data-id="heading-1">✏️ 开篇说明 🎨</h2>
<p>本文为全新原创CSS自适应教程，避开复杂理论，聚焦「90%项目必用」的自适应方案，精选4个搜索量TOP的核心知识点，主打极简可复制代码、新手零门槛，每部分都附实战示例+避坑提示，开发时直接抄作业，有错欢迎指出来～</p>
<p>💡 核心目标：学会后能快速实现「PC端+移动端」自适应，适配不同屏幕尺寸（手机、平板、电脑），不用写多套CSS！</p>
<h2 data-id="heading-2">📌 四大高频自适应方案（搜索量拉满，刚需实用）</h2>
<p>精选知识点（按使用频率排序）：1. 媒体查询（最常用，兼容所有浏览器）2. Rem适配（移动端首选）3. Vw/Vh适配（极简无依赖）4. Flex/Grid自适应布局（配合适配方案使用），逐个拆解，代码可直接复制运行。</p>
<h3 data-id="heading-3">一、媒体查询（Media Query）—— 自适应万能方案</h3>
<p>搜索量TOP1，最基础、最常用的自适应方案，核心逻辑：根据不同屏幕宽度，执行不同的CSS样式，兼容所有浏览器（包括旧版），PC端+移动端通用，新手入门首选。</p>
<h4 data-id="heading-4">1. 核心语法（必记）</h4>
<pre><code class="hljs language-CSS" lang="CSS">
<span class="hljs-comment">/* 基础语法：屏幕宽度满足条件时，执行内部样式 */</span>
<span class="hljs-keyword">@media</span> screen <span class="hljs-keyword">and</span> (条件) {
  <span class="hljs-comment">/* 这里写满足条件后的CSS样式 */</span>
}

<span class="hljs-comment">/* 常用条件（重点记这3个） */</span>
<span class="hljs-keyword">@media</span> screen <span class="hljs-keyword">and</span> (<span class="hljs-attribute">max-width</span>: <span class="hljs-number">768px</span>) { <span class="hljs-comment">/* 屏幕宽度 ≤ 768px（移动端） */</span> }
<span class="hljs-keyword">@media</span> screen <span class="hljs-keyword">and</span> (<span class="hljs-attribute">min-width</span>: <span class="hljs-number">769px</span>) <span class="hljs-keyword">and</span> (<span class="hljs-attribute">max-width</span>: <span class="hljs-number">1200px</span>) { <span class="hljs-comment">/* 平板端 */</span> }
<span class="hljs-keyword">@media</span> screen <span class="hljs-keyword">and</span> (<span class="hljs-attribute">min-width</span>: <span class="hljs-number">1201px</span>) { <span class="hljs-comment">/* 屏幕宽度 ≥ 1201px（PC端） */</span> }
    
</code></pre>
<h4 data-id="heading-5">2. 实战示例（可直接复制运行）</h4>
<p>需求：实现一个卡片，PC端显示3列、移动端显示1列，字体和内边距随屏幕自适应。</p>
<pre><code class="hljs language-HTML" lang="HTML">
<span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"zh-CN"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&amp;<span class="hljs-attr">gt</span>;
  &lt;!<span class="hljs-attr">--</span> <span class="hljs-attr">关键</span>：<span class="hljs-attr">移动端适配必须加这个meta标签</span>，<span class="hljs-attr">否则媒体查询无效</span> <span class="hljs-attr">--</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>媒体查询实战<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
    <span class="hljs-comment">/* 通用样式（所有屏幕都生效） */</span>
    <span class="hljs-selector-class">.card-container</span> {
      <span class="hljs-attribute">display</span>: flex;
      <span class="hljs-attribute">flex-wrap</span>: wrap; <span class="hljs-comment">/* 自动换行，配合自适应 */</span>
      <span class="hljs-attribute">gap</span>: <span class="hljs-number">20px</span>; <span class="hljs-comment">/* 卡片之间的间距 */</span>
      <span class="hljs-attribute">padding</span>: <span class="hljs-number">20px</span>;
    }
    <span class="hljs-selector-class">.card</span> {
      <span class="hljs-attribute">background</span>: <span class="hljs-number">#f5f5f5</span>;
      <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">8px</span>;
      <span class="hljs-attribute">padding</span>: <span class="hljs-number">16px</span>;
      <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">2px</span> <span class="hljs-number">4px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0.1</span>);
    }

    <span class="hljs-comment">/* 1. PC端（≥1201px）：3列布局 */</span>
    <span class="hljs-keyword">@media</span> screen <span class="hljs-keyword">and</span> (<span class="hljs-attribute">min-width</span>: <span class="hljs-number">1201px</span>) {
      <span class="hljs-selector-class">.card</span> {
        <span class="hljs-attribute">width</span>: <span class="hljs-built_in">calc</span>(<span class="hljs-number">33.33%</span> - <span class="hljs-number">20px</span>); <span class="hljs-comment">/* 3列均分，减去间距 */</span>
        <span class="hljs-attribute">font-size</span>: <span class="hljs-number">16px</span>;
      }
    }

    <span class="hljs-comment">/* 2. 平板端（769px-1200px）：2列布局 */</span>
    <span class="hljs-keyword">@media</span> screen <span class="hljs-keyword">and</span> (<span class="hljs-attribute">min-width</span>: <span class="hljs-number">769px</span>) <span class="hljs-keyword">and</span> (<span class="hljs-attribute">max-width</span>: <span class="hljs-number">1200px</span>) {
      <span class="hljs-selector-class">.card</span> {
        <span class="hljs-attribute">width</span>: <span class="hljs-built_in">calc</span>(<span class="hljs-number">50%</span> - <span class="hljs-number">20px</span>); <span class="hljs-comment">/* 2列均分 */</span>
        <span class="hljs-attribute">font-size</span>: <span class="hljs-number">15px</span>;
      }
    }

    <span class="hljs-comment">/* 3. 移动端（≤768px）：1列布局 */</span>
    <span class="hljs-keyword">@media</span> screen <span class="hljs-keyword">and</span> (<span class="hljs-attribute">max-width</span>: <span class="hljs-number">768px</span>) {
      <span class="hljs-selector-class">.card</span> {
        <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>; <span class="hljs-comment">/* 占满屏幕宽度 */</span>
        <span class="hljs-attribute">font-size</span>: <span class="hljs-number">14px</span>;
        <span class="hljs-attribute">padding</span>: <span class="hljs-number">12px</span>; <span class="hljs-comment">/* 减小内边距，适配小屏幕 */</span>
      }
      <span class="hljs-selector-class">.card-container</span> {
        <span class="hljs-attribute">padding</span>: <span class="hljs-number">10px</span>; <span class="hljs-comment">/* 减小容器内边距 */</span>
        <span class="hljs-attribute">gap</span>: <span class="hljs-number">10px</span>;
      }
    }
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"card-container"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"card"</span>&gt;</span>卡片1（自适应宽度）<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"card"</span>&gt;</span>卡片2（自适应宽度）<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"card"</span>&gt;</span>卡片3（自适应宽度）<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
    
</code></pre>
<h4 data-id="heading-6">3. 核心避坑（90%新手踩过）</h4>
<ul>
<li>
<p>🚨 避坑1：必须添加 viewport  meta 标签（示例中已写），否则移动端媒体查询无效，样式错乱。</p>
</li>
<li>
<p>🚨 避坑2：媒体查询的顺序不能乱！要遵循「从小到大」或「从大到小」，推荐「从大到小」（PC→平板→移动端），避免样式覆盖。</p>
</li>
<li>
<p>🚨 避坑3：不要在媒体查询中重复写所有样式，只写需要修改的样式（通用样式写在媒体查询外面），减少冗余。</p>
</li>
</ul>
<h3 data-id="heading-7">二、Rem适配 —— 移动端首选方案</h3>
<p>搜索量TOP2，专门针对移动端的自适应方案，核心逻辑：以根元素（html）的字体大小为基准，所有元素尺寸用rem单位，通过JS动态修改根字体大小，实现「等比例缩放」，适配所有手机屏幕。</p>
<h4 data-id="heading-8">1. 核心准备（2步搞定）</h4>
<h5 data-id="heading-9">步骤1：设置根字体大小（默认基准）</h5>
<pre><code class="hljs language-CSS" lang="CSS">
<span class="hljs-comment">/* CSS 中设置默认根字体大小（PC端/平板端） */</span>
<span class="hljs-selector-tag">html</span> {
  <span class="hljs-attribute">font-size</span>: <span class="hljs-number">16px</span>; <span class="hljs-comment">/* 1rem = 16px（默认基准，可自定义） */</span>
}

<span class="hljs-comment">/* 移动端通过JS动态修改，后面会写 */</span>
    
</code></pre>
<h5 data-id="heading-10">步骤2：添加JS动态适配代码（核心）</h5>
<p>作用：根据手机屏幕宽度，动态修改html的font-size，实现rem等比例缩放（复制到html的head标签内即可）。</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript">
&lt;script&gt;
<span class="hljs-comment">// Rem自适应核心JS（无需修改，直接复制）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">setRemUnit</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 1. 获取屏幕宽度（兼容不同浏览器）</span>
  <span class="hljs-keyword">const</span> screenWidth = <span class="hljs-variable language_">document</span>.<span class="hljs-property">documentElement</span>.<span class="hljs-property">clientWidth</span> || <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span>;
  <span class="hljs-comment">// 2. 设定基准宽度（通常以375px为手机设计稿基准，可修改）</span>
  <span class="hljs-keyword">const</span> baseWidth = <span class="hljs-number">375</span>;
  <span class="hljs-comment">// 3. 计算根字体大小（1rem = 屏幕宽度 / 10，方便计算）</span>
  <span class="hljs-keyword">const</span> fontSize = screenWidth / <span class="hljs-number">10</span>;
  <span class="hljs-comment">// 4. 设置根元素字体大小（最大不超过32px，避免字体过大）</span>
  <span class="hljs-variable language_">document</span>.<span class="hljs-property">documentElement</span>.<span class="hljs-property">style</span>.<span class="hljs-property">fontSize</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(fontSize, <span class="hljs-number">32</span>) + <span class="hljs-string">'px'</span>;
}

<span class="hljs-comment">// 5. 初始化执行一次</span>
<span class="hljs-title function_">setRemUnit</span>();
<span class="hljs-comment">// 6. 屏幕旋转/ resize时，重新执行（适配屏幕变化）</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'resize'</span>, setRemUnit);
<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'orientationchange'</span>, setRemUnit);
&lt;/script&gt;
    
</code></pre>
<h4 data-id="heading-11">2. 实战示例（移动端适配卡片）</h4>
<pre><code class="hljs language-HTML" lang="HTML">
<span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"zh-CN"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Rem自适应实战<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
    <span class="hljs-comment">// 先复制Rem自适应JS（核心）</span>
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">setRemUnit</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">const</span> screenWidth = <span class="hljs-variable language_">document</span>.<span class="hljs-property">documentElement</span>.<span class="hljs-property">clientWidth</span> || <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span>;
      <span class="hljs-keyword">const</span> baseWidth = <span class="hljs-number">375</span>;
      <span class="hljs-keyword">const</span> fontSize = screenWidth / <span class="hljs-number">10</span>;
      <span class="hljs-variable language_">document</span>.<span class="hljs-property">documentElement</span>.<span class="hljs-property">style</span>.<span class="hljs-property">fontSize</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(fontSize, <span class="hljs-number">32</span>) + <span class="hljs-string">'px'</span>;
    }
    <span class="hljs-title function_">setRemUnit</span>();
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'resize'</span>, setRemUnit);
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'orientationchange'</span>, setRemUnit);
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
    <span class="hljs-comment">/* 所有元素尺寸用rem单位（1rem = 屏幕宽度/10） */</span>
    <span class="hljs-selector-class">.card</span> {
      <span class="hljs-attribute">width</span>: <span class="hljs-number">8rem</span>; <span class="hljs-comment">/* 相当于屏幕宽度的80%（8/10） */</span>
      <span class="hljs-attribute">height</span>: <span class="hljs-number">5rem</span>;
      <span class="hljs-attribute">background</span>: <span class="hljs-number">#42b983</span>;
      <span class="hljs-attribute">color</span>: <span class="hljs-number">#fff</span>;
      <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">0.5rem</span>; <span class="hljs-comment">/* 5px（以375px屏幕为例） */</span>
      <span class="hljs-attribute">padding</span>: <span class="hljs-number">0.8rem</span>;
      <span class="hljs-attribute">font-size</span>: <span class="hljs-number">1rem</span>;
      <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span> auto;
      <span class="hljs-attribute">display</span>: flex;
      <span class="hljs-attribute">align-items</span>: center;
      <span class="hljs-attribute">justify-content</span>: center;
    }
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"card"</span>&gt;</span>Rem自适应卡片<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
    
</code></pre>
<h4 data-id="heading-12">3. 核心避坑</h4>
<ul>
<li>
<p>🚨 避坑1：JS代码必须放在CSS前面（优先修改根字体大小），否则CSS中的rem计算会出错。</p>
</li>
<li>
<p>🚨 避坑2：设计稿基准宽度（baseWidth）要和UI设计稿一致（通常375px/750px），否则缩放比例不对。</p>
</li>
<li>
<p>🚨 避坑3：不要混合使用px和rem（除了根字体大小），否则无法实现等比例自适应。</p>
</li>
</ul>
<h3 data-id="heading-13">三、Vw/Vh适配 —— 极简无依赖方案</h3>
<p>搜索量TOP3，最简洁的自适应方案，核心逻辑：以「屏幕可视区域」为基准，1vw = 屏幕宽度的1%，1vh = 屏幕高度的1%，无需JS、无需媒体查询，直接用vw/vh单位，适配所有屏幕（推荐简单页面使用）。</p>
<h4 data-id="heading-14">1. 核心单位说明（必记）</h4>
<ul>
<li>
<p>✅ 1vw = 视口宽度的1%（例：屏幕宽375px，1vw = 3.75px）</p>
</li>
<li>
<p>✅ 1vh = 视口高度的1%（例：屏幕高667px，1vh = 6.67px）</p>
</li>
<li>
<p>✅ vmin = vw和vh中的最小值，vmax = vw和vh中的最大值（适配横竖屏）</p>
</li>
</ul>
<h4 data-id="heading-15">2. 实战示例（极简自适应页面）</h4>
<p>需求：实现一个全屏自适应卡片，居中显示，字体、间距随屏幕缩放。</p>
<pre><code class="hljs language-HTML" lang="HTML">
<span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"zh-CN"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Vw/Vh自适应实战<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
    <span class="hljs-comment">/* 重置默认边距 */</span>
    * {
      <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span>;
      <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span>;
      <span class="hljs-attribute">box-sizing</span>: border-box;
    }

    <span class="hljs-comment">/* 页面全屏 */</span>
    <span class="hljs-selector-tag">body</span> {
      <span class="hljs-attribute">width</span>: <span class="hljs-number">100vw</span>; <span class="hljs-comment">/* 占满屏幕宽度 */</span>
      <span class="hljs-attribute">height</span>: <span class="hljs-number">100vh</span>; <span class="hljs-comment">/* 占满屏幕高度 */</span>
      <span class="hljs-attribute">display</span>: flex;
      <span class="hljs-attribute">align-items</span>: center;
      <span class="hljs-attribute">justify-content</span>: center;
      <span class="hljs-attribute">background</span>: <span class="hljs-number">#f8f9fa</span>;
    }

    <span class="hljs-comment">/* 自适应卡片（所有尺寸用vw） */</span>
    <span class="hljs-selector-class">.vw-card</span> {
      <span class="hljs-attribute">width</span>: <span class="hljs-number">80vw</span>; <span class="hljs-comment">/* 卡片宽 = 屏幕宽的80% */</span>
      <span class="hljs-attribute">height</span>: <span class="hljs-number">50vw</span>; <span class="hljs-comment">/* 卡片高 = 屏幕宽的50%（避免竖屏过高） */</span>
      <span class="hljs-attribute">background</span>: <span class="hljs-number">#6495ed</span>;
      <span class="hljs-attribute">color</span>: <span class="hljs-number">#fff</span>;
      <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">2vw</span>; <span class="hljs-comment">/* 圆角随屏幕缩放 */</span>
      <span class="hljs-attribute">padding</span>: <span class="hljs-number">5vw</span>;
      <span class="hljs-attribute">font-size</span>: <span class="hljs-number">4vw</span>; <span class="hljs-comment">/* 字体大小 = 屏幕宽的4% */</span>
      <span class="hljs-attribute">text-align</span>: center;
      <span class="hljs-attribute">display</span>: flex;
      <span class="hljs-attribute">align-items</span>: center;
      <span class="hljs-attribute">justify-content</span>: center;
    }
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"vw-card"</span>&gt;</span>Vw/Vh自适应<span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span>极简无依赖<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
    
</code></pre>
<h4 data-id="heading-16">3. 核心避坑</h4>
<ul>
<li>
<p>🚨 避坑1：同样需要添加viewport meta标签，否则vw/vh的计算基准会错误（适配移动端）。</p>
</li>
<li>
<p>🚨 避坑2：vh会受手机状态栏、导航栏影响，高度建议用vw或vmin，避免竖屏时高度溢出。</p>
</li>
<li>
<p>🚨 避坑3：复杂页面不推荐单独使用vw/vh（会出现字体过大/过小），建议配合媒体查询微调。</p>
</li>
</ul>
<h3 data-id="heading-17">四、Flex/Grid自适应布局 —— 配合适配方案使用</h3>
<p>搜索量TOP4，布局层面的自适应，核心逻辑：通过Flex（弹性布局）或Grid（网格布局），让元素自动分配空间，配合前面的媒体查询、rem、vw/vh，实现更灵活的自适应，是项目中最常用的组合方案。</p>
<h4 data-id="heading-18">1. Flex自适应（最常用，重点记）</h4>
<pre><code class="hljs language-HTML" lang="HTML">
<span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"zh-CN"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Flex自适应布局<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
    <span class="hljs-selector-class">.flex-container</span> {
      <span class="hljs-attribute">display</span>: flex; <span class="hljs-comment">/* 开启Flex布局 */</span>
      <span class="hljs-attribute">flex-wrap</span>: wrap; <span class="hljs-comment">/* 自动换行（关键，适配小屏幕） */</span>
      <span class="hljs-attribute">gap</span>: <span class="hljs-number">1rem</span>; <span class="hljs-comment">/* 间距用rem，配合Rem适配 */</span>
      <span class="hljs-attribute">padding</span>: <span class="hljs-number">1rem</span>;
    }

    <span class="hljs-selector-class">.flex-item</span> {
      <span class="hljs-attribute">flex</span>: <span class="hljs-number">1</span>; <span class="hljs-comment">/* 自动分配剩余空间，实现均分 */</span>
      <span class="hljs-attribute">min-width</span>: <span class="hljs-number">200px</span>; <span class="hljs-comment">/* 最小宽度，小于这个宽度就换行 */</span>
      <span class="hljs-attribute">height</span>: <span class="hljs-number">100px</span>;
      <span class="hljs-attribute">background</span>: <span class="hljs-number">#f08080</span>;
      <span class="hljs-attribute">color</span>: <span class="hljs-number">#fff</span>;
      <span class="hljs-attribute">display</span>: flex;
      <span class="hljs-attribute">align-items</span>: center;
      <span class="hljs-attribute">justify-content</span>: center;
      <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">8px</span>;
    }

    <span class="hljs-comment">/* 移动端微调（配合媒体查询） */</span>
    <span class="hljs-keyword">@media</span> screen <span class="hljs-keyword">and</span> (<span class="hljs-attribute">max-width</span>: <span class="hljs-number">768px</span>) {
      <span class="hljs-selector-class">.flex-item</span> {
        <span class="hljs-attribute">min-width</span>: <span class="hljs-number">100%</span>; <span class="hljs-comment">/* 移动端占满宽度，1列显示 */</span>
      }
    }
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"flex-container"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"flex-item"</span>&gt;</span>Flex item1<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"flex-item"</span>&gt;</span>Flex item2<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"flex-item"</span>&gt;</span>Flex item3<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
    
</code></pre>
<h4 data-id="heading-19">2. Grid自适应（复杂布局首选）</h4>
<pre><code class="hljs language-HTML" lang="HTML">
<span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"zh-CN"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Grid自适应布局<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
    <span class="hljs-selector-class">.grid-container</span> {
      <span class="hljs-attribute">display</span>: grid; <span class="hljs-comment">/* 开启Grid布局 */</span>
      <span class="hljs-comment">/* 关键：自动填充，每列最小200px，最大1fr（均分） */</span>
      <span class="hljs-attribute">grid-template-columns</span>: <span class="hljs-built_in">repeat</span>(auto-fill, <span class="hljs-built_in">minmax</span>(<span class="hljs-number">200px</span>, <span class="hljs-number">1</span>fr));
      <span class="hljs-attribute">gap</span>: <span class="hljs-number">1rem</span>;
      <span class="hljs-attribute">padding</span>: <span class="hljs-number">1rem</span>;
    }

    <span class="hljs-selector-class">.grid-item</span> {
      <span class="hljs-attribute">height</span>: <span class="hljs-number">100px</span>;
      <span class="hljs-attribute">background</span>: <span class="hljs-number">#9370db</span>;
      <span class="hljs-attribute">color</span>: <span class="hljs-number">#fff</span>;
      <span class="hljs-attribute">display</span>: flex;
      <span class="hljs-attribute">align-items</span>: center;
      <span class="hljs-attribute">justify-content</span>: center;
      <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">8px</span>;
    }

    <span class="hljs-comment">/* 移动端微调 */</span>
    <span class="hljs-keyword">@media</span> screen <span class="hljs-keyword">and</span> (<span class="hljs-attribute">max-width</span>: <span class="hljs-number">768px</span>) {
      <span class="hljs-selector-class">.grid-container</span> {
        <span class="hljs-attribute">grid-template-columns</span>: <span class="hljs-number">1</span>fr; <span class="hljs-comment">/* 移动端1列布局 */</span>
      }
    }
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"grid-container"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"grid-item"</span>&gt;</span>Grid item1<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"grid-item"</span>&gt;</span>Grid item2<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"grid-item"</span>&gt;</span>Grid item3<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"grid-item"</span>&gt;</span>Grid item4<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
    
</code></pre>
<h4 data-id="heading-20">3. 核心避坑</h4>
<ul>
<li>
<p>🚨 避坑1：Flex布局中，flex-wrap: wrap 必须写，否则元素不会换行，会溢出屏幕。</p>
</li>
<li>
<p>🚨 避坑2：Grid布局的grid-template-columns，用auto-fill配合minmax，实现自动适配列数，新手首选。</p>
</li>
<li>
<p>🚨 避坑3：Flex/Grid只是布局方式，单独使用无法实现“字体、间距”自适应，需配合媒体查询/rem/vw使用。</p>
</li>
</ul>
<h3 data-id="heading-21">五、实战组合方案（重点！项目必用）</h3>
<p>实际开发中，不会单独使用某一种方案，推荐「组合搭配」，兼顾兼容性和灵活性，示例如下（可直接复制到项目中）：</p>
<pre><code class="hljs language-HTML" lang="HTML">
<span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"zh-CN"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>CSS自适应组合方案<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- 1. Rem自适应JS（优先加载） --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">setRemUnit</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">const</span> screenWidth = <span class="hljs-variable language_">document</span>.<span class="hljs-property">documentElement</span>.<span class="hljs-property">clientWidth</span> || <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span>;
      <span class="hljs-keyword">const</span> baseWidth = <span class="hljs-number">375</span>;
      <span class="hljs-keyword">const</span> fontSize = screenWidth / <span class="hljs-number">10</span>;
      <span class="hljs-variable language_">document</span>.<span class="hljs-property">documentElement</span>.<span class="hljs-property">style</span>.<span class="hljs-property">fontSize</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(fontSize, <span class="hljs-number">32</span>) + <span class="hljs-string">'px'</span>;
    }
    <span class="hljs-title function_">setRemUnit</span>();
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'resize'</span>, setRemUnit);
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
    <span class="hljs-comment">/* 2. 通用样式（rem单位） */</span>
    * {
      <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span>;
      <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span>;
      <span class="hljs-attribute">box-sizing</span>: border-box;
    }
    <span class="hljs-selector-tag">body</span> {
      <span class="hljs-attribute">font-size</span>: <span class="hljs-number">1rem</span>;
      <span class="hljs-attribute">background</span>: <span class="hljs-number">#f5f5f5</span>;
    }

    <span class="hljs-comment">/* 3. Flex布局（自适应布局） */</span>
    <span class="hljs-selector-class">.container</span> {
      <span class="hljs-attribute">display</span>: flex;
      <span class="hljs-attribute">flex-wrap</span>: wrap;
      <span class="hljs-attribute">gap</span>: <span class="hljs-number">1rem</span>;
      <span class="hljs-attribute">padding</span>: <span class="hljs-number">1rem</span>;
    }

    <span class="hljs-selector-class">.item</span> {
      <span class="hljs-attribute">flex</span>: <span class="hljs-number">1</span>;
      <span class="hljs-attribute">min-width</span>: <span class="hljs-number">12rem</span>; <span class="hljs-comment">/* 192px（以375px屏幕为例） */</span>
      <span class="hljs-attribute">height</span>: <span class="hljs-number">8rem</span>;
      <span class="hljs-attribute">background</span>: <span class="hljs-number">#42b983</span>;
      <span class="hljs-attribute">color</span>: <span class="hljs-number">#fff</span>;
      <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">0.5rem</span>;
      <span class="hljs-attribute">display</span>: flex;
      <span class="hljs-attribute">align-items</span>: center;
      <span class="hljs-attribute">justify-content</span>: center;
    }

    <span class="hljs-comment">/* 4. 媒体查询（微调细节） */</span>
    <span class="hljs-keyword">@media</span> screen <span class="hljs-keyword">and</span> (<span class="hljs-attribute">max-width</span>: <span class="hljs-number">768px</span>) {
      <span class="hljs-selector-class">.container</span> {
        <span class="hljs-attribute">gap</span>: <span class="hljs-number">0.8rem</span>;
        <span class="hljs-attribute">padding</span>: <span class="hljs-number">0.8rem</span>;
      }
      <span class="hljs-selector-class">.item</span> {
        <span class="hljs-attribute">min-width</span>: <span class="hljs-number">100%</span>; <span class="hljs-comment">/* 移动端1列 */</span>
      }
    }

    <span class="hljs-keyword">@media</span> screen <span class="hljs-keyword">and</span> (<span class="hljs-attribute">min-width</span>: <span class="hljs-number">1201px</span>) {
      <span class="hljs-selector-class">.container</span> {
        <span class="hljs-attribute">max-width</span>: <span class="hljs-number">1200px</span>; <span class="hljs-comment">/* PC端限制最大宽度，避免过宽 */</span>
        <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span> auto;
      }
    }
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"container"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"item"</span>&gt;</span>组合方案1<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"item"</span>&gt;</span>组合方案2<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"item"</span>&gt;</span>组合方案3<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
    
</code></pre>
<h3 data-id="heading-22">六、总结（重点提炼，快速记忆）</h3>
<ul>
<li>
<p>✅ 媒体查询：万能方案，兼容所有浏览器，适合PC+移动端，核心是“按屏幕宽度写样式”。</p>
</li>
<li>
<p>✅ Rem适配：移动端首选，等比例缩放，需配合JS修改根字体大小，适配所有手机。</p>
</li>
<li>
<p>✅ Vw/Vh适配：极简无依赖，适合简单页面，核心是“以屏幕可视区域为基准”。</p>
</li>
<li>
<p>✅ Flex/Grid：布局方案，配合前面3种使用，实现元素自动分配空间，灵活适配。</p>
</li>
<li>
<p>💡 项目首选：Rem + Flex/Grid + 媒体查询（兼顾兼容性、灵活性和开发效率）。</p>
</li>
</ul>
<p>✏️ CSS自适应教程完结，所有代码均可直接复制运行，避坑点已标注清楚～ 收藏起来，开发时直接抄作业，再也不用愁屏幕适配问题！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[数字输入范围组件vue2]]></title>    <link>https://juejin.cn/post/7605107459066495022</link>    <guid>https://juejin.cn/post/7605107459066495022</guid>    <pubDate>2026-02-11T03:56:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605107459066495022" data-draft-id="7605107459066478638" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="数字输入范围组件vue2"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-02-11T03:56:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="逍遥江湖"/> <meta itemprop="url" content="https://juejin.cn/user/3940246036941134"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            数字输入范围组件vue2
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3940246036941134/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    逍遥江湖
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-11T03:56:08.000Z" title="Wed Feb 11 2026 03:56:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/241dcfedbd864041adddb4cf6af72959~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCN6YGl5rGf5rmW:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771386969&amp;x-signature=K5ZBYJ8vpFQstyo7O2sCbtf9Dws%3D" alt="image.png" loading="lazy"/></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- 无内部 el-form 嵌套，适配外部 el-form 校验 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"number-range-input"</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"rangeInputRef"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"input-wrap"</span> <span class="hljs-attr">:style</span>=<span class="hljs-string">"{ width: inputWidth }"</span>&gt;</span>
      <span class="hljs-comment">&lt;!-- 最小值输入框：强制数字输入，绑定内部值 --&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">el-input</span>
        <span class="hljs-attr">v-model</span>=<span class="hljs-string">"innerMin"</span>
        <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"最小值"</span>
        @<span class="hljs-attr">blur</span>=<span class="hljs-string">"handleSyncValue"</span>
        @<span class="hljs-attr">input</span>=<span class="hljs-string">"handleMinInput"</span>
        @<span class="hljs-attr">clear</span>=<span class="hljs-string">"handleSyncValue"</span>
        <span class="hljs-attr">:clearable</span>=<span class="hljs-string">"clearable"</span>
        <span class="hljs-attr">type</span>=<span class="hljs-string">"number"</span>
        <span class="hljs-attr">style</span>=<span class="hljs-string">"width: calc(50% - 6px);"</span>
        <span class="hljs-attr">size</span>=<span class="hljs-string">"mini"</span>
        <span class="hljs-attr">:disabled</span>=<span class="hljs-string">"disabled"</span>
      &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">el-input</span>&gt;</span>

      <span class="hljs-comment">&lt;!-- 视觉分隔符 --&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"separator"</span>&gt;</span>-<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>

      <span class="hljs-comment">&lt;!-- 最大值输入框：强制数字输入，绑定内部值 --&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">el-input</span>
        <span class="hljs-attr">v-model</span>=<span class="hljs-string">"innerMax"</span>
        <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"最大值"</span>
        @<span class="hljs-attr">blur</span>=<span class="hljs-string">"handleSyncValue"</span>
        @<span class="hljs-attr">input</span>=<span class="hljs-string">"handleMaxInput"</span>
        @<span class="hljs-attr">clear</span>=<span class="hljs-string">"handleSyncValue"</span>
        <span class="hljs-attr">:clearable</span>=<span class="hljs-string">"clearable"</span>
        <span class="hljs-attr">type</span>=<span class="hljs-string">"number"</span>
        <span class="hljs-attr">style</span>=<span class="hljs-string">"width: calc(50% - 6px);"</span>
        <span class="hljs-attr">size</span>=<span class="hljs-string">"mini"</span>
        <span class="hljs-attr">:disabled</span>=<span class="hljs-string">"disabled"</span>
      &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">el-input</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'NumberRangeInput'</span>,
  <span class="hljs-comment">// Vue2 语法：props 接收外部配置（适配 el-form 校验和回显）</span>
  <span class="hljs-attr">props</span>: {
    <span class="hljs-comment">// 双向绑定值："1,20" 格式字符串（支持回显和 el-form 校验）</span>
    <span class="hljs-attr">value</span>: {
      <span class="hljs-attr">type</span>: <span class="hljs-title class_">String</span>,
      <span class="hljs-attr">default</span>: <span class="hljs-string">''</span>
    },
    <span class="hljs-comment">// 输入框整体宽度</span>
    <span class="hljs-attr">inputWidth</span>: {
      <span class="hljs-attr">type</span>: <span class="hljs-title class_">String</span>,
      <span class="hljs-attr">default</span>: <span class="hljs-string">'300px'</span>
    },
    <span class="hljs-comment">// 是否显示清除按钮</span>
    <span class="hljs-attr">clearable</span>: {
      <span class="hljs-attr">type</span>: <span class="hljs-title class_">Boolean</span>,
      <span class="hljs-attr">default</span>: <span class="hljs-literal">true</span>
    },
    <span class="hljs-comment">// 是否禁用</span>
    <span class="hljs-attr">disabled</span>: {
      <span class="hljs-attr">type</span>: <span class="hljs-title class_">Boolean</span>,
      <span class="hljs-attr">default</span>: <span class="hljs-literal">false</span>
    },
    <span class="hljs-comment">// 最大值不能小于最小值的提示文本</span>
    <span class="hljs-attr">rangeTip</span>: {
      <span class="hljs-attr">type</span>: <span class="hljs-title class_">String</span>,
      <span class="hljs-attr">default</span>: <span class="hljs-string">'最小值不能大於最大值'</span>
    }
  },
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-comment">// 内部缓存值（隔离外部 props，避免直接修改，保留字符串格式）</span>
      <span class="hljs-attr">innerMin</span>: <span class="hljs-string">''</span>,
      <span class="hljs-attr">innerMax</span>: <span class="hljs-string">''</span>
    };
  },
  <span class="hljs-attr">watch</span>: {
    <span class="hljs-comment">// 1. 监听外部 value 变化，实现数据回显（支持 "1,20" 格式回显）</span>
    <span class="hljs-attr">value</span>: {
      <span class="hljs-attr">immediate</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-title function_">handler</span>(<span class="hljs-params">val</span>) {
        <span class="hljs-keyword">if</span> (!val || <span class="hljs-keyword">typeof</span> val !== <span class="hljs-string">'string'</span>) {
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">innerMin</span> = <span class="hljs-string">''</span>;
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">innerMax</span> = <span class="hljs-string">''</span>;
          <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-comment">// 分割 "1,20" 格式字符串，解析为最小值和最大值</span>
        <span class="hljs-keyword">const</span> [minStr, maxStr] = val.<span class="hljs-title function_">split</span>(<span class="hljs-string">'&amp;&amp;'</span>).<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.<span class="hljs-title function_">trim</span>());
        <span class="hljs-keyword">const</span> minNum = <span class="hljs-title class_">Number</span>(minStr);
        <span class="hljs-keyword">const</span> maxNum = <span class="hljs-title class_">Number</span>(maxStr);

        <span class="hljs-comment">// 校验解析结果有效性，有效则填充输入框</span>
        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">isNaN</span>(minNum) &amp;&amp; !<span class="hljs-built_in">isNaN</span>(maxNum) &amp;&amp; minStr &amp;&amp; maxStr) {
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">innerMin</span> = <span class="hljs-title class_">String</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(minNum, maxNum));
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">innerMax</span> = <span class="hljs-title class_">String</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(minNum, maxNum));
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">innerMin</span> = <span class="hljs-string">''</span>;
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">innerMax</span> = <span class="hljs-string">''</span>;
        }
      }
    }
  },
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-comment">/**
     * 最小值输入监听：联动最大值，确保最小值 ≤ 最大值（保留字符串格式）
     */</span>
    <span class="hljs-title function_">handleMinInput</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">const</span> { innerMin, innerMax } = <span class="hljs-variable language_">this</span>;
      <span class="hljs-comment">// 转换为数字判断大小，避免字符串比较误差</span>
      <span class="hljs-keyword">if</span> (innerMin &amp;&amp; innerMax &amp;&amp; !<span class="hljs-built_in">isNaN</span>(<span class="hljs-title class_">Number</span>(innerMin)) &amp;&amp; !<span class="hljs-built_in">isNaN</span>(<span class="hljs-title class_">Number</span>(innerMax))) {
        <span class="hljs-keyword">const</span> minNum = <span class="hljs-title class_">Number</span>(innerMin);
        <span class="hljs-keyword">const</span> maxNum = <span class="hljs-title class_">Number</span>(innerMax);
        <span class="hljs-keyword">if</span> (minNum &gt; maxNum) {
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">innerMax</span> = innerMin;
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">$message</span>?.<span class="hljs-title function_">warning</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">rangeTip</span>);
        }
      }
    },

    <span class="hljs-comment">/**
     * 最大值输入监听：联动最小值，确保最大值 ≥ 最小值（保留字符串格式）
     */</span>
    <span class="hljs-title function_">handleMaxInput</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">const</span> { innerMin, innerMax } = <span class="hljs-variable language_">this</span>;
      <span class="hljs-comment">// 转换为数字判断大小，避免字符串比较误差</span>
      <span class="hljs-keyword">if</span> (innerMin!==<span class="hljs-string">''</span> &amp;&amp; innerMax!==<span class="hljs-string">''</span> &amp;&amp; !<span class="hljs-built_in">isNaN</span>(<span class="hljs-title class_">Number</span>(innerMin)) &amp;&amp; !<span class="hljs-built_in">isNaN</span>(<span class="hljs-title class_">Number</span>(innerMax))) {
        <span class="hljs-keyword">const</span> minNum = <span class="hljs-title class_">Number</span>(innerMin);
        <span class="hljs-keyword">const</span> maxNum = <span class="hljs-title class_">Number</span>(innerMax);
        <span class="hljs-keyword">if</span> (maxNum &lt; minNum) {
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">innerMin</span> =innerMax;
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">$message</span>?.<span class="hljs-title function_">warning</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">rangeTip</span>);
        }
      }
    },

    <span class="hljs-comment">/**
     * 核心：同步内部值到外部，生成 "1,20" 格式字符串（实现双向绑定）
     */</span>
    <span class="hljs-title function_">handleSyncValue</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">const</span> { innerMin, innerMax } = <span class="hljs-variable language_">this</span>;
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"innerMin, innerMax "</span>,innerMin, innerMax )
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"!isNaN(Number(innerMin) "</span>,<span class="hljs-built_in">isNaN</span>(<span class="hljs-title class_">Number</span>(innerMin)))
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"!isNaN(Number(innerMax) "</span>,<span class="hljs-built_in">isNaN</span>(<span class="hljs-title class_">Number</span>(innerMax)))
      <span class="hljs-keyword">let</span> result = <span class="hljs-string">''</span>;

      <span class="hljs-comment">// 校验内部值有效性（均为有效数字且非空）</span>
      <span class="hljs-keyword">if</span> (innerMin!==<span class="hljs-string">''</span> &amp;&amp; innerMax!==<span class="hljs-string">''</span> &amp;&amp; !<span class="hljs-built_in">isNaN</span>(<span class="hljs-title class_">Number</span>(innerMin)) &amp;&amp; !<span class="hljs-built_in">isNaN</span>(<span class="hljs-title class_">Number</span>(innerMax))) {
        <span class="hljs-keyword">const</span> minNum = <span class="hljs-title class_">Number</span>(innerMin);
        <span class="hljs-keyword">const</span> maxNum = <span class="hljs-title class_">Number</span>(innerMax);
        <span class="hljs-comment">// 生成 "最小值,最大值" 格式字符串，保证顺序正确</span>
        <span class="hljs-keyword">const</span> minStr = <span class="hljs-title class_">String</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(minNum, maxNum));
        <span class="hljs-keyword">const</span> maxStr = <span class="hljs-title class_">String</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(minNum, maxNum));
        result = <span class="hljs-string">`<span class="hljs-subst">${minStr}</span>&amp;&amp;<span class="hljs-subst">${maxStr}</span>`</span>;
      }<span class="hljs-keyword">else</span>{
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"不滿足"</span>)
      }

      <span class="hljs-comment">// Vue2 双向绑定核心：$emit('input') 同步值到外部 v-model</span>
      <span class="hljs-variable language_">this</span>.$emit(<span class="hljs-string">'input'</span>, result);
      <span class="hljs-comment">// 额外发射事件，方便外部监听详情</span>
      <span class="hljs-variable language_">this</span>.$emit(<span class="hljs-string">'rangeChange'</span>, result);
    },

    <span class="hljs-comment">/**
     * 外部调用：校验方法（适配 el-form 自定义校验，返回是否有效）
     * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">Boolean</span>} 校验结果（有效返回 true，无效返回 false）
     */</span>
    <span class="hljs-title function_">validate</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">const</span> { innerMin, innerMax } = <span class="hljs-variable language_">this</span>;
      <span class="hljs-comment">// 校验规则：两个值均为有效数字且非空</span>
      <span class="hljs-keyword">return</span> innerMin &amp;&amp; innerMax &amp;&amp; !<span class="hljs-built_in">isNaN</span>(<span class="hljs-title class_">Number</span>(innerMin)) &amp;&amp; !<span class="hljs-built_in">isNaN</span>(<span class="hljs-title class_">Number</span>(innerMax));
    },

    <span class="hljs-comment">/**
     * 外部调用：重置组件（清空输入框，返回空字符串）
     */</span>
    <span class="hljs-title function_">reset</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">innerMin</span> = <span class="hljs-string">''</span>;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">innerMax</span> = <span class="hljs-string">''</span>;
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handleSyncValue</span>();
    }
  }
};
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
<span class="hljs-selector-class">.number-range-input</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
  <span class="hljs-attribute">box-sizing</span>: border-box;
}
<span class="hljs-selector-class">.input-wrap</span> {
  <span class="hljs-attribute">display</span>: flex;
  <span class="hljs-attribute">align-items</span>: center;
  <span class="hljs-attribute">justify-content</span>: space-between;
}
<span class="hljs-selector-class">.separator</span> {
  <span class="hljs-attribute">color</span>: <span class="hljs-number">#666</span>;
  user-select: none;
}
::v-deep .el-input__inner{
    <span class="hljs-attribute">height</span>: <span class="hljs-number">28px</span> <span class="hljs-meta">!important</span>;
    <span class="hljs-attribute">line-height</span>: <span class="hljs-number">28px</span> <span class="hljs-meta">!important</span>;
    <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span> <span class="hljs-number">3px</span> <span class="hljs-meta">!important</span>;
    <span class="hljs-attribute">font-size</span>: <span class="hljs-number">12px</span> <span class="hljs-meta">!important</span>;
    <span class="hljs-attribute">text-align</span>: center;
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[ES7+ React/Redux/GraphQL/React-Native snippets]]></title>    <link>https://juejin.cn/post/7605106957133447202</link>    <guid>https://juejin.cn/post/7605106957133447202</guid>    <pubDate>2026-02-11T03:37:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605106957133447202" data-draft-id="7605128056485036047" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="ES7+ React/Redux/GraphQL/React-Native snippets"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-02-11T03:37:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="搬砖码"/> <meta itemprop="url" content="https://juejin.cn/user/3919122516937176"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ES7+ React/Redux/GraphQL/React-Native snippets
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3919122516937176/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    搬砖码
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-11T03:37:42.000Z" title="Wed Feb 11 2026 03:37:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">ES7+ React/Redux/GraphQL/React-Native snippets 插件深度解析</h3>
<h2 data-id="heading-1">引言</h2>
<p>在前端开发领域，React 凭借其高效的组件化开发模式和丰富的生态系统，成为了众多开发者的首选框架。然而，在日常开发中，我们常常需要编写大量重复的样板代码，这不仅降低了开发效率，还容易引入人为错误。为了解决这一问题，ES7+ React/Redux/GraphQL/React-Native snippets 插件应运而生。这款插件为 VS Code 用户提供了丰富的 React 开发代码模板，能够显著提高开发效率，减少重复劳动。</p>
<h2 data-id="heading-2">插件简介</h2>
<p>ES7+ React/Redux/GraphQL/React-Native snippets 是一款专为 React 开发者设计的 VS Code 插件，由 dsznajder 开发维护。该插件提供了大量基于 ES7+ 语法的 React、Redux、GraphQL 和 React-Native 代码片段，涵盖了从基础组件创建到高级状态管理的全流程开发需求。截至 2025 年，该插件在 VS Code marketplace 已累计超过 1000 万次下载，评分 4.8/5，被全球 30% 的 React 开发者采用。</p>
<h3 data-id="heading-3">核心优势</h3>
<ol>
<li><strong>高效的代码生成</strong>：通过简单的缩写词（trigger）映射到完整代码结构，开发者只需输入几个字母，然后按下 Tab 键，即可快速生成复杂的代码模板。</li>
<li><strong>全面的框架支持</strong>：支持 React、Redux、GraphQL 和 React-Native 等多个框架，能够满足不同项目的开发需求。</li>
<li><strong>灵活的自定义配置</strong>：提供了多个可配置参数，开发者可以根据项目需求调整插件的行为，如是否使用 Prettier 格式化代码、是否在组件顶部自动导入 React 等。</li>
<li><strong>智能的搜索功能</strong>：提供了高效的片段搜索功能，开发者可以通过快捷键或命令面板快速找到需要的代码模板。</li>
<li><strong>良好的社区活跃度</strong>：插件每月更新，及时修复 bug 和添加新功能，确保开发者能够使用到最新的技术和最佳实践。</li>
</ol>
<h2 data-id="heading-4">安装与配置</h2>
<h3 data-id="heading-5">安装方法</h3>
<h4 data-id="heading-6">方法一：通过 VS Code Marketplace</h4>
<ol>
<li>打开 VS Code，按 <code>Ctrl+P</code>（Windows/Linux）或 <code>⌘P</code>（macOS）打开快速打开面板。</li>
<li>输入命令：<code>ext install dsznajder.es7-react-js-snippets</code>，然后按 Enter 键安装。</li>
</ol>
<h4 data-id="heading-7">方法二：通过命令行</h4>
<p>如果你更喜欢命令行操作，可以使用以下命令：</p>
<pre><code class="hljs language-bash" lang="bash">code --install-extension dsznajder.es7-react-js-snippets
</code></pre>
<h3 data-id="heading-8">配置选项</h3>
<p>从版本 4 开始，插件提供了多个可配置参数，开发者可以根据项目需求调整插件的行为：</p>

























<table><thead><tr><th>选项</th><th>描述</th></tr></thead><tbody><tr><td><code>languageScopes</code></td><td>定义支持的语言范围，如 <code>["javascript", "typescriptreact"]</code></td></tr><tr><td><code>prettierEnabled</code></td><td>是否使用项目 Prettier 配置格式化代码片段，默认为 <code>true</code></td></tr><tr><td><code>importReactOnTop</code></td><td>是否在组件顶部自动导入 React，React 17+ 用户可设为 <code>false</code>，移除自动导入 React（新 JSX 转换特性），默认为 <code>true</code></td></tr><tr><td><code>typescript</code></td><td>是否启用 TypeScript 专属代码片段，默认为 <code>true</code></td></tr></tbody></table>
<h2 data-id="heading-9">常用代码片段介绍</h2>
<h3 data-id="heading-10">React 代码片段</h3>
<ol>
<li><strong>函数组件</strong>：使用 <code>rafce</code> 命令可以快速生成一个无状态的箭头函数组件（Arrow Function Component）。</li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title function_">ComponentName</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">ComponentName</span>;
</code></pre>
<ol start="2">
<li><strong>类组件</strong>：使用 <code>rcc</code> 命令可以快速生成一个类组件的模板。</li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { <span class="hljs-title class_">Component</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">class</span> <span class="hljs-title class_">ComponentName</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Component</span> {
  <span class="hljs-title function_">render</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> (
      <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    );
  }
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">ComponentName</span>;
</code></pre>
<ol start="3">
<li><strong>React Hooks</strong>：插件提供了常用的 React Hooks 快捷生成方式，如 <code>useState</code>、<code>useEffect</code>、<code>useContext</code> 等。</li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// useState</span>
<span class="hljs-keyword">const</span> [state, setState] = <span class="hljs-title function_">useState</span>(initialState);

<span class="hljs-comment">// useEffect</span>
<span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// 执行副作用</span>
  <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 清理函数</span>
  };
}, [deps]);
</code></pre>
<h3 data-id="heading-11">Redux 代码片段</h3>
<ol>
<li><strong>创建 action</strong>：使用 <code>reduxaction</code> 命令可以快速生成 Redux 的 action。</li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">actionName</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">type</span>: <span class="hljs-string">'ACTION_TYPE'</span>
  };
};
</code></pre>
<ol start="2">
<li><strong>创建 reducer</strong>：使用 <code>reduxreducer</code> 命令可以快速创建一个 reducer。</li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> initialState = {};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> (state = initialState, action) =&gt; {
  <span class="hljs-keyword">switch</span> (action.<span class="hljs-property">type</span>) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">'ACTION_TYPE'</span>:
      <span class="hljs-keyword">return</span> {
        ...state,
        <span class="hljs-comment">// ...</span>
      };
    <span class="hljs-attr">default</span>:
      <span class="hljs-keyword">return</span> state;
  }
};
</code></pre>
<h3 data-id="heading-12">GraphQL 代码片段</h3>
<p>使用 <code>gqlquery</code> 命令可以快速生成 GraphQL 查询的模板。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> gql <span class="hljs-keyword">from</span> <span class="hljs-string">'graphql-tag'</span>;

<span class="hljs-keyword">const</span> queryName = gql<span class="hljs-string">`
  query {
    field
  }
`</span>;
</code></pre>
<h2 data-id="heading-13">高级使用技巧</h2>
<h3 data-id="heading-14">智能搜索功能</h3>
<p>插件提供了高效的片段搜索功能，开发者可以通过以下方式快速找到需要的代码模板：</p>
<ol>
<li>打开命令面板：<code>Ctrl+Shift+P</code>（Windows/Linux）或 <code>⌘Shift+P</code>（macOS）。</li>
<li>输入 <code>ES7 snippet search</code> 并回车。</li>
<li>输入关键词搜索所需片段。</li>
</ol>
<p>快捷键配置：默认 <code>Ctrl+Alt+R</code>（Windows/Linux）或 <code>Shift+Cmd+R</code>（macOS）可直接调出搜索面板。</p>
<h3 data-id="heading-15">自定义代码片段</h3>
<p>插件支持在项目中扩展自定义片段，开发者可以在 <code>.vscode/snippets/javascript.json</code> 中添加项目专属的代码片段。例如，添加一个自定义的函数组件模板：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"Custom Function Component"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"prefix"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"cfc"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"body"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-string">"import React from 'react';"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">""</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"const $1 = ({ children }) =&gt; {"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"  return ("</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"    &lt;div className=\"$2\"&gt;"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"      {children}"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"    &lt;/div&gt;"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"  );"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"};"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">""</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"export default $1;"</span>
  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Custom React Function Component"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-16">与其他插件配合使用</h3>
<p>ES7+ React/Redux/GraphQL/React-Native snippets 插件可以与其他 VS Code 插件配合使用，进一步提升开发效率：</p>
<ol>
<li><strong>Prettier</strong>：代码格式化工具，确保代码风格一致。</li>
<li><strong>ESLint</strong>：代码检查工具，帮助发现和修复代码中的问题。</li>
<li><strong>Auto Import</strong>：自动导入依赖的利器，能够自动查找、解析并导入项目中使用的模块。</li>
</ol>
<h2 data-id="heading-17">实战案例：Todo 应用开发全流程</h2>
<h3 data-id="heading-18">1. 创建功能组件</h3>
<p>使用 <code>tsrfce</code> 命令快速创建一个 TypeScript 函数组件。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { useState } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">type</span> <span class="hljs-title class_">Todo</span> = {
  <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-attr">text</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">completed</span>: <span class="hljs-built_in">boolean</span>;
};

<span class="hljs-keyword">const</span> <span class="hljs-title function_">TodoApp</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> [todos, setTodos] = useState&lt;<span class="hljs-title class_">Todo</span>[]&gt;([]);
  <span class="hljs-keyword">const</span> [inputText, setInputText] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">''</span>);

  <span class="hljs-comment">// 添加 Todo 处理函数</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">addTodo</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">if</span> (inputText.<span class="hljs-title function_">trim</span>()) {
      <span class="hljs-title function_">setTodos</span>([...todos, { <span class="hljs-attr">id</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>(), <span class="hljs-attr">text</span>: inputText, <span class="hljs-attr">completed</span>: <span class="hljs-literal">false</span> }]);
      <span class="hljs-title function_">setInputText</span>(<span class="hljs-string">''</span>);
    }
  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"todo-app"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Todo List<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">input</span>
          <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span>
          <span class="hljs-attr">value</span>=<span class="hljs-string">{inputText}</span>
          <span class="hljs-attr">onChange</span>=<span class="hljs-string">{(e)</span> =&gt;</span> setInputText(e.target.value)}
          placeholder="Add a new todo"
        /&gt;
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{addTodo}</span>&gt;</span>Add<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>
        {todos.map(todo =&gt; (
          <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{todo.id}</span>&gt;</span>{todo.text}<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
        ))}
      <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">TodoApp</span>;
</code></pre>
<h3 data-id="heading-19">2. 添加 Redux 状态管理</h3>
<p>使用 <code>tsrcredux</code> 命令快速生成连接 Redux store 的组件。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// TodoList.tsx</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> { connect } <span class="hljs-keyword">from</span> <span class="hljs-string">'react-redux'</span>;
<span class="hljs-keyword">import</span> { addTodo, toggleTodo } <span class="hljs-keyword">from</span> <span class="hljs-string">'../store/todos/actions'</span>;

<span class="hljs-keyword">type</span> <span class="hljs-title class_">TodoProps</span> = {
  <span class="hljs-attr">todos</span>: <span class="hljs-title class_">Todo</span>[];
  <span class="hljs-attr">addTodo</span>: <span class="hljs-function">(<span class="hljs-params">text: <span class="hljs-built_in">string</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>;
  <span class="hljs-attr">toggleTodo</span>: <span class="hljs-function">(<span class="hljs-params">id: <span class="hljs-built_in">number</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>;
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">TodoList</span> = (<span class="hljs-params">{ todos, addTodo, toggleTodo }: TodoProps</span>) =&gt; {
  <span class="hljs-comment">// 组件实现...</span>
};

<span class="hljs-keyword">const</span> <span class="hljs-title function_">mapStateToProps</span> = (<span class="hljs-params">state</span>) =&gt; ({
  <span class="hljs-attr">todos</span>: state.<span class="hljs-property">todos</span>.<span class="hljs-property">items</span>
});

<span class="hljs-keyword">const</span> mapDispatchToProps = { addTodo, toggleTodo };

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">connect</span>(mapStateToProps, mapDispatchToProps)(<span class="hljs-title class_">TodoList</span>);
</code></pre>
<h3 data-id="heading-20">3. 创建 Redux Action</h3>
<p>使用 <code>rxaction</code> 命令快速生成 Redux Action。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// store/todos/actions.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">ADD_TODO</span> = <span class="hljs-string">'ADD_TODO'</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">TOGGLE_TODO</span> = <span class="hljs-string">'TOGGLE_TODO'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">addTodo</span> = (<span class="hljs-params">text: <span class="hljs-built_in">string</span></span>) =&gt; ({
  <span class="hljs-attr">type</span>: <span class="hljs-variable constant_">ADD_TODO</span>,
  <span class="hljs-attr">payload</span>: {
    <span class="hljs-attr">id</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>(),
    text,
    <span class="hljs-attr">completed</span>: <span class="hljs-literal">false</span>
  }
});

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">toggleTodo</span> = (<span class="hljs-params">id: <span class="hljs-built_in">number</span></span>) =&gt; ({
  <span class="hljs-attr">type</span>: <span class="hljs-variable constant_">TOGGLE_TODO</span>,
  <span class="hljs-attr">payload</span>: id
});
</code></pre>
<h2 data-id="heading-21">插件对比与选择</h2>
<h3 data-id="heading-22">与同类插件对比</h3>









































<table><thead><tr><th>特性</th><th>ES7+ React/Redux/GraphQL/React-Native snippets</th><th>Simple React Snippets</th><th>Reactjs code snippets</th></tr></thead><tbody><tr><td>支持框架</td><td>React/Redux/GraphQL/React-Native</td><td>React</td><td>React</td></tr><tr><td>代码片段数量</td><td>150+</td><td>80±</td><td>100±</td></tr><tr><td>自定义选项</td><td>5+可配置参数</td><td>2-3个</td><td>2-3个</td></tr><tr><td>社区活跃度</td><td>每月更新</td><td>季度更新</td><td>半年更新</td></tr><tr><td>安装体积</td><td>&lt;200KB</td><td>500KB±</td><td>400KB±</td></tr></tbody></table>
<h3 data-id="heading-23">选择建议</h3>
<ul>
<li><strong>优先选择 ES7+ React/Redux/GraphQL/React-Native snippets</strong>：如果你需要开发复杂的 React 应用，使用 Redux 进行状态管理，或者涉及 React-Native 开发，这款插件是你的不二之选。它提供了全面的代码片段和灵活的配置选项，能够满足不同项目的开发需求。</li>
<li><strong>考虑 Simple React Snippets</strong>：如果你只需要基础的 React 功能，避免过多冗余代码片段，或者需要更轻量级的开发环境，可以考虑使用 Simple React Snippets。</li>
<li><strong>混合使用注意事项</strong>：如果同时使用多个代码片段插件，可能会出现触发词冲突的情况。此时，你可以通过 VS Code 设置控制插件加载顺序，或者禁用冲突插件。</li>
</ul>
<h2 data-id="heading-24">常见问题与解决方案</h2>
<h3 data-id="heading-25">问题一：代码片段不生效</h3>
<p><strong>原因分析</strong>：可能是文件类型未被正确识别，或者语言模式设置不正确。
<strong>解决方案</strong>：</p>
<ol>
<li>将当前文件保存为 <code>.jsx</code> 或 <code>.tsx</code> 后缀，避免使用纯 <code>.js/.ts</code> 文件调用 React 专用片段。</li>
<li>点击 VS Code 窗口右下角的语言模式标识（如 “JavaScript”），手动切换为 <code>JavaScript React</code> 或 <code>TypeScript React</code>。</li>
<li>检查键盘布局是否为英文输入法；中文输入法状态下 Tab 键可能被系统拦截，导致无法触发片段。</li>
</ol>
<h3 data-id="heading-26">问题二：触发词冲突</h3>
<p><strong>原因分析</strong>：其他代码片段类插件（如 Reactjs code snippets）可能与 ES7+ 插件注册相同前缀，导致触发失败或内容错乱。
<strong>解决方案</strong>：</p>
<ol>
<li>在扩展视图中搜索已安装的插件，查找名称含 <code>Reactjs code snippets</code> 或 <code>React Preview</code> 的条目。</li>
<li>对疑似冲突插件点击右侧齿轮图标，选择 <code>Disable</code>。</li>
<li>重启 VS Code，再次测试代码片段是否正常展开。</li>
</ol>
<h2 data-id="heading-27">总结</h2>
<p>ES7+ React/Redux/GraphQL/React-Native snippets 插件是一款功能强大、高效实用的 React 开发工具，能够显著提高开发效率，减少重复劳动。通过本文的介绍，相信你已经对该插件有了全面的了解，并掌握了其安装、配置和使用方法。在实际开发中，合理使用这款插件，结合其他优秀的开发工具，能够让你的 React 开发之旅更加顺畅。</p>
<p>如果你正在寻找一款能够提升 React 开发效率的插件，不妨试试 ES7+ React/Redux/GraphQL/React-Native snippets，相信它会成为你开发过程中的得力助手。</p>
<p>**注：**大家还有那些好用的插件推荐，欢迎大家来讨论~</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Unaipp 使用 wot UI 实现一个带数字键盘的密码输入框弹窗]]></title>    <link>https://juejin.cn/post/7605142381151961151</link>    <guid>https://juejin.cn/post/7605142381151961151</guid>    <pubDate>2026-02-11T03:57:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605142381151961151" data-draft-id="7605041451328946219" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Unaipp 使用 wot UI 实现一个带数字键盘的密码输入框弹窗"/> <meta itemprop="keywords" content="Vue.js,前端"/> <meta itemprop="datePublished" content="2026-02-11T03:57:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="isixe"/> <meta itemprop="url" content="https://juejin.cn/user/107078962384456"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Unaipp 使用 wot UI 实现一个带数字键盘的密码输入框弹窗
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/107078962384456/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    isixe
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-11T03:57:16.000Z" title="Wed Feb 11 2026 03:57:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    11
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body blockquote&gt;:first-child{margin-top:0}.markdown-body blockquote&gt;:last-child{margin-bottom:0}.markdown-body{overflow:hidden;line-height:1.75;font-size:15px;background-image:linear-gradient(90deg,rgba(72,42,10,.05) 5%,rgba(72,42,10,0) 0),linear-gradient(1turn,rgba(72,42,10,.05) 5%,rgba(72,42,10,0) 0);background-size:20px 20px;background-position:50%;padding-top:0!important}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{position:relative;display:flex;border-bottom:5px solid #6d4e00;line-height:35px;letter-spacing:1px;font-size:25px;padding-left:25px;color:#664900;text-shadow:1px 1px 1px #8a6200;padding-bottom:0}.markdown-body h1:before{content:"";display:flex;position:absolute;left:0;top:3px;bottom:0;margin:auto;width:20px;height:20px;background-size:20px 20px;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAMAAACahl6sAAAAQlBMVEVHcEwlRnqtZBj76q4lRnolRnolRnolRnolRnokRnr/gGtrVUeLXDBKTl+hYSHasW7Ik0zs0JG4dCvUdEE0SW+rYxrLQJfjAAAACnRSTlMA////0H/xUaMi5MCoTwAACfVJREFUeNrtnQl3qygUgJ9GXAqosfL//+pgmgXwXmRNJGdu55xO+6rx8+6I8O9fehmGriN93zdN07bVXdpW/ih/SbpuGP6dXbpOXv7z2i3S9ISck2eQOnAhMHG64VQQbmrAaM4B05GmipaGdB+m6BNQPBXzMYtKR3EPbB/RS5eY4g+lIW9WBqnySCvVMrzRpqqs0g9nwVg5p1KYlHEchRT5bftp+y3n6xlQDjAkABtrKULU9f377ev+4/1/NiT+URRiZRhrcZP6WLa/Gq005BORaqXsdYEuHPIP798ZxSyt6d5sVfxJESRCsvB32lfXwhRjnUBGmKXNoJQe04VIASJqRC/9G7yDsyQMiloYz+0pHYghEoPISAGgpDSvHsCoMwmA0mfjSG5UOsqah2RodkljzMkhZZdamiEDB8+Nsbk9T04yGNljDXGOZZ6u0+Tj9DuvbyNJBuPO0ABtLNPlJtfZJ4CNNCWJoY8gddwxNpm9YrHh9DEkBoeMud4Kma8XRZaYpBJOYvg59U9wOsblMvmGrzQe30dyqFZ1dxPfO0FT5BOdw989THVs4q1TFk+iN4PMu7CaLpd4EJOExNaJLE4d0xQKYpJ0cY5Ozcwwu6WOu2cs9TUYxPB4b4fvLRzTUXbT1HH7y0BnB0j6CAehkPFfFzd1TMsi6sU1/P4VM9NiISHBlYnBMR+kad075sXlmMehj1twnfTUqJH4GJfqIKte7S72emPnHbdiYHIB0e6ATjKq1UoTaFh6wBL2csMIVo9fH/v6QRHAgoxrOHQQxG/36tC1ODmGOeBGBRmXalgcdhDQ1xF1vI6a3DF2d4r7G1enOUgNOshlFq7qUCxrca9ldiCam7ilxRbP6JbOYsYtfLFmkcXEgLG1DN/6eroxHjqh5bh+Uw27e1oWVK7pN+AqwzUcq/UYTPw8nWufLFBHN2zcxLRYlmGPs6rA2Wy0uJe/E7TknbHIa1WH1bLA8DAj3JpxET+FCNCWZ5uNT6jxTPZK/1mXoCBeKlGLRT2lP69XN3XdqqCojKX1ZVda6iD2McjeXSHa0I+AHd2InGAJgjRVM6gOBfygDrarRJnho6eQBbrns+HkcNUCWtYClJa66qFgPbqqZEBTCOAgRqxCOhQBWpZeIC6QBq91hEoI5unTjsMsK9DCFigY9WNn19hgVCrELalrTw6WnYMYzjHhQ2/7G2xTx1HvwpzSe4cVi5ORQQwMW9+72FU5L4gGsa6Yu1RcDeIhs64Qs8izt0vGH+n9/IKaIlYpM2UqkYOrwwq5CgBjWpyGtxaonxe4KaJ3hx+7O0HaqVkxLBPj8FmBVmjNevIUFhUuDmMq5NDV9RwyPe/95IvxAhG7ymqxHGE5sZJL2kPLUhUinkXfrnFwGFwXD99djNLSFh/meXEb2B6Oyiwm0I7BC+OlTlOVPk9K8CIYzu5YHwKDTI6XAo5lz3WEqEXwQRKhh5cyLa6D81P4PXBw984as9YaGXHwx4Ba8rmOldUat/BHt9cQ38AaljnBdCJqs60OcXVDJZP//ZwSWtV9FpHNtgg22KuYx/U2tB5Mcp1TYOiphNhiFjgWeJ3DL2OZpuuUisIoUyzZEJ76I+LmyqWdv8LwnEiwMYczihjxeqtBsuFJSTg2oD1ETQx4v6D1VleSZW1xCwvAfVGWpQ069kgrQksAUW2rReYzsboIjSABuDQX0QJwB9cnZVgWVgE31vrklAJnEmVObykgYCk/VGX5OlpuKb5eiovUAvJ2tMstw0kIkNdpiSA91K6XA6K8CVCyr4PePhTo65q3DyX7OpTbSVk1PB62mhJ9HSpSqtKaESxsFRm0tLBVcvTV+vbBrLRK4hC7aitN9B0ZpX6vNMgjGIt5ZdmMv32KrmprD1afsPd4FEhThK0+WfTl3kpd482AGvG3jQdZK1+t8ireDswhofigRb3fxfI/4jj+xkffUX/1ccxxhEP9qyyBEH9Cx9vhf8TB7eiSpBHjZVSa4whQMJC1TqIR6q8RERtjOr2ID0yx3oYi0oAIvZCPz4eG64p3ObuREeOHUIR3MBVJwq9yll5P7KHdiPBOiOoRa/AjXz21J3k04l+i8OjErj4kaXWQiIVO/EvA+KLRAEnUVomtjPd6SvR3RLoeMT54nKFH1EqtkkEGFaQuTlSQrsxhRiOIt51S/Ho8B11+FUlwRaHnU4utEI38/mgSjRJ8PhWEtN6Z6WcncQOU4efjKoh3zfi7/+DfhPrwOZ9a/iYBiVJJxPlei3CqIDTYEqAPFow5/c71fAdVIwmo4n+cTIGbr2n9NULAE5ifcNNS63hvEOFk0wxYnICBBZ0I9xERBVILF0uggNdxuOkR4S6ngvgPmArzHv4KpMKGQFjQ+Rw6q9dC6R6dgZaJF7RVWIH0BTY9h+fz0ohHOyLuy+He/hN4GUR3/RxcBx2f76izarI9CaXmzRmhNQuSfIgJkva5GzN6HJbhQxCNsDGDSh56plmef6sg2eaXPsYBt5W+H6VE6omG6hOS1w4hiTWiThbJ1YO+RSO1vrpMlomf6nhQGz0m7qT6W04XOUHyzhZ4rkG+0hxL66oDW9mnPWyL3TMmssxyQUwr01CHX7b2OvUIaqS48TnMtAoEQTQixJeAlDfSiGmk/l8jpwIpTyFqOfeNIHWBooC036ERtUQp2tm/CKT5jjySbxTlvUVj2yhjvyWDVL3yfKRojXwLSEWUp7q0PBAKPp7m5YGoT3WH7wAZ1BeOywNZv3Gak/LIqriwxbQ5jaTcsEW1eb+FvoWo+zr5V/IUOvNtsapU2zJXSyj0xVB13sPfq0kkZA7dubIIKXIlJ8Cy7u+BN22RVcr+peOuxHdcBbA04FAVmEoEtO5vX55K4KVZS1QJvBBzU1rgUl8JapBNYIowLoZtD9NWRTWKqqe36L48BSz8QPH9epqqIDehlh2UuqocEmrdV7AvhuRoM74m80yeDIEX3ppreNN235FxV58DNjhswn5K8zK21+5ctjut6NmUIoy9tVvitnHr2VDM3ahtW8KQ/Vbsp9GGiWHfk8skyTSFz9/HdxhHe4uR/RxX/mG1SGXwypcDJNmCMfucZ/C1CuCQUbiBUDYbe7tiRkZX8GIat50d+wqR1fdN7ygGzrHrcN4kGFHK02cil5M6INgQVsvnNz77T5PqUFYJJInYmIBplJfP5On4eiOwYfhuCD44oLyYVs43rI1rk3H7usttzq8Qo3j84vavN9mOkAeuq8dHEd9NtCVKX51Oen+MM6IEYvz5StOehKLpIjD+nKU5AQWJpLizdB+1sb5LQvFRxbSJVGHmSdK/0WWaPguEYmcSJ68aWkK6rAw6jwSSCmrTWVHT96R7HwHANEgqybVJL+E2vE2q7Uu91Gr73SbbNUvZDtiOlCeIv4r/AI+0XUwz1lvcAAAAAElFTkSuQmCC")}.markdown-body h2{position:relative;padding:0 0 0 20px;font-size:20px;font-weight:700;color:#614500}.markdown-body h2:before{content:"";position:absolute;top:3px;bottom:0;left:0;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAMAAACahl6sAAAAQlBMVEVHcEwlRnqtZBj76q4lRnolRnolRnolRnolRnokRnr/gGtrVUeLXDBKTl+hYSHasW7Ik0zs0JG4dCvUdEE0SW+rYxrLQJfjAAAACnRSTlMA////0H/xUaMi5MCoTwAACfVJREFUeNrtnQl3qygUgJ9GXAqosfL//+pgmgXwXmRNJGdu55xO+6rx8+6I8O9fehmGriN93zdN07bVXdpW/ih/SbpuGP6dXbpOXv7z2i3S9ISck2eQOnAhMHG64VQQbmrAaM4B05GmipaGdB+m6BNQPBXzMYtKR3EPbB/RS5eY4g+lIW9WBqnySCvVMrzRpqqs0g9nwVg5p1KYlHEchRT5bftp+y3n6xlQDjAkABtrKULU9f377ev+4/1/NiT+URRiZRhrcZP6WLa/Gq005BORaqXsdYEuHPIP798ZxSyt6d5sVfxJESRCsvB32lfXwhRjnUBGmKXNoJQe04VIASJqRC/9G7yDsyQMiloYz+0pHYghEoPISAGgpDSvHsCoMwmA0mfjSG5UOsqah2RodkljzMkhZZdamiEDB8+Nsbk9T04yGNljDXGOZZ6u0+Tj9DuvbyNJBuPO0ABtLNPlJtfZJ4CNNCWJoY8gddwxNpm9YrHh9DEkBoeMud4Kma8XRZaYpBJOYvg59U9wOsblMvmGrzQe30dyqFZ1dxPfO0FT5BOdw989THVs4q1TFk+iN4PMu7CaLpd4EJOExNaJLE4d0xQKYpJ0cY5Ozcwwu6WOu2cs9TUYxPB4b4fvLRzTUXbT1HH7y0BnB0j6CAehkPFfFzd1TMsi6sU1/P4VM9NiISHBlYnBMR+kad075sXlmMehj1twnfTUqJH4GJfqIKte7S72emPnHbdiYHIB0e6ATjKq1UoTaFh6wBL2csMIVo9fH/v6QRHAgoxrOHQQxG/36tC1ODmGOeBGBRmXalgcdhDQ1xF1vI6a3DF2d4r7G1enOUgNOshlFq7qUCxrca9ldiCam7ilxRbP6JbOYsYtfLFmkcXEgLG1DN/6eroxHjqh5bh+Uw27e1oWVK7pN+AqwzUcq/UYTPw8nWufLFBHN2zcxLRYlmGPs6rA2Wy0uJe/E7TknbHIa1WH1bLA8DAj3JpxET+FCNCWZ5uNT6jxTPZK/1mXoCBeKlGLRT2lP69XN3XdqqCojKX1ZVda6iD2McjeXSHa0I+AHd2InGAJgjRVM6gOBfygDrarRJnho6eQBbrns+HkcNUCWtYClJa66qFgPbqqZEBTCOAgRqxCOhQBWpZeIC6QBq91hEoI5unTjsMsK9DCFigY9WNn19hgVCrELalrTw6WnYMYzjHhQ2/7G2xTx1HvwpzSe4cVi5ORQQwMW9+72FU5L4gGsa6Yu1RcDeIhs64Qs8izt0vGH+n9/IKaIlYpM2UqkYOrwwq5CgBjWpyGtxaonxe4KaJ3hx+7O0HaqVkxLBPj8FmBVmjNevIUFhUuDmMq5NDV9RwyPe/95IvxAhG7ymqxHGE5sZJL2kPLUhUinkXfrnFwGFwXD99djNLSFh/meXEb2B6Oyiwm0I7BC+OlTlOVPk9K8CIYzu5YHwKDTI6XAo5lz3WEqEXwQRKhh5cyLa6D81P4PXBw984as9YaGXHwx4Ba8rmOldUat/BHt9cQ38AaljnBdCJqs60OcXVDJZP//ZwSWtV9FpHNtgg22KuYx/U2tB5Mcp1TYOiphNhiFjgWeJ3DL2OZpuuUisIoUyzZEJ76I+LmyqWdv8LwnEiwMYczihjxeqtBsuFJSTg2oD1ETQx4v6D1VleSZW1xCwvAfVGWpQ069kgrQksAUW2rReYzsboIjSABuDQX0QJwB9cnZVgWVgE31vrklAJnEmVObykgYCk/VGX5OlpuKb5eiovUAvJ2tMstw0kIkNdpiSA91K6XA6K8CVCyr4PePhTo65q3DyX7OpTbSVk1PB62mhJ9HSpSqtKaESxsFRm0tLBVcvTV+vbBrLRK4hC7aitN9B0ZpX6vNMgjGIt5ZdmMv32KrmprD1afsPd4FEhThK0+WfTl3kpd482AGvG3jQdZK1+t8ireDswhofigRb3fxfI/4jj+xkffUX/1ccxxhEP9qyyBEH9Cx9vhf8TB7eiSpBHjZVSa4whQMJC1TqIR6q8RERtjOr2ID0yx3oYi0oAIvZCPz4eG64p3ObuREeOHUIR3MBVJwq9yll5P7KHdiPBOiOoRa/AjXz21J3k04l+i8OjErj4kaXWQiIVO/EvA+KLRAEnUVomtjPd6SvR3RLoeMT54nKFH1EqtkkEGFaQuTlSQrsxhRiOIt51S/Ho8B11+FUlwRaHnU4utEI38/mgSjRJ8PhWEtN6Z6WcncQOU4efjKoh3zfi7/+DfhPrwOZ9a/iYBiVJJxPlei3CqIDTYEqAPFow5/c71fAdVIwmo4n+cTIGbr2n9NULAE5ifcNNS63hvEOFk0wxYnICBBZ0I9xERBVILF0uggNdxuOkR4S6ngvgPmArzHv4KpMKGQFjQ+Rw6q9dC6R6dgZaJF7RVWIH0BTY9h+fz0ohHOyLuy+He/hN4GUR3/RxcBx2f76izarI9CaXmzRmhNQuSfIgJkva5GzN6HJbhQxCNsDGDSh56plmef6sg2eaXPsYBt5W+H6VE6omG6hOS1w4hiTWiThbJ1YO+RSO1vrpMlomf6nhQGz0m7qT6W04XOUHyzhZ4rkG+0hxL66oDW9mnPWyL3TMmssxyQUwr01CHX7b2OvUIaqS48TnMtAoEQTQixJeAlDfSiGmk/l8jpwIpTyFqOfeNIHWBooC036ERtUQp2tm/CKT5jjySbxTlvUVj2yhjvyWDVL3yfKRojXwLSEWUp7q0PBAKPp7m5YGoT3WH7wAZ1BeOywNZv3Gak/LIqriwxbQ5jaTcsEW1eb+FvoWo+zr5V/IUOvNtsapU2zJXSyj0xVB13sPfq0kkZA7dubIIKXIlJ8Cy7u+BN22RVcr+peOuxHdcBbA04FAVmEoEtO5vX55K4KVZS1QJvBBzU1rgUl8JapBNYIowLoZtD9NWRTWKqqe36L48BSz8QPH9epqqIDehlh2UuqocEmrdV7AvhuRoM74m80yeDIEX3ppreNN235FxV58DNjhswn5K8zK21+5ctjut6NmUIoy9tVvitnHr2VDM3ahtW8KQ/Vbsp9GGiWHfk8skyTSFz9/HdxhHe4uR/RxX/mG1SGXwypcDJNmCMfucZ/C1CuCQUbiBUDYbe7tiRkZX8GIat50d+wqR1fdN7ygGzrHrcN4kGFHK02cil5M6INgQVsvnNz77T5PqUFYJJInYmIBplJfP5On4eiOwYfhuCD44oLyYVs43rI1rk3H7usttzq8Qo3j84vavN9mOkAeuq8dHEd9NtCVKX51Oen+MM6IEYvz5StOehKLpIjD+nKU5AQWJpLizdB+1sb5LQvFRxbSJVGHmSdK/0WWaPguEYmcSJ68aWkK6rAw6jwSSCmrTWVHT96R7HwHANEgqybVJL+E2vE2q7Uu91Gr73SbbNUvZDtiOlCeIv4r/AI+0XUwz1lvcAAAAAElFTkSuQmCC");background-size:100% 100%;background-repeat:no-repeat;width:15px;height:15px;margin:auto}.markdown-body h3{width:100%;text-align:left;margin:20px 10px 0 0;font-size:18px;font-weight:700;display:inline-block;padding-left:10px;padding-bottom:0;border-left:5px solid #8f6600;color:#614500}.markdown-body h4,.markdown-body h5,.markdown-body h6{font-weight:700;color:#a37400}.markdown-body h4{font-size:17px}.markdown-body h5,.markdown-body h6{display:flex;align-items:center}.markdown-body h5:after,.markdown-body h6:after{display:inline-block;border:2px solid #fff6e0;color:rgba(189,134,0,.5);border-radius:50%;text-align:center;margin-left:5px}.markdown-body h5{font-size:14px}.markdown-body h5:after{content:"5";width:15px;height:15px;line-height:15px;font-size:13px}.markdown-body h6{font-size:12px}.markdown-body h6:after{content:"6";width:13px;height:13px;line-height:13px;font-size:12px}.markdown-body p{color:#412c0c;letter-spacing:1px;font-weight:400;margin-bottom:16px}.markdown-body img{max-width:100%;display:block;margin:auto}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#755300;font-weight:400;border-bottom:1px solid #755300;font-weight:bolder;text-decoration:none}.markdown-body table{width:100%!important;margin:0;font-size:12px;width:auto;max-width:100%;overflow:auto;border-collapse:collapse;border-spacing:0}.markdown-body table img{box-shadow:none}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body thead tr th{text-align:center}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px;box-sizing:border-box;border:1px solid rgba(72,42,10,.1)}.markdown-body blockquote{position:relative;text-size-adjust:100%;line-height:25px;font-weight:400;border-radius:10px;font-style:normal;text-align:left;box-sizing:inherit;border:1px solid #ffd87a;background-color:rgba(189,134,0,.5);margin:20px 0;padding:20px}.markdown-body blockquote p{color:#fff6e0;letter-spacing:2px;margin:0}.markdown-body blockquote:after,.markdown-body blockquote:before{position:absolute;color:#cc9100;font-size:34px;font-weight:700}.markdown-body blockquote:before{content:"❝";top:8px;left:5px}.markdown-body blockquote:after{content:"❞";right:5px;bottom:-5px}.markdown-body strong{color:#c28a00;font-weight:bolder}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{color:#c28a00}.markdown-body em strong{font-style:normal;color:#c28a00;background-color:#8a6200}.markdown-body s{color:#c28a00}.markdown-body hr{border-top:1px solid #805b00}.markdown-body code,.markdown-body li code,.markdown-body p code{color:#996d00;background-color:rgba(130,98,0,.3)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit;color:#858585;font-family:bold;letter-spacing:1px}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection,.markdown-body img::selection{color:rgba(189,134,0,.5);background-color:#fff}.markdown-body a::selection,.markdown-body b::selection,.markdown-body del::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:transparent}.markdown-body pre&gt;code::selection{background-color:rgba(189,134,0,.5)}.markdown-body .math .math-inline::selection,.markdown-body blockquote::selection,.markdown-body ol::selection,.markdown-body p::selection,.markdown-body strong::selection,.markdown-body table::selection,.markdown-body ul::selection{background-color:rgba(189,134,0,.5)}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="monokai-sublime">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#23241f}.hljs-subst,.hljs-tag,.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#f8f8f2}.hljs-emphasis,.hljs-strong{color:#a8a8a2}.hljs-bullet,.hljs-link,.hljs-literal,.hljs-number,.hljs-quote,.hljs-regexp{color:#ae81ff}.hljs-code,.hljs-section,.hljs-selector-class,.hljs-title{color:#a6e22e}.hljs-strong{font-weight:700}.hljs-emphasis{font-style:italic}.hljs-attr,.hljs-keyword,.hljs-name,.hljs-selector-tag{color:#f92672}.hljs-attribute,.hljs-symbol{color:#66d9ef}.hljs-class .hljs-title,.hljs-params{color:#f8f8f2}.hljs-addition,.hljs-built_in,.hljs-builtin-name,.hljs-selector-attr,.hljs-selector-id,.hljs-selector-pseudo,.hljs-string,.hljs-template-variable,.hljs-type,.hljs-variable{color:#e6db74}.hljs-comment,.hljs-deletion,.hljs-meta{color:#75715e}</style><p>最近项目里有个支付输入密码的需求，所以在这之前都是使用一个简单的输入框实现的，但是这样体验不太好。所以，这次就改成了弹窗，尝试达到类似支付宝的弹窗输入密码的形式。</p>
<h3 data-id="heading-0">前言</h3>
<p>在 Wot UI 中是有密码输入框（wd-password-input）和数字键盘（wd-number-keyboard）两个组件的，但是在文档示例中你会发现，数字键盘是以弹窗的形式覆盖在界面顶层的。如果我们直接使用这个组件，就会出现弹窗盖在弹窗上的奇怪问题。</p>
<p>所以最好的方式，是改写数字键盘组件的全局样式，再将其和密码输入框组合起来，放到新的弹窗中。</p>
<h3 data-id="heading-1">防止数字键盘下沉</h3>
<p>打开控制台管擦，我们会发现数字键盘实际上也是一个弹窗，而内部会通关组件参数 v-model:visible 进行更新。</p>
<p>因此，首先我们要设置 <code>:hide-on-click-outside="false"</code>，防止数字键盘因为点击蒙版意外关闭。</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">wd-keyboard</span>
  <span class="hljs-attr">class</span>=<span class="hljs-string">"pass-keyboard"</span>
  <span class="hljs-attr">:hide-on-click-outside</span>=<span class="hljs-string">"false"</span>
  <span class="hljs-attr">v-model:visible</span>=<span class="hljs-string">"showKeyboard"</span>
  <span class="hljs-attr">mode</span>=<span class="hljs-string">"custom"</span>
  <span class="hljs-attr">:close-text</span>=<span class="hljs-string">"confirmText"</span>
  @<span class="hljs-attr">input</span>=<span class="hljs-string">"onPassInput"</span>
  @<span class="hljs-attr">close</span>=<span class="hljs-string">"handlePassClose"</span>
  @<span class="hljs-attr">delete</span>=<span class="hljs-string">"onPassDelete"</span>
&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">wd-keyboard</span>&gt;</span>
</code></pre>
<p>然后我们会发现一旦点击左下角的键盘按钮，数字键盘就会被收起来，只有点击密码输入框才能弹出。显然这不是我们想要的效果，最终效果应该是数字输入框和密码输入框固定的一直显示。通过观察，弹窗的显示是通过 display 和过渡动画实现的，那么最有效的方式就是样式覆盖了</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.pass-keyboard</span> {
  :<span class="hljs-built_in">deep</span>(.wd-popup) {
    <span class="hljs-attribute">position</span>: relative;
    <span class="hljs-attribute">transition</span>: none;
    <span class="hljs-attribute">display</span>: block <span class="hljs-meta">!important</span>;
  }
}
</code></pre>
<p>我们还需要禁止初始化时，弹窗淡入淡出的动画，防止数字键盘出现延迟显示，闪烁的问题</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.pass-keyboard</span> {
  :<span class="hljs-built_in">deep</span>(.wd-slide-up-enter),
  :<span class="hljs-built_in">deep</span>(.wd-slide-up-leave-to) {
    <span class="hljs-attribute">transform</span>: none;
  }
}
</code></pre>
<p>到这里，我们就能够让数字键盘固定到界面中，作为一个普通的组件使用了。</p>
<h3 data-id="heading-2">在悬浮面板中组合 密码输入框 和 数字键盘</h3>
<p>现在，我们把 密码输入框 和 数字键盘同时放进 Wot IU 的底部弹窗组件（wd-popup）中，会发现两个组件没有联动起来，所以还需要配合密码输入框的焦点事件, 让数字键盘一直显示。</p>
<pre><code class="hljs language-html" lang="html">...
<span class="hljs-tag">&lt;<span class="hljs-name">wd-password-input</span>
  <span class="hljs-attr">v-model</span>=<span class="hljs-string">"payPassword"</span>
  <span class="hljs-attr">:length</span>=<span class="hljs-string">"maxLength"</span>
  <span class="hljs-attr">:gutter</span>=<span class="hljs-string">"10"</span>
  <span class="hljs-attr">:mask</span>=<span class="hljs-string">"true"</span>
  <span class="hljs-attr">:focused</span>=<span class="hljs-string">"showKeyboard"</span>
  @<span class="hljs-attr">focus</span>=<span class="hljs-string">"handlePasswordFocus"</span>
/&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">wd-keyboard</span>
  <span class="hljs-attr">class</span>=<span class="hljs-string">"pass-keyboard"</span>
  <span class="hljs-attr">:hide-on-click-outside</span>=<span class="hljs-string">"false"</span>
  <span class="hljs-attr">v-model:visible</span>=<span class="hljs-string">"showKeyboard"</span>
&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">wd-keyboard</span>&gt;</span>

...

// 处理密码框聚焦 
function handlePasswordFocus() { 
  // 强制显示键盘
  showKeyboard.value = true; 
}
</code></pre>
<p>这样我们就基本完成在不弹出系统输入法的情况下，使用数字虚拟键盘输入框密码的操作了。但是到这里你会发现支付宝的密码弹窗都是自动完成后关闭的，现在我们实现的功能，不能做到自动未完成和关闭弹窗。</p>
<p>不过，我们可以通过自定义数字键盘，增加提交按钮，并监听点击事件实现这个操作。在 @close 我们将关闭动作传递到父组件，让父组件直接关闭最外层的弹窗就可以了。</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">wd-keyboard</span>
  <span class="hljs-attr">class</span>=<span class="hljs-string">"pass-keyboard"</span>
  <span class="hljs-attr">:hide-on-click-outside</span>=<span class="hljs-string">"false"</span>
  <span class="hljs-attr">v-model:visible</span>=<span class="hljs-string">"showKeyboard"</span>
  <span class="hljs-attr">mode</span>=<span class="hljs-string">"custom"</span>
  <span class="hljs-attr">:close-text</span>=<span class="hljs-string">"confirmText"</span>
  @<span class="hljs-attr">input</span>=<span class="hljs-string">"onPassInput"</span>
  @<span class="hljs-attr">close</span>=<span class="hljs-string">"handlePassClose"</span>
  @<span class="hljs-attr">delete</span>=<span class="hljs-string">"onPassDelete"</span>
&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">wd-keyboard</span>&gt;</span>

// 处理关闭 - 点击确定按钮后直接关闭弹窗
function handlePassClose() {
  if (payPassword.value.length &lt; 6) return;

  // 触发输入完成事件
  emit("input-complete", payPassword.value);
}
</code></pre>
<p>如果需要自动完成，那么就直接监听密码输入框的输入位数，手动调用上面的关闭事件就可以了</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 监听密码变化</span>
<span class="hljs-title function_">watch</span>(payPassword, <span class="hljs-function">(<span class="hljs-params">newVal</span>) =&gt;</span> {
  <span class="hljs-comment">// 密码输入完成后的处理</span>
  <span class="hljs-keyword">if</span> (newVal.<span class="hljs-property">length</span> === props.<span class="hljs-property">maxLength</span>) {
    <span class="hljs-comment">// 如果启用自动关闭</span>
    <span class="hljs-keyword">if</span> (props.<span class="hljs-property">autoConfirm</span>) {
      <span class="hljs-comment">// 延迟关闭，让用户能看到输入完成的效果</span>
      <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-title function_">handlePassClose</span>();
      }, <span class="hljs-number">300</span>);
    }
  }
});
</code></pre>
<h3 data-id="heading-3">完整实例</h3>
<p>最后，我把这个功能封装成了一个组件，只需要在项目中引用这个组件，并且根据输入完成事件做进一步处理就行了。唯一不足的是，当密码输入错误时，不能像支付宝一样停留在弹窗输入层，只能退其次统一关闭后处理接口请求传参。</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">view</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">wd-popup</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"showPasswordPopup"</span> <span class="hljs-attr">position</span>=<span class="hljs-string">"bottom"</span> <span class="hljs-attr">round</span> <span class="hljs-attr">:close-on-click-overlay</span>=<span class="hljs-string">"true"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">view</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"pay-pass-popup"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"pass-top"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">view</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"popup-title"</span>&gt;</span> {{ title }} <span class="hljs-tag">&lt;/<span class="hljs-name">view</span>&gt;</span>

          <span class="hljs-comment">&lt;!-- 密码长度提示 --&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">view</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"showLengthHint"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"password-length-hint"</span>&gt;</span>
            {{ payPassword.length }}/{{ maxLength }}
          <span class="hljs-tag">&lt;/<span class="hljs-name">view</span>&gt;</span>

          <span class="hljs-comment">&lt;!-- 密码输入框 --&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">wd-password-input</span>
            <span class="hljs-attr">v-model</span>=<span class="hljs-string">"payPassword"</span>
            <span class="hljs-attr">:length</span>=<span class="hljs-string">"maxLength"</span>
            <span class="hljs-attr">:gutter</span>=<span class="hljs-string">"10"</span>
            <span class="hljs-attr">:mask</span>=<span class="hljs-string">"mask"</span>
            <span class="hljs-attr">:focused</span>=<span class="hljs-string">"showKeyboard"</span>
            @<span class="hljs-attr">focus</span>=<span class="hljs-string">"handlePasswordFocus"</span>
          /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">wd-keyboard</span>
          <span class="hljs-attr">class</span>=<span class="hljs-string">"pass-keyboard"</span>
          <span class="hljs-attr">:hide-on-click-outside</span>=<span class="hljs-string">"false"</span>
          <span class="hljs-attr">v-model:visible</span>=<span class="hljs-string">"showKeyboard"</span>
          <span class="hljs-attr">mode</span>=<span class="hljs-string">"custom"</span>
          <span class="hljs-attr">:close-text</span>=<span class="hljs-string">"confirmText"</span>
          @<span class="hljs-attr">input</span>=<span class="hljs-string">"onPassInput"</span>
          @<span class="hljs-attr">close</span>=<span class="hljs-string">"handlePassClose"</span>
          @<span class="hljs-attr">delete</span>=<span class="hljs-string">"onPassDelete"</span>
        &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">wd-keyboard</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">view</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">wd-popup</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">view</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"ts"</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { ref, watch } <span class="hljs-keyword">from</span> <span class="hljs-string">"vue"</span>;

<span class="hljs-comment">// 定义Props</span>
interface <span class="hljs-title class_">Props</span> {
  <span class="hljs-comment">// 弹窗标题</span>
  title?: string;
  <span class="hljs-comment">// 确认按钮文本</span>
  confirmText?: string;
  <span class="hljs-comment">// 是否显示弹窗</span>
  visible?: boolean;
  <span class="hljs-comment">// 密码最大长度</span>
  maxLength?: number;
  <span class="hljs-comment">// 是否显示密码长度提示</span>
  showLengthHint?: boolean;
  <span class="hljs-comment">// 是否隐藏密码（显示为圆点）</span>
  mask?: boolean;
  <span class="hljs-comment">// 是否自动关闭（输入完成后）</span>
  autoConfirm?: boolean;
}

<span class="hljs-keyword">const</span> props = <span class="hljs-title function_">withDefaults</span>(defineProps&lt;<span class="hljs-title class_">Props</span>&gt;(), {
  <span class="hljs-attr">title</span>: <span class="hljs-string">"请输入支付密码"</span>,
  <span class="hljs-attr">confirmText</span>: <span class="hljs-string">"确定"</span>,
  <span class="hljs-attr">visible</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">maxLength</span>: <span class="hljs-number">6</span>,
  <span class="hljs-attr">showLengthHint</span>: <span class="hljs-literal">false</span>,
  <span class="hljs-attr">mask</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">autoConfirm</span>: <span class="hljs-literal">false</span>,
});

<span class="hljs-comment">// 定义Emits</span>
<span class="hljs-keyword">const</span> emit = defineEmits&lt;{
  <span class="hljs-string">"input-complete"</span>: [<span class="hljs-attr">value</span>: string];
}&gt;();

<span class="hljs-keyword">const</span> payPassword = ref&lt;string&gt;(<span class="hljs-string">""</span>);
<span class="hljs-keyword">const</span> showPasswordPopup = <span class="hljs-title function_">defineModel</span>(<span class="hljs-string">"visible"</span>, { <span class="hljs-attr">default</span>: <span class="hljs-literal">false</span> });
<span class="hljs-comment">// 显示键盘</span>
<span class="hljs-keyword">const</span> showKeyboard = ref&lt;boolean&gt;(<span class="hljs-literal">true</span>);

<span class="hljs-comment">// 监听密码变化</span>
<span class="hljs-title function_">watch</span>(payPassword, <span class="hljs-function">(<span class="hljs-params">newVal</span>) =&gt;</span> {
  <span class="hljs-comment">//   console.log("当前密码:", newVal);</span>

  <span class="hljs-comment">// 密码输入完成后的处理</span>
  <span class="hljs-keyword">if</span> (newVal.<span class="hljs-property">length</span> === props.<span class="hljs-property">maxLength</span>) {
    <span class="hljs-comment">// 如果启用自动关闭</span>
    <span class="hljs-keyword">if</span> (props.<span class="hljs-property">autoConfirm</span>) {
      <span class="hljs-comment">// 延迟关闭，让用户能看到输入完成的效果</span>
      <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-title function_">handlePassClose</span>();
      }, <span class="hljs-number">300</span>);
    }
  }
});

<span class="hljs-comment">// 键盘输入处理 - 只接受数字</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">onPassInput</span>(<span class="hljs-params">val: string</span>) {
  <span class="hljs-comment">// 只接受数字输入</span>
  <span class="hljs-keyword">if</span> (!<span class="hljs-regexp">/^\d$/</span>.<span class="hljs-title function_">test</span>(val)) {
    <span class="hljs-keyword">return</span>;
  }

  <span class="hljs-comment">// 如果已经输入到最大长度，不再接受输入</span>
  <span class="hljs-keyword">if</span> (payPassword.<span class="hljs-property">value</span>.<span class="hljs-property">length</span> &gt;= props.<span class="hljs-property">maxLength</span>) {
    <span class="hljs-keyword">return</span>;
  }

  <span class="hljs-comment">// 添加数字到密码</span>
  payPassword.<span class="hljs-property">value</span> += val;
}

<span class="hljs-comment">// 删除处理</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">onPassDelete</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">if</span> (payPassword.<span class="hljs-property">value</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
    <span class="hljs-comment">// 删除最后一位</span>
    payPassword.<span class="hljs-property">value</span> = payPassword.<span class="hljs-property">value</span>.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, -<span class="hljs-number">1</span>);
  }
}

<span class="hljs-comment">// 处理密码框聚焦</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">handlePasswordFocus</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 强制显示键盘</span>
  showKeyboard.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span>;
}

<span class="hljs-comment">// 处理关闭 - 点击确定按钮后直接关闭弹窗</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">handlePassClose</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">if</span> (payPassword.<span class="hljs-property">value</span>.<span class="hljs-property">length</span> &lt; <span class="hljs-number">6</span>) <span class="hljs-keyword">return</span>;

  <span class="hljs-comment">// 触发输入完成事件</span>
  <span class="hljs-title function_">emit</span>(<span class="hljs-string">"input-complete"</span>, payPassword.<span class="hljs-property">value</span>);

  <span class="hljs-comment">// 关闭密码输入弹窗</span>
  <span class="hljs-comment">//   close();</span>
}

<span class="hljs-comment">// 清空密码</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">clearPassword</span>(<span class="hljs-params"/>) {
  payPassword.<span class="hljs-property">value</span> = <span class="hljs-string">""</span>;
}

<span class="hljs-comment">// 打开弹窗</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">open</span>(<span class="hljs-params"/>) {
  <span class="hljs-title function_">clearPassword</span>();
  showPasswordPopup.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span>;
}

<span class="hljs-comment">// 关闭弹窗</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">close</span>(<span class="hljs-params"/>) {
  showPasswordPopup.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>;
  <span class="hljs-title function_">clearPassword</span>();
}

<span class="hljs-comment">// 获取当前密码</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getPassword</span>(<span class="hljs-params"/>): string {
  <span class="hljs-keyword">return</span> payPassword.<span class="hljs-property">value</span>;
}

<span class="hljs-comment">// 暴露方法给父组件</span>
<span class="hljs-title function_">defineExpose</span>({
  open,
  close,
  clearPassword,
  getPassword,
});
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"scss"</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
<span class="hljs-selector-class">.pay-pass-popup</span> {
  <span class="hljs-attribute">justify-content</span>: center;
}

<span class="hljs-selector-class">.pass-top</span> {
  <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#ffffff</span>;
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">40</span>rpx;
  <span class="hljs-attribute">display</span>: flex;
  <span class="hljs-attribute">flex-direction</span>: column;
  <span class="hljs-attribute">gap</span>: <span class="hljs-number">20px</span>;
}

<span class="hljs-selector-class">.popup-title</span> {
  <span class="hljs-attribute">font-size</span>: <span class="hljs-number">32</span>rpx;
  <span class="hljs-attribute">font-weight</span>: bold;
  <span class="hljs-attribute">text-align</span>: center;
  <span class="hljs-attribute">color</span>: <span class="hljs-number">#333</span>;
}

<span class="hljs-selector-class">.password-length-hint</span> {
  <span class="hljs-attribute">font-size</span>: <span class="hljs-number">24</span>rpx;
  <span class="hljs-attribute">text-align</span>: center;
  <span class="hljs-attribute">color</span>: <span class="hljs-number">#999</span>;
  <span class="hljs-attribute">margin-top</span>: -<span class="hljs-number">10</span>rpx;
}

<span class="hljs-selector-class">.pass-keyboard</span> {
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">40</span>rpx <span class="hljs-number">0</span>;
  <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#f5f5f5</span>;

  :<span class="hljs-built_in">deep</span>(.wd-popup) {
    <span class="hljs-attribute">position</span>: relative;
    <span class="hljs-attribute">transition</span>: none;
    <span class="hljs-attribute">display</span>: block <span class="hljs-meta">!important</span>;
  }

  :<span class="hljs-built_in">deep</span>(.wd-key.wd-key--close) {
    <span class="hljs-attribute">background</span>: <span class="hljs-built_in">linear-gradient</span>(<span class="hljs-number">37deg</span>, <span class="hljs-number">#ff3945</span> <span class="hljs-number">5%</span>, <span class="hljs-number">#ff9c4a</span> <span class="hljs-number">80%</span>);
    <span class="hljs-attribute">color</span>: white;
    <span class="hljs-attribute">font-weight</span>: bold;
  }

  :<span class="hljs-built_in">deep</span>(.wd-key) {
    <span class="hljs-attribute">font-size</span>: <span class="hljs-number">32</span>rpx;
    <span class="hljs-attribute">font-weight</span>: <span class="hljs-number">500</span>;
  }

  :<span class="hljs-built_in">deep</span>(.wd-key:active) {
    <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#e0e0e0</span>;
  }

  :<span class="hljs-built_in">deep</span>(.wd-key--close:active) {
    <span class="hljs-attribute">background</span>: <span class="hljs-built_in">linear-gradient</span>(<span class="hljs-number">37deg</span>, <span class="hljs-number">#e6323d</span> <span class="hljs-number">5%</span>, <span class="hljs-number">#e68c45</span> <span class="hljs-number">80%</span>);
  }

  :<span class="hljs-built_in">deep</span>(.wd-keyboard__keys) {
    <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span> <span class="hljs-number">8</span>rpx;
  }

  :<span class="hljs-built_in">deep</span>(.wd-slide-up-enter),
  :<span class="hljs-built_in">deep</span>(.wd-slide-up-leave-to) {
    <span class="hljs-attribute">transform</span>: none;
  }
}

:<span class="hljs-built_in">deep</span>(.wd-password-input__item) {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">45px</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">40px</span>;
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">background</span>: <span class="hljs-number">#f2f2f2</span>;
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">10px</span>;
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre>
<h3 data-id="heading-4">使用示例</h3>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">ac-pass-popup</span>
    <span class="hljs-attr">ref</span>=<span class="hljs-string">"passPopupRef"</span>
    <span class="hljs-attr">v-model:visible</span>=<span class="hljs-string">"showPassPopup"</span>
    <span class="hljs-attr">:title</span>=<span class="hljs-string">"t('withdrawPage.请输入支付密码')"</span>
    <span class="hljs-attr">:confirmText</span>=<span class="hljs-string">"t('withdrawPage.提现')"</span>
    @<span class="hljs-attr">input-complete</span>=<span class="hljs-string">"onInputComplete"</span>
  /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">const</span> passPopupRef = <span class="hljs-title function_">ref</span>();

<span class="hljs-keyword">function</span> <span class="hljs-title function_">onRequest</span>(<span class="hljs-params"/>){
    <span class="hljs-comment">// 接口处理</span>
    ...
    passPopupRef.<span class="hljs-property">value</span>.<span class="hljs-title function_">close</span>();
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<h3 data-id="heading-5">结语</h3>
<p>组件库虽然方便了大部分的开发场景，但是在某些情况下，仍然需要自行做类似的功能实现处理。</p>
<p>另外，该组件已经归档到项目 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fisixe%2Funiapp-vitesse-wot-one%2Fblob%2Fmaster%2Fsrc%2Fcomponents%2Fwot%2Fpopup%2Fkeyboard-pwd-popup.vue" target="_blank" title="https://gitee.com/isixe/uniapp-vitesse-wot-one/blob/master/src/components/wot/popup/keyboard-pwd-popup.vue" ref="nofollow noopener noreferrer">uniapp-vitesse-wot-one</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[聊聊编程里的“魔法棒”：取余运算（Modulo）]]></title>    <link>https://juejin.cn/post/7605051886434910271</link>    <guid>https://juejin.cn/post/7605051886434910271</guid>    <pubDate>2026-02-11T05:35:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605051886434910271" data-draft-id="7605131777175060543" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="聊聊编程里的“魔法棒”：取余运算（Modulo）"/> <meta itemprop="keywords" content="面试"/> <meta itemprop="datePublished" content="2026-02-11T05:35:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="换个号退隐江湖i"/> <meta itemprop="url" content="https://juejin.cn/user/4318537403872727"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            聊聊编程里的“魔法棒”：取余运算（Modulo）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4318537403872727/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    换个号退隐江湖i
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-11T05:35:05.000Z" title="Wed Feb 11 2026 05:35:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>💡 <strong>写在前面</strong>：
最近面试被问到一个倒计时相关问题，又一次用到了取余（Modulo）。说实话，刚入行那会儿，总觉得这玩意儿不就是小学数学里的<code>求余数</code>
吗？除了面试题里用来判断奇偶数，平时好像也没啥大用。</p>
<p>但随着代码写得越来越多，逐渐发现 <code>%</code> 符号背后其实隐藏着一种处理数据的<strong>思维模型</strong>——它能把无限延伸的线性世界，折叠成有限可控的
<strong>周期世界</strong>。今天想和大家分享一下我对取余的重新思考，看看它是怎么帮我们优雅地解决那些头疼的边界问题。</p>
</blockquote>
<h2 data-id="heading-0">重新认识 <code>%</code></h2>
<p>取余的本质，是将任意数值强行<code>限定</code>在一个固定的循环范围内。无论数字跑多远，<code>% N</code> 都能让它回归到 <code>0</code> 至 <code>N-1</code> 的闭环中。</p>
<p>在教科书里，取余的公式是 <code>a % n = r</code></p>
<ul>
<li><code>a</code>：被除数</li>
<li><code>n</code>：除数</li>
<li><code>r</code>：余数</li>
</ul>
<p>但在代码逻辑里，我更愿意把它理解为两个超级好用的思维模型：</p>
<h3 data-id="heading-1">🔄 循环</h3>
<p>想象一下家里的挂钟。不管时间怎么流逝，时针转了一圈又一圈，它永远只会停在 <code>1</code> 到 <code>12</code> 之间。取余就是这个<strong>表盘</strong>
，它能让无限增长的数字，乖乖地在一个固定的"圈"里打转。</p>
<h3 data-id="heading-2">✂️ 限制</h3>
<p>无论你给我的数字有多大，<code>% n</code> 就像一把剪刀，强行把多出来的部分剪掉，只保留 <code>0</code> 到 <code>n-1</code> 这一小段。</p>
<p>就可以理解为：</p>
<ul>
<li><code>a</code>：被除数（任意数值）</li>
<li><code>n</code>：除数（限定的范围大小，也就是"表盘"的大小）</li>
<li><code>r</code>：余数（结果永远在 <code>0</code> 到 <code>n-1</code> 之间）</li>
</ul>
<h2 data-id="heading-3">特点</h2>
<h3 data-id="heading-4">构建"周期闭环"</h3>
<p>说白了就是让数字一直在一个圈里转，永远跑不出去。比如轮播图或红绿灯，写 <code>if (index &gt;= length)</code> 来防止数组越界，写多了特别烦。</p>
<p>有了取余，这事儿就简单了：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 不管 index 涨到几万，结果永远锁死在 0 到 length-1 之间</span>
<span class="hljs-keyword">const</span> safeIndex = index % list.<span class="hljs-property">length</span>;
</code></pre>
<h3 data-id="heading-5">降维与坐标映射</h3>
<p>这个主要解决"一维变二维"的问题。比如为了省流量，后端扔过来一个长长的一维数组，你需要在界面上画个九宫格。</p>
<p>别傻乎乎地去搞双层循环，直接用数学搞定。假设一行有 <code>col</code> 列：</p>
<ul>
<li><strong>找列号（X轴）</strong>：看它在当前行走了几步 -&gt; <strong>取余</strong> (<code>% col</code>)</li>
<li><strong>找行号（Y轴）</strong>：看它已经填满了几行 -&gt; <strong>整除</strong> (<code>Math.floor(i / col)</code>)</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 假设数组索引 i=7，一行3个 (col=3)</span>
<span class="hljs-keyword">const</span> x = <span class="hljs-number">7</span> % <span class="hljs-number">3</span>;                <span class="hljs-comment">// 1 （第2列）</span>
<span class="hljs-keyword">const</span> y = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-number">7</span> / <span class="hljs-number">3</span>);    <span class="hljs-comment">// 2 （第3行）</span>

<span class="hljs-comment">// 坐标就是 (1, 2)</span>
</code></pre>
<h3 data-id="heading-6">均匀离散与分流</h3>
<p>一大堆随机数据（比如 1000 万个用户 ID），把它们公平地分给 3 台服务器，怎么分最匀称？</p>
<p>别搞什么复杂的随机算法，直接按 ID 取余。这不仅分得匀，还能保证同一个用户每次都能分到同一台机器上（这在分布式里叫 Hash 一致性）。</p>
<ul>
<li><strong>数字 ID</strong>：直接取余。</li>
<li><strong>字符串 ID</strong>：先算 Hash 值（转成数字），再取余。</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 简单又高效的负载均衡</span>
<span class="hljs-keyword">const</span> targetServer = servers[userId % <span class="hljs-number">3</span>];

<span class="hljs-comment">// 如果是字符串 ID，就先转成数字（Hash）</span>
<span class="hljs-comment">// const hash = stringToNumber(userId); </span>
<span class="hljs-comment">// const targetServer = servers[hash % 3];</span>
</code></pre>
<h3 data-id="heading-7">声明式逻辑</h3>
<p>代码是写给人看的。<code>if-else</code> 是告诉机器"怎么做流程控制"，而 <code>%</code> 是告诉人"这里是个循环"。</p>
<p>用 <code>%</code> 最大的好处就是——你再也不会把 <code>&gt;</code> 误写成 <code>&gt;=</code> 了。那种差 1 的 Bug（Off-by-one error），写过代码的都懂有多坑。</p>
<h3 data-id="heading-8">倍数与规律捕捉</h3>
<p>想每隔 10 行打个日志？或者给表格弄个"斑马纹"（奇偶变色）？</p>
<p>这种"每隔 N 次搞点事情"的逻辑，用取余是最直观的。它就像个节拍器，到了那个点就会响。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 经典的斑马纹逻辑</span>
<span class="hljs-keyword">const</span> color = index % <span class="hljs-number">2</span> === <span class="hljs-number">0</span> ? <span class="hljs-string">'white'</span> : <span class="hljs-string">'gray'</span>;
</code></pre>
<h2 data-id="heading-9">常见的面试题（由简到难）</h2>
<h3 data-id="heading-10">1. 秒转时分秒（倒计时）</h3>
<p><strong>问</strong>：给你一个总秒数 <code>3661</code>，怎么在页面上显示 <code>01:01:01</code>？</p>
<p><strong>答</strong>：这是最基础的"进制转换"题。</p>
<ul>
<li><strong>低位（秒）</strong>：总秒数对 60 取余 -&gt; 剩下的零头就是秒。</li>
<li><strong>中位（分）</strong>：总秒数先除以 60 得到总分钟数，再对 60 取余 -&gt; 剩下的零头就是分。</li>
<li><strong>高位（时）</strong>：总分钟数除以 60 -&gt; 剩下的就是时。</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> totalSeconds = <span class="hljs-number">3661</span>;

<span class="hljs-keyword">const</span> seconds = totalSeconds % <span class="hljs-number">60</span>;            <span class="hljs-comment">// 1</span>
<span class="hljs-keyword">const</span> minutes = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(totalSeconds / <span class="hljs-number">60</span>) % <span class="hljs-number">60</span>; <span class="hljs-comment">// 61 % 60 = 1</span>
<span class="hljs-keyword">const</span> hours = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(totalSeconds / <span class="hljs-number">3600</span>);      <span class="hljs-comment">// 1</span>

<span class="hljs-keyword">const</span> <span class="hljs-title function_">format</span> = time =&gt; time.<span class="hljs-title function_">toString</span>().<span class="hljs-title function_">padStart</span>(<span class="hljs-number">2</span>, <span class="hljs-string">'0'</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${format(hours)}</span>:<span class="hljs-subst">${format(minutes)}</span>:<span class="hljs-subst">${format(seconds)}</span>`</span>); <span class="hljs-comment">// 01:01:01</span>
</code></pre>
<h3 data-id="heading-11">2. 判断质数（Prime Number）</h3>
<p><strong>问</strong>：怎么判断一个数 <code>n</code> 是不是质数？</p>
<p><strong>答</strong>：质数就是只能被 1 和它自己整除的数。</p>
<p>所以，拿 2 到 n-1 之间的所有数去试着除它。只要有一个能被整除（<code>n % i === 0</code>），它就不是质数。</p>
<p><strong>优化点</strong>：其实只需要试到 <code>Math.sqrt(n)</code> 就够了，后面都是重复的。</p>
<blockquote>
<p><strong>为什么？</strong> 因子都是成对出现的。比如 <code>36</code>：</p>
<ul>
<li><code>2 × 18</code></li>
<li><code>3 × 12</code></li>
<li><code>4 × 9</code></li>
<li><code>6 × 6</code> (根号 n)</li>
<li><code>9 × 4</code> (重复了！)</li>
</ul>
<p>只要在 <code>6</code> (根号 n) 之前没找到因子，后面也绝不会有（除非是它自己）。同理 <code>100</code> 的根号是 <code>10</code>，你只要试到 <code>10</code>
就行了，不用傻乎乎试到 <code>99</code>。</p>
</blockquote>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">isPrime</span>(<span class="hljs-params">n</span>) {
  <span class="hljs-keyword">if</span> (n &lt;= <span class="hljs-number">1</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">if</span> (n === <span class="hljs-number">2</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;      <span class="hljs-comment">// 2 是质数</span>
  <span class="hljs-keyword">if</span> (n % <span class="hljs-number">2</span> === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>; <span class="hljs-comment">// 偶数直接排除</span>

  <span class="hljs-comment">// 只需要试除奇数，步长为 2</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">3</span>; i &lt;= <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sqrt</span>(n); i += <span class="hljs-number">2</span>) {
    <span class="hljs-keyword">if</span> (n % i === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }
  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}
</code></pre>
<h3 data-id="heading-12">3. 判断回文数（不转字符串）</h3>
<p><strong>问</strong>：给你个数字 <code>12321</code>，怎么判断它是回文？不许转成 String。</p>
<p><strong>答</strong>：这题考的是数字拆解的基本功。</p>
<p>你需要理解 <code>%</code> 和 <code>/</code> 在十进制里的<strong>黄金搭档</strong>关系：</p>
<ul>
<li><b><code>% 10</code> 是"拿"</b>：拿到个位数（剥洋葱的第一层）。</li>
<li><b><code>/ 10</code> 是"扔"</b>：扔掉个位数（把洋葱缩小一圈）。</li>
</ul>
<p><strong>一边拆，一边装</strong>：
把 <code>x</code> 的屁股（最后一位）拆下来，装到 <code>reversed</code> 的头上。如果装完发现 <code>reversed === x</code>，那就是回文。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">let</span> x = <span class="hljs-number">12321</span>, reversed = <span class="hljs-number">0</span>;
<span class="hljs-comment">// 假设 x=123</span>
<span class="hljs-comment">// 第一轮：123 % 10 = 3 (拿3), 123 / 10 = 12 (剩12)</span>
<span class="hljs-comment">// 第二轮：12 % 10 = 2 (拿2), 12 / 10 = 1 (剩1)</span>
<span class="hljs-comment">// 第三轮：1 % 10 = 1 (拿1), 1 / 10 = 0 (剩0) -&gt; 结束</span>
<span class="hljs-keyword">while</span> (x &gt; <span class="hljs-number">0</span>) {
  reversed = reversed * <span class="hljs-number">10</span> + x % <span class="hljs-number">10</span>; <span class="hljs-comment">// 拼到新数末尾</span>
  x = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(x / <span class="hljs-number">10</span>);            <span class="hljs-comment">// 原数去掉末尾</span>
}
</code></pre>
<h3 data-id="heading-13">4. 负数取余的坑（JS vs 其他语言）</h3>
<p><strong>问</strong>：<code>(-1) % 5</code> 在 JS 里等于多少？在 Python 里呢？</p>
<p><strong>答</strong>：这题特容易踩坑。</p>
<ul>
<li>在 JS（C/Java）里，结果是 <code>-1</code>。因为它们看重"商"向 0 取整。</li>
<li>在 Python 里，结果是 <code>4</code>。因为 Python 看重"商"向下取整。</li>
</ul>
<p><strong>实战解法</strong>：</p>
<p>如果在 JS 做轮播图（点击上一张），算出 <code>-1</code> 程序就崩了。</p>
<p>记住这个<strong>万能公式</strong>，不管正负都能转正：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> index = (current + step + length) % length;
</code></pre>
<p><strong>为什么加 <code>length</code>？</strong></p>
<p>因为 <code>%</code> 运算在 JS 里会保留符号。假设当前是第 0 张图（current=0），你要退一张（step=-1），总共5张图（length=5）。</p>
<ul>
<li><strong>不加 length</strong>：<code>(0 + (-1)) % 5 = -1</code> ❌（不仅不对，还越界了）</li>
<li><strong>加 length</strong>：<code>(0 + (-1) + 5) % 5 = 4</code> ✅（这就对了，回到了最后一个）</li>
<li><strong>正向移动</strong>：<code>(0 + 1 + 5) % 5 = 1</code> ✅（加一圈不影响正数结果，没副作用）</li>
</ul>
<p><strong>场景举例</strong>：</p>
<ol>
<li><b>轮播图"上一张"</b>：<code>current=0, step=-1</code>。<code>(0 - 1 + 5) % 5 = 4</code> -&gt; 完美跳到最后一张。</li>
<li><strong>贪吃蛇穿墙</strong>：蛇头钻出左边界 <code>x=-1</code>。<code>(-1 + width) % width</code> -&gt; 瞬间从右边出来。</li>
<li><strong>日期计算</strong>：今天是周三 <code>3</code>，问 5 天前是周几？<code>(3 - 5 + 7) % 7 = 5</code> -&gt; 周五。不用脑补倒着数数了。</li>
</ol>
<h3 data-id="heading-14">5. 不用临时变量交换两个数</h3>
<p><strong>问</strong>：给你两个整数 a 和 b，不许用 <code>temp</code> 变量，怎么交换它们？</p>
<p><strong>答</strong>：除了烂大街的位运算（异或），取余其实也能干这事儿（虽然不如位运算快，但思路很骚）。</p>
<p>思路是把两个数"压缩"到一个大数里，再拆出来。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">let</span> a = <span class="hljs-number">123</span>, b = <span class="hljs-number">456</span>;
<span class="hljs-comment">// 假设 n 足够大，比 a 和 b 都大</span>
<span class="hljs-keyword">const</span> n = <span class="hljs-number">1000</span>;

<span class="hljs-comment">// 压缩：把 b 藏在高位，a 藏在低位</span>
a = a + b * n; <span class="hljs-comment">// 123 + 456 * 1000 = 456123</span>

b = a % n;        <span class="hljs-comment">// 取出低位，也就是原来的 a </span>
a = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(a / n); <span class="hljs-comment">// 取出高位，也就是原来的 b</span>

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(a, b); <span class="hljs-comment">// 456, 123</span>
</code></pre>
<h3 data-id="heading-15">6. 约瑟夫环问题</h3>
<p><strong>场景描述</strong>：
有 <code>n</code> 个人围成一圈（编号 0 到 n-1）。从第 0 号开始报数，报到 <code>m</code> 的人出局。下一位继续从 1 开始报数，直到只剩最后一个人。问最后这个人的原始编号是多少？</p>
<p><strong>例子</strong>：</p>
<ul>
<li><strong>n = 5</strong>（5个人：0, 1, 2, 3, 4）</li>
<li><strong>m = 3</strong>（报到3出局）</li>
<li><strong>出局过程</strong>：2号出局 -&gt; 0号出局 -&gt; 4号出局 -&gt; 1号出局 -&gt; <strong>3号幸存</strong>。</li>
<li><strong>幸存过程</strong>：0, 1, 2, 3, 4 -&gt; 0, 1, 3, 4 -&gt; 1, 3, 4 -&gt; 1, 3 -&gt; 3</li>
</ul>
<p>这道题有点复杂，先上答案，后面咱们掰开揉碎了讲</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number</span>} n 总人数
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number</span>} m 报数号码（报到几出局）
 * <span class="hljs-doctag">@return</span> {<span class="hljs-type">number</span>} 最后幸存者的编号
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">lastRemaining</span>(<span class="hljs-params">n, m</span>) {
  <span class="hljs-keyword">let</span> pos = <span class="hljs-number">0</span>; <span class="hljs-comment">// 时光倒流终点：最后只剩1个人时，幸存者索引是0</span>

  <span class="hljs-comment">// 开始倒推：从2个人 -&gt; 3个人 -&gt; ... -&gt; n个人</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">2</span>; i &lt;= n; i++) {
    pos = (pos + m) % i; <span class="hljs-comment">// 每一轮人数变多(i)，位置都要往后挪 m 位</span>
  }
  <span class="hljs-keyword">return</span> pos;
}
</code></pre>
<p><strong>解法思路：时光倒流（坐标偏移）</strong></p>
<p>这个问题如果顺着想（模拟淘汰），数组删元素很麻烦。但如果我们<strong>倒着想</strong>，利用<strong>坐标偏移</strong>规律，就非常简单。</p>
<p><strong>1. 正向（淘汰 = 坐标前移）：</strong>
想象一下，<code>m=3</code>，第 3 个人（索引 2）被淘汰后。</p>
<ul>
<li>按照规则，<strong>下一轮报数从被淘汰者的下一个人（索引 3）开始</strong>。</li>
<li>这就意味着，<strong>索引 3</strong> 变成了新一轮的 <strong>排头兵（新的索引 0）</strong>。</li>
<li>相当于所有人整体<strong>往前挪了 3 位</strong>（注意：不仅仅是填补空缺，而是连起点都变了）。</li>
<li>即：<code>旧索引 - 3 = 新索引</code>。</li>
</ul>
<p><strong>2. 逆向（恢复 = 坐标后移）：</strong>
我们要找幸存者最初在哪，可以从<strong>终局</strong>（只剩他 1 人，索引 0）开始，一步步把时光倒流，恢复之前被淘汰的人。</p>
<ul>
<li><strong>恢复就是淘汰的逆操作</strong>。</li>
<li>既然淘汰是"往前挪 3 位"，那恢复就是<b>"往后挪 3 位"</b>（<code>+3</code>）。</li>
<li>公式呼之欲出：<code>新索引 + 3 = 旧索引</code>。</li>
<li><strong>核心补丁</strong>：因为是圆圈，往后挪超出了队尾就要绕回队头，所以必须 <code>% 上轮人数</code>。</li>
</ul>
<p><strong>推导过程演示（N=5, M=3）</strong>：</p>
<p>我们只关注<strong>最后那个幸存者</strong>（假设他叫"天选之子"），他在每一轮的索引是多少？</p>
<blockquote>
<p><strong>表头说明</strong>：</p>
<ul>
<li><strong>n</strong>：当前轮剩余人数。</li>
<li><strong>倒推公式</strong>：<code>(当前索引 + m) % 上轮人数</code>。通过这个公式，我们可以算出幸存者在上一轮（人数更多时）的位置。</li>
</ul>
</blockquote>















































<table><thead><tr><th align="left">轮次</th><th align="left">剩余人数</th><th align="left">场景描述</th><th align="left">计算过程</th><th align="left">幸存者索引</th></tr></thead><tbody><tr><td align="left"><strong>终局</strong></td><td align="left">1</td><td align="left">只剩天选之子</td><td align="left">0 (固定)</td><td align="left"><strong>0</strong></td></tr><tr><td align="left"><strong>倒数第2轮</strong></td><td align="left">2</td><td align="left">恢复成2人</td><td align="left"><code>(0 + 3) % 2</code></td><td align="left"><strong>1</strong></td></tr><tr><td align="left"><strong>倒数第3轮</strong></td><td align="left">3</td><td align="left">恢复成3人</td><td align="left"><code>(1 + 3) % 3</code></td><td align="left"><strong>1</strong></td></tr><tr><td align="left"><strong>倒数第4轮</strong></td><td align="left">4</td><td align="left">恢复成4人</td><td align="left"><code>(1 + 3) % 4</code></td><td align="left"><strong>0</strong></td></tr><tr><td align="left"><strong>开局</strong></td><td align="left">5</td><td align="left">恢复成5人</td><td align="left"><code>(0 + 3) % 5</code></td><td align="left"><strong>3</strong></td></tr></tbody></table>
<p><strong>结论</strong>：一开始索引为 <strong>3</strong> 的那个人，就是天选之子。</p>
<p><strong>💡 核心疑点 Q&amp;A</strong>：</p>
<ol>
<li>
<p><strong>为什么要倒推？</strong></p>
<ul>
<li><strong>正推太麻烦</strong>：如果正向模拟，你需要不断地删除数组元素、处理索引越界，数组长度一直在变，计算极其复杂。</li>
<li><strong>终局是已知的</strong>：无论过程多复杂，<strong>最后一定只剩 1 个人</strong>，且那个人的索引一定是 <code>0</code>。从确定的结果出发找源头，比从源头去猜结果要容易得多。</li>
</ul>
</li>
<li>
<p><strong>为什么要恢复上一轮的状态？</strong></p>
<ul>
<li>这是一个<strong>递归/递推</strong>的问题。<code>5个人</code> 的游戏淘汰一个，就变成了 <code>4个人</code> 的游戏。</li>
<li>如果我们知道 <code>4个人</code> 里的幸存者是谁，只要把这个幸存者在 <code>4个人</code> 局里的位置，<strong>映射（还原）</strong> 回 <code>5个人</code> 局里的位置，问题就解决了。</li>
<li>所谓"恢复"，其实就是<strong>坐标变换</strong>。</li>
</ul>
</li>
<li>
<p><strong>为什么要 % i（当前人数），而不是 % n（总人数）？</strong></p>
<ul>
<li>这是很多人的盲点！</li>
<li>每一轮淘汰一个人，<strong>圈子的大小都在变</strong>。</li>
<li>倒数第 2 轮时，圈子只有 2 个人，所以是 <code>% 2</code>；倒数第 3 轮时，圈子有 3 个人，所以是 <code>% 3</code>。</li>
<li>我们是在<strong>那一轮的圈子</strong>里进行坐标恢复，当然要模<strong>那一轮的人数</strong>。</li>
</ul>
</li>
<li>
<p><strong>公式 <code>(当前索引 + m) % 上轮人数</code> 怎么来的？</strong></p>
<ul>
<li>这就是我们上面提到的<strong>坐标偏移</strong>：</li>
<li><strong>+ m</strong>：代表时光倒流，恢复被删掉的 <code>m</code> 个位置。</li>
<li><strong>% 上轮人数</strong>：代表在恢复后的圈子里转圈圈，防止索引越界。</li>
</ul>
</li>
</ol>
<p><strong>💡 小贴士：数学公式版（递归实现）</strong></p>
<p>如果你在算法书上看到这个公式，别慌，它和我们的代码是一回事：</p>
<p><code>f(n, m) = (f(n-1, m) + m) % n</code></p>
<ul>
<li><code>f(n, m)</code>：n 个人时幸存者的索引。</li>
<li><code>f(n-1, m)</code>：n-1 个人时幸存者的索引（也就是我们代码里的 <code>pos</code>）。</li>
<li>代码里的 <code>for</code> 循环，就是把这个数学递归公式变成了<strong>从 2 到 n 的递推</strong>。</li>
</ul>
<p><strong>递归版代码（仅供参考）</strong>：</p>
<p>虽然代码看着短，但如果 n 很大，会爆栈哦。还是推荐用上面的 <code>for</code> 循环（迭代版）。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">lastRemainingRecursive</span>(<span class="hljs-params">n, m</span>) {
  <span class="hljs-keyword">if</span> (n === <span class="hljs-number">1</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>; <span class="hljs-comment">// 剩下1个人，索引肯定是0</span>
  <span class="hljs-keyword">return</span> (<span class="hljs-title function_">lastRemainingRecursive</span>(n - <span class="hljs-number">1</span>, m) + m) % n;
}
</code></pre>
<p><strong>动态规划版（标准 DP）</strong>：</p>
<p>有了推导公式，自然就能写出 DP。</p>
<p><code>dp[i]</code> 表示 <code>i</code> 个人时的幸存者索引。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">lastRemainingDP</span>(<span class="hljs-params">n, m</span>) {
  <span class="hljs-keyword">let</span> dp = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(n + <span class="hljs-number">1</span>);
  dp[<span class="hljs-number">1</span>] = <span class="hljs-number">0</span>; <span class="hljs-comment">// 只有1个人时，索引是0</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">2</span>; i &lt;= n; i++) {
    dp[i] = (dp[i - <span class="hljs-number">1</span>] + m) % i; <span class="hljs-comment">// 状态转移方程</span>
  }
  <span class="hljs-keyword">return</span> dp[n];
}
</code></pre>
<p><em>注：我们最开始写的那个 <code>let pos</code> 的版本，其实就是这个 DP 版本的<strong>空间优化版</strong>（滚动数组思想），把 <code>dp</code>
数组压缩成了一个变量。</em></p>
<h2 data-id="heading-16">总结</h2>
<p>说实话，取余（Modulo）这个概念，以前我也觉得它只是个数学符号，顶多用来算算奇偶数。但当你真的深入去理解它，你会发现它其实是一种<code>化直为曲</code>
的思维方式。</p>
<p>无论是处理时间、轮播图，还是解决像约瑟夫环这样复杂的算法题，取余的核心永远只有两点：<strong>控制边界</strong>和<strong>制造循环</strong>。</p>
<p>希望这篇文章能帮你打破对 <code>%</code> 的固有印象。下次在代码里遇到"溢出"、"循环"或者"映射"的问题时，试着停下来想一想：这里是不是可以用取余来简化一下？</p>
<p>多思考，多动手，编程不仅是写代码，更是对数据规律的优雅掌控。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React - useState 进阶]]></title>    <link>https://juejin.cn/post/7605106957133512738</link>    <guid>https://juejin.cn/post/7605106957133512738</guid>    <pubDate>2026-02-11T04:41:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605106957133512738" data-draft-id="7605105527257513984" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React - useState 进阶"/> <meta itemprop="keywords" content="前端,React.js"/> <meta itemprop="datePublished" content="2026-02-11T04:41:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="web_bee"/> <meta itemprop="url" content="https://juejin.cn/user/428665740231"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React - useState 进阶
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/428665740231/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    web_bee
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-11T04:41:29.000Z" title="Wed Feb 11 2026 04:41:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>语法：</p>
<pre><code class="hljs language-scss" lang="scss">const <span class="hljs-selector-attr">[state, setState]</span> = <span class="hljs-built_in">useState</span>(initialState)
</code></pre>
<p>参数：</p>
<ul>
<li>
<p>setState 它有两种写法</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">setState</span>(value)
​
<span class="hljs-built_in">setState</span>(pre =&gt; pre + <span class="hljs-number">1</span>)
</code></pre>
</li>
</ul>
<p>下面来详细了解一下它为什么会有两种写法。</p>
<h2 data-id="heading-0">setState(value)</h2>
<p>先看一个例子：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">App</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>)
  
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleClick</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-title function_">setCount</span>(count + <span class="hljs-number">1</span>)
    <span class="hljs-title function_">setCount</span>(count + <span class="hljs-number">1</span>)
    <span class="hljs-title function_">setCount</span>(count + <span class="hljs-number">1</span>)
  }
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>{count}<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{handleClick}</span>&gt;</span>点击<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>  
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
}
</code></pre>
<p>当点击按钮时，最终页面上展示的会是：1</p>
<p><strong>为什么呢？</strong></p>
<ol start="0">
<li>
<p>state的闭包陷阱（Stale Closure）</p>
<p>handleClick 函数作用域内的count值，永远是当前渲染时的值，初始值 0</p>
</li>
<li>
<p>异步和批处理机制（Async &amp; Batching）：</p>
<p>React 会将 <code>同一个事件处理器</code> 中的所有 <code>setCount</code> 调用<code>批量处理</code>，而不是立即更新</p>
</li>
<li>
<p>计算过程：</p>
<ul>
<li>当前渲染周期中 <code>count = 0</code></li>
<li>第一次 <code>setCount(count + 1)</code>：计划将 <code>count</code> 更新为 <code>1 + 0 = 1</code></li>
<li>第二次 <code>setCount(count + 1)</code>：此时的 <code>count</code> 仍然是 1（不是更新后的 2），所以还是计划更新为 <code>1 + 0 = 1</code></li>
<li>第三次同理，仍然是计划更新为 1</li>
<li>React 合并所有更新，最后只执行一次更新：<code>setCount(count + 1)</code></li>
</ul>
</li>
</ol>
<p>因此引入了 函数式写法 <code>setState(pre =&gt; pre + 1)</code></p>
<h2 data-id="heading-1">setState(pre =&gt; pre + 1)</h2>
<p>还是上面的例子：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">App</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>)
  
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleClick</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-title function_">setCount</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> prev + <span class="hljs-number">1</span>)
    <span class="hljs-title function_">setCount</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> prev + <span class="hljs-number">1</span>)
    <span class="hljs-title function_">setCount</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> prev + <span class="hljs-number">1</span>)
  }
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>{count}<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{handleClick}</span>&gt;</span>点击<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>  
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
}
</code></pre>
<p>此时，当点击按钮时，最终页面上展示的会是：3</p>
<p><strong>为什么呢？我们来看一下执行过程</strong></p>
<ul>
<li>点击</li>
<li>出发函数 handleClick</li>
<li>3个更新函数依次进入队列：setCount(prev =&gt; prev + 1) 入队</li>
<li>fiber架构整个渲染过程，render阶段执行计算</li>
<li>开始处理 更新队列 （初始值 state = 0）</li>
<li>执行函数一：0 + 1 = 1</li>
<li>执行函数二：此时pre = 1，故 1 + 1 = 2</li>
<li>执行函数三：此时pre = 2，故 2 + 1 = 3</li>
<li>最终 count = 3</li>
<li>Commit 阶段：<code>count = 3</code> 被用于渲染，更新到DOM</li>
</ul>
<p><strong>函数式更新的优势：</strong></p>
<ul>
<li>不受闭包影响，它可以保证数据更新的准确性</li>
<li>代码更直观</li>
</ul>
<h2 data-id="heading-2">如何选择：</h2>
<ul>
<li><code>新state</code> 依赖于 <code>旧state</code>，那么我们应该用函数式更新</li>
<li>如果没有依赖关系，我们则使用 直接传值的方式；</li>
</ul>
<h2 data-id="heading-3">批处理</h2>
<p>批处理指的是 React 会将多个状态更新<strong>合并</strong>到一次重新渲染中，而不是每次 <code>setState</code> 都立即触发重新渲染。</p>
<h3 data-id="heading-4">原则</h3>
<ul>
<li>
<p>事件处理器中的自动批处理</p>
<blockquote>
<p>在 <strong>React 事件处理器</strong>（如 onClick、onChange）中，所有的 <code>setState</code> 调用都会被自动批处理。</p>
<p>理解：<code>同一个事件处理器中</code> 的 setState 会被批处理，而不是单个单个执行</p>
<p><code>同一个事件处理器</code></p>
</blockquote>
</li>
<li>
<p>生命周期和 useEffect 中的批处理</p>
<p>在生命周期方法和 <code>useEffect</code> 中，更新也会被批处理。</p>
</li>
<li>
<p>React 18 的增强批处理</p>
<p><strong>React 18 之前</strong>：只有在 React 事件处理器中才有自动批处理。</p>
<p><strong>React 18 及以后</strong>：批处理扩展到 <strong>所有场景</strong>，包括：</p>
<ul>
<li>Promise</li>
<li>setTimeout</li>
<li>原生事件处理程序</li>
<li>其他异步代码</li>
</ul>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[9.3k星Skill Seekers：一键把文档变成Claude技能，文档党狂喜]]></title>    <link>https://juejin.cn/post/7605055844255170598</link>    <guid>https://juejin.cn/post/7605055844255170598</guid>    <pubDate>2026-02-11T04:08:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605055844255170598" data-draft-id="7605135197165895730" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="9.3k星Skill Seekers：一键把文档变成Claude技能，文档党狂喜"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2026-02-11T04:08:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="老金带你玩AI"/> <meta itemprop="url" content="https://juejin.cn/user/2561191397043127"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            9.3k星Skill Seekers：一键把文档变成Claude技能，文档党狂喜
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2561191397043127/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    老金带你玩AI
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-11T04:08:13.000Z" title="Wed Feb 11 2026 04:08:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在GitHub刷到一个Python项目，叫 Skill Seekers。
9300多颗星，MIT开源。</p>
<p>核心功能：把文档网站、GitHub仓库、PDF一键转成Claude AI技能。</p>
<p>老金我第一反应：这不就是文档党的救星吗？</p>
<p>先说个背景。
Claude Code有个 技能系统，简单说就是你可以给Claude装"外挂"。
装了技能的Claude，就像一个背了参考书的助手——你说"帮我写个Next.js页面"，它不用瞎猜，直接按官方文档的最佳实践来。</p>
<p>但问题是：这个"外挂"得你自己做。
官方文档几十页，要自己提炼、格式化、写成一个叫SKILL.md的配置文件。
手动整理一个技能，老金我至少要2-3小时。</p>
<p>现在Skill Seekers能自动干这事儿了。</p>
<h2 data-id="heading-0">先搞懂：Claude技能到底是啥</h2>
<p>打个比方。</p>
<p>Claude就像一个聪明但啥都不记的实习生。
你每次跟它说"用Tailwind写样式"，它可能用v3的写法，因为它不知道你项目用的是v4。</p>
<p>"技能"就是你给它准备的一份速查手册。
装上之后，它就知道：哦，Tailwind v4要用@theme不用@apply了。</p>
<p>技术上说，技能就是一个文本文件（SKILL.md），放在你项目的 .claude/skills/ 文件夹里。
Claude每次干活前会自动读取这些文件，相当于"考前复习"。</p>
<p>Skill Seekers干的事情就是：帮你自动生成这个SKILL.md文件。</p>
<h2 data-id="heading-1">三种输入源全覆盖</h2>
<p>Skill Seekers支持三种输入：</p>
<p>第一种：文档网站
比如你想让Claude学会用某个框架。
直接丢官方文档URL或者md文件进去，它自动爬取、提炼、生成技能文件。</p>
<p>第二种：GitHub仓库
开源项目的README、docs文件夹、代码注释。
全部自动解析，变成结构化的Claude技能。</p>
<p>第三种：PDF文件
技术白皮书、API文档、产品手册。
丢个PDF进去，输出可用的技能配置。</p>
<p>老金我觉得第二种最实用。
很多开源项目文档散落在各处，手动整理要半天。
现在一键搞定。</p>
<h2 data-id="heading-2">自动冲突检测是亮点</h2>
<p>用过Claude Code技能系统的都知道一个坑：技能冲突。</p>
<p>比如你装了两个技能，都会在你说"写代码"的时候被触发。
Claude就懵了，不知道该听哪个。</p>
<p>Skill Seekers内置了 冲突检测。
生成技能前，它会扫描你现有的技能库。
发现功能重叠，直接告警。</p>
<p>这个功能省了老金我不少排查时间。
之前技能不生效，查半天才发现是冲突了。</p>
<h2 data-id="heading-3">手把手：安装Skill Seekers</h2>
<p>两种方式，选一个就行。</p>
<h3 data-id="heading-4">方式一：让Claude Code帮你装（推荐小白用这个）</h3>
<p>打开Claude Code，直接说一句：</p>
<pre><code class="hljs language-arduino" lang="arduino">帮我安装 https:<span class="hljs-comment">//github.com/yusufkaraaslan/Skill_Seekers ， 我是 win11 系统 &lt;- 自行修改OS</span>
</code></pre>
<p>Claude Code会自动执行 pip install skill-seekers，装好后告诉你结果。
中间遇到PATH问题、依赖冲突，它都帮你处理。
你只管等结果就行。</p>
<h3 data-id="heading-5">方式二：自己手动装（适合喜欢掌控一切的人）</h3>
<p>需要Python 3.10以上。打开终端输入：</p>
<pre><code class="hljs">pip install skill-seekers
</code></pre>
<p>看到 Successfully installed skill-seekers-x.x.x 就是装好了。</p>
<p>如果提示pip不是命令，试试 python -m pip install skill-seekers。
如果装完后 skill-seekers 命令找不到，大概率是Python Scripts目录没在系统PATH里，用 python -m skill_seekers 代替就行。</p>
<h2 data-id="heading-6">装好了，怎么用它生成技能</h2>
<p>Skill Seekers装好之后，就可以用它把文档转成Claude技能了。
同样两种方式。</p>
<h3 data-id="heading-7">方式一：让Claude Code帮你生成（推荐）</h3>
<p>直接跟Claude Code说：</p>
<pre><code class="hljs language-arduino" lang="arduino">用skill-seekers把这个文档生成Claude技能：https:<span class="hljs-comment">//tailwindcss.com/docs</span>
</code></pre>
<p>或者GitHub仓库：</p>
<pre><code class="hljs language-arduino" lang="arduino">用skill-seekers把这个项目的文档转成技能：https:<span class="hljs-comment">//github.com/shadcn-ui/ui</span>
</code></pre>
<p>Claude Code会调用Skill Seekers，生成SKILL.md，放到 .claude/skills/ 目录里。
全程一句话搞定。</p>
<h3 data-id="heading-8">方式二：命令行操作（适合批量处理）</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 从文档网站生成技能</span>
skill-seekers --url https://tailwindcss.com/docs

<span class="hljs-comment"># 从GitHub仓库生成</span>
skill-seekers --repo shadcn-ui/ui

<span class="hljs-comment"># 从本地PDF生成</span>
skill-seekers --pdf ./api-handbook.pdf
</code></pre>
<p>生成的技能文件，手动复制到项目的 .claude/skills/ 目录下。
找不到这个目录？在项目根目录下创建一个：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">mkdir</span> -p .claude/skills/tailwind-v4
</code></pre>
<p>把生成的SKILL.md丢进去就行。</p>
<p>如果对你有帮助，记得关注一波~</p>
<h2 data-id="heading-9">装好之后怎么用：自然语言触发</h2>
<p>技能装好了，怎么让Claude用起来？</p>
<p>答案是：正常说话就行，技能会自动触发。</p>
<p>Claude Code会根据你说的内容，自动匹配对应的技能。比如你装了Tailwind v4的技能：</p>
<pre><code class="hljs">帮我写一个响应式导航栏，用Tailwind
</code></pre>
<p>Claude看到"Tailwind"，自动加载你的Tailwind技能，按v4的写法来。</p>
<p>再比如你装了Next.js技能：</p>
<pre><code class="hljs language-vbnet" lang="vbnet">写个<span class="hljs-keyword">Next</span>.js的API路由，处理用户登录
</code></pre>
<p>Claude自动按Next.js最新的App Router规范来写，不会给你整出Pages Router的老写法。</p>
<p>关键点：技能的触发是自动的，靠的是SKILL.md里定义的触发词。
Skill Seekers生成的技能文件已经帮你配好了触发词，你直接用自然语言描述需求就行。</p>
<p>如果你想看当前项目装了哪些技能，在Claude Code里说一句：</p>
<pre><code class="hljs">列出当前项目的所有技能
</code></pre>
<p>它会告诉你有哪些技能、各自的触发词是什么。</p>
<h2 data-id="heading-10">实际使用场景</h2>
<p>场景1：学新框架
想让Claude帮你写Next.js代码。
把Next.js官方文档URL丢给Claude Code。
生成的技能包含：API用法、最佳实践、常见坑点。
之后你说"写个Next.js页面"，Claude直接按最新文档来。</p>
<p>场景2：公司内部工具
公司有个内部SDK，文档是PDF。
转成Claude技能后，新人问问题直接问Claude。
比翻文档快10倍。</p>
<p>场景3：参与开源项目
想给某个开源项目提代码，但不熟悉项目规范。
把仓库地址丢给Claude Code，生成项目理解技能。
Claude就能按照项目的代码风格帮你写了。</p>
<h2 data-id="heading-11">和手动写技能对比</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/02730b0057cb4c80b9e70f1ac507c112~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ICB6YeR5bim5L2g546pQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771387694&amp;x-signature=C%2Bf9778XIEsGQrOqPEe5JfJ6LMQ%3D" alt="Image" loading="lazy"/></p>
<p>老金我的建议：先用Skill Seekers生成初版，再手动优化关键部分。
效率能提升5倍以上。</p>
<h2 data-id="heading-12">几个注意点</h2>
<p>1、文档质量决定技能质量
垃圾进垃圾出。
如果原始文档写得乱七八糟，生成的技能也好不到哪去。
选文档质量高的源头。</p>
<p>2、大型文档要分批处理
几百页的PDF，建议拆成章节分别处理。
不然生成的技能文件太大，Claude加载慢，反而影响效率。</p>
<p>3、定期更新技能
框架升级了，技能也要重新生成。
不然Claude用的是过时信息，写出来的代码跑不起来。</p>
<p>4、生成后一定要检查
自动生成的东西不可能100%准确。
花10分钟过一遍，删掉不相关的内容，补充你自己的经验。
这10分钟投入绝对值得。</p>
<h2 data-id="heading-13">老金我的看法</h2>
<p>Skill Seekers解决了一个真实痛点：文档到技能的转换成本。</p>
<p>之前老金我写一个技能，光整理文档就要2-3小时。
现在10分钟搞定初版，再花30分钟优化。
效率提升明显。</p>
<p>9300星不是白给的。
MIT开源，代码质量也不错。
值得一试。</p>
<p>最后提醒：切记！需要审核！大概率需要微调！</p>
<p>GitHub：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fyusufkaraaslan%2FSkill%255C%255C%255C%255C_Seekers" target="_blank" title="https://github.com/yusufkaraaslan/Skill%5C%5C%5C%5C_Seekers" ref="nofollow noopener noreferrer">github.com/yusufkaraas…</a></p>
<p>有问题评论区聊。</p>
<hr/>
<p><strong>往期推荐：</strong></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fmp%2Fappmsgalbum%3F__biz%3DMzI0NzU2MDgyNA%3D%3D%26action%3Dgetalbum%26album_id%3D3704202865347362819%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzI0NzU2MDgyNA==&amp;action=getalbum&amp;album_id=3704202865347362819#wechat_redirect" ref="nofollow noopener noreferrer">AI编程教程列表</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fmp%2Fappmsgalbum%3F__biz%3DMzI0NzU2MDgyNA%3D%3D%26action%3Dgetalbum%26album_id%3D4120385726238392327%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzI0NzU2MDgyNA==&amp;action=getalbum&amp;album_id=4120385726238392327#wechat_redirect" ref="nofollow noopener noreferrer">提示词工工程（Prompt Engineering）</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fmp%2Fappmsgalbum%3F__biz%3DMzI0NzU2MDgyNA%3D%3D%26action%3Dgetalbum%26album_id%3D3171759118513111043%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzI0NzU2MDgyNA==&amp;action=getalbum&amp;album_id=3171759118513111043#wechat_redirect" ref="nofollow noopener noreferrer">LLMOPS(大语言模运维平台)</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fmp%2Fappmsgalbum%3F__biz%3DMzI0NzU2MDgyNA%3D%3D%26action%3Dgetalbum%26album_id%3D3192433076551843848%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzI0NzU2MDgyNA==&amp;action=getalbum&amp;album_id=3192433076551843848#wechat_redirect" ref="nofollow noopener noreferrer">AI绘画教程列表</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fmp%2Fappmsgalbum%3F__biz%3DMzI0NzU2MDgyNA%3D%3D%26action%3Dgetalbum%26album_id%3D3502843007181520907%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzI0NzU2MDgyNA==&amp;action=getalbum&amp;album_id=3502843007181520907#wechat_redirect" ref="nofollow noopener noreferrer">WX机器人教程列表</a></p>
<hr/>
<p>每次我都想提醒一下，这不是凡尔赛，是希望有想法的人勇敢冲。
我不会代码，我英语也不好，但是我做出来了很多东西，在文末的开源知识库可见。
我真心希望能影响更多的人来尝试新的技巧，迎接新的时代。</p>
<p>谢谢你读我的文章。
如果觉得不错，随手点个赞、在看、转发三连吧🙂
如果想第一时间收到推送，也可以给我个星标⭐～谢谢你看我的文章。</p>
<p>开源知识库地址：
<a href="https://link.juejin.cn?target=https%3A%2F%2Ftffyvtlai4.feishu.cn%2Fwiki%2FOhQ8wqntFihcI1kWVDlcNdpznFf" target="_blank" title="https://tffyvtlai4.feishu.cn/wiki/OhQ8wqntFihcI1kWVDlcNdpznFf" ref="nofollow noopener noreferrer">tffyvtlai4.feishu.cn/wiki/OhQ8wq…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SSL 在 Nginx 环境下的完整配置模板及详细部署指南]]></title>    <link>https://juejin.cn/post/7605164560711008282</link>    <guid>https://juejin.cn/post/7605164560711008282</guid>    <pubDate>2026-02-11T05:35:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605164560711008282" data-draft-id="7605107459066626094" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" SSL 在 Nginx 环境下的完整配置模板及详细部署指南"/> <meta itemprop="keywords" content="HTTPS,HTTP"/> <meta itemprop="datePublished" content="2026-02-11T05:35:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="JoySSLHAN"/> <meta itemprop="url" content="https://juejin.cn/user/1241795356007113"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             SSL 在 Nginx 环境下的完整配置模板及详细部署指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1241795356007113/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    JoySSLHAN
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-11T05:35:31.000Z" title="Wed Feb 11 2026 05:35:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、Nginx 配置模板</h2>
<p>以下是一个完整的 Nginx 配置示例，包含 SSL 证书配置、HSTS 策略和 OCSP Stapling 优化：</p>
<pre><code class="hljs language-ini" lang="ini">nginx
server {
    listen 443 ssl http2<span class="hljs-comment">;</span>
    server_name www.yourdomain.com<span class="hljs-comment">;  # 替换为你的实际域名</span>

    <span class="hljs-comment"># SSL 证书配置</span>
    ssl_certificate /path/to/yourdomain.com.pem<span class="hljs-comment">;  # 证书文件路径（含公钥）</span>
    ssl_certificate_key /path/to/yourdomain.com.key<span class="hljs-comment">;  # 私钥文件路径</span>
    ssl_trusted_certificate /path/to/yourdomain.com.chain.pem<span class="hljs-comment">;  # 证书链文件（如有）</span>

    <span class="hljs-comment"># SSL 协议优化</span>
    ssl_protocols TLSv1.2 TLSv1.3<span class="hljs-comment">;</span>
    ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384'<span class="hljs-comment">;</span>
    ssl_prefer_server_ciphers on<span class="hljs-comment">;</span>

    <span class="hljs-comment"># HSTS 策略</span>
    add_header Strict-Transport-Security "<span class="hljs-attr">max-age</span>=<span class="hljs-number">63072000</span><span class="hljs-comment">; includeSubDomains; preload" always;</span>

    <span class="hljs-comment"># OCSP Stapling 配置</span>
    ssl_stapling on<span class="hljs-comment">;</span>
    ssl_stapling_verify on<span class="hljs-comment">;</span>
    resolver 8.8.8.8 8.8.4.4 <span class="hljs-attr">valid</span>=<span class="hljs-number">300</span>s<span class="hljs-comment">;  # 指定 DNS 解析服务器</span>
    resolver_timeout 5s<span class="hljs-comment">;</span>

    <span class="hljs-comment"># 其他常规配置</span>
    root /var/www/html<span class="hljs-comment">;</span>
    index index.html index.htm<span class="hljs-comment">;</span>

    location / {
        try_files $uri $uri/ =404<span class="hljs-comment">;</span>
    }
}

<span class="hljs-comment"># HTTP 重定向到 HTTPS</span>
server {
    listen 80<span class="hljs-comment">;</span>
    server_name www.yourdomain.com<span class="hljs-comment">;</span>
    return 301 https://$host$request_uri<span class="hljs-comment">;</span>
}
</code></pre>
<h2 data-id="heading-1">二、详细部署步骤</h2>
<h3 data-id="heading-2">1. 获取 JoySSL 证书</h3>
<ol>
<li>
<p><strong>注册 JoySSL 账号</strong>：访问 <strong>[JoySSL 官网]</strong> 完成注册（注册时填写推荐码 <code>230959</code> 可获取免费额度）。</p>
</li>
<li>
<p><strong>选择证书类型</strong>：</p>
<ul>
<li>单域名证书：适用于单个域名（如 <code>www.yourdomain.com</code>）</li>
<li>通配符证书：适用于主域名及所有子域名（如 <code>*.yourdomain.com</code>）</li>
</ul>
</li>
<li>
<p><strong>完成域名验证</strong>：</p>
<ul>
<li><strong>DNS 验证</strong>：在域名 DNS 解析中添加一条 TXT 记录</li>
<li><strong>文件验证</strong>：下载验证文件并上传至网站根目录</li>
</ul>
</li>
<li>
<p><strong>下载证书文件</strong>：验证通过后，下载包含以下文件的压缩包：</p>
<ul>
<li><code>yourdomain.com.pem</code>（证书文件）</li>
<li><code>yourdomain.com.key</code>（私钥文件）</li>
<li><code>yourdomain.com.chain.pem</code>（证书链文件，部分证书可能不包含）</li>
</ul>
</li>
</ol>
<h3 data-id="heading-3">2. 上传证书到服务器</h3>
<pre><code class="hljs language-ruby" lang="ruby">bash
<span class="hljs-comment"># 创建 SSL 证书目录（建议放在 /etc/nginx/ssl/ 下）</span>
sudo mkdir -p /etc/nginx/ssl/

<span class="hljs-comment"># 上传证书文件到服务器</span>
<span class="hljs-comment"># 可通过 scp、sftp 或云存储等方式上传</span>
<span class="hljs-comment"># 示例：使用 scp 从本地上传</span>
scp ~<span class="hljs-regexp">/Downloads/yourdomain</span>.com.* username<span class="hljs-variable">@your_server_ip</span><span class="hljs-symbol">:/etc/nginx/ssl/</span>

<span class="hljs-comment"># 设置正确的文件权限</span>
sudo chmod <span class="hljs-number">600</span> /etc/nginx/ssl/*.key
sudo chmod <span class="hljs-number">644</span> /etc/nginx/ssl/*.pem
</code></pre>
<h3 data-id="heading-4">3. 配置 Nginx</h3>
<ol>
<li><strong>编辑 Nginx 配置文件</strong>：</li>
</ol>
<pre><code class="hljs language-arduino" lang="arduino">bash
   sudo nano /etc/nginx/sites-available/yourdomain.com
   
</code></pre>
<ol start="2">
<li>
<p><strong>粘贴上述配置模板</strong>，并修改以下参数：</p>
<ul>
<li><code>server_name</code>：替换为你的实际域名</li>
<li>文件路径：修改为你的证书文件实际路径</li>
</ul>
</li>
<li>
<p><strong>创建符号链接（如果使用 sites-enabled 目录）</strong> ：</p>
</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">bash
   sudo <span class="hljs-built_in">ln</span> -s /etc/nginx/sites-available/yourdomain.com /etc/nginx/sites-enabled/
   
</code></pre>
<h3 data-id="heading-5">4. 测试并重启 Nginx</h3>
<pre><code class="hljs language-bash" lang="bash">bash
<span class="hljs-comment"># 测试配置语法</span>
sudo nginx -t

<span class="hljs-comment"># 重启 Nginx 使配置生效</span>
sudo systemctl restart nginx

<span class="hljs-comment"># 检查服务状态</span>
sudo systemctl status nginx
</code></pre>
<h3 data-id="heading-6">5. 验证部署结果</h3>
<ol>
<li>
<p><strong>浏览器检查</strong>：</p>
<ul>
<li>访问 <code>https://yourdomain.com</code>，确认浏览器地址栏显示安全锁图标</li>
<li>点击锁图标查看证书信息，确认颁发者为 JoySSL</li>
</ul>
</li>
<li>
<p><strong>在线测试工具</strong>：</p>
<ul>
<li>使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.ssllabs.com%2Fssltest%2F" target="_blank" title="https://www.ssllabs.com/ssltest/" ref="nofollow noopener noreferrer">SSL Labs 测试</a> 检查配置安全性</li>
<li>使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fhstspreload.org%2F" target="_blank" title="https://hstspreload.org/" ref="nofollow noopener noreferrer">HSTS Preload 测试</a> 验证 HSTS 配置</li>
</ul>
</li>
</ol>
<h2 data-id="heading-7">三、高级优化配置</h2>
<h3 data-id="heading-8">1. 启用 Session 复用</h3>
<pre><code class="hljs language-ini" lang="ini">nginx
ssl_session_cache shared:SSL:10m<span class="hljs-comment">;</span>
ssl_session_timeout 10m<span class="hljs-comment">;</span>
</code></pre>
<h3 data-id="heading-9">2. 配置 TLS 1.3 专用参数（Nginx 1.13.0+）</h3>
<pre><code class="hljs language-ini" lang="ini">nginx
ssl_conf_command Options ServerPreference<span class="hljs-comment">;</span>
ssl_conf_command Signatures rsa_pss_rsae_sha256 rsa_pss_rsae_sha384 rsa_pss_rsae_sha512<span class="hljs-comment">;</span>
</code></pre>
<h3 data-id="heading-10">3. 配置 0-RTT（需要 TLS 1.3 支持）</h3>
<pre><code class="hljs language-csharp" lang="csharp">nginx
ssl_early_data <span class="hljs-keyword">on</span>;  <span class="hljs-meta"># 需客户端支持，可能存在重放攻击风险，谨慎使用</span>
</code></pre>
<h2 data-id="heading-11">四、常见问题解决</h2>
<h3 data-id="heading-12">1. 证书验证失败</h3>
<ul>
<li>
<p><strong>问题原因</strong>：DNS 记录未生效或文件验证路径错误</p>
</li>
<li>
<p><strong>解决方案</strong>：</p>
<ul>
<li>DNS 验证：等待 DNS 记录全球同步（通常需要 5-30 分钟）</li>
<li>文件验证：确认验证文件已上传至网站根目录且可通过 <code>http://yourdomain.com/.well-known/pki-validation/file.txt</code> 访问</li>
</ul>
</li>
</ul>
<h3 data-id="heading-13">2. Nginx 启动失败</h3>
<ul>
<li><strong>问题原因</strong>：配置文件语法错误或证书路径错误</li>
<li><strong>解决方案</strong>：</li>
</ul>
<pre><code class="hljs language-bash" lang="bash">bash
  <span class="hljs-comment"># 检查具体错误信息</span>
  sudo nginx -t
  <span class="hljs-comment"># 根据错误提示修正配置</span>
  
</code></pre>
<h3 data-id="heading-14">3. 浏览器显示"不安全"</h3>
<ul>
<li>
<p><strong>问题原因</strong>：混合内容（HTTP/HTTPS 混用）或证书链不完整</p>
</li>
<li>
<p><strong>解决方案</strong>：</p>
<ul>
<li>检查页面所有资源是否使用 HTTPS 加载</li>
<li>确保证书链文件（<code>.chain.pem</code>）已正确配置</li>
</ul>
</li>
</ul>
<h2 data-id="heading-15">五、自动续期配置（可选）</h2>
<h3 data-id="heading-16">1. 使用 Certbot 自动续期（适用于 DNS 验证）</h3>
<pre><code class="hljs language-perl" lang="perl">bash
<span class="hljs-comment"># 安装 Certbot</span>
sudo apt install certbot python3-certbot-nginx

<span class="hljs-comment"># 配置自动续期（需提前配置 DNS API 凭证）</span>
sudo certbot renew --dry-run
<span class="hljs-comment"># 实际续期命令</span>
sudo certbot renew --quiet --<span class="hljs-keyword">no</span>-self-upgrade
</code></pre>
<h3 data-id="heading-17">2. JoySSL 官方自动续期工具</h3>
<ol>
<li>登录 JoySSL 控制台</li>
<li>进入证书管理页面</li>
<li>启用"自动续期"功能（需配置服务器 SSH 访问权限）</li>
</ol>
<h2 data-id="heading-18">六、安全建议</h2>
<ol>
<li><strong>定期更新 Nginx</strong>：保持最新版本以修复安全漏洞</li>
<li><strong>监控证书有效期</strong>：设置提前 30 天续期提醒</li>
<li><strong>启用防火墙</strong>：仅开放 443（HTTPS）和 80（HTTP 重定向）端口</li>
<li><strong>定期审计</strong>：使用工具如 <code>lynx -dump https://yourdomain.com</code> 检查混合内容</li>
</ol>
<p>通过以上配置，你的网站将获得：</p>
<ul>
<li>A+ 级 SSL 安全评级</li>
<li>完整的 HSTS 策略保护</li>
<li>优化的 TLS 握手性能</li>
<li>自动化的证书续期能力</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[在仿真优化项目里的数据库选型，OpenTeleDB的Xstore存储引擎应用]]></title>    <link>https://juejin.cn/post/7605041451329110059</link>    <guid>https://juejin.cn/post/7605041451329110059</guid>    <pubDate>2026-02-11T05:41:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605041451329110059" data-draft-id="7605051886434959423" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="在仿真优化项目里的数据库选型，OpenTeleDB的Xstore存储引擎应用"/> <meta itemprop="keywords" content="后端,PostgreSQL,SQL"/> <meta itemprop="datePublished" content="2026-02-11T05:41:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="静Yu"/> <meta itemprop="url" content="https://juejin.cn/user/2225839800062215"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            在仿真优化项目里的数据库选型，OpenTeleDB的Xstore存储引擎应用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2225839800062215/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    静Yu
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-11T05:41:55.000Z" title="Wed Feb 11 2026 05:41:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>最近在做一个项目是关于仿真优化业务的，项目背景是在系统中搭建仿真工作流，工作流会调用各种优化算法进行计算，每个任务的计算会产生大量的中间结果写入数据库中，而且每个任务会多次修改参数重新提交，就会多次大量的更新数据库的数据。</p>
<p>👉 <strong>这是一个 UPDATE 远多于 INSERT 的系统</strong></p>
<p>问题：“大量中间数据 + 反复重算 + 高频 UPDATE”，可能会出现的问题就是系统经过一段时间的运行，大量的数据导致磁盘被占满的问题。</p>
<p>解决方法：与同事讨论后一致决定，将计算结果数据表与其余业务表分开，并部署到不同的服务器上。这还不能解决根本问题，如果依旧采用PostgreSQL数据库依旧会出现存储空间持续膨胀，以及性能波动问题。这时我们就把目光瞄准了OpenTeleDB，他的Xstore存储引擎完美的解决了这些问题。</p>
<blockquote>
<p>OpenTeleDB通过XStore存储引擎对存储层进行全链路重构：通过原位更新与Undo日志管理，从根本杜绝空间膨胀，表空间占用几乎零增长；同时对索引采用原位更新，彻底告别扫表式Vacuum，将执行TPCC模型时性能波动压制在5%以内。</p>
</blockquote>
<p><strong>下面是我的一些验证测试流程。</strong></p>
<h3 data-id="heading-0">数据库安装</h3>
<p>关于OpenTeleDB的安装教程网上有很多，我就不过多赘述了。</p>
<p>数据库安装主要分为以下几步，部署也相对简单：</p>
<ol>
<li>安装一些必要的依赖</li>
<li>源码下载</li>
<li>编译安装</li>
<li>初始化数据库</li>
<li>启动数据库</li>
</ol>
<p>最终通过命令启动数据库，如果出现server started的字样则证明数据库服务启动成功。</p>
<pre><code class="hljs language-bash" lang="bash">安装目录/bin/pg_ctl -D 安装目录/data start
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2599da2acd5c418b90d84e819da22cb8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2ZWXU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771393323&amp;x-signature=132BVUlq3b%2FjVPxB9k%2F%2BUGdNR3Y%3D" alt="" loading="lazy"/></p>
<p>启动之后也可以<code>ps uxf | grep postgres</code> 命令用于查看 OpenTeleDB 数据库相关的所有进程</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0b758c8e0ecc4f80b9d7c3d3be30f5f3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2ZWXU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771393323&amp;x-signature=E95roZQDXQuT7FfSd2Vbn6YSHv4%3D" alt="" loading="lazy"/></p>
<p><strong>在测试过程中遇到的问题：</strong></p>
<p>1.OpenTeleDB默认的监听地址是 localhost,只允许本地连接</p>
<p>我的服务和数据库不在同一台服务器，需要修改一下配置允许通过ip访问。</p>
<p>需要修改/openteledb/data/下的postgresql.conf文件中的</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">listen_addresses</span> = <span class="hljs-string">'localhost'</span>      <span class="hljs-comment"># what IP address(es) to listen on;</span>
<span class="hljs-comment"># 修改为</span>
<span class="hljs-attr">listen_addresses</span> = <span class="hljs-string">'*'</span>      <span class="hljs-comment"># what IP address(es) to listen on; </span>
</code></pre>
<p>修改完成之后，可以通过<code>ss -lntp | grep 5432</code>验证是否生效，如果是0.0.0.0就代表允许外部ip访问。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3ec20a832b4a4d819d2dd56299c799fb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2ZWXU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771393323&amp;x-signature=kc9NkeUfT0LXDTQiEs%2BBigMvBIo%3D" alt="" loading="lazy"/></p>
<p>2.FATAL: no pg_hba.conf entry for host "192.168.1.102", user "postgres", database "postgres", no encryption</p>
<p>这个错误表明 PostgreSQL 在 <code>pg_hba.conf</code> 配置文件中没有为 IP 地址 <code>192.168.1.102</code> 配置访问权限，导致无法建立数据库连接。</p>
<p>需要修改 <code>pg_hba.conf</code> 配置文件，添加一条允许连接的规则。</p>
<pre><code class="hljs language-css" lang="css">host    <span class="hljs-attribute">all</span>    <span class="hljs-attribute">all</span>    <span class="hljs-number">192.168</span>.<span class="hljs-number">1.102</span>/<span class="hljs-number">32</span>    md5
</code></pre>
<p>修复了上述的两个问题之后，我就可以在另外一台服务器上连接到数据库。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/158bc830f500425187106b41d285598c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2ZWXU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771393323&amp;x-signature=tvG6PCwlLLrTjPg7%2FbmMQgg5iLY%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-1">测试过程</h3>
<p>现在来模拟一下我的业务场景，通过SQL模拟一个优化算法来生成大量的中间结果数据.为了验证Xstore在表空间膨胀的表现，测试过程中我创建了两张表，一张是正常创建的数据库表(optimization_results_indexed)，另外一张是使用Xstore引擎创建的数据库表(optimization_results_indexed_xstore)。</p>
<p>在进行测试过程之前，我们先确认一下<code>Xstore</code> 扩展已正常启用。</p>
<pre><code class="hljs language-sql" lang="sql">\dx

<span class="hljs-comment">-- 显式启用 xstore 扩展</span>
<span class="hljs-keyword">CREATE</span> EXTENSION IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> xstore;
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/163714a78b6948c28809e60c8420d484~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2ZWXU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771393323&amp;x-signature=3McLk4IEM8PgLAZ78HtJ8SJCdJE%3D" alt="" loading="lazy"/></p>
<h5 data-id="heading-2">生成库表</h5>
<p>我首先要做的是实现一个SQL语句，确保数据库中存在一个用于存储优化结果的表。具体来说，下面这段SQL会检查并创建一个名为 optimization_results_indexed 或 optimization_results_indexed_xstore 的表，表结构设计用于存储优化算法的执行结果。表包括以下字段：</p>
<p><code>algorithm_name</code>：存储算法名称。</p>
<p><code>execution_index</code>：标识算法执行的编号。</p>
<p><code>best_solution</code>：保存算法的最佳解决方案。</p>
<p><code>best_score</code>：记录最佳解决方案的得分。</p>
<p><code>iteration_count</code>：表示算法执行的迭代次数。</p>
<p><code>last_updated</code>：自动记录表中的数据最后更新时间。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> optimization_results_indexed (
    algorithm_name   <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>),
    execution_index  <span class="hljs-type">INT</span>,
    best_solution    TEXT,
    best_score       <span class="hljs-type">DOUBLE PRECISION</span>,
    iteration_count  <span class="hljs-type">INT</span>,
    last_updated     <span class="hljs-type">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>,
    <span class="hljs-keyword">PRIMARY</span> KEY (algorithm_name, execution_index)
);
<span class="hljs-operator">/</span><span class="hljs-operator">/</span>Xstore存储引擎
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> optimization_results_indexed_xstore (
    algorithm_name   <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>),
    execution_index  <span class="hljs-type">INT</span>,
    best_solution    TEXT,
    best_score       <span class="hljs-type">DOUBLE PRECISION</span>,
    iteration_count  <span class="hljs-type">INT</span>,
    last_updated     <span class="hljs-type">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>,
    <span class="hljs-keyword">PRIMARY</span> KEY (algorithm_name, execution_index)
) <span class="hljs-keyword">USING</span> xstore;
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6c9f619399e24853b697b2033a778e82~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2ZWXU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771393323&amp;x-signature=qF%2FlD6Adhq%2F16IfM0ySgzIDPE6Y%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/69540abbfa6f4e508517ca5ca3467bc5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2ZWXU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771393323&amp;x-signature=3CcnXgqMCbCouFPOHYdn8EaEjc0%3D" alt="" loading="lazy"/></p>
<h5 data-id="heading-3">首次插入</h5>
<p>生成了数据库表之后，就开始首次插入第一波模拟数据，分别在两张表中插入数据。</p>
<p>这条 SQL 语句的目的是向 <code>optimization_results_indexed</code> 和<code>optimization_results_indexed_xstore</code>表中插入 20,000 条模拟数据记录，模拟一个梯度下降优化算法的执行结果。在插入的过程中，首先为每一条记录指定了一个静态的算法名称 <code>'gradient_descent'</code>，并通过 <code>generate_series(1, 20000)</code> 函数生成从 1 到 20,000 的整数序列，用作每条记录的 <code>execution_index</code>。接着，为 <code>best_solution</code> 字段设置了一个固定的 JSON 格式字符串 <code>{"x": 1.23, "y": 4.56}</code>，代表每次优化算法得到的最佳解决方案。在 <code>best_score</code> 字段中，使用 <code>random() * 100</code> 生成一个介于 0 到 100 之间的随机分数，模拟每次优化过程中的得分。<code>iteration_count</code> 字段则通过 <code>(random() * 1000)::INT</code> 生成一个介于 0 到 1000 之间的随机整数，代表每次优化算法的迭代次数。最后，<code>last_updated</code> 字段被赋予当前时间戳 <code>CURRENT_TIMESTAMP</code>，表示每条记录的更新时间。整个查询语句将这 20,000 条记录插入到表中，用于模拟大量的优化算法执行结果和测试。</p>
<pre><code class="hljs language-vbnet" lang="vbnet">INSERT <span class="hljs-keyword">INTO</span> optimization_results_indexed (
    algorithm_name,
    execution_index,
    best_solution,
    best_score,
    iteration_count,
    last_updated
)
<span class="hljs-keyword">SELECT</span>
    <span class="hljs-comment">'gradient_descent'               AS algorithm_name,</span>
    gs                               <span class="hljs-keyword">AS</span> execution_index,
    <span class="hljs-comment">'{"x": 1.23, "y": 4.56}'          AS best_solution,</span>
    random() * <span class="hljs-number">100</span>                   <span class="hljs-keyword">AS</span> best_score,
    (random() * <span class="hljs-number">1000</span>)::INT           <span class="hljs-keyword">AS</span> iteration_count,
    CURRENT_TIMESTAMP
<span class="hljs-keyword">FROM</span> generate_series(<span class="hljs-number">1</span>, <span class="hljs-number">20000</span>) <span class="hljs-keyword">AS</span> gs;

//Xstore存储引擎
INSERT <span class="hljs-keyword">INTO</span> optimization_results_indexed_xstore (
    algorithm_name,
    execution_index,
    best_solution,
    best_score,
    iteration_count,
    last_updated
)
<span class="hljs-keyword">SELECT</span>
    <span class="hljs-comment">'gradient_descent'               AS algorithm_name,</span>
    gs                               <span class="hljs-keyword">AS</span> execution_index,
    <span class="hljs-comment">'{"x": 1.23, "y": 4.56}'          AS best_solution,</span>
    random() * <span class="hljs-number">100</span>                   <span class="hljs-keyword">AS</span> best_score,
    (random() * <span class="hljs-number">1000</span>)::INT           <span class="hljs-keyword">AS</span> iteration_count,
    CURRENT_TIMESTAMP
<span class="hljs-keyword">FROM</span> generate_series(<span class="hljs-number">1</span>, <span class="hljs-number">20000</span>) <span class="hljs-keyword">AS</span> gs;
</code></pre>
<p>执行完上面的代码后，打开数据库可视化操作工具，确认一下数据是否成功插入。可以看到，数据库中已经有了模拟生成的中间数据了。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/85a38f2448864d1a9b1e5acf9fc2343f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2ZWXU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771393323&amp;x-signature=7jBLwXumtKydOoFPRLnJmEbIZPU%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a9c7415099d44984b8d23f4d5889b4a9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2ZWXU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771393323&amp;x-signature=xLmcbw5MKk19cMhUdHoDbQpj2Q4%3D" alt="" loading="lazy"/></p>
<p>通过SELECT语句查询了一下表中的数据总条数。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">FROM</span> optimization_results_indexed;

<span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">FROM</span> optimization_results_indexed_xstore;
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d160039a38b1457faa982a037590d19a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2ZWXU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771393323&amp;x-signature=j9pOti%2BUd03HfpPBEaTGgb%2F7vbw%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/28f4b919c0784105b2edab88041c244f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2ZWXU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771393323&amp;x-signature=2sDPxi1LK3VOE4Jt79Od3zY5p8Y%3D" alt="" loading="lazy"/></p>
<p>我的目的是为了验证多次更新海量数据，Xstore存储引擎在表空间膨胀方面的表现。所以执行完第一次优化算法之后，先去查一下两张表所占存储大小。</p>
<p>然后再通过命令查询一下optimization_results_indexed和optimization_results_indexed_xstore这两张表的存储大小，我们可以清晰的看到20000条数据分别所占用2016kB、2008kB大小，相差不大。</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-function">SELECT <span class="hljs-title">pg_size_pretty</span><span class="hljs-params">(pg_table_size(<span class="hljs-string">'optimization_results_indexed'</span>))</span></span>;

<span class="hljs-function">SELECT <span class="hljs-title">pg_size_pretty</span><span class="hljs-params">(pg_table_size(<span class="hljs-string">'optimization_results_indexed_xstore'</span>))</span></span>;
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/017c4b60f30545f3a3b0d2493bf7a41a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2ZWXU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771393323&amp;x-signature=rkpITyBeBw0XiI7Zl7jBTdcZlw4%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/978e9b463b474869a8e2f6096675ba98~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2ZWXU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771393323&amp;x-signature=ab%2BzaVZsQLtTQnhG9DRNOOKxrUU%3D" alt="" loading="lazy"/></p>
<h5 data-id="heading-4">更新数据</h5>
<p>为了验证OpenTeleDB的Xstore存储引擎在原位更新和表膨胀两个点的表现，现在实现一个更新SQL。</p>
<p>这条 SQL 语句用于更新 <code>optimization_results_indexed</code> 或<code>optimization_results_indexed_xstore</code> 表中 <code>algorithm_name</code> 为 <code>'gradient_descent'</code> 且 <code>execution_index</code> 在 1 到 20,000 之间的记录。更新内容包括：将 <code>best_solution</code> 字段设置为新的随机值（以 JSON 格式表示的 <code>x</code> 和 <code>y</code> 坐标），<code>best_score</code> 字段更新为一个新的随机分数（0 到 100 之间），<code>iteration_count</code> 字段增加一个随机整数（0 到 10 之间），并且将 <code>last_updated</code> 字段设置为当前时间戳。</p>
<pre><code class="hljs language-ini" lang="ini">UPDATE optimization_results_indexed
SET
    <span class="hljs-attr">best_solution</span>   = format(<span class="hljs-string">'{"x": %s, "y": %s}'</span>,
                              to_char(random(), 'FM999999999.0000'),
                              to_char(random(), 'FM999999999.0000')),
    <span class="hljs-attr">best_score</span>      = random() * <span class="hljs-number">100</span>,
    <span class="hljs-attr">iteration_count</span> = iteration_count + (random() * <span class="hljs-number">10</span>)::INT,
    <span class="hljs-attr">last_updated</span>    = CURRENT_TIMESTAMP
WHERE <span class="hljs-attr">algorithm_name</span> = <span class="hljs-string">'gradient_descent'</span>
  AND execution_index IN (
      SELECT generate_series(1, 20000)
  )<span class="hljs-comment">;</span>
  
//Xstore存储引擎 
UPDATE optimization_results_indexed_xstore
SET
    <span class="hljs-attr">best_solution</span>   = format(<span class="hljs-string">'{"x": %s, "y": %s}'</span>,
                              to_char(random(), 'FM999999999.0000'),
                              to_char(random(), 'FM999999999.0000')),
    <span class="hljs-attr">best_score</span>      = random() * <span class="hljs-number">100</span>,
    <span class="hljs-attr">iteration_count</span> = iteration_count + (random() * <span class="hljs-number">10</span>)::INT,
    <span class="hljs-attr">last_updated</span>    = CURRENT_TIMESTAMP
WHERE <span class="hljs-attr">algorithm_name</span> = <span class="hljs-string">'gradient_descent'</span>
  AND execution_index IN (
      SELECT generate_series(1, 20000)
  )<span class="hljs-comment">;</span>
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e9095c04f1d347ddb6f7488742f40474~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2ZWXU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771393323&amp;x-signature=3byWDPY1HAOepK1sTx5t5oHu5bI%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9624e15399f44df88738a6798270acc8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2ZWXU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771393323&amp;x-signature=oKVgIKCAvbsYVx6n5h2X%2FEoM6lA%3D" alt="" loading="lazy"/></p>
<p>首先进行一次之后，我又重新查询了表空间的大小。可以看到两张表的空间都有一定的增加。其中每次优化算法产生的数据完全不一致，这很可能也是导致表增长的原因。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3f38bd9b6633470e8551d44fd6006d96~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2ZWXU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771393323&amp;x-signature=jyyeNUikaDviNGHobUkEVOXnsV4%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bf6e66906f29498cacb9745eac261ad2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2ZWXU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771393323&amp;x-signature=%2BFp63xR972nPEqtQJi1JRiKQ2WU%3D" alt="" loading="lazy"/></p>
<p>这只更新了一次，并不能说明什么问题，我要验证的是高频UPDATE。现在我再执行几次更新看看效果。</p>
<p>可以发现正常方式创建的表，表空间还是会一直增长的，然后我就一直执行一直执行，直到执行了三十次之后，数据表空间竟然达到了27MB。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/01c7d2b1847846d4a01300f8c2f7a0b6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2ZWXU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771393323&amp;x-signature=f0VATApOk1256dTR%2F63pinbD2UI%3D" alt="" loading="lazy"/></p>
<p>然后我又用同样的方式对<code>optimization_results_indexed_xstore</code>执行了同样的三十次覆盖式更新操作。我惊喜的发现，表空间依旧是第一次更新之后的3800kB。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cb128502b59044e096970de8551ea89b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2ZWXU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771393323&amp;x-signature=LORfRz%2Bj%2FtP5TkPX9jWkJoeWRSE%3D" alt="" loading="lazy"/></p>
<p>经过真实测试，答案已经显而易见了,Xstore存储引擎的原位更新真的做到了表空间几乎零增长。</p>

























<table><thead><tr><th/><th><code>optimization_results_indexed</code></th><th><code>optimization_results_indexed_xstore</code></th></tr></thead><tbody><tr><td>第一次插入数据</td><td>2016kB</td><td>2008kB</td></tr><tr><td>第一次更新数据</td><td>4152kB</td><td>3800kB</td></tr><tr><td>更新30次数据</td><td>27MB</td><td>3800kB</td></tr></tbody></table>
<h3 data-id="heading-5">结尾</h3>
<p>说白了，这次测试一圈下来，Xstore 确实挺能“扛”的。我们这种反复更新、数据量大的业务，最怕的就是表一直膨胀，最后磁盘爆满、性能下滑。用 Xstore 之后，第一次更新虽然也会涨一点，但后面不管怎么频繁改数据，表大小基本就稳住了，再也没往上跑。对我们来说，这就是最实在的解决方案——不用总担心空间问题，也不用老想着扩容服务器。</p>
<p>如果你也在做仿真优化、实时计算、频繁迭代这类“写多改多”的系统，并且被 PostgreSQL 的：</p>
<ul>
<li>表空间不断膨胀</li>
<li>VACUUM 压力大、性能波动</li>
<li>磁盘很快被中间数据占满</li>
</ul>
<p>这类问题困扰，那么 OpenTeleDB + Xstore 存储引擎 是一个值得认真考虑的选项。 它不是“魔法”，但通过原位更新和优化的 UNDO 管理，实实在在地解决了高频更新场景下的存储膨胀问题。</p>
<h5 data-id="heading-6">如果你打算尝试，可以顺着这个思路走：</h5>
<ol>
<li>
<p><strong>判断是否适用</strong> 如果你的业务是：UPDATE 远多于 INSERT、中间数据多、同一批数据反复重算、不想频繁清理或拆表。 如果你的痛点是：表膨胀快、VACUUM 影响性能、存储成本增长明显。 那 Xstore 很可能对你有用。</p>
</li>
<li>
<p><strong>使用很简单，就两步</strong></p>
<ol>
<li>建表时加一句 <code>USING xstore</code></li>
<li>确保数据库里启用了 <code>xstore</code> 扩展（<code>CREATE EXTENSION IF NOT EXISTS xstore;</code>） 其他代码、查询基本不用改，对应用透明。</li>
</ol>
</li>
<li>
<p><strong>没必要全库换</strong> 只针对那种更新极度频繁的表使用 Xstore，其他普通表还是用原来的存储方式。这样既能解决痛点，也不引入不必要的复杂度。</p>
</li>
</ol>
<p>技术选型没有最好的，但如果有某个特性正好对准你的业务痛点，那就值得一试。</p>
<p>Xstore 对我们这种“反复算、反复写”的场景来说，真的算是“对症下药”了。</p>
<p>如果你也遇到了类似的数据膨胀困扰，不妨搭个测试环境跑一跑，用真实数据验证一下，毕竟适合自己的才是最好的。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[牛掰，MySQL官方支持读写分离了！]]></title>    <link>https://juejin.cn/post/7605173538416853002</link>    <guid>https://juejin.cn/post/7605173538416853002</guid>    <pubDate>2026-02-11T05:53:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605173538416853002" data-draft-id="7605114266023919667" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="牛掰，MySQL官方支持读写分离了！"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-02-11T05:53:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Java编程爱好者"/> <meta itemprop="url" content="https://juejin.cn/user/819554264300154"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            牛掰，MySQL官方支持读写分离了！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/819554264300154/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Java编程爱好者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-11T05:53:49.000Z" title="Wed Feb 11 2026 05:53:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>我们一直在等待的 MySQL 读/写分离功能现在终于可以使用了！</p>
<p>在规模上，我们在副本之间分配读取，但这必须在应用程序中以某种方式进行管理：指向在某个地方写入并在其他地方读取。</p>
<p>在 MySQL 8.2中，MySQL Router 现在能够识别读取和写入，并将它们路由到主实例（如果是 InnoDB 集群），或者路由到异步复制源以进行写入，将其路由到辅助实例或副本以进行读取。</p>
<p>为了说明这一点，我部署了最简单的架构：MySQL InnoDB ReplicaSet。</p>
<h2 data-id="heading-0">MySQL InnoDB ReplicaSet</h2>
<p>这只是一个复制源实例和一个（或多个）异步副本：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a3ee362c1ea04c52a206cf1ceb4336cd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2Yee8lueoi-eIseWlveiAhQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771394034&amp;x-signature=pBn6uPlIrYnrsYRN8rHknsK974E%3D" alt="" loading="lazy"/></p>
<p>这是 MySQL Shell 中 ReplicaSet 对象的状态：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/22ae1e034d574cc192ffd56f54fac28a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2Yee8lueoi-eIseWlveiAhQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771394034&amp;x-signature=sWWiWUgP6LMm%2B4jgplpWZlwr9ko%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-1">启动 MySQL Router 8.2</h2>
<p>让我们配置（启动）MySQL Router：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ac72c4dcd0814b12a15eb7789828a1a5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2Yee8lueoi-eIseWlveiAhQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771394034&amp;x-signature=POizPowNyxWAsJXvjkhODgM9tm0%3D" alt="" loading="lazy"/></p>
<p>我们还可以在 MySQL Shell ReplicaSet 对象中看到 Router：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b47075dfbb6c40248778d59e6054b876~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2Yee8lueoi-eIseWlveiAhQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771394034&amp;x-signature=ysvSw1rNj7gciZ5uSrid5vGgyBI%3D" alt="" loading="lazy"/></p>
<p>使用读/写端口 ( 6450 ) 连接到 MySQL：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b554f1158dc84d3f86cbf983fc08244c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2Yee8lueoi-eIseWlveiAhQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771394034&amp;x-signature=lp1PdNx4PzrO7zxl%2BpoRlGpjDgU%3D" alt="" loading="lazy"/></p>
<p>我们可以看到，默认情况下，如果执行读操作，我们将访问到副本，但如果启动事务，我们将到达复制源（主），而无需更改端口并使用相同的连接。</p>
<p>我们还可以看到使用只读事务时的差异：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/44395af374b74ac197506c6e23cc1847~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2Yee8lueoi-eIseWlveiAhQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771394034&amp;x-signature=1zSarejP3CqGlctArVjw4Cqzrfg%3D" alt="" loading="lazy"/></p>
<p>我们可以在 MySQL Router 的配置文件中看到生成的读写分离的设置：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-section">[routing:bootstrap_rw_split]</span>
<span class="hljs-attr">bind_address</span>=<span class="hljs-number">0.0</span>.<span class="hljs-number">0.0</span>
<span class="hljs-attr">bind_port</span>=<span class="hljs-number">6450</span>
<span class="hljs-attr">destinations</span>=metadata-cache://myreplica/?role=PRIMARY_AND_SECONDARY
<span class="hljs-attr">routing_strategy</span>=round-robin
<span class="hljs-attr">protocol</span>=classic
<span class="hljs-attr">connection_sharing</span>=<span class="hljs-number">1</span>
<span class="hljs-attr">client_ssl_mode</span>=PREFERRED
<span class="hljs-attr">server_ssl_mode</span>=PREFERRED
<span class="hljs-attr">access_mode</span>=auto
</code></pre>
<p>您还可以使用命令 <code>ROUTER SET access_mode=</code> 在会话中定义要访问的实例类型：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/70ade077153f4ec5af940499b1763021~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2Yee8lueoi-eIseWlveiAhQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771394034&amp;x-signature=MSMFFSy5k51wPAAyTHOXKoYLu1o%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-2">结论</h2>
<p>综上所述，MySQL Router 8.2 支持读写分离。这是一项很有价值的功能，可以优化数据库性能和可扩展性，而无需对应用程序进行任何更改。</p>
<p>通过此配置，您可以将所有读取流量定向到只读实例，并将所有写入流量定向到读写实例。</p>
<p>此功能不仅增强了整体用户体验，还简化了数据库管理和部署。</p>
<p>读写实例是主实例或源实例。只读实例是副本（InnoDB Cluster ReplicaSet、ReplicaSet 辅助实例或副本群集中的辅助实例）。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI推理：如何实现吞吐翻倍、时延降90%与GPU资源节省26%？]]></title>    <link>https://juejin.cn/post/7605106957133725730</link>    <guid>https://juejin.cn/post/7605106957133725730</guid>    <pubDate>2026-02-11T05:56:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605106957133725730" data-draft-id="7605128056485396495" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI推理：如何实现吞吐翻倍、时延降90%与GPU资源节省26%？"/> <meta itemprop="keywords" content="程序员"/> <meta itemprop="datePublished" content="2026-02-11T05:56:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="京东云开发者"/> <meta itemprop="url" content="https://juejin.cn/user/2634854380340008"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI推理：如何实现吞吐翻倍、时延降90%与GPU资源节省26%？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2634854380340008/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    京东云开发者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-11T05:56:04.000Z" title="Wed Feb 11 2026 05:56:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作者：马国忠</p>
<h2 data-id="heading-0">引言：AI规模化落地，推理系统面临全新挑战</h2>
<p>﻿</p>
<p>全球领先的市场研究和咨询公司IDC预测，到2028年，75%的新 AI 工作负载将实现容器化，从而显著提升模型与工作负载更新的速度、一致性与安全性。容器化技术将成为 AI 推理时代的“默认交付形态”。当前随着大模型技术快速演进与业务场景的深度融合，<strong>AI业务对推理基础设施的需求呈现爆发式增长</strong>。在早期小流量场景下，手动部署与定制化方案尚可应对；然而当模型规模、并发请求与业务复杂度攀升至新高度时，传统推理系统在以下四个主要方面逐渐暴露出瓶颈。</p>
<ol>
<li><strong>稳定性不足</strong>：</li>
</ol>
<p>◦<strong>单点故障风险</strong>：手动部署的静态架构缺乏多副本与故障自愈机制，单节点宕机易引发服务中断；</p>
<p>◦<strong>负载不均衡</strong>：缺乏智能流量调度，高并发时部分节点过载导致响应延迟，低负载时资源闲置；</p>
<p>◦<strong>故障恢复滞后</strong>：依赖人工排查与重启，恢复周期长，影响业务连续性。</p>
<p>2.<strong>资源利用率低下</strong>：</p>
<p>◦<strong>静态资源分配</strong>：固定规模的GPU集群无法适应流量波动，高峰时段资源争抢，低谷期GPU闲置率超40%；</p>
<p>◦<strong>缺乏弹性机制</strong>：无法根据请求队列长度、KV缓存利用率等指标动态扩缩容，导致周级别GPU卡时浪费超5000+。</p>
<p>3.<strong>推理性能瓶颈</strong>：</p>
<p>◦<strong>混合请求排队</strong>：长、短文请求混合处理时，短文首字时延（TTFT）因排队激增90%以上；</p>
<p>◦<strong>缓存复用率低</strong>：多副本场景下相同前缀请求随机调度，重复计算导致KV缓存命中率不足60%；</p>
<p>◦<strong>硬件拓扑未优化</strong>：跨交换机部署引发传输延迟，人工调整拓扑亲和性成本高且易出错。</p>
<p>4.<strong>定制成本高昂</strong>：</p>
<p>◦<strong>多引擎适配复杂</strong>：vLLM、SGLang等引擎需独立开发接入层，版本迭代与兼容性维护成本攀升；</p>
<p>◦<strong>运维依赖人工</strong>：从部署、监控到故障修复全流程手动操作，人力成本占比超30%，且易引入人为错误。</p>
<p>﻿</p>
<p>为此，京东云结合实际业务需求与技术趋势，全面拥抱云原生技术栈，积累了丰富的云原生与高性能推理经验。自主研发了新一代<strong>云原生AI推理框架。</strong> 推动推理系统完成了一次体系化升级，实现了从手动部署到全场景AutoScale，从资源浪费到GPU利用率最大化。</p>
<p>•<strong>流量高峰自动扩容、低谷自动缩容</strong>，GPU卡时节省高达26%；</p>
<p>•<strong>智能流量调度与KV缓存复用</strong>，最高提升吞吐124%，首次生成时延TTFT降低90%；</p>
<p>•<strong>具备多级高可用能力</strong>，支持流量隔离、故障自愈与深度可观测；</p>
<p>•<strong>模型量化、引擎调优、算子开发</strong>等多项优化，推理引擎单点性能呈现局部领先优势。</p>
<p>﻿</p>
<p>详细了解一套生产级分布式AI训练推理平台（JoyBuilder）的云原生改造全纪实。京东云<strong>云原生AI推理框架。</strong></p>
<p>﻿</p>
<h2 data-id="heading-1">一、系统架构设计：面向生产级的高性能云原生推理平台</h2>
<h3 data-id="heading-2">设计理念：</h3>
<p>我们遵循三大核心设计原则，确保系统长期迭代的灵活性：</p>
<p>1.<strong>解耦与组合</strong> 各模块尽量松耦合，优先复用开源成熟组件，同时避免被社区绑定，保留核心模块的可替换能力。</p>
<p>2.<strong>扩展性优先</strong> 支持以插件化方式集成智能调度算法（流量调度、扩缩容决策、Prefix Cache打分等）；容器编排能力可扩展，目前已支持跨机部署与基于角色的调度策略。</p>
<p>3.<strong>引擎无感接入</strong> 目前可同时支持vLLM、SGLang等主流推理引擎，最终实现任意推理引擎的低成本接入。</p>
<h3 data-id="heading-3">系统架构：</h3>
<p>﻿</p>
<h3 data-id="heading-4">模块详解：</h3>
<h4 data-id="heading-5"><strong>1. 智能流量调度网关</strong></h4>
<p>基于云原生Gateway API与Inference Extension框架，我们构建了支持多引擎、高可用、高扩展的智能推理网关，支持多层次调度策略：</p>
<p>﻿</p>









































<table><thead><tr><th><strong>核心能力</strong></th><th><strong>说明</strong></th></tr></thead><tbody><tr><td><strong>长短文分桶推理 流量调度</strong></td><td>网关基于高效的<strong>长短文分桶算法</strong>，构建跨模型集群的分流调度，显著<strong>降低短文TTFT（首字生成时延）；</strong></td></tr><tr><td><strong>前缀缓存感知KV复用流量调度</strong></td><td>面向不同模型上下文特征，基于 <strong>HashTrie 算法</strong>构建集群内全局pod的近似前缀缓存画像，支持prefix cache的亲和调度，<strong>有效降低推理 TTFT(首字生成时延)；</strong></td></tr><tr><td><strong>多维负载均衡流量调度</strong></td><td>毫秒级实时采集KV Cache Utilization、Waiting Queue等server load指标，支持<strong>load aware 亲和调度；</strong></td></tr><tr><td><strong>交换机拓扑感知流量调度</strong></td><td>为减少PD group组内KV cache传输的耗时，构建网络拓扑感知，<strong>支持全局最优prefill + 局部最优decode的网络亲和调度</strong>；</td></tr><tr><td><strong>多引擎PD分离流量编排调度</strong></td><td>已支持<strong>vLLM</strong>(PD串行)、<strong>SGLang</strong>(PD异步并行) 异构引擎无差别流量调度</td></tr><tr><td><strong>多LoRA动态流量调度、模型切换的流量调度</strong></td><td>实现不同引擎多LoRA的动态装、卸载，集成LoRA-aware 的动态流量感知调度能力；</td></tr><tr><td><strong>精确的前缀感知Cache-aware流量调度</strong></td><td>实时订阅引擎侧KV Events Metrics，构建精确的前缀缓存画像，实现更高效的prefix cache亲和调度，进一步降低推理TTFT；</td></tr><tr><td><strong>基于时延预测的SLO-aware 流量优先级感知调度</strong></td><td>利用延迟预测来估算每个请求在每个可用节点上的首次生成时间（TTFT）和每个输出令牌时间（TPOT），实现基于时延预测的SLO-aware智能调度；</td></tr></tbody></table>
<h4 data-id="heading-6"><strong>2. 容器编排与资源调度</strong></h4>
<p>﻿</p>
<p>•<strong>部署灵活</strong>：PD分离部署，具有Group和Pool两种模式，实现弹性扩缩容与拓扑感知调度。</p>
<p>•<strong>高可用机制</strong>：多副本部署，避免单点故障。同时支持故障时自动摘流与容器自愈，保障服务持续可用，用户无感知。</p>
<p>﻿</p>

























<table><thead><tr><th><strong>核心能力</strong></th><th><strong>说明</strong></th></tr></thead><tbody><tr><td><strong>容器编排</strong></td><td>根据推理引擎工作特点，基于容器之间的协作关系（Kimi多容器跨机推理、PD分离架构等），将各个推理引擎容器一定的组织方式部署成一组Pods，并联动服务发现、重启策略。</td></tr><tr><td><strong>GPU资源调度</strong></td><td>自动将各个新创建的Pod调度到具有足够GPU资源的机器节点。</td></tr><tr><td><strong>拓扑感知调度</strong></td><td>Kimi跨机推理， TP16部署的2台机器保证在同一个交换机下；PD分离部署，协作关系的P和D在同一个交换机下。</td></tr><tr><td><strong>优先级调度和抢占</strong></td><td>支持在线服务和离线任务的混合调度，高优的在线服务可以抢占低优任务的GPU资源。</td></tr></tbody></table>
<h4 data-id="heading-7"><strong>3. 系统稳定性与可观测</strong></h4>
<p>•集成流量镜像、全链路告警与主备值班协同机制。</p>
<p>•通过网关大盘、调度模块监控、模型性能面板等多层次观测体系，实现问题快速发现与定位。</p>
<p>﻿</p>
<p>﻿</p>
<h4 data-id="heading-8">4. 引擎优化与性能突破</h4>
<p>针对MoE、多模态等模型特点，通过算子优化、引擎调优与量化等手段，在多项关键性能指标上实现行业领先。</p>
<p>﻿</p>
<h2 data-id="heading-9">二、关键场景落地与收益量化</h2>
<h4 data-id="heading-10">1. 长短文混合调度</h4>
<p><strong>问题</strong>：长、短文请求混合排队时，短文TTFT急剧上升，集群吞吐下降。 <strong>方案</strong>：通过长短文分桶与跨集群调度，实现长短文分离处理。</p>
<p><strong>收益</strong>（以Kimi-K2与DeepSeek-V3压测为例）：</p>
<p>•<strong>Kimi-K2</strong>：短文TTFT降低90.97%，吞吐提升124.46%；长文吞吐提升33.89%，集群整体吞吐提升67%。</p>
<p>•<strong>DeepSeek-V3</strong>：短文TTFT降低79.09%，吞吐提升36.7%；长文吞吐提升14.34%，集群整体吞吐提升21.82%。</p>
<p>﻿</p>
<h4 data-id="heading-11">2. KV Cache全局感知的流量调度</h4>
<p><strong>问题</strong>：多副本场景下相同前缀请求被随机调度，导致每个实例都重复计算并缓存相同前缀。 <strong>方案</strong>：持续刻画更新集群级KV Cache缓存画像，实现前缀匹配的智能路由，KV Cache高效复用。</p>
<p><strong>收益</strong>：</p>
<p>•DeepSeek-V3场景下，集群吞吐提升29.9%，首Token时延TTFT降低28.7%；</p>
<p>•Kimi-K2场景下，KV Cache命中率整体提升20%~30%。</p>













<table><thead><tr><th><strong>旧系统：</strong> 均值 60%、22%、12%</th><th><strong>云原生系统：均值</strong> <strong>90%、45%、22%</strong></th></tr></thead><tbody><tr><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/10ec8c94e23247a4b8ea5354a1c1ef25~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771394166&amp;x-signature=OJRQv9ekBUtwxwZTSPwtWv3TbEY%3D" alt="" loading="lazy"/>﻿</td><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/29141fb6524041159cdd432f0d691b65~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771394166&amp;x-signature=Gv7KDeUds74lxu9IDyxGJV%2FaV90%3D" alt="" loading="lazy"/>﻿</td></tr></tbody></table>
<h4 data-id="heading-12">3. 全场景自动弹性伸缩</h4>
<p><strong>问题</strong>：夜间或周末的流量低谷期GPU资源闲置严重。 <strong>方案</strong>：通过多种弹性部署模式并基于排队长度与KV使用率等多项指标，实现全场景自动扩缩容。</p>
<p><strong>收益</strong>：</p>
<p>•周级别节省GPU卡时5000+，资源利用率提升26%；</p>
<p>﻿</p>











<table><thead><tr><th><strong>占用卡量：</strong> 随负载 弹性扩缩</th></tr></thead><tbody><tr><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3e58737ac7374cbb9db0d3da51fbe432~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771394166&amp;x-signature=n04xSf2fVdA8K7dkXMZXmor4Vu8%3D" alt="" loading="lazy"/>﻿</td></tr></tbody></table>
<p>﻿</p>
<h4 data-id="heading-13">4. 硬件拓扑亲和调度</h4>
<p><strong>问题</strong>：跨交换机部署导致性能下降；人工修正部署成本高，维护压力大。 <strong>方案</strong>：</p>
<p>•通过节点标签与亲和性规则，实现交换机级自动拓扑亲和调度；</p>
<p>•Router实现按组进行PD配对流量调度。</p>
<p><strong>收益</strong>：</p>
<p>•组容器间通信不跨交换机，数据高效传输，全程自动化，无需人工干预，保证服务SLA。</p>
<p>﻿</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4d57abde5162461a8021ea43c15c6536~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771394166&amp;x-signature=%2FHwd%2FaprWnkOJutGGyF%2FV4JjMQg%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>﻿</p>
<h4 data-id="heading-14"><strong>5. 稳定性与业务连续性</strong></h4>
<p><strong>问题：</strong> 容器故障后，因分发机制导致持续的客户影响。故障恢复强依赖人工，导致故障时间长，修复难度大。</p>
<p><strong>方案：</strong> 通过实时健康监测，快速感知故障容器，进行隔离。启动新副本，实现故障自愈。</p>
<p><strong>收益：</strong></p>
<p>•实现自动隔离，自动自愈，无需人工干预，节点人力成本，提高用户体验。</p>
<p>﻿</p>
<p>﻿</p>
<h4 data-id="heading-15"><strong>6.推理引擎无感接入</strong></h4>
<p><strong>问题</strong>：多引擎支持成本高，定制化开发量大，维护成本高。 <strong>方案</strong>：构建统一推理引擎调度接入层，支持vLLM、SGLang等不同推理引擎一键接入。</p>
<p><strong>收益：</strong></p>
<p>•推理引擎无感快速接入。</p>
<p>•降低开发与维护成本。</p>
<p>﻿</p>
<p>﻿</p>
<h2 data-id="heading-16">三、收益总结</h2>
<p>京东云云原生AI推理框架通过多维度调度与系统级优化，显著提升了推理效率与资源利用率。短文与长文吞吐均有大幅增长，首 token 延迟明显降低，并结合自动弹性扩缩容与 KV Cache 感知调度，进一步提升集群吞吐与缓存命中率，同时节省可观的 GPU 卡时成本。在此基础上，引入硬件拓扑亲和调度，实现更高效的自动化部署与调度，降低大规模集群运维压力；配合故障自愈、高可用机制与更精细的可观测体系，使系统运行更加稳定、可控、易排障。通过针对引擎瓶颈的持续优化，不同模型场景下的吞吐能力均得到明显增强。</p>





































<table><thead><tr><th><strong>能力</strong></th><th><strong>量化结果与效益</strong></th></tr></thead><tbody><tr><td>长短文调度</td><td>吞吐：短文提升120%+，长文提升30%+ TTFT：短文降低90%</td></tr><tr><td>自动弹性扩缩容</td><td>GPU卡时：节省GPU卡时约26%</td></tr><tr><td>KV Cache感知调度</td><td>提升KV Cache命中率：增长约20%~30% TTFT：降低29% 集群吞吐：增长30%</td></tr><tr><td>硬件拓扑亲和调度</td><td>实现自动化部署与调度，降低大规模集群运维成本</td></tr><tr><td>故障自愈与高可用</td><td>自动检测故障、自动恢复故障，减少对人工的依赖，更具可控性</td></tr><tr><td>可观测性</td><td>具备更细致的监控告警体系、提升故障发现和排查效率</td></tr><tr><td>引擎瓶颈优化</td><td>DS-MoE模型吞吐提升9%，多模态模型吞吐最高提升39%</td></tr></tbody></table>
<h2 data-id="heading-17">四、客户案例</h2>
<h3 data-id="heading-18">客户背景</h3>
<p>客户原系统面临AI规模化落地的挑战，在推理系统的稳定性、性能和资源利用率方面遇到了明显瓶颈。京东云通过帮助客户升级至云原生架构，成功改造了其推理系统，实现显著的性能提升和资源节约。见证了新系统如何带来切实的业务效益。</p>
<h3 data-id="heading-19">解决方案</h3>
<p>京东云通过<strong>云原生AI推理框架</strong>对客户原78台节点进行逐步云原生改造，在不到一个月时间内从最初的2%切流比率提升到达到40%，实现对用户AI推理系统的云原生重构，助力企业实现高效、稳定、低成本的AI规模化落地。<strong>核心方案</strong>包括：采用<strong>智能流量调度</strong>技术，通过长短文分桶、KV缓存复用及拓扑感知调度；基于流量波动的<strong>弹性扩缩容</strong>机制；<strong>高可用架构</strong>通过多副本部署与故障自愈保障服务连续性；支持vLLM、SGLang等主流引擎的<strong>无感接入</strong>；<strong>硬件拓扑优化</strong>实现跨交换机亲和调度，减少传输延迟。</p>
<p>﻿</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/00fc57a906b946b28d052e22ca8d6f93~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771394166&amp;x-signature=%2BkNi2dKr2DPXT%2FS8Zaq2LGEcH5A%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<h3 data-id="heading-20">客户收益</h3>
<p>﻿</p>
<p>•<strong>GPU吞吐能力</strong>：切换云原生系统后，GPU吞吐提升幅度达74%。这一增强使客户在高负载情况下依然能够维持高效的模型推理速度。</p>
<p>•<strong>限流数量</strong>：云原生AI推理框架系统将需要限流的请求显著减少82%，这意味着更多的客户请求在高峰时段得到及时响应，提高了用户体验和满意度。</p>















































<table><thead><tr><th>﻿</th><th><strong>整体</strong></th><th><strong>旧版系统</strong></th><th><strong>云原生系统</strong></th><th><strong>收益</strong></th></tr></thead><tbody><tr><td><strong>机器规模</strong></td><td>78 (100%)</td><td><strong>50 (64%)</strong></td><td><strong>28 (36%)</strong></td><td><strong>-</strong></td></tr><tr><td><strong>请求数量</strong></td><td>36671 (100%)</td><td><strong>17091 (47%)</strong></td><td><strong>19580 (53%)</strong></td><td><strong>-</strong></td></tr><tr><td><strong>GPU吞吐</strong> <strong>(TGS)</strong></td><td>-</td><td><strong>183</strong></td><td><strong>319</strong></td><td><strong>提升74%</strong></td></tr><tr><td><strong>限流数量</strong></td><td>687 ( 1.87%)</td><td><strong>570 (3.3%)</strong></td><td><strong>117 (0.59%)</strong></td><td><strong>减少82%</strong></td></tr><tr><td>备注： 1、数据来源基于Kimi-K2-instruct-0905模型。</td><td/><td/><td/><td/></tr></tbody></table>
<p>客户对于系统的云原生改造表示高度认可：“云原生AI系统的导入，让我们不仅在资源利用上实现了显著的性价比提升，同时在关键业务高峰期的响应能力也大大增强，显著减少了因限流带来的服务瓶颈问题。”</p>
<p>﻿</p>
<p>﻿</p>
<h2 data-id="heading-21">五、未来展望</h2>
<p>京东云将继续优化<strong>云原生AI推理框架</strong>，致力于为客户提供更智能、高效、稳定的AI基础设施。通过在各个行业和应用场景中的深化应用，我们的客户可以持续依赖这一平台，实现业务的长期可持续发展。</p>
<p>这个成功案例不仅展示了京东云<strong>云原生AI推理框架</strong>系统的技术优势，也为其他企业提供了一个可借鉴的成功模型，期待更多客户从中获益。</p>
<p>京东云云原生AI推理框架的研发升级并非一蹴而就。从架构设计、配置调试再到全量上线，每一步都围绕着<strong>业务价值、性能提升与运维提效</strong>展开。我们相信，只有将稳定性、性能、成本三者统筹兼顾的基础设施，才能真正支撑AI业务规模化、可持续地落地与增长。如您有类似场景或技术交流需求，欢迎随时联系我们。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Agent Skills与MCP：一场被误解的"替代战争"]]></title>    <link>https://juejin.cn/post/7605105527257808896</link>    <guid>https://juejin.cn/post/7605105527257808896</guid>    <pubDate>2026-02-11T05:58:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605105527257808896" data-draft-id="7605105527257792512" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Agent Skills与MCP：一场被误解的&quot;替代战争&quot;"/> <meta itemprop="keywords" content="程序员"/> <meta itemprop="datePublished" content="2026-02-11T05:58:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="京东云开发者"/> <meta itemprop="url" content="https://juejin.cn/user/2634854380340008"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Agent Skills与MCP：一场被误解的"替代战争"
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2634854380340008/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    京东云开发者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-11T05:58:05.000Z" title="Wed Feb 11 2026 05:58:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读19分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作者：牛潇</p>
<p>在 Agentic AI 快速演进的今天，“Agent Skills 会取代 MCP”或“MCP 已经过时”的声音不绝于耳。这种二元对立的叙事，看似犀利，实则掩盖了智能体架构设计中最本质的真相：<strong>Agent Skills 与 MCP 并非对手，而是搭档</strong>。</p>
<p>﻿</p>
<p>前者是人类智慧的结晶——将业务规则、决策逻辑与合规要求，以声明式、可读、可维护的方式注入 AI 代理；后者是技术能力的桥梁——让 AI 能安全、可靠地触达现实世界的数据、工具与系统。一个回答“怎么做才对”，一个解决“能不能做”；一个由产品经理和业务专家驱动，一个由工程师和 SRE 构建。</p>
<p>﻿</p>
<p>本文旨在彻底厘清二者的核心差异、适用边界与协同模式。我们将从概念定义出发，深入实现机制，通过多维对比与真实场景剖析，最终给出一套可落地的选择策略与高阶架构范式。无论你是智能体开发者、平台架构师，还是正在规划 AI 原生应用的产品负责人，都能从中获得清晰的判断框架与实践指引。</p>
<p>﻿</p>
<p>更重要的是，我们将证明：<strong>真正的智能，不在于选择某一种工具，而在于知道何时用哪一种，以及如何让它们共舞</strong>。</p>
<p>﻿</p>
<h2 data-id="heading-0">一、核心概念定义：超越实现的标准</h2>
<h3 data-id="heading-1">1.1 Model Context Protocol (MCP) - 模型上下文协议</h3>
<p><strong>本质定义</strong>：MCP是一种<strong>标准化通信协议</strong>，定义了AI模型如何与外部系统建立安全、高效、可审计的双向连接。</p>
<p><strong>核心特性</strong>：</p>
<p>•<strong>能力扩展协议</strong>：为AI代理提供访问实时数据、专业工具和企业系统的标准化接口</p>
<p>•<strong>安全沙箱规范</strong>：在协议层面定义权限控制、数据隔离和操作审计机制</p>
<p>•<strong>上下文同步机制</strong>：解决模型内部状态与外部世界状态的一致性问题</p>
<p>•<strong>标准化接口</strong>：通过JSON-RPC或其他标准协议定义请求/响应格式、认证机制和错误处理</p>
<p>•<strong>服务化架构</strong>：协议设计支持独立部署的服务进程，实现高可用和水平扩展</p>
<p><strong>架构定位</strong>：MCP解决了 <strong>"能不能做"</strong> 的问题 (Capability)，为AI代理扩展其原始训练数据范围之外的能力边界。</p>
<h3 data-id="heading-2">1.2 Agent Skills - 代理技能标准</h3>
<p><strong>本质定义</strong>：Agent Skills是一种<strong>模块化能力封装标准</strong>，通过声明式、配置化的方式定义AI代理在特定场景下的行为规范、决策逻辑和工作流程。</p>
<p><strong>核心特性</strong>：</p>
<p>•<strong>流程编排标准</strong>：定义如何将原子操作组合成完整业务流程的标准</p>
<p>•<strong>上下文感知能力</strong>：标准定义了技能如何根据对话历史和环境动态调整行为</p>
<p>•<strong>透明可解释性</strong>：决策路径对人类可见，便于理解和修改</p>
<p>•<strong>轻量级集成</strong>：标准设计支持无服务部署，修改配置即可生效</p>
<p>•<strong>组合式架构</strong>：支持技能的嵌套、组合和复用</p>
<p><strong>架构定位</strong>：Agent Skills解决了 <strong>"怎么做才对"</strong> 的问题 (Orchestration)，为AI代理编写符合业务标准和人类期望的行为规范。</p>
<p>﻿</p>
<h2 data-id="heading-3">二、设计哲学与架构差异</h2>
<h3 data-id="heading-4">2.1 MCP：能力导向的设计</h3>
<p>MCP的核心设计哲学是<strong>能力扩展</strong>。它关注：</p>
<p>•<strong>原子操作</strong>：如何安全地执行单一、精确的操作</p>
<p>•<strong>连接管理</strong>：如何高效管理与外部系统的连接</p>
<p>•<strong>权限边界</strong>：如何在协议层面实现细粒度权限控制</p>
<p>•<strong>数据标准化</strong>：如何统一不同数据源的格式和语义</p>
<p>MCP的架构本质上是<strong>服务化</strong>的：</p>
<p>﻿</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0a6202c376224e88854aa2226fef8005~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771394286&amp;x-signature=eOC3IaN8IIikdH9IBcWIYk2MosU%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<h3 data-id="heading-5">2.2 Agent Skills：流程导向的设计</h3>
<p>Agent Skills的核心设计哲学是<strong>业务价值</strong>。它关注：</p>
<p>•<strong>决策逻辑</strong>：在特定情境下如何做出正确决策</p>
<p>•<strong>流程规范</strong>：如何将多个操作组合成符合业务标准的流程</p>
<p>•<strong>上下文适应</strong>：如何根据环境变化动态调整行为</p>
<p>•<strong>人类协作</strong>：如何使AI行为可理解、可预测、可修正</p>
<p>Agent Skills的架构本质上是<strong>声明式</strong>的：</p>
<p>﻿</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dde9d004f9d14ec19e92bfd06d6fe2e7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771394286&amp;x-signature=yv6Z2ffwBmsxUI0vcLqD3jzcU48%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<h2 data-id="heading-6">﻿</h2>
<h2 data-id="heading-7">三、多维度对比分析</h2>




























































<table><thead><tr><th>维度</th><th>Agent Skills</th><th>MCP</th></tr></thead><tbody><tr><td><strong>协议/标准类型</strong></td><td>声明式配置标准 (Declarative)</td><td>通信协议标准 (Imperative)</td></tr><tr><td><strong>核心关注点</strong></td><td>业务流程与决策逻辑 (What &amp; Why)</td><td>能力执行与数据获取 (How &amp; Can)</td></tr><tr><td><strong>抽象层级</strong></td><td>业务逻辑层 (Business Logic Layer)</td><td>能力扩展层 (Capability Layer)</td></tr><tr><td><strong>数据流向</strong></td><td>自顶向下 (决策驱动)</td><td>自底向上 (能力驱动)</td></tr><tr><td><strong>变更频率</strong></td><td>高 (业务规则经常变化)</td><td>低 (接口相对稳定)</td></tr><tr><td><strong>维护主体</strong></td><td>业务专家、领域专家</td><td>工程师、系统管理员</td></tr><tr><td><strong>安全模型</strong></td><td>软约束 (依赖执行引擎的策略)</td><td>硬约束 (协议层强制控制)</td></tr><tr><td><strong>性能特性</strong></td><td>低延迟 (纯逻辑决策)</td><td>可变延迟 (依赖外部系统)</td></tr><tr><td><strong>复用模式</strong></td><td>领域特定复用</td><td>跨领域通用复用</td></tr><tr><td><strong>标准化程度</strong></td><td>高 (结构化配置)</td><td>高 (协议规范)</td></tr></tbody></table>
<h2 data-id="heading-8">﻿</h2>
<h2 data-id="heading-9">四、核心区别总结</h2>
<h3 data-id="heading-10">4.1 本质差异</h3>
<blockquote>
<p><strong>Agent Skills定义业务价值路径，MCP实现技术能力扩展</strong></p>
</blockquote>
<p>•<strong>Agent Skills关注"为什么"和"如何"</strong> ：</p>
<p>◦为什么这个任务对业务有价值？</p>
<p>◦如何确保任务按照业务标准和合规要求完成？</p>
<p>◦如何在不同业务情境下动态调整决策逻辑？</p>
<p>◦其设计哲学是以业务为中心，将人类专业知识编码为AI可执行的规范</p>
<p>•<strong>MCP关注"什么"和"能否"</strong> ：</p>
<p>◦需要访问什么外部数据或工具？</p>
<p>◦AI能否安全、可靠地执行这个具体操作？</p>
<p>◦如何在协议层面实现权限控制和数据隔离？</p>
<p>◦其设计哲学是以能力为中心，解决AI与现实世界连接的技术问题</p>
<h3 data-id="heading-11">4.2 架构隐喻</h3>
<p>•<strong>Agent Skills如同"企业SOP手册"</strong> ：</p>
<p>◦详细描述每个业务流程的标准步骤</p>
<p>◦规定在特定情境下的决策规则</p>
<p>◦可由非技术人员编写和维护</p>
<p>◦随业务需求灵活调整</p>
<p>•<strong>MCP如同"企业IT基础设施"</strong> ：</p>
<p>◦提供基础数据访问和计算能力</p>
<p>◦确保系统安全性和可靠性</p>
<p>◦需要专业技术团队维护</p>
<p>◦变更需要严格测试和审批流程</p>
<h2 data-id="heading-12">﻿</h2>
<h2 data-id="heading-13">五、场景示例对比：标准应用与实际落地</h2>
<h3 data-id="heading-14">5.1 场景一：客户服务工单处理</h3>
<p><strong>需求</strong>：自动处理客户支持工单，需要理解客户意图、查询相关数据、生成适当回复。</p>
<p><strong>Agent Skills标准应用</strong>（业务流程编排）：</p>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-symbol">skill:</span>
  name: <span class="hljs-string">"customer_ticket_processing"</span>
  trigger: 
    <span class="hljs-keyword">event</span>: <span class="hljs-string">"new_ticket_created"</span>
  workflow:
    steps:
      - name: <span class="hljs-string">"intent_classification"</span>
        description: <span class="hljs-string">"识别客户工单类型"</span>
        rules:
          - <span class="hljs-string">"如果包含'退款'、'钱'等关键词，标记为财务类"</span>
          - <span class="hljs-string">"如果包含'无法登录'、'错误'，标记为技术类"</span>
          - <span class="hljs-string">"如果包含'多久'、'什么时候'，标记为咨询类"</span>
      
      - name: <span class="hljs-string">"data_requirements"</span>
        description: <span class="hljs-string">"确定需要查询的数据"</span>
        conditional:
          <span class="hljs-keyword">if</span>: <span class="hljs-string">"ticket_type == 'financial'"</span>
          <span class="hljs-keyword">then</span>: [<span class="hljs-string">"mcp_order_history"</span>, <span class="hljs-string">"mcp_payment_records"</span>]
          elif: <span class="hljs-string">"ticket_type == 'technical'"</span>
          <span class="hljs-keyword">then</span>: [<span class="hljs-string">"mcp_user_activity"</span>, <span class="hljs-string">"mcp_system_logs"</span>]
      
      - name: <span class="hljs-string">"response_generation"</span>
        description: <span class="hljs-string">"生成符合品牌标准的回复"</span>
        prompt_template: |
          你是一个专业客服代表，遵循以下规则：
          <span class="hljs-number">1</span>. 使用友好、专业的语气
          <span class="hljs-number">2</span>. 对于财务问题，必须提供具体金额和时间
          <span class="hljs-number">3</span>. 对于技术问题，提供具体解决方案而不是模糊建议
          <span class="hljs-number">4</span>. 如无法解决，明确升级路径
        constraints:
          - <span class="hljs-string">"不得承诺无法确认的信息"</span>
          - <span class="hljs-string">"必须引用数据支持你的结论"</span>
</code></pre>
<p><strong>为什么适用Agent Skills</strong>：</p>
<p>•✅<strong>业务规则复杂</strong>：需要根据多种条件动态调整处理流程</p>
<p>•✅<strong>合规要求高</strong>：必须遵循特定的沟通标准和数据使用规范</p>
<p>•✅<strong>频繁变更</strong>：客户政策和响应标准经常变化</p>
<p>•❌<strong>不适合MCP</strong>：这不是原子操作，而是需要上下文感知的决策流程</p>
<hr/>
<p>﻿</p>
<p><strong>MCP标准应用</strong>（能力提供）：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomerDataMCP</span>:
<span class="hljs-meta">    @mcp_tool(<span class="hljs-params">permission=<span class="hljs-string">"read_only"</span></span>)</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_order_history</span>(<span class="hljs-params">self, customer_id, limit=<span class="hljs-number">10</span></span>):
        <span class="hljs-string">"""安全获取客户订单历史"""</span>
        <span class="hljs-comment"># 从订单数据库获取数据</span>
        orders = self.order_db.query(
            <span class="hljs-string">"SELECT order_id, amount, status, created_at FROM orders WHERE customer_id=? ORDER BY created_at DESC LIMIT?"</span>,
            [customer_id, limit]
        )
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">"orders"</span>: orders,
            <span class="hljs-string">"total_count"</span>: self.order_db.count(<span class="hljs-string">"orders"</span>, {<span class="hljs-string">"customer_id"</span>: customer_id})
        }
    
<span class="hljs-meta">    @mcp_tool(<span class="hljs-params">permission=<span class="hljs-string">"read_only"</span></span>)</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_system_status</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""获取系统当前状态"""</span>
        <span class="hljs-comment"># 从监控系统获取实时状态</span>
        <span class="hljs-keyword">return</span> self.monitoring_api.get_current_status()
    
<span class="hljs-meta">    @mcp_tool(<span class="hljs-params">permission=<span class="hljs-string">"write"</span></span>)</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">create_support_note</span>(<span class="hljs-params">self, ticket_id, note_content, agent_id</span>):
        <span class="hljs-string">"""创建客服备注，需要写权限"""</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> self.auth.has_permission(agent_id, <span class="hljs-string">"support_write"</span>):
            <span class="hljs-keyword">raise</span> PermissionError(<span class="hljs-string">"Insufficient permissions"</span>)
        <span class="hljs-keyword">return</span> self.support_db.insert_note(ticket_id, note_content, agent_id)
</code></pre>
<p><strong>为什么适用MCP</strong>：</p>
<p>•✅<strong>数据敏感性</strong>：涉及客户个人数据，需要严格的权限控制</p>
<p>•✅<strong>跨系统集成</strong>：需要连接订单系统、监控系统和客服系统</p>
<p>•✅<strong>结构化输出</strong>：需要统一的数据格式，避免文本解析歧义</p>
<p>•❌<strong>不适合Agent Skills</strong>：这不是业务决策，而是需要安全控制的原子操作</p>
<h3 data-id="heading-15">5.2 场景二：金融风险评估</h3>
<p><strong>需求</strong>：为贷款申请提供风险评估，需要综合多源数据、应用复杂模型、生成合规报告。</p>
<p><strong>Agent Skills标准应用</strong>（决策规则与合规性）：</p>
<pre><code class="hljs language-bash" lang="bash">skill:
  name: <span class="hljs-string">"loan_risk_assessment"</span>
  trigger: 
    event: <span class="hljs-string">"loan_application_received"</span>
  workflow:
    compliance_rules:
      - <span class="hljs-string">"必须检查申请者年龄是否≥18岁"</span>
      - <span class="hljs-string">"必须验证收入证明真实性"</span>
      - <span class="hljs-string">"禁止基于种族、性别等因素做决策"</span>
      - <span class="hljs-string">"超过<span class="hljs-variable">$100</span>,000的贷款必须人工审核"</span>
    
    assessment_steps:
      1. <span class="hljs-string">"data_collection"</span>:
           tools: [<span class="hljs-string">"mcp_credit_report"</span>, <span class="hljs-string">"mcp_income_verification"</span>, <span class="hljs-string">"mcp_employment_history"</span>]
      
      2. <span class="hljs-string">"risk_calculation"</span>:
           description: <span class="hljs-string">"应用公司标准风险模型"</span>
           rules:
             - <span class="hljs-string">"信用分&lt;600：高风险"</span>
             - <span class="hljs-string">"负债收入比&gt;50%：中高风险"</span>
             - <span class="hljs-string">"就业历史&lt;2年：中风险"</span>
      
      3. <span class="hljs-string">"decision_logic"</span>:
           rules:
             - <span class="hljs-string">"如果高风险因素≥2，拒绝贷款"</span>
             - <span class="hljs-string">"如果中风险因素≥3，要求额外担保"</span>
             - <span class="hljs-string">"否则，批准贷款但限制额度"</span>
      
      4. <span class="hljs-string">"report_generation"</span>:
           template: |
             <span class="hljs-comment"># 贷款风险评估报告</span>
             **申请人**: {applicant_name}
             **申请金额**: <span class="hljs-variable">${loan_amount}</span>
             
             <span class="hljs-comment">## 风险因素分析</span>
             {risk_factors_section}
             
             <span class="hljs-comment">## 决策依据</span>
             {decision_rationale}
             
             <span class="hljs-comment">## 合规声明</span>
             本评估严格遵循[相关法规]，未考虑受保护特征。
</code></pre>
<p><strong>为什么适用Agent Skills</strong>：</p>
<p>•✅<strong>合规驱动</strong>：需要严格遵循金融法规和内部政策</p>
<p>•✅<strong>决策复杂</strong>：需要权衡多个风险因素并应用业务规则</p>
<p>•✅<strong>审计要求</strong>：需要完整的决策路径记录和解释</p>
<p>•❌<strong>不适合MCP</strong>：这不是技术实现问题，而是业务决策逻辑</p>
<hr/>
<p>﻿</p>
<p><strong>MCP标准应用</strong>（数据获取与模型执行）：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">FinancialRiskMCP</span>:
<span class="hljs-meta">    @mcp_tool(<span class="hljs-params">permission=<span class="hljs-string">"sensitive_data"</span></span>)</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_credit_report</span>(<span class="hljs-params">self, applicant_id</span>):
        <span class="hljs-string">"""获取信用报告，处理敏感数据"""</span>
        <span class="hljs-comment"># 通过安全通道调用外部信用机构API</span>
        report = self.credit_api.get_report(applicant_id)
        <span class="hljs-comment"># 数据脱敏处理</span>
        <span class="hljs-keyword">return</span> self._sanitize_sensitive_data(report)
    
<span class="hljs-meta">    @mcp_tool(<span class="hljs-params">permission=<span class="hljs-string">"model_execution"</span></span>)</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">run_risk_model</span>(<span class="hljs-params">self, features</span>):
        <span class="hljs-string">"""执行风险评估模型"""</span>
        <span class="hljs-comment"># 加载预训练的风险评估模型</span>
        model = self.model_registry.get(<span class="hljs-string">"risk-assessment-v3"</span>)
        <span class="hljs-comment"># 特征工程和预测</span>
        processed_features = self._preprocess_features(features)
        prediction = model.predict(processed_features)
        <span class="hljs-comment"># 生成可解释的模型输出</span>
        explanation = self.explainer.generate_explanation(model, processed_features)
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">"risk_score"</span>: prediction,
            <span class="hljs-string">"confidence"</span>: model.confidence_score,
            <span class="hljs-string">"key_factors"</span>: explanation.top_factors
        }
    
<span class="hljs-meta">    @mcp_tool(<span class="hljs-params">permission=<span class="hljs-string">"document_generation"</span></span>)</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">generate_compliance_report</span>(<span class="hljs-params">self, assessment_data</span>):
        <span class="hljs-string">"""生成合规的审计报告"""</span>
        <span class="hljs-comment"># 应用合规模板</span>
        report = self.report_template.render(assessment_data)
        <span class="hljs-comment"># 添加数字签名</span>
        signed_report = self.crypto.sign_document(report)
        <span class="hljs-comment"># 存档到审计系统</span>
        self.audit_system.archive(signed_report)
        <span class="hljs-keyword">return</span> signed_report
</code></pre>
<p><strong>为什么适用MCP</strong>：</p>
<p>•✅<strong>数据安全</strong>：涉及敏感金融数据，需要严格的访问控制</p>
<p>•✅<strong>专业模型</strong>：需要调用专门的风险评估模型</p>
<p>•✅<strong>审计追踪</strong>：需要完整的操作日志和数字签名</p>
<p>•❌<strong>不适合Agent Skills</strong>：这不是业务规则，而是需要安全控制的技术操作</p>
<h3 data-id="heading-16">5.3 场景三：实际落地案例 - Claude Code 中的自动化部署</h3>
<p><strong>需求</strong>：在软件开发项目中，实现自动化部署流程，包括运行测试、构建和部署到生产环境。</p>
<p>这是一个已在<strong>Claude Code</strong>中实际落地的场景，完美展现了 MCP 与 Skills 的协同工作模式。</p>
<h4 data-id="heading-17">MCP 层实现：提供原子能力</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># mcp_deployment_server.py</span>
<span class="hljs-keyword">from</span> mcp_server <span class="hljs-keyword">import</span> MCPServer, mcp_tool

<span class="hljs-keyword">class</span> <span class="hljs-title class_">DeploymentMCP</span>(<span class="hljs-title class_ inherited__">MCPServer</span>):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, config</span>):
        <span class="hljs-built_in">super</span>().__init__()
        self.config = config
        self._setup_connections()
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_setup_connections</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""建立必要的系统连接"""</span>
        self.ci_connection = self._connect_to_ci_system()
        self.s3_client = self._setup_s3_client()
    
<span class="hljs-meta">    @mcp_tool()</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">run_tests</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""
        运行项目测试套件
        返回结构化的测试结果
        """</span>
        <span class="hljs-comment"># 通过CI系统API触发测试</span>
        test_result = self.ci_connection.run_pipeline(<span class="hljs-string">"test"</span>)
        
        <span class="hljs-comment"># 返回结构化结果</span>
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">"success"</span>: test_result[<span class="hljs-string">"status"</span>] == <span class="hljs-string">"passed"</span>,
            <span class="hljs-string">"total_tests"</span>: test_result[<span class="hljs-string">"total"</span>],
            <span class="hljs-string">"failed_tests"</span>: test_result[<span class="hljs-string">"failed"</span>],
            <span class="hljs-string">"duration_ms"</span>: test_result[<span class="hljs-string">"duration"</span>]
        }
    
<span class="hljs-meta">    @mcp_tool(<span class="hljs-params">permission=<span class="hljs-string">"deployment_write"</span></span>)</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">upload_to_s3</span>(<span class="hljs-params">self, environment=<span class="hljs-string">"production"</span></span>):
        <span class="hljs-string">"""
        将构建产物上传到S3
        需要部署权限
        """</span>
        <span class="hljs-comment"># 验证环境</span>
        <span class="hljs-keyword">if</span> environment <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> [<span class="hljs-string">"staging"</span>, <span class="hljs-string">"production"</span>]:
            <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">"Invalid environment"</span>)
        
        <span class="hljs-comment"># 获取最新构建产物</span>
        build_artifact = self.ci_connection.get_latest_build_artifact()
        
        <span class="hljs-comment"># 上传到S3</span>
        bucket_name = <span class="hljs-string">f"myapp-<span class="hljs-subst">{environment}</span>-bucket"</span>
        key = <span class="hljs-string">f"builds/<span class="hljs-subst">{build_artifact[<span class="hljs-string">'version'</span>]}</span>/<span class="hljs-subst">{build_artifact[<span class="hljs-string">'filename'</span>]}</span>"</span>
        
        self.s3_client.upload_file(
            build_artifact[<span class="hljs-string">'local_path'</span>],
            bucket_name,
            key
        )
        
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">"status"</span>: <span class="hljs-string">"success"</span>,
            <span class="hljs-string">"bucket"</span>: bucket_name,
            <span class="hljs-string">"key"</span>: key,
            <span class="hljs-string">"url"</span>: <span class="hljs-string">f"https://<span class="hljs-subst">{bucket_name}</span>.s3.amazonaws.com/<span class="hljs-subst">{key}</span>"</span>
        }
</code></pre>
<p><strong>MCP 层关键价值</strong>：</p>
<p>•✅<strong>安全封装</strong>：敏感凭证（S3密钥、CI系统令牌）完全封装在服务内部</p>
<p>•✅<strong>标准化接口</strong>：提供统一的输入/输出格式，便于调用</p>
<p>•✅<strong>错误处理</strong>：在服务层处理网络错误、超时等异常情况</p>
<p>•✅<strong>权限控制</strong>：通过<code>@mcp_tool(permission="deployment_write")</code>严格控制部署权限</p>
<h4 data-id="heading-18">Skills 层实现：定义业务流程</h4>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># CLAUDE.md (项目根目录)</span>

<span class="hljs-section">## Skill: 代码部署 (Deploy)</span>

 <span class="hljs-strong">**触发条件**</span> ：用户要求"deploy"、"部署"、"上线"或相关操作

 <span class="hljs-strong">**执行流程**</span> ：
<span class="hljs-bullet">1.</span>  <span class="hljs-strong">**运行测试**</span> ：
<span class="hljs-bullet">   -</span> 首先调用 MCP 工具 <span class="hljs-code">`run_tests`</span>
<span class="hljs-bullet">   -</span> 如果返回失败，立即停止并报错："测试未通过，无法部署"
<span class="hljs-bullet">   -</span> 不要继续执行后续步骤
<span class="hljs-bullet">   -</span> 具体失败原因：{failed<span class="hljs-emphasis">_tests} 个测试失败

2.  <span class="hljs-strong">**执行上传**</span> ：
   - 如果测试通过，调用 MCP 工具 `upload_</span>to<span class="hljs-emphasis">_s3`
   - 参数设置：
     - environment: "production"（生产环境）
   - 等待上传完成确认
   - 验证返回的S3 URL是否可访问

3.  <span class="hljs-strong">**验证部署**</span> ：
   - 访问部署后的URL进行健康检查
   - 确认关键功能是否正常工作
   - 如果验证失败，触发回滚流程

4.  <span class="hljs-strong">**报告结果**</span> ：
   - 用简洁的语言总结部署结果
   - 包含关键信息：部署时间、版本号、S3 URL
   - 如果有问题，提供具体的错误信息和建议

 <span class="hljs-strong">**安全规则**</span> ：
- 永远不要直接在生产环境执行未经测试的代码
- 任何破坏性操作（如数据库迁移）必须先询问用户确认
- 部署前必须备份当前版本
- 生产环境部署必须获得至少一名资深工程师的批准
</span></code></pre>
<p><strong>Skills 层关键价值</strong>：</p>
<p>•✅<strong>业务逻辑清晰</strong>：用自然语言描述完整的部署流程，易于理解和修改</p>
<p>•✅<strong>灵活调整</strong>：业务规则变化时（如添加预发布环境），只需修改配置</p>
<p>•✅<strong>团队协作</strong>：非工程师（如产品经理、QA）也能理解并参与优化流程</p>
<p>•✅<strong>透明决策</strong>：用户可以看到完整的推理过程，增强信任</p>
<h4 data-id="heading-19">协同工作流程</h4>
<pre><code class="hljs language-javascript" lang="javascript">用户请求：<span class="hljs-string">"部署最新版本到生产环境"</span>

<span class="hljs-number">1.</span> <span class="hljs-title class_">Claude</span> 检测到<span class="hljs-string">"部署"</span>关键词，激活 <span class="hljs-string">"代码部署 (Deploy)"</span> <span class="hljs-title class_">Skill</span>
<span class="hljs-number">2.</span> <span class="hljs-title class_">Skill</span> 定义第一步：运行测试
   → 调用 <span class="hljs-variable constant_">MCP</span> 工具 <span class="hljs-string">`run_tests`</span>
   ← <span class="hljs-variable constant_">MCP</span> 返回：{<span class="hljs-string">"success"</span>: <span class="hljs-literal">true</span>, <span class="hljs-string">"total_tests"</span>: <span class="hljs-number">125</span>, <span class="hljs-string">"failed_tests"</span>: <span class="hljs-number">0</span>}
<span class="hljs-number">3.</span> <span class="hljs-title class_">Skill</span> 检查测试结果，判定通过
<span class="hljs-number">4.</span> <span class="hljs-title class_">Skill</span> 定义第二步：执行上传
   → 调用 <span class="hljs-variable constant_">MCP</span> 工具 <span class="hljs-string">`upload_to_s3`</span> <span class="hljs-keyword">with</span> {<span class="hljs-string">"environment"</span>: <span class="hljs-string">"production"</span>}
   ← <span class="hljs-variable constant_">MCP</span> 返回：{
        <span class="hljs-string">"status"</span>: <span class="hljs-string">"success"</span>, 
        <span class="hljs-string">"bucket"</span>: <span class="hljs-string">"myapp-production-bucket"</span>,
        <span class="hljs-string">"key"</span>: <span class="hljs-string">"builds/v2.3.1/app-bundle.zip"</span>,
        <span class="hljs-string">"url"</span>: <span class="hljs-string">"https://myapp-production-bucket.s3.amazonaws.com/builds/v2.3.1/app-bundle.zip"</span>
      }
<span class="hljs-number">5.</span> <span class="hljs-title class_">Skill</span> 进行验证和报告
<span class="hljs-number">6.</span> 最终输出：<span class="hljs-string">"✅ 部署成功！版本 v2.3.1 已部署到生产环境，S3 URL: https://..."</span>
</code></pre>
<p><strong>为什么这种分层架构最优</strong>：</p>
<p>•✅<strong>关注点分离</strong>：MCP 专注"如何安全执行"，Skills 专注"如何正确流程"</p>
<p>•✅<strong>变更独立性</strong>：修改部署流程不需要修改 MCP 服务，反之亦然</p>
<p>•✅<strong>复用性</strong>：<code>run_tests</code>和<code>upload_to_s3</code>工具可被其他 Skill 复用</p>
<p>•✅<strong>安全与灵活性平衡</strong>：敏感操作受控，业务逻辑灵活可变</p>
<p><strong>实际工程价值</strong>：</p>
<p>•<strong>开发效率</strong>：新团队成员通过阅读<code>CLAUDE.md</code>即可理解部署流程</p>
<p>•<strong>运维可靠性</strong>：MCP 层的错误处理和重试机制提高了系统稳定性</p>
<p>•<strong>合规保证</strong>：所有部署操作都有完整审计日志</p>
<p>•<strong>快速迭代</strong>：业务流程调整只需修改配置，无需重新部署服务</p>
<h2 data-id="heading-20">﻿</h2>
<h2 data-id="heading-21">六、选择建议与高阶策略</h2>
<h3 data-id="heading-22">6.1 基础决策框架</h3>
<p><strong>优先选择Agent Skills当</strong>： ✅ 业务规则复杂且经常变化：当决策逻辑依赖于业务策略而非技术实现时 ✅ 需要人类可读的规范：当非技术人员需要理解和修改行为规则时 ✅ 涉及主观判断：当任务需要权衡多个因素且没有明确的算法时 ✅ 强调一致性和合规性：当需要确保AI行为符合公司政策或法规要求时 ✅ 快速原型和迭代：当需要快速验证想法而不想投入大量工程资源时</p>
<p><strong>优先选择MCP当</strong>： ✅ 需要访问外部数据源：当任务依赖实时数据、专有系统或敏感信息时 ✅ 性能要求严格：当需要高效处理大量数据或低延迟响应时 ✅ 安全性至关重要：当涉及财务交易、个人隐私或系统关键操作时 ✅ 需要精确控制：当任务要求精确的输入/输出格式或复杂的状态管理时 ✅ 跨系统集成：当需要连接多个不兼容的系统或协议时</p>
<h3 data-id="heading-23">6.2 高阶决策树</h3>
<p>﻿</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/48826f7399b341aca6dc40ca7b474ac2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771394286&amp;x-signature=FekKgVmpmX4%2BXjUHiIrnD6i%2BYaU%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<h3 data-id="heading-24">6.3 经典协同模式</h3>
<p><strong>模式1：分层架构（最常见）</strong></p>
<p>﻿</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0cad3b8b1e8d4be09022b6824332dbe3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771394286&amp;x-signature=h55ewmKAekXxty9teql4EVLqQRw%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p><strong>最佳实践</strong>：</p>
<p>•<strong>Agent Skills负责"为什么"和"做什么"</strong> ：定义业务目标和流程</p>
<p>•<strong>MCP负责"怎么做"</strong> ：提供具体的执行能力</p>
<p>•<strong>严格分离关注点</strong>：避免在Skills中硬编码技术细节，避免在MCP中包含业务规则</p>
<p><strong>模式2：技能驱动型MCP</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">skill:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">"dynamic_mcp_selection"</span>
  <span class="hljs-attr">description:</span> <span class="hljs-string">"根据上下文动态选择最合适的MCP工具"</span>
  <span class="hljs-attr">logic:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">if:</span> <span class="hljs-string">"data_freshness_requirement == 'real-time'"</span>
      <span class="hljs-attr">then:</span> <span class="hljs-string">"use mcp_live_data_feed"</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">if:</span> <span class="hljs-string">"data_volume &gt; 1GB"</span>
      <span class="hljs-attr">then:</span> <span class="hljs-string">"use mcp_batch_processing"</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">if:</span> <span class="hljs-string">"security_classification == 'sensitive'"</span>
      <span class="hljs-attr">then:</span> <span class="hljs-string">"use mcp_encrypted_channel"</span>
</code></pre>
<p><strong>优势</strong>：最大化灵活性，适应复杂多变的业务需求</p>
<p><strong>模式3：MCP增强型技能</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">SkillEnhancementMCP</span>:
<span class="hljs-meta">    @mcp_tool</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_optimal_workflow</span>(<span class="hljs-params">self, task_type, context</span>):
        <span class="hljs-string">"""基于历史数据推荐最佳工作流程"""</span>
        <span class="hljs-comment"># 分析历史任务完成数据</span>
        historical_data = self.analytics_db.get_task_metrics(task_type)
        <span class="hljs-comment"># 应用机器学习模型推荐最优流程</span>
        recommended_workflow = self.recommender.predict_optimal_workflow(
            task_features=context,
            historical_performance=historical_data
        )
        <span class="hljs-keyword">return</span> recommended_workflow
</code></pre>
<p><strong>优势</strong>：利用数据驱动优化技能定义，形成闭环学习系统</p>
<p>﻿</p>
<h2 data-id="heading-25">七、总结与技术展望</h2>
<h3 data-id="heading-26">7.1 核心原则重申</h3>
<p>1.<strong>MCP = 能力扩展 (Capability Extension)</strong> ：解决"能不能做"的问题</p>
<p>2.<strong>Agent Skills = 业务编排 (Business Orchestration)</strong> ：解决"怎么做才对"的问题</p>
<p>3.<strong>协同而非替代</strong>：两者在智能体架构中互补共存，创造最大价值</p>
<h3 data-id="heading-27">7.2 真实工程经验教训</h3>
<p>在多个大型AI系统中，我们观察到以下关键点：</p>
<p><strong>误区1：用MCP实现所有功能</strong></p>
<p>•<strong>症状</strong>：每个小功能都实现为MCP工具</p>
<p>•<strong>后果</strong>：过度工程化，维护成本高，业务逻辑与技术实现耦合</p>
<p>•<strong>解法</strong>：优先评估是否需要外部系统访问或安全控制</p>
<p><strong>误区2：在Agent Skills中硬编码复杂逻辑</strong></p>
<p>•<strong>症状</strong>：Skills配置超过2000行，包含大量条件判断</p>
<p>•<strong>后果</strong>：决策逻辑难以理解和维护，执行不可靠</p>
<p>•<strong>解法</strong>：将复杂逻辑拆分为MCP工具，Skills只负责业务编排</p>
<p><strong>误区3：忽视安全边界</strong></p>
<p>•<strong>症状</strong>：在Skills中暴露敏感操作，在MCP中缺少输入校验</p>
<p>•<strong>后果</strong>：安全漏洞，数据泄露风险</p>
<p>•<strong>解法</strong>：敏感操作始终通过MCP，Skills只包含公开的业务规则</p>
<h3 data-id="heading-28">7.3 未来展望</h3>
<p>随着AI智能体架构的发展，我们观察到以下趋势：</p>
<p>1.<strong>标准化融合</strong>：</p>
<p>◦MCP协议将支持技能描述标准，使能力发现和组合更加自动化</p>
<p>◦Agent Skills标准将内置对MCP能力的语义描述，提升互操作性</p>
<p>2.<strong>动态协同</strong>：</p>
<p>◦智能体将能够根据任务复杂度自动决定使用Skills还是MCP</p>
<p>◦运行时将动态平衡配置驱动和代码驱动的执行路径</p>
<p>3.<strong>开发者体验优化</strong>：</p>
<p>◦统一的开发框架将无缝集成Skills和MCP</p>
<p>◦低代码平台将使业务专家能够定义技能，自动映射到合适的MCP能力</p>
<h2 data-id="heading-29">﻿</h2>
<h2 data-id="heading-30">八、结语：协同共生，而非零和博弈</h2>
<p>在AI技术社区中，经常出现"Skills将取代MCP"或"MCP是过时的技术"等论调。这些观点源于对两者本质的误解，忽视了它们在智能体架构中互补共存的价值。</p>
<p><strong>MCP和Agent Skills不是竞争关系，而是共生关系</strong>：</p>
<p>•MCP扩展了AI的感知和行动能力，使其能够连接现实世界</p>
<p>•Agent Skills定义了AI的思维和决策模式，使其能够按照人类期望的方式行动</p>
<p>将AI智能体视为一个完整的系统：</p>
<p>•<strong>MCP是感官和肢体</strong>：眼睛（数据获取）、耳朵（事件监听）、手（工具执行）</p>
<p>•<strong>Agent Skills是大脑和神经系统</strong>：决策逻辑、行为规范、学习能力</p>
<p>没有感官和肢体，大脑无法感知世界；没有大脑和神经系统，肢体无法协调行动。两者缺一不可。</p>
<p>﻿</p>
<h3 data-id="heading-31"><strong>终极建议</strong>：</h3>
<p>不要陷入"二选一"的思维陷阱。最强大的AI代理系统往往是Skills和MCP精心设计的协同体：</p>
<p>•<strong>用Skills定义业务价值</strong>：什么是对用户真正有用的？</p>
<p>•<strong>用MCP实现技术可能</strong>：如何最安全、高效地交付这些价值？</p>
<p>•<strong>持续优化两者的边界</strong>：随着业务演进和技术进步，重新评估职责分配</p>
<p>记住：<strong>技术的目的是解决问题，而不是创造新的复杂性</strong>。Skills和MCP都是工具，明智的工程师会根据具体问题选择最合适的工具，或将多个工具创造性地组合，以交付最大价值。</p>
<p>在AI代理的未来，我们不会看到Skills取代MCP，或MCP淘汰Skills。相反，我们将见证一个融合的生态系统，其中配置驱动的灵活性与代码实现的强大性和谐共存，共同推动AI代理走向更智能、更可靠、更有价值的未来。</p>
<p>﻿</p>
<hr/>
<p>﻿</p>
<p>﻿</p>
<h2 data-id="heading-32">参考资料与延伸阅读</h2>
<p>本文引用的核心概念与技术规范基于以下行业权威文档，推荐读者深入阅读以获取更多技术细节：</p>
<ol>
<li>Model Context Protocol Specification</li>
</ol>
<p>•来源: Anthropic &amp; MCP Community</p>
<p>•地址: <a href="https://link.juejin.cn?target=https%3A%2F%2Fmodelcontextprotocol.io%2Fintroduction" target="_blank" title="https://modelcontextprotocol.io/introduction" ref="nofollow noopener noreferrer">modelcontextprotocol.io/introductio…</a>﻿</p>
<p>•对应内容: 支持文中第一章与第二章关于 MCP 作为“标准化连接协议”、“安全沙箱”及“JSON-RPC 消息规范”的技术定义。</p>
<ol start="2">
<li>Building Effective Agents</li>
</ol>
<p>•来源: Anthropic Research Team (2024)</p>
<p>•地址: <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.anthropic.com%2Fresearch%2Fbuilding-effective-agents" target="_blank" title="https://www.anthropic.com/research/building-effective-agents" ref="nofollow noopener noreferrer">anthropic.com/research/bu…</a>﻿</p>
<p>•对应内容: 支持文中关于“Workflows（工作流） vs Agents（自主体）”的区分，以及为何在生产环境中应优先采用确定性较高的 Agent Skills（即文中提到的 Orchestration）。</p>
<ol start="3">
<li>The Future of Agentic AI &amp; Design Patterns</li>
</ol>
<p>•来源: Andrew Ng, DeepLearning.AI (The Batch, Issue 242)</p>
<p>•地址: <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.deeplearning.ai%2Fthe-batch%2Fissue-242%2F" target="_blank" title="https://www.deeplearning.ai/the-batch/issue-242/" ref="nofollow noopener noreferrer">deeplearning.ai/the-batch/i…</a>﻿</p>
<p>•对应内容: 支持文中关于“SOP 即智能”的观点，详细阐述了通过结构化流程（Agentic Workflows）来提升 AI 产出质量的设计模式。</p>
<ol start="4">
<li>Semantic Kernel Overview</li>
</ol>
<p>•来源: Microsoft Learn</p>
<p>•地址: <a href="https://link.juejin.cn?target=https%3A%2F%2Flearn.microsoft.com%2Fen-us%2Fsemantic-kernel%2Foverview%2F" target="_blank" title="https://learn.microsoft.com/en-us/semantic-kernel/overview/" ref="nofollow noopener noreferrer">learn.microsoft.com/en-us/seman…</a>﻿</p>
<p>•对应内容: 提供了文中“声明式技能”的工程实现参考，展示了如何将自然语言 Prompt 封装为可调用的 Skills/Plugins。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[突破传统限制：OxygenREC--一个基于指令跟随的"快慢思考"电商生成式推荐框架]]></title>    <link>https://juejin.cn/post/7605106957133758498</link>    <guid>https://juejin.cn/post/7605106957133758498</guid>    <pubDate>2026-02-11T05:59:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605106957133758498" data-draft-id="7605106957133742114" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="突破传统限制：OxygenREC--一个基于指令跟随的&quot;快慢思考&quot;电商生成式推荐框架"/> <meta itemprop="keywords" content="程序员"/> <meta itemprop="datePublished" content="2026-02-11T05:59:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="京东云开发者"/> <meta itemprop="url" content="https://juejin.cn/user/2634854380340008"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            突破传统限制：OxygenREC--一个基于指令跟随的"快慢思考"电商生成式推荐框架
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2634854380340008/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    京东云开发者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-11T05:59:08.000Z" title="Wed Feb 11 2026 05:59:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作者：李卿阳</p>
<p>在电商推荐系统中，推荐模型长期面临着两个核心矛盾：一方面，传统的多阶段级联推荐系统存在目标不一致和误差累积的问题；另一方面，直接引入大型语言模型LLM虽然能带来强大的推理能力，但其高昂的延迟和计算成本在工业级应用中难以承受。更重要的是，现有的生成式推荐方法在多场景扩展性上面临巨大瓶颈--每个场景都需要独立训练和部署，导致资源利用率低下、维护成本高昂。</p>
<p>京东零售OxygenREC团队在论文《OxygenREC: An Instruction-Following Generative Framework for E-commerce Recommendation》中提出了一种全新的解决方案：<strong>OxygenREC</strong>。这是一个基于“快慢思考”的指令跟随生成式推荐框架，不仅解决了推理能力与延迟之间的矛盾，更实现了“一次训练，多处部署”的多场景统一高效解决方案。</p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f04763cc78d549429e54d0d9990fffd5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771394356&amp;x-signature=v05NkTwsmd%2BaENels%2BA7k%2F4xNP4%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<h2 data-id="heading-0">一、 关键挑战</h2>
<p>OxygenREC 旨在解决当前推荐系统，特别是生成式推荐范式下的三大核心难题：</p>
<p>1.<strong>有限的演绎推理能力</strong>：现有的生成式推荐方法主要从用户海量行为中进行归纳学习，但在需要结合现实世界知识进行<strong>深度演绎推理</strong>的场景下表现不佳。比如下边两个例子：</p>
<p>1.当推荐的时空背景和用户画像是“成都冬至时的年轻宝妈”时，传统模型可能只是推荐“冬季外套”这样的商品，而无法深度推理出此时成都是“冷湿环境”，这位年轻母亲潜在的需求可能是“婴儿排汗睡衣”。</p>
<p>2.有个户外运动vlogger在购物行为中反复对比华为Mate 70和iPhone 16 Pro两款手机，传统系统因为用户频繁的交互历史，只会不断加强重复推荐这两款商品进行比价，而无法推理出其真正诉求可能是“高质量的移动影像”，从而模型未能精准推荐‘华为Pura’系列这一真正符合用户诉求的目标商品。</p>
<p>2.<strong>多场景适应与资源效率的矛盾</strong>：大部分推荐平台拥有首页、频道流、购物车、搜索等多种推荐场景。现有生成式推荐模型如果为每个场景训练独立模型，会带来巨大的运营和计算成本，而使用简单的统一模型又会面临“负迁移”问题--不同场景间的知识相互干扰，导致性能下降。</p>
<p>3.<strong>工业级部署的工程挑战</strong>：将<strong>LLM的深度推理能力</strong>与推荐系统的大规模稀疏特征、<strong>严格延迟</strong>要求相结合，是一个巨大的<strong>系统工程</strong>挑战。它需要同时处理推荐系统典型的TB级稀疏嵌入和LLM典型的十亿级稠密参数，这对训练框架和推理引擎都提出了极高要求。</p>
<h2 data-id="heading-1">二、 核心贡献</h2>
<p>面对这些挑战，京东零售OxygenREC团队提出了一个基于指令跟随的生成式推荐框架-OxygenREC，首次把LLM中的“快慢思考”模式引入到生成式推荐中来。在OxygenREC框架中，通过基于Transformer 的Encoder-Decoder 作为骨干网络，能够根据特定指令生成语义化物品序列，来执行推荐场景的”快思考"方式。在“慢思考”模式中，引入上下文推理指令--由近线LLM pipeline 生成，将用户行为与上下文合成为可解释的指令。同时多场景对齐中，通过场景指令与基于强化学习的对齐机制，实现“一次训练，多场景部署”。</p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a9a70ace103f446da6a7027a9e9843ed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771394356&amp;x-signature=Qms%2F0vl5hQB9W8lsq1a9bQgxJfc%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<h3 data-id="heading-2"><strong>1. “快慢思考”架构：知识注入与低延迟的平衡</strong></h3>
<p>这是整个OxygenREC的基础，其核心思想是将复杂的推理过程“离线化”，保证在线服务的<strong>低延迟</strong>。</p>
<p>•<strong>慢思考</strong>：一个近线的LLM pipeline，综合分析用户的时空上下文、个性化特征和历史行为，生成高质量的 <strong>“上下文推理指令”</strong> 。这个过程融合了世界知识，能进行深度演绎推理，但因其是近线批量处理，不增加在线请求的延迟。</p>
<p>•<strong>快思考</strong>：一个高效的编码器-解码器骨干网络。它接收“慢思考”生成的指令，结合实时用户信号，在严格的延迟限制下生成推荐序列。该骨干网络本身轻量、高效，专为实时推理优化。</p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/74d02919f2ba46e0a390f9dd19a45a37~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771394356&amp;x-signature=AMq0FPNMc0gyOBNsjZRO7O%2BZhzI%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>﻿</p>
<h3 data-id="heading-3"><strong>2. 语义对齐的指令控制机制：让指令真正发挥作用</strong></h3>
<p>仅仅生成指令是不够的，还必须确保模型能够准确理解并遵循指令。OxygenREC通过两项关键技术实现精准指令控制：</p>
<p>•<strong>查询到物品的对齐损失</strong>：在训练阶段，通过一个辅助的<strong>Query-to-Item</strong> (Q2I) 损失函数，将指令嵌入与目标物品嵌入在同一个语义空间中对齐。这使得指令能够“理解”物品，并用于检索：</p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/02c772feb872428f9b4d8aa72d3f7d21~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771394356&amp;x-signature=fAX3MiBL30AgD1C673UVtaCUvtU%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>•<strong>指令引导检索(IGR)</strong> ：在生成推荐时，利用对齐后的指令作为查询，从用户长期历史行为中检索出最相关的部分，过滤掉无关的噪声。这确保了模型生成时专注在与当前指令意图最相关的历史信息上，大大提升了可控性和准确性。</p>
<p>﻿</p>
<h3 data-id="heading-4"><strong>3. 基于指令与强化学习的多场景统一对齐：Train-Once-Deploy-Everywhere</strong></h3>
<p>这是解决多场景扩展性的关键。OxygenREC摒弃了为每个场景独立建模的思路。</p>
<p>•<strong>场景指令化</strong>：将不同的场景信息（如首页、购物车）和可选的触发物品（如用户点击的入口商品）统一编码为 <strong>“场景指令”</strong> ，作为模型的条件输入。</p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ba27af0c439c47c48625d557c536e0f6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771394356&amp;x-signature=cZcXK9VY4dXafuamn9Nz5B1mtQk%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>•<strong>统一奖励映射与策略优化</strong>：设计了一个统一的奖励映射服务，将不同场景、不同业务目标（如GMV，转化率，合法性，多样性）的奖励信号归一化。在此基础上，提出了<strong>Soft Adaptive Group Clip Policy Optimization</strong> (SA-GCPO) ****算法进行强化学习训练:</p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/97b9c4700a384c13af70b9ee14a82314~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771394356&amp;x-signature=fq5zt0OuEyC1JpL9aK3BoGxlK4c%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>•该算法用自适应门控函数替代传统基于GRPO的硬截断方式(hard clip):</p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6f88530135b34fd3b1ca5ff6c8d7a8b8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771394356&amp;x-signature=jzmX1s3lp10iErQMsV9izBgm%2FOc%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>•并以基于用户真实反馈的奖励分数作为阈值区分正负advantage样本，显著提升了多任务、多场景下策略学习的稳定性和效率：</p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bb02fd550d4949cf8b255fc7c0ef90c7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771394356&amp;x-signature=MgvOo8YH8QBMVuw0O1S1RoIpc88%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>﻿</p>
<h3 data-id="heading-5"><strong>4. 大规模生产级系统实现</strong></h3>
<p>为了支撑以上创新，团队构建了完整的工程体系：</p>
<p>•﻿<a href="https://link.juejin.cn?target=http%3A%2F%2Fxingyun.jd.com%2Fshendeng%2Farticle%2Fdetail%2F54347%3FisHideShareButton%3D1%26jdme_router%3Djdme%253A%252F%252Fweb%252F202206081297%253Furl%253Dhttp%253A%252F%252Fsd.jd.com%252Farticle%252F54347%253FisHideShareButton%253D1" target="_blank" title="http://xingyun.jd.com/shendeng/article/detail/54347?isHideShareButton=1&amp;jdme_router=jdme%3A%2F%2Fweb%2F202206081297%3Furl%3Dhttp%3A%2F%2Fsd.jd.com%2Farticle%2F54347%3FisHideShareButton%3D1" ref="nofollow noopener noreferrer">统一训练框架：基于PyTorch，深度融合了工业级稀疏嵌入引擎和LLM稠密训练引擎，在128张H800 GPU集群上实现了40%的模型FLOPs利用率。</a>﻿</p>
<p>•<strong>高性能推理引擎xLLM</strong>：针对生成式推荐长上下文、大候选集的特点，定制开发了<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fjd-opensource%2Fxllm" target="_blank" title="https://github.com/jd-opensource/xllm" ref="nofollow noopener noreferrer">xLLM</a>推理框架，通过xSchedule（系统调度）、xAttention（算子优化）、xBeam（束搜索优化）三级优化，满足线上严格的服务级别目标。</p>
<p>•<strong>近线指令服务</strong>：推理指令通过近线服务批量生成并存入KV数据库，线上推荐模型直接读取，实现了零在线LLM调用，兼顾了语义丰富性和低延迟。</p>
<p>﻿</p>
<h2 data-id="heading-6">三、 实验成果</h2>
<p>OxygenREC在京东几个核心场景的大量离线实验和在线A/B测试中取得了显著效果，证明OxygenREC 基于生成式推荐的方法在大规模工业级推荐系统中的有效性。</p>
<h3 data-id="heading-7">1. 基于快慢思考的生成式框架有效性验证</h3>
<p>•<strong>语义ID</strong>：通过多源对比学习（文本、图像、行为关联）构建的层次化语义ID，在保持高类别纯度（92.8%）的同时，实现了极低的ID碰撞，证明了其强大的表达和区分能力。</p>
<p>•<strong>指令跟随</strong>：消融实验证明，在BOS右侧插入指令的方式为最佳；融合了场景ID和触发物品ID的指令效果显著优于单一组件；IGR和Q2I对齐机制共同作用带来了显著的性能提升。</p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cc49ecb5f4d5468598fc386e542dae32~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771394356&amp;x-signature=CMgj6Cra13wGvJ%2FmHxWnVZBu1A4%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>•<strong>统一模型 vs. 独立模型</strong>：在六个核心场景的对比中，统一的OxygenREC模型全面超越了为每个场景独立微调的基线模型，验证了OxygenREC框架在场景间正向迁移的有效性。</p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c72ff4c53200429ea6ff6edccbae0b82~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771394356&amp;x-signature=kqkmfjzvWp%2F%2BdcscC%2BffvB%2BbEBw%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<h3 data-id="heading-8">2. 基于SA-GCPO后训练的有效性验证</h3>
<p>在后续训练阶段，提出的SA-GCPO算法在合成数据比例变化时表现更稳定，且性能显著优于传统的GRPO及其变体GSPO。例如，在33%合成数据比例下，SA-GCPO在HR@1和HR@10上有显著提升。</p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/174846682dde49e6a1c61aad711392f0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771394356&amp;x-signature=R1aGHdwjivV5cM2wi3Qtfsy87Bc%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<h3 data-id="heading-9">3. 电商场景在线A/B测试的商业效果</h3>
<p>OxygenREC已在京东App上形成覆盖用户购物全链路的部署闭环：首页导流（场景1、2）-&gt; 频道浏览（场景3、4）-&gt; 商品结算转化（场景5、6）。在线测试结果表明，该模型在<strong>所有关键业务指标</strong>上均带来显著提升：</p>
<p>•<strong>首页场景</strong>：GMV提升4.52%-8.40%。</p>
<p>•<strong>频道流场景</strong>：其中一个场景的订单量提升了<strong>8.03%</strong> ，显示出模型精准匹配购买意图的能力。</p>
<p>•<strong>结算路径场景</strong>：在用户强购买意图下，GMV提升高达11.80%。</p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5090f46ccb5848638430b5a95523566f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771394356&amp;x-signature=o%2B6csUFl8ixg6xTDewsYqUt6x6A%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<h3 data-id="heading-10">与行业上其他生成式推荐方式对比:</h3>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1a085d32518549aaac4fa84184c45b29~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771394356&amp;x-signature=V4%2Fa4dGsr2TaVEiFhRkU0pvloeA%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>OxygenREC 在几个关键维度上进行了生成式推荐的范式革新：</p>
<p>•架构上，用“快慢思考”破解了推理与延迟的死结。</p>
<p>•效率上，用“统一指令模型”破解了多场景训练的困局。</p>
<p>•控制上，用“语义对齐与引导检索”构建了生成式推荐模型的指令跟随能力。</p>
<p>•优化上，用“SA-GCPO”和全栈系统优化，确保了技术在工业巨量流量下的可行性、稳定性和卓越性能。</p>
<p>﻿</p>
<h2 data-id="heading-11">总结与展望</h2>
<p>OxygenREC的成功，标志着生成式推荐在工业落地上迈出了关键一步。它通过“快慢思考”巧妙平衡了深度推理与低延迟，通过“指令跟随”实现了对推荐过程的精准可控，并通过统一的奖励与策略学习破解了多场景扩展的难题，真正实现了“一次训练，多场景部署”的pipeline。</p>
<p>未来，京东零售OxygenREC团队计划从两个方向继续探索：</p>
<p>•一是向基于语言扩散模型的<strong>非自回归生成</strong>范式演进，从根本上突破序列生成延迟与列表长度的线性关系，满足更高吞吐需求；</p>
<p>•二是开展<strong>跨场景用户轨迹建模</strong>，从用户在首页、搜索、购物车、结算等多场景的连贯行为中挖掘更深层的用户意图，实现更长周期的价值推荐。</p>
<p>OxygenREC不仅是一个高效的推荐系统，更为工业级生成式AI应用的大模型设计提供了宝贵范式--如何将大模型的“脑”与小模型的“身手”结合，如何在复杂多目标任务中实现稳定高效的学习，这其中的思想值得广泛借鉴。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端向架构突围系列 - 基建与研发效能 [10 - 1]：物料体系的工程化治理]]></title>    <link>https://juejin.cn/post/7605135197166239794</link>    <guid>https://juejin.cn/post/7605135197166239794</guid>    <pubDate>2026-02-11T06:00:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605135197166239794" data-draft-id="7605107459066675246" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端向架构突围系列 - 基建与研发效能 [10 - 1]：物料体系的工程化治理"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-02-11T06:00:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="前端王壮壮"/> <meta itemprop="url" content="https://juejin.cn/user/4473272506789485"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端向架构突围系列 - 基建与研发效能 [10 - 1]：物料体系的工程化治理
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4473272506789485/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    前端王壮壮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-11T06:00:57.000Z" title="Wed Feb 11 2026 06:00:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><blockquote>
<p>前言</p>
<p>很多公司吹嘘自己有“自研组件库”，点开一看，其实就是把 Ant Design 的按钮改了个颜色，再套个壳。</p>
<p>真正的物料基建，不是为了解决“按钮长什么样”，而是为了解决“为什么我的项目里有 18 个逻辑一模一样的搜索框，且没一个能直接复用”。如果你的基建不能让业务开发在面对 PM 的奇葩需求时少写 50% 的代码，那它就是个摆设。</p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a195f38ee7eb43f2bde3d25f325500bd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv546L5aOu5aOu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771394459&amp;x-signature=OBFBhZoZID6hEx5ulZAJsfSZBSY%3D" alt="image.png" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-0">一、 认知突围：物料是“业务逻辑”的载体</h2>
<p>在架构师眼中，物料的治理不应停留在 UI 视觉层，而应深入到<strong>业务语义层</strong>。</p>
<h3 data-id="heading-1">1.1 从“工具包”到“资产库”</h3>
<ul>
<li>
<p><strong>UI 组件 (Low Level):</strong> 解决的是“样式统一”。（如：Modal, Select）</p>
</li>
<li>
<p><strong>业务物料 (High Level):</strong> 解决的是“行为统一”。</p>
<ul>
<li><strong>例子：</strong> “用户选择器”不仅是一个下拉框，它背后关联着：接口鉴权、防抖搜索、分页加载、头像渲染。</li>
<li><strong>深度治理：</strong> 如果每个业务线都自己写一遍这套逻辑，那就是 10 倍的维护成本。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-2">1.2 为什么大部分物料库会走向“腐烂”？</h3>
<ul>
<li><strong>过度封装：</strong> 为了支持所有场景，给一个组件开了 50 个 Props，最后代码里全是 <code>if/else</code>。</li>
<li><strong>文档滞后：</strong> 开发者看文档像是在猜灯谜，最后发现“看源码比看文档快”。</li>
<li><strong>版本割裂：</strong> 核心库升级了，业务线不敢升，最后全公司跑着 5 个版本的组件库。</li>
</ul>
<hr/>
<h2 data-id="heading-3">二、 深度工程化：物料的“生产流水线”</h2>
<p>要让物料体系真正流转起来，架构师必须构建一套**“非人治”**的自动化链路。</p>
<h3 data-id="heading-4">2.1 基于 AST 的“自动化元数据提取”</h3>
<p>别再让开发者手写文档了。利用 TypeScript 的编译器 API（Compiler API），在物料发布时自动扫描源码：</p>
<ul>
<li><strong>自动提取 Props 定义、注释、默认值。</strong></li>
<li><strong>自动生成 API 表格。</strong></li>
<li><strong>自动识别依赖项。</strong></li>
<li><strong>意义：</strong> 确保“代码即文档”，从根源上消灭文档与代码不一致的问题。</li>
</ul>
<h3 data-id="heading-5">2.2 视觉回归测试：基建的“保险杠”</h3>
<p>在企业级治理中，你最怕的就是：改了 A 组件的一个边距，结果 B 业务线的老页面直接塌陷了。</p>
<ul>
<li><strong>方案：</strong> 引入 <strong>Visual Regression Testing</strong>（如 Playwright + Pixelmatch）。</li>
<li><strong>实战：</strong> 在 CI 环节，自动化对比组件修改前后的像素差异。哪怕只是偏移了 1px，也要在 PR 阶段被拦截。</li>
</ul>
<hr/>
<h2 data-id="heading-6">三、 治理逻辑：如何让物料“好找且敢用”</h2>
<h3 data-id="heading-7">3.1 建立“物料索引市场” (Discovery System)</h3>
<p>如果一个物料不能在 30 秒内被开发者搜到，那它就不存在。</p>
<ul>
<li><strong>智能搜索：</strong> 不止搜名称，更要搜“功能描述”。（搜“上传照片”，能关联出“图片裁剪”和“头像上传”）。</li>
<li><strong>在线 Sandbox：</strong> 必须提供<strong>即时预览</strong>和<strong>代码试运行</strong>。开发者应该在“买”之前，先在浏览器里把玩一下。</li>
</ul>
<h3 data-id="heading-8">3.2 影子测试与灰度策略</h3>
<p>核心物料升级时，利用 <strong>Babel 插件</strong>或 <strong>Webpack 插件</strong>，在编译阶段分析业务代码的覆盖情况。</p>
<ul>
<li><strong>深度实践：</strong> 统计哪些业务方使用了该物料的哪些属性。如果某属性没有任何人用，直接在下一版本废弃（Deprecate），保持物料库的“轻盈”。</li>
</ul>
<hr/>
<h2 data-id="heading-9">四、 架构师的权衡：标准化 vs 灵活性</h2>
<p>这是一个经典的架构陷阱：<strong>物料封装得越死，复用性越高，但灵活性越差。</strong></p>
<h3 data-id="heading-10">4.1 经典陷阱：“千手观音”组件</h3>
<p>想象一下，你们团队需要一个“开关 (Switch/Toggle)”组件。</p>
<p><strong>起初（标准化阶段）：</strong> 基础架构组设计了一个极其标准的 <code>&lt;StandardSwitch /&gt;</code>。它只有两个属性：<code>checked</code> 和 <code>onChange</code>。样式是写死的：圆角、蓝色背景。大家用得很开心，规范统一。</p>
<p><strong>后来（灵活性需求爆发）：</strong></p>
<ul>
<li>业务线 A：我们的产品主色调是红色，能改颜色吗？</li>
<li>业务线 B：我们要搞促销活动，这个开关得是方形的，里面还要加个文字图标。</li>
<li>业务线 C：我们需要把开关放在一个极小的空间里，尺寸能自定义吗？</li>
</ul>
<p><strong>结果（架构腐化）：</strong> 为了满足这些需求，<code>&lt;StandardSwitch /&gt;</code> 被迫增加了几十个 Props：<code>color</code>, <code>borderRadius</code>, <code>size</code>, <code>showIcon</code>, <code>iconContent</code>...</p>
<p>最终，这个组件变成了一个长着无数只手的“千手观音”，内部充斥着复杂的样式判断逻辑，维护成本极高，且性能堪忧。</p>
<h3 data-id="heading-11">4.2 破局思路：Headless (无头) 组件</h3>
<p>Headless 的核心思想是：<strong>将“逻辑的脑子”与“渲染的皮囊”彻底分离。</strong></p>
<ul>
<li><strong>有头组件 (Traditional):</strong> 买电脑送显示器。你想换个 4K 屏？对不起，主机和屏幕焊死在一起了。</li>
<li><strong>无头组件 (Headless):</strong> 只卖主机。你爱接 4K 屏、带鱼屏还是投影仪，随你便。</li>
</ul>
<h4 data-id="heading-12">架构图解：分离的艺术</h4>
<p>我们来看下 Headless 模式下，组件的分层架构：</p>
<p>如上图所示：</p>
<ul>
<li><strong>底层 (Headless 逻辑层)：</strong> 封装了所有“脏活累活”。比如，开关的状态切换、按空格键触发切换、盲人阅读器的 <code>aria-checked</code> 属性支持等。这些逻辑是通用的，与 UI 无关。</li>
<li><strong>顶层 (UI 渲染层)：</strong> 完全由业务方自己决定。他们可以使用 <code>&lt;div&gt;</code>, <code>&lt;span&gt;</code>, CSS-in-JS, Tailwind CSS，想画成圆的就画成圆的，想画成方的就画成方的。</li>
</ul>
<h3 data-id="heading-13">4.3 代码实例：从“千手观音”到“灵活组装”</h3>
<p>我们用 React Hooks 来演示一下这个转变（Vue 的 Composition API 同理）。</p>
<h4 data-id="heading-14">场景：实现一个 Switch 开关</h4>
<p><strong>1. 定义 Headless Hook (只管逻辑)：</strong></p>
<p>这个 Hook 包含了开关的所有核心能力，但不涉及任何 DOM 和 CSS。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// useSwitch.ts (物料库提供)</span>
<span class="hljs-keyword">import</span> { useState, useCallback } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useSwitch</span>(<span class="hljs-params">initialState = <span class="hljs-literal">false</span></span>) {
  <span class="hljs-comment">// 1. 状态管理</span>
  <span class="hljs-keyword">const</span> [isOn, setIsOn] = <span class="hljs-title function_">useState</span>(initialState);

  <span class="hljs-comment">// 2. 交互逻辑</span>
  <span class="hljs-keyword">const</span> toggle = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">setIsOn</span>(<span class="hljs-function"><span class="hljs-params">v</span> =&gt;</span> !v), []);

  <span class="hljs-comment">// 3. 辅助功能 (A11y) 属性生成器</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">getSwitchProps</span> = (<span class="hljs-params"/>) =&gt; ({
    <span class="hljs-attr">role</span>: <span class="hljs-string">'switch'</span>,
    <span class="hljs-string">'aria-checked'</span>: isOn,
    <span class="hljs-attr">tabIndex</span>: <span class="hljs-number">0</span>,
    <span class="hljs-attr">onClick</span>: toggle,
    <span class="hljs-attr">onKeyDown</span>: <span class="hljs-function">(<span class="hljs-params">e: React.KeyboardEvent</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (e.<span class="hljs-property">key</span> === <span class="hljs-string">' '</span> || e.<span class="hljs-property">key</span> === <span class="hljs-string">'Enter'</span>) {
        e.<span class="hljs-title function_">preventDefault</span>();
        <span class="hljs-title function_">toggle</span>();
      }
    }
  });

  <span class="hljs-comment">// 只返回状态和逻辑方法</span>
  <span class="hljs-keyword">return</span> { isOn, toggle, getSwitchProps };
}
</code></pre>
<p><strong>2. 业务方 A 的实现（标准圆角蓝风格）：</strong></p>
<p>业务方拿到了逻辑，自己决定怎么渲染。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// BusinessA_Switch.jsx (业务方 A 自定义)</span>
<span class="hljs-keyword">import</span> { useSwitch } <span class="hljs-keyword">from</span> <span class="hljs-string">'@my-org/hooks'</span>;
<span class="hljs-keyword">import</span> styled <span class="hljs-keyword">from</span> <span class="hljs-string">'styled-components'</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title class_">StyledButton</span> = styled.<span class="hljs-property">button</span><span class="hljs-string">`
  background-color: <span class="hljs-subst">${props =&gt; props.isOn ? <span class="hljs-string">'blue'</span> : <span class="hljs-string">'gray'</span>}</span>;
  border-radius: 9999px; // 圆角风格
  // ... 其他样式
`</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">StandardSwitch</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 使用 Headless 能力</span>
  <span class="hljs-keyword">const</span> { isOn, getSwitchProps } = <span class="hljs-title function_">useSwitch</span>();

  <span class="hljs-keyword">return</span> (
    <span class="hljs-comment">// 将逻辑属性解构赋值给 UI 元素</span>
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">StyledButton</span> <span class="hljs-attr">isOn</span>=<span class="hljs-string">{isOn}</span> {<span class="hljs-attr">...getSwitchProps</span>()}&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"thumb"</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">StyledButton</span>&gt;</span></span>
  );
}
</code></pre>
<p><strong>3. 业务方 B 的实现（方形红色促销风格）：</strong></p>
<p>业务方 B 可以完全复用逻辑，画出截然不同的 UI。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// BusinessB_PromoSwitch.jsx (业务方 B 自定义)</span>
<span class="hljs-keyword">import</span> { useSwitch } <span class="hljs-keyword">from</span> <span class="hljs-string">'@my-org/hooks'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">PromoSwitch</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> { isOn, getSwitchProps } = <span class="hljs-title function_">useSwitch</span>();

  <span class="hljs-keyword">return</span> (
    <span class="hljs-comment">// 使用 Tailwind 编写完全不同的方形样式</span>
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>
      {<span class="hljs-attr">...getSwitchProps</span>()}
      <span class="hljs-attr">className</span>=<span class="hljs-string">{</span>`${<span class="hljs-attr">isOn</span> ? '<span class="hljs-attr">bg-red-500</span>' <span class="hljs-attr">:</span> '<span class="hljs-attr">bg-zinc-300</span>'} <span class="hljs-attr">w-16</span> <span class="hljs-attr">h-8</span> <span class="hljs-attr">rounded-none</span> <span class="hljs-attr">flex</span> <span class="hljs-attr">items-center</span> <span class="hljs-attr">cursor-pointer</span>`}
    &gt;</span>
       <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"bg-white w-6 h-6 mx-1 rounded-none"</span>&gt;</span>
         {isOn ? '开' : '关'}
       <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<h3 data-id="heading-15">4.4 总结</h3>
<p>通过 Headless 模式，架构师完成了对权力的完美让渡：</p>
<ul>
<li><strong>架构师守住了底线：</strong> 核心交互逻辑、状态流转、可访问性标准被统一封装，不会因为业务方的 UI 定制而产生逻辑 Bug。</li>
<li><strong>业务方得到了自由：</strong> 他们再也不用为了改个颜色而去求基础架构组加 Props 了。</li>
</ul>
<p>这就是那句格言的深层含义：</p>
<blockquote>
<p><strong>“给业务方留一扇窗（UI 自定义能力），他们就不会想拆掉你的墙（核心逻辑封装）。”</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-16">五、 总结：从“重复造轮子”到“按需组装”</h2>
<h3 data-id="heading-17">5.1 研发复利：架构师的“长期主义”</h3>
<p>在一般的团队中，工作量是随项目数量线性增长的；而在拥有顶级物料治理的团队里，工作量曲线应该是<strong>对数级</strong>的。</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>研发成本</mtext><mo>=</mo><mtext>首次沉淀成本</mtext><mo>+</mo><mo>∑</mo><mo stretchy="false">(</mo><mtext>极低的单次复用成本</mtext><mo>+</mo><mtext>边际维护成本</mtext><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">研发成本 = \text{首次沉淀成本} + \sum (\text{极低的单次复用成本} + \text{边际维护成本})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord cjk_fallback">研发成本</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.7667em;vertical-align:-0.0833em;"/><span class="mord text"><span class="mord cjk_fallback">首次沉淀成本</span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="mopen">(</span><span class="mord text"><span class="mord cjk_fallback">极低的单次复用成本</span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord text"><span class="mord cjk_fallback">边际维护成本</span></span><span class="mclose">)</span></span></span></span></span></p>
<ul>
<li><strong>初期（高投入）：</strong> 你可能花了 2 周才磨合出一个完美的、Headless 架构的“财务大搜表”物料。</li>
<li><strong>后期（高回报）：</strong> 当公司要开 5 个新的后台管理页面时，开发者只需要花 10 分钟引入物料并配置 Schema。由于物料已经在 100 个场景下跑过，其**健壮性（Robustness）**是任何新写的代码都无法比拟的。</li>
</ul>
<h3 data-id="heading-18">5.2 案例对比：从“冷启动”到“一键飞升”</h3>
<p>我们来看一个实际的业务场景：<strong>实现一个带“权限控制”和“自动重试”功能的图片上传组件。</strong></p>






























<table><thead><tr><th><strong>维度</strong></th><th><strong>传统“造轮子”模式 (No Infrastructure)</strong></th><th><strong>“按需组装”模式 (Material Asset)</strong></th></tr></thead><tbody><tr><td><strong>开发耗时</strong></td><td>3 - 5 小时（找文档、调 API、写逻辑、调样式）</td><td><strong>5 - 10 分钟</strong>（拖拽组件，填写 API Key）</td></tr><tr><td><strong>代码量</strong></td><td>150+ 行（逻辑散落在各个组件中）</td><td><strong>3 行</strong>（纯声明式配置）</td></tr><tr><td><strong>稳定性</strong></td><td>极低（不同人写的代码，异常处理逻辑不一）</td><td><strong>极高</strong>（物料自带熔断、重试、OSS 分片逻辑）</td></tr><tr><td><strong>可维护性</strong></td><td>噩梦（后端 API 一改，全项目全局搜索替换）</td><td><strong>轻松</strong>（物料中心统一升级，全线同步生效）</td></tr></tbody></table>
<ul>
<li><strong>向上管理：</strong> 用数据告诉老板，你搞的基建到底省了多少钱（换算成工时）。</li>
<li><strong>向下优化：</strong> 如果某个物料的使用率为 0，说明要么是不好用，要么是没推广，架构师应及时止损，将其踢出资产库。</li>
</ul>
<hr/>
<h2 data-id="heading-19">结语：交付的最后一公里</h2>
<p><strong>研发效能不是看你写代码有多快，而是看从“代码提交”到“用户可用”的总时长（Lead Time）。</strong></p>
<h3 data-id="heading-20">1. 现状对比：手工业 vs. 工业化流水线</h3>
<p>如果交付链路不打通，你的基建就像是在泥潭里开跑车。</p>






























<table><thead><tr><th><strong>环节</strong></th><th><strong>人肉运维 (手工时代)</strong></th><th><strong>DevOps 交付 (架构时代)</strong></th></tr></thead><tbody><tr><td><strong>构建</strong></td><td>开发者在本地执行 <code>npm build</code>，环境不一致导致“我本地明明是好的”。</td><td><strong>云端环境统一构建</strong>（Docker 镜像），保证 100% 环境一致。</td></tr><tr><td><strong>部署</strong></td><td>找运维开权限，手动 FTP 上传或 SSH 到服务器执行 <code>git pull</code>。</td><td><strong>合入即部署</strong>。代码通过测试自动触发部署，开发者无需关注服务器。</td></tr><tr><td><strong>配置</strong></td><td>手动修改 Nginx 转发规则、配置跨域、刷新 CDN 缓存。</td><td><strong>配置即代码 (IaC)</strong> 。Nginx 和路由配置随代码版本走，一键生效。</td></tr><tr><td><strong>回滚</strong></td><td>“快！把刚才那个备份压缩包覆盖回去！”（手忙脚乱中可能覆盖错版本）。</td><td><strong>秒级回滚</strong>。通过镜像版本切换，一键回到任何稳定时刻。</td></tr></tbody></table>
<h3 data-id="heading-21">2. 图解：交付链路的“能量损耗”</h3>
<p>我们可以用一个“水管模型”来理解交付瓶颈：</p>
<p><strong>警示：</strong></p>
<p>如果中间那段“交付管道”是细窄的、堵塞的，那么你前端基建做得再大（漏斗再宽），最终流向用户的价值流速依然由那根细管子决定。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>