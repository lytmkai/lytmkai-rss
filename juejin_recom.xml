<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>æ˜é‡‘æ–‡ç« æ¨è</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>ä¸€ä¸ªå¸®åŠ©å¼€å‘è€…æˆé•¿çš„ç¤¾åŒº</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[React Hooks æ·±åº¦ç†è§£ï¼šuseState / useEffect å¦‚ä½•ç®¡ç†å‰¯ä½œç”¨ä¸å†…å­˜]]></title>    <link>https://juejin.cn/post/7585484081436033075</link>    <guid>https://juejin.cn/post/7585484081436033075</guid>    <pubDate>2025-12-20T13:32:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585484081436033075" data-draft-id="7585686247270006793" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React Hooks æ·±åº¦ç†è§£ï¼šuseState / useEffect å¦‚ä½•ç®¡ç†å‰¯ä½œç”¨ä¸å†…å­˜"/> <meta itemprop="keywords" content="å‰ç«¯,React.js"/> <meta itemprop="datePublished" content="2025-12-20T13:32:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ç™½å…°åœ°ç©ºç“¶"/> <meta itemprop="url" content="https://juejin.cn/user/191753514127514"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="æ˜é‡‘"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React Hooks æ·±åº¦ç†è§£ï¼šuseState / useEffect å¦‚ä½•ç®¡ç†å‰¯ä½œç”¨ä¸å†…å­˜
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/191753514127514/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ç™½å…°åœ°ç©ºç“¶
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T13:32:06.000Z" title="Sat Dec 20 2025 13:32:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    é˜…è¯»4åˆ†é’Ÿ
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">ğŸ¤¯ä½ ä»¥ä¸º React Hooks åªæ˜¯è¯­æ³•ç³–ï¼Ÿ</h2>
<h3 data-id="heading-1">ä¸â€”â€”å®ƒä»¬æ˜¯åœ¨å¸®ä½ å¯¹æŠ—ã€Œå‰¯ä½œç”¨ã€å’Œã€Œå†…å­˜æ³„æ¼ã€</h3>
<blockquote>
<p><strong>å¦‚æœä½ åªæŠŠ Hooks å½“æˆâ€œä¸ç”¨ class äº†â€ï¼Œ<br/>
é‚£ä½ å¯èƒ½åªç†è§£äº† React çš„ 10%ã€‚</strong></p>
</blockquote>
<hr/>
<h3 data-id="heading-2">ğŸš€ ä¸€ã€ä¸€ä¸ªâ€œçœ‹èµ·æ¥æ¯«æ— é—®é¢˜â€çš„ç»„ä»¶</h3>
<p>æˆ‘ä»¬å…ˆä»ä¸€ä¸ªä½ æˆ‘éƒ½å†™è¿‡æ— æ•°æ¬¡çš„ç»„ä»¶å¼€å§‹ï¼š</p>
<pre><code class="hljs language-scss" lang="scss">function <span class="hljs-built_in">App</span>() {
  const <span class="hljs-selector-attr">[num, setNum]</span> = <span class="hljs-built_in">useState</span>(<span class="hljs-number">0</span>)

  return (
    &lt;div onClick={() =&gt; <span class="hljs-built_in">setNum</span>(num + <span class="hljs-number">1</span>)}&gt;
      {num}
    &lt;/<span class="hljs-selector-tag">div</span>&gt;
  )
}
</code></pre>
<p>çœ‹èµ·æ¥éå¸¸å®Œç¾ï¼š</p>
<ul>
<li>âœ… æ²¡æœ‰ class</li>
<li>âœ… æ²¡æœ‰ this</li>
<li>âœ… å°±æ˜¯ä¸€ä¸ªæ™®é€šå‡½æ•°</li>
</ul>
<p>ä½†é—®é¢˜æ˜¯ï¼š</p>
<blockquote>
<p><strong>React ä¸ºä»€ä¹ˆè¦å‘æ˜ Hooksï¼Ÿ</strong><br/>
<strong>useState / useEffect åˆ°åº•è§£å†³äº†ä»€ä¹ˆâ€œæœ¬è´¨é—®é¢˜â€ï¼Ÿ</strong></p>
</blockquote>
<p>ç­”æ¡ˆå…¶å®åªæœ‰ä¸€ä¸ªå…³é”®è¯ğŸ‘‡</p>
<hr/>
<h3 data-id="heading-3">ğŸ’£ äºŒã€React ä¸–ç•Œçš„ç»ˆææ•Œäººï¼šå‰¯ä½œç”¨ï¼ˆSide Effectï¼‰</h3>
<p>React èƒŒåæœ‰ä¸€ä¸ª<strong>å¾ˆå°‘è¢«æ˜è¯´ï¼Œä½†æå…¶é‡è¦çš„ä¿¡ä»°</strong>ï¼š</p>
<blockquote>
<p><strong>ç»„ä»¶ â‰ˆ çº¯å‡½æ•°</strong></p>
</blockquote>
<h4 data-id="heading-4">ğŸ§  ä»€ä¹ˆæ˜¯çº¯å‡½æ•°ï¼Ÿ</h4>
<ul>
<li>ç›¸åŒè¾“å…¥ â†’ æ°¸è¿œç›¸åŒè¾“å‡º</li>
<li>ä¸ä¾èµ–å¤–éƒ¨å˜é‡</li>
<li>ä¸äº§ç”Ÿé¢å¤–å½±å“ï¼ˆI/Oã€å®šæ—¶å™¨ã€è¯·æ±‚ï¼‰</li>
</ul>
<pre><code class="hljs language-css" lang="css">function add(<span class="hljs-selector-tag">a</span>, <span class="hljs-selector-tag">b</span>) {
  return <span class="hljs-selector-tag">a</span> + <span class="hljs-selector-tag">b</span>
}
</code></pre>
<p>è€Œç†æƒ³ä¸­çš„ React ç»„ä»¶æ˜¯ï¼š</p>
<pre><code class="hljs language-perl" lang="perl">(props + <span class="hljs-keyword">state</span>) â†’ JSX
</code></pre>
<blockquote>
<p><strong>React å¸Œæœ›ä½ â€œåªè´Ÿè´£ç®— UIâ€ï¼Œ<br/>
è€Œä¸æ˜¯åœ¨æ¸²æŸ“æ—¶å¹²åˆ«çš„äº‹ã€‚</strong></p>
</blockquote>
<hr/>
<h3 data-id="heading-5">âš ï¸ ä½†ç°å®æ˜¯ï¼šä½ å¿…é¡»å¹²â€œåäº‹â€</h3>
<p>çœŸå®ä¸šåŠ¡ä¸­ï¼Œä½ ä¸å¯é¿å…è¦åšè¿™äº›äº‹ï¼š</p>
<ul>
<li>ğŸŒ è¯·æ±‚æ¥å£</li>
<li>â±ï¸ è®¾ç½®å®šæ—¶å™¨</li>
<li>ğŸ§ äº‹ä»¶ç›‘å¬</li>
<li>ğŸ“¦ è®¢é˜… / å–æ¶ˆè®¢é˜…</li>
<li>ğŸ§± æ“ä½œ DOM</li>
</ul>
<p>è¿™äº›è¡Œä¸ºæœ‰ä¸€ä¸ªå…±åŒç‚¹ğŸ‘‡</p>
<blockquote>
<p>âŒ <strong>å®ƒä»¬éƒ½ä¸æ˜¯çº¯å‡½æ•°è¡Œä¸º</strong><br/>
âœ… <strong>å®ƒä»¬éƒ½æ˜¯å‰¯ä½œç”¨</strong></p>
</blockquote>
<p>å¦‚æœä½ ç›´æ¥æŠŠå‰¯ä½œç”¨å†™è¿›ç»„ä»¶å‡½æ•°ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/data'</span>) <span class="hljs-comment">// âŒ</span>
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> /&gt;</span></span>
}
</code></pre>
<p>ğŸ‘‰ æ¯ä¸€æ¬¡ render éƒ½è¯·æ±‚<br/>
ğŸ‘‰ çŠ¶æ€æ›´æ–° â†’ å† render â†’ å†è¯·æ±‚<br/>
ğŸ‘‰ <strong>ç»„ä»¶ç›´æ¥å¤±æ§</strong></p>
<hr/>
<h3 data-id="heading-6">ğŸ§¯ ä¸‰ã€useEffectï¼šå‰¯ä½œç”¨çš„â€œéš”ç¦»åŒºâ€</h3>
<p><code>useEffect</code> çš„å­˜åœ¨ï¼Œæœ¬è´¨åªå¹²ä¸€ä»¶äº‹ï¼š</p>
<blockquote>
<p><strong>æŠŠå‰¯ä½œç”¨ä»â€œæ¸²æŸ“é˜¶æ®µâ€æŒªèµ°</strong></p>
</blockquote>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">useEffect</span>(() =&gt; {
  <span class="hljs-comment">// å‰¯ä½œç”¨é€»è¾‘</span>
}, <span class="hljs-selector-attr">[]</span>)
</code></pre>
<p>ğŸ’¡ <strong>ä¸€å¥è¯ç†è§£ï¼š</strong></p>
<blockquote>
<p><strong>render é˜¶æ®µå¿…é¡»çº¯ï¼Œ<br/>
effect é˜¶æ®µå…è®¸è„ã€‚</strong></p>
</blockquote>
<hr/>
<h3 data-id="heading-7">ğŸ“¦ å››ã€ä¾èµ–æ•°ç»„ä¸æ˜¯ç»†èŠ‚ï¼Œè€Œæ˜¯â€œå‰¯ä½œç”¨è¾¹ç•Œâ€</h3>
<h4 data-id="heading-8">1ï¸âƒ£ åªæ‰§è¡Œä¸€æ¬¡ï¼ˆæŒ‚è½½ï¼‰</h4>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">useEffect</span>(() =&gt; {
  console<span class="hljs-selector-class">.log</span>('mounted')
}, <span class="hljs-selector-attr">[]</span>)
</code></pre>
<ul>
<li>åªåœ¨ç»„ä»¶æŒ‚è½½æ—¶æ‰§è¡Œ</li>
<li>ç±»ä¼¼ Vue çš„ <code>onMounted</code></li>
</ul>
<hr/>
<h4 data-id="heading-9">2ï¸âƒ£ ä¾èµ–å˜åŒ–æ‰æ‰§è¡Œ</h4>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">useEffect</span>(() =&gt; {
  console<span class="hljs-selector-class">.log</span>(num)
}, <span class="hljs-selector-attr">[num]</span>)
</code></pre>
<ul>
<li><code>num</code> å˜åŒ– â†’ æ‰§è¡Œ</li>
<li>ä¸å˜ â†’ ä¸æ‰§è¡Œ</li>
</ul>
<blockquote>
<p><strong>ä¾èµ–æ•°ç»„çš„æœ¬è´¨æ˜¯ï¼š<br/>
â€œè¿™ä¸ªå‰¯ä½œç”¨ä¾èµ–è°ï¼Ÿâ€</strong></p>
</blockquote>
<hr/>
<h4 data-id="heading-10">3ï¸âƒ£ ä¸å†™ä¾èµ–é¡¹ï¼Ÿ</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'every render'</span>)
})
</code></pre>
<p>ğŸ‘‰ æ¯æ¬¡ render éƒ½æ‰§è¡Œ<br/>
ğŸ‘‰ <strong>99% çš„æ—¶å€™æ˜¯æ€§èƒ½é™·é˜±</strong></p>
<hr/>
<h3 data-id="heading-11">ğŸ’¥ äº”ã€90% æ–°æ‰‹éƒ½ä¼šè¸©çš„å‘ï¼šå†…å­˜æ³„æ¼</h3>
<p>æ¥çœ‹ä¸€ä¸ª<strong>æå…¶ç»å…¸</strong>çš„ Hooks é”™è¯¯å†™æ³•ğŸ‘‡</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">useEffect</span>(() =&gt; {
  const timer = <span class="hljs-built_in">setInterval</span>(() =&gt; {
    console<span class="hljs-selector-class">.log</span>(num)
  }, <span class="hljs-number">1000</span>)
}, <span class="hljs-selector-attr">[num]</span>)
</code></pre>
<p>ä½ è§‰å¾—è¿™æ®µä»£ç æœ‰é—®é¢˜å—ï¼Ÿ</p>
<blockquote>
<p><strong>æœ‰ï¼Œè€Œä¸”éå¸¸è‡´å‘½ã€‚</strong></p>
</blockquote>
<hr/>
<h4 data-id="heading-12">âŒ é—®é¢˜åœ¨å“ªé‡Œï¼Ÿ</h4>
<ul>
<li><code>num</code> æ¯å˜ä¸€æ¬¡</li>
<li>effect é‡æ–°æ‰§è¡Œ</li>
<li>æ–°å»ºä¸€ä¸ªå®šæ—¶å™¨</li>
<li>â—æ—§å®šæ—¶å™¨è¿˜æ´»ç€</li>
</ul>
<p>ç»“æœå°±æ˜¯ï¼š</p>
<ul>
<li>â±ï¸ å®šæ—¶å™¨è¶Šæ¥è¶Šå¤š</li>
<li>ğŸ“ˆ å†…å­˜æŒç»­ä¸Šæ¶¨</li>
<li>ğŸ’¥ æ§åˆ¶å°ç–¯ç‹‚æ‰“å°</li>
<li>ğŸ§  <strong>å†…å­˜æ³„æ¼</strong></li>
</ul>
<hr/>
<h3 data-id="heading-13">ğŸ§¹ å…­ã€useEffect returnï¼šå‰¯ä½œç”¨çš„â€œå–„ç»ˆæœºåˆ¶â€</h3>
<p>React ç»™ä½ å‡†å¤‡äº†ä¸€ä¸ª<strong>å®˜æ–¹æ¸…ç†é€šé“</strong>ğŸ‘‡</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">useEffect</span>(() =&gt; {
  const timer = <span class="hljs-built_in">setInterval</span>(() =&gt; {
    console<span class="hljs-selector-class">.log</span>(num)
  }, <span class="hljs-number">1000</span>)

  return () =&gt; {
    <span class="hljs-built_in">clearInterval</span>(timer)
  }
}, <span class="hljs-selector-attr">[num]</span>)
</code></pre>
<h4 data-id="heading-14">âš ï¸ é‡ç‚¹æ¥äº†</h4>
<blockquote>
<p><strong>return çš„å‡½æ•°ä¸æ˜¯â€œå¸è½½æ—¶æ‰æ‰§è¡Œâ€</strong></p>
</blockquote>
<p>è€Œæ˜¯ï¼š</p>
<blockquote>
<p><strong>ä¸‹ä¸€æ¬¡ effect æ‰§è¡Œå‰ï¼Œä¸€å®šä¼šå…ˆæ‰§è¡Œå®ƒ</strong></p>
</blockquote>
<p>React å†…éƒ¨é¡ºåºæ˜¯è¿™æ ·çš„ï¼š</p>
<ol>
<li>æ‰§è¡Œä¸Šä¸€æ¬¡ effect çš„ cleanup</li>
<li>å†æ‰§è¡Œæ–°çš„ effect</li>
</ol>
<p>ğŸ‘‰ <strong>è¿™å°±æ˜¯ Hooks é˜²å†…å­˜æ³„æ¼çš„æ ¸å¿ƒè®¾è®¡</strong></p>
<hr/>
<h3 data-id="heading-15">ğŸ§  ä¸ƒã€useStateï¼šä¸ºä»€ä¹ˆåˆå§‹åŒ–ä¸èƒ½å¼‚æ­¥ï¼Ÿ</h3>
<p>ä½ åœ¨å­¦ä¹  Hooks æ—¶ï¼Œä¸€å®šé—®è¿‡è¿™ä¸ªé—®é¢˜ğŸ‘‡</p>
<blockquote>
<p>â“ æˆ‘èƒ½ä¸èƒ½åœ¨ useState åˆå§‹åŒ–æ—¶è¯·æ±‚æ¥å£ï¼Ÿ</p>
</blockquote>
<pre><code class="hljs language-kotlin" lang="kotlin">useState(async () =&gt; {
  <span class="hljs-keyword">const</span> <span class="hljs-keyword">data</span> = await fetchData()
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">data</span>
})
</code></pre>
<p>ç­”æ¡ˆå¾ˆå¹²è„†ï¼š</p>
<blockquote>
<p>âŒ <strong>ä¸è¡Œ</strong></p>
</blockquote>
<hr/>
<h4 data-id="heading-16">ğŸ¤” ä¸ºä»€ä¹ˆä¸è¡Œï¼Ÿ</h4>
<p>å› ä¸º React å¿…é¡»ä¿è¯ï¼š</p>
<ul>
<li>é¦–æ¬¡ render <strong>ç«‹å³æœ‰ç¡®å®šçš„ state</strong></li>
<li>å¼‚æ­¥ç»“æœæ˜¯ä¸ç¡®å®šçš„</li>
<li>state ä¸€æ—¦åˆå§‹åŒ–ï¼Œå¿…é¡»æ˜¯åŒæ­¥å€¼</li>
</ul>
<p>React å…è®¸çš„åªæœ‰è¿™ç§ğŸ‘‡</p>
<pre><code class="hljs language-css" lang="css">useState(() =&gt; {
  const <span class="hljs-selector-tag">a</span> = <span class="hljs-number">1</span> + <span class="hljs-number">2</span>
  const <span class="hljs-selector-tag">b</span> = <span class="hljs-number">2</span> + <span class="hljs-number">3</span>
  return <span class="hljs-selector-tag">a</span> + <span class="hljs-selector-tag">b</span>
})
</code></pre>
<p>ğŸ’¡ è¿™å« <strong>æƒ°æ€§åˆå§‹åŒ–</strong><br/>
ğŸ’¡ ä½†å‰ææ˜¯ï¼š<strong>åŒæ­¥ + çº¯å‡½æ•°</strong></p>
<hr/>
<h3 data-id="heading-17">ğŸŒ å…«ã€é‚£å¼‚æ­¥è¯·æ±‚åˆ°åº•è¯¥å†™å“ªï¼Ÿ</h3>
<p>ç­”æ¡ˆåªæœ‰ä¸€ä¸ªåœ°æ–¹ï¼š</p>
<blockquote>
<p><strong>useEffect</strong></p>
</blockquote>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">useEffect</span>(() =&gt; {
  async function <span class="hljs-built_in">query</span>() {
    const data = await <span class="hljs-built_in">queryData</span>()
    <span class="hljs-built_in">setNum</span>(data)
  }
  <span class="hljs-built_in">query</span>()
}, <span class="hljs-selector-attr">[]</span>)
</code></pre>
<p>ğŸ¯ <strong>è¿™æ˜¯ React å®˜æ–¹æ¨èæ¨¡å¼</strong></p>
<ul>
<li>state åˆå§‹åŒ– â†’ ç¡®å®š</li>
<li>å¼‚æ­¥è¯·æ±‚ â†’ å‰¯ä½œç”¨</li>
<li>æ•°æ®å›æ¥ â†’ æ›´æ–°çŠ¶æ€</li>
</ul>
<hr/>
<h3 data-id="heading-18">ğŸ”„ ä¹ã€ä¸ºä»€ä¹ˆ setState å¯ä»¥ä¼ å‡½æ•°ï¼Ÿ</h3>
<pre><code class="hljs language-ini" lang="ini">setNum(<span class="hljs-attr">prev</span> =&gt; prev + <span class="hljs-number">1</span>)
</code></pre>
<p>è¿™ä¸æ˜¯â€œèŠ±é‡Œèƒ¡å“¨â€ï¼Œè€Œæ˜¯<strong>å¹¶å‘å®‰å…¨è®¾è®¡</strong>ã€‚</p>
<p>React å†…éƒ¨å¯èƒ½ä¼šï¼š</p>
<ul>
<li>åˆå¹¶å¤šæ¬¡æ›´æ–°</li>
<li>å»¶è¿Ÿæ‰§è¡Œ setState</li>
</ul>
<p>å¦‚æœä½ ç›´æ¥ç”¨ <code>num + 1</code>ï¼Œå¾ˆå¯èƒ½æ‹¿åˆ°çš„æ˜¯æ—§å€¼ã€‚</p>
<blockquote>
<p><strong>å‡½æ•°å¼ setState = æ°¸è¿œå®‰å…¨</strong></p>
</blockquote>
<hr/>
<h3 data-id="heading-19">ğŸ åã€Hooks çš„çœŸæ­£ä»·å€¼ï¼ˆæ€»ç»“ï¼‰</h3>
<p>å¦‚æœä½ åªæŠŠ Hooks å½“æˆï¼š</p>
<blockquote>
<p>â€œä¸ç”¨å†™ class äº†â€</p>
</blockquote>
<p>é‚£ä½ åªçœ‹åˆ°äº†è¡¨é¢ã€‚</p>
<h4 data-id="heading-20">Hooks çœŸæ­£è§£å†³çš„æ˜¯ï¼š</h4>
<ul>
<li>ğŸ§© <strong>çŠ¶æ€å¦‚ä½•åœ¨å‡½æ•°ä¸­ç¨³å®šå­˜åœ¨</strong></li>
<li>ğŸ§¯ <strong>å‰¯ä½œç”¨å¦‚ä½•è¢«ç²¾ç¡®æ§åˆ¶</strong></li>
<li>ğŸ§  <strong>ç”Ÿå‘½å‘¨æœŸå¦‚ä½•æ˜¾å¼å»ºæ¨¡</strong></li>
<li>ğŸ”’ <strong>å†…å­˜æ³„æ¼å¦‚ä½•è¢«ä¸»åŠ¨è§„é¿</strong></li>
</ul>
<hr/>
<h3 data-id="heading-21">âœ¨ æœ€åçš„æ˜é‡‘é‡‘å¥</h3>
<blockquote>
<p><strong>useState è§£å†³çš„æ˜¯ï¼šæ•°æ®å¦‚ä½•â€œæ´»ç€â€</strong><br/>
<strong>useEffect è§£å†³çš„æ˜¯ï¼šå‰¯ä½œç”¨å¦‚ä½•â€œå–„ç»ˆâ€</strong></p>
<p>React Hooks ä¸åªæ˜¯è¯­æ³•å‡çº§ï¼Œ<br/>
è€Œæ˜¯ä¸€åœºä»â€œå‘½ä»¤å¼ç”Ÿå‘½å‘¨æœŸâ€<br/>
åˆ°â€œå£°æ˜å¼å‰¯ä½œç”¨ç®¡ç†â€çš„é©å‘½ã€‚</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI Agent ä»‹ç»]]></title>    <link>https://juejin.cn/post/7585458459166359586</link>    <guid>https://juejin.cn/post/7585458459166359586</guid>    <pubDate>2025-12-20T12:18:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585458459166359586" data-draft-id="7585476892976070690" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI Agent ä»‹ç»"/> <meta itemprop="keywords" content="å‰ç«¯,åç«¯,äººå·¥æ™ºèƒ½"/> <meta itemprop="datePublished" content="2025-12-20T12:18:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="å­æ´‹"/> <meta itemprop="url" content="https://juejin.cn/user/1099167359835015"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="æ˜é‡‘"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI Agent ä»‹ç»
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1099167359835015/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    å­æ´‹
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T12:18:00.000Z" title="Sat Dec 20 2025 12:18:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    é˜…è¯»7åˆ†é’Ÿ
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{font-family:-apple-system,BlinkMacSystemFont,PingFang SC,Helvetica Neue,Helvetica,Arial,sans-serif;word-break:break-word;line-height:1.75;font-weight:200;font-size:16px;overflow-x:hidden;color:#666;letter-spacing:.5px}.markdown-body a{text-decoration:none;color:#0064c8;position:relative}.markdown-body a:after{content:"";position:absolute;bottom:-2px;left:0;width:100%;height:1px;background-color:rgba(0,100,200,.7);transform:scale(0);transition:all .4s ease-in-out}.markdown-body a:link:hover:after{transform:scale(1)}.markdown-body code{padding:2px 4px;font-size:.9em;font-family:Menlo,Monaco,Consolas,Courier New,monospace;border-radius:2px;background-color:rgba(0,46,70,.0431);color:#39f}.markdown-body strong{font-weight:400}.markdown-body em{color:#ff6a00}.markdown-body del,.markdown-body s{color:#bbb}.markdown-body small{font-size:.8em;color:#bbb}.markdown-body kbd{margin:0 .1em;padding:5px 8px 3px;border:1px solid #d1d5d9;border-radius:3px;box-shadow:0 1px 0 0 #e3e4e6,inset 0 0 0 2px #fff;background-color:#eee;font-weight:600;font-size:.8em;font-family:Arial,Helvetica Neue,Helvetica,sans-serif;white-space:nowrap;color:#666}.markdown-body kbd:first-child{margin-left:0}.markdown-body kbd:last-child{margin-right:0}.markdown-body img{display:block;border:0;max-width:calc(100% - 20px);min-width:20px;min-height:20px;margin:0 10px;box-shadow:0 2px 8px 2px rgba(0,0,0,.2);transition:all .25s ease-in-out}.markdown-body img:hover{transform:translateY(-4px)}.markdown-body blockquote,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body ol,.markdown-body p,.markdown-body pre,.markdown-body table,.markdown-body ul{line-height:inherit;font-size:inherit;color:inherit}.markdown-body blockquote:first-child,.markdown-body h1:first-child,.markdown-body h2:first-child,.markdown-body h3:first-child,.markdown-body h4:first-child,.markdown-body h5:first-child,.markdown-body h6:first-child,.markdown-body ol:first-child,.markdown-body p:first-child,.markdown-body pre:first-child,.markdown-body table:first-child,.markdown-body ul:first-child{margin-top:0}.markdown-body blockquote:last-child,.markdown-body h1:last-child,.markdown-body h2:last-child,.markdown-body h3:last-child,.markdown-body h4:last-child,.markdown-body h5:last-child,.markdown-body h6:last-child,.markdown-body ol:last-child,.markdown-body p:last-child,.markdown-body pre:last-child,.markdown-body table:last-child,.markdown-body ul:last-child{margin-bottom:0}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:1.6em 0 .6em;color:#333;font-weight:400;position:relative}.markdown-body h1:before,.markdown-body h2:before,.markdown-body h3:before,.markdown-body h4:before,.markdown-body h5:before,.markdown-body h6:before{position:absolute;left:-2em}.markdown-body h1{font-size:1.75em}.markdown-body h1:before{content:"#"}.markdown-body h1:first-child{margin-top:0}.markdown-body h2{font-size:1.5em}.markdown-body h3{font-size:1.35em}.markdown-body h4{font-size:1.2em}.markdown-body h5{font-size:1.1em}.markdown-body h6{font-size:1em}.markdown-body blockquote,.markdown-body ol,.markdown-body pre,.markdown-body table,.markdown-body ul{margin:1em 0}.markdown-body p{margin:.7em 0;word-break:break-word}.markdown-body pre{padding:8px 12px;color:#666;background-color:rgba(0,46,70,.0431);border:1px solid #ebebeb;tab-size:4;white-space:pre-wrap;line-height:1.4}.markdown-body pre code{color:inherit;background-color:transparent;padding:0}.markdown-body ol,.markdown-body ul{margin:1em 0 1em 2em;padding:0;line-height:1.5!important;font-size:inherit;color:inherit}.markdown-body ol:first-child,.markdown-body ul:first-child{margin-top:0}.markdown-body ol:last-child,.markdown-body ul:last-child{margin-bottom:0}.markdown-body ol li,.markdown-body ul li{margin:.5em 0;list-style:inherit}.markdown-body ul{list-style:disc outside}.markdown-body ul ul{list-style-type:circle}.markdown-body ul ul ul{list-style-type:square}.markdown-body ol{list-style:decimal outside}.markdown-body ol ol{list-style-type:lower-alpha}.markdown-body ol ol ol{list-style-type:lower-roman}.markdown-body blockquote{font-size:.9em;padding:8px 20px 8px 15px;color:#666;border-left:5px solid rgba(0,100,200,.7);background-color:rgba(0,100,200,.1)}.markdown-body table{border-collapse:collapse;border-spacing:0;max-width:100%;min-width:50%;word-wrap:break-word;color:inherit}.markdown-body table thead tr{background-color:#f4f6f7}.markdown-body table td,.markdown-body table th{padding:4px 16px;font-size:.95em;text-align:left;color:inherit;border:0;min-width:72px}.markdown-body table td[align=center],.markdown-body table th[align=center]{text-align:center}.markdown-body table td[align=right],.markdown-body table th[align=right]{text-align:right}.markdown-body table th{border-bottom:2px solid #e3e4e6;color:#333;font-weight:400;white-space:nowrap}.markdown-body table td{border-bottom:1px solid #ebebeb}.markdown-body hr{margin:1.5em 0;padding:0;border:0;background:linear-gradient(90deg,rgba(0,46,70,.0431),#ebebeb 50%,rgba(0,46,70,.0431));height:1px}.markdown-body br{content:"";display:block}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><h2 data-id="heading-0">å‰è¨€</h2>
<p>è¿™å‘¨åœ¨ç»„å†…åšäº†ä¸€æ¬¡å…³äº <strong>Agent è®¾è®¡æ¨¡å¼</strong> çš„åˆ†äº«ï¼Œä¸»è¦ä»‹ç»å’Œè®²è§£äº† <strong>ReAct æ¨¡å¼</strong> ä¸ <strong>P&amp;Aï¼ˆPlan and Executeï¼‰æ¨¡å¼</strong>ã€‚æˆ‘è®¡åˆ’å°†è¿™æ¬¡åˆ†äº«æ‹†åˆ†ä¸ºä¸‰ç¯‡æ–‡ç« ï¼Œå¯¹æˆ‘åœ¨ç»„ä¼šä¸­è®²è§£çš„å†…å®¹è¿›è¡Œæ›´åŠ ç³»ç»Ÿå’Œç»†è‡´çš„æ•´ç†ã€‚</p>
<p>åœ¨æ­£å¼è¿›å…¥å…·ä½“çš„ Agent æ¨¡å¼å®ç°ä¹‹å‰ï¼Œæœ‰ä¸€ä¸ªç»•ä¸å¼€çš„é—®é¢˜éœ€è¦å…ˆå›ç­”æ¸…æ¥šï¼š</p>
<blockquote>
<p><strong>ä»€ä¹ˆæ˜¯ AI Agentï¼Ÿå®ƒè§£å†³äº†ä»€ä¹ˆé—®é¢˜ï¼Ÿä»¥åŠåœ¨è¿‘å‡ å¹´ AI æŠ€æœ¯ä¸åº”ç”¨å¿«é€Ÿæ¼”è¿›çš„è¿‡ç¨‹ä¸­ï¼ŒAI åº”ç”¨çš„å¼€å‘èŒƒå¼ç»å†äº†å“ªäº›å…³é”®å˜åŒ–ï¼Ÿ</strong></p>
</blockquote>
<p>è¿™ä¸€ç¯‡å°†ä¸ç›´æ¥å±•å¼€æŸä¸€ç§ Agent æ¨¡å¼çš„å®ç°ç»†èŠ‚ï¼Œè€Œæ˜¯å…ˆå›åˆ°æ›´å®è§‚çš„è§†è§’ï¼Œä» <strong>AI åº”ç”¨å½¢æ€ä¸å·¥ç¨‹èŒƒå¼çš„æ¼”è¿›</strong> å…¥æ‰‹ï¼Œæ¢³ç† Agent å‡ºç°çš„æŠ€æœ¯èƒŒæ™¯ä¸å¿…ç„¶æ€§ã€‚</p>
<p>éœ€è¦è¯´æ˜çš„æ˜¯ï¼Œä¸‹æ–‡å¯¹ AI åº”ç”¨æ¼”è¿›é˜¶æ®µçš„åˆ’åˆ†ï¼Œæ˜¯ä¸€ç§<strong>ä»¥â€œåº”ç”¨å¼€å‘èŒƒå¼â€ä¸ºæ ¸å¿ƒçš„æŠ½è±¡æ€»ç»“</strong>ã€‚çœŸå®çš„æŠ€æœ¯æ¼”è¿›åœ¨æ—¶é—´ä¸Šå­˜åœ¨æ˜æ˜¾é‡å ï¼Œä½†è¿™ç§é˜¶æ®µåŒ–çš„å™è¿°æœ‰åŠ©äºæˆ‘ä»¬ç†è§£ï¼š<strong>ä¸ºä»€ä¹ˆ Agent ä¼šåœ¨å½“ä¸‹æˆä¸ºä¸»æµæ–¹å‘</strong>ã€‚</p>
<h2 data-id="heading-1">AI åº”ç”¨çš„å‘å±•å†ç¨‹</h2>
<h3 data-id="heading-2">ç¬¬ä¸€é˜¶æ®µï¼šæç¤ºè¯å·¥ç¨‹</h3>
<p>2022 å¹´ 11 æœˆï¼ŒGPT-3.5 å‘å¸ƒåï¼Œå¤§æ¨¡å‹å¼€å§‹ä»ç ”ç©¶é¢†åŸŸè¿›å…¥å¤§ä¼—è§†é‡ã€‚å¯¹å¼€å‘è€…æ¥è¯´ï¼Œè¿™æ˜¯ç¬¬ä¸€æ¬¡å¯ä»¥åœ¨å®é™…äº§å“ä¸­ç›´æ¥ä½¿ç”¨é€šç”¨è¯­è¨€æ¨¡å‹ã€‚</p>
<p>è¿™ä¸€é˜¶æ®µçš„ AI åº”ç”¨å½¢æ€éå¸¸ç®€å•ï¼Œå¤§å¤šæ•°äº§å“æœ¬è´¨ä¸Šéƒ½æ˜¯ä¸€ä¸ªå¯¹è¯ç•Œé¢ï¼š<code>ç”¨æˆ·è¾“å…¥é—®é¢˜</code> â†’ <code>æ¨¡å‹ç”Ÿæˆå›ç­”</code> â†’ <code>ç»“æŸ</code>ã€‚</p>
<p>å¾ˆå¿«ï¼Œå›´ç»• Prompt çš„å·¥ç¨‹å®è·µå¼€å§‹å‡ºç°ã€‚ç”±äºæ¨¡å‹å¯¹ä¸Šä¸‹æ–‡éå¸¸æ•æ„Ÿï¼Œ<strong>ç³»ç»Ÿæç¤ºè¯ï¼ˆSystem Promptï¼‰æˆä¸ºå½“æ—¶æœ€ç›´æ¥ã€ä¹Ÿæœ€æœ‰æ•ˆçš„æ§åˆ¶æ‰‹æ®µ</strong>ã€‚å¸¸è§çš„åšæ³•æ˜¯é€šè¿‡æç¤ºè¯çº¦æŸæ¨¡å‹çš„è§’è‰²ã€è¾“å‡ºå½¢å¼å’Œå…³æ³¨é‡ç‚¹ï¼Œä¾‹å¦‚ï¼š</p>
<blockquote>
<p>â€œä½ æ˜¯ä¸€ä¸ªèµ„æ·±çš„å‰ç«¯å¼€å‘å·¥ç¨‹å¸ˆï¼Œè¯·ä¸¥æ ¼ä»¥ JSON æ ¼å¼è¾“å‡ºç»“æœâ€¦â€¦â€</p>
</blockquote>
<p>è¿™ç±»â€œèº«ä»½é¢å…·â€å¼çš„æç¤ºï¼Œæœ¬è´¨ä¸Šæ˜¯é€šè¿‡ä¸Šä¸‹æ–‡çº¦æŸæ¥å‡å°‘æ¨¡å‹è¾“å‡ºçš„å‘æ•£æ€§ï¼Œè®©ç»“æœæ›´è´´è¿‘é¢„æœŸã€‚åœ¨è¿™ä¸€é˜¶æ®µï¼Œä¹Ÿé™†ç»­å‡ºç°äº† <strong>Chain-of-Thoughtã€Few-shot Prompting</strong> ç­‰æ¨ç†å¢å¼ºæŠ€å·§ï¼Œä½†å®ƒä»¬ä¾ç„¶å±äº<strong>å•æ¬¡ç”Ÿæˆæ¨¡å¼</strong>ï¼šæ¨¡å‹åœ¨ä¸€æ¬¡è°ƒç”¨ä¸­å®Œæˆå…¨éƒ¨æ¨ç†ï¼Œè¿‡ç¨‹ä¸­æ— æ³•è·å¾—å¤–éƒ¨åé¦ˆï¼Œä¹Ÿæ— æ³•æ ¹æ®ä¸­é—´ç»“æœè°ƒæ•´ç­–ç•¥ã€‚</p>
<h3 data-id="heading-3">ç¬¬äºŒé˜¶æ®µï¼šRAG</h3>
<p>å½“ AI å¼€å§‹è¢«ç”¨äºçœŸå®ä¸šåŠ¡åœºæ™¯æ—¶ï¼Œå¾ˆå¿«æš´éœ²å‡ºä¸¤ä¸ªé—®é¢˜ï¼š<strong>æ¨¡å‹ä¸äº†è§£ç§æœ‰çŸ¥è¯†</strong>ï¼Œä»¥åŠ<strong>ç”Ÿæˆç»“æœéš¾ä»¥æ ¡éªŒ</strong>ã€‚ä»¥ GPT-3.5 ä¸ºä¾‹ï¼Œå®ƒçš„è®­ç»ƒæ•°æ®æˆªæ­¢åœ¨ 21 å¹´å·¦å³ï¼Œå¯¹äºæ–°æŠ€æœ¯ä»¥åŠä¼ä¸šå†…éƒ¨æ–‡æ¡£ã€ä¸šåŠ¡è§„åˆ™æ›´æ˜¯ä¸äº†è§£ï¼Œç›´æ¥ä½¿ç”¨å¾€å¾€ä¸å¯æ§ã€‚</p>
<p>RAGï¼ˆRetrieval-Augmented Generationï¼‰æ˜¯åœ¨è¿™ç§èƒŒæ™¯ä¸‹è¢«å¹¿æ³›é‡‡ç”¨çš„æ–¹æ¡ˆã€‚å®ƒçš„æ ¸å¿ƒåšæ³•æ˜¯ï¼š</p>
<ul>
<li>å°†ç§æœ‰çŸ¥è¯†è¿›è¡Œåˆ‡åˆ†å’Œå‘é‡åŒ–å­˜å‚¨ï¼›</li>
<li>ç”¨æˆ·æé—®æ—¶ï¼Œå…ˆè¿›è¡Œç›¸ä¼¼åº¦æ£€ç´¢ï¼›</li>
<li>å°†å‘½ä¸­çš„å†…å®¹ä½œä¸ºä¸Šä¸‹æ–‡æä¾›ç»™æ¨¡å‹ï¼Œå†ç”±æ¨¡å‹å®Œæˆç”Ÿæˆã€‚</li>
</ul>
<p>é€šè¿‡è¿™ç§æ–¹å¼ï¼Œæ¨¡å‹ä¸éœ€è¦è®°ä½æ‰€æœ‰çŸ¥è¯†ï¼Œè€Œæ˜¯åœ¨ç”Ÿæˆæ—¶æŒ‰éœ€è·å–å‚è€ƒä¿¡æ¯ã€‚</p>
<p>RAG çš„ä»·å€¼ä¸ä»…åœ¨äºè¡¥å……æ–°çŸ¥è¯†ï¼Œæ›´é‡è¦çš„æ˜¯å¸¦æ¥äº†<strong>å¯æ§æ€§å’Œå¯è¿½æº¯æ€§</strong>ï¼šç”Ÿæˆå†…å®¹å¯ä»¥æ˜ç¡®å¯¹åº”åˆ°åŸå§‹æ–‡æ¡£ï¼Œè¿™ä¸€ç‚¹åœ¨ä¼ä¸šåœºæ™¯ä¸­å°¤ä¸ºå…³é”®ã€‚</p>
<h3 data-id="heading-4">ç¬¬ä¸‰é˜¶æ®µï¼šTool Calling</h3>
<p>å¦‚æœè¯´ RAG è®©æ¨¡å‹èƒ½å¤Ÿâ€œæŸ¥èµ„æ–™â€ï¼Œé‚£ä¹ˆ <strong>Function / Tool Calling</strong> åˆ™è®©æ¨¡å‹å¼€å§‹èƒ½å¤Ÿâ€œåšäº‹æƒ…â€ã€‚</p>
<p>åœ¨è¿™ä¸€é˜¶æ®µï¼Œå¼€å‘è€…ä¼šæŠŠå¯ç”¨èƒ½åŠ›ï¼ˆå¦‚æŸ¥è¯¢æ•°æ®åº“ã€è°ƒç”¨æ¥å£ã€æ‰§è¡Œè„šæœ¬ï¼‰ä»¥ç»“æ„åŒ–çš„æ–¹å¼æä¾›ç»™æ¨¡å‹ï¼ŒåŒ…æ‹¬å‡½æ•°åã€å‚æ•°è¯´æ˜å’ŒåŠŸèƒ½æè¿°ã€‚æ¨¡å‹åœ¨ç†è§£ç”¨æˆ·æ„å›¾åï¼Œå¯ä»¥è¿”å›ä¸€ä¸ªæ˜ç¡®çš„å·¥å…·è°ƒç”¨è¯·æ±‚ï¼Œå†ç”±ç¨‹åºå®Œæˆå®é™…æ‰§è¡Œã€‚</p>
<p>è¿™ä¸€èƒ½åŠ›çš„å‡ºç°ï¼Œæ ‡å¿—ç€ <strong>AI ç¬¬ä¸€æ¬¡åœ¨å·¥ç¨‹ä¸Šå…·å¤‡äº†å¯é è°ƒç”¨å¤–éƒ¨ç³»ç»Ÿçš„èƒ½åŠ›</strong>ã€‚å®ƒä¸å†åªæ˜¯ä¸€ä¸ªèŠå¤©æœºå™¨äººï¼Œè€Œæ˜¯ä¸€ä¸ªå¯ä»¥è§¦å‘çœŸå®ä¸–ç•ŒåŠ¨ä½œçš„â€œæ§åˆ¶å™¨â€ï¼Œè¿™ä¹Ÿæ˜¯åç»­ Agent èƒ½å¤Ÿè½åœ°çš„å…³é”®æŠ€æœ¯æ”¯æ’‘ã€‚</p>
<h3 data-id="heading-5">ç¬¬å››é˜¶æ®µï¼šAI Workflow</h3>
<p>å½“ RAG èƒ½åŠ›å’Œ Tool Calling èƒ½åŠ›é€æ¸æˆç†Ÿåï¼Œå¼€å‘è€…å¼€å§‹å°è¯•æŠŠå¤šä¸ªæ­¥éª¤ç»„åˆèµ·æ¥ï¼Œå½¢æˆå®Œæ•´çš„ä¸šåŠ¡æµç¨‹ã€‚è¿™å‚¬ç”Ÿäº†ä»¥ Difyã€Coze ä¸ºä»£è¡¨çš„ <strong>AI Workflow</strong> èŒƒå¼ã€‚</p>
<p>åœ¨ Workflow æ¨¡å¼ä¸‹ï¼Œä¸€ä¸ª AI åº”ç”¨ä¼šè¢«æ‹†è§£ä¸ºå¤šä¸ªå›ºå®šèŠ‚ç‚¹ï¼Œå¹¶æŒ‰ç…§é¢„è®¾é¡ºåºæ‰§è¡Œï¼Œä¾‹å¦‚ï¼šæ£€ç´¢ â†’ åˆ¤æ–­ â†’ å·¥å…·è°ƒç”¨ â†’ æ±‡æ€»è¾“å‡ºã€‚</p>
<p>Workflow çš„ä¼˜åŠ¿éå¸¸æ˜æ˜¾ï¼š</p>
<ul>
<li>æµç¨‹æ¸…æ™°ï¼Œè¡Œä¸ºå¯é¢„æœŸï¼›</li>
<li>æ˜“äºæµ‹è¯•å’Œè¿è¥ï¼›</li>
<li>å¯¹éå·¥ç¨‹äººå‘˜å‹å¥½ã€‚</li>
</ul>
<p>ä½†é—®é¢˜ä¹ŸåŒæ ·æ˜æ˜¾ï¼šæµç¨‹å®Œå…¨ç”±äººè®¾è®¡ï¼Œæ¨¡å‹åªæ˜¯æ‰§è¡Œè€…ã€‚æ— è®ºé—®é¢˜å¤æ‚ä¸å¦ï¼Œéƒ½å¿…é¡»èµ°å®Œæ•´æ¡è·¯å¾„ã€‚è¿™ç§æ–¹å¼åœ¨åº”å¯¹é«˜åº¦åŠ¨æ€æˆ–éæ ‡å‡†ä»»åŠ¡æ—¶ï¼Œçµæ´»æ€§æœ‰é™ã€‚</p>
<h3 data-id="heading-6">ç¬¬äº”é˜¶æ®µï¼šAgent</h3>
<p>åœ¨ Agent å‡ºç°ä¹‹å‰ï¼Œå¤§å¤šæ•° AI åº”ç”¨ä»ç„¶éµå¾ªä¸€ç§å…¸å‹æ¨¡å¼ï¼š<code>è¾“å…¥</code> â†’ <code>å•æ¬¡/ç¼–æ’å¥½çš„æ¨ç†</code> â†’ <code>è¾“å‡º</code>ã€‚</p>
<p>è€Œ Agent çš„å‡ºç°ï¼Œæœ¬è´¨ä¸Šæ˜¯<strong>å°†â€œä»»åŠ¡ç¼–æ’â€çš„æ§åˆ¶æƒä»äººç±»æ‰‹ä¸­äº¤è¿˜ç»™äº† AI</strong>ã€‚åœ¨ Agent æ¶æ„ä¸‹ï¼ŒAI ä¸å†æ˜¯è¢«åŠ¨æ‰§è¡Œä¸€æ®µä»£ç ï¼Œè€Œæ˜¯ä¸€ä¸ªå…·å¤‡ä»¥ä¸‹æ ¸å¿ƒèƒ½åŠ›çš„é—­ç¯ç³»ç»Ÿï¼š</p>
<ul>
<li>å°†å¤æ‚ç›®æ ‡æ‹†è§£ä¸ºå¤šä¸ªå¯æ‰§è¡Œæ­¥éª¤ï¼›</li>
<li>æ ¹æ®å·¥å…·æ‰§è¡Œç»“æœè°ƒæ•´åç»­è¡ŒåŠ¨ï¼›</li>
<li>åœ¨å¤±è´¥æ—¶å°è¯•ä¿®æ­£ç­–ç•¥ï¼›</li>
<li>åœ¨å¤šæ­¥è¿‡ç¨‹ä¸­ç»´æŠ¤ä¸Šä¸‹æ–‡çŠ¶æ€ã€‚</li>
</ul>
<p>è¿™äº›èƒ½åŠ›å¹¶ä¸æ˜¯ä¸€æ¬¡æ¨¡å‹è°ƒç”¨å®Œæˆçš„ï¼Œè€Œæ˜¯é€šè¿‡å¤šè½®æ¨ç†ä¸æ‰§è¡Œå½¢æˆé—­ç¯ã€‚ä¹Ÿæ­£æ˜¯åœ¨è¿™ä¸€ç‚¹ä¸Šï¼ŒAgent ä¸å‰é¢çš„åº”ç”¨å½¢æ€æ‹‰å¼€äº†å·®è·ã€‚</p>
<h2 data-id="heading-7">Agent è®¾è®¡æ¨¡å¼è§£å†³çš„é—®é¢˜</h2>
<p>å½“ Agent å¼€å§‹æ‰¿æ‹…æ›´å¤æ‚çš„ä»»åŠ¡æ—¶ï¼Œé—®é¢˜ä¹Ÿéšä¹‹å‡ºç°ï¼š</p>
<ul>
<li>å¤šæ­¥æ¨ç†å®¹æ˜“è·‘åï¼›</li>
<li>æ‰§è¡Œå¤±è´¥åç¼ºä¹ç»Ÿä¸€çš„ä¿®æ­£ç­–ç•¥ï¼›</li>
<li>æˆæœ¬å’Œç¨³å®šæ€§éš¾ä»¥æ§åˆ¶ã€‚</li>
</ul>
<p><strong>Agent è®¾è®¡æ¨¡å¼çš„ä½œç”¨ï¼Œå°±æ˜¯æŠŠè¿™äº›åå¤å‡ºç°çš„é—®é¢˜æŠ½è±¡æˆå¯å¤ç”¨çš„ç»“æ„ã€‚</strong></p>
<p>æ— è®ºæ˜¯ <strong>ReAct</strong>ï¼Œè¿˜æ˜¯ <strong>Plan and Execute</strong>ï¼Œå®ƒä»¬å…³æ³¨çš„æ ¸å¿ƒå¹¶ä¸æ˜¯â€œè®©æ¨¡å‹æ›´èªæ˜â€ï¼Œè€Œæ˜¯ï¼š<strong>å¦‚ä½•åœ¨å·¥ç¨‹ä¸Šç»„ç»‡æ¨¡å‹çš„æ¨ç†ã€è¡ŒåŠ¨å’Œåé¦ˆè¿‡ç¨‹ï¼Œä½¿ç³»ç»Ÿæ•´ä½“å¯æ§ã€å¯ç»´æŠ¤ã€‚</strong></p>
<p>ç†è§£è¿™äº›æ¨¡å¼ï¼Œæœ‰åŠ©äºæˆ‘ä»¬åœ¨æ„å»º Agent ç³»ç»Ÿæ—¶å°‘èµ°å¼¯è·¯ï¼Œè€Œä¸æ˜¯æ¯ä¸€æ¬¡éƒ½ä»é›¶å¼€å§‹è®¾è®¡æ•´å¥—äº¤äº’ä¸æ§åˆ¶é€»è¾‘ã€‚</p>
<h2 data-id="heading-8">ç»“è¯­</h2>
<p>ä»æœ€åˆåŸºäº Prompt çš„ç®€å•å¯¹è¯ï¼Œåˆ°å¦‚ä»Šå…·å¤‡ä¸€å®šè‡ªä¸»èƒ½åŠ›çš„ Agentï¼Œæˆ‘ä»¬çœ‹åˆ°çš„ä¸åªæ˜¯æ¨¡å‹èƒ½åŠ›çš„æå‡ï¼Œæ›´æ˜¯ AI åœ¨å®é™…ä½¿ç”¨æ–¹å¼ä¸Šçš„å˜åŒ–ã€‚</p>
<p>å›é¡¾æ•´ä¸ªè¿‡ç¨‹ä¼šå‘ç°ï¼Œå¾ˆå¤šå…³é”®æŠ€æœ¯å¹¶ä¸æ˜¯æœ€è¿‘æ‰å‡ºç°çš„ã€‚RAG çš„æ ¸å¿ƒæ€è·¯æ—©åœ¨å‡ å¹´å‰å°±å·²ç»è¢«æå‡ºï¼ŒReAct ä¹Ÿå¹¶éæ–°æ¦‚å¿µï¼Œåªæ˜¯åœ¨æœ€è¿‘éšç€æ¨¡å‹æ¨ç†èƒ½åŠ›æå‡ã€å·¥å…·é“¾é€æ¸æˆç†Ÿï¼Œæ‰çœŸæ­£å…·å¤‡äº†å·¥ç¨‹è½åœ°çš„æ¡ä»¶ã€‚å¾ˆå¤šæ—¶å€™ï¼Œå¹¶ä¸æ˜¯æƒ³æ³•ä¸å­˜åœ¨ï¼Œè€Œæ˜¯æ—¶æœºè¿˜æ²¡åˆ°ã€‚</p>
<p>ç†è§£è¿™äº›æ¼”è¿›èƒŒæ™¯ï¼Œæœ‰åŠ©äºæˆ‘ä»¬åˆ¤æ–­å“ªäº›èƒ½åŠ›æ˜¯çŸ­æœŸå™±å¤´ï¼Œå“ªäº›æ˜¯é•¿æœŸæ–¹å‘ã€‚ä¸‹ä¸€ç¯‡æ–‡ç« å°†èšç„¦ Agent è®¾è®¡æ¨¡å¼ä¸­æœ€å¸¸è§ã€ä¹Ÿæœ€å®ç”¨çš„ ReAct æ¨¡å¼ï¼Œç»“åˆå®é™…å®ç°ï¼Œçœ‹çœ‹å®ƒæ˜¯å¦‚ä½•è®© AI åœ¨æ‰§è¡Œä»»åŠ¡çš„è¿‡ç¨‹ä¸­é€æ­¥æ€è€ƒã€ä¸æ–­è°ƒæ•´ç­–ç•¥çš„ã€‚</p>
<h2 data-id="heading-9">å‚è€ƒèµ„æ–™</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.promptingguide.ai%2F" target="_blank" title="https://www.promptingguide.ai/" ref="nofollow noopener noreferrer">æç¤ºå·¥ç¨‹æŒ‡å—</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bohrium.com%2Fpaper%2Fread%3FlibraryId%3D8578838" target="_blank" title="https://www.bohrium.com/paper/read?libraryId=8578838" ref="nofollow noopener noreferrer">Chain-of-Thought Prompting Elicits Reasoning in Large Language Models.</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bohrium.com%2Fpaper%2Fread%3FlibraryId%3D8579062" target="_blank" title="https://www.bohrium.com/paper/read?libraryId=8579062" ref="nofollow noopener noreferrer">Language Models are Few-Shot Learners</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bohrium.com%2Fpaper%2Fread%3FlibraryId%3D8578906%26activeReadTab%3Dchat" target="_blank" title="https://www.bohrium.com/paper/read?libraryId=8578906&amp;activeReadTab=chat" ref="nofollow noopener noreferrer">Retrieval-Augmented Generation for Knowledge-Intensive NLP Tasks.</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bohrium.com%2Fpaper%2Fread%3FlibraryId%3D8578958%26activeReadTab%3Dchat" target="_blank" title="https://www.bohrium.com/paper/read?libraryId=8578958&amp;activeReadTab=chat" ref="nofollow noopener noreferrer">Toolformer: Language Models Can Teach Themselves to Use Tools.</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bohrium.com%2Fpaper%2Fread%3FlibraryId%3D8578981" target="_blank" title="https://www.bohrium.com/paper/read?libraryId=8578981" ref="nofollow noopener noreferrer">A Survey on Large Language Model based Autonomous Agents.</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[ã€èŠ‚ç‚¹ã€‘[LinearToGammaSpaceExactèŠ‚ç‚¹]åŸç†è§£æä¸å®é™…åº”ç”¨]]></title>    <link>https://juejin.cn/post/7585484081435639859</link>    <guid>https://juejin.cn/post/7585484081435639859</guid>    <pubDate>2025-12-20T11:07:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585484081435639859" data-draft-id="7585463258691174409" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="ã€èŠ‚ç‚¹ã€‘[LinearToGammaSpaceExactèŠ‚ç‚¹]åŸç†è§£æä¸å®é™…åº”ç”¨"/> <meta itemprop="keywords" content="æ¸¸æˆå¼€å‘,å›¾å½¢å­¦,Unity3D"/> <meta itemprop="datePublished" content="2025-12-20T11:07:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SmalBox"/> <meta itemprop="url" content="https://juejin.cn/user/2218166695237532"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="æ˜é‡‘"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ã€èŠ‚ç‚¹ã€‘[LinearToGammaSpaceExactèŠ‚ç‚¹]åŸç†è§£æä¸å®é™…åº”ç”¨
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2218166695237532/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SmalBox
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T11:07:21.000Z" title="Sat Dec 20 2025 11:07:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    é˜…è¯»10åˆ†é’Ÿ
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fchenghai37%2Fcategory_13074589.html%3Ffromshare%3Dblogcolumn%26sharetype%3Dblogcolumn%26sharerId%3D13074589%26sharerefer%3DPC%26sharesource%3Dchenghai37%26sharefrom%3Dfrom_link" target="_blank" title="https://blog.csdn.net/chenghai37/category_13074589.html?fromshare=blogcolumn&amp;sharetype=blogcolumn&amp;sharerId=13074589&amp;sharerefer=PC&amp;sharesource=chenghai37&amp;sharefrom=from_link" ref="nofollow noopener noreferrer">ã€Unity Shader Graph ä½¿ç”¨ä¸ç‰¹æ•ˆå®ç°ã€‘</a><strong>ä¸“æ -ç›´è¾¾</strong></p>
</blockquote>
<h2 data-id="heading-0">çº¿æ€§é¢œè‰²ç©ºé—´ä¸ä¼½é©¬é¢œè‰²ç©ºé—´åŸºç¡€æ¦‚å¿µ</h2>
<p>åœ¨è®¡ç®—æœºå›¾å½¢å­¦ä¸­ï¼Œé¢œè‰²ç©ºé—´çš„ç®¡ç†æ˜¯æ¸²æŸ“æµç¨‹ä¸­è‡³å…³é‡è¦çš„ç¯èŠ‚ã€‚ç†è§£çº¿æ€§é¢œè‰²ç©ºé—´å’Œä¼½é©¬é¢œè‰²ç©ºé—´çš„åŒºåˆ«å¯¹äºåˆ›å»ºé€¼çœŸçš„æ¸²æŸ“æ•ˆæœè‡³å…³é‡è¦ã€‚</p>
<p>çº¿æ€§é¢œè‰²ç©ºé—´æŒ‡çš„æ˜¯é¢œè‰²æ•°å€¼ä¸å®é™…ç‰©ç†å…‰å¼ºå‘ˆçº¿æ€§å…³ç³»çš„é¢œè‰²è¡¨ç¤ºæ–¹å¼ã€‚åœ¨è¿™ç§ç©ºé—´ä¸­ï¼Œé¢œè‰²å€¼0.5è¡¨ç¤ºçš„å…‰å¼ºæ­£å¥½æ˜¯é¢œè‰²å€¼1.0çš„ä¸€åŠã€‚è¿™ç§è¡¨ç¤ºæ–¹å¼ç¬¦åˆç‰©ç†ä¸–ç•Œçš„çœŸå®å…‰ç…§è¡Œä¸ºï¼Œåœ¨æ¸²æŸ“è®¡ç®—ä¸­èƒ½å¤Ÿäº§ç”Ÿå‡†ç¡®çš„æ•°å­¦ç»“æœã€‚</p>
<p>ä¼½é©¬é¢œè‰²ç©ºé—´åˆ™æ˜¯ä¸ºäº†é€‚åº”ä¼ ç»Ÿæ˜¾ç¤ºè®¾å¤‡çš„éçº¿æ€§ç‰¹æ€§è€Œè®¾è®¡çš„é¢œè‰²è¡¨ç¤ºç³»ç»Ÿã€‚ç”±äºCRTæ˜¾ç¤ºå™¨ä»¥åŠå…¶ä»–æ˜¾ç¤ºè®¾å¤‡å¯¹è¾“å…¥ä¿¡å·çš„å“åº”ä¸æ˜¯çº¿æ€§çš„ï¼Œå®é™…ä¸Šæ˜¾ç¤ºè®¾å¤‡ä¼šå¯¹è¾“å…¥ä¿¡å·è¿›è¡Œä¼½é©¬å˜æ¢ã€‚åœ¨ä¼½é©¬ç©ºé—´ä¸­ï¼Œé¢œè‰²æ•°å€¼ä¸æœ€ç»ˆæ˜¾ç¤ºçš„äº®åº¦ä¹‹é—´ä¸æ˜¯ç®€å•çš„çº¿æ€§å…³ç³»ï¼Œè€Œæ˜¯éµå¾ªä¸€ä¸ªå¹‚å‡½æ•°å…³ç³»ã€‚</p>
<h3 data-id="heading-1">ä¼½é©¬æ ¡æ­£çš„å†å²èƒŒæ™¯</h3>
<p>ä¼½é©¬æ ¡æ­£çš„æ¦‚å¿µèµ·æºäºæ—©æœŸçš„CRTæ˜¾ç¤ºå™¨æ—¶ä»£ã€‚CRTæ˜¾ç¤ºå™¨å…·æœ‰å›ºæœ‰çš„éçº¿æ€§å“åº”ç‰¹æ€§ï¼Œå…¶äº®åº¦è¾“å‡ºä¸è¾“å…¥ç”µå‹ä¹‹é—´çš„å…³ç³»å¤§è‡´ç¬¦åˆå¹‚å‡½æ•°è§„å¾‹ï¼ŒæŒ‡æ•°çº¦ä¸º2.2ã€‚è¿™æ„å‘³ç€å³ä½¿è¾“å…¥çº¿æ€§çš„é¢œè‰²ä¿¡å·ï¼Œæ˜¾ç¤ºå™¨ä¹Ÿä¼šè‡ªåŠ¨åº”ç”¨ä¸€ä¸ªè¿‘ä¼¼çš„ä¼½é©¬å˜æ¢ã€‚</p>
<p>ä¸ºäº†è¡¥å¿è¿™ç§éçº¿æ€§ï¼Œå›¾åƒå’Œè§†é¢‘å†…å®¹åœ¨åˆ›å»ºæ—¶å°±ä¼šé¢„å…ˆåº”ç”¨ä¸€ä¸ªåå‘çš„ä¼½é©¬å˜æ¢ï¼ˆæŒ‡æ•°çº¦ä¸º1/2.2ï¼‰ï¼Œè¿™æ ·å½“å†…å®¹åœ¨æ˜¾ç¤ºå™¨ä¸Šæ˜¾ç¤ºæ—¶ï¼Œä¸¤è€…çš„å˜æ¢ç›¸äº’æŠµæ¶ˆï¼Œæœ€ç»ˆç”¨æˆ·çœ‹åˆ°çš„å°±æ˜¯æ­£ç¡®çš„çº¿æ€§äº®åº¦å…³ç³»ã€‚è¿™ç§é¢„å¤„ç†è¿‡ç¨‹å°±æ˜¯æ‰€è°“çš„ä¼½é©¬æ ¡æ­£ã€‚</p>
<h3 data-id="heading-2">ç°ä»£æ¸²æŸ“ä¸­çš„ä¼½é©¬å¤„ç†</h3>
<p>åœ¨ç°ä»£æ¸²æŸ“ç®¡çº¿ä¸­ï¼Œè™½ç„¶CRTæ˜¾ç¤ºå™¨å·²é€æ¸è¢«LCDã€OLEDç­‰æ–°æŠ€æœ¯å–ä»£ï¼Œä½†ä¼½é©¬æ ¡æ­£çš„æ¦‚å¿µä»ç„¶éå¸¸é‡è¦ã€‚ä¸»è¦åŸå› åŒ…æ‹¬ï¼š</p>
<ul>
<li>å‘åå…¼å®¹æ€§ï¼šå¤§é‡ç°æœ‰çš„å›¾åƒå†…å®¹å’Œæ ‡å‡†éƒ½æ˜¯åŸºäºä¼½é©¬ç©ºé—´è®¾è®¡çš„</li>
<li>æ„ŸçŸ¥å‡åŒ€æ€§ï¼šäººç±»è§†è§‰ç³»ç»Ÿå¯¹äº®åº¦çš„æ„ŸçŸ¥ä¹Ÿæ˜¯éçº¿æ€§çš„ï¼Œä¼½é©¬ç¼–ç å¯ä»¥æ›´æœ‰æ•ˆåœ°åˆ©ç”¨æœ‰é™çš„æ¯”ç‰¹æ·±åº¦</li>
<li>è¡Œä¸šæ ‡å‡†ï¼šsRGBç­‰ç°ä»£é¢œè‰²æ ‡å‡†ä»ç„¶å»ºç«‹åœ¨ä¼½é©¬ç¼–ç çš„åŸºç¡€ä¸Š</li>
</ul>
<h2 data-id="heading-3">LinearToGammaSpaceExactèŠ‚ç‚¹æ ¸å¿ƒåŠŸèƒ½</h2>
<p>LinearToGammaSpaceExactèŠ‚ç‚¹æ˜¯Unity URP Shader Graphä¸­ä¸“é—¨ç”¨äºé¢œè‰²ç©ºé—´è½¬æ¢çš„å·¥å…·èŠ‚ç‚¹ã€‚è¯¥èŠ‚ç‚¹æ‰§è¡Œä»çº¿æ€§é¢œè‰²ç©ºé—´åˆ°ä¼½é©¬é¢œè‰²ç©ºé—´çš„ç²¾ç¡®æ•°å­¦è½¬æ¢ï¼Œç¡®ä¿é¢œè‰²æ•°æ®åœ¨ä¸åŒç©ºé—´ä¹‹é—´çš„å‡†ç¡®è½¬æ¢ã€‚</p>
<h3 data-id="heading-4">æ•°å­¦åŸç†</h3>
<p>LinearToGammaSpaceExactèŠ‚ç‚¹å®ç°çš„æ•°å­¦è½¬æ¢åŸºäºæ ‡å‡†çš„sRGBä¼½é©¬æ ¡æ­£å…¬å¼ã€‚è½¬æ¢è¿‡ç¨‹ä½¿ç”¨åˆ†æ®µå‡½æ•°æ¥ç²¾ç¡®å¤„ç†æ•´ä¸ªæ•°å€¼èŒƒå›´ï¼š</p>
<p>å¯¹äºè¾“å…¥å€¼å°äºæˆ–ç­‰äº0.0031308çš„æƒ…å†µï¼š</p>
<pre><code class="hljs">ä¼½é©¬å€¼ = 12.92 Ã— çº¿æ€§å€¼
</code></pre>
<p>å¯¹äºè¾“å…¥å€¼å¤§äº0.0031308çš„æƒ…å†µï¼š</p>
<pre><code class="hljs language-scss" lang="scss">ä¼½é©¬å€¼ = <span class="hljs-number">1.055</span> Ã— çº¿æ€§å€¼^(<span class="hljs-number">1</span>/<span class="hljs-number">2.4</span>) - <span class="hljs-number">0.055</span>
</code></pre>
<p>è¿™ç§åˆ†æ®µå¤„ç†ç¡®ä¿äº†åœ¨ä½äº®åº¦åŒºåŸŸçš„çº¿æ€§å…³ç³»å’Œè¾ƒé«˜äº®åº¦åŒºåŸŸçš„å¹‚å‡½æ•°å…³ç³»ä¹‹é—´çš„å¹³æ»‘è¿‡æ¸¡ï¼Œç¬¦åˆsRGBæ ‡å‡†è§„èŒƒã€‚</p>
<h3 data-id="heading-5">ä¸è¿‘ä¼¼æ–¹æ³•çš„åŒºåˆ«</h3>
<p>Unityæä¾›äº†ä¸¤ç§ä¼½é©¬è½¬æ¢æ–¹æ³•ï¼šLinearToGammaSpaceExactå’ŒLinearToGammaSpaceã€‚ä¸¤è€…çš„ä¸»è¦åŒºåˆ«åœ¨äºç²¾åº¦å’Œæ€§èƒ½ï¼š</p>
<ul>
<li>LinearToGammaSpaceExactï¼šä½¿ç”¨ç²¾ç¡®çš„sRGBè½¬æ¢å…¬å¼ï¼Œè®¡ç®—ç»“æœå‡†ç¡®ä½†è®¡ç®—é‡ç¨å¤§</li>
<li>LinearToGammaSpaceï¼šä½¿ç”¨è¿‘ä¼¼çš„è½¬æ¢å…¬å¼ï¼ˆé€šå¸¸ä¸ºçº¿æ€§å€¼^(1/2.2)ï¼‰ï¼Œè®¡ç®—é€Ÿåº¦å¿«ä½†ç²¾åº¦ç•¥ä½</li>
</ul>
<p>åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œä¸¤ç§æ–¹æ³•çš„è§†è§‰å·®å¼‚ä¸å¤§ï¼Œä½†åœ¨éœ€è¦ä¸¥æ ¼é¢œè‰²å‡†ç¡®æ€§çš„åœºæ™¯ä¸­ï¼ˆå¦‚ä¸“ä¸šå›¾åƒå¤„ç†ã€é¢œè‰²åˆ†çº§ç­‰ï¼‰ï¼Œåº”ä¼˜å…ˆä½¿ç”¨Exactç‰ˆæœ¬ã€‚</p>
<h2 data-id="heading-6">èŠ‚ç‚¹æ¥å£è¯¦è§£</h2>
<p><img src="https://docs.unity.cn/cn/Packages-cn/com.unity.shadergraph@14.0/manual/images/LinearToGammaSpaceExactNodeThumb.png" alt="" loading="lazy"/></p>
<h3 data-id="heading-7">è¾“å…¥ç«¯å£</h3>
<p>Inè¾“å…¥ç«¯å£æ¥æ”¶Floatç±»å‹çš„æ•°å€¼ï¼Œä»£è¡¨çº¿æ€§é¢œè‰²ç©ºé—´ä¸­çš„é¢œè‰²åˆ†é‡ã€‚è¯¥ç«¯å£å¯ä»¥æ¥å—ä»¥ä¸‹ç±»å‹çš„æ•°å€¼ï¼š</p>
<ul>
<li>å•ä¸ªæµ®ç‚¹æ•°å€¼ï¼šè¡¨ç¤ºå•é¢œè‰²é€šé“çš„çº¿æ€§å€¼</li>
<li>äºŒç»´å‘é‡ï¼šè¡¨ç¤ºä¸¤ä¸ªé¢œè‰²é€šé“çš„çº¿æ€§å€¼</li>
<li>ä¸‰ç»´å‘é‡ï¼šè¡¨ç¤ºRGBé¢œè‰²çš„çº¿æ€§å€¼</li>
<li>å››ç»´å‘é‡ï¼šè¡¨ç¤ºRGBAé¢œè‰²çš„çº¿æ€§å€¼ï¼ŒåŒ…æ‹¬é€æ˜åº¦</li>
</ul>
<p>è¾“å…¥å€¼çš„æœ‰æ•ˆèŒƒå›´é€šå¸¸æ˜¯[0,1]ï¼Œä½†èŠ‚ç‚¹ä¹Ÿå¯ä»¥å¤„ç†è¶…å‡ºæ­¤èŒƒå›´çš„HDRå€¼ï¼Œè½¬æ¢æ—¶ä¼šä¿æŒæ•°å€¼çš„ç›¸å¯¹å…³ç³»ã€‚</p>
<h3 data-id="heading-8">è¾“å‡ºç«¯å£</h3>
<p>Outè¾“å‡ºç«¯å£è¿”å›è½¬æ¢åçš„Floatç±»å‹æ•°å€¼ï¼Œè¡¨ç¤ºä¼½é©¬é¢œè‰²ç©ºé—´ä¸­çš„é¢œè‰²åˆ†é‡ã€‚è¾“å‡ºå€¼çš„èŒƒå›´ä¸è¾“å…¥ç›¸å¯¹åº”ï¼š</p>
<ul>
<li>å¯¹äºæ ‡å‡†èŒƒå›´[0,1]çš„è¾“å…¥ï¼Œè¾“å‡ºä¹Ÿåœ¨[0,1]èŒƒå›´å†…</li>
<li>å¯¹äºHDRå€¼ï¼ˆå¤§äº1ï¼‰ï¼Œè¾“å‡ºä¼šä¿æŒç›¸åº”çš„ç›¸å¯¹äº®åº¦å…³ç³»</li>
</ul>
<p>è¾“å‡ºæ•°æ®ç±»å‹ä¸è¾“å…¥ä¿æŒä¸€è‡´ï¼Œå¦‚æœè¾“å…¥æ˜¯å‘é‡ç±»å‹ï¼Œè¾“å‡ºä¹Ÿæ˜¯ç›¸åº”çš„å‘é‡ç±»å‹ï¼Œæ¯ä¸ªåˆ†é‡éƒ½ç‹¬ç«‹è¿›è¡Œä¼½é©¬è½¬æ¢ã€‚</p>
<h2 data-id="heading-9">å®é™…åº”ç”¨åœºæ™¯</h2>
<h3 data-id="heading-10">åå¤„ç†æ•ˆæœä¸­çš„é¢œè‰²æ ¡æ­£</h3>
<p>åœ¨åå¤„ç†æ¸²æŸ“ä¸­ï¼ŒLinearToGammaSpaceExactèŠ‚ç‚¹å¸¸ç”¨äºå°†çº¿æ€§ç©ºé—´çš„è®¡ç®—ç»“æœè½¬æ¢ä¸ºé€‚åˆæ˜¾ç¤ºçš„ä¼½é©¬ç©ºé—´ã€‚ä¾‹å¦‚ï¼Œåœ¨å®ç°è‰²å½©åˆ†çº§ã€è‰²è°ƒæ˜ å°„æˆ–Bloomæ•ˆæœæ—¶ï¼š</p>
<ul>
<li>åœ¨è‰²è°ƒæ˜ å°„è¿‡ç¨‹ä¸­ï¼Œé¦–å…ˆåœ¨çº¿æ€§ç©ºé—´ä¸­è¿›è¡Œäº®åº¦å‹ç¼©å’Œé¢œè‰²è°ƒæ•´</li>
<li>ä½¿ç”¨LinearToGammaSpaceExactå°†ç»“æœè½¬æ¢åˆ°ä¼½é©¬ç©ºé—´</li>
<li>æœ€ç»ˆè¾“å‡ºåˆ°å±å¹•ç¼“å†²åŒºï¼Œç¡®ä¿æ˜¾ç¤ºè®¾å¤‡èƒ½æ­£ç¡®å‘ˆç°</li>
</ul>
<p>è¿™ç§å·¥ä½œæµç¨‹ä¿è¯äº†é¢œè‰²å¤„ç†çš„å‡†ç¡®æ€§ï¼Œé¿å…äº†å› é¢œè‰²ç©ºé—´ä¸åŒ¹é…å¯¼è‡´çš„é¢œè‰²å¤±çœŸã€‚</p>
<h3 data-id="heading-11">UIå…ƒç´ ä¸æ¸²æŸ“ç»“æœçš„æ··åˆ</h3>
<p>å½“éœ€è¦å°†3Dæ¸²æŸ“ç»“æœä¸UIå…ƒç´ ç»“åˆæ—¶ï¼Œæ­£ç¡®ç®¡ç†é¢œè‰²ç©ºé—´è‡³å…³é‡è¦ï¼š</p>
<ul>
<li>3Dæ¸²æŸ“é€šå¸¸åœ¨çº¿æ€§ç©ºé—´ä¸­è¿›è¡Œè®¡ç®—</li>
<li>UIå…ƒç´ å’Œçº¹ç†é€šå¸¸å­˜å‚¨åœ¨ä¼½é©¬ç©ºé—´ä¸­</li>
<li>ä½¿ç”¨LinearToGammaSpaceExactå¯ä»¥å°†æ¸²æŸ“ç»“æœè½¬æ¢åˆ°ä¸UIä¸€è‡´çš„é¢œè‰²ç©ºé—´</li>
<li>ç¡®ä¿æ··åˆåçš„è§†è§‰æ•ˆæœé¢œè‰²ä¸€è‡´ï¼Œæ²¡æœ‰æ˜æ˜¾çš„ç•Œé™æˆ–å·®å¼‚</li>
</ul>
<h3 data-id="heading-12">è‡ªå®šä¹‰å…‰ç…§æ¨¡å‹å¼€å‘</h3>
<p>åœ¨å¼€å‘è‡ªå®šä¹‰å…‰ç…§æ¨¡å‹æ—¶ï¼Œæ­£ç¡®ç®¡ç†é¢œè‰²ç©ºé—´æ˜¯ä¿è¯å…‰ç…§è®¡ç®—å‡†ç¡®æ€§çš„å…³é”®ï¼š</p>
<ul>
<li>å…‰ç…§è®¡ç®—åœ¨çº¿æ€§ç©ºé—´ä¸­æ‰§è¡Œï¼Œç¬¦åˆç‰©ç†è§„å¾‹</li>
<li>ä½¿ç”¨LinearToGammaSpaceExactå°†æœ€ç»ˆå…‰ç…§ç»“æœè½¬æ¢åˆ°æ˜¾ç¤ºç©ºé—´</li>
<li>ç¡®ä¿å…‰ç…§çš„äº®åº¦å’Œé¢œè‰²å…³ç³»åœ¨æ˜¾ç¤ºæ—¶ä¿æŒæ­£ç¡®</li>
</ul>
<p>ç‰¹åˆ«æ˜¯åœ¨å®ç°å¤æ‚çš„PBRæè´¨æ—¶ï¼Œé¢œè‰²ç©ºé—´çš„æ­£ç¡®è½¬æ¢å¯¹äºé‡‘å±åº¦ã€ç²—ç³™åº¦ç­‰å‚æ•°çš„å‡†ç¡®è¡¨ç°å°¤ä¸ºé‡è¦ã€‚</p>
<h2 data-id="heading-13">ä½¿ç”¨ç¤ºä¾‹ä¸æ¡ˆä¾‹åˆ†æ</h2>
<h3 data-id="heading-14">åŸºç¡€é¢œè‰²ç©ºé—´è½¬æ¢</h3>
<p>ä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€å•çš„Shader Graphè®¾ç½®ï¼Œæ¼”ç¤ºå¦‚ä½•ä½¿ç”¨LinearToGammaSpaceExactèŠ‚ç‚¹è¿›è¡ŒåŸºæœ¬çš„é¢œè‰²ç©ºé—´è½¬æ¢ï¼š</p>
<ul>
<li>åˆ›å»ºColorèŠ‚ç‚¹ä½œä¸ºçº¿æ€§ç©ºé—´çš„é¢œè‰²è¾“å…¥</li>
<li>å°†ColorèŠ‚ç‚¹è¿æ¥åˆ°LinearToGammaSpaceExactèŠ‚ç‚¹çš„Inç«¯å£</li>
<li>å°†LinearToGammaSpaceExactèŠ‚ç‚¹çš„Outç«¯å£è¿æ¥åˆ°ä¸»èŠ‚ç‚¹çš„Base Colorè¾“å…¥</li>
<li>é€šè¿‡è°ƒèŠ‚è¾“å…¥é¢œè‰²ï¼Œè§‚å¯Ÿè½¬æ¢å‰åé¢œè‰²çš„å˜åŒ–</li>
</ul>
<p>è¿™ç§åŸºç¡€è®¾ç½®å¯ä»¥å¸®åŠ©ç†è§£çº¿æ€§ç©ºé—´ä¸ä¼½é©¬ç©ºé—´ä¹‹é—´é¢œè‰²è¡¨ç°çš„å·®å¼‚ï¼Œç‰¹åˆ«æ˜¯åœ¨ä¸­ç­‰äº®åº¦åŒºåŸŸï¼Œå·®å¼‚æœ€ä¸ºæ˜æ˜¾ã€‚</p>
<h3 data-id="heading-15">HDRé¢œè‰²å¤„ç†æ¡ˆä¾‹</h3>
<p>åœ¨å¤„ç†é«˜åŠ¨æ€èŒƒå›´é¢œè‰²æ—¶ï¼ŒLinearToGammaSpaceExactèŠ‚ç‚¹çš„è¡Œä¸ºå€¼å¾—ç‰¹åˆ«å…³æ³¨ï¼š</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// å‡è®¾åœ¨çº¿æ€§ç©ºé—´ä¸­æœ‰ä»¥ä¸‹HDRé¢œè‰²å€¼</span>
float3 linearColor = <span class="hljs-built_in">float3</span>(<span class="hljs-number">2.0</span>, <span class="hljs-number">1.0</span>, <span class="hljs-number">0.5</span>);

<span class="hljs-comment">// åº”ç”¨LinearToGammaSpaceExactè½¬æ¢</span>
float3 gammaColor = <span class="hljs-built_in">LinearToGammaSpaceExact</span>(linearColor);

<span class="hljs-comment">// ç»“æœä¼šä¿æŒç›¸å¯¹çš„äº®åº¦å…³ç³»</span>
<span class="hljs-comment">// ä½†æ•°å€¼å¯èƒ½è¶…å‡ºæ ‡å‡†[0,1]èŒƒå›´</span>
</code></pre>
<p>åœ¨å®é™…åº”ç”¨ä¸­ï¼Œé€šå¸¸ä¼šåœ¨ä¼½é©¬è½¬æ¢å‰å…ˆè¿›è¡Œè‰²è°ƒæ˜ å°„ï¼Œå°†HDRå€¼å‹ç¼©åˆ°æ˜¾ç¤ºè®¾å¤‡èƒ½å¤Ÿå¤„ç†çš„èŒƒå›´å†…ã€‚</p>
<h3 data-id="heading-16">è‡ªå®šä¹‰åå¤„ç†æ•ˆæœå®ç°</h3>
<p>ä¸‹é¢æ˜¯ä¸€ä¸ªå®ç°ç®€å•é¢œè‰²åˆ†çº§æ•ˆæœçš„Shader Graphç¤ºä¾‹ï¼š</p>
<ul>
<li>ä½¿ç”¨Scene ColorèŠ‚ç‚¹è·å–å½“å‰æ¸²æŸ“çš„çº¿æ€§ç©ºé—´é¢œè‰²</li>
<li>åº”ç”¨é¢œè‰²è°ƒæ•´èŠ‚ç‚¹ï¼ˆå¦‚å¯¹æ¯”åº¦ã€é¥±å’Œåº¦ã€è‰²ç›¸è°ƒæ•´ï¼‰</li>
<li>æ‰€æœ‰è°ƒæ•´åœ¨çº¿æ€§ç©ºé—´ä¸­æ‰§è¡Œï¼Œä¿è¯è®¡ç®—å‡†ç¡®æ€§</li>
<li>ä½¿ç”¨LinearToGammaSpaceExactèŠ‚ç‚¹å°†ç»“æœè½¬æ¢åˆ°ä¼½é©¬ç©ºé—´</li>
<li>è¾“å‡ºåˆ°Blitå‘½ä»¤æˆ–åå¤„ç†å †æ ˆ</li>
</ul>
<p>è¿™ç§æ–¹æ³•ç¡®ä¿äº†é¢œè‰²è°ƒæ•´çš„ç‰©ç†å‡†ç¡®æ€§ï¼Œé¿å…äº†åœ¨ä¼½é©¬ç©ºé—´ä¸­è¿›è¡Œè°ƒæ•´å¯èƒ½å¼•å…¥çš„æ•°å­¦é”™è¯¯ã€‚</p>
<h2 data-id="heading-17">æ€§èƒ½è€ƒé‡ä¸ä¼˜åŒ–å»ºè®®</h2>
<h3 data-id="heading-18">è®¡ç®—å¼€é”€åˆ†æ</h3>
<p>LinearToGammaSpaceExactèŠ‚ç‚¹çš„è®¡ç®—å¼€é”€ä¸»è¦æ¥è‡ªå¹‚å‡½æ•°è®¡ç®—å’Œæ¡ä»¶åˆ¤æ–­ã€‚è™½ç„¶å•ä¸ªèŠ‚ç‚¹çš„å¼€é”€ä¸å¤§ï¼Œä½†åœ¨åƒç´ ç€è‰²å™¨ä¸­å¤§é‡ä½¿ç”¨æ—¶ä»éœ€æ³¨æ„ï¼š</p>
<ul>
<li>æ¯ä¸ªåƒç´ è‡³å°‘éœ€è¦æ‰§è¡Œä¸€æ¬¡æ¡ä»¶åˆ¤æ–­å’Œä¸€æ¬¡å¹‚è¿ç®—</li>
<li>åœ¨é«˜åˆ†è¾¨ç‡æ¸²æŸ“ä¸­ï¼Œè¿™äº›æ“ä½œä¼šç´¯ç§¯æˆå¯è§‚çš„è®¡ç®—é‡</li>
<li>åœ¨ç§»åŠ¨å¹³å°æˆ–æ€§èƒ½å—é™çš„ç¯å¢ƒä¸­åº”è°¨æ…ä½¿ç”¨</li>
</ul>
<h3 data-id="heading-19">ä¼˜åŒ–ç­–ç•¥</h3>
<p>é’ˆå¯¹æ€§èƒ½æ•æ„Ÿçš„åœºæ™¯ï¼Œå¯ä»¥è€ƒè™‘ä»¥ä¸‹ä¼˜åŒ–ç­–ç•¥ï¼š</p>
<ul>
<li>åœ¨é¡¶ç‚¹ç€è‰²å™¨ä¸­è¿›è¡Œè½¬æ¢ï¼šå¦‚æœé¢œè‰²æ•°æ®åœ¨é¡¶ç‚¹é—´å˜åŒ–ä¸å¤§ï¼Œå¯ä»¥åœ¨é¡¶ç‚¹é˜¶æ®µè¿›è¡Œè½¬æ¢</li>
<li>ä½¿ç”¨è¿‘ä¼¼ç‰ˆæœ¬ï¼šåœ¨è§†è§‰è¦æ±‚ä¸é«˜çš„åœºæ™¯ä¸­ï¼Œä½¿ç”¨LinearToGammaSpaceæ›¿ä»£Exactç‰ˆæœ¬</li>
<li>æ‰¹é‡å¤„ç†ï¼šå°†å¤šä¸ªé¢œè‰²é€šé“çš„è½¬æ¢åˆå¹¶å¤„ç†ï¼Œå‡å°‘æ¡ä»¶åˆ¤æ–­æ¬¡æ•°</li>
<li>LUTä¼˜åŒ–ï¼šå¯¹äºå›ºå®šçš„é¢œè‰²è½¬æ¢ï¼Œå¯ä»¥ä½¿ç”¨æŸ¥æ‰¾è¡¨æ›¿ä»£å®æ—¶è®¡ç®—</li>
</ul>
<h3 data-id="heading-20">å¹³å°ç‰¹å¼‚æ€§è€ƒè™‘</h3>
<p>ä¸åŒç¡¬ä»¶å¹³å°å¯¹è¶…è¶Šå‡½æ•°ï¼ˆå¦‚å¹‚è¿ç®—ï¼‰çš„æ”¯æŒç¨‹åº¦ä¸åŒï¼š</p>
<ul>
<li>ç°ä»£æ¡Œé¢GPUé€šå¸¸æœ‰ä¸“é—¨çš„ç¡¬ä»¶å•å…ƒå¤„ç†è¿™ç±»è¿ç®—ï¼Œæ•ˆç‡è¾ƒé«˜</li>
<li>ç§»åŠ¨GPUå¯èƒ½é€šè¿‡è½¯ä»¶æ¨¡æ‹Ÿï¼Œæ•ˆç‡ç›¸å¯¹è¾ƒä½</li>
<li>åœ¨é’ˆå¯¹å¤šå¹³å°å¼€å‘æ—¶ï¼Œåº”æµ‹è¯•ç›®æ ‡å¹³å°çš„æ€§èƒ½è¡¨ç°</li>
</ul>
<h2 data-id="heading-21">å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ</h2>
<h3 data-id="heading-22">é¢œè‰²æ˜¾ç¤ºä¸ä¸€è‡´é—®é¢˜</h3>
<p>åœ¨ä½¿ç”¨LinearToGammaSpaceExactèŠ‚ç‚¹æ—¶ï¼Œå¯èƒ½ä¼šé‡åˆ°é¢œè‰²æ˜¾ç¤ºä¸ä¸€è‡´çš„é—®é¢˜ï¼š</p>
<ul>
<li>é—®é¢˜è¡¨ç°ï¼šåœ¨ä¸åŒè®¾å¤‡æˆ–ä¸åŒæŸ¥çœ‹æ¡ä»¶ä¸‹é¢œè‰²æ˜¾ç¤ºæœ‰å·®å¼‚</li>
<li>å¯èƒ½åŸå› ï¼šé¢œè‰²ç©ºé—´é…ç½®é”™è¯¯ã€æ˜¾ç¤ºå™¨æ ¡å‡†ä¸ä¸€è‡´ã€å›¾åƒæ ¼å¼ä¸åŒ¹é…</li>
<li>è§£å†³æ–¹æ¡ˆï¼šç¡®ä¿æ•´ä¸ªæ¸²æŸ“ç®¡çº¿é¢œè‰²ç©ºé—´è®¾ç½®ä¸€è‡´ï¼Œä½¿ç”¨æ ‡å‡†é¢œè‰²é…ç½®æ–‡ä»¶ï¼Œå®šæœŸæ ¡å‡†æ˜¾ç¤ºè®¾å¤‡</li>
</ul>
<h3 data-id="heading-23">æ€§èƒ½ç“¶é¢ˆè¯†åˆ«ä¸è§£å†³</h3>
<p>å¦‚æœå‘ç°ä½¿ç”¨LinearToGammaSpaceExactèŠ‚ç‚¹åæ€§èƒ½ä¸‹é™ï¼š</p>
<ul>
<li>ä½¿ç”¨Unity Profileråˆ†æç€è‰²å™¨æ‰§è¡Œæ—¶é—´</li>
<li>æ£€æŸ¥æ˜¯å¦åœ¨ä¸éœ€è¦ç²¾ç¡®è½¬æ¢çš„åœ°æ–¹ä½¿ç”¨äº†Exactç‰ˆæœ¬</li>
<li>è€ƒè™‘å°†è½¬æ¢ç§»åˆ°æ¸²æŸ“ç®¡çº¿çš„åæœŸé˜¶æ®µï¼Œå‡å°‘é‡å¤è®¡ç®—</li>
<li>è¯„ä¼°æ˜¯å¦å¯ä»¥ä½¿ç”¨æ›´ç®€åŒ–çš„é¢œè‰²ç©ºé—´å¤„ç†æ–¹æ¡ˆ</li>
</ul>
<h3 data-id="heading-24">HDRä¸LDRå·¥ä½œæµåˆ‡æ¢</h3>
<p>åœ¨HDRå’ŒLDRæ¸²æŸ“ç®¡çº¿ä¹‹é—´åˆ‡æ¢æ—¶ï¼Œé¢œè‰²ç©ºé—´å¤„ç†éœ€è¦ç‰¹åˆ«æ³¨æ„ï¼š</p>
<ul>
<li>HDRç®¡çº¿é€šå¸¸åœ¨çº¿æ€§ç©ºé—´ä¸­å¤„ç†æ›´å¤šè®¡ç®—</li>
<li>LDRç®¡çº¿å¯èƒ½æ··åˆä½¿ç”¨çº¿æ€§å’Œä¼½é©¬ç©ºé—´</li>
<li>ä½¿ç”¨LinearToGammaSpaceExactèŠ‚ç‚¹æ—¶åº”æ˜ç¡®å½“å‰çš„é¢œè‰²ç©ºé—´çŠ¶æ€</li>
<li>å»ºç«‹ç»Ÿä¸€çš„é¢œè‰²ç©ºé—´ç®¡ç†ç­–ç•¥ï¼Œç¡®ä¿åœ¨ä¸åŒç®¡çº¿é—´çš„ä¸€è‡´æ€§</li>
</ul>
<h2 data-id="heading-25">æœ€ä½³å®è·µæ€»ç»“</h2>
<p>æ­£ç¡®ä½¿ç”¨LinearToGammaSpaceExactèŠ‚ç‚¹éœ€è¦éµå¾ªä¸€ç³»åˆ—æœ€ä½³å®è·µï¼š</p>
<ul>
<li>å§‹ç»ˆäº†è§£æ•°æ®å½“å‰æ‰€å¤„çš„é¢œè‰²ç©ºé—´ï¼Œåœ¨çº¿æ€§ç©ºé—´ä¸­è¿›è¡Œå…‰ç…§å’Œé¢œè‰²è®¡ç®—</li>
<li>ä»…åœ¨æœ€ç»ˆè¾“å‡ºåˆ°å±å¹•æˆ–éæµ®ç‚¹æ ¼å¼çº¹ç†æ—¶è¿›è¡Œä¼½é©¬è½¬æ¢</li>
<li>åœ¨éœ€è¦æœ€é«˜é¢œè‰²å‡†ç¡®æ€§çš„åœºæ™¯ä¸­ä½¿ç”¨Exactç‰ˆæœ¬ï¼Œå…¶ä»–æƒ…å†µå¯è€ƒè™‘ä½¿ç”¨è¿‘ä¼¼ç‰ˆæœ¬</li>
<li>å»ºç«‹é¡¹ç›®ç»Ÿä¸€çš„é¢œè‰²ç©ºé—´ç®¡ç†è§„èŒƒï¼Œé¿å…æ··ä¹±çš„é¢œè‰²ç©ºé—´ä½¿ç”¨</li>
<li>å®šæœŸæµ‹è¯•åœ¨ä¸åŒæ˜¾ç¤ºè®¾å¤‡ä¸Šçš„é¢œè‰²è¡¨ç°ï¼Œç¡®ä¿ä¸€è‡´æ€§</li>
<li>æ–‡æ¡£åŒ–é¢œè‰²ç©ºé—´å†³ç­–ï¼Œä¾¿äºå›¢é˜Ÿåä½œå’Œåç»­ç»´æŠ¤</li>
</ul>
<p>é€šè¿‡éµå¾ªè¿™äº›å®è·µåŸåˆ™ï¼Œå¯ä»¥ç¡®ä¿æ¸²æŸ“ç»“æœçš„è§†è§‰å‡†ç¡®æ€§ï¼ŒåŒæ—¶åœ¨æ€§èƒ½å’Œç”»è´¨ä¹‹é—´å–å¾—è‰¯å¥½å¹³è¡¡ã€‚LinearToGammaSpaceExactèŠ‚ç‚¹ä½œä¸ºé¢œè‰²ç®¡ç†å·¥å…·ç®±ä¸­çš„é‡è¦ç»„ä»¶ï¼Œåœ¨æ­£ç¡®çš„ä½¿ç”¨åœºæ™¯ä¸‹èƒ½å¤Ÿæ˜¾è‘—æå‡æ¸²æŸ“è´¨é‡ã€‚</p>
<hr/>
<blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fchenghai37%2Fcategory_13074589.html%3Ffromshare%3Dblogcolumn%26sharetype%3Dblogcolumn%26sharerId%3D13074589%26sharerefer%3DPC%26sharesource%3Dchenghai37%26sharefrom%3Dfrom_link" target="_blank" title="https://blog.csdn.net/chenghai37/category_13074589.html?fromshare=blogcolumn&amp;sharetype=blogcolumn&amp;sharerId=13074589&amp;sharerefer=PC&amp;sharesource=chenghai37&amp;sharefrom=from_link" ref="nofollow noopener noreferrer">ã€Unity Shader Graph ä½¿ç”¨ä¸ç‰¹æ•ˆå®ç°ã€‘</a><strong>ä¸“æ -ç›´è¾¾</strong>
ï¼ˆæ¬¢è¿<em>ç‚¹èµç•™è¨€</em>æ¢è®¨ï¼Œæ›´å¤šäººåŠ å…¥è¿›æ¥èƒ½æ›´åŠ å®Œå–„è¿™ä¸ªæ¢ç´¢çš„è¿‡ç¨‹ï¼ŒğŸ™ï¼‰</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[15 Go Eino AIåº”ç”¨å¼€å‘å®æˆ˜ | æ€§èƒ½ä¼˜åŒ–]]></title>    <link>https://juejin.cn/post/7585468725332475958</link>    <guid>https://juejin.cn/post/7585468725332475958</guid>    <pubDate>2025-12-20T09:57:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585468725332475958" data-draft-id="7585474459776450596" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="15 Go Eino AIåº”ç”¨å¼€å‘å®æˆ˜ | æ€§èƒ½ä¼˜åŒ–"/> <meta itemprop="keywords" content="åç«¯,é¢è¯•,Go"/> <meta itemprop="datePublished" content="2025-12-20T09:57:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ç‹ä¸­é˜³è®²AIç¼–ç¨‹"/> <meta itemprop="url" content="https://juejin.cn/user/2189882892232029"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="æ˜é‡‘"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            15 Go Eino AIåº”ç”¨å¼€å‘å®æˆ˜ | æ€§èƒ½ä¼˜åŒ–
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2189882892232029/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ç‹ä¸­é˜³è®²AIç¼–ç¨‹
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T09:57:57.000Z" title="Sat Dec 20 2025 09:57:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    é˜…è¯»5åˆ†é’Ÿ
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;font-weight:400;line-height:2;font-size:17px;overflow-x:hidden;color:#000}.markdown-body strong{padding:1px;color:#ee3f4d}.markdown-body em{padding:0 2px;color:#f33b1f}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{position:relative;margin-top:30px;margin-bottom:20px;line-height:1.5;font-weight:700}.markdown-body h1{text-align:center;padding-bottom:5px;font-size:32px;color:#ac1f18}.markdown-body h1:after{content:"";display:block;margin:4px auto 0;width:100px;height:2px;border-bottom:2px solid #f33b1f}.markdown-body h2{font-size:28px;border-bottom:1px solid #f33b1f}.markdown-body h2:before{content:"# "!important;color:#f33b1f}.markdown-body h3{font-size:24px;padding-left:9px;border-left:6px solid #f33b1f}.markdown-body h4{font-size:20px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #bbb;margin:16px 0}.markdown-body code{word-break:break-word;overflow-x:auto;background-color:#f9f1db;color:#ee2746;border-radius:2px;font-size:16px;padding:1px 2px}.markdown-body code,.markdown-body pre{font-family:-apple-system,-apple-system-body,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,PingFang SC,æ€æºé»‘ä½“ CN,æ€æºé»‘ä½“,JetBrains Mono,Fira Code,Menlo,Ubuntu Mono,Consolas,sans-serif}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{margin:12px 0!important;border-radius:3px;font-size:15px;padding:16px 12px;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f7f7f7}.markdown-body a{text-decoration:none;color:#1781b5;padding:0 2px;border-bottom:1px solid #1781b5}.markdown-body a:active,.markdown-body a:hover{border-bottom:2px solid #f33b1f;color:#ac1f18}.markdown-body blockquote{color:#3d3d3d;background-color:#fff9f9;padding:6px 16px;margin:16px 0;border-left:3px solid #f07c82}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:6px 0}.markdown-body ol,.markdown-body ul{padding-left:30px}.markdown-body ol li,.markdown-body ul li{margin-bottom:6px}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:6px}.markdown-body ol li{padding-left:6px}.markdown-body ::marker{color:#f33b1f}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}.markdown-body .task-list-item input[type=checkbox]{position:relative}.markdown-body .task-list-item input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;background:#fff;border:1px solid #f07c82;border-radius:3px;box-sizing:border-box;z-index:1}.markdown-body .task-list-item input[type=checkbox]:checked:after{content:"âœ“";position:absolute;top:-5px;left:0;right:0;bottom:0;width:0;height:0;color:#f33b1f;font-size:16px;font-weight:700;z-index:2}.markdown-body table{display:inline-block!important;font-size:14px;width:auto;max-width:100%;overflow:auto;border-spacing:0;border-collapse:collapse}.markdown-body table thead{background:#fff9f9;color:#000;text-align:left;font-size:15px}.markdown-body table tr:nth-child(2n){background-color:#fcfcfc}.markdown-body table tr:hover{background-color:#fff9f9}.markdown-body table td,.markdown-body table th{padding:12px 7px;line-height:24px;border:1px solid #f9f1db}.markdown-body table td{min-width:120px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><blockquote>
<p>å£°æ˜ï¼šæœ¬AIåº”ç”¨å¼€å‘ç³»åˆ—æ•™ç¨‹é¦–å‘åœ¨åŒåå…¬ä¼—å·ï¼š<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F5DYsyMKh9cDJdVvs_Mn9_Q" target="_blank" title="https://mp.weixin.qq.com/s/5DYsyMKh9cDJdVvs_Mn9_Q" ref="nofollow noopener noreferrer">ç‹ä¸­é˜³</a>ï¼Œæœªç»æˆæƒç¦æ­¢è½¬è½½ã€‚</p>
</blockquote>
<p>Go-Eino Interview Agent å¹³å°çš„æ€§èƒ½ä¼˜åŒ–ä¸“æ³¨äºå®ç°é«˜ååé‡ã€ä½å»¶è¿Ÿå’Œé«˜æ•ˆèµ„æºåˆ©ç”¨ï¼Œæ¶µç›–æ•°æ®åº“è¿æ¥ã€ç¼“å­˜ç­–ç•¥ã€æ¶ˆæ¯é˜Ÿåˆ—å’Œå‘é‡æœç´¢æ“ä½œã€‚è¿™ç§ç»¼åˆæ–¹æ³•ç¡®ä¿ç³»ç»Ÿèƒ½å¤Ÿå¤„ç†å¹¶å‘é¢è¯•ä¼šè¯ï¼ŒåŒæ—¶ä¿æŒå“åº”å¼ AI äº¤äº’ã€‚</p>
<h2 data-id="heading-0">æ•°æ®åº“è¿æ¥æ± ä¼˜åŒ–</h2>
<p>æ•°æ®åº“å±‚é‡‡ç”¨å¤æ‚çš„è¿æ¥æ± æŠ€æœ¯æ¥é«˜æ•ˆç®¡ç† MySQL è¿æ¥ã€‚ç³»ç»Ÿä½¿ç”¨ GORM é…åˆä¼˜åŒ–çš„è¿æ¥å‚æ•°ï¼Œå¹³è¡¡èµ„æºä½¿ç”¨ä¸æ€§èƒ½éœ€æ±‚ã€‚</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// æ¥è‡ª database.go çš„è¿æ¥æ± é…ç½®</span>
sqlDB.SetMaxIdleConns(dbConfig.MaxIdleConns)
sqlDB.SetMaxOpenConns(dbConfig.MaxOpenConns)
<span class="hljs-keyword">if</span> dbConfig.ConnMaxLifetime != <span class="hljs-string">""</span> {
    connMaxLifetime, err := time.ParseDuration(dbConfig.ConnMaxLifetime)
    <span class="hljs-keyword">if</span> err == <span class="hljs-literal">nil</span> {
        sqlDB.SetConnMaxLifetime(connMaxLifetime)
    }
}
</code></pre>
<p>è¯¥é…ç½®æ”¯æŒé€šè¿‡ YAML é…ç½®æ–‡ä»¶åŠ¨æ€è°ƒæ•´è¿æ¥æ± å‚æ•°ï¼Œå…è®¸åŸºäºç”Ÿäº§å·¥ä½œè´Ÿè½½æ¨¡å¼è¿›è¡Œå¾®è°ƒã€‚ç³»ç»Ÿç»´æŠ¤å…¨å±€æ•°æ®åº“å®ä¾‹ï¼Œåœ¨æ‰€æœ‰æœåŠ¡ç»„ä»¶é—´å¤ç”¨è¿æ¥ï¼Œæœ€å°åŒ–è¿æ¥å¼€é”€ã€‚</p>
<blockquote>
<p><strong>ä¼˜åŒ–å»ºè®®</strong>ï¼šåº”æ ¹æ®å®é™…æ•°æ®åº“æŒ‡æ ‡ç›‘æ§å¹¶è°ƒæ•´è¿æ¥æ± å‚æ•°ã€‚åœ¨å…¸å‹é¢è¯•å·¥ä½œè´Ÿè½½ä¸‹ï¼Œå°† <code>MaxIdleConns</code> è®¾ç½®ä¸º <code>MaxOpenConns</code> çš„ 20-30% å¯è·å¾—æœ€ä½³æ€§èƒ½ã€‚</p>
</blockquote>
<h2 data-id="heading-1">Redis ç¼“å­˜ç­–ç•¥</h2>
<p>Redis ä½œä¸ºç¼“å­˜å±‚å’Œæ¶ˆæ¯é˜Ÿåˆ—åŸºç¡€è®¾æ–½ï¼Œä¸ºé¢‘ç¹è®¿é—®çš„æ•°æ®æä¾›äºšæ¯«ç§’çº§è®¿é—®ã€‚ç¼“å­˜å®ç°ä¸“æ³¨äºä¼šè¯ç®¡ç†ã€é¢è¯•çŠ¶æ€æŒä¹…åŒ–å’Œ AI ç”Ÿæˆå†…å®¹çš„ä¸´æ—¶å­˜å‚¨ã€‚</p>
<p><strong>æ¥æº</strong>ï¼šredis.go</p>
<p>Redis å®¢æˆ·ç«¯é…ç½®é€šè¿‡åº•å±‚ go-redis åº“æ”¯æŒè¿æ¥æ± ï¼Œå…·æœ‰è‡ªåŠ¨è¿æ¥å¤ç”¨å’Œæ•…éšœè½¬ç§»å¤„ç†åŠŸèƒ½ã€‚ç¼“å­˜å±‚å®ç°äº†ç®€å•çš„é”®å€¼æ¥å£ï¼Œæ”¯æŒå¯é…ç½®çš„è¿‡æœŸæ—¶é—´ï¼š</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// æ”¯æŒä¸Šä¸‹æ–‡çš„ç¼“å­˜æ“ä½œ</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">SetCache</span><span class="hljs-params">(ctx context.Context, key <span class="hljs-type">string</span>, value <span class="hljs-keyword">interface</span>{}, expiration <span class="hljs-type">int</span>)</span></span> <span class="hljs-type">error</span> {
    <span class="hljs-keyword">return</span> RedisClient.Set(ctx, key, value, <span class="hljs-number">0</span>).Err()
}
</code></pre>
<p>ç³»ç»Ÿåˆ©ç”¨ Redis pub/sub åŠŸèƒ½åœ¨é¢è¯•ç»„ä»¶é—´å®æ—¶åˆ†å‘æ¶ˆæ¯ï¼Œå½“é¢è¯•çŠ¶æ€å˜åŒ–æ—¶èƒ½å¤Ÿç«‹å³æ›´æ–°è¿æ¥çš„å®¢æˆ·ç«¯ã€‚</p>
<h2 data-id="heading-2">æ¶ˆæ¯é˜Ÿåˆ—æ€§èƒ½</h2>
<p>åŸºäº Redis çš„æ¶ˆæ¯é˜Ÿåˆ—å®ç°ä¸ºè®¡ç®—å¯†é›†å‹æ“ä½œï¼ˆå¦‚ AI æ¨¡å‹æ¨ç†å’Œè¯„ä¼°æŠ¥å‘Šç”Ÿæˆï¼‰æä¾›å¼‚æ­¥å¤„ç†èƒ½åŠ›ã€‚é˜Ÿåˆ—æ¶æ„ç¡®ä¿éé˜»å¡è¯·æ±‚å¤„ç†ï¼ŒåŒæ—¶ç»´æŠ¤æ¶ˆæ¯é¡ºåºå’Œäº¤ä»˜ä¿è¯ã€‚</p>
<p><strong>æ¥æº</strong>ï¼šredis_queue.go</p>
<p>é˜Ÿåˆ—ç³»ç»Ÿå®ç°äº†åŸºäº goroutine çš„å¤„ç†å™¨çš„å¹¶å‘æ¶ˆæ¯å¤„ç†ï¼š</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// å¹¶å‘æ¶ˆæ¯å¤„ç†</span>
<span class="hljs-keyword">for</span> _, h := <span class="hljs-keyword">range</span> handlers {
    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(handler MessageHandler, m *Message)</span></span> {
        <span class="hljs-keyword">if</span> err := handler(ctx, m); err != <span class="hljs-literal">nil</span> {
            log.Printf(<span class="hljs-string">"[RedisQueue] Error processing message: %v, type: %s"</span>, err, m.Type)
        }
    }(h, &amp;message)
}
</code></pre>
<p>åŸºäºé€šé“çš„æ¶ˆæ¯è·¯ç”±ç¡®ä¿æ ¹æ®æ¶ˆæ¯ç±»å‹é«˜æ•ˆåˆ†å‘åˆ°ç›¸åº”å¤„ç†å™¨ï¼Œè€Œ pub/sub æœºåˆ¶ä¸ºè®¢é˜…ç»„ä»¶æä¾›å®æ—¶äº¤ä»˜ã€‚</p>
<h2 data-id="heading-3">å‘é‡æœç´¢ä¼˜åŒ–</h2>
<p>Milvus å‘é‡æ•°æ®åº“é›†æˆå®ç°äº†é’ˆå¯¹ç®€å†åŒ¹é…å’Œé—®é¢˜æ£€ç´¢çš„ä¼˜åŒ–ç›¸ä¼¼æ€§æœç´¢ã€‚ç³»ç»Ÿä¸“æ³¨äºæœ€å°åŒ–æŸ¥è¯¢å»¶è¿Ÿï¼ŒåŒæ—¶ä¿æŒé¢è¯•ç›¸å…³å†…å®¹çš„é«˜å¬å›ç‡ã€‚</p>
<p><strong>æ¥æº</strong>ï¼šmilvus_retriever_tool.go</p>
<p>å‘é‡æœç´¢å·¥ä½œæµç¨‹åŒ…æ‹¬ï¼š</p>
<ol>
<li><strong>æŸ¥è¯¢é¢„å¤„ç†</strong>ï¼šè¾“å…¥éªŒè¯å’ŒåµŒå…¥ç”Ÿæˆ</li>
<li><strong>ç´¢å¼•é€‰æ‹©</strong>ï¼šåŸºäºæ•°æ®ç‰¹å¾è‡ªåŠ¨é€‰æ‹©æœ€ä¼˜ç´¢å¼•</li>
<li><strong>ç›¸ä¼¼æ€§æœç´¢</strong>ï¼šé«˜æ•ˆ ANNï¼ˆè¿‘ä¼¼æœ€è¿‘é‚»ï¼‰æœç´¢ï¼Œæ”¯æŒå¯é…ç½®çš„ top-k ç»“æœ</li>
<li><strong>ç»“æœæ ¼å¼åŒ–</strong>ï¼šåŒ…å«ç›¸ä¼¼åº¦åˆ†æ•°å’Œå…ƒæ•°æ®çš„ç»“æ„åŒ–è¾“å‡º</li>
</ol>
<p>æ£€ç´¢å™¨æœåŠ¡å®ç°äº†è¿æ¥æ± å’ŒæŸ¥è¯¢æ‰¹å¤„ç†ï¼Œä»¥åœ¨é¢è¯•é«˜å³°æœŸæœ€å¤§åŒ–ååé‡ã€‚</p>
<h2 data-id="heading-4">æ¨¡å‹ç®¡ç†æ€§èƒ½</h2>
<p>é™æ€æ¨¡å‹ç®¡ç†å™¨å®ç°äº† AI æ¨¡å‹é…ç½®çš„é«˜æ•ˆå†…å­˜ç¼“å­˜ï¼Œå…·æœ‰ O(1) æŸ¥æ‰¾æ€§èƒ½ã€‚ç³»ç»Ÿä½¿ç”¨è¯»å†™äº’æ–¥é”ç¡®ä¿çº¿ç¨‹å®‰å…¨ï¼ŒåŒæ—¶æœ€å°åŒ–é”äº‰ç”¨ã€‚</p>
<p><strong>æ¥æº</strong>ï¼šmanager_impl.go</p>
<p>æ¨¡å‹ç®¡ç†æ¶æ„æ”¯æŒï¼š</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// æ”¯æŒæ˜ å°„ä¼˜åŒ–çš„çº¿ç¨‹å®‰å…¨æ¨¡å‹æŸ¥æ‰¾</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *staticManager)</span></span> Get(ctx context.Context, id <span class="hljs-type">int64</span>) (*InternalModel, <span class="hljs-type">error</span>) {
    s.mu.RLock()
    <span class="hljs-keyword">defer</span> s.mu.RUnlock()
    
    <span class="hljs-keyword">if</span> m, ok := s.mapping[id]; ok {
        <span class="hljs-keyword">return</span> m, <span class="hljs-literal">nil</span>
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span>
}
</code></pre>
<p>æ‰¹é‡æ“ä½œï¼ˆMGetï¼‰é€šè¿‡å•æ¬¡æ“ä½œæ£€ç´¢å¤šä¸ªæ¨¡å‹æ¥æœ€å°åŒ–æ•°æ®åº“å¾€è¿”ï¼Œè€Œ list å‡½æ•°æ”¯æŒåˆ†é¡µå’Œè¿‡æ»¤ä»¥å‡å°‘å†…å­˜å ç”¨ã€‚</p>
<h2 data-id="heading-5">å†…å­˜ç®¡ç†å’Œå¹¶å‘</h2>
<p>ç³»ç»Ÿé‡‡ç”¨å¤šç§å†…å­˜ä¼˜åŒ–ç­–ç•¥ï¼š</p>
<ul>
<li><strong>å¯¹è±¡æ± </strong>ï¼šå¤ç”¨é¢‘ç¹åˆ†é…çš„å¯¹è±¡ä»¥å‡å°‘ GC å‹åŠ›</li>
<li><strong>æµå¼å¤„ç†</strong>ï¼šåˆ†å—å¤„ç†å¤§å‹æ–‡æ¡£ä»¥æœ€å°åŒ–å†…å­˜ä½¿ç”¨</li>
<li><strong>Goroutine ç®¡ç†</strong>ï¼šæ§åˆ¶ goroutine ç”Ÿå‘½å‘¨æœŸä»¥é˜²æ­¢èµ„æºæ³„æ¼</li>
<li><strong>ç¼“å†²åŒºç®¡ç†</strong>ï¼šä¸º I/O æ“ä½œä½¿ç”¨å¤§å°åˆé€‚çš„ç¼“å†²åŒºä»¥å¹³è¡¡å†…å­˜ä½¿ç”¨å’Œæ€§èƒ½</li>
</ul>
<p>å¹¶å‘æ¶æ„ä½¿ç”¨ <code>sync.RWMutex</code> å¤„ç†è¯»å¯†é›†å‹æ“ä½œï¼ˆå¦‚æ¨¡å‹æŸ¥æ‰¾ï¼‰ï¼Œä½¿ç”¨ <code>sync.Mutex</code> å¤„ç†å†™æ“ä½œï¼Œç¡®ä¿åœ¨æ··åˆè¯»å†™å·¥ä½œè´Ÿè½½ä¸‹çš„æœ€ä½³æ€§èƒ½ã€‚</p>
<h2 data-id="heading-6">æ€§èƒ½ç›‘æ§å’ŒæŒ‡æ ‡</h2>
<p>è™½ç„¶åŸºç¡€åŸºç¡€è®¾æ–½å·²å°±ä½ï¼Œä½†ç”Ÿäº§ç¯å¢ƒåº”å®æ–½å…¨é¢çš„æ€§èƒ½ç›‘æ§ï¼š</p>
<ol>
<li>æ•°æ®åº“æŸ¥è¯¢å»¶è¿Ÿå’Œè¿æ¥æ± æŒ‡æ ‡</li>
<li>Redis ç¼“å­˜å‘½ä¸­ç‡å’Œå†…å­˜ä½¿ç”¨æƒ…å†µ</li>
<li>æ¶ˆæ¯é˜Ÿåˆ—ååé‡å’Œå¤„ç†å»¶è¿Ÿ</li>
<li>å‘é‡æœç´¢æŸ¥è¯¢æ—¶é—´å’Œå‡†ç¡®æ€§æŒ‡æ ‡</li>
<li>AI æ¨¡å‹æ¨ç†å»¶è¿Ÿå’Œèµ„æºåˆ©ç”¨ç‡</li>
</ol>
<p>å®æ–½å¸¦æœ‰å…³è” ID çš„ç»“æ„åŒ–æ—¥å¿—è®°å½•ï¼Œä»¥è¿½è¸ªé¢è¯•å¤„ç†ç®¡é“ä¸­çš„æ€§èƒ½ç“¶é¢ˆã€‚è¿™æœ‰åŠ©äºå¯¹ç«¯åˆ°ç«¯å»¶è¿Ÿè¿›è¡Œè¯¦ç»†åˆ†æã€‚</p>
<h2 data-id="heading-7">ä¼˜åŒ–å»ºè®®</h2>
<p>åŸºäºå½“å‰æ¶æ„ï¼Œè€ƒè™‘ä»¥ä¸‹æ€§èƒ½å¢å¼ºæªæ–½ï¼š</p>
<ol>
<li><strong>æ•°æ®åº“ç´¢å¼•</strong>ï¼šä¸ºé¢è¯•è®°å½•å’Œç”¨æˆ·ä¼šè¯ä¸­çš„é¢‘ç¹æŸ¥è¯¢æ¨¡å¼æ·»åŠ å¤åˆç´¢å¼•</li>
<li><strong>ç¼“å­˜é¢„çƒ­</strong>ï¼šå°†é¢‘ç¹è®¿é—®çš„é¢è¯•æ¨¡æ¿å’Œé—®é¢˜é›†é¢„åŠ è½½åˆ° Redis ç¼“å­˜ä¸­</li>
<li><strong>è¿æ¥æ± è°ƒä¼˜</strong>ï¼šæ ¹æ®å¹¶å‘ç”¨æˆ·æŒ‡æ ‡è°ƒæ•´æ•°æ®åº“å’Œ Redis è¿æ¥æ± </li>
<li><strong>æ‰¹å¤„ç†</strong>ï¼šä¸º AI æ¨¡å‹æ¨ç†å®ç°æ‰¹å¤„ç†æ“ä½œä»¥æé«˜ GPU åˆ©ç”¨ç‡</li>
<li><strong>CDN é›†æˆ</strong>ï¼šé€šè¿‡ CDN æä¾›é™æ€èµ„æºå’Œç¼“å­˜å“åº”ä»¥å‡å°‘å»¶è¿Ÿ</li>
</ol>
<p>æ€§èƒ½ä¼˜åŒ–åŸºç¡€ä¸ºå¤„ç†ä¸æ–­å¢é•¿çš„é¢è¯•å·¥ä½œè´Ÿè½½æä¾›äº†å¯æ‰©å±•çš„åŸºç¡€ï¼ŒåŒæ—¶ä¿æŒç³»ç»Ÿå“åº”æ€§å’Œå¯é æ€§ã€‚</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[ä¸‰ç§ä¾èµ–æ³¨å…¥è¯¦è§£]]></title>    <link>https://juejin.cn/post/7585463195201519666</link>    <guid>https://juejin.cn/post/7585463195201519666</guid>    <pubDate>2025-12-20T10:05:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585463195201519666" data-draft-id="7585463258690977801" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="ä¸‰ç§ä¾èµ–æ³¨å…¥è¯¦è§£"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2025-12-20T10:05:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="L0CK"/> <meta itemprop="url" content="https://juejin.cn/user/3555195572989993"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="æ˜é‡‘"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ä¸‰ç§ä¾èµ–æ³¨å…¥è¯¦è§£
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3555195572989993/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    L0CK
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T10:05:03.000Z" title="Sat Dec 20 2025 10:05:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    é˜…è¯»2åˆ†é’Ÿ
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>åœ¨ Spring æ¡†æ¶ä¸­ï¼Œå°†ä¸€ä¸ª Bean æ³¨å…¥åˆ°å¦ä¸€ä¸ª Bean é‡Œï¼Œä¸»è¦æœ‰ä¸‰ç§æ–¹å¼ã€‚</p>
<hr/>
<h2 data-id="heading-0">1. å±æ€§æ³¨å…¥ (Field Injection)</h2>
<p>è¿™æ˜¯åˆå­¦é˜¶æ®µå’Œå„ç§æ•™ç¨‹ä¸­æœ€å¸¸è§çš„æ–¹å¼ã€‚ç›´æ¥åœ¨æˆå‘˜å˜é‡ä¸ŠåŠ  <code>@Autowired</code>ã€‚</p>
<p><strong>ä»£ç ç¤ºä¾‹ï¼š</strong></p>
<p>Java</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@RestController</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> {

    <span class="hljs-meta">@Autowired</span> <span class="hljs-comment">// æ ¸å¿ƒåŠ¨ä½œï¼šç›´æ¥åœ¨å±æ€§ä¸Šç‚¹å</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">UserService</span> userService;

    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">list</span>(<span class="hljs-params"/>) {
        userService.<span class="hljs-title function_">findAll</span>();
    }
}
</code></pre>
<ul>
<li>
<p><strong>ä¼˜ç‚¹</strong>ï¼šä»£ç æœ€ç®€æ´ï¼Œçœ‹èµ·æ¥éå¸¸å¹²å‡€ã€‚</p>
</li>
<li>
<p><strong>ç¼ºç‚¹</strong>ï¼š</p>
<ul>
<li><strong>éš¾ä»¥è„±ç¦»å®¹å™¨ä½¿ç”¨</strong>ï¼šå¦‚æœä½ æƒ³åœ¨æ²¡æœ‰ Spring ç¯å¢ƒçš„æƒ…å†µä¸‹ï¼ˆæ¯”å¦‚å†™çº¯ Java çš„å•å…ƒæµ‹è¯•ï¼‰æ‰‹åŠ¨ new è¿™ä¸ªå¯¹è±¡ï¼Œä½ æ²¡æ³•ç»™ <code>userService</code> èµ‹å€¼ã€‚</li>
<li><strong>å®¹æ˜“å¾ªç¯ä¾èµ–</strong>ï¼šå¦‚æœ A æ³¨å…¥ Bï¼ŒB åˆæ³¨å…¥ Aï¼Œè¿™ç§æ–¹å¼æœ‰æ—¶ä¼šæ©ç›–ä»£ç è®¾è®¡çš„ç¼ºé™·ã€‚</li>
</ul>
</li>
</ul>
<hr/>
<h2 data-id="heading-1">2. Setter æ–¹æ³•æ³¨å…¥ (Setter Injection)</h2>
<p>é€šè¿‡ç±»çš„ Setter æ–¹æ³•æ¥å®Œæˆæ³¨å…¥ã€‚</p>
<p><strong>ä»£ç ç¤ºä¾‹ï¼š</strong></p>
<p>Java</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@RestController</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-title class_">UserService</span> userService;

    <span class="hljs-meta">@Autowired</span> <span class="hljs-comment">// æ ¸å¿ƒåŠ¨ä½œï¼šåœ¨ Setter æ–¹æ³•ä¸Šç‚¹å</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">setUserService</span>(<span class="hljs-params">UserService userService</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">userService</span> = userService;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">list</span>(<span class="hljs-params"/>) {
        userService.<span class="hljs-title function_">findAll</span>();
    }
}
</code></pre>
<ul>
<li>
<p><strong>ä¼˜ç‚¹</strong>ï¼šæ¯”è¾ƒçµæ´»ï¼Œå¯ä»¥åœ¨å¯¹è±¡åˆ›å»ºåé‡æ–°ä¿®æ”¹æ³¨å…¥çš„å®ä¾‹ã€‚</p>
</li>
<li>
<p><strong>ç¼ºç‚¹</strong>ï¼š</p>
<ul>
<li><strong>å®‰å…¨æ€§è¾ƒä½</strong>ï¼šå¯¹è±¡åœ¨è¢«è°ƒç”¨æ—¶ï¼Œå¯èƒ½è¿˜æ²¡æœ‰è¢«æ³¨å…¥ï¼ˆæ¯”å¦‚æœ‰äººä¸å°å¿ƒæ”¹äº†å€¼ï¼‰ï¼Œå¯¼è‡´ç©ºæŒ‡é’ˆå¼‚å¸¸ã€‚</li>
<li><strong>ä»£ç å†—é•¿</strong>ï¼šæ¯ä¸ªå±æ€§éƒ½è¦å†™ä¸€å¥— Setterã€‚</li>
</ul>
</li>
</ul>
<hr/>
<h2 data-id="heading-2">3. æ„é€ å™¨æ³¨å…¥ (Constructor Injection) â€”â€” <strong>å®˜æ–¹æ¨è</strong></h2>
<p>é€šè¿‡ç±»çš„æ„é€ æ–¹æ³•æ¥å®Œæˆæ³¨å…¥ã€‚è¿™æ˜¯ Spring å®˜æ–¹ç›®å‰æœ€æ¨èçš„æ–¹å¼ã€‚</p>
<p><strong>ä»£ç ç¤ºä¾‹ï¼š</strong></p>
<p>Java</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@RestController</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> UserService userService; <span class="hljs-comment">// ç”šè‡³å¯ä»¥åŠ  finalï¼Œä¿è¯ä¸å¯å˜</span>

    <span class="hljs-comment">// æ ¸å¿ƒåŠ¨ä½œï¼šåœ¨æ„é€ å‡½æ•°ä¸Šæ³¨å…¥ï¼ˆSpring 4.3åï¼Œå¦‚æœåªæœ‰ä¸€ä¸ªæ„é€ å‡½æ•°ï¼Œ@Autowiredå¯çœç•¥ï¼‰</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">UserController</span><span class="hljs-params">(UserService userService)</span> {
        <span class="hljs-built_in">this</span>.userService = userService;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">list</span><span class="hljs-params">()</span> {
        userService.findAll();
    }
}
</code></pre>
<ul>
<li>
<p><strong>ä¼˜ç‚¹</strong>ï¼š</p>
<ol>
<li><strong>ä¿è¯ä¸ä¸ºç©º</strong>ï¼šå¯¹è±¡ä¸€å‡ºç”Ÿï¼ˆæ„é€ æ—¶ï¼‰å°±å¿…é¡»æŠŠä¾èµ–ä¼ è¿›æ¥ï¼Œå¦åˆ™ç¼–è¯‘æŠ¥é”™ã€‚</li>
<li><strong>ä¸å¯å˜æ€§</strong>ï¼šå¯ä»¥ä½¿ç”¨ <code>final</code> å…³é”®å­—ï¼Œé˜²æ­¢ä»¥åè¢«ä¿®æ”¹ã€‚</li>
<li><strong>åˆ©äºæµ‹è¯•</strong>ï¼šå³ä¾¿æ²¡æœ‰ Springï¼Œä½ ä¹Ÿå¯ä»¥è½»æ¾åœ°é€šè¿‡ <code>new UserController(mockService)</code> æ¥è¿›è¡Œæµ‹è¯•ã€‚</li>
</ol>
</li>
<li>
<p><strong>ç¼ºç‚¹</strong>ï¼šå½“ä¾èµ–éå¸¸å¤šï¼ˆæ¯”å¦‚æœ‰ 10 ä¸ªï¼‰æ—¶ï¼Œæ„é€ å‡½æ•°çš„å‚æ•°åˆ—è¡¨ä¼šéå¸¸é•¿ã€‚</p>
</li>
</ul>
<hr/>
<h2 data-id="heading-3">æ€»ç»“ï¼šé¢è¯•æ€ä¹ˆç­”ï¼Ÿ</h2>

























<table><thead><tr><th><strong>æ–¹å¼</strong></th><th><strong>æ¨èç¨‹åº¦</strong></th><th><strong>ç†ç”±</strong></th></tr></thead><tbody><tr><td><strong>æ„é€ å™¨æ³¨å…¥</strong></td><td>â­â­â­â­â­</td><td>å®˜æ–¹æ¨èï¼Œå®‰å…¨ã€å¯é ã€æ–¹ä¾¿æµ‹è¯•ï¼Œä¿è¯å¯¹è±¡çŠ¶æ€å®Œæ•´ã€‚</td></tr><tr><td><strong>å±æ€§æ³¨å…¥</strong></td><td>â­â­â­</td><td>å¼€å‘å¿«ï¼Œä»£ç çœäº‹ï¼Œä½†åœ¨å¤§å‹é¡¹ç›®å’Œä¸¥æ ¼æµ‹è¯•ä¸­ä¸æ¨èã€‚</td></tr><tr><td><strong>Setter æ³¨å…¥</strong></td><td>â­â­</td><td>é™¤ééœ€è¦åœ¨è¿è¡ŒæœŸé—´åŠ¨æ€æ”¹å˜ä¾èµ–ï¼Œå¦åˆ™å¾ˆå°‘ä½¿ç”¨ã€‚</td></tr></tbody></table>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Linuxå…¥ä¾µæŒ–çŸ¿å¤„ç†è®°å½•]]></title>    <link>https://juejin.cn/post/7585412203979096107</link>    <guid>https://juejin.cn/post/7585412203979096107</guid>    <pubDate>2025-12-20T10:05:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585412203979096107" data-draft-id="7585412203979079723" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" Linuxå…¥ä¾µæŒ–çŸ¿å¤„ç†è®°å½•"/> <meta itemprop="keywords" content="åç«¯"/> <meta itemprop="datePublished" content="2025-12-20T10:05:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="å¹³å‡¡çš„è¿ç»´ä¹‹è·¯"/> <meta itemprop="url" content="https://juejin.cn/user/917424464473512"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="æ˜é‡‘"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             Linuxå…¥ä¾µæŒ–çŸ¿å¤„ç†è®°å½•
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/917424464473512/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    å¹³å‡¡çš„è¿ç»´ä¹‹è·¯
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T10:05:29.000Z" title="Sat Dec 20 2025 10:05:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    é˜…è¯»1åˆ†é’Ÿ
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">Linuxå…¥ä¾µæŒ–çŸ¿å¤„ç†è®°å½•</h3>
<ul>
<li>çªç„¶æ”¶åˆ°ç³»ç»Ÿå‘Šè­¦ï¼Œcpuä½¿ç”¨è¶…50%ä»¥ä¸Šï¼Œå®é™…å‘¨æœ«ä¸šåŠ¡ä½è°·æœŸï¼Œä¸ä¼šä½¿ç”¨è¿™ä¹ˆé«˜çš„cpuä½¿ç”¨ç‡ã€‚</li>
</ul>
<h4 data-id="heading-1">è§£å†³æ€è·¯</h4>
<ul>
<li>
<p>ç³»ç»ŸåŸºç¡€å‘½ä»¤è¢«æ›¿æ¢å¯¼è‡´ï¼Œæ— æ³•å±•ç¤ºéšè—çš„è¿›ç¨‹æˆ–è€…å…¶ä»–ä¿¡æ¯ï¼Œä½¿ç”¨BusyBox å‘½ä»¤ä»£æ›¿åŸºç¡€å‘½ä»¤ï¼Œèƒ½è¾“å‡ºå®Œæ•´ä¿¡æ¯ã€‚</p>
<ul>
<li>ä¸‹è½½åœ°å€ <code>https://www.busybox.net/downloads/binaries/1.30.0-i686/busybox</code></li>
</ul>
</li>
<li>
<p>ä½¿ç”¨busybox topå‘½ä»¤</p>
<ul>
<li>ä½¿ç”¨busybox topå‘½ä»¤ï¼Œå¯ä»¥æ¸…æ¥šå‘ç°å¼‚å¸¸è¿›ç¨‹å ç”¨cpuè¶…50%,</li>
</ul>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e923f90398e24bb38cb1bc02a0ed04e2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bmz5Yeh55qE6L-Q57u05LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766829929&amp;x-signature=BXOQitlP3GekJ8aMv0s%2Ba7omr4s%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>æ‰¾åˆ°è¿›ç¨‹æ–‡ä»¶ï¼Œæ¸…ç†è¯¥æ–‡ä»¶
<ul>
<li>è¿›å…¥/procç›®å½•ä¸‹æ‰¾åˆ°å¯¹åº”pidï¼ŒæŸ¥çœ‹environæ–‡ä»¶ï¼ŒSSC_ARGV0=å°±æ˜¯ç¨‹åºæœ¬èº«ï¼Œåˆ é™¤è¯¥æ–‡ä»¶åï¼Œé‡å¯æœåŠ¡å™¨çœ‹æ˜¯å¦è¿˜ä¼šæœ‰å¼‚å¸¸è¿›ç¨‹ã€‚</li>
</ul>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/feb6d0e294604584b578e445bc80cd89~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bmz5Yeh55qE6L-Q57u05LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766829929&amp;x-signature=WSmx8bJ0rh7h11v90efV5UmB57Y%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Strapi 5 æ€ä¹ˆç”¨æ‰å¤Ÿçˆ½ï¼Ÿè¿™æ¬¾æ’ä»¶å¸¦ä½ å®ç°â€œå»ºç«™è‡ªç”±â€]]></title>    <link>https://juejin.cn/post/7585452404113227791</link>    <guid>https://juejin.cn/post/7585452404113227791</guid>    <pubDate>2025-12-20T09:10:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585452404113227791" data-draft-id="7585452404113195023" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Strapi 5 æ€ä¹ˆç”¨æ‰å¤Ÿçˆ½ï¼Ÿè¿™æ¬¾æ’ä»¶å¸¦ä½ å®ç°â€œå»ºç«™è‡ªç”±â€"/> <meta itemprop="keywords" content="åç«¯,Node.js"/> <meta itemprop="datePublished" content="2025-12-20T09:10:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="çŸ¥èˆªé©¿ç«™"/> <meta itemprop="url" content="https://juejin.cn/user/4125023356335576"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="æ˜é‡‘"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Strapi 5 æ€ä¹ˆç”¨æ‰å¤Ÿçˆ½ï¼Ÿè¿™æ¬¾æ’ä»¶å¸¦ä½ å®ç°â€œå»ºç«™è‡ªç”±â€
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4125023356335576/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    çŸ¥èˆªé©¿ç«™
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T09:10:10.000Z" title="Sat Dec 20 2025 09:10:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    é˜…è¯»2åˆ†é’Ÿ
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{line-height:1.75;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;letter-spacing:2px;background-image:linear-gradient(90deg,rgba(50,0,0,.05) 3%,transparent 0),linear-gradient(1turn,rgba(50,0,0,.05) 3%,transparent 0);background-size:20px 20px;background-position:50%;word-break:break-word;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body h1{font-size:23px;margin-bottom:5px;font-weight:700;padding-left:10px;border-left:5px solid #773098}.markdown-body h2{font-size:19px;font-weight:700;padding-left:10px;border-left:5px solid #916dd5}.markdown-body h3{font-size:17px;font-weight:700;padding-left:10px;border-left:5px solid #d89cf6}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{font-size:14px;margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{display:block;max-width:100%;margin:1em 0;border-radius:6px;box-shadow:2px 4px 7px #999;user-select:none}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{padding:.2em .5em;font-weight:700;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-size:1em;color:#916dd5;word-break:break-word;overflow-x:auto;background-color:none;border-radius:2px}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-weight:400;font-size:.9em;padding:16px 12px;margin:0;color:#333;word-break:normal;overflow-x:auto;background:#f8f8f8;scroll-behavior:smooth}.markdown-body a{text-decoration:none;color:#916dd5;font-weight:700;border-bottom:1px solid #916dd5}.markdown-body a:active,.markdown-body a:hover{color:#773098}.markdown-body table{display:inline-block!important;font-size:14px;width:auto;max-width:100%;overflow:auto;border:1px solid #916dd5;border-collapse:collapse}.markdown-body thead{background-color:#916dd5;color:#fff;text-align:left}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px;border:1px solid #916dd5}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #d89cf6;background-color:#f4eeff}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0;line-height:26px}.markdown-body ol,.markdown-body ul{padding-left:28px;list-style-type:circle}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body b,.markdown-body strong{color:#916dd5;font-weight:700}.markdown-body b:before,.markdown-body strong:before{content:"ã€Œ"}.markdown-body b:after,.markdown-body strong:after{content:"ã€"}.markdown-body em,.markdown-body i{color:#916dd5}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="github-gist">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fff;color:#333}.hljs-comment,.hljs-meta{color:#969896}.hljs-emphasis,.hljs-quote,.hljs-strong,.hljs-template-variable,.hljs-variable{color:#df5000}.hljs-keyword,.hljs-selector-tag,.hljs-type{color:#d73a49}.hljs-attribute,.hljs-bullet,.hljs-literal,.hljs-symbol{color:#0086b3}.hljs-name,.hljs-section{color:#63a35c}.hljs-tag{color:#333}.hljs-attr,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-id,.hljs-selector-pseudo,.hljs-title{color:#6f42c1}.hljs-addition{color:#55a532;background-color:#eaffea}.hljs-deletion{color:#bd2c00;background-color:#ffecec}.hljs-link{text-decoration:underline}.hljs-number{color:#005cc5}.hljs-string{color:#032f62}</style><p>Strapi 5 æ˜¯ä¸€ä¸ªä¼˜ç§€çš„åŸºçŸ³ï¼Œè€Œ <strong>strapi-plugin-bag</strong> åˆ™æ˜¯å…¶ä¸Šçš„â€œç²¾è£…ä¿®â€æ–¹æ¡ˆã€‚æˆ‘ä»¬è‡´åŠ›äºè§£å†³å¼€å‘è€…åœ¨å•†ä¸šåŒ–äº¤ä»˜è¿‡ç¨‹ä¸­çš„é‚£äº›é‡å¤åŠ³åŠ¨ï¼Œè®©å¤§å®¶èƒ½æŠŠç²¾åŠ›é›†ä¸­åœ¨çœŸæ­£çš„ä¸šåŠ¡é€»è¾‘ä¸Šã€‚</p>
<p>æœ¬é¡¹ç›®å·²åœ¨ GitHub å¼€æºï¼Œå¹¶åŸºäº <strong>Turborepo</strong> ç»´æŠ¤ï¼ŒåŒ…å«äº†å®Œæ•´çš„æ–‡æ¡£å’Œå‰åç«¯ä»£ç ã€‚</p>
<ul>
<li><strong>GitHub ä»“åº“</strong>ï¼š<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fhangjob%2Fstrapi-plugin-bag" target="_blank" title="https://github.com/hangjob/strapi-plugin-bag" ref="nofollow noopener noreferrer">github.com/hangjob/strâ€¦</a></li>
<li><strong>åœ¨çº¿æ–‡æ¡£</strong>ï¼š<a href="https://link.juejin.cn?target=https%3A%2F%2Fhangjob.github.io%2Fstrapi-plugin-bag%2F" target="_blank" title="https://hangjob.github.io/strapi-plugin-bag/" ref="nofollow noopener noreferrer">hangjob.github.io/strapi-plugâ€¦</a></li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3be8cfd60d9942b08d2b6f5cd91cc7c6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55-l6Iiq6am_56uZ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766826610&amp;x-signature=vqmEgr8EqX9brTXu41eqHLr%2BkEQ%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-0">æ ¸å¿ƒç‰¹æ€§</h2>
<ul>
<li>ğŸ›¡ï¸ <strong>å®‰å…¨é˜²å¾¡</strong>ï¼šå†…ç½®åŠ¨æ€ IP é»‘ç™½åå•ã€å¤šé‡éªŒè¯ç æ‹¦æˆªé€»è¾‘ã€‚</li>
<li>ğŸ” <strong>éšç§åŠ å›º</strong>ï¼šä¸€é”®å¯ç”¨ RSA 2048 ä¸ AES 256 æ•°æ®åŠ å¯†æœåŠ¡ã€‚</li>
<li>ğŸ“° <strong>å†…å®¹ç”Ÿæ€</strong>ï¼šå®Œå–„çš„æ–‡ç« ã€åˆ†ç±»ã€æ ‡ç­¾ç®¡ç†ï¼Œå†…ç½® SEO ä¸é˜…è¯»é‡ç»Ÿè®¡ã€‚</li>
<li>ğŸ—ºï¸ <strong>å¯è§†åŒ–è¿è¥</strong>ï¼šå¯è§†åŒ–ç®¡ç†å¤šçº§èœå•ã€å¹»ç¯ç‰‡ã€å‹æƒ…é“¾æ¥ã€‚</li>
<li>ğŸ’¬ <strong>äº’åŠ¨äº¤äº’</strong>ï¼šå¼ºå¤§çš„å¤šçº§è¯„è®ºå®¡æ ¸æœºåˆ¶ä¸ç‹¬ç«‹ç•™è¨€æ¿ã€‚</li>
<li>ğŸš€ <strong>æé€Ÿäº¤ä»˜</strong>ï¼šå…¨ä¸­æ–‡é€‚é…ï¼Œæ·±åº¦ä¼˜åŒ– Strapi 5 æ“ä½œä½“éªŒã€‚</li>
<li/>
</ul>
<h2 data-id="heading-1">ç¯å¢ƒè¦æ±‚</h2>
<p>åœ¨å¼€å§‹ä¹‹å‰ï¼Œè¯·ç¡®ä¿æ‚¨çš„å¼€å‘ç¯å¢ƒæ»¡è¶³ä»¥ä¸‹è¦æ±‚ï¼š</p>
<ul>
<li><strong>Strapi ç‰ˆæœ¬</strong>: <code>^5.0.0</code> (æ”¯æŒæœ€æ–°çš„ Strapi 5 æ¶æ„)</li>
<li><strong>Node.js ç‰ˆæœ¬</strong>: <code>&gt;=22.10.0</code></li>
<li><strong>æ•°æ®åº“</strong>: MySQL, PostgreSQL æˆ– SQLite</li>
</ul>
<h2 data-id="heading-2">å®‰è£…æ­¥éª¤</h2>
<p>æ‚¨å¯ä»¥ä½¿ç”¨æ‚¨å–œæ¬¢çš„åŒ…ç®¡ç†å™¨å°†æ’ä»¶æ·»åŠ åˆ°æ‚¨çš„ Strapi é¡¹ç›®ä¸­ã€‚</p>
<pre><code class="hljs language-bash" lang="bash">pnpm add strapi-plugin-bag
</code></pre>
<h2 data-id="heading-3">å¯ç”¨æ’ä»¶</h2>
<p>å®‰è£…å®Œæˆåï¼Œæ‚¨éœ€è¦æ‰‹åŠ¨åœ¨ Strapi çš„é…ç½®æ–‡ä»¶ä¸­å¯ç”¨è¯¥æ’ä»¶ã€‚</p>
<p>ç¼–è¾‘æˆ–åˆ›å»ºé¡¹ç›®æ ¹ç›®å½•ä¸‹çš„ <code>config/plugins.js</code> (æˆ– <code>config/plugins.ts</code>) æ–‡ä»¶ï¼š</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-function">(<span class="hljs-params">{ env }</span>) =&gt;</span> ({
  <span class="hljs-comment">// ... å…¶ä»–æ’ä»¶é…ç½®</span>
  <span class="hljs-string">"strapi-plugin-bag"</span>: {
    <span class="hljs-attr">enabled</span>: <span class="hljs-literal">true</span>,
  },
});
</code></pre>
<h2 data-id="heading-4">é‡æ–°æ„å»º</h2>
<p>ä¸ºäº†è®©æ’ä»¶çš„åå°ç®¡ç†ç•Œé¢ç”Ÿæ•ˆï¼Œæ‚¨éœ€è¦é‡æ–°æ„å»º Strapi çš„ç®¡ç†é¢æ¿å¹¶é‡å¯æœåŠ¡ï¼š</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># æ„å»ºç®¡ç†é¢æ¿</span>
npm run build

<span class="hljs-comment"># å¯åŠ¨å¼€å‘æœåŠ¡å™¨</span>
npm run dev
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/98a42f9b6b8c4bfab6fa57256a876ebf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55-l6Iiq6am_56uZ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766826610&amp;x-signature=AyHO1SHMe%2Fv2P9ts4dI%2BLF9PsI4%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-5">æƒé™é…ç½®</h2>
<p>å¯ç”¨æ’ä»¶åï¼Œæ‚¨éœ€è¦ä¸ºç›¸åº”çš„è§’è‰²é…ç½® API è®¿é—®æƒé™ï¼š</p>
<ol>
<li>ç™»å½• Strapi ç®¡ç†åå°ã€‚</li>
<li>å‰å¾€ <strong>Settings (è®¾ç½®)</strong> -&gt; <strong>Users &amp; Permissions Plugin</strong> -&gt; <strong>Roles (è§’è‰²)</strong>ã€‚</li>
<li>é€‰æ‹©æ‚¨æƒ³è¦é…ç½®çš„è§’è‰²ï¼ˆå¦‚ <code>Public</code> æˆ– <code>Authenticated</code>ï¼‰ã€‚</li>
<li>åœ¨ <strong>Permissions (æƒé™)</strong> åˆ—è¡¨ä¸­æ‰¾åˆ° <strong>Strapi-plugin-bag</strong>ã€‚</li>
<li>å‹¾é€‰æ‚¨éœ€è¦å¼€æ”¾çš„ API æƒé™ï¼ˆå¦‚ <code>article.find</code>, <code>menu.findOne</code> ç­‰ï¼‰ã€‚</li>
<li>ç‚¹å‡»å³ä¸Šè§’çš„ <strong>Save (ä¿å­˜)</strong>ã€‚</li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7481680accff4270b0df50836742b563~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55-l6Iiq6am_56uZ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766826610&amp;x-signature=8%2FSWWqCtXMnQcYAESliBfHl91RI%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-6">ç¯å¢ƒå¯è§†åŒ–é…ç½®</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ff3db7f4873f4ab38d1dbec6fd4914c0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55-l6Iiq6am_56uZ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766826610&amp;x-signature=c%2ByHVcnSweVJqau6aANHwykrmhY%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[è„šæ‰‹æ¶å¼€å‘å·¥å…·â€”â€”dotenv]]></title>    <link>https://juejin.cn/post/7585474459776466980</link>    <guid>https://juejin.cn/post/7585474459776466980</guid>    <pubDate>2025-12-20T08:58:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585474459776466980" data-draft-id="7585485074037456902" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="è„šæ‰‹æ¶å¼€å‘å·¥å…·â€”â€”dotenv"/> <meta itemprop="keywords" content="å‰ç«¯"/> <meta itemprop="datePublished" content="2025-12-20T08:58:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="code_YuJun"/> <meta itemprop="url" content="https://juejin.cn/user/3615612462441358"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="æ˜é‡‘"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            è„šæ‰‹æ¶å¼€å‘å·¥å…·â€”â€”dotenv
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3615612462441358/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    code_YuJun
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T08:58:20.000Z" title="Sat Dec 20 2025 08:58:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    14
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    é˜…è¯»1åˆ†é’Ÿ
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">ç®€ä»‹</h2>
<p>dotenv æ˜¯ä¸€ä¸ª<strong>è½»é‡çº§çš„ Node.js ç¯å¢ƒå˜é‡ç®¡ç†å·¥å…·</strong>ï¼Œå…¶æ ¸å¿ƒä½œç”¨æ˜¯ï¼š<strong>ä»é¡¹ç›®æ ¹ç›®å½•çš„Â <code>.env</code>Â æ–‡ä»¶ä¸­åŠ è½½è‡ªå®šä¹‰çš„ç¯å¢ƒå˜é‡ï¼Œå¹¶å°†å®ƒä»¬æ³¨å…¥åˆ° Node.js çš„Â <code>process.env</code>Â å¯¹è±¡ä¸­</strong>ï¼Œä½¿å¾—æˆ‘ä»¬å¯ä»¥åœ¨é¡¹ç›®ä»£ç ä¸­ç»Ÿä¸€é€šè¿‡Â <code>process.env.XXX</code>Â çš„æ–¹å¼è·å–è¿™äº›ç¯å¢ƒé…ç½®ï¼Œæ— éœ€æ‰‹åŠ¨åœ¨ç³»ç»Ÿç¯å¢ƒä¸­é…ç½®ä¸´æ—¶å˜é‡æˆ–æ°¸ä¹…å˜é‡ã€‚</p>
<h2 data-id="heading-1">æ ¸å¿ƒå·¥ä½œåŸç†</h2>
<ol>
<li>å½“åœ¨é¡¹ç›®ä¸­å¼•å…¥å¹¶æ‰§è¡Œ dotenv æ—¶ï¼Œå®ƒä¼šè‡ªåŠ¨æŸ¥æ‰¾é¡¹ç›®æ ¹ç›®å½•ä¸‹çš„Â <code>.env</code>Â æ–‡ä»¶ï¼ˆè¯¥æ–‡ä»¶ä¸ºçº¯æ–‡æœ¬æ ¼å¼ï¼Œé‡‡ç”¨é”®å€¼å¯¹é…ç½®ï¼‰ï¼›</li>
<li>å®ƒä¼šè§£æÂ <code>.env</code>Â æ–‡ä»¶ä¸­çš„æ¯ä¸€è¡Œé…ç½®ï¼ˆæ ¼å¼é€šå¸¸ä¸ºÂ <code>KEY=VALUE</code>ï¼‰ï¼›</li>
<li>å°†è§£æåçš„é”®å€¼å¯¹é€ä¸€æŒ‚è½½åˆ° Node.js å†…ç½®çš„Â <code>process.env</code>Â å¯¹è±¡ä¸Šï¼ˆ<code>process.env</code>Â åŸæœ¬ç”¨äºå­˜å‚¨ç³»ç»Ÿçº§ç¯å¢ƒå˜é‡ï¼Œdotenv ä¸ºå…¶æ‰©å±•äº†é¡¹ç›®è‡ªå®šä¹‰ç¯å¢ƒå˜é‡ï¼‰ï¼›</li>
<li>ä¹‹ååœ¨é¡¹ç›®çš„ä»»æ„ä»£ç æ–‡ä»¶ä¸­ï¼Œéƒ½å¯ä»¥é€šè¿‡Â <code>process.env.KEY</code>Â çš„å½¢å¼è·å–å¯¹åº”çš„å€¼ã€‚</li>
</ol>
<h2 data-id="heading-2">ä½¿ç”¨ç¤ºä¾‹</h2>
<pre><code class="hljs language-css" lang="css">npm install dotenv <span class="hljs-attr">--save</span>
</code></pre>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># .env æ–‡ä»¶å†…å®¹ å½“å‰ç”¨æˆ·è·¯å¾„ä¸‹åˆ›å»ºÂ `.env`Â æ–‡ä»¶</span>
<span class="hljs-attr">PORT</span>=<span class="hljs-number">3000</span>
<span class="hljs-attr">DB_HOST</span>=localhost
<span class="hljs-attr">DB_USER</span>=root
<span class="hljs-attr">DB_PASSWORD</span>=<span class="hljs-number">123456</span>
<span class="hljs-attr">API_KEY</span>=abcdefg123456
</code></pre>
<pre><code class="hljs language-js" lang="js">    <span class="hljs-keyword">const</span> dotenv = <span class="hljs-built_in">require</span>(<span class="hljs-string">'dotenv'</span>);
    <span class="hljs-keyword">const</span> dotenvPath = path.<span class="hljs-title function_">resolve</span>(userHome, <span class="hljs-string">'.env'</span>); <span class="hljs-comment">// /Users/***/.env</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-title function_">pathExists</span>(dotenvPath)) {
        dotenv.<span class="hljs-title function_">config</span>({
            <span class="hljs-attr">path</span>: dotenvPath,
        });
    }
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[ã€ŠFlutterå…¨æ ˆå¼€å‘å®æˆ˜æŒ‡å—ï¼šä»é›¶åˆ°é«˜çº§ã€‹- 26 -æŒç»­é›†æˆä¸éƒ¨ç½²]]></title>    <link>https://juejin.cn/post/7585463195201404978</link>    <guid>https://juejin.cn/post/7585463195201404978</guid>    <pubDate>2025-12-20T08:56:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585463195201404978" data-draft-id="7585686247269548041" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="ã€ŠFlutterå…¨æ ˆå¼€å‘å®æˆ˜æŒ‡å—ï¼šä»é›¶åˆ°é«˜çº§ã€‹- 26 -æŒç»­é›†æˆä¸éƒ¨ç½²"/> <meta itemprop="keywords" content="Flutter,Android,iOS"/> <meta itemprop="datePublished" content="2025-12-20T08:56:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="QuantumLeapä¸¶"/> <meta itemprop="url" content="https://juejin.cn/user/1767603104125197"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="æ˜é‡‘"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ã€ŠFlutterå…¨æ ˆå¼€å‘å®æˆ˜æŒ‡å—ï¼šä»é›¶åˆ°é«˜çº§ã€‹- 26 -æŒç»­é›†æˆä¸éƒ¨ç½²
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1767603104125197/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    QuantumLeapä¸¶
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T08:56:38.000Z" title="Sat Dec 20 2025 08:56:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    é˜…è¯»12åˆ†é’Ÿ
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">å¼•è¨€</h2>
<blockquote>
<p>ä»£ç å†™å¾—å†å¥½ï¼Œæ²¡æœ‰è‡ªåŠ¨åŒ–çš„æµæ°´çº¿ï¼Œå°±åƒæ³•æ‹‰åˆ©å¼•æ“è£…åœ¨ç‰›è½¦ä¸Šï¼ï¼ï¼</p>
</blockquote>
<p><strong>ä»€ä¹ˆæ˜¯æŒç»­é›†æˆä¸éƒ¨ç½²ï¼Ÿç®€å•è¯´å°±æ˜¯ï¼š</strong></p>
<ul>
<li>ä½ å†™ä»£ç  â†’ è‡ªåŠ¨æµ‹è¯• â†’ è‡ªåŠ¨æ‰“åŒ… â†’ è‡ªåŠ¨å‘å¸ƒ</li>
<li>å°±åƒå·¥å‚çš„æµæ°´çº¿ï¼Œä»£ç è¿›å»ï¼ŒAppå‡ºæ¥</li>
</ul>
<p>ä»Šå¤©æˆ‘ä»¬ä¸€èµ·æ¥æ­å»ºè¿™æ¡"ä»£ç æµæ°´çº¿"ï¼Œè®©ä½ çš„å¼€å‘æ•ˆç‡å¤§å¹…æå‡ï¼</p>
<h3 data-id="heading-1">ä¸€ï¼šCI/CDåˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆæ¯ä¸ªå›¢é˜Ÿéƒ½éœ€è¦ï¼Ÿ</h3>
<h4 data-id="heading-2">1.1 ä»æ‰‹åŠ¨æ“ä½œåˆ°è‡ªåŠ¨åŒ–æµæ°´çº¿</h4>
<p>å…ˆçœ‹çœ‹ä¼ ç»Ÿå¼€å‘æµç¨‹çš„ç—›ç‚¹ï¼š</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// ä¼ ç»Ÿå‘å¸ƒæµç¨‹ï¼ˆæ‰‹åŠ¨ç‰ˆï¼‰</span>
  <span class="hljs-number">1.</span> æœ¬åœ°è¿è¡Œæµ‹è¯•();       <span class="hljs-comment">// æŸäº›æµ‹è¯•å¯èƒ½å¿˜è®°è¿è¡Œ</span>
  <span class="hljs-number">2.</span> æ‰‹åŠ¨æ‰“åŒ…Android();    <span class="hljs-comment">// é…ç½®è¯ä¹¦ã€ç­¾åã€ç‰ˆæœ¬å·...</span>
  <span class="hljs-number">3.</span> æ‰‹åŠ¨æ‰“åŒ…iOS();        <span class="hljs-comment">// è¯ä¹¦ã€æè¿°æ–‡ä»¶ã€ä¸Šæ¶æˆªå›¾...</span>
  <span class="hljs-number">4.</span> ä¸Šä¼ åˆ°æµ‹è¯•å¹³å°();     <span class="hljs-comment">// æ‰¾æµ‹è¯•å¦¹å­è¦æ‰‹æœºå·</span>
  <span class="hljs-number">5.</span> æ”¶é›†åé¦ˆä¿®å¤bug();    <span class="hljs-comment">// æ¥å›æ²Ÿé€šï¼Œæ•ˆç‡ä½ä¸‹</span>
  <span class="hljs-number">6.</span> é‡å¤æ­¥éª¤<span class="hljs-number">1</span><span class="hljs-number">-5</span>();        <span class="hljs-comment">// æ— é™å¾ªç¯...</span>
</code></pre>
<p>å†çœ‹è‡ªåŠ¨åŒ–æµæ°´çº¿ï¼š</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># è‡ªåŠ¨åŒ–å‘å¸ƒæµç¨‹ï¼ˆCI/CDç‰ˆï¼‰</span>
<span class="hljs-string">æµç¨‹:</span>
  <span class="hljs-number">1</span><span class="hljs-string">.</span> <span class="hljs-string">æ¨é€ä»£ç åˆ°GitHub/Gitlab</span> <span class="hljs-string">â†’</span> <span class="hljs-string">è‡ªåŠ¨è§¦å‘</span>
  <span class="hljs-number">2</span><span class="hljs-string">.</span> <span class="hljs-string">è¿è¡Œæ‰€æœ‰æµ‹è¯•</span> <span class="hljs-string">â†’</span> <span class="hljs-string">å¤±è´¥è‡ªåŠ¨é€šçŸ¥</span>
  <span class="hljs-number">3</span><span class="hljs-string">.</span> <span class="hljs-string">æ‰“åŒ…æ‰€æœ‰å¹³å°</span> <span class="hljs-string">â†’</span> <span class="hljs-string">åŒæ—¶è¿›è¡Œ</span>
  <span class="hljs-number">4</span><span class="hljs-string">.</span> <span class="hljs-string">åˆ†å‘åˆ°æµ‹è¯•ç¯å¢ƒ</span> <span class="hljs-string">â†’</span> <span class="hljs-string">è‡ªåŠ¨åˆ†å‘ç»™æµ‹è¯•äººå‘˜</span>
  <span class="hljs-number">5</span><span class="hljs-string">.</span> <span class="hljs-string">å‘å¸ƒåˆ°åº”ç”¨å•†åº—</span> <span class="hljs-string">â†’</span> <span class="hljs-string">æ¡ä»¶è§¦å‘</span>
</code></pre>
<h4 data-id="heading-3">1.2 CI/CDçš„æ ¸å¿ƒä»·å€¼</h4>
<p>å¾ˆå¤šæ–°æ‰‹è§‰å¾—CI/CDæ˜¯"å¤§å…¬å¸æ‰éœ€è¦çš„ä¸œè¥¿"ï¼Œå…¶å®å®Œå…¨é”™äº†ï¼å®ƒè§£å†³çš„æ˜¯è¿™äº›ç—›ç‚¹ï¼š</p>
<p><strong>é—®é¢˜1ï¼šç¯å¢ƒä¸ä¸€è‡´</strong></p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">æœ¬åœ°ç¯å¢ƒ: Flutter 3.10, Dart 2.18, Mac M1</span>
<span class="hljs-section">æµ‹è¯•ç¯å¢ƒ: Flutter 3.7, Dart 2.17, Windows</span>
<span class="hljs-section">ç”Ÿäº§ç¯å¢ƒ: ???</span>
</code></pre>
<p><strong>é—®é¢˜2ï¼šæ‰‹åŠ¨æ“ä½œå®¹æ˜“å‡ºé”™</strong>
ä¹‹å‰é‡åˆ°è¿‡åŒäº‹æŠŠdebugåŒ…å‘ç»™äº†ç”¨æˆ·ï¼Œå› ä¸ºæ‰“åŒ…æ—¶é€‰é”™äº†æ„å»ºå˜ä½“ã€‚</p>
<p><strong>é—®é¢˜3ï¼šåé¦ˆå‘¨æœŸå¤ªé•¿</strong>
ä»£ç æäº¤ â†’ æ‰‹åŠ¨æ‰“åŒ… â†’ å‘ç»™æµ‹è¯• â†’ å‘ç°é—®é¢˜ â†’ å·²ç»è¿‡äº†åŠå¤©</p>
<h4 data-id="heading-4">1.3 CI/CDçš„ä¸‰ä¸ªæ ¸å¿ƒæ¦‚å¿µ</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[ä»£ç æäº¤] --&gt; B[æŒç»­é›†æˆ CI]
    B --&gt; C[æŒç»­äº¤ä»˜ CD]
    C --&gt; D[æŒç»­éƒ¨ç½² CD]
    
    B --&gt; E[è‡ªåŠ¨æ„å»º]
    B --&gt; F[è‡ªåŠ¨æµ‹è¯•]
    
    C --&gt; G[è‡ªåŠ¨æ‰“åŒ…]
    C --&gt; H[è‡ªåŠ¨å‘å¸ƒåˆ°æµ‹è¯•]
    
    D --&gt; I[è‡ªåŠ¨å‘å¸ƒåˆ°ç”Ÿäº§]
    
    style A fill:#e3f2fd
    style B fill:#f3e5f5
    style C fill:#e8f5e8
    style D fill:#fff3e0
</code></pre>
<p><strong>æŒç»­é›†æˆï¼ˆCIï¼‰</strong>ï¼šé¢‘ç¹é›†æˆä»£ç åˆ°ä¸»å¹²ï¼Œæ¯æ¬¡é›†æˆéƒ½é€šè¿‡è‡ªåŠ¨åŒ–æµ‹è¯•</p>
<p><strong>æŒç»­äº¤ä»˜ï¼ˆCDï¼‰</strong>ï¼šè‡ªåŠ¨å°†ä»£ç æ‰“åŒ…æˆå¯éƒ¨ç½²çš„äº§ç‰©</p>
<p><strong>æŒç»­éƒ¨ç½²ï¼ˆCDï¼‰</strong>ï¼šè‡ªåŠ¨å°†äº§ç‰©éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ</p>
<blockquote>
<p>æ³¨æ„ï¼šä¸¤ä¸ªCDè™½ç„¶ç¼©å†™ä¸€æ ·ï¼Œä½†å«ä¹‰ä¸åŒã€‚Continuous Deliveryï¼ˆæŒç»­äº¤ä»˜ï¼‰å’Œ Continuous Deploymentï¼ˆæŒç»­éƒ¨ç½²ï¼‰</p>
</blockquote>
<h3 data-id="heading-5">äºŒï¼šGitHub Actions</h3>
<p>æˆ‘ä»¬ä»¥githubä¸ºä¾‹ï¼Œå½“ç„¶å„å…¬å¸æœ‰å•ç‹¬éƒ¨ç½²çš„gitlabï¼Œå¤§åŒå°å¼‚è¿™é‡Œä¸åœ¨èµ˜è¿°ã€‚ã€‚ã€‚</p>
<h4 data-id="heading-6">2.1 GitHub Actionså·¥ä½œåŸç†</h4>
<p>GitHub Actionsä¸æ˜¯é­”æ³•ï¼Œè€Œæ˜¯GitHubæä¾›çš„<strong>è‡ªåŠ¨åŒ–æ‰§è¡Œç¯å¢ƒ</strong>ã€‚æƒ³è±¡ä¸€ä¸‹ï¼š</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[ä½ çš„ä»£ç ä»“åº“] --&gt; B[äº‹ä»¶æ¨é€/PR]
    B --&gt; C[GitHub ActionsæœåŠ¡å™¨]
    C --&gt; D[åˆ†é…è™šæ‹Ÿæœº]
    D --&gt; E[ä½ çš„å·¥ä½œæµ]
    E --&gt; F[è¿è¡Œä½ çš„è„šæœ¬]

    style A fill:#f9f,stroke:#333,stroke-width:1px
    style C fill:#9f9,stroke:#333,stroke-width:1px
    style E fill:#99f,stroke:#333,stroke-width:1px
</code></pre>
<p><strong>æ ¸å¿ƒç»„ä»¶è§£æ</strong>ï¼š</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># å·¥ä½œæµç»„ä»¶å…³ç³»å›¾</span>
<span class="hljs-string">å·¥ä½œæµæ–‡ä»¶</span> <span class="hljs-string">(.github/workflows/ci.yml)</span>
    <span class="hljs-string">â”œâ”€â”€</span> <span class="hljs-string">è§¦å‘å™¨:</span> <span class="hljs-string">ä»€ä¹ˆæƒ…å†µä¸‹è¿è¡Œ</span> <span class="hljs-string">(push,</span> <span class="hljs-string">pull_request)</span>
    <span class="hljs-string">â”œâ”€â”€</span> <span class="hljs-string">ä»»åŠ¡:</span> <span class="hljs-string">åœ¨ä»€ä¹ˆç¯å¢ƒä¸‹è¿è¡Œ</span> <span class="hljs-string">(ubuntu-latest)</span>
    <span class="hljs-string">â””â”€â”€</span> <span class="hljs-string">æ­¥éª¤:</span> <span class="hljs-string">å…·ä½“æ‰§è¡Œä»€ä¹ˆ</span> <span class="hljs-string">(å®‰è£…Flutterã€è¿è¡Œæµ‹è¯•)</span>
</code></pre>
<h4 data-id="heading-7">2.2 åˆ›å»ºä½ çš„ç¬¬ä¸€ä¸ªå·¥ä½œæµ</h4>
<p>åˆ«è¢«å“åˆ°ï¼Œå…¶å®åˆ›å»ºä¸€ä¸ªåŸºç¡€çš„CIæµç¨‹åªéœ€è¦5åˆ†é’Ÿï¼š</p>
<ol>
<li><strong>åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»ºæ–‡ä»¶å¤¹</strong>ï¼š</li>
</ol>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">mkdir</span> -p .github/workflows
</code></pre>
<ol start="2">
<li><strong>åˆ›å»ºCIé…ç½®æ–‡ä»¶</strong>ï¼š</li>
</ol>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># .github/workflows/flutter-ci.yml</span>
<span class="hljs-attr">name:</span> <span class="hljs-string">Flutter</span> <span class="hljs-string">CI</span>  <span class="hljs-comment"># å·¥ä½œæµåç§°</span>

<span class="hljs-comment"># è§¦å‘æ¡ä»¶ï¼šå½“æœ‰ä»£ç æ¨é€åˆ°mainåˆ†æ”¯ï¼Œæˆ–è€…æœ‰PRæ—¶</span>
<span class="hljs-attr">on:</span>
  <span class="hljs-attr">push:</span>
    <span class="hljs-attr">branches:</span> [ <span class="hljs-string">main</span>, <span class="hljs-string">develop</span> ]
  <span class="hljs-attr">pull_request:</span>
    <span class="hljs-attr">branches:</span> [ <span class="hljs-string">main</span> ]

<span class="hljs-comment"># è®¾ç½®æƒé™</span>
<span class="hljs-attr">permissions:</span>
  <span class="hljs-attr">contents:</span> <span class="hljs-string">read</span>  <span class="hljs-comment"># åªè¯»æƒé™ï¼Œä¿è¯å®‰å…¨</span>

<span class="hljs-comment"># å·¥ä½œæµä¸­çš„ä»»åŠ¡</span>
<span class="hljs-attr">jobs:</span>
  <span class="hljs-comment"># ä»»åŠ¡1ï¼šè¿è¡Œæµ‹è¯•</span>
  <span class="hljs-attr">test:</span>
    <span class="hljs-comment"># è¿è¡Œåœ¨Ubuntuæœ€æ–°ç‰ˆ</span>
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>
    
    <span class="hljs-comment"># ä»»åŠ¡æ­¥éª¤</span>
    <span class="hljs-attr">steps:</span>
      <span class="hljs-comment"># æ­¥éª¤1ï¼šæ£€å‡ºä»£ç </span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Checkout</span> <span class="hljs-string">code</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v3</span>
        
      <span class="hljs-comment"># æ­¥éª¤2ï¼šå®‰è£…Flutter</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Setup</span> <span class="hljs-string">Flutter</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">subosito/flutter-action@v2</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">flutter-version:</span> <span class="hljs-string">'3.10.x'</span>  <span class="hljs-comment"># æŒ‡å®šFlutterç‰ˆæœ¬</span>
          <span class="hljs-attr">channel:</span> <span class="hljs-string">'stable'</span>          <span class="hljs-comment"># ç¨³å®šç‰ˆ</span>
        
      <span class="hljs-comment"># æ­¥éª¤3ï¼šè·å–ä¾èµ–</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Get</span> <span class="hljs-string">dependencies</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">flutter</span> <span class="hljs-string">pub</span> <span class="hljs-string">get</span>
        
      <span class="hljs-comment"># æ­¥éª¤4ï¼šè¿è¡Œæµ‹è¯•</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Run</span> <span class="hljs-string">tests</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">flutter</span> <span class="hljs-string">test</span>
        
      <span class="hljs-comment"># æ­¥éª¤5ï¼šæ£€æŸ¥ä»£ç æ ¼å¼</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Check</span> <span class="hljs-string">formatting</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">flutter</span> <span class="hljs-string">format</span> <span class="hljs-string">--set-exit-if-changed</span> <span class="hljs-string">.</span>
        
      <span class="hljs-comment"># æ­¥éª¤6ï¼šé™æ€åˆ†æ</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Analyze</span> <span class="hljs-string">code</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">flutter</span> <span class="hljs-string">analyze</span>
</code></pre>
<ol start="3">
<li><strong>æäº¤å¹¶æ¨é€ä»£ç </strong>ï¼š</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">git add .github/workflows/flutter-ci.yml
git commit -m <span class="hljs-string">"æ·»åŠ CIå·¥ä½œæµ"</span>
git push origin main
</code></pre>
<p>æ¨é€åˆ°GitHubåï¼Œæ‰“å¼€ä½ çš„ä»“åº“é¡µé¢ï¼Œç‚¹å‡»"Actions"æ ‡ç­¾ï¼Œä½ ä¼šçœ‹åˆ°ä¸€ä¸ªå·¥ä½œæµæ­£åœ¨è¿è¡Œï¼</p>
<h4 data-id="heading-8">2.3 GitHub Actionsæ¶æ„</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    subgraph &amp;#34;GitHub Actionsæ¶æ„&amp;#34;
        A[ä½ çš„ä»£ç ä»“åº“] --&gt; B[è§¦å‘äº‹ä»¶]
        B --&gt; C[GitHub Actions Runner]
        
        subgraph &amp;#34;Runneræ‰§è¡Œç¯å¢ƒ&amp;#34;
            C --&gt; D[åˆ›å»ºè™šæ‹Ÿæœº]
            D --&gt; E[æ‰§è¡Œå·¥ä½œæµ]
            
            subgraph &amp;#34;å·¥ä½œæµæ­¥éª¤&amp;#34;
                E --&gt; F[æ£€å‡ºä»£ç ]
                F --&gt; G[ç¯å¢ƒé…ç½®]
                G --&gt; H[æ‰§è¡Œè„šæœ¬]
                H --&gt; I[äº§å‡ºç‰©]
            end
        end
        
        I --&gt; J[ç»“æœåé¦ˆ]
        J --&gt; K[GitHub UIæ˜¾ç¤º]
        J --&gt; L[é‚®ä»¶/é€šçŸ¥]
    end
    
    style A fill:#e3f2fd
    style C fill:#f3e5f5
    style E fill:#e8f5e8
    style I fill:#fff3e0
</code></pre>
<p><strong>æ ¸å¿ƒæ¦‚å¿µè§£é‡Š</strong>ï¼š</p>
<ol>
<li><strong>Runner</strong>ï¼šGitHubæä¾›çš„è™šæ‹Ÿæœºï¼ˆæˆ–ä½ è‡ªå·±çš„æœåŠ¡å™¨ï¼‰ï¼Œç”¨æ¥æ‰§è¡Œå·¥ä½œæµ</li>
<li><strong>Workflow</strong>ï¼šå·¥ä½œæµï¼Œä¸€ä¸ªå®Œæ•´çš„è‡ªåŠ¨åŒ–æµç¨‹</li>
<li><strong>Job</strong>ï¼šä»»åŠ¡ï¼Œå·¥ä½œæµä¸­çš„ç‹¬ç«‹å•å…ƒ</li>
<li><strong>Step</strong>ï¼šæ­¥éª¤ï¼Œä»»åŠ¡ä¸­çš„å…·ä½“æ“ä½œ</li>
<li><strong>Action</strong>ï¼šå¯å¤ç”¨çš„æ“ä½œå•å…ƒï¼Œå¦‚"å®‰è£…Flutter"</li>
</ol>
<h3 data-id="heading-9">ä¸‰ï¼šè‡ªåŠ¨åŒ–æµ‹è¯•æµæ°´çº¿</h3>
<h4 data-id="heading-10">3.1 ä¸ºä»€ä¹ˆè‡ªåŠ¨åŒ–æµ‹è¯•å¦‚æ­¤é‡è¦ï¼Ÿ</h4>
<p>åŠŸèƒ½ä¸Šçº¿å‰ï¼Œå…¨éƒ¨åŠŸèƒ½æ‰‹åŠ¨æµ‹è¯•è€—æ—¶é•¿ï¼Œæ˜“å‡ºbugã€‚åŠ å…¥è‡ªåŠ¨åŒ–æµ‹è¯•ï¼Œæœ‰æ•ˆå‡å°‘bugç‡ã€‚</p>
<p><strong>æµ‹è¯•é‡‘å­—å¡”ç†è®º</strong>ï¼š</p>
<pre><code class="hljs language-bash" lang="bash">        /\
       /  \      E2Eæµ‹è¯•ï¼ˆå°‘é‡ï¼‰
      /____\     
     /      \    é›†æˆæµ‹è¯•ï¼ˆé€‚ä¸­ï¼‰
    /________\
   /          \  å•å…ƒæµ‹è¯•ï¼ˆå¤§é‡ï¼‰
  /____________\
</code></pre>
<p>å¯¹äºFlutterï¼Œæµ‹è¯•åˆ†ä¸ºä¸‰å±‚ï¼š</p>
<h4 data-id="heading-11">3.2 é…ç½®å•å…ƒæµ‹è¯•</h4>
<p>å•å…ƒæµ‹è¯•æ˜¯æœ€åŸºç¡€çš„ï¼Œæµ‹è¯•å•ä¸ªå‡½æ•°æˆ–ç±»ï¼š</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># .github/workflows/unit-tests.yml</span>
<span class="hljs-attr">name:</span> <span class="hljs-string">Unit</span> <span class="hljs-string">Tests</span>

<span class="hljs-attr">on:</span> [<span class="hljs-string">push</span>, <span class="hljs-string">pull_request</span>]

<span class="hljs-attr">jobs:</span>
  <span class="hljs-attr">unit-tests:</span>
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>
    
    <span class="hljs-attr">strategy:</span>
      <span class="hljs-attr">matrix:</span>
        <span class="hljs-comment"># åœ¨ä¸åŒç‰ˆæœ¬çš„Flutterä¸Šè¿è¡Œæµ‹è¯•</span>
        <span class="hljs-attr">flutter:</span> [<span class="hljs-string">'3.7.x'</span>, <span class="hljs-string">'3.10.x'</span>]
    
    <span class="hljs-attr">steps:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Checkout</span> <span class="hljs-string">code</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v3</span>
        
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Setup</span> <span class="hljs-string">Flutter</span> <span class="hljs-string">${{</span> <span class="hljs-string">matrix.flutter</span> <span class="hljs-string">}}</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">subosito/flutter-action@v2</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">flutter-version:</span> <span class="hljs-string">${{</span> <span class="hljs-string">matrix.flutter</span> <span class="hljs-string">}}</span>
          
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Get</span> <span class="hljs-string">dependencies</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">flutter</span> <span class="hljs-string">pub</span> <span class="hljs-string">get</span>
        
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Run</span> <span class="hljs-string">unit</span> <span class="hljs-string">tests</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          # è¿è¡Œæ‰€æœ‰å•å…ƒæµ‹è¯•
          flutter test
</span>          
          <span class="hljs-comment"># ç”Ÿæˆæµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š</span>
          <span class="hljs-string">flutter</span> <span class="hljs-string">test</span> <span class="hljs-string">--coverage</span>
          
          <span class="hljs-comment"># ä¸Šä¼ è¦†ç›–ç‡æŠ¥å‘Š</span>
          <span class="hljs-string">bash</span> <span class="hljs-string">&lt;(curl</span> <span class="hljs-string">-s</span> <span class="hljs-string">https://codecov.io/bash)</span>
</code></pre>
<p><strong>å•å…ƒæµ‹è¯•</strong>ï¼š</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// test/calculator_test.dart</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter_test/flutter_test.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:my_app/utils/calculator.dart'</span>;

<span class="hljs-keyword">void</span> main() {
  group(<span class="hljs-string">'ä»¥Calculatoræµ‹è¯•ä¸ºä¾‹'</span>, () {
    <span class="hljs-keyword">late</span> Calculator calculator;
    
    <span class="hljs-comment">// å‡†å¤‡å·¥ä½œ</span>
    setUp(() {
      calculator = Calculator();
    });
    
    test(<span class="hljs-string">'ä¸¤ä¸ªæ­£æ•°ç›¸åŠ '</span>, () {
      expect(calculator.add(<span class="hljs-number">2</span>, <span class="hljs-number">3</span>), <span class="hljs-number">5</span>);
    });
    
    test(<span class="hljs-string">'æ­£æ•°ä¸è´Ÿæ•°ç›¸åŠ '</span>, () {
      expect(calculator.add(<span class="hljs-number">5</span>, <span class="hljs-number">-3</span>), <span class="hljs-number">2</span>);
    });
    
    test(<span class="hljs-string">'é™¤ä»¥é›¶åº”è¯¥æŠ›å‡ºå¼‚å¸¸'</span>, () {
      expect(() =&gt; calculator.divide(<span class="hljs-number">10</span>, <span class="hljs-number">0</span>), throwsA(isA&lt;ArgumentError&gt;()));
    });
  });
}
</code></pre>
<h4 data-id="heading-12">3.3 é…ç½®é›†æˆæµ‹è¯•</h4>
<p>é›†æˆæµ‹è¯•æµ‹è¯•å¤šä¸ªç»„ä»¶çš„äº¤äº’ï¼š</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># é›†æˆæµ‹è¯•å·¥ä½œæµ</span>
<span class="hljs-attr">jobs:</span>
  <span class="hljs-attr">integration-tests:</span>
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">macos-latest</span>  <span class="hljs-comment"># iOSé›†æˆæµ‹è¯•éœ€è¦macOS</span>
    
    <span class="hljs-attr">steps:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Checkout</span> <span class="hljs-string">code</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v3</span>
        
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Setup</span> <span class="hljs-string">Flutter</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">subosito/flutter-action@v2</span>
        
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Get</span> <span class="hljs-string">dependencies</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">flutter</span> <span class="hljs-string">pub</span> <span class="hljs-string">get</span>
        
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Run</span> <span class="hljs-string">integration</span> <span class="hljs-string">tests</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          # å¯åŠ¨æ¨¡æ‹Ÿå™¨
          # flutter emulators --launch flutter_emulator
</span>          
          <span class="hljs-comment"># è¿è¡Œé›†æˆæµ‹è¯•</span>
          <span class="hljs-string">flutter</span> <span class="hljs-string">test</span> <span class="hljs-string">integration_test/</span>
          
      <span class="hljs-comment"># å¦‚æœé›†æˆæµ‹è¯•å¤±è´¥ï¼Œä¸Šä¼ æˆªå›¾è¾…åŠ©è°ƒè¯•</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Upload</span> <span class="hljs-string">screenshots</span> <span class="hljs-string">on</span> <span class="hljs-string">failure</span>
        <span class="hljs-attr">if:</span> <span class="hljs-string">failure()</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/upload-artifact@v3</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">name:</span> <span class="hljs-string">integration-test-screenshots</span>
          <span class="hljs-attr">path:</span> <span class="hljs-string">screenshots/</span>
</code></pre>
<h4 data-id="heading-13">3.4 é…ç½®Widgetæµ‹è¯•</h4>
<p>Widgetæµ‹è¯•æµ‹è¯•UIç»„ä»¶ï¼š</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">jobs:</span>
  <span class="hljs-attr">widget-tests:</span>
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>
    
    <span class="hljs-attr">steps:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Checkout</span> <span class="hljs-string">code</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v3</span>
        
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Setup</span> <span class="hljs-string">Flutter</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">subosito/flutter-action@v2</span>
        
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Install</span> <span class="hljs-string">dependencies</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          flutter pub get
</span>          
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Run</span> <span class="hljs-string">widget</span> <span class="hljs-string">tests</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          # è¿è¡Œæ‰€æœ‰widgetæµ‹è¯•
          flutter test test/widget_test.dart
</span>          
          <span class="hljs-comment"># æˆ–è€…è¿è¡Œç‰¹å®šç›®å½•</span>
          <span class="hljs-string">flutter</span> <span class="hljs-string">test</span> <span class="hljs-string">test/widgets/</span>
</code></pre>
<h4 data-id="heading-14">3.5 æµ‹è¯•æµæ°´çº¿</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant D as å¼€å‘è€…
    participant G as Gitä»“åº“
    participant CI as CIæœåŠ¡å™¨
    participant UT as å•å…ƒæµ‹è¯•æœåŠ¡
    participant WT as Widgetæµ‹è¯•æœåŠ¡
    participant IT as é›†æˆæµ‹è¯•æœåŠ¡
    participant R as æŠ¥å‘ŠæœåŠ¡
    participant N as é€šçŸ¥æœåŠ¡
    
    D-&gt;&gt;G: æ¨é€ä»£ç 
    G-&gt;&gt;CI: è§¦å‘Webhook
    
    CI-&gt;&gt;CI: è§£æå·¥ä½œæµé…ç½®
    CI-&gt;&gt;CI: åˆ†é…æµ‹è¯•èµ„æº
    
    par å¹¶è¡Œæ‰§è¡Œ
        CI-&gt;&gt;UT: å¯åŠ¨å•å…ƒæµ‹è¯•
        UT-&gt;&gt;UT: å‡†å¤‡ç¯å¢ƒ
        UT-&gt;&gt;UT: æ‰§è¡Œæµ‹è¯•
        UT-&gt;&gt;UT: åˆ†æè¦†ç›–ç‡
        UT--&gt;&gt;CI: è¿”å›ç»“æœ
    and
        CI-&gt;&gt;WT: å¯åŠ¨Widgetæµ‹è¯•
        WT-&gt;&gt;WT: å‡†å¤‡UIç¯å¢ƒ
        WT-&gt;&gt;WT: æ‰§è¡Œæµ‹è¯•
        WT-&gt;&gt;WT: æˆªå›¾å¯¹æ¯”
        WT--&gt;&gt;CI: è¿”å›ç»“æœ
    and
        CI-&gt;&gt;IT: å¯åŠ¨é›†æˆæµ‹è¯•
        IT-&gt;&gt;IT: å‡†å¤‡è®¾å¤‡
        IT-&gt;&gt;IT: æ‰§è¡Œæµ‹è¯•
        IT-&gt;&gt;IT: ç«¯åˆ°ç«¯éªŒè¯
        IT--&gt;&gt;CI: è¿”å›ç»“æœ
    end
    
    CI-&gt;&gt;CI: æ”¶é›†æ‰€æœ‰ç»“æœ
    
    alt æ‰€æœ‰æµ‹è¯•é€šè¿‡
        CI-&gt;&gt;R: è¯·æ±‚ç”ŸæˆæŠ¥å‘Š
        R-&gt;&gt;R: ç”Ÿæˆè¯¦ç»†æŠ¥å‘Š
        R--&gt;&gt;CI: è¿”å›æŠ¥å‘Š
        CI-&gt;&gt;N: å‘é€æˆåŠŸé€šçŸ¥
        N--&gt;&gt;D: é€šçŸ¥å¼€å‘è€…
    else æœ‰æµ‹è¯•å¤±è´¥
        CI-&gt;&gt;R: è¯·æ±‚ç”Ÿæˆé”™è¯¯æŠ¥å‘Š
        R-&gt;&gt;R: ç”Ÿæˆé”™è¯¯æŠ¥å‘Š
        R--&gt;&gt;CI: è¿”å›æŠ¥å‘Š
        CI-&gt;&gt;N: å‘é€å¤±è´¥é€šçŸ¥
        N--&gt;&gt;D: è­¦æŠ¥å¼€å‘è€…
    end
</code></pre>
<h3 data-id="heading-15">å››ï¼šè‡ªåŠ¨æ‰“åŒ…ä¸å‘å¸ƒæµæ°´çº¿</h3>
<h4 data-id="heading-16">4.1 Androidè‡ªåŠ¨æ‰“åŒ…</h4>
<p>Androidæ‰“åŒ…ç›¸å¯¹ç®€å•ï¼Œä½†è¦æ³¨æ„ç­¾åé—®é¢˜ï¼š</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># .github/workflows/android-build.yml</span>
<span class="hljs-attr">name:</span> <span class="hljs-string">Android</span> <span class="hljs-string">Build</span>

<span class="hljs-attr">on:</span>
  <span class="hljs-attr">push:</span>
    <span class="hljs-attr">tags:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">'v*'</span>  <span class="hljs-comment"># åªæœ‰æ‰“tagæ—¶æ‰è§¦å‘æ‰“åŒ…</span>

<span class="hljs-attr">jobs:</span>
  <span class="hljs-attr">build-android:</span>
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>
    
    <span class="hljs-attr">steps:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Checkout</span> <span class="hljs-string">code</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v3</span>
        
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Setup</span> <span class="hljs-string">Java</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/setup-java@v3</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">distribution:</span> <span class="hljs-string">'temurin'</span>
          <span class="hljs-attr">java-version:</span> <span class="hljs-string">'17'</span>
          
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Setup</span> <span class="hljs-string">Flutter</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">subosito/flutter-action@v2</span>
        
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Get</span> <span class="hljs-string">dependencies</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">flutter</span> <span class="hljs-string">pub</span> <span class="hljs-string">get</span>
        
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Setup</span> <span class="hljs-string">keystore</span>
        <span class="hljs-comment"># ä»GitHub Secretsè¯»å–ç­¾åå¯†é’¥</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          echo "${{ secrets.ANDROID_KEYSTORE }}" &gt; android/app/key.jks.base64
          base64 -d android/app/key.jks.base64 &gt; android/app/key.jks
</span>          
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Build</span> <span class="hljs-string">APK</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          # æ„å»ºReleaseç‰ˆAPK
          flutter build apk --release \
            --dart-define=APP_VERSION=${{ github.ref_name }} \
            --dart-define=BUILD_NUMBER=${{ github.run_number }}
            
</span>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Build</span> <span class="hljs-string">App</span> <span class="hljs-string">Bundle</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          # æ„å»ºApp Bundle
          flutter build appbundle --release
</span>          
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Upload</span> <span class="hljs-string">artifacts</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/upload-artifact@v3</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">name:</span> <span class="hljs-string">android-build-${{</span> <span class="hljs-string">github.run_number</span> <span class="hljs-string">}}</span>
          <span class="hljs-attr">path:</span> <span class="hljs-string">|
            build/app/outputs/flutter-apk/app-release.apk
            build/app/outputs/bundle/release/app-release.aab
</span></code></pre>
<h4 data-id="heading-17">4.2 iOSè‡ªåŠ¨æ‰“åŒ…</h4>
<p>iOSæ‰“åŒ…ç›¸å¯¹å¤æ‚ï¼Œéœ€è¦è‹¹æœå¼€å‘è€…è´¦å·ï¼š</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># .github/workflows/ios-build.yml</span>
<span class="hljs-attr">name:</span> <span class="hljs-string">iOS</span> <span class="hljs-string">Build</span>

<span class="hljs-attr">on:</span>
  <span class="hljs-attr">push:</span>
    <span class="hljs-attr">tags:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">'v*'</span>

<span class="hljs-attr">jobs:</span>
  <span class="hljs-attr">build-ios:</span>
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">macos-latest</span>
    
    <span class="hljs-attr">steps:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Checkout</span> <span class="hljs-string">code</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v3</span>
        
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Setup</span> <span class="hljs-string">Flutter</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">subosito/flutter-action@v2</span>
        
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Install</span> <span class="hljs-string">CocoaPods</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          cd ios
          pod install
</span>          
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Setup</span> <span class="hljs-string">Xcode</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          # è®¾ç½®Xcodeç‰ˆæœ¬
          sudo xcode-select -s /Applications/Xcode_14.2.app
</span>          
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Setup</span> <span class="hljs-string">provisioning</span> <span class="hljs-string">profiles</span>
        <span class="hljs-comment"># é…ç½®è¯ä¹¦å’Œæè¿°æ–‡ä»¶</span>
        <span class="hljs-attr">env:</span>
          <span class="hljs-attr">BUILD_CERTIFICATE_BASE64:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.BUILD_CERTIFICATE</span> <span class="hljs-string">}}</span>
          <span class="hljs-attr">P12_PASSWORD:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.P12_PASSWORD</span> <span class="hljs-string">}}</span>
          <span class="hljs-attr">BUILD_PROVISION_PROFILE_BASE64:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.BUILD_PROVISION_PROFILE</span> <span class="hljs-string">}}</span>
          
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          # å¯¼å…¥è¯ä¹¦
          echo $BUILD_CERTIFICATE_BASE64 | base64 --decode &gt; certificate.p12
</span>          
          <span class="hljs-comment"># åˆ›å»ºé’¥åŒ™é“¾</span>
          <span class="hljs-string">security</span> <span class="hljs-string">create-keychain</span> <span class="hljs-string">-p</span> <span class="hljs-string">""</span> <span class="hljs-string">build.keychain</span>
          <span class="hljs-string">security</span> <span class="hljs-string">default-keychain</span> <span class="hljs-string">-s</span> <span class="hljs-string">build.keychain</span>
          <span class="hljs-string">security</span> <span class="hljs-string">unlock-keychain</span> <span class="hljs-string">-p</span> <span class="hljs-string">""</span> <span class="hljs-string">build.keychain</span>
          
          <span class="hljs-comment"># å¯¼å…¥è¯ä¹¦åˆ°é’¥åŒ™é“¾</span>
          <span class="hljs-string">security</span> <span class="hljs-string">import</span> <span class="hljs-string">certificate.p12</span> <span class="hljs-string">-k</span> <span class="hljs-string">build.keychain</span> <span class="hljs-string">\</span>
            <span class="hljs-string">-P</span> <span class="hljs-string">$P12_PASSWORD</span> <span class="hljs-string">-T</span> <span class="hljs-string">/usr/bin/codesign</span>
          
          <span class="hljs-comment"># å¯¼å…¥æè¿°æ–‡ä»¶</span>
          <span class="hljs-string">echo</span> <span class="hljs-string">$BUILD_PROVISION_PROFILE_BASE64</span> <span class="hljs-string">|</span> <span class="hljs-string">base64</span> <span class="hljs-string">--decode</span> <span class="hljs-string">&gt;</span> <span class="hljs-string">profile.mobileprovision</span>
          <span class="hljs-string">mkdir</span> <span class="hljs-string">-p</span> <span class="hljs-string">~/Library/MobileDevice/Provisioning\</span> <span class="hljs-string">Profiles</span>
          <span class="hljs-string">cp</span> <span class="hljs-string">profile.mobileprovision</span> <span class="hljs-string">~/Library/MobileDevice/Provisioning\</span> <span class="hljs-string">Profiles/</span>
          
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Build</span> <span class="hljs-string">iOS</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          # æ„å»ºiOSåº”ç”¨
          flutter build ipa --release \
            --export-options-plist=ios/ExportOptions.plist \
            --dart-define=APP_VERSION=${{ github.ref_name }} \
            --dart-define=BUILD_NUMBER=${{ github.run_number }}
            
</span>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Upload</span> <span class="hljs-string">IPA</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/upload-artifact@v3</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">name:</span> <span class="hljs-string">ios-build-${{</span> <span class="hljs-string">github.run_number</span> <span class="hljs-string">}}</span>
          <span class="hljs-attr">path:</span> <span class="hljs-string">build/ios/ipa/*.ipa</span>
</code></pre>
<h4 data-id="heading-18">4.3 å¤šç¯å¢ƒæ„å»ºé…ç½®</h4>
<p>çœŸå®çš„é¡¹ç›®é€šå¸¸æœ‰å¤šä¸ªç¯å¢ƒï¼š</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># å¤šç¯å¢ƒæ„å»ºé…ç½®</span>
<span class="hljs-attr">env:</span>
  <span class="hljs-comment"># æ ¹æ®åˆ†æ”¯é€‰æ‹©ç¯å¢ƒ</span>
  <span class="hljs-attr">APP_ENV:</span> <span class="hljs-string">${{</span> <span class="hljs-string">github.ref</span> <span class="hljs-string">==</span> <span class="hljs-string">'refs/heads/main'</span> <span class="hljs-string">&amp;&amp;</span> <span class="hljs-string">'production'</span> <span class="hljs-string">||</span> <span class="hljs-string">'staging'</span> <span class="hljs-string">}}</span>
  <span class="hljs-attr">APP_NAME:</span> <span class="hljs-string">${{</span> <span class="hljs-string">github.ref</span> <span class="hljs-string">==</span> <span class="hljs-string">'refs/heads/main'</span> <span class="hljs-string">&amp;&amp;</span> <span class="hljs-string">'ç”Ÿäº§'</span> <span class="hljs-string">||</span> <span class="hljs-string">'æµ‹è¯•'</span> <span class="hljs-string">}}</span>

<span class="hljs-attr">jobs:</span>
  <span class="hljs-attr">build:</span>
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>
    
    <span class="hljs-attr">strategy:</span>
      <span class="hljs-attr">matrix:</span>
        <span class="hljs-comment"># åŒæ—¶æ„å»ºå¤šä¸ªFlavor</span>
        <span class="hljs-attr">flavor:</span> [<span class="hljs-string">development</span>, <span class="hljs-string">staging</span>, <span class="hljs-string">production</span>]
        <span class="hljs-attr">platform:</span> [<span class="hljs-string">android</span>, <span class="hljs-string">ios</span>]
        
    <span class="hljs-attr">steps:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Checkout</span> <span class="hljs-string">code</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v3</span>
        
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Setup</span> <span class="hljs-string">Flutter</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">subosito/flutter-action@v2</span>
        
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Build</span> <span class="hljs-string">${{</span> <span class="hljs-string">matrix.platform</span> <span class="hljs-string">}}</span> <span class="hljs-string">for</span> <span class="hljs-string">${{</span> <span class="hljs-string">matrix.flavor</span> <span class="hljs-string">}}</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          if [ "${{ matrix.platform }}" = "android" ]; then
            flutter build apk --flavor ${{ matrix.flavor }} --release
          else
            flutter build ipa --flavor ${{ matrix.flavor }} --release
          fi
</span>          
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Upload</span> <span class="hljs-string">${{</span> <span class="hljs-string">matrix.flavor</span> <span class="hljs-string">}}</span> <span class="hljs-string">build</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/upload-artifact@v3</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">name:</span> <span class="hljs-string">${{</span> <span class="hljs-string">matrix.platform</span> <span class="hljs-string">}}-${{</span> <span class="hljs-string">matrix.flavor</span> <span class="hljs-string">}}</span>
          <span class="hljs-attr">path:</span> <span class="hljs-string">|
            build/app/outputs/flutter-apk/app-${{ matrix.flavor }}-release.apk
            build/ios/ipa/*.ipa
</span></code></pre>
<h4 data-id="heading-19">4.4 è‡ªåŠ¨åŒ–å‘å¸ƒåˆ°æµ‹è¯•å¹³å°</h4>
<p>æ„å»ºå®Œæˆåï¼Œè‡ªåŠ¨åˆ†å‘ç»™æµ‹è¯•äººå‘˜ï¼š</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># åˆ†å‘åˆ°æµ‹è¯•å¹³å°</span>
<span class="hljs-attr">jobs:</span>
  <span class="hljs-attr">distribute:</span>
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>
    <span class="hljs-attr">needs:</span> [<span class="hljs-string">build</span>]  <span class="hljs-comment"># ä¾èµ–buildä»»åŠ¡</span>
    
    <span class="hljs-attr">steps:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Download</span> <span class="hljs-string">artifacts</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/download-artifact@v3</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">path:</span> <span class="hljs-string">artifacts/</span>
          
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Upload</span> <span class="hljs-string">to</span> <span class="hljs-string">Firebase</span> <span class="hljs-string">App</span> <span class="hljs-string">Distribution</span>
        <span class="hljs-comment"># åˆ†å‘åˆ°Firebase</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          # å®‰è£…Firebase CLI
          curl -sL https://firebase.tools | bash
</span>          
          <span class="hljs-comment"># ç™»å½•Firebase</span>
          <span class="hljs-string">echo</span> <span class="hljs-string">"$<span class="hljs-template-variable">{{ secrets.FIREBASE_TOKEN }}</span>"</span> <span class="hljs-string">&gt;</span> <span class="hljs-string">firebase_token.json</span>
          
          <span class="hljs-comment"># åˆ†å‘Android APK</span>
          <span class="hljs-string">firebase</span> <span class="hljs-string">appdistribution:distribute</span> <span class="hljs-string">artifacts/android-production/app-release.apk</span> <span class="hljs-string">\</span>
            <span class="hljs-string">--app</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.FIREBASE_ANDROID_APP_ID</span> <span class="hljs-string">}}</span> <span class="hljs-string">\</span>
            <span class="hljs-string">--groups</span> <span class="hljs-string">"testers"</span> <span class="hljs-string">\</span>
            <span class="hljs-string">--release-notes-file</span> <span class="hljs-string">CHANGELOG.md</span>
            
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Upload</span> <span class="hljs-string">to</span> <span class="hljs-string">TestFlight</span>
        <span class="hljs-comment"># iOSä¸Šä¼ åˆ°TestFlight</span>
        <span class="hljs-attr">if:</span> <span class="hljs-string">matrix.platform</span> <span class="hljs-string">==</span> <span class="hljs-string">'ios'</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          # ä½¿ç”¨altoolä¸Šä¼ åˆ°App Store Connect
          xcrun altool --upload-app \
            -f artifacts/ios-production/*.ipa \
            -t ios \
            --apiKey ${{ secrets.APPSTORE_API_KEY }} \
            --apiIssuer ${{ secrets.APPSTORE_API_ISSUER }}
            
</span>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Notify</span> <span class="hljs-string">testers</span>
        <span class="hljs-comment"># é€šçŸ¥æµ‹è¯•äººå‘˜</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">8398a7/action-slack@v3</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">status:</span> <span class="hljs-string">${{</span> <span class="hljs-string">job.status</span> <span class="hljs-string">}}</span>
          <span class="hljs-attr">fields:</span> <span class="hljs-string">repo,message,commit,author,action,eventName,ref,workflow,job,took</span>
        <span class="hljs-attr">env:</span>
          <span class="hljs-attr">SLACK_WEBHOOK_URL:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.SLACK_WEBHOOK_URL</span> <span class="hljs-string">}}</span>
</code></pre>
<h4 data-id="heading-20">4.5 æ‰“åŒ…å‘å¸ƒæµæ°´çº¿</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">gantt
    title Flutteræ‰“åŒ…å‘å¸ƒæµæ°´çº¿
    dateFormat HH:mm
    axisFormat %H:%M
    
    section è§¦å‘ä¸å‡†å¤‡
    ä»£ç æäº¤æ£€æµ‹ :00:00, 2m
    ç¯å¢ƒåˆå§‹åŒ– :00:02, 3m
    ä¾èµ–å®‰è£… :00:05, 4m
    
    section Androidæ„å»º
    Androidç¯å¢ƒå‡†å¤‡ :00:05, 2m
    Androidä»£ç ç¼–è¯‘ :00:07, 6m
    Androidä»£ç ç­¾å :00:13, 3m
    Androidæ‰“åŒ… :00:16, 2m
    
    section iOSæ„å»º
    iOSç¯å¢ƒå‡†å¤‡ :00:05, 3m
    iOSä»£ç ç¼–è¯‘ :00:08, 8m
    iOSè¯ä¹¦é…ç½® :00:16, 4m
    iOSæ‰“åŒ… :00:20, 3m
    
    section æµ‹è¯•åˆ†å‘
    ä¸Šä¼ åˆ°æµ‹è¯•å¹³å° :00:23, 5m
    æµ‹è¯•äººå‘˜é€šçŸ¥ :00:28, 2m
    æµ‹è¯•æ‰§è¡Œå‘¨æœŸ :00:30, 30m
    
    section ç”Ÿäº§å‘å¸ƒ
    æµ‹è¯•ç»“æœè¯„ä¼° :01:00, 3m
    ç”Ÿäº§ç¯å¢ƒå‡†å¤‡ :01:03, 5m
    æäº¤åˆ°åº”ç”¨å•†åº— :01:08, 10m
    å•†åº—å®¡æ ¸ç­‰å¾… :01:18, 30m
    å‘å¸ƒå®Œæˆé€šçŸ¥ :01:48, 2m
    
    section ç¯å¢ƒé…ç½®ç®¡ç†
    å¯†é’¥åŠ è½½ :00:02, 3m
    ç¯å¢ƒå˜é‡è®¾ç½® :00:05, 2m
    é…ç½®æ–‡ä»¶è§£æ :00:07, 3m
    ç‰ˆæœ¬å·å¤„ç† :00:10, 2m
</code></pre>
<h3 data-id="heading-21">äº”ï¼šç¯å¢ƒé…ç½®ç®¡ç†</h3>
<h4 data-id="heading-22">5.1 ä¸ºä»€ä¹ˆéœ€è¦ç¯å¢ƒé…ç½®ç®¡ç†ï¼Ÿ</h4>
<p>å…ˆçœ‹ä¸€ä¸ªåé¢æ•™æï¼šæˆ‘ä»¬é¡¹ç›®æ—©æœŸï¼Œä¸åŒç¯å¢ƒçš„APIåœ°å€æ˜¯ç¡¬ç¼–ç çš„ï¼š</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// ä¸æ¨èï¼šç¡¬ç¼–ç é…ç½®</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ApiConfig</span> </span>{
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-built_in">String</span> baseUrl = <span class="hljs-string">'https://api.production.com'</span>;
  <span class="hljs-comment">// æµ‹è¯•æ—¶éœ€è¦æ‰‹åŠ¨æ”¹æˆï¼š'https://api.staging.com'</span>
  <span class="hljs-comment">// å¾ˆå®¹æ˜“å¿˜è®°æ”¹å›æ¥ï¼</span>
}
</code></pre>
<p>ç»“æœå°±æ˜¯ï¼šæµ‹è¯•æ—¶è°ƒç”¨äº†ç”Ÿäº§æ¥å£ï¼ŒæŠŠæµ‹è¯•æ•°æ®æ’åˆ°äº†ç”Ÿäº§æ•°æ®åº“ï¼ğŸ’¥</p>
<h4 data-id="heading-23">5.2 å¤šç¯å¢ƒé…ç½®æ–¹æ¡ˆ</h4>
<p><strong>æ–¹æ¡ˆä¸€ï¼šåŸºäºFlavorçš„é…ç½®</strong></p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// lib/config/flavors.dart</span>
<span class="hljs-keyword">enum</span> AppFlavor {
  development,
  staging,
  production,
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AppConfig</span> </span>{
  <span class="hljs-keyword">final</span> AppFlavor flavor;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> appName;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> apiBaseUrl;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">bool</span> enableAnalytics;
  
  AppConfig({
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.flavor,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.appName,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.apiBaseUrl,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.enableAnalytics,
  });
  
  <span class="hljs-comment">// æ ¹æ®Flavoråˆ›å»ºé…ç½®</span>
  <span class="hljs-keyword">factory</span> AppConfig.fromFlavor(AppFlavor flavor) {
    <span class="hljs-keyword">switch</span> (flavor) {
      <span class="hljs-keyword">case</span> AppFlavor.development:
        <span class="hljs-keyword">return</span> AppConfig(
          flavor: flavor,
          appName: <span class="hljs-string">'MyApp Dev'</span>,
          apiBaseUrl: <span class="hljs-string">'https://api.dev.xxxx.com'</span>,
          enableAnalytics: <span class="hljs-keyword">false</span>,
        );
      <span class="hljs-keyword">case</span> AppFlavor.staging:
        <span class="hljs-keyword">return</span> AppConfig(
          flavor: flavor,
          appName: <span class="hljs-string">'MyApp Staging'</span>,
          apiBaseUrl: <span class="hljs-string">'https://api.staging.xxxx.com'</span>,
          enableAnalytics: <span class="hljs-keyword">true</span>,
        );
      <span class="hljs-keyword">case</span> AppFlavor.production:
        <span class="hljs-keyword">return</span> AppConfig(
          flavor: flavor,
          appName: <span class="hljs-string">'MyApp'</span>,
          apiBaseUrl: <span class="hljs-string">'https://api.xxxx.com'</span>,
          enableAnalytics: <span class="hljs-keyword">true</span>,
        );
    }
  }
}
</code></pre>
<p><strong>æ–¹æ¡ˆäºŒï¼šä½¿ç”¨dart-defineä¼ å…¥é…ç½®</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># CIé…ç½®ä¸­ä¼ å…¥ç¯å¢ƒå˜é‡</span>
<span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Build</span> <span class="hljs-string">with</span> <span class="hljs-string">environment</span> <span class="hljs-string">variables</span>
  <span class="hljs-attr">run:</span> <span class="hljs-string">|
    flutter build apk --release \
      --dart-define=APP_FLAVOR=production \
      --dart-define=API_BASE_URL=https://api.xxxx.com \
      --dart-define=ENABLE_ANALYTICS=true
</span></code></pre>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// åœ¨ä»£ç ä¸­è¯»å–ç¯å¢ƒå˜é‡</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EnvConfig</span> </span>{
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-built_in">String</span> flavor = <span class="hljs-built_in">String</span>.fromEnvironment(<span class="hljs-string">'APP_FLAVOR'</span>);
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-built_in">String</span> apiBaseUrl = <span class="hljs-built_in">String</span>.fromEnvironment(<span class="hljs-string">'API_BASE_URL'</span>);
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-built_in">bool</span> enableAnalytics = <span class="hljs-built_in">bool</span>.fromEnvironment(<span class="hljs-string">'ENABLE_ANALYTICS'</span>);
}
</code></pre>
<h4 data-id="heading-24">5.3 ç®¡ç†æ•æ„Ÿä¿¡æ¯</h4>
<p>æ•æ„Ÿä¿¡æ¯ç»ä¸èƒ½å†™åœ¨ä»£ç é‡Œï¼</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># ä½¿ç”¨GitHub Secrets</span>
<span class="hljs-attr">steps:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Use</span> <span class="hljs-string">secrets</span>
    <span class="hljs-attr">env:</span>
      <span class="hljs-comment"># ä»Secretsè¯»å–</span>
      <span class="hljs-attr">API_KEY:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.API_KEY</span> <span class="hljs-string">}}</span>
      <span class="hljs-attr">DATABASE_URL:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.DATABASE_URL</span> <span class="hljs-string">}}</span>
      <span class="hljs-attr">SIGNING_KEY:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.ANDROID_SIGNING_KEY</span> <span class="hljs-string">}}</span>
      
    <span class="hljs-attr">run:</span> <span class="hljs-string">|
      # åœ¨è„šæœ¬ä¸­ä½¿ç”¨
      echo "API Key: $API_KEY"
</span>      
      <span class="hljs-comment"># å†™å…¥åˆ°é…ç½®æ–‡ä»¶</span>
      <span class="hljs-string">echo</span> <span class="hljs-string">"{ \"apiKey\": \"$API_KEY\" }"</span> <span class="hljs-string">&gt;</span> <span class="hljs-string">config.json</span>
</code></pre>
<p><strong>å¦‚ä½•è®¾ç½®Secrets</strong>ï¼š</p>
<ol>
<li>æ‰“å¼€GitHubä»“åº“ â†’ Settings â†’ Secrets and variables â†’ Actions</li>
<li>ç‚¹å‡»"New repository secret"</li>
<li>è¾“å…¥åç§°å’Œå€¼</li>
</ol>
<h4 data-id="heading-25">5.4 é…ç½®æ–‡ä»¶ç®¡ç†</h4>
<p>æ¨èä»¥ä¸‹åˆ†å±‚é…ç½®ç­–ç•¥ï¼š</p>
<pre><code class="hljs language-bash" lang="bash">config/
â”œâ”€â”€ .env.example          <span class="hljs-comment"># ç¤ºä¾‹æ–‡ä»¶ï¼Œä¸å«çœŸå®å€¼</span>
â”œâ”€â”€ .env.development      <span class="hljs-comment"># å¼€å‘ç¯å¢ƒé…ç½®</span>
â”œâ”€â”€ .env.staging          <span class="hljs-comment"># æµ‹è¯•ç¯å¢ƒé…ç½®</span>
â”œâ”€â”€ .env.production       <span class="hljs-comment"># ç”Ÿäº§ç¯å¢ƒé…ç½®</span>
â””â”€â”€ config_loader.dart    <span class="hljs-comment"># é…ç½®åŠ è½½å™¨</span>
</code></pre>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// config/config_loader.dart</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter_dotenv/flutter_dotenv.dart'</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ConfigLoader</span> </span>{
  <span class="hljs-keyword">static</span> Future&lt;<span class="hljs-keyword">void</span>&gt; load(<span class="hljs-built_in">String</span> env) <span class="hljs-keyword">async</span> {
    <span class="hljs-comment">// æ ¹æ®ç¯å¢ƒåŠ è½½å¯¹åº”çš„é…ç½®æ–‡ä»¶</span>
    <span class="hljs-keyword">await</span> dotenv.load(fileName: <span class="hljs-string">'.env.<span class="hljs-subst">$env</span>'</span>);
  }
  
  <span class="hljs-keyword">static</span> <span class="hljs-built_in">String</span> <span class="hljs-keyword">get</span> apiBaseUrl =&gt; dotenv.<span class="hljs-keyword">get</span>(<span class="hljs-string">'API_BASE_URL'</span>);
  <span class="hljs-keyword">static</span> <span class="hljs-built_in">String</span> <span class="hljs-keyword">get</span> apiKey =&gt; dotenv.<span class="hljs-keyword">get</span>(<span class="hljs-string">'API_KEY'</span>);
  <span class="hljs-keyword">static</span> <span class="hljs-built_in">bool</span> <span class="hljs-keyword">get</span> isDebug =&gt; dotenv.<span class="hljs-keyword">get</span>(<span class="hljs-string">'DEBUG'</span>) == <span class="hljs-string">'true'</span>;
}

<span class="hljs-comment">// main.dart</span>
<span class="hljs-keyword">void</span> main() <span class="hljs-keyword">async</span> {
  <span class="hljs-comment">// æ ¹æ®ç¼–è¯‘æ¨¡å¼é€‰æ‹©ç¯å¢ƒ</span>
  <span class="hljs-keyword">const</span> flavor = <span class="hljs-built_in">String</span>.fromEnvironment(<span class="hljs-string">'FLAVOR'</span>, defaultValue: <span class="hljs-string">'development'</span>);
  
  <span class="hljs-keyword">await</span> ConfigLoader.load(flavor);
  
  runApp(MyApp());
}
</code></pre>
<h4 data-id="heading-26">5.5 è®¾è®¡ç¯å¢ƒé…ç½®</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    subgraph &amp;#34;ç¯å¢ƒé…ç½®ç®¡ç†æ¶æ„&amp;#34;
        A[é…ç½®æ¥æº] --&gt; B[ä¼˜å…ˆçº§]
        
        subgraph &amp;#34;B[ä¼˜å…ˆçº§]&amp;#34;
            B1[1. è¿è¡Œæ—¶ç¯å¢ƒå˜é‡] --&gt; B2[æœ€é«˜ä¼˜å…ˆçº§]
            B3[2. é…ç½®æ–‡ä»¶] --&gt; B4[ä¸­ç­‰ä¼˜å…ˆçº§]
            B5[3. é»˜è®¤å€¼] --&gt; B6[æœ€ä½ä¼˜å…ˆçº§]
        end
        
        A --&gt; C[æ•æ„Ÿä¿¡æ¯å¤„ç†]
        
        subgraph &amp;#34;C[æ•æ„Ÿä¿¡æ¯å¤„ç†]&amp;#34;
            C1[å¯†é’¥/å¯†ç ] --&gt; C2[GitHub Secrets]
            C3[APIä»¤ç‰Œ] --&gt; C4[ç¯å¢ƒå˜é‡æ³¨å…¥]
            C5[æ•°æ®åº“è¿æ¥] --&gt; C6[è¿è¡Œæ—¶è·å–]
        end
        
        A --&gt; D[ç¯å¢ƒç±»å‹]
        
        subgraph &amp;#34;D[ç¯å¢ƒç±»å‹]&amp;#34;
            D1[å¼€å‘ç¯å¢ƒ] --&gt; D2[æœ¬åœ°è°ƒè¯•]
            D3[æµ‹è¯•ç¯å¢ƒ] --&gt; D4[CI/CDæµ‹è¯•]
            D5[é¢„å‘ç¯å¢ƒ] --&gt; D6[ç”Ÿäº§å‰éªŒè¯]
            D7[ç”Ÿäº§ç¯å¢ƒ] --&gt; D8[çº¿ä¸Šç”¨æˆ·]
        end
        
        B --&gt; E[é…ç½®åˆå¹¶]
        C --&gt; E
        D --&gt; E
        
        E --&gt; F[æœ€ç»ˆé…ç½®]
        
        F --&gt; G[åº”ç”¨å¯åŠ¨]
        F --&gt; H[APIè°ƒç”¨]
        F --&gt; I[åŠŸèƒ½å¼€å…³]
    end
    
    subgraph &amp;#34;å®‰å…¨å®è·µ&amp;#34;
        J[æ°¸è¿œä¸è¦æäº¤] --&gt; K[.envæ–‡ä»¶åˆ°Git]
        L[ä½¿ç”¨.gitignore] --&gt; M[å¿½ç•¥æ•æ„Ÿæ–‡ä»¶]
        N[å®šæœŸè½®æ¢] --&gt; O[å¯†é’¥å’Œä»¤ç‰Œ]
        P[æœ€å°æƒé™åŸåˆ™] --&gt; Q[ä»…æˆäºˆå¿…è¦æƒé™]
    end
    
    style A fill:#e3f2fd
    style C fill:#f3e5f5
    style D fill:#e8f5e8
    style J fill:#fff3e0
</code></pre>
<h3 data-id="heading-27">å…­ï¼šå¸¸è§CI/CDæŠ€å·§</h3>
<h4 data-id="heading-28">6.1 ä½¿ç”¨ç¼“å­˜åŠ é€Ÿæ„å»º</h4>
<p>Flutteré¡¹ç›®ä¾èµ–ä¸‹è½½å¾ˆæ…¢ï¼Œä½¿ç”¨ç¼“å­˜å¯ä»¥å¤§å¹…æé€Ÿï¼š</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">jobs:</span>
  <span class="hljs-attr">build:</span>
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>
    
    <span class="hljs-attr">steps:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Checkout</span> <span class="hljs-string">code</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v3</span>
        
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Cache</span> <span class="hljs-string">Flutter</span> <span class="hljs-string">dependencies</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/cache@v3</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">path:</span> <span class="hljs-string">|
            /opt/hostedtoolcache/flutter
            ${{ github.workspace }}/.pub-cache
            ${{ github.workspace }}/build
</span>          <span class="hljs-attr">key:</span> <span class="hljs-string">${{</span> <span class="hljs-string">runner.os</span> <span class="hljs-string">}}-flutter-${{</span> <span class="hljs-string">hashFiles('pubspec.lock')</span> <span class="hljs-string">}}</span>
          <span class="hljs-attr">restore-keys:</span> <span class="hljs-string">|
            ${{ runner.os }}-flutter-
</span>            
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Cache</span> <span class="hljs-string">Android</span> <span class="hljs-string">dependencies</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/cache@v3</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">path:</span> <span class="hljs-string">|
            ~/.gradle/caches
            ~/.gradle/wrapper
</span>          <span class="hljs-attr">key:</span> <span class="hljs-string">${{</span> <span class="hljs-string">runner.os</span> <span class="hljs-string">}}-gradle-${{</span> <span class="hljs-string">hashFiles('**/*.gradle*',</span> <span class="hljs-string">'**/gradle-wrapper.properties'</span><span class="hljs-string">)</span> <span class="hljs-string">}}</span>
          <span class="hljs-attr">restore-keys:</span> <span class="hljs-string">|
            ${{ runner.os }}-gradle-
</span></code></pre>
<h4 data-id="heading-29">6.2 æ„å»ºç­–ç•¥</h4>
<p>åŒæ—¶æµ‹è¯•å¤šä¸ªé…ç½®ç»„åˆï¼š</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">jobs:</span>
  <span class="hljs-attr">test:</span>
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">${{</span> <span class="hljs-string">matrix.os</span> <span class="hljs-string">}}</span>
    
    <span class="hljs-attr">strategy:</span>
      <span class="hljs-attr">matrix:</span>
        <span class="hljs-comment"># å®šä¹‰</span>
        <span class="hljs-attr">os:</span> [<span class="hljs-string">ubuntu-latest</span>, <span class="hljs-string">macos-latest</span>]
        <span class="hljs-attr">flutter-version:</span> [<span class="hljs-string">'3.7.x'</span>, <span class="hljs-string">'3.10.x'</span>]
    
        <span class="hljs-attr">exclude:</span>
          <span class="hljs-bullet">-</span> <span class="hljs-attr">os:</span> <span class="hljs-string">macos-latest</span>
            <span class="hljs-attr">flutter-version:</span> <span class="hljs-string">'3.7.x'</span>
        <span class="hljs-comment"># åŒ…å«ç‰¹å®šç»„åˆ</span>
        <span class="hljs-attr">include:</span>
          <span class="hljs-bullet">-</span> <span class="hljs-attr">os:</span> <span class="hljs-string">windows-latest</span>
            <span class="hljs-attr">flutter-version:</span> <span class="hljs-string">'3.10.x'</span>
            <span class="hljs-attr">channel:</span> <span class="hljs-string">'beta'</span>
            
    <span class="hljs-attr">steps:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Test</span> <span class="hljs-string">on</span> <span class="hljs-string">${{</span> <span class="hljs-string">matrix.os</span> <span class="hljs-string">}}</span> <span class="hljs-string">with</span> <span class="hljs-string">Flutter</span> <span class="hljs-string">${{</span> <span class="hljs-string">matrix.flutter-version</span> <span class="hljs-string">}}</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">echo</span> <span class="hljs-string">"Running tests..."</span>
</code></pre>
<h4 data-id="heading-30">6.3 æ¡ä»¶æ‰§è¡Œä¸å·¥ä½œæµæ§åˆ¶</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">jobs:</span>
  <span class="hljs-attr">deploy:</span>
    <span class="hljs-comment"># åªæœ‰ç‰¹å®šåˆ†æ”¯æ‰æ‰§è¡Œ</span>
    <span class="hljs-attr">if:</span> <span class="hljs-string">github.ref</span> <span class="hljs-string">==</span> <span class="hljs-string">'refs/heads/main'</span>
    
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>
    
    <span class="hljs-attr">steps:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Check</span> <span class="hljs-string">changed</span> <span class="hljs-string">files</span>
        <span class="hljs-comment"># åªæœ‰ç‰¹å®šæ–‡ä»¶æ”¹åŠ¨æ‰æ‰§è¡Œ</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">dorny/paths-filter@v2</span>
        <span class="hljs-attr">id:</span> <span class="hljs-string">changes</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">filters:</span> <span class="hljs-string">|
            src:
              - 'src/**'
            configs:
              - 'config/**'
              
</span>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Run</span> <span class="hljs-string">if</span> <span class="hljs-string">src</span> <span class="hljs-string">changed</span>
        <span class="hljs-attr">if:</span> <span class="hljs-string">steps.changes.outputs.src</span> <span class="hljs-string">==</span> <span class="hljs-string">'true'</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">echo</span> <span class="hljs-string">"Source code changed"</span>
        
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Skip</span> <span class="hljs-string">if</span> <span class="hljs-string">only</span> <span class="hljs-string">docs</span> <span class="hljs-string">changed</span>
        <span class="hljs-attr">if:</span> <span class="hljs-string">github.event_name</span> <span class="hljs-string">==</span> <span class="hljs-string">'pull_request'</span> <span class="hljs-string">&amp;&amp;</span> <span class="hljs-string">contains(github.event.pull_request.title,</span> <span class="hljs-string">'[skip-ci]'</span><span class="hljs-string">)</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          echo "Skipping CI due to [skip-ci] in PR title"
          exit 0
</span></code></pre>
<h4 data-id="heading-31">6.4 è‡ªå®šä¹‰Actions</h4>
<p>å½“é€šç”¨Actionsä¸å¤Ÿç”¨æ—¶ï¼Œå¯ä»¥è‡ªå®šä¹‰ï¼š</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># .github/actions/flutter-setup/action.yml</span>
<span class="hljs-attr">name:</span> <span class="hljs-string">'Flutter Setup with Custom Options'</span>
<span class="hljs-attr">description:</span> <span class="hljs-string">'Setup Flutter environment with custom configurations'</span>

<span class="hljs-attr">inputs:</span>
  <span class="hljs-attr">flutter-version:</span>
    <span class="hljs-attr">description:</span> <span class="hljs-string">'Flutter version'</span>
    <span class="hljs-attr">required:</span> <span class="hljs-literal">true</span>
    <span class="hljs-attr">default:</span> <span class="hljs-string">'stable'</span>
  <span class="hljs-attr">channel:</span>
    <span class="hljs-attr">description:</span> <span class="hljs-string">'Flutter channel'</span>
    <span class="hljs-attr">required:</span> <span class="hljs-literal">false</span>
    <span class="hljs-attr">default:</span> <span class="hljs-string">'stable'</span>
  <span class="hljs-attr">enable-web:</span>
    <span class="hljs-attr">description:</span> <span class="hljs-string">'Enable web support'</span>
    <span class="hljs-attr">required:</span> <span class="hljs-literal">false</span>
    <span class="hljs-attr">default:</span> <span class="hljs-string">'false'</span>

<span class="hljs-attr">runs:</span>
  <span class="hljs-attr">using:</span> <span class="hljs-string">"composite"</span>
  <span class="hljs-attr">steps:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Setup</span> <span class="hljs-string">Flutter</span>
      <span class="hljs-attr">uses:</span> <span class="hljs-string">subosito/flutter-action@v2</span>
      <span class="hljs-attr">with:</span>
        <span class="hljs-attr">flutter-version:</span> <span class="hljs-string">${{</span> <span class="hljs-string">inputs.flutter-version</span> <span class="hljs-string">}}</span>
        <span class="hljs-attr">channel:</span> <span class="hljs-string">${{</span> <span class="hljs-string">inputs.channel</span> <span class="hljs-string">}}</span>
        
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Enable</span> <span class="hljs-string">web</span> <span class="hljs-string">if</span> <span class="hljs-string">needed</span>
      <span class="hljs-attr">if:</span> <span class="hljs-string">${{</span> <span class="hljs-string">inputs.enable-web</span> <span class="hljs-string">==</span> <span class="hljs-string">'true'</span> <span class="hljs-string">}}</span>
      <span class="hljs-attr">shell:</span> <span class="hljs-string">bash</span>
      <span class="hljs-attr">run:</span> <span class="hljs-string">flutter</span> <span class="hljs-string">config</span> <span class="hljs-string">--enable-web</span>
      
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Install</span> <span class="hljs-string">licenses</span>
      <span class="hljs-attr">shell:</span> <span class="hljs-string">bash</span>
      <span class="hljs-attr">run:</span> <span class="hljs-string">flutter</span> <span class="hljs-string">doctor</span> <span class="hljs-string">--android-licenses</span>
</code></pre>
<h3 data-id="heading-32">ä¸ƒï¼šä¸ºç°æœ‰é¡¹ç›®æ·»åŠ CI/CD</h3>
<h4 data-id="heading-33">7.1 åˆ†æç°æœ‰é¡¹ç›®</h4>
<p>å¦‚æœæˆ‘ä»¬æœ‰ä¸€ä¸ªç°æˆçš„Flutteråº”ç”¨ï¼Œéœ€è¦æ·»åŠ CI/CDï¼š</p>
<pre><code class="hljs language-bash" lang="bash">é¡¹ç›®ç»“æ„ï¼š
my_flutter_app/
â”œâ”€â”€ lib/
â”œâ”€â”€ <span class="hljs-built_in">test</span>/
â”œâ”€â”€ android/
â”œâ”€â”€ ios/
â””â”€â”€ pubspec.yaml
</code></pre>
<p><strong>å½“å‰é—®é¢˜</strong>ï¼š</p>
<ol>
<li>æ‰‹åŠ¨æµ‹è¯•ï¼Œç»å¸¸æ¼æµ‹</li>
<li>æ‰“åŒ…éœ€è¦20åˆ†é’Ÿï¼Œä¸”å®¹æ˜“å‡ºé”™</li>
<li>ä¸åŒå¼€å‘è€…ç¯å¢ƒä¸ä¸€è‡´</li>
<li>å‘å¸ƒæµç¨‹ç¹ç</li>
</ol>
<h4 data-id="heading-34">7.2 åˆ†é˜¶æ®µå®æ–½è‡ªåŠ¨åŒ–</h4>
<p><strong>ç¬¬ä¸€é˜¶æ®µï¼šå®ç°åŸºç¡€CI</strong></p>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" checked="checked" disabled="disabled"/> æ·»åŠ åŸºç¡€æµ‹è¯•æµæ°´çº¿</li>
<li class="task-list-item"><input type="checkbox" checked="checked" disabled="disabled"/> ä»£ç è´¨é‡æ£€æŸ¥</li>
<li class="task-list-item"><input type="checkbox" checked="checked" disabled="disabled"/> é…ç½®GitHub Actions</li>
</ul>
<p><strong>ç¬¬äºŒé˜¶æ®µï¼šè‡ªåŠ¨åŒ–æ„å»º</strong></p>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> Androidè‡ªåŠ¨æ‰“åŒ…</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> iOSè‡ªåŠ¨æ‰“åŒ…</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> å¤šç¯å¢ƒé…ç½®</li>
</ul>
<p><strong>ç¬¬ä¸‰é˜¶æ®µï¼šè‡ªåŠ¨åŒ–å‘å¸ƒ</strong></p>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> æµ‹è¯•ç¯å¢ƒè‡ªåŠ¨åˆ†å‘</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> ç”Ÿäº§ç¯å¢ƒè‡ªåŠ¨å‘å¸ƒ</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> ç›‘æ§ä¸å‘Šè­¦</li>
</ul>
<h4 data-id="heading-35">7.3 é…ç½®æ–‡ä»¶</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># .github/workflows/ecommerce-ci.yml</span>
<span class="hljs-attr">name:</span> <span class="hljs-string">E-commerce</span> <span class="hljs-string">App</span> <span class="hljs-string">CI/CD</span>

<span class="hljs-attr">on:</span>
  <span class="hljs-attr">push:</span>
    <span class="hljs-attr">branches:</span> [<span class="hljs-string">develop</span>]
  <span class="hljs-attr">pull_request:</span>
    <span class="hljs-attr">branches:</span> [<span class="hljs-string">main</span>, <span class="hljs-string">develop</span>]
  <span class="hljs-attr">schedule:</span>
    <span class="hljs-comment"># æ¯å¤©å‡Œæ™¨2ç‚¹è·‘ä¸€éæµ‹è¯•</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">cron:</span> <span class="hljs-string">'0 2 * * *'</span>

<span class="hljs-attr">jobs:</span>
  <span class="hljs-comment"># ä»£ç è´¨é‡</span>
  <span class="hljs-attr">quality-gate:</span>
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>
    
    <span class="hljs-attr">outputs:</span>
      <span class="hljs-attr">passed:</span> <span class="hljs-string">${{</span> <span class="hljs-string">steps.quality-check.outputs.passed</span> <span class="hljs-string">}}</span>
    
    <span class="hljs-attr">steps:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v3</span>
      
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Quality</span> <span class="hljs-string">Check</span>
        <span class="hljs-attr">id:</span> <span class="hljs-string">quality-check</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          # ä»£ç è§„èŒƒæ£€æŸ¥
          flutter analyze . || echo "::warning::Code analysis failed"
</span>          
          <span class="hljs-comment"># æ£€æŸ¥æµ‹è¯•è¦†ç›–ç‡</span>
          <span class="hljs-string">flutter</span> <span class="hljs-string">test</span> <span class="hljs-string">--coverage</span>
          <span class="hljs-string">PERCENTAGE=$(lcov</span> <span class="hljs-string">--summary</span> <span class="hljs-string">coverage/lcov.info</span> <span class="hljs-string">|</span> <span class="hljs-string">grep</span> <span class="hljs-string">lines</span> <span class="hljs-string">|</span> <span class="hljs-string">awk</span> <span class="hljs-string">'{print $4}'</span> <span class="hljs-string">|</span> <span class="hljs-string">sed</span> <span class="hljs-string">'s/%//'</span><span class="hljs-string">)</span>
          <span class="hljs-string">if</span> <span class="hljs-string">((</span> <span class="hljs-string">$(echo</span> <span class="hljs-string">"$PERCENTAGE &lt; 80"</span> <span class="hljs-string">|</span> <span class="hljs-string">bc</span> <span class="hljs-string">-l)</span> <span class="hljs-string">));</span> <span class="hljs-string">then</span>
            <span class="hljs-string">echo</span> <span class="hljs-string">"::error::Test coverage $PERCENTAGE% is below 80% threshold"</span>
            <span class="hljs-string">echo</span> <span class="hljs-string">"passed=false"</span> <span class="hljs-string">&gt;&gt;</span> <span class="hljs-string">$GITHUB_OUTPUT</span>
          <span class="hljs-string">else</span>
            <span class="hljs-string">echo</span> <span class="hljs-string">"passed=true"</span> <span class="hljs-string">&gt;&gt;</span> <span class="hljs-string">$GITHUB_OUTPUT</span>
          <span class="hljs-string">fi</span>
          
  <span class="hljs-comment"># é›†æˆæµ‹è¯•</span>
  <span class="hljs-attr">integration-test:</span>
    <span class="hljs-attr">needs:</span> <span class="hljs-string">quality-gate</span>
    <span class="hljs-attr">if:</span> <span class="hljs-string">needs.quality-gate.outputs.passed</span> <span class="hljs-string">==</span> <span class="hljs-string">'true'</span>
    
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">macos-latest</span>
    
    <span class="hljs-attr">services:</span>
      <span class="hljs-comment"># å¯åŠ¨æµ‹è¯•æ•°æ®åº“</span>
      <span class="hljs-attr">postgres:</span>
        <span class="hljs-attr">image:</span> <span class="hljs-string">postgres:14</span>
        <span class="hljs-attr">env:</span>
          <span class="hljs-attr">POSTGRES_PASSWORD:</span> <span class="hljs-string">postgres</span>
        <span class="hljs-attr">options:</span> <span class="hljs-string">&gt;-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
</span>          
    <span class="hljs-attr">steps:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v3</span>
      
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Setup</span> <span class="hljs-string">Flutter</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">subosito/flutter-action@v2</span>
        
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Run</span> <span class="hljs-string">integration</span> <span class="hljs-string">tests</span> <span class="hljs-string">with</span> <span class="hljs-string">database</span>
        <span class="hljs-attr">env:</span>
          <span class="hljs-attr">DATABASE_URL:</span> <span class="hljs-string">postgres://postgres:postgres@postgres:5432/test_db</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          flutter test integration_test/ --dart-define=DATABASE_URL=$DATABASE_URL
</span>          
  <span class="hljs-comment"># æ€§èƒ½æµ‹è¯•</span>
  <span class="hljs-attr">performance-test:</span>
    <span class="hljs-attr">needs:</span> <span class="hljs-string">integration-test</span>
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>
    
    <span class="hljs-attr">steps:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v3</span>
      
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Run</span> <span class="hljs-string">performance</span> <span class="hljs-string">benchmarks</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          # è¿è¡Œæ€§èƒ½æµ‹è¯•
          flutter drive --target=test_driver/app_perf.dart
</span>          
          <span class="hljs-comment"># åˆ†ææ€§èƒ½æ•°æ®</span>
          <span class="hljs-string">dart</span> <span class="hljs-string">analyze_performance.dart</span> <span class="hljs-string">perf_data.json</span>
          
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Upload</span> <span class="hljs-string">performance</span> <span class="hljs-string">report</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/upload-artifact@v3</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">name:</span> <span class="hljs-string">performance-report</span>
          <span class="hljs-attr">path:</span> <span class="hljs-string">perf_report.json</span>
          
  <span class="hljs-comment"># å®‰å…¨æ‰«æ</span>
  <span class="hljs-attr">security-scan:</span>
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>
    
    <span class="hljs-attr">steps:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v3</span>
      
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Run</span> <span class="hljs-string">security</span> <span class="hljs-string">scan</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">snyk/actions/dart@master</span>
        <span class="hljs-attr">env:</span>
          <span class="hljs-attr">SNYK_TOKEN:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.SNYK_TOKEN</span> <span class="hljs-string">}}</span>
          
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Check</span> <span class="hljs-string">for</span> <span class="hljs-string">secrets</span> <span class="hljs-string">in</span> <span class="hljs-string">code</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">trufflesecurity/trufflehog@main</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">path:</span> <span class="hljs-string">./</span>
          
  <span class="hljs-comment"># æŠ¥å‘Š</span>
  <span class="hljs-attr">report:</span>
    <span class="hljs-attr">needs:</span> [<span class="hljs-string">quality-gate</span>, <span class="hljs-string">integration-test</span>, <span class="hljs-string">performance-test</span>, <span class="hljs-string">security-scan</span>]
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>
    
    <span class="hljs-attr">if:</span> <span class="hljs-string">always()</span>
    
    <span class="hljs-attr">steps:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Generate</span> <span class="hljs-string">CI/CD</span> <span class="hljs-string">Report</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          echo "# CI/CD Run Report" &gt; report.md
          echo "## Run: ${{ github.run_id }}" &gt;&gt; report.md
          echo "## Status: ${{ job.status }}" &gt;&gt; report.md
          echo "## Jobs:" &gt;&gt; report.md
          echo "- Quality Gate: ${{ needs.quality-gate.result }}" &gt;&gt; report.md
          echo "- Integration Test: ${{ needs.integration-test.result }}" &gt;&gt; report.md
          echo "- Performance Test: ${{ needs.performance-test.result }}" &gt;&gt; report.md
          echo "- Security Scan: ${{ needs.security-scan.result }}" &gt;&gt; report.md
</span>          
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Upload</span> <span class="hljs-string">report</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/upload-artifact@v3</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">name:</span> <span class="hljs-string">ci-cd-report</span>
          <span class="hljs-attr">path:</span> <span class="hljs-string">report.md</span>
</code></pre>
<h4 data-id="heading-36">7.4 æµç¨‹ä¼˜åŒ–</h4>
<p>CI/CDä¸æ˜¯ä¸€æ¬¡æ€§çš„ï¼Œéœ€è¦æŒç»­ä¼˜åŒ–ï¼š</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># ç›‘æ§CI/CDæ€§èƒ½</span>
<span class="hljs-attr">name:</span> <span class="hljs-string">CI/CD</span> <span class="hljs-string">Performance</span> <span class="hljs-string">Monitoring</span>

<span class="hljs-attr">on:</span>
  <span class="hljs-attr">workflow_run:</span>
    <span class="hljs-attr">workflows:</span> [<span class="hljs-string">"E-commerce App CI/CD"</span>]
    <span class="hljs-attr">types:</span> [<span class="hljs-string">completed</span>]

<span class="hljs-attr">jobs:</span>
  <span class="hljs-attr">analyze-performance:</span>
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>
    
    <span class="hljs-attr">steps:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Download</span> <span class="hljs-string">workflow</span> <span class="hljs-string">artifacts</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/github-script@v6</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">script:</span> <span class="hljs-string">|
            const { data: artifacts } = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.payload.workflow_run.id,
            });
</span>            
            <span class="hljs-string">//</span> <span class="hljs-string">åˆ†ææ‰§è¡Œæ—¶é—´</span>
            <span class="hljs-string">const</span> <span class="hljs-string">runDuration</span> <span class="hljs-string">=</span> <span class="hljs-string">new</span> <span class="hljs-string">Date(context.payload.workflow_run.updated_at)</span> <span class="hljs-bullet">-</span> 
                               <span class="hljs-string">new</span> <span class="hljs-string">Date(context.payload.workflow_run.run_started_at);</span>
            
            <span class="hljs-string">console.log(`Workflow</span> <span class="hljs-string">took</span> <span class="hljs-string">${runDuration</span> <span class="hljs-string">/</span> <span class="hljs-number">1000</span><span class="hljs-string">}</span> <span class="hljs-string">seconds`);</span>
            
            <span class="hljs-string">//</span> <span class="hljs-string">å‘é€åˆ°ç›‘æ§ç³»ç»Ÿ</span>
            <span class="hljs-string">//</span> <span class="hljs-string">...</span>
            
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Send</span> <span class="hljs-string">to</span> <span class="hljs-string">monitoring</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          # å‘é€æŒ‡æ ‡åˆ°Prometheus/Grafana
          echo "ci_duration_seconds $DURATION" | \
            curl -X POST -H "Content-Type: text/plain" \
            --data-binary @- http://monitoring.xxxx.com/metrics
</span></code></pre>
<h3 data-id="heading-37">å…«ï¼šå¸¸è§é—®é¢˜</h3>
<h4 data-id="heading-38">8.1 GitHub Actionså¸¸è§é—®é¢˜</h4>
<p><strong>Qï¼šå·¥ä½œæµè¿è¡Œå¤ªæ…¢æ€ä¹ˆåŠï¼Ÿ</strong></p>
<p>Aï¼šä¼˜åŒ–æ‰‹æ®µï¼š</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 1. ä½¿ç”¨ç¼“å­˜</span>
<span class="hljs-bullet">-</span> <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/cache@v3</span>
  <span class="hljs-attr">with:</span>
    <span class="hljs-attr">path:</span> <span class="hljs-string">~/.pub-cache</span>
    <span class="hljs-attr">key:</span> <span class="hljs-string">${{</span> <span class="hljs-string">runner.os</span> <span class="hljs-string">}}-pub-${{</span> <span class="hljs-string">hashFiles('pubspec.lock')</span> <span class="hljs-string">}}</span>

<span class="hljs-comment"># 2. å¹¶è¡Œæ‰§è¡Œç‹¬ç«‹ä»»åŠ¡</span>
<span class="hljs-attr">jobs:</span>
  <span class="hljs-attr">test-android:</span>
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>
  <span class="hljs-attr">test-ios:</span>
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">macos-latest</span>
  <span class="hljs-comment"># ä¸¤ä¸ªä»»åŠ¡ä¼šå¹¶è¡Œæ‰§è¡Œ</span>

<span class="hljs-comment"># 3. é¡¹ç›®å¤§å¯ä»¥è€ƒè™‘ä½¿ç”¨è‡ªæ‰˜ç®¡Runner</span>
<span class="hljs-attr">runs-on:</span> [<span class="hljs-string">self-hosted</span>, <span class="hljs-string">linux</span>, <span class="hljs-string">x64</span>]
</code></pre>
<p><strong>Qï¼šiOSæ„å»ºå¤±è´¥ï¼Œè¯ä¹¦é—®é¢˜ï¼Ÿ</strong></p>
<p>Aï¼šiOSè¯ä¹¦é…ç½®æµç¨‹ï¼š</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. å¯¼å‡ºå¼€å‘è¯ä¹¦</span>
openssl pkcs12 -<span class="hljs-keyword">in</span> certificate.p12 -out certificate.pem -nodes

<span class="hljs-comment"># 2. åœ¨GitHub Secretsä¸­å­˜å‚¨</span>
<span class="hljs-comment"># ä½¿ç”¨base64ç¼–ç </span>
<span class="hljs-built_in">base64</span> -i certificate.p12 &gt; certificate.txt

<span class="hljs-comment"># 3. åœ¨CIä¸­è¿˜åŸ</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">${{ secrets.IOS_CERTIFICATE }</span>}"</span> | <span class="hljs-built_in">base64</span> --decode &gt; certificate.p12
security import certificate.p12 -k build.keychain -P <span class="hljs-string">"<span class="hljs-variable">${{ secrets.CERT_PASSWORD }</span>}"</span>
</code></pre>
<p><strong>Qï¼šå¦‚ä½•è°ƒè¯•å¤±è´¥çš„CIï¼Ÿ</strong></p>
<p>Aï¼šè°ƒè¯•æŠ€å·§ï¼š</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 1. å¯ç”¨è°ƒè¯•æ—¥å¿—</span>
<span class="hljs-attr">run:</span> <span class="hljs-string">|
  # æ˜¾ç¤ºè¯¦ç»†æ—¥å¿—
  flutter build apk --verbose
</span>  
  <span class="hljs-comment"># æˆ–ä½¿ç”¨ç¯å¢ƒå˜é‡</span>
  <span class="hljs-attr">env:</span>
    <span class="hljs-attr">FLUTTER_VERBOSE:</span> <span class="hljs-literal">true</span>

<span class="hljs-comment"># 2. ä¸Šä¼ æ„å»ºæ—¥å¿—</span>
<span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Upload</span> <span class="hljs-string">build</span> <span class="hljs-string">logs</span>
  <span class="hljs-attr">if:</span> <span class="hljs-string">failure()</span>
  <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/upload-artifact@v3</span>
  <span class="hljs-attr">with:</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">build-logs</span>
    <span class="hljs-attr">path:</span> <span class="hljs-string">|
      ~/flutter/bin/cache/
      build/
</span>      
<span class="hljs-comment"># 3. ä½¿ç”¨tmateè¿›è¡ŒSSHè°ƒè¯•</span>
<span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Setup</span> <span class="hljs-string">tmate</span> <span class="hljs-string">session</span>
  <span class="hljs-attr">uses:</span> <span class="hljs-string">mxschmitt/action-tmate@v3</span>
  <span class="hljs-attr">if:</span> <span class="hljs-string">failure()</span> <span class="hljs-string">&amp;&amp;</span> <span class="hljs-string">github.ref</span> <span class="hljs-string">==</span> <span class="hljs-string">'refs/heads/main'</span>
</code></pre>
<h4 data-id="heading-39">8.2 Flutteré—®é¢˜</h4>
<p><strong>Qï¼šä¸åŒç‰ˆæœ¬å…¼å®¹æ€§ï¼Ÿ</strong></p>
<p>Aï¼šç‰ˆæœ¬ç®¡ç†ç­–ç•¥ï¼š</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># ä½¿ç”¨ç‰ˆæœ¬æµ‹è¯•å…¼å®¹æ€§</span>
<span class="hljs-attr">strategy:</span>
  <span class="hljs-attr">matrix:</span>
    <span class="hljs-attr">flutter-version:</span> [<span class="hljs-string">'3.7.x'</span>, <span class="hljs-string">'3.10.x'</span>, <span class="hljs-string">'stable'</span>]
    
<span class="hljs-comment"># åœ¨ä»£ç ä¸­æ£€æŸ¥ç‰ˆæœ¬</span>
<span class="hljs-string">void</span> <span class="hljs-string">checkFlutterVersion()</span> {
  <span class="hljs-string">const</span> <span class="hljs-string">minVersion</span> <span class="hljs-string">=</span> <span class="hljs-string">'3.7.0'</span><span class="hljs-string">;</span>
  <span class="hljs-string">final</span> <span class="hljs-string">currentVersion</span> <span class="hljs-string">=</span> <span class="hljs-string">FlutterVersion.instance.version;</span>
  
  <span class="hljs-string">if</span> <span class="hljs-string">(Version.parse(currentVersion)</span> <span class="hljs-string">&lt;</span> <span class="hljs-string">Version.parse(minVersion))</span> {
    <span class="hljs-string">throw</span> <span class="hljs-string">Exception('Flutter</span> <span class="hljs-string">version</span> <span class="hljs-string">$minVersion</span> <span class="hljs-string">or</span> <span class="hljs-string">higher</span> <span class="hljs-string">required');</span>
  }
}
</code></pre>
<p><strong>Qï¼šWebæ„å»ºå¤±è´¥ï¼Ÿ</strong></p>
<p>Aï¼šWebæ„å»ºé…ç½®ï¼š</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># ç¡®ä¿å¯ç”¨Webæ”¯æŒ</span>
<span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Enable</span> <span class="hljs-string">web</span>
  <span class="hljs-attr">run:</span> <span class="hljs-string">flutter</span> <span class="hljs-string">config</span> <span class="hljs-string">--enable-web</span>

<span class="hljs-comment"># æ„å»ºWebç‰ˆæœ¬</span>
<span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Build</span> <span class="hljs-string">for</span> <span class="hljs-string">web</span>
  <span class="hljs-attr">run:</span> <span class="hljs-string">|
    flutter build web \
      --web-renderer canvaskit \
      --release \
      --dart-define=FLUTTER_WEB_USE_SKIA=true
      
</span><span class="hljs-comment"># å¤„ç†Webç‰¹å®šé—®é¢˜</span>
<span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Fix</span> <span class="hljs-string">web</span> <span class="hljs-string">issues</span>
  <span class="hljs-attr">run:</span> <span class="hljs-string">|
    # æ¸…ç†ç¼“å­˜
    flutter clean
</span>    
    <span class="hljs-comment"># æ›´æ–°Webå¼•æ“</span>
    <span class="hljs-string">flutter</span> <span class="hljs-string">precache</span> <span class="hljs-string">--web</span>
</code></pre>
<h4 data-id="heading-40">8.3 å®‰å…¨ä¸æƒé™é—®é¢˜</h4>
<p><strong>Qï¼šå¦‚ä½•ç®¡ç†æ•æ„Ÿä¿¡æ¯ï¼Ÿ</strong></p>
<p>Aï¼šå®‰å…¨å®è·µï¼š</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 1. ä½¿ç”¨ç¯å¢ƒçº§åˆ«çš„Secrets</span>
<span class="hljs-attr">env:</span>
  <span class="hljs-attr">SUPER_SECRET_KEY:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.PRODUCTION_KEY</span> <span class="hljs-string">}}</span>

<span class="hljs-comment"># 2. æœ€å°æƒé™åŸåˆ™</span>
<span class="hljs-attr">permissions:</span>
  <span class="hljs-attr">contents:</span> <span class="hljs-string">read</span>
  <span class="hljs-attr">packages:</span> <span class="hljs-string">write</span>  <span class="hljs-comment"># åªæœ‰éœ€è¦æ—¶æ‰å†™</span>
  
<span class="hljs-comment"># 3. ä½¿ç”¨ä¸´æ—¶å‡­è¯</span>
<span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Configure</span> <span class="hljs-string">AWS</span> <span class="hljs-string">credentials</span>
  <span class="hljs-attr">uses:</span> <span class="hljs-string">aws-actions/configure-aws-credentials@v1</span>
  <span class="hljs-attr">with:</span>
    <span class="hljs-attr">aws-access-key-id:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.AWS_ACCESS_KEY_ID</span> <span class="hljs-string">}}</span>
    <span class="hljs-attr">aws-secret-access-key:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.AWS_SECRET_ACCESS_KEY</span> <span class="hljs-string">}}</span>
    <span class="hljs-attr">aws-region:</span> <span class="hljs-string">us-east-1</span>
    
<span class="hljs-comment"># 4. å®šæœŸè½®æ¢å¯†é’¥</span>
<span class="hljs-comment"># è®¾ç½®æé†’æ¯æœˆæ›´æ–°ä¸€æ¬¡Secrets</span>
</code></pre>
<h3 data-id="heading-41">æœ€å</h3>
<p>é€šè¿‡è¿™ç¯‡æ•™ç¨‹æˆ‘ä»¬æŒæ¡äº†Flutter CI/CDçš„æ ¸å¿ƒçŸ¥è¯†ï¼Œä¸€ä¸ªå®Œç¾çš„æµæ°´çº¿æ˜¯ä¸€æ¬¡æ¬¡è¿­ä»£å‡ºæ¥çš„ï¼Œéœ€è¦ä¸æ–­ä¼˜åŒ–ã€‚<strong>å¦‚æœè§‰å¾—æ–‡ç« å¯¹ä½ æœ‰å¸®åŠ©ï¼Œåˆ«å¿˜äº†ä¸€é”®ä¸‰è¿ï¼Œæ”¯æŒä¸€ä¸‹</strong></p>
<hr/>
<p><strong>æœ‰ä»»ä½•é—®é¢˜æˆ–æƒ³æ³•ï¼Œæ¬¢è¿åœ¨è¯„è®ºåŒºäº¤æµè®¨è®ºã€‚</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[ã€Geminiç®€ç›´æ— æ•Œäº†ã€‘æŒé—´æ˜Ÿæ²³ï¼šé€šè¿‡MediaPipeå®ç°æ‰‹åŠ¿æ§åˆ¶ç²’å­]]></title>    <link>https://juejin.cn/post/7585463258690863113</link>    <guid>https://juejin.cn/post/7585463258690863113</guid>    <pubDate>2025-12-20T09:15:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585463258690863113" data-draft-id="7585706951583416329" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="ã€Geminiç®€ç›´æ— æ•Œäº†ã€‘æŒé—´æ˜Ÿæ²³ï¼šé€šè¿‡MediaPipeå®ç°æ‰‹åŠ¿æ§åˆ¶ç²’å­"/> <meta itemprop="keywords" content="Gemini,React.js"/> <meta itemprop="datePublished" content="2025-12-20T09:15:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="å°é±¼å°é±¼å¹²"/> <meta itemprop="url" content="https://juejin.cn/user/2162083945256777"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="æ˜é‡‘"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ã€Geminiç®€ç›´æ— æ•Œäº†ã€‘æŒé—´æ˜Ÿæ²³ï¼šé€šè¿‡MediaPipeå®ç°æ‰‹åŠ¿æ§åˆ¶ç²’å­
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2162083945256777/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    å°é±¼å°é±¼å¹²
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T09:15:45.000Z" title="Sat Dec 20 2025 09:15:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    é˜…è¯»3åˆ†é’Ÿ
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>å—æ˜é‡‘å¤§ä½¬â€œä¸å¦‚æ‘¸é±¼å»â€çš„å¯å‘ï¼Œæˆ‘ä¹Ÿè¯•è¯• Gemini 3åšä¸€ä¸‹æ‰‹åŠ¿+ç²’å­äº¤äº’ï¼Œ ç¡®å®å­¦åˆ°äº†ä¸å°‘ä¸œè¥¿ï¼Œåœ¨è¿™é‡Œç®€å•çš„åˆ†äº«ä¸‹ã€‚
githubåœ°å€ï¼šæŒé—´æ˜Ÿæ²³ï¼š<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fhuijieya%2FGesture-Galaxy.git" target="_blank" title="https://github.com/huijieya/Gesture-Galaxy.git" ref="nofollow noopener noreferrer">github.com/huijieya/Geâ€¦</a></p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/25f905388d114ac69818a85dd2cf3cf5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP6bG85bCP6bG85bmy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766826945&amp;x-signature=lrD0UZyeu9uscVe8UxT8t66b%2FIE%3D" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" loading="lazy"/></p>
<pre><code class="hljs language-javascript" lang="javascript">åŸºäºåŸç”Ÿh5ã€æµè§ˆå™¨ã€<span class="hljs-variable constant_">PC</span>æ‘„åƒå¤´å®ç°æ‰‹åŠ¿æ§åˆ¶ç²’å­ç‰¹æ•ˆäº¤äº’çš„é€»è¾‘ï¼Œç²’å­é»˜è®¤ç¦»æ•£ï¼Œç±»ä¼¼é“¶æ²³ç³»åˆ†å¸ƒç¼“æ…¢ç§»åŠ¨ï¼ŒåŒæ—¶æœ‰<span class="hljs-number">5</span>ç§æ‰‹åŠ¿ï¼š

æ‰‹åŠ¿<span class="hljs-number">1</span>: æ¡æ‹³ï¼Œæ¡æ‹³åç²’å­èšæ‹¢æ˜¾ç¤ºçˆ±å¿ƒçš„å½¢çŠ¶

æ‰‹åŠ¿<span class="hljs-number">2</span>: å±•å¼€æ‰‹æŒå¹¶æŒ¥æ‰‹ï¼Œå±•å¼€æ‰‹æŒæŒ¥æ‰‹åç²’å­ä»å½“å‰çŠ¶æ€æ¢å¤åˆ°ç¦»æ•£çŠ¶æ€

æ‰‹åŠ¿<span class="hljs-number">3</span>: ğŸ‘† æ¯” <span class="hljs-number">1</span> ï¼šåªæœ‰é£ŸæŒ‡ä¼¸ç›´ï¼Œå…¶ä»– <span class="hljs-number">3</span> æ ¹å¼¯æ›²ï¼Œæ­¤æ—¶ç²’å­èšæ‹¢æ˜¾ç¤ºç¬¬ä¸€å¥è¯ï¼šæ˜¥æ¥å¤å¾€

æ‰‹åŠ¿<span class="hljs-number">4</span>: âœŒ æ¯” <span class="hljs-number">2</span> ï¼šåªæœ‰é£ŸæŒ‡å’Œä¸­æŒ‡ä¼¸ç›´ï¼Œå…¶ä»– <span class="hljs-number">2</span> æ ¹å¼¯æ›²æ‰‹æ­¤æ—¶ç²’å­èšæ‹¢æ˜¾ç¤ºç¬¬äºŒå¥è¯ï¼š ç§‹æ”¶å†¬è—

æ‰‹åŠ¿<span class="hljs-number">5</span>: ğŸ‘Œ æ¯” <span class="hljs-number">3</span> ï¼šåªæœ‰ä¸­æŒ‡ã€æ— åæŒ‡ã€å°æŒ‡ä¼¸ç›´ï¼Œé£ŸæŒ‡å¼¯æ›²ï¼Œæ­¤æ—¶ç²’å­èšæ‹¢æ˜¾ç¤ºç¬¬ä¸‰å¥è¯ï¼šæˆ‘ä»¬æ¥æ—¥æ–¹é•¿
</code></pre>
<h2 data-id="heading-0">æ•ˆæœå±•ç¤º</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/692793d7f1254e37a0fa1f4787aa72a5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP6bG85bCP6bG85bmy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766826945&amp;x-signature=AUwLnI1AilLfnzkzxYmDz7tjPvI%3D" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" loading="lazy"/></p>
<h2 data-id="heading-1">æºç åœ°å€</h2>
<p>æŒé—´æ˜Ÿæ²³ï¼š<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fhuijieya%2FGesture-Galaxy.git" target="_blank" title="https://github.com/huijieya/Gesture-Galaxy.git" ref="nofollow noopener noreferrer">github.com/huijieya/Geâ€¦</a></p>
<h2 data-id="heading-2">æºç åˆ†æ</h2>
<h3 data-id="heading-3">æ‰‹åŠ¿è¯†åˆ«æµç¨‹</h3>
<h4 data-id="heading-4">1. æ‰‹éƒ¨æ£€æµ‹åˆå§‹åŒ–</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// HandTracker.tsx ä¸­åˆå§‹åŒ– MediaPipe Hands</span>
<span class="hljs-keyword">const</span> hands = <span class="hljs-keyword">new</span> (<span class="hljs-variable language_">window</span> <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>).<span class="hljs-title class_">Hands</span>({
  <span class="hljs-attr">locateFile</span>: <span class="hljs-function">(<span class="hljs-params">file: <span class="hljs-built_in">string</span></span>) =&gt;</span> <span class="hljs-string">`https://cdn.jsdelivr.net/npm/@mediapipe/hands/<span class="hljs-subst">${file}</span>`</span>
});

hands.<span class="hljs-title function_">setOptions</span>({
  <span class="hljs-attr">maxNumHands</span>: <span class="hljs-number">1</span>,           <span class="hljs-comment">// æœ€å¤šæ£€æµ‹ä¸€åªæ‰‹</span>
  <span class="hljs-attr">modelComplexity</span>: <span class="hljs-number">1</span>,       <span class="hljs-comment">// æ¨¡å‹å¤æ‚åº¦</span>
  <span class="hljs-attr">minDetectionConfidence</span>: <span class="hljs-number">0.7</span>,  <span class="hljs-comment">// æœ€å°æ£€æµ‹ç½®ä¿¡åº¦</span>
  <span class="hljs-attr">minTrackingConfidence</span>: <span class="hljs-number">0.7</span>    <span class="hljs-comment">// æœ€å°è·Ÿè¸ªç½®ä¿¡åº¦</span>
});
</code></pre>
<h4 data-id="heading-5">2. æ‰‹éƒ¨å…³é”®ç‚¹è·å–</h4>
<p>MediaPipe ä¼šæ£€æµ‹æ‰‹éƒ¨çš„21ä¸ªå…³é”®ç‚¹ï¼ˆlandmarksï¼‰ï¼Œæ¯ä¸ªå…³é”®ç‚¹åŒ…å« x, y, z åæ ‡ï¼š</p>
<ul>
<li>æŒ‡å°–: 4(æ‹‡æŒ‡), 8(é£ŸæŒ‡), 12(ä¸­æŒ‡), 16(æ— åæŒ‡), 20(å°æŒ‡)</li>
<li>æŒ‡å…³èŠ‚: ç”¨äºåˆ¤æ–­æ‰‹æŒ‡æ˜¯å¦ä¼¸ç›´</li>
</ul>
<h4 data-id="heading-6">3. æ‰‹åŠ¿åˆ†ç±»é€»è¾‘</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// gestureLogic.ts ä¸­çš„ classifyGesture å‡½æ•°</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">isExtended</span> = (<span class="hljs-params">tipIdx: <span class="hljs-built_in">number</span>, mcpIdx: <span class="hljs-built_in">number</span></span>) =&gt; landmarks[tipIdx].<span class="hljs-property">y</span> &lt; landmarks[mcpIdx].<span class="hljs-property">y</span>;

<span class="hljs-comment">// åˆ¤æ–­å„æ‰‹æŒ‡æ˜¯å¦ä¼¸ç›´</span>
<span class="hljs-keyword">const</span> indexExt = <span class="hljs-title function_">isExtended</span>(<span class="hljs-number">8</span>, <span class="hljs-number">5</span>);   <span class="hljs-comment">// é£ŸæŒ‡</span>
<span class="hljs-keyword">const</span> middleExt = <span class="hljs-title function_">isExtended</span>(<span class="hljs-number">12</span>, <span class="hljs-number">9</span>); <span class="hljs-comment">// ä¸­æŒ‡</span>
<span class="hljs-keyword">const</span> ringExt = <span class="hljs-title function_">isExtended</span>(<span class="hljs-number">16</span>, <span class="hljs-number">13</span>);  <span class="hljs-comment">// æ— åæŒ‡</span>
<span class="hljs-keyword">const</span> pinkyExt = <span class="hljs-title function_">isExtended</span>(<span class="hljs-number">20</span>, <span class="hljs-number">17</span>); <span class="hljs-comment">// å°æŒ‡</span>

<span class="hljs-comment">// æ ¹æ®æ‰‹æŒ‡çŠ¶æ€è¯†åˆ«ä¸åŒæ‰‹åŠ¿</span>
<span class="hljs-keyword">if</span> (!indexExt &amp;&amp; !middleExt &amp;&amp; !ringExt &amp;&amp; !pinkyExt) {
  <span class="hljs-keyword">return</span> <span class="hljs-title class_">GestureType</span>.<span class="hljs-property">HEART</span>; <span class="hljs-comment">// æ¡æ‹³ - æ˜¾ç¤ºçˆ±å¿ƒ</span>
}
<span class="hljs-keyword">if</span> (indexExt &amp;&amp; middleExt &amp;&amp; ringExt &amp;&amp; pinkyExt) {
  <span class="hljs-keyword">return</span> <span class="hljs-title class_">GestureType</span>.<span class="hljs-property">GALAXY</span>; <span class="hljs-comment">// æ‰‹æŒå±•å¼€ - é“¶æ²³çŠ¶æ€</span>
}
<span class="hljs-comment">// ... å…¶ä»–æ‰‹åŠ¿åˆ¤æ–­</span>
</code></pre>
<h3 data-id="heading-7">ç²’å­ç»˜åˆ¶æœºåˆ¶</h3>
<h4 data-id="heading-8">1. ç²’å­ç³»ç»Ÿåˆå§‹åŒ–</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// ParticleCanvas.tsx ä¸­åˆå§‹åŒ–ç²’å­</span>
<span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> <span class="hljs-attr">particles</span>: <span class="hljs-title class_">Particle</span>[] = [];
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable constant_">PARTICLE_COUNT</span>; i++) {
    particles.<span class="hljs-title function_">push</span>({
      <span class="hljs-attr">x</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span>,     <span class="hljs-comment">// éšæœºåˆå§‹ä½ç½®</span>
      <span class="hljs-attr">y</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span>,
      <span class="hljs-attr">targetX</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span>, <span class="hljs-comment">// ç›®æ ‡ä½ç½®</span>
      <span class="hljs-attr">targetY</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span>,
      <span class="hljs-attr">vx</span>: <span class="hljs-number">0</span>,                                    <span class="hljs-comment">// é€Ÿåº¦</span>
      <span class="hljs-attr">vy</span>: <span class="hljs-number">0</span>,
      <span class="hljs-attr">size</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">1.5</span> + <span class="hljs-number">0.5</span>,          <span class="hljs-comment">// å¤§å°</span>
      <span class="hljs-attr">color</span>: <span class="hljs-variable constant_">COLORS</span>[<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-variable constant_">COLORS</span>.<span class="hljs-property">length</span>)], <span class="hljs-comment">// é¢œè‰²</span>
      <span class="hljs-attr">alpha</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">0.4</span> + <span class="hljs-number">0.4</span>,         <span class="hljs-comment">// é€æ˜åº¦</span>
    });
  }
  particlesRef.<span class="hljs-property">current</span> = particles;
}, []);
</code></pre>
<h4 data-id="heading-9">2. å½¢çŠ¶ç”Ÿæˆç®—æ³•</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> getShapePoints = (<span class="hljs-attr">type</span>: <span class="hljs-title class_">GestureType</span>, <span class="hljs-attr">width</span>: <span class="hljs-built_in">number</span>, <span class="hljs-attr">height</span>: <span class="hljs-built_in">number</span>): <span class="hljs-title class_">Point</span>[] =&gt; {
  <span class="hljs-keyword">const</span> centerX = width / <span class="hljs-number">2</span>;
  <span class="hljs-keyword">const</span> centerY = height / <span class="hljs-number">2</span>;
  
  <span class="hljs-keyword">switch</span> (<span class="hljs-keyword">type</span>) {
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">GestureType</span>.<span class="hljs-property">HEART</span>: 
      <span class="hljs-comment">// å¿ƒå½¢æ–¹ç¨‹å‚æ•°åŒ–ç”Ÿæˆç‚¹</span>
      <span class="hljs-comment">// x = 16sinÂ³(t)</span>
      <span class="hljs-comment">// y = 13cos(t) - 5cos(2t) - 2cos(3t) - cos(4t)</span>
      
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">GestureType</span>.<span class="hljs-property">TEXT_1</span>/<span class="hljs-number">2</span>/<span class="hljs-number">3</span>:
      <span class="hljs-comment">// ä½¿ç”¨ Canvas ç»˜åˆ¶æ–‡å­—å¹¶æå–åƒç´ ç‚¹</span>
      
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">GestureType</span>.<span class="hljs-property">GALAXY</span>:
    <span class="hljs-attr">default</span>:
      <span class="hljs-comment">// èºæ—‹é“¶æ²³å½¢çŠ¶</span>
      <span class="hljs-keyword">const</span> angle = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> * <span class="hljs-number">2</span>;
      <span class="hljs-keyword">const</span> r = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">pow</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>(), <span class="hljs-number">0.7</span>) * maxRadius;
      <span class="hljs-keyword">const</span> spiralFactor = <span class="hljs-number">2.0</span>;
      <span class="hljs-keyword">const</span> offset = r * (spiralFactor / maxRadius) * <span class="hljs-number">5</span>;
      points.<span class="hljs-title function_">push</span>({ 
        <span class="hljs-attr">x</span>: centerX + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">cos</span>(angle + offset) * r, 
        <span class="hljs-attr">y</span>: centerY + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(angle + offset) * r 
      });
  }
}
</code></pre>
<h4 data-id="heading-10">3. ç²’å­åŠ¨ç”»æ›´æ–°</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// ç²’å­è¿åŠ¨å’Œæ¸²æŸ“å¾ªç¯</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">render</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-comment">// åŠé€æ˜èƒŒæ™¯è¦†ç›–äº§ç”Ÿæ‹–å°¾æ•ˆæœ</span>
  ctx.<span class="hljs-property">fillStyle</span> = <span class="hljs-string">'rgba(0, 0, 0, 0.18)'</span>;
  ctx.<span class="hljs-title function_">fillRect</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, canvas.<span class="hljs-property">width</span>, canvas.<span class="hljs-property">height</span>);
  
  particlesRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">p</span>) =&gt;</span> {
    <span class="hljs-comment">// å¹³æ»‘æ’å€¼ç§»åŠ¨åˆ°ç›®æ ‡ä½ç½®</span>
    p.<span class="hljs-property">x</span> += (tx - p.<span class="hljs-property">x</span>) * <span class="hljs-variable constant_">LERP_FACTOR</span>;
    p.<span class="hljs-property">y</span> += (ty - p.<span class="hljs-property">y</span>) * <span class="hljs-variable constant_">LERP_FACTOR</span>;
    
    <span class="hljs-comment">// æ‰‹åŠ¿äº¤äº’å½±å“ç²’å­ä½ç½®</span>
    <span class="hljs-keyword">if</span> (hPos &amp;&amp; canInteract) {
      <span class="hljs-keyword">const</span> dx = p.<span class="hljs-property">x</span> - hPos.<span class="hljs-property">x</span>;
      <span class="hljs-keyword">const</span> dy = p.<span class="hljs-property">y</span> - hPos.<span class="hljs-property">y</span>;
      <span class="hljs-keyword">const</span> distSq = dx * dx + dy * dy;
      <span class="hljs-keyword">if</span> (distSq &lt; <span class="hljs-variable constant_">INTERACTION_RADIUS</span> * <span class="hljs-variable constant_">INTERACTION_RADIUS</span>) {
        <span class="hljs-comment">// æ’æ–¥åŠ›è®¡ç®—</span>
        <span class="hljs-keyword">const</span> dist = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sqrt</span>(distSq);
        <span class="hljs-keyword">const</span> force = (<span class="hljs-number">1</span> - dist / <span class="hljs-variable constant_">INTERACTION_RADIUS</span>) * <span class="hljs-variable constant_">INTERACTION_STRENGTH</span>;
        p.<span class="hljs-property">x</span> += dx * force;
        p.<span class="hljs-property">y</span> += dy * force;
      }
    }
    
    <span class="hljs-comment">// æ·»åŠ éšæœºæ‰°åŠ¨ä½¿ç²’å­æ›´ç”ŸåŠ¨</span>
    p.<span class="hljs-property">x</span> += (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() - <span class="hljs-number">0.5</span>) * <span class="hljs-number">0.6</span>;
    p.<span class="hljs-property">y</span> += (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() - <span class="hljs-number">0.5</span>) * <span class="hljs-number">0.6</span>;
    
    <span class="hljs-comment">// ç»˜åˆ¶ç²’å­</span>
    ctx.<span class="hljs-property">fillStyle</span> = p.<span class="hljs-property">color</span>;
    ctx.<span class="hljs-property">globalAlpha</span> = p.<span class="hljs-property">alpha</span>;
    ctx.<span class="hljs-title function_">beginPath</span>();
    ctx.<span class="hljs-title function_">arc</span>(p.<span class="hljs-property">x</span>, p.<span class="hljs-property">y</span>, p.<span class="hljs-property">size</span>, <span class="hljs-number">0</span>, <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> * <span class="hljs-number">2</span>);
    ctx.<span class="hljs-title function_">fill</span>();
  });
  
  animationRef.<span class="hljs-property">current</span> = <span class="hljs-title function_">requestAnimationFrame</span>(render);
};
</code></pre>
<h4 data-id="heading-11">4. é“¶æ²³æ—‹è½¬æ•ˆæœ</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// é“¶æ²³çŠ¶æ€ä¸‹çš„æ—‹è½¬åŠ¨ç”»</span>
galaxyAngleRef.<span class="hljs-property">current</span> += <span class="hljs-variable constant_">GALAXY_ROTATION_SPEED</span>;
<span class="hljs-keyword">const</span> cosA = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">cos</span>(galaxyAngleRef.<span class="hljs-property">current</span>);
<span class="hljs-keyword">const</span> sinA = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(galaxyAngleRef.<span class="hljs-property">current</span>);

<span class="hljs-comment">// å¯¹æ¯ä¸ªç²’å­åº”ç”¨æ—‹è½¬å˜æ¢</span>
<span class="hljs-keyword">const</span> dx = p.<span class="hljs-property">targetX</span> - cx;
<span class="hljs-keyword">const</span> dy = p.<span class="hljs-property">targetY</span> - cy;
tx = cx + dx * cosA - dy * sinA;
ty = cy + dx * sinA + dy * cosA;
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[ConcurrentHashMapå®ç°åŸç†]]></title>    <link>https://juejin.cn/post/7585468725332394038</link>    <guid>https://juejin.cn/post/7585468725332394038</guid>    <pubDate>2025-12-20T09:20:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585468725332394038" data-draft-id="7585412203978948651" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="ConcurrentHashMapå®ç°åŸç†"/> <meta itemprop="keywords" content="åç«¯,Java"/> <meta itemprop="datePublished" content="2025-12-20T09:20:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ç„¡é‡"/> <meta itemprop="url" content="https://juejin.cn/user/1116759546145086"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="æ˜é‡‘"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ConcurrentHashMapå®ç°åŸç†
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1116759546145086/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ç„¡é‡
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T09:20:39.000Z" title="Sat Dec 20 2025 09:20:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    é˜…è¯»30åˆ†é’Ÿ
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">ä¸€ã€ç†è®ºçŸ¥è¯†ä¸æ ¸å¿ƒæ¦‚å¿µ</h2>
<h3 data-id="heading-1">1.1 ä¸ºä»€ä¹ˆéœ€è¦ConcurrentHashMapï¼Ÿ</h3>
<p>åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œæˆ‘ä»¬ç»å¸¸éœ€è¦ä½¿ç”¨Mapæ¥å­˜å‚¨å…±äº«æ•°æ®ã€‚ä½†æ™®é€šçš„<code>HashMap</code>å¹¶ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œåœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ä¼šå‡ºç°ä¸¥é‡é—®é¢˜ã€‚</p>
<p><strong>HashMapçš„çº¿ç¨‹ä¸å®‰å…¨é—®é¢˜ï¼š</strong></p>
<ol>
<li>
<p><strong>æ•°æ®ä¸¢å¤±</strong>ï¼šå¤šä¸ªçº¿ç¨‹åŒæ—¶putï¼Œå¯èƒ½å¯¼è‡´ä¸€ä¸ªçº¿ç¨‹çš„æ•°æ®è¢«è¦†ç›–</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// çº¿ç¨‹1å’Œçº¿ç¨‹2åŒæ—¶æ‰§è¡Œput</span>
Thread-<span class="hljs-number">1</span>: put(<span class="hljs-string">"key1"</span>, <span class="hljs-string">"value1"</span>)  <span class="hljs-comment">// è®¡ç®—åˆ°index=5</span>
Thread-<span class="hljs-number">2</span>: put(<span class="hljs-string">"key2"</span>, <span class="hljs-string">"value2"</span>)  <span class="hljs-comment">// ä¹Ÿè®¡ç®—åˆ°index=5</span>
<span class="hljs-comment">// ç»“æœï¼šåªæœ‰ä¸€ä¸ªæ•°æ®è¢«ä¿å­˜ï¼Œå¦ä¸€ä¸ªä¸¢å¤±</span>
</code></pre>
</li>
<li>
<p><strong>æ­»å¾ªç¯é—®é¢˜ï¼ˆJDK 1.7ï¼‰</strong>ï¼šæ‰©å®¹æ—¶å¤šçº¿ç¨‹å¹¶å‘å¯¼è‡´é“¾è¡¨æˆç¯</p>
<ul>
<li>çº¿ç¨‹Aæ‰©å®¹åˆ°ä¸€åŠè¢«æŒ‚èµ·</li>
<li>çº¿ç¨‹Bå®Œæˆæ‰©å®¹ï¼Œé“¾è¡¨åè½¬</li>
<li>çº¿ç¨‹Aæ¢å¤æ‰§è¡Œï¼Œå½¢æˆç¯å½¢é“¾è¡¨</li>
<li>getæ“ä½œæ—¶CPU 100%ï¼Œæ— é™å¾ªç¯</li>
</ul>
</li>
<li>
<p><strong>æ•°æ®ä¸ä¸€è‡´</strong>ï¼šsize()è¿”å›å€¼ä¸å‡†ç¡®ï¼Œè¿­ä»£è¿‡ç¨‹ä¸­æ•°æ®å˜åŒ–</p>
</li>
</ol>
<h3 data-id="heading-2">1.2 Hashtableçš„æ€§èƒ½é—®é¢˜</h3>
<p><code>Hashtable</code>é€šè¿‡å¯¹æ‰€æœ‰æ–¹æ³•åŠ <code>synchronized</code>å®ç°çº¿ç¨‹å®‰å…¨ï¼Œä½†æ€§èƒ½æå·®ï¼š</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> V <span class="hljs-title function_">put</span><span class="hljs-params">(K key, V value)</span> { ... }
<span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> V <span class="hljs-title function_">get</span><span class="hljs-params">(Object key)</span> { ... }
</code></pre>
<p><strong>æ€§èƒ½é—®é¢˜</strong>ï¼š</p>
<ul>
<li><strong>å…¨è¡¨é”</strong>ï¼šæ— è®ºæ“ä½œå“ªä¸ªæ¡¶ï¼Œéƒ½è¦é”ä½æ•´ä¸ªè¡¨</li>
<li><strong>è¯»å†™äº’æ–¥</strong>ï¼šå³ä½¿åªæ˜¯è¯»å–ï¼Œä¹Ÿéœ€è¦ç­‰å¾…å†™æ“ä½œé‡Šæ”¾é”</li>
<li><strong>å¹¶å‘åº¦ä¸º1</strong>ï¼šåŒä¸€æ—¶åˆ»åªå…è®¸ä¸€ä¸ªçº¿ç¨‹è®¿é—®</li>
</ul>
<p><strong>æ€§èƒ½æµ‹è¯•æ•°æ®</strong>ï¼š</p>
<ul>
<li>å•çº¿ç¨‹ï¼šHashMap â‰ˆ Hashtable</li>
<li>10çº¿ç¨‹å¹¶å‘ï¼šHashMapä¸å®‰å…¨ï¼ŒHashtableååé‡ä»…ä¸ºHashMapçš„1/10</li>
</ul>
<h3 data-id="heading-3">1.3 Collections.synchronizedMapçš„å±€é™æ€§</h3>
<p><code>Collections.synchronizedMap</code>æ˜¯å¯¹Mapçš„ç®€å•åŒ…è£…ï¼š</p>
<pre><code class="hljs language-java" lang="java">Map&lt;K,V&gt; syncMap = Collections.synchronizedMap(<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;());

<span class="hljs-comment">// åº•å±‚å®ç°</span>
<span class="hljs-keyword">public</span> V <span class="hljs-title function_">put</span><span class="hljs-params">(K key, V value)</span> {
    <span class="hljs-keyword">synchronized</span> (mutex) {  <span class="hljs-comment">// mutex = this</span>
        <span class="hljs-keyword">return</span> m.put(key, value);
    }
}
</code></pre>
<p><strong>å±€é™æ€§</strong>ï¼š</p>
<ul>
<li>æœ¬è´¨ä»æ˜¯<strong>å…¨è¡¨é”</strong>ï¼Œæ€§èƒ½ä¸Hashtableç±»ä¼¼</li>
<li>è¿­ä»£æ—¶éœ€è¦æ‰‹åŠ¨åŠ é”ï¼Œå¦åˆ™æŠ›<code>ConcurrentModificationException</code></li>
<li>å¤åˆæ“ä½œï¼ˆå¦‚putIfAbsentï¼‰ä¸æ˜¯åŸå­çš„ï¼Œéœ€è¦é¢å¤–åŠ é”</li>
</ul>
<h3 data-id="heading-4">1.4 ConcurrentHashMapçš„è®¾è®¡ç›®æ ‡</h3>
<p>ä¸ºäº†è§£å†³ä¸Šè¿°é—®é¢˜ï¼Œ<code>ConcurrentHashMap</code>åº”è¿è€Œç”Ÿï¼Œè®¾è®¡ç›®æ ‡ï¼š</p>
<ol>
<li><strong>é«˜å¹¶å‘</strong>ï¼šæ”¯æŒé«˜å¹¶å‘è¯»å†™ï¼Œé”ç²’åº¦ç»†åŒ–</li>
<li><strong>é«˜æ€§èƒ½</strong>ï¼šè¯»æ“ä½œæ— é”ï¼Œå†™æ“ä½œå±€éƒ¨é”</li>
<li><strong>çº¿ç¨‹å®‰å…¨</strong>ï¼šä¿è¯æ•°æ®ä¸€è‡´æ€§</li>
<li><strong>å¼±ä¸€è‡´æ€§</strong>ï¼šå…è®¸è¯»åˆ°ç¨æ—§çš„æ•°æ®ï¼Œæ¢å–æ€§èƒ½</li>
</ol>
<p><strong>æ ¸å¿ƒæ€æƒ³</strong>ï¼š</p>
<ul>
<li><strong>åˆ†æ®µé”ï¼ˆJDK 1.7ï¼‰</strong>ï¼šå°†Mapåˆ†ä¸ºå¤šä¸ªSegmentï¼Œæ¯ä¸ªSegmentç‹¬ç«‹åŠ é”</li>
<li><strong>CAS + synchronizedï¼ˆJDK 1.8ï¼‰</strong>ï¼šæ›´ç»†ç²’åº¦çš„é”ï¼Œé”å®šå•ä¸ªNode</li>
</ul>
<hr/>
<h2 data-id="heading-5">äºŒã€åŸç†æ·±åº¦å‰–æ</h2>
<h3 data-id="heading-6">2.1 JDK 1.7 Segmentåˆ†æ®µé”æœºåˆ¶</h3>
<h4 data-id="heading-7">2.1.1 Segmentæ•°ç»„ç»“æ„</h4>
<p>JDK 1.7çš„<code>ConcurrentHashMap</code>é‡‡ç”¨<strong>Segmentæ•°ç»„ + HashEntryæ•°ç»„ + é“¾è¡¨</strong>çš„ç»“æ„ï¼š</p>
<pre><code class="hljs language-css" lang="css">ConcurrentHashMap
    |
    +-- Segment<span class="hljs-selector-attr">[0]</span> (extends ReentrantLock)
    |       |
    |       +-- HashEntry<span class="hljs-selector-attr">[]</span> <span class="hljs-selector-tag">table</span>
    |               |
    |               +-- HashEntry -&gt; HashEntry -&gt; null (é“¾è¡¨)
    |
    +-- Segment<span class="hljs-selector-attr">[1]</span>
    |       |
    |       +-- HashEntry<span class="hljs-selector-attr">[]</span> <span class="hljs-selector-tag">table</span>
    |
    +-- Segment<span class="hljs-selector-attr">[15]</span>  (é»˜è®¤<span class="hljs-number">16</span>ä¸ªSegment)
            |
            +-- HashEntry<span class="hljs-selector-attr">[]</span> <span class="hljs-selector-tag">table</span>
</code></pre>
<p><strong>æ ¸å¿ƒæ•°æ®ç»“æ„ï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;K,V&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractMap</span>&lt;K,V&gt; {
    <span class="hljs-comment">// Segmentæ•°ç»„</span>
    <span class="hljs-keyword">final</span> Segment&lt;K,V&gt;[] segments;

    <span class="hljs-comment">// Segmentç»§æ‰¿ReentrantLock</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Segment</span>&lt;K,V&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ReentrantLock</span> {
        <span class="hljs-keyword">transient</span> <span class="hljs-keyword">volatile</span> HashEntry&lt;K,V&gt;[] table;  <span class="hljs-comment">// HashEntryæ•°ç»„</span>
        <span class="hljs-keyword">transient</span> <span class="hljs-type">int</span> count;  <span class="hljs-comment">// Segmentä¸­å…ƒç´ æ•°é‡</span>
        <span class="hljs-keyword">transient</span> <span class="hljs-type">int</span> modCount;  <span class="hljs-comment">// ä¿®æ”¹æ¬¡æ•°</span>
        <span class="hljs-keyword">transient</span> <span class="hljs-type">int</span> threshold;  <span class="hljs-comment">// æ‰©å®¹é˜ˆå€¼</span>
        <span class="hljs-keyword">final</span> <span class="hljs-type">float</span> loadFactor;  <span class="hljs-comment">// åŠ è½½å› å­</span>
    }

    <span class="hljs-comment">// HashEntryèŠ‚ç‚¹</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HashEntry</span>&lt;K,V&gt; {
        <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> hash;
        <span class="hljs-keyword">final</span> K key;
        <span class="hljs-keyword">volatile</span> V value;
        <span class="hljs-keyword">volatile</span> HashEntry&lt;K,V&gt; next;  <span class="hljs-comment">// volatileä¿è¯å¯è§æ€§</span>
    }
}
</code></pre>
<p><strong>å…³é”®å‚æ•°ï¼š</strong></p>
<ul>
<li><strong>concurrencyLevelï¼ˆå¹¶å‘åº¦ï¼‰</strong>ï¼šSegmentæ•°ç»„é•¿åº¦ï¼Œé»˜è®¤16</li>
<li><strong>initialCapacity</strong>ï¼šåˆå§‹å®¹é‡ï¼Œé»˜è®¤16</li>
<li><strong>loadFactor</strong>ï¼šåŠ è½½å› å­ï¼Œé»˜è®¤0.75</li>
</ul>
<h4 data-id="heading-8">2.1.2 putæ“ä½œæµç¨‹</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> V <span class="hljs-title function_">put</span><span class="hljs-params">(K key, V value)</span> {
    Segment&lt;K,V&gt; s;
    <span class="hljs-keyword">if</span> (value == <span class="hljs-literal">null</span>)
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NullPointerException</span>();  <span class="hljs-comment">// valueä¸å…è®¸null</span>

    <span class="hljs-comment">// 1. è®¡ç®—hashå€¼</span>
    <span class="hljs-type">int</span> <span class="hljs-variable">hash</span> <span class="hljs-operator">=</span> hash(key);

    <span class="hljs-comment">// 2. å®šä½Segment (hash &gt;&gt;&gt; segmentShift) &amp; segmentMask</span>
    <span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> (hash &gt;&gt;&gt; segmentShift) &amp; segmentMask;

    <span class="hljs-comment">// 3. è·å–Segment</span>
    <span class="hljs-keyword">if</span> ((s = (Segment&lt;K,V&gt;)UNSAFE.getObject(segments, (j &lt;&lt; SSHIFT) + SBASE)) == <span class="hljs-literal">null</span>)
        s = ensureSegment(j);  <span class="hljs-comment">// å»¶è¿Ÿåˆå§‹åŒ–Segment</span>

    <span class="hljs-comment">// 4. è°ƒç”¨Segmentçš„putæ–¹æ³•</span>
    <span class="hljs-keyword">return</span> s.put(key, hash, value, <span class="hljs-literal">false</span>);
}

<span class="hljs-comment">// Segmentçš„putæ–¹æ³•</span>
<span class="hljs-keyword">final</span> V <span class="hljs-title function_">put</span><span class="hljs-params">(K key, <span class="hljs-type">int</span> hash, V value, <span class="hljs-type">boolean</span> onlyIfAbsent)</span> {
    <span class="hljs-comment">// 1. å°è¯•è·å–é”(tryLock)</span>
    HashEntry&lt;K,V&gt; node = tryLock() ? <span class="hljs-literal">null</span> :
        scanAndLockForPut(key, hash, value);  <span class="hljs-comment">// å¤±è´¥åˆ™è‡ªæ—‹è·å–é”</span>

    V oldValue;
    <span class="hljs-keyword">try</span> {
        HashEntry&lt;K,V&gt;[] tab = table;
        <span class="hljs-type">int</span> <span class="hljs-variable">index</span> <span class="hljs-operator">=</span> (tab.length - <span class="hljs-number">1</span>) &amp; hash;  <span class="hljs-comment">// å®šä½æ¡¶</span>
        HashEntry&lt;K,V&gt; first = entryAt(tab, index);  <span class="hljs-comment">// è·å–é“¾è¡¨å¤´</span>

        <span class="hljs-comment">// 2. éå†é“¾è¡¨</span>
        <span class="hljs-keyword">for</span> (HashEntry&lt;K,V&gt; e = first;;) {
            <span class="hljs-keyword">if</span> (e != <span class="hljs-literal">null</span>) {
                K k;
                <span class="hljs-comment">// æ‰¾åˆ°ç›¸åŒkeyï¼Œæ›¿æ¢value</span>
                <span class="hljs-keyword">if</span> ((k = e.key) == key ||
                    (e.hash == hash &amp;&amp; key.equals(k))) {
                    oldValue = e.value;
                    <span class="hljs-keyword">if</span> (!onlyIfAbsent) {
                        e.value = value;
                        ++modCount;
                    }
                    <span class="hljs-keyword">break</span>;
                }
                e = e.next;
            }
            <span class="hljs-keyword">else</span> {
                <span class="hljs-comment">// 3. æ’å…¥æ–°èŠ‚ç‚¹</span>
                <span class="hljs-keyword">if</span> (node != <span class="hljs-literal">null</span>)
                    node.setNext(first);  <span class="hljs-comment">// å¤´æ’æ³•</span>
                <span class="hljs-keyword">else</span>
                    node = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashEntry</span>&lt;K,V&gt;(hash, key, value, first);

                <span class="hljs-type">int</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> count + <span class="hljs-number">1</span>;
                <span class="hljs-comment">// 4. åˆ¤æ–­æ˜¯å¦éœ€è¦æ‰©å®¹</span>
                <span class="hljs-keyword">if</span> (c &gt; threshold &amp;&amp; tab.length &lt; MAXIMUM_CAPACITY)
                    rehash(node);
                <span class="hljs-keyword">else</span>
                    setEntryAt(tab, index, node);
                ++modCount;
                count = c;
                oldValue = <span class="hljs-literal">null</span>;
                <span class="hljs-keyword">break</span>;
            }
        }
    } <span class="hljs-keyword">finally</span> {
        unlock();  <span class="hljs-comment">// é‡Šæ”¾é”</span>
    }
    <span class="hljs-keyword">return</span> oldValue;
}
</code></pre>
<p><strong>æµç¨‹æ€»ç»“ï¼š</strong></p>
<ol>
<li>è®¡ç®—hashï¼Œå®šä½Segment</li>
<li>SegmentåŠ é”ï¼ˆReentrantLockï¼‰</li>
<li>å®šä½HashEntryæ¡¶ä½ç½®</li>
<li>éå†é“¾è¡¨ï¼Œæ‰¾åˆ°åˆ™æ›¿æ¢ï¼Œå¦åˆ™å¤´æ’æ³•æ’å…¥</li>
<li>åˆ¤æ–­æ˜¯å¦æ‰©å®¹</li>
<li>é‡Šæ”¾é”</li>
</ol>
<h4 data-id="heading-9">2.1.3 getæ“ä½œ</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> V <span class="hljs-title function_">get</span><span class="hljs-params">(Object key)</span> {
    Segment&lt;K,V&gt; s;
    HashEntry&lt;K,V&gt;[] tab;

    <span class="hljs-comment">// 1. è®¡ç®—hash</span>
    <span class="hljs-type">int</span> <span class="hljs-variable">h</span> <span class="hljs-operator">=</span> hash(key);

    <span class="hljs-comment">// 2. å®šä½Segment</span>
    <span class="hljs-type">long</span> <span class="hljs-variable">u</span> <span class="hljs-operator">=</span> (((h &gt;&gt;&gt; segmentShift) &amp; segmentMask) &lt;&lt; SSHIFT) + SBASE;

    <span class="hljs-comment">// 3. æ— é”è·å–Segmentå’Œtable</span>
    <span class="hljs-keyword">if</span> ((s = (Segment&lt;K,V&gt;)UNSAFE.getObjectVolatile(segments, u)) != <span class="hljs-literal">null</span> &amp;&amp;
        (tab = s.table) != <span class="hljs-literal">null</span>) {

        <span class="hljs-comment">// 4. éå†é“¾è¡¨æŸ¥æ‰¾ï¼ˆæ— é”ï¼‰</span>
        <span class="hljs-keyword">for</span> (HashEntry&lt;K,V&gt; e = (HashEntry&lt;K,V&gt;) UNSAFE.getObjectVolatile
                 (tab, ((<span class="hljs-type">long</span>)(((tab.length - <span class="hljs-number">1</span>) &amp; h)) &lt;&lt; TSHIFT) + TBASE);
             e != <span class="hljs-literal">null</span>; e = e.next) {
            K k;
            <span class="hljs-keyword">if</span> ((k = e.key) == key || (e.hash == h &amp;&amp; key.equals(k)))
                <span class="hljs-keyword">return</span> e.value;  <span class="hljs-comment">// volatileè¯»ï¼Œä¿è¯å¯è§æ€§</span>
        }
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
}
</code></pre>
<p><strong>å…³é”®ç‚¹ï¼š</strong></p>
<ul>
<li><strong>æ— é”è¯»å–</strong>ï¼šgetä¸åŠ é”ï¼Œä¾èµ–volatileä¿è¯å¯è§æ€§</li>
<li><strong>UNSAFEæ“ä½œ</strong>ï¼šç›´æ¥ä»å†…å­˜è¯»å–ï¼Œä¿è¯è¯»åˆ°æœ€æ–°å€¼</li>
<li><strong>æ€§èƒ½æé«˜</strong>ï¼šå¹¶å‘è¯»ä¸ä¼šé˜»å¡</li>
</ul>
<h4 data-id="heading-10">2.1.4 æ‰©å®¹æœºåˆ¶</h4>
<p><strong>Segmentç‹¬ç«‹æ‰©å®¹</strong>ï¼š</p>
<ul>
<li>åªæ‰©å®¹å•ä¸ªSegmentï¼Œä¸å½±å“å…¶ä»–Segment</li>
<li>æ‰©å®¹æ—¶æŒæœ‰Segmenté”ï¼Œé˜»å¡è¯¥Segmentçš„å†™æ“ä½œ</li>
<li>è¯»æ“ä½œä»å¯å¹¶å‘è¿›è¡Œ</li>
</ul>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">rehash</span><span class="hljs-params">(HashEntry&lt;K,V&gt; node)</span> {
    HashEntry&lt;K,V&gt;[] oldTable = table;
    <span class="hljs-type">int</span> <span class="hljs-variable">oldCapacity</span> <span class="hljs-operator">=</span> oldTable.length;

    <span class="hljs-comment">// æ‰©å®¹ä¸º2å€</span>
    <span class="hljs-type">int</span> <span class="hljs-variable">newCapacity</span> <span class="hljs-operator">=</span> oldCapacity &lt;&lt; <span class="hljs-number">1</span>;
    threshold = (<span class="hljs-type">int</span>)(newCapacity * loadFactor);

    HashEntry&lt;K,V&gt;[] newTable =
        (HashEntry&lt;K,V&gt;[]) <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashEntry</span>[newCapacity];
    <span class="hljs-type">int</span> <span class="hljs-variable">sizeMask</span> <span class="hljs-operator">=</span> newCapacity - <span class="hljs-number">1</span>;

    <span class="hljs-comment">// éå†æ—§tableï¼Œé‡æ–°åˆ†é…èŠ‚ç‚¹</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; oldCapacity ; i++) {
        HashEntry&lt;K,V&gt; e = oldTable[i];

        <span class="hljs-keyword">if</span> (e != <span class="hljs-literal">null</span>) {
            HashEntry&lt;K,V&gt; next = e.next;
            <span class="hljs-type">int</span> <span class="hljs-variable">idx</span> <span class="hljs-operator">=</span> e.hash &amp; sizeMask;

            <span class="hljs-keyword">if</span> (next == <span class="hljs-literal">null</span>)  <span class="hljs-comment">// å•èŠ‚ç‚¹ç›´æ¥æ”¾å…¥</span>
                newTable[idx] = e;
            <span class="hljs-keyword">else</span> {
                <span class="hljs-comment">// éå†é“¾è¡¨ï¼Œé‡æ–°hashåˆ†é…</span>
                HashEntry&lt;K,V&gt; lastRun = e;
                <span class="hljs-type">int</span> <span class="hljs-variable">lastIdx</span> <span class="hljs-operator">=</span> idx;
                <span class="hljs-keyword">for</span> (HashEntry&lt;K,V&gt; last = next;
                     last != <span class="hljs-literal">null</span>;
                     last = last.next) {
                    <span class="hljs-type">int</span> <span class="hljs-variable">k</span> <span class="hljs-operator">=</span> last.hash &amp; sizeMask;
                    <span class="hljs-keyword">if</span> (k != lastIdx) {
                        lastIdx = k;
                        lastRun = last;
                    }
                }
                newTable[lastIdx] = lastRun;

                <span class="hljs-comment">// Clone remaining nodes</span>
                <span class="hljs-keyword">for</span> (HashEntry&lt;K,V&gt; p = e; p != lastRun; p = p.next) {
                    <span class="hljs-type">V</span> <span class="hljs-variable">v</span> <span class="hljs-operator">=</span> p.value;
                    <span class="hljs-type">int</span> <span class="hljs-variable">h</span> <span class="hljs-operator">=</span> p.hash;
                    <span class="hljs-type">int</span> <span class="hljs-variable">k</span> <span class="hljs-operator">=</span> h &amp; sizeMask;
                    HashEntry&lt;K,V&gt; n = newTable[k];
                    newTable[k] = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashEntry</span>&lt;K,V&gt;(h, p.key, v, n);
                }
            }
        }
    }

    <span class="hljs-comment">// æ’å…¥æ–°èŠ‚ç‚¹</span>
    <span class="hljs-type">int</span> <span class="hljs-variable">nodeIndex</span> <span class="hljs-operator">=</span> node.hash &amp; sizeMask;
    node.setNext(newTable[nodeIndex]);
    newTable[nodeIndex] = node;
    table = newTable;
}
</code></pre>
<h4 data-id="heading-11">2.1.5 size()æ–¹æ³•</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">size</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">final</span> Segment&lt;K,V&gt;[] segments = <span class="hljs-built_in">this</span>.segments;
    <span class="hljs-type">int</span> size;
    <span class="hljs-type">boolean</span> overflow;
    <span class="hljs-type">long</span> sum;
    <span class="hljs-type">long</span> <span class="hljs-variable">last</span> <span class="hljs-operator">=</span> <span class="hljs-number">0L</span>;
    <span class="hljs-type">int</span> <span class="hljs-variable">retries</span> <span class="hljs-operator">=</span> -<span class="hljs-number">1</span>;

    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">for</span> (;;) {
            <span class="hljs-comment">// 1. å°è¯•2æ¬¡æ— é”ç»Ÿè®¡</span>
            <span class="hljs-keyword">if</span> (retries++ == RETRIES_BEFORE_LOCK) {
                <span class="hljs-comment">// 2. å¤±è´¥åˆ™é”å®šæ‰€æœ‰Segment</span>
                <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; j &lt; segments.length; ++j)
                    ensureSegment(j).lock();
            }

            sum = <span class="hljs-number">0L</span>;
            size = <span class="hljs-number">0</span>;
            overflow = <span class="hljs-literal">false</span>;

            <span class="hljs-comment">// 3. ç´¯åŠ æ‰€æœ‰Segmentçš„count</span>
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; j &lt; segments.length; ++j) {
                Segment&lt;K,V&gt; seg = segmentAt(segments, j);
                <span class="hljs-keyword">if</span> (seg != <span class="hljs-literal">null</span>) {
                    sum += seg.modCount;
                    <span class="hljs-type">int</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> seg.count;
                    <span class="hljs-keyword">if</span> (c &lt; <span class="hljs-number">0</span> || (size += c) &lt; <span class="hljs-number">0</span>)
                        overflow = <span class="hljs-literal">true</span>;
                }
            }

            <span class="hljs-comment">// 4. modCountæœªå˜åŒ–ï¼Œè¯´æ˜æœŸé—´æ²¡æœ‰ä¿®æ”¹ï¼Œè¿”å›</span>
            <span class="hljs-keyword">if</span> (sum == last)
                <span class="hljs-keyword">break</span>;
            last = sum;
        }
    } <span class="hljs-keyword">finally</span> {
        <span class="hljs-keyword">if</span> (retries &gt; RETRIES_BEFORE_LOCK) {
            <span class="hljs-comment">// é‡Šæ”¾æ‰€æœ‰Segmenté”</span>
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; j &lt; segments.length; ++j)
                segmentAt(segments, j).unlock();
        }
    }
    <span class="hljs-keyword">return</span> overflow ? Integer.MAX_VALUE : size;
}
</code></pre>
<p><strong>ç­–ç•¥ï¼š</strong></p>
<ul>
<li>å…ˆå°è¯•2æ¬¡æ— é”ç»Ÿè®¡ï¼Œé€šè¿‡æ¯”è¾ƒ<code>modCount</code>åˆ¤æ–­æ˜¯å¦æœ‰ä¿®æ”¹</li>
<li>å¦‚æœ2æ¬¡ç»Ÿè®¡ç»“æœä¸€è‡´ï¼Œè¯´æ˜æœŸé—´æ— ä¿®æ”¹ï¼Œç›´æ¥è¿”å›</li>
<li>å¦åˆ™é”å®šæ‰€æœ‰Segmentï¼Œå†æ¬¡ç»Ÿè®¡</li>
</ul>
<h4 data-id="heading-12">2.1.6 ä¼˜ç¼ºç‚¹åˆ†æ</h4>
<p><strong>ä¼˜ç‚¹ï¼š</strong></p>
<ul>
<li>âœ… åˆ†æ®µé”ï¼Œå¹¶å‘åº¦é«˜ï¼ˆé»˜è®¤16ï¼‰</li>
<li>âœ… è¯»æ“ä½œæ— é”ï¼Œæ€§èƒ½å¥½</li>
<li>âœ… å†™æ“ä½œåªé”å•ä¸ªSegmentï¼Œä¸å½±å“å…¶ä»–Segment</li>
</ul>
<p><strong>ç¼ºç‚¹ï¼š</strong></p>
<ul>
<li>âŒ Segmentç²’åº¦è¾ƒç²—ï¼Œå¹¶å‘åº¦å—é™äºSegmentæ•°é‡</li>
<li>âŒ æ‰©å®¹æ—¶éœ€è¦é”å®šSegment</li>
<li>âŒ ç»“æ„å¤æ‚ï¼Œå†…å­˜å ç”¨è¾ƒå¤§</li>
</ul>
<hr/>
<h3 data-id="heading-13">2.2 JDK 1.8 CAS + synchronizedå®ç°åŸç†</h3>
<h4 data-id="heading-14">2.2.1 æ•°æ®ç»“æ„å˜åŒ–</h4>
<p>JDK 1.8å®Œå…¨é‡æ„ï¼Œ<strong>å–æ¶ˆSegment</strong>ï¼Œæ”¹ä¸º<strong>Nodeæ•°ç»„ + é“¾è¡¨/çº¢é»‘æ ‘</strong>ï¼š</p>
<pre><code class="hljs language-scss" lang="scss">ConcurrentHashMap
    |
    +-- Node<span class="hljs-selector-attr">[]</span> <span class="hljs-selector-tag">table</span>
            |
            +-- Node<span class="hljs-selector-attr">[0]</span> -&gt; Node -&gt; Node (é“¾è¡¨)
            |
            +-- Node<span class="hljs-selector-attr">[1]</span> -&gt; TreeNode (çº¢é»‘æ ‘)
            |                 / \
            |                /   \
            |           TreeNode TreeNode
            |
            +-- Node<span class="hljs-selector-attr">[2]</span> -&gt; ForwardingNode (æ‰©å®¹æ ‡è®°)
</code></pre>
<p><strong>æ ¸å¿ƒæ•°æ®ç»“æ„ï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;K,V&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractMap</span>&lt;K,V&gt; {
    <span class="hljs-keyword">transient</span> <span class="hljs-keyword">volatile</span> Node&lt;K,V&gt;[] table;  <span class="hljs-comment">// Nodeæ•°ç»„</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">transient</span> <span class="hljs-keyword">volatile</span> Node&lt;K,V&gt;[] nextTable;  <span class="hljs-comment">// æ‰©å®¹æ—¶çš„æ–°è¡¨</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">transient</span> <span class="hljs-keyword">volatile</span> <span class="hljs-type">long</span> baseCount;  <span class="hljs-comment">// å…ƒç´ æ•°é‡åŸºæ•°</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">transient</span> <span class="hljs-keyword">volatile</span> <span class="hljs-type">int</span> sizeCtl;  <span class="hljs-comment">// æ§åˆ¶æ ‡è¯†ç¬¦</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">transient</span> <span class="hljs-keyword">volatile</span> CounterCell[] counterCells;  <span class="hljs-comment">// è®¡æ•°æ•°ç»„</span>

    <span class="hljs-comment">// NodeèŠ‚ç‚¹ï¼ˆé“¾è¡¨ï¼‰</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Node</span>&lt;K,V&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Map</span>.Entry&lt;K,V&gt; {
        <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> hash;
        <span class="hljs-keyword">final</span> K key;
        <span class="hljs-keyword">volatile</span> V val;  <span class="hljs-comment">// volatileä¿è¯å¯è§æ€§</span>
        <span class="hljs-keyword">volatile</span> Node&lt;K,V&gt; next;
    }

    <span class="hljs-comment">// TreeNodeï¼ˆçº¢é»‘æ ‘ï¼‰</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TreeNode</span>&lt;K,V&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Node</span>&lt;K,V&gt; {
        TreeNode&lt;K,V&gt; parent;
        TreeNode&lt;K,V&gt; left;
        TreeNode&lt;K,V&gt; right;
        TreeNode&lt;K,V&gt; prev;
        <span class="hljs-type">boolean</span> red;
    }

    <span class="hljs-comment">// ForwardingNodeï¼ˆæ‰©å®¹æ ‡è®°èŠ‚ç‚¹ï¼‰</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ForwardingNode</span>&lt;K,V&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Node</span>&lt;K,V&gt; {
        <span class="hljs-keyword">final</span> Node&lt;K,V&gt;[] nextTable;
        ForwardingNode(Node&lt;K,V&gt;[] tab) {
            <span class="hljs-built_in">super</span>(MOVED, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);  <span class="hljs-comment">// hash = MOVED = -1</span>
            <span class="hljs-built_in">this</span>.nextTable = tab;
        }
    }
}
</code></pre>
<p><strong>å…³é”®å˜åŒ–ï¼š</strong></p>
<ul>
<li><strong>Nodeæ•°ç»„</strong>ï¼šå–ä»£Segmentæ•°ç»„ï¼Œç›´æ¥å­˜å‚¨Node</li>
<li><strong>TreeNode</strong>ï¼šé“¾è¡¨é•¿åº¦â‰¥8ä¸”æ•°ç»„é•¿åº¦â‰¥64æ—¶ï¼Œè½¬ä¸ºçº¢é»‘æ ‘</li>
<li><strong>ForwardingNode</strong>ï¼šæ ‡è®°æ­£åœ¨è¿ç§»çš„æ¡¶ï¼Œhashå€¼ä¸º-1</li>
</ul>
<h4 data-id="heading-15">2.2.2 putæ“ä½œè¯¦ç»†æµç¨‹</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> V <span class="hljs-title function_">put</span><span class="hljs-params">(K key, V value)</span> {
    <span class="hljs-keyword">return</span> putVal(key, value, <span class="hljs-literal">false</span>);
}

<span class="hljs-keyword">final</span> V <span class="hljs-title function_">putVal</span><span class="hljs-params">(K key, V value, <span class="hljs-type">boolean</span> onlyIfAbsent)</span> {
    <span class="hljs-keyword">if</span> (key == <span class="hljs-literal">null</span> || value == <span class="hljs-literal">null</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NullPointerException</span>();

    <span class="hljs-comment">// 1. è®¡ç®—hashï¼ˆæ‰°åŠ¨å‡½æ•°ï¼‰</span>
    <span class="hljs-type">int</span> <span class="hljs-variable">hash</span> <span class="hljs-operator">=</span> spread(key.hashCode());
    <span class="hljs-type">int</span> <span class="hljs-variable">binCount</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;

    <span class="hljs-keyword">for</span> (Node&lt;K,V&gt;[] tab = table;;) {
        Node&lt;K,V&gt; f; <span class="hljs-type">int</span> n, i, fh;

        <span class="hljs-comment">// æƒ…å†µ1: tableæœªåˆå§‹åŒ–</span>
        <span class="hljs-keyword">if</span> (tab == <span class="hljs-literal">null</span> || (n = tab.length) == <span class="hljs-number">0</span>)
            tab = initTable();

        <span class="hljs-comment">// æƒ…å†µ2: æ¡¶ä¸ºç©ºï¼ŒCASæ’å…¥ï¼ˆæ— é”ï¼‰</span>
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ((f = tabAt(tab, i = (n - <span class="hljs-number">1</span>) &amp; hash)) == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">if</span> (casTabAt(tab, i, <span class="hljs-literal">null</span>,
                         <span class="hljs-keyword">new</span> <span class="hljs-title class_">Node</span>&lt;K,V&gt;(hash, key, value, <span class="hljs-literal">null</span>)))
                <span class="hljs-keyword">break</span>;  <span class="hljs-comment">// CASæˆåŠŸï¼Œæ’å…¥å®Œæˆ</span>
        }

        <span class="hljs-comment">// æƒ…å†µ3: æ­£åœ¨æ‰©å®¹ï¼ˆhash == MOVEDï¼‰</span>
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ((fh = f.hash) == MOVED)
            tab = helpTransfer(tab, f);  <span class="hljs-comment">// å¸®åŠ©æ‰©å®¹</span>

        <span class="hljs-comment">// æƒ…å†µ4: hashå†²çªï¼Œsynchronizedé”å®šæ¡¶</span>
        <span class="hljs-keyword">else</span> {
            <span class="hljs-type">V</span> <span class="hljs-variable">oldVal</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
            <span class="hljs-keyword">synchronized</span> (f) {  <span class="hljs-comment">// é”å®šé“¾è¡¨/æ ‘çš„å¤´èŠ‚ç‚¹</span>
                <span class="hljs-keyword">if</span> (tabAt(tab, i) == f) {  <span class="hljs-comment">// åŒé‡æ£€æŸ¥</span>
                    <span class="hljs-keyword">if</span> (fh &gt;= <span class="hljs-number">0</span>) {  <span class="hljs-comment">// é“¾è¡¨</span>
                        binCount = <span class="hljs-number">1</span>;
                        <span class="hljs-keyword">for</span> (Node&lt;K,V&gt; e = f;; ++binCount) {
                            K ek;
                            <span class="hljs-comment">// æ‰¾åˆ°ç›¸åŒkeyï¼Œæ›¿æ¢value</span>
                            <span class="hljs-keyword">if</span> (e.hash == hash &amp;&amp;
                                ((ek = e.key) == key ||
                                 (ek != <span class="hljs-literal">null</span> &amp;&amp; key.equals(ek)))) {
                                oldVal = e.val;
                                <span class="hljs-keyword">if</span> (!onlyIfAbsent)
                                    e.val = value;
                                <span class="hljs-keyword">break</span>;
                            }
                            Node&lt;K,V&gt; pred = e;
                            <span class="hljs-comment">// åˆ°è¾¾é“¾è¡¨å°¾éƒ¨ï¼Œæ’å…¥æ–°èŠ‚ç‚¹</span>
                            <span class="hljs-keyword">if</span> ((e = e.next) == <span class="hljs-literal">null</span>) {
                                pred.next = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Node</span>&lt;K,V&gt;(hash, key,
                                                          value, <span class="hljs-literal">null</span>);
                                <span class="hljs-keyword">break</span>;
                            }
                        }
                    }
                    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (f <span class="hljs-keyword">instanceof</span> TreeBin) {  <span class="hljs-comment">// çº¢é»‘æ ‘</span>
                        Node&lt;K,V&gt; p;
                        binCount = <span class="hljs-number">2</span>;
                        <span class="hljs-keyword">if</span> ((p = ((TreeBin&lt;K,V&gt;)f).putTreeVal(hash, key,
                                                       value)) != <span class="hljs-literal">null</span>) {
                            oldVal = p.val;
                            <span class="hljs-keyword">if</span> (!onlyIfAbsent)
                                p.val = value;
                        }
                    }
                }
            }  <span class="hljs-comment">// é‡Šæ”¾synchronizedé”</span>

            <span class="hljs-keyword">if</span> (binCount != <span class="hljs-number">0</span>) {
                <span class="hljs-comment">// é“¾è¡¨é•¿åº¦ &gt;= 8ï¼Œå°è¯•æ ‘åŒ–</span>
                <span class="hljs-keyword">if</span> (binCount &gt;= TREEIFY_THRESHOLD)
                    treeifyBin(tab, i);
                <span class="hljs-keyword">if</span> (oldVal != <span class="hljs-literal">null</span>)
                    <span class="hljs-keyword">return</span> oldVal;
                <span class="hljs-keyword">break</span>;
            }
        }
    }

    <span class="hljs-comment">// å¢åŠ è®¡æ•°</span>
    addCount(<span class="hljs-number">1L</span>, binCount);
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
}
</code></pre>
<p><strong>æµç¨‹å›¾ï¼š</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5c69b728f5be43718222afb43c84e796~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54Sh6YeP:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766827239&amp;x-signature=FOA7KKkZWmPXNHFgQ%2BGa379lN2k%3D" alt="concurrenthashmap-put-flow.svg" loading="lazy"/></p>
<p><strong>å…³é”®ç‚¹ï¼š</strong></p>
<ul>
<li><strong>æ¡¶ä¸ºç©º</strong>ï¼šç›´æ¥CASæ’å…¥ï¼Œæ— éœ€åŠ é”</li>
<li><strong>æ­£åœ¨æ‰©å®¹</strong>ï¼šå¸®åŠ©æ‰©å®¹ï¼Œåä½œå®Œæˆ</li>
<li><strong>hashå†²çª</strong>ï¼šsynchronizedé”å®š<strong>å¤´èŠ‚ç‚¹</strong>ï¼Œç²’åº¦æç»†</li>
<li><strong>æ ‘åŒ–æ¡ä»¶</strong>ï¼šé“¾è¡¨é•¿åº¦â‰¥8 <strong>ä¸”</strong> æ•°ç»„é•¿åº¦â‰¥64</li>
</ul>
<h4 data-id="heading-16">2.2.3 getæ“ä½œ</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> V <span class="hljs-title function_">get</span><span class="hljs-params">(Object key)</span> {
    Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; e, p; <span class="hljs-type">int</span> n, eh; K ek;

    <span class="hljs-comment">// 1. è®¡ç®—hash</span>
    <span class="hljs-type">int</span> <span class="hljs-variable">h</span> <span class="hljs-operator">=</span> spread(key.hashCode());

    <span class="hljs-comment">// 2. tableä¸ä¸ºç©º ä¸” æ¡¶ä¸ä¸ºç©º</span>
    <span class="hljs-keyword">if</span> ((tab = table) != <span class="hljs-literal">null</span> &amp;&amp; (n = tab.length) &gt; <span class="hljs-number">0</span> &amp;&amp;
        (e = tabAt(tab, (n - <span class="hljs-number">1</span>) &amp; h)) != <span class="hljs-literal">null</span>) {

        <span class="hljs-comment">// 3. æ£€æŸ¥å¤´èŠ‚ç‚¹</span>
        <span class="hljs-keyword">if</span> ((eh = e.hash) == h) {
            <span class="hljs-keyword">if</span> ((ek = e.key) == key || (ek != <span class="hljs-literal">null</span> &amp;&amp; key.equals(ek)))
                <span class="hljs-keyword">return</span> e.val;
        }
        <span class="hljs-comment">// 4. hash &lt; 0: çº¢é»‘æ ‘æˆ–ForwardingNode</span>
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (eh &lt; <span class="hljs-number">0</span>)
            <span class="hljs-keyword">return</span> (p = e.find(h, key)) != <span class="hljs-literal">null</span> ? p.val : <span class="hljs-literal">null</span>;

        <span class="hljs-comment">// 5. éå†é“¾è¡¨</span>
        <span class="hljs-keyword">while</span> ((e = e.next) != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">if</span> (e.hash == h &amp;&amp;
                ((ek = e.key) == key || (ek != <span class="hljs-literal">null</span> &amp;&amp; key.equals(ek))))
                <span class="hljs-keyword">return</span> e.val;
        }
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
}
</code></pre>
<p><strong>å…³é”®ç‚¹ï¼š</strong></p>
<ul>
<li><strong>æ— é”è¯»å–</strong>ï¼šå®Œå…¨ä¸åŠ é”ï¼Œä¾èµ–volatileä¿è¯å¯è§æ€§</li>
<li><strong>ForwardingNodeå¤„ç†</strong>ï¼šæ‰©å®¹æ—¶é€šè¿‡<code>find()</code>æ–¹æ³•åœ¨æ–°è¡¨ä¸­æŸ¥æ‰¾</li>
<li><strong>æ€§èƒ½æé«˜</strong>ï¼šå¹¶å‘è¯»ä¸ä¼šé˜»å¡</li>
</ul>
<h4 data-id="heading-17">2.2.4 æ‰©å®¹æœºåˆ¶è¯¦è§£</h4>
<p><strong>å¤šçº¿ç¨‹åä½œæ‰©å®¹</strong>æ˜¯JDK 1.8çš„äº®ç‚¹ï¼Œæ ¸å¿ƒæ€æƒ³ï¼š</p>
<ul>
<li>å°†æ‰©å®¹ä»»åŠ¡æ‹†åˆ†ä¸ºå¤šä¸ªå°ä»»åŠ¡</li>
<li>å¤šä¸ªçº¿ç¨‹å¹¶å‘è¿ç§»ä¸åŒåŒºé—´çš„æ•°æ®</li>
<li>ä½¿ç”¨<code>ForwardingNode</code>æ ‡è®°å·²è¿ç§»çš„æ¡¶</li>
</ul>
<p><strong>å…³é”®å˜é‡ï¼š</strong></p>
<ul>
<li><code>sizeCtl</code>ï¼šæ§åˆ¶æ ‡è¯†ç¬¦
<ul>
<li><code>-1</code>ï¼šæ­£åœ¨åˆå§‹åŒ–</li>
<li><code>-(1 + nThreads)</code>ï¼šæ­£åœ¨æ‰©å®¹ï¼ŒnThreadsä¸ºå‚ä¸æ‰©å®¹çš„çº¿ç¨‹æ•°</li>
<li><code>&gt; 0</code>ï¼šä¸‹æ¬¡æ‰©å®¹é˜ˆå€¼</li>
</ul>
</li>
<li><code>transferIndex</code>ï¼šä¸‹ä¸€ä¸ªå¾…è¿ç§»çš„æ¡¶ç´¢å¼•</li>
<li><code>stride</code>ï¼šæ¯ä¸ªçº¿ç¨‹å¤„ç†çš„æ¡¶æ•°é‡ï¼ˆæœ€å°16ï¼‰</li>
</ul>
<p><strong>æ‰©å®¹æµç¨‹ï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transfer</span><span class="hljs-params">(Node&lt;K,V&gt;[] tab, Node&lt;K,V&gt;[] nextTab)</span> {
    <span class="hljs-type">int</span> <span class="hljs-variable">n</span> <span class="hljs-operator">=</span> tab.length, stride;

    <span class="hljs-comment">// 1. è®¡ç®—æ¯ä¸ªçº¿ç¨‹å¤„ç†çš„æ¡¶æ•°ï¼ˆstrideï¼‰</span>
    <span class="hljs-keyword">if</span> ((stride = (NCPU &gt; <span class="hljs-number">1</span>) ? (n &gt;&gt;&gt; <span class="hljs-number">3</span>) / NCPU : n) &lt; MIN_TRANSFER_STRIDE)
        stride = MIN_TRANSFER_STRIDE;

    <span class="hljs-comment">// 2. åˆå§‹åŒ–æ–°è¡¨</span>
    <span class="hljs-keyword">if</span> (nextTab == <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">try</span> {
            Node&lt;K,V&gt;[] nt = (Node&lt;K,V&gt;[])<span class="hljs-keyword">new</span> <span class="hljs-title class_">Node</span>&lt;?,?&gt;[n &lt;&lt; <span class="hljs-number">1</span>];  <span class="hljs-comment">// 2å€æ‰©å®¹</span>
            nextTab = nt;
        } <span class="hljs-keyword">catch</span> (Throwable ex) {
            sizeCtl = Integer.MAX_VALUE;
            <span class="hljs-keyword">return</span>;
        }
        nextTable = nextTab;
        transferIndex = n;  <span class="hljs-comment">// ä»åå¾€å‰è¿ç§»</span>
    }

    <span class="hljs-type">int</span> <span class="hljs-variable">nextn</span> <span class="hljs-operator">=</span> nextTab.length;
    ForwardingNode&lt;K,V&gt; fwd = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ForwardingNode</span>&lt;K,V&gt;(nextTab);
    <span class="hljs-type">boolean</span> <span class="hljs-variable">advance</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;
    <span class="hljs-type">boolean</span> <span class="hljs-variable">finishing</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;

    <span class="hljs-comment">// 3. å¾ªç¯å¤„ç†æ¯ä¸ªæ¡¶</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>, bound = <span class="hljs-number">0</span>;;) {
        Node&lt;K,V&gt; f; <span class="hljs-type">int</span> fh;

        <span class="hljs-comment">// 3.1 é¢†å–ä»»åŠ¡ï¼šCASè·å–[bound, i]åŒºé—´</span>
        <span class="hljs-keyword">while</span> (advance) {
            <span class="hljs-type">int</span> nextIndex, nextBound;
            <span class="hljs-keyword">if</span> (--i &gt;= bound || finishing)
                advance = <span class="hljs-literal">false</span>;
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ((nextIndex = transferIndex) &lt;= <span class="hljs-number">0</span>) {
                i = -<span class="hljs-number">1</span>;
                advance = <span class="hljs-literal">false</span>;
            }
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (U.compareAndSwapInt
                     (<span class="hljs-built_in">this</span>, TRANSFERINDEX, nextIndex,
                      nextBound = (nextIndex &gt; stride ?
                                   nextIndex - stride : <span class="hljs-number">0</span>))) {
                bound = nextBound;
                i = nextIndex - <span class="hljs-number">1</span>;
                advance = <span class="hljs-literal">false</span>;
            }
        }

        <span class="hljs-comment">// 3.2 å®Œæˆæ£€æŸ¥</span>
        <span class="hljs-keyword">if</span> (i &lt; <span class="hljs-number">0</span> || i &gt;= n || i + n &gt;= nextn) {
            <span class="hljs-type">int</span> sc;
            <span class="hljs-keyword">if</span> (finishing) {
                nextTable = <span class="hljs-literal">null</span>;
                table = nextTab;
                sizeCtl = (n &lt;&lt; <span class="hljs-number">1</span>) - (n &gt;&gt;&gt; <span class="hljs-number">1</span>);  <span class="hljs-comment">// 0.75 * 2n</span>
                <span class="hljs-keyword">return</span>;
            }
            <span class="hljs-comment">// å½“å‰çº¿ç¨‹å®Œæˆï¼Œæ‰©å®¹çº¿ç¨‹æ•°-1</span>
            <span class="hljs-keyword">if</span> (U.compareAndSwapInt(<span class="hljs-built_in">this</span>, SIZECTL, sc = sizeCtl, sc - <span class="hljs-number">1</span>)) {
                <span class="hljs-keyword">if</span> ((sc - <span class="hljs-number">2</span>) != resizeStamp(n) &lt;&lt; RESIZE_STAMP_SHIFT)
                    <span class="hljs-keyword">return</span>;
                finishing = advance = <span class="hljs-literal">true</span>;
                i = n;
            }
        }

        <span class="hljs-comment">// 3.3 æ¡¶ä¸ºç©ºï¼Œæ”¾ç½®ForwardingNode</span>
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ((f = tabAt(tab, i)) == <span class="hljs-literal">null</span>)
            advance = casTabAt(tab, i, <span class="hljs-literal">null</span>, fwd);

        <span class="hljs-comment">// 3.4 å·²ç»å¤„ç†è¿‡ï¼ˆForwardingNodeï¼‰</span>
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ((fh = f.hash) == MOVED)
            advance = <span class="hljs-literal">true</span>;

        <span class="hljs-comment">// 3.5 è¿ç§»æ•°æ®</span>
        <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">synchronized</span> (f) {  <span class="hljs-comment">// é”å®šæ—§æ¡¶</span>
                <span class="hljs-keyword">if</span> (tabAt(tab, i) == f) {
                    Node&lt;K,V&gt; ln, hn;
                    <span class="hljs-keyword">if</span> (fh &gt;= <span class="hljs-number">0</span>) {  <span class="hljs-comment">// é“¾è¡¨</span>
                        <span class="hljs-comment">// æ ¹æ®hash &amp; n åˆ†ä¸ºé«˜ä½å’Œä½ä½é“¾è¡¨</span>
                        <span class="hljs-type">int</span> <span class="hljs-variable">runBit</span> <span class="hljs-operator">=</span> fh &amp; n;
                        Node&lt;K,V&gt; lastRun = f;
                        <span class="hljs-keyword">for</span> (Node&lt;K,V&gt; p = f.next; p != <span class="hljs-literal">null</span>; p = p.next) {
                            <span class="hljs-type">int</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> p.hash &amp; n;
                            <span class="hljs-keyword">if</span> (b != runBit) {
                                runBit = b;
                                lastRun = p;
                            }
                        }
                        <span class="hljs-keyword">if</span> (runBit == <span class="hljs-number">0</span>) {
                            ln = lastRun;
                            hn = <span class="hljs-literal">null</span>;
                        }
                        <span class="hljs-keyword">else</span> {
                            hn = lastRun;
                            ln = <span class="hljs-literal">null</span>;
                        }

                        <span class="hljs-keyword">for</span> (Node&lt;K,V&gt; p = f; p != lastRun; p = p.next) {
                            <span class="hljs-type">int</span> <span class="hljs-variable">ph</span> <span class="hljs-operator">=</span> p.hash; <span class="hljs-type">K</span> <span class="hljs-variable">pk</span> <span class="hljs-operator">=</span> p.key; <span class="hljs-type">V</span> <span class="hljs-variable">pv</span> <span class="hljs-operator">=</span> p.val;
                            <span class="hljs-keyword">if</span> ((ph &amp; n) == <span class="hljs-number">0</span>)
                                ln = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Node</span>&lt;K,V&gt;(ph, pk, pv, ln);
                            <span class="hljs-keyword">else</span>
                                hn = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Node</span>&lt;K,V&gt;(ph, pk, pv, hn);
                        }

                        <span class="hljs-comment">// ä½ä½é“¾è¡¨æ”¾åœ¨åŸä½ç½® i</span>
                        setTabAt(nextTab, i, ln);
                        <span class="hljs-comment">// é«˜ä½é“¾è¡¨æ”¾åœ¨ i + n</span>
                        setTabAt(nextTab, i + n, hn);
                        <span class="hljs-comment">// æ—§è¡¨è¯¥ä½ç½®æ”¾ForwardingNode</span>
                        setTabAt(tab, i, fwd);
                        advance = <span class="hljs-literal">true</span>;
                    }
                    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (f <span class="hljs-keyword">instanceof</span> TreeBin) {  <span class="hljs-comment">// çº¢é»‘æ ‘</span>
                        <span class="hljs-comment">// æ ‘çš„è¿ç§»é€»è¾‘ï¼ˆçœç•¥ï¼‰</span>
                        ...
                    }
                }
            }
        }
    }
}
</code></pre>
<p><strong>æ‰©å®¹æµç¨‹å›¾ï¼š</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/83d524c07c84415f8e5ee366db93ccb5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54Sh6YeP:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766827239&amp;x-signature=syyvRCDAs%2FqgY%2FkFZE%2B5oRApr9I%3D" alt="concurrenthashmap-resize-flow.svg" loading="lazy"/></p>
<p><strong>å…³é”®ç‚¹ï¼š</strong></p>
<ul>
<li><strong>ä»»åŠ¡åˆ†é…</strong>ï¼šCASè·å–å¾…è¿ç§»åŒºé—´ï¼Œé¿å…é‡å¤</li>
<li><strong>ForwardingNode</strong>ï¼šæ ‡è®°å·²è¿ç§»ï¼Œgetæ—¶é‡å®šå‘åˆ°æ–°è¡¨</li>
<li><strong>å¹¶å‘å®‰å…¨</strong>ï¼šè¿ç§»æ—¶é”å®šæ—§æ¡¶ï¼Œä¸å½±å“å…¶ä»–æ¡¶</li>
<li><strong>é«˜æ•ˆåä½œ</strong>ï¼šputé‡åˆ°æ‰©å®¹æ—¶ä¼š<code>helpTransfer()</code>å¸®å¿™</li>
</ul>
<h4 data-id="heading-18">2.2.5 size()æ–¹æ³•</h4>
<p>JDK 1.8ä½¿ç”¨<strong>LongAdderæ€æƒ³</strong>å®ç°é«˜æ€§èƒ½è®¡æ•°ï¼š</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">size</span><span class="hljs-params">()</span> {
    <span class="hljs-type">long</span> <span class="hljs-variable">n</span> <span class="hljs-operator">=</span> sumCount();
    <span class="hljs-keyword">return</span> ((n &lt; <span class="hljs-number">0L</span>) ? <span class="hljs-number">0</span> :
            (n &gt; (<span class="hljs-type">long</span>)Integer.MAX_VALUE) ? Integer.MAX_VALUE :
            (<span class="hljs-type">int</span>)n);
}

<span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-title function_">sumCount</span><span class="hljs-params">()</span> {
    CounterCell[] as = counterCells; CounterCell a;
    <span class="hljs-type">long</span> <span class="hljs-variable">sum</span> <span class="hljs-operator">=</span> baseCount;
    <span class="hljs-keyword">if</span> (as != <span class="hljs-literal">null</span>) {
        <span class="hljs-comment">// ç´¯åŠ æ‰€æœ‰CounterCell</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; as.length; ++i) {
            <span class="hljs-keyword">if</span> ((a = as[i]) != <span class="hljs-literal">null</span>)
                sum += a.value;
        }
    }
    <span class="hljs-keyword">return</span> sum;
}

<span class="hljs-comment">// å¢åŠ è®¡æ•°</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addCount</span><span class="hljs-params">(<span class="hljs-type">long</span> x, <span class="hljs-type">int</span> check)</span> {
    CounterCell[] as; <span class="hljs-type">long</span> b, s;

    <span class="hljs-comment">// å°è¯•CASæ›´æ–°baseCount</span>
    <span class="hljs-keyword">if</span> ((as = counterCells) != <span class="hljs-literal">null</span> ||
        !U.compareAndSwapLong(<span class="hljs-built_in">this</span>, BASECOUNT, b = baseCount, s = b + x)) {

        CounterCell a; <span class="hljs-type">long</span> v; <span class="hljs-type">int</span> m;
        <span class="hljs-type">boolean</span> <span class="hljs-variable">uncontended</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;

        <span class="hljs-comment">// CASå¤±è´¥ï¼Œæ›´æ–°CounterCell</span>
        <span class="hljs-keyword">if</span> (as == <span class="hljs-literal">null</span> || (m = as.length - <span class="hljs-number">1</span>) &lt; <span class="hljs-number">0</span> ||
            (a = as[ThreadLocalRandom.getProbe() &amp; m]) == <span class="hljs-literal">null</span> ||
            !(uncontended =
              U.compareAndSwapLong(a, CELLVALUE, v = a.value, v + x))) {
            fullAddCount(x, uncontended);  <span class="hljs-comment">// æ‰©å®¹CounterCellæ•°ç»„</span>
            <span class="hljs-keyword">return</span>;
        }
        <span class="hljs-keyword">if</span> (check &lt;= <span class="hljs-number">1</span>)
            <span class="hljs-keyword">return</span>;
        s = sumCount();
    }

    <span class="hljs-comment">// æ£€æŸ¥æ˜¯å¦éœ€è¦æ‰©å®¹</span>
    <span class="hljs-keyword">if</span> (check &gt;= <span class="hljs-number">0</span>) {
        ...
    }
}
</code></pre>
<p><strong>è®¡æ•°åŸç†ï¼š</strong></p>
<ul>
<li><strong>baseCount</strong>ï¼šåŸºç¡€è®¡æ•°</li>
<li><strong>CounterCell[]</strong>ï¼šåˆ†æ®µè®¡æ•°æ•°ç»„ï¼Œå‡å°‘CASå†²çª</li>
<li><strong>æ€»æ•° = baseCount + Î£(counterCells[i].value)</strong></li>
</ul>
<p><strong>ä¼˜ç‚¹</strong>ï¼š</p>
<ul>
<li>é«˜å¹¶å‘ä¸‹æ€§èƒ½ä¼˜ç§€ï¼Œé¿å…å•ç‚¹CASç«äº‰</li>
<li>size()ç›´æ¥æ±‚å’Œï¼Œæ— éœ€åŠ é”</li>
</ul>
<h4 data-id="heading-19">2.2.6 ä¸ºä»€ä¹ˆæ”¾å¼ƒåˆ†æ®µé”ï¼Ÿ</h4>













































<table><thead><tr><th>å¯¹æ¯”é¡¹</th><th>JDK 1.7 Segment</th><th>JDK 1.8 CAS + synchronized</th></tr></thead><tbody><tr><td><strong>é”ç²’åº¦</strong></td><td>Segmentçº§åˆ«ï¼ˆç²—ï¼‰</td><td>Nodeçº§åˆ«ï¼ˆç»†ï¼‰</td></tr><tr><td><strong>å¹¶å‘åº¦</strong></td><td>Segmentæ•°é‡ï¼ˆé»˜è®¤16ï¼‰</td><td>æ•°ç»„é•¿åº¦ï¼ˆåŠ¨æ€ï¼‰</td></tr><tr><td><strong>æ‰©å®¹</strong></td><td>å•Segmentæ‰©å®¹</td><td>å…¨è¡¨æ‰©å®¹ï¼Œå¤šçº¿ç¨‹åä½œ</td></tr><tr><td><strong>ç»“æ„å¤æ‚åº¦</strong></td><td>ä¸‰å±‚ç»“æ„ï¼ˆSegment-HashEntry-é“¾è¡¨ï¼‰</td><td>äºŒå±‚ç»“æ„ï¼ˆNode-é“¾è¡¨/æ ‘ï¼‰</td></tr><tr><td><strong>å†…å­˜å ç”¨</strong></td><td>è¾ƒå¤§ï¼ˆSegmentå¼€é”€ï¼‰</td><td>è¾ƒå°</td></tr><tr><td><strong>è¯»æ€§èƒ½</strong></td><td>é«˜ï¼ˆvolatileï¼‰</td><td>é«˜ï¼ˆvolatileï¼‰</td></tr><tr><td><strong>å†™æ€§èƒ½</strong></td><td>ä¸­ï¼ˆReentrantLockï¼‰</td><td>é«˜ï¼ˆCAS + synchronizedä¼˜åŒ–ï¼‰</td></tr></tbody></table>
<p><strong>æ”¾å¼ƒåŸå› ï¼š</strong></p>
<ol>
<li><strong>Segmentç²’åº¦è¿‡ç²—</strong>ï¼šå¹¶å‘åº¦å—é™ï¼Œæœ€å¤š16ä¸ªçº¿ç¨‹å¹¶å‘å†™</li>
<li><strong>synchronizedä¼˜åŒ–</strong>ï¼šJDK 1.6åsynchronizedæ€§èƒ½å¤§å¹…æå‡ï¼ˆé”æ¶ˆé™¤ã€é”ç²—åŒ–ã€åå‘é”ã€è½»é‡çº§é”ï¼‰</li>
<li><strong>CASæ— é”æ›´å¿«</strong>ï¼šæ¡¶ä¸ºç©ºæ—¶CASç›´æ¥æ’å…¥ï¼Œæ€§èƒ½æ›´é«˜</li>
<li><strong>æ‰©å®¹æ›´é«˜æ•ˆ</strong>ï¼šå¤šçº¿ç¨‹åä½œæ‰©å®¹ï¼Œæ¯”å•Segmentæ‰©å®¹å¿«</li>
</ol>
<hr/>
<h3 data-id="heading-20">2.3 ä¸å…¶ä»–çº¿ç¨‹å®‰å…¨Mapå¯¹æ¯”</h3>





















































































<table><thead><tr><th>ç‰¹æ€§</th><th>HashMap</th><th>Hashtable</th><th>synchronizedMap</th><th>ConcurrentHashMap 1.7</th><th>ConcurrentHashMap 1.8</th></tr></thead><tbody><tr><td><strong>çº¿ç¨‹å®‰å…¨</strong></td><td>âŒ å¦</td><td>âœ… æ˜¯</td><td>âœ… æ˜¯</td><td>âœ… æ˜¯</td><td>âœ… æ˜¯</td></tr><tr><td><strong>é”ç²’åº¦</strong></td><td>-</td><td>å…¨è¡¨é”</td><td>å…¨è¡¨é”</td><td>Segmenté”</td><td>Nodeé”</td></tr><tr><td><strong>å¹¶å‘åº¦</strong></td><td>-</td><td>1</td><td>1</td><td>16ï¼ˆé»˜è®¤ï¼‰</td><td>æ•°ç»„é•¿åº¦</td></tr><tr><td><strong>keyå…è®¸null</strong></td><td>âœ… æ˜¯</td><td>âŒ å¦</td><td>âœ… æ˜¯</td><td>âŒ å¦</td><td>âŒ å¦</td></tr><tr><td><strong>valueå…è®¸null</strong></td><td>âœ… æ˜¯</td><td>âŒ å¦</td><td>âœ… æ˜¯</td><td>âŒ å¦</td><td>âŒ å¦</td></tr><tr><td><strong>è¿­ä»£å™¨</strong></td><td>fail-fast</td><td>fail-fast</td><td>fail-fast</td><td>fail-safe</td><td>fail-safe</td></tr><tr><td><strong>æ€§èƒ½ï¼ˆå•çº¿ç¨‹ï¼‰</strong></td><td>â­â­â­â­â­</td><td>â­â­â­</td><td>â­â­â­</td><td>â­â­â­â­</td><td>â­â­â­â­â­</td></tr><tr><td><strong>æ€§èƒ½ï¼ˆå¹¶å‘ï¼‰</strong></td><td>-</td><td>â­</td><td>â­</td><td>â­â­â­</td><td>â­â­â­â­â­</td></tr><tr><td><strong>é€‚ç”¨åœºæ™¯</strong></td><td>å•çº¿ç¨‹</td><td>ä½å¹¶å‘</td><td>ä½å¹¶å‘</td><td>ä¸­é«˜å¹¶å‘</td><td>é«˜å¹¶å‘</td></tr></tbody></table>
<p><strong>æ€§èƒ½å¯¹æ¯”ï¼ˆ10çº¿ç¨‹å¹¶å‘put 100ä¸‡æ¬¡ï¼‰ï¼š</strong></p>



































<table><thead><tr><th>å®ç°</th><th>è€—æ—¶</th><th>ååé‡</th></tr></thead><tbody><tr><td>HashMap</td><td>ä¸å®‰å…¨</td><td>-</td></tr><tr><td>Hashtable</td><td>8500ms</td><td>11.7ä¸‡/s</td></tr><tr><td>synchronizedMap</td><td>8200ms</td><td>12.2ä¸‡/s</td></tr><tr><td>ConcurrentHashMap 1.7</td><td>2800ms</td><td>35.7ä¸‡/s</td></tr><tr><td>ConcurrentHashMap 1.8</td><td>1500ms</td><td>66.7ä¸‡/s</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-21">ä¸‰ã€å®æˆ˜åœºæ™¯åº”ç”¨</h2>
<h3 data-id="heading-22">3.1 åœºæ™¯1ï¼šé«˜å¹¶å‘æœ¬åœ°ç¼“å­˜å®ç°</h3>
<h4 data-id="heading-23">3.1.1 ä¸šåŠ¡èƒŒæ™¯</h4>
<p>ç”µå•†å¹³å°çš„å•†å“åŸºç¡€ä¿¡æ¯ï¼ˆå¦‚ç±»ç›®ã€å“ç‰Œï¼‰å˜åŒ–é¢‘ç‡ä½ï¼Œä½†æŸ¥è¯¢é¢‘ç¹ï¼Œé€‚åˆä½¿ç”¨æœ¬åœ°ç¼“å­˜å‡è½»æ•°æ®åº“å‹åŠ›ã€‚</p>
<p><strong>éœ€æ±‚ï¼š</strong></p>
<ul>
<li>è¯»å¤šå†™å°‘ï¼ˆè¯»å†™æ¯” 100:1ï¼‰</li>
<li>æ”¯æŒé«˜å¹¶å‘è®¿é—®</li>
<li>æ•°æ®å®šæœŸåˆ·æ–°</li>
<li>æ”¯æŒæ‰‹åŠ¨å¤±æ•ˆ</li>
</ul>
<h4 data-id="heading-24">3.1.2 æŠ€æœ¯æ–¹æ¡ˆ</h4>
<p>ä½¿ç”¨<code>ConcurrentHashMap</code>ä½œä¸ºç¼“å­˜å®¹å™¨ï¼š</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.util.concurrent.*;
<span class="hljs-keyword">import</span> java.util.function.Function;
<span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;

<span class="hljs-comment">/**
 * æœ¬åœ°ç¼“å­˜å·¥å…·ç±»
 */</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LocalCache</span>&lt;K, V&gt; {
    <span class="hljs-comment">// ç¼“å­˜å®¹å™¨</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ConcurrentHashMap&lt;K, CacheValue&lt;V&gt;&gt; cache;

    <span class="hljs-comment">// å®šæ—¶åˆ·æ–°ä»»åŠ¡</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ScheduledExecutorService scheduler;

    <span class="hljs-comment">// è¿‡æœŸæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> expireTime;

    <span class="hljs-comment">// ç¼“å­˜å€¼åŒ…è£…ç±»</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CacheValue</span>&lt;V&gt; {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> V value;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> createTime;

        <span class="hljs-keyword">public</span> <span class="hljs-title function_">CacheValue</span><span class="hljs-params">(V value)</span> {
            <span class="hljs-built_in">this</span>.value = value;
            <span class="hljs-built_in">this</span>.createTime = System.currentTimeMillis();
        }

        <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isExpired</span><span class="hljs-params">(<span class="hljs-type">long</span> expireTime)</span> {
            <span class="hljs-keyword">return</span> System.currentTimeMillis() - createTime &gt; expireTime;
        }

        <span class="hljs-keyword">public</span> V <span class="hljs-title function_">getValue</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">return</span> value;
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">LocalCache</span><span class="hljs-params">(<span class="hljs-type">int</span> initialCapacity, <span class="hljs-type">long</span> expireTime)</span> {
        <span class="hljs-built_in">this</span>.cache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;(initialCapacity);
        <span class="hljs-built_in">this</span>.expireTime = expireTime;
        <span class="hljs-built_in">this</span>.scheduler = Executors.newScheduledThreadPool(<span class="hljs-number">1</span>);

        <span class="hljs-comment">// å¯åŠ¨å®šæœŸæ¸…ç†è¿‡æœŸæ•°æ®ä»»åŠ¡</span>
        startCleanupTask();
    }

    <span class="hljs-comment">/**
     * è·å–ç¼“å­˜ï¼Œä¸å­˜åœ¨åˆ™åŠ è½½
     */</span>
    <span class="hljs-keyword">public</span> V <span class="hljs-title function_">get</span><span class="hljs-params">(K key, Function&lt;K, V&gt; loader)</span> {
        CacheValue&lt;V&gt; cacheValue = cache.get(key);

        <span class="hljs-comment">// ç¼“å­˜å­˜åœ¨ä¸”æœªè¿‡æœŸ</span>
        <span class="hljs-keyword">if</span> (cacheValue != <span class="hljs-literal">null</span> &amp;&amp; !cacheValue.isExpired(expireTime)) {
            <span class="hljs-keyword">return</span> cacheValue.getValue();
        }

        <span class="hljs-comment">// ç¼“å­˜ä¸å­˜åœ¨æˆ–å·²è¿‡æœŸï¼Œé‡æ–°åŠ è½½</span>
        <span class="hljs-comment">// ä½¿ç”¨computeIfAbsentä¿è¯åªåŠ è½½ä¸€æ¬¡</span>
        <span class="hljs-keyword">return</span> cache.compute(key, (k, oldValue) -&gt; {
            <span class="hljs-comment">// åŒé‡æ£€æŸ¥ï¼šå…¶ä»–çº¿ç¨‹å¯èƒ½å·²ç»åŠ è½½</span>
            <span class="hljs-keyword">if</span> (oldValue != <span class="hljs-literal">null</span> &amp;&amp; !oldValue.isExpired(expireTime)) {
                <span class="hljs-keyword">return</span> oldValue;
            }

            <span class="hljs-comment">// åŠ è½½æ•°æ®</span>
            <span class="hljs-type">V</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> loader.apply(k);
            <span class="hljs-keyword">if</span> (value == <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;  <span class="hljs-comment">// ä¸ç¼“å­˜null</span>
            }

            log.info(<span class="hljs-string">"ç¼“å­˜åŠ è½½: key={}"</span>, k);
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CacheValue</span>&lt;&gt;(value);
        }).getValue();
    }

    <span class="hljs-comment">/**
     * ä¸»åŠ¨è®¾ç½®ç¼“å­˜
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">put</span><span class="hljs-params">(K key, V value)</span> {
        <span class="hljs-keyword">if</span> (value != <span class="hljs-literal">null</span>) {
            cache.put(key, <span class="hljs-keyword">new</span> <span class="hljs-title class_">CacheValue</span>&lt;&gt;(value));
        }
    }

    <span class="hljs-comment">/**
     * ä½¿ç¼“å­˜å¤±æ•ˆ
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">invalidate</span><span class="hljs-params">(K key)</span> {
        cache.remove(key);
        log.info(<span class="hljs-string">"ç¼“å­˜å¤±æ•ˆ: key={}"</span>, key);
    }

    <span class="hljs-comment">/**
     * æ¸…ç©ºæ‰€æœ‰ç¼“å­˜
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">clear</span><span class="hljs-params">()</span> {
        cache.clear();
        log.info(<span class="hljs-string">"ç¼“å­˜å·²æ¸…ç©º"</span>);
    }

    <span class="hljs-comment">/**
     * è·å–ç¼“å­˜å¤§å°
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">size</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> cache.size();
    }

    <span class="hljs-comment">/**
     * å¯åŠ¨å®šæœŸæ¸…ç†ä»»åŠ¡
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">startCleanupTask</span><span class="hljs-params">()</span> {
        scheduler.scheduleAtFixedRate(() -&gt; {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-type">int</span> <span class="hljs-variable">cleanCount</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
                <span class="hljs-type">long</span> <span class="hljs-variable">now</span> <span class="hljs-operator">=</span> System.currentTimeMillis();

                <span class="hljs-comment">// éå†æ¸…ç†è¿‡æœŸæ•°æ®</span>
                <span class="hljs-keyword">for</span> (K key : cache.keySet()) {
                    CacheValue&lt;V&gt; value = cache.get(key);
                    <span class="hljs-keyword">if</span> (value != <span class="hljs-literal">null</span> &amp;&amp; value.isExpired(expireTime)) {
                        cache.remove(key);
                        cleanCount++;
                    }
                }

                <span class="hljs-keyword">if</span> (cleanCount &gt; <span class="hljs-number">0</span>) {
                    log.info(<span class="hljs-string">"æ¸…ç†è¿‡æœŸç¼“å­˜: count={}, size={}"</span>, cleanCount, cache.size());
                }
            } <span class="hljs-keyword">catch</span> (Exception e) {
                log.error(<span class="hljs-string">"æ¸…ç†ç¼“å­˜å¼‚å¸¸"</span>, e);
            }
        }, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, TimeUnit.MINUTES);  <span class="hljs-comment">// æ¯åˆ†é’Ÿæ¸…ç†ä¸€æ¬¡</span>
    }

    <span class="hljs-comment">/**
     * å…³é—­ç¼“å­˜
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">shutdown</span><span class="hljs-params">()</span> {
        scheduler.shutdown();
        cache.clear();
    }
}
</code></pre>
<h4 data-id="heading-25">3.1.3 ä½¿ç”¨ç¤ºä¾‹</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductService</span> {
    <span class="hljs-comment">// å•†å“ç±»ç›®ç¼“å­˜ï¼Œè¿‡æœŸæ—¶é—´10åˆ†é’Ÿ</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> LocalCache&lt;Long, Category&gt; categoryCache =
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">LocalCache</span>&lt;&gt;(<span class="hljs-number">1000</span>, <span class="hljs-number">10</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>);

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> CategoryMapper categoryMapper;

    <span class="hljs-comment">/**
     * æŸ¥è¯¢ç±»ç›®ï¼ˆå¸¦ç¼“å­˜ï¼‰
     */</span>
    <span class="hljs-keyword">public</span> Category <span class="hljs-title function_">getCategory</span><span class="hljs-params">(Long categoryId)</span> {
        <span class="hljs-keyword">return</span> categoryCache.get(categoryId, id -&gt; {
            <span class="hljs-comment">// ç¼“å­˜ä¸å­˜åœ¨æ—¶ï¼Œä»æ•°æ®åº“åŠ è½½</span>
            <span class="hljs-type">Category</span> <span class="hljs-variable">category</span> <span class="hljs-operator">=</span> categoryMapper.selectById(id);
            log.info(<span class="hljs-string">"ä»æ•°æ®åº“åŠ è½½ç±»ç›®: id={}"</span>, id);
            <span class="hljs-keyword">return</span> category;
        });
    }

    <span class="hljs-comment">/**
     * æ›´æ–°ç±»ç›®ï¼ˆå¤±æ•ˆç¼“å­˜ï¼‰
     */</span>
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateCategory</span><span class="hljs-params">(Category category)</span> {
        categoryMapper.updateById(category);
        <span class="hljs-comment">// æ›´æ–°åç«‹å³å¤±æ•ˆç¼“å­˜</span>
        categoryCache.invalidate(category.getId());
    }

    <span class="hljs-comment">/**
     * é¢„çƒ­ç¼“å­˜
     */</span>
    <span class="hljs-meta">@PostConstruct</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">warmUpCache</span><span class="hljs-params">()</span> {
        List&lt;Category&gt; categories = categoryMapper.selectAll();
        <span class="hljs-keyword">for</span> (Category category : categories) {
            categoryCache.put(category.getId(), category);
        }
        log.info(<span class="hljs-string">"ç±»ç›®ç¼“å­˜é¢„çƒ­å®Œæˆ: size={}"</span>, categoryCache.size());
    }
}
</code></pre>
<h4 data-id="heading-26">3.1.4 ä¸ºä»€ä¹ˆä¸ç”¨Guava Cacheï¼Ÿ</h4>
<p><strong>åœºæ™¯å¯¹æ¯”ï¼š</strong></p>








































<table><thead><tr><th>åœºæ™¯</th><th>ConcurrentHashMap</th><th>Guava Cache</th></tr></thead><tbody><tr><td><strong>ç®€å•ç¼“å­˜ï¼Œæ‰‹åŠ¨æ§åˆ¶</strong></td><td>âœ… æ¨è</td><td>âŒ è¿‡åº¦è®¾è®¡</td></tr><tr><td><strong>éœ€è¦è‡ªåŠ¨è¿‡æœŸ</strong></td><td>âš ï¸ éœ€æ‰‹åŠ¨å®ç°</td><td>âœ… æ¨è</td></tr><tr><td><strong>éœ€è¦LRUæ·˜æ±°</strong></td><td>âŒ ä¸æ”¯æŒ</td><td>âœ… æ¨è</td></tr><tr><td><strong>éœ€è¦ç¼“å­˜ç»Ÿè®¡</strong></td><td>âŒ ä¸æ”¯æŒ</td><td>âœ… æ¨è</td></tr><tr><td><strong>æœ€å¤§å®¹é‡é™åˆ¶</strong></td><td>âš ï¸ éœ€æ‰‹åŠ¨å®ç°</td><td>âœ… æ¨è</td></tr><tr><td><strong>æ€§èƒ½è¦æ±‚æé«˜</strong></td><td>âœ… æ›´è½»é‡</td><td>âš ï¸ ç•¥é‡</td></tr></tbody></table>
<p><strong>æ¨èä½¿ç”¨Guava Cacheçš„æ”¹è¿›ç‰ˆæœ¬ï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductServiceWithGuava</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> LoadingCache&lt;Long, Category&gt; categoryCache = CacheBuilder.newBuilder()
        .maximumSize(<span class="hljs-number">1000</span>)  <span class="hljs-comment">// æœ€å¤§å®¹é‡</span>
        .expireAfterWrite(<span class="hljs-number">10</span>, TimeUnit.MINUTES)  <span class="hljs-comment">// å†™å…¥10åˆ†é’Ÿåè¿‡æœŸ</span>
        .recordStats()  <span class="hljs-comment">// è®°å½•ç»Ÿè®¡ä¿¡æ¯</span>
        .build(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CacheLoader</span>&lt;Long, Category&gt;() {
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> Category <span class="hljs-title function_">load</span><span class="hljs-params">(Long id)</span> {
                <span class="hljs-keyword">return</span> categoryMapper.selectById(id);
            }
        });

    <span class="hljs-keyword">public</span> Category <span class="hljs-title function_">getCategory</span><span class="hljs-params">(Long id)</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">return</span> categoryCache.get(id);
        } <span class="hljs-keyword">catch</span> (ExecutionException e) {
            log.error(<span class="hljs-string">"åŠ è½½ç¼“å­˜å¤±è´¥"</span>, e);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }
    }
}
</code></pre>
<h4 data-id="heading-27">3.1.5 æ€§èƒ½æµ‹è¯•æ•°æ®</h4>
<p><strong>æµ‹è¯•åœºæ™¯</strong>ï¼š100ä¸ªçº¿ç¨‹å¹¶å‘æŸ¥è¯¢1000ä¸ªå•†å“ç±»ç›®</p>





























<table><thead><tr><th>å®ç°</th><th>æ•°æ®åº“æŸ¥è¯¢æ¬¡æ•°</th><th>å¹³å‡å“åº”æ—¶é—´</th><th>QPS</th></tr></thead><tbody><tr><td><strong>æ— ç¼“å­˜</strong></td><td>100,000</td><td>50ms</td><td>2000</td></tr><tr><td><strong>ConcurrentHashMapç¼“å­˜</strong></td><td>1,000</td><td>0.5ms</td><td>200,000</td></tr><tr><td><strong>Guava Cache</strong></td><td>1,000</td><td>0.6ms</td><td>166,667</td></tr></tbody></table>
<p><strong>ç»“è®º</strong>ï¼šæœ¬åœ°ç¼“å­˜æ€§èƒ½æå‡<strong>100å€</strong>ï¼Œæ•°æ®åº“å‹åŠ›é™ä½<strong>99%</strong></p>
<hr/>
<h3 data-id="heading-28">3.2 åœºæ™¯2ï¼šç»Ÿè®¡åœ¨çº¿ç”¨æˆ·æ•°</h3>
<h4 data-id="heading-29">3.2.1 ä¸šåŠ¡èƒŒæ™¯</h4>
<p>éœ€è¦å®æ—¶ç»Ÿè®¡å½“å‰åœ¨çº¿ç”¨æˆ·æ•°ï¼Œç”¨æˆ·ç™»å½•æ—¶æ·»åŠ ï¼Œé€€å‡ºæˆ–è¶…æ—¶æ—¶ç§»é™¤ã€‚</p>
<h4 data-id="heading-30">3.2.2 é”™è¯¯æ–¹æ¡ˆï¼šAtomicLong</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// âŒ é”™è¯¯æ–¹æ¡ˆ</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OnlineUserCounter</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">AtomicLong</span> <span class="hljs-variable">onlineCount</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicLong</span>(<span class="hljs-number">0</span>);

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">userLogin</span><span class="hljs-params">(Long userId)</span> {
        onlineCount.incrementAndGet();
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">userLogout</span><span class="hljs-params">(Long userId)</span> {
        onlineCount.decrementAndGet();
    }

    <span class="hljs-keyword">public</span> <span class="hljs-type">long</span> <span class="hljs-title function_">getOnlineCount</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> onlineCount.get();
    }
}
</code></pre>
<p><strong>é—®é¢˜</strong>ï¼š</p>
<ol>
<li>âŒ æ— æ³•åˆ¤æ–­ç”¨æˆ·æ˜¯å¦çœŸçš„åœ¨çº¿ï¼ˆé‡å¤ç™»å½•ä¼šé‡å¤è®¡æ•°ï¼‰</li>
<li>âŒ æ— æ³•è·å–åœ¨çº¿ç”¨æˆ·åˆ—è¡¨</li>
<li>âŒ æ— æ³•åŒºåˆ†ç”¨æˆ·ç™»å½•å’Œé€€å‡º</li>
</ol>
<h4 data-id="heading-31">3.2.3 æ­£ç¡®æ–¹æ¡ˆï¼šConcurrentHashMap</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.util.concurrent.*;
<span class="hljs-keyword">import</span> java.time.LocalDateTime;
<span class="hljs-keyword">import</span> lombok.Data;

<span class="hljs-comment">/**
 * åœ¨çº¿ç”¨æˆ·ç®¡ç†
 */</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OnlineUserManager</span> {
    <span class="hljs-comment">// åœ¨çº¿ç”¨æˆ·Map: userId -&gt; Session</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ConcurrentHashMap&lt;Long, UserSession&gt; onlineUsers =
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;(<span class="hljs-number">10000</span>);

    <span class="hljs-comment">// å®šæ—¶æ¸…ç†è¶…æ—¶ç”¨æˆ·</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ScheduledExecutorService</span> <span class="hljs-variable">scheduler</span> <span class="hljs-operator">=</span>
        Executors.newScheduledThreadPool(<span class="hljs-number">1</span>);

    <span class="hljs-comment">// è¶…æ—¶æ—¶é—´ï¼ˆ30åˆ†é’Ÿï¼‰</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">TIMEOUT_MILLIS</span> <span class="hljs-operator">=</span> <span class="hljs-number">30</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>;

    <span class="hljs-meta">@Data</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserSession</span> {
        <span class="hljs-keyword">private</span> Long userId;
        <span class="hljs-keyword">private</span> String sessionId;
        <span class="hljs-keyword">private</span> String ip;
        <span class="hljs-keyword">private</span> LocalDateTime loginTime;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> <span class="hljs-type">long</span> lastActiveTime;  <span class="hljs-comment">// volatileä¿è¯å¯è§æ€§</span>

        <span class="hljs-keyword">public</span> <span class="hljs-title function_">UserSession</span><span class="hljs-params">(Long userId, String sessionId, String ip)</span> {
            <span class="hljs-built_in">this</span>.userId = userId;
            <span class="hljs-built_in">this</span>.sessionId = sessionId;
            <span class="hljs-built_in">this</span>.ip = ip;
            <span class="hljs-built_in">this</span>.loginTime = LocalDateTime.now();
            <span class="hljs-built_in">this</span>.lastActiveTime = System.currentTimeMillis();
        }

        <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isTimeout</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">return</span> System.currentTimeMillis() - lastActiveTime &gt; TIMEOUT_MILLIS;
        }

        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateActiveTime</span><span class="hljs-params">()</span> {
            <span class="hljs-built_in">this</span>.lastActiveTime = System.currentTimeMillis();
        }
    }

    <span class="hljs-meta">@PostConstruct</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// å¯åŠ¨å®šæœŸæ¸…ç†è¶…æ—¶ç”¨æˆ·</span>
        scheduler.scheduleAtFixedRate(() -&gt; {
            <span class="hljs-keyword">try</span> {
                cleanTimeoutUsers();
            } <span class="hljs-keyword">catch</span> (Exception e) {
                log.error(<span class="hljs-string">"æ¸…ç†è¶…æ—¶ç”¨æˆ·å¤±è´¥"</span>, e);
            }
        }, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, TimeUnit.MINUTES);
    }

    <span class="hljs-comment">/**
     * ç”¨æˆ·ç™»å½•
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">userLogin</span><span class="hljs-params">(Long userId, String sessionId, String ip)</span> {
        <span class="hljs-type">UserSession</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserSession</span>(userId, sessionId, ip);

        <span class="hljs-comment">// putIfAbsent: åªæœ‰ä¸å­˜åœ¨æ—¶æ‰æ·»åŠ </span>
        <span class="hljs-type">UserSession</span> <span class="hljs-variable">oldSession</span> <span class="hljs-operator">=</span> onlineUsers.putIfAbsent(userId, session);

        <span class="hljs-keyword">if</span> (oldSession != <span class="hljs-literal">null</span>) {
            <span class="hljs-comment">// ç”¨æˆ·å·²åœ¨çº¿ï¼Œæ›´æ–°sessionï¼ˆè¸¢å‡ºæ—§ç™»å½•ï¼‰</span>
            onlineUsers.put(userId, session);
            log.info(<span class="hljs-string">"ç”¨æˆ·é‡æ–°ç™»å½•: userId={}, oldSessionId={}, newSessionId={}"</span>,
                userId, oldSession.getSessionId(), sessionId);
        } <span class="hljs-keyword">else</span> {
            log.info(<span class="hljs-string">"ç”¨æˆ·ç™»å½•: userId={}, sessionId={}, onlineCount={}"</span>,
                userId, sessionId, onlineUsers.size());
        }
    }

    <span class="hljs-comment">/**
     * ç”¨æˆ·ç™»å‡º
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">userLogout</span><span class="hljs-params">(Long userId)</span> {
        <span class="hljs-type">UserSession</span> <span class="hljs-variable">removed</span> <span class="hljs-operator">=</span> onlineUsers.remove(userId);
        <span class="hljs-keyword">if</span> (removed != <span class="hljs-literal">null</span>) {
            log.info(<span class="hljs-string">"ç”¨æˆ·ç™»å‡º: userId={}, sessionId={}, onlineCount={}"</span>,
                userId, removed.getSessionId(), onlineUsers.size());
        }
    }

    <span class="hljs-comment">/**
     * æ›´æ–°ç”¨æˆ·æ´»è·ƒæ—¶é—´ï¼ˆå¿ƒè·³ï¼‰
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateUserActiveTime</span><span class="hljs-params">(Long userId)</span> {
        <span class="hljs-type">UserSession</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> onlineUsers.get(userId);
        <span class="hljs-keyword">if</span> (session != <span class="hljs-literal">null</span>) {
            session.updateActiveTime();
        }
    }

    <span class="hljs-comment">/**
     * åˆ¤æ–­ç”¨æˆ·æ˜¯å¦åœ¨çº¿
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isOnline</span><span class="hljs-params">(Long userId)</span> {
        <span class="hljs-keyword">return</span> onlineUsers.containsKey(userId);
    }

    <span class="hljs-comment">/**
     * è·å–åœ¨çº¿ç”¨æˆ·æ•°
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getOnlineCount</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> onlineUsers.size();
    }

    <span class="hljs-comment">/**
     * è·å–æ‰€æœ‰åœ¨çº¿ç”¨æˆ·
     */</span>
    <span class="hljs-keyword">public</span> List&lt;UserSession&gt; <span class="hljs-title function_">getOnlineUsers</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(onlineUsers.values());
    }

    <span class="hljs-comment">/**
     * æ¸…ç†è¶…æ—¶ç”¨æˆ·
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">cleanTimeoutUsers</span><span class="hljs-params">()</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">cleanCount</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;

        <span class="hljs-keyword">for</span> (Long userId : onlineUsers.keySet()) {
            <span class="hljs-type">UserSession</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> onlineUsers.get(userId);

            <span class="hljs-keyword">if</span> (session != <span class="hljs-literal">null</span> &amp;&amp; session.isTimeout()) {
                <span class="hljs-comment">// è¶…æ—¶ï¼Œç§»é™¤ç”¨æˆ·</span>
                <span class="hljs-keyword">if</span> (onlineUsers.remove(userId, session)) {  <span class="hljs-comment">// CASåˆ é™¤</span>
                    cleanCount++;
                    log.info(<span class="hljs-string">"æ¸…ç†è¶…æ—¶ç”¨æˆ·: userId={}, sessionId={}"</span>,
                        userId, session.getSessionId());
                }
            }
        }

        <span class="hljs-keyword">if</span> (cleanCount &gt; <span class="hljs-number">0</span>) {
            log.info(<span class="hljs-string">"æ¸…ç†è¶…æ—¶ç”¨æˆ·å®Œæˆ: cleanCount={}, onlineCount={}"</span>,
                cleanCount, onlineUsers.size());
        }
    }

    <span class="hljs-comment">/**
     * è·å–ç”¨æˆ·åœ¨çº¿æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">long</span> <span class="hljs-title function_">getOnlineDuration</span><span class="hljs-params">(Long userId)</span> {
        <span class="hljs-type">UserSession</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> onlineUsers.get(userId);
        <span class="hljs-keyword">if</span> (session == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
        }

        <span class="hljs-type">long</span> <span class="hljs-variable">duration</span> <span class="hljs-operator">=</span> System.currentTimeMillis() -
            session.getLoginTime().atZone(ZoneId.systemDefault())
                .toInstant().toEpochMilli();
        <span class="hljs-keyword">return</span> duration / <span class="hljs-number">60000</span>;
    }

    <span class="hljs-meta">@PreDestroy</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">destroy</span><span class="hljs-params">()</span> {
        scheduler.shutdown();
        onlineUsers.clear();
    }
}
</code></pre>
<h4 data-id="heading-32">3.2.4 ä½¿ç”¨ç¤ºä¾‹</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("/api/user")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> {
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> OnlineUserManager onlineUserManager;

    <span class="hljs-comment">/**
     * ç”¨æˆ·ç™»å½•
     */</span>
    <span class="hljs-meta">@PostMapping("/login")</span>
    <span class="hljs-keyword">public</span> Response&lt;Void&gt; <span class="hljs-title function_">login</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> LoginRequest request,
                                HttpServletRequest httpRequest)</span> {
        <span class="hljs-comment">// éªŒè¯ç”¨æˆ·åå¯†ç ...</span>
        <span class="hljs-type">Long</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> authenticate(request);

        <span class="hljs-comment">// æ·»åŠ åˆ°åœ¨çº¿ç”¨æˆ·</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">sessionId</span> <span class="hljs-operator">=</span> httpRequest.getSession().getId();
        <span class="hljs-type">String</span> <span class="hljs-variable">ip</span> <span class="hljs-operator">=</span> httpRequest.getRemoteAddr();
        onlineUserManager.userLogin(userId, sessionId, ip);

        <span class="hljs-keyword">return</span> Response.success();
    }

    <span class="hljs-comment">/**
     * ç”¨æˆ·ç™»å‡º
     */</span>
    <span class="hljs-meta">@PostMapping("/logout")</span>
    <span class="hljs-keyword">public</span> Response&lt;Void&gt; <span class="hljs-title function_">logout</span><span class="hljs-params">(<span class="hljs-meta">@RequestHeader("userId")</span> Long userId)</span> {
        onlineUserManager.userLogout(userId);
        <span class="hljs-keyword">return</span> Response.success();
    }

    <span class="hljs-comment">/**
     * å¿ƒè·³æ¥å£ï¼ˆå®šæœŸè°ƒç”¨ï¼Œå¦‚æ¯5åˆ†é’Ÿï¼‰
     */</span>
    <span class="hljs-meta">@PostMapping("/heartbeat")</span>
    <span class="hljs-keyword">public</span> Response&lt;Void&gt; <span class="hljs-title function_">heartbeat</span><span class="hljs-params">(<span class="hljs-meta">@RequestHeader("userId")</span> Long userId)</span> {
        onlineUserManager.updateUserActiveTime(userId);
        <span class="hljs-keyword">return</span> Response.success();
    }

    <span class="hljs-comment">/**
     * è·å–åœ¨çº¿ç”¨æˆ·æ•°
     */</span>
    <span class="hljs-meta">@GetMapping("/online-count")</span>
    <span class="hljs-keyword">public</span> Response&lt;Integer&gt; <span class="hljs-title function_">getOnlineCount</span><span class="hljs-params">()</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> onlineUserManager.getOnlineCount();
        <span class="hljs-keyword">return</span> Response.success(count);
    }

    <span class="hljs-comment">/**
     * è·å–åœ¨çº¿ç”¨æˆ·åˆ—è¡¨ï¼ˆç®¡ç†å‘˜ï¼‰
     */</span>
    <span class="hljs-meta">@GetMapping("/online-users")</span>
    <span class="hljs-keyword">public</span> Response&lt;List&lt;UserSession&gt;&gt; <span class="hljs-title function_">getOnlineUsers</span><span class="hljs-params">()</span> {
        List&lt;UserSession&gt; users = onlineUserManager.getOnlineUsers();
        <span class="hljs-keyword">return</span> Response.success(users);
    }
}
</code></pre>
<h4 data-id="heading-33">3.2.5 æ€§èƒ½å¯¹æ¯”</h4>
<p><strong>æµ‹è¯•åœºæ™¯</strong>ï¼š10000ä¸ªç”¨æˆ·å¹¶å‘ç™»å½•/ç™»å‡º</p>



































<table><thead><tr><th>æŒ‡æ ‡</th><th>AtomicLongæ–¹æ¡ˆ</th><th>ConcurrentHashMapæ–¹æ¡ˆ</th></tr></thead><tbody><tr><td><strong>å‡†ç¡®æ€§</strong></td><td>âŒ ä¸å‡†ç¡®ï¼ˆé‡å¤è®¡æ•°ï¼‰</td><td>âœ… å‡†ç¡®</td></tr><tr><td><strong>åŠŸèƒ½æ€§</strong></td><td>âŒ åªèƒ½è®¡æ•°</td><td>âœ… å¯æŸ¥è¯¢ç”¨æˆ·ã€åˆ¤æ–­åœ¨çº¿ã€è¶…æ—¶æ¸…ç†</td></tr><tr><td><strong>ç™»å½•è€—æ—¶</strong></td><td>0.01ms</td><td>0.05ms</td></tr><tr><td><strong>æŸ¥è¯¢è€—æ—¶</strong></td><td>0.001ms</td><td>0.01ms</td></tr><tr><td><strong>å†…å­˜å ç”¨</strong></td><td>8 bytes</td><td>~10MBï¼ˆ1ä¸‡ç”¨æˆ·ï¼‰</td></tr></tbody></table>
<p><strong>ç»“è®º</strong>ï¼šConcurrentHashMapåŠŸèƒ½æ›´å¼ºå¤§ï¼Œæ€§èƒ½æŸå¤±å¯æ¥å—</p>
<hr/>
<h2 data-id="heading-34">å››ã€ç”Ÿäº§æ¡ˆä¾‹ä¸æ•…éšœæ’æŸ¥</h2>
<h3 data-id="heading-35">4.1 æ¡ˆä¾‹1ï¼šæœ¬åœ°ç¼“å­˜æœªè®¾ä¸Šé™å¯¼è‡´OOM</h3>
<h4 data-id="heading-36">4.1.1 æ•…éšœç°è±¡</h4>
<p>æŸç”µå•†å¹³å°å•†å“æœåŠ¡åœ¨è¿è¡Œä¸€å‘¨åçªç„¶å‡ºç°ï¼š</p>
<ul>
<li>Javaè¿›ç¨‹OOM: <code>java.lang.OutOfMemoryError: Java heap space</code></li>
<li>é¢‘ç¹Full GCï¼Œæ¯æ¬¡GCåè€å¹´ä»£å›æ”¶å¾ˆå°‘</li>
<li>æœåŠ¡å“åº”å˜æ…¢ï¼Œæœ€ç»ˆä¸å¯ç”¨</li>
</ul>
<h4 data-id="heading-37">4.1.2 æ’æŸ¥è¿‡ç¨‹</h4>
<p><strong>Step 1: è·å–å †dump</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. æ‰¾åˆ°è¿›ç¨‹ID</span>
jps -l

<span class="hljs-comment"># 2. ç”Ÿæˆå †dump</span>
jmap -dump:live,format=b,file=heap.hprof &lt;pid&gt;

<span class="hljs-comment"># 3. ä½¿ç”¨MATåˆ†æ</span>
<span class="hljs-comment"># Eclipse Memory Analyzer Tool</span>
</code></pre>
<p><strong>Step 2: MATåˆ†æ</strong></p>
<p>æ‰“å¼€<code>heap.hprof</code>ï¼ŒæŸ¥çœ‹Dominator Treeï¼š</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section">Class Name                           Objects   Shallow Heap   Retained Heap
-----------------------------------------------------------------------------</span>
ConcurrentHashMap                        1         48 bytes    3.2 GB !!!
  |- Node[]                              1       800 MB        3.2 GB
<span class="hljs-code">      |- Product (è‡ªå®šä¹‰ç±»)          500,000     80 MB         2.4 GB
</span></code></pre>
<p>å‘ç°ï¼š</p>
<ul>
<li><code>ConcurrentHashMap</code>å ç”¨<strong>3.2GB</strong>å†…å­˜</li>
<li>å­˜å‚¨äº†<strong>50ä¸‡ä¸ª</strong>Productå¯¹è±¡</li>
<li>å ç”¨äº†å †å†…å­˜çš„<strong>80%</strong></li>
</ul>
<p><strong>Step 3: æŸ¥çœ‹ä»£ç </strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// é—®é¢˜ä»£ç </span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductService</span> {
    <span class="hljs-comment">// âŒ æ²¡æœ‰å®¹é‡é™åˆ¶çš„ç¼“å­˜</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ConcurrentHashMap&lt;Long, Product&gt; productCache =
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();

    <span class="hljs-keyword">public</span> Product <span class="hljs-title function_">getProduct</span><span class="hljs-params">(Long productId)</span> {
        <span class="hljs-type">Product</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> productCache.get(productId);
        <span class="hljs-keyword">if</span> (product == <span class="hljs-literal">null</span>) {
            product = productMapper.selectById(productId);
            <span class="hljs-comment">// âŒ åªputä¸removeï¼ŒæŒç»­å¢é•¿</span>
            productCache.put(productId, product);
        }
        <span class="hljs-keyword">return</span> product;
    }
}
</code></pre>
<h4 data-id="heading-38">4.1.3 é—®é¢˜åˆ†æ</h4>
<p><strong>æ ¹æœ¬åŸå› ï¼š</strong></p>
<ol>
<li>âŒ <strong>åªputä¸remove</strong>ï¼šæ¯æ¬¡æŸ¥è¯¢æ–°å•†å“éƒ½ä¼šç¼“å­˜ï¼Œä»ä¸åˆ é™¤</li>
<li>âŒ <strong>æ²¡æœ‰è¿‡æœŸç­–ç•¥</strong>ï¼šæ—§æ•°æ®æ°¸è¿œä¸ä¼šè¿‡æœŸ</li>
<li>âŒ <strong>æ²¡æœ‰å®¹é‡é™åˆ¶</strong>ï¼šç¼“å­˜æ— é™å¢é•¿</li>
</ol>
<p><strong>å¢é•¿è¶‹åŠ¿ï¼š</strong></p>
<ul>
<li>å•†å“æ€»æ•°ï¼š100ä¸‡</li>
<li>æ¯å¤©è®¿é—®ä¸åŒå•†å“ï¼š5ä¸‡</li>
<li>7å¤©åç¼“å­˜å•†å“æ•°ï¼š35ä¸‡</li>
<li>æŒ‰æ¯ä¸ªProduct 5KBè®¡ç®—ï¼š35ä¸‡ * 5KB = 1.75GB</li>
</ul>
<h4 data-id="heading-39">4.1.4 è§£å†³æ–¹æ¡ˆ</h4>
<p><strong>æ–¹æ¡ˆAï¼šä½¿ç”¨Guava Cacheï¼ˆæ¨èï¼‰</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductService</span> {
    <span class="hljs-comment">// âœ… ä½¿ç”¨Guava Cacheï¼Œè‡ªåŠ¨è¿‡æœŸå’Œå®¹é‡é™åˆ¶</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> LoadingCache&lt;Long, Product&gt; productCache = CacheBuilder.newBuilder()
        .maximumSize(<span class="hljs-number">10000</span>)  <span class="hljs-comment">// æœ€å¤§ç¼“å­˜10000ä¸ªå•†å“</span>
        .expireAfterWrite(<span class="hljs-number">1</span>, TimeUnit.HOURS)  <span class="hljs-comment">// 1å°æ—¶åè¿‡æœŸ</span>
        .recordStats()  <span class="hljs-comment">// è®°å½•ç¼“å­˜ç»Ÿè®¡</span>
        .build(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CacheLoader</span>&lt;Long, Product&gt;() {
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> Product <span class="hljs-title function_">load</span><span class="hljs-params">(Long id)</span> {
                <span class="hljs-keyword">return</span> productMapper.selectById(id);
            }
        });

    <span class="hljs-keyword">public</span> Product <span class="hljs-title function_">getProduct</span><span class="hljs-params">(Long productId)</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">return</span> productCache.get(productId);
        } <span class="hljs-keyword">catch</span> (ExecutionException e) {
            log.error(<span class="hljs-string">"åŠ è½½å•†å“ç¼“å­˜å¤±è´¥: productId={}"</span>, productId, e);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }
    }

    <span class="hljs-comment">// æŸ¥çœ‹ç¼“å­˜ç»Ÿè®¡</span>
    <span class="hljs-meta">@Scheduled(fixedRate = 60000)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">logCacheStats</span><span class="hljs-params">()</span> {
        <span class="hljs-type">CacheStats</span> <span class="hljs-variable">stats</span> <span class="hljs-operator">=</span> productCache.stats();
        log.info(<span class="hljs-string">"å•†å“ç¼“å­˜ç»Ÿè®¡: hitRate={}, size={}, evictionCount={}"</span>,
            stats.hitRate(), productCache.size(), stats.evictionCount());
    }
}
</code></pre>
<p><strong>æ–¹æ¡ˆBï¼šConcurrentHashMap + å®šæœŸæ¸…ç† + LRU</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductServiceWithLRU</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">MAX_SIZE</span> <span class="hljs-operator">=</span> <span class="hljs-number">10000</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">EXPIRE_TIME</span> <span class="hljs-operator">=</span> <span class="hljs-number">60</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>;  <span class="hljs-comment">// 1å°æ—¶</span>

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ConcurrentHashMap&lt;Long, CacheEntry&lt;Product&gt;&gt; productCache =
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();

    <span class="hljs-comment">// LRUé˜Ÿåˆ—ï¼ˆè®¿é—®é¡ºåºï¼‰</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ConcurrentLinkedDeque&lt;Long&gt; lruQueue =
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentLinkedDeque</span>&lt;&gt;();

    <span class="hljs-meta">@Data</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CacheEntry</span>&lt;T&gt; {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> T value;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> createTime;

        <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isExpired</span><span class="hljs-params">(<span class="hljs-type">long</span> expireTime)</span> {
            <span class="hljs-keyword">return</span> System.currentTimeMillis() - createTime &gt; expireTime;
        }
    }

    <span class="hljs-keyword">public</span> Product <span class="hljs-title function_">getProduct</span><span class="hljs-params">(Long productId)</span> {
        CacheEntry&lt;Product&gt; entry = productCache.get(productId);

        <span class="hljs-comment">// ç¼“å­˜å‘½ä¸­ä¸”æœªè¿‡æœŸ</span>
        <span class="hljs-keyword">if</span> (entry != <span class="hljs-literal">null</span> &amp;&amp; !entry.isExpired(EXPIRE_TIME)) {
            <span class="hljs-comment">// æ›´æ–°LRU</span>
            lruQueue.remove(productId);
            lruQueue.offerLast(productId);
            <span class="hljs-keyword">return</span> entry.getValue();
        }

        <span class="hljs-comment">// ç¼“å­˜ä¸å­˜åœ¨æˆ–å·²è¿‡æœŸï¼ŒåŠ è½½æ•°æ®</span>
        <span class="hljs-type">Product</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> productMapper.selectById(productId);
        <span class="hljs-keyword">if</span> (product != <span class="hljs-literal">null</span>) {
            put(productId, product);
        }

        <span class="hljs-keyword">return</span> product;
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">put</span><span class="hljs-params">(Long key, Product value)</span> {
        <span class="hljs-comment">// å®¹é‡æ£€æŸ¥ï¼Œè¶…è¿‡åˆ™ç§»é™¤æœ€ä¹…æœªä½¿ç”¨çš„</span>
        <span class="hljs-keyword">if</span> (productCache.size() &gt;= MAX_SIZE) {
            <span class="hljs-type">Long</span> <span class="hljs-variable">oldest</span> <span class="hljs-operator">=</span> lruQueue.pollFirst();
            <span class="hljs-keyword">if</span> (oldest != <span class="hljs-literal">null</span>) {
                productCache.remove(oldest);
            }
        }

        productCache.put(key, <span class="hljs-keyword">new</span> <span class="hljs-title class_">CacheEntry</span>&lt;&gt;(value, System.currentTimeMillis()));
        lruQueue.offerLast(key);
    }

    <span class="hljs-comment">// å®šæœŸæ¸…ç†è¿‡æœŸæ•°æ®</span>
    <span class="hljs-meta">@Scheduled(fixedRate = 60000)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">cleanExpired</span><span class="hljs-params">()</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">cleanCount</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
        <span class="hljs-keyword">for</span> (Long key : productCache.keySet()) {
            CacheEntry&lt;Product&gt; entry = productCache.get(key);
            <span class="hljs-keyword">if</span> (entry != <span class="hljs-literal">null</span> &amp;&amp; entry.isExpired(EXPIRE_TIME)) {
                productCache.remove(key);
                lruQueue.remove(key);
                cleanCount++;
            }
        }
        <span class="hljs-keyword">if</span> (cleanCount &gt; <span class="hljs-number">0</span>) {
            log.info(<span class="hljs-string">"æ¸…ç†è¿‡æœŸç¼“å­˜: count={}, size={}"</span>, cleanCount, productCache.size());
        }
    }
}
</code></pre>
<p><strong>æ–¹æ¡ˆCï¼šé™åˆ¶æœ€å¤§å®¹é‡ï¼ˆç®€å•ç‰ˆï¼‰</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductServiceSimple</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">MAX_SIZE</span> <span class="hljs-operator">=</span> <span class="hljs-number">10000</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ConcurrentHashMap&lt;Long, Product&gt; productCache =
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();

    <span class="hljs-keyword">public</span> Product <span class="hljs-title function_">getProduct</span><span class="hljs-params">(Long productId)</span> {
        <span class="hljs-keyword">return</span> productCache.computeIfAbsent(productId, id -&gt; {
            <span class="hljs-comment">// å®¹é‡æ£€æŸ¥</span>
            <span class="hljs-keyword">if</span> (productCache.size() &gt;= MAX_SIZE) {
                log.warn(<span class="hljs-string">"ç¼“å­˜å·²æ»¡ï¼Œæ‹’ç»æ–°å¢: size={}"</span>, productCache.size());
                <span class="hljs-keyword">return</span> productMapper.selectById(id);  <span class="hljs-comment">// ä¸ç¼“å­˜ï¼Œç›´æ¥è¿”å›</span>
            }

            <span class="hljs-keyword">return</span> productMapper.selectById(id);
        });
    }
}
</code></pre>
<h4 data-id="heading-40">4.1.5 æœ€ä½³å®è·µ</h4>
<p><strong>æœ¬åœ°ç¼“å­˜ä½¿ç”¨è§„èŒƒï¼š</strong></p>
<ol>
<li>âœ… <strong>å¿…é¡»è®¾ç½®å®¹é‡ä¸Šé™</strong>ï¼ˆmaximumSizeï¼‰</li>
<li>âœ… <strong>å¿…é¡»è®¾ç½®è¿‡æœŸæ—¶é—´</strong>ï¼ˆexpireAfterWrite/expireAfterAccessï¼‰</li>
<li>âœ… <strong>ä¼˜å…ˆä½¿ç”¨Guava Cache</strong>ï¼Œè€Œéè£¸ç”¨ConcurrentHashMap</li>
<li>âœ… <strong>å®šæœŸæ¸…ç†è¿‡æœŸæ•°æ®</strong></li>
<li>âœ… <strong>ç›‘æ§ç¼“å­˜å‘½ä¸­ç‡</strong>å’Œå®¹é‡</li>
<li>âœ… <strong>å‹æµ‹éªŒè¯å†…å­˜å ç”¨</strong></li>
</ol>
<hr/>
<h3 data-id="heading-41">4.2 æ¡ˆä¾‹2ï¼šConcurrentHashMapçš„size()æ–¹æ³•æ€§èƒ½é—®é¢˜</h3>
<h4 data-id="heading-42">4.2.1 ä¸šåŠ¡åœºæ™¯</h4>
<p>æŸç›‘æ§ç³»ç»Ÿéœ€è¦é¢‘ç¹è°ƒç”¨<code>size()</code>ç»Ÿè®¡ç¼“å­˜å¤§å°ï¼Œç”¨äºå‘Šè­¦ï¼š</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Scheduled(fixedRate = 1000)</span>  <span class="hljs-comment">// æ¯ç§’æ‰§è¡Œä¸€æ¬¡</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">monitorCacheSize</span><span class="hljs-params">()</span> {
    <span class="hljs-type">int</span> <span class="hljs-variable">size</span> <span class="hljs-operator">=</span> cache.size();
    <span class="hljs-keyword">if</span> (size &gt; <span class="hljs-number">100000</span>) {
        alertService.send(<span class="hljs-string">"ç¼“å­˜å®¹é‡å‘Šè­¦: "</span> + size);
    }
}
</code></pre>
<h4 data-id="heading-43">4.2.2 æ€§èƒ½é—®é¢˜</h4>
<p><strong>é—®é¢˜åˆ†æï¼š</strong></p>
<p><code>ConcurrentHashMap</code>çš„<code>size()</code>æ–¹æ³•éœ€è¦éå†<strong>æ‰€æœ‰Node</strong>è¿›è¡Œç´¯åŠ ï¼š</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">size</span><span class="hljs-params">()</span> {
    <span class="hljs-type">long</span> <span class="hljs-variable">n</span> <span class="hljs-operator">=</span> sumCount();
    <span class="hljs-keyword">return</span> ((n &lt; <span class="hljs-number">0L</span>) ? <span class="hljs-number">0</span> :
            (n &gt; (<span class="hljs-type">long</span>)Integer.MAX_VALUE) ? Integer.MAX_VALUE :
            (<span class="hljs-type">int</span>)n);
}

<span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-title function_">sumCount</span><span class="hljs-params">()</span> {
    CounterCell[] as = counterCells; CounterCell a;
    <span class="hljs-type">long</span> <span class="hljs-variable">sum</span> <span class="hljs-operator">=</span> baseCount;
    <span class="hljs-keyword">if</span> (as != <span class="hljs-literal">null</span>) {
        <span class="hljs-comment">// éå†æ‰€æœ‰CounterCellç´¯åŠ </span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; as.length; ++i) {
            <span class="hljs-keyword">if</span> ((a = as[i]) != <span class="hljs-literal">null</span>)
                sum += a.value;
        }
    }
    <span class="hljs-keyword">return</span> sum;
}
</code></pre>
<p>è™½ç„¶JDK 1.8ä½¿ç”¨<code>CounterCell</code>æ•°ç»„åˆ†æ®µè®¡æ•°ï¼Œä½†ä»éœ€<strong>éå†æ•°ç»„</strong>ï¼Œæ•°æ®é‡å¤§æ—¶æœ‰æ€§èƒ½å¼€é”€ã€‚</p>
<p><strong>æ€§èƒ½æµ‹è¯•ï¼š</strong></p>






























<table><thead><tr><th>ç¼“å­˜å¤§å°</th><th>size()è€—æ—¶</th><th>æ¯ç§’è°ƒç”¨1000æ¬¡å½±å“</th></tr></thead><tbody><tr><td>1ä¸‡</td><td>0.01ms</td><td>å¯å¿½ç•¥</td></tr><tr><td>10ä¸‡</td><td>0.05ms</td><td>50ms/s</td></tr><tr><td>100ä¸‡</td><td>0.2ms</td><td>200ms/s</td></tr><tr><td>1000ä¸‡</td><td>1ms</td><td>1000ms/sï¼ˆ1ç§’ï¼‰</td></tr></tbody></table>
<p>å½“ç¼“å­˜è¾¾åˆ°<strong>ç™¾ä¸‡çº§</strong>æ—¶ï¼Œé¢‘ç¹è°ƒç”¨<code>size()</code>ä¼šæ˜¾è‘—å½±å“æ€§èƒ½ã€‚</p>
<h4 data-id="heading-44">4.2.3 è§£å†³æ–¹æ¡ˆ</h4>
<p><strong>ä½¿ç”¨AtomicLongå•ç‹¬è®¡æ•°</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MonitoredCache</span>&lt;K, V&gt; {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ConcurrentHashMap&lt;K, V&gt; cache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();

    <span class="hljs-comment">// âœ… å•ç‹¬ç»´æŠ¤è®¡æ•°å™¨</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">AtomicLong</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicLong</span>(<span class="hljs-number">0</span>);

    <span class="hljs-keyword">public</span> V <span class="hljs-title function_">put</span><span class="hljs-params">(K key, V value)</span> {
        <span class="hljs-type">V</span> <span class="hljs-variable">oldValue</span> <span class="hljs-operator">=</span> cache.put(key, value);
        <span class="hljs-keyword">if</span> (oldValue == <span class="hljs-literal">null</span>) {
            count.incrementAndGet();  <span class="hljs-comment">// æ–°å¢</span>
        }
        <span class="hljs-keyword">return</span> oldValue;
    }

    <span class="hljs-keyword">public</span> V <span class="hljs-title function_">putIfAbsent</span><span class="hljs-params">(K key, V value)</span> {
        <span class="hljs-type">V</span> <span class="hljs-variable">oldValue</span> <span class="hljs-operator">=</span> cache.putIfAbsent(key, value);
        <span class="hljs-keyword">if</span> (oldValue == <span class="hljs-literal">null</span>) {
            count.incrementAndGet();  <span class="hljs-comment">// æ–°å¢</span>
        }
        <span class="hljs-keyword">return</span> oldValue;
    }

    <span class="hljs-keyword">public</span> V <span class="hljs-title function_">remove</span><span class="hljs-params">(K key)</span> {
        <span class="hljs-type">V</span> <span class="hljs-variable">removed</span> <span class="hljs-operator">=</span> cache.remove(key);
        <span class="hljs-keyword">if</span> (removed != <span class="hljs-literal">null</span>) {
            count.decrementAndGet();  <span class="hljs-comment">// åˆ é™¤</span>
        }
        <span class="hljs-keyword">return</span> removed;
    }

    <span class="hljs-keyword">public</span> V <span class="hljs-title function_">get</span><span class="hljs-params">(K key)</span> {
        <span class="hljs-keyword">return</span> cache.get(key);
    }

    <span class="hljs-comment">/**
     * å¿«é€Ÿè·å–å¤§å°ï¼ˆO(1)ï¼‰
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">long</span> <span class="hljs-title function_">size</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> count.get();
    }

    <span class="hljs-comment">/**
     * ç²¾ç¡®å¤§å°ï¼ˆéœ€è¦æ—¶è°ƒç”¨ï¼‰
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">actualSize</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> cache.size();
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">clear</span><span class="hljs-params">()</span> {
        cache.clear();
        count.set(<span class="hljs-number">0</span>);
    }
}
</code></pre>
<h4 data-id="heading-45">4.2.4 æ€§èƒ½å¯¹æ¯”</h4>























<table><thead><tr><th>æ–¹æ¡ˆ</th><th>è·å–å¤§å°è€—æ—¶</th><th>100ä¸‡æ•°æ®</th><th>1000ä¸‡æ•°æ®</th></tr></thead><tbody><tr><td><code>cache.size()</code></td><td>éå†ç´¯åŠ </td><td>0.2ms</td><td>1ms</td></tr><tr><td><code>count.get()</code></td><td><strong>O(1)</strong></td><td><strong>0.001ms</strong></td><td><strong>0.001ms</strong></td></tr></tbody></table>
<p><strong>æ€§èƒ½æå‡ï¼š200å€</strong></p>
<h4 data-id="heading-46">4.2.5 æ³¨æ„äº‹é¡¹</h4>
<p><strong>ä¸ºä»€ä¹ˆä¸èƒ½å®Œå…¨æ›¿ä»£size()ï¼Ÿ</strong></p>
<ul>
<li><code>AtomicLong</code>è®¡æ•°å¯èƒ½ä¸ç²¾ç¡®ï¼ˆå¹¶å‘removeæ—¶ï¼‰</li>
<li>éœ€è¦åœ¨æ‰€æœ‰ä¿®æ”¹æ–¹æ³•ä¸­åŒæ­¥æ›´æ–°è®¡æ•°</li>
<li>é€‚ç”¨äº<strong>è¯»å¤šå†™å°‘</strong>çš„åœºæ™¯</li>
</ul>
<p><strong>æ¨èä½¿ç”¨åœºæ™¯ï¼š</strong></p>
<ul>
<li>âœ… ç›‘æ§å‘Šè­¦ï¼ˆå…è®¸è½»å¾®è¯¯å·®ï¼‰</li>
<li>âœ… ç»Ÿè®¡å¤§ç›˜æ•°æ®</li>
<li>âŒ éœ€è¦ç²¾ç¡®è®¡æ•°çš„ä¸šåŠ¡é€»è¾‘</li>
</ul>
<hr/>
<h2 data-id="heading-47">äº”ã€å¸¸è§é—®é¢˜ä¸é¿å‘æŒ‡å—</h2>
<h3 data-id="heading-48">5.1 ConcurrentHashMapä¸ºä»€ä¹ˆkeyå’Œvalueä¸å…è®¸nullï¼Ÿ</h3>
<p><strong>åŸå› ï¼šäºŒä¹‰æ€§é—®é¢˜</strong></p>
<p>åœ¨å¹¶å‘ç¯å¢ƒä¸‹ï¼Œå¦‚æœå…è®¸nullä¼šäº§ç”Ÿæ­§ä¹‰ï¼š</p>
<pre><code class="hljs language-java" lang="java">ConcurrentHashMap&lt;String, String&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();

<span class="hljs-comment">// å‡è®¾å…è®¸null value</span>
<span class="hljs-type">V</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> map.get(<span class="hljs-string">"key"</span>);
<span class="hljs-keyword">if</span> (value == <span class="hljs-literal">null</span>) {
    <span class="hljs-comment">// é—®é¢˜ï¼šæ— æ³•åŒºåˆ†ä»¥ä¸‹ä¸¤ç§æƒ…å†µ</span>
    <span class="hljs-comment">// 1. keyä¸å­˜åœ¨</span>
    <span class="hljs-comment">// 2. keyå­˜åœ¨ï¼Œä½†valueä¸ºnull</span>
}

<span class="hljs-comment">// HashMapå¯ä»¥ç”¨containsKey()åˆ¤æ–­ï¼Œä½†ConcurrentHashMapä¸è¡Œ</span>
<span class="hljs-keyword">if</span> (map.containsKey(<span class="hljs-string">"key"</span>)) {
    <span class="hljs-comment">// åœ¨containsKey()å’Œget()ä¹‹é—´ï¼Œå…¶ä»–çº¿ç¨‹å¯èƒ½removeäº†key</span>
    <span class="hljs-comment">// å¯¼è‡´åˆ¤æ–­å¤±æ•ˆ</span>
}
</code></pre>
<p><strong>HashMapä¸ºä»€ä¹ˆå¯ä»¥ï¼Ÿ</strong></p>
<ul>
<li>HashMapæ˜¯éçº¿ç¨‹å®‰å…¨çš„ï¼Œå•çº¿ç¨‹ç¯å¢ƒä¸‹å¯ä»¥ç”¨<code>containsKey()</code>å‡†ç¡®åˆ¤æ–­</li>
<li>ConcurrentHashMapåœ¨å¹¶å‘ç¯å¢ƒä¸‹ï¼Œ<code>containsKey()</code>å’Œ<code>get()</code>ä¹‹é—´çŠ¶æ€å¯èƒ½å˜åŒ–</li>
</ul>
<p><strong>æºç éªŒè¯ï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> V <span class="hljs-title function_">put</span><span class="hljs-params">(K key, V value)</span> {
    <span class="hljs-keyword">if</span> (key == <span class="hljs-literal">null</span> || value == <span class="hljs-literal">null</span>)
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NullPointerException</span>();  <span class="hljs-comment">// ç›´æ¥æŠ›å¼‚å¸¸</span>
    ...
}
</code></pre>
<hr/>
<h3 data-id="heading-49">5.2 ConcurrentHashMapæ˜¯å¼ºä¸€è‡´æ€§çš„å—ï¼Ÿ</h3>
<p><strong>ç­”æ¡ˆï¼šä¸æ˜¯ï¼Œæ˜¯å¼±ä¸€è‡´æ€§</strong></p>
<p><strong>å¼±ä¸€è‡´æ€§è¡¨ç°ï¼š</strong></p>
<ol>
<li>
<p><strong>size()æ–¹æ³•</strong>ï¼šè¿”å›çš„æ˜¯<strong>è¿‘ä¼¼å€¼</strong>ï¼Œå¯èƒ½ä¸å‡†ç¡®</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// çº¿ç¨‹1</span>
map.put(<span class="hljs-string">"k1"</span>, <span class="hljs-string">"v1"</span>);

<span class="hljs-comment">// çº¿ç¨‹2ï¼ˆåŒæ—¶ï¼‰</span>
<span class="hljs-type">int</span> <span class="hljs-variable">size</span> <span class="hljs-operator">=</span> map.size();  <span class="hljs-comment">// å¯èƒ½çœ‹ä¸åˆ°çº¿ç¨‹1çš„put</span>
</code></pre>
</li>
<li>
<p><strong>è¿­ä»£å™¨</strong>ï¼šè¿”å›çš„æ˜¯<strong>æŸä¸€æ—¶åˆ»çš„å¿«ç…§</strong>ï¼Œä¸ä¿è¯å®æ—¶æ€§</p>
<pre><code class="hljs language-java" lang="java">Iterator&lt;String&gt; it = map.keySet().iterator();
<span class="hljs-keyword">while</span> (it.hasNext()) {
    <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> it.next();
    <span class="hljs-comment">// è¿­ä»£è¿‡ç¨‹ä¸­ï¼Œå…¶ä»–çº¿ç¨‹çš„put/removeä¸ä¸€å®šèƒ½çœ‹åˆ°</span>
}
</code></pre>
</li>
<li>
<p><strong>èšåˆæ“ä½œ</strong>ï¼šå¦‚<code>putAll()</code>, <code>clear()</code>ï¼Œä¸æ˜¯åŸå­çš„</p>
<pre><code class="hljs language-java" lang="java">map.putAll(otherMap);  <span class="hljs-comment">// ä¸æ˜¯åŸå­æ“ä½œï¼Œä¸­é—´çŠ¶æ€å¯è§</span>
</code></pre>
</li>
</ol>
<p><strong>ä¸ºä»€ä¹ˆä¸æ˜¯å¼ºä¸€è‡´ï¼Ÿ</strong></p>
<ul>
<li><strong>æ€§èƒ½ä¼˜å…ˆ</strong>ï¼šå¼ºä¸€è‡´éœ€è¦å…¨å±€é”ï¼Œæ€§èƒ½æŸå¤±å¤§</li>
<li><strong>å®é™…éœ€æ±‚</strong>ï¼šå¤§å¤šæ•°åœºæ™¯ä¸‹å¼±ä¸€è‡´æ€§è¶³å¤Ÿ</li>
</ul>
<p><strong>éœ€è¦å¼ºä¸€è‡´æ€§æ€ä¹ˆåŠï¼Ÿ</strong></p>
<ul>
<li>ä½¿ç”¨<code>Collections.synchronizedMap()</code></li>
<li>æˆ–åœ¨å¤–éƒ¨åŠ é”</li>
</ul>
<hr/>
<h3 data-id="heading-50">5.3 ä¸ºä»€ä¹ˆé“¾è¡¨é•¿åº¦é˜ˆå€¼æ˜¯8ï¼Œæ ‘é€€åŒ–é˜ˆå€¼æ˜¯6ï¼Ÿ</h3>
<p><strong>æ ‘åŒ–é˜ˆå€¼ä¸º8çš„åŸå› ï¼š</strong></p>
<p>æ ¹æ®<strong>æ³Šæ¾åˆ†å¸ƒ</strong>ï¼Œhashç¢°æ’è¾¾åˆ°8ä¸ªèŠ‚ç‚¹çš„æ¦‚ç‡æä½ï¼š</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">0:    0.60653066</span>
<span class="hljs-section">1:    0.30326533</span>
<span class="hljs-section">2:    0.07581633</span>
<span class="hljs-section">3:    0.01263606</span>
<span class="hljs-section">4:    0.00157952</span>
<span class="hljs-section">5:    0.00015795</span>
<span class="hljs-section">6:    0.00001316</span>
<span class="hljs-section">7:    0.00000094</span>
<span class="hljs-section">8:    0.00000006  // åƒä¸‡åˆ†ä¹‹ä¸€</span>
</code></pre>
<p>å³ä½¿hashç®—æ³•ä¸€èˆ¬ï¼Œé“¾è¡¨é•¿åº¦ä¹Ÿå¾ˆéš¾è¾¾åˆ°8ï¼Œå› æ­¤8æ˜¯ä¸€ä¸ªåˆç†çš„é˜ˆå€¼ã€‚</p>
<p><strong>ä¸ºä»€ä¹ˆä¸æ˜¯7æˆ–9ï¼Ÿ</strong></p>
<ul>
<li><strong>æ€§èƒ½å¹³è¡¡</strong>ï¼šé“¾è¡¨éå†O(n)ï¼Œçº¢é»‘æ ‘O(logn)ï¼Œå½“n=8æ—¶æ€§èƒ½å·®å¼‚æ˜¾è‘—</li>
<li><strong>å†…å­˜å¼€é”€</strong>ï¼šTreeNodeå ç”¨ç©ºé—´æ˜¯Nodeçš„<strong>2å€</strong>ï¼Œè¿‡æ—©æ ‘åŒ–æµªè´¹å†…å­˜</li>
</ul>
<p><strong>æ ‘é€€åŒ–é˜ˆå€¼ä¸º6çš„åŸå› ï¼š</strong></p>
<p><strong>é˜²æ­¢é¢‘ç¹æ ‘åŒ–/é€€åŒ–</strong>ï¼š</p>
<ul>
<li>å¦‚æœé˜ˆå€¼éƒ½æ˜¯8ï¼Œåœ¨7-8ä¹‹é—´åå¤å¢åˆ ä¼šå¯¼è‡´é¢‘ç¹æ ‘åŒ–å’Œé€€åŒ–</li>
<li>è®¾ç½®ä¸º6æä¾›äº†ä¸€ä¸ª<strong>ç¼“å†²åŒºé—´</strong>[6, 8]ï¼Œé¿å…æŠ–åŠ¨</li>
</ul>

<pre><code class="hljs language-rust" lang="rust">é“¾è¡¨é•¿åº¦å˜åŒ–:
  <span class="hljs-number">7</span> <span class="hljs-punctuation">-&gt;</span> <span class="hljs-number">8</span> <span class="hljs-punctuation">-&gt;</span> <span class="hljs-number">7</span> <span class="hljs-punctuation">-&gt;</span> <span class="hljs-number">8</span> <span class="hljs-punctuation">-&gt;</span> <span class="hljs-number">7</span>  (å¦‚æœé˜ˆå€¼éƒ½æ˜¯<span class="hljs-number">8</span>)
  é¢‘ç¹æ ‘åŒ– â†” é€€åŒ–ï¼ˆæ€§èƒ½å·®ï¼‰

  <span class="hljs-number">7</span> <span class="hljs-punctuation">-&gt;</span> <span class="hljs-number">8</span>ï¼ˆæ ‘åŒ–ï¼‰ <span class="hljs-punctuation">-&gt;</span> <span class="hljs-number">7</span> <span class="hljs-punctuation">-&gt;</span> <span class="hljs-number">6</span>ï¼ˆé€€åŒ–ï¼‰ <span class="hljs-punctuation">-&gt;</span> <span class="hljs-number">7</span> <span class="hljs-punctuation">-&gt;</span> <span class="hljs-number">8</span>ï¼ˆæ ‘åŒ–ï¼‰
  ç¼“å†²åŒºé—´[<span class="hljs-number">6</span>,<span class="hljs-number">8</span>]ï¼Œå‡å°‘è½¬æ¢æ¬¡æ•°
</code></pre>
<hr/>
<h3 data-id="heading-51">5.4 ConcurrentHashMapçš„å¹¶å‘åº¦æ˜¯ä»€ä¹ˆï¼Ÿå¦‚ä½•è®¾ç½®ï¼Ÿ</h3>
<p><strong>å¹¶å‘åº¦ï¼ˆconcurrencyLevelï¼‰ï¼š</strong></p>
<ul>
<li>
<p><strong>JDK 1.7</strong>ï¼šSegmentæ•°ç»„é•¿åº¦ï¼Œé»˜è®¤16</p>
<ul>
<li>è¡¨ç¤ºæœ€å¤š<strong>16ä¸ªçº¿ç¨‹</strong>å¯ä»¥åŒæ—¶ä¿®æ”¹ï¼ˆæ¯ä¸ªSegmentä¸€ä¸ªï¼‰</li>
<li>åˆå§‹åŒ–æ—¶æŒ‡å®šï¼š<code>new ConcurrentHashMap&lt;&gt;(16, 0.75f, 16)</code></li>
</ul>
</li>
<li>
<p><strong>JDK 1.8</strong>ï¼šå·²åºŸå¼ƒï¼Œå¹¶å‘åº¦åŠ¨æ€ç­‰äº<strong>æ•°ç»„é•¿åº¦</strong></p>
<ul>
<li>æ•°ç»„æ‰©å®¹æ—¶å¹¶å‘åº¦è‡ªåŠ¨ç¿»å€</li>
<li>ç†è®ºä¸Šå¯ä»¥æœ‰<strong>æ•°ç»„é•¿åº¦</strong>ä¸ªçº¿ç¨‹åŒæ—¶ä¿®æ”¹ä¸åŒæ¡¶</li>
</ul>
</li>
</ul>
<p><strong>å¦‚ä½•è®¾ç½®ï¼Ÿ</strong></p>
<p>JDK 1.8ä¸­ä¸éœ€è¦è®¾ç½®ï¼Œåªéœ€æŒ‡å®š<code>initialCapacity</code>ï¼š</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// æ¨èæ–¹å¼</span>
ConcurrentHashMap&lt;K, V&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;(initialCapacity);

<span class="hljs-comment">// initialCapacityå»ºè®®è®¾ç½®ä¸ºé¢„æœŸå…ƒç´ æ•°é‡ / 0.75</span>
<span class="hljs-type">int</span> <span class="hljs-variable">expectedSize</span> <span class="hljs-operator">=</span> <span class="hljs-number">10000</span>;
<span class="hljs-type">int</span> <span class="hljs-variable">initialCapacity</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>) (expectedSize / <span class="hljs-number">0.75</span>) + <span class="hljs-number">1</span>;
ConcurrentHashMap&lt;K, V&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;(initialCapacity);
</code></pre>
<hr/>
<h3 data-id="heading-52">5.5 è¿­ä»£ConcurrentHashMapæ—¶èƒ½ä¿®æ”¹å—ï¼Ÿ</h3>
<p><strong>ç­”æ¡ˆï¼šå¯ä»¥ï¼Œä½†è¦å°å¿ƒ</strong></p>
<p><strong>ConcurrentHashMapçš„è¿­ä»£å™¨æ˜¯fail-safeçš„ï¼š</strong></p>
<pre><code class="hljs language-java" lang="java">ConcurrentHashMap&lt;String, String&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();
map.put(<span class="hljs-string">"k1"</span>, <span class="hljs-string">"v1"</span>);
map.put(<span class="hljs-string">"k2"</span>, <span class="hljs-string">"v2"</span>);

<span class="hljs-comment">// âœ… è¿­ä»£æ—¶å¯ä»¥ä¿®æ”¹ï¼Œä¸ä¼šæŠ›å¼‚å¸¸</span>
<span class="hljs-keyword">for</span> (String key : map.keySet()) {
    map.put(<span class="hljs-string">"k3"</span>, <span class="hljs-string">"v3"</span>);  <span class="hljs-comment">// å…è®¸</span>
    map.remove(<span class="hljs-string">"k2"</span>);     <span class="hljs-comment">// å…è®¸</span>
}

<span class="hljs-comment">// HashMapä¼šæŠ›ConcurrentModificationException</span>
HashMap&lt;String, String&gt; hashMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
<span class="hljs-keyword">for</span> (String key : hashMap.keySet()) {
    hashMap.put(<span class="hljs-string">"k3"</span>, <span class="hljs-string">"v3"</span>);  <span class="hljs-comment">// âŒ æŠ›å¼‚å¸¸</span>
}
</code></pre>
<p><strong>æ³¨æ„äº‹é¡¹ï¼š</strong></p>
<ol>
<li><strong>æ–°å¢çš„å…ƒç´ å¯èƒ½çœ‹ä¸åˆ°</strong>ï¼šè¿­ä»£å™¨è¿”å›çš„æ˜¯æŸä¸€æ—¶åˆ»çš„å¿«ç…§</li>
<li><strong>åˆ é™¤çš„å…ƒç´ å¯èƒ½è¿˜èƒ½çœ‹åˆ°</strong>ï¼šè¿­ä»£å™¨å·²ç»ç¼“å­˜</li>
<li><strong>ä¸ä¿è¯è¿­ä»£é¡ºåº</strong></li>
</ol>
<p><strong>å®‰å…¨çš„è¿­ä»£æ–¹å¼ï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// æ–¹å¼1ï¼šå…ˆå¤åˆ¶ï¼Œå†è¿­ä»£</span>
List&lt;String&gt; keys = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(map.keySet());
<span class="hljs-keyword">for</span> (String key : keys) {
    map.remove(key);  <span class="hljs-comment">// å®‰å…¨</span>
}

<span class="hljs-comment">// æ–¹å¼2ï¼šä½¿ç”¨Iterator.remove()</span>
Iterator&lt;String&gt; it = map.keySet().iterator();
<span class="hljs-keyword">while</span> (it.hasNext()) {
    <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> it.next();
    it.remove();  <span class="hljs-comment">// å®‰å…¨</span>
}
</code></pre>
<hr/>
<h3 data-id="heading-53">5.6 compute/computeIfAbsentçš„çº¿ç¨‹å®‰å…¨é—®é¢˜</h3>
<p><strong>computeç³»åˆ—æ–¹æ³•æ˜¯åŸå­çš„ï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// âœ… computeIfAbsentæ˜¯åŸå­æ“ä½œ</span>
map.computeIfAbsent(<span class="hljs-string">"key"</span>, k -&gt; expensiveCompute());

<span class="hljs-comment">// âŒ é”™è¯¯ï¼šéåŸå­ï¼Œå¯èƒ½å¤šæ¬¡è®¡ç®—</span>
<span class="hljs-keyword">if</span> (map.get(<span class="hljs-string">"key"</span>) == <span class="hljs-literal">null</span>) {
    map.put(<span class="hljs-string">"key"</span>, expensiveCompute());  <span class="hljs-comment">// å¯èƒ½è¢«å¤šä¸ªçº¿ç¨‹æ‰§è¡Œ</span>
}
</code></pre>
<p><strong>æºç åˆ†æï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> V <span class="hljs-title function_">computeIfAbsent</span><span class="hljs-params">(K key, Function&lt;? <span class="hljs-built_in">super</span> K, ? extends V&gt; mappingFunction)</span> {
    ...
    <span class="hljs-keyword">for</span> (Node&lt;K,V&gt;[] tab = table;;) {
        ...
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ((f = tabAt(tab, i = (n - <span class="hljs-number">1</span>) &amp; h)) == <span class="hljs-literal">null</span>) {
            <span class="hljs-comment">// æ¡¶ä¸ºç©ºï¼ŒCASæ’å…¥</span>
            Node&lt;K,V&gt; r = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReservationNode</span>&lt;K,V&gt;();
            <span class="hljs-keyword">synchronized</span> (r) {  <span class="hljs-comment">// ä¸´æ—¶èŠ‚ç‚¹åŠ é”</span>
                <span class="hljs-keyword">if</span> (casTabAt(tab, i, <span class="hljs-literal">null</span>, r)) {
                    <span class="hljs-keyword">try</span> {
                        <span class="hljs-type">V</span> <span class="hljs-variable">v</span> <span class="hljs-operator">=</span> mappingFunction.apply(key);  <span class="hljs-comment">// åªè®¡ç®—ä¸€æ¬¡</span>
                        ...
                    }
                }
            }
        }
        <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">synchronized</span> (f) {  <span class="hljs-comment">// é”å®šæ¡¶</span>
                ...
                <span class="hljs-keyword">if</span> (binCount != <span class="hljs-number">0</span>) {
                    <span class="hljs-keyword">if</span> (binCount &gt;= TREEIFY_THRESHOLD)
                        treeifyBin(tab, i);
                    <span class="hljs-keyword">if</span> (oldVal != <span class="hljs-literal">null</span>)
                        <span class="hljs-keyword">return</span> oldVal;
                    <span class="hljs-keyword">break</span>;
                }
            }
        }
    }
    ...
}
</code></pre>
<p><strong>å…³é”®ç‚¹ï¼š</strong></p>
<ul>
<li><code>mappingFunction.apply()</code>åªä¼šè¢«<strong>ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œ</strong></li>
<li>å…¶ä»–çº¿ç¨‹ä¼šç­‰å¾…ç¬¬ä¸€ä¸ªçº¿ç¨‹å®Œæˆ</li>
</ul>
<p><strong>âš ï¸ æ³¨æ„æ­»é”é£é™©ï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// âŒ å¯èƒ½æ­»é”</span>
map.computeIfAbsent(<span class="hljs-string">"key1"</span>, k -&gt; {
    <span class="hljs-keyword">return</span> map.computeIfAbsent(<span class="hljs-string">"key2"</span>, k2 -&gt; <span class="hljs-string">"value"</span>);  <span class="hljs-comment">// åµŒå¥—é”</span>
});
</code></pre>
<p><strong>æ­£ç¡®ç”¨æ³•ï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// âœ… é¿å…åµŒå¥—</span>
<span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> map.computeIfAbsent(<span class="hljs-string">"key"</span>, k -&gt; computeValue());
</code></pre>
<hr/>
<h3 data-id="heading-54">5.7 putIfAbsent vs computeIfAbsentçš„åŒºåˆ«</h3>






























<table><thead><tr><th>å¯¹æ¯”é¡¹</th><th>putIfAbsent</th><th>computeIfAbsent</th></tr></thead><tbody><tr><td><strong>å‚æ•°</strong></td><td><code>putIfAbsent(K key, V value)</code></td><td><code>computeIfAbsent(K key, Function&lt;K, V&gt; f)</code></td></tr><tr><td><strong>è®¡ç®—æ—¶æœº</strong></td><td><strong>ç«‹å³è®¡ç®—</strong>value</td><td><strong>å»¶è¿Ÿè®¡ç®—</strong>ï¼Œkeyä¸å­˜åœ¨æ—¶æ‰è®¡ç®—</td></tr><tr><td><strong>æ€§èƒ½</strong></td><td>æµªè´¹è®¡ç®—ï¼ˆvalueå·²è®¡ç®—å¥½ï¼‰</td><td><strong>æ‡’åŠ è½½</strong>ï¼Œæ€§èƒ½æ›´å¥½</td></tr><tr><td><strong>é€‚ç”¨åœºæ™¯</strong></td><td>valueå·²å‡†å¤‡å¥½</td><td>valueè®¡ç®—æ˜‚è´µ</td></tr></tbody></table>
<p><strong>ç¤ºä¾‹ï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// åœºæ™¯1ï¼švalueå·²å‡†å¤‡å¥½ â†’ putIfAbsent</span>
<span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> <span class="hljs-string">"computed-value"</span>;
map.putIfAbsent(<span class="hljs-string">"key"</span>, value);

<span class="hljs-comment">// åœºæ™¯2ï¼švalueéœ€è¦è®¡ç®— â†’ computeIfAbsentï¼ˆæ¨èï¼‰</span>
map.computeIfAbsent(<span class="hljs-string">"key"</span>, k -&gt; {
    <span class="hljs-comment">// åªæœ‰keyä¸å­˜åœ¨æ—¶æ‰æ‰§è¡Œ</span>
    <span class="hljs-keyword">return</span> expensiveCompute();
});

<span class="hljs-comment">// âŒ é”™è¯¯ç”¨æ³•ï¼šæå‰è®¡ç®—æµªè´¹</span>
<span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> expensiveCompute();  <span class="hljs-comment">// keyå­˜åœ¨æ—¶ç™½ç®—äº†</span>
map.putIfAbsent(<span class="hljs-string">"key"</span>, value);
</code></pre>
<hr/>
<h3 data-id="heading-55">5.8 å¦‚ä½•æ­£ç¡®ç»Ÿè®¡ConcurrentHashMapçš„å…ƒç´ æ•°é‡ï¼Ÿ</h3>
<p><strong>æ–¹æ³•1ï¼šsize()ï¼ˆæ¨èï¼‰</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">int</span> <span class="hljs-variable">size</span> <span class="hljs-operator">=</span> map.size();  <span class="hljs-comment">// O(counterCells.length)</span>
</code></pre>
<p><strong>ä¼˜ç‚¹</strong>ï¼š</p>
<ul>
<li>âœ… å®ç°ç®€å•</li>
<li>âœ… æ€§èƒ½å°šå¯ï¼ˆéå†counterCellsæ•°ç»„ï¼‰</li>
</ul>
<p><strong>ç¼ºç‚¹</strong>ï¼š</p>
<ul>
<li>âŒ è¿”å›<strong>è¿‘ä¼¼å€¼</strong>ï¼Œä¸ä¿è¯ç²¾ç¡®</li>
<li>âŒ æ•°æ®é‡å¤§æ—¶æœ‰æ€§èƒ½å¼€é”€</li>
</ul>
<p><strong>æ–¹æ³•2ï¼šAtomicLongè®¡æ•°ï¼ˆç²¾ç¡®ï¼‰</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">AtomicLong</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicLong</span>(<span class="hljs-number">0</span>);

<span class="hljs-keyword">public</span> V <span class="hljs-title function_">put</span><span class="hljs-params">(K key, V value)</span> {
    <span class="hljs-type">V</span> <span class="hljs-variable">oldValue</span> <span class="hljs-operator">=</span> map.put(key, value);
    <span class="hljs-keyword">if</span> (oldValue == <span class="hljs-literal">null</span>) {
        count.incrementAndGet();
    }
    <span class="hljs-keyword">return</span> oldValue;
}

<span class="hljs-keyword">public</span> <span class="hljs-type">long</span> <span class="hljs-title function_">size</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">return</span> count.get();  <span class="hljs-comment">// O(1)</span>
}
</code></pre>
<p><strong>ä¼˜ç‚¹</strong>ï¼š</p>
<ul>
<li>âœ… O(1)æ€§èƒ½</li>
<li>âœ… å®æ—¶ç²¾ç¡®</li>
</ul>
<p><strong>ç¼ºç‚¹</strong>ï¼š</p>
<ul>
<li>âŒ éœ€è¦åœ¨æ‰€æœ‰ä¿®æ”¹æ–¹æ³•ä¸­åŒæ­¥æ›´æ–°</li>
<li>âŒ ä»£ç ä¾µå…¥æ€§å¼º</li>
</ul>
<p><strong>æ–¹æ³•3ï¼šmappingCount()ï¼ˆJDK 1.8æ¨èï¼‰</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">long</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> map.mappingCount();  <span class="hljs-comment">// è¿”å›longï¼Œé¿å…æº¢å‡º</span>
</code></pre>
<p><strong>åŒºåˆ«ï¼š</strong></p>
<ul>
<li><code>size()</code>è¿”å›<code>int</code>ï¼Œæœ€å¤§<code>Integer.MAX_VALUE</code></li>
<li><code>mappingCount()</code>è¿”å›<code>long</code>ï¼Œæ”¯æŒæ›´å¤§å®¹é‡</li>
</ul>
<p><strong>æ¨èï¼š</strong></p>
<ul>
<li>æ™®é€šåœºæ™¯ï¼š<code>size()</code></li>
<li>è¶…å¤§å®¹é‡ï¼š<code>mappingCount()</code></li>
<li>æ€§èƒ½æ•æ„Ÿï¼š<code>AtomicLong</code></li>
</ul>
<hr/>
<h2 data-id="heading-56">å…­ã€æœ€ä½³å®è·µä¸æ€»ç»“</h2>
<h3 data-id="heading-57">6.1 ä»€ä¹ˆåœºæ™¯ä½¿ç”¨ConcurrentHashMapï¼Ÿ</h3>
<p><strong>é€‚ç”¨åœºæ™¯ï¼š</strong></p>
<ol>
<li>âœ… <strong>é«˜å¹¶å‘è¯»å†™</strong>ï¼šå¤šçº¿ç¨‹é¢‘ç¹è¯»å†™å…±äº«Map</li>
<li>âœ… <strong>è¯»å¤šå†™å°‘</strong>ï¼šå¦‚é…ç½®ç¼“å­˜ã€ç”¨æˆ·session</li>
<li>âœ… <strong>æ— éœ€å¼ºä¸€è‡´æ€§</strong>ï¼šå…è®¸è¯»åˆ°ç¨æ—§çš„æ•°æ®</li>
<li>âœ… <strong>éœ€è¦é«˜æ€§èƒ½</strong>ï¼šHashtableæ€§èƒ½ä¸æ»¡è¶³éœ€æ±‚</li>
</ol>
<p><strong>ä¸é€‚ç”¨åœºæ™¯ï¼š</strong></p>
<ol>
<li>âŒ <strong>å•çº¿ç¨‹</strong>ï¼šHashMapæ€§èƒ½æ›´å¥½</li>
<li>âŒ <strong>éœ€è¦å¼ºä¸€è‡´æ€§</strong>ï¼šä½¿ç”¨<code>Collections.synchronizedMap()</code></li>
<li>âŒ <strong>éœ€è¦æ’åº</strong>ï¼šä½¿ç”¨<code>ConcurrentSkipListMap</code></li>
<li>âŒ <strong>key/valueå…è®¸null</strong>ï¼šä½¿ç”¨<code>Collections.synchronizedMap(new HashMap&lt;&gt;())</code></li>
</ol>
<hr/>
<h3 data-id="heading-58">6.2 å¦‚ä½•æ­£ç¡®ä½¿ç”¨ConcurrentHashMapï¼Ÿ</h3>
<p><strong>1. é€‰æ‹©åˆé€‚çš„åˆå§‹å®¹é‡</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// âœ… æ¨èï¼šé¢„ä¼°å…ƒç´ æ•°é‡ï¼Œé¿å…æ‰©å®¹</span>
<span class="hljs-type">int</span> <span class="hljs-variable">expectedSize</span> <span class="hljs-operator">=</span> <span class="hljs-number">10000</span>;
<span class="hljs-type">int</span> <span class="hljs-variable">initialCapacity</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>) (expectedSize / <span class="hljs-number">0.75</span>) + <span class="hljs-number">1</span>;
ConcurrentHashMap&lt;K, V&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;(initialCapacity);

<span class="hljs-comment">// âŒ ä¸æ¨èï¼šé»˜è®¤å®¹é‡16ï¼Œé¢‘ç¹æ‰©å®¹</span>
ConcurrentHashMap&lt;K, V&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();
</code></pre>
<p><strong>2. ä½¿ç”¨computeç³»åˆ—æ–¹æ³•ä¿è¯åŸå­æ€§</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// âœ… åŸå­æ“ä½œ</span>
map.computeIfAbsent(<span class="hljs-string">"key"</span>, k -&gt; computeValue());

<span class="hljs-comment">// âŒ éåŸå­</span>
<span class="hljs-keyword">if</span> (!map.containsKey(<span class="hljs-string">"key"</span>)) {
    map.put(<span class="hljs-string">"key"</span>, computeValue());
}
</code></pre>
<p><strong>3. é¿å…åœ¨computeä¸­åµŒå¥—ä¿®æ”¹</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// âŒ å¯èƒ½æ­»é”</span>
map.computeIfAbsent(<span class="hljs-string">"key1"</span>, k -&gt; map.get(<span class="hljs-string">"key2"</span>));

<span class="hljs-comment">// âœ… å…ˆè·å–ï¼Œå†è®¡ç®—</span>
<span class="hljs-type">String</span> <span class="hljs-variable">key2Value</span> <span class="hljs-operator">=</span> map.get(<span class="hljs-string">"key2"</span>);
map.computeIfAbsent(<span class="hljs-string">"key1"</span>, k -&gt; process(key2Value));
</code></pre>
<p><strong>4. ä½¿ç”¨mappingCount()æ›¿ä»£size()</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// âœ… æ”¯æŒlongï¼Œé¿å…æº¢å‡º</span>
<span class="hljs-type">long</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> map.mappingCount();

<span class="hljs-comment">// âš ï¸ è¿”å›intï¼Œå¯èƒ½æº¢å‡º</span>
<span class="hljs-type">int</span> <span class="hljs-variable">size</span> <span class="hljs-operator">=</span> map.size();
</code></pre>
<hr/>
<h3 data-id="heading-59">6.3 æ€§èƒ½ä¼˜åŒ–å»ºè®®</h3>
<p><strong>1. åˆç†è®¾ç½®åˆå§‹å®¹é‡å’ŒåŠ è½½å› å­</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// åœºæ™¯ï¼šé¢„æœŸ10000ä¸ªå…ƒç´ ï¼Œè¯»å¤šå†™å°‘</span>
ConcurrentHashMap&lt;K, V&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;(
    <span class="hljs-number">16384</span>,  <span class="hljs-comment">// initialCapacity: 10000 / 0.75 â‰ˆ 13333ï¼Œå‘ä¸Šå–2çš„å¹‚æ¬¡ = 16384</span>
    <span class="hljs-number">0.75f</span>   <span class="hljs-comment">// loadFactor: é»˜è®¤0.75å³å¯</span>
);
</code></pre>
<p><strong>2. é¿å…é¢‘ç¹size()è°ƒç”¨</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// âŒ æ¯æ¬¡éƒ½è°ƒç”¨size()</span>
<span class="hljs-keyword">for</span> (...) {
    <span class="hljs-keyword">if</span> (map.size() &gt; <span class="hljs-number">10000</span>) {
        ...
    }
}

<span class="hljs-comment">// âœ… ç¼“å­˜size()ç»“æœ</span>
<span class="hljs-type">int</span> <span class="hljs-variable">size</span> <span class="hljs-operator">=</span> map.size();
<span class="hljs-keyword">for</span> (...) {
    <span class="hljs-keyword">if</span> (size &gt; <span class="hljs-number">10000</span>) {
        ...
    }
}
</code></pre>
<p><strong>3. æ‰¹é‡æ“ä½œä½¿ç”¨putAll()</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// âŒ é€ä¸ªput</span>
<span class="hljs-keyword">for</span> (Entry&lt;K, V&gt; entry : entries) {
    map.put(entry.getKey(), entry.getValue());
}

<span class="hljs-comment">// âœ… æ‰¹é‡putAll</span>
map.putAll(otherMap);
</code></pre>
<hr/>
<h3 data-id="heading-60">6.4 å¸¸è§é”™è¯¯ç”¨æ³•</h3>
<p><strong>é”™è¯¯1ï¼šå½“ä½œå¼ºä¸€è‡´æ€§å®¹å™¨</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// âŒ é”™è¯¯ï¼šä»¥ä¸ºæ˜¯åŸå­æ“ä½œ</span>
<span class="hljs-keyword">if</span> (map.size() &gt; <span class="hljs-number">100</span>) {
    map.remove(oldestKey);  <span class="hljs-comment">// size()å’Œremove()ä¹‹é—´ï¼Œsizeå¯èƒ½å·²å˜åŒ–</span>
}

<span class="hljs-comment">// âœ… æ­£ç¡®ï¼šå•ç‹¬ç»´æŠ¤è®¡æ•°</span>
<span class="hljs-keyword">if</span> (count.get() &gt; <span class="hljs-number">100</span>) {
    removeOldest();
}
</code></pre>
<p><strong>é”™è¯¯2ï¼šä¾èµ–è¿­ä»£é¡ºåº</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// âŒ é”™è¯¯ï¼šConcurrentHashMapä¸ä¿è¯é¡ºåº</span>
<span class="hljs-keyword">for</span> (String key : map.keySet()) {
    <span class="hljs-comment">// æœŸæœ›æŒ‰æ’å…¥é¡ºåº...</span>
}

<span class="hljs-comment">// âœ… æ­£ç¡®ï¼šä½¿ç”¨ConcurrentSkipListMapï¼ˆæœ‰åºï¼‰</span>
ConcurrentNavigableMap&lt;K, V&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentSkipListMap</span>&lt;&gt;();
</code></pre>
<p><strong>é”™è¯¯3ï¼šå¿˜è®°å¤„ç†null</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// âŒ é”™è¯¯ï¼šå¿˜è®°åˆ¤null</span>
<span class="hljs-type">V</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> map.get(<span class="hljs-string">"key"</span>);
value.toString();  <span class="hljs-comment">// NPE</span>

<span class="hljs-comment">// âœ… æ­£ç¡®ï¼šåˆ¤ç©ºæˆ–ä½¿ç”¨getOrDefault</span>
<span class="hljs-type">V</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> map.getOrDefault(<span class="hljs-string">"key"</span>, defaultValue);
</code></pre>
<hr/>
<h3 data-id="heading-61">6.5 çº¿ç¨‹å®‰å…¨å®¹å™¨é€‰å‹æŒ‡å—</h3>









































<table><thead><tr><th>éœ€æ±‚</th><th>æ¨èå®¹å™¨</th></tr></thead><tbody><tr><td><strong>é«˜å¹¶å‘è¯»å†™Map</strong></td><td><code>ConcurrentHashMap</code></td></tr><tr><td><strong>æœ‰åºMap</strong></td><td><code>ConcurrentSkipListMap</code></td></tr><tr><td><strong>é«˜å¹¶å‘List</strong></td><td><code>CopyOnWriteArrayList</code>ï¼ˆè¯»å¤šå†™å°‘ï¼‰</td></tr><tr><td><strong>é«˜å¹¶å‘Set</strong></td><td><code>ConcurrentHashMap.newKeySet()</code></td></tr><tr><td><strong>é«˜å¹¶å‘Queue</strong></td><td><code>ConcurrentLinkedQueue</code>ï¼ˆæ— ç•Œï¼‰<br/><code>LinkedBlockingQueue</code>ï¼ˆæœ‰ç•Œï¼‰</td></tr><tr><td><strong>å»¶è¿Ÿé˜Ÿåˆ—</strong></td><td><code>DelayQueue</code></td></tr><tr><td><strong>ä¼˜å…ˆçº§é˜Ÿåˆ—</strong></td><td><code>PriorityBlockingQueue</code></td></tr><tr><td><strong>å¼ºä¸€è‡´æ€§Map</strong></td><td><code>Collections.synchronizedMap()</code></td></tr></tbody></table>
<hr/>
<h2 data-id="heading-62">æ€»ç»“</h2>
<p><code>ConcurrentHashMap</code>æ˜¯Javaå¹¶å‘åŒ…ä¸­æœ€é‡è¦çš„å®¹å™¨ä¹‹ä¸€ï¼Œç»å†äº†ä»**åˆ†æ®µé”ï¼ˆJDK 1.7ï¼‰<strong>åˆ°</strong>CAS + synchronizedï¼ˆJDK 1.8ï¼‰**çš„æ¼”è¿›ï¼Œåœ¨ä¿è¯çº¿ç¨‹å®‰å…¨çš„åŒæ—¶å®ç°äº†æé«˜çš„å¹¶å‘æ€§èƒ½ã€‚</p>
<p><strong>æ ¸å¿ƒè¦ç‚¹å›é¡¾ï¼š</strong></p>
<ol>
<li><strong>è®¾è®¡ç›®æ ‡</strong>ï¼šé«˜å¹¶å‘ã€é«˜æ€§èƒ½ã€çº¿ç¨‹å®‰å…¨ã€å¼±ä¸€è‡´æ€§</li>
<li><strong>JDK 1.7</strong>ï¼šSegmentåˆ†æ®µé”ï¼Œå¹¶å‘åº¦å—é™äºSegmentæ•°é‡ï¼ˆé»˜è®¤16ï¼‰</li>
<li><strong>JDK 1.8</strong>ï¼šNodeæ•°ç»„ + é“¾è¡¨/çº¢é»‘æ ‘ï¼ŒCAS + synchronizedï¼Œå¹¶å‘åº¦ç­‰äºæ•°ç»„é•¿åº¦</li>
<li><strong>å…³é”®æœºåˆ¶</strong>ï¼š
<ul>
<li>æ¡¶ä¸ºç©ºï¼šCASæ’å…¥ï¼ˆæ— é”ï¼‰</li>
<li>æ­£åœ¨æ‰©å®¹ï¼šååŠ©æ‰©å®¹ï¼ˆå¤šçº¿ç¨‹åä½œï¼‰</li>
<li>hashå†²çªï¼šsynchronizedé”å¤´èŠ‚ç‚¹ï¼ˆç»†ç²’åº¦é”ï¼‰</li>
</ul>
</li>
<li><strong>æ‰©å®¹ä¼˜åŒ–</strong>ï¼šå¤šçº¿ç¨‹åä½œè¿ç§»ï¼ŒForwardingNodeæ ‡è®°å·²è¿ç§»æ¡¶</li>
<li><strong>è®¡æ•°ä¼˜åŒ–</strong>ï¼šbaseCount + CounterCell[]ï¼ŒLongAdderæ€æƒ³</li>
</ol>
<p><strong>æœ€ä½³å®è·µï¼š</strong></p>
<ul>
<li>âœ… é¢„ä¼°å®¹é‡ï¼Œé¿å…é¢‘ç¹æ‰©å®¹</li>
<li>âœ… ä½¿ç”¨computeç³»åˆ—æ–¹æ³•ä¿è¯åŸå­æ€§</li>
<li>âœ… ä½¿ç”¨mappingCount()æ›¿ä»£size()</li>
<li>âœ… é€‚ç”¨äºè¯»å¤šå†™å°‘ã€å¼±ä¸€è‡´æ€§åœºæ™¯</li>
<li>âŒ ä¸è¦åœ¨computeä¸­åµŒå¥—ä¿®æ”¹</li>
<li>âŒ ä¸è¦ä¾èµ–è¿­ä»£é¡ºåº</li>
<li>âŒ ä¸è¦é¢‘ç¹è°ƒç”¨size()</li>
</ul>
<p><code>ConcurrentHashMap</code>æ˜¯å¹¶å‘ç¼–ç¨‹çš„åŸºç¡€ç»„ä»¶ï¼Œæ·±å…¥ç†è§£å…¶åŸç†å’Œæ­£ç¡®ä½¿ç”¨æ–¹å¼ï¼Œå¯¹æ„å»ºé«˜æ€§èƒ½å¹¶å‘ç³»ç»Ÿè‡³å…³é‡è¦ã€‚</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[09 Go Eino AIåº”ç”¨å¼€å‘å®æˆ˜ | Hertz Web æ¡†æ¶æ­å»º]]></title>    <link>https://juejin.cn/post/7585474459776630820</link>    <guid>https://juejin.cn/post/7585474459776630820</guid>    <pubDate>2025-12-20T09:43:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585474459776630820" data-draft-id="7585390679398858758" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="09 Go Eino AIåº”ç”¨å¼€å‘å®æˆ˜ | Hertz Web æ¡†æ¶æ­å»º"/> <meta itemprop="keywords" content="åç«¯,äººå·¥æ™ºèƒ½,Go"/> <meta itemprop="datePublished" content="2025-12-20T09:43:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ç‹ä¸­é˜³è®²AIç¼–ç¨‹"/> <meta itemprop="url" content="https://juejin.cn/user/2189882892232029"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="æ˜é‡‘"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            09 Go Eino AIåº”ç”¨å¼€å‘å®æˆ˜ | Hertz Web æ¡†æ¶æ­å»º
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2189882892232029/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ç‹ä¸­é˜³è®²AIç¼–ç¨‹
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T09:43:30.000Z" title="Sat Dec 20 2025 09:43:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    é˜…è¯»3åˆ†é’Ÿ
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;font-weight:400;line-height:2;font-size:17px;overflow-x:hidden;color:#000}.markdown-body strong{padding:1px;color:#ee3f4d}.markdown-body em{padding:0 2px;color:#f33b1f}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{position:relative;margin-top:30px;margin-bottom:20px;line-height:1.5;font-weight:700}.markdown-body h1{text-align:center;padding-bottom:5px;font-size:32px;color:#ac1f18}.markdown-body h1:after{content:"";display:block;margin:4px auto 0;width:100px;height:2px;border-bottom:2px solid #f33b1f}.markdown-body h2{font-size:28px;border-bottom:1px solid #f33b1f}.markdown-body h2:before{content:"# "!important;color:#f33b1f}.markdown-body h3{font-size:24px;padding-left:9px;border-left:6px solid #f33b1f}.markdown-body h4{font-size:20px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #bbb;margin:16px 0}.markdown-body code{word-break:break-word;overflow-x:auto;background-color:#f9f1db;color:#ee2746;border-radius:2px;font-size:16px;padding:1px 2px}.markdown-body code,.markdown-body pre{font-family:-apple-system,-apple-system-body,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,PingFang SC,æ€æºé»‘ä½“ CN,æ€æºé»‘ä½“,JetBrains Mono,Fira Code,Menlo,Ubuntu Mono,Consolas,sans-serif}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{margin:12px 0!important;border-radius:3px;font-size:15px;padding:16px 12px;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f7f7f7}.markdown-body a{text-decoration:none;color:#1781b5;padding:0 2px;border-bottom:1px solid #1781b5}.markdown-body a:active,.markdown-body a:hover{border-bottom:2px solid #f33b1f;color:#ac1f18}.markdown-body blockquote{color:#3d3d3d;background-color:#fff9f9;padding:6px 16px;margin:16px 0;border-left:3px solid #f07c82}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:6px 0}.markdown-body ol,.markdown-body ul{padding-left:30px}.markdown-body ol li,.markdown-body ul li{margin-bottom:6px}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:6px}.markdown-body ol li{padding-left:6px}.markdown-body ::marker{color:#f33b1f}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}.markdown-body .task-list-item input[type=checkbox]{position:relative}.markdown-body .task-list-item input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;background:#fff;border:1px solid #f07c82;border-radius:3px;box-sizing:border-box;z-index:1}.markdown-body .task-list-item input[type=checkbox]:checked:after{content:"âœ“";position:absolute;top:-5px;left:0;right:0;bottom:0;width:0;height:0;color:#f33b1f;font-size:16px;font-weight:700;z-index:2}.markdown-body table{display:inline-block!important;font-size:14px;width:auto;max-width:100%;overflow:auto;border-spacing:0;border-collapse:collapse}.markdown-body table thead{background:#fff9f9;color:#000;text-align:left;font-size:15px}.markdown-body table tr:nth-child(2n){background-color:#fcfcfc}.markdown-body table tr:hover{background-color:#fff9f9}.markdown-body table td,.markdown-body table th{padding:12px 7px;line-height:24px;border:1px solid #f9f1db}.markdown-body table td{min-width:120px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><blockquote>
<p>å£°æ˜ï¼šæœ¬AIåº”ç”¨å¼€å‘ç³»åˆ—æ•™ç¨‹é¦–å‘åœ¨åŒåå…¬ä¼—å·ï¼š<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F5DYsyMKh9cDJdVvs_Mn9_Q" target="_blank" title="https://mp.weixin.qq.com/s/5DYsyMKh9cDJdVvs_Mn9_Q" ref="nofollow noopener noreferrer">ç‹ä¸­é˜³</a>ï¼Œæœªç»æˆæƒç¦æ­¢è½¬è½½ã€‚</p>
</blockquote>
<p>Hertz Web æ¡†æ¶ä½œä¸º AI Interview Agent å¹³å°çš„æ ¸å¿ƒæ”¯æŸ±ï¼Œæä¾›é«˜æ€§èƒ½çš„ HTTP è·¯ç”±ã€ä¸­é—´ä»¶ç¼–æ’å’Œè¯·æ±‚å¤„ç†èƒ½åŠ›ã€‚æœ¬æŒ‡å—æ¶µç›– Hertz åœ¨é¡¹ç›®æ¶æ„ä¸­çš„å®Œæ•´è®¾ç½®å’Œé…ç½®ã€‚</p>
<h2 data-id="heading-0">æ¡†æ¶åˆå§‹åŒ–</h2>
<p>Hertz æœåŠ¡å™¨åœ¨ä¸»åº”ç”¨ç¨‹åºå…¥å£ç‚¹åˆå§‹åŒ–ï¼Œé€šè¿‡åŒ…å«é…ç½®åŠ è½½ã€æ•°æ®åº“è¿æ¥å’Œä¸­é—´ä»¶æ³¨å†Œçš„å®Œæ•´è®¾ç½®åºåˆ— [main.go#L101-L175]ã€‚</p>
<p>æœåŠ¡å™¨åˆå§‹åŒ–éµå¾ªä»¥ä¸‹å…³é”®æ¨¡å¼ï¼š</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// ä½¿ç”¨é…ç½®ä¸­çš„ä¸»æœºå’Œç«¯å£åˆå§‹åŒ– Hertz æœåŠ¡å™¨</span>
s := server.Default(server.WithHostPorts(fmt.Sprintf(<span class="hljs-string">"%s:%d"</span>, cfg.Host, cfg.Port)))
</code></pre>
<h2 data-id="heading-1">ä¸­é—´ä»¶æ¶æ„</h2>
<p>Hertz å®ç°äº†åˆ†å±‚ä¸­é—´ä»¶æ¶æ„æ¥å¤„ç†æ¨ªåˆ‡å…³æ³¨ç‚¹ï¼š</p>
<h3 data-id="heading-2">æ¢å¤ä¸­é—´ä»¶</h3>
<p>æ¢å¤ä¸­é—´ä»¶æ•è· panic å¹¶é˜²æ­¢æœåŠ¡å™¨å´©æºƒï¼Œæä¾›ç»“æ„åŒ–é”™è¯¯å“åº” [recovery.go#L15-L35]ï¼š</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Recovery</span><span class="hljs-params">()</span></span> app.HandlerFunc {
    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(ctx context.Context, c *app.RequestContext)</span></span> {
        <span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {
            <span class="hljs-keyword">if</span> r := <span class="hljs-built_in">recover</span>(); r != <span class="hljs-literal">nil</span> {
                stack := debug.Stack()
                log.Printf(<span class="hljs-string">"[PANIC] Recovered: %v\n%s"</span>, r, stack)
                <span class="hljs-comment">// è¿”å›ç»“æ„åŒ–é”™è¯¯å“åº”</span>
            }
        }()
        c.Next(ctx)
    }
}
</code></pre>
<h3 data-id="heading-3">CORS é…ç½®</h3>
<p>å…¨å±€ CORS ä¸­é—´ä»¶é€šè¿‡å…¨é¢çš„å¤´éƒ¨é…ç½®å¤„ç†è·¨åŸŸè¯·æ±‚ [main.go#L113-L127]ï¼š</p>






























<table><thead><tr><th>Header</th><th>Value</th><th>Purpose</th></tr></thead><tbody><tr><td>Access-Control-Allow-Origin</td><td>*</td><td>å…è®¸æ‰€æœ‰æ¥æº</td></tr><tr><td>Access-Control-Allow-Methods</td><td>GET, POST, PUT, DELETE, OPTIONS</td><td>å…è®¸çš„ HTTP æ–¹æ³•</td></tr><tr><td>Access-Control-Allow-Headers</td><td>Content-Type, Authorization, X-Requested-With, Cache-Control, X-Auth-Token</td><td>å…è®¸çš„è¯·æ±‚å¤´</td></tr><tr><td>Access-Control-Max-Age</td><td>86400</td><td>é¢„æ£€è¯·æ±‚ç¼“å­˜ 24 å°æ—¶</td></tr></tbody></table>
<h3 data-id="heading-4">JWT è®¤è¯</h3>
<p>JWT ä¸­é—´ä»¶æä¾›åŸºäºä»¤ç‰Œçš„è®¤è¯ï¼Œæ”¯æŒå¯é…ç½®çš„è·¯ç”±è·³è¿‡ [jwt.go#L37-L79]ã€‚ç»•è¿‡è®¤è¯çš„å…¬å…±è·¯ç”±åŒ…æ‹¬ï¼š</p>
<ul>
<li><code>/api/user/login</code></li>
<li><code>/api/user/register</code></li>
<li><code>/api/user/logout</code></li>
<li><code>/api/user/wechat/login</code></li>
<li><code>/api/user/wechat/callback</code></li>
<li><code>/api/demo/create/model</code></li>
</ul>
<h2 data-id="heading-5">è·¯ç”±æ³¨å†Œç³»ç»Ÿ</h2>
<p>Hertz ä½¿ç”¨åŸºäº IDL å®šä¹‰çš„è‡ªåŠ¨ç”Ÿæˆè·¯ç”±æ³¨å†Œç³»ç»Ÿ [register.go#L11-L16]ã€‚è·¯ç”±å±‚æ¬¡éµå¾ªç»“æ„åŒ–æ¨¡å¼ï¼š</p>
<pre><code class="hljs language-bash" lang="bash">/
â”œâ”€â”€ /api/
    â”œâ”€â”€ /interview/
    â”‚   â”œâ”€â”€ /records (GET)
    â”‚   â””â”€â”€ /stream/
    â”‚       â””â”€â”€ /start (POST)
    â”œâ”€â”€ /mianshi/
    â”‚   â”œâ”€â”€ /answer-record (GET)
    â”‚   â”œâ”€â”€ /evaluation (GET)
    â”‚   â”œâ”€â”€ /records (GET)
    â”‚   â”œâ”€â”€ /answer/
    â”‚   â”‚   â””â”€â”€ /submit (POST)
    â”‚   â”œâ”€â”€ /interview/
    â”‚   â”‚   â””â”€â”€ /end (POST)
    â”‚   â”œâ”€â”€ /session/
    â”‚   â”‚   â””â”€â”€ /info (GET)
    â”‚   â””â”€â”€ /stream/
    â”‚       â””â”€â”€ /start (POST)
    â”œâ”€â”€ /prediction/
    â”‚   â”œâ”€â”€ /:<span class="hljs-built_in">id</span> (GET)
    â”‚   â”œâ”€â”€ /list (GET)
    â”‚   â””â”€â”€ /start (POST)
    â”œâ”€â”€ /resume/
    â”‚   â”œâ”€â”€ /default (GET)
    â”‚   â”œâ”€â”€ /list (GET)
    â”‚   â”œâ”€â”€ /:resume_id (GET, PUT, DELETE)
    â”‚   â”œâ”€â”€ /set-default (POST)
    â”‚   â””â”€â”€ /upload (POST)
    â””â”€â”€ /user/
        â”œâ”€â”€ /login (POST)
        â”œâ”€â”€ /register (POST)
        â”œâ”€â”€ /profile (GET, PUT)
        â”œâ”€â”€ /create/model (POST)
        â”œâ”€â”€ /model/
        â”‚   â”œâ”€â”€ /check (GET)
        â”‚   â”œâ”€â”€ /list (GET)
        â”‚   â”œâ”€â”€ /delete/:<span class="hljs-built_in">id</span> (DELETE)
        â”‚   â”œâ”€â”€ /details/:<span class="hljs-built_in">id</span> (GET)
        â”‚   â””â”€â”€ /update/:<span class="hljs-built_in">id</span> (PUT)
        â””â”€â”€ /wechat/
            â”œâ”€â”€ /login (GET)
            â””â”€â”€ /callback (GET)
</code></pre>
<p>è·¯ç”±æ³¨å†Œæ˜¯ä½¿ç”¨ Hertz ç”Ÿæˆå™¨ä» IDL å®šä¹‰è‡ªåŠ¨ç”Ÿæˆçš„ã€‚æ‰‹åŠ¨ä¿®æ”¹ç”Ÿæˆçš„æ–‡ä»¶å°†åœ¨æ›´æ–°æ—¶è¢«è¦†ç›–ã€‚</p>
<h2 data-id="heading-6">é…ç½®é›†æˆ</h2>
<p>Hertz é…ç½®ä¸åº”ç”¨ç¨‹åºçš„é›†ä¸­å¼é…ç½®ç³»ç»Ÿé›†æˆ [config.go#L75-L83]ï¼š</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">type</span> HertzConfig <span class="hljs-keyword">struct</span> {
    Host         <span class="hljs-type">string</span>        <span class="hljs-string">`yaml:"host"`</span>
    Port         <span class="hljs-type">int</span>           <span class="hljs-string">`yaml:"port"`</span>
    ReadTimeout  time.Duration <span class="hljs-string">`yaml:"read_timeout"`</span>
    WriteTimeout time.Duration <span class="hljs-string">`yaml:"write_timeout"`</span>
    IdleTimeout  time.Duration <span class="hljs-string">`yaml:"idle_timeout"`</span>
}
</code></pre>
<p>æœåŠ¡å™¨ä½¿ç”¨ç¯å¢ƒå˜é‡æ‰©å±•ï¼Œå…è®¸é€šè¿‡ YAML æ–‡ä»¶ä¸­çš„Â <code>${VAR_NAME}</code>Â è¯­æ³•è¿›è¡Œçµæ´»é…ç½®ã€‚</p>
<h2 data-id="heading-7">ä¼˜é›…å…³é—­</h2>
<p>Hertz å®ç°äº†å¸¦æœ‰é€‚å½“èµ„æºæ¸…ç†çš„ä¼˜é›…å…³é—­ [main.go#L147-L175]ï¼š</p>
<ol>
<li><strong>ä¿¡å·å¤„ç†</strong>ï¼šç›‘å¬ SIGINT å’Œ SIGTERM ä¿¡å·</li>
<li><strong>æ¶ˆè´¹è€…å…³é—­</strong>ï¼šåœæ­¢æ¶ˆæ¯é˜Ÿåˆ—æ¶ˆè´¹è€…</li>
<li><strong>é˜Ÿåˆ—æ¸…ç†</strong>ï¼šå…³é—­æ¶ˆæ¯é˜Ÿåˆ—è¿æ¥</li>
<li><strong>æœåŠ¡å™¨å…³é—­</strong>ï¼šåœ¨ 5 ç§’è¶…æ—¶å†…ä¼˜é›…å…³é—­ HTTP è¿æ¥</li>
</ol>
<p>ä¼˜é›…å…³é—­åºåˆ—ç¡®ä¿æ‰€æœ‰è¿›è¡Œä¸­çš„è¯·æ±‚å®Œæˆï¼ŒåŒæ—¶é˜»æ­¢æ–°è¯·æ±‚ï¼Œåœ¨é‡å¯æœŸé—´ç»´æŠ¤æ•°æ®å®Œæ•´æ€§ã€‚</p>
<h2 data-id="heading-8">æ€§èƒ½è€ƒè™‘</h2>
<p>Hertz è®¾ç½®åŒ…æ‹¬å¤šé¡¹æ€§èƒ½ä¼˜åŒ–ï¼š</p>
<ul>
<li><strong>è¿æ¥æ± </strong>ï¼šé€šè¿‡æ•°æ®åº“å’Œ Redis è¿æ¥è®¾ç½®é…ç½®</li>
<li><strong>è¯·æ±‚è¶…æ—¶</strong>ï¼šå¯é…ç½®çš„è¯»å–ã€å†™å…¥å’Œç©ºé—²è¶…æ—¶é˜²æ­¢èµ„æºæ³„æ¼</li>
<li><strong>ä¸­é—´ä»¶é¡ºåº</strong>ï¼šå…³é”®ä¸­é—´ä»¶ï¼ˆæ¢å¤ã€CORSï¼‰ç½®äºè®¤è¯ä¹‹å‰ä»¥è·å¾—æœ€ä½³æ€§èƒ½</li>
<li><strong>é™æ€æ–‡ä»¶å¤„ç†</strong>ï¼šé€šè¿‡ Hertz å†…ç½®çš„é™æ€æ–‡ä»¶åŠŸèƒ½é«˜æ•ˆæä¾›</li>
</ul>
<h2 data-id="heading-9">é›†æˆç‚¹</h2>
<p>Hertz ä¸å…¶ä»–ç³»ç»Ÿç»„ä»¶æ— ç¼é›†æˆï¼š</p>
<ul>
<li><strong>æ¶ˆæ¯é˜Ÿåˆ—</strong>ï¼šåŸºäº Redis çš„å¼‚æ­¥å¤„ç†é˜Ÿåˆ—</li>
<li><strong>æ•°æ®åº“</strong>ï¼šGORM é›†æˆç”¨äºæ•°æ®æŒä¹…åŒ–</li>
<li><strong>AI æœåŠ¡</strong>ï¼šEino æ¡†æ¶é›†æˆç”¨äº AI Agent ç¼–æ’</li>
<li><strong>æ–‡ä»¶å­˜å‚¨</strong>ï¼šç®€å†ä¸Šä¼ å’Œç®¡ç†èƒ½åŠ›</li>
</ul>
<p>æ¡†æ¶çš„æ¨¡å—åŒ–è®¾è®¡å…è®¸è½»æ¾æ‰©å±•å’Œç»´æŠ¤ï¼ŒåŒæ—¶ä¸º AI Interview Agent å¹³å°ä¿æŒé«˜æ€§èƒ½å’Œå¯é æ€§ã€‚</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Redissonåˆ†å¸ƒå¼é”å®ç°åŸç†]]></title>    <link>https://juejin.cn/post/7585463195201339442</link>    <guid>https://juejin.cn/post/7585463195201339442</guid>    <pubDate>2025-12-20T08:01:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585463195201339442" data-draft-id="7585446706327388169" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Redissonåˆ†å¸ƒå¼é”å®ç°åŸç†"/> <meta itemprop="keywords" content="åç«¯"/> <meta itemprop="datePublished" content="2025-12-20T08:01:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="sir761"/> <meta itemprop="url" content="https://juejin.cn/user/1285746184422272"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="æ˜é‡‘"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Redissonåˆ†å¸ƒå¼é”å®ç°åŸç†
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1285746184422272/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    sir761
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T08:01:18.000Z" title="Sat Dec 20 2025 08:01:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    é˜…è¯»12åˆ†é’Ÿ
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>è¯´åˆ°redisçš„åˆ†å¸ƒå¼é”å®¹æ˜“æƒ³åˆ°äº†setNxï¼Œå¥½å¤„æ˜¯å®ç°ç®€å•ï¼Œä½†æ˜¯ä¼šæœ‰ä¸€äº›é—®é¢˜æ¯”å¦‚è¯¯åˆ é”é—®é¢˜ã€é”ä¸å¯é‡å…¥é—®é¢˜ã€‚æ‰€ä»¥Redissonå¹¶æ²¡æœ‰é€šè¿‡setNxå‘½ä»¤æ¥å®ç°åŠ é”ï¼Œè€Œæ˜¯è‡ªå·±å®ç°äº†ä¸€å¥—å®Œæˆçš„åŠ é”çš„é€»è¾‘</p>
<h3 data-id="heading-0">åŠ é”ä¸è§£é”</h3>
<p>RLockç»§æ‰¿äº†Javaçš„lockæ¥å£ï¼ŒRedissonLockç»§æ‰¿è‡ªRedissonBaseLockï¼ˆæŠ½è±¡ç±»ï¼‰ï¼Œè€ŒRedissonBaseLockåˆå®ç°äº†RLockã€‚</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">//è°ƒç”¨getLockæ—¶å€™å°±æ˜¯newäº†ä¸€ä¸ªRedissonLock</span>
<span class="hljs-keyword">public</span> <span class="hljs-title class_">RLock</span> <span class="hljs-title function_">getLock</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> name</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RedissonLock</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">commandExecutor</span>, name);
}
</code></pre>
<p>æˆ‘ä»¬é‡ç‚¹çœ‹lockæ–¹æ³•ï¼š</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">public</span> void lock() {
 Â  Â <span class="hljs-keyword">try</span> {
 Â  Â  Â  Â <span class="hljs-keyword">this</span>.lock(-<span class="hljs-number">1L</span>, (TimeUnit)<span class="hljs-literal">null</span>, <span class="hljs-literal">false</span>);
 Â   } <span class="hljs-keyword">catch</span> (InterruptedException var2) {
 Â  Â  Â  Â <span class="hljs-keyword">throw</span> new IllegalStateException();
 Â   }
}
â€‹
<span class="hljs-keyword">private</span> void lock(long leaseTime, TimeUnit unit, boolean interruptibly) throws InterruptedException {
 Â  Â long threadId = Thread.currentThread().getId();
 Â  Â <span class="hljs-comment">//è°ƒç”¨äº†tryAcquireè·å–é”ï¼Œè¿™é‡Œä¼ å…¥äº†-1Lä»£è¡¨æ²¡æœ‰æŒ‡å®šé”çš„é‡Šæ”¾æ—¶é—´ï¼Œæ­£å¸¸æƒ…å†µä¸‹å¦‚æœä¸é‡Šæ”¾æ˜¯æ°¸ä¹…æŒæœ‰ã€‚</span>
 Â  Â <span class="hljs-built_in">Long</span> ttl = <span class="hljs-keyword">this</span>.tryAcquire(-<span class="hljs-number">1L</span>, leaseTime, unit, threadId);
 Â  Â <span class="hljs-comment">//ä»¥ä¸‹ä»£ç å…ˆå¿½ç•¥</span>
 Â  Â <span class="hljs-comment">//.....</span>
}
â€‹
<span class="hljs-keyword">private</span> <span class="hljs-built_in">Long</span> tryAcquire(long waitTime, long leaseTime, TimeUnit unit, long threadId) {
 Â  Â <span class="hljs-comment">//è¿™é‡Œè°ƒç”¨getï¼Œç­‰å¾…futureè¿”å›ã€‚</span>
 Â  Â <span class="hljs-keyword">return</span> (<span class="hljs-built_in">Long</span>)<span class="hljs-keyword">this</span>.<span class="hljs-keyword">get</span>(<span class="hljs-keyword">this</span>.tryAcquireAsync0(waitTime, leaseTime, unit, threadId));
}
â€‹
<span class="hljs-keyword">private</span> RFuture&lt;<span class="hljs-built_in">Long</span>&gt; tryAcquireAsync0(long waitTime, long leaseTime, TimeUnit unit, long threadId) {
 Â  Â <span class="hljs-comment">//ä½¿ç”¨äº†çº¿ç¨‹æ± å»è·å–é”</span>
 Â  Â <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.getServiceManager().execute(() -&gt; {
 Â  Â  Â  Â <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.tryAcquireAsync(waitTime, leaseTime, unit, threadId);
 Â   });
}
<span class="hljs-comment">//é‡ç‚¹æ–¹æ³•æ¥äº†</span>
<span class="hljs-keyword">private</span> RFuture&lt;<span class="hljs-built_in">Long</span>&gt; tryAcquireAsync(long waitTime, long leaseTime, TimeUnit unit, long threadId) {
 Â  Â RFuture ttlRemainingFuture;
 Â  Â <span class="hljs-keyword">if</span> (leaseTime &gt; <span class="hljs-number">0L</span>) {
 Â  Â  Â  Â <span class="hljs-comment">//å¦‚æœè¿™é‡ŒleaseTimeä¸ä¸º0è¯´æ˜ç”¨æˆ·è®¾ç½®äº†é”çš„ç§Ÿçº¦æ—¶é—´ç›´æ¥ä¼ å…¥ã€‚</span>
 Â  Â  Â  Â ttlRemainingFuture = <span class="hljs-keyword">this</span>.tryLockInnerAsync(waitTime, leaseTime, unit, threadId, RedisCommands.EVAL_LONG);
 Â   } <span class="hljs-keyword">else</span> {
 Â  Â  Â  Â <span class="hljs-comment">//å¦‚æœè¿™é‡ŒleaseTimeä¸º0è¯´æ˜ç”¨æˆ·æ²¡æœ‰é™åˆ¶é”çš„ç§Ÿçº¦æ—¶é—´ï¼Œä½†æ˜¯è¿™é‡Œä»ç„¶ä¼šä¼ 30ç§’çš„æŒæœ‰æ—¶é—´</span>
 Â  Â  Â  Â ttlRemainingFuture = <span class="hljs-keyword">this</span>.tryLockInnerAsync(waitTime, <span class="hljs-keyword">this</span>.internalLockLeaseTime, TimeUnit.MILLISECONDS, threadId, RedisCommands.EVAL_LONG);
 Â   }
â€‹
 Â  Â CompletionStage&lt;<span class="hljs-built_in">Long</span>&gt; s = <span class="hljs-keyword">this</span>.handleNoSync(threadId, ttlRemainingFuture);
 Â  Â RFuture&lt;<span class="hljs-built_in">Long</span>&gt; ttlRemainingFuture = new CompletableFutureWrapper(s);
 Â  Â CompletionStage&lt;<span class="hljs-built_in">Long</span>&gt; f = ttlRemainingFuture.thenApply((ttlRemaining) -&gt; {
 Â  Â  Â  Â <span class="hljs-comment">//å¦‚æœä¸ºç©ºè¯´æ˜luaè·å–é”è„šæœ¬è·å¾—äº†é”</span>
 Â  Â  Â  Â <span class="hljs-keyword">if</span> (ttlRemaining == <span class="hljs-literal">null</span>) {
 Â  Â  Â  Â  Â  Â <span class="hljs-comment">//åˆ¤æ–­æ˜¯å¦å¼€å¯çœ‹é—¨ç‹—æœºåˆ¶ã€‚</span>
 Â  Â  Â  Â  Â  Â <span class="hljs-keyword">if</span> (leaseTime &gt; <span class="hljs-number">0L</span>) {
 Â  Â  Â  Â  Â  Â  Â  Â <span class="hljs-keyword">this</span>.internalLockLeaseTime = unit.toMillis(leaseTime);
 Â  Â  Â  Â  Â   } <span class="hljs-keyword">else</span> {
 Â  Â  Â  Â  Â  Â  Â  Â <span class="hljs-keyword">this</span>.scheduleExpirationRenewal(threadId);
 Â  Â  Â  Â  Â   }
 Â  Â  Â   }
â€‹
 Â  Â  Â  Â <span class="hljs-keyword">return</span> ttlRemaining;
 Â   });
 Â  Â <span class="hljs-keyword">return</span> new CompletableFutureWrapper(f);
}
&lt;T&gt; RFuture&lt;T&gt; tryLockInnerAsync(long waitTime, long leaseTime, TimeUnit unit, long threadId, RedisStrictCommand&lt;T&gt; command) {
 Â  Â <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.evalWriteSyncedNoRetryAsync(<span class="hljs-keyword">this</span>.getRawName(), LongCodec.INSTANCE, command, 
    <span class="hljs-string">"if ((redis.call('exists', KEYS[1]) == 0) or (redis.call('hexists', KEYS[1], ARGV[2]) == 1)) then "</span> +
        <span class="hljs-string">"redis.call('hincrby', KEYS[1], ARGV[2], 1); "</span> +
        <span class="hljs-string">"redis.call('pexpire', KEYS[1], ARGV[1]); "</span>+
        <span class="hljs-string">"return nil; "</span>+ 
    <span class="hljs-string">"end;"</span>+
    <span class="hljs-comment">//è¿”å›é”çš„è¿‡æœŸæ—¶é—´ã€‚</span>
    <span class="hljs-string">"return redis.call('pttl', KEYS[1]);"</span>, 
    Collections.singletonList(<span class="hljs-keyword">this</span>.getRawName()), new Object[]{unit.toMillis(leaseTime), <span class="hljs-keyword">this</span>.getLockName(threadId)});
}
</code></pre>
<p>è·å–é”çš„æ•´ä¸ªé€»è¾‘æ˜¯ï¼š
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7303c1cfaf4549c39ec9472e6462b533~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2lyNzYx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766822478&amp;x-signature=QQsH%2FZidVMS0dKLq54qchV%2F1e0E%3D" alt="åˆ†å¸ƒå¼é”è·å–è¿‡ç¨‹.drawio-1764576921173-4.png" loading="lazy"/>
é¦–å…ˆï¼Œå¦‚æœç”¨æˆ·è°ƒç”¨è·å–é”æ—¶å€™æ²¡æœ‰é™åˆ¶ç§Ÿçº¦æ—¶é—´ï¼Œredissonä¼šè‡ªåŠ¨ç»™tryLockInnerAsyncåŠ ä¸Šä¸€ä¸ª30ç§’çš„ç§Ÿçº¦æ—¶é—´ï¼Œå¹¶è°ƒç”¨scheduleExpirationRenewalè¿›è¡Œçœ‹é—¨ç‹—æœºåˆ¶</p>
<p>tryLockInnerAsyncæ˜¯æ‰§è¡Œäº†ä¸€ä¸ªluaè„šæœ¬ï¼Œé¦–å…ˆredissonä»–é‡‡ç”¨çš„æ˜¯hashæ¥å­˜æ”¾è¿™ä¸ªé”ï¼Œkeyæ˜¯é”çš„åå­—ï¼Œfieldç”±UUIDå’Œçº¿ç¨‹idç»„æˆï¼ˆUUIDæ˜¯åŒºåˆ†ä¸åŒå®¢æˆ·ç«¯ï¼Œé˜²æ­¢ä¸åŒå®¢æˆ·ç«¯ä½†æ˜¯çº¿ç¨‹åæ°å¥½ç›¸åŒï¼‰ï¼Œvalueæ˜¯é”çš„é‡å…¥æ¬¡æ•°ã€‚è¿™æ ·å°±é¿å…äº†é”çš„è¯¯åˆ ï¼Œé‡å…¥å’Œæ­»é”é—®é¢˜äº†ã€‚luaçš„å¤§è‡´æµç¨‹ä¸ºï¼š</p>
<ol>
<li>å…ˆåˆ¤æ–­å½“å‰é”æ˜¯å¦è¢«æŒæœ‰æˆ–è€…æŒæœ‰è€…æ˜¯å¦æ˜¯å½“å‰çº¿ç¨‹ï¼Œå¦‚æœæ˜¯çš„è¯é‡å…¥æ¬¡æ•°åŠ 1ï¼Œå¹¶è®¾ç½®/é‡ç½®æ•´ä¸ªé” Key çš„è¿‡æœŸæ—¶é—´ï¼ˆé˜²æ­¢æ­»é”ï¼‰ç„¶åè¿”å›ã€‚</li>
<li>å¦‚æœä¸Šé¢ifä¸æˆç«‹è¯´æ˜é”è¢«<strong>åˆ«äºº</strong>æŒæœ‰äº†ï¼Œåˆ™è¿”å›å½“å‰é”å‰©ä½™çš„å­˜æ´»æ—¶é—´ï¼ˆTTLï¼‰ã€‚å®¢æˆ·ç«¯æ‹¿åˆ°è¿™ä¸ªæ—¶é—´åï¼Œä¼šç­‰å¾…è¿™ä¹ˆä¹…å†é‡è¯•ã€‚</li>
</ol>
<p>å›åˆ°åˆšåˆšæˆ‘ä»¬å¿½ç•¥çš„ä»£ç ï¼š</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">lock</span><span class="hljs-params">(<span class="hljs-type">long</span> leaseTime, TimeUnit unit, <span class="hljs-type">boolean</span> interruptibly)</span> <span class="hljs-keyword">throws</span> InterruptedException {
 Â  Â <span class="hljs-type">long</span> <span class="hljs-variable">threadId</span> <span class="hljs-operator">=</span> Thread.currentThread().getId();
 Â  Â <span class="hljs-type">Long</span> <span class="hljs-variable">ttl</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.tryAcquire(-<span class="hljs-number">1L</span>, leaseTime, unit, threadId);
 Â  Â <span class="hljs-comment">//å¦‚æœè¿™é‡Œttlä¸ä¸ºç©ºè¯´æ˜é”è¢«äººå æœ‰äº†ã€‚</span>
 Â  Â <span class="hljs-keyword">if</span> (ttl != <span class="hljs-literal">null</span>) {
 Â  Â  Â  Â <span class="hljs-comment">//æ­¤æ—¶ä½¿ç”¨pub/subè®¢é˜…è¿™ä¸ªç®¡é“</span>
 Â  Â  Â  Â CompletableFuture&lt;RedissonLockEntry&gt; future = <span class="hljs-built_in">this</span>.subscribe(threadId);
 Â  Â  Â  Â <span class="hljs-built_in">this</span>.pubSub.timeout(future);
 Â  Â  Â  Â <span class="hljs-comment">//å†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ªSemaphoreç”¨äºæ§åˆ¶æœ¬åœ°çº¿ç¨‹çš„é˜»å¡å’Œå”¤é†’</span>
 Â  Â  Â  Â RedissonLockEntry entry;
 Â  Â  Â  Â <span class="hljs-keyword">if</span> (interruptibly) {
 Â  Â  Â  Â  Â  Â entry = (RedissonLockEntry)<span class="hljs-built_in">this</span>.commandExecutor.getInterrupted(future);
 Â  Â  Â   } <span class="hljs-keyword">else</span> {
 Â  Â  Â  Â  Â  Â entry = (RedissonLockEntry)<span class="hljs-built_in">this</span>.commandExecutor.get(future);
 Â  Â  Â   }
â€‹
 Â  Â  Â  Â <span class="hljs-keyword">try</span> {
 Â  Â  Â  Â  Â  Â <span class="hljs-comment">//æ­»å¾ªç¯ç›´åˆ°è·å–é”æˆ–è€…è¢«ä¸­æ–­</span>
 Â  Â  Â  Â  Â  Â <span class="hljs-keyword">while</span>(<span class="hljs-literal">true</span>) {
 Â  Â  Â  Â  Â  Â  Â  Â <span class="hljs-comment">//å…ˆä¹è§‚æŸ¥è¯¢ä¸€æ¬¡</span>
 Â  Â  Â  Â  Â  Â  Â  Â ttl = <span class="hljs-built_in">this</span>.tryAcquire(-<span class="hljs-number">1L</span>, leaseTime, unit, threadId);
 Â  Â  Â  Â  Â  Â  Â  Â <span class="hljs-keyword">if</span> (ttl == <span class="hljs-literal">null</span>) {
 Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <span class="hljs-keyword">return</span>;
 Â  Â  Â  Â  Â  Â  Â   }
             Â  <span class="hljs-comment">//ä»ç„¶æ²¡æœ‰è·å–åˆ°é”åˆ™è¿›å…¥é˜»å¡é˜¶æ®µ</span>
 Â  Â  Â  Â  Â  Â  Â  Â <span class="hljs-keyword">if</span> (ttl &gt;= <span class="hljs-number">0L</span>) {
 Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <span class="hljs-keyword">try</span> {
 Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <span class="hljs-comment">//é€šè¿‡ttlæ—¶é—´åˆ¤æ–­é”è¿˜æœ‰å¤šä¹…é‡Šæ”¾ï¼Œä»è€Œåˆ¤æ–­é˜»å¡å¤šä¹…ï¼Œé¿å…cpuç©ºè½¬å¸¦æ¥æ€§èƒ½æ¶ˆè€—ï¼Œç²¾å‡†åœ¨é”é‡Šæ”¾æ—¶å€™å”¤é†’</span>
 Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <span class="hljs-comment">//å½“æœ‰äººé‡Šæ”¾é”äº†,redissonç›‘å¬åˆ°äº†ä¹‹åè°ƒç”¨entry.getLatch().release(),æˆ–è€…åˆ°è¾¾ttläº†éƒ½ä¼šä½¿çº¿ç¨‹è¢«å”¤é†’</span>
 Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â entry.getLatch().tryAcquire(ttl, TimeUnit.MILLISECONDS);
 Â  Â  Â  Â  Â  Â  Â  Â  Â   } <span class="hljs-keyword">catch</span> (InterruptedException var14) {
 Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <span class="hljs-type">InterruptedException</span> <span class="hljs-variable">e</span> <span class="hljs-operator">=</span> var14;
 Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <span class="hljs-keyword">if</span> (interruptibly) {
 Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <span class="hljs-keyword">throw</span> e;
 Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â   }
 Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <span class="hljs-comment">//å‡ºç°å¼‚å¸¸äº†ï¼Œé‡æ–°æŠ¢é”</span>
 Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â entry.getLatch().tryAcquire(ttl, TimeUnit.MILLISECONDS);
 Â  Â  Â  Â  Â  Â  Â  Â  Â   }
 Â  Â  Â  Â  Â  Â  Â   } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (interruptibly) {
 Â  Â  Â  Â  Â  Â  Â  Â  Â  Â entry.getLatch().acquire();
 Â  Â  Â  Â  Â  Â  Â   } <span class="hljs-keyword">else</span> {
 Â  Â  Â  Â  Â  Â  Â  Â  Â  Â entry.getLatch().acquireUninterruptibly();
 Â  Â  Â  Â  Â  Â  Â   }
 Â  Â  Â  Â  Â   }
 Â  Â  Â   } <span class="hljs-keyword">finally</span> {
 Â  Â  Â  Â  Â  Â <span class="hljs-comment">//æœ€åç»ˆæ­¢è®¢é˜…ã€‚</span>
 Â  Â  Â  Â  Â  Â <span class="hljs-built_in">this</span>.unsubscribe(entry, threadId);
 Â  Â  Â   }
 Â   }
}
</code></pre>
<p>è§£é”çš„é€»è¾‘ï¼š</p>
<p>è·ŸåŠ é”é€»è¾‘ä¸€æ ·éƒ½æ˜¯å¼‚æ­¥è½¬æ¢åŒæ­¥ã€‚</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> RFuture&lt;Void&gt; <span class="hljs-title function_">unlockAsync</span><span class="hljs-params">(<span class="hljs-type">long</span> threadId)</span> {
 Â  Â <span class="hljs-type">String</span> <span class="hljs-variable">requestId</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getServiceManager().generateId();
 Â  Â <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.getServiceManager().execute(() -&gt; {
 Â  Â  Â  Â <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.unlockAsync0(threadId, requestId);
 Â   });
}
â€‹
<span class="hljs-keyword">private</span> RFuture&lt;Void&gt; <span class="hljs-title function_">unlockAsync0</span><span class="hljs-params">(<span class="hljs-type">long</span> threadId, String requestId)</span> {
 Â  Â CompletionStage&lt;Boolean&gt; future = <span class="hljs-built_in">this</span>.unlockInnerAsync(threadId, requestId);
 Â  Â <span class="hljs-comment">//å¤„ç†å¼‚å¸¸</span>
 Â  Â CompletionStage&lt;Void&gt; f = future.handle((res, e) -&gt; {
 Â  Â  Â  Â <span class="hljs-built_in">this</span>.cancelExpirationRenewal(threadId, res);
 Â  Â  Â  Â <span class="hljs-keyword">if</span> (e != <span class="hljs-literal">null</span>) {
 Â  Â  Â  Â  Â  Â <span class="hljs-keyword">if</span> (e <span class="hljs-keyword">instanceof</span> CompletionException) {
 Â  Â  Â  Â  Â  Â  Â  Â <span class="hljs-keyword">throw</span> (CompletionException)e;
 Â  Â  Â  Â  Â   } <span class="hljs-keyword">else</span> {
 Â  Â  Â  Â  Â  Â  Â  Â <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CompletionException</span>(e);
 Â  Â  Â  Â  Â   }
 Â  Â  Â   } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (res == <span class="hljs-literal">null</span>) {
 Â  Â  Â  Â  Â  Â <span class="hljs-type">IllegalMonitorStateException</span> <span class="hljs-variable">cause</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalMonitorStateException</span>(<span class="hljs-string">"attempt to unlock lock, not locked by current thread by node id: "</span> + <span class="hljs-built_in">this</span>.id + <span class="hljs-string">" thread-id: "</span> + threadId);
 Â  Â  Â  Â  Â  Â <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CompletionException</span>(cause);
 Â  Â  Â   } <span class="hljs-keyword">else</span> {
 Â  Â  Â  Â  Â  Â <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
 Â  Â  Â   }
 Â   });
 Â  Â <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CompletableFutureWrapper</span>(f);
}
â€‹
<span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> RFuture&lt;Boolean&gt; <span class="hljs-title function_">unlockInnerAsync</span><span class="hljs-params">(<span class="hljs-type">long</span> threadId, String requestId)</span> {
 Â  Â <span class="hljs-keyword">if</span> (requestId == <span class="hljs-literal">null</span>) {
 Â  Â  Â  Â requestId = <span class="hljs-built_in">this</span>.getServiceManager().generateId();
 Â   }
â€‹
 Â  Â <span class="hljs-type">MasterSlaveServersConfig</span> <span class="hljs-variable">config</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getServiceManager().getConfig();
 Â  Â <span class="hljs-type">long</span> <span class="hljs-variable">timeout</span> <span class="hljs-operator">=</span> ((<span class="hljs-type">long</span>)config.getTimeout() + config.getRetryDelay().calcDelay(config.getRetryAttempts()).toMillis()) * (<span class="hljs-type">long</span>)config.getRetryAttempts();
 Â  Â timeout = Math.max(timeout, <span class="hljs-number">1L</span>);
 Â  Â <span class="hljs-comment">//å¼‚æ­¥é‡Šæ”¾é”</span>
 Â  Â RFuture&lt;Boolean&gt; r = <span class="hljs-built_in">this</span>.unlockInnerAsync(threadId, requestId, (<span class="hljs-type">int</span>)timeout);
 Â  Â CompletionStage&lt;Boolean&gt; ff = r.thenApply((v) -&gt; {
 Â  Â  Â  Â <span class="hljs-type">CommandAsyncExecutor</span> <span class="hljs-variable">ce</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.commandExecutor;
 Â  Â  Â  Â <span class="hljs-keyword">if</span> (ce <span class="hljs-keyword">instanceof</span> CommandBatchService) {
 Â  Â  Â  Â  Â  Â ce = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CommandBatchService</span>(<span class="hljs-built_in">this</span>.commandExecutor);
 Â  Â  Â   }
â€‹
 Â  Â  Â   ((CommandAsyncExecutor)ce).writeAsync(<span class="hljs-built_in">this</span>.getRawName(), LongCodec.INSTANCE, RedisCommands.DEL, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]{<span class="hljs-built_in">this</span>.getUnlockLatchName(<span class="hljs-built_in">this</span>.id)});
 Â  Â  Â  Â <span class="hljs-keyword">if</span> (ce <span class="hljs-keyword">instanceof</span> CommandBatchService) {
 Â  Â  Â  Â  Â   ((CommandBatchService)ce).executeAsync();
 Â  Â  Â   }
â€‹
 Â  Â  Â  Â <span class="hljs-keyword">return</span> v;
 Â   });
 Â  Â <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CompletableFutureWrapper</span>(ff);
}
â€‹
<span class="hljs-keyword">protected</span> RFuture&lt;Boolean&gt; <span class="hljs-title function_">unlockInnerAsync</span><span class="hljs-params">(<span class="hljs-type">long</span> threadId, String requestId, <span class="hljs-type">int</span> timeout)</span> {
 Â  Â <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.evalWriteSyncedNoRetryAsync(<span class="hljs-built_in">this</span>.getRawName(), LongCodec.INSTANCE, RedisCommands.EVAL_BOOLEAN,
<span class="hljs-comment">//é˜²é‡æ£€æŸ¥ï¼ˆå¹‚ç­‰æ€§ï¼‰</span>
<span class="hljs-string">"local val = redis.call('get', KEYS[3]);"</span>+
<span class="hljs-string">"if val ~= false then "</span>+
    <span class="hljs-string">"return tonumber(val);"</span>+
<span class="hljs-string">"end;"</span>+
<span class="hljs-comment">//åˆ¤æ–­æ˜¯å¦æŒæœ‰é”</span>
<span class="hljs-string">"if (redis.call('hexists', KEYS[1], ARGV[3]) == 0) then "</span>+
    <span class="hljs-string">"return nil;"</span>+
<span class="hljs-string">"end; "</span>+
<span class="hljs-comment">//æ‰£å‡é‡å…¥æ¬¡æ•°</span>
<span class="hljs-string">"local counter = redis.call('hincrby', KEYS[1], ARGV[3], -1); "</span>+
<span class="hljs-comment">//åˆ¤æ–­æ˜¯â€œé‡å…¥é‡Šæ”¾â€è¿˜æ˜¯â€œå½»åº•é‡Šæ”¾â€</span>
<span class="hljs-string">"if (counter &gt; 0) then "</span>+
    <span class="hljs-comment">//é‡å…¥æ¬¡æ•°å‡1</span>
    <span class="hljs-string">"redis.call('pexpire', KEYS[1], ARGV[2]); "</span>+
    <span class="hljs-string">"redis.call('set', KEYS[3], 0, 'px', ARGV[5]); "</span>+
<span class="hljs-string">"return 0; "</span>+
<span class="hljs-string">"else "</span>+
    <span class="hljs-comment">//å½»åº•é‡Šæ”¾é”</span>
    <span class="hljs-string">"redis.call('del', KEYS[1]); "</span>+
    <span class="hljs-comment">//å‘é€é˜Ÿåˆ—æ¶ˆæ¯</span>
    <span class="hljs-string">"redis.call(ARGV[4], KEYS[2], ARGV[1]); "</span>+
    <span class="hljs-string">"redis.call('set', KEYS[3], 1, 'px', ARGV[5]); "</span>+
    <span class="hljs-string">"return 1; "</span>+
<span class="hljs-string">"end; "</span>,
Arrays.asList(<span class="hljs-built_in">this</span>.getRawName(), <span class="hljs-built_in">this</span>.getChannelName(), <span class="hljs-built_in">this</span>.getUnlockLatchName(requestId)), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]{LockPubSub.UNLOCK_MESSAGE, <span class="hljs-built_in">this</span>.internalLockLeaseTime, <span class="hljs-built_in">this</span>.getLockName(threadId), <span class="hljs-built_in">this</span>.getSubscribeService().getPublishCommand(), timeout});
}
</code></pre>
<p>luaçš„æµç¨‹ä¸ºï¼š</p>
<p>å…ˆå»æŸ¥ä¸€ä¸‹ KEYS[3]ï¼ˆæŸ¥çœ‹è§£é”è¯·æ±‚çš„ç»“æœç¼“å­˜ï¼‰æ˜¯å¦å­˜åœ¨ã€‚å¦‚æœå­˜åœ¨ï¼Œè¯´æ˜<strong>è¿™ä¸ªè¯·æ±‚ä¹‹å‰å·²ç»å¤„ç†è¿‡äº†</strong>ï¼ˆå¯èƒ½æ˜¯ç½‘ç»œæ³¢åŠ¨å¯¼è‡´å®¢æˆ·ç«¯ä»¥ä¸ºè¶…æ—¶äº†ï¼Œé‡å‘äº†è¯·æ±‚ï¼‰ã€‚ç›´æ¥è¿”å›ä¹‹å‰ç¼“å­˜çš„ç»“æœï¼ˆ0 æˆ– 1ï¼‰ï¼Œä¸éœ€è¦å†æ‰§è¡Œåé¢çš„é€»è¾‘ã€‚è¿™ä¿è¯äº†<strong>å¹‚ç­‰æ€§</strong>ã€‚</p>
<ol start="0">
<li>æ£€æŸ¥ Hash KEYS[1] ä¸­æ˜¯å¦å­˜åœ¨å½“å‰çº¿ç¨‹ ARGV[3]ã€‚å¦‚æœä¸å­˜åœ¨ï¼ˆ== 0ï¼‰ï¼Œè¯´æ˜å½“å‰çº¿ç¨‹æ ¹æœ¬æ²¡æœ‰æŒæœ‰è¿™æŠŠé”ã€‚è¿”å› nilï¼ˆJava å®¢æˆ·ç«¯ä¼šæŠ›å‡º IllegalMonitorStateExceptionï¼‰ã€‚</li>
<li>å°†è¯¥çº¿ç¨‹çš„åŠ é”è®¡æ•°å™¨å‡ 1ï¼Œcounter æ˜¯å‡å®Œä¹‹åå‰©ä¸‹çš„æ¬¡æ•°ã€‚</li>
<li>å¦‚æœcounter &gt; 0ï¼Œè¯´æ˜é”é‡å…¥äº†ã€‚pexpireï¼šåˆ·æ–°é”çš„è¿‡æœŸæ—¶é—´ï¼ˆçœ‹é—¨ç‹—æ—¶é—´ï¼‰ï¼Œåªè¦é”è¿˜æ²¡å½»åº•é‡Šæ”¾ï¼Œå°±å¾—ç»™å®ƒç»­å‘½ã€‚set KEYS[3] 0ï¼šè®°å½•æœ¬æ¬¡è¯·æ±‚ç»“æœä¸º 0ï¼ˆè¡¨ç¤ºæœªå®Œå…¨é‡Šæ”¾ï¼‰ã€‚è¿”å› 0ï¼Œä»£è¡¨è¿˜æœªé‡Šæ”¾é”ã€‚</li>
<li>å¦‚æœcounter&lt;=0ï¼Œè¯´æ˜é”æ­¤æ—¶å¯ä»¥é‡Šæ”¾äº†ï¼Œè¿™é‡Œä¼šå…ˆåˆ é™¤è¿™ä¸ªé”å¯¹åº”çš„keyï¼Œç„¶åè°ƒç”¨<code>redis.call(ARGV[4], KEYS[2], ARGV[1]);</code>è¿™é‡ŒARGC[4]å…¶å®é€šå¸¸æ˜¯publishå‘é€æ¶ˆæ¯ï¼Œä¹‹æ‰€ä»¥ä¸å†™æ­»æ˜¯å› ä¸ºé›†ç¾¤ä¸‹å¯ä»¥ç”¨spublishåŠ å¿«æ€§èƒ½ã€‚è¿™é‡Œå‘é€æ¶ˆæ¯æ˜¯ä¸ºäº†å‰æ–‡æåˆ°çš„ï¼Œå‘Šè¯‰ç›‘å¬è€…é”å·²ç»é‡Šæ”¾ã€‚set KEYS[3] 1ï¼šç¼“å­˜æœ¬æ¬¡è¯·æ±‚ç»“æœä¸º 1ï¼Œå¹¶å°†1è¿”å›ï¼Œä»£è¡¨é”æˆåŠŸé‡Šæ”¾äº†</li>
</ol>
<p>è¿™é‡Œä¹‹æ‰€ä»¥è¦å¤šå‡ºä¸€ä¸ªKEY[3]æ˜¯ä¸ºäº†<strong>åšå¹‚ç­‰</strong>ã€‚KEY[3]å‘½åä¸€èˆ¬ä¸º{é”å‰ç¼€}:{é”å}:{requestId}ï¼Œæ¯æ¬¡è¯·æ±‚æ—¶å€™éƒ½ä¼šå¸¦ä¸Šä¸åŒçš„requestIdï¼Œvlaueæ˜¯requestIdè¯·æ±‚çš„è§£é”ç»“æœ</p>
<p>å­˜åœ¨ä¸€ç§å¯èƒ½ï¼Œå®¢æˆ·ç«¯é‡å…¥äº†2æ¬¡é”ï¼Œå®¢æˆ·ç«¯ç¬¬ä¸€æ¬¡è°ƒç”¨unlockæ—¶å€™ï¼Œredisæ­£å¸¸æ‰§è¡Œäº†è§£é”é€»è¾‘ï¼Œå¹¶æ‰£å‡äº†1æ¬¡é”è®°å½•ï¼Œä½†æ˜¯ç”±äºç½‘ç»œæ³¢åŠ¨ï¼Œå“åº”ä¸¢å¤±äº†ï¼Œæ­¤æ—¶å®¢æˆ·ç«¯ä¼šé‡æ–°å‘èµ·ä¸€æ¬¡è¯·æ±‚ï¼Œå¯¼è‡´é‡å¤æ‰£å‡ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå°±åˆ©ç”¨key[3]ï¼Œåˆ¤æ–­ä¸€ä¸‹ç›¸åŒçš„è¯·æ±‚idæ˜¯å¦æœ‰è®°å½•å¦‚æœæ˜¯å°±ä»£è¡¨ç¡®å®å‘é€äº†å“åº”ä¸¢å¤±ï¼Œç›´æ¥å°†ä¸Šæ¬¡çš„æ•°æ®è¿”å›ï¼Œé¿å…é‡å¤è§£é”ã€‚</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eedf6a2fdad34405a4e6a6423c17e22a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2lyNzYx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766822478&amp;x-signature=KTTnPGHIo7Up7jT%2F0NvTi7QGW1I%3D" alt="Redissoné”æ•°æ®ç»“æ„.drawio.png" loading="lazy"/></p>
<h3 data-id="heading-1">å…¬å¹³é”</h3>
<p>ä»¥ä¸Šé”æ˜¯é»˜è®¤éå…¬å¹³é”ï¼Œæ‰€æœ‰çº¿ç¨‹éƒ½å»äº‰æŠ¢é”ï¼Œè€Œå…¬å¹³é”åˆ™æ˜¯è¿›å…¥é˜Ÿåˆ—ç­‰å¾…ï¼Œé˜²æ­¢é¥¥é¥¿é—®é¢˜ã€‚</p>
<p>å½“æˆ‘ä»¬getFairLockæ—¶å€™å…¶å®æ˜¯newäº†ä¸€ä¸ªRedissonFairLock</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">public</span> <span class="hljs-title class_">RLock</span> <span class="hljs-title function_">getFairLock</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> name</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RedissonFairLock</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">commandExecutor</span>, name);
}
</code></pre>
<p>RedissonFairLockç»§æ‰¿è‡ªRedissonLockä¹Ÿå°±æ˜¯è¯´åŠ é”çš„æµç¨‹éƒ½æ˜¯å¤§è‡´ç›¸åŒçš„ã€‚RedissonFairLocké‡å†™äº†tryLockInnerAsyncæ–¹æ³•</p>
<pre><code class="hljs language-ini" lang="ini">&lt;T&gt; RFuture&lt;T&gt; tryLockInnerAsync(long waitTime, long leaseTime, TimeUnit unit, long threadId, RedisStrictCommand&lt;T&gt; command) {
 Â  Â long <span class="hljs-attr">wait</span> = this.threadWaitTime<span class="hljs-comment">;</span>
 Â  Â if (waitTime &gt; 0L) {
 Â  Â  Â  Â <span class="hljs-attr">wait</span> = unit.toMillis(waitTime)<span class="hljs-comment">;</span>
 Â   }
â€‹
 Â  Â long <span class="hljs-attr">currentTime</span> = System.currentTimeMillis()<span class="hljs-comment">;</span>
 Â  Â if (<span class="hljs-attr">command</span> == RedisCommands.EVAL_NULL_BOOLEAN) {
 Â  Â  Â  Â return this.commandExecutor.syncedEvalNoRetry(
 Â  Â  Â  Â  Â  Â this.getRawName(),
 Â  Â  Â  Â  Â  Â LongCodec.INSTANCE,
 Â  Â  Â  Â  Â  Â command,
 Â  Â  Â  Â  Â  Â // Luaè„šæœ¬ - ç”¨äºè·å–é”
 Â  Â  Â  Â  Â  Â "while true do " +
 Â  Â  Â  Â  Â  Â " Â   local <span class="hljs-attr">firstThreadId2</span> = redis.call(<span class="hljs-string">'lindex'</span>, KEYS[<span class="hljs-number">2</span>], <span class="hljs-number">0</span>)<span class="hljs-comment">; " +</span>
 Â  Â  Â  Â  Â  Â " Â   if <span class="hljs-attr">firstThreadId2</span> == <span class="hljs-literal">false</span> then <span class="hljs-string">" +
 Â  Â  Â  Â  Â  Â "</span> Â  Â  Â   break<span class="hljs-comment">; " +</span>
 Â  Â  Â  Â  Â  Â " Â   end<span class="hljs-comment">; " +</span>
 Â  Â  Â  Â  Â  Â " Â   local <span class="hljs-attr">timeout</span> = redis.call(<span class="hljs-string">'zscore'</span>, KEYS[<span class="hljs-number">3</span>], firstThreadId2)<span class="hljs-comment">; " +</span>
 Â  Â  Â  Â  Â  Â " Â   if timeout ~= false and tonumber(timeout) &lt;= tonumber(ARGV<span class="hljs-section">[3]</span>) then " +
 Â  Â  Â  Â  Â  Â " Â  Â  Â   redis.call('zrem', KEYS<span class="hljs-section">[3]</span>, firstThreadId2)<span class="hljs-comment">; " +</span>
 Â  Â  Â  Â  Â  Â " Â  Â  Â   redis.call('lpop', KEYS<span class="hljs-section">[2]</span>)<span class="hljs-comment">; " +</span>
 Â  Â  Â  Â  Â  Â " Â   else " +
 Â  Â  Â  Â  Â  Â " Â  Â  Â   break<span class="hljs-comment">; " +</span>
 Â  Â  Â  Â  Â  Â " Â   end<span class="hljs-comment">; " +</span>
 Â  Â  Â  Â  Â  Â "end<span class="hljs-comment">; " +</span>
 Â  Â  Â  Â  Â  Â "if (redis.call('exists', KEYS<span class="hljs-section">[1]</span>) == 0) and ((redis.call('exists', KEYS<span class="hljs-section">[2]</span>) == 0) or (redis.call('lindex', KEYS<span class="hljs-section">[2]</span>, 0) == ARGV<span class="hljs-section">[2]</span>)) then " +
 Â  Â  Â  Â  Â  Â " Â   redis.call('lpop', KEYS<span class="hljs-section">[2]</span>)<span class="hljs-comment">; " +</span>
 Â  Â  Â  Â  Â  Â " Â   redis.call('zrem', KEYS<span class="hljs-section">[3]</span>, ARGV<span class="hljs-section">[2]</span>)<span class="hljs-comment">; " +</span>
 Â  Â  Â  Â  Â  Â " Â   local <span class="hljs-attr">keys</span> = redis.call(<span class="hljs-string">'zrange'</span>, KEYS[<span class="hljs-number">3</span>], <span class="hljs-number">0</span>, -<span class="hljs-number">1</span>)<span class="hljs-comment">; " +</span>
 Â  Â  Â  Â  Â  Â " Â   for <span class="hljs-attr">i</span> = <span class="hljs-number">1</span>, <span class="hljs-comment">#keys, 1 do " +</span>
 Â  Â  Â  Â  Â  Â " Â  Â  Â   redis.call('zincrby', KEYS<span class="hljs-section">[3]</span>, -tonumber(ARGV<span class="hljs-section">[4]</span>), keys<span class="hljs-section">[i]</span>)<span class="hljs-comment">; " +</span>
 Â  Â  Â  Â  Â  Â " Â   end<span class="hljs-comment">; " +</span>
 Â  Â  Â  Â  Â  Â " Â   redis.call('hset', KEYS<span class="hljs-section">[1]</span>, ARGV<span class="hljs-section">[2]</span>, 1)<span class="hljs-comment">; " +</span>
 Â  Â  Â  Â  Â  Â " Â   redis.call('pexpire', KEYS<span class="hljs-section">[1]</span>, ARGV<span class="hljs-section">[1]</span>)<span class="hljs-comment">; " +</span>
 Â  Â  Â  Â  Â  Â " Â   return nil<span class="hljs-comment">; " +</span>
 Â  Â  Â  Â  Â  Â "end<span class="hljs-comment">; " +</span>
 Â  Â  Â  Â  Â  Â "if (redis.call('hexists', KEYS<span class="hljs-section">[1]</span>, ARGV<span class="hljs-section">[2]</span>) == 1) then " +
 Â  Â  Â  Â  Â  Â " Â   redis.call('hincrby', KEYS<span class="hljs-section">[1]</span>, ARGV<span class="hljs-section">[2]</span>, 1)<span class="hljs-comment">; " +</span>
 Â  Â  Â  Â  Â  Â " Â   redis.call('pexpire', KEYS<span class="hljs-section">[1]</span>, ARGV<span class="hljs-section">[1]</span>)<span class="hljs-comment">; " +</span>
 Â  Â  Â  Â  Â  Â " Â   return nil<span class="hljs-comment">; " +</span>
 Â  Â  Â  Â  Â  Â "end<span class="hljs-comment">; " +</span>
 Â  Â  Â  Â  Â  Â "return 1<span class="hljs-comment">;",</span>
 Â  Â  Â  Â  Â  Â Arrays.asList(this.getRawName(), this.threadsQueueName, this.timeoutSetName),
 Â  Â  Â  Â  Â  Â new Object<span class="hljs-section">[]</span>{unit.toMillis(leaseTime), this.getLockName(threadId), currentTime, wait}
 Â  Â  Â   )<span class="hljs-comment">;</span>
 Â   } else if (<span class="hljs-attr">command</span> == RedisCommands.EVAL_LONG) {
 Â  Â  Â  Â return this.commandExecutor.syncedEvalNoRetry(
 Â  Â  Â  Â  Â  Â this.getRawName(),
 Â  Â  Â  Â  Â  Â LongCodec.INSTANCE,
 Â  Â  Â  Â  Â  Â command,
 Â  Â  Â  Â  Â  Â // Luaè„šæœ¬ - ç”¨äºå°è¯•è·å–é”å¹¶è¿”å›TTL
 Â  Â  Â  Â  Â  Â "while true do " +
 Â  Â  Â  Â  Â  Â " Â   local <span class="hljs-attr">firstThreadId2</span> = redis.call(<span class="hljs-string">'lindex'</span>, KEYS[<span class="hljs-number">2</span>], <span class="hljs-number">0</span>)<span class="hljs-comment">; " +</span>
 Â  Â  Â  Â  Â  Â " Â   if <span class="hljs-attr">firstThreadId2</span> == <span class="hljs-literal">false</span> then <span class="hljs-string">" +
 Â  Â  Â  Â  Â  Â "</span> Â  Â  Â   break<span class="hljs-comment">; " +</span>
 Â  Â  Â  Â  Â  Â " Â   end<span class="hljs-comment">; " +</span>
 Â  Â  Â  Â  Â  Â " Â   local <span class="hljs-attr">timeout</span> = redis.call(<span class="hljs-string">'zscore'</span>, KEYS[<span class="hljs-number">3</span>], firstThreadId2)<span class="hljs-comment">; " +</span>
 Â  Â  Â  Â  Â  Â " Â   if timeout ~= false and tonumber(timeout) &lt;= tonumber(ARGV<span class="hljs-section">[4]</span>) then " +
 Â  Â  Â  Â  Â  Â " Â  Â  Â   redis.call('zrem', KEYS<span class="hljs-section">[3]</span>, firstThreadId2)<span class="hljs-comment">; " +</span>
 Â  Â  Â  Â  Â  Â " Â  Â  Â   redis.call('lpop', KEYS<span class="hljs-section">[2]</span>)<span class="hljs-comment">; " +</span>
 Â  Â  Â  Â  Â  Â " Â   else " +
 Â  Â  Â  Â  Â  Â " Â  Â  Â   break<span class="hljs-comment">; " +</span>
 Â  Â  Â  Â  Â  Â " Â   end<span class="hljs-comment">; " +</span>
 Â  Â  Â  Â  Â  Â "end<span class="hljs-comment">; " +</span>
 Â  Â  Â  Â  Â  Â "if (redis.call('exists', KEYS<span class="hljs-section">[1]</span>) == 0) and ((redis.call('exists', KEYS<span class="hljs-section">[2]</span>) == 0) or (redis.call('lindex', KEYS<span class="hljs-section">[2]</span>, 0) == ARGV<span class="hljs-section">[2]</span>)) then " +
 Â  Â  Â  Â  Â  Â " Â   redis.call('lpop', KEYS<span class="hljs-section">[2]</span>)<span class="hljs-comment">; " +</span>
 Â  Â  Â  Â  Â  Â " Â   redis.call('zrem', KEYS<span class="hljs-section">[3]</span>, ARGV<span class="hljs-section">[2]</span>)<span class="hljs-comment">; " +</span>
 Â  Â  Â  Â  Â  Â " Â   local <span class="hljs-attr">keys</span> = redis.call(<span class="hljs-string">'zrange'</span>, KEYS[<span class="hljs-number">3</span>], <span class="hljs-number">0</span>, -<span class="hljs-number">1</span>)<span class="hljs-comment">; " +</span>
 Â  Â  Â  Â  Â  Â " Â   for <span class="hljs-attr">i</span> = <span class="hljs-number">1</span>, <span class="hljs-comment">#keys, 1 do " +</span>
 Â  Â  Â  Â  Â  Â " Â  Â  Â   redis.call('zincrby', KEYS<span class="hljs-section">[3]</span>, -tonumber(ARGV<span class="hljs-section">[3]</span>), keys<span class="hljs-section">[i]</span>)<span class="hljs-comment">; " +</span>
 Â  Â  Â  Â  Â  Â " Â   end<span class="hljs-comment">; " +</span>
 Â  Â  Â  Â  Â  Â " Â   redis.call('hset', KEYS<span class="hljs-section">[1]</span>, ARGV<span class="hljs-section">[2]</span>, 1)<span class="hljs-comment">; " +</span>
 Â  Â  Â  Â  Â  Â " Â   redis.call('pexpire', KEYS<span class="hljs-section">[1]</span>, ARGV<span class="hljs-section">[1]</span>)<span class="hljs-comment">; " +</span>
 Â  Â  Â  Â  Â  Â " Â   return nil<span class="hljs-comment">; " +</span>
 Â  Â  Â  Â  Â  Â "end<span class="hljs-comment">; " +</span>
 Â  Â  Â  Â  Â  Â "if redis.call('hexists', KEYS<span class="hljs-section">[1]</span>, ARGV<span class="hljs-section">[2]</span>) == 1 then " +
 Â  Â  Â  Â  Â  Â " Â   redis.call('hincrby', KEYS<span class="hljs-section">[1]</span>, ARGV<span class="hljs-section">[2]</span>, 1)<span class="hljs-comment">; " +</span>
 Â  Â  Â  Â  Â  Â " Â   redis.call('pexpire', KEYS<span class="hljs-section">[1]</span>, ARGV<span class="hljs-section">[1]</span>)<span class="hljs-comment">; " +</span>
 Â  Â  Â  Â  Â  Â " Â   return nil<span class="hljs-comment">; " +</span>
 Â  Â  Â  Â  Â  Â "end<span class="hljs-comment">; " +</span>
 Â  Â  Â  Â  Â  Â "local <span class="hljs-attr">timeout</span> = redis.call(<span class="hljs-string">'zscore'</span>, KEYS[<span class="hljs-number">3</span>], ARGV[<span class="hljs-number">2</span>])<span class="hljs-comment">; " +</span>
 Â  Â  Â  Â  Â  Â "if timeout ~= false then " +
 Â  Â  Â  Â  Â  Â " Â   local <span class="hljs-attr">ttl</span> = redis.call(<span class="hljs-string">'pttl'</span>, KEYS[<span class="hljs-number">1</span>])<span class="hljs-comment">; " +</span>
 Â  Â  Â  Â  Â  Â " Â   return math.max(0, ttl)<span class="hljs-comment">; " +</span>
 Â  Â  Â  Â  Â  Â "end<span class="hljs-comment">; " +</span>
 Â  Â  Â  Â  Â  Â "local <span class="hljs-attr">lastThreadId</span> = redis.call(<span class="hljs-string">'lindex'</span>, KEYS[<span class="hljs-number">2</span>], -<span class="hljs-number">1</span>)<span class="hljs-comment">; " +</span>
 Â  Â  Â  Â  Â  Â "local ttl<span class="hljs-comment">; " +</span>
 Â  Â  Â  Â  Â  Â "if lastThreadId ~= false and lastThreadId ~= ARGV<span class="hljs-section">[2]</span> and redis.call('zscore', KEYS<span class="hljs-section">[3]</span>, lastThreadId) ~= false then " +
 Â  Â  Â  Â  Â  Â " Â   <span class="hljs-attr">ttl</span> = tonumber(redis.call(<span class="hljs-string">'zscore'</span>, KEYS[<span class="hljs-number">3</span>], lastThreadId)) - tonumber(ARGV[<span class="hljs-number">4</span>])<span class="hljs-comment">; " +</span>
 Â  Â  Â  Â  Â  Â "else " +
 Â  Â  Â  Â  Â  Â " Â   <span class="hljs-attr">ttl</span> = redis.call(<span class="hljs-string">'pttl'</span>, KEYS[<span class="hljs-number">1</span>])<span class="hljs-comment">; " +</span>
 Â  Â  Â  Â  Â  Â "end<span class="hljs-comment">; " +</span>
 Â  Â  Â  Â  Â  Â "local <span class="hljs-attr">timeout</span> = ttl + tonumber(ARGV[<span class="hljs-number">3</span>]) + tonumber(ARGV[<span class="hljs-number">4</span>])<span class="hljs-comment">; " +</span>
 Â  Â  Â  Â  Â  Â "if redis.call('zadd', KEYS<span class="hljs-section">[3]</span>, timeout, ARGV<span class="hljs-section">[2]</span>) == 1 then " +
 Â  Â  Â  Â  Â  Â " Â   redis.call('rpush', KEYS<span class="hljs-section">[2]</span>, ARGV<span class="hljs-section">[2]</span>)<span class="hljs-comment">; " +</span>
 Â  Â  Â  Â  Â  Â "end<span class="hljs-comment">; " +</span>
 Â  Â  Â  Â  Â  Â "return ttl<span class="hljs-comment">;",</span>
 Â  Â  Â  Â  Â  Â Arrays.asList(this.getRawName(), this.threadsQueueName, this.timeoutSetName),
 Â  Â  Â  Â  Â  Â new Object<span class="hljs-section">[]</span>{unit.toMillis(leaseTime), this.getLockName(threadId), wait, currentTime}
 Â  Â  Â   )<span class="hljs-comment">;</span>
 Â   } else {
 Â  Â  Â  Â throw new IllegalArgumentException()<span class="hljs-comment">;</span>
 Â   }
}
</code></pre>
<p>è¿™é‡Œæœ‰ä¿©æ®µluaè„šæœ¬ï¼Œç¬¬ä¸€æ®µå¯¹åº”çš„æ˜¯æ— å‚çš„tryLockï¼ˆï¼‰æ–¹æ³•ï¼Œè¿›è¡Œä¸€æ¬¡å¿«é€Ÿå°è¯•ï¼Œå¦‚æœè·å–ä¸åˆ°é”ç›´æ¥è¿”å›ã€‚ç¬¬äºŒæ®µå¯¹åº”çš„æ˜¯tryLock(waitTime)/lockè¿™ä¿©ä¸ªé˜»å¡ç­‰é”çš„æ–¹æ³•ã€‚è¿™é‡Œæˆ‘ä»¬é‡ç‚¹çœ‹ç¬¬äºŒæ®µluaè„šæœ¬ï¼Œç¬¬ä¸€ä¸ªluaè„šæœ¬å’Œç¬¬äºŒä¸ªç±»ä¼¼ï¼š</p>
<pre><code class="hljs language-java" lang="java">--å¾ªç¯çš„åˆ¤æ–­æ˜¯å¦æœ‰waitTimeå·²ç»è¶…è¿‡çš„èŠ‚ç‚¹ï¼Œå¦‚æœæœ‰å°±å‰”é™¤æ‰ï¼Œé˜²æ­¢å ç”¨ç€é˜Ÿåˆ—
<span class="hljs-keyword">while</span> <span class="hljs-literal">true</span> <span class="hljs-keyword">do</span> 
 Â  Â --æŸ¥è¯¢ç­‰å¾…é˜Ÿåˆ—å¤´èŠ‚ç‚¹æ˜¯ä»€ä¹ˆ
 Â  Â <span class="hljs-type">local</span> <span class="hljs-variable">firstThreadId2</span> <span class="hljs-operator">=</span> redis.call(<span class="hljs-string">'lindex'</span>, KEYS[<span class="hljs-number">2</span>], <span class="hljs-number">0</span>); 
 Â  Â --å¦‚æœç­‰å¾…é˜Ÿåˆ—ä¸ºç©ºåˆ™è·³å‡ºå¾ªç¯
 Â  Â <span class="hljs-keyword">if</span> firstThreadId2 == <span class="hljs-literal">false</span> then 
 Â  Â  Â  Â <span class="hljs-keyword">break</span>; 
 Â  Â end; 
 Â  Â --ä¸ä¸ºç©ºï¼Œåˆ¤æ–­ä¸€ä¸‹æ˜¯å¦è¶…è¿‡äº†è¶…æ—¶æ—¶é—´ï¼Œå¦‚æœæ˜¯å°±åˆ é™¤æ‰ï¼Œæ²¡æœ‰å°±è·³å‡ºå¾ªç¯
 Â  Â <span class="hljs-type">local</span> <span class="hljs-variable">timeout</span> <span class="hljs-operator">=</span> redis.call(<span class="hljs-string">'zscore'</span>, KEYS[<span class="hljs-number">3</span>], firstThreadId2); 
 Â  Â <span class="hljs-keyword">if</span> timeout ~= <span class="hljs-literal">false</span> and <span class="hljs-title function_">tonumber</span><span class="hljs-params">(timeout)</span> &lt;= tonumber(ARGV[<span class="hljs-number">4</span>]) then 
 Â  Â  Â  Â redis.call(<span class="hljs-string">'zrem'</span>, KEYS[<span class="hljs-number">3</span>], firstThreadId2); 
 Â  Â  Â  Â redis.call(<span class="hljs-string">'lpop'</span>, KEYS[<span class="hljs-number">2</span>]); 
 Â  Â <span class="hljs-keyword">else</span> 
 Â  Â  Â  Â <span class="hljs-keyword">break</span>; 
 Â  Â end; 
end; 
--åˆ¤æ–­ä¸€ä¸‹é”æ˜¯å¦æ²¡æœ‰è¢«å…¶ä»–çº¿ç¨‹æŒæœ‰å¹¶ä¸”ç­‰å¾…é˜Ÿåˆ—ä¸å­˜åœ¨ï¼ˆç­‰å¾…é˜Ÿåˆ—ä¸ºç©ºï¼‰æˆ–è€…å¯¹å¤´æ˜¯æ­¤çº¿ç¨‹ï¼Œå¦‚æœæ˜¯åˆ™è¿›å…¥æŠ¢é”ã€‚
<span class="hljs-keyword">if</span> (redis.call(<span class="hljs-string">'exists'</span>, KEYS[<span class="hljs-number">1</span>]) == <span class="hljs-number">0</span>) and ((redis.call(<span class="hljs-string">'exists'</span>, KEYS[<span class="hljs-number">2</span>]) == <span class="hljs-number">0</span>) or (redis.call(<span class="hljs-string">'lindex'</span>, KEYS[<span class="hljs-number">2</span>], <span class="hljs-number">0</span>) == ARGV[<span class="hljs-number">2</span>])) then 
 Â  Â --å°†è‡ªå·±ä»é˜Ÿåˆ—ç§»é™¤
 Â  Â redis.call(<span class="hljs-string">'lpop'</span>, KEYS[<span class="hljs-number">2</span>]); 
 Â  Â redis.call(<span class="hljs-string">'zrem'</span>, KEYS[<span class="hljs-number">3</span>], ARGV[<span class="hljs-number">2</span>]); 
 Â  Â <span class="hljs-type">local</span> <span class="hljs-variable">keys</span> <span class="hljs-operator">=</span> redis.call(<span class="hljs-string">'zrange'</span>, KEYS[<span class="hljs-number">3</span>], <span class="hljs-number">0</span>, -<span class="hljs-number">1</span>); 
 Â  Â --å¾ªç¯æ•´ä¸ªé˜Ÿåˆ—ï¼Œæ›´æ–°æ‰€æœ‰èŠ‚ç‚¹çš„è¶…æ—¶æ—¶é—´ï¼ˆå‡å°‘ç­‰å¾…é¢„ç®—ï¼‰
 Â  Â <span class="hljs-type">for</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>, #keys, <span class="hljs-number">1</span> <span class="hljs-keyword">do</span> 
 Â  Â  Â  Â redis.call(<span class="hljs-string">'zincrby'</span>, KEYS[<span class="hljs-number">3</span>], -tonumber(ARGV[<span class="hljs-number">3</span>]), keys[i]); 
 Â  Â end; 
 Â  Â --çœŸæ­£çš„åŠ é”é€»è¾‘ï¼ŒåŠ é”åç›´æ¥è¿”å›ã€‚
 Â  Â redis.call(<span class="hljs-string">'hset'</span>, KEYS[<span class="hljs-number">1</span>], ARGV[<span class="hljs-number">2</span>], <span class="hljs-number">1</span>); 
 Â  Â redis.call(<span class="hljs-string">'pexpire'</span>, KEYS[<span class="hljs-number">1</span>], ARGV[<span class="hljs-number">1</span>]); 
 Â  Â --è¿”å›nilè¯´æ˜æŠ¢é”æˆåŠŸ
 Â  Â <span class="hljs-keyword">return</span> nil; 
end; 
--å‰é¢åˆ¤æ–­ä¸º<span class="hljs-literal">false</span>ï¼Œè¯´æ˜é”è¢«æŒæœ‰äº†ï¼Œåˆ¤æ–­ä¸€ä¸‹é”æ˜¯å¦è¢«æœ¬çº¿ç¨‹æŒæœ‰ï¼Œå¦‚æœæ˜¯é‡å…¥åŠ <span class="hljs-number">1</span>å¹¶è¿”å›
<span class="hljs-keyword">if</span> redis.call(<span class="hljs-string">'hexists'</span>, KEYS[<span class="hljs-number">1</span>], ARGV[<span class="hljs-number">2</span>]) == <span class="hljs-number">1</span> then 
 Â  Â redis.call(<span class="hljs-string">'hincrby'</span>, KEYS[<span class="hljs-number">1</span>], ARGV[<span class="hljs-number">2</span>], <span class="hljs-number">1</span>); 
 Â  Â redis.call(<span class="hljs-string">'pexpire'</span>, KEYS[<span class="hljs-number">1</span>], ARGV[<span class="hljs-number">1</span>]); 
 Â  Â <span class="hljs-keyword">return</span> nil; 
end; 
--èµ°åˆ°è¿™é‡Œè¯´æ˜é”è¢«å…¶ä»–äººæŒæœ‰äº†ï¼Œæ­¤æ—¶åˆ¤æ–­ä¸€ä¸‹æœ¬çº¿ç¨‹æ˜¯å¦å·²ç»åœ¨æ’é˜Ÿäº†
<span class="hljs-type">local</span> <span class="hljs-variable">timeout</span> <span class="hljs-operator">=</span> redis.call(<span class="hljs-string">'zscore'</span>, KEYS[<span class="hljs-number">3</span>], ARGV[<span class="hljs-number">2</span>]); 
<span class="hljs-keyword">if</span> timeout ~= <span class="hljs-literal">false</span> then 
 Â  Â --å¦‚æœåœ¨æ’é˜Ÿäº†ï¼Œåˆ™è¿”å›é”çš„å‰©ä½™æŒæœ‰æ—¶é—´
 Â  Â <span class="hljs-type">local</span> <span class="hljs-variable">ttl</span> <span class="hljs-operator">=</span> redis.call(<span class="hljs-string">'pttl'</span>, KEYS[<span class="hljs-number">1</span>]); 
 Â  Â <span class="hljs-keyword">return</span> math.max(<span class="hljs-number">0</span>, ttl); 
end; 
--èµ°åˆ°è¿™é‡Œè¯´æ˜æ²¡æœ‰å…¥é˜Ÿï¼Œå…ˆæŸ¥çœ‹ä¸€ä¸‹é˜Ÿå°¾èŠ‚ç‚¹
<span class="hljs-type">local</span> <span class="hljs-variable">lastThreadId</span> <span class="hljs-operator">=</span> redis.call(<span class="hljs-string">'lindex'</span>, KEYS[<span class="hljs-number">2</span>], -<span class="hljs-number">1</span>); 
local ttl; 
--å¦‚æœé˜Ÿå°¾èŠ‚ç‚¹å­˜åœ¨ï¼ˆé”è¢«æŒæœ‰ï¼Œæœ‰çº¿ç¨‹ç­‰å¾…æŠ¢é”ï¼‰åˆ™ttlæ˜¯é’±ä¸€ä¸ªäººçš„è¶…æ—¶æ—¶é—´-å½“å‰æ—¶é—´ã€‚
<span class="hljs-keyword">if</span> lastThreadId ~= <span class="hljs-literal">false</span> and lastThreadId ~= ARGV[<span class="hljs-number">2</span>] and redis.call(<span class="hljs-string">'zscore'</span>, KEYS[<span class="hljs-number">3</span>], lastThreadId) ~= <span class="hljs-literal">false</span> <span class="hljs-type">then</span> 
 Â  Â <span class="hljs-variable">ttl</span> <span class="hljs-operator">=</span> tonumber(redis.call(<span class="hljs-string">'zscore'</span>, KEYS[<span class="hljs-number">3</span>], lastThreadId)) - tonumber(ARGV[<span class="hljs-number">4</span>]); 
<span class="hljs-keyword">else</span> 
 Â  Â --å¦‚æœé˜Ÿå°¾èŠ‚ç‚¹ä¸å­˜åœ¨ï¼ˆé”è¢«æŒæœ‰ï¼Œä¸”æ²¡æœ‰çº¿ç¨‹ç­‰å¾…æŠ¢é”ï¼‰åˆ™ttlå°±æ˜¯é”çš„è¿‡æœŸæ—¶é—´
 Â  Â ttl = redis.call(<span class="hljs-string">'pttl'</span>, KEYS[<span class="hljs-number">1</span>]); 
end; 
<span class="hljs-type">local</span> <span class="hljs-variable">timeout</span> <span class="hljs-operator">=</span> ttl + tonumber(ARGV[<span class="hljs-number">3</span>]) + tonumber(ARGV[<span class="hljs-number">4</span>]); 
--ç„¶åå…¥é˜Ÿï¼Œå°†è®¡ç®—å¥½çš„è¶…æ—¶æ—¶é—´æ”¾å…¥Zsetï¼Œå¹¶å°†æœ¬çº¿ç¨‹æ”¾å…¥é˜Ÿå°¾ã€‚
<span class="hljs-keyword">if</span> redis.call(<span class="hljs-string">'zadd'</span>, KEYS[<span class="hljs-number">3</span>], timeout, ARGV[<span class="hljs-number">2</span>]) == <span class="hljs-number">1</span> then 
 Â  Â redis.call(<span class="hljs-string">'rpush'</span>, KEYS[<span class="hljs-number">2</span>], ARGV[<span class="hljs-number">2</span>]); 
end; 
--è¿”å›å‘Šè¯‰å®¢æˆ·ç«¯ï¼Œè¿˜éœ€è¦æ—¶é—´ä¸ºttlï¼Œä½¿ç”¨Semaphoreå»é˜»å¡ã€‚ï¼ˆå”¤é†’è¿‡ç¨‹å’Œå‰æ–‡æåˆ°è¿‡çš„ä¸€æ ·ï¼‰
<span class="hljs-keyword">return</span> ttl;
</code></pre>
<p>æ­¤è¿‡ç¨‹ä¸­ç”¨åˆ°äº†Zsetï¼ŒListï¼Œæˆ‘ä»¬ç›´åˆ°Listç”¨äºå­˜æ”¾èµ„æºäº‰æŠ¢è€…ï¼Œé‚£Zsetåˆæ˜¯å¹²å˜›çš„ï¼Ÿ</p>
<p>List è™½ç„¶èƒ½å®Œç¾å®ç° FIFOï¼ˆå…ˆè¿›å…ˆå‡ºï¼‰ï¼Œä½†å®ƒæœ‰2ä¸ªè‡´å‘½å¼±ç‚¹ï¼š</p>
<ul>
<li><strong>ä¸å¥½åˆ¤æ–­è¿‡æœŸæ—¶é—´</strong>ï¼šList åªèƒ½å‘Šè¯‰ä½ è°æ’ç¬¬ä¸€ï¼Œä½†ä¸èƒ½å‘Šè¯‰ä½ ä»–è¿˜æ˜¯ä¸æ˜¯æ´»çš„ï¼ˆæœ‰æ²¡æœ‰è¶…æ—¶ï¼‰ï¼Œå¦‚æœéè¦åˆ©ç”¨Listå­˜å‚¨è¿‡æœŸæ—¶é—´å°±å¾—é€šè¿‡valueå»åˆ†å‰²ï¼Œä¸ä»…éœ€è¦å ç”¨cpuèµ„æºè€Œä¸”ä¸å¥½åˆ¤æ–­å¦‚ä½•åˆ†å‰²ï¼Œä¸‡ä¸€ç”¨æˆ·å‘½åä¸è§„èŒƒå¯¼è‡´åˆ†å‰²é”™è¯¯ï¼Œæ­¤æ—¶éœ€è¦Zsetï¼Œå®ƒå­˜å‚¨äº†æ¯ä¸ªäººçš„â€œæ­»äº¡æ—¶é—´â€ï¼Œç”¨æ¥åœ¨æ¯æ¬¡æ“ä½œå‰æ¸…ç† List é‡Œçš„åƒµå°¸èŠ‚ç‚¹ã€‚memberæ˜¯uuid+çº¿ç¨‹idï¼Œscoreæ˜¯è¿‡æœŸæ—¶é—´</li>
<li><strong>ä¸å¥½åˆ¤æ–­æ˜¯å¦å½“å‰çº¿ç¨‹åœ¨é˜Ÿåˆ—ä¸­</strong>ï¼šListéœ€è¦O(n)åˆ¤æ–­ï¼Œæ—¶é—´æ…¢ï¼Œé€šè¿‡Zsetçš„dictæ•°æ®ç»“æ„O(1)åˆ¤æ–­ã€‚</li>
</ul>
<p>æ­¤å¤–ï¼Œç”±äºæ¯ä¸€ä¸ªèŠ‚ç‚¹æœ‰å¯èƒ½æ˜¯lockï¼ˆï¼‰è¿™ç§æ— ç­‰å¾…æ—¶é—´ï¼Œä¼šé˜»å¡åˆ°ä¸€ç›´è·å–é”ï¼Œåœ¨Zsetä¸­éš¾é“æˆ‘ä»¬è¦å°†Zsetçš„è¿‡æœŸåˆ†æ•°è®¾ç½®å¾ˆå¤§æˆ–è€…è®¾ç½®ä¸º-1ä»£è¡¨æ²¡æœ‰è¿‡æœŸæ—¶é—´å—ï¼Ÿé‚£å¦‚æœå®¢æˆ·ç«¯å®•æœºäº†ï¼Œè¯¥èŠ‚ç‚¹ä¸å°±å ç”¨è¿™ä¸ªZsetå’Œlistçš„èŠ‚ç‚¹ï¼Œä¸”è°ä¹Ÿæ¸…é™¤ä¸æ‰ï¼Œå¯¼è‡´å†…å­˜æ³„éœ²ã€‚ä¸”è½®åˆ°å®ƒä½œä¸ºå¤´èŠ‚ç‚¹æ—¶å€™ï¼Œåˆä¸ä¼šæŠ¢é”ï¼Œå¯¼è‡´å…¨éƒ¨éƒ½åœ¨æ­»ç­‰ã€‚</p>
<p>æ—§ç‰ˆæœ¬çš„redissonæ˜¯é»˜è®¤ç»™5ç§’è¿‡æœŸæ—¶é—´ï¼Œæ¯æ¬¡5ç§’åå°±åˆ·æ–°ä¸€ä¸‹ï¼Œå¦‚æœå®¢æˆ·ç«¯å®•æœºäº†å°±ä¸ä¼šåˆ·æ–°ï¼Œè¿™ä¸ªèŠ‚ç‚¹ä¼šè¢«æ¸…é™¤æ‰ã€‚ä½†æ˜¯å½“ç«äº‰æ¿€çƒˆçš„æ—¶å€™5ç§’è·å–ä¸åˆ°é”æ—¶å€™å¤§é‡çš„çº¿ç¨‹é†’è¿‡æ¥åŒæ—¶å»æ›´æ–°è¿‡æœŸæ—¶é—´ï¼Œè¿™ä¸ªæƒŠç¾¤æ•ˆåº”ä¼šå¯¼è‡´æ€§èƒ½æ€¥å‰§ä¸‹é™ï¼Œåç»­æ–°ç‰ˆæœ¬æ”¹ä¸ºäº†5åˆ†é’Ÿã€‚</p>
<p>å¦‚å›¾ï¼Œæ¯”èµ·éå…¬å¹³é”å¤šäº†ä¿©ä¸ªæ•°æ®ç»“æ„</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6fcdc19af5dd40fcb4c907beb88fa65c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2lyNzYx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766822478&amp;x-signature=fCOelRfQZtVqpd7k%2FW%2BCSTzULqE%3D" alt="åˆ†å¸ƒå¼å…¬å¹³é”è·å–è¿‡ç¨‹.drawio.png" loading="lazy"/></p>
<p>è‹¥æœ‰é”™è¯¯æ¬¢è¿æŒ‡å‡ºï¼Œå°†åŠæ—¶æ”¹æ­£ã€‚</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Kibanaï¼šä½¿ç”¨ ES|QL æ„å»ºåœ°å›¾ï¼Œå¯¹å›½å®¶æˆ–åœ°åŒºçš„æŒ‡æ ‡è¿›è¡Œå¯¹æ¯”]]></title>    <link>https://juejin.cn/post/7585474459776335908</link>    <guid>https://juejin.cn/post/7585474459776335908</guid>    <pubDate>2025-12-20T08:22:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585474459776335908" data-draft-id="7585474459776319524" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Kibanaï¼šä½¿ç”¨ ES|QL æ„å»ºåœ°å›¾ï¼Œå¯¹å›½å®¶æˆ–åœ°åŒºçš„æŒ‡æ ‡è¿›è¡Œå¯¹æ¯”"/> <meta itemprop="keywords" content="Elasticsearch"/> <meta itemprop="datePublished" content="2025-12-20T08:22:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Elasticsearch"/> <meta itemprop="url" content="https://juejin.cn/user/2612095360441448"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="æ˜é‡‘"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Kibanaï¼šä½¿ç”¨ ES|QL æ„å»ºåœ°å›¾ï¼Œå¯¹å›½å®¶æˆ–åœ°åŒºçš„æŒ‡æ ‡è¿›è¡Œå¯¹æ¯”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2612095360441448/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Elasticsearch
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T08:22:04.000Z" title="Sat Dec 20 2025 08:22:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    é˜…è¯»6åˆ†é’Ÿ
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>ä½œè€…ï¼šæ¥è‡ª ElasticÂ <a href="https://link.juejin.cn?target=https%3A%2F%2Fdiscuss.elastic.co%2Fu%2Fnathan_reese" title="https://discuss.elastic.co/u/nathan_reese" target="_blank" ref="nofollow noopener noreferrer">Nathan_Reese</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/856719b33e094553a77f3f6a06f3920a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=sIwkFyIrQn5FbGU4%2Ful7xVJkdLg%3D" alt="" loading="lazy"/></p>
<p>Kibana åœ°å›¾ æ•™ç¨‹ â€œ<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fguide%2Fen%2Fkibana%2F8.19%2Fmaps-getting-started.html" title="https://www.elastic.co/guide/en/kibana/8.19/maps-getting-started.html" target="_blank" ref="nofollow noopener noreferrer">æ„å»ºåœ°å›¾ï¼Œç”¨äºæŒ‰å›½å®¶æˆ–åœ°åŒºå¯¹æ¯”æŒ‡æ ‡</a>â€ ä½¿ç”¨ Elasticsearch çš„ DSL æŸ¥è¯¢ æ¥åˆ›å»ºåœ°å›¾ã€‚æœ€è¿‘æ–°å¢çš„ ES|QL å‡½æ•° <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Freference%2Fquery-languages%2Fesql%2Fcommands%2Flookup-join" title="https://www.elastic.co/docs/reference/query-languages/esql/commands/lookup-join" target="_blank" ref="nofollow noopener noreferrer">LOOKUP JOIN</a>ï¼ˆ 8.18 ï¼‰å’Œ <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Freference%2Fquery-languages%2Fesql%2Ffunctions-operators%2Fspatial-functions%23esql-st_geotile" title="https://www.elastic.co/docs/reference/query-languages/esql/functions-operators/spatial-functions#esql-st_geotile" target="_blank" ref="nofollow noopener noreferrer">ST_GEOTILE</a>ï¼ˆ 9.2 ï¼‰ä½¿å¾—å¯ä»¥ä½¿ç”¨ ES|QL é‡æ–°åˆ›å»ºè¯¥æ•™ç¨‹ä¸­çš„åœ°å›¾ã€‚</p>
<p>ä¸‹é¢æ˜¯ä½¿ç”¨ ES|QL é‡æ–°åˆ›å»ºè¯¥æ•™ç¨‹åœ°å›¾çš„æ­¥éª¤ã€‚éšåï¼Œè¿™äº›æ­¥éª¤è¿˜è¶…å‡ºäº†åŸå§‹æ•™ç¨‹çš„èƒ½åŠ›èŒƒå›´ï¼Œå¹¶æŒ‰å›½å®¶äººå£å¯¹åˆ†çº§è®¾è‰²å›¾å±‚è¿›è¡Œå½’ä¸€åŒ–å¤„ç†ã€‚</p>
<h2 data-id="heading-0">å‰ææ¡ä»¶</h2>
<ul>
<li>å¦‚æœä½ è¿˜æ²¡æœ‰ Kibanaï¼Œè¯·ä½¿ç”¨æˆ‘ä»¬çš„ <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fcloud%2Felasticsearch-service%2Fsignup%3Fbaymax%3Ddocs-body%26elektra%3Ddocs" title="https://www.elastic.co/cloud/elasticsearch-service/signup?baymax=docs-body&amp;elektra=docs" target="_blank" ref="nofollow noopener noreferrer">å…è´¹è¯•ç”¨</a> è¿›è¡Œè®¾ç½®ã€‚</li>
<li>æœ¬æ•™ç¨‹éœ€è¦ <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fguide%2Fen%2Fkibana%2F8.19%2Fget-started.html" title="https://www.elastic.co/guide/en/kibana/8.19/get-started.html" target="_blank" ref="nofollow noopener noreferrer">web logs ç¤ºä¾‹æ•°æ®é›†</a>ã€‚</li>
<li>ä½ å¿…é¡»å…·å¤‡åˆ›å»ºåœ°å›¾å’Œåˆ›å»ºç´¢å¼•çš„æ­£ç¡®æƒé™ã€‚</li>
<li><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9ee18d03841d4a7b96cdced29f035bb0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=6L9%2BwGiBlMHJT3I5WumIGOqBYNM%3D" alt="" loading="lazy"/></li>
</ul>
<h2 data-id="heading-1">æ­¥éª¤ 1ï¼šåˆ›å»º åœ°å›¾</h2>
<ul>
<li>å‰å¾€ Dashboardsã€‚</li>
<li>ç‚¹å‡» Create dashboardã€‚</li>
<li>å°†æ—¶é—´èŒƒå›´è®¾ç½®ä¸º Last 7 daysã€‚</li>
<li>ç‚¹å‡» Add æŒ‰é’®å¹¶é€‰æ‹© New panelï¼Œæœ€åç‚¹å‡» Mapsã€‚</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/75fc5d68a38a40f792bc5d21960ce2fb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=mJiW3kgJ8oYBKljJb4IvqZq81ls%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/299c6ca01e7841c8b6e1531d07ad0624~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=scm067o%2BWSNTSko5PB19C0sNp5Y%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fdad565309644328b1aaf0a42913a686~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=PtY7x5OTT9xrruWB1E2nPc8dI6I%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6bf44c4e950944ca850b10893148010d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=lw1aRSNzzIR4M%2FTiDrYGyyi4L3I%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/77d62ab1b5054e3c8e88a8af9ef37d81~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=nkla1tjbPRClZk0W0d0D4OzLjvI%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c59530e10ed7425189a9495e511ae321~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=Ff2hpwV1S%2FqsEW9kp%2BWcWaYKlyA%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-2">æ­¥éª¤ 2. æ·»åŠ ä¸€ä¸ª choropleth å›¾å±‚</h2>
<p>ä½ å°†æ·»åŠ çš„ç¬¬ä¸€ä¸ªå›¾å±‚æ˜¯ä¸€ä¸ª choropleth å›¾å±‚ï¼Œç”¨äºæŒ‰ web æ—¥å¿—æµé‡ä¸ºä¸–ç•Œå„å›½ç€è‰²ã€‚è¾ƒæ·±çš„é¢œè‰²è¡¨ç¤º web æ—¥å¿—æµé‡è¾ƒå¤šçš„å›½å®¶ï¼Œè¾ƒæµ…çš„é¢œè‰²è¡¨ç¤ºæµé‡è¾ƒå°‘çš„å›½å®¶ã€‚</p>
<h3 data-id="heading-3">ç´¢å¼•ä¸–ç•Œå›½å®¶</h3>
<ul>
<li>ä¸‹è½½<a href="https://link.juejin.cn?target=https%3A%2F%2Fmaps.elastic.co%2F%23file%2Fworld_countries" title="https://maps.elastic.co/#file/world_countries" target="_blank" ref="nofollow noopener noreferrer">ä¸–ç•Œå›½å®¶ GeoJSON</a> æ–‡ä»¶</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cfefe39ae1fd487aa0309dddf21cd827~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=eACxlm%2BKon4ew2isg3ZK3iirlJw%3D" alt="" loading="lazy"/></p>
<ul>
<li>åœ¨ Kibana maps ä¸­ï¼Œç‚¹å‡» Add layer</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6248b5f4f086401e9d30e61074397de2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=1PagyFqjZttoljj5MD9LPscOGsw%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/920a2f78b8384cf8b662807c1b109b30~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=%2BbCKB6%2FzjuUt5rIvcVSHa4%2BnWGc%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2521840315d547edb220d8935431def9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=Zl4BlgIF%2F0OOIPL0i6Ld6kN6U5M%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3077a8304ea04d90a34dcae0b504e448~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=mp%2BmwWXkFNUkH%2FNE%2FiBrxviIURM%3D" alt="" loading="lazy"/></p>
<ul>
<li>é€‰æ‹© Upload file</li>
<li>åœ¨æ–‡ä»¶é€‰æ‹©å™¨ä¸­é€‰æ‹©ä¸–ç•Œå›½å®¶ GeoJSON æ–‡ä»¶</li>
<li>å°† Index name è®¾ç½®ä¸º world_countries</li>
<li>æ‰“å¼€ Advanced éƒ¨åˆ†</li>
<li>å°† Index settings è®¾ç½®ä¸º { "index.mode": "lookup" }ã€‚</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/af35066cef874968a8f2ad7341c735bb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=HzesTFW6kVSrmxME6gU7qTWCows%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-4">æ·»åŠ  choropleth å›¾å±‚</h3>
<ul>
<li>ç‚¹å‡» Add layer</li>
<li>é€‰æ‹© ES|QL</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0edb88e6558f4c88852224e928da565f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=6a5vS%2Bc2eTHqlcillFK5yzGRL7A%3D" alt="" loading="lazy"/></p>
<ul>
<li>å°† ES|QL statement è®¾ç½®ä¸º</li>
</ul>

<pre><code class="hljs language-vbnet" lang="vbnet">`

<span class="hljs-number">1</span>.  <span class="hljs-keyword">FROM</span> kibana_sample_data_logs 
<span class="hljs-number">2</span>.  | STATS count = COUNT() <span class="hljs-keyword">BY</span> geo.dest 
<span class="hljs-number">3</span>.  | RENAME geo.dest <span class="hljs-keyword">AS</span> iso2.keyword 
<span class="hljs-number">4</span>.  | LOOKUP <span class="hljs-keyword">JOIN</span> world_countries <span class="hljs-keyword">ON</span> iso2.keyword 
<span class="hljs-number">5</span>.  | RENAME iso2.keyword <span class="hljs-keyword">AS</span> geo.dest 
<span class="hljs-number">6</span>.  | KEEP count, geometry, geo.dest

`AIå†™ä»£ç 
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2412b1d2aa71444a9fe534fd845acb2b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=3ZPwYpEy%2BYvjLfGovf6N8EaRIv0%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1cf38ada7d0845a5ba800dbe73770a4e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=OC6es0DwoXsYv4FNwA1XpZUzQqY%3D" alt="" loading="lazy"/></p>
<ul>
<li>ç‚¹å‡» Add and continue</li>
<li>åœ¨ Layer settings ä¸­ï¼Œè®¾ç½®ï¼š
<ul>
<li>å°† Name è®¾ç½®ä¸º Total Requests by Destinationã€‚</li>
<li>å°† Opacity è®¾ç½®ä¸º 50%ã€‚</li>
</ul>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/efe3b047e63e48edb6d1ea0fe2ad2d4e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=v9G2LV%2FfNUpVGK7PEYlowcM4eBY%3D" alt="" loading="lazy"/></p>
<ul>
<li>åœ¨ Layer style ä¸­
<ul>
<li>å°† Fill color è®¾ç½®ä¸º By value by countã€‚é€‰æ‹© â€œgrey to blackâ€ é¢œè‰²æ¸å˜ã€‚</li>
<li>å°† Border color è®¾ç½®ä¸º â€œwhiteâ€ã€‚4.</li>
</ul>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7cc5319e4c22433494754567f7f74405~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=YUzd07oNYRMnCTSqkJaV%2F%2FSTvv4%3D" alt="" loading="lazy"/></p>
<ul>
<li>ç‚¹å‡» Keep changesã€‚ä½ çš„åœ°å›¾ç°åœ¨åº”è¯¥çœ‹èµ·æ¥åƒ</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fce6da60d5fe4a64802c857e2a2d6112~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=12N4r%2FY7slCp05qi3N%2FK5r1b9Pg%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-5">æ­¥éª¤ 3. ä¸º Elasticsearch æ•°æ®æ·»åŠ å›¾å±‚</h2>
<p>ä¸ºäº†é¿å…ä¸€æ¬¡å‘ç”¨æˆ·å±•ç¤ºè¿‡å¤šæ•°æ®ï¼Œä½ å°†ä¸º Elasticsearch æ•°æ®æ·»åŠ ä¸¤ä¸ªå›¾å±‚ã€‚ç¬¬ä¸€ä¸ªå›¾å±‚åœ¨ç”¨æˆ·æ”¾å¤§åœ°å›¾æ—¶æ˜¾ç¤ºå•ä¸ªæ–‡æ¡£ã€‚ç¬¬äºŒä¸ªå›¾å±‚åœ¨ç”¨æˆ·ç¼©å°åœ°å›¾æ—¶æ˜¾ç¤ºèšåˆæ•°æ®ã€‚</p>
<h3 data-id="heading-6">ä¸ºå•ä¸ªæ–‡æ¡£æ·»åŠ å›¾å±‚</h3>
<p>æ­¤å›¾å±‚å°† web æ—¥å¿—æ–‡æ¡£æ˜¾ç¤ºä¸ºç‚¹ã€‚<br/>
è¯¥å›¾å±‚ä»…åœ¨ç”¨æˆ·æ”¾å¤§æ—¶å¯è§ã€‚</p>
<ul>
<li>ç‚¹å‡» Add layer</li>
<li>é€‰æ‹© ES|QL</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7195fa36fd744d3f9855a4cfabb3d640~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=gCo1jOY35J0wBj%2F0qorOOgWXYEg%3D" alt="" loading="lazy"/></p>
<ul>
<li>å°† ES|QL statement è®¾ç½®ä¸º</li>
</ul>

<pre><code class="hljs language-sql" lang="sql">`

<span class="hljs-number">1.</span>  <span class="hljs-keyword">FROM</span> kibana_sample_data_logs 
<span class="hljs-number">2.</span>  <span class="hljs-operator">|</span> KEEP geo.coordinates, agent, bytes, clientip, 
<span class="hljs-number">3.</span>         host, machine.os, request, response, <span class="hljs-type">timestamp</span> 
<span class="hljs-number">4.</span>  <span class="hljs-operator">|</span> LIMIT <span class="hljs-number">10000</span>

`AIå†™ä»£ç 
</code></pre>
<ul>
<li>åœ¨ ES|QL ç¼–è¾‘å™¨ä¸­ç‚¹å‡» Run query</li>
<li>ç‚¹å‡» Add and continue</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/730d8242b0514cb289a6009e5edb2f45~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=IAa4srQhlXSDFk3eyMxnM4nDgSg%3D" alt="" loading="lazy"/></p>
<ul>
<li>åœ¨ Layer settings ä¸­ï¼Œè®¾ç½®ï¼š
<ul>
<li>å°† Name è®¾ç½®ä¸º Actual Requestsã€‚</li>
<li>å°† Visibility è®¾ç½®ä¸ºèŒƒå›´ [9, 24]ã€‚</li>
</ul>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a28785535c8a4fe0b901ed166e835728~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=xnY1P%2BvT0tWOUUKOA3qxCy1F7KQ%3D" alt="" loading="lazy"/></p>
<ul>
<li>åœ¨ Layer style ä¸­ï¼Œè®¾ç½®ï¼š
<ul>
<li>å°† Fill color è®¾ç½®ä¸º #2200FFã€‚</li>
<li>å°† Border width è®¾ç½®ä¸º 0ã€‚</li>
</ul>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c07660b51c74440f857eebcc605b9587~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=h578EnyVh%2FZ%2BDvoqvQreP4Q%2BsZc%3D" alt="" loading="lazy"/></p>
<ul>
<li>ç‚¹å‡» Keep changesã€‚ä½ çš„åœ°å›¾ç°åœ¨åº”è¯¥çœ‹èµ·æ¥åƒ</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ff4d39c9221d44e1937a90308283b291~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=Dndj%2B%2F0T6IvXTXHZviJj8%2B2liSE%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-7">ä¸ºèšåˆæ•°æ®æ·»åŠ å›¾å±‚</h3>
<p>ä½ å°†åˆ›å»ºä¸€ä¸ªèšåˆæ•°æ®å›¾å±‚ï¼Œå¹¶ä»…åœ¨åœ°å›¾ç¼©å°æ—¶æ˜¾ç¤ºã€‚è¾ƒæ·±çš„é¢œè‰²è¡¨ç¤º web æ—¥å¿—æµé‡æ›´å¤šçš„ç½‘æ ¼ï¼Œè¾ƒæµ…çš„é¢œè‰²è¡¨ç¤ºæµé‡è¾ƒå°‘çš„ç½‘æ ¼ã€‚è¾ƒå¤§çš„åœ†è¡¨ç¤ºä¼ è¾“æ€»å­—èŠ‚æ›´å¤šçš„ç½‘æ ¼ï¼Œè¾ƒå°çš„åœ†è¡¨ç¤ºå­—èŠ‚è¾ƒå°‘çš„ç½‘æ ¼ã€‚</p>
<ul>
<li>ç‚¹å‡» Add layer</li>
<li>é€‰æ‹© ES|QL</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/26353c3fa7834282888e2f26d36aec0c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=hQR3rEIMLEI%2B%2Fc8HzcqE6AB1CcI%3D" alt="" loading="lazy"/></p>
<ul>
<li>å°† ES|QL statement è®¾ç½®ä¸º</li>
</ul>

<pre><code class="hljs language-ini" lang="ini">`

1.  FROM kibana_sample_data_logs  
2.  | EVAL <span class="hljs-attr">geotile</span> = ST_GEOTILE(geo.coordinates, <span class="hljs-number">6</span>) 
3.  | STATS <span class="hljs-attr">count</span> = COUNT(geotile), 
<span class="hljs-attr">4.          sumOfBytes</span> = SUM(bytes), 
<span class="hljs-attr">5.          centroid</span> = ST_CENTROID_AGG(geo.coordinates) BY geotile

`AIå†™ä»£ç 
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/63cbfb4a468c4d9abb7b2c0a87b50320~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=tdOEyoqo1YDlLEb0j2xE4do33WE%3D" alt="" loading="lazy"/></p>
<ul>
<li>åœ¨ ES|QL ç¼–è¾‘å™¨ä¸­ç‚¹å‡» Run query</li>
<li>ç‚¹å‡» Add å¹¶ç»§ç»­</li>
<li>åœ¨ Layer settings ä¸­ï¼Œè®¾ç½®ï¼š
<ul>
<li>å°† Name è®¾ç½®ä¸º Total Requests and Bytesã€‚</li>
<li>å°† Visibility è®¾ç½®ä¸ºèŒƒå›´ [0, 9]ã€‚</li>
</ul>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d8adbe05ff81480795b4230f56b6ccb6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=WzfyNO%2FWRy9KFKGGdTFvd1fJPrM%3D" alt="" loading="lazy"/></p>
<ul>
<li>åœ¨ Layer style ä¸­ï¼Œè®¾ç½®ï¼š
<ul>
<li>å°† Fill color è®¾ç½®ä¸º By value by count</li>
<li>å°† Border width è®¾ç½®ä¸º 0ã€‚</li>
<li>å°† Symbol size è®¾ç½®ä¸º By value by sumOfBytesã€‚å°†æœ€å°å°ºå¯¸è®¾ç½®ä¸º 7ï¼Œæœ€å¤§å°ºå¯¸è®¾ç½®ä¸º 25ã€‚</li>
<li>å°† Label è®¾ç½®ä¸º By value by count</li>
</ul>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a1d9989a1d94426993b7a16386386185~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=nHcJDNQlFi7P%2F37bsJfSi7MIkSM%3D" alt="" loading="lazy"/></p>
<ul>
<li>ç‚¹å‡» Keep changesã€‚ä½ çš„åœ°å›¾ç°åœ¨åº”è¯¥çœ‹èµ·æ¥åƒ</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c273d329e9454d77883ac49f767a6d30~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=MRF3qen00nX22RKWkyljk9T4jDs%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-8">æ­¥éª¤ 4. æŒ‰å›½å®¶äººå£æ ‡å‡†åŒ– choropleth å›¾å±‚</h2>
<p>ç¬¬ 2 æ­¥åˆ›å»ºçš„ choropleth å›¾å±‚æŒ‰ web æ—¥å¿—æµé‡ä¸ºä¸–ç•Œå„å›½ç€è‰²ã€‚ç”±äºå„å›½äººå£ä¸åŒï¼Œç›´æ¥æ¯”è¾ƒå„å›½çš„è®¡æ•°å¹¶ä¸å…¬å¹³ã€‚äººå£è¾ƒå¤šçš„å›½å®¶å¯èƒ½æœ‰æ›´å¤šçš„ web æµé‡ï¼Œè€Œäººå£è¾ƒå°‘çš„å›½å®¶æµé‡è¾ƒå°‘ã€‚ç›¸åï¼Œä½ å¸Œæœ›æŒ‰äººå£è°ƒæ•´åçš„ web æ—¥å¿—æµé‡ä¸ºä¸–ç•Œå„å›½ç€è‰²ã€‚</p>
<p>ES|QL å¯ä»¥é€šè¿‡è€ƒè™‘æ¯ä¸ªå›½å®¶çš„æ€»äººå£æ¥å¯¹ web æ—¥å¿—è®¡æ•°è¿›è¡Œæ ‡å‡†åŒ–ã€‚æˆ‘ä»¬å°†å¯è§†åŒ–æ¯ 100,000 äººçš„ web æ—¥å¿—è®¡æ•°ï¼Œè€Œä¸æ˜¯åŸå§‹è®¡æ•°ã€‚ç°åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥æ¯”è¾ƒå„å›½çš„æ ‡å‡†åŒ–è®¡æ•°ã€‚</p>
<h3 data-id="heading-9">ç´¢å¼•ä¸–ç•Œå›½å®¶äººå£</h3>
<ul>
<li>ä¸‹è½½ <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnreese%2Fnotes%2Fraw%2Frefs%2Fheads%2Fmaster%2Fpopulations_2024.csv" title="https://github.com/nreese/notes/raw/refs/heads/master/populations_2024.csv" target="_blank" ref="nofollow noopener noreferrer">populations_2024.csv</a>æ–‡ä»¶ã€‚è¯¥æ–‡ä»¶æ¥æºäº <a href="https://link.juejin.cn?target=https%3A%2F%2Fdata.worldbank.org%2Findicator%2FSP.POP.TOTL" title="https://data.worldbank.org/indicator/SP.POP.TOTL" target="_blank" ref="nofollow noopener noreferrer">World Bank Group</a>ã€‚ ä¸‹è½½å®Œæ¯•åï¼Œæˆ‘ä»¬å¿…é¡»é‡æ–°å‘½åæ–‡ä»¶åç¼€ä¸º .csv è€Œä¸æ˜¯ .txtã€‚</li>
<li>åœ¨ Kibana ä¸­ï¼Œé€šè¿‡å…¨å±€æœç´¢å­—æ®µè¿›å…¥ File uploadã€‚</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9427dce25b2d40b19f23333325109477~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=%2BP%2BpcFz4ng8SyOshN81%2FchfaYb8%3D" alt="" loading="lazy"/></p>
<ul>
<li>åœ¨æ–‡ä»¶é€‰æ‹©å™¨ä¸­é€‰æ‹© populations_2024.csv</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cbbce9d5ad5b44ac99a3384511c1f9d1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=6sZSjkloapPqJNPnUNct35TZXns%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4d887ff51a0748e0918add6e011f0ad9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=9D%2BXR09h0e10Ujy40zE2pZ1lNDs%3D" alt="" loading="lazy"/></p>
<ul>
<li>å°† New index name è®¾ç½®ä¸º populations</li>
<li>ç‚¹å‡» Import</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1d0645d5615f44ae8348b930b15be4d9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=set59wxYd4DcSCXa8dEOARYIEw8%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-10">å‘ world_countries ç´¢å¼•æ·»åŠ äººå£å­—æ®µ</h3>
<p>ä½¿ç”¨ enrich processor å°†äººå£æ•°æ®æ·»åŠ åˆ°ä¸–ç•Œå›½å®¶é›†åˆä¸­ã€‚</p>
<ul>
<li>é€šè¿‡å¯¼èˆªèœå•æˆ–å…¨å±€æœç´¢å­—æ®µè¿›å…¥ Developer toolsã€‚</li>
<li>åˆ›å»ºä¸€ä¸ª match enrichment policy</li>
</ul>

<pre><code class="hljs language-bash" lang="bash">`

1.  PUT /_enrich/policy/population_lookup
2.  {
3.    <span class="hljs-string">"match"</span>: {
4.      <span class="hljs-string">"indices"</span>: <span class="hljs-string">"populations"</span>,
5.      <span class="hljs-string">"match_field"</span>: <span class="hljs-string">"iso3"</span>,
6.      <span class="hljs-string">"enrich_fields"</span>: [ <span class="hljs-string">"population_2024"</span>]
7.    }
8.  }

`AIå†™ä»£ç 
</code></pre>
<ul>
<li>è¦åˆå§‹åŒ–è¯¥ç­–ç•¥ï¼Œè¿è¡Œï¼š</li>
</ul>

<pre><code class="hljs language-bash" lang="bash">`POST /_enrich/policy/population_lookup/_execute`AIå†™ä»£ç 
</code></pre>
<ul>
<li>è¦åˆ›å»ºä¸€ä¸ª ingest pipelineï¼Œè¿è¡Œï¼š</li>
</ul>

<pre><code class="hljs language-bash" lang="bash">`

1.  PUT _ingest/pipeline/add_population_to_world_countries
2.  {
3.    <span class="hljs-string">"processors"</span>: [
4.      {
5.        <span class="hljs-string">"enrich"</span>: {
6.          <span class="hljs-string">"field"</span>: <span class="hljs-string">"iso3"</span>,
7.          <span class="hljs-string">"policy_name"</span>: <span class="hljs-string">"population_lookup"</span>,
8.          <span class="hljs-string">"target_field"</span>: <span class="hljs-string">"population"</span>,
9.          <span class="hljs-string">"ignore_missing"</span>: <span class="hljs-literal">true</span>,
10.          <span class="hljs-string">"ignore_failure"</span>: <span class="hljs-literal">true</span>
11.        }
12.      }
13.    ]
14.  }

`AIå†™ä»£ç ![](https://csdnimg.cn/release/blogv2/dist/pc/img/runCode/icon-arrowwhite.png)
</code></pre>
<ul>
<li>è¦å‘ world_countries æ·»åŠ äººå£æ•°æ®ï¼Œè¿è¡Œï¼š</li>
</ul>

<pre><code class="hljs language-ini" lang="ini">`POST world_countries/_update_by_query?<span class="hljs-attr">pipeline</span>=add_population_to_world_countries`AIå†™ä»£ç 
</code></pre>
<ul>
<li>åœ¨ Discover ä¸­æŸ¥çœ‹ world_countries ç´¢å¼•ã€‚æ¯ä¸€è¡Œç°åœ¨éƒ½åŒ…å« population.population_2024 åˆ—ã€‚</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b7a16b1b69204dffb9ac4dcb4a15e6d9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=93zdsqE99lKpjSnBXp4yIFDaQEg%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-11">åœ¨ ES|QL statement ä¸­æŒ‰äººå£æ ‡å‡†åŒ–è®¡æ•°</h3>
<ul>
<li>ç‚¹å‡» Total Requests by Destination å›¾å±‚çš„ edit æŒ‰é’®ã€‚</li>
<li>å°† ES|QL statement æ›¿æ¢ä¸º</li>
</ul>

<pre><code class="hljs language-vbnet" lang="vbnet">`

<span class="hljs-number">1</span>.  <span class="hljs-keyword">FROM</span> kibana_sample_data_logs 
<span class="hljs-number">2</span>.  | STATS count = COUNT() <span class="hljs-keyword">BY</span> geo.dest 
<span class="hljs-number">3</span>.  | RENAME geo.dest <span class="hljs-keyword">AS</span> iso2.keyword 
<span class="hljs-number">4</span>.  | LOOKUP <span class="hljs-keyword">JOIN</span> world_countries <span class="hljs-keyword">ON</span> iso2.keyword 
<span class="hljs-number">5</span>.  | RENAME iso2.keyword <span class="hljs-keyword">AS</span> geo.dest 
<span class="hljs-number">6</span>.  | KEEP count, geometry, geo.dest, population.population_2024 
<span class="hljs-number">7</span>.  | EVAL normalized_count = TO_DOUBLE(count) / population.population_2024 * <span class="hljs-number">100000</span>

`AIå†™ä»£ç 
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e63741079f2141bd9030ad4edfa290ba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=DBwGweAj8s76pmqMlOXkGeEk2k0%3D" alt="" loading="lazy"/></p>
<ul>
<li>åœ¨ ES|QL ç¼–è¾‘å™¨ä¸­ç‚¹å‡» Run query</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/21e69d74f8de451280b14ae6d8c7ddce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=XzvV31MVsr8bO%2FhyYtP9RaNfOd4%3D" alt="" loading="lazy"/></p>
<ul>
<li>åœ¨ Layer style ä¸­å°† Fill color è®¾ç½®ä¸º By value by normalized_countã€‚</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/86b8e174129f42f3a2aa1ac6a42dec6c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=KQKsChdXQl1oDPyjGegXlVlsE60%3D" alt="" loading="lazy"/></p>
<ul>
<li>ç‚¹å‡» Keep changesã€‚</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2ad2ef7cbb0945448f6f5439bb833c9e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=vIleNIwrAzdRPRsF88yAeHBtg2A%3D" alt="" loading="lazy"/></p>
<blockquote>
<p><strong>æ³¨æ„</strong>ï¼šä½ å¯èƒ½å·²ç»çŒœåˆ°ï¼Œä¸ºä»€ä¹ˆä¸ä½¿ç”¨ lookup è®¾ç½®å¯¼å…¥ populations CSV æ¥å¯¹åœ°å›¾æŸ¥è¯¢æ‰§è¡Œç¬¬äºŒæ¬¡ LOOKUP JOINã€‚é‚£æ˜¯å¯è¡Œçš„ï¼ä½†è¦æ³¨æ„ï¼Œæ¯å¢åŠ ä¸€æ¬¡ join éƒ½ä¼šæœ‰æ€§èƒ½å¼€é”€ã€‚</p>
</blockquote>
<p>åŸæ–‡ï¼š<a href="https://link.juejin.cn?target=https%3A%2F%2Fdiscuss.elastic.co%2Ft%2Fdec-14th-2025-en-build-a-map-to-compare-metrics-by-country-or-region-with-es-ql%2F383243" title="https://discuss.elastic.co/t/dec-14th-2025-en-build-a-map-to-compare-metrics-by-country-or-region-with-es-ql/383243" target="_blank" ref="nofollow noopener noreferrer">discuss.elastic.co/t/dec-14th-â€¦</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[è„šæ‰‹æ¶å¼€å‘å·¥å…·â€”â€”root-check]]></title>    <link>https://juejin.cn/post/7585474459776237604</link>    <guid>https://juejin.cn/post/7585474459776237604</guid>    <pubDate>2025-12-20T08:02:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585474459776237604" data-draft-id="7585463195201306674" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="è„šæ‰‹æ¶å¼€å‘å·¥å…·â€”â€”root-check"/> <meta itemprop="keywords" content="å‰ç«¯"/> <meta itemprop="datePublished" content="2025-12-20T08:02:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="code_YuJun"/> <meta itemprop="url" content="https://juejin.cn/user/3615612462441358"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="æ˜é‡‘"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            è„šæ‰‹æ¶å¼€å‘å·¥å…·â€”â€”root-check
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3615612462441358/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    code_YuJun
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T08:02:32.000Z" title="Sat Dec 20 2025 08:02:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    21
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    é˜…è¯»2åˆ†é’Ÿ
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">ç®€ä»‹</h2>
<p><code>root-check</code>Â æ˜¯ä¸€ä¸ªÂ <strong>Node.js å·¥å…·åŒ…</strong>ï¼Œæ ¸å¿ƒä½œç”¨æ˜¯<strong>æ£€æµ‹å½“å‰ Node.js è¿›ç¨‹æ˜¯å¦ä»¥Â <code>root</code>ï¼ˆè¶…çº§ç®¡ç†å‘˜ï¼‰æƒé™è¿è¡Œ</strong>ï¼Œå¹¶åœ¨æ£€æµ‹åˆ°Â <code>root</code>Â æƒé™æ—¶ï¼Œè‡ªåŠ¨é™çº§ä¸ºæŒ‡å®šçš„æ™®é€šç”¨æˆ·æƒé™è¿è¡Œï¼Œä»¥æ­¤æå‡åº”ç”¨çš„å®‰å…¨æ€§ã€‚</p>
<h3 data-id="heading-1">æ£€æµ‹ root æƒé™</h3>
<p>å®ƒä¼šåˆ¤æ–­å½“å‰è¿›ç¨‹çš„Â <code>uid</code>ï¼ˆç”¨æˆ· IDï¼‰æ˜¯å¦ä¸ºÂ <code>0</code>ï¼ˆUnix/Linux ç³»ç»Ÿä¸­Â <code>root</code>Â ç”¨æˆ·çš„Â <code>uid</code>Â å›ºå®šä¸ºÂ <code>0</code>ï¼‰ï¼Œä»¥æ­¤è¯†åˆ«æ˜¯å¦ä¸ºÂ <code>root</code>Â æƒé™è¿è¡Œã€‚</p>
<h3 data-id="heading-2">è‡ªåŠ¨é™çº§æƒé™</h3>
<p>å¦‚æœæ£€æµ‹åˆ°å½“å‰æ˜¯Â <code>root</code>Â æƒé™ï¼Œå®ƒä¼šå°è¯•åˆ‡æ¢åˆ°ä¸€ä¸ª<strong>é root æ™®é€šç”¨æˆ·</strong>çš„æƒé™æ¥è¿è¡Œåç»­ä»£ç ã€‚</p>
<ul>
<li>é»˜è®¤ä¼šå°è¯•åˆ‡æ¢åˆ°Â <code>nobody</code>Â ç”¨æˆ·ï¼ˆUnix/Linux ç³»ç»Ÿä¸­å†…ç½®çš„æ— ç‰¹æƒç”¨æˆ·ï¼‰ã€‚</li>
<li>ä¹Ÿå¯ä»¥æ‰‹åŠ¨æŒ‡å®šè¦åˆ‡æ¢çš„ç”¨æˆ·ï¼ˆé€šè¿‡ç”¨æˆ·åæˆ–Â <code>uid</code>ï¼‰ã€‚</li>
</ul>
<h3 data-id="heading-3">è§£å†³çš„æ ¸å¿ƒé—®é¢˜</h3>
<p>åœ¨ Unix/Linux ç³»ç»Ÿä¸­ï¼Œä»¥Â <code>root</code>Â æƒé™è¿è¡Œ Node.js åº”ç”¨å­˜åœ¨<strong>æé«˜çš„å®‰å…¨é£é™©</strong>ï¼šä¸€æ—¦åº”ç”¨å­˜åœ¨æ¼æ´è¢«æ”»å‡»ï¼Œæ”»å‡»è€…å°†ç›´æ¥è·å¾—ç³»ç»Ÿçš„æœ€é«˜æƒé™ï¼Œå¯èƒ½å¯¼è‡´æœåŠ¡å™¨è¢«å®Œå…¨æ§åˆ¶ã€‚<code>root-check</code>Â çš„å­˜åœ¨å°±æ˜¯ä¸ºäº†<strong>é¿å…è¿™ç§é£é™©</strong>ï¼Œå¼ºåˆ¶åº”ç”¨ä»¥ä½æƒé™è¿è¡Œï¼Œå³ä½¿è¢«æ”»å‡»ï¼Œå½±å“èŒƒå›´ä¹Ÿä¼šè¢«å¤§å¹…é™åˆ¶ã€‚</p>
<h3 data-id="heading-4">é€‚ç”¨åœºæ™¯</h3>
<ul>
<li>å‘½ä»¤è¡Œå·¥å…·ï¼ˆCLIï¼‰å¼€å‘ï¼šå¾ˆå¤š Node.js å‘½ä»¤è¡Œå·¥å…·ï¼ˆå¦‚å‰ç«¯çš„æ„å»ºå·¥å…·ã€è„šæ‰‹æ¶ï¼‰ä¼šç”¨åˆ°è¿™ä¸ªåŒ…ï¼Œé˜²æ­¢ç”¨æˆ·ä»¥Â <code>root</code>Â æƒé™æ‰§è¡Œå‘½ä»¤å¸¦æ¥é£é™©ã€‚</li>
<li>æœåŠ¡ç«¯åº”ç”¨ï¼šNode.js ç¼–å†™çš„åç«¯æœåŠ¡ï¼Œéƒ¨ç½²æ—¶éœ€è¦é¿å… root æƒé™è¿è¡Œï¼Œå¯é€šè¿‡æ­¤åŒ…è‡ªåŠ¨é™çº§ã€‚</li>
</ul>
<h3 data-id="heading-5">åŸºæœ¬ä½¿ç”¨ç¤ºä¾‹</h3>
<pre><code class="hljs language-js" lang="js">npm install root-check --save
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> rootCheck = <span class="hljs-built_in">require</span>(<span class="hljs-string">'root-check'</span>).<span class="hljs-property">default</span>;
<span class="hljs-comment">// è‡ªåŠ¨é™çº§ä¸º nobody ç”¨æˆ·ï¼ˆå¦‚æœå½“å‰æ˜¯ root æƒé™ï¼‰</span>
<span class="hljs-title function_">rootCheck</span>();
<span class="hljs-comment">// æˆ–è€…æ‰‹åŠ¨æŒ‡å®šè¦åˆ‡æ¢çš„ç”¨æˆ·</span>
<span class="hljs-comment">// rootCheck('www-data'); // åˆ‡æ¢åˆ° www-data ç”¨æˆ·</span>
</code></pre>
<h3 data-id="heading-6">æ³¨æ„äº‹é¡¹</h3>
<ul>
<li><strong>ä»…æ”¯æŒ Unix/Linux ç³»ç»Ÿ</strong>ï¼šWindows ç³»ç»Ÿæ²¡æœ‰Â <code>root</code>/<code>uid</code>Â çš„æ¦‚å¿µï¼Œè¯¥åŒ…åœ¨ Windows ä¸Šä¼šç›´æ¥å¤±æ•ˆï¼ˆæ— å‰¯ä½œç”¨ï¼‰ã€‚</li>
<li><strong>é™çº§å¤±è´¥ä¼šæŠ›å‡ºé”™è¯¯</strong>ï¼šå¦‚æœå½“å‰æ˜¯ root æƒé™ï¼Œä½†æ— æ³•åˆ‡æ¢åˆ°ç›®æ ‡ç”¨æˆ·ï¼ˆæ¯”å¦‚ç›®æ ‡ç”¨æˆ·ä¸å­˜åœ¨ï¼‰ï¼Œ<code>rootCheck</code>Â ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œéœ€è¦æ‰‹åŠ¨æ•è·å¤„ç†ã€‚</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue3æ¡ä»¶æ¸²æŸ“ä¸­v-ifç³»åˆ—æŒ‡ä»¤å¦‚ä½•åˆç†ä½¿ç”¨ä¸è§„é¿é”™è¯¯ï¼Ÿ]]></title>    <link>https://juejin.cn/post/7585485284152295459</link>    <guid>https://juejin.cn/post/7585485284152295459</guid>    <pubDate>2025-12-20T08:13:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585485284152295459" data-draft-id="7585452404113129487" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue3æ¡ä»¶æ¸²æŸ“ä¸­v-ifç³»åˆ—æŒ‡ä»¤å¦‚ä½•åˆç†ä½¿ç”¨ä¸è§„é¿é”™è¯¯ï¼Ÿ    "/> <meta itemprop="keywords" content="å‰ç«¯,Trae,AIç¼–ç¨‹"/> <meta itemprop="datePublished" content="2025-12-20T08:13:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="kknone"/> <meta itemprop="url" content="https://juejin.cn/user/1366025597879930"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="æ˜é‡‘"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue3æ¡ä»¶æ¸²æŸ“ä¸­v-ifç³»åˆ—æŒ‡ä»¤å¦‚ä½•åˆç†ä½¿ç”¨ä¸è§„é¿é”™è¯¯ï¼Ÿ    
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1366025597879930/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    kknone
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T08:13:19.000Z" title="Sat Dec 20 2025 08:13:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    é˜…è¯»14åˆ†é’Ÿ
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">ä¸€ã€Vue3æ¡ä»¶æ¸²æŸ“çš„æ ¸å¿ƒæ¦‚å¿µ</h3>
<p>åœ¨Vue3ä¸­ï¼Œ<strong>æ¡ä»¶æ¸²æŸ“</strong>æ˜¯æŒ‡æ ¹æ®<strong>å“åº”å¼æ•°æ®çš„çœŸå‡</strong>ï¼Œå†³å®šæ˜¯å¦åœ¨é¡µé¢ä¸Šæ¸²æŸ“æŸä¸ªå…ƒç´ æˆ–ç»„ä»¶ã€‚è€Œ<code>v-if</code>ã€<code>v-else</code>ã€<code>v-else-if</code>
è¿™ç»„æŒ‡ä»¤ï¼Œå°±æ˜¯å®ç°æ¡ä»¶æ¸²æŸ“çš„â€œæ ¸å¿ƒå·¥å…·â€â€”â€”å®ƒä»¬åƒä¸€å¥—â€œé€»è¾‘å¼€å…³â€ï¼Œå¸®ä½ ç²¾å‡†æ§åˆ¶DOMçš„æ˜¾ç¤ºä¸éšè—ã€‚</p>
<h3 data-id="heading-1">äºŒã€v-ifç³»åˆ—æŒ‡ä»¤çš„è¯­æ³•ä¸ç”¨æ³•</h3>
<p>æˆ‘ä»¬å…ˆé€ä¸ªæ‹†è§£æ¯ä¸ªæŒ‡ä»¤çš„ä½œç”¨ï¼Œå†é€šè¿‡<strong>å®é™…æ¡ˆä¾‹</strong>ä¸²èµ·æ¥ç”¨ã€‚</p>
<h4 data-id="heading-2">2.1 v-ifï¼šåŸºç¡€æ¡ä»¶åˆ¤æ–­</h4>
<p><code>v-if</code>æ˜¯æœ€åŸºç¡€çš„æ¡ä»¶æŒ‡ä»¤ï¼Œå®ƒçš„è¯­æ³•å¾ˆç®€å•ï¼š</p>
<pre><code class="hljs language-html" lang="html">
<span class="hljs-tag">&lt;<span class="hljs-name">å…ƒç´ </span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"æ¡ä»¶è¡¨è¾¾å¼"</span>&gt;</span>è¦æ¸²æŸ“çš„å†…å®¹<span class="hljs-tag">&lt;/<span class="hljs-name">å…ƒç´ </span>&gt;</span>
</code></pre>
<ul>
<li><strong>æ¡ä»¶è¡¨è¾¾å¼</strong>ï¼šå¯ä»¥æ˜¯ä»»ä½•è¿”å›<code>true</code>æˆ–<code>false</code>çš„JavaScriptè¡¨è¾¾å¼ï¼ˆæ¯”å¦‚<code>isLogin</code>ã€<code>score &gt;= 90</code>ï¼‰ã€‚</li>
<li><strong>æƒ°æ€§æ¸²æŸ“</strong>ï¼š<code>v-if</code>æ˜¯â€œæ‡’â€çš„â€”â€”å¦‚æœåˆå§‹æ¡ä»¶ä¸æ»¡è¶³ï¼ˆæ¯”å¦‚<code>isLogin = false</code>ï¼‰ï¼Œå…ƒç´ <strong>ä¸ä¼šè¢«æ¸²æŸ“åˆ°DOMä¸­</strong>ï¼ˆè¿DOMèŠ‚ç‚¹éƒ½ä¸ä¼šç”Ÿæˆï¼‰ï¼›åªæœ‰å½“æ¡ä»¶å˜ä¸º
<code>true</code>æ—¶ï¼Œæ‰ä¼šâ€œä»é›¶å¼€å§‹â€åˆ›å»ºå…ƒç´ åŠå…¶å­ç»„ä»¶ã€‚</li>
</ul>
<p>ä¸¾ä¸ªä¾‹å­ï¼šåˆ¤æ–­ç”¨æˆ·æ˜¯å¦ç™»å½•ï¼Œæ˜¾ç¤ºä¸åŒçš„å†…å®¹ï¼š</p>
<pre><code class="hljs language-vue" lang="vue">
&lt;script setup&gt;
  import {ref} from 'vue'

  const isLogin = ref(false) // åˆå§‹æœªç™»å½•
&lt;/script&gt;

&lt;template&gt;
  &lt;div&gt;
    &lt;!-- ç™»å½•åæ˜¾ç¤º --&gt;
    &lt;p v-if="isLogin"&gt;æ¬¢è¿å›æ¥ï¼Œç”¨æˆ·ï¼&lt;/p&gt;
    &lt;!-- æœªç™»å½•æ˜¾ç¤º --&gt;
    &lt;button v-if="!isLogin" @click="isLogin = true"&gt;ç‚¹å‡»ç™»å½•&lt;/button&gt;
  &lt;/div&gt;
&lt;/template&gt;
</code></pre>
<p>å½“ç‚¹å‡»æŒ‰é’®æ—¶ï¼Œ<code>isLogin</code>å˜ä¸º<code>true</code>ï¼Œæœªç™»å½•çš„æŒ‰é’®ä¼šè¢«é”€æ¯ï¼ŒåŒæ—¶æ¸²æŸ“â€œæ¬¢è¿â€æ–‡æœ¬â€”â€”è¿™å°±æ˜¯<code>v-if</code>çš„â€œé”€æ¯/é‡å»ºâ€é€»è¾‘ã€‚</p>
<details>
<summary>å¾€æœŸæ–‡ç« å½’æ¡£</summary>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F218c3a59282c3b757447ee08a01937bb%2F" target="_blank" title="https://blog.cmdragon.cn/posts/218c3a59282c3b757447ee08a01937bb/" ref="nofollow noopener noreferrer">Vue3åŠ¨æ€æ ·å¼æ§åˆ¶ï¼šrefã€reactiveã€watchä¸computedçš„åº”ç”¨åœºæ™¯ä¸åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F1bab953e41f66ac53de099fa9fe76483%2F" target="_blank" title="https://blog.cmdragon.cn/posts/1bab953e41f66ac53de099fa9fe76483/" ref="nofollow noopener noreferrer">Vue3ä¸­åŠ¨æ€æ ·å¼æ•°ç»„çš„åé¡¹è¦†ç›–è§„åˆ™å¦‚ä½•ä¸è®¡ç®—å±æ€§ç»“åˆå®ç°å¤æ‚çŠ¶æ€æ ·å¼ç®¡ç†ï¼Ÿ</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fc85e1fe16a7ae45e965b4e2df4d9d2f4%2F" target="_blank" title="https://blog.cmdragon.cn/posts/c85e1fe16a7ae45e965b4e2df4d9d2f4/" ref="nofollow noopener noreferrer">Vueæµ…å“åº”å¼å¦‚ä½•è§£å†³æ·±å±‚å“åº”å¼çš„æ€§èƒ½é—®é¢˜ï¼Ÿé€‚ç”¨åœºæ™¯æœ‰å“ªäº›ï¼Ÿ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fbe04b02d2723994632de0d4ca22a3391%2F" target="_blank" title="https://blog.cmdragon.cn/posts/be04b02d2723994632de0d4ca22a3391/" ref="nofollow noopener noreferrer">Vue 3ç»„åˆå¼APIä¸­refä¸reactiveçš„æ ¸å¿ƒå“åº”å¼å·®å¼‚åŠä½¿ç”¨æœ€ä½³å®è·µæ˜¯ä»€ä¹ˆï¼Ÿ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fbe04b02d2723994632de0d4ca22a3391%2F" target="_blank" title="https://blog.cmdragon.cn/posts/be04b02d2723994632de0d4ca22a3391/" ref="nofollow noopener noreferrer">Vue 3ç»„åˆå¼APIä¸­refä¸reactiveçš„æ ¸å¿ƒå“åº”å¼å·®å¼‚åŠä½¿ç”¨æœ€ä½³å®è·µæ˜¯ä»€ä¹ˆï¼Ÿ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fa0af08dd60a37b9a890a9957f2cbfc9f%2F" target="_blank" title="https://blog.cmdragon.cn/posts/a0af08dd60a37b9a890a9957f2cbfc9f/" ref="nofollow noopener noreferrer">Vue3å“åº”å¼ç³»ç»Ÿä¸­ï¼Œå¯¹è±¡æ–°å¢å±æ€§ã€æ•°ç»„æ”¹ç´¢å¼•ã€åŸå§‹å€¼ä»£ç†çš„é—®é¢˜å¦‚ä½•è§£å†³ï¼Ÿ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fbc287e1e36287afd90750fd907eca85e%2F" target="_blank" title="https://blog.cmdragon.cn/posts/bc287e1e36287afd90750fd907eca85e/" ref="nofollow noopener noreferrer">Vue 3ä¸­watchä¾¦å¬å™¨çš„æ­£ç¡®ä½¿ç”¨å§¿åŠ¿ä½ æŒæ¡äº†å—ï¼Ÿæ·±åº¦ç›‘å¬ã€ä¸watchEffectçš„å·®å¼‚åŠå¸¸è§æŠ¥é”™è§£æ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F654b9447ef1ba7ec1126a1bc26a4726d%2F" target="_blank" title="https://blog.cmdragon.cn/posts/654b9447ef1ba7ec1126a1bc26a4726d/" ref="nofollow noopener noreferrer">Vueå“åº”å¼å£°æ˜çš„APIå·®å¼‚ã€åº•å±‚åŸç†ä¸å¸¸è§é™·é˜±ä½ éƒ½ææ‡‚äº†å— - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F654b9447ef1ba7ec1126a1bc26a4726d%2F" target="_blank" title="https://blog.cmdragon.cn/posts/654b9447ef1ba7ec1126a1bc26a4726d/" ref="nofollow noopener noreferrer">Vueå“åº”å¼å£°æ˜çš„APIå·®å¼‚ã€åº•å±‚åŸç†ä¸å¸¸è§é™·é˜±ä½ éƒ½ææ‡‚äº†å— - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fc405a8d9950af5b7c63b56c348ac36b6%2F" target="_blank" title="https://blog.cmdragon.cn/posts/c405a8d9950af5b7c63b56c348ac36b6/" ref="nofollow noopener noreferrer">ä¸ºä»€ä¹ˆVue 3éœ€è¦refå‡½æ•°ï¼Ÿå®ƒçš„å“åº”å¼åŸç†ä¸æ­£ç¡®ç”¨æ³•æ˜¯ä»€ä¹ˆï¼Ÿ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fa7e9abb9691a81e4404d9facabe0f7c3%2F" target="_blank" title="https://blog.cmdragon.cn/posts/a7e9abb9691a81e4404d9facabe0f7c3/" ref="nofollow noopener noreferrer">Vue 3ä¸­reactiveå‡½æ•°å¦‚ä½•é€šè¿‡Proxyå®ç°å“åº”å¼ï¼Ÿä½¿ç”¨æ—¶è¦é¿å¼€å“ªäº›è¯¯åŒºï¼Ÿ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fbd995ea45161727597fb85b62566c43d%2F" target="_blank" title="https://blog.cmdragon.cn/posts/bd995ea45161727597fb85b62566c43d/" ref="nofollow noopener noreferrer">Vue3å“åº”å¼ç³»ç»Ÿçš„åº•å±‚åŸç†ä¸å®è·µè¦ç‚¹ä½ çœŸçš„æ‡‚å—ï¼Ÿ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F53e3f270a80675df662c6857a3332c0f%2F" target="_blank" title="https://blog.cmdragon.cn/posts/53e3f270a80675df662c6857a3332c0f/" ref="nofollow noopener noreferrer">Vue 3æ¨¡æ¿å¦‚ä½•é€šè¿‡ç¼–è¯‘ä¸‰é˜¶æ®µå®ç°ä»å£°æ˜å¼è¯­æ³•åˆ°é«˜æ•ˆæ¸²æŸ“çš„è·¨è¶Š - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fddbce4f2a23aa72c96b1c0473900321e%2F" target="_blank" title="https://blog.cmdragon.cn/posts/ddbce4f2a23aa72c96b1c0473900321e/" ref="nofollow noopener noreferrer">å¿«é€Ÿå…¥é—¨Vueæ¨¡æ¿å¼•ç”¨ï¼šä»æ”¶DOMâ€œå¿«é€’â€åˆ°è°ƒå­ç»„ä»¶æ–¹æ³•ï¼Œä½ ç©æ˜ç™½äº†å—ï¼Ÿ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F23a2d5a334e15575277814c16e45df50%2F" target="_blank" title="https://blog.cmdragon.cn/posts/23a2d5a334e15575277814c16e45df50/" ref="nofollow noopener noreferrer">å¿«é€Ÿå…¥é—¨Vueæ¨¡æ¿é‡Œçš„JSè¡¨è¾¾å¼æœ‰å•¥ä¸èƒ½ç¢°ï¼Ÿè®¡ç®—å±æ€§ä¸ºå•¥æ¯”æ–¹æ³•æ›´èƒ½æ‰“ï¼Ÿ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F6be38de6382e31d282659b689c5b17f0%2F" target="_blank" title="https://blog.cmdragon.cn/posts/6be38de6382e31d282659b689c5b17f0/" ref="nofollow noopener noreferrer">å¿«é€Ÿå…¥é—¨Vueçš„v-modelè¡¨å•ç»‘å®šï¼šè¯­æ³•ç³–ã€åŠ¨æ€å€¼ã€ä¿®é¥°ç¬¦çš„å°æŠ€å·§ä½ éƒ½æŒæ¡äº†å—ï¼Ÿ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F60ce517684f4a418f453d66aa805606c%2F" target="_blank" title="https://blog.cmdragon.cn/posts/60ce517684f4a418f453d66aa805606c/" ref="nofollow noopener noreferrer">å¿«é€Ÿå…¥é—¨Vue3äº‹ä»¶å¤„ç†çš„æŒ‘æˆ˜é¢˜ï¼šv-onã€ä¿®é¥°ç¬¦ã€è‡ªå®šä¹‰äº‹ä»¶ä½ èƒ½é€šå…³å—ï¼Ÿ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fe4ae7d5e4a9205bb11b2baccb230c637%2F" target="_blank" title="https://blog.cmdragon.cn/posts/e4ae7d5e4a9205bb11b2baccb230c637/" ref="nofollow noopener noreferrer">å¿«é€Ÿå…¥é—¨Vue3çš„v-æŒ‡ä»¤ï¼šæ•°æ®å’ŒDOMçš„â€œç¿»è¯‘å®˜â€åˆ°åº•æœ‰å¤šå°‘æœ¬äº‹ï¼Ÿ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F999ce4fb32259ff4fbf4bf7bcb851654%2F" target="_blank" title="https://blog.cmdragon.cn/posts/999ce4fb32259ff4fbf4bf7bcb851654/" ref="nofollow noopener noreferrer">å¿«é€Ÿå…¥é—¨Vue3ï¼Œæ’å€¼ã€åŠ¨æ€ç»‘å®šå’Œé¿å‘æŠ€å·§ä½ éƒ½ææ‡‚äº†å—ï¼Ÿ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fa6997d81b49cd232b87e1cf603888ad1%2F" target="_blank" title="https://blog.cmdragon.cn/posts/a6997d81b49cd232b87e1cf603888ad1/" ref="nofollow noopener noreferrer">æƒ³è®©PostgreSQLå¿«åˆ°é£èµ·ï¼Ÿå…ˆæ‰¾å¥åº·å¯†ç è¿˜æ˜¯å…ˆæ¢å¼•æ“ï¼Ÿ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F1fee7afbb9abd4540b8aa9c141d6845d%2F" target="_blank" title="https://blog.cmdragon.cn/posts/1fee7afbb9abd4540b8aa9c141d6845d/" ref="nofollow noopener noreferrer">æƒ³è®©PostgreSQLæŸ¥è¯¢å¿«åˆ°é£èµ·ï¼Ÿåˆ†åŒºè¡¨ã€ç‰©åŒ–è§†å›¾ã€å¹¶è¡ŒæŸ¥è¯¢è¿™ä¸‰æ‹›çµä¸çµï¼Ÿ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F79c590fbd87ece535b11a71c9667884f%2F" target="_blank" title="https://blog.cmdragon.cn/posts/79c590fbd87ece535b11a71c9667884f/" ref="nofollow noopener noreferrer">å­æŸ¥è¯¢æ€»æ‹–æ…¢æŸ¥è¯¢ï¼ŸæŠŠå®ƒå˜æˆè¿æ¥å°±èƒ½è§£å†³ï¼Ÿ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F748cdac2536008199abf8a8a2cd0ec85%2F" target="_blank" title="https://blog.cmdragon.cn/posts/748cdac2536008199abf8a8a2cd0ec85/" ref="nofollow noopener noreferrer">PostgreSQLå…¨è¡¨æ‰«ææ…¢åˆ°å´©æºƒï¼Ÿå»ºç´¢å¼•+æ”¹æŸ¥è¯¢+æ›´ç»Ÿè®¡ä¿¡æ¯ä¸‰æ‹›èƒ½ç ´ï¼Ÿ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F32ca943703226d317d4276a8fb53b0dd%2F" target="_blank" title="https://blog.cmdragon.cn/posts/32ca943703226d317d4276a8fb53b0dd/" ref="nofollow noopener noreferrer">å¤æ‚æŸ¥è¯¢æ€»æ‹–åè…¿ï¼ŸPostgreSQLå¤šåˆ—ç´¢å¼•+è¦†ç›–ç´¢å¼•çš„ç¥ä»™æŠ€å·§ä½ getæ²¡ï¼Ÿ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fca93f1d53aa910e7ba5ffd8df611c12b%2F" target="_blank" title="https://blog.cmdragon.cn/posts/ca93f1d53aa910e7ba5ffd8df611c12b/" ref="nofollow noopener noreferrer">åªç»™è¡¨å­é›†å»ºç´¢å¼•ï¼Ÿç”¨å‡½æ•°ç»“æœå»ºç´¢å¼•ï¼ŸPostgreSQLè¿™ä¿©æ“ä½œå‡­å•¥èƒ½çœç©ºé—´åˆåŠ é€Ÿï¼Ÿ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Ff507856ebfddd592448813c510a53669%2F" target="_blank" title="https://blog.cmdragon.cn/posts/f507856ebfddd592448813c510a53669/" ref="nofollow noopener noreferrer">B-treeç´¢å¼•åƒå­—å…¸æŸ¥è¯ä¸€æ ·å·¥ä½œï¼Ÿé‚£å“ªäº›æ•°æ®åº“æŸ¥è¯¢å®ƒèƒ½åŠ é€Ÿï¼Œå“ªäº›ä¸èƒ½ï¼Ÿ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fb2213bfcb5b88a862f2138404c03d596%2F" target="_blank" title="https://blog.cmdragon.cn/posts/b2213bfcb5b88a862f2138404c03d596/" ref="nofollow noopener noreferrer">æƒ³æŠ“PostgreSQLé‡Œçš„æ…¢SQLï¼Ÿpg_stat_statementsåŸºç¡€é»‘åŒ£å­å’Œpg_stat_monitoræ—¶é—´çª—ï¼Œè°èƒ½å¸®ä½ æ›´å‡†æªå‡ºæ€§èƒ½å°å·ï¼Ÿ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F26614eb7da6c476dde41d367ad888d2f%2F" target="_blank" title="https://blog.cmdragon.cn/posts/26614eb7da6c476dde41d367ad888d2f/" ref="nofollow noopener noreferrer">PostgreSQLçš„â€œæ—¶å…‰æœºâ€MVCCå’Œé”æœºåˆ¶æ˜¯æ€ä¹ˆæå®šé«˜å¹¶å‘çš„ï¼Ÿ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F69f99bc6972a860d559c74aad7280da4%2F" target="_blank" title="https://blog.cmdragon.cn/posts/69f99bc6972a860d559c74aad7280da4/" ref="nofollow noopener noreferrer">PostgreSQLæ€§èƒ½æš´æ¶¨çš„å…³é”®ï¼Ÿå†…å­˜IOå¹¶å‘å‚æ•°å±…ç„¶è¦è¿™ä¹ˆè®¾ç½®ï¼Ÿ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F7b7053f392147a8b3b1a16bebeb08d0a%2F" target="_blank" title="https://blog.cmdragon.cn/posts/7b7053f392147a8b3b1a16bebeb08d0a/" ref="nofollow noopener noreferrer">å¤§è¡¨æŸ¥è¯¢æ…¢åˆ°ç¿»éæ•´ä¸ªä¹¦æ¶ï¼ŸPostgreSQLåˆ†åŒºè¡¨æ•™ä½ æ€ä¹ˆâ€œåˆ†ç±»â€æ‰é«˜æ•ˆ</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fc856e3cb073822349f3bf2d29995dcfc%2F" target="_blank" title="https://blog.cmdragon.cn/posts/c856e3cb073822349f3bf2d29995dcfc/" ref="nofollow noopener noreferrer">PostgreSQL æŸ¥è¯¢æ…¢ï¼Ÿæ˜¯ä¸æ˜¯å¿˜äº†ä¼˜åŒ– GROUP BYã€ORDER BY å’Œçª—å£å‡½æ•°ï¼Ÿ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fc096347d18e67b7431faacd2c4757093%2F" target="_blank" title="https://blog.cmdragon.cn/posts/c096347d18e67b7431faacd2c4757093/" ref="nofollow noopener noreferrer">PostgreSQLé‡Œçš„å­æŸ¥è¯¢å’ŒCTEå±…ç„¶åœ¨æ€§èƒ½ä¸Šâ€œææ¶â€ï¼Ÿåˆ°åº•è¯¥ç«™å“ªè¾¹ï¼Ÿ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F2eca89463454fd4250d7b66243b9fe5a%2F" target="_blank" title="https://blog.cmdragon.cn/posts/2eca89463454fd4250d7b66243b9fe5a/" ref="nofollow noopener noreferrer">PostgreSQLé€‰Joinç­–ç•¥æœ‰å•¥å°ä¹ä¹ï¼ŸNested Loop/Merge/Hashè°æ˜¯å®ƒçš„èœï¼Ÿ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F068ecb772a87d7df20a8c9fb4b233f8e%2F" target="_blank" title="https://blog.cmdragon.cn/posts/068ecb772a87d7df20a8c9fb4b233f8e/" ref="nofollow noopener noreferrer">PostgreSQLæ–°æ‰‹SQLæ€»ç¿»è½¦ï¼Ÿè¿™7ä¸ªæ€§èƒ½é™·é˜±ä½ è¸©è¿‡æ²¡ï¼Ÿ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fd498f63cd0a2d5a77e445c688a8b88db%2F" target="_blank" title="https://blog.cmdragon.cn/posts/d498f63cd0a2d5a77e445c688a8b88db/" ref="nofollow noopener noreferrer">PostgreSQLç´¢å¼•é€‰B-Treeè¿˜æ˜¯GiSTï¼Ÿâ€œç‘å£«å†›åˆ€â€å’Œâ€œå¤šé¢æ‰‹â€çš„å·®åˆ«ä½ å±…ç„¶è¿˜ä¸çŸ¥é“ï¼Ÿ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F9101b75bdec6faea9b35d54f14e37f36%2F" target="_blank" title="https://blog.cmdragon.cn/posts/9101b75bdec6faea9b35d54f14e37f36/" ref="nofollow noopener noreferrer">æƒ³çŸ¥é“æ•°æ®åº“æ€ä¹ˆç»™æŸ¥è¯¢â€œç®—æˆæœ¬é€‰è·¯çº¿â€ï¼ŸEXPLAINèƒ½å¸®ä½ çœ‹æ˜ç™½ï¼Ÿ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fd527f8ebb6e3dae2c7dfe4c8d8979444%2F" target="_blank" title="https://blog.cmdragon.cn/posts/d527f8ebb6e3dae2c7dfe4c8d8979444/" ref="nofollow noopener noreferrer">PostgreSQLå¤„ç†SQLå±…ç„¶åƒåšè›‹ç³•ï¼Ÿè§£æåˆ°æ‰§è¡Œçš„4æ­¥é‡Œè—ç€å¤šå°‘æŸ¥è¯¢ä¼˜åŒ–çš„å°å¿ƒæœºï¼Ÿ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F6bfdae84f313cf7ad0bb7045c4392347%2F" target="_blank" title="https://blog.cmdragon.cn/posts/6bfdae84f313cf7ad0bb7045c4392347/" ref="nofollow noopener noreferrer">PostgreSQLå¤‡ä»½ä¸æ˜¯å¤åˆ¶æ–‡ä»¶ï¼Ÿç‰©ç†vsé€»è¾‘å’‹é€‰ï¼Ÿè¯¯åˆ è¿˜èƒ½ç²¾å‡†æ¢å¤åˆ°1åˆ†é’Ÿå‰ï¼Ÿ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fde3672803de34dbad244d0a8d48b0eb5%2F" target="_blank" title="https://blog.cmdragon.cn/posts/de3672803de34dbad244d0a8d48b0eb5/" ref="nofollow noopener noreferrer">è½¬è´¦ä¸ç¿»è½¦ã€å¹¶å‘ä¸å¹²æ‰°ï¼ŒPostgreSQLçš„ACIDç‰¹æ€§åˆ°åº•æœ‰å•¥é­”æ³•ï¼Ÿ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fe463e8a2668abdf00a228c9b79324ded%2F" target="_blank" title="https://blog.cmdragon.cn/posts/e463e8a2668abdf00a228c9b79324ded/" ref="nofollow noopener noreferrer">é“¶è¡Œè½¬è´¦ä¸ç™½æ‰£é’±ã€ç”µå•†ä¸‹å•ä¸è¶…å–ï¼ŒPostgreSQLäº‹åŠ¡çš„è¯€çªæ˜¯å•¥ï¼Ÿ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F5c967e595058c4a1fc4474a68e64031d%2F" target="_blank" title="https://blog.cmdragon.cn/posts/5c967e595058c4a1fc4474a68e64031d/" ref="nofollow noopener noreferrer">PostgreSQLé‡Œçš„PL/pgSQLåˆ°åº•æ˜¯å•¥ï¼Ÿèƒ½è®©SQLä»â€œè¯´ç›®æ ‡â€å˜â€œè®²æ­¥éª¤â€ï¼Ÿ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F325047855e3e23b5ef82f7d2db134fbd%2F" target="_blank" title="https://blog.cmdragon.cn/posts/325047855e3e23b5ef82f7d2db134fbd/" ref="nofollow noopener noreferrer">PostgreSQLè§†å›¾ä¸å­˜æ•°æ®ï¼Ÿé‚£å®ƒæ€ä¹ˆç®€åŒ–æŸ¥è¯¢è¿˜èƒ½é€’å½’ç”Ÿæˆåºåˆ—å’Œæ§åˆ¶æƒé™ï¼Ÿ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fd2dba50bb6e4df7b27e735245a06a2a2%2F" target="_blank" title="https://blog.cmdragon.cn/posts/d2dba50bb6e4df7b27e735245a06a2a2/" ref="nofollow noopener noreferrer">PostgreSQLç´¢å¼•è¿™ä¹ˆç©ï¼Œæ‰èƒ½è®©ä½ çš„æŸ¥è¯¢çœŸçš„â€œé£â€èµ·æ¥ï¼Ÿ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F849ae5bab0f8c66e94c2f6ad1bb798e3%2F" target="_blank" title="https://blog.cmdragon.cn/posts/849ae5bab0f8c66e94c2f6ad1bb798e3/" ref="nofollow noopener noreferrer">PostgreSQLçš„è¡¨å…³ç³»å’Œçº¦æŸï¼Œå’‹å¸®ä½ æå®šç”¨æˆ·è®¢å•ä¸æ··ä¹±ã€å­¦ç”Ÿé€‰è¯¾ä¸é‡å¤ï¼Ÿ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fef4800975ffa84f1ca51976a70a1585b%2F" target="_blank" title="https://blog.cmdragon.cn/posts/ef4800975ffa84f1ca51976a70a1585b/" ref="nofollow noopener noreferrer">PostgreSQLæŸ¥è¯¢çš„ç­›å­ã€æ’åºã€èšåˆã€åˆ†ç»„ï¼Ÿä½ ä¼šç”¨å®ƒä»¬æå®šæ•°æ®å—ï¼Ÿ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fbf54711525c507c5eacfa7b0151c39d2%2F" target="_blank" title="https://blog.cmdragon.cn/posts/bf54711525c507c5eacfa7b0151c39d2/" ref="nofollow noopener noreferrer">PostgreSQLæ•°æ®ç±»å‹æ€ä¹ˆé€‰æ‰é«˜æ•ˆä¸è¸©å‘ï¼Ÿ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F887809b3e0375f5956873cd442f516d8%2F" target="_blank" title="https://blog.cmdragon.cn/posts/887809b3e0375f5956873cd442f516d8/" ref="nofollow noopener noreferrer">æƒ³è§£é”PostgreSQLæŸ¥è¯¢ä»åŸºç¡€åˆ°è¿›é˜¶çš„æ ¸å¿ƒçŸ¥è¯†ç‚¹ï¼Ÿä½ éƒ½getäº†å—ï¼Ÿ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F934be1203725e8be9d6f6e9104e5abcc%2F" target="_blank" title="https://blog.cmdragon.cn/posts/934be1203725e8be9d6f6e9104e5abcc/" ref="nofollow noopener noreferrer">PostgreSQL DELETEå±…ç„¶æœ‰è¿™äº›æ“ä½œï¼Ÿè¿”å›æ•°æ®ã€è¿è¡¨åˆ ä½ è¯•è¿‡æ²¡ï¼Ÿ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F0f0622e9b7402b599e618150d0596ffe%2F" target="_blank" title="https://blog.cmdragon.cn/posts/0f0622e9b7402b599e618150d0596ffe/" ref="nofollow noopener noreferrer">PostgreSQL UPDATEè¯­å¥æ€ä¹ˆç©ï¼Ÿä»æ”¹é‚®ç®±åˆ°æ‰¹é‡æ›´æ–°çš„é¿å‘æŠ€å·§ä½ éƒ½ä¼šå—ï¼Ÿ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F0e3bf7efc030b024ea67ee855a00f2de%2F" target="_blank" title="https://blog.cmdragon.cn/posts/0e3bf7efc030b024ea67ee855a00f2de/" ref="nofollow noopener noreferrer">PostgreSQLæ’å…¥æ•°æ®è¿˜åœ¨é€æ¡æ•²ï¼Ÿæ‰¹é‡ã€å†²çªå¤„ç†ã€è¿”å›è‡ªå¢IDçš„æŠ€å·§ä½ ä¼šå—ï¼Ÿ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fb6cd3c86da6aac26ed829e472d34078e%2F" target="_blank" title="https://blog.cmdragon.cn/posts/b6cd3c86da6aac26ed829e472d34078e/" ref="nofollow noopener noreferrer">PostgreSQLçš„â€œä»“åº“-æˆ¿é—´-è´§æ¶â€æ¸¸æˆï¼Œä½ èƒ½å»ºå‡ºç”µå•†æ•°æ®åº“å’Œè¡¨å—ï¼Ÿ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fba1f545a3410144552fbdbfcf31b5265%2F" target="_blank" title="https://blog.cmdragon.cn/posts/ba1f545a3410144552fbdbfcf31b5265/" ref="nofollow noopener noreferrer">PostgreSQL 17å®‰è£…æ€»ç¿»è½¦ï¼ŸWindows/macOS/Linuxé¿å‘æŒ‡å—å¸®ä½ æå®šï¼Ÿ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fb5474d1480509c5072085abc80b3dd9f%2F" target="_blank" title="https://blog.cmdragon.cn/posts/b5474d1480509c5072085abc80b3dd9f/" ref="nofollow noopener noreferrer">èƒ½å½“å…³ç³»å‹æ•°æ®åº“è¿˜èƒ½ç©å¯¹è±¡ç‰¹æ€§ï¼Œèƒ½æ‹†å¤æ‚æŸ¥è¯¢è¿˜èƒ½è‡ªåŠ¨ç®¡åº“å­˜ï¼ŒPostgreSQLå‡­ä»€ä¹ˆè¿™ä¹ˆé¦™ï¼Ÿ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fcc098d8836e787baa8a4d92e4d56d5c5%2F" target="_blank" title="https://blog.cmdragon.cn/posts/cc098d8836e787baa8a4d92e4d56d5c5/" ref="nofollow noopener noreferrer">ç»™æ¥å£åŠ æ–°å­—æ®µåˆä¸æå´©è€å®¢æˆ·ç«¯ï¼ŸFastAPIçš„å¤šç‰ˆæœ¬APIé å“ªä¸‰æ‹›å®ç°ï¼Ÿ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F46d05151c5bd31cf37a7bcf0b8f5b0b8%2F" target="_blank" title="https://blog.cmdragon.cn/posts/46d05151c5bd31cf37a7bcf0b8f5b0b8/" ref="nofollow noopener noreferrer">æµé‡çªå¢è¦æå´©FastAPIï¼Ÿç†”æ–­æµ‹è¯•æ˜¯æ€ä¹ˆé˜²ç³»ç»Ÿé›ªå´©çš„ï¼Ÿ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F65ce343cc5df9faf3a8e2eeaab42ae45%2F" target="_blank" title="https://blog.cmdragon.cn/posts/65ce343cc5df9faf3a8e2eeaab42ae45/" ref="nofollow noopener noreferrer">FastAPIç§’æ€åº“å­˜æ€»å˜è´Ÿæ•°ï¼ŸRedisåˆ†å¸ƒå¼é”èƒ½å¸®ä½ å®ˆä½åº•çº¿å— - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Feed6cd8985d9be0a4b092a7da38b3e0c%2F" target="_blank" title="https://blog.cmdragon.cn/posts/eed6cd8985d9be0a4b092a7da38b3e0c/" ref="nofollow noopener noreferrer">FastAPIçš„CIæµæ°´çº¿æ€ä¹ˆè‡ªåŠ¨æµ‹ç«¯ç‚¹ï¼Œè¿˜èƒ½è®©AllureæŠ¥å‘Šç¾åˆ°çŠ¯è§„ï¼Ÿ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F6157d87338ce894d18c013c3c4777abb%2F" target="_blank" title="https://blog.cmdragon.cn/posts/6157d87338ce894d18c013c3c4777abb/" ref="nofollow noopener noreferrer">å¦‚ä½•ç”¨GitHub Actionsä¸ºFastAPIé¡¹ç›®æ‰“é€ è‡ªåŠ¨åŒ–æµ‹è¯•æµæ°´çº¿ï¼Ÿ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Ffc4ef84559e04693a620d0714cb30787%2F" target="_blank" title="https://blog.cmdragon.cn/posts/fc4ef84559e04693a620d0714cb30787/" ref="nofollow noopener noreferrer">å¦‚ä½•ç”¨Git Hookå’ŒCIæµæ°´çº¿ä¸ºFastAPIé¡¹ç›®ä¿é©¾æŠ¤èˆªï¼Ÿ - cmdragon's Blog</a></li>
</ul>
</details>
<details>
<summary>å…è´¹å¥½ç”¨çš„çƒ­é—¨åœ¨çº¿å·¥å…·</summary>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fraid-calculator" target="_blank" title="https://tools.cmdragon.cn/zh/apps/raid-calculator" ref="nofollow noopener noreferrer">RAID è®¡ç®—å™¨ - åº”ç”¨å•†åº— | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fphotoshop-online" target="_blank" title="https://tools.cmdragon.cn/zh/apps/photoshop-online" ref="nofollow noopener noreferrer">åœ¨çº¿PS - åº”ç”¨å•†åº— | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fmermaid-live-editor" target="_blank" title="https://tools.cmdragon.cn/zh/apps/mermaid-live-editor" ref="nofollow noopener noreferrer">Mermaid åœ¨çº¿ç¼–è¾‘å™¨ - åº”ç”¨å•†åº— | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fmath-solver-calculator" target="_blank" title="https://tools.cmdragon.cn/zh/apps/math-solver-calculator" ref="nofollow noopener noreferrer">æ•°å­¦æ±‚è§£è®¡ç®—å™¨ - åº”ç”¨å•†åº— | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fsmart-teleprompter" target="_blank" title="https://tools.cmdragon.cn/zh/apps/smart-teleprompter" ref="nofollow noopener noreferrer">æ™ºèƒ½æè¯å™¨ - åº”ç”¨å•†åº— | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fmagic-resume" target="_blank" title="https://tools.cmdragon.cn/zh/apps/magic-resume" ref="nofollow noopener noreferrer">é­”æ³•ç®€å† - åº”ç”¨å•†åº— | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fimage-puzzle-tool" target="_blank" title="https://tools.cmdragon.cn/zh/apps/image-puzzle-tool" ref="nofollow noopener noreferrer">Image Puzzle Tool - å›¾ç‰‡æ‹¼å›¾å·¥å…· | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fsubtitle-downloader" target="_blank" title="https://tools.cmdragon.cn/zh/apps/subtitle-downloader" ref="nofollow noopener noreferrer">å­—å¹•ä¸‹è½½å·¥å…· - åº”ç”¨å•†åº— | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Flyrics-generator" target="_blank" title="https://tools.cmdragon.cn/zh/apps/lyrics-generator" ref="nofollow noopener noreferrer">æ­Œè¯ç”Ÿæˆå·¥å…· - åº”ç”¨å•†åº— | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fcloud-drive-search" target="_blank" title="https://tools.cmdragon.cn/zh/apps/cloud-drive-search" ref="nofollow noopener noreferrer">ç½‘ç›˜èµ„æºèšåˆæœç´¢ - åº”ç”¨å•†åº— | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fascii-art-generator" target="_blank" title="https://tools.cmdragon.cn/zh/apps/ascii-art-generator" ref="nofollow noopener noreferrer">ASCIIå­—ç¬¦ç”»ç”Ÿæˆå™¨ - åº”ç”¨å•†åº— | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fjwt-tool" target="_blank" title="https://tools.cmdragon.cn/zh/apps/jwt-tool" ref="nofollow noopener noreferrer">JSON Web Tokens å·¥å…· - åº”ç”¨å•†åº— | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fbcrypt-tool" target="_blank" title="https://tools.cmdragon.cn/zh/apps/bcrypt-tool" ref="nofollow noopener noreferrer">Bcrypt å¯†ç å·¥å…· - åº”ç”¨å•†åº— | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fgif-composer" target="_blank" title="https://tools.cmdragon.cn/zh/apps/gif-composer" ref="nofollow noopener noreferrer">GIF åˆæˆå™¨ - åº”ç”¨å•†åº— | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fgif-decomposer" target="_blank" title="https://tools.cmdragon.cn/zh/apps/gif-decomposer" ref="nofollow noopener noreferrer">GIF åˆ†è§£å™¨ - åº”ç”¨å•†åº— | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Ftext-steganography" target="_blank" title="https://tools.cmdragon.cn/zh/apps/text-steganography" ref="nofollow noopener noreferrer">æ–‡æœ¬éšå†™æœ¯ - åº”ç”¨å•†åº— | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh" target="_blank" title="https://tools.cmdragon.cn/zh" ref="nofollow noopener noreferrer">CMDragon åœ¨çº¿å·¥å…· - é«˜çº§AIå·¥å…·ç®±ä¸å¼€å‘è€…å¥—ä»¶ | å…è´¹å¥½ç”¨çš„åœ¨çº¿å·¥å…·</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%3Fcategory%3Dtrending" target="_blank" title="https://tools.cmdragon.cn/zh/apps?category=trending" ref="nofollow noopener noreferrer">åº”ç”¨å•†åº— - å‘ç°1000+æå‡æ•ˆç‡ä¸å¼€å‘çš„AIå·¥å…·å’Œå®ç”¨ç¨‹åº | å…è´¹å¥½ç”¨çš„åœ¨çº¿å·¥å…·</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fchangelog" target="_blank" title="https://tools.cmdragon.cn/zh/changelog" ref="nofollow noopener noreferrer">CMDragon æ›´æ–°æ—¥å¿— - æœ€æ–°æ›´æ–°ã€åŠŸèƒ½ä¸æ”¹è¿› | å…è´¹å¥½ç”¨çš„åœ¨çº¿å·¥å…·</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fsponsor" target="_blank" title="https://tools.cmdragon.cn/zh/sponsor" ref="nofollow noopener noreferrer">æ”¯æŒæˆ‘ä»¬ - æˆä¸ºèµåŠ©è€… | å…è´¹å¥½ç”¨çš„åœ¨çº¿å·¥å…·</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Ftext-to-image-ai" target="_blank" title="https://tools.cmdragon.cn/zh/apps/text-to-image-ai" ref="nofollow noopener noreferrer">AIæ–‡æœ¬ç”Ÿæˆå›¾åƒ - åº”ç”¨å•†åº— | å…è´¹å¥½ç”¨çš„åœ¨çº¿å·¥å…·</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Ftemp-email" target="_blank" title="https://tools.cmdragon.cn/zh/apps/temp-email" ref="nofollow noopener noreferrer">ä¸´æ—¶é‚®ç®± - åº”ç”¨å•†åº— | å…è´¹å¥½ç”¨çš„åœ¨çº¿å·¥å…·</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fqrcode-parser" target="_blank" title="https://tools.cmdragon.cn/zh/apps/qrcode-parser" ref="nofollow noopener noreferrer">äºŒç»´ç è§£æå™¨ - åº”ç”¨å•†åº— | å…è´¹å¥½ç”¨çš„åœ¨çº¿å·¥å…·</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Ftext-to-mindmap" target="_blank" title="https://tools.cmdragon.cn/zh/apps/text-to-mindmap" ref="nofollow noopener noreferrer">æ–‡æœ¬è½¬æ€ç»´å¯¼å›¾ - åº”ç”¨å•†åº— | å…è´¹å¥½ç”¨çš„åœ¨çº¿å·¥å…·</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fregex-visualizer" target="_blank" title="https://tools.cmdragon.cn/zh/apps/regex-visualizer" ref="nofollow noopener noreferrer">æ­£åˆ™è¡¨è¾¾å¼å¯è§†åŒ–å·¥å…· - åº”ç”¨å•†åº— | å…è´¹å¥½ç”¨çš„åœ¨çº¿å·¥å…·</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fsteganography-tool" target="_blank" title="https://tools.cmdragon.cn/zh/apps/steganography-tool" ref="nofollow noopener noreferrer">æ–‡ä»¶éšå†™å·¥å…· - åº”ç”¨å•†åº— | å…è´¹å¥½ç”¨çš„åœ¨çº¿å·¥å…·</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fiptv-explorer" target="_blank" title="https://tools.cmdragon.cn/zh/apps/iptv-explorer" ref="nofollow noopener noreferrer">IPTV é¢‘é“æ¢ç´¢å™¨ - åº”ç”¨å•†åº— | å…è´¹å¥½ç”¨çš„åœ¨çº¿å·¥å…·</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fsnapdrop" target="_blank" title="https://tools.cmdragon.cn/zh/apps/snapdrop" ref="nofollow noopener noreferrer">å¿«ä¼  - åº”ç”¨å•†åº— | å…è´¹å¥½ç”¨çš„åœ¨çº¿å·¥å…·</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Flucky-draw" target="_blank" title="https://tools.cmdragon.cn/zh/apps/lucky-draw" ref="nofollow noopener noreferrer">éšæœºæŠ½å¥–å·¥å…· - åº”ç”¨å•†åº— | å…è´¹å¥½ç”¨çš„åœ¨çº¿å·¥å…·</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fanime-scene-finder" target="_blank" title="https://tools.cmdragon.cn/zh/apps/anime-scene-finder" ref="nofollow noopener noreferrer">åŠ¨æ¼«åœºæ™¯æŸ¥æ‰¾å™¨ - åº”ç”¨å•†åº— | å…è´¹å¥½ç”¨çš„åœ¨çº¿å·¥å…·</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Ftime-toolkit" target="_blank" title="https://tools.cmdragon.cn/zh/apps/time-toolkit" ref="nofollow noopener noreferrer">æ—¶é—´å·¥å…·ç®± - åº”ç”¨å•†åº— | å…è´¹å¥½ç”¨çš„åœ¨çº¿å·¥å…·</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fspeed-test" target="_blank" title="https://tools.cmdragon.cn/zh/apps/speed-test" ref="nofollow noopener noreferrer">ç½‘é€Ÿæµ‹è¯• - åº”ç”¨å•†åº— | å…è´¹å¥½ç”¨çš„åœ¨çº¿å·¥å…·</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fbackground-remover" target="_blank" title="https://tools.cmdragon.cn/zh/apps/background-remover" ref="nofollow noopener noreferrer">AI æ™ºèƒ½æŠ å›¾å·¥å…· - åº”ç”¨å•†åº— | å…è´¹å¥½ç”¨çš„åœ¨çº¿å·¥å…·</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fbackground-replacer" target="_blank" title="https://tools.cmdragon.cn/zh/apps/background-replacer" ref="nofollow noopener noreferrer">èƒŒæ™¯æ›¿æ¢å·¥å…· - åº”ç”¨å•†åº— | å…è´¹å¥½ç”¨çš„åœ¨çº¿å·¥å…·</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fartistic-qrcode" target="_blank" title="https://tools.cmdragon.cn/zh/apps/artistic-qrcode" ref="nofollow noopener noreferrer">è‰ºæœ¯äºŒç»´ç ç”Ÿæˆå™¨ - åº”ç”¨å•†åº— | å…è´¹å¥½ç”¨çš„åœ¨çº¿å·¥å…·</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fopen-graph-generator" target="_blank" title="https://tools.cmdragon.cn/zh/apps/open-graph-generator" ref="nofollow noopener noreferrer">Open Graph å…ƒæ ‡ç­¾ç”Ÿæˆå™¨ - åº”ç”¨å•†åº— | å…è´¹å¥½ç”¨çš„åœ¨çº¿å·¥å…·</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fimage-comparison" target="_blank" title="https://tools.cmdragon.cn/zh/apps/image-comparison" ref="nofollow noopener noreferrer">å›¾åƒå¯¹æ¯”å·¥å…· - åº”ç”¨å•†åº— | å…è´¹å¥½ç”¨çš„åœ¨çº¿å·¥å…·</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fimage-compressor" target="_blank" title="https://tools.cmdragon.cn/zh/apps/image-compressor" ref="nofollow noopener noreferrer">å›¾ç‰‡å‹ç¼©ä¸“ä¸šç‰ˆ - åº”ç”¨å•†åº— | å…è´¹å¥½ç”¨çš„åœ¨çº¿å·¥å…·</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fpassword-generator" target="_blank" title="https://tools.cmdragon.cn/zh/apps/password-generator" ref="nofollow noopener noreferrer">å¯†ç ç”Ÿæˆå™¨ - åº”ç”¨å•†åº— | å…è´¹å¥½ç”¨çš„åœ¨çº¿å·¥å…·</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fsvg-optimizer" target="_blank" title="https://tools.cmdragon.cn/zh/apps/svg-optimizer" ref="nofollow noopener noreferrer">SVGä¼˜åŒ–å™¨ - åº”ç”¨å•†åº— | å…è´¹å¥½ç”¨çš„åœ¨çº¿å·¥å…·</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fcolor-palette" target="_blank" title="https://tools.cmdragon.cn/zh/apps/color-palette" ref="nofollow noopener noreferrer">è°ƒè‰²æ¿ç”Ÿæˆå™¨ - åº”ç”¨å•†åº— | å…è´¹å¥½ç”¨çš„åœ¨çº¿å·¥å…·</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fonline-metronome" target="_blank" title="https://tools.cmdragon.cn/zh/apps/online-metronome" ref="nofollow noopener noreferrer">åœ¨çº¿èŠ‚æ‹å™¨ - åº”ç”¨å•†åº— | å…è´¹å¥½ç”¨çš„åœ¨çº¿å·¥å…·</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fip-geolocation" target="_blank" title="https://tools.cmdragon.cn/zh/apps/ip-geolocation" ref="nofollow noopener noreferrer">IPå½’å±åœ°æŸ¥è¯¢ - åº”ç”¨å•†åº— | å…è´¹å¥½ç”¨çš„åœ¨çº¿å·¥å…·</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fcss-grid-layout" target="_blank" title="https://tools.cmdragon.cn/zh/apps/css-grid-layout" ref="nofollow noopener noreferrer">CSSç½‘æ ¼å¸ƒå±€ç”Ÿæˆå™¨ - åº”ç”¨å•†åº— | å…è´¹å¥½ç”¨çš„åœ¨çº¿å·¥å…·</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Femail-validator" target="_blank" title="https://tools.cmdragon.cn/zh/apps/email-validator" ref="nofollow noopener noreferrer">é‚®ç®±éªŒè¯å·¥å…· - åº”ç”¨å•†åº— | å…è´¹å¥½ç”¨çš„åœ¨çº¿å·¥å…·</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fcalligraphy-practice" target="_blank" title="https://tools.cmdragon.cn/zh/apps/calligraphy-practice" ref="nofollow noopener noreferrer">ä¹¦æ³•ç»ƒä¹ å­—å¸– - åº”ç”¨å•†åº— | å…è´¹å¥½ç”¨çš„åœ¨çº¿å·¥å…·</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Ffinance-calculator-suite" target="_blank" title="https://tools.cmdragon.cn/zh/apps/finance-calculator-suite" ref="nofollow noopener noreferrer">é‡‘èè®¡ç®—å™¨å¥—ä»¶ - åº”ç”¨å•†åº— | å…è´¹å¥½ç”¨çš„åœ¨çº¿å·¥å…·</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fchinese-kinship-calculator" target="_blank" title="https://tools.cmdragon.cn/zh/apps/chinese-kinship-calculator" ref="nofollow noopener noreferrer">ä¸­å›½äº²æˆšå…³ç³»è®¡ç®—å™¨ - åº”ç”¨å•†åº— | å…è´¹å¥½ç”¨çš„åœ¨çº¿å·¥å…·</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fprotobuf-toolkit" target="_blank" title="https://tools.cmdragon.cn/zh/apps/protobuf-toolkit" ref="nofollow noopener noreferrer">Protocol Buffer å·¥å…·ç®± - åº”ç”¨å•†åº— | å…è´¹å¥½ç”¨çš„åœ¨çº¿å·¥å…·</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fip-geolocation" target="_blank" title="https://tools.cmdragon.cn/zh/apps/ip-geolocation" ref="nofollow noopener noreferrer">IPå½’å±åœ°æŸ¥è¯¢ - åº”ç”¨å•†åº— | å…è´¹å¥½ç”¨çš„åœ¨çº¿å·¥å…·</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fimage-upscaler" target="_blank" title="https://tools.cmdragon.cn/zh/apps/image-upscaler" ref="nofollow noopener noreferrer">å›¾ç‰‡æ— æŸæ”¾å¤§ - åº”ç”¨å•†åº— | å…è´¹å¥½ç”¨çš„åœ¨çº¿å·¥å…·</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Ftext-compare" target="_blank" title="https://tools.cmdragon.cn/zh/apps/text-compare" ref="nofollow noopener noreferrer">æ–‡æœ¬æ¯”è¾ƒå·¥å…· - åº”ç”¨å•†åº— | å…è´¹å¥½ç”¨çš„åœ¨çº¿å·¥å…·</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fip-batch-lookup" target="_blank" title="https://tools.cmdragon.cn/zh/apps/ip-batch-lookup" ref="nofollow noopener noreferrer">IPæ‰¹é‡æŸ¥è¯¢å·¥å…· - åº”ç”¨å•†åº— | å…è´¹å¥½ç”¨çš„åœ¨çº¿å·¥å…·</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fdomain-finder" target="_blank" title="https://tools.cmdragon.cn/zh/apps/domain-finder" ref="nofollow noopener noreferrer">åŸŸåæŸ¥è¯¢å·¥å…· - åº”ç”¨å•†åº— | å…è´¹å¥½ç”¨çš„åœ¨çº¿å·¥å…·</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fdns-toolkit" target="_blank" title="https://tools.cmdragon.cn/zh/apps/dns-toolkit" ref="nofollow noopener noreferrer">DNSå·¥å…·ç®± - åº”ç”¨å•†åº— | å…è´¹å¥½ç”¨çš„åœ¨çº¿å·¥å…·</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Ffavicon-generator" target="_blank" title="https://tools.cmdragon.cn/zh/apps/favicon-generator" ref="nofollow noopener noreferrer">ç½‘ç«™å›¾æ ‡ç”Ÿæˆå™¨ - åº”ç”¨å•†åº— | å…è´¹å¥½ç”¨çš„åœ¨çº¿å·¥å…·</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fsitemap_index.xml" target="_blank" title="https://tools.cmdragon.cn/sitemap_index.xml" ref="nofollow noopener noreferrer">XML Sitemap</a></li>
</ul>
</details>
<h4 data-id="heading-3">2.2 v-elseï¼šè¡¥å……é»˜è®¤åˆ†æ”¯</h4>
<p>å¦‚æœ<code>v-if</code>çš„æ¡ä»¶ä¸æ»¡è¶³ï¼Œä½ å¯ä»¥ç”¨<code>v-else</code>æ·»åŠ ä¸€ä¸ªâ€œé»˜è®¤é€‰é¡¹â€ã€‚ä½†è¦æ³¨æ„ï¼š<br/>
<strong><code>v-else</code>å¿…é¡»ç´§è·Ÿåœ¨<code>v-if</code>æˆ–<code>v-else-if</code>çš„åé¢ï¼Œä¸­é—´ä¸èƒ½æœ‰å…¶ä»–å…„å¼Ÿå…ƒç´ </strong>ï¼ˆå¦åˆ™Vueæ— æ³•è¯†åˆ«å®ƒå±äºå“ªä¸ªæ¡ä»¶ï¼‰ã€‚</p>
<p>ä¿®æ”¹ä¸Šé¢çš„ä¾‹å­ï¼Œç”¨<code>v-else</code>ç®€åŒ–æœªç™»å½•çš„æƒ…å†µï¼š</p>
<pre><code class="hljs language-html" lang="html">
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"isLogin"</span>&gt;</span>æ¬¢è¿å›æ¥ï¼Œç”¨æˆ·ï¼<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
        <span class="hljs-comment">&lt;!-- ç›´æ¥è·Ÿåœ¨v-ifåé¢ï¼Œæ— éœ€å†™æ¡ä»¶ --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">v-else</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"isLogin = true"</span>&gt;</span>ç‚¹å‡»ç™»å½•<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
</code></pre>
<h4 data-id="heading-4">2.3 v-else-ifï¼šå¤šåˆ†æ”¯æ¡ä»¶åˆ¤æ–­</h4>
<p>å½“éœ€è¦åˆ¤æ–­<strong>å¤šä¸ªæ¡ä»¶</strong>æ—¶ï¼Œç”¨<code>v-else-if</code>è¿æ¥ã€‚å®ƒçš„è¯­æ³•æ˜¯ï¼š</p>
<pre><code class="hljs language-html" lang="html">
<span class="hljs-tag">&lt;<span class="hljs-name">å…ƒç´ </span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"æ¡ä»¶1"</span>&gt;</span>å†…å®¹1<span class="hljs-tag">&lt;/<span class="hljs-name">å…ƒç´ </span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">å…ƒç´ </span> <span class="hljs-attr">v-else-if</span>=<span class="hljs-string">"æ¡ä»¶2"</span>&gt;</span>å†…å®¹2<span class="hljs-tag">&lt;/<span class="hljs-name">å…ƒç´ </span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">å…ƒç´ </span> <span class="hljs-attr">v-else-if</span>=<span class="hljs-string">"æ¡ä»¶3"</span>&gt;</span>å†…å®¹3<span class="hljs-tag">&lt;/<span class="hljs-name">å…ƒç´ </span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">å…ƒç´ </span> <span class="hljs-attr">v-else</span>&gt;</span>é»˜è®¤å†…å®¹<span class="hljs-tag">&lt;/<span class="hljs-name">å…ƒç´ </span>&gt;</span>
</code></pre>
<p><strong>å…³é”®è§„åˆ™</strong>ï¼šVueä¼šæŒ‰<strong>æŒ‡ä»¤çš„é¡ºåºä¾æ¬¡åˆ¤æ–­</strong>ï¼Œæ»¡è¶³ç¬¬ä¸€ä¸ªæ¡ä»¶å°±åœæ­¢ï¼ˆæ‰€ä»¥æ¡ä»¶çš„é¡ºåºå¾ˆé‡è¦ï¼ï¼‰ã€‚</p>
<p>æ¯”å¦‚æ ¹æ®åˆ†æ•°æ˜¾ç¤ºç­‰çº§ï¼ˆæœ€å¸¸è§çš„å¤šåˆ†æ”¯åœºæ™¯ï¼‰ï¼š</p>
<pre><code class="hljs language-vue" lang="vue">
&lt;script setup&gt;
  import {ref} from 'vue'

  const score = ref(85) // å“åº”å¼åˆ†æ•°ï¼Œåˆå§‹85åˆ†
&lt;/script&gt;

&lt;template&gt;
  &lt;div class="score-level"&gt;
    &lt;h3&gt;ä½ çš„åˆ†æ•°ï¼š{{ score }}&lt;/h3&gt;
    &lt;!-- é¡ºåºï¼šä»é«˜åˆ°ä½ --&gt;
    &lt;p v-if="score &gt;= 90" class="excellent"&gt;ç­‰çº§ï¼šä¼˜ç§€ï¼ˆâ‰¥90ï¼‰&lt;/p&gt;
    &lt;p v-else-if="score &gt;= 80" class="good"&gt;ç­‰çº§ï¼šè‰¯å¥½ï¼ˆ80-89ï¼‰&lt;/p&gt;
    &lt;p v-else-if="score &gt;= 60" class="pass"&gt;ç­‰çº§ï¼šåŠæ ¼ï¼ˆ60-79ï¼‰&lt;/p&gt;
    &lt;p v-else class="fail"&gt;ç­‰çº§ï¼šä¸åŠæ ¼ï¼ˆ&lt;60ï¼‰&lt;/p&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;style scoped&gt;
  .excellent {
    color: #4CAF50;
  }

  .good {
    color: #2196F3;
  }

  .pass {
    color: #FFC107;
  }

  .fail {
    color: #F44336;
  }
&lt;/style&gt;
</code></pre>
<p>è¿è¡Œè¿™ä¸ªç»„ä»¶ï¼Œä¿®æ”¹<code>score</code>çš„å€¼ï¼ˆæ¯”å¦‚æ”¹æˆ<code>95</code>æˆ–<code>50</code>ï¼‰ï¼Œä¼šçœ‹åˆ°ç­‰çº§è‡ªåŠ¨åˆ‡æ¢â€”â€”è¿™å°±æ˜¯å¤šåˆ†æ”¯æ¡ä»¶æ¸²æŸ“çš„å®é™…æ•ˆæœã€‚</p>
<h3 data-id="heading-5">ä¸‰ã€æ¡ä»¶æ¸²æŸ“çš„æµç¨‹é€»è¾‘ï¼ˆé™„æµç¨‹å›¾ï¼‰</h3>
<p>ä¸ºäº†æ›´ç›´è§‚ç†è§£<code>v-if</code>ç³»åˆ—çš„æ‰§è¡Œé¡ºåºï¼Œæˆ‘ä»¬ç”»ä¸€ä¸ª<strong>åˆ¤æ–­æµç¨‹å›¾</strong>ï¼š</p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TD
    A[å¼€å§‹] --&gt; B{æ£€æŸ¥v-ifæ¡ä»¶}
    B --&gt;|æ»¡è¶³| C[æ¸²æŸ“v-ifå†…å®¹ï¼Œç»“æŸ]
    B --&gt;|ä¸æ»¡è¶³| D{æ£€æŸ¥ä¸‹ä¸€ä¸ªv-else-ifæ¡ä»¶}
    D --&gt;|æ»¡è¶³| E[æ¸²æŸ“å¯¹åº”å†…å®¹ï¼Œç»“æŸ]
    D --&gt;|ä¸æ»¡è¶³| F{è¿˜æœ‰v-else-ifå—?}
    F --&gt;|æ˜¯| D
    F --&gt;|å¦| G[æ¸²æŸ“v-elseå†…å®¹ï¼Œç»“æŸ]
</code></pre>
<p>ç®€å•æ¥è¯´ï¼š<strong>æŒ‰é¡ºåºâ€œé—¯å…³â€ï¼Œæ»¡è¶³æ¡ä»¶å°±â€œé€šå…³â€ï¼Œå¦åˆ™ç»§ç»­ï¼Œç›´åˆ°æœ€åä¸€ä¸ªv-else</strong>ã€‚</p>
<h3 data-id="heading-6">å››ã€è¯¾åQuizï¼šå·©å›ºä½ çš„ç†è§£</h3>
<h4 data-id="heading-7">Quiz 1ï¼šv-ifå’Œv-showæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ</h4>
<p><strong>é—®é¢˜</strong>ï¼šåŒæ ·æ˜¯â€œéšè—å…ƒç´ â€ï¼Œ<code>v-if</code>å’Œ<code>v-show</code>çš„æ ¸å¿ƒå·®å¼‚æ˜¯ä»€ä¹ˆï¼Ÿåˆ†åˆ«é€‚åˆä»€ä¹ˆåœºæ™¯ï¼Ÿ</p>
<p><strong>ç­”æ¡ˆè§£æ</strong>ï¼ˆå‚è€ƒVueå®˜ç½‘ï¼‰ï¼š</p>
<ul>
<li><code>v-if</code>ï¼š<strong>é”€æ¯/é‡å»ºDOM</strong>â€”â€”æ¡ä»¶ä¸æ»¡è¶³æ—¶ï¼Œå…ƒç´ ä»DOMä¸­æ¶ˆå¤±ï¼›æ¡ä»¶æ»¡è¶³æ—¶ï¼Œé‡æ–°åˆ›å»ºã€‚é€‚åˆ<strong>æ¡ä»¶å¾ˆå°‘å˜åŒ–</strong>çš„åœºæ™¯ï¼ˆæ¯”å¦‚æƒé™åˆ¤æ–­ï¼‰ï¼Œå› ä¸ºåˆå§‹æ¸²æŸ“æ›´çœæ€§èƒ½ã€‚</li>
<li><code>v-show</code>ï¼š<strong>ä¿®æ”¹CSSæ˜¾ç¤º</strong>â€”â€”æ— è®ºæ¡ä»¶å¦‚ä½•ï¼Œå…ƒç´ éƒ½ä¼šæ¸²æŸ“åˆ°DOMï¼Œåªæ˜¯ç”¨<code>display: none</code>éšè—ã€‚é€‚åˆ<strong>æ¡ä»¶é¢‘ç¹åˆ‡æ¢</strong>çš„åœºæ™¯ï¼ˆæ¯”å¦‚
tabs åˆ‡æ¢ï¼‰ï¼Œå› ä¸ºåˆ‡æ¢æ—¶æ— éœ€é”€æ¯é‡å»ºï¼Œæ›´é«˜æ•ˆã€‚</li>
</ul>
<h4 data-id="heading-8">Quiz 2ï¼šä¸ºä»€ä¹ˆv-elseå¿…é¡»ç´§è·Ÿv-ifï¼Ÿ</h4>
<p><strong>é—®é¢˜</strong>ï¼šå¦‚æœå†™<code>v-if</code>ä¹‹åéš”äº†ä¸€ä¸ª<code>div</code>å†å†™<code>v-else</code>ï¼Œä¼šæŠ¥é”™å—ï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ</p>
<p><strong>ç­”æ¡ˆè§£æ</strong>ï¼š<br/>
ä¼šæŠ¥é”™ï¼é”™è¯¯ä¿¡æ¯æ˜¯â€œv-else has no adjacent v-ifâ€ã€‚<br/>
åŸå› ï¼šVueéœ€è¦æ˜ç¡®<code>v-else</code>å¯¹åº”çš„â€œä¸Šçº§æ¡ä»¶â€â€”â€”å®ƒå¿…é¡»ä¸æœ€è¿‘çš„<code>v-if/v-else-if</code><strong>ç›´æ¥ç›¸é‚»</strong>ï¼ˆä¸­é—´ä¸èƒ½æœ‰å…¶ä»–å…„å¼Ÿå…ƒç´ ï¼‰ã€‚å¦‚æœéš”å¼€ï¼ŒVueæ— æ³•è¯†åˆ«ä¸¤è€…çš„å…³è”ã€‚</p>
<h3 data-id="heading-9">äº”ã€å¸¸è§æŠ¥é”™ä¸è§£å†³æ–¹æ¡ˆ</h3>
<p>åœ¨ä½¿ç”¨<code>v-if</code>ç³»åˆ—æ—¶ï¼Œæ–°æ‰‹å¸¸é‡åˆ°ä»¥ä¸‹é—®é¢˜ï¼Œæˆ‘ä»¬é€ä¸€è§£å†³ï¼š</p>
<h4 data-id="heading-10">1. æŠ¥é”™ï¼šâ€œv-else/v-else-if has no adjacent v-ifâ€</h4>
<ul>
<li><strong>åŸå› </strong>ï¼š<code>v-else</code>æˆ–<code>v-else-if</code>æ²¡æœ‰ç´§è·Ÿå¯¹åº”çš„<code>v-if</code>ï¼ˆä¸­é—´æœ‰å…¶ä»–å…ƒç´ ï¼‰ã€‚<br/>
æ¯”å¦‚ï¼š
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"isShow"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>æ— å…³å†…å®¹<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span> <span class="hljs-comment">&lt;!-- ä¸­é—´çš„på…ƒç´ å¯¼è‡´é”™è¯¯ --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-else</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
</li>
<li><strong>è§£å†³</strong>ï¼šåˆ é™¤ä¸­é—´çš„æ— å…³å…ƒç´ ï¼Œè®©<code>v-else</code>ç›´æ¥ç´§è·Ÿ<code>v-if</code>ã€‚</li>
<li><strong>é¢„é˜²</strong>ï¼šå†™<code>v-else</code>å‰ï¼Œå…ˆæ£€æŸ¥å‰é¢çš„å…ƒç´ æ˜¯å¦æ˜¯<code>v-if</code>æˆ–<code>v-else-if</code>ã€‚</li>
</ul>
<h4 data-id="heading-11">2. æŠ¥é”™ï¼šâ€œæ¡ä»¶å˜åŒ–æ—¶ï¼Œv-ifå†…å®¹ä¸æ›´æ–°â€</h4>
<ul>
<li><strong>åŸå› </strong>ï¼šæ¡ä»¶å˜é‡ä¸æ˜¯<strong>å“åº”å¼</strong>çš„ï¼ˆæ¯”å¦‚ç”¨<code>let isShow = false</code>è€Œä¸æ˜¯<code>ref(false)</code>ï¼‰ï¼ŒVueæ— æ³•è¿½è¸ªå…¶å˜åŒ–ã€‚</li>
<li><strong>è§£å†³</strong>ï¼šç”¨<code>ref</code>ï¼ˆåŸºæœ¬ç±»å‹ï¼‰æˆ–<code>reactive</code>ï¼ˆå¯¹è±¡/æ•°ç»„ï¼‰åŒ…è£¹æ¡ä»¶å˜é‡ï¼š
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// é”™è¯¯å†™æ³•</span>
<span class="hljs-keyword">let</span> isShow = <span class="hljs-literal">false</span> 
<span class="hljs-comment">// æ­£ç¡®å†™æ³•</span>
<span class="hljs-keyword">const</span> isShow = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>)
</code></pre>
</li>
<li><strong>é¢„é˜²</strong>ï¼šæ‰€æœ‰éœ€è¦â€œéšæ•°æ®å˜åŒ–è€Œæ›´æ–°â€çš„å˜é‡ï¼Œéƒ½ç”¨Vueçš„å“åº”å¼APIï¼ˆ<code>ref</code>/<code>reactive</code>ï¼‰å®šä¹‰ã€‚</li>
</ul>
<h4 data-id="heading-12">3. é€»è¾‘é”™è¯¯ï¼šv-else-ifé¡ºåºå¯¼è‡´æ¡ä»¶å¤±æ•ˆ</h4>
<ul>
<li><strong>ä¾‹å­</strong>ï¼šå…ˆå†™<code>v-else-if="score &gt;= 60"</code>ï¼Œå†å†™<code>v-else-if="score &gt;= 80"</code>â€”â€”æ­¤æ—¶<code>80åˆ†</code>ä¼šè¢«ç¬¬ä¸€ä¸ªæ¡ä»¶æ‹¦æˆªï¼Œæ°¸è¿œåˆ°ä¸äº†ç¬¬äºŒä¸ªã€‚</li>
<li><strong>åŸå› </strong>ï¼šVueæŒ‰æŒ‡ä»¤é¡ºåºåˆ¤æ–­ï¼Œæ»¡è¶³ç¬¬ä¸€ä¸ªæ¡ä»¶å°±åœæ­¢ã€‚</li>
<li><strong>è§£å†³</strong>ï¼šå°†<strong>æ›´ä¸¥æ ¼çš„æ¡ä»¶</strong>æ”¾åœ¨å‰é¢ï¼ˆæ¯”å¦‚å…ˆ<code>&gt;=90</code>ï¼Œå†<code>&gt;=80</code>ï¼Œæœ€å<code>&gt;=60</code>ï¼‰ã€‚</li>
</ul>
<h3 data-id="heading-13">å‚è€ƒé“¾æ¥</h3>
<p>Vueå®˜ç½‘æ¡ä»¶æ¸²æŸ“æ–‡æ¡£ï¼š<a href="https://link.juejin.cn?target=https%3A%2F%2Fvuejs.org%2Fguide%2Fessentials%2Fconditional.html" target="_blank" title="https://vuejs.org/guide/essentials/conditional.html" ref="nofollow noopener noreferrer">vuejs.org/guide/essenâ€¦</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2025-12-20 vue3ä¸­ eslint9+å’Œprettieré…ç½®]]></title>    <link>https://juejin.cn/post/7585468725332197430</link>    <guid>https://juejin.cn/post/7585468725332197430</guid>    <pubDate>2025-12-20T08:19:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585468725332197430" data-draft-id="7585474459776090148" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="2025-12-20    vue3ä¸­ eslint9+å’Œprettieré…ç½®"/> <meta itemprop="keywords" content="å‰ç«¯"/> <meta itemprop="datePublished" content="2025-12-20T08:19:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Mr_Swilder"/> <meta itemprop="url" content="https://juejin.cn/user/3927901716878829"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="æ˜é‡‘"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            2025-12-20    vue3ä¸­ eslint9+å’Œprettieré…ç½®
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3927901716878829/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Mr_Swilder
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T08:19:05.000Z" title="Sat Dec 20 2025 08:19:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    é˜…è¯»1åˆ†é’Ÿ
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"ã€Œ"}.markdown-body strong:after{content:"ã€"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"â";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"â";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><blockquote>
<p>eslint 9+ç›¸è¾ƒ8ç‰ˆæœ¬ä½¿ç”¨<code>eslint.config.js</code>å’Œæ‰å¹³åŒ–é…ç½®æ–¹å¼ã€‚</p>
</blockquote>
<h3 data-id="heading-0">1.åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹å®‰è£…æ‰€éœ€çš„å¼€å‘ä¾èµ–åŒ…</h3>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">æ ¸å¿ƒä»£ç æ£€æŸ¥ä¸æ ¼å¼åŒ–å·¥å…·</span>
pnpm add -D eslint prettier
<span class="hljs-meta prompt_">
# </span><span class="bash">Vue.js è¯­æ³•æ”¯æŒ</span>
pnpm add -D eslint-plugin-vue
<span class="hljs-meta prompt_">
# </span><span class="bash">Prettier ä¸ ESLint é›†æˆ</span>
pnpm add -D eslint-config-prettier eslint-plugin-prettier
</code></pre>
<h3 data-id="heading-1">ğŸ’… 2. <code>prettier</code>é…ç½®</h3>
<p>åœ¨<code>vscode</code>ä¸­å®‰è£…æ’ä»¶</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a1742bb6496d4f07b32be2c2963d0580~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTXJfU3dpbGRlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823740&amp;x-signature=%2B2%2BlEqI6zH04b3JliMIuAzgjdfY%3D" alt="image.png" loading="lazy"/></p>
<p>æ ¹ç›®å½•ä¸‹æ–°å»ºé…ç½®æ–‡ä»¶ <code>.prettierrc</code></p>
<pre><code class="hljs language-js" lang="js">{
  <span class="hljs-string">"semi"</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-string">"singleQuote"</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-string">"tabWidth"</span>: <span class="hljs-number">2</span>,
  <span class="hljs-string">"trailingComma"</span>: <span class="hljs-string">"es5"</span>,
  <span class="hljs-string">"printWidth"</span>: <span class="hljs-number">100</span>,
  <span class="hljs-string">"arrowParens"</span>: <span class="hljs-string">"avoid"</span>,
  <span class="hljs-string">"htmlWhitespaceSensitivity"</span>: <span class="hljs-string">"ignore"</span>
}
</code></pre>
<h3 data-id="heading-2">3.<code>eslint</code>é…ç½®å¹¶å°†<code>prettier</code>è§„åˆ™ä½œä¸º<code>eslint</code>ä¸€éƒ¨åˆ†ï¼Œå¯¹ä¸ç¬¦åˆè¦æ±‚çš„æŠ¥é”™</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// eslint.config.js</span>
<span class="hljs-keyword">import</span> eslintPluginVue <span class="hljs-keyword">from</span> <span class="hljs-string">'eslint-plugin-vue'</span>
<span class="hljs-keyword">import</span> vueEslintParser <span class="hljs-keyword">from</span> <span class="hljs-string">'vue-eslint-parser'</span>
<span class="hljs-keyword">import</span> eslintPluginPrettierRecommended <span class="hljs-keyword">from</span> <span class="hljs-string">'eslint-plugin-prettier/recommended'</span>
<span class="hljs-comment">// console.log(eslintPluginPrettierRecommended)</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> [
  <span class="hljs-comment">// å…¨å±€é…ç½®ï¼šæŒ‡å®šç¯å¢ƒã€è§£æå™¨é€‰é¡¹</span>
  {
    <span class="hljs-attr">files</span>: [<span class="hljs-string">'**/*.js'</span>, <span class="hljs-string">'**/*.vue'</span>],
    <span class="hljs-attr">ignores</span>: [<span class="hljs-string">'vite.config.js'</span>, <span class="hljs-string">'node_modules/'</span>, <span class="hljs-string">'dist/'</span>, <span class="hljs-string">'public/'</span>],
    <span class="hljs-attr">languageOptions</span>: {
      <span class="hljs-attr">ecmaVersion</span>: <span class="hljs-string">'latest'</span>,
      <span class="hljs-attr">sourceType</span>: <span class="hljs-string">'module'</span>,
      <span class="hljs-attr">globals</span>: {
        <span class="hljs-attr">browser</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// æµè§ˆå™¨ç¯å¢ƒå…¨å±€å˜é‡</span>
        <span class="hljs-attr">node</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// Node.js ç¯å¢ƒå…¨å±€å˜é‡</span>
        <span class="hljs-attr">es2021</span>: <span class="hljs-literal">true</span> <span class="hljs-comment">// ES2021 è¯­æ³•æ”¯æŒ</span>
      }
    },
    <span class="hljs-attr">rules</span>: {
      <span class="hljs-string">'no-console'</span>: <span class="hljs-string">'warn'</span>,
      <span class="hljs-string">'no-debugger'</span>: <span class="hljs-string">'error'</span>,
      <span class="hljs-string">'no-unused-vars'</span>: [<span class="hljs-string">'warn'</span>, { <span class="hljs-attr">varsIgnorePattern</span>: <span class="hljs-string">'^_'</span> }]
    }
  },

  <span class="hljs-comment">// Vue å•æ–‡ä»¶ç»„ä»¶ä¸“å±é…ç½®</span>
  {
    <span class="hljs-attr">files</span>: [<span class="hljs-string">'**/*.vue'</span>],
    <span class="hljs-comment">// ä½¿ç”¨ vue-eslint-parser è§£æ .vue æ–‡ä»¶</span>
    <span class="hljs-attr">languageOptions</span>: {
      <span class="hljs-attr">parser</span>: vueEslintParser,
      <span class="hljs-attr">parserOptions</span>: {
        <span class="hljs-attr">parser</span>: <span class="hljs-string">'espree'</span>, <span class="hljs-comment">// è§£æ &lt;script&gt; å—å†…çš„ JavaScript</span>
        <span class="hljs-attr">ecmaVersion</span>: <span class="hljs-string">'latest'</span>,
        <span class="hljs-attr">sourceType</span>: <span class="hljs-string">'module'</span>
      }
    },
    <span class="hljs-attr">plugins</span>: {
      <span class="hljs-attr">vue</span>: eslintPluginVue
    },
    <span class="hljs-attr">rules</span>: {
      <span class="hljs-comment">// å¯ç”¨ Vue å®˜æ–¹æ¨èè§„åˆ™</span>
      ...eslintPluginVue.<span class="hljs-property">configs</span>[<span class="hljs-string">'flat/recommended'</span>].<span class="hljs-property">rules</span>,
      <span class="hljs-comment">// è‡ªå®šä¹‰ Vue è§„åˆ™</span>
      <span class="hljs-string">'vue/multi-word-component-names'</span>: <span class="hljs-string">'off'</span> <span class="hljs-comment">// å…³é—­ç»„ä»¶åå¿…é¡»å¤šå•è¯çš„è¦æ±‚</span>
    }
  },
  <span class="hljs-comment">//prettieré…ç½®</span>
  eslintPluginPrettierRecommended
]
</code></pre>
<p>æ­¤æ—¶è¿è¡Œ</p>
<pre><code class="hljs language-shell" lang="shell">npm run lint
</code></pre>
<p>å¯ä»¥å¯¹ä¸ç¬¦åˆè§„åˆ™çš„ä»£ç æ£€æŸ¥ï¼ŒåŒ…å«ä¸ç¬¦åˆ<code>eslint</code>è§„åˆ™çš„</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/03c23319426b4f6d86115eea28bbe3b3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTXJfU3dpbGRlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823740&amp;x-signature=5ietbj%2FFYai2fzTxhmmDQi%2Bv82I%3D" alt="image.png" loading="lazy"/></p>
<p>4.é…ç½®vscodeæ’ä»¶<code>eslint</code>å’Œ<code>Prettier ESlint</code>ï¼Œè®¾ç½®é»˜è®¤æ ¼å¼åŒ–å·¥å…·ä¸º<code>Prettier ESlint</code>ï¼Œè®©<code>eslint</code>ç›´æ¥æŠ¥é”™<code>prettier</code>ä¸­çš„é…ç½®ï¼Œæœ‰æ—¶ä¿®æ”¹äº†<code>.prettierrc</code>ä¸­çš„é…ç½®éœ€è¦é‡å¯<code>Prettier ESlint</code>æ’ä»¶æ‰èƒ½ç”Ÿæ•ˆã€‚</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5991155e944d43e8a514563f1cf7d674~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTXJfU3dpbGRlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823740&amp;x-signature=WlILNcFyOppEaY4XsUO1tfyjRZM%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ca06d152bbfe4152be64ba9accbe17ef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTXJfU3dpbGRlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823740&amp;x-signature=H4K5RzLd9rlKbrhHdippKxV6dfM%3D" alt="image.png" loading="lazy"/></p>
<blockquote>
<p>å¯¹äº<code>.eslintignore</code>æ–‡ä»¶ç¼ºå¤±æ—¶<code>eslint</code>ä¼šä½¿ç”¨<code>.gitignore</code>æ–‡ä»¶</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[XMLHttpRequestã€AJAXã€Fetch ä¸ Axios]]></title>    <link>https://juejin.cn/post/7585463195201355826</link>    <guid>https://juejin.cn/post/7585463195201355826</guid>    <pubDate>2025-12-20T08:20:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585463195201355826" data-draft-id="7585686247269482505" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="XMLHttpRequestã€AJAXã€Fetch ä¸ Axios"/> <meta itemprop="keywords" content="å‰ç«¯"/> <meta itemprop="datePublished" content="2025-12-20T08:20:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ç”¨æˆ·5427784851540"/> <meta itemprop="url" content="https://juejin.cn/user/224762173330942"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="æ˜é‡‘"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            XMLHttpRequestã€AJAXã€Fetch ä¸ Axios
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/224762173330942/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ç”¨æˆ·5427784851540
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T08:20:09.000Z" title="Sat Dec 20 2025 08:20:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    é˜…è¯»7åˆ†é’Ÿ
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>åœ¨ç°ä»£ Web å¼€å‘ä¸­ï¼Œå‰ç«¯ä¸åç«¯çš„æ•°æ®äº¤äº’æ˜¯æ„å»ºåŠ¨æ€åº”ç”¨çš„æ ¸å¿ƒã€‚å›´ç»•è¿™ä¸€éœ€æ±‚ï¼Œè¯ç”Ÿäº†å¤šä¸ªå…³é”®æŠ€æœ¯ä¸å·¥å…·ï¼š<strong>XMLHttpRequestï¼ˆXHRï¼‰</strong> ã€<strong>AJAX</strong>ã€<strong>Axios</strong> å’Œ <strong>Fetch API</strong>ã€‚å®ƒä»¬ä¹‹é—´æ—¢æœ‰å†å²æ¼”è¿›å…³ç³»ï¼Œä¹Ÿæœ‰åŠŸèƒ½é‡å ä¸äº’è¡¥ã€‚æœ¬æ–‡å°†ç³»ç»Ÿæ¢³ç†å››è€…çš„å…³ç³»ï¼Œæ·±å…¥å‰–æ XHR çš„å·¥ä½œæœºåˆ¶ä¸ Fetch çš„åº•å±‚åŸç†ï¼Œå¹¶ç»“åˆ Vue 3 å¼€å‘å®è·µï¼Œæä¾›ä¸€å¥—å®Œæ•´çš„å‰ç«¯ç½‘ç»œé€šä¿¡çŸ¥è¯†ä½“ç³»ã€‚</p>
<hr/>
<h2 data-id="heading-0">ä¸€ã€æ ¸å¿ƒæ¦‚å¿µä¸å±‚çº§å…³ç³»</h2>
<h3 data-id="heading-1">1.1 AJAXï¼šä¸€ç§ç¼–ç¨‹èŒƒå¼ï¼ˆä¸æ˜¯æŠ€æœ¯ï¼‰</h3>
<ul>
<li><strong>å…¨ç§°</strong>ï¼šAsynchronous JavaScript and XML</li>
<li><strong>æœ¬è´¨</strong>ï¼š<strong>ä¸€ç§å¼€å‘æ¨¡å¼</strong>ï¼ŒæŒ‡åœ¨ä¸åˆ·æ–°é¡µé¢çš„æƒ…å†µä¸‹ï¼Œé€šè¿‡ JavaScript å¼‚æ­¥ä¸æœåŠ¡å™¨äº¤æ¢æ•°æ®å¹¶æ›´æ–°éƒ¨åˆ†ç½‘é¡µå†…å®¹ã€‚</li>
<li><strong>æ ¸å¿ƒæ€æƒ³</strong>ï¼šè§£è€¦ UI æ›´æ–°ä¸æ•°æ®è·å–ï¼Œæå‡ç”¨æˆ·ä½“éªŒã€‚</li>
</ul>
<blockquote>
<p>âœ… <strong>å…³é”®ç‚¹</strong>ï¼š<br/>
AJAX ä¸æ˜¯æŸä¸ªå…·ä½“ APIï¼Œè€Œæ˜¯ä¸€ç§<strong>ä½¿ç”¨ç°æœ‰æŠ€æœ¯å®ç°å¼‚æ­¥é€šä¿¡çš„ç­–ç•¥</strong>ã€‚<br/>
å®ç° AJAX çš„æ ¸å¿ƒæŠ€æœ¯å°±æ˜¯ <code>XMLHttpRequest</code>ã€‚</p>
</blockquote>
<h3 data-id="heading-2">1.2 XMLHttpRequestï¼ˆXHRï¼‰ï¼šæµè§ˆå™¨åŸç”Ÿ API</h3>
<ul>
<li>
<p><strong>è§’è‰²</strong>ï¼š<strong>å®ç° AJAX çš„åº•å±‚å·¥å…·</strong></p>
</li>
<li>
<p><strong>åŠŸèƒ½</strong>ï¼šæä¾›æµè§ˆå™¨ä¸æœåŠ¡å™¨è¿›è¡Œ HTTP é€šä¿¡çš„èƒ½åŠ›</p>
</li>
<li>
<p><strong>ç‰¹ç‚¹</strong>ï¼š</p>
<ul>
<li>åŸºäºå›è°ƒï¼ˆäº‹ä»¶é©±åŠ¨ï¼‰</li>
<li>æ”¯æŒè¿›åº¦ç›‘æ§ã€å–æ¶ˆè¯·æ±‚ã€ä¸Šä¼ /ä¸‹è½½</li>
<li>å…¼å®¹æ€§æå¥½ï¼ˆIE7+ï¼‰</li>
</ul>
</li>
</ul>
<blockquote>
<p>ğŸ“Œ <strong>å…³ç³»</strong>ï¼š<br/>
<strong>XHR æ˜¯ AJAX çš„â€œå¼•æ“â€</strong> ã€‚æ²¡æœ‰ XHRï¼Œå°±æ²¡æœ‰ç°ä»£æ„ä¹‰ä¸Šçš„ AJAXã€‚</p>
</blockquote>
<h3 data-id="heading-3">1.3 Axiosï¼šåŸºäº Promise çš„ HTTP å®¢æˆ·ç«¯åº“</h3>
<ul>
<li>
<p><strong>å®šä½</strong>ï¼š<strong>å¯¹ XHR çš„å°è£…ä¸å¢å¼º</strong></p>
</li>
<li>
<p><strong>æ ¸å¿ƒç‰¹æ€§</strong>ï¼š</p>
<ul>
<li>è¿”å› Promiseï¼Œæ”¯æŒ async/await</li>
<li>è‡ªåŠ¨è½¬æ¢ JSON æ•°æ®</li>
<li>æ‹¦æˆªå™¨ï¼ˆè¯·æ±‚/å“åº”ï¼‰</li>
<li>å®¢æˆ·ç«¯æ”¯æŒ XSRF é˜²æŠ¤</li>
<li>æµè§ˆå™¨ + Node.js åŒç«¯æ”¯æŒ</li>
</ul>
</li>
<li>
<p><strong>åº•å±‚å®ç°</strong>ï¼šåœ¨æµè§ˆå™¨ä¸­<strong>é»˜è®¤ä½¿ç”¨ XHR</strong>ï¼Œåœ¨ Node.js ä¸­ä½¿ç”¨ <code>http</code> æ¨¡å—</p>
</li>
</ul>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// Axios å†…éƒ¨ç®€åŒ–é€»è¾‘</span>
function <span class="hljs-built_in">axios</span>(config) {
  return new <span class="hljs-built_in">Promise</span>((resolve, reject) =&gt; {
    const xhr = new <span class="hljs-built_in">XMLHttpRequest</span>();
    xhr<span class="hljs-selector-class">.open</span>(config.method, config.url);
    xhr<span class="hljs-selector-class">.send</span>(config.data);
    xhr<span class="hljs-selector-class">.onload</span> = () =&gt; <span class="hljs-built_in">resolve</span>(xhr.response);
    xhr<span class="hljs-selector-class">.onerror</span> = () =&gt; <span class="hljs-built_in">reject</span>(xhr.statusText);
  });
}
</code></pre>
<blockquote>
<p>âœ… <strong>å…³ç³»</strong>ï¼š<br/>
<strong>Axios æ˜¯ XHR çš„ç°ä»£åŒ–å°è£…</strong>ï¼Œè®©å¼€å‘è€…ç”¨æ›´ç®€æ´çš„è¯­æ³•äº«å— XHR çš„å…¨éƒ¨èƒ½åŠ›ã€‚</p>
</blockquote>
<h3 data-id="heading-4">1.4 Fetch APIï¼šæµè§ˆå™¨æ–°ä¸€ä»£åŸç”Ÿ API</h3>
<ul>
<li>
<p><strong>å®šä½</strong>ï¼š<strong>XHR çš„å®˜æ–¹ç»§ä»»è€…</strong></p>
</li>
<li>
<p><strong>è®¾è®¡ç›®æ ‡</strong>ï¼š</p>
<ul>
<li>åŸºäº Promiseï¼Œç¬¦åˆç°ä»£ JS ç¼–ç¨‹ä¹ æƒ¯</li>
<li>æ›´ç®€æ´çš„ API è®¾è®¡</li>
<li>æ›´å¥½çš„æµï¼ˆStreamï¼‰æ”¯æŒ</li>
<li>ç»Ÿä¸€è¯·æ±‚/å“åº”æ¨¡å‹ï¼ˆRequest/Response å¯¹è±¡ï¼‰</li>
</ul>
</li>
<li>
<p><strong>åº•å±‚å®ç°</strong>ï¼š<strong>å¹¶éåŸºäº XHR</strong>ï¼Œè€Œæ˜¯ç›´æ¥è°ƒç”¨æµè§ˆå™¨çš„ç½‘ç»œå±‚ï¼ˆå¦‚ Chromium çš„ <code>blink::WebURLLoader</code>ï¼‰</p>
</li>
</ul>
<blockquote>
<p>âš ï¸ <strong>é‡è¦åŒºåˆ«</strong>ï¼š<br/>
Fetch <strong>ä¸æ˜¯ XHR çš„å°è£…</strong>ï¼Œè€Œæ˜¯<strong>å…¨æ–°çš„åº•å±‚å®ç°</strong>ã€‚</p>
</blockquote>
<hr/>
<h2 data-id="heading-5">äºŒã€å››è€…å…³ç³»å›¾è°±</h2>
<pre><code class="hljs language-scss" lang="scss">                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â”‚    AJAX      â”‚ â†â”€â”€ ç¼–ç¨‹èŒƒå¼ï¼ˆå¼‚æ­¥é€šä¿¡æ€æƒ³ï¼‰
                          â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                       â”‚                       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ XMLHttpRequest  â”‚   â”‚       Fetch API     â”‚   â”‚      Axios      â”‚
â”‚ (åŸç”Ÿ, å›è°ƒå¼)   â”‚   â”‚ (åŸç”Ÿ, Promiseå¼)   â”‚   â”‚ (ç¬¬ä¸‰æ–¹åº“, Promise)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                                               â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚   ç°ä»£ Web åº”ç”¨æ•°æ®é€šä¿¡    â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre>
<blockquote>
<p>ğŸ”‘ <strong>æ€»ç»“å…³ç³»</strong>ï¼š</p>
<ul>
<li><strong>AJAX</strong> æ˜¯æ€æƒ³ï¼Œ<strong>XHR/Fetch</strong> æ˜¯å®ç°è¯¥æ€æƒ³çš„åŸç”Ÿå·¥å…·</li>
<li><strong>Axios</strong> æ˜¯å¯¹ XHRï¼ˆæµè§ˆå™¨ç«¯ï¼‰çš„é«˜çº§å°è£…</li>
<li><strong>Fetch</strong> æ˜¯æµè§ˆå™¨æä¾›çš„ã€ä¸ XHR å¹¶åˆ—çš„æ–°ä¸€ä»£åŸç”Ÿ API</li>
</ul>
</blockquote>
<hr/>
<h2 data-id="heading-6">ä¸‰ã€XMLHttpRequest è¯¦è§£</h2>
<h3 data-id="heading-7">3.1 åŸºæœ¬ä½¿ç”¨æµç¨‹</h3>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">xhr</span> = new XMLHttpRequest()<span class="hljs-comment">;</span>
xhr.open('GET', '/api/users', true)<span class="hljs-comment">;</span>
xhr.setRequestHeader('Content-Type', 'application/json')<span class="hljs-comment">;</span>
<span class="hljs-attr">xhr.onreadystatechange</span> = function() {
  if (<span class="hljs-attr">xhr.readyState</span> === <span class="hljs-number">4</span> &amp;&amp; xhr.status === <span class="hljs-number">200</span>) {
    console.log(xhr.responseText)<span class="hljs-comment">;</span>
  }
}<span class="hljs-comment">;</span>
xhr.send()<span class="hljs-comment">;</span>
</code></pre>
<h3 data-id="heading-8">3.2 æ ¸å¿ƒå±æ€§</h3>





























<table><thead><tr><th>å±æ€§</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>readyState</code></td><td>è¯·æ±‚çŠ¶æ€ï¼ˆ0â€“4ï¼‰</td></tr><tr><td><code>status</code> / <code>statusText</code></td><td>HTTP çŠ¶æ€ç ä¸æè¿°</td></tr><tr><td><code>responseText</code></td><td>å­—ç¬¦ä¸²å“åº”ä½“</td></tr><tr><td><code>response</code></td><td>æ ¹æ® <code>responseType</code> è§£æåçš„æ•°æ®</td></tr><tr><td><code>responseType</code></td><td>å“åº”ç±»å‹ï¼ˆ<code>json</code>ã€<code>blob</code>ã€<code>arraybuffer</code> ç­‰ï¼‰</td></tr></tbody></table>
<h3 data-id="heading-9">3.3 äº‹ä»¶æ¨¡å‹</h3>
<ul>
<li>
<p><strong>ä¼ ç»Ÿæ–¹å¼</strong>ï¼š<code>onreadystatechange</code>ï¼ˆéœ€æ‰‹åŠ¨åˆ¤æ–­ <code>readyState</code>ï¼‰</p>
</li>
<li>
<p><strong>ç°ä»£æ–¹å¼</strong>ï¼ˆæ¨èï¼‰ï¼š</p>
<ul>
<li><code>onload</code>ï¼šè¯·æ±‚å®Œæˆ</li>
<li><code>onerror</code>ï¼šç½‘ç»œé”™è¯¯</li>
<li><code>ontimeout</code>ï¼šè¶…æ—¶</li>
<li><code>onabort</code>ï¼šè¢«ä¸­æ­¢</li>
</ul>
</li>
</ul>
<h3 data-id="heading-10">3.4 é«˜çº§åŠŸèƒ½</h3>
<ul>
<li><strong>è¶…æ—¶æ§åˆ¶</strong>ï¼š<code>xhr.timeout = 5000</code></li>
<li><strong>è·¨åŸŸå‡­æ®</strong>ï¼š<code>xhr.withCredentials = true</code></li>
<li><strong>ä¸Šä¼ è¿›åº¦</strong>ï¼š<code>xhr.upload.onprogress</code></li>
<li><strong>ä¸­æ­¢è¯·æ±‚</strong>ï¼š<code>xhr.abort()</code></li>
</ul>
<h3 data-id="heading-11">3.5 å®é™…åº”ç”¨åœºæ™¯</h3>
<h4 data-id="heading-12">æ–‡ä»¶ä¸Šä¼ ï¼ˆå¸¦è¿›åº¦ï¼‰</h4>
<pre><code class="hljs language-ini" lang="ini">function uploadFile(file) {
  const <span class="hljs-attr">formData</span> = new FormData()<span class="hljs-comment">;</span>
  formData.append('file', file)<span class="hljs-comment">;</span>
  
  const <span class="hljs-attr">xhr</span> = new XMLHttpRequest()<span class="hljs-comment">;</span>
  xhr.open('POST', '/upload')<span class="hljs-comment">;</span>
  
  <span class="hljs-attr">xhr.upload.onprogress</span> = (e) =&gt; {
    if (e.lengthComputable) {
      const <span class="hljs-attr">percent</span> = (e.loaded / e.total) * <span class="hljs-number">100</span><span class="hljs-comment">;</span>
      updateProgress(percent)<span class="hljs-comment">;</span>
    }
  }<span class="hljs-comment">;</span>
  
  <span class="hljs-attr">xhr.onload</span> = () =&gt; {
    if (<span class="hljs-attr">xhr.status</span> === <span class="hljs-number">200</span>) showSuccess()<span class="hljs-comment">;</span>
  }<span class="hljs-comment">;</span>
  
  xhr.send(formData)<span class="hljs-comment">;</span>
}
</code></pre>
<hr/>
<h2 data-id="heading-13">å››ã€Fetch API åŸç†æ·±åº¦è§£æ</h2>
<h3 data-id="heading-14">4.1 æ ¸å¿ƒè®¾è®¡ï¼šåŸºäº Stream çš„è¯·æ±‚/å“åº”æ¨¡å‹</h3>
<p>Fetch çš„æ ¸å¿ƒæ˜¯ä¸¤ä¸ªæ„é€ å‡½æ•°ï¼š</p>
<ul>
<li><code>Request</code>ï¼šè¡¨ç¤º HTTP è¯·æ±‚</li>
<li><code>Response</code>ï¼šè¡¨ç¤º HTTP å“åº”</li>
</ul>
<p>ä¸¤è€…éƒ½å®ç°äº† <strong>Body mixin</strong>ï¼ŒåŒ…å«å¯è¯»æµï¼ˆReadableStreamï¼‰ï¼š</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/data'</span>)
  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(response.<span class="hljs-property">body</span> <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">ReadableStream</span>); <span class="hljs-comment">// true</span>
    <span class="hljs-keyword">return</span> response.<span class="hljs-title function_">json</span>(); <span class="hljs-comment">// å†…éƒ¨è¯»å– body æµå¹¶è§£æ</span>
  });
</code></pre>
<blockquote>
<p>ğŸ’¡ <strong>å…³é”®æœºåˆ¶</strong>ï¼š<br/>
Fetch å°†å“åº”ä½“è§†ä¸º<strong>æµï¼ˆStreamï¼‰</strong> ï¼Œæ”¯æŒè¾¹ä¸‹è½½è¾¹å¤„ç†ï¼Œé€‚åˆå¤§æ–‡ä»¶æˆ–å®æ—¶æ•°æ®ã€‚</p>
</blockquote>
<h3 data-id="heading-15">4.2 æ‰§è¡Œæµç¨‹ï¼ˆæµè§ˆå™¨å†…éƒ¨ï¼‰</h3>
<p>ä»¥ Chromium ä¸ºä¾‹ï¼š</p>
<ol>
<li>è°ƒç”¨ <code>fetch(url)</code> â†’ åˆ›å»º <code>Request</code> å¯¹è±¡</li>
<li>æµè§ˆå™¨ä¸»çº¿ç¨‹ â†’ ç½‘ç»œæœåŠ¡çº¿ç¨‹ï¼ˆNetwork Serviceï¼‰</li>
<li>ç½‘ç»œçº¿ç¨‹å‘èµ· HTTP è¯·æ±‚ï¼ˆå¤ç”¨è¿æ¥æ± ã€DNS ç¼“å­˜ç­‰ï¼‰</li>
<li>æ”¶åˆ°å“åº”å¤´ â†’ ç«‹å³ resolve Promiseï¼ˆè¿”å› <code>Response</code> å¯¹è±¡ï¼‰</li>
<li>å“åº”ä½“é€šè¿‡ <strong>ReadableStream</strong> é€æ­¥ä¼ è¾“åˆ° JS ä¸»çº¿ç¨‹</li>
<li>è°ƒç”¨ <code>.json()</code> / <code>.text()</code> ç­‰æ–¹æ³• â†’ æ¶ˆè´¹æµå¹¶è§£æ</li>
</ol>
<h3 data-id="heading-16">4.3 ä¸ XHR çš„å…³é”®å·®å¼‚</h3>



































<table><thead><tr><th>ç‰¹æ€§</th><th>XHR</th><th>Fetch</th></tr></thead><tbody><tr><td><strong>é”™è¯¯å¤„ç†</strong></td><td>ç½‘ç»œé”™è¯¯ â†’ <code>onerror</code>ï¼›HTTP é”™è¯¯ï¼ˆ404/500ï¼‰â†’ <code>onload</code></td><td><strong>ä»…ç½‘ç»œé”™è¯¯ reject</strong>ï¼›HTTP é”™è¯¯ä» resolveï¼ˆéœ€æ‰‹åŠ¨æ£€æŸ¥ <code>response.ok</code>ï¼‰</td></tr><tr><td><strong>Cookie å‘é€</strong></td><td>åŒåŸŸè‡ªåŠ¨å‘é€</td><td>éœ€æ˜¾å¼è®¾ç½® <code>credentials: 'same-origin'</code></td></tr><tr><td><strong>å–æ¶ˆè¯·æ±‚</strong></td><td><code>xhr.abort()</code></td><td><code>AbortController</code></td></tr><tr><td><strong>ä¸Šä¼ è¿›åº¦</strong></td><td>åŸç”Ÿ <code>upload.onprogress</code></td><td><strong>ä¸æ”¯æŒ</strong>ï¼ˆéœ€è‡ªå®šä¹‰ <code>ReadableStream</code>ï¼Œå¤æ‚ï¼‰</td></tr><tr><td><strong>è¶…æ—¶æ§åˆ¶</strong></td><td><code>xhr.timeout</code></td><td>éœ€é…åˆ <code>AbortController</code> + <code>setTimeout</code></td></tr></tbody></table>
<h4 data-id="heading-17">é”™è¯¯å¤„ç†å¯¹æ¯”ç¤ºä¾‹ï¼š</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Fetchï¼šHTTP 404 ä» resolve</span>
<span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/not-found'</span>)
  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> {
    <span class="hljs-keyword">if</span> (!res.<span class="hljs-property">ok</span>) { <span class="hljs-comment">// å¿…é¡»æ‰‹åŠ¨æ£€æŸ¥</span>
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`HTTP <span class="hljs-subst">${res.status}</span>`</span>);
    }
  })
  .<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> {
    <span class="hljs-comment">// åªæœ‰ç½‘ç»œæ–­å¼€æ‰ä¼šè¿›å…¥è¿™é‡Œ</span>
  });
</code></pre>
<h3 data-id="heading-18">4.4 Fetch çš„å±€é™æ€§ä¸è§£å†³æ–¹æ¡ˆ</h3>
<h4 data-id="heading-19">é—®é¢˜ 1ï¼šæ— æ³•ç›‘æ§ä¸‹è½½è¿›åº¦</h4>
<p><strong>è§£å†³æ–¹æ¡ˆ</strong>ï¼šæ‰‹åŠ¨è¯»å–æµå¹¶è®¡ç®—è¿›åº¦ï¼š</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">response</span> = await fetch(<span class="hljs-string">'/large-file'</span>)<span class="hljs-comment">;</span>
const <span class="hljs-attr">contentLength</span> = +response.headers.get(<span class="hljs-string">'Content-Length'</span>)<span class="hljs-comment">;</span>
let <span class="hljs-attr">loaded</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>

const <span class="hljs-attr">reader</span> = response.body.getReader()<span class="hljs-comment">;</span>
while (true) {
  const { done, value } = await reader.read()<span class="hljs-comment">;</span>
  if (done) break<span class="hljs-comment">;</span>
  loaded += value.length<span class="hljs-comment">;</span>
  const <span class="hljs-attr">progress</span> = (loaded / contentLength) * <span class="hljs-number">100</span><span class="hljs-comment">;</span>
  updateProgress(progress)<span class="hljs-comment">;</span>
}
</code></pre>
<h4 data-id="heading-20">é—®é¢˜ 2ï¼šæ— å†…ç½®è¶…æ—¶</h4>
<p><strong>è§£å†³æ–¹æ¡ˆ</strong>ï¼šç»“åˆ <code>AbortController</code>ï¼š</p>
<pre><code class="hljs language-scss" lang="scss">const controller = new <span class="hljs-built_in">AbortController</span>();
const timeoutId = <span class="hljs-built_in">setTimeout</span>(() =&gt; controller<span class="hljs-selector-class">.abort</span>(), <span class="hljs-number">5000</span>);

<span class="hljs-built_in">fetch</span>('/api/data', { signal: controller.signal })
  <span class="hljs-selector-class">.finally</span>(() =&gt; <span class="hljs-built_in">clearTimeout</span>(timeoutId));
</code></pre>
<hr/>
<h2 data-id="heading-21">äº”ã€Vue 3 ä¸­çš„ç½‘ç»œé€šä¿¡å®è·µ</h2>
<p>è™½ç„¶ Vue æœ¬èº«ä¸å¼ºåˆ¶ä½¿ç”¨ç‰¹å®š HTTP å®¢æˆ·ç«¯ï¼Œä½†å…¶ç»„åˆå¼ API ä¸ç°ä»£è¯·æ±‚åº“å¤©ç„¶å¥‘åˆã€‚</p>
<h3 data-id="heading-22">5.1 ä½¿ç”¨ Axiosï¼ˆæ¨èç”¨äºå¤æ‚é¡¹ç›®ï¼‰</h3>
<pre><code class="hljs language-ini" lang="ini">// composables/useApi.js
import axios from 'axios'<span class="hljs-comment">;</span>

const <span class="hljs-attr">api</span> = axios.create({
  baseURL: '/api',
  timeout: 10000,
  withCredentials: true
})<span class="hljs-comment">;</span>

// è¯·æ±‚æ‹¦æˆªå™¨
api.interceptors.request.use(<span class="hljs-attr">config</span> =&gt; {
  const <span class="hljs-attr">token</span> = localStorage.getItem(<span class="hljs-string">'token'</span>)<span class="hljs-comment">;</span>
  if (token) <span class="hljs-attr">config.headers.Authorization</span> = `Bearer <span class="hljs-variable">${token}</span>`<span class="hljs-comment">;</span>
  return config<span class="hljs-comment">;</span>
})<span class="hljs-comment">;</span>

// å“åº”æ‹¦æˆªå™¨
api.interceptors.response.use(
  <span class="hljs-attr">response</span> =&gt; response.data,
  <span class="hljs-attr">error</span> =&gt; {
    if (error.response?.<span class="hljs-attr">status</span> === <span class="hljs-number">401</span>) {
      // å¤„ç†æœªæˆæƒ
      router.push('/login')<span class="hljs-comment">;</span>
    }
    return Promise.reject(error)<span class="hljs-comment">;</span>
  }
)<span class="hljs-comment">;</span>

export default api<span class="hljs-comment">;</span>
</code></pre>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- åœ¨ç»„ä»¶ä¸­ä½¿ç”¨ --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { ref } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;
<span class="hljs-keyword">import</span> api <span class="hljs-keyword">from</span> <span class="hljs-string">'@/composables/useApi'</span>;

<span class="hljs-keyword">const</span> users = <span class="hljs-title function_">ref</span>([]);
<span class="hljs-keyword">const</span> loading = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>);

<span class="hljs-keyword">const</span> <span class="hljs-title function_">fetchUsers</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
  loading.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span>;
  <span class="hljs-keyword">try</span> {
    users.<span class="hljs-property">value</span> = <span class="hljs-keyword">await</span> api.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/users'</span>);
  } <span class="hljs-keyword">finally</span> {
    loading.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>;
  }
};

<span class="hljs-title function_">fetchUsers</span>();
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<h3 data-id="heading-23">5.2 ä½¿ç”¨ Fetchï¼ˆè½»é‡çº§é¡¹ç›®ï¼‰</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// utils/request.js</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">request</span>(<span class="hljs-params">url, options = {}</span>) {
  <span class="hljs-keyword">const</span> config = {
    <span class="hljs-attr">credentials</span>: <span class="hljs-string">'include'</span>,
    ...options,
    <span class="hljs-attr">headers</span>: {
      <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span>,
      ...options.<span class="hljs-property">headers</span>
    }
  };

  <span class="hljs-keyword">const</span> controller = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AbortController</span>();
  <span class="hljs-keyword">const</span> timeoutId = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> controller.<span class="hljs-title function_">abort</span>(), <span class="hljs-number">10000</span>);
  
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(url, {
      ...config,
      <span class="hljs-attr">signal</span>: controller.<span class="hljs-property">signal</span>
    });
    
    <span class="hljs-built_in">clearTimeout</span>(timeoutId);
    
    <span class="hljs-keyword">if</span> (!response.<span class="hljs-property">ok</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`HTTP <span class="hljs-subst">${response.status}</span>`</span>);
    }
    
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> response.<span class="hljs-title function_">json</span>();
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-built_in">clearTimeout</span>(timeoutId);
    <span class="hljs-keyword">throw</span> error;
  }
}

<span class="hljs-keyword">export</span> { request };
</code></pre>
<h3 data-id="heading-24">5.3 å°è£…ä¸º Composableï¼ˆæœ€ä½³å®è·µï¼‰</h3>
<pre><code class="hljs language-ini" lang="ini">// composables/useFetch.js
import { ref } from 'vue'<span class="hljs-comment">;</span>

export function useFetch(url) {
  const <span class="hljs-attr">data</span> = ref(null)<span class="hljs-comment">;</span>
  const <span class="hljs-attr">loading</span> = ref(<span class="hljs-literal">false</span>)<span class="hljs-comment">;</span>
  const <span class="hljs-attr">error</span> = ref(null)<span class="hljs-comment">;</span>

  const <span class="hljs-attr">execute</span> = async () =&gt; {
    <span class="hljs-attr">loading.value</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
    <span class="hljs-attr">error.value</span> = null<span class="hljs-comment">;</span>
    
    try {
      const <span class="hljs-attr">res</span> = await fetch(url)<span class="hljs-comment">;</span>
      if (!res.ok) throw new Error(res.statusText)<span class="hljs-comment">;</span>
      <span class="hljs-attr">data.value</span> = await res.json()<span class="hljs-comment">;</span>
    } catch (err) {
      <span class="hljs-attr">error.value</span> = err<span class="hljs-comment">;</span>
    } finally {
      <span class="hljs-attr">loading.value</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
    }
  }<span class="hljs-comment">;</span>

  return { data, loading, error, execute }<span class="hljs-comment">;</span>
}
</code></pre>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { useFetch } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/composables/useFetch'</span>;

<span class="hljs-keyword">const</span> { <span class="hljs-attr">data</span>: users, loading, execute } = <span class="hljs-title function_">useFetch</span>(<span class="hljs-string">'/api/users'</span>);
<span class="hljs-title function_">execute</span>();
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<hr/>
<h2 data-id="heading-25">å…­ã€å¦‚ä½•é€‰æ‹©ï¼Ÿâ€”â€” ä½¿ç”¨åœºæ™¯å»ºè®®</h2>








































<table><thead><tr><th>åœºæ™¯</th><th>æ¨èæ–¹æ¡ˆ</th><th>ç†ç”±</th></tr></thead><tbody><tr><td><strong>æ–°é¡¹ç›®ï¼ˆç°ä»£æµè§ˆå™¨ï¼‰</strong></td><td><code>fetch()</code> + å·¥å…·å‡½æ•°å°è£…</td><td>åŸç”Ÿæ”¯æŒï¼Œæ— ä¾èµ–ï¼Œç¬¦åˆæ ‡å‡†</td></tr><tr><td><strong>éœ€è¦ä¸Šä¼ /ä¸‹è½½è¿›åº¦</strong></td><td><code>XMLHttpRequest</code> æˆ– Axios</td><td>åŸç”Ÿæ”¯æŒ <code>onprogress</code>ï¼Œç®€å•å¯é </td></tr><tr><td><strong>å¤æ‚æ‹¦æˆªã€è½¬æ¢ã€å…¼å®¹ Node.js</strong></td><td><code>Axios</code></td><td>åŠŸèƒ½å…¨é¢ï¼Œç”Ÿæ€æˆç†Ÿ</td></tr><tr><td><strong>ç»´æŠ¤æ—§é¡¹ç›®ï¼ˆIE11+ï¼‰</strong></td><td><code>XMLHttpRequest</code> æˆ– Axiosï¼ˆå¸¦ polyfillï¼‰</td><td>æœ€å¤§å…¼å®¹æ€§</td></tr><tr><td><strong>è½»é‡çº§åº”ç”¨ï¼Œé¿å…æ‰“åŒ…ä½“ç§¯</strong></td><td><code>fetch()</code></td><td>æ— éœ€å¼•å…¥ç¬¬ä¸‰æ–¹åº“</td></tr><tr><td><strong>Vue 3 é¡¹ç›®</strong></td><td><strong>Axiosï¼ˆå¤æ‚ï¼‰</strong> æˆ– <strong>Fetch + Composableï¼ˆç®€å•ï¼‰</strong></td><td>ä¸ç»„åˆå¼ API å®Œç¾å¥‘åˆ</td></tr></tbody></table>
<blockquote>
<p>ğŸ“Œ <strong>ç°ä»£æœ€ä½³å®è·µ</strong>ï¼š</p>
<ul>
<li>ä¼˜å…ˆä½¿ç”¨ <code>fetch()</code> æˆ– Axios</li>
<li>å°†ç½‘ç»œé€»è¾‘å°è£…ä¸º Composableï¼Œå®ç°é€»è¾‘å¤ç”¨</li>
<li>é¿å…ç›´æ¥ä½¿ç”¨è£¸ XHRï¼ˆé™¤éç‰¹æ®Šéœ€æ±‚ï¼‰</li>
</ul>
</blockquote>
<hr/>
<h2 data-id="heading-26">ä¸ƒã€å®‰å…¨ä¸æ€§èƒ½æ³¨æ„äº‹é¡¹</h2>
<h3 data-id="heading-27">7.1 å®‰å…¨</h3>
<ul>
<li><strong>XSS é˜²æŠ¤</strong>ï¼šæ°¸è¿œä¸è¦å°†å“åº”ç›´æ¥æ’å…¥ <code>innerHTML</code></li>
<li><strong>CSRF é˜²æŠ¤</strong>ï¼šä½¿ç”¨ anti-CSRF tokenï¼Œé‡è¦æ“ä½œç”¨é GET æ–¹æ³•</li>
<li><strong>CORS ç­–ç•¥</strong>ï¼šæœåŠ¡å™¨ä¸¥æ ¼é™åˆ¶ <code>Access-Control-Allow-Origin</code></li>
<li><strong>æ•æ„Ÿæ•°æ®</strong>ï¼šä½¿ç”¨ HTTPSï¼Œé¿å…å®¢æˆ·ç«¯å­˜å‚¨å¯†ç /token</li>
</ul>
<h3 data-id="heading-28">7.2 æ€§èƒ½</h3>
<ul>
<li><strong>ç¼“å­˜ç­–ç•¥</strong>ï¼šåˆç†è®¾ç½® <code>Cache-Control</code> å¤´</li>
<li><strong>è¯·æ±‚åˆå¹¶</strong>ï¼šé¿å…é¢‘ç¹å°è¯·æ±‚</li>
<li><strong>æ‡’åŠ è½½</strong>ï¼šéå…³é”®æ•°æ®å»¶è¿Ÿè¯·æ±‚</li>
<li><strong>å–æ¶ˆå†—ä½™è¯·æ±‚</strong>ï¼šç»„ä»¶é”€æ¯æ—¶ä¸­æ­¢æœªå®Œæˆçš„è¯·æ±‚</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Vue 3 ä¸­å–æ¶ˆè¯·æ±‚</span>
<span class="hljs-keyword">import</span> { onUnmounted } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useFetch</span>(<span class="hljs-params">url</span>) {
  <span class="hljs-keyword">const</span> controller = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AbortController</span>();
  
  <span class="hljs-title function_">onUnmounted</span>(<span class="hljs-function">() =&gt;</span> {
    controller.<span class="hljs-title function_">abort</span>(); <span class="hljs-comment">// ç»„ä»¶å¸è½½æ—¶å–æ¶ˆè¯·æ±‚</span>
  });
  
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">execute</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">fetch</span>(url, { <span class="hljs-attr">signal</span>: controller.<span class="hljs-property">signal</span> });
  };
  
  <span class="hljs-keyword">return</span> { execute };
}
</code></pre>
<hr/>
<h2 data-id="heading-29">ç»“è¯­</h2>
<p>ç†è§£ XHRã€AJAXã€Axios ä¸ Fetch çš„å…³ç³»ï¼Œæœ¬è´¨ä¸Šæ˜¯ç†è§£ Web å¼‚æ­¥é€šä¿¡æŠ€æœ¯çš„æ¼”è¿›å²ï¼š</p>
<ul>
<li><strong>AJAX</strong> æå‡ºäº†â€œå¼‚æ­¥æ›´æ–°â€çš„æ€æƒ³</li>
<li><strong>XHR</strong> æä¾›äº†é¦–ä¸ªæ ‡å‡†åŒ–å®ç°</li>
<li><strong>Axios</strong> åœ¨ XHR åŸºç¡€ä¸Šæ„å»ºäº†å¼€å‘è€…å‹å¥½çš„æŠ½è±¡</li>
<li><strong>Fetch</strong> åˆ™ä»£è¡¨äº†æµè§ˆå™¨å‚å•†å¯¹ä¸‹ä¸€ä»£ç½‘ç»œ API çš„é‡æ–°è®¾è®¡</li>
</ul>
<p>ä½œä¸ºå¼€å‘è€…ï¼Œæˆ‘ä»¬ä¸å¿…æ‹˜æ³¥äºæŸä¸€ç§å·¥å…·ï¼Œè€Œåº”æ ¹æ®é¡¹ç›®éœ€æ±‚ã€æµè§ˆå™¨æ”¯æŒå’ŒåŠŸèƒ½å¤æ‚åº¦åšå‡ºåˆç†é€‰æ‹©ã€‚ä½†æ— è®ºä½¿ç”¨å“ªç§æ–¹å¼ï¼Œå…¶èƒŒåçš„æ ¸å¿ƒåŸç†â€”â€”<strong>HTTP åè®®ã€CORS å®‰å…¨æ¨¡å‹ã€å¼‚æ­¥ç¼–ç¨‹èŒƒå¼</strong>â€”â€”å§‹ç»ˆä¸å˜ã€‚</p>
<p>åœ¨ Vue 3 çš„ç»„åˆå¼ API æ—¶ä»£ï¼Œå°†ç½‘ç»œé€»è¾‘å°è£…ä¸ºå¯å¤ç”¨çš„ Composableï¼Œä¸ä»…èƒ½æå‡ä»£ç å¯ç»´æŠ¤æ€§ï¼Œæ›´èƒ½å……åˆ†å‘æŒ¥ç°ä»£ JavaScript çš„è¡¨è¾¾åŠ›ã€‚æŒæ¡è¿™äº›åº•å±‚é€»è¾‘ï¼Œæ‰èƒ½åœ¨æŠ€æœ¯å˜è¿ä¸­æ¸¸åˆƒæœ‰ä½™ï¼Œæ„å»ºå‡ºé«˜æ€§èƒ½ã€é«˜å®‰å…¨æ€§çš„ç°ä»£ Web åº”ç”¨ã€‚</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[è„šæ‰‹æ¶å¼€å‘å·¥å…·â€”â€”åˆ¤æ–­æ–‡ä»¶æ˜¯å¦å­˜åœ¨ path-exists]]></title>    <link>https://juejin.cn/post/7585400495684124714</link>    <guid>https://juejin.cn/post/7585400495684124714</guid>    <pubDate>2025-12-20T08:23:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585400495684124714" data-draft-id="7585474459776286756" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="è„šæ‰‹æ¶å¼€å‘å·¥å…·â€”â€”åˆ¤æ–­æ–‡ä»¶æ˜¯å¦å­˜åœ¨  path-exists"/> <meta itemprop="keywords" content="å‰ç«¯"/> <meta itemprop="datePublished" content="2025-12-20T08:23:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="code_YuJun"/> <meta itemprop="url" content="https://juejin.cn/user/3615612462441358"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="æ˜é‡‘"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            è„šæ‰‹æ¶å¼€å‘å·¥å…·â€”â€”åˆ¤æ–­æ–‡ä»¶æ˜¯å¦å­˜åœ¨  path-exists
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3615612462441358/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    code_YuJun
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T08:23:02.000Z" title="Sat Dec 20 2025 08:23:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    é˜…è¯»1åˆ†é’Ÿ
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">ç®€ä»‹</h2>
<p><code>path-exists</code>Â æ˜¯ä¸€ä¸ªè½»é‡çº§çš„ Node.js npm åŒ…ï¼Œå…¶<strong>æ ¸å¿ƒä½œç”¨æ˜¯ç®€ä¾¿ã€é«˜æ•ˆåœ°æ£€æŸ¥æ–‡ä»¶ç³»ç»Ÿä¸­æŒ‡å®šçš„è·¯å¾„ï¼ˆæ–‡ä»¶æˆ–ç›®å½•ï¼‰æ˜¯å¦å­˜åœ¨</strong>ï¼Œæ— éœ€å¼€å‘è€…æ‰‹åŠ¨å°è£…åŸç”Ÿæ–‡ä»¶æ“ä½œçš„å›è°ƒé€»è¾‘æˆ–é”™è¯¯å¤„ç†ï¼Œç®€åŒ–äº† Node.js ä¸­çš„è·¯å¾„å­˜åœ¨æ€§æ ¡éªŒåœºæ™¯ã€‚</p>
<h3 data-id="heading-1">æ ¸å¿ƒç”¨æ³•</h3>
<pre><code class="hljs language-lua" lang="lua">npm install <span class="hljs-built_in">path</span>-exists <span class="hljs-comment">--save</span>
</code></pre>
<ul>
<li>å¼‚æ­¥ç”¨æ³•ï¼ˆæ¨èï¼Œéé˜»å¡ I/Oï¼‰</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> pathExists = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path-exists'</span>);

<span class="hljs-comment">// å¼‚æ­¥æ£€æŸ¥æ–‡ä»¶è·¯å¾„æ˜¯å¦å­˜åœ¨</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">checkFilePath</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// ä¼ å…¥è¦æ£€æŸ¥çš„æ–‡ä»¶/ç›®å½•è·¯å¾„ï¼ˆç›¸å¯¹è·¯å¾„æˆ–ç»å¯¹è·¯å¾„å‡å¯ï¼‰</span>
  <span class="hljs-keyword">const</span> isExist = <span class="hljs-keyword">await</span> <span class="hljs-title function_">pathExists</span>(<span class="hljs-string">'./test.txt'</span>);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼š'</span>, isExist); <span class="hljs-comment">// è¿”å› true æˆ– false</span>
}

<span class="hljs-title function_">checkFilePath</span>();

<span class="hljs-comment">// ä¹Ÿå¯ä½¿ç”¨ Promise é“¾å¼è°ƒç”¨ï¼ˆå…¼å®¹æ—§ç‰ˆè¯­æ³•ï¼‰</span>
<span class="hljs-title function_">pathExists</span>(<span class="hljs-string">'./dist/'</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">exists</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'ç›®å½•æ˜¯å¦å­˜åœ¨ï¼š'</span>, exists);
});
</code></pre>
<ul>
<li>åŒæ­¥ç”¨æ³•ï¼ˆé€‚ç”¨äºç®€å•è„šæœ¬ï¼Œé˜»å¡ I/Oï¼‰</li>
</ul>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">pathExists</span> = require(<span class="hljs-string">'path-exists'</span>)<span class="hljs-comment">;</span>

// åŒæ­¥æ£€æŸ¥ç›®å½•è·¯å¾„æ˜¯å¦å­˜åœ¨
const <span class="hljs-attr">dirExists</span> = pathExists.sync(<span class="hljs-string">'./node_modules/'</span>)<span class="hljs-comment">;</span>
console.log('node_modules ç›®å½•æ˜¯å¦å­˜åœ¨ï¼š', dirExists)<span class="hljs-comment">; // è¿”å› true æˆ– false</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[linuxæ­å»ºhadoopæœåŠ¡]]></title>    <link>https://juejin.cn/post/7585474459776385060</link>    <guid>https://juejin.cn/post/7585474459776385060</guid>    <pubDate>2025-12-20T08:27:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585474459776385060" data-draft-id="7585474459776172068" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="linuxæ­å»ºhadoopæœåŠ¡"/> <meta itemprop="keywords" content="åç«¯"/> <meta itemprop="datePublished" content="2025-12-20T08:27:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="è‹ä¸‰çš„å¼€å‘æ—¥è®°"/> <meta itemprop="url" content="https://juejin.cn/user/4248949048749213"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="æ˜é‡‘"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            linuxæ­å»ºhadoopæœåŠ¡
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4248949048749213/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    è‹ä¸‰çš„å¼€å‘æ—¥è®°
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T08:27:37.000Z" title="Sat Dec 20 2025 08:27:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    é˜…è¯»1åˆ†é’Ÿ
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1.åˆ›å»ºxsyncä¸jpsall</h2>
<p>mkdir -p /home/atguigu/bin</p>
<p>vim xsync</p>
<pre><code class="hljs language-js" lang="js">#!<span class="hljs-regexp">/bin/</span>bash

# <span class="hljs-number">1.</span> åˆ¤æ–­å‚æ•°ä¸ªæ•°
<span class="hljs-keyword">if</span> [ $# -lt <span class="hljs-number">1</span> ]; then
    echo <span class="hljs-string">"Not Enough Arguement!"</span>
    exit <span class="hljs-number">1</span>
fi

# <span class="hljs-number">2.</span> éå†é›†ç¾¤æ‰€æœ‰æœºå™¨
<span class="hljs-keyword">for</span> host <span class="hljs-keyword">in</span> hadoop102 hadoop103 hadoop104; <span class="hljs-keyword">do</span>
    echo <span class="hljs-string">"==================== $host ===================="</span>

    # <span class="hljs-number">3.</span> éå†æ‰€æœ‰ç›®å½•ï¼ŒæŒ¨ä¸ªå‘é€
    <span class="hljs-keyword">for</span> file <span class="hljs-keyword">in</span> <span class="hljs-string">"$@"</span>; <span class="hljs-keyword">do</span>
        # <span class="hljs-number">4.</span> åˆ¤æ–­æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        <span class="hljs-keyword">if</span> [ -e <span class="hljs-string">"$file"</span> ]; then
            # <span class="hljs-number">5.</span> è·å–çˆ¶ç›®å½•
            pdir=$(cd -P <span class="hljs-string">"$(dirname "</span>$file<span class="hljs-string">")"</span>; pwd)
            # <span class="hljs-number">6.</span> è·å–å½“å‰æ–‡ä»¶çš„åç§°
            fname=$(basename <span class="hljs-string">"$file"</span>)

            ssh <span class="hljs-string">"$host"</span> <span class="hljs-string">"mkdir -p $pdir"</span>
            rsync -av <span class="hljs-string">"$pdir/$fname"</span> <span class="hljs-string">"$host:$pdir"</span>
        <span class="hljs-keyword">else</span>
            echo <span class="hljs-string">"$file does not exist!"</span>
        fi
    done
done
</code></pre>
<p>vim jpsall</p>
<pre><code class="hljs language-js" lang="js">#!<span class="hljs-regexp">/bin/</span>bash

<span class="hljs-keyword">for</span> host <span class="hljs-keyword">in</span> hadoop102 hadoop103 hadoop104

<span class="hljs-keyword">do</span>

echo =============== $host ===============

ssh $host jps

done
</code></pre>
<h2 data-id="heading-1">2.ç¼–è¾‘/etc/profile.d/my_env.sh</h2>
<pre><code class="hljs language-js" lang="js">#<span class="hljs-variable constant_">JAVA_HOME</span>
<span class="hljs-keyword">export</span> <span class="hljs-variable constant_">JAVA_HOME</span>=<span class="hljs-regexp">/opt/m</span>odule/jdk1<span class="hljs-number">.8</span><span class="hljs-number">.0_212</span>
<span class="hljs-keyword">export</span> <span class="hljs-variable constant_">PATH</span>=<span class="hljs-attr">$PATH</span>:$JAVA_HOME/bin
#<span class="hljs-variable constant_">HADOOP_HOME</span>
<span class="hljs-keyword">export</span> <span class="hljs-variable constant_">HADOOP_HOME</span>=<span class="hljs-regexp">/opt/m</span>odule/hadoop-<span class="hljs-number">3.1</span><span class="hljs-number">.3</span>
<span class="hljs-keyword">export</span> <span class="hljs-variable constant_">PATH</span>=<span class="hljs-attr">$PATH</span>:$HADOOP_HOME/bin
<span class="hljs-keyword">export</span> <span class="hljs-variable constant_">PATH</span>=<span class="hljs-attr">$PATH</span>:$HADOOP_HOME/sbin
#<span class="hljs-variable constant_">KAFKA_HOME</span>
<span class="hljs-keyword">export</span> <span class="hljs-variable constant_">KAFKA_HOME</span>=<span class="hljs-regexp">/opt/m</span>odule/kafka
<span class="hljs-keyword">export</span> <span class="hljs-variable constant_">PATH</span>=<span class="hljs-attr">$PATH</span>:$KAFKA_HOME/bin

source /etc/profile.<span class="hljs-property">d</span>/my_env.<span class="hljs-property">sh</span>
</code></pre>
<h2 data-id="heading-2">3.ä¿®æ”¹æ–‡ä»¶ç»„</h2>
<pre><code class="hljs language-js" lang="js">åœ¨ hadoop102ã€hadoop103ã€hadoop104 éƒ½å·²ç»åˆ›å»ºå¥½çš„/opt/<span class="hljs-variable language_">module</span> å¹¶ä¸”å·²ç»æŠŠè¿™ä¸ªç›®å½•ä¿®æ”¹ä¸º <span class="hljs-attr">atguigu</span>:atguigu

<span class="hljs-number">102</span>æœåŠ¡å™¨: sudo chown <span class="hljs-attr">atguigu</span>:atguigu -R /opt/<span class="hljs-variable language_">module</span>

scp -r /opt/<span class="hljs-variable language_">module</span>/jdk1<span class="hljs-number">.8</span><span class="hljs-number">.0_212</span> atguigu@<span class="hljs-attr">hadoop103</span>:<span class="hljs-regexp">/opt/m</span>odule

scp -r /opt/<span class="hljs-variable language_">module</span>/jdk1<span class="hljs-number">.8</span><span class="hljs-number">.0_212</span> atguigu@<span class="hljs-attr">hadoop104</span>:<span class="hljs-regexp">/opt/m</span>odule
</code></pre>
<h2 data-id="heading-3">4.ä¿®æ”¹hadoopç›¸å…³é…ç½®æ–‡ä»¶</h2>
<p>cd $HADOOP_HOME/etc/hadoop</p>
<p>ç¼–è¾‘ core-site.xml</p>
<pre><code class="hljs language-js" lang="js">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span>?&gt;
&lt;?xml-stylesheet type=<span class="hljs-string">"text/xsl"</span> href=<span class="hljs-string">"configuration.xsl"</span>?&gt;
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span>
 <span class="hljs-comment">&lt;!-- æŒ‡å®š NameNode çš„åœ°å€ --&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">property</span>&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>fs.defaultFS<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>hdfs://hadoop102:8020<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span>
 <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
 <span class="hljs-comment">&lt;!-- æŒ‡å®š hadoop æ•°æ®çš„å­˜å‚¨ç›®å½• --&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">property</span>&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>hadoop.tmp.dir<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>/opt/module/hadoop-3.1.3/data<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span>
 <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
 <span class="hljs-comment">&lt;!-- é…ç½® HDFS ç½‘é¡µç™»å½•ä½¿ç”¨çš„é™æ€ç”¨æˆ·ä¸º atguigu --&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">property</span>&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>hadoop.http.staticuser.user<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>atguigu<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span>
 <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span></span>
</code></pre>
<p>ç¼–è¾‘ hdfs-site.xml</p>
<pre><code class="hljs language-js" lang="js">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span>?&gt;
&lt;?xml-stylesheet type=<span class="hljs-string">"text/xsl"</span> href=<span class="hljs-string">"configuration.xsl"</span>?&gt;
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span>
<span class="hljs-comment">&lt;!-- nn web ç«¯è®¿é—®åœ°å€--&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">property</span>&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>dfs.namenode.http-address<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>hadoop102:9870<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span>
 <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
<span class="hljs-comment">&lt;!-- 2nn web ç«¯è®¿é—®åœ°å€--&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">property</span>&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>dfs.namenode.secondary.http-address<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>hadoop104:9868<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span>
 <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span></span>
</code></pre>
<p>ç¼–è¾‘ yarn-site.xml</p>
<pre><code class="hljs language-js" lang="js">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span>?&gt;
&lt;?xml-stylesheet type=<span class="hljs-string">"text/xsl"</span> href=<span class="hljs-string">"configuration.xsl"</span>?&gt;
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span>
 <span class="hljs-comment">&lt;!-- æŒ‡å®š MR èµ° shuffle --&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">property</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>yarn.nodemanager.aux-services<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>mapreduce_shuffle<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span>
 <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
 <span class="hljs-comment">&lt;!-- æŒ‡å®š ResourceManager çš„åœ°å€--&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">property</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>yarn.resourcemanager.hostname<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>hadoop103<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span>
 <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
 <span class="hljs-comment">&lt;!-- ç¯å¢ƒå˜é‡çš„ç»§æ‰¿ --&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">property</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>yarn.nodemanager.env-whitelist<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>JAVA_HOME,HADOOP_COMMON_HOME,HADOOP_HDFS_HOME,HADOOP_CONF_DIR,CLASSPATH_PREPEND_DISTCACHE,HADOOP_YARN_HOME,HADOOP_MAPRED_HOME<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span>
 <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
 <span class="hljs-comment">&lt;!-- å¼€å¯æ—¥å¿—èšé›†åŠŸèƒ½ --&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">property</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>yarn.log-aggregation-enable<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span>
 <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
 <span class="hljs-comment">&lt;!-- è®¾ç½®æ—¥å¿—èšé›†æœåŠ¡å™¨åœ°å€ --&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">property</span>&gt;</span> 
  <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>yarn.log.server.url<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span> 
  <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>http://hadoop102:19888/jobhistory/logs<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span>
 <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
 <span class="hljs-comment">&lt;!-- è®¾ç½®æ—¥å¿—ä¿ç•™æ—¶é—´ä¸º 7 å¤© --&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">property</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>yarn.log-aggregation.retain-seconds<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>604800<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span>
 <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
 <span class="hljs-comment">&lt;!--æ˜¯å¦å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹æ£€æŸ¥æ¯ä¸ªä»»åŠ¡æ­£ä½¿ç”¨çš„ç‰©ç†å†…å­˜é‡ï¼Œå¦‚æœä»»åŠ¡è¶…å‡ºåˆ†é…å€¼ï¼Œåˆ™ç›´æ¥å°†å…¶æ€æ‰ï¼Œé»˜è®¤æ˜¯true --&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">property</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>yarn.nodemanager.pmem-check-enabled<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>false<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span>
 <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
 <span class="hljs-comment">&lt;!--æ˜¯å¦å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹æ£€æŸ¥æ¯ä¸ªä»»åŠ¡æ­£ä½¿ç”¨çš„è™šæ‹Ÿå†…å­˜é‡ï¼Œå¦‚æœä»»åŠ¡è¶…å‡ºåˆ†é…å€¼ï¼Œåˆ™ç›´æ¥å°†å…¶æ€æ‰ï¼Œé»˜è®¤æ˜¯true --&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">property</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>yarn.nodemanager.vmem-check-enabled<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>false<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span>
 <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>    
 <span class="hljs-tag">&lt;<span class="hljs-name">property</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>yarn.log.server.url<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>http://hadoop102:19888/jobhistory/logs<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span>
 <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span></span>
</code></pre>
<p>ç¼–è¾‘ mapred-site.xml</p>
<pre><code class="hljs language-js" lang="js">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span>?&gt;
&lt;?xml-stylesheet type=<span class="hljs-string">"text/xsl"</span> href=<span class="hljs-string">"configuration.xsl"</span>?&gt;
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span>
<span class="hljs-comment">&lt;!-- æŒ‡å®š MapReduce ç¨‹åºè¿è¡Œåœ¨ Yarn ä¸Š --&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">property</span>&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>mapreduce.framework.name<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>yarn<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span>
 <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
 <span class="hljs-comment">&lt;!-- å†å²æœåŠ¡å™¨ç«¯åœ°å€ --&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">property</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>mapreduce.jobhistory.address<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>hadoop102:10020<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span>
 <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
 <span class="hljs-comment">&lt;!-- å†å²æœåŠ¡å™¨ web ç«¯åœ°å€ --&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">property</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>mapreduce.jobhistory.webapp.address<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>hadoop102:19888<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span>
 <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span></span>
</code></pre>
<p>xsyncåŒæ­¥æ–‡ä»¶</p>
<pre><code class="hljs language-js" lang="js">xsync /opt/<span class="hljs-variable language_">module</span>/hadoop-<span class="hljs-number">3.1</span><span class="hljs-number">.3</span>/etc/hadoop/
</code></pre>
<p>ç¼–è¾‘ workersæ·»åŠ å†…å®¹</p>
<pre><code class="hljs language-js" lang="js">hadoop102
hadoop103
hadoop104

æ³¨æ„ï¼šè¯¥æ–‡ä»¶ä¸­æ·»åŠ çš„å†…å®¹ç»“å°¾ä¸å…è®¸æœ‰ç©ºæ ¼ï¼Œæ–‡ä»¶ä¸­ä¸å…è®¸æœ‰ç©ºè¡Œ
</code></pre>
<h2 data-id="heading-4">5.ç¼–å†™hadoopé›†ç¾¤ç®¡ç†è„šæœ¬</h2>
<pre><code class="hljs language-js" lang="js">#!<span class="hljs-regexp">/bin/</span>bash

<span class="hljs-keyword">if</span> [ $# -lt <span class="hljs-number">1</span> ]; then
    echo <span class="hljs-string">"No Args Input..."</span>
    exit
fi

<span class="hljs-keyword">case</span> $1 <span class="hljs-keyword">in</span>
    <span class="hljs-string">"start"</span>)
        echo <span class="hljs-string">" =================== å¯åŠ¨ hadoop é›†ç¾¤ ==================="</span>
        echo <span class="hljs-string">" --------------- å¯åŠ¨ hdfs ---------------"</span>
        ssh hadoop102 <span class="hljs-string">"/opt/module/hadoop-3.1.3/sbin/start-dfs.sh"</span>
        echo <span class="hljs-string">" --------------- å¯åŠ¨ yarn ---------------"</span>
        ssh hadoop103 <span class="hljs-string">"/opt/module/hadoop-3.1.3/sbin/start-yarn.sh"</span>
        echo <span class="hljs-string">" --------------- å¯åŠ¨ historyserver ---------------"</span>
        ssh hadoop102 <span class="hljs-string">"/opt/module/hadoop-3.1.3/bin/mapred --daemon start historyserver"</span>
        ;;
    <span class="hljs-string">"stop"</span>)
        echo <span class="hljs-string">" =================== å…³é—­ hadoop é›†ç¾¤ ==================="</span>
        echo <span class="hljs-string">" --------------- å…³é—­ historyserver ---------------"</span>
        ssh hadoop102 <span class="hljs-string">"/opt/module/hadoop-3.1.3/bin/mapred --daemon stop historyserver"</span>
        echo <span class="hljs-string">" --------------- å…³é—­ yarn ---------------"</span>
        ssh hadoop103 <span class="hljs-string">"/opt/module/hadoop-3.1.3/sbin/stop-yarn.sh"</span>
        echo <span class="hljs-string">" --------------- å…³é—­ hdfs ---------------"</span>
        ssh hadoop102 <span class="hljs-string">"/opt/module/hadoop-3.1.3/sbin/stop-dfs.sh"</span>
        ;;
    *)
        echo <span class="hljs-string">"Input Args Error..."</span>
        ;;
esac
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Promise ï¼šä»åŸºç¡€åŸç†åˆ°é«˜çº§å®è·µ]]></title>    <link>https://juejin.cn/post/7585686247269515273</link>    <guid>https://juejin.cn/post/7585686247269515273</guid>    <pubDate>2025-12-20T08:35:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585686247269515273" data-draft-id="7585463195201388594" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Promise ï¼šä»åŸºç¡€åŸç†åˆ°é«˜çº§å®è·µ"/> <meta itemprop="keywords" content="å‰ç«¯"/> <meta itemprop="datePublished" content="2025-12-20T08:35:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ç”¨æˆ·5427784851540"/> <meta itemprop="url" content="https://juejin.cn/user/224762173330942"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="æ˜é‡‘"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Promise ï¼šä»åŸºç¡€åŸç†åˆ°é«˜çº§å®è·µ
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/224762173330942/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ç”¨æˆ·5427784851540
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T08:35:42.000Z" title="Sat Dec 20 2025 08:35:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    é˜…è¯»6åˆ†é’Ÿ
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><code>Promise</code> æ˜¯ JavaScript ä¸­å¤„ç†å¼‚æ­¥æ“ä½œçš„æ ¸å¿ƒæœºåˆ¶ï¼Œå®ƒè§£å†³äº†ä¼ ç»Ÿå›è°ƒå‡½æ•°ï¼ˆCallbackï¼‰å¸¦æ¥çš„â€œå›è°ƒåœ°ç‹±â€ï¼ˆCallback Hellï¼‰é—®é¢˜ï¼Œä½¿å¼‚æ­¥ä»£ç æ›´æ¸…æ™°ã€å¯è¯»ã€å¯ç»´æŠ¤ã€‚è‡ª ES6ï¼ˆECMAScript 2015ï¼‰æ­£å¼å¼•å…¥ä»¥æ¥ï¼ŒPromise å·²æˆä¸ºç°ä»£å‰ç«¯å¼€å‘çš„åŸºçŸ³ï¼Œå¹¶ä¸º <code>async/await</code> è¯­æ³•æä¾›äº†åº•å±‚æ”¯æŒã€‚</p>
<hr/>
<h2 data-id="heading-0">ä¸€ã€ä¸ºä»€ä¹ˆéœ€è¦ Promiseï¼Ÿ</h2>
<h3 data-id="heading-1">1.1 å›è°ƒå‡½æ•°çš„å±€é™æ€§</h3>
<p>åœ¨ Promise å‡ºç°ä¹‹å‰ï¼Œå¼‚æ­¥æ“ä½œä¸»è¦é€šè¿‡å›è°ƒå‡½æ•°å®ç°ï¼š</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// åµŒå¥—å›è°ƒï¼ˆå›è°ƒåœ°ç‹±ï¼‰</span>
<span class="hljs-title function_">getData</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">a</span>) {
  <span class="hljs-title function_">getMoreData</span>(a, <span class="hljs-keyword">function</span>(<span class="hljs-params">b</span>) {
    <span class="hljs-title function_">getEvenMoreData</span>(b, <span class="hljs-keyword">function</span>(<span class="hljs-params">c</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(c);
    });
  });
});
</code></pre>
<p><strong>é—®é¢˜</strong>ï¼š</p>
<ul>
<li>ä»£ç æ¨ªå‘æ‰©å±•ï¼Œéš¾ä»¥é˜…è¯»å’Œç»´æŠ¤</li>
<li>é”™è¯¯å¤„ç†åˆ†æ•£ï¼Œéœ€åœ¨æ¯ä¸ªå›è°ƒä¸­é‡å¤å†™ <code>try/catch</code></li>
<li>æ— æ³•ä½¿ç”¨ <code>return</code> æˆ– <code>throw</code> æ§åˆ¶æµç¨‹</li>
<li>å¤šä¸ªå¼‚æ­¥æ“ä½œçš„ç»„åˆï¼ˆå¦‚å¹¶è¡Œã€ç«æ€ï¼‰å®ç°å¤æ‚</li>
</ul>
<h3 data-id="heading-2">1.2 Promise çš„ä¼˜åŠ¿</h3>
<ul>
<li><strong>é“¾å¼è°ƒç”¨</strong>ï¼šé€šè¿‡ <code>.then()</code> å®ç°çº¿æ€§æµç¨‹</li>
<li><strong>ç»Ÿä¸€é”™è¯¯å¤„ç†</strong>ï¼šé€šè¿‡ <code>.catch()</code> æ•è·æ•´ä¸ªé“¾ä¸­çš„é”™è¯¯</li>
<li><strong>ç»„åˆèƒ½åŠ›</strong>ï¼šæ”¯æŒ <code>Promise.all</code>ã€<code>Promise.race</code> ç­‰é«˜çº§æ¨¡å¼</li>
<li><strong>ä¸ async/await æ— ç¼é›†æˆ</strong></li>
</ul>
<hr/>
<h2 data-id="heading-3">äºŒã€Promise åŸºç¡€æ¦‚å¿µ</h2>
<h3 data-id="heading-4">2.1 ä»€ä¹ˆæ˜¯ Promiseï¼Ÿ</h3>
<blockquote>
<p><strong>Promise æ˜¯ä¸€ä¸ªè¡¨ç¤ºå¼‚æ­¥æ“ä½œæœ€ç»ˆå®Œæˆæˆ–å¤±è´¥çš„å¯¹è±¡ã€‚</strong></p>
</blockquote>
<p>å®ƒæœ‰ä¸‰ç§çŠ¶æ€ï¼ˆStateï¼‰ï¼š</p>
<ul>
<li><strong>pendingï¼ˆå¾…å®šï¼‰</strong> ï¼šåˆå§‹çŠ¶æ€ï¼Œæ—¢ä¸æ˜¯æˆåŠŸä¹Ÿä¸æ˜¯å¤±è´¥</li>
<li><strong>fulfilledï¼ˆå·²æˆåŠŸï¼‰</strong> ï¼šæ“ä½œæˆåŠŸå®Œæˆ</li>
<li><strong>rejectedï¼ˆå·²å¤±è´¥ï¼‰</strong> ï¼šæ“ä½œå¤±è´¥</li>
</ul>
<blockquote>
<p>âš ï¸ <strong>çŠ¶æ€ä¸å¯é€†</strong>ï¼š<br/>
ä¸€æ—¦ Promise ä» <code>pending</code> å˜ä¸º <code>fulfilled</code> æˆ– <code>rejected</code>ï¼ŒçŠ¶æ€å°†<strong>æ°¸ä¹…å›ºå®š</strong>ï¼Œä¸èƒ½å†æ”¹å˜ã€‚</p>
</blockquote>
<h3 data-id="heading-5">2.2 åˆ›å»º Promise</h3>
<p>ä½¿ç”¨ <code>new Promise(executor)</code> æ„é€ å‡½æ•°ï¼š</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> promise = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
  <span class="hljs-comment">// å¼‚æ­¥æ“ä½œ</span>
  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> success = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() &gt; <span class="hljs-number">0.5</span>;
    <span class="hljs-keyword">if</span> (success) {
      <span class="hljs-title function_">resolve</span>(<span class="hljs-string">'æ“ä½œæˆåŠŸï¼'</span>); <span class="hljs-comment">// å°†çŠ¶æ€å˜ä¸º fulfilled</span>
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'æ“ä½œå¤±è´¥ï¼'</span>)); <span class="hljs-comment">// å°†çŠ¶æ€å˜ä¸º rejected</span>
    }
  }, <span class="hljs-number">1000</span>);
});
</code></pre>
<ul>
<li><code>resolve(value)</code>ï¼šæ ‡è®° Promise æˆåŠŸï¼Œä¼ é€’ç»“æœå€¼</li>
<li><code>reject(reason)</code>ï¼šæ ‡è®° Promise å¤±è´¥ï¼Œä¼ é€’é”™è¯¯åŸå› ï¼ˆé€šå¸¸ä¸º Error å¯¹è±¡ï¼‰</li>
</ul>
<hr/>
<h2 data-id="heading-6">ä¸‰ã€Promise çš„åŸºæœ¬ç”¨æ³•</h2>
<h3 data-id="heading-7">3.1 é“¾å¼è°ƒç”¨ï¼ˆChainingï¼‰</h3>
<p>é€šè¿‡ <code>.then(onFulfilled, onRejected)</code> å¤„ç†ç»“æœï¼š</p>
<pre><code class="hljs language-javascript" lang="javascript">promise
  .<span class="hljs-title function_">then</span>(
    <span class="hljs-function"><span class="hljs-params">result</span> =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'æˆåŠŸ:'</span>, result); <span class="hljs-comment">// 'æ“ä½œæˆåŠŸï¼'</span>
      <span class="hljs-keyword">return</span> result.<span class="hljs-title function_">toUpperCase</span>(); <span class="hljs-comment">// è¿”å›æ–°å€¼ï¼Œä¼ é€’ç»™ä¸‹ä¸€ä¸ª then</span>
    },
    <span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'å¤±è´¥:'</span>, error); <span class="hljs-comment">// ä¸ä¼šæ‰§è¡Œï¼ˆé™¤éä¸Šä¸€æ­¥ rejectï¼‰</span>
    }
  )
  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">transformedResult</span> =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'è½¬æ¢å:'</span>, transformedResult); <span class="hljs-comment">// 'æ“ä½œæˆåŠŸï¼'</span>
  })
  .<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> {
    <span class="hljs-comment">// æ•è·é“¾ä¸­ä»»ä½•æœªå¤„ç†çš„ reject</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'æ•è·é”™è¯¯:'</span>, error);
  });
</code></pre>
<blockquote>
<p>âœ… <strong>å…³é”®è§„åˆ™</strong>ï¼š</p>
<ul>
<li><code>.then()</code> æ€»æ˜¯è¿”å›ä¸€ä¸ªæ–°çš„ Promise</li>
<li>è‹¥ <code>onFulfilled</code> è¿”å›æ™®é€šå€¼ â†’ æ–° Promise çŠ¶æ€ä¸º <code>fulfilled</code></li>
<li>è‹¥ <code>onFulfilled</code> æŠ›å‡ºå¼‚å¸¸ â†’ æ–° Promise çŠ¶æ€ä¸º <code>rejected</code></li>
<li>è‹¥ <code>onFulfilled</code> è¿”å›å¦ä¸€ä¸ª Promise â†’ æ–° Promise è·Ÿéšè¯¥ Promise çš„çŠ¶æ€</li>
</ul>
</blockquote>
<h3 data-id="heading-8">3.2 é”™è¯¯å¤„ç†ï¼š<code>.catch()</code></h3>
<p><code>.catch(onRejected)</code> æ˜¯ <code>.then(null, onRejected)</code> çš„è¯­æ³•ç³–ï¼š</p>
<pre><code class="hljs language-ini" lang="ini">fetchUserData()
  .then(<span class="hljs-attr">user</span> =&gt; processUser(user))
  .then(<span class="hljs-attr">data</span> =&gt; saveToCache(data))
  .catch(<span class="hljs-attr">error</span> =&gt; {
    // æ•è· fetchUserDataã€processUser æˆ– saveToCache ä¸­çš„ä»»ä½•é”™è¯¯
    console.error('æ“ä½œå¤±è´¥:', error.message)<span class="hljs-comment">;</span>
    showErrorMessage()<span class="hljs-comment">;</span>
  })<span class="hljs-comment">;</span>
</code></pre>
<blockquote>
<p>ğŸ“Œ <strong>æœ€ä½³å®è·µ</strong>ï¼š<br/>
åœ¨é“¾çš„æœ«å°¾ä½¿ç”¨ <code>.catch()</code> ç»Ÿä¸€å¤„ç†é”™è¯¯ï¼Œé¿å…åœ¨æ¯ä¸ª <code>.then()</code> ä¸­å†™é”™è¯¯å›è°ƒã€‚</p>
</blockquote>
<hr/>
<h2 data-id="heading-9">å››ã€Promise çš„é«˜çº§ç‰¹æ€§</h2>
<h3 data-id="heading-10">4.1 é™æ€æ–¹æ³•</h3>
<h4 data-id="heading-11"><code>Promise.resolve(value)</code></h4>
<p>å°†å€¼è½¬ä¸ºå·²æˆåŠŸçš„ Promiseï¼š</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-number">42</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">v</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(v)); <span class="hljs-comment">// 42</span>
<span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-string">'hello'</span>)).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">v</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(v)); <span class="hljs-comment">// 'hello'</span>
</code></pre>
<h4 data-id="heading-12"><code>Promise.reject(reason)</code></h4>
<p>åˆ›å»ºä¸€ä¸ªå·²å¤±è´¥çš„ Promiseï¼š</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'Oops!'</span>)).<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(e.<span class="hljs-property">message</span>));
</code></pre>
<h4 data-id="heading-13"><code>Promise.all(iterable)</code></h4>
<p><strong>å¹¶è¡Œæ‰§è¡Œå¤šä¸ª Promiseï¼Œå…¨éƒ¨æˆåŠŸæ‰æˆåŠŸ</strong>ï¼š</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">promises</span> = [
  fetch(<span class="hljs-string">'/api/users'</span>),
  fetch(<span class="hljs-string">'/api/posts'</span>),
  fetch(<span class="hljs-string">'/api/comments'</span>)
]<span class="hljs-comment">;</span>

Promise.all(promises)
  .then(<span class="hljs-attr">results</span> =&gt; {
    const <span class="hljs-section">[users, posts, comments]</span> = results<span class="hljs-comment">;</span>
    renderPage(users, posts, comments)<span class="hljs-comment">;</span>
  })
  .catch(<span class="hljs-attr">error</span> =&gt; {
    // ä»»ä¸€è¯·æ±‚å¤±è´¥ï¼Œç«‹å³ reject
    console.error('åŠ è½½å¤±è´¥:', error)<span class="hljs-comment">;</span>
  })<span class="hljs-comment">;</span>
</code></pre>
<blockquote>
<p>âš ï¸ <strong>æ³¨æ„</strong>ï¼šè‹¥ä»»ä¸€ Promise rejectï¼Œ<code>all</code> ç«‹å³ rejectï¼Œå…¶ä½™ Promise ä»ä¼šæ‰§è¡Œä½†ç»“æœè¢«å¿½ç•¥ã€‚</p>
</blockquote>
<h4 data-id="heading-14"><code>Promise.allSettled(iterable)</code></h4>
<p>ç­‰å¾…æ‰€æœ‰ Promise å®Œæˆï¼ˆæ— è®ºæˆåŠŸæˆ–å¤±è´¥ï¼‰ï¼š</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">allSettled</span>(promises)
  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">results</span> =&gt;</span> {
    results.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">result, i</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (result.<span class="hljs-property">status</span> === <span class="hljs-string">'fulfilled'</span>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`è¯·æ±‚ <span class="hljs-subst">${i}</span> æˆåŠŸ:`</span>, result.<span class="hljs-property">value</span>);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`è¯·æ±‚ <span class="hljs-subst">${i}</span> å¤±è´¥:`</span>, result.<span class="hljs-property">reason</span>);
      }
    });
  });
</code></pre>
<h4 data-id="heading-15"><code>Promise.race(iterable)</code></h4>
<p><strong>è¿”å›ç¬¬ä¸€ä¸ªå®Œæˆçš„ Promiseï¼ˆæ— è®ºæˆåŠŸæˆ–å¤±è´¥ï¼‰</strong> ï¼š</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> timeout = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">_, reject</span>) =&gt;</span>
  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'è¶…æ—¶'</span>)), <span class="hljs-number">5000</span>)
);

<span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">race</span>([<span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/data'</span>), timeout])
  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'æ•°æ®:'</span>, data))
  .<span class="hljs-keyword">catch</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'å¤±è´¥æˆ–è¶…æ—¶:'</span>, error));
</code></pre>
<h4 data-id="heading-16"><code>Promise.any(iterable)</code>ï¼ˆES2021ï¼‰</h4>
<p>è¿”å›ç¬¬ä¸€ä¸ª<strong>æˆåŠŸ</strong>çš„ Promiseï¼ˆå¿½ç•¥å¤±è´¥ï¼‰ï¼š</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">any</span>([
  <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(<span class="hljs-string">'A å¤±è´¥'</span>),
  <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-string">'B æˆåŠŸ'</span>),
  <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(<span class="hljs-string">'C å¤±è´¥'</span>)
]).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(value)); <span class="hljs-comment">// 'B æˆåŠŸ'</span>
</code></pre>
<blockquote>
<p>â— è‹¥å…¨éƒ¨å¤±è´¥ï¼Œåˆ™ reject ä¸€ä¸ª <code>AggregateError</code>ã€‚</p>
</blockquote>
<hr/>
<h2 data-id="heading-17">äº”ã€Promise ä¸ async/await</h2>
<p><code>async/await</code> æ˜¯ Promise çš„è¯­æ³•ç³–ï¼Œä½¿å¼‚æ­¥ä»£ç çœ‹èµ·æ¥åƒåŒæ­¥ä»£ç ã€‚</p>
<h3 data-id="heading-18">5.1 åŸºæœ¬ç”¨æ³•</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchData</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/data'</span>);
    <span class="hljs-keyword">if</span> (!response.<span class="hljs-property">ok</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'è¯·æ±‚å¤±è´¥'</span>);
    <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> response.<span class="hljs-title function_">json</span>();
    <span class="hljs-keyword">return</span> data;
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'é”™è¯¯:'</span>, error);
    <span class="hljs-keyword">throw</span> error; <span class="hljs-comment">// å¯é€‰æ‹©é‡æ–°æŠ›å‡º</span>
  }
}

<span class="hljs-comment">// è°ƒç”¨</span>
<span class="hljs-title function_">fetchData</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data));
</code></pre>
<h3 data-id="heading-19">5.2 å…³é”®è§„åˆ™</h3>
<ul>
<li><code>async</code> å‡½æ•°<strong>æ€»æ˜¯è¿”å› Promise</strong></li>
<li><code>await</code> åªèƒ½åœ¨ <code>async</code> å‡½æ•°å†…ä½¿ç”¨</li>
<li><code>await</code> åå¯è·Ÿ Promise æˆ–æ™®é€šå€¼</li>
<li>é”™è¯¯å¯é€šè¿‡ <code>try/catch</code> æ•è·</li>
</ul>
<h3 data-id="heading-20">5.3 å¹¶è¡Œ vs ä¸²è¡Œ</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// âŒ ä¸²è¡Œï¼ˆæ…¢ï¼‰</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">slow</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> a = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/a'</span>);
  <span class="hljs-keyword">const</span> b = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/b'</span>);
  <span class="hljs-keyword">const</span> c = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/c'</span>);
}

<span class="hljs-comment">// âœ… å¹¶è¡Œï¼ˆå¿«ï¼‰</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fast</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [a, b, c] = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>([
    <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/a'</span>),
    <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/b'</span>),
    <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/c'</span>)
  ]);
}
</code></pre>
<hr/>
<h2 data-id="heading-21">å…­ã€å¸¸è§é™·é˜±ä¸æœ€ä½³å®è·µ</h2>
<h3 data-id="heading-22">6.1 é™·é˜± 1ï¼šå¿˜è®°è¿”å› Promise</h3>
<pre><code class="hljs language-ini" lang="ini">// âŒ é”™è¯¯ï¼šç¬¬äºŒä¸ª then æ— æ³•è·å–æ•°æ®
fetch('/api')
  .then(<span class="hljs-attr">res</span> =&gt; res.json())
  .then(<span class="hljs-attr">data</span> =&gt; {
    processData(data)<span class="hljs-comment">; // å¿˜è®° return</span>
  })
  .then(<span class="hljs-attr">result</span> =&gt; {
    console.log(result)<span class="hljs-comment">; // undefined!</span>
  })<span class="hljs-comment">;</span>

// âœ… æ­£ç¡®
fetch('/api')
  .then(<span class="hljs-attr">res</span> =&gt; res.json())
  .then(<span class="hljs-attr">data</span> =&gt; {
    return processData(data)<span class="hljs-comment">; // æ˜¾å¼ return</span>
  })<span class="hljs-comment">;</span>
</code></pre>
<h3 data-id="heading-23">6.2 é™·é˜± 2ï¼šæœªå¤„ç†æ‹’ç»ï¼ˆUncaught Rejectionï¼‰</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// âŒ å±é™©ï¼šå¯èƒ½è¢«å¿½ç•¥ï¼Œå¯¼è‡´é™é»˜å¤±è´¥</span>
somePromise.<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">result</span> =&gt;</span> {
  <span class="hljs-comment">// ...</span>
});

<span class="hljs-comment">// âœ… å®‰å…¨ï¼šå§‹ç»ˆå¤„ç†é”™è¯¯</span>
somePromise
  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">result</span> =&gt;</span> { <span class="hljs-comment">/* ... */</span> })
  .<span class="hljs-keyword">catch</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> { <span class="hljs-comment">/* å¤„ç†é”™è¯¯ */</span> });
</code></pre>
<blockquote>
<p>ğŸ”” <strong>Node.js æç¤º</strong>ï¼šæœªå¤„ç†çš„ Promise rejection ä¼šå¯¼è‡´è¿›ç¨‹è­¦å‘Šï¼ˆæœªæ¥å¯èƒ½ç»ˆæ­¢è¿›ç¨‹ï¼‰ã€‚</p>
</blockquote>
<h3 data-id="heading-24">6.3 é™·é˜± 3ï¼šåœ¨å¾ªç¯ä¸­ä½¿ç”¨ awaitï¼ˆä¸²è¡Œè€Œéå¹¶è¡Œï¼‰</h3>
<pre><code class="hljs language-ini" lang="ini">// âŒ ä¸²è¡Œæ‰§è¡Œï¼ˆæ€»è€—æ—¶ = æ‰€æœ‰è¯·æ±‚æ—¶é—´ä¹‹å’Œï¼‰
for (const url of urls) {
  const <span class="hljs-attr">data</span> = await fetch(url)<span class="hljs-comment">;</span>
  results.push(data)<span class="hljs-comment">;</span>
}

// âœ… å¹¶è¡Œæ‰§è¡Œï¼ˆæ€»è€—æ—¶ â‰ˆ æœ€é•¿è¯·æ±‚æ—¶é—´ï¼‰
const <span class="hljs-attr">promises</span> = urls.map(url =&gt; fetch(url))<span class="hljs-comment">;</span>
const <span class="hljs-attr">results</span> = await Promise.all(promises)<span class="hljs-comment">;</span>
</code></pre>
<h3 data-id="heading-25">6.4 æœ€ä½³å®è·µ</h3>
<ol>
<li><strong>å§‹ç»ˆå¤„ç†é”™è¯¯</strong>ï¼šä½¿ç”¨ <code>.catch()</code> æˆ– <code>try/catch</code></li>
<li><strong>é¿å…åµŒå¥— Promise</strong>ï¼šä½¿ç”¨é“¾å¼è°ƒç”¨æˆ– async/await</li>
<li><strong>æ˜ç¡®è¿”å›å€¼</strong>ï¼šåœ¨ <code>.then()</code> ä¸­æ˜¾å¼ <code>return</code></li>
<li><strong>åˆç†ä½¿ç”¨ç»„åˆæ–¹æ³•</strong>ï¼š<code>all</code>ã€<code>race</code>ã€<code>allSettled</code></li>
<li><strong>ä¸è¦æ··åˆå›è°ƒä¸ Promise</strong>ï¼šç»Ÿä¸€å¼‚æ­¥é£æ ¼</li>
</ol>
<hr/>
<h2 data-id="heading-26">ä¸ƒã€Promise çš„å†…éƒ¨åŸç†ï¼ˆç®€è¦ï¼‰</h2>
<p>è™½ç„¶å¼€å‘è€…é€šå¸¸æ— éœ€å®ç° Promiseï¼Œä½†ç†è§£å…¶æœºåˆ¶æœ‰åŠ©äºè°ƒè¯•ï¼š</p>
<pre><code class="hljs language-ini" lang="ini">// æç®€ Promise å®ç°ï¼ˆä»…æ¼”ç¤ºæ€è·¯ï¼‰
class SimplePromise {
  constructor(executor) {
    <span class="hljs-attr">this.state</span> = <span class="hljs-string">'pending'</span><span class="hljs-comment">;</span>
    <span class="hljs-attr">this.value</span> = undefined<span class="hljs-comment">;</span>
    <span class="hljs-attr">this.callbacks</span> = []<span class="hljs-comment">;</span>

    const <span class="hljs-attr">resolve</span> = value =&gt; {
      if (this.state !== 'pending') return<span class="hljs-comment">;</span>
      <span class="hljs-attr">this.state</span> = <span class="hljs-string">'fulfilled'</span><span class="hljs-comment">;</span>
      <span class="hljs-attr">this.value</span> = value<span class="hljs-comment">;</span>
      this.callbacks.forEach(<span class="hljs-attr">cb</span> =&gt; cb())<span class="hljs-comment">;</span>
    }<span class="hljs-comment">;</span>

    const <span class="hljs-attr">reject</span> = reason =&gt; {
      if (this.state !== 'pending') return<span class="hljs-comment">;</span>
      <span class="hljs-attr">this.state</span> = <span class="hljs-string">'rejected'</span><span class="hljs-comment">;</span>
      <span class="hljs-attr">this.value</span> = reason<span class="hljs-comment">;</span>
      this.callbacks.forEach(<span class="hljs-attr">cb</span> =&gt; cb())<span class="hljs-comment">;</span>
    }<span class="hljs-comment">;</span>

    executor(resolve, reject)<span class="hljs-comment">;</span>
  }

  then(onFulfilled) {
    return new SimplePromise((resolve) =&gt; {
      const <span class="hljs-attr">callback</span> = () =&gt; {
        if (<span class="hljs-attr">this.state</span> === <span class="hljs-string">'fulfilled'</span>) {
          const <span class="hljs-attr">result</span> = <span class="hljs-literal">on</span>Fulfilled(this.value)<span class="hljs-comment">;</span>
          resolve(result)<span class="hljs-comment">;</span>
        }
      }<span class="hljs-comment">;</span>
      if (<span class="hljs-attr">this.state</span> === <span class="hljs-string">'pending'</span>) {
        this.callbacks.push(callback)<span class="hljs-comment">;</span>
      } else {
        callback()<span class="hljs-comment">;</span>
      }
    })<span class="hljs-comment">;</span>
  }
}
</code></pre>
<blockquote>
<p>ğŸ“š <strong>çœŸå® Promise æ›´å¤æ‚</strong>ï¼šéœ€å¤„ç†å¾®ä»»åŠ¡é˜Ÿåˆ—ï¼ˆMicrotask Queueï¼‰ã€thenable å¯¹è±¡ã€é€’å½’è§£æç­‰ã€‚</p>
</blockquote>
<hr/>
<h2 data-id="heading-27">å…«ã€åœ¨ Vue 3 ä¸­çš„å®è·µ</h2>
<p>Vue 3 çš„ç»„åˆå¼ API ä¸ Promise å¤©ç„¶å¥‘åˆï¼š</p>
<pre><code class="hljs language-ini" lang="ini">// composables/useApi.js
import { ref } from 'vue'<span class="hljs-comment">;</span>

export function useApi(url) {
  const <span class="hljs-attr">data</span> = ref(null)<span class="hljs-comment">;</span>
  const <span class="hljs-attr">loading</span> = ref(<span class="hljs-literal">false</span>)<span class="hljs-comment">;</span>
  const <span class="hljs-attr">error</span> = ref(null)<span class="hljs-comment">;</span>

  const <span class="hljs-attr">execute</span> = async () =&gt; {
    <span class="hljs-attr">loading.value</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
    <span class="hljs-attr">error.value</span> = null<span class="hljs-comment">;</span>
    try {
      const <span class="hljs-attr">res</span> = await fetch(url)<span class="hljs-comment">;</span>
      if (!res.ok) throw new Error(res.statusText)<span class="hljs-comment">;</span>
      <span class="hljs-attr">data.value</span> = await res.json()<span class="hljs-comment">;</span>
    } catch (err) {
      <span class="hljs-attr">error.value</span> = err<span class="hljs-comment">;</span>
    } finally {
      <span class="hljs-attr">loading.value</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
    }
  }<span class="hljs-comment">;</span>

  return { data, loading, error, execute }<span class="hljs-comment">;</span>
}
</code></pre>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { useApi } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/composables/useApi'</span>;

<span class="hljs-keyword">const</span> { data, loading, error, execute } = <span class="hljs-title function_">useApi</span>(<span class="hljs-string">'/api/users'</span>);
<span class="hljs-title function_">execute</span>();
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"loading"</span>&gt;</span>åŠ è½½ä¸­...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-else-if</span>=<span class="hljs-string">"error"</span>&gt;</span>é”™è¯¯: {{ error.message }}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">ul</span> <span class="hljs-attr">v-else</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">"user in data"</span> <span class="hljs-attr">:key</span>=<span class="hljs-string">"user.id"</span>&gt;</span>{{ user.name }}<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
</code></pre>
<blockquote>
<p>âœ… <strong>ä¼˜åŠ¿</strong>ï¼šé€»è¾‘å¤ç”¨ã€çŠ¶æ€ç®¡ç†ã€é”™è¯¯å¤„ç†ä¸€ä½“åŒ–ã€‚</p>
</blockquote>
<hr/>
<h2 data-id="heading-28">ç»“è¯­</h2>
<p>Promise æ˜¯ JavaScript å¼‚æ­¥ç¼–ç¨‹çš„é‡Œç¨‹ç¢‘ï¼Œå®ƒä¸ä»…è§£å†³äº†å›è°ƒåœ°ç‹±é—®é¢˜ï¼Œè¿˜ä¸ºç°ä»£å¼‚æ­¥è¯­æ³•ï¼ˆasync/awaitï¼‰å¥ å®šäº†åŸºç¡€ã€‚æŒæ¡ Promise çš„æ ¸å¿ƒæ¦‚å¿µã€é“¾å¼è°ƒç”¨ã€é”™è¯¯å¤„ç†å’Œç»„åˆæ–¹æ³•ï¼Œæ˜¯æˆä¸ºé«˜æ•ˆå‰ç«¯å¼€å‘è€…çš„å¿…ç»ä¹‹è·¯ã€‚</p>
<p>è®°ä½ï¼š</p>
<ul>
<li><strong>Promise æ˜¯çŠ¶æ€æœº</strong>ï¼špending â†’ fulfilled/rejected</li>
<li><strong>é“¾å¼è°ƒç”¨æ˜¯æ ¸å¿ƒ</strong>ï¼šæ¯ä¸ª <code>.then()</code> è¿”å›æ–° Promise</li>
<li><strong>é”™è¯¯å¿…é¡»å¤„ç†</strong>ï¼šé¿å…é™é»˜å¤±è´¥</li>
<li><strong>ç»„åˆä¼˜äºåµŒå¥—</strong>ï¼šå–„ç”¨ <code>Promise.all</code> ç­‰é™æ€æ–¹æ³•</li>
</ul>
<p>éšç€ Web åº”ç”¨æ—¥ç›Šå¤æ‚ï¼Œå¼‚æ­¥æ“ä½œæ— å¤„ä¸åœ¨ã€‚</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Koa æºç æ·±åº¦è§£æï¼šå¸¦ä½ ç†è§£ Koa çš„è®¾è®¡å“²å­¦å’Œæ ¸å¿ƒå®ç°åŸç†]]></title>    <link>https://juejin.cn/post/7585412203978833963</link>    <guid>https://juejin.cn/post/7585412203978833963</guid>    <pubDate>2025-12-20T08:42:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585412203978833963" data-draft-id="7585390679399301126" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Koa æºç æ·±åº¦è§£æï¼šå¸¦ä½ ç†è§£ Koa çš„è®¾è®¡å“²å­¦å’Œæ ¸å¿ƒå®ç°åŸç†"/> <meta itemprop="keywords" content="Node.js"/> <meta itemprop="datePublished" content="2025-12-20T08:42:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="è¶´åœ¨çª—è¾¹æ•°æ˜Ÿæ˜Ÿ"/> <meta itemprop="url" content="https://juejin.cn/user/2283029051479357"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="æ˜é‡‘"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Koa æºç æ·±åº¦è§£æï¼šå¸¦ä½ ç†è§£ Koa çš„è®¾è®¡å“²å­¦å’Œæ ¸å¿ƒå®ç°åŸç†
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2283029051479357/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    è¶´åœ¨çª—è¾¹æ•°æ˜Ÿæ˜Ÿ
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T08:42:40.000Z" title="Sat Dec 20 2025 08:42:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    é˜…è¯»10åˆ†é’Ÿ
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Koa æºç æ·±åº¦è§£æï¼šå¸¦ä½ ç†è§£ Koa çš„è®¾è®¡å“²å­¦å’Œæ ¸å¿ƒå®ç°åŸç†</h2>
<blockquote>
<p>æ³¨ï¼šæœ¬æ–‡åªè®²koaæºç ä¸æ ¸å¿ƒå®ç°ï¼Œæ— åº”ç”¨å±‚ç›¸å…³çŸ¥è¯†</p>
</blockquote>
<h3 data-id="heading-1">ä¸€ã€Koa çš„è®¾è®¡å“²å­¦</h3>
<h4 data-id="heading-2">1.1 ä»€ä¹ˆæ˜¯koa</h4>
<p>Koa æ˜¯ç”± Express åŸç­äººé©¬æ‰“é€ çš„ä¸‹ä¸€ä»£ Node.js Web æ¡†æ¶ã€‚ç›¸æ¯”äº Expressï¼ŒKoa åˆ©ç”¨ ES2017 çš„ async/await ç‰¹æ€§ï¼Œè®©å¼‚æ­¥ä»£ç çš„ç¼–å†™å˜å¾—æ›´åŠ ä¼˜é›…å’Œå¯ç»´æŠ¤ã€‚æœ¬æ–‡å°†æ·±å…¥è§£æ Koa çš„æ ¸å¿ƒæºç ï¼Œå¸®åŠ©ä½ ç†è§£å…¶è®¾è®¡å“²å­¦å’Œå®ç°åŸç†ã€‚</p>
<h4 data-id="heading-3">1.2 æ ¸å¿ƒè®¾è®¡ç†å¿µ</h4>
<p>Koa çš„è®¾è®¡ç†å¿µå¯ä»¥æ¦‚æ‹¬ä¸ºï¼š</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Koa åº”ç”¨æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªåŒ…å«ä¸­é—´ä»¶å‡½æ•°æ•°ç»„çš„å¯¹è±¡</span>
<span class="hljs-comment">// è¿™äº›ä¸­é—´ä»¶ä»¥ç±»ä¼¼æ ˆçš„æ–¹å¼ç»„åˆå’Œæ‰§è¡Œ</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">Koa</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">'koa'</span>);
<span class="hljs-keyword">const</span> app = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Koa</span>();

<span class="hljs-comment">// ä¸­é—´ä»¶ä»¥"æ´‹è‘±æ¨¡å‹"æ–¹å¼æ‰§è¡Œ</span>
app.<span class="hljs-title function_">use</span>(<span class="hljs-keyword">async</span> (ctx, next) =&gt; {
  <span class="hljs-comment">// è¯·æ±‚é˜¶æ®µï¼ˆå‘ä¸‹ï¼‰</span>
  <span class="hljs-keyword">await</span> <span class="hljs-title function_">next</span>();
  <span class="hljs-comment">// å“åº”é˜¶æ®µï¼ˆå‘ä¸Šï¼‰</span>
});
</code></pre>
<p>å®˜æ–¹æ–‡æ¡£è¿™æ ·æè¿°ï¼š</p>
<blockquote>
<p>A Koa application is an object containing an array of middleware functions which are composed and executed in a stack-like manner upon request.</p>
</blockquote>
<h3 data-id="heading-4">äºŒã€æºç æ ¸å¿ƒæµç¨‹è§£æ</h3>
<p>åœ¨æ·±å…¥æºç ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆç†è§£ä¸€ä¸‹ Koa åº”ç”¨ä»åˆ›å»ºåˆ°å¤„ç†è¯·æ±‚çš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸã€‚ä¸€ä¸ªå…¸å‹çš„ Koa åº”ç”¨ä¼šç»å†ä»¥ä¸‹å‡ ä¸ªé˜¶æ®µï¼š</p>
<ol>
<li><strong>åˆ›å»ºåº”ç”¨å®ä¾‹</strong> - <code>new Koa()</code> åˆå§‹åŒ–åº”ç”¨å¯¹è±¡</li>
<li><strong>æ³¨å†Œä¸­é—´ä»¶</strong> - <code>app.use()</code> å°†ä¸­é—´ä»¶å‡½æ•°æ·»åŠ åˆ°æ•°ç»„</li>
<li><strong>å¯åŠ¨ç›‘å¬</strong> - <code>app.listen()</code> åˆ›å»º HTTP æœåŠ¡å¹¶å¼€å§‹ç›‘å¬</li>
<li><strong>å¤„ç†è¯·æ±‚</strong> - å½“è¯·æ±‚åˆ°æ¥æ—¶ï¼Œç»„åˆä¸­é—´ä»¶å¹¶æ‰§è¡Œ</li>
</ol>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬é€æ­¥å‰–ææ¯ä¸ªé˜¶æ®µçš„æºç å®ç°ã€‚</p>
<h4 data-id="heading-5">2.1 åˆ›å»ºApplication</h4>
<p>å½“æˆ‘ä»¬æ‰§è¡Œ <code>const app = new Koa()</code> æ—¶ï¼ŒKoa å†…éƒ¨åšäº†å“ªäº›åˆå§‹åŒ–å·¥ä½œå‘¢ï¼Ÿè®©æˆ‘ä»¬çœ‹çœ‹ <code>Application</code> ç±»çš„æ„é€ å‡½æ•°ï¼š</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Application</span> {

  <span class="hljs-title function_">constructor</span> (options) {
    ......
    options = options || {}
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">compose</span> = options.<span class="hljs-property">compose</span> || compose <span class="hljs-comment">// ç»„åˆä¸­é—´ä»¶çš„å‡½æ•°ï¼Œè¿™æ˜¯å®ç°æ´‹è‘±æ¨¡å‹çš„å…³é”®</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">middleware</span> = []                      <span class="hljs-comment">// ä¸­é—´ä»¶æ•°ç»„ï¼Œæ‰€æœ‰é€šè¿‡ use() æ³¨å†Œçš„ä¸­é—´ä»¶éƒ½ä¼šå­˜å‚¨åœ¨è¿™é‡Œ</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span> = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(context)     <span class="hljs-comment">// ä¸Šä¸‹æ–‡å¯¹è±¡çš„åŸå‹ï¼Œæ¯ä¸ªè¯·æ±‚ä¼šåŸºäºå®ƒåˆ›å»ºç‹¬ç«‹çš„ ctx</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">request</span> = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(request)     <span class="hljs-comment">// è¯·æ±‚å¯¹è±¡çš„åŸå‹ï¼Œå°è£…äº†å¯¹ Node.js åŸç”Ÿ req çš„è®¿é—®</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">response</span> = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(response);  <span class="hljs-comment">// å“åº”å¯¹è±¡çš„åŸå‹ï¼Œå°è£…äº†å¯¹ Node.js åŸç”Ÿ res çš„è®¿é—®</span>
    ......
   }
</code></pre>
<p><strong>ä¸ºä»€ä¹ˆä½¿ç”¨ <code>Object.create()</code> è€Œä¸æ˜¯ç›´æ¥èµ‹å€¼ï¼Ÿ</strong></p>
<p>è¿™æ˜¯ä¸€ä¸ªéå¸¸å·§å¦™çš„è®¾è®¡ã€‚ä½¿ç”¨ <code>Object.create()</code> åˆ›å»ºåŸå‹é“¾ï¼Œæ„å‘³ç€ï¼š</p>
<ul>
<li>æ¯ä¸ªåº”ç”¨å®ä¾‹éƒ½æœ‰è‡ªå·±ç‹¬ç«‹çš„ <code>context</code>ã€<code>request</code>ã€<code>response</code> å¯¹è±¡</li>
<li>è¿™äº›å¯¹è±¡ç»§æ‰¿è‡ªå…±äº«çš„åŸå‹ï¼Œæ—¢èŠ‚çœå†…å­˜åˆä¿è¯äº†éš”ç¦»æ€§</li>
<li>å¯ä»¥åœ¨ä¸åŒåº”ç”¨å®ä¾‹ä¸ŠæŒ‚è½½ä¸åŒçš„æ‰©å±•å±æ€§ï¼Œäº’ä¸å½±å“</li>
</ul>
<h4 data-id="heading-6">2.2 æ³¨å†Œä¸­é—´ä»¶</h4>
<p>ä¸­é—´ä»¶æ˜¯ Koa çš„æ ¸å¿ƒæ¦‚å¿µã€‚é€šè¿‡ <code>app.use()</code> æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥æ³¨å†Œå„ç§ä¸­é—´ä»¶æ¥å¤„ç†è¯·æ±‚ã€‚è®©æˆ‘ä»¬çœ‹ä¸€ä¸ªå®é™…ä¾‹å­ï¼š</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// è¯·æ±‚æ—¥å¿—ä¸­é—´ä»¶ï¼šè®°å½•è¯·æ±‚çš„ URL å’Œå“åº”æ—¶é—´</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">logMiddleware</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">ctx, next</span>) =&gt; {
  <span class="hljs-keyword">const</span> start = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();  <span class="hljs-comment">// è®°å½•å¼€å§‹æ—¶é—´</span>
  <span class="hljs-keyword">await</span> <span class="hljs-title function_">next</span>();              <span class="hljs-comment">// ç­‰å¾…åç»­ä¸­é—´ä»¶æ‰§è¡Œå®Œæ¯•</span>
  <span class="hljs-keyword">const</span> end = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();    <span class="hljs-comment">// è®°å½•ç»“æŸæ—¶é—´</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${ctx.method}</span> <span class="hljs-subst">${ctx.url}</span> - <span class="hljs-subst">${end - start}</span>ms`</span>);
};

app.<span class="hljs-title function_">use</span>(logMiddleware);

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Application</span> {
  <span class="hljs-title function_">use</span>(<span class="hljs-params">fn</span>) {
    <span class="hljs-comment">// æ³¨å†Œä¸­é—´ä»¶ï¼šå°†ä¸­é—´ä»¶å‡½æ•°æ·»åŠ åˆ°æ•°ç»„æœ«å°¾</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">middleware</span>.<span class="hljs-title function_">push</span>(fn);
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>; <span class="hljs-comment">// è¿”å› this æ”¯æŒé“¾å¼è°ƒç”¨</span>
  }
}
</code></pre>
<p><strong><code>use()</code> æ–¹æ³•çš„è®¾è®¡äº®ç‚¹ï¼š</strong></p>
<ol>
<li><strong>ç®€å•ç›´æ¥</strong> - åªæ˜¯å°†ä¸­é—´ä»¶å‡½æ•° push åˆ°æ•°ç»„ï¼Œæ²¡æœ‰å¤æ‚çš„é€»è¾‘</li>
<li><strong>é“¾å¼è°ƒç”¨</strong> - è¿”å› <code>this</code> ä½¿å¾—å¯ä»¥è¿ç»­è°ƒç”¨ <code>app.use().use().use()</code></li>
<li><strong>é¡ºåºæ•æ„Ÿ</strong> - ä¸­é—´ä»¶çš„æ‰§è¡Œé¡ºåºå–å†³äºæ³¨å†Œé¡ºåºï¼Œè¿™å¯¹ç†è§£æ´‹è‘±æ¨¡å‹å¾ˆé‡è¦</li>
</ol>
<p>æ³¨æ„ä¸Šé¢çš„æ—¥å¿—ä¸­é—´ä»¶ç¤ºä¾‹ï¼š<code>await next()</code> æ˜¯ä¸€ä¸ªåˆ†æ°´å²­ï¼Œå®ƒå°†ä¸­é—´ä»¶åˆ†ä¸º"è¯·æ±‚é˜¶æ®µ"å’Œ"å“åº”é˜¶æ®µ"ã€‚è¿™æ­£æ˜¯æ´‹è‘±æ¨¡å‹çš„ç²¾é«“æ‰€åœ¨ã€‚</p>
<h4 data-id="heading-7">2.3 åˆ›å»ºcontext</h4>
<p>æ¯å½“æœ‰æ–°çš„ HTTP è¯·æ±‚åˆ°æ¥æ—¶ï¼ŒKoa éƒ½ä¼šä¸ºè¿™ä¸ªè¯·æ±‚åˆ›å»ºä¸€ä¸ªå…¨æ–°çš„ <code>context</code> å¯¹è±¡ã€‚è¿™ä¸ªå¯¹è±¡æ˜¯ Koa æœ€é‡è¦çš„åˆ›æ–°ä¹‹ä¸€ï¼Œå®ƒå°è£…äº† Node.js åŸç”Ÿçš„ <code>req</code> å’Œ <code>res</code>ï¼Œæä¾›äº†æ›´åŠ ä¾¿æ·çš„ APIã€‚</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">createContext</span>(<span class="hljs-params">req, res</span>) {
  <span class="hljs-comment">// åŸºäºåº”ç”¨çš„ context åŸå‹åˆ›å»ºæ–°çš„ context å®ä¾‹</span>
  <span class="hljs-keyword">const</span> context = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>);
  <span class="hljs-comment">// åŸºäºåº”ç”¨çš„ request å’Œ response åŸå‹åˆ›å»ºæ–°çš„å®ä¾‹</span>
  <span class="hljs-keyword">const</span> request = context.<span class="hljs-property">request</span> = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">request</span>);
  <span class="hljs-keyword">const</span> response = context.<span class="hljs-property">response</span> = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">response</span>);

  <span class="hljs-comment">// å»ºç«‹å„å¯¹è±¡ä¹‹é—´çš„å¼•ç”¨å…³ç³»</span>
  context.<span class="hljs-property">app</span> = request.<span class="hljs-property">app</span> = response.<span class="hljs-property">app</span> = <span class="hljs-variable language_">this</span>;        <span class="hljs-comment">// éƒ½æŒæœ‰ app å®ä¾‹çš„å¼•ç”¨</span>
  context.<span class="hljs-property">req</span> = request.<span class="hljs-property">req</span> = response.<span class="hljs-property">req</span> = req;         <span class="hljs-comment">// éƒ½æŒæœ‰ Node.js åŸç”Ÿ req çš„å¼•ç”¨</span>
  context.<span class="hljs-property">res</span> = request.<span class="hljs-property">res</span> = response.<span class="hljs-property">res</span> = res;         <span class="hljs-comment">// éƒ½æŒæœ‰ Node.js åŸç”Ÿ res çš„å¼•ç”¨</span>

  <span class="hljs-comment">// å»ºç«‹ contextã€requestã€response ä¹‹é—´çš„ç›¸äº’å¼•ç”¨</span>
  request.<span class="hljs-property">ctx</span> = response.<span class="hljs-property">ctx</span> = context;                   <span class="hljs-comment">// request å’Œ response éƒ½èƒ½è®¿é—® context</span>
  request.<span class="hljs-property">response</span> = response;                            <span class="hljs-comment">// request èƒ½è®¿é—® response</span>
  response.<span class="hljs-property">request</span> = request;                             <span class="hljs-comment">// response èƒ½è®¿é—® request</span>

  <span class="hljs-keyword">return</span> context;
}

</code></pre>
<p><strong>è¿™ä¸ªæ–¹æ³•çš„ç²¾å¦™ä¹‹å¤„ï¼š</strong></p>
<ol>
<li><strong>åŸå‹ç»§æ‰¿</strong> - ä½¿ç”¨ <code>Object.create()</code> ç¡®ä¿æ¯ä¸ªè¯·æ±‚éƒ½æœ‰ç‹¬ç«‹çš„ contextï¼Œä½†å…±äº«åŸå‹ä¸Šçš„æ–¹æ³•</li>
<li><strong>å››å±‚å°è£…</strong> - <code>context</code> â†’ <code>request/response</code> â†’ <code>req/res</code>ï¼Œé€å±‚æŠ½è±¡ï¼Œæä¾›æ›´ä¼˜é›…çš„ API</li>
<li><strong>ç›¸äº’å¼•ç”¨</strong> - å»ºç«‹äº†å¤æ‚ä½†åˆç†çš„å¼•ç”¨å…³ç³»ï¼Œä½¿å¾—åœ¨ä»»ä½•å±‚çº§éƒ½èƒ½æ–¹ä¾¿åœ°è®¿é—®å…¶ä»–å¯¹è±¡</li>
<li><strong>å†…å­˜ä¼˜åŒ–</strong> - é€šè¿‡åŸå‹é“¾å…±äº«æ–¹æ³•ï¼Œé¿å…æ¯ä¸ªè¯·æ±‚éƒ½åˆ›å»ºé‡å¤çš„æ–¹æ³•å‰¯æœ¬</li>
</ol>
<p>è¿™æ ·è®¾è®¡çš„å¥½å¤„æ˜¯ï¼Œåœ¨ä¸­é—´ä»¶ä¸­æˆ‘ä»¬å¯ä»¥çµæ´»åœ°è®¿é—®ï¼š</p>
<ul>
<li><code>ctx.req</code> / <code>ctx.res</code> - è®¿é—® Node.js åŸç”Ÿå¯¹è±¡</li>
<li><code>ctx.request</code> / <code>ctx.response</code> - è®¿é—® Koa å°è£…çš„å¯¹è±¡</li>
<li><code>ctx.body</code> / <code>ctx.status</code> - ä½¿ç”¨ Koa çš„ä¾¿æ·å±æ€§ï¼ˆä»£ç†åˆ° responseï¼‰</li>
</ul>
<h4 data-id="heading-8">2.4 å¯åŠ¨ç›‘å¬æœåŠ¡</h4>
<p>å½“æ‰€æœ‰ä¸­é—´ä»¶æ³¨å†Œå®Œæˆåï¼Œæˆ‘ä»¬éœ€è¦å¯åŠ¨ HTTP æœåŠ¡å™¨å¼€å§‹ç›‘å¬è¯·æ±‚ã€‚</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ç”¨æˆ·ä»£ç ï¼šå¯åŠ¨æœåŠ¡å™¨</span>
app.<span class="hljs-title function_">listen</span>(<span class="hljs-number">3000</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Server is running on port 3000'</span>);
});

<span class="hljs-comment">// Koa å†…éƒ¨å®ç°</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Application</span> {
  listen (...args) {
    <span class="hljs-title function_">debug</span>(<span class="hljs-string">'listen'</span>)
    <span class="hljs-comment">// åˆ›å»º Node.js HTTP æœåŠ¡å™¨ï¼Œä¼ å…¥ callback ä½œä¸ºè¯·æ±‚å¤„ç†å‡½æ•°</span>
    <span class="hljs-keyword">const</span> server = http.<span class="hljs-title function_">createServer</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">callback</span>())
    <span class="hljs-keyword">return</span> server.<span class="hljs-title function_">listen</span>(...args) <span class="hljs-comment">// è¿”å› Node.js çš„ http.Server å®ä¾‹</span>
  }

  <span class="hljs-comment">// callback æ–¹æ³•è¿”å›ä¸€ä¸ªç¬¦åˆ Node.js http.createServer è¦æ±‚çš„è¯·æ±‚å¤„ç†å‡½æ•°</span>
  <span class="hljs-title function_">callback</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// â­ï¸ æ ¸å¿ƒï¼šä½¿ç”¨ compose å°†æ‰€æœ‰ä¸­é—´ä»¶ç»„åˆæˆä¸€ä¸ªå‡½æ•°</span>
    <span class="hljs-comment">// è¿™å°±æ˜¯æ´‹è‘±æ¨¡å‹çš„å®ç°å…¥å£ï¼</span>
    <span class="hljs-keyword">const</span> fn = <span class="hljs-title function_">compose</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">middleware</span>);

    <span class="hljs-comment">// å¦‚æœæ²¡æœ‰ç›‘å¬ error äº‹ä»¶ï¼Œæ·»åŠ é»˜è®¤çš„é”™è¯¯å¤„ç†å™¨</span>
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">listenerCount</span>(<span class="hljs-string">'error'</span>)) <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'error'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">onerror</span>);

    <span class="hljs-comment">// è¿”å›è¯·æ±‚å¤„ç†å‡½æ•°ï¼ŒNode.js ä¼šåœ¨æ¯æ¬¡è¯·æ±‚åˆ°æ¥æ—¶è°ƒç”¨å®ƒ</span>
    <span class="hljs-keyword">return</span> <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
      <span class="hljs-comment">// ä¸ºè¿™ä¸ªè¯·æ±‚åˆ›å»ºç‹¬ç«‹çš„ context</span>
      <span class="hljs-keyword">const</span> ctx = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">createContext</span>(req, res);
      <span class="hljs-comment">// æ‰§è¡Œç»„åˆåçš„ä¸­é—´ä»¶å‡½æ•°ï¼Œä¼ å…¥ context</span>
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handleRequest</span>(ctx, fn);
    };
  }
}
</code></pre>
<p><strong>æµç¨‹åˆ†è§£ï¼š</strong></p>
<ol>
<li><strong><code>app.listen()</code></strong> - è¿™åªæ˜¯å¯¹ Node.js åŸç”Ÿ API çš„è–„å°è£…</li>
<li><strong><code>this.callback()</code></strong> - è¿™é‡Œæ˜¯é­”æ³•å‘ç”Ÿçš„åœ°æ–¹ï¼š
<ul>
<li>è°ƒç”¨ <code>compose(this.middleware)</code> å°†æ‰€æœ‰ä¸­é—´ä»¶ç»„åˆæˆä¸€ä¸ªå‡½æ•°</li>
<li>è¿”å›ä¸€ä¸ªé—­åŒ…å‡½æ•°ï¼Œæ¯æ¬¡è¯·æ±‚æ—¶è¢«è°ƒç”¨</li>
</ul>
</li>
<li><strong>è¯·æ±‚å¤„ç†</strong> - å½“è¯·æ±‚åˆ°æ¥æ—¶ï¼š
<ul>
<li>åˆ›å»ºæœ¬æ¬¡è¯·æ±‚ä¸“å±çš„ <code>ctx</code> å¯¹è±¡</li>
<li>æ‰§è¡Œç»„åˆåçš„ä¸­é—´ä»¶å‡½æ•° <code>fn(ctx)</code></li>
<li>æ‰€æœ‰ä¸­é—´ä»¶å…±äº«åŒä¸€ä¸ª <code>ctx</code></li>
</ul>
</li>
</ol>
<p><strong>å…³é”®ç‚¹ï¼š<code>compose(this.middleware)</code></strong></p>
<p>è¿™è¡Œä»£ç æ˜¯ç†è§£ Koa çš„å…³é”®ã€‚å®ƒå°†ä¸€ä¸ªä¸­é—´ä»¶æ•°ç»„ï¼š</p>
<pre><code class="hljs language-javascript" lang="javascript">[middleware1, middleware2, middleware3]
</code></pre>
<p>è½¬æ¢æˆä¸€ä¸ªåµŒå¥—çš„è°ƒç”¨é“¾ï¼š</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">middleware1</span>(ctx, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-title function_">middleware2</span>(ctx, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">middleware3</span>(ctx, <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-comment">// æœ€å†…å±‚</span>
    })
  })
})
</code></pre>
<p>è¿™å°±æ˜¯è‘—åçš„"æ´‹è‘±æ¨¡å‹"çš„å®ç°åŸºç¡€ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬å°†æ·±å…¥å‰–æ <code>compose</code> å‡½æ•°çš„æºç ã€‚</p>
<h3 data-id="heading-9">ä¸‰ã€æ´‹è‘±æ¨¡å‹ï¼šä¸­é—´ä»¶çš„ä¼˜é›…ç¼–æ’</h3>
<h4 data-id="heading-10">3.1 ä»€ä¹ˆæ˜¯æ´‹è‘±æ¨¡å‹ï¼Ÿ</h4>
<p>Koa çš„ä¸­é—´ä»¶æ‰§è¡Œæœºåˆ¶è¢«å½¢è±¡åœ°ç§°ä¸º"æ´‹è‘±æ¨¡å‹"ã€‚ä¸­é—´ä»¶çš„æ‰§è¡Œè¿‡ç¨‹ç±»ä¼¼äºå‰¥æ´‹è‘±ï¼š</p>
<ol>
<li><strong>è¯·æ±‚é˜¶æ®µ</strong>ï¼ˆå¤–å±‚åˆ°å†…å±‚ï¼‰ï¼šä»ç¬¬ä¸€ä¸ªä¸­é—´ä»¶å¼€å§‹ï¼Œé‡åˆ° <code>await next()</code> å°±è¿›å…¥ä¸‹ä¸€ä¸ªä¸­é—´ä»¶</li>
<li><strong>å“åº”é˜¶æ®µ</strong>ï¼ˆå†…å±‚åˆ°å¤–å±‚ï¼‰ï¼šæœ€å†…å±‚ä¸­é—´ä»¶æ‰§è¡Œå®Œæ¯•åï¼Œä¾æ¬¡è¿”å›åˆ°å¤–å±‚ä¸­é—´ä»¶</li>
</ol>
<h4 data-id="heading-11">3.2 compose æºç è§£æä¸å®ç°</h4>
<p><code>compose</code> å‡½æ•°æ˜¯ <code>koa-compose</code> åŒ…æä¾›çš„ï¼Œå®ƒæ˜¯å®ç°æ´‹è‘±æ¨¡å‹çš„æ ¸å¿ƒã€‚è®©æˆ‘ä»¬å…ˆçœ‹çœ‹å®˜æ–¹æºç ï¼š</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">compose</span>(<span class="hljs-params">middleware</span>) {
  <span class="hljs-comment">// compose è¿”å›ä¸€ä¸ªå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°æ¥æ”¶ context å’Œä¸€ä¸ªå¯é€‰çš„ next</span>
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span> (<span class="hljs-params">context, next</span>) {
    <span class="hljs-keyword">let</span> index = -<span class="hljs-number">1</span>;  <span class="hljs-comment">// ç”¨äºè®°å½•å½“å‰æ‰§è¡Œåˆ°ç¬¬å‡ ä¸ªä¸­é—´ä»¶</span>

    <span class="hljs-comment">// dispatch å‡½æ•°è´Ÿè´£æ‰§è¡Œç¬¬ i ä¸ªä¸­é—´ä»¶</span>
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">dispatch</span>(<span class="hljs-params">i</span>) {
      <span class="hljs-comment">// é˜²æ­¢åœ¨åŒä¸€ä¸ªä¸­é—´ä»¶ä¸­å¤šæ¬¡è°ƒç”¨ next()</span>
      <span class="hljs-comment">// å¦‚æœ i &lt;= indexï¼Œè¯´æ˜ next() è¢«è°ƒç”¨äº†å¤šæ¬¡</span>
      <span class="hljs-keyword">if</span> (i &lt;= index) {
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'next() è¢«å¤šæ¬¡è°ƒç”¨'</span>));
      }

      index = i; <span class="hljs-comment">// æ›´æ–°å½“å‰ä¸­é—´ä»¶ç´¢å¼•ï¼Œç”¨äºé˜²æ­¢ next è¢«å¤šæ¬¡è°ƒç”¨</span>
      <span class="hljs-keyword">let</span> fn = middleware[i];  <span class="hljs-comment">// è·å–å½“å‰è¦æ‰§è¡Œçš„ä¸­é—´ä»¶</span>

      <span class="hljs-comment">// å¦‚æœå·²ç»æ˜¯æœ€åä¸€ä¸ªä¸­é—´ä»¶ï¼Œfn è®¾ä¸ºä¼ å…¥çš„ nextï¼ˆé€šå¸¸ä¸º undefinedï¼‰</span>
      <span class="hljs-keyword">if</span> (i === middleware.<span class="hljs-property">length</span>) fn = next;
      <span class="hljs-comment">// å¦‚æœ fn ä¸å­˜åœ¨ï¼Œè¯´æ˜å·²ç»åˆ°è¾¾æœ«å°¾ï¼Œè¿”å›ä¸€ä¸ª resolved çš„ Promise</span>
      <span class="hljs-keyword">if</span> (!fn) <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>();

      <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// â­ï¸ æ ¸å¿ƒé€»è¾‘ï¼šæ‰§è¡Œå½“å‰ä¸­é—´ä»¶ï¼Œå¹¶å°† dispatch(i + 1) ä½œä¸º next å‚æ•°ä¼ å…¥</span>
        <span class="hljs-comment">// è¿™æ ·å½“ä¸­é—´ä»¶è°ƒç”¨ await next() æ—¶ï¼Œå®é™…ä¸Šæ˜¯åœ¨è°ƒç”¨ dispatch(i + 1)</span>
        <span class="hljs-comment">// ä»è€Œé€’å½’åœ°æ‰§è¡Œä¸‹ä¸€ä¸ªä¸­é—´ä»¶</span>
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-title function_">fn</span>(context, dispatch.<span class="hljs-title function_">bind</span>(<span class="hljs-literal">null</span>, i + <span class="hljs-number">1</span>)));
      } <span class="hljs-keyword">catch</span> (err) {
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(err);
      }
    }

    <span class="hljs-comment">// ä»ç¬¬ä¸€ä¸ªä¸­é—´ä»¶å¼€å§‹æ‰§è¡Œ</span>
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">dispatch</span>(<span class="hljs-number">0</span>);
  };
}
</code></pre>
<p><strong>è¿™ä¸ªå‡½æ•°çš„ç²¾å¦™ä¹‹å¤„ï¼š</strong></p>
<ol>
<li><strong>é—­åŒ…ä¿å­˜çŠ¶æ€</strong> - é€šè¿‡é—­åŒ…ä¿å­˜ <code>index</code>ï¼Œé˜²æ­¢ <code>next()</code> è¢«é‡å¤è°ƒç”¨ï¼Œè¿™æ˜¯ä¸€ä¸ªé‡è¦çš„å®‰å…¨æ£€æŸ¥</li>
<li><strong>é€’å½’è°ƒç”¨é“¾</strong> - <code>dispatch(i)</code> æ‰§è¡Œå½“å‰ä¸­é—´ä»¶ï¼Œå¹¶å°† <code>dispatch(i + 1)</code> ä½œä¸º <code>next</code> ä¼ å…¥</li>
<li><strong>Promise åŒ…è£…</strong> - æ‰€æœ‰ä¸­é—´ä»¶éƒ½è¢«åŒ…è£…æˆ Promiseï¼Œæ”¯æŒ async/await è¯­æ³•</li>
<li><strong>æ‡’æ‰§è¡Œ</strong> - åªæœ‰å½“ä¸­é—´ä»¶è°ƒç”¨ <code>await next()</code> æ—¶ï¼Œä¸‹ä¸€ä¸ªä¸­é—´ä»¶æ‰ä¼šæ‰§è¡Œ</li>
</ol>
<p><strong>æ‰§è¡Œæµç¨‹å¯è§†åŒ–ï¼š</strong></p>
<p>å‡è®¾æœ‰ä¸‰ä¸ªä¸­é—´ä»¶ <code>[m1, m2, m3]</code>ï¼š</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">dispatch</span>(<span class="hljs-number">0</span>) æ‰§è¡Œ <span class="hljs-built_in">m1</span>(ctx, dispatch(<span class="hljs-number">1</span>))
  â†“
  m1 æ‰§è¡Œåˆ° await <span class="hljs-built_in">next</span>()
  â†“
  <span class="hljs-built_in">dispatch</span>(<span class="hljs-number">1</span>) æ‰§è¡Œ <span class="hljs-built_in">m2</span>(ctx, dispatch(<span class="hljs-number">2</span>))
    â†“
    m2 æ‰§è¡Œåˆ° await <span class="hljs-built_in">next</span>()
    â†“
    <span class="hljs-built_in">dispatch</span>(<span class="hljs-number">2</span>) æ‰§è¡Œ <span class="hljs-built_in">m3</span>(ctx, dispatch(<span class="hljs-number">3</span>))
      â†“
      m3 æ‰§è¡Œå®Œæ¯•
    â†“
    m2 çš„ <span class="hljs-built_in">next</span>() åçš„ä»£ç æ‰§è¡Œ
  â†“
  m1 çš„ <span class="hljs-built_in">next</span>() åçš„ä»£ç æ‰§è¡Œ
</code></pre>
<p>æºç ä½¿ç”¨é€’å½’å®ç°ï¼Œåˆçœ‹å¯èƒ½æœ‰äº›éš¾æ‡‚ã€‚æ²¡å…³ç³»ï¼Œä¸‹é¢æˆ‘ä»¬æ¥å®ç°ä¸€ä¸ªç®€åŒ–ç‰ˆæœ¬ï¼Œå¸®åŠ©ç†è§£æ ¸å¿ƒæ€æƒ³ã€‚</p>
<h4 data-id="heading-12">3.3 æ‰‹å†™ç®€æ˜“ç‰ˆ compose</h4>
<p>æ ¸å¿ƒæ€æƒ³ï¼š<strong>åœ¨å½“å‰ä¸­é—´ä»¶æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œè®© <code>next()</code> å‡½æ•°èƒ½å¤Ÿè‡ªåŠ¨æ‰§è¡Œä¸‹ä¸€ä¸ªä¸­é—´ä»¶</strong>ï¼Œç›´åˆ°æœ€åä¸€ä¸ªã€‚</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">compose</span> = (<span class="hljs-params">middleware</span>) =&gt; {
  <span class="hljs-keyword">const</span> ctx = {};  <span class="hljs-comment">// åˆ›å»ºä¸€ä¸ªä¸Šä¸‹æ–‡å¯¹è±¡</span>

  <span class="hljs-keyword">if</span> (middleware.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">return</span>;
  }

  <span class="hljs-keyword">let</span> index = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">const</span> fn = middleware[index]; <span class="hljs-comment">// è·å–ç¬¬ä¸€ä¸ªä¸­é—´ä»¶</span>
  <span class="hljs-title function_">fn</span>(ctx, next);                <span class="hljs-comment">// æ‰‹åŠ¨æ‰§è¡Œç¬¬ä¸€ä¸ªä¸­é—´ä»¶</span>

  <span class="hljs-comment">// å®ç° next() å‡½æ•°</span>
  <span class="hljs-comment">// æ ¸å¿ƒæ˜¯åœ¨å½“å‰ä¸­é—´ä»¶æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œè·å–ä¸‹ä¸€ä¸ªä¸­é—´ä»¶å‡½æ•°å¹¶è‡ªåŠ¨æ‰§è¡Œï¼Œç›´åˆ°æœ€åä¸€ä¸ª</span>
  <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">next</span>(<span class="hljs-params"/>) {
    index++;  <span class="hljs-comment">// ç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªä¸­é—´ä»¶</span>

    <span class="hljs-comment">// å¦‚æœå·²ç»æ˜¯æœ€åä¸€ä¸ªä¸­é—´ä»¶ï¼Œç›´æ¥è¿”å›</span>
    <span class="hljs-keyword">if</span> (index &gt;= middleware.<span class="hljs-property">length</span>) {
      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-keyword">const</span> fn = middleware[index];  <span class="hljs-comment">// è·å–ä¸‹ä¸€ä¸ªä¸­é—´ä»¶</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-title function_">fn</span>(ctx, next);    <span class="hljs-comment">// æ‰§è¡Œä¸‹ä¸€ä¸ªä¸­é—´ä»¶ï¼Œå¹¶ä¼ å…¥ next</span>
  }
};

<span class="hljs-comment">// å®šä¹‰ä¸‰ä¸ªæµ‹è¯•ä¸­é—´ä»¶</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">middleware1</span> = (<span class="hljs-params">ctx, next</span>) =&gt; {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"&gt;&gt; one"</span>);
  <span class="hljs-title function_">next</span>();                 <span class="hljs-comment">// è°ƒç”¨ next()ï¼Œæ‰§è¡Œ middleware2</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"&lt;&lt; one"</span>);
};

<span class="hljs-keyword">const</span> <span class="hljs-title function_">middleware2</span> = (<span class="hljs-params">ctx, next</span>) =&gt; {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"&gt;&gt; two"</span>);
  <span class="hljs-title function_">next</span>();                 <span class="hljs-comment">// è°ƒç”¨ next()ï¼Œæ‰§è¡Œ middleware3</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"&lt;&lt; two"</span>);
};

<span class="hljs-keyword">const</span> <span class="hljs-title function_">middleware3</span> = (<span class="hljs-params">ctx, next</span>) =&gt; {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"&gt;&gt; three"</span>);
  <span class="hljs-title function_">next</span>();                 <span class="hljs-comment">// å·²ç»æ˜¯æœ€åä¸€ä¸ªï¼Œnext() ç›´æ¥è¿”å›</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"&lt;&lt; three"</span>);
};

<span class="hljs-comment">// æ‰§è¡Œç»„åˆåçš„ä¸­é—´ä»¶</span>
<span class="hljs-title function_">compose</span>([middleware1, middleware2, middleware3]);

<span class="hljs-comment">// è¾“å‡ºï¼š</span>
<span class="hljs-comment">// &gt;&gt; one</span>
<span class="hljs-comment">// &gt;&gt; two</span>
<span class="hljs-comment">// &gt;&gt; three</span>
<span class="hljs-comment">// &lt;&lt; three</span>
<span class="hljs-comment">// &lt;&lt; two</span>
<span class="hljs-comment">// &lt;&lt; one</span>
</code></pre>
<p><strong>å…³é”®ç†è§£ç‚¹ï¼š</strong></p>
<ol>
<li><strong>åŒæ­¥æ‰§è¡Œ</strong> - å½“ <code>middleware1</code> è°ƒç”¨ <code>next()</code> æ—¶ï¼Œ<code>middleware2</code> ä¼šç«‹å³å¼€å§‹æ‰§è¡Œ</li>
<li><strong>æ ˆå¼å›æº¯</strong> - å½“ <code>middleware3</code> æ‰§è¡Œå®Œæ¯•åï¼Œæ§åˆ¶æƒä¼šä¾æ¬¡è¿”å›åˆ° <code>middleware2</code> å’Œ <code>middleware1</code> çš„ <code>next()</code> ä¹‹å</li>
<li><strong>æ´‹è‘±ç»“æ„</strong> - è¿™å°±å½¢æˆäº†"è¿›å…¥"å’Œ"é€€å‡º"ä¸¤ä¸ªé˜¶æ®µï¼Œåƒå‰¥æ´‹è‘±ä¸€æ ·</li>
</ol>
<p><strong>æ‰§è¡Œé¡ºåºè¯¦è§£ï¼š</strong></p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> middleware1 å¼€å§‹æ‰§è¡Œ â†’ æ‰“å° "&gt;&gt; one"
<span class="hljs-bullet">2.</span> middleware1 è°ƒç”¨ next() â†’ æš‚åœï¼Œè¿›å…¥ middleware2
<span class="hljs-bullet">3.</span> middleware2 å¼€å§‹æ‰§è¡Œ â†’ æ‰“å° "&gt;&gt; two"
<span class="hljs-bullet">4.</span> middleware2 è°ƒç”¨ next() â†’ æš‚åœï¼Œè¿›å…¥ middleware3
<span class="hljs-bullet">5.</span> middleware3 å¼€å§‹æ‰§è¡Œ â†’ æ‰“å° "&gt;&gt; three"
<span class="hljs-bullet">6.</span> middleware3 è°ƒç”¨ next() â†’ è¿”å›ï¼ˆå·²æ˜¯æœ€åä¸€ä¸ªï¼‰
<span class="hljs-bullet">7.</span> middleware3 ç»§ç»­æ‰§è¡Œ â†’ æ‰“å° "&lt;&lt; three"
<span class="hljs-bullet">8.</span> middleware3 æ‰§è¡Œå®Œæ¯• â†’ è¿”å›åˆ° middleware2
<span class="hljs-bullet">9.</span> middleware2 ç»§ç»­æ‰§è¡Œ â†’ æ‰“å° "&lt;&lt; two"
<span class="hljs-bullet">10.</span> middleware2 æ‰§è¡Œå®Œæ¯• â†’ è¿”å›åˆ° middleware1
<span class="hljs-bullet">11.</span> middleware1 ç»§ç»­æ‰§è¡Œ â†’ æ‰“å° "&lt;&lt; one"
</code></pre>
<p><strong>å»ºè®®ï¼š</strong> ä½¿ç”¨ VSCode çš„æ–­ç‚¹è°ƒè¯•åŠŸèƒ½ï¼Œåœ¨æ¯ä¸ªä¸­é—´ä»¶çš„ <code>next()</code> å‰åæ‰“æ–­ç‚¹ï¼Œå•æ­¥æ‰§è¡Œä½“ä¼šä»£ç çš„å…·ä½“æ‰§è¡Œè¿‡ç¨‹ã€‚è¿™æ ·èƒ½å¤Ÿæ›´ç›´è§‚åœ°ç†è§£æ´‹è‘±æ¨¡å‹çš„è¿ä½œæœºåˆ¶ã€‚</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d68926e6e1eb4925b44a05a1692dc599~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6La05Zyo56qX6L655pWw5pif5pif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766824960&amp;x-signature=2O9KCiNJtD3y9zXPy72oxglmmTA%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-13">å››ã€æ€»ç»“</h3>
<p>é€šè¿‡å¯¹ Koa æºç çš„æ·±å…¥åˆ†æï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å®ƒçš„è®¾è®¡å“²å­¦ï¼š<strong>æç®€ã€ä¼˜é›…ã€çµæ´»</strong>ã€‚</p>
<h3 data-id="heading-14">å‚è€ƒèµ„æº</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fkoajs.com%2F" target="_blank" title="https://koajs.com/" ref="nofollow noopener noreferrer">Koa å®˜æ–¹æ–‡æ¡£</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fkoajs%2Fkoa" target="_blank" title="https://github.com/koajs/koa" ref="nofollow noopener noreferrer">Koa GitHub ä»“åº“</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fkoajs%2Fcompose" target="_blank" title="https://github.com/koajs/compose" ref="nofollow noopener noreferrer">koa-compose æºç </a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fkoajs%2Fkoa%2Fwiki" target="_blank" title="https://github.com/koajs/koa/wiki" ref="nofollow noopener noreferrer">Koa ä¸­é—´ä»¶åˆ—è¡¨</a></li>
</ul>
<hr/>
<p>å¦‚æœè§‰å¾—æœ‰å¸®åŠ©ï¼Œæ¬¢è¿ç‚¹èµæ”¶è—ï¼Œä¹Ÿæ¬¢è¿åœ¨è¯„è®ºåŒºäº¤æµè®¨è®ºï¼</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[vscodeæ²¡æœ‰jsæç¤ºï¼šé…ç½®jsconfigé…ç½®]]></title>    <link>https://juejin.cn/post/7585468725332279350</link>    <guid>https://juejin.cn/post/7585468725332279350</guid>    <pubDate>2025-12-20T08:44:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585468725332279350" data-draft-id="7585468725332262966" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="vscodeæ²¡æœ‰jsæç¤ºï¼šé…ç½®jsconfigé…ç½®"/> <meta itemprop="keywords" content="å‰ç«¯"/> <meta itemprop="datePublished" content="2025-12-20T08:44:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Mr_Swilder"/> <meta itemprop="url" content="https://juejin.cn/user/3927901716878829"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="æ˜é‡‘"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            vscodeæ²¡æœ‰jsæç¤ºï¼šé…ç½®jsconfigé…ç½®
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3927901716878829/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Mr_Swilder
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T08:44:44.000Z" title="Sat Dec 20 2025 08:44:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    é˜…è¯»3åˆ†é’Ÿ
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"ã€Œ"}.markdown-body strong:after{content:"ã€"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"â";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"â";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="androidstudio">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#a9b7c6;background:#282b2e}.hljs-bullet,.hljs-literal,.hljs-number,.hljs-symbol{color:#6897bb}.hljs-deletion,.hljs-keyword,.hljs-selector-tag{color:#cc7832}.hljs-link,.hljs-template-variable,.hljs-variable{color:#629755}.hljs-comment,.hljs-quote{color:grey}.hljs-meta{color:#bbb529}.hljs-addition,.hljs-attribute,.hljs-string{color:#6a8759}.hljs-section,.hljs-title,.hljs-type{color:#ffc66d}.hljs-name,.hljs-selector-class,.hljs-selector-id{color:#e8bf6a}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><code>jsconfig.json</code>æ˜¯ä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼Œå®ƒçš„æ ¸å¿ƒä½œç”¨æ˜¯å‘Šè¯‰ Visual Studio Codeï¼ˆVSCodeï¼‰å½“å‰ç›®å½•æ˜¯ä¸€ä¸ª <strong>JavaScript é¡¹ç›®çš„æ ¹ç›®å½•</strong>ï¼Œä»è€Œä¸ºä½ çš„ä»£ç æä¾›æ›´å¼ºå¤§çš„æ™ºèƒ½æ„ŸçŸ¥ï¼ˆIntelliSenseï¼‰å’Œè¯­è¨€æ”¯æŒã€‚</p>
<p>ä¸‹é¢è¿™ä¸ªè¡¨æ ¼æ¦‚æ‹¬äº†å®ƒçš„ä¸»è¦ä½œç”¨ï¼š</p>






























<table><thead><tr><th>æ ¸å¿ƒä½œç”¨</th><th>è§£å†³çš„é—®é¢˜</th><th>ç®€å•ç¤ºä¾‹</th></tr></thead><tbody><tr><td><strong>å®šä¹‰é¡¹ç›®ä¸Šä¸‹æ–‡</strong>â€‹</td><td>æ²¡æœ‰å®ƒæ—¶ï¼ŒVSCode å°†æ¯ä¸ª JS æ–‡ä»¶è§†ä¸ºç‹¬ç«‹å•å…ƒï¼Œæ–‡ä»¶é—´ç¼ºä¹å…³è”æ€§ã€‚æœ‰äº†å®ƒï¼ŒVSCode èƒ½å°†æ•´ä¸ªé¡¹ç›®ä½œä¸ºä¸€ä¸ªæ•´ä½“ç†è§£ã€‚</td><td><code>{}</code>(ä¸€ä¸ªç©ºæ–‡ä»¶å³å¯å®šä¹‰é¡¹ç›®)</td></tr><tr><td><strong>é…ç½®è·¯å¾„åˆ«åæ˜ å°„</strong>â€‹</td><td>å½“é¡¹ç›®ä½¿ç”¨åƒ <code>@</code>è¿™æ ·çš„åˆ«åæ¥ä»£è¡¨ <code>src</code>ç›®å½•æ—¶ï¼ŒVSCode é»˜è®¤æ— æ³•è¯†åˆ«ã€‚é…ç½®åï¼Œå¯ä»¥å®ç°<strong>è·¯å¾„çš„è‡ªåŠ¨è¡¥å…¨å’Œç‚¹å‡»è·³è½¬</strong>ã€‚</td><td><code>"paths": { "@/*": ["src/*"] }</code></td></tr><tr><td><strong>æå‡ IDE æ€§èƒ½</strong>â€‹</td><td>é€šè¿‡æ’é™¤ä¸å¿…è¦çš„æ–‡ä»¶ï¼ˆå¦‚ <code>node_modules</code>, <code>dist</code>ï¼‰ï¼Œè®©è¯­è¨€æœåŠ¡ä¸“æ³¨äºæºä»£ç ï¼Œ<strong>é¿å… IntelliSense å˜æ…¢</strong>ã€‚</td><td><code>"exclude": ["node_modules", "dist"]</code></td></tr><tr><td><strong>è°ƒæ•´è¯­è¨€æœåŠ¡é€‰é¡¹</strong>â€‹</td><td>é…ç½® JavaScript çš„è¯­è¨€æ£€æŸ¥æ ‡å‡†ï¼Œä¾‹å¦‚å¯ç”¨å®éªŒæ€§è¯­æ³•æ”¯æŒï¼ˆå¦‚è£…é¥°å™¨ï¼‰æˆ–æŒ‡å®š ECMAScript ç›®æ ‡ç‰ˆæœ¬ã€‚</td><td><code>"experimentalDecorators": true</code></td></tr></tbody></table>
<h3 data-id="heading-0">ğŸ’¡ è¯¦ç»†è§£è¯»ä¸é…ç½®</h3>
<ul>
<li>
<p><strong>å®šä¹‰é¡¹ç›®ä¸Šä¸‹æ–‡</strong>ï¼šåœ¨æ²¡æœ‰ <code>jsconfig.json</code>çš„â€œæ–‡ä»¶èŒƒå›´ï¼ˆFile Scopeï¼‰â€æ¨¡å¼ä¸‹ï¼ŒVSCode è™½ç„¶èƒ½ä¸ºå•ä¸ªæ–‡ä»¶æä¾›åŸºç¡€è¯­æ³•é«˜äº®ï¼Œä½†éš¾ä»¥å‡†ç¡®åˆ†ææ–‡ä»¶ä¹‹é—´çš„æ¨¡å—å¼•ç”¨å…³ç³»ã€‚åˆ›å»º <code>jsconfig.json</code>åï¼Œé¡¹ç›®è¿›å…¥â€œæ˜¾å¼é¡¹ç›®ï¼ˆExplicit Projectï¼‰â€æ¨¡å¼ï¼ŒVSCode çš„è¯­è¨€æœåŠ¡èƒ½ç†è§£é¡¹ç›®çš„æ•´ä½“ç»“æ„ï¼Œä»è€Œæä¾›æ›´ç²¾ç¡®çš„ä»£ç è¡¥å…¨ã€ç±»å‹æ¨æ–­å’Œé”™è¯¯æ£€æŸ¥ã€‚</p>
</li>
<li>
<p><strong>é…ç½®è·¯å¾„æ˜ å°„ï¼ˆPaths Mappingï¼‰</strong> ï¼šè¿™æ˜¯åœ¨å‰ç«¯é¡¹ç›®ä¸­éå¸¸å®ç”¨çš„åŠŸèƒ½ã€‚è®¸å¤šé¡¹ç›®ä½¿ç”¨ Webpack æˆ– Vite ç­‰æ„å»ºå·¥å…·é…ç½®äº†è·¯å¾„åˆ«åï¼Œä½†åœ¨ä»£ç ç¼–è¾‘å™¨ä¸­ï¼Œè¿™äº›åˆ«åé»˜è®¤æ— æ³•è¢«è¯†åˆ«ã€‚é€šè¿‡åœ¨ <code>jsconfig.json</code>ä¸­é…ç½® <code>paths</code>ï¼Œå³å¯è®© VSCode ç†è§£è¿™äº›åˆ«åã€‚</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"compilerOptions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"baseUrl"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./"</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// è®¾ç½®åŸºç¡€ç›®å½•</span>
    <span class="hljs-attr">"paths"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"@/*"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"src/*"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>    <span class="hljs-comment">// å°† @ æ˜ å°„åˆ° src ç›®å½•</span>
      <span class="hljs-attr">"components/*"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"src/components/*"</span><span class="hljs-punctuation">]</span> <span class="hljs-comment">// é…ç½®å…¶ä»–åˆ«å</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>é…ç½®åï¼Œå½“ä½ è¾“å…¥ <code>import App from '@/App'</code>ï¼ŒVSCode å°±èƒ½çŸ¥é“ <code>@</code>æŒ‡å‘ <code>src</code>ç›®å½•ï¼Œå¹¶æä¾›è‡ªåŠ¨è¡¥å…¨å’Œè·³è½¬åŠŸèƒ½ã€‚</p>
</li>
<li>
<p><strong>ä¼˜åŒ–æ€§èƒ½ï¼ˆExcludeï¼‰</strong> ï¼šJavaScript è¯­è¨€æœåŠ¡ä¼šåˆ†æé¡¹ç›®ä¸­çš„æ–‡ä»¶æ¥æä¾› IntelliSenseã€‚å¦‚æœå®ƒå»è§£æåºå¤§çš„ <code>node_modules</code>æˆ–æ„å»ºè¾“å‡ºçš„ <code>dist</code>ç›®å½•ï¼Œä¼šä¸¥é‡æ‹–æ…¢é€Ÿåº¦ã€‚ä½¿ç”¨ <code>exclude</code>å±æ€§å¯ä»¥å‘Šè¯‰è¯­è¨€æœåŠ¡å¿½ç•¥è¿™äº›ç›®å½•ã€‚</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"exclude"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"node_modules"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"dist"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"build"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"*.min.js"</span><span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
</li>
</ul>
<h3 data-id="heading-1">ğŸ› ï¸ åˆ›å»ºä¸é…ç½®ç¤ºä¾‹</h3>
<p>ä½ å¯ä»¥åœ¨é¡¹ç›®çš„æ ¹ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªåä¸º <code>jsconfig.json</code>çš„æ–‡ä»¶ã€‚ä¸€ä¸ªé€‚ç”¨äºç°ä»£å‰ç«¯é¡¹ç›®ï¼ˆå¦‚ Vueã€Reactï¼‰çš„å¸¸è§é…ç½®å¦‚ä¸‹ï¼š</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"compilerOptions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"target"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ESNext"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"module"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ESNext"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"moduleResolution"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"node"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"baseUrl"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"paths"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"@/*"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"src/*"</span><span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"allowSyntheticDefaultImports"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"experimentalDecorators"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"lib"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"esnext"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"dom"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"dom.iterable"</span><span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"include"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"src/**/*"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"exclude"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"node_modules"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"dist"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"build"</span><span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>é…ç½®é¡¹è¯´æ˜</strong>ï¼š</p>
<ul>
<li><code>compilerOptions</code>ï¼šè™½ç„¶åå­—å«â€œç¼–è¯‘é€‰é¡¹â€ï¼Œä½†å®ƒä¸»è¦ç”¨äºé…ç½® VSCode çš„ JavaScript è¯­è¨€æœåŠ¡è¡Œä¸ºï¼Œå› ä¸º <code>jsconfig.json</code>æºè‡ª TypeScript çš„ <code>tsconfig.json</code>ã€‚</li>
<li><code>include</code>ï¼šæ˜ç¡®æŒ‡å®šå“ªäº›æ–‡ä»¶å±äºé¡¹ç›®ã€‚å¦‚æœæœªè®¾ç½®ï¼Œåˆ™é»˜è®¤åŒ…å«æ‰€æœ‰å­ç›®å½•ä¸‹çš„æ–‡ä»¶ã€‚</li>
<li><code>exclude</code>ï¼šæŒ‡å®šè¦æ’é™¤çš„æ–‡ä»¶å’Œæ–‡ä»¶å¤¹ã€‚</li>
</ul>
<h3 data-id="heading-2">ğŸ’ æ€»ç»“</h3>
<p>æ€»è€Œè¨€ä¹‹ï¼Œ<code>jsconfig.json</code>å°±åƒæ˜¯ä½ åœ¨ VSCode ä¸­çš„<strong>é¡¹ç›®åœ°å›¾å’Œè¯´æ˜ä¹¦</strong>ã€‚å®ƒé€šè¿‡å®šä¹‰é¡¹ç›®æ ¹ç›®å½•ã€æ˜ å°„è·¯å¾„åˆ«åã€æ’é™¤æ— å…³æ–‡ä»¶ç­‰æ–¹å¼ï¼Œæ˜¾è‘—æå‡äº†ä»£ç ç¼–è¾‘çš„æ™ºèƒ½ä½“éªŒã€å¯¼èˆªæ•ˆç‡å’Œæ•´ä½“æ€§èƒ½ã€‚å¯¹äºä»»ä½•æœ‰ä¸€å®šè§„æ¨¡çš„ JavaScript/TypeScript é¡¹ç›®ï¼Œé…ç½®ä¸€ä¸ª <code>jsconfig.json</code>éƒ½æ˜¯éå¸¸å€¼å¾—çš„ã€‚</p>
<p>å¸Œæœ›è¿™äº›ä¿¡æ¯èƒ½å¸®åŠ©ä½ æ›´å¥½åœ°ç†è§£å’Œä½¿ç”¨ <code>jsconfig.json</code>ã€‚å¦‚æœä½ åœ¨é…ç½®è¿‡ç¨‹ä¸­é‡åˆ°å…·ä½“é—®é¢˜ï¼Œä¾‹å¦‚å¦‚ä½•ä¸ºç‰¹å®šæ¡†æ¶è¿›è¡Œä¼˜åŒ–ï¼Œæˆ‘å¾ˆä¹æ„æä¾›è¿›ä¸€æ­¥çš„å¸®åŠ©ã€‚</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[å‘Šåˆ«ä»£ç å±å±±ï¼UniApp + Vue3 è‡ªåŠ¨åŒ–è§„èŒƒï¼šESLint 9+ æ‰å¹³åŒ–é…ç½®å…¨æŒ‡å—]]></title>    <link>https://juejin.cn/post/7585463195201126450</link>    <guid>https://juejin.cn/post/7585463195201126450</guid>    <pubDate>2025-12-20T06:40:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585463195201126450" data-draft-id="7585446706327076873" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="å‘Šåˆ«ä»£ç å±å±±ï¼UniApp + Vue3 è‡ªåŠ¨åŒ–è§„èŒƒï¼šESLint 9+ æ‰å¹³åŒ–é…ç½®å…¨æŒ‡å—"/> <meta itemprop="keywords" content="JavaScript,Vue.js"/> <meta itemprop="datePublished" content="2025-12-20T06:40:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="å¹¼å„¿å›­è€å¤§"/> <meta itemprop="url" content="https://juejin.cn/user/1574156383555415"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="æ˜é‡‘"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            å‘Šåˆ«ä»£ç å±å±±ï¼UniApp + Vue3 è‡ªåŠ¨åŒ–è§„èŒƒï¼šESLint 9+ æ‰å¹³åŒ–é…ç½®å…¨æŒ‡å—
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1574156383555415/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    å¹¼å„¿å›­è€å¤§
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T06:40:20.000Z" title="Sat Dec 20 2025 06:40:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    12
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    é˜…è¯»3åˆ†é’Ÿ
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>é…ç½®åˆè¡·æ˜¯ä¸ºäº†ä¿è¯ï¼Œå›¢é˜Ÿå¼€å‘ä¸­çš„ä»£ç è§„èŒƒé—®é¢˜ã€‚
ä»¥ä¸‹æ˜¯å…¨éƒ¨é…ç½®è¿‡ç¨‹ï¼Œæˆ‘çš„é¡¹ç›®æ˜¯npmåˆ›å»ºçš„ï¼Œå¹¶éhbuilderåˆ›å»ºçš„ã€‚å¦‚æœä½ çš„é¡¹ç›®çš„hbuilderåˆ›å»ºçš„ï¼Œéœ€è¦æ‰§è¡Œä¸‹ <code>npm init -y</code>ã€‚</p>
<p>é…ç½®åæƒ³è¦è¾¾åˆ°çš„æ•ˆæœï¼š</p>
<ul>
<li>ä¿è¯ç¼©è¿›ç»Ÿä¸€æ€§</li>
<li>vueç»„ä»¶å¤šä¸ªå±æ€§å¯ä»¥è‡ªåŠ¨æ¢è¡Œã€‚</li>
<li>åœ¨ä»£ç é‡Œç”¨äº†Â <code>uni.showToast</code>ï¼ŒESLint å´ç–¯ç‹‚æŠ¥é”™Â <code>uni is not defined</code>ã€‚</li>
</ul>
<p>2025 å¹´ï¼ŒESLint è¿æ¥äº†å²ä¸Šæœ€å¤§å˜é©â€”â€”<strong>Flat Configï¼ˆæ‰å¹³åŒ–é…ç½®ï¼‰</strong> Â æ—¶ä»£ã€‚ä»Šå¤©ï¼Œæˆ‘ä»¬å°±ç”¨ä¸€å¥—æœ€ç¡¬æ ¸çš„æ–¹æ¡ˆï¼ŒæŠŠÂ <strong>Vue3ã€TypeScriptã€SCSS</strong>Â å’ŒÂ <strong>Git è‡ªåŠ¨åŒ–</strong>Â å…¨éƒ¨æ‰“é€šï¼</p>
<h2 data-id="heading-0">ä¸€ã€ ä¸ºä»€ä¹ˆ 2025 å¹´è¦ç”¨ ESLint 9+ ï¼Ÿ</h2>
<p>ä¼ ç»Ÿçš„Â <code>.eslintrc.js</code>Â é‡‡ç”¨çš„æ˜¯â€œå±‚çº§ç»§æ‰¿â€é€»è¾‘ï¼Œé…ç½®å¤šäº†å°±åƒè¿·å®«ã€‚è€ŒÂ <strong>ESLint 9+ çš„ Flat Config (<code>eslint.config.mjs</code>)</strong> Â é‡‡ç”¨çº¯ JavaScript æ•°ç»„å¯¹è±¡ï¼Œé€»è¾‘æ›´æ‰å¹³ã€åŠ è½½æ›´å¿«é€Ÿã€å¯¹ ESM åŸç”Ÿæ”¯æŒæ›´å¥½ã€‚</p>
<h2 data-id="heading-1">äºŒã€ æ ¸å¿ƒä¾èµ–å®‰è£…ï¼šä¸€æ­¥åˆ°ä½</h2>
<p>é¦–å…ˆï¼Œæ¸…ç†æ‰é¡¹ç›®é‡Œçš„æ—§é…ç½®æ–‡ä»¶ï¼Œç„¶ååœ¨æ ¹ç›®å½•æ‰§è¡Œè¿™è¡Œâ€œå…¨å®¶æ¡¶â€å®‰è£…å‘½ä»¤ï¼š</p>
<pre><code class="hljs language-bash" lang="bash">npm install eslint @eslint/js typescript-eslint eslint-plugin-vue globals eslint-config-prettier eslint-plugin-prettier prettier husky lint-staged --save-dev
</code></pre>
<h2 data-id="heading-2">ä¸‰ã€ é…ç½®å®æˆ˜ï¼šä¸‰å‰‘å®¢é½èš</h2>
<ol>
<li>é­”æ³•å¯åŠ¨ï¼šç”Ÿæˆ ESLint 9 é…ç½®æ–‡ä»¶</li>
</ol>
<p>æ–°ç‰ˆ ESLint æ¨èé€šè¿‡äº¤äº’å¼å‘½ä»¤ç”ŸæˆåŸºç¡€æ¡†æ¶ï¼Œä½†é’ˆå¯¹ UniAppï¼Œæˆ‘ä»¬å»ºè®®ç›´æ¥åˆ›å»ºÂ <code>eslint.config.mjs</code>Â ä»¥è·å¾—æè‡´æ§åˆ¶åŠ›ã€‚</p>
<p><strong>æ ¸å¿ƒé€»è¾‘ï¼š</strong></p>
<ul>
<li><strong>2 ç©ºæ ¼ç¼©è¿›</strong>ï¼šå¼ºè¿«ç—‡çš„ç¦éŸ³ã€‚</li>
<li><strong>å±æ€§æ¢è¡Œ</strong>ï¼šç»„ä»¶å±æ€§ &gt; 3 ä¸ªè‡ªåŠ¨èµ·æ–°è¡Œã€‚</li>
<li><strong>å¤šè¯­è¨€å…¨å¼€</strong>ï¼šJS / TS / Vue / CSS / SCSS å®Œç¾å…¼å®¹ã€‚</li>
</ul>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment">/* eslint.config.mjs */</span>
import js <span class="hljs-keyword">from</span> <span class="hljs-string">'@eslint/js'</span>;
import tseslint <span class="hljs-keyword">from</span> <span class="hljs-string">'typescript-eslint'</span>;
import pluginVue <span class="hljs-keyword">from</span> <span class="hljs-string">'eslint-plugin-vue'</span>;
import pluginPrettierRecommended <span class="hljs-keyword">from</span> <span class="hljs-string">'eslint-plugin-prettier/recommended'</span>;
import globals <span class="hljs-keyword">from</span> <span class="hljs-string">'globals'</span>;

export <span class="hljs-keyword">default</span> tseslint.<span class="hljs-title function_ invoke__">config</span>(
  // ã€<span class="hljs-number">1</span>ã€‘é…ç½®å¿½ç•¥åå•ï¼šä¸æ£€æŸ¥ç¼–è¯‘åçš„ä»£ç 
  { <span class="hljs-attr">ignores</span>: [<span class="hljs-string">'dist/**'</span>, <span class="hljs-string">'unpackage/**'</span>, <span class="hljs-string">'node_modules/**'</span>, <span class="hljs-string">'static/**'</span>] },

  // ã€<span class="hljs-number">2</span>ã€‘JS åŸºç¡€è§„åˆ™ &amp; UniApp å…¨å±€å˜é‡æ”¯æŒ
  js.configs.recommended,
  {
    <span class="hljs-attr">languageOptions</span>: {
      <span class="hljs-attr">ecmaVersion</span>: <span class="hljs-string">'latest'</span>,
      <span class="hljs-attr">sourceType</span>: <span class="hljs-string">'module'</span>,
      <span class="hljs-attr">globals</span>: {
        ...globals.browser, ...globals.node,
        <span class="hljs-attr">uni</span>: <span class="hljs-string">'readonly'</span>, <span class="hljs-attr">wx</span>: <span class="hljs-string">'readonly'</span>, <span class="hljs-attr">plus</span>: <span class="hljs-string">'readonly'</span> // è§£å†³ uni æŠ¥é”™
      },
    },
  },

  // ã€<span class="hljs-number">3</span>ã€‘TypeScript å¼ºç±»å‹æ”¯æŒ
  ...tseslint.configs.recommended,

  // ã€<span class="hljs-number">4</span>ã€‘Vue <span class="hljs-number">3</span> æ ¸å¿ƒè§„èŒƒï¼ˆå±æ€§æ¢è¡Œç­–ç•¥ï¼‰
  ...pluginVue.configs[<span class="hljs-string">'flat/recommended'</span>],
  {
    <span class="hljs-attr">files</span>: [<span class="hljs-string">'**/*.vue'</span>],
    <span class="hljs-attr">languageOptions</span>: {
      <span class="hljs-attr">parserOptions</span>: { <span class="hljs-attr">parser</span>: tseslint.parser } // Vue æ¨¡æ¿å†…æ”¯æŒ TS
    },
    <span class="hljs-attr">rules</span>: {
      <span class="hljs-string">'vue/multi-word-component-names'</span>: <span class="hljs-string">'off'</span>, // é€‚é… UniApp é¡µé¢å
      <span class="hljs-string">'vue/html-indent'</span>: [<span class="hljs-string">'error'</span>, <span class="hljs-number">2</span>],         // æ¨¡æ¿å¼ºåˆ¶ <span class="hljs-number">2</span> ç©ºæ ¼
      <span class="hljs-string">'vue/max-attributes-per-line'</span>: [<span class="hljs-string">'error'</span>, {
        <span class="hljs-attr">singleline</span>: { <span class="hljs-attr">max</span>: <span class="hljs-number">3</span> }, // è¶…è¿‡ <span class="hljs-number">3</span> ä¸ªå±æ€§å°±æ¢è¡Œ
        <span class="hljs-attr">multiline</span>: { <span class="hljs-attr">max</span>: <span class="hljs-number">1</span> }   // å¤šè¡Œæ¨¡å¼ä¸‹æ¯è¡Œåªèƒ½æœ‰ä¸€ä¸ªå±æ€§
      }],
      <span class="hljs-string">'vue/first-attribute-linebreak'</span>: [<span class="hljs-string">'error'</span>, {
        <span class="hljs-attr">singleline</span>: <span class="hljs-string">'beside'</span>, <span class="hljs-attr">multiline</span>: <span class="hljs-string">'below'</span>
      }]
    }
  },

  // ã€<span class="hljs-number">5</span>ã€‘Prettier å†²çªå¤„ç†ï¼šå¿…é¡»æ”¾åœ¨æ•°ç»„æœ€åä¸€è¡Œï¼
  pluginPrettierRecommended,
);
</code></pre>
<ol start="2">
<li>è§†è§‰ç»Ÿé¢†ï¼š<code>.prettierrc</code></li>
</ol>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"semi"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"singleQuote"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"tabWidth"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"useTabs"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"printWidth"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">100</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"trailingComma"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"all"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"endOfLine"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"auto"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<ol start="3">
<li>ç¼–è¾‘å™¨åº•å±‚é€»è¾‘ï¼š<code>.editorconfig</code></li>
</ol>
<p>è®© IDEA å’Œ VS Code åœ¨ä½ æ‰“å­—çš„ç¬¬ä¸€ç§’å°±æ˜ç™½ï¼šç¼©è¿›åªè¦ä¸¤ä¸ªç©ºæ ¼ã€‚</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">root</span> = <span class="hljs-literal">true</span>
<span class="hljs-section">[*]</span>
<span class="hljs-attr">indent_style</span> = space
<span class="hljs-attr">indent_size</span> = <span class="hljs-number">2</span>
<span class="hljs-attr">end_of_line</span> = lf
<span class="hljs-attr">insert_final_newline</span> = <span class="hljs-literal">true</span>
</code></pre>
<p>å››ã€ æé€Ÿä½“éªŒï¼šè®©å·¥å…·ä¸ºä½ æ‰“å·¥</p>
<ol>
<li>IDEA / WebStorm æ·±åº¦è”åŠ¨</li>
</ol>
<p>åˆ«å†æ‰‹åŠ¨æ•²Â <code>Ctrl+Alt+L</code>Â äº†ï¼</p>
<ul>
<li>è¿›å…¥Â <strong>Settings -&gt; ESLint</strong>ï¼Œå‹¾é€‰Â <strong>Run eslint --fix on save</strong>ã€‚</li>
<li>è¿›å…¥Â <strong>Settings -&gt; Prettier</strong>ï¼Œå‹¾é€‰Â <strong>Run on save</strong>ã€‚<br/>
<em>IDEA 2024+ ä¼šå®Œç¾è¯†åˆ«ä½ çš„Â <code>eslint.config.mjs</code>ã€‚</em></li>
</ul>
<ol start="2">
<li>Git æäº¤è‡ªåŠ¨â€œæ´—åœ°â€ (Husky + lint-staged)</li>
</ol>
<p>æƒ³è¦ä»£ç ä»“åº“æ°¸è¿œå¹²å¹²å‡€å‡€ï¼Ÿåœ¨Â <code>package.json</code>Â ä¸­åŠ å…¥è¿™é“é—¸é—¨ï¼š</p>
<p>json</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"lint-staged"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"*.{js,ts,vue}"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"eslint --fix"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"prettier --write"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"*.{css,scss,json,md}"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"prettier --write"</span><span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>æ‰§è¡ŒÂ <code>npx husky init</code>Â å¹¶å°†Â <code>.husky/pre-commit</code>Â æ”¹ä¸ºÂ <code>npx lint-staged</code>ã€‚ç°åœ¨ï¼Œä»»ä½•ä¸ç¬¦åˆè§„åˆ™çš„ä»£ç éƒ½åˆ«æƒ³æºœè¿› Git ä»“åº“ï¼</p>
<h2 data-id="heading-3">äº”ã€ ç»“è¯­</h2>
<p>è§„èŒƒä¸æ˜¯ä¸ºäº†é™åˆ¶è‡ªç”±ï¼Œè€Œæ˜¯ä¸ºäº†è®©å¼€å‘è€…åœ¨ 2025 å¹´ç¹é‡çš„ä¸šåŠ¡ä¸­ï¼Œèƒ½æ‹¥æœ‰ä¸€ä»½ä¼˜é›…çš„ä»£ç åº•åº§ã€‚</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[RAGå®æˆ˜|8ç§RAGæ¶æ„æµ…æ]]></title>    <link>https://juejin.cn/post/7585390679399333894</link>    <guid>https://juejin.cn/post/7585390679399333894</guid>    <pubDate>2025-12-20T07:02:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585390679399333894" data-draft-id="7585382553290686500" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="RAGå®æˆ˜|8ç§RAGæ¶æ„æµ…æ"/> <meta itemprop="keywords" content="AIGC,LangChain"/> <meta itemprop="datePublished" content="2025-12-20T07:02:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="å‘¨æœ«ç¨‹åºçŒ¿"/> <meta itemprop="url" content="https://juejin.cn/user/3245414056989757"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="æ˜é‡‘"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            RAGå®æˆ˜|8ç§RAGæ¶æ„æµ…æ
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3245414056989757/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    å‘¨æœ«ç¨‹åºçŒ¿
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T07:02:08.000Z" title="Sat Dec 20 2025 07:02:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    é˜…è¯»21åˆ†é’Ÿ
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>å› ä¸ºé¡¹ç›®çš„éœ€è¦ï¼Œä¹‹å‰ç ”ç©¶äº†ä¸€æ®µæ—¶é—´çš„<code>RAG</code>ï¼Œäºæ˜¯æœ¬æ–‡æ€»ç»“ 8 ç§Â <code>RAG</code>Â æ¶æ„ï¼Œå¯¹æ¯ç§æ¶æ„è¿›è¡Œç®€è¦ä»‹ç»ï¼Œå¹¶ç”¨Â <code>langchain</code>Â å®ç°å…¶å‚è€ƒä»£ç ã€‚</p>
<h2 data-id="heading-0">1. Naive RAG</h2>
<p><strong>ç®€ä»‹ï¼š</strong></p>
<p>Naive RAG æ˜¯æœ€åŸºç¡€çš„æ£€ç´¢å¢å¼ºç”Ÿæˆæ¶æ„ï¼Œé‡‡ç”¨â€œç´¢å¼•-æ£€ç´¢-ç”Ÿæˆâ€çš„ç»å…¸æµç¨‹ã€‚<strong>æ¶æ„ï¼š</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a791bbe7f4524e51b74053ad63de110f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZGo5pyr56iL5bqP54y_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766818928&amp;x-signature=ku0AJbn3D7xRqqygvjDvDp5jEfs%3D" alt="å›¾ç‰‡" loading="lazy"/></p>
<p><strong>å®ç°æ­¥éª¤ï¼š</strong></p>
<ul>
<li>æ•°æ®åŠ è½½ ï¼šæ”¶é›†æ•°æ®å¹¶è¿›è¡Œæ¸…æ´—ï¼Œæ¯”å¦‚å„ä¸ªæ–‡æ¡£æ ¼å¼çš„è½¬æ¢ï¼ŒOCR æ–‡å­—æå–ç­‰</li>
<li>åˆ†å—å’Œ embedding ï¼šå°†æ–‡æ¡£æ‹†åˆ†æ›´å°çš„ chunkï¼Œä¸€æ–¹é¢è®© embedding æ›´å¥½è½¬æ¢è¯­ä¹‰ä¿¡æ¯ï¼Œå¦ä¸€æ–¹é¢è§£å†³LLMçš„ä¸Šä¸‹æ–‡é•¿åº¦é™åˆ¶é—®é¢˜</li>
<li>å‘é‡å­˜å‚¨ï¼šå°† embedding å­˜å‚¨åˆ°å‘é‡æ•°æ®åº“ä¸­ï¼Œæ–¹ä¾¿å¿«é€Ÿæœç´¢</li>
<li>search å’Œ Promptå·¥ç¨‹ï¼šå¯¹äºæŸ¥æ‰¾çš„é—®é¢˜å…ˆé€šè¿‡å‘é‡æ•°æ®åº“æ£€ç´¢ï¼Œç„¶åå°†å¬å›çš„æ–‡ä»¶åŸæ–‡ï¼Œé€šè¿‡ Prompt åŠ å·¥æä¾›ç»™LLM</li>
<li>è¾“å‡ºç­”æ¡ˆï¼šLLM æ ¹æ® Prompt ç”Ÿæˆç­”æ¡ˆè¾“å‡º</li>
</ul>
<p><strong>å‚è€ƒä»£ç ï¼š</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span>Â langchain_openaiÂ <span class="hljs-keyword">import</span>Â ChatOpenAI
<span class="hljs-keyword">from</span>Â langchain_huggingfaceÂ <span class="hljs-keyword">import</span>Â HuggingFaceEmbeddings
<span class="hljs-keyword">from</span>Â langchain_community.vectorstoresÂ <span class="hljs-keyword">import</span>Â LanceDB
<span class="hljs-keyword">from</span>Â langchain.schemaÂ <span class="hljs-keyword">import</span>Â Document
<span class="hljs-keyword">from</span>Â langchain.chainsÂ <span class="hljs-keyword">import</span>Â RetrievalQA
<span class="hljs-keyword">from</span>Â langchain.promptsÂ <span class="hljs-keyword">import</span>Â PromptTemplate
<span class="hljs-keyword">import</span>Â lancedb

<span class="hljs-keyword">class</span>Â <span class="hljs-title class_">NaiveRAG</span>:
Â  Â Â <span class="hljs-keyword">def</span>Â <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
Â  Â  Â  Â  self.llm = ChatOpenAI(model=<span class="hljs-string">"gpt-5"</span>, temperature=<span class="hljs-number">0</span>)
Â  Â  Â  Â Â <span class="hljs-comment"># ä½¿ç”¨è½»é‡çº§çš„all-MiniLM-L6-v2æ¨¡å‹ï¼Œä»…80MB</span>
Â  Â  Â  Â  self.embeddings = HuggingFaceEmbeddings(
Â  Â  Â  Â  Â  Â  model_name=<span class="hljs-string">"sentence-transformers/all-MiniLM-L6-v2"</span>,
Â  Â  Â  Â  Â  Â  model_kwargs={<span class="hljs-string">"device"</span>:Â <span class="hljs-string">"cpu"</span>},
Â  Â  Â  Â  Â  Â  encode_kwargs={<span class="hljs-string">"normalize_embeddings"</span>:Â <span class="hljs-literal">True</span>}
Â  Â  Â  Â  )
Â  Â  Â  Â  self.db = lancedb.connect(<span class="hljs-string">"/tmp/lancedb_naive_rag"</span>)
Â  Â  Â  Â  self.vectorstore =Â <span class="hljs-literal">None</span>
Â  Â Â 
Â  Â Â <span class="hljs-keyword">def</span>Â <span class="hljs-title function_">build_index</span>(<span class="hljs-params">self, documents: <span class="hljs-built_in">list</span></span>):
Â  Â  Â  Â Â <span class="hljs-string">"""æ„å»ºå‘é‡ç´¢å¼•"""</span>
Â  Â  Â  Â  docs = [Document(page_content=d)Â <span class="hljs-keyword">for</span>Â dÂ <span class="hljs-keyword">in</span>Â documents]
Â  Â  Â  Â  self.vectorstore = LanceDB.from_documents(
Â  Â  Â  Â  Â  Â  docs,Â 
Â  Â  Â  Â  Â  Â  self.embeddings,
Â  Â  Â  Â  Â  Â  connection=self.db,
Â  Â  Â  Â  Â  Â  table_name=<span class="hljs-string">"naive_rag_docs"</span>
Â  Â  Â  Â  )
Â  Â Â 
Â  Â Â <span class="hljs-keyword">def</span>Â <span class="hljs-title function_">query</span>(<span class="hljs-params">self, question: <span class="hljs-built_in">str</span></span>)Â -&gt; <span class="hljs-built_in">str</span>:
Â  Â  Â  Â Â <span class="hljs-string">"""æ‰§è¡Œæ£€ç´¢å¹¶ç”Ÿæˆç­”æ¡ˆ"""</span>
Â  Â  Â  Â Â <span class="hljs-comment"># åˆ›å»ºæ£€ç´¢é“¾</span>
Â  Â  Â  Â  retriever = self.vectorstore.as_retriever(search_kwargs={<span class="hljs-string">"k"</span>:Â <span class="hljs-number">3</span>})
Â  Â  Â  Â Â 
Â  Â  Â  Â  prompt_template = PromptTemplate(
Â  Â  Â  Â  Â  Â  input_variables=[<span class="hljs-string">"context"</span>,Â <span class="hljs-string">"question"</span>],
Â  Â  Â  Â  Â  Â  template=<span class="hljs-string">"""åŸºäºä»¥ä¸‹ä¸Šä¸‹æ–‡å›ç­”é—®é¢˜ï¼š
Â  Â  Â  Â  Â  Â  ä¸Šä¸‹æ–‡: {context}
Â  Â  Â  Â  Â  Â  é—®é¢˜: {question}
Â  Â  Â  Â  Â  Â  ç­”æ¡ˆ:"""</span>
Â  Â  Â  Â  )
Â  Â  Â  Â Â 
Â  Â  Â  Â  qa_chain = RetrievalQA.from_chain_type(
Â  Â  Â  Â  Â  Â  llm=self.llm,
Â  Â  Â  Â  Â  Â  chain_type=<span class="hljs-string">"stuff"</span>,
Â  Â  Â  Â  Â  Â  retriever=retriever,
Â  Â  Â  Â  Â  Â  chain_type_kwargs={<span class="hljs-string">"prompt"</span>: prompt_template}
Â  Â  Â  Â  )
Â  Â  Â  Â Â 
Â  Â  Â  Â Â <span class="hljs-keyword">return</span>Â qa_chain.invoke({<span class="hljs-string">"query"</span>: question})[<span class="hljs-string">"result"</span>]

<span class="hljs-comment"># ä½¿ç”¨ç¤ºä¾‹</span>
naive_rag = NaiveRAG()
naive_rag.build_index([<span class="hljs-string">"æ–‡æ¡£1å†…å®¹..."</span>,Â <span class="hljs-string">"æ–‡æ¡£2å†…å®¹..."</span>,Â <span class="hljs-string">"æ–‡æ¡£3å†…å®¹..."</span>])
answer = naive_rag.query(<span class="hljs-string">"What is issue date of lease?"</span>)
<span class="hljs-built_in">print</span>(answer)
</code></pre>
<h2 data-id="heading-1">2. Multi-Head RAG</h2>
<p><strong>ç®€ä»‹ï¼š</strong></p>
<p>Multi-Head RAG å€Ÿé‰´äº† Transformer çš„å¤šå¤´æ³¨æ„åŠ›æœºåˆ¶ï¼Œåˆ©ç”¨æ¨¡å‹ä¸åŒæ³¨æ„åŠ›å¤´æ•è·çš„å¤šæ ·åŒ–è¯­ä¹‰ç‰¹å¾è¿›è¡Œå¹¶è¡Œæ£€ç´¢ã€‚</p>
<p><strong>æ¶æ„ï¼š</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f2d889c3e8cf46d9a2bf9be204b3dbec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZGo5pyr56iL5bqP54y_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766818928&amp;x-signature=YUXFtx%2FXAO9Q0PjbKx6buyMl9UY%3D" alt="å›¾ç‰‡" loading="lazy"/></p>
<p><strong>å®ç°æ­¥éª¤ï¼š</strong></p>
<ul>
<li>å¤šå¤´æ³¨æ„åŠ›Embeddingï¼šåˆ©ç”¨ Transformer æ¨¡å‹çš„å¤šå¤´æ³¨æ„åŠ›å±‚ï¼ˆè€Œéæœ€åä¸€å±‚ï¼‰ç”Ÿæˆå¤šä¸ªembeddingï¼Œæ¯ä¸ªå¤´æ•è·ä¸åŒçš„è¯­ä¹‰ç‰¹å¾</li>
<li>å¤šå‘é‡ç´¢å¼•æ„å»ºï¼šä¸ºæ¯ä¸ªæ³¨æ„åŠ›å¤´æ„å»ºç‹¬ç«‹çš„å‘é‡ç´¢å¼•ï¼Œå­˜å‚¨ä¸åŒç»´åº¦çš„è¯­ä¹‰ä¿¡æ¯</li>
<li>å¹¶è¡Œæ£€ç´¢ï¼šé’ˆå¯¹æŸ¥è¯¢ï¼Œåœ¨å¤šä¸ªç´¢å¼•ä¸Šå¹¶è¡Œæ£€ç´¢ï¼Œæ¯ä¸ªå¤´è¿”å›æœ€ç›¸å…³çš„æ–‡æ¡£ç‰‡æ®µ</li>
<li>ç»“æœèåˆï¼šå°†å¤šä¸ªå¤´çš„æ£€ç´¢ç»“æœè¿›è¡Œå»é‡å’Œèåˆï¼Œç»¼åˆè€ƒè™‘ä¸åŒè¯­ä¹‰ç»´åº¦çš„ç›¸å…³æ€§</li>
<li>ä¸Šä¸‹æ–‡ç”Ÿæˆï¼šå°†èåˆåçš„æ–‡æ¡£ç‰‡æ®µç»„è£…æˆä¸Šä¸‹æ–‡ï¼Œè¾“å…¥LLMç”Ÿæˆç­”æ¡ˆ</li>
</ul>
<p><strong>ç›¸å…³å‚è€ƒå¦‚ä¸‹ï¼š</strong></p>
<p>è®ºæ–‡ï¼š<a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fpdf%2F2406.05085" target="_blank" title="https://arxiv.org/pdf/2406.05085" ref="nofollow noopener noreferrer">arxiv.org/pdf/2406.05â€¦</a></p>
<p>ä»£ç ï¼š<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fspcl%2FMRAG" target="_blank" title="https://github.com/spcl/MRAG" ref="nofollow noopener noreferrer">github.com/spcl/MRAG</a></p>
<p><strong>å‚è€ƒä»£ç ï¼š</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span>Â langchain_openaiÂ <span class="hljs-keyword">import</span>Â ChatOpenAI
<span class="hljs-keyword">from</span>Â langchain_community.vectorstoresÂ <span class="hljs-keyword">import</span>Â LanceDB
<span class="hljs-keyword">from</span>Â langchain.schemaÂ <span class="hljs-keyword">import</span>Â Document
<span class="hljs-keyword">from</span>Â langchain.embeddings.baseÂ <span class="hljs-keyword">import</span>Â Embeddings
<span class="hljs-keyword">from</span>Â transformersÂ <span class="hljs-keyword">import</span>Â AutoModel, AutoTokenizer
<span class="hljs-keyword">import</span>Â torch
<span class="hljs-keyword">import</span>Â lancedb
<span class="hljs-keyword">from</span>Â typingÂ <span class="hljs-keyword">import</span>Â <span class="hljs-type">List</span>

<span class="hljs-keyword">class</span>Â <span class="hljs-title class_">MultiHeadEmbeddings</span>(<span class="hljs-title class_ inherited__">Embeddings</span>):
Â  Â Â <span class="hljs-string">"""è‡ªå®šä¹‰å¤šå¤´æ³¨æ„åŠ›Embeddingï¼Œç»§æ‰¿LangChainçš„EmbeddingsåŸºç±»"""</span>
Â  Â Â <span class="hljs-keyword">def</span>Â <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, model_name=<span class="hljs-string">"bert-base-uncased"</span>, head_index=<span class="hljs-number">0</span>, num_heads=<span class="hljs-number">12</span></span>):
Â  Â  Â  Â  self.tokenizer = AutoTokenizer.from_pretrained(model_name)
Â  Â  Â  Â  self.model = AutoModel.from_pretrained(model_name, output_hidden_states=<span class="hljs-literal">True</span>)
Â  Â  Â  Â  self.head_index = head_index
Â  Â  Â  Â  self.num_heads = num_heads
Â  Â  Â  Â  self.head_dim =Â <span class="hljs-number">768</span>Â // num_heads Â <span class="hljs-comment"># BERT hidden size / num_heads</span>
Â  Â Â 
Â  Â Â <span class="hljs-keyword">def</span>Â <span class="hljs-title function_">_get_head_embedding</span>(<span class="hljs-params">self, texts: <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]</span>)Â -&gt; <span class="hljs-type">List</span>[<span class="hljs-type">List</span>[<span class="hljs-built_in">float</span>]]:
Â  Â  Â  Â Â <span class="hljs-string">"""è·å–æŒ‡å®šå¤´çš„embedding"""</span>
Â  Â  Â  Â  inputs = self.tokenizer(texts, return_tensors=<span class="hljs-string">"pt"</span>, padding=<span class="hljs-literal">True</span>, truncation=<span class="hljs-literal">True</span>)
Â  Â  Â  Â Â <span class="hljs-keyword">with</span>Â torch.no_grad():
Â  Â  Â  Â  Â  Â  outputs = self.model(**inputs, output_hidden_states=<span class="hljs-literal">True</span>)
Â  Â  Â  Â  hidden_states = outputs.hidden_states[-<span class="hljs-number">2</span>] Â <span class="hljs-comment"># å€’æ•°ç¬¬äºŒå±‚</span>
Â  Â  Â  Â  start = self.head_index * self.head_dim
Â  Â  Â  Â  end = (self.head_index +Â <span class="hljs-number">1</span>) * self.head_dim
Â  Â  Â  Â  head_emb = hidden_states[:,Â <span class="hljs-number">0</span>, start:end].numpy()
Â  Â  Â  Â Â <span class="hljs-keyword">return</span>Â head_emb.tolist()
Â  Â Â 
Â  Â Â <span class="hljs-keyword">def</span>Â <span class="hljs-title function_">embed_documents</span>(<span class="hljs-params">self, texts: <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]</span>)Â -&gt; <span class="hljs-type">List</span>[<span class="hljs-type">List</span>[<span class="hljs-built_in">float</span>]]:
Â  Â  Â  Â Â <span class="hljs-keyword">return</span>Â self._get_head_embedding(texts)
Â  Â Â 
Â  Â Â <span class="hljs-keyword">def</span>Â <span class="hljs-title function_">embed_query</span>(<span class="hljs-params">self, text: <span class="hljs-built_in">str</span></span>)Â -&gt; <span class="hljs-type">List</span>[<span class="hljs-built_in">float</span>]:
Â  Â  Â  Â Â <span class="hljs-keyword">return</span>Â self._get_head_embedding([text])[<span class="hljs-number">0</span>]

<span class="hljs-keyword">class</span>Â <span class="hljs-title class_">MultiHeadRAG</span>:
Â  Â Â <span class="hljs-keyword">def</span>Â <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, num_heads=<span class="hljs-number">12</span></span>):
Â  Â  Â  Â  self.llm = ChatOpenAI(model=<span class="hljs-string">"gpt-5"</span>, temperature=<span class="hljs-number">0</span>)
Â  Â  Â  Â  self.num_heads = num_heads
Â  Â  Â  Â  self.db = lancedb.connect(<span class="hljs-string">"/tmp/lancedb_multihead_rag"</span>)
Â  Â  Â  Â  self.vectorstores = [] Â <span class="hljs-comment"># æ¯ä¸ªå¤´ä¸€ä¸ªå‘é‡å­˜å‚¨</span>
Â  Â  Â  Â  self.documents = []
Â  Â Â 
Â  Â Â <span class="hljs-keyword">def</span>Â <span class="hljs-title function_">build_index</span>(<span class="hljs-params">self, documents: <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]</span>):
Â  Â  Â  Â Â <span class="hljs-string">"""ä¸ºæ¯ä¸ªå¤´æ„å»ºç‹¬ç«‹çš„LanceDBå‘é‡å­˜å‚¨"""</span>
Â  Â  Â  Â  self.documents = documents
Â  Â  Â  Â  docs = [Document(page_content=d)Â <span class="hljs-keyword">for</span>Â dÂ <span class="hljs-keyword">in</span>Â documents]
Â  Â  Â  Â Â 
Â  Â  Â  Â Â <span class="hljs-keyword">for</span>Â head_idxÂ <span class="hljs-keyword">in</span>Â <span class="hljs-built_in">range</span>(self.num_heads):
Â  Â  Â  Â  Â  Â  embeddings = MultiHeadEmbeddings(head_index=head_idx, num_heads=self.num_heads)
Â  Â  Â  Â  Â  Â  vectorstore = LanceDB.from_documents(
Â  Â  Â  Â  Â  Â  Â  Â  docs,Â 
Â  Â  Â  Â  Â  Â  Â  Â  embeddings,
Â  Â  Â  Â  Â  Â  Â  Â  connection=self.db,
Â  Â  Â  Â  Â  Â  Â  Â  table_name=<span class="hljs-string">f"head_<span class="hljs-subst">{head_idx}</span>_docs"</span>
Â  Â  Â  Â  Â  Â  )
Â  Â  Â  Â  Â  Â  self.vectorstores.append(vectorstore)
Â  Â Â 
Â  Â Â <span class="hljs-keyword">def</span>Â <span class="hljs-title function_">search</span>(<span class="hljs-params">self, query: <span class="hljs-built_in">str</span>, top_k: <span class="hljs-built_in">int</span> =Â <span class="hljs-number">3</span></span>)Â -&gt; <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]:
Â  Â  Â  Â Â <span class="hljs-string">"""å¤šå¤´å¹¶è¡Œæ£€ç´¢å¹¶èåˆç»“æœ"""</span>
Â  Â  Â  Â  all_results = <span class="hljs-built_in">set</span>()
Â  Â  Â  Â Â <span class="hljs-keyword">for</span>Â vectorstoreÂ <span class="hljs-keyword">in</span>Â self.vectorstores:
Â  Â  Â  Â  Â  Â  docs = vectorstore.similarity_search(query, k=top_k)
Â  Â  Â  Â  Â  Â Â <span class="hljs-keyword">for</span>Â docÂ <span class="hljs-keyword">in</span>Â docs:
Â  Â  Â  Â  Â  Â  Â  Â  all_results.add(doc.page_content)
Â  Â  Â  Â Â <span class="hljs-keyword">return</span>Â <span class="hljs-built_in">list</span>(all_results)
Â  Â Â 
Â  Â Â <span class="hljs-keyword">def</span>Â <span class="hljs-title function_">query</span>(<span class="hljs-params">self, question: <span class="hljs-built_in">str</span></span>)Â -&gt; <span class="hljs-built_in">str</span>:
Â  Â  Â  Â Â <span class="hljs-string">"""æ£€ç´¢å¹¶ç”Ÿæˆç­”æ¡ˆ"""</span>
Â  Â  Â  Â  retrieved_docs = self.search(question)
Â  Â  Â  Â  context =Â <span class="hljs-string">"\n\n"</span>.join(retrieved_docs)
Â  Â  Â  Â Â 
Â  Â  Â  Â Â <span class="hljs-keyword">from</span>Â langchain.promptsÂ <span class="hljs-keyword">import</span>Â ChatPromptTemplate
Â  Â  Â  Â  prompt = ChatPromptTemplate.from_template(
Â  Â  Â  Â  Â  Â Â <span class="hljs-string">"""åŸºäºä»¥ä¸‹å¤šç»´åº¦æ£€ç´¢çš„ä¸Šä¸‹æ–‡å›ç­”é—®é¢˜ï¼š
Â  Â  Â  Â  Â  Â  ä¸Šä¸‹æ–‡: {context}
Â  Â  Â  Â  Â  Â  é—®é¢˜: {question}
Â  Â  Â  Â  Â  Â  ç­”æ¡ˆ:"""</span>
Â  Â  Â  Â  )
Â  Â  Â  Â  chain = prompt | self.llm
Â  Â  Â  Â  response = chain.invoke({<span class="hljs-string">"context"</span>: context,Â <span class="hljs-string">"question"</span>: question})
Â  Â  Â  Â Â <span class="hljs-keyword">return</span>Â response.content

<span class="hljs-comment"># ä½¿ç”¨ç¤ºä¾‹</span>
mrag = MultiHeadRAG(num_heads=<span class="hljs-number">12</span>)
documents = [<span class="hljs-string">"æ–‡æ¡£1çš„å†…å®¹..."</span>,Â <span class="hljs-string">"æ–‡æ¡£2çš„å†…å®¹..."</span>,Â <span class="hljs-string">"æ–‡æ¡£3çš„å†…å®¹..."</span>]
mrag.build_index(documents)
answer = mrag.query(<span class="hljs-string">"æŸ¥è¯¢é—®é¢˜"</span>)
<span class="hljs-built_in">print</span>(answer)
</code></pre>
<h2 data-id="heading-2">3. Corrective RAG</h2>
<p><strong>ç®€ä»‹ï¼š</strong></p>
<p>Corrective RAG åœ¨ä¼ ç»Ÿ RAG åŸºç¡€ä¸Šå¼•å…¥äº†æ–‡æ¡£è´¨é‡è¯„ä¼°å’Œè‡ªæˆ‘ä¿®æ­£æœºåˆ¶ã€‚å¯¹æ£€ç´¢åˆ°çš„æ¯ä¸ªæ–‡æ¡£è¿›è¡Œç›¸å…³æ€§è¯„åˆ†ï¼ˆCorrect/Incorrect/Ambiguousï¼‰ï¼Œå¯¹äºè´¨é‡ä¸è¶³çš„æ£€ç´¢ç»“æœï¼Œæœç´¢å¤–éƒ¨çŸ¥è¯†æºè¿›è¡Œè¡¥å……ã€‚</p>
<p><strong>æ¶æ„ï¼š</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fe0109c62e3e43f68ce49846a9450b74~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZGo5pyr56iL5bqP54y_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766818928&amp;x-signature=Wei8vQwsNIC1FczlF8K80NbNPsE%3D" alt="å›¾ç‰‡" loading="lazy"/></p>
<p><strong>å®ç°æ­¥éª¤ï¼š</strong></p>
<ul>
<li>åˆå§‹æ£€ç´¢ï¼šä½¿ç”¨å‘é‡æ£€ç´¢è·å–ä¸æŸ¥è¯¢ç›¸å…³çš„å€™é€‰æ–‡æ¡£</li>
<li>ç›¸å…³æ€§è¯„ä¼°ï¼šä½¿ç”¨LLMæˆ–ä¸“é—¨çš„è¯„ä¼°æ¨¡å‹å¯¹æ¯ä¸ªæ£€ç´¢åˆ°çš„æ–‡æ¡£è¿›è¡Œç›¸å…³æ€§è¯„åˆ†ï¼ˆCorrect/Incorrect/Ambiguousï¼‰</li>
<li>çŸ¥è¯†ä¿®æ­£ï¼šå¯¹äºè¯„ä¼°ä¸ºä¸ç›¸å…³æˆ–æ¨¡ç³Šçš„æ–‡æ¡£ï¼Œè§¦å‘çŸ¥è¯†ä¿®æ­£æœºåˆ¶</li>
<li>ç½‘ç»œæœç´¢å¢å¼ºï¼šå½“æœ¬åœ°çŸ¥è¯†åº“æ–‡æ¡£è´¨é‡ä¸è¶³æ—¶ï¼Œè°ƒç”¨å¤–éƒ¨æœç´¢å¼•æ“è·å–è¡¥å……ä¿¡æ¯</li>
<li>æ–‡æ¡£é‡ç»„ï¼šå°†è¯„ä¼°ä¸ºç›¸å…³çš„æ–‡æ¡£å’Œè¡¥å……æœç´¢ç»“æœé‡æ–°ç»„ç»‡ï¼Œå»é™¤å†—ä½™ä¿¡æ¯</li>
<li>ç­”æ¡ˆç”Ÿæˆï¼šåŸºäºä¿®æ­£åçš„é«˜è´¨é‡ä¸Šä¸‹æ–‡ç”Ÿæˆæœ€ç»ˆç­”æ¡ˆ</li>
</ul>
<p><strong>å‚è€ƒä»£ç ï¼š</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span>Â langchain_openaiÂ <span class="hljs-keyword">import</span>Â ChatOpenAI
<span class="hljs-keyword">from</span>Â langchain_huggingfaceÂ <span class="hljs-keyword">import</span>Â HuggingFaceEmbeddings
<span class="hljs-keyword">from</span>Â langchain_community.vectorstoresÂ <span class="hljs-keyword">import</span>Â LanceDB
<span class="hljs-keyword">from</span>Â langchain_community.toolsÂ <span class="hljs-keyword">import</span>Â TavilySearchResults
<span class="hljs-keyword">from</span>Â langchain.schemaÂ <span class="hljs-keyword">import</span>Â Document
<span class="hljs-keyword">from</span>Â langchain.promptsÂ <span class="hljs-keyword">import</span>Â ChatPromptTemplate
<span class="hljs-keyword">from</span>Â langchain_core.output_parsersÂ <span class="hljs-keyword">import</span>Â StrOutputParser
<span class="hljs-keyword">import</span>Â lancedb
<span class="hljs-keyword">from</span>Â typingÂ <span class="hljs-keyword">import</span>Â <span class="hljs-type">List</span>

<span class="hljs-keyword">class</span>Â <span class="hljs-title class_">CorrectiveRAG</span>:
Â  Â Â <span class="hljs-keyword">def</span>Â <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
Â  Â  Â  Â  self.llm = ChatOpenAI(model=<span class="hljs-string">"gpt-5"</span>, temperature=<span class="hljs-number">0</span>)
Â  Â  Â  Â  self.embeddings = HuggingFaceEmbeddings(
Â  Â  Â  Â  Â  Â  model_name=<span class="hljs-string">"sentence-transformers/all-MiniLM-L6-v2"</span>,
Â  Â  Â  Â  Â  Â  model_kwargs={<span class="hljs-string">"device"</span>:Â <span class="hljs-string">"cpu"</span>},
Â  Â  Â  Â  Â  Â  encode_kwargs={<span class="hljs-string">"normalize_embeddings"</span>:Â <span class="hljs-literal">True</span>}
Â  Â  Â  Â  )
Â  Â  Â  Â  self.db = lancedb.connect(<span class="hljs-string">"/tmp/lancedb_corrective_rag"</span>)
Â  Â  Â  Â  self.vectorstore =Â <span class="hljs-literal">None</span>
Â  Â  Â  Â Â <span class="hljs-comment"># ä½¿ç”¨Tavilyè¿›è¡Œç½‘ç»œæœç´¢</span>
Â  Â  Â  Â  self.web_search = TavilySearchResults(max_results=<span class="hljs-number">3</span>)
Â  Â Â 
Â  Â Â <span class="hljs-keyword">def</span>Â <span class="hljs-title function_">build_index</span>(<span class="hljs-params">self, documents: <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]</span>):
Â  Â  Â  Â Â <span class="hljs-string">"""æ„å»ºå‘é‡ç´¢å¼•"""</span>
Â  Â  Â  Â  docs = [Document(page_content=d)Â <span class="hljs-keyword">for</span>Â dÂ <span class="hljs-keyword">in</span>Â documents]
Â  Â  Â  Â  self.vectorstore = LanceDB.from_documents(
Â  Â  Â  Â  Â  Â  docs,Â 
Â  Â  Â  Â  Â  Â  self.embeddings,
Â  Â  Â  Â  Â  Â  connection=self.db,
Â  Â  Â  Â  Â  Â  table_name=<span class="hljs-string">"corrective_rag_docs"</span>
Â  Â  Â  Â  )
Â  Â Â 
Â  Â Â <span class="hljs-keyword">def</span>Â <span class="hljs-title function_">evaluate_relevance</span>(<span class="hljs-params">self, query: <span class="hljs-built_in">str</span>, document: <span class="hljs-built_in">str</span></span>)Â -&gt; <span class="hljs-built_in">str</span>:
Â  Â  Â  Â Â <span class="hljs-string">"""è¯„ä¼°æ–‡æ¡£ä¸æŸ¥è¯¢çš„ç›¸å…³æ€§"""</span>
Â  Â  Â  Â  prompt = ChatPromptTemplate.from_template(
Â  Â  Â  Â  Â  Â Â <span class="hljs-string">"""è¯„ä¼°ä»¥ä¸‹æ–‡æ¡£ä¸æŸ¥è¯¢çš„ç›¸å…³æ€§ã€‚
Â  Â  Â  Â  Â  Â  æŸ¥è¯¢: {query}
Â  Â  Â  Â  Â  Â  æ–‡æ¡£: {document}
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  è¯·å›ç­”: CORRECT(ç›¸å…³), INCORRECT(ä¸ç›¸å…³), æˆ– AMBIGUOUS(æ¨¡ç³Š)
Â  Â  Â  Â  Â  Â  åªè¿”å›ä¸€ä¸ªè¯ã€‚"""</span>
Â  Â  Â  Â  )
Â  Â  Â  Â  chain = prompt | self.llm | StrOutputParser()
Â  Â  Â  Â  response = chain.invoke({<span class="hljs-string">"query"</span>: query,Â <span class="hljs-string">"document"</span>: document})
Â  Â  Â  Â Â <span class="hljs-keyword">return</span>Â response.strip().upper()
Â  Â Â 
Â  Â Â <span class="hljs-keyword">def</span>Â <span class="hljs-title function_">search_web</span>(<span class="hljs-params">self, query: <span class="hljs-built_in">str</span></span>)Â -&gt; <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]:
Â  Â  Â  Â Â <span class="hljs-string">"""å½“æœ¬åœ°æ–‡æ¡£ä¸è¶³æ—¶è¿›è¡Œç½‘ç»œæœç´¢"""</span>
Â  Â  Â  Â Â <span class="hljs-keyword">try</span>:
Â  Â  Â  Â  Â  Â  results = self.web_search.invoke(query)
Â  Â  Â  Â  Â  Â Â <span class="hljs-keyword">return</span>Â [r[<span class="hljs-string">"content"</span>]Â <span class="hljs-keyword">for</span>Â rÂ <span class="hljs-keyword">in</span>Â resultsÂ <span class="hljs-keyword">if</span><span class="hljs-string">"content"</span><span class="hljs-keyword">in</span>Â r]
Â  Â  Â  Â Â <span class="hljs-keyword">except</span>:
Â  Â  Â  Â  Â  Â Â <span class="hljs-keyword">return</span>Â []
Â  Â Â 
Â  Â Â <span class="hljs-keyword">def</span>Â <span class="hljs-title function_">retrieve_and_correct</span>(<span class="hljs-params">self, query: <span class="hljs-built_in">str</span>, top_k: <span class="hljs-built_in">int</span> =Â <span class="hljs-number">5</span></span>)Â -&gt; <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]:
Â  Â  Â  Â Â <span class="hljs-string">"""æ£€ç´¢å¹¶ä¿®æ­£æ–‡æ¡£"""</span>
Â  Â  Â  Â Â <span class="hljs-comment"># 1. åˆå§‹æ£€ç´¢</span>
Â  Â  Â  Â  retriever = self.vectorstore.as_retriever(search_kwargs={<span class="hljs-string">"k"</span>: top_k})
Â  Â  Â  Â  docs = retriever.invoke(query)
Â  Â  Â  Â Â 
Â  Â  Â  Â Â <span class="hljs-comment"># 2. è¯„ä¼°æ¯ä¸ªæ–‡æ¡£çš„ç›¸å…³æ€§</span>
Â  Â  Â  Â  correct_docs = []
Â  Â  Â  Â  need_web_search =Â <span class="hljs-literal">True</span>
Â  Â  Â  Â Â 
Â  Â  Â  Â Â <span class="hljs-keyword">for</span>Â docÂ <span class="hljs-keyword">in</span>Â docs:
Â  Â  Â  Â  Â  Â  relevance = self.evaluate_relevance(query, doc.page_content)
Â  Â  Â  Â  Â  Â Â <span class="hljs-keyword">if</span>Â relevance ==Â <span class="hljs-string">"CORRECT"</span>:
Â  Â  Â  Â  Â  Â  Â  Â  correct_docs.append(doc.page_content)
Â  Â  Â  Â  Â  Â  Â  Â  need_web_search =Â <span class="hljs-literal">False</span>
Â  Â  Â  Â  Â  Â Â <span class="hljs-keyword">elif</span>Â relevance ==Â <span class="hljs-string">"AMBIGUOUS"</span>:
Â  Â  Â  Â  Â  Â  Â  Â Â <span class="hljs-comment"># å¯¹æ¨¡ç³Šæ–‡æ¡£è¿›è¡ŒçŸ¥è¯†ç²¾ç‚¼</span>
Â  Â  Â  Â  Â  Â  Â  Â  refined = self.refine_document(query, doc.page_content)
Â  Â  Â  Â  Â  Â  Â  Â  correct_docs.append(refined)
Â  Â  Â  Â Â 
Â  Â  Â  Â Â <span class="hljs-comment"># 3. å¿…è¦æ—¶è¿›è¡Œç½‘ç»œæœç´¢è¡¥å……</span>
Â  Â  Â  Â Â <span class="hljs-keyword">if</span>Â need_web_searchÂ <span class="hljs-keyword">or</span>Â <span class="hljs-built_in">len</span>(correct_docs) &lt;Â <span class="hljs-number">2</span>:
Â  Â  Â  Â  Â  Â  web_results = self.search_web(query)
Â  Â  Â  Â  Â  Â  correct_docs.extend(web_results)
Â  Â  Â  Â Â 
Â  Â  Â  Â Â <span class="hljs-keyword">return</span>Â correct_docs
Â  Â Â 
Â  Â Â <span class="hljs-keyword">def</span>Â <span class="hljs-title function_">refine_document</span>(<span class="hljs-params">self, query: <span class="hljs-built_in">str</span>, document: <span class="hljs-built_in">str</span></span>)Â -&gt; <span class="hljs-built_in">str</span>:
Â  Â  Â  Â Â <span class="hljs-string">"""ç²¾ç‚¼æ–‡æ¡£ï¼Œæå–ä¸æŸ¥è¯¢ç›¸å…³çš„éƒ¨åˆ†"""</span>
Â  Â  Â  Â  prompt = ChatPromptTemplate.from_template(
Â  Â  Â  Â  Â  Â Â <span class="hljs-string">"""ä»ä»¥ä¸‹æ–‡æ¡£ä¸­æå–ä¸æŸ¥è¯¢æœ€ç›¸å…³çš„ä¿¡æ¯ï¼š
Â  Â  Â  Â  Â  Â  æŸ¥è¯¢: {query}
Â  Â  Â  Â  Â  Â  æ–‡æ¡£: {document}
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  è¯·åªè¿”å›ç›¸å…³çš„ç²¾ç‚¼å†…å®¹ï¼š"""</span>
Â  Â  Â  Â  )
Â  Â  Â  Â  chain = prompt | self.llm | StrOutputParser()
Â  Â  Â  Â Â <span class="hljs-keyword">return</span>Â chain.invoke({<span class="hljs-string">"query"</span>: query,Â <span class="hljs-string">"document"</span>: document})
Â  Â Â 
Â  Â Â <span class="hljs-keyword">def</span>Â <span class="hljs-title function_">query</span>(<span class="hljs-params">self, question: <span class="hljs-built_in">str</span></span>)Â -&gt; <span class="hljs-built_in">str</span>:
Â  Â  Â  Â Â <span class="hljs-string">"""ç”Ÿæˆæœ€ç»ˆç­”æ¡ˆ"""</span>
Â  Â  Â  Â  corrected_docs = self.retrieve_and_correct(question)
Â  Â  Â  Â  context =Â <span class="hljs-string">"\n\n"</span>.join(corrected_docs)
Â  Â  Â  Â Â 
Â  Â  Â  Â  prompt = ChatPromptTemplate.from_template(
Â  Â  Â  Â  Â  Â Â <span class="hljs-string">"""åŸºäºä»¥ä¸‹ç»è¿‡ä¿®æ­£çš„ä¸Šä¸‹æ–‡å›ç­”é—®é¢˜ï¼š
Â  Â  Â  Â  Â  Â  ä¸Šä¸‹æ–‡: {context}
Â  Â  Â  Â  Â  Â  é—®é¢˜: {question}
Â  Â  Â  Â  Â  Â  ç­”æ¡ˆ:"""</span>
Â  Â  Â  Â  )
Â  Â  Â  Â  chain = prompt | self.llm | StrOutputParser()
Â  Â  Â  Â Â <span class="hljs-keyword">return</span>Â chain.invoke({<span class="hljs-string">"context"</span>: context,Â <span class="hljs-string">"question"</span>: question})

<span class="hljs-comment"># ä½¿ç”¨ç¤ºä¾‹</span>
crag = CorrectiveRAG()
crag.build_index([<span class="hljs-string">"æ–‡æ¡£1..."</span>,Â <span class="hljs-string">"æ–‡æ¡£2..."</span>,Â <span class="hljs-string">"æ–‡æ¡£3..."</span>])
answer = crag.query(<span class="hljs-string">"ä½ çš„é—®é¢˜æ˜¯ä»€ä¹ˆï¼Ÿ"</span>)
<span class="hljs-built_in">print</span>(answer)
</code></pre>
<h2 data-id="heading-3">4. Agentic RAG</h2>
<p><strong>ç®€ä»‹ï¼š</strong></p>
<p>Agentic RAGï¼ˆæ™ºèƒ½ä½“RAGï¼‰å°† AI Agent çš„è§„åˆ’å’Œæ¨ç†èƒ½åŠ›ä¸ RAG ç›¸ç»“åˆã€‚<br/>
Agent å¯ä»¥è‡ªä¸»åˆ†ææŸ¥è¯¢ã€åˆ¶å®šæ£€ç´¢ç­–ç•¥ã€é€‰æ‹©åˆé€‚çš„å·¥å…·ï¼ˆè¯­ä¹‰æœç´¢ã€å…³é”®è¯æœç´¢ã€è®¡ç®—å™¨ç­‰ï¼‰ï¼Œå¹¶æ ¹æ®ä¸­é—´ç»“æœè¿›è¡Œè¿­ä»£ä¼˜åŒ–ã€‚</p>
<p><strong>æ¶æ„ï¼š</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e2d4ac2fafbf4f2f8a4549436c5adc3f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZGo5pyr56iL5bqP54y_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766818928&amp;x-signature=nzUF6IDJ6xHC4IINPGVnM04N3Ig%3D" alt="å›¾ç‰‡" loading="lazy"/></p>
<p><strong>å®ç°æ­¥éª¤ï¼š</strong></p>
<ul>
<li>Agentåˆå§‹åŒ–ï¼šåˆ›å»ºå…·æœ‰æ¨ç†å’Œè§„åˆ’èƒ½åŠ›çš„AI Agentï¼Œé…å¤‡æ£€ç´¢å·¥å…·</li>
<li>ä»»åŠ¡åˆ†è§£ï¼šAgentåˆ†æç”¨æˆ·æŸ¥è¯¢ï¼Œå°†å¤æ‚é—®é¢˜åˆ†è§£ä¸ºå¤šä¸ªå­ä»»åŠ¡</li>
<li>å·¥å…·é€‰æ‹©ï¼šAgentæ ¹æ®å­ä»»åŠ¡ç‰¹ç‚¹é€‰æ‹©åˆé€‚çš„å·¥å…·ï¼ˆæ£€ç´¢ã€è®¡ç®—ã€APIè°ƒç”¨ç­‰ï¼‰</li>
<li>è¿­ä»£æ£€ç´¢ï¼šAgentå¯ä»¥æ ¹æ®ä¸­é—´ç»“æœå†³å®šæ˜¯å¦éœ€è¦è¿›ä¸€æ­¥æ£€ç´¢æˆ–è°ƒæ•´æŸ¥è¯¢ç­–ç•¥</li>
<li>æ¨ç†æ•´åˆï¼šAgentå¯¹å¤šè½®æ£€ç´¢å’Œå·¥å…·è°ƒç”¨çš„ç»“æœè¿›è¡Œæ¨ç†å’Œæ•´åˆ</li>
<li>è‡ªæˆ‘åæ€ï¼šAgentè¯„ä¼°ç­”æ¡ˆè´¨é‡ï¼Œå¿…è¦æ—¶è¿›è¡Œè‡ªæˆ‘ä¿®æ­£</li>
<li>æœ€ç»ˆè¾“å‡ºï¼šç”Ÿæˆå®Œæ•´ã€å‡†ç¡®çš„ç­”æ¡ˆ</li>
</ul>
<p><strong>å‚è€ƒä»£ç ï¼š</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span>Â langchain_openaiÂ <span class="hljs-keyword">import</span>Â ChatOpenAI
<span class="hljs-keyword">from</span>Â langchain_huggingfaceÂ <span class="hljs-keyword">import</span>Â HuggingFaceEmbeddings
<span class="hljs-keyword">from</span>Â langchain_community.vectorstoresÂ <span class="hljs-keyword">import</span>Â LanceDB
<span class="hljs-keyword">from</span>Â langchain.schemaÂ <span class="hljs-keyword">import</span>Â Document
<span class="hljs-keyword">from</span>Â langchain.agentsÂ <span class="hljs-keyword">import</span>Â AgentExecutor, create_tool_calling_agent
<span class="hljs-keyword">from</span>Â langchain.toolsÂ <span class="hljs-keyword">import</span>Â tool
<span class="hljs-keyword">from</span>Â langchain_core.promptsÂ <span class="hljs-keyword">import</span>Â ChatPromptTemplate, MessagesPlaceholder
<span class="hljs-keyword">import</span>Â lancedb
<span class="hljs-keyword">from</span>Â typingÂ <span class="hljs-keyword">import</span>Â <span class="hljs-type">List</span>

<span class="hljs-keyword">class</span>Â <span class="hljs-title class_">AgenticRAG</span>:
Â  Â Â <span class="hljs-keyword">def</span>Â <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
Â  Â  Â  Â  self.llm = ChatOpenAI(model=<span class="hljs-string">"gpt-4"</span>, temperature=<span class="hljs-number">0</span>)
Â  Â  Â  Â Â <span class="hljs-comment"># ä½¿ç”¨è½»é‡çº§çš„all-MiniLM-L6-v2æ¨¡å‹ï¼Œä»…80MB</span>
Â  Â  Â  Â  self.embeddings = HuggingFaceEmbeddings(
Â  Â  Â  Â  Â  Â  model_name=<span class="hljs-string">"sentence-transformers/all-MiniLM-L6-v2"</span>,
Â  Â  Â  Â  Â  Â  model_kwargs={<span class="hljs-string">"device"</span>:Â <span class="hljs-string">"cpu"</span>},
Â  Â  Â  Â  Â  Â  encode_kwargs={<span class="hljs-string">"normalize_embeddings"</span>:Â <span class="hljs-literal">True</span>}
Â  Â  Â  Â  )
Â  Â  Â  Â  self.db = lancedb.connect(<span class="hljs-string">"/tmp/lancedb_agentic_rag"</span>)
Â  Â  Â  Â  self.vectorstore =Â <span class="hljs-literal">None</span>
Â  Â  Â  Â  self.agent_executor =Â <span class="hljs-literal">None</span>
Â  Â Â 
Â  Â Â <span class="hljs-keyword">def</span>Â <span class="hljs-title function_">build_index</span>(<span class="hljs-params">self, documents: <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]</span>):
Â  Â  Â  Â Â <span class="hljs-string">"""æ„å»ºå‘é‡ç´¢å¼•"""</span>
Â  Â  Â  Â  docs = [Document(page_content=d)Â <span class="hljs-keyword">for</span>Â dÂ <span class="hljs-keyword">in</span>Â documents]
Â  Â  Â  Â  self.vectorstore = LanceDB.from_documents(
Â  Â  Â  Â  Â  Â  docs,Â 
Â  Â  Â  Â  Â  Â  self.embeddings,
Â  Â  Â  Â  Â  Â  connection=self.db,
Â  Â  Â  Â  Â  Â  table_name=<span class="hljs-string">"agentic_rag_docs"</span>
Â  Â  Â  Â  )
Â  Â Â 
Â  Â Â <span class="hljs-keyword">def</span>Â <span class="hljs-title function_">setup_agent</span>(<span class="hljs-params">self</span>):
Â  Â  Â  Â Â <span class="hljs-string">"""é…ç½®Agentå’Œå·¥å…·"""</span>
Â  Â  Â  Â  vectorstore = self.vectorstore Â <span class="hljs-comment"># é—­åŒ…å¼•ç”¨</span>
Â  Â  Â  Â Â 
Â  Â  Â  Â  @tool
Â  Â  Â  Â Â <span class="hljs-keyword">def</span>Â <span class="hljs-title function_">semantic_search</span>(<span class="hljs-params">query: <span class="hljs-built_in">str</span></span>)Â -&gt; <span class="hljs-built_in">str</span>:
Â  Â  Â  Â  Â  Â Â <span class="hljs-string">"""ç”¨äºè¯­ä¹‰æœç´¢ï¼Œå½“éœ€è¦ç†è§£é—®é¢˜å«ä¹‰å¹¶æŸ¥æ‰¾ç›¸å…³æ–‡æ¡£æ—¶ä½¿ç”¨"""</span>
Â  Â  Â  Â  Â  Â  docs = vectorstore.similarity_search(query, k=<span class="hljs-number">3</span>)
Â  Â  Â  Â  Â  Â Â <span class="hljs-keyword">return</span><span class="hljs-string">"\n"</span>.join([d.page_contentÂ <span class="hljs-keyword">for</span>Â dÂ <span class="hljs-keyword">in</span>Â docs])
Â  Â  Â  Â Â 
Â  Â  Â  Â  @tool
Â  Â  Â  Â Â <span class="hljs-keyword">def</span>Â <span class="hljs-title function_">keyword_search</span>(<span class="hljs-params">query: <span class="hljs-built_in">str</span></span>)Â -&gt; <span class="hljs-built_in">str</span>:
Â  Â  Â  Â  Â  Â Â <span class="hljs-string">"""ç”¨äºå…³é”®è¯æœç´¢ï¼Œå½“éœ€è¦ç²¾ç¡®åŒ¹é…ç‰¹å®šæœ¯è¯­æ—¶ä½¿ç”¨"""</span>
Â  Â  Â  Â  Â  Â  docs = vectorstore.similarity_search(query, k=<span class="hljs-number">2</span>)
Â  Â  Â  Â  Â  Â Â <span class="hljs-keyword">return</span><span class="hljs-string">"\n"</span>.join([d.page_contentÂ <span class="hljs-keyword">for</span>Â dÂ <span class="hljs-keyword">in</span>Â docs])
Â  Â  Â  Â Â 
Â  Â  Â  Â  @tool
Â  Â  Â  Â Â <span class="hljs-keyword">def</span>Â <span class="hljs-title function_">calculator</span>(<span class="hljs-params">expression: <span class="hljs-built_in">str</span></span>)Â -&gt; <span class="hljs-built_in">str</span>:
Â  Â  Â  Â  Â  Â Â <span class="hljs-string">"""ç”¨äºæ•°å­¦è®¡ç®—ï¼Œè¾“å…¥æ•°å­¦è¡¨è¾¾å¼"""</span>
Â  Â  Â  Â  Â  Â Â <span class="hljs-keyword">try</span>:
Â  Â  Â  Â  Â  Â  Â  Â Â <span class="hljs-keyword">return</span>Â <span class="hljs-built_in">str</span>(<span class="hljs-built_in">eval</span>(expression))
Â  Â  Â  Â  Â  Â Â <span class="hljs-keyword">except</span>:
Â  Â  Â  Â  Â  Â  Â  Â Â <span class="hljs-keyword">return</span><span class="hljs-string">"è®¡ç®—é”™è¯¯"</span>
Â  Â  Â  Â Â 
Â  Â  Â  Â  tools = [semantic_search, keyword_search, calculator]
Â  Â  Â  Â Â 
Â  Â  Â  Â Â <span class="hljs-comment"># ä½¿ç”¨æ–°ç‰ˆæœ¬çš„Agentæç¤ºæ¨¡æ¿</span>
Â  Â  Â  Â  prompt = ChatPromptTemplate.from_messages([
Â  Â  Â  Â  Â  Â  (<span class="hljs-string">"system"</span>,Â <span class="hljs-string">"""ä½ æ˜¯ä¸€ä¸ªæ™ºèƒ½åŠ©æ‰‹ï¼Œå¯ä»¥ä½¿ç”¨å·¥å…·æ¥å›ç­”é—®é¢˜ã€‚
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  å¯ç”¨å·¥å…·ï¼š
Â  Â  Â  Â  Â  Â  - semantic_search: ç”¨äºè¯­ä¹‰æœç´¢ï¼ŒæŸ¥æ‰¾ç›¸å…³æ–‡æ¡£
Â  Â  Â  Â  Â  Â  - keyword_search: ç”¨äºå…³é”®è¯ç²¾ç¡®åŒ¹é…
Â  Â  Â  Â  Â  Â  - calculator: ç”¨äºæ•°å­¦è®¡ç®—
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  è¯·æ ¹æ®é—®é¢˜é€‰æ‹©åˆé€‚çš„å·¥å…·ï¼Œå¯ä»¥å¤šæ¬¡è°ƒç”¨å·¥å…·æ¥è·å–å®Œæ•´ä¿¡æ¯ã€‚"""</span>),
Â  Â  Â  Â  Â  Â  (<span class="hljs-string">"human"</span>,Â <span class="hljs-string">"{input}"</span>),
Â  Â  Â  Â  Â  Â  MessagesPlaceholder(variable_name=<span class="hljs-string">"agent_scratchpad"</span>)
Â  Â  Â  Â  ])
Â  Â  Â  Â Â 
Â  Â  Â  Â Â <span class="hljs-comment"># åˆ›å»ºTool Calling Agent</span>
Â  Â  Â  Â  agent = create_tool_calling_agent(self.llm, tools, prompt)
Â  Â  Â  Â  self.agent_executor = AgentExecutor(
Â  Â  Â  Â  Â  Â  agent=agent,Â 
Â  Â  Â  Â  Â  Â  tools=tools,Â 
Â  Â  Â  Â  Â  Â  verbose=<span class="hljs-literal">True</span>,
Â  Â  Â  Â  Â  Â  max_iterations=<span class="hljs-number">5</span>,
Â  Â  Â  Â  Â  Â  handle_parsing_errors=<span class="hljs-literal">True</span>
Â  Â  Â  Â  )
Â  Â Â 
Â  Â Â <span class="hljs-keyword">def</span>Â <span class="hljs-title function_">query</span>(<span class="hljs-params">self, question: <span class="hljs-built_in">str</span></span>)Â -&gt; <span class="hljs-built_in">str</span>:
Â  Â  Â  Â Â <span class="hljs-string">"""æ‰§è¡ŒæŸ¥è¯¢"""</span>
Â  Â  Â  Â Â ifnotÂ self.agent_executor:
Â  Â  Â  Â  Â  Â  self.setup_agent()
Â  Â  Â  Â  result = self.agent_executor.invoke({<span class="hljs-string">"input"</span>: question})
Â  Â  Â  Â Â <span class="hljs-keyword">return</span>Â result[<span class="hljs-string">"output"</span>]

<span class="hljs-comment"># ä½¿ç”¨ç¤ºä¾‹</span>
arag = AgenticRAG()
arag.build_index([<span class="hljs-string">"äº§å“Aä»·æ ¼100å…ƒ..."</span>,Â <span class="hljs-string">"äº§å“Bä»·æ ¼200å…ƒ..."</span>,Â <span class="hljs-string">"ä¼˜æƒ æ”¿ç­–..."</span>])
answer = arag.query(<span class="hljs-string">"äº§å“Aå’Œäº§å“Bçš„æ€»ä»·æ˜¯å¤šå°‘ï¼Ÿæœ‰ä»€ä¹ˆä¼˜æƒ ï¼Ÿ"</span>)
<span class="hljs-built_in">print</span>(answer)
</code></pre>
<h2 data-id="heading-4">5. Graph RAG</h2>
<p><strong>ç®€ä»‹ï¼š</strong></p>
<p>Graph RAG å°†çŸ¥è¯†å›¾è°±æŠ€æœ¯ä¸ RAG ç›¸ç»“åˆï¼Œé€šè¿‡ä»æ–‡æ¡£ä¸­æŠ½å–å®ä½“å’Œå…³ç³»æ„å»ºçŸ¥è¯†å›¾è°±ï¼Œå¹¶è¿›è¡Œç¤¾åŒºæ£€æµ‹å’Œæ‘˜è¦ç”Ÿæˆã€‚</p>
<p><strong>æ¶æ„ï¼š</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/156a00f8228c4cd6ad9d9a913b14922b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZGo5pyr56iL5bqP54y_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766818928&amp;x-signature=1qbByKhMhrVkeQ42ZSiqfMkGUbc%3D" alt="å›¾ç‰‡" loading="lazy"/></p>
<p><strong>å®ç°æ­¥éª¤ï¼š</strong></p>
<ul>
<li>å®ä½“æŠ½å–ï¼šä½¿ç”¨NERæˆ–LLMä»æ–‡æ¡£ä¸­æŠ½å–å®ä½“ï¼ˆäººç‰©ã€åœ°ç‚¹ã€æ¦‚å¿µç­‰ï¼‰</li>
<li>å…³ç³»æŠ½å–ï¼šè¯†åˆ«å®ä½“ä¹‹é—´çš„å…³ç³»ï¼Œæ„å»ºä¸‰å…ƒç»„ï¼ˆå®ä½“-å…³ç³»-å®ä½“ï¼‰</li>
<li>çŸ¥è¯†å›¾è°±æ„å»ºï¼šå°†å®ä½“å’Œå…³ç³»å­˜å‚¨åˆ°å›¾æ•°æ®åº“ä¸­ï¼ˆå¦‚Neo4jï¼‰</li>
<li>ç¤¾åŒºæ£€æµ‹ï¼šå¯¹å›¾è¿›è¡Œç¤¾åŒºåˆ’åˆ†ï¼Œè¯†åˆ«ä¸»é¢˜èšç±»</li>
<li>ç¤¾åŒºæ‘˜è¦ï¼šä¸ºæ¯ä¸ªç¤¾åŒºç”Ÿæˆæ‘˜è¦æè¿°</li>
<li>å›¾æ£€ç´¢ï¼šæ ¹æ®æŸ¥è¯¢åœ¨çŸ¥è¯†å›¾è°±ä¸­æ£€ç´¢ç›¸å…³å­å›¾å’Œç¤¾åŒºæ‘˜è¦</li>
<li>ç­”æ¡ˆç”Ÿæˆï¼šç»“åˆå›¾ç»“æ„ä¿¡æ¯å’Œç¤¾åŒºæ‘˜è¦ç”Ÿæˆæ›´å…¨é¢çš„ç­”æ¡ˆ</li>
</ul>
<p><strong>å‚è€ƒä»£ç ï¼š</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span>Â langchain_openaiÂ <span class="hljs-keyword">import</span>Â ChatOpenAI
<span class="hljs-keyword">from</span>Â langchain_community.graphsÂ <span class="hljs-keyword">import</span>Â Neo4jGraph
<span class="hljs-keyword">from</span>Â langchain.promptsÂ <span class="hljs-keyword">import</span>Â ChatPromptTemplate
<span class="hljs-keyword">from</span>Â langchain_core.output_parsersÂ <span class="hljs-keyword">import</span>Â StrOutputParser, JsonOutputParser
<span class="hljs-keyword">import</span>Â networkxÂ <span class="hljs-keyword">as</span>Â nx
<span class="hljs-keyword">from</span>Â typingÂ <span class="hljs-keyword">import</span>Â <span class="hljs-type">List</span>, <span class="hljs-type">Dict</span>
<span class="hljs-keyword">import</span>Â json

<span class="hljs-keyword">class</span>Â <span class="hljs-title class_">GraphRAG</span>:
Â  Â Â <span class="hljs-keyword">def</span>Â <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, neo4j_uri=<span class="hljs-string">"bolt://localhost:7687"</span>,Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â neo4j_user=<span class="hljs-string">"neo4j"</span>, neo4j_password=<span class="hljs-string">"password"</span></span>):
Â  Â  Â  Â  self.llm = ChatOpenAI(model=<span class="hljs-string">"gpt-5"</span>, temperature=<span class="hljs-number">0</span>)
Â  Â  Â  Â Â <span class="hljs-comment"># ä½¿ç”¨LangChainçš„Neo4jé›†æˆ</span>
Â  Â  Â  Â  self.graph_db = Neo4jGraph(
Â  Â  Â  Â  Â  Â  url=neo4j_uri,Â 
Â  Â  Â  Â  Â  Â  username=neo4j_user,Â 
Â  Â  Â  Â  Â  Â  password=neo4j_password
Â  Â  Â  Â  )
Â  Â  Â  Â  self.nx_graph = nx.Graph()
Â  Â Â 
Â  Â Â <span class="hljs-keyword">def</span>Â <span class="hljs-title function_">extract_entities_and_relations</span>(<span class="hljs-params">self, text: <span class="hljs-built_in">str</span></span>)Â -&gt; <span class="hljs-type">Dict</span>:
Â  Â  Â  Â Â <span class="hljs-string">"""ä½¿ç”¨LLMæŠ½å–å®ä½“å’Œå…³ç³»"""</span>
Â  Â  Â  Â  prompt = ChatPromptTemplate.from_template(
Â  Â  Â  Â  Â  Â Â <span class="hljs-string">"""ä»ä»¥ä¸‹æ–‡æœ¬ä¸­æŠ½å–å®ä½“å’Œå…³ç³»ï¼Œè¿”å›JSONæ ¼å¼ï¼š
Â  Â  Â  Â  Â  Â  æ–‡æœ¬: {text}
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  è¿”å›æ ¼å¼(åªè¿”å›JSON):
Â  Â  Â  Â  Â  Â  {{
Â  Â  Â  Â  Â  Â  Â  Â  "entities": ["å®ä½“1", "å®ä½“2", ...],
Â  Â  Â  Â  Â  Â  Â  Â  "relations": [["å®ä½“1", "å…³ç³»", "å®ä½“2"], ...]
Â  Â  Â  Â  Â  Â  }}"""</span>
Â  Â  Â  Â  )
Â  Â  Â  Â  chain = prompt | self.llm | StrOutputParser()
Â  Â  Â  Â  response = chain.invoke({<span class="hljs-string">"text"</span>: text})
Â  Â  Â  Â Â <span class="hljs-keyword">try</span>:
Â  Â  Â  Â  Â  Â Â <span class="hljs-keyword">return</span>Â json.loads(response)
Â  Â  Â  Â Â <span class="hljs-keyword">except</span>:
Â  Â  Â  Â  Â  Â Â <span class="hljs-keyword">return</span>Â {<span class="hljs-string">"entities"</span>: [],Â <span class="hljs-string">"relations"</span>: []}
Â  Â Â 
Â  Â Â <span class="hljs-keyword">def</span>Â <span class="hljs-title function_">build_knowledge_graph</span>(<span class="hljs-params">self, documents: <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]</span>):
Â  Â  Â  Â Â <span class="hljs-string">"""æ„å»ºçŸ¥è¯†å›¾è°±"""</span>
Â  Â  Â  Â Â <span class="hljs-keyword">for</span>Â docÂ <span class="hljs-keyword">in</span>Â documents:
Â  Â  Â  Â  Â  Â  extracted = self.extract_entities_and_relations(doc)
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â Â <span class="hljs-comment"># æ·»åŠ åˆ°NetworkXå›¾</span>
Â  Â  Â  Â  Â  Â Â <span class="hljs-keyword">for</span>Â entityÂ <span class="hljs-keyword">in</span>Â extracted[<span class="hljs-string">"entities"</span>]:
Â  Â  Â  Â  Â  Â  Â  Â  self.nx_graph.add_node(entity)
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â Â <span class="hljs-keyword">for</span>Â relÂ <span class="hljs-keyword">in</span>Â extracted[<span class="hljs-string">"relations"</span>]:
Â  Â  Â  Â  Â  Â  Â  Â Â <span class="hljs-keyword">if</span>Â <span class="hljs-built_in">len</span>(rel) ==Â <span class="hljs-number">3</span>:
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  self.nx_graph.add_edge(rel[<span class="hljs-number">0</span>], rel[<span class="hljs-number">2</span>], relation=rel[<span class="hljs-number">1</span>])
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â Â <span class="hljs-comment"># å­˜å‚¨åˆ°Neo4j</span>
Â  Â  Â  Â  Â  Â Â <span class="hljs-keyword">for</span>Â entityÂ <span class="hljs-keyword">in</span>Â extracted[<span class="hljs-string">"entities"</span>]:
Â  Â  Â  Â  Â  Â  Â  Â  self.graph_db.query(
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â <span class="hljs-string">"MERGE (e:Entity {name: $name})"</span>,Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {<span class="hljs-string">"name"</span>: entity}
Â  Â  Â  Â  Â  Â  Â  Â  )
Â  Â  Â  Â  Â  Â Â <span class="hljs-keyword">for</span>Â relÂ <span class="hljs-keyword">in</span>Â extracted[<span class="hljs-string">"relations"</span>]:
Â  Â  Â  Â  Â  Â  Â  Â Â <span class="hljs-keyword">if</span>Â <span class="hljs-built_in">len</span>(rel) ==Â <span class="hljs-number">3</span>:
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  self.graph_db.query(
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â <span class="hljs-string">"""MATCH (a:Entity {name: $from})
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â MATCH (b:Entity {name: $to})
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â MERGE (a)-[r:RELATED {type: $rel}]-&gt;(b)"""</span>,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {<span class="hljs-string">"from"</span>: rel[<span class="hljs-number">0</span>],Â <span class="hljs-string">"to"</span>: rel[<span class="hljs-number">2</span>],Â <span class="hljs-string">"rel"</span>: rel[<span class="hljs-number">1</span>]}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  )
Â  Â Â 
Â  Â Â <span class="hljs-keyword">def</span>Â <span class="hljs-title function_">detect_communities</span>(<span class="hljs-params">self</span>)Â -&gt; <span class="hljs-type">List</span>[<span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]]:
Â  Â  Â  Â Â <span class="hljs-string">"""ç¤¾åŒºæ£€æµ‹"""</span>
Â  Â  Â  Â Â <span class="hljs-keyword">from</span>Â networkx.algorithmsÂ <span class="hljs-keyword">import</span>Â community
Â  Â  Â  Â Â <span class="hljs-keyword">if</span>Â <span class="hljs-built_in">len</span>(self.nx_graph.nodes()) ==Â <span class="hljs-number">0</span>:
Â  Â  Â  Â  Â  Â Â <span class="hljs-keyword">return</span>Â []
Â  Â  Â  Â  communities = community.louvain_communities(self.nx_graph)
Â  Â  Â  Â Â <span class="hljs-keyword">return</span>Â [<span class="hljs-built_in">list</span>(c)Â <span class="hljs-keyword">for</span>Â cÂ <span class="hljs-keyword">in</span>Â communities]
Â  Â Â 
Â  Â Â <span class="hljs-keyword">def</span>Â <span class="hljs-title function_">generate_community_summaries</span>(<span class="hljs-params">self, communities: <span class="hljs-type">List</span>[<span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]]</span>)Â -&gt; <span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>]:
Â  Â  Â  Â Â <span class="hljs-string">"""ä¸ºæ¯ä¸ªç¤¾åŒºç”Ÿæˆæ‘˜è¦"""</span>
Â  Â  Â  Â  summaries = []
Â  Â  Â  Â Â <span class="hljs-keyword">for</span>Â i, commÂ <span class="hljs-keyword">in</span>Â <span class="hljs-built_in">enumerate</span>(communities):
Â  Â  Â  Â  Â  Â  subgraph = self.nx_graph.subgraph(comm)
Â  Â  Â  Â  Â  Â  edges_info = [(u, v, d.get(<span class="hljs-string">'relation'</span>,Â <span class="hljs-string">''</span>))Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <span class="hljs-keyword">for</span>Â u, v, dÂ <span class="hljs-keyword">in</span>Â subgraph.edges(data=<span class="hljs-literal">True</span>)]
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  prompt = ChatPromptTemplate.from_template(
Â  Â  Â  Â  Â  Â  Â  Â Â <span class="hljs-string">"""ä¸ºä»¥ä¸‹å®ä½“ç¾¤ç»„ç”Ÿæˆç®€çŸ­æ‘˜è¦ï¼š
Â  Â  Â  Â  Â  Â  Â  Â  å®ä½“: {entities}
Â  Â  Â  Â  Â  Â  Â  Â  å…³ç³»: {relations}
Â  Â  Â  Â  Â  Â  Â  Â  æ‘˜è¦:"""</span>
Â  Â  Â  Â  Â  Â  )
Â  Â  Â  Â  Â  Â  chain = prompt | self.llm | StrOutputParser()
Â  Â  Â  Â  Â  Â  summary = chain.invoke({<span class="hljs-string">"entities"</span>: comm,Â <span class="hljs-string">"relations"</span>: edges_info})
Â  Â  Â  Â  Â  Â  summaries.append({<span class="hljs-string">"community"</span>: i,Â <span class="hljs-string">"entities"</span>: comm,Â <span class="hljs-string">"summary"</span>: summary})
Â  Â  Â  Â Â <span class="hljs-keyword">return</span>Â summaries
Â  Â Â 
Â  Â Â <span class="hljs-keyword">def</span>Â <span class="hljs-title function_">query</span>(<span class="hljs-params">self, question: <span class="hljs-built_in">str</span></span>)Â -&gt; <span class="hljs-built_in">str</span>:
Â  Â  Â  Â Â <span class="hljs-string">"""åŸºäºå›¾çš„æ£€ç´¢å’Œå›ç­”"""</span>
Â  Â  Â  Â Â <span class="hljs-comment"># 1. ä»é—®é¢˜ä¸­æå–å…³é”®å®ä½“</span>
Â  Â  Â  Â  entities = self.extract_entities_and_relations(question)[<span class="hljs-string">"entities"</span>]
Â  Â  Â  Â Â 
Â  Â  Â  Â Â <span class="hljs-comment"># 2. åœ¨Neo4jä¸­æŸ¥æ‰¾ç›¸å…³å­å›¾</span>
Â  Â  Â  Â  graph_context = self.graph_db.query(
Â  Â  Â  Â  Â  Â Â <span class="hljs-string">"""MATCH (e:Entity)-[r]-(related)
Â  Â  Â  Â  Â  Â  Â  Â WHERE e.name IN $entities
Â  Â  Â  Â  Â  Â  Â  Â RETURN e.name AS entity, type(r) AS rel_type,Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  r.type AS relation, related.name AS related_entity
Â  Â  Â  Â  Â  Â  Â  Â LIMIT 20"""</span>,
Â  Â  Â  Â  Â  Â  {<span class="hljs-string">"entities"</span>: entities}
Â  Â  Â  Â  )
Â  Â  Â  Â Â 
Â  Â  Â  Â Â <span class="hljs-comment"># 3. è·å–ç¤¾åŒºæ‘˜è¦</span>
Â  Â  Â  Â  communities = self.detect_communities()
Â  Â  Â  Â  summaries = self.generate_community_summaries(communities[:<span class="hljs-number">3</span>])
Â  Â  Â  Â Â 
Â  Â  Â  Â Â <span class="hljs-comment"># 4. ç”Ÿæˆç­”æ¡ˆ</span>
Â  Â  Â  Â  context =Â <span class="hljs-string">f"å›¾å…³ç³»:Â <span class="hljs-subst">{graph_context}</span>\nç¤¾åŒºæ‘˜è¦:Â <span class="hljs-subst">{summaries}</span>"</span>
Â  Â  Â  Â  prompt = ChatPromptTemplate.from_template(
Â  Â  Â  Â  Â  Â Â <span class="hljs-string">"""åŸºäºä»¥ä¸‹çŸ¥è¯†å›¾è°±ä¿¡æ¯å›ç­”é—®é¢˜ï¼š
Â  Â  Â  Â  Â  Â  {context}
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  é—®é¢˜: {question}
Â  Â  Â  Â  Â  Â  ç­”æ¡ˆ:"""</span>
Â  Â  Â  Â  )
Â  Â  Â  Â  chain = prompt | self.llm | StrOutputParser()
Â  Â  Â  Â Â <span class="hljs-keyword">return</span>Â chain.invoke({<span class="hljs-string">"context"</span>: context,Â <span class="hljs-string">"question"</span>: question})

<span class="hljs-comment"># ä½¿ç”¨ç¤ºä¾‹</span>
grag = GraphRAG()
grag.build_knowledge_graph([
Â  Â Â <span class="hljs-string">"å¼ ä¸‰æ˜¯ABCå…¬å¸çš„CEOï¼Œè¯¥å…¬å¸ä½äºåŒ—äº¬"</span>,
Â  Â Â <span class="hljs-string">"æå››æ˜¯ABCå…¬å¸çš„CTOï¼Œä»–ä¸å¼ ä¸‰æ˜¯å¤§å­¦åŒå­¦"</span>,
Â  Â Â <span class="hljs-string">"ABCå…¬å¸å¼€å‘äº†äº§å“Xï¼Œå¸‚åœºä»½é¢é¢†å…ˆ"</span>
])
answer = grag.query(<span class="hljs-string">"ABCå…¬å¸çš„é¢†å¯¼å±‚æœ‰å“ªäº›äººï¼Ÿ"</span>)
<span class="hljs-built_in">print</span>(answer)
</code></pre>
<h2 data-id="heading-5">6. Self RAG</h2>
<p><strong>ç®€ä»‹ï¼š</strong></p>
<p>Self RAG æä¾›ç»™æ¨¡å‹è‡ªæˆ‘è¯„ä¼°å’Œå†³ç­–èƒ½åŠ›ï¼Œå®ƒé€šè¿‡å››ä¸ªåæ€æ ‡è®°ï¼ˆRetrieve/ISREL/ISSUP/ISUSEï¼‰æ¥åˆ¤æ–­ï¼šæ˜¯å¦éœ€è¦æ£€ç´¢ã€æ–‡æ¡£æ˜¯å¦ç›¸å…³ã€ç­”æ¡ˆæ˜¯å¦è¢«æ”¯æŒã€ç­”æ¡ˆæ˜¯å¦æœ‰ç”¨ï¼Œæ¨¡å‹ä¼šç”Ÿæˆå¤šä¸ªå€™é€‰ç­”æ¡ˆå¹¶ç»¼åˆè¯„åˆ†ï¼Œé€‰æ‹©æœ€ä¼˜ç»“æœè¾“å‡ºã€‚</p>
<p><strong>æ¶æ„ï¼š</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f305a7dcc64a4d119b93fc171c739451~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZGo5pyr56iL5bqP54y_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766818928&amp;x-signature=568LwX2VOeLFWFTprYECRBOGzH0%3D" alt="å›¾ç‰‡" loading="lazy"/></p>
<p><strong>å®ç°æ­¥éª¤ï¼š</strong></p>
<ul>
<li>æ£€ç´¢å†³ç­–ï¼šæ¨¡å‹é¦–å…ˆåˆ¤æ–­æ˜¯å¦éœ€è¦æ£€ç´¢ï¼ˆç”ŸæˆRetrieveæ ‡è®°ï¼‰</li>
<li>æŒ‰éœ€æ£€ç´¢ï¼šå¦‚æœéœ€è¦æ£€ç´¢ï¼Œä»çŸ¥è¯†åº“ä¸­è·å–ç›¸å…³æ–‡æ¡£</li>
<li>ç›¸å…³æ€§è¯„ä¼°ï¼šæ¨¡å‹è¯„ä¼°æ£€ç´¢åˆ°çš„æ–‡æ¡£æ˜¯å¦ä¸æŸ¥è¯¢ç›¸å…³ï¼ˆç”ŸæˆISRELæ ‡è®°ï¼‰</li>
<li>æ”¯æŒåº¦è¯„ä¼°ï¼šæ¨¡å‹è¯„ä¼°ç”Ÿæˆçš„å†…å®¹æ˜¯å¦è¢«æ£€ç´¢æ–‡æ¡£æ”¯æŒï¼ˆç”ŸæˆISSUPæ ‡è®°ï¼‰</li>
<li>æœ‰ç”¨æ€§è¯„ä¼°ï¼šæ¨¡å‹è¯„ä¼°ç”Ÿæˆçš„å›ç­”æ˜¯å¦å¯¹ç”¨æˆ·æœ‰ç”¨ï¼ˆç”ŸæˆISUSEæ ‡è®°ï¼‰</li>
<li>è‡ªé€‚åº”ç”Ÿæˆï¼šåŸºäºä»¥ä¸Šè¯„ä¼°æ ‡è®°ï¼Œæ¨¡å‹å†³å®šæ˜¯å¦ä½¿ç”¨æ£€ç´¢å†…å®¹ã€é‡æ–°æ£€ç´¢æˆ–ç›´æ¥ç”Ÿæˆ</li>
<li>è¾“å‡ºæœ€ä¼˜ç­”æ¡ˆï¼šé€‰æ‹©è¯„åˆ†æœ€é«˜çš„ç”Ÿæˆç»“æœä½œä¸ºæœ€ç»ˆè¾“å‡º</li>
</ul>
<p><strong>å‚è€ƒä»£ç ï¼š</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span>Â langchain_openaiÂ <span class="hljs-keyword">import</span>Â ChatOpenAI
<span class="hljs-keyword">from</span>Â langchain_huggingfaceÂ <span class="hljs-keyword">import</span>Â HuggingFaceEmbeddings
<span class="hljs-keyword">from</span>Â langchain_community.vectorstoresÂ <span class="hljs-keyword">import</span>Â LanceDB
<span class="hljs-keyword">from</span>Â langchain.schemaÂ <span class="hljs-keyword">import</span>Â Document
<span class="hljs-keyword">from</span>Â langchain.promptsÂ <span class="hljs-keyword">import</span>Â ChatPromptTemplate
<span class="hljs-keyword">from</span>Â langchain_core.output_parsersÂ <span class="hljs-keyword">import</span>Â StrOutputParser
<span class="hljs-keyword">import</span>Â lancedb
<span class="hljs-keyword">from</span>Â typingÂ <span class="hljs-keyword">import</span>Â <span class="hljs-type">List</span>, <span class="hljs-type">Tuple</span>

<span class="hljs-keyword">class</span>Â <span class="hljs-title class_">SelfRAG</span>:
Â  Â Â <span class="hljs-keyword">def</span>Â <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
Â  Â  Â  Â  self.llm = ChatOpenAI(model=<span class="hljs-string">"gpt-4"</span>, temperature=<span class="hljs-number">0</span>)
Â  Â  Â  Â Â <span class="hljs-comment"># ä½¿ç”¨è½»é‡çº§çš„all-MiniLM-L6-v2æ¨¡å‹ï¼Œä»…80MB</span>
Â  Â  Â  Â  self.embeddings = HuggingFaceEmbeddings(
Â  Â  Â  Â  Â  Â  model_name=<span class="hljs-string">"sentence-transformers/all-MiniLM-L6-v2"</span>,
Â  Â  Â  Â  Â  Â  model_kwargs={<span class="hljs-string">"device"</span>:Â <span class="hljs-string">"cpu"</span>},
Â  Â  Â  Â  Â  Â  encode_kwargs={<span class="hljs-string">"normalize_embeddings"</span>:Â <span class="hljs-literal">True</span>}
Â  Â  Â  Â  )
Â  Â  Â  Â  self.db = lancedb.connect(<span class="hljs-string">"/tmp/lancedb_self_rag"</span>)
Â  Â  Â  Â  self.vectorstore =Â <span class="hljs-literal">None</span>
Â  Â Â 
Â  Â Â <span class="hljs-keyword">def</span>Â <span class="hljs-title function_">build_index</span>(<span class="hljs-params">self, documents: <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]</span>):
Â  Â  Â  Â Â <span class="hljs-string">"""æ„å»ºå‘é‡ç´¢å¼•"""</span>
Â  Â  Â  Â  docs = [Document(page_content=d)Â <span class="hljs-keyword">for</span>Â dÂ <span class="hljs-keyword">in</span>Â documents]
Â  Â  Â  Â  self.vectorstore = LanceDB.from_documents(
Â  Â  Â  Â  Â  Â  docs,Â 
Â  Â  Â  Â  Â  Â  self.embeddings,
Â  Â  Â  Â  Â  Â  connection=self.db,
Â  Â  Â  Â  Â  Â  table_name=<span class="hljs-string">"self_rag_docs"</span>
Â  Â  Â  Â  )
Â  Â Â 
Â  Â Â <span class="hljs-keyword">def</span>Â <span class="hljs-title function_">should_retrieve</span>(<span class="hljs-params">self, query: <span class="hljs-built_in">str</span></span>)Â -&gt; <span class="hljs-built_in">bool</span>:
Â  Â  Â  Â Â <span class="hljs-string">"""åˆ¤æ–­æ˜¯å¦éœ€è¦æ£€ç´¢ (Retrieveæ ‡è®°)"""</span>
Â  Â  Â  Â  prompt = ChatPromptTemplate.from_template(
Â  Â  Â  Â  Â  Â Â <span class="hljs-string">"""åˆ¤æ–­ä»¥ä¸‹é—®é¢˜æ˜¯å¦éœ€è¦æ£€ç´¢å¤–éƒ¨çŸ¥è¯†æ¥å›ç­”ã€‚
Â  Â  Â  Â  Â  Â  é—®é¢˜: {query}
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  å¦‚æœé—®é¢˜éœ€è¦äº‹å®æ€§çŸ¥è¯†ã€æœ€æ–°ä¿¡æ¯æˆ–ç‰¹å®šé¢†åŸŸçŸ¥è¯†ï¼Œå›ç­”YESã€‚
Â  Â  Â  Â  Â  Â  å¦‚æœé—®é¢˜æ˜¯é€šç”¨é—®é¢˜æˆ–æ¨ç†é—®é¢˜ï¼Œå›ç­”NOã€‚
Â  Â  Â  Â  Â  Â  åªå›ç­”YESæˆ–NO:"""</span>
Â  Â  Â  Â  )
Â  Â  Â  Â  chain = prompt | self.llm | StrOutputParser()
Â  Â  Â  Â  response = chain.invoke({<span class="hljs-string">"query"</span>: query}).strip().upper()
Â  Â  Â  Â Â <span class="hljs-keyword">return</span><span class="hljs-string">"YES"</span><span class="hljs-keyword">in</span>Â response
Â  Â Â 
Â  Â Â <span class="hljs-keyword">def</span>Â <span class="hljs-title function_">evaluate_relevance</span>(<span class="hljs-params">self, query: <span class="hljs-built_in">str</span>, document: <span class="hljs-built_in">str</span></span>)Â -&gt; <span class="hljs-type">Tuple</span>[<span class="hljs-built_in">bool</span>, <span class="hljs-built_in">float</span>]:
Â  Â  Â  Â Â <span class="hljs-string">"""è¯„ä¼°æ–‡æ¡£ç›¸å…³æ€§ (ISRELæ ‡è®°)"""</span>
Â  Â  Â  Â  prompt = ChatPromptTemplate.from_template(
Â  Â  Â  Â  Â  Â Â <span class="hljs-string">"""è¯„ä¼°æ–‡æ¡£ä¸é—®é¢˜çš„ç›¸å…³æ€§ï¼Œæ‰“åˆ†1-5åˆ†ã€‚
Â  Â  Â  Â  Â  Â  é—®é¢˜: {query}
Â  Â  Â  Â  Â  Â  æ–‡æ¡£: {document}
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  è¿”å›æ ¼å¼: åˆ†æ•°|ç†ç”±
Â  Â  Â  Â  Â  Â  ç¤ºä¾‹: 4|æ–‡æ¡£ç›´æ¥å›ç­”äº†é—®é¢˜çš„æ ¸å¿ƒå†…å®¹"""</span>
Â  Â  Â  Â  )
Â  Â  Â  Â  chain = prompt | self.llm | StrOutputParser()
Â  Â  Â  Â  response = chain.invoke({<span class="hljs-string">"query"</span>: query,Â <span class="hljs-string">"document"</span>: document})
Â  Â  Â  Â Â <span class="hljs-keyword">try</span>:
Â  Â  Â  Â  Â  Â  score = <span class="hljs-built_in">int</span>(response.split(<span class="hljs-string">"|"</span>)[<span class="hljs-number">0</span>].strip())
Â  Â  Â  Â  Â  Â Â <span class="hljs-keyword">return</span>Â score &gt;=Â <span class="hljs-number">3</span>, score /Â <span class="hljs-number">5.0</span>
Â  Â  Â  Â Â <span class="hljs-keyword">except</span>:
Â  Â  Â  Â  Â  Â Â returnTrue,Â <span class="hljs-number">0.6</span>
Â  Â Â 
Â  Â Â <span class="hljs-keyword">def</span>Â <span class="hljs-title function_">evaluate_support</span>(<span class="hljs-params">self, document: <span class="hljs-built_in">str</span>, answer: <span class="hljs-built_in">str</span></span>)Â -&gt; <span class="hljs-type">Tuple</span>[<span class="hljs-built_in">bool</span>, <span class="hljs-built_in">float</span>]:
Â  Â  Â  Â Â <span class="hljs-string">"""è¯„ä¼°ç­”æ¡ˆæ˜¯å¦è¢«æ–‡æ¡£æ”¯æŒ (ISSUPæ ‡è®°)"""</span>
Â  Â  Â  Â  prompt = ChatPromptTemplate.from_template(
Â  Â  Â  Â  Â  Â Â <span class="hljs-string">"""è¯„ä¼°ç­”æ¡ˆæ˜¯å¦è¢«æ–‡æ¡£å†…å®¹æ”¯æŒï¼Œæ‰“åˆ†1-5åˆ†ã€‚
Â  Â  Â  Â  Â  Â  æ–‡æ¡£: {document}
Â  Â  Â  Â  Â  Â  ç­”æ¡ˆ: {answer}
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  è¿”å›æ ¼å¼: åˆ†æ•°|ç†ç”±"""</span>
Â  Â  Â  Â  )
Â  Â  Â  Â  chain = prompt | self.llm | StrOutputParser()
Â  Â  Â  Â  response = chain.invoke({<span class="hljs-string">"document"</span>: document,Â <span class="hljs-string">"answer"</span>: answer})
Â  Â  Â  Â Â <span class="hljs-keyword">try</span>:
Â  Â  Â  Â  Â  Â  score = <span class="hljs-built_in">int</span>(response.split(<span class="hljs-string">"|"</span>)[<span class="hljs-number">0</span>].strip())
Â  Â  Â  Â  Â  Â Â <span class="hljs-keyword">return</span>Â score &gt;=Â <span class="hljs-number">3</span>, score /Â <span class="hljs-number">5.0</span>
Â  Â  Â  Â Â <span class="hljs-keyword">except</span>:
Â  Â  Â  Â  Â  Â Â returnTrue,Â <span class="hljs-number">0.6</span>
Â  Â Â 
Â  Â Â <span class="hljs-keyword">def</span>Â <span class="hljs-title function_">evaluate_usefulness</span>(<span class="hljs-params">self, query: <span class="hljs-built_in">str</span>, answer: <span class="hljs-built_in">str</span></span>)Â -&gt; <span class="hljs-type">Tuple</span>[<span class="hljs-built_in">bool</span>, <span class="hljs-built_in">float</span>]:
Â  Â  Â  Â Â <span class="hljs-string">"""è¯„ä¼°ç­”æ¡ˆæœ‰ç”¨æ€§ (ISUSEæ ‡è®°)"""</span>
Â  Â  Â  Â  prompt = ChatPromptTemplate.from_template(
Â  Â  Â  Â  Â  Â Â <span class="hljs-string">"""è¯„ä¼°ç­”æ¡ˆå¯¹ç”¨æˆ·é—®é¢˜çš„æœ‰ç”¨ç¨‹åº¦ï¼Œæ‰“åˆ†1-5åˆ†ã€‚
Â  Â  Â  Â  Â  Â  é—®é¢˜: {query}
Â  Â  Â  Â  Â  Â  ç­”æ¡ˆ: {answer}
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  è¿”å›æ ¼å¼: åˆ†æ•°|ç†ç”±"""</span>
Â  Â  Â  Â  )
Â  Â  Â  Â  chain = prompt | self.llm | StrOutputParser()
Â  Â  Â  Â  response = chain.invoke({<span class="hljs-string">"query"</span>: query,Â <span class="hljs-string">"answer"</span>: answer})
Â  Â  Â  Â Â <span class="hljs-keyword">try</span>:
Â  Â  Â  Â  Â  Â  score = <span class="hljs-built_in">int</span>(response.split(<span class="hljs-string">"|"</span>)[<span class="hljs-number">0</span>].strip())
Â  Â  Â  Â  Â  Â Â <span class="hljs-keyword">return</span>Â score &gt;=Â <span class="hljs-number">3</span>, score /Â <span class="hljs-number">5.0</span>
Â  Â  Â  Â Â <span class="hljs-keyword">except</span>:
Â  Â  Â  Â  Â  Â Â returnTrue,Â <span class="hljs-number">0.6</span>
Â  Â Â 
Â  Â Â <span class="hljs-keyword">def</span>Â <span class="hljs-title function_">generate_with_context</span>(<span class="hljs-params">self, query: <span class="hljs-built_in">str</span>, context: <span class="hljs-built_in">str</span></span>)Â -&gt; <span class="hljs-built_in">str</span>:
Â  Â  Â  Â Â <span class="hljs-string">"""åŸºäºä¸Šä¸‹æ–‡ç”Ÿæˆç­”æ¡ˆ"""</span>
Â  Â  Â  Â  prompt = ChatPromptTemplate.from_template(
Â  Â  Â  Â  Â  Â Â <span class="hljs-string">"""åŸºäºä»¥ä¸‹ä¸Šä¸‹æ–‡å›ç­”é—®é¢˜ã€‚å¦‚æœä¸Šä¸‹æ–‡ä¸è¶³ä»¥å›ç­”ï¼Œè¯·è¯´æ˜ã€‚
Â  Â  Â  Â  Â  Â  ä¸Šä¸‹æ–‡: {context}
Â  Â  Â  Â  Â  Â  é—®é¢˜: {query}
Â  Â  Â  Â  Â  Â  ç­”æ¡ˆ:"""</span>
Â  Â  Â  Â  )
Â  Â  Â  Â  chain = prompt | self.llm | StrOutputParser()
Â  Â  Â  Â Â <span class="hljs-keyword">return</span>Â chain.invoke({<span class="hljs-string">"context"</span>: context,Â <span class="hljs-string">"query"</span>: query})
Â  Â Â 
Â  Â Â <span class="hljs-keyword">def</span>Â <span class="hljs-title function_">generate_without_context</span>(<span class="hljs-params">self, query: <span class="hljs-built_in">str</span></span>)Â -&gt; <span class="hljs-built_in">str</span>:
Â  Â  Â  Â Â <span class="hljs-string">"""ä¸ä½¿ç”¨æ£€ç´¢ç›´æ¥ç”Ÿæˆ"""</span>
Â  Â  Â  Â  prompt = ChatPromptTemplate.from_template(<span class="hljs-string">"è¯·å›ç­”ä»¥ä¸‹é—®é¢˜: {query}"</span>)
Â  Â  Â  Â  chain = prompt | self.llm | StrOutputParser()
Â  Â  Â  Â Â <span class="hljs-keyword">return</span>Â chain.invoke({<span class="hljs-string">"query"</span>: query})
Â  Â Â 
Â  Â Â <span class="hljs-keyword">def</span>Â <span class="hljs-title function_">query</span>(<span class="hljs-params">self, question: <span class="hljs-built_in">str</span></span>)Â -&gt; <span class="hljs-built_in">str</span>:
Â  Â  Â  Â Â <span class="hljs-string">"""Self-RAGä¸»æµç¨‹"""</span>
Â  Â  Â  Â Â <span class="hljs-comment"># 1. æ£€ç´¢å†³ç­–</span>
Â  Â  Â  Â  need_retrieval = self.should_retrieve(question)
Â  Â  Â  Â Â 
Â  Â  Â  Â Â ifnotÂ need_retrieval:
Â  Â  Â  Â  Â  Â Â <span class="hljs-comment"># ç›´æ¥ç”Ÿæˆ</span>
Â  Â  Â  Â  Â  Â  answer = self.generate_without_context(question)
Â  Â  Â  Â  Â  Â  _, usefulness = self.evaluate_usefulness(question, answer)
Â  Â  Â  Â  Â  Â Â <span class="hljs-keyword">return</span>Â answer
Â  Â  Â  Â Â 
Â  Â  Â  Â Â <span class="hljs-comment"># 2. æ£€ç´¢æ–‡æ¡£</span>
Â  Â  Â  Â  retriever = self.vectorstore.as_retriever(search_kwargs={<span class="hljs-string">"k"</span>:Â <span class="hljs-number">3</span>})
Â  Â  Â  Â  docs = retriever.invoke(question)
Â  Â  Â  Â Â 
Â  Â  Â  Â Â <span class="hljs-comment"># 3. å¯¹æ¯ä¸ªæ–‡æ¡£ç”Ÿæˆå€™é€‰ç­”æ¡ˆå¹¶è¯„åˆ†</span>
Â  Â  Â  Â  candidates = []
Â  Â  Â  Â Â <span class="hljs-keyword">for</span>Â docÂ <span class="hljs-keyword">in</span>Â docs:
Â  Â  Â  Â  Â  Â Â <span class="hljs-comment"># è¯„ä¼°ç›¸å…³æ€§ (ISREL)</span>
Â  Â  Â  Â  Â  Â  is_relevant, rel_score = self.evaluate_relevance(question, doc.page_content)
Â  Â  Â  Â  Â  Â Â ifnotÂ is_relevant:
Â  Â  Â  Â  Â  Â  Â  Â Â <span class="hljs-keyword">continue</span>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â Â <span class="hljs-comment"># ç”Ÿæˆç­”æ¡ˆ</span>
Â  Â  Â  Â  Â  Â  answer = self.generate_with_context(question, doc.page_content)
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â Â <span class="hljs-comment"># è¯„ä¼°æ”¯æŒåº¦ (ISSUP)</span>
Â  Â  Â  Â  Â  Â  is_supported, sup_score = self.evaluate_support(doc.page_content, answer)
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â Â <span class="hljs-comment"># è¯„ä¼°æœ‰ç”¨æ€§ (ISUSE)</span>
Â  Â  Â  Â  Â  Â  is_useful, use_score = self.evaluate_usefulness(question, answer)
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â Â <span class="hljs-comment"># ç»¼åˆè¯„åˆ†</span>
Â  Â  Â  Â  Â  Â  total_score = rel_score *Â <span class="hljs-number">0.3</span>Â + sup_score *Â <span class="hljs-number">0.4</span>Â + use_score *Â <span class="hljs-number">0.3</span>
Â  Â  Â  Â  Â  Â  candidates.append((answer, total_score))
Â  Â  Â  Â Â 
Â  Â  Â  Â Â <span class="hljs-comment"># 4. é€‰æ‹©æœ€ä½³ç­”æ¡ˆ</span>
Â  Â  Â  Â Â <span class="hljs-keyword">if</span>Â candidates:
Â  Â  Â  Â  Â  Â  candidates.sort(key=<span class="hljs-keyword">lambda</span>Â x: x[<span class="hljs-number">1</span>], reverse=<span class="hljs-literal">True</span>)
Â  Â  Â  Â  Â  Â Â <span class="hljs-keyword">return</span>Â candidates[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>]
Â  Â  Â  Â Â <span class="hljs-keyword">else</span>:
Â  Â  Â  Â  Â  Â Â <span class="hljs-comment"># å¦‚æœæ²¡æœ‰åˆé€‚çš„æ£€ç´¢ç»“æœï¼Œç›´æ¥ç”Ÿæˆ</span>
Â  Â  Â  Â  Â  Â Â <span class="hljs-keyword">return</span>Â self.generate_without_context(question)

<span class="hljs-comment"># ä½¿ç”¨ç¤ºä¾‹</span>
srag = SelfRAG()
srag.build_index([<span class="hljs-string">"æ–‡æ¡£1å†…å®¹..."</span>,Â <span class="hljs-string">"æ–‡æ¡£2å†…å®¹..."</span>,Â <span class="hljs-string">"æ–‡æ¡£3å†…å®¹..."</span>])
answer = srag.query(<span class="hljs-string">"ä½ çš„é—®é¢˜æ˜¯ä»€ä¹ˆï¼Ÿ"</span>)
<span class="hljs-built_in">print</span>(answer)
</code></pre>
<h2 data-id="heading-6">7. Adaptive RAG</h2>
<p><strong>ç®€ä»‹ï¼š</strong></p>
<p>Adaptive RAG æ ¹æ®æŸ¥è¯¢çš„ç±»å‹å’Œå¤æ‚åº¦åŠ¨æ€é€‰æ‹©æœ€ä¼˜çš„å¤„ç†ç­–ç•¥ã€‚</p>
<p><strong>æ¶æ„ï¼š</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/867cf90ae2aa496eb94c184bbfc132a6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZGo5pyr56iL5bqP54y_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766818928&amp;x-signature=n8LHCBmrPpc99fZg4kO7JcJl4h0%3D" alt="å›¾ç‰‡" loading="lazy"/></p>
<p><strong>å®ç°æ­¥éª¤ï¼š</strong></p>
<ul>
<li>æŸ¥è¯¢åˆ†ç±»ï¼šåˆ†æç”¨æˆ·æŸ¥è¯¢çš„ç±»å‹å’Œå¤æ‚åº¦ï¼ˆç®€å•äº‹å®/å¤šè·³æ¨ç†/å¼€æ”¾æ€§é—®é¢˜ï¼‰</li>
<li>ç­–ç•¥é€‰æ‹©ï¼šæ ¹æ®æŸ¥è¯¢ç±»å‹é€‰æ‹©æœ€ä¼˜çš„RAGç­–ç•¥</li>
<li>
<ul>
<li>ç®€å•æŸ¥è¯¢ï¼šç›´æ¥LLMå›ç­”æˆ–å•æ¬¡æ£€ç´¢</li>
<li>å¤æ‚æŸ¥è¯¢ï¼šå¤šè½®è¿­ä»£æ£€ç´¢</li>
<li>å¼€æ”¾æ€§é—®é¢˜ï¼šç»“åˆç½‘ç»œæœç´¢</li>
</ul>
</li>
<li>åŠ¨æ€è·¯ç”±ï¼šå°†æŸ¥è¯¢è·¯ç”±åˆ°å¯¹åº”çš„å¤„ç†æµç¨‹</li>
<li>è‡ªé€‚åº”æ£€ç´¢ï¼šæ ¹æ®ä¸­é—´ç»“æœåŠ¨æ€è°ƒæ•´æ£€ç´¢æ·±åº¦å’ŒèŒƒå›´</li>
<li>ç»“æœæ•´åˆï¼šæ•´åˆä¸åŒç­–ç•¥çš„ç»“æœç”Ÿæˆæœ€ç»ˆç­”æ¡ˆ</li>
</ul>
<p><strong>å‚è€ƒä»£ç ï¼š</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span>Â langchain_openaiÂ <span class="hljs-keyword">import</span>Â ChatOpenAI
<span class="hljs-keyword">from</span>Â langchain_huggingfaceÂ <span class="hljs-keyword">import</span>Â HuggingFaceEmbeddings
<span class="hljs-keyword">from</span>Â langchain_community.vectorstoresÂ <span class="hljs-keyword">import</span>Â LanceDB
<span class="hljs-keyword">from</span>Â langchain.schemaÂ <span class="hljs-keyword">import</span>Â Document
<span class="hljs-keyword">from</span>Â langchain.promptsÂ <span class="hljs-keyword">import</span>Â ChatPromptTemplate
<span class="hljs-keyword">from</span>Â langchain_core.output_parsersÂ <span class="hljs-keyword">import</span>Â StrOutputParser
<span class="hljs-keyword">from</span>Â langchain_core.runnablesÂ <span class="hljs-keyword">import</span>Â RunnableLambda, RunnablePassthrough
<span class="hljs-keyword">import</span>Â lancedb
<span class="hljs-keyword">from</span>Â enumÂ <span class="hljs-keyword">import</span>Â Enum
<span class="hljs-keyword">from</span>Â typingÂ <span class="hljs-keyword">import</span>Â <span class="hljs-type">List</span>

<span class="hljs-keyword">class</span>Â <span class="hljs-title class_">QueryType</span>(<span class="hljs-title class_ inherited__">Enum</span>):
Â  Â  SIMPLE =Â <span class="hljs-string">"simple"</span>Â  Â  Â  Â  Â  Â <span class="hljs-comment"># ç®€å•äº‹å®æŸ¥è¯¢</span>
Â  Â  MULTI_HOP =Â <span class="hljs-string">"multi_hop"</span>Â  Â  Â <span class="hljs-comment"># å¤šè·³æ¨ç†æŸ¥è¯¢</span>
Â  Â  OPEN_ENDED =Â <span class="hljs-string">"open_ended"</span>Â  Â <span class="hljs-comment"># å¼€æ”¾æ€§é—®é¢˜</span>
Â  Â  NO_RETRIEVAL =Â <span class="hljs-string">"no_retrieval"</span><span class="hljs-comment"># ä¸éœ€è¦æ£€ç´¢</span>

<span class="hljs-keyword">class</span>Â <span class="hljs-title class_">AdaptiveRAG</span>:
Â  Â Â <span class="hljs-keyword">def</span>Â <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
Â  Â  Â  Â  self.llm = ChatOpenAI(model=<span class="hljs-string">"gpt-4"</span>, temperature=<span class="hljs-number">0</span>)
Â  Â  Â  Â Â <span class="hljs-comment"># ä½¿ç”¨è½»é‡çº§çš„all-MiniLM-L6-v2æ¨¡å‹ï¼Œä»…80MB</span>
Â  Â  Â  Â  self.embeddings = HuggingFaceEmbeddings(
Â  Â  Â  Â  Â  Â  model_name=<span class="hljs-string">"sentence-transformers/all-MiniLM-L6-v2"</span>,
Â  Â  Â  Â  Â  Â  model_kwargs={<span class="hljs-string">"device"</span>:Â <span class="hljs-string">"cpu"</span>},
Â  Â  Â  Â  Â  Â  encode_kwargs={<span class="hljs-string">"normalize_embeddings"</span>:Â <span class="hljs-literal">True</span>}
Â  Â  Â  Â  )
Â  Â  Â  Â  self.db = lancedb.connect(<span class="hljs-string">"/tmp/lancedb_adaptive_rag"</span>)
Â  Â  Â  Â  self.vectorstore =Â <span class="hljs-literal">None</span>
Â  Â Â 
Â  Â Â <span class="hljs-keyword">def</span>Â <span class="hljs-title function_">build_index</span>(<span class="hljs-params">self, documents: <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]</span>):
Â  Â  Â  Â Â <span class="hljs-string">"""æ„å»ºå‘é‡ç´¢å¼•"""</span>
Â  Â  Â  Â  docs = [Document(page_content=d)Â <span class="hljs-keyword">for</span>Â dÂ <span class="hljs-keyword">in</span>Â documents]
Â  Â  Â  Â  self.vectorstore = LanceDB.from_documents(
Â  Â  Â  Â  Â  Â  docs,Â 
Â  Â  Â  Â  Â  Â  self.embeddings,
Â  Â  Â  Â  Â  Â  connection=self.db,
Â  Â  Â  Â  Â  Â  table_name=<span class="hljs-string">"adaptive_rag_docs"</span>
Â  Â  Â  Â  )
Â  Â Â 
Â  Â Â <span class="hljs-keyword">def</span>Â <span class="hljs-title function_">classify_query</span>(<span class="hljs-params">self, query: <span class="hljs-built_in">str</span></span>)Â -&gt; QueryType:
Â  Â  Â  Â Â <span class="hljs-string">"""åˆ†ç±»æŸ¥è¯¢ç±»å‹"""</span>
Â  Â  Â  Â  prompt = ChatPromptTemplate.from_template(
Â  Â  Â  Â  Â  Â Â <span class="hljs-string">"""åˆ†æä»¥ä¸‹æŸ¥è¯¢çš„ç±»å‹ï¼Œè¿”å›å¯¹åº”ç±»åˆ«ï¼š
Â  Â  Â  Â  Â  Â  æŸ¥è¯¢: {query}
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  ç±»åˆ«è¯´æ˜:
Â  Â  Â  Â  Â  Â  - SIMPLE: ç®€å•çš„äº‹å®æ€§é—®é¢˜ï¼Œå¯ä»¥ç›´æ¥ä»å•ä¸ªæ–‡æ¡£æ‰¾åˆ°ç­”æ¡ˆ
Â  Â  Â  Â  Â  Â  - MULTI_HOP: éœ€è¦ç»¼åˆå¤šä¸ªä¿¡æ¯æºè¿›è¡Œæ¨ç†çš„å¤æ‚é—®é¢˜
Â  Â  Â  Â  Â  Â  - OPEN_ENDED: å¼€æ”¾æ€§é—®é¢˜ï¼Œéœ€è¦å¹¿æ³›çš„çŸ¥è¯†å’Œåˆ›é€ æ€§æ€è€ƒ
Â  Â  Â  Â  Â  Â  - NO_RETRIEVAL: é€šç”¨çŸ¥è¯†é—®é¢˜ï¼Œä¸éœ€è¦æ£€ç´¢å³å¯å›ç­”
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  åªè¿”å›ç±»åˆ«åç§°(SIMPLE/MULTI_HOP/OPEN_ENDED/NO_RETRIEVAL):"""</span>
Â  Â  Â  Â  )
Â  Â  Â  Â  chain = prompt | self.llm | StrOutputParser()
Â  Â  Â  Â  response = chain.invoke({<span class="hljs-string">"query"</span>: query}).strip().upper()
Â  Â  Â  Â  mapping = {
Â  Â  Â  Â  Â  Â Â <span class="hljs-string">"SIMPLE"</span>: QueryType.SIMPLE,
Â  Â  Â  Â  Â  Â Â <span class="hljs-string">"MULTI_HOP"</span>: QueryType.MULTI_HOP,
Â  Â  Â  Â  Â  Â Â <span class="hljs-string">"OPEN_ENDED"</span>: QueryType.OPEN_ENDED,
Â  Â  Â  Â  Â  Â Â <span class="hljs-string">"NO_RETRIEVAL"</span>: QueryType.NO_RETRIEVAL
Â  Â  Â  Â  }
Â  Â  Â  Â Â <span class="hljs-keyword">return</span>Â mapping.get(response, QueryType.SIMPLE)
Â  Â Â 
Â  Â Â <span class="hljs-keyword">def</span>Â <span class="hljs-title function_">simple_rag</span>(<span class="hljs-params">self, query: <span class="hljs-built_in">str</span></span>)Â -&gt; <span class="hljs-built_in">str</span>:
Â  Â  Â  Â Â <span class="hljs-string">"""ç®€å•RAGï¼šå•æ¬¡æ£€ç´¢"""</span>
Â  Â  Â  Â  retriever = self.vectorstore.as_retriever(search_kwargs={<span class="hljs-string">"k"</span>:Â <span class="hljs-number">2</span>})
Â  Â  Â  Â Â 
Â  Â  Â  Â  prompt = ChatPromptTemplate.from_template(
Â  Â  Â  Â  Â  Â Â <span class="hljs-string">"åŸºäºä»¥ä¸‹å†…å®¹å›ç­”é—®é¢˜ï¼š\n{context}\n\né—®é¢˜ï¼š{question}\nç­”æ¡ˆï¼š"</span>
Â  Â  Â  Â  )
Â  Â  Â  Â Â 
Â  Â  Â  Â Â <span class="hljs-keyword">def</span>Â <span class="hljs-title function_">format_docs</span>(<span class="hljs-params">docs</span>):
Â  Â  Â  Â  Â  Â Â <span class="hljs-keyword">return</span><span class="hljs-string">"\n"</span>.join([d.page_contentÂ <span class="hljs-keyword">for</span>Â dÂ <span class="hljs-keyword">in</span>Â docs])
Â  Â  Â  Â Â 
Â  Â  Â  Â  chain = (
Â  Â  Â  Â  Â  Â  {<span class="hljs-string">"context"</span>: retriever | format_docs,Â <span class="hljs-string">"question"</span>: RunnablePassthrough()}
Â  Â  Â  Â  Â  Â  | prompt
Â  Â  Â  Â  Â  Â  | self.llm
Â  Â  Â  Â  Â  Â  | StrOutputParser()
Â  Â  Â  Â  )
Â  Â  Â  Â Â <span class="hljs-keyword">return</span>Â chain.invoke(query)
Â  Â Â 
Â  Â Â <span class="hljs-keyword">def</span>Â <span class="hljs-title function_">multi_hop_rag</span>(<span class="hljs-params">self, query: <span class="hljs-built_in">str</span>, max_hops: <span class="hljs-built_in">int</span> =Â <span class="hljs-number">3</span></span>)Â -&gt; <span class="hljs-built_in">str</span>:
Â  Â  Â  Â Â <span class="hljs-string">"""å¤šè·³RAGï¼šè¿­ä»£æ£€ç´¢"""</span>
Â  Â  Â  Â  accumulated_context = []
Â  Â  Â  Â  current_query = query
Â  Â  Â  Â  retriever = self.vectorstore.as_retriever(search_kwargs={<span class="hljs-string">"k"</span>:Â <span class="hljs-number">2</span>})
Â  Â  Â  Â Â 
Â  Â  Â  Â Â <span class="hljs-keyword">for</span>Â hopÂ <span class="hljs-keyword">in</span>Â <span class="hljs-built_in">range</span>(max_hops):
Â  Â  Â  Â  Â  Â Â <span class="hljs-comment"># æ£€ç´¢</span>
Â  Â  Â  Â  Â  Â  docs = retriever.invoke(current_query)
Â  Â  Â  Â  Â  Â  accumulated_context.extend([d.page_contentÂ <span class="hljs-keyword">for</span>Â dÂ <span class="hljs-keyword">in</span>Â docs])
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â Â <span class="hljs-comment"># æ£€æŸ¥æ˜¯å¦å·²æœ‰è¶³å¤Ÿä¿¡æ¯</span>
Â  Â  Â  Â  Â  Â  context =Â <span class="hljs-string">"\n"</span>.join(accumulated_context)
Â  Â  Â  Â  Â  Â  check_prompt = ChatPromptTemplate.from_template(
Â  Â  Â  Â  Â  Â  Â  Â Â <span class="hljs-string">"""åŸºäºå½“å‰æ”¶é›†çš„ä¿¡æ¯ï¼Œåˆ¤æ–­æ˜¯å¦è¶³å¤Ÿå›ç­”é—®é¢˜ã€‚
Â  Â  Â  Â  Â  Â  Â  Â  æ”¶é›†çš„ä¿¡æ¯: {context}
Â  Â  Â  Â  Â  Â  Â  Â  é—®é¢˜: {query}
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  å›ç­”YESå¦‚æœä¿¡æ¯è¶³å¤Ÿï¼Œå›ç­”NOå¦‚æœéœ€è¦æ›´å¤šä¿¡æ¯ã€‚
Â  Â  Â  Â  Â  Â  Â  Â  å¦‚æœå›ç­”NOï¼Œè¯·æä¾›ä¸‹ä¸€æ­¥åº”è¯¥æœç´¢çš„å­é—®é¢˜ã€‚
Â  Â  Â  Â  Â  Â  Â  Â  æ ¼å¼: YES æˆ– NO|å­é—®é¢˜"""</span>
Â  Â  Â  Â  Â  Â  )
Â  Â  Â  Â  Â  Â  check_chain = check_prompt | self.llm | StrOutputParser()
Â  Â  Â  Â  Â  Â  check_response = check_chain.invoke({<span class="hljs-string">"context"</span>: context,Â <span class="hljs-string">"query"</span>: query})
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â Â <span class="hljs-keyword">if</span>Â check_response.strip().upper().startswith(<span class="hljs-string">"YES"</span>):
Â  Â  Â  Â  Â  Â  Â  Â Â <span class="hljs-keyword">break</span>
Â  Â  Â  Â  Â  Â Â eli<span class="hljs-string">f"|"</span><span class="hljs-keyword">in</span>Â check_response:
Â  Â  Â  Â  Â  Â  Â  Â  current_query = check_response.split(<span class="hljs-string">"|"</span>)[<span class="hljs-number">1</span>].strip()
Â  Â  Â  Â Â 
Â  Â  Â  Â Â <span class="hljs-comment"># ç”Ÿæˆæœ€ç»ˆç­”æ¡ˆ</span>
Â  Â  Â  Â  final_context =Â <span class="hljs-string">"\n"</span>.join(accumulated_context)
Â  Â  Â  Â  final_prompt = ChatPromptTemplate.from_template(
Â  Â  Â  Â  Â  Â Â <span class="hljs-string">"ç»¼åˆä»¥ä¸‹ä¿¡æ¯å›ç­”é—®é¢˜ï¼š\n{context}\n\né—®é¢˜ï¼š{question}\nç­”æ¡ˆï¼š"</span>
Â  Â  Â  Â  )
Â  Â  Â  Â  final_chain = final_prompt | self.llm | StrOutputParser()
Â  Â  Â  Â Â <span class="hljs-keyword">return</span>Â final_chain.invoke({<span class="hljs-string">"context"</span>: final_context,Â <span class="hljs-string">"question"</span>: query})
Â  Â Â 
Â  Â Â <span class="hljs-keyword">def</span>Â <span class="hljs-title function_">open_ended_rag</span>(<span class="hljs-params">self, query: <span class="hljs-built_in">str</span></span>)Â -&gt; <span class="hljs-built_in">str</span>:
Â  Â  Â  Â Â <span class="hljs-string">"""å¼€æ”¾æ€§RAGï¼šå¹¿æ³›æ£€ç´¢+åˆ›é€ æ€§ç”Ÿæˆ"""</span>
Â  Â  Â  Â Â <span class="hljs-comment"># æ‰©å±•æŸ¥è¯¢</span>
Â  Â  Â  Â  expand_prompt = ChatPromptTemplate.from_template(
Â  Â  Â  Â  Â  Â Â <span class="hljs-string">"ä¸ºä»¥ä¸‹é—®é¢˜ç”Ÿæˆ3ä¸ªç›¸å…³çš„æœç´¢æŸ¥è¯¢ï¼š\n{query}\næŸ¥è¯¢åˆ—è¡¨ï¼š"</span>
Â  Â  Â  Â  )
Â  Â  Â  Â  expand_chain = expand_prompt | self.llm | StrOutputParser()
Â  Â  Â  Â  expanded = expand_chain.invoke({<span class="hljs-string">"query"</span>: query})
Â  Â  Â  Â  queries = [query] + [q.strip()Â <span class="hljs-keyword">for</span>Â qÂ <span class="hljs-keyword">in</span>Â expanded.split(<span class="hljs-string">"\n"</span>)Â <span class="hljs-keyword">if</span>Â q.strip()][:<span class="hljs-number">3</span>]
Â  Â  Â  Â Â 
Â  Â  Â  Â Â <span class="hljs-comment"># å¤šæŸ¥è¯¢æ£€ç´¢</span>
Â  Â  Â  Â  retriever = self.vectorstore.as_retriever(search_kwargs={<span class="hljs-string">"k"</span>:Â <span class="hljs-number">2</span>})
Â  Â  Â  Â  all_docs = []
Â  Â  Â  Â Â <span class="hljs-keyword">for</span>Â qÂ <span class="hljs-keyword">in</span>Â queries:
Â  Â  Â  Â  Â  Â  docs = retriever.invoke(q)
Â  Â  Â  Â  Â  Â  all_docs.extend([d.page_contentÂ <span class="hljs-keyword">for</span>Â dÂ <span class="hljs-keyword">in</span>Â docs])
Â  Â  Â  Â Â 
Â  Â  Â  Â Â <span class="hljs-comment"># å»é‡</span>
Â  Â  Â  Â  unique_docs = <span class="hljs-built_in">list</span>(<span class="hljs-built_in">set</span>(all_docs))
Â  Â  Â  Â  context =Â <span class="hljs-string">"\n"</span>.join(unique_docs[:<span class="hljs-number">5</span>])
Â  Â  Â  Â Â 
Â  Â  Â  Â  final_prompt = ChatPromptTemplate.from_template(
Â  Â  Â  Â  Â  Â Â <span class="hljs-string">"""åŸºäºä»¥ä¸‹ä¿¡æ¯ï¼Œå¯¹é—®é¢˜ç»™å‡ºå…¨é¢ã€æœ‰è§åœ°çš„å›ç­”ï¼š
Â  Â  Â  Â  Â  Â  ä¿¡æ¯: {context}
Â  Â  Â  Â  Â  Â  é—®é¢˜: {question}
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  è¯·æä¾›è¯¦ç»†çš„åˆ†æå’Œè§è§£ï¼š"""</span>
Â  Â  Â  Â  )
Â  Â  Â  Â  final_chain = final_prompt | self.llm | StrOutputParser()
Â  Â  Â  Â Â <span class="hljs-keyword">return</span>Â final_chain.invoke({<span class="hljs-string">"context"</span>: context,Â <span class="hljs-string">"question"</span>: query})
Â  Â Â 
Â  Â Â <span class="hljs-keyword">def</span>Â <span class="hljs-title function_">no_retrieval_generate</span>(<span class="hljs-params">self, query: <span class="hljs-built_in">str</span></span>)Â -&gt; <span class="hljs-built_in">str</span>:
Â  Â  Â  Â Â <span class="hljs-string">"""ç›´æ¥ç”Ÿæˆï¼šä¸ä½¿ç”¨æ£€ç´¢"""</span>
Â  Â  Â  Â  prompt = ChatPromptTemplate.from_template(<span class="hljs-string">"è¯·å›ç­”ï¼š{query}"</span>)
Â  Â  Â  Â  chain = prompt | self.llm | StrOutputParser()
Â  Â  Â  Â Â <span class="hljs-keyword">return</span>Â chain.invoke({<span class="hljs-string">"query"</span>: query})
Â  Â Â 
Â  Â Â <span class="hljs-keyword">def</span>Â <span class="hljs-title function_">query</span>(<span class="hljs-params">self, question: <span class="hljs-built_in">str</span></span>)Â -&gt; <span class="hljs-built_in">str</span>:
Â  Â  Â  Â Â <span class="hljs-string">"""è‡ªé€‚åº”æŸ¥è¯¢ä¸»æµç¨‹ - ä½¿ç”¨LangChainè·¯ç”±"""</span>
Â  Â  Â  Â Â <span class="hljs-comment"># 1. åˆ†ç±»æŸ¥è¯¢</span>
Â  Â  Â  Â  query_type = self.classify_query(question)
Â  Â  Â  Â  <span class="hljs-built_in">print</span>(<span class="hljs-string">f"æŸ¥è¯¢ç±»å‹:Â <span class="hljs-subst">{query_type.value}</span>"</span>)
Â  Â  Â  Â Â 
Â  Â  Â  Â Â <span class="hljs-comment"># 2. è·¯ç”±åˆ°å¯¹åº”ç­–ç•¥</span>
Â  Â  Â  Â  routing_map = {
Â  Â  Â  Â  Â  Â  QueryType.SIMPLE: self.simple_rag,
Â  Â  Â  Â  Â  Â  QueryType.MULTI_HOP: self.multi_hop_rag,
Â  Â  Â  Â  Â  Â  QueryType.OPEN_ENDED: self.open_ended_rag,
Â  Â  Â  Â  Â  Â  QueryType.NO_RETRIEVAL: self.no_retrieval_generate
Â  Â  Â  Â  }
Â  Â  Â  Â Â <span class="hljs-keyword">return</span>Â routing_map[query_type](question)

<span class="hljs-comment"># ä½¿ç”¨ç¤ºä¾‹</span>
arag = AdaptiveRAG()
arag.build_index([<span class="hljs-string">"å…¬å¸è´¢æŠ¥æ•°æ®..."</span>,Â <span class="hljs-string">"å¸‚åœºåˆ†ææŠ¥å‘Š..."</span>,Â <span class="hljs-string">"è¡Œä¸šè¶‹åŠ¿..."</span>])
answer = arag.query(<span class="hljs-string">"åˆ†æå…¬å¸æœªæ¥çš„å‘å±•å‰æ™¯"</span>) Â <span class="hljs-comment"># ä¼šè¢«è¯†åˆ«ä¸ºOPEN_ENDED</span>
<span class="hljs-built_in">print</span>(answer)
</code></pre>
<h2 data-id="heading-7">8. SFR RAG</h2>
<p><strong>ç®€ä»‹ï¼š</strong></p>
<p>SFR RAGï¼ˆSalesforce Research RAGï¼‰æ˜¯å·¥ä¸šçº§é«˜è´¨é‡ RAG çš„æœ€ä½³å®è·µã€‚å®ƒé‡‡ç”¨ç»è¿‡æŒ‡ä»¤å¾®è°ƒçš„é«˜æ€§èƒ½ embedding æ¨¡å‹ï¼ˆå¦‚ BGEï¼‰ï¼Œç»“åˆ Cross-Encoder é‡æ’åºã€ä¸Šä¸‹æ–‡å‹ç¼©ã€å¼•ç”¨ç”Ÿæˆå’Œè´¨é‡éªŒè¯ç­‰å¤šé¡¹ä¼˜åŒ–æŠ€æœ¯ã€‚</p>
<p><strong>æ¶æ„ï¼š</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ad02654af9d646f2854979047c43080d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZGo5pyr56iL5bqP54y_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766818928&amp;x-signature=zLZu5nudCscefZbhgOBpnlaA%2BKA%3D" alt="å›¾ç‰‡" loading="lazy"/></p>
<p><strong>å®ç°æ­¥éª¤ï¼š</strong></p>
<ul>
<li>é«˜è´¨é‡Embeddingï¼šä½¿ç”¨SFRï¼ˆSalesforce Researchï¼‰çš„é«˜æ€§èƒ½embeddingæ¨¡å‹è¿›è¡Œæ–‡æ¡£å’ŒæŸ¥è¯¢ç¼–ç </li>
<li>æŒ‡ä»¤å¾®è°ƒæ£€ç´¢ï¼šä½¿ç”¨æŒ‡ä»¤å¾®è°ƒçš„æ£€ç´¢æ¨¡å‹ï¼Œæ”¯æŒå¤šç§æ£€ç´¢ä»»åŠ¡ï¼ˆé—®ç­”ã€æ‘˜è¦ã€äº‹å®æ ¸æŸ¥ç­‰ï¼‰</li>
<li>ä¸Šä¸‹æ–‡å‹ç¼©ï¼šå¯¹æ£€ç´¢åˆ°çš„æ–‡æ¡£è¿›è¡Œæ™ºèƒ½å‹ç¼©ï¼Œå»é™¤å†—ä½™ä¿¡æ¯</li>
<li>é‡æ’åºï¼šä½¿ç”¨ä¸“é—¨çš„é‡æ’åºæ¨¡å‹å¯¹å€™é€‰æ–‡æ¡£è¿›è¡Œç²¾ç»†æ’åº</li>
<li>å¼•ç”¨ç”Ÿæˆï¼šç”Ÿæˆç­”æ¡ˆæ—¶é™„å¸¦å¼•ç”¨æ¥æºï¼Œæé«˜å¯ä¿¡åº¦</li>
<li>è´¨é‡æ§åˆ¶ï¼šå¯¹ç”Ÿæˆç»“æœè¿›è¡Œäº‹å®æ€§æ£€éªŒå’Œè´¨é‡è¯„ä¼°</li>
</ul>
<p><strong>å‚è€ƒä»£ç ï¼š</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span>Â langchain_openaiÂ <span class="hljs-keyword">import</span>Â ChatOpenAI
<span class="hljs-keyword">from</span>Â langchain_community.embeddingsÂ <span class="hljs-keyword">import</span>Â HuggingFaceBgeEmbeddings
<span class="hljs-keyword">from</span>Â langchain_community.vectorstoresÂ <span class="hljs-keyword">import</span>Â LanceDB
<span class="hljs-keyword">from</span>Â langchain_community.cross_encodersÂ <span class="hljs-keyword">import</span>Â HuggingFaceCrossEncoder
<span class="hljs-keyword">from</span>Â langchain.retrievers.document_compressorsÂ <span class="hljs-keyword">import</span>Â CrossEncoderReranker
<span class="hljs-keyword">from</span>Â langchain.retrieversÂ <span class="hljs-keyword">import</span>Â ContextualCompressionRetriever
<span class="hljs-keyword">from</span>Â langchain.schemaÂ <span class="hljs-keyword">import</span>Â Document
<span class="hljs-keyword">from</span>Â langchain.promptsÂ <span class="hljs-keyword">import</span>Â ChatPromptTemplate
<span class="hljs-keyword">from</span>Â langchain_core.output_parsersÂ <span class="hljs-keyword">import</span>Â StrOutputParser
<span class="hljs-keyword">import</span>Â lancedb
<span class="hljs-keyword">from</span>Â typingÂ <span class="hljs-keyword">import</span>Â <span class="hljs-type">List</span>, <span class="hljs-type">Dict</span>

<span class="hljs-keyword">class</span>Â <span class="hljs-title class_">SFRRAG</span>:
Â  Â Â <span class="hljs-keyword">def</span>Â <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
Â  Â  Â  Â Â <span class="hljs-comment"># ä½¿ç”¨BGEé«˜è´¨é‡Embeddingæ¨¡å‹</span>
Â  Â  Â  Â  self.embeddings = HuggingFaceBgeEmbeddings(
Â  Â  Â  Â  Â  Â  model_name=<span class="hljs-string">"BAAI/bge-large-en-v1.5"</span>,
Â  Â  Â  Â  Â  Â  model_kwargs={<span class="hljs-string">"device"</span>:Â <span class="hljs-string">"cpu"</span>},
Â  Â  Â  Â  Â  Â  encode_kwargs={<span class="hljs-string">"normalize_embeddings"</span>:Â <span class="hljs-literal">True</span>},
Â  Â  Â  Â  Â  Â  query_instruction=<span class="hljs-string">"ä¸ºæ£€ç´¢ä»»åŠ¡ç”ŸæˆæŸ¥è¯¢è¡¨ç¤º: "</span>
Â  Â  Â  Â  )
Â  Â  Â  Â Â <span class="hljs-comment"># é‡æ’åºæ¨¡å‹</span>
Â  Â  Â  Â  self.reranker_model = HuggingFaceCrossEncoder(
Â  Â  Â  Â  Â  Â  model_name=<span class="hljs-string">"cross-encoder/ms-marco-MiniLM-L-6-v2"</span>
Â  Â  Â  Â  )
Â  Â  Â  Â  self.llm = ChatOpenAI(model=<span class="hljs-string">"gpt-5"</span>, temperature=<span class="hljs-number">0</span>)
Â  Â  Â  Â  self.db = lancedb.connect(<span class="hljs-string">"./lancedb_sfr_rag"</span>)
Â  Â  Â  Â  self.vectorstore =Â <span class="hljs-literal">None</span>
Â  Â  Â  Â  self.documents = []
Â  Â Â 
Â  Â Â <span class="hljs-keyword">def</span>Â <span class="hljs-title function_">build_index</span>(<span class="hljs-params">self, documents: <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]</span>):
Â  Â  Â  Â Â <span class="hljs-string">"""æ„å»ºé«˜è´¨é‡å‘é‡ç´¢å¼•"""</span>
Â  Â  Â  Â  self.documents = documents
Â  Â  Â  Â  docs = [Document(page_content=d)Â <span class="hljs-keyword">for</span>Â dÂ <span class="hljs-keyword">in</span>Â documents]
Â  Â  Â  Â  self.vectorstore = LanceDB.from_documents(
Â  Â  Â  Â  Â  Â  docs,Â 
Â  Â  Â  Â  Â  Â  self.embeddings,
Â  Â  Â  Â  Â  Â  connection=self.db,
Â  Â  Â  Â  Â  Â  table_name=<span class="hljs-string">"sfr_rag_docs"</span>
Â  Â  Â  Â  )
Â  Â Â 
Â  Â Â <span class="hljs-keyword">def</span>Â <span class="hljs-title function_">get_retriever_with_reranker</span>(<span class="hljs-params">self, top_k: <span class="hljs-built_in">int</span> =Â <span class="hljs-number">5</span></span>):
Â  Â  Â  Â Â <span class="hljs-string">"""åˆ›å»ºå¸¦é‡æ’åºçš„æ£€ç´¢å™¨"""</span>
Â  Â  Â  Â Â <span class="hljs-comment"># åŸºç¡€æ£€ç´¢å™¨</span>
Â  Â  Â  Â  base_retriever = self.vectorstore.as_retriever(search_kwargs={<span class="hljs-string">"k"</span>:Â <span class="hljs-number">10</span>})
Â  Â  Â  Â Â 
Â  Â  Â  Â Â <span class="hljs-comment"># é‡æ’åºå‹ç¼©å™¨</span>
Â  Â  Â  Â  reranker = CrossEncoderReranker(
Â  Â  Â  Â  Â  Â  model=self.reranker_model,Â 
Â  Â  Â  Â  Â  Â  top_n=top_k
Â  Â  Â  Â  )
Â  Â  Â  Â Â 
Â  Â  Â  Â Â <span class="hljs-comment"># ç»„åˆæ£€ç´¢å™¨</span>
Â  Â  Â  Â Â <span class="hljs-keyword">return</span>Â ContextualCompressionRetriever(
Â  Â  Â  Â  Â  Â  base_compressor=reranker,
Â  Â  Â  Â  Â  Â  base_retriever=base_retriever
Â  Â  Â  Â  )
Â  Â Â 
Â  Â Â <span class="hljs-keyword">def</span>Â <span class="hljs-title function_">compress_context</span>(<span class="hljs-params">self, query: <span class="hljs-built_in">str</span>, documents: <span class="hljs-type">List</span>[Document]</span>)Â -&gt; <span class="hljs-built_in">str</span>:
Â  Â  Â  Â Â <span class="hljs-string">"""ä¸Šä¸‹æ–‡å‹ç¼©"""</span>
Â  Â  Â  Â  doc_texts =Â <span class="hljs-string">"\n"</span>.join([<span class="hljs-string">f"[<span class="hljs-subst">{i+<span class="hljs-number">1</span>}</span>]Â <span class="hljs-subst">{doc.page_content}</span>"</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â <span class="hljs-keyword">for</span>Â i, docÂ <span class="hljs-keyword">in</span>Â <span class="hljs-built_in">enumerate</span>(documents)])
Â  Â  Â  Â  prompt = ChatPromptTemplate.from_template(
Â  Â  Â  Â  Â  Â Â <span class="hljs-string">"""æå–ä»¥ä¸‹æ–‡æ¡£ä¸­ä¸é—®é¢˜ç›¸å…³çš„å…³é”®ä¿¡æ¯ï¼š
Â  Â  Â  Â  Â  Â  é—®é¢˜: {query}
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  æ–‡æ¡£:
Â  Â  Â  Â  Â  Â  {documents}
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  è¯·è¿”å›å‹ç¼©åçš„å…³é”®ä¿¡æ¯ï¼Œä¿ç•™æ–‡æ¡£ç¼–å·ä»¥ä¾¿å¼•ç”¨ï¼š"""</span>
Â  Â  Â  Â  )
Â  Â  Â  Â  chain = prompt | self.llm | StrOutputParser()
Â  Â  Â  Â Â <span class="hljs-keyword">return</span>Â chain.invoke({<span class="hljs-string">"query"</span>: query,Â <span class="hljs-string">"documents"</span>: doc_texts})
Â  Â Â 
Â  Â Â <span class="hljs-keyword">def</span>Â <span class="hljs-title function_">generate_with_citations</span>(<span class="hljs-params">self, query: <span class="hljs-built_in">str</span>, context: <span class="hljs-built_in">str</span></span>)Â -&gt; <span class="hljs-built_in">str</span>:
Â  Â  Â  Â Â <span class="hljs-string">"""ç”Ÿæˆå¸¦å¼•ç”¨çš„ç­”æ¡ˆ"""</span>
Â  Â  Â  Â  prompt = ChatPromptTemplate.from_template(
Â  Â  Â  Â  Â  Â Â <span class="hljs-string">"""åŸºäºä»¥ä¸‹ä¸Šä¸‹æ–‡å›ç­”é—®é¢˜ï¼Œå¹¶æ ‡æ³¨å¼•ç”¨æ¥æº[1][2]ç­‰ã€‚
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  ä¸Šä¸‹æ–‡: {context}
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  é—®é¢˜: {query}
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  è¦æ±‚ï¼š
Â  Â  Â  Â  Â  Â  1. å‡†ç¡®å›ç­”é—®é¢˜
Â  Â  Â  Â  Â  Â  2. åœ¨ç›¸å…³é™ˆè¿°åæ ‡æ³¨å¼•ç”¨æ¥æº
Â  Â  Â  Â  Â  Â  3. å¦‚æœä¸Šä¸‹æ–‡ä¸è¶³ä»¥å›ç­”ï¼Œè¯·è¯´æ˜
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  ç­”æ¡ˆï¼š"""</span>
Â  Â  Â  Â  )
Â  Â  Â  Â  chain = prompt | self.llm | StrOutputParser()
Â  Â  Â  Â Â <span class="hljs-keyword">return</span>Â chain.invoke({<span class="hljs-string">"context"</span>: context,Â <span class="hljs-string">"query"</span>: query})
Â  Â Â 
Â  Â Â <span class="hljs-keyword">def</span>Â <span class="hljs-title function_">verify_answer</span>(<span class="hljs-params">self, query: <span class="hljs-built_in">str</span>, answer: <span class="hljs-built_in">str</span>, documents: <span class="hljs-type">List</span>[Document]</span>)Â -&gt; <span class="hljs-type">Dict</span>:
Â  Â  Â  Â Â <span class="hljs-string">"""éªŒè¯ç­”æ¡ˆè´¨é‡"""</span>
Â  Â  Â  Â  doc_contents = [doc.page_contentÂ <span class="hljs-keyword">for</span>Â docÂ <span class="hljs-keyword">in</span>Â documents]
Â  Â  Â  Â  prompt = ChatPromptTemplate.from_template(
Â  Â  Â  Â  Â  Â Â <span class="hljs-string">"""è¯„ä¼°ä»¥ä¸‹ç­”æ¡ˆçš„è´¨é‡ï¼š
Â  Â  Â  Â  Â  Â  é—®é¢˜: {query}
Â  Â  Â  Â  Â  Â  ç­”æ¡ˆ: {answer}
Â  Â  Â  Â  Â  Â  å‚è€ƒæ–‡æ¡£: {documents}
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  è¯„ä¼°ç»´åº¦(1-5åˆ†)ï¼š
Â  Â  Â  Â  Â  Â  1. å‡†ç¡®æ€§ï¼šç­”æ¡ˆæ˜¯å¦è¢«æ–‡æ¡£æ”¯æŒ
Â  Â  Â  Â  Â  Â  2. å®Œæ•´æ€§ï¼šç­”æ¡ˆæ˜¯å¦å…¨é¢å›ç­”äº†é—®é¢˜
Â  Â  Â  Â  Â  Â  3. ç›¸å…³æ€§ï¼šç­”æ¡ˆæ˜¯å¦ç´§æ‰£é—®é¢˜
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  è¿”å›æ ¼å¼: å‡†ç¡®æ€§åˆ†æ•°|å®Œæ•´æ€§åˆ†æ•°|ç›¸å…³æ€§åˆ†æ•°|æ€»è¯„"""</span>
Â  Â  Â  Â  )
Â  Â  Â  Â  chain = prompt | self.llm | StrOutputParser()
Â  Â  Â  Â  response = chain.invoke({
Â  Â  Â  Â  Â  Â Â <span class="hljs-string">"query"</span>: query,Â 
Â  Â  Â  Â  Â  Â Â <span class="hljs-string">"answer"</span>: answer,Â 
Â  Â  Â  Â  Â  Â Â <span class="hljs-string">"documents"</span>: doc_contents
Â  Â  Â  Â  })
Â  Â  Â  Â Â <span class="hljs-keyword">try</span>:
Â  Â  Â  Â  Â  Â  parts = response.split(<span class="hljs-string">"|"</span>)
Â  Â  Â  Â  Â  Â Â <span class="hljs-keyword">return</span>Â {
Â  Â  Â  Â  Â  Â  Â  Â Â <span class="hljs-string">"accuracy"</span>: <span class="hljs-built_in">int</span>(parts[<span class="hljs-number">0</span>].strip()),
Â  Â  Â  Â  Â  Â  Â  Â Â <span class="hljs-string">"completeness"</span>: <span class="hljs-built_in">int</span>(parts[<span class="hljs-number">1</span>].strip()),
Â  Â  Â  Â  Â  Â  Â  Â Â <span class="hljs-string">"relevance"</span>: <span class="hljs-built_in">int</span>(parts[<span class="hljs-number">2</span>].strip()),
Â  Â  Â  Â  Â  Â  Â  Â Â <span class="hljs-string">"summary"</span>: parts[<span class="hljs-number">3</span>].strip()Â <span class="hljs-keyword">if</span>Â <span class="hljs-built_in">len</span>(parts) &gt;Â <span class="hljs-number">3</span><span class="hljs-keyword">else</span><span class="hljs-string">""</span>
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â Â <span class="hljs-keyword">except</span>:
Â  Â  Â  Â  Â  Â Â <span class="hljs-keyword">return</span>Â {<span class="hljs-string">"accuracy"</span>:Â <span class="hljs-number">3</span>,Â <span class="hljs-string">"completeness"</span>:Â <span class="hljs-number">3</span>,Â <span class="hljs-string">"relevance"</span>:Â <span class="hljs-number">3</span>,Â <span class="hljs-string">"summary"</span>:Â <span class="hljs-string">""</span>}
Â  Â Â 
Â  Â Â <span class="hljs-keyword">def</span>Â <span class="hljs-title function_">query</span>(<span class="hljs-params">self, question: <span class="hljs-built_in">str</span></span>)Â -&gt; <span class="hljs-type">Dict</span>:
Â  Â  Â  Â Â <span class="hljs-string">"""SFR-RAGä¸»æµç¨‹"""</span>
Â  Â  Â  Â Â <span class="hljs-comment"># 1. åˆå§‹æ£€ç´¢ + é‡æ’åº</span>
Â  Â  Â  Â  retriever = self.get_retriever_with_reranker(top_k=<span class="hljs-number">5</span>)
Â  Â  Â  Â  docs = retriever.invoke(question)
Â  Â  Â  Â Â 
Â  Â  Â  Â Â <span class="hljs-comment"># 2. ä¸Šä¸‹æ–‡å‹ç¼©</span>
Â  Â  Â  Â  compressed_context = self.compress_context(question, docs)
Â  Â  Â  Â Â 
Â  Â  Â  Â Â <span class="hljs-comment"># 3. ç”Ÿæˆå¸¦å¼•ç”¨çš„ç­”æ¡ˆ</span>
Â  Â  Â  Â  answer = self.generate_with_citations(question, compressed_context)
Â  Â  Â  Â Â 
Â  Â  Â  Â Â <span class="hljs-comment"># 4. è´¨é‡éªŒè¯</span>
Â  Â  Â  Â  quality = self.verify_answer(question, answer, docs)
Â  Â  Â  Â Â 
Â  Â  Â  Â Â <span class="hljs-keyword">return</span>Â {
Â  Â  Â  Â  Â  Â Â <span class="hljs-string">"answer"</span>: answer,
Â  Â  Â  Â  Â  Â Â <span class="hljs-string">"sources"</span>: [{<span class="hljs-string">"content"</span>: doc.page_content[:<span class="hljs-number">100</span>]}Â <span class="hljs-keyword">for</span>Â docÂ <span class="hljs-keyword">in</span>Â docs],
Â  Â  Â  Â  Â  Â Â <span class="hljs-string">"quality"</span>: quality
Â  Â  Â  Â  }

<span class="hljs-comment"># ä½¿ç”¨ç¤ºä¾‹</span>
sfr_rag = SFRRAG()
sfr_rag.build_index([
Â  Â Â <span class="hljs-string">"äººå·¥æ™ºèƒ½æ˜¯è®¡ç®—æœºç§‘å­¦çš„ä¸€ä¸ªåˆ†æ”¯..."</span>,
Â  Â Â <span class="hljs-string">"æœºå™¨å­¦ä¹ æ˜¯AIçš„æ ¸å¿ƒæŠ€æœ¯ä¹‹ä¸€..."</span>,
Â  Â Â <span class="hljs-string">"æ·±åº¦å­¦ä¹ ä½¿ç”¨ç¥ç»ç½‘ç»œè¿›è¡Œå­¦ä¹ ..."</span>
])
result = sfr_rag.query(<span class="hljs-string">"ä»€ä¹ˆæ˜¯äººå·¥æ™ºèƒ½ï¼Ÿ"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"ç­”æ¡ˆ:Â <span class="hljs-subst">{result[<span class="hljs-string">'answer'</span>]}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"è´¨é‡è¯„ä¼°:Â <span class="hljs-subst">{result[<span class="hljs-string">'quality'</span>]}</span>"</span>)
</code></pre>
<h2 data-id="heading-8">å‚è€ƒ</h2>
<p>ï¼ˆ1ï¼‰<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.langchain.com%2Foss%2Fpython%2Flangchain%2Foverview" target="_blank" title="https://docs.langchain.com/oss/python/langchain/overview" ref="nofollow noopener noreferrer">docs.langchain.com/oss/python/â€¦</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[è§£å†³Tailwindä»»æ„å€¼æ»¥ç”¨ï¼šè§„èŒƒåŒ–CSSå¼€å‘ä½“éªŒ]]></title>    <link>https://juejin.cn/post/7585382553290752036</link>    <guid>https://juejin.cn/post/7585382553290752036</guid>    <pubDate>2025-12-20T07:15:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585382553290752036" data-draft-id="7585031571889930283" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="è§£å†³Tailwindä»»æ„å€¼æ»¥ç”¨ï¼šè§„èŒƒåŒ–CSSå¼€å‘ä½“éªŒ"/> <meta itemprop="keywords" content="å‰ç«¯,CSS,ESLint"/> <meta itemprop="datePublished" content="2025-12-20T07:15:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="è¿œå±±æ— æœŸ"/> <meta itemprop="url" content="https://juejin.cn/user/1310273590526728"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="æ˜é‡‘"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            è§£å†³Tailwindä»»æ„å€¼æ»¥ç”¨ï¼šè§„èŒƒåŒ–CSSå¼€å‘ä½“éªŒ
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1310273590526728/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    è¿œå±±æ— æœŸ
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T07:15:30.000Z" title="Sat Dec 20 2025 07:15:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    é˜…è¯»4åˆ†é’Ÿ
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>èƒŒæ™¯ <code>eslint-plugin-tailwindcss</code>æ’ä»¶çš„<code>no-unnecessary-arbitrary-value</code>æ— æ³•å¯¹æ‰€æœ‰çš„ä»»æ„å€¼è¿›è¡Œæ ¡éªŒï¼Œæ¯”å¦‚<code>h-[48px]</code>ã€<code>text-[#f5f5f5]</code>æ— æ³•æ ¡éªŒå‡ºæ¥ã€‚ä½†tailwindcssçš„é¢„è®¾å€¼å¤ªå¤šäº†ï¼Œä¸€ä¸ªä¸å°å¿ƒå¯èƒ½å°±åˆå†™äº†ä¸€ä¸ªæ²¡æœ‰å¿…è¦çš„ä»»æ„å€¼ã€‚ä¸ºäº†é¿å…è¿™ç§æƒ…å†µï¼Œæˆ‘ä»¬éœ€è¦è‡ªå·±å®ç°ä¸€ä¸ªæ£€æµ‹ä»»æ„å€¼çš„eslintæ’ä»¶ã€‚</p>
</blockquote>
<h2 data-id="heading-0">æ’ä»¶åœ°å€ï¼š<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2Feslint-plugin-tailwind-no-preset-class" target="_blank" title="https://www.npmjs.com/package/eslint-plugin-tailwind-no-preset-class" ref="nofollow noopener noreferrer">eslint-plugin-tailwind-no-preset-class</a></h2>
<h2 data-id="heading-1">é¦–å…ˆæ¥çœ‹ä¸‹æ•ˆæœ</h2>
<h3 data-id="heading-2">no-unnecessary-arbitrary-value æ— æ³•æ£€æµ‹çš„æƒ…å†µ</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/043c2b930ece4a7285c452a827c0d3aa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-c5bGx5peg5pyf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766819730&amp;x-signature=F%2B9oCeYocy4yAlLcoktqfAdeMLM%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-3">ä½¿ç”¨è‡ªå®šä¹‰çš„ï¼šeslint-plugin-tailwind-no-preset-classæ’ä»¶ï¼Œå®Œç¾å®Œæˆäº†æ ¡éªŒ</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9ead78aa0a4746c48b6f75e2552a51b9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-c5bGx5peg5pyf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766819730&amp;x-signature=NCb9n8Gm87M%2Bb83i5qxtHcHHrFk%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-4">åˆ›å»ºeslintæ’ä»¶æ ‡å‡†ç›®å½•ç»“æ„</h2>
<ul>
<li>å®‰è£…Yeoman</li>
</ul>
<pre><code class="hljs language-sh" lang="sh">npm install -g yo
</code></pre>
<ul>
<li>å®‰è£…Yeoman generator-eslint</li>
</ul>
<pre><code class="hljs language-sh" lang="sh">npm install -g generator-eslint
</code></pre>
<ul>
<li>åˆ›å»ºé¡¹ç›®</li>
</ul>
<pre><code class="hljs language-sh" lang="sh"><span class="hljs-built_in">mkdir</span> eslint-plugin-my-plugin
yo eslint:plugin
</code></pre>
<p>ç”Ÿæˆç›®å½•ç»“æ„å¦‚ä¸‹ï¼š</p>
<pre><code class="hljs language-perl" lang="perl">eslint-plugin-<span class="hljs-keyword">my</span>-plugin/
â”œâ”€â”€ lib/                    <span class="hljs-comment"># æ ¸å¿ƒæºä»£ç ç›®å½•</span>
â”‚   â”œâ”€â”€ index.js           <span class="hljs-comment"># æ’ä»¶çš„å…¥å£æ–‡ä»¶ï¼Œåœ¨è¿™é‡Œå¯¼å‡ºæ‰€æœ‰è§„åˆ™</span>
â”‚   â””â”€â”€ rules/             <span class="hljs-comment"># å­˜æ”¾æ‰€æœ‰è‡ªå®šä¹‰è§„åˆ™çš„ç›®å½•</span>
â”‚       â””â”€â”€ <span class="hljs-keyword">my</span>-rule.js     <span class="hljs-comment"># ç”Ÿæˆå™¨ä¸ºä½ åˆ›å»ºçš„ä¸€æ¡ç¤ºä¾‹è§„åˆ™æ–‡ä»¶</span>
â”œâ”€â”€ tests/                 <span class="hljs-comment"># æµ‹è¯•æ–‡ä»¶ç›®å½•</span>
â”‚   â””â”€â”€ lib/
â”‚       â””â”€â”€ rules/
â”‚           â””â”€â”€ <span class="hljs-keyword">my</span>-rule.js <span class="hljs-comment"># ç¤ºä¾‹è§„åˆ™å¯¹åº”çš„æµ‹è¯•æ–‡ä»¶</span>
â”œâ”€â”€ package.json           <span class="hljs-comment"># é¡¹ç›®çš„ npm é…ç½®æ–‡ä»¶ï¼Œä¾èµ–å’Œå…ƒä¿¡æ¯éƒ½åœ¨è¿™é‡Œ</span>
â””â”€â”€ README.md              <span class="hljs-comment"># é¡¹ç›®è¯´æ˜æ–‡æ¡£</span>
</code></pre>
<h2 data-id="heading-5">æ ¹æ®å®é™…é¡¹ç›®çš„tailwindcssé…ç½®æ–‡ä»¶å’Œtailwindcssé»˜è®¤é…ç½®ç”Ÿæˆå…¨é‡å®šåˆ¶åŒ–é…ç½®ï¼Œç”¨äºåç»­eslintæ’ä»¶çš„æ ¡éªŒä¾æ®</h2>
<h3 data-id="heading-6">å®ç°é…ç½®æ–‡ä»¶ç”Ÿæˆå¹¶åŠ è½½æ–¹æ³•ï¼š</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// lib/tailwind-config-loader.js</span>
<span class="hljs-comment">// é…ç½®æ–‡ä»¶ç”Ÿæˆ</span>
...
...
<span class="hljs-comment">// åŠ¨æ€åŠ è½½ Tailwind é¢„è®¾é…ç½®</span>
<span class="hljs-keyword">let</span> tailwindPresetConfig = <span class="hljs-literal">null</span>;
...
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">generateTailwindConfig</span>(<span class="hljs-params">projectRootPath</span>) {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// åŠ¨æ€å¯¼å…¥tailwindcss</span>
    <span class="hljs-keyword">const</span> resolveConfigModule = <span class="hljs-keyword">await</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'tailwindcss/lib/public/resolve-config.js'</span>);
    <span class="hljs-keyword">const</span> resolveConfig = resolveConfigModule.<span class="hljs-property">default</span>.<span class="hljs-property">default</span>
    <span class="hljs-comment">// å°è¯•åŠ è½½é¡¹ç›®é…ç½®</span>
    <span class="hljs-keyword">let</span> projectConfig = {};
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> projectConfigPath = <span class="hljs-title function_">join</span>(projectRootPath||process.<span class="hljs-title function_">cwd</span>(), <span class="hljs-string">'tailwind.config.js'</span>);
      <span class="hljs-keyword">const</span> projectConfigModule = <span class="hljs-keyword">await</span> <span class="hljs-keyword">import</span>(projectConfigPath);
      projectConfig = projectConfigModule.<span class="hljs-property">default</span> || projectConfigModule;
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'âš ï¸ æœªæ‰¾åˆ°é¡¹ç›® tailwind.config.jsï¼Œä½¿ç”¨é»˜è®¤é…ç½®'</span>);
      <span class="hljs-keyword">throw</span> error;
    }

    <span class="hljs-comment">// ä½¿ç”¨tailwindcssçš„resolveConfigå‡½æ•°</span>
    <span class="hljs-keyword">const</span> finalConfig = <span class="hljs-title function_">resolveConfig</span>(projectConfig);

    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'âœ… Tailwind preset config generated successfully!'</span>);
    
    <span class="hljs-keyword">return</span> finalConfig;
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'âŒ ç”ŸæˆTailwindé…ç½®å¤±è´¥:'</span>, error.<span class="hljs-property">message</span>);
    <span class="hljs-keyword">throw</span> error;
  }
}


<span class="hljs-comment">// åŠ è½½é…ç½®åˆ°å†…å­˜ä¸­</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">loadTailwindPresetConfig</span>(<span class="hljs-params">projectRootPath</span>) {
  <span class="hljs-keyword">if</span> (configLoading) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'â³ é…ç½®æ­£åœ¨åŠ è½½ä¸­ï¼Œè·³è¿‡é‡å¤è¯·æ±‚'</span>);
    <span class="hljs-keyword">return</span>;
  }

  configLoading = <span class="hljs-literal">true</span>;

  <span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// ç›´æ¥åŠ¨æ€ç”Ÿæˆé…ç½®</span>
    tailwindPresetConfig = <span class="hljs-keyword">await</span> <span class="hljs-title function_">generateTailwindConfig</span>(projectRootPath);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'âœ… Tailwind é¢„è®¾é…ç½®å·²åŠ¨æ€ç”Ÿæˆå¹¶åŠ è½½'</span>);
    <span class="hljs-title function_">onConfigLoaded</span>();
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'âŒ åŠ¨æ€ç”Ÿæˆ Tailwind é¢„è®¾é…ç½®å¤±è´¥:'</span>, error.<span class="hljs-property">message</span>);
    <span class="hljs-title function_">onConfigLoadFailed</span>(error);
    <span class="hljs-keyword">throw</span> error;
  }
}


...
<span class="hljs-comment">// å¯¼å‡ºé…ç½®</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">TailwindConfigLoader</span> = {
  <span class="hljs-attr">getConfig</span>: <span class="hljs-function">() =&gt;</span> tailwindPresetConfig,
  <span class="hljs-attr">isLoaded</span>: <span class="hljs-function">() =&gt;</span> configLoaded,
  <span class="hljs-attr">ensureLoaded</span>: ensureConfigLoaded,
  <span class="hljs-attr">reload</span>: loadTailwindPresetConfig,
  <span class="hljs-attr">generateConfig</span>: generateTailwindConfig
};
...
...

</code></pre>
<h3 data-id="heading-7">åˆ›å»ºæ ¡éªŒè§„åˆ™å‡½æ•°</h3>
<ul>
<li>å®ç°æ ¡éªŒè§„åˆ™å‡½æ•°<code>checkAndReport</code></li>
</ul>
<pre><code class="hljs language-js" lang="js">...
<span class="hljs-comment">// ä½¿ç”¨ WeakMap æ¥è·Ÿè¸ªæ¯ä¸ªæ–‡ä»¶çš„å·²æŠ¥å‘Šç±»åï¼Œé¿å…é‡å¤æŠ¥å‘Š</span>
<span class="hljs-keyword">const</span> reportedClassesMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WeakMap</span>();
...
<span class="hljs-comment">// æ£€æŸ¥å¹¶æŠ¥å‘Š</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">checkAndReport</span>(<span class="hljs-params">context, node, className</span>) {
  <span class="hljs-comment">// å¦‚æœé…ç½®å°šæœªåŠ è½½ï¼Œå°è¯•ç­‰å¾…åŠ è½½</span>
  <span class="hljs-keyword">if</span> (!<span class="hljs-title class_">TailwindConfigLoader</span>.<span class="hljs-title function_">isLoaded</span>()) {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">const</span> projectRootPath = context.<span class="hljs-title function_">getCwd</span>();
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`æ­£åœ¨ç­‰å¾…åŠ è½½é…ç½®æ–‡ä»¶ <span class="hljs-subst">${projectRootPath}</span>...`</span>);
      <span class="hljs-keyword">const</span> loaded = <span class="hljs-keyword">await</span> <span class="hljs-title class_">TailwindConfigLoader</span>.<span class="hljs-title function_">ensureLoaded</span>(projectRootPath);
      <span class="hljs-keyword">if</span> (!loaded) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">'âš ï¸ Tailwind é¢„è®¾é…ç½®å°šæœªåŠ è½½ï¼Œè·³è¿‡æ£€æŸ¥'</span>);
        <span class="hljs-keyword">return</span>;
      }
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">'âš ï¸ é…ç½®åŠ è½½å¤±è´¥ï¼Œè·³è¿‡æ£€æŸ¥'</span>);
      <span class="hljs-keyword">return</span>;
    }
  }

  <span class="hljs-keyword">const</span> filePath = context.<span class="hljs-title function_">getFilename</span>();
  <span class="hljs-keyword">const</span> filePathWrapper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FilePathWrapper</span>(filePath);

  <span class="hljs-keyword">if</span> (!reportedClassesMap.<span class="hljs-title function_">has</span>(filePathWrapper)) {
    reportedClassesMap.<span class="hljs-title function_">set</span>(filePathWrapper, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>());
  }
  <span class="hljs-keyword">const</span> reportedClasses = reportedClassesMap.<span class="hljs-title function_">get</span>(filePathWrapper);

  <span class="hljs-keyword">if</span> (reportedClasses.<span class="hljs-title function_">has</span>(className)) {
    <span class="hljs-keyword">return</span>;
  }

  <span class="hljs-keyword">const</span> propertyInfo = <span class="hljs-title function_">extractProperty</span>(className);
  <span class="hljs-keyword">if</span> (!propertyInfo) {
    <span class="hljs-keyword">return</span>;
  }

  <span class="hljs-keyword">const</span> { property, value, originalPrefix } = propertyInfo;

  <span class="hljs-comment">// åªæ£€æŸ¥ä»»æ„å€¼</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isArbitraryValue</span>(value)) {
    <span class="hljs-keyword">const</span> arbitraryValue = value.<span class="hljs-title function_">slice</span>(<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>);
    <span class="hljs-keyword">const</span> presetClass = <span class="hljs-title function_">findPresetClass</span>(property, arbitraryValue);

    <span class="hljs-keyword">if</span> (presetClass) {
      reportedClasses.<span class="hljs-title function_">add</span>(className);
      <span class="hljs-comment">// ä½¿ç”¨åŸå§‹å‰ç¼€æ˜¾ç¤ºæ­£ç¡®çš„ç±»åæ ¼å¼ï¼ˆå¦‚ h-14 è€Œä¸æ˜¯ height-14ï¼‰</span>
      <span class="hljs-keyword">const</span> suggestedClass = <span class="hljs-string">`<span class="hljs-subst">${originalPrefix}</span><span class="hljs-subst">${presetClass}</span>`</span>;
      context.<span class="hljs-title function_">report</span>({
        node,
        <span class="hljs-attr">message</span>: <span class="hljs-string">`ç±»å "<span class="hljs-subst">${className}</span>" ä½¿ç”¨äº†ä»»æ„å€¼ï¼Œä½†å­˜åœ¨å¯¹åº”çš„é¢„è®¾ç±»å "<span class="hljs-subst">${suggestedClass}</span>"ã€‚è¯·ä½¿ç”¨é¢„è®¾ç±»åæ›¿ä»£ã€‚`</span>,
      });
    }
  }
}

</code></pre>
<ul>
<li>å®ç°å±æ€§æå–ï¼Œå°†classnameè§£æä¸ºtailwindcssçš„propertyå’Œvalue</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// æå–å±æ€§å€¼</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">extractProperty</span>(<span class="hljs-params">className</span>) {
  <span class="hljs-comment">// å¤„ç†å“åº”å¼å‰ç¼€ï¼ˆå¦‚ max-md:, md:, lg: ç­‰ï¼‰</span>
  <span class="hljs-keyword">const</span> responsivePrefixes = [
    <span class="hljs-string">'max-sm:'</span>,
    <span class="hljs-string">'max-md:'</span>,
    <span class="hljs-string">'max-lg:'</span>,
    <span class="hljs-string">'max-xl:'</span>,
    <span class="hljs-string">'max-2xl:'</span>,
    <span class="hljs-string">'max-'</span>,
    <span class="hljs-string">'min-'</span>,
    <span class="hljs-string">'sm:'</span>,
    <span class="hljs-string">'md:'</span>,
    <span class="hljs-string">'lg:'</span>,
    <span class="hljs-string">'xl:'</span>,
    <span class="hljs-string">'2xl:'</span>,
  ];

  <span class="hljs-comment">// ç§»é™¤å“åº”å¼å‰ç¼€ï¼Œä¿ç•™æ ¸å¿ƒç±»å</span>
  <span class="hljs-keyword">let</span> coreClassName = className;
  <span class="hljs-keyword">let</span> responsivePrefix = <span class="hljs-string">''</span>;

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> prefix <span class="hljs-keyword">of</span> responsivePrefixes) {
    <span class="hljs-keyword">if</span> (className.<span class="hljs-title function_">startsWith</span>(prefix)) {
      responsivePrefix = prefix;
      coreClassName = className.<span class="hljs-title function_">slice</span>(prefix.<span class="hljs-property">length</span>);
      <span class="hljs-keyword">break</span>;
    }
  }

  <span class="hljs-comment">// æŒ‰å‰ç¼€é•¿åº¦é™åºæ’åºï¼Œä¼˜å…ˆåŒ¹é…æ›´é•¿çš„å‰ç¼€</span>
  <span class="hljs-keyword">const</span> sortedPrefixes = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(prefixToProperty).<span class="hljs-title function_">sort</span>(
    <span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> b.<span class="hljs-property">length</span> - a.<span class="hljs-property">length</span>
  );

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> prefix <span class="hljs-keyword">of</span> sortedPrefixes) {
    <span class="hljs-keyword">if</span> (coreClassName.<span class="hljs-title function_">startsWith</span>(prefix)) {
      <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">property</span>: prefixToProperty[prefix],
        <span class="hljs-attr">value</span>: coreClassName.<span class="hljs-title function_">slice</span>(prefix.<span class="hljs-property">length</span>),
        <span class="hljs-attr">originalPrefix</span>: responsivePrefix + prefix, <span class="hljs-comment">// åŒ…å«å“åº”å¼å‰ç¼€</span>
      };
    }
  }

  <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
}
</code></pre>
<ul>
<li>å°†æå–çš„propertyå’Œå‰é¢ç”Ÿæˆçš„å…¨é‡çš„tailwindcssè¿›è¡Œæ˜ å°„</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// ç®€åŒ–å±æ€§æ˜ å°„ï¼Œåªä¿ç•™å¸¸ç”¨çš„å±æ€§</span>
<span class="hljs-keyword">const</span> prefixToProperty = {
  <span class="hljs-comment">// å°ºå¯¸ç›¸å…³</span>
  <span class="hljs-string">"w-"</span>: <span class="hljs-string">"width"</span>,
  <span class="hljs-string">"h-"</span>: <span class="hljs-string">"height"</span>,
  <span class="hljs-string">"min-w-"</span>: <span class="hljs-string">"minWidth"</span>,
  <span class="hljs-string">"min-h-"</span>: <span class="hljs-string">"minHeight"</span>,
  <span class="hljs-string">"max-w-"</span>: <span class="hljs-string">"maxWidth"</span>,
  <span class="hljs-string">"max-h-"</span>: <span class="hljs-string">"maxHeight"</span>,

  <span class="hljs-comment">// é—´è·ç›¸å…³</span>
  <span class="hljs-string">"m-"</span>: <span class="hljs-string">"margin"</span>,
  <span class="hljs-string">"mt-"</span>: <span class="hljs-string">"marginTop"</span>,
  <span class="hljs-string">"mr-"</span>: <span class="hljs-string">"marginRight"</span>,
  <span class="hljs-string">"mb-"</span>: <span class="hljs-string">"marginBottom"</span>,
  <span class="hljs-string">"ml-"</span>: <span class="hljs-string">"marginLeft"</span>,
  <span class="hljs-string">"mx-"</span>: <span class="hljs-string">"margin"</span>,
  <span class="hljs-string">"my-"</span>: <span class="hljs-string">"margin"</span>,
  <span class="hljs-string">"p-"</span>: <span class="hljs-string">"padding"</span>,
  <span class="hljs-string">"pt-"</span>: <span class="hljs-string">"paddingTop"</span>,
  <span class="hljs-string">"pr-"</span>: <span class="hljs-string">"paddingRight"</span>,
  <span class="hljs-string">"pb-"</span>: <span class="hljs-string">"paddingBottom"</span>,
  <span class="hljs-string">"pl-"</span>: <span class="hljs-string">"paddingLeft"</span>,
  <span class="hljs-string">"px-"</span>: <span class="hljs-string">"padding"</span>,
  <span class="hljs-string">"py-"</span>: <span class="hljs-string">"padding"</span>,

  <span class="hljs-comment">// è¾¹æ¡†ç›¸å…³ï¼ˆæ–°å¢ï¼‰</span>
  <span class="hljs-string">"border-"</span>: <span class="hljs-string">"borderWidth;borderColor"</span>,
  <span class="hljs-string">"border-t-"</span>: <span class="hljs-string">"borderWidth;borderColor"</span>,
  <span class="hljs-string">"border-r-"</span>: <span class="hljs-string">"borderWidth;borderColor"</span>,
  <span class="hljs-string">"border-b-"</span>: <span class="hljs-string">"borderWidth;borderColor"</span>,
  <span class="hljs-string">"border-l-"</span>: <span class="hljs-string">"borderWidth;borderColor"</span>,
  <span class="hljs-string">"border-x-"</span>: <span class="hljs-string">"borderWidth;borderColor"</span>,
  <span class="hljs-string">"border-y-"</span>: <span class="hljs-string">"borderWidth;borderColor"</span>,

  <span class="hljs-comment">// åœ†è§’ç›¸å…³ï¼ˆæ–°å¢ï¼‰</span>
  <span class="hljs-string">"rounded-"</span>: <span class="hljs-string">"borderRadius"</span>,
  <span class="hljs-string">"rounded-t-"</span>: <span class="hljs-string">"borderRadius"</span>,
  <span class="hljs-string">"rounded-r-"</span>: <span class="hljs-string">"borderRadius"</span>,
  <span class="hljs-string">"rounded-b-"</span>: <span class="hljs-string">"borderRadius"</span>,
  <span class="hljs-string">"rounded-l-"</span>: <span class="hljs-string">"borderRadius"</span>,
  <span class="hljs-string">"rounded-tl-"</span>: <span class="hljs-string">"borderRadius"</span>,
  <span class="hljs-string">"rounded-tr-"</span>: <span class="hljs-string">"borderRadius"</span>,
  <span class="hljs-string">"rounded-br-"</span>: <span class="hljs-string">"borderRadius"</span>,
  <span class="hljs-string">"rounded-bl-"</span>: <span class="hljs-string">"borderRadius"</span>,

  <span class="hljs-comment">// æ–‡å­—ç›¸å…³</span>
  <span class="hljs-string">"text-"</span>: <span class="hljs-string">"fontSize;color"</span>,
  <span class="hljs-string">"leading-"</span>: <span class="hljs-string">"lineHeight"</span>,
  <span class="hljs-string">"tracking-"</span>: <span class="hljs-string">"letterSpacing"</span>,
  <span class="hljs-string">"font-"</span>: <span class="hljs-string">"fontWeight"</span>,

  <span class="hljs-comment">// èƒŒæ™¯ç›¸å…³</span>
  <span class="hljs-string">"bg-"</span>: <span class="hljs-string">"backgroundColor"</span>,

  <span class="hljs-comment">// SVGç›¸å…³</span>
  <span class="hljs-string">"fill-"</span>: <span class="hljs-string">"fill"</span>,
  <span class="hljs-string">"stroke-"</span>: <span class="hljs-string">"stroke"</span>,
  <span class="hljs-string">"stroke-w-"</span>: <span class="hljs-string">"strokeWidth"</span>,

  <span class="hljs-comment">// å®šä½ç›¸å…³</span>
  <span class="hljs-string">"z-"</span>: <span class="hljs-string">"zIndex"</span>,
  <span class="hljs-string">"inset-"</span>: <span class="hljs-string">"inset"</span>,
  <span class="hljs-string">"top-"</span>: <span class="hljs-string">"top"</span>,
  <span class="hljs-string">"right-"</span>: <span class="hljs-string">"right"</span>,
  <span class="hljs-string">"bottom-"</span>: <span class="hljs-string">"bottom"</span>,
  <span class="hljs-string">"left-"</span>: <span class="hljs-string">"left"</span>,

  <span class="hljs-comment">// å¸ƒå±€ç›¸å…³ï¼ˆæ–°å¢ï¼‰</span>
  <span class="hljs-string">"gap-"</span>: <span class="hljs-string">"gap"</span>,
  <span class="hljs-string">"gap-x-"</span>: <span class="hljs-string">"gap"</span>,
  <span class="hljs-string">"gap-y-"</span>: <span class="hljs-string">"gap"</span>,
  <span class="hljs-string">"space-x-"</span>: <span class="hljs-string">"gap"</span>,
  <span class="hljs-string">"space-y-"</span>: <span class="hljs-string">"gap"</span>,

  <span class="hljs-comment">// é€æ˜åº¦</span>
  <span class="hljs-string">"opacity-"</span>: <span class="hljs-string">"opacity"</span>,

  <span class="hljs-comment">// å˜æ¢ç›¸å…³ï¼ˆæ–°å¢ï¼‰</span>
  <span class="hljs-string">"scale-"</span>: <span class="hljs-string">"scale"</span>,
  <span class="hljs-string">"scale-x-"</span>: <span class="hljs-string">"scale"</span>,
  <span class="hljs-string">"scale-y-"</span>: <span class="hljs-string">"scale"</span>,
  <span class="hljs-string">"rotate-"</span>: <span class="hljs-string">"rotate"</span>,
  <span class="hljs-string">"translate-x-"</span>: <span class="hljs-string">"translate"</span>,
  <span class="hljs-string">"translate-y-"</span>: <span class="hljs-string">"translate"</span>,
  <span class="hljs-string">"skew-x-"</span>: <span class="hljs-string">"skew"</span>,
  <span class="hljs-string">"skew-y-"</span>: <span class="hljs-string">"skew"</span>,

  <span class="hljs-comment">// é˜´å½±ç›¸å…³ï¼ˆæ–°å¢ï¼‰</span>
  <span class="hljs-string">"shadow-"</span>: <span class="hljs-string">"boxShadow"</span>,

  <span class="hljs-comment">// ç½‘æ ¼ç›¸å…³ï¼ˆæ–°å¢ï¼‰</span>
  <span class="hljs-string">"grid-cols-"</span>: <span class="hljs-string">"gridTemplateColumns"</span>,
  <span class="hljs-string">"grid-rows-"</span>: <span class="hljs-string">"gridTemplateRows"</span>,
  <span class="hljs-string">"col-"</span>: <span class="hljs-string">"gridColumn"</span>,
  <span class="hljs-string">"row-"</span>: <span class="hljs-string">"gridRow"</span>,
  <span class="hljs-string">"col-start-"</span>: <span class="hljs-string">"gridColumnStart"</span>,
  <span class="hljs-string">"col-end-"</span>: <span class="hljs-string">"gridColumnEnd"</span>,
  <span class="hljs-string">"row-start-"</span>: <span class="hljs-string">"gridRowStart"</span>,
  <span class="hljs-string">"row-end-"</span>: <span class="hljs-string">"gridRowEnd"</span>,

  <span class="hljs-comment">// Flexboxç›¸å…³ï¼ˆæ–°å¢ï¼‰</span>
  <span class="hljs-string">"flex-"</span>: <span class="hljs-string">"flex"</span>,
  <span class="hljs-string">"basis-"</span>: <span class="hljs-string">"flexBasis"</span>,
  <span class="hljs-string">"grow-"</span>: <span class="hljs-string">"flexGrow"</span>,
  <span class="hljs-string">"shrink-"</span>: <span class="hljs-string">"flexShrink"</span>,
  <span class="hljs-string">"order-"</span>: <span class="hljs-string">"order"</span>,

  <span class="hljs-comment">// åŠ¨ç”»ç›¸å…³ï¼ˆæ–°å¢ï¼‰</span>
  <span class="hljs-string">"duration-"</span>: <span class="hljs-string">"transitionDuration"</span>,
  <span class="hljs-string">"delay-"</span>: <span class="hljs-string">"transitionDelay"</span>,
  <span class="hljs-string">"ease-"</span>: <span class="hljs-string">"transitionTimingFunction"</span>,

  <span class="hljs-comment">// å…¶ä»–ï¼ˆæ–°å¢ï¼‰</span>
  <span class="hljs-string">"aspect-"</span>: <span class="hljs-string">"aspectRatio"</span>,
  <span class="hljs-string">"cursor-"</span>: <span class="hljs-string">"cursor"</span>,
};

<span class="hljs-comment">// åŠ¨æ€æ„å»ºæ”¯æŒçš„ Tailwind å±æ€§æ˜ å°„</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getSupportedProperties</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> config = <span class="hljs-title class_">TailwindConfigLoader</span>.<span class="hljs-title function_">getConfig</span>();
  <span class="hljs-keyword">if</span> (!config) {
    <span class="hljs-keyword">return</span> {};
  }

  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">width</span>: config.<span class="hljs-property">theme</span>.<span class="hljs-property">width</span>,
    <span class="hljs-attr">height</span>: config.<span class="hljs-property">theme</span>.<span class="hljs-property">height</span>,
    <span class="hljs-attr">minWidth</span>: config.<span class="hljs-property">theme</span>.<span class="hljs-property">minWidth</span>,
    <span class="hljs-attr">minHeight</span>: config.<span class="hljs-property">theme</span>.<span class="hljs-property">minHeight</span>,
    <span class="hljs-attr">maxWidth</span>: config.<span class="hljs-property">theme</span>.<span class="hljs-property">maxWidth</span>,
    <span class="hljs-attr">maxHeight</span>: config.<span class="hljs-property">theme</span>.<span class="hljs-property">maxHeight</span>,
    <span class="hljs-attr">margin</span>: config.<span class="hljs-property">theme</span>.<span class="hljs-property">margin</span>,
    <span class="hljs-attr">marginTop</span>: config.<span class="hljs-property">theme</span>.<span class="hljs-property">margin</span>,
    <span class="hljs-attr">marginRight</span>: config.<span class="hljs-property">theme</span>.<span class="hljs-property">margin</span>,
    <span class="hljs-attr">marginBottom</span>: config.<span class="hljs-property">theme</span>.<span class="hljs-property">margin</span>,
    <span class="hljs-attr">marginLeft</span>: config.<span class="hljs-property">theme</span>.<span class="hljs-property">margin</span>,
    <span class="hljs-attr">padding</span>: config.<span class="hljs-property">theme</span>.<span class="hljs-property">padding</span>,
    <span class="hljs-attr">paddingTop</span>: config.<span class="hljs-property">theme</span>.<span class="hljs-property">padding</span>,
    <span class="hljs-attr">paddingRight</span>: config.<span class="hljs-property">theme</span>.<span class="hljs-property">padding</span>,
    <span class="hljs-attr">paddingBottom</span>: config.<span class="hljs-property">theme</span>.<span class="hljs-property">padding</span>,
    <span class="hljs-attr">paddingLeft</span>: config.<span class="hljs-property">theme</span>.<span class="hljs-property">padding</span>,
    <span class="hljs-attr">fontSize</span>: config.<span class="hljs-property">theme</span>.<span class="hljs-property">fontSize</span>,
    <span class="hljs-attr">lineHeight</span>: config.<span class="hljs-property">theme</span>.<span class="hljs-property">lineHeight</span>,
    <span class="hljs-attr">borderRadius</span>: config.<span class="hljs-property">theme</span>.<span class="hljs-property">borderRadius</span>,
    <span class="hljs-attr">color</span>: config.<span class="hljs-property">theme</span>.<span class="hljs-property">colors</span>,
    <span class="hljs-attr">backgroundColor</span>: config.<span class="hljs-property">theme</span>.<span class="hljs-property">backgroundColor</span>,
    <span class="hljs-attr">borderColor</span>: config.<span class="hljs-property">theme</span>.<span class="hljs-property">borderColor</span>,
    <span class="hljs-attr">fill</span>: config.<span class="hljs-property">theme</span>.<span class="hljs-property">fill</span>,
    <span class="hljs-attr">stroke</span>: config.<span class="hljs-property">theme</span>.<span class="hljs-property">stroke</span>,
    <span class="hljs-attr">borderWidth</span>: config.<span class="hljs-property">theme</span>.<span class="hljs-property">borderWidth</span>,
    <span class="hljs-attr">zIndex</span>: config.<span class="hljs-property">theme</span>.<span class="hljs-property">zIndex</span>,
    <span class="hljs-attr">gap</span>: config.<span class="hljs-property">theme</span>.<span class="hljs-property">gap</span>,
    <span class="hljs-attr">inset</span>: config.<span class="hljs-property">theme</span>.<span class="hljs-property">inset</span>,
    <span class="hljs-attr">top</span>: config.<span class="hljs-property">theme</span>.<span class="hljs-property">spacing</span>,
    <span class="hljs-attr">right</span>: config.<span class="hljs-property">theme</span>.<span class="hljs-property">spacing</span>,
    <span class="hljs-attr">bottom</span>: config.<span class="hljs-property">theme</span>.<span class="hljs-property">spacing</span>,
    <span class="hljs-attr">left</span>: config.<span class="hljs-property">theme</span>.<span class="hljs-property">spacing</span>,
    <span class="hljs-attr">opacity</span>: config.<span class="hljs-property">theme</span>.<span class="hljs-property">opacity</span>,
  };
}
</code></pre>
<h2 data-id="heading-8">æ•´ä½“å®ç°æµç¨‹</h2>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    A[ESLint æ‰§è¡Œæ’ä»¶] --&gt; B[éå†ä»£ç ä¸­çš„ç±»å]
    B --&gt; C{æ˜¯å¦ä¸º Tailwind ç±»å?}
    C --&gt;|å¦| D[è·³è¿‡æ£€æŸ¥]
    C --&gt;|æ˜¯| E{æ˜¯å¦åŒ…å«ä»»æ„å€¼?}
    E --&gt;|å¦| F[ä½¿ç”¨é¢„è®¾å€¼ é€šè¿‡æ£€æŸ¥]
    E --&gt;|æ˜¯| G[æå–ç±»åå‰ç¼€å’Œä»»æ„å€¼]
    
    G --&gt; H[é€šè¿‡ prefixToProperty æ˜ å°„åˆ°CSSå±æ€§]
    H --&gt; I[æ£€æŸ¥Tailwindé…ç½®æ˜¯å¦å·²åŠ è½½]
    I --&gt;|å·²åŠ è½½| J[è·å–æ”¯æŒçš„å±æ€§é¢„è®¾å€¼]
    I --&gt;|æœªåŠ è½½| K[åŠ è½½é¡¹ç›®Tailwindé…ç½®]
    
    K --&gt; L[è¯»å–é¡¹ç›®tailwind.config.js]
    L --&gt; M{é…ç½®æ˜¯å¦å­˜åœ¨?}
    M --&gt;|ä¸å­˜åœ¨| N[ä½¿ç”¨Tailwindé»˜è®¤é…ç½®]
    M --&gt;|å­˜åœ¨| O[è§£æé¡¹ç›®é…ç½®]
    
    O --&gt; P[åˆå¹¶é»˜è®¤é…ç½®å’Œé¡¹ç›®é…ç½®]
    N --&gt; P
    
    P --&gt; Q[ç”Ÿæˆå…¨é‡Tailwindé…ç½®]
    Q --&gt; R[ç¼“å­˜é…ç½®åˆ°å†…å­˜]
    R --&gt; J
    
    J --&gt; S{åˆ¤æ–­å±æ€§ç±»å‹}
    S --&gt;|é¢œè‰²ç›¸å…³| T[è°ƒç”¨ findColorPreset]
    S --&gt;|æ•°å€¼ç›¸å…³| U[è°ƒç”¨ findNumericPreset]
    
    T --&gt; V{æ˜¯å¦åŒ¹é…é¢„è®¾?}
    U --&gt; V
    
    V --&gt;|æ˜¯| W[æ‰¾åˆ°å¯¹åº”é¢„è®¾ç±»å]
    V --&gt;|å¦| X[æœªæ‰¾åˆ°é¢„è®¾ç±»å]
    
    W --&gt; Y[ç”Ÿæˆå»ºè®®æ¶ˆæ¯]
    X --&gt; Z[é€šè¿‡æ£€æŸ¥ æ— åŒ¹é…é¢„è®¾]
    
    Y --&gt; AA[æŠ¥å‘Šå»ºè®®]
    Z --&gt; BB[æ£€æŸ¥å®Œæˆ]
    
    AA --&gt; BB
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[windowsç³»ç»Ÿæ­å»ºkafkaç¯å¢ƒ]]></title>    <link>https://juejin.cn/post/7585397173023735827</link>    <guid>https://juejin.cn/post/7585397173023735827</guid>    <pubDate>2025-12-20T07:21:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585397173023735827" data-draft-id="7585382553290719268" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="windowsç³»ç»Ÿæ­å»ºkafkaç¯å¢ƒ"/> <meta itemprop="keywords" content="åç«¯"/> <meta itemprop="datePublished" content="2025-12-20T07:21:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="è‹ä¸‰çš„å¼€å‘æ—¥è®°"/> <meta itemprop="url" content="https://juejin.cn/user/4248949048749213"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="æ˜é‡‘"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            windowsç³»ç»Ÿæ­å»ºkafkaç¯å¢ƒ
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4248949048749213/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    è‹ä¸‰çš„å¼€å‘æ—¥è®°
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T07:21:34.000Z" title="Sat Dec 20 2025 07:21:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    é˜…è¯»2åˆ†é’Ÿ
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>kafkaå†…ç½®zkï¼Œå› æ­¤æ²¡å¿…è¦å®‰è£…zkã€‚</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fkafka.apache.org%2Fcommunity%2Fdownloads%2F" target="_blank" title="https://kafka.apache.org/community/downloads/" ref="nofollow noopener noreferrer">kafka.apache.org/community/dâ€¦</a></p>
<p>1.ä¿®æ”¹zookeeper.propertiesæ–‡ä»¶</p>
<pre><code class="hljs language-js" lang="js">dataDir=<span class="hljs-attr">E</span>:<span class="hljs-regexp">/kafka_2.12-3.6.1/</span>data/zk
</code></pre>
<p>2.ä¿®æ”¹server.propertiesæ–‡ä»¶</p>
<pre><code class="hljs language-js" lang="js">log.<span class="hljs-property">dirs</span>=<span class="hljs-attr">e</span>:<span class="hljs-regexp">/kafka/</span>data/kafka
</code></pre>
<p>3.é…ç½®zk.cmd</p>
<pre><code class="hljs language-js" lang="js">call bin/windows/kafka-server-start.<span class="hljs-property">bat</span> config/server.<span class="hljs-property">properties</span>
</code></pre>
<p>4.é…ç½®kafka.cmd</p>
<pre><code class="hljs language-js" lang="js">call bin/windows/zookeeper-server-start.<span class="hljs-property">bat</span> config/zookeeper.<span class="hljs-property">properties</span>
</code></pre>
<p>5.ä¸€äº›å¸¸ç”¨çš„å‘½ä»¤</p>
<pre><code class="hljs language-js" lang="js">kafka-topics.<span class="hljs-property">bat</span> ç›¸å…³

 --bootstrap-server : æŠŠå½“å‰çš„<span class="hljs-variable constant_">DOS</span>çª—å£å½“æˆ<span class="hljs-title class_">Kafka</span>çš„å®¢æˆ·ç«¯
 --create : è¡¨ç¤ºå¯¹ä¸»é¢˜çš„åˆ›å»ºæ“ä½œï¼Œæ˜¯ä¸ªæ“ä½œå‚æ•°ï¼Œåé¢æ— éœ€å¢åŠ å‚æ•°å€¼
 --topic : ä¸»é¢˜çš„åç§°
 --list : è¡¨ç¤ºå¯¹æ‰€æœ‰ä¸»é¢˜çš„æŸ¥è¯¢æ“ä½œï¼Œæ˜¯ä¸ªæ“ä½œå‚æ•°ï¼Œåé¢æ— éœ€å¢åŠ å‚æ•°å€¼
 --describe : æŸ¥çœ‹ä¸»é¢˜çš„è¯¦ç»†ä¿¡æ¯
 --alter : è¡¨ç¤ºå¯¹æ‰€æœ‰ä¸»é¢˜çš„æŸ¥è¯¢æ“ä½œï¼Œæ˜¯ä¸ªæ“ä½œå‚æ•°ï¼Œåé¢æ— éœ€å¢åŠ å‚æ•°å€¼
--partitions : ä¿®æ”¹çš„é…ç½®å‚æ•°ï¼šåˆ†åŒºæ•°é‡
 --<span class="hljs-attr">delete</span>: è¡¨ç¤ºå¯¹ä¸»é¢˜çš„åˆ é™¤æ“ä½œï¼Œæ˜¯ä¸ªæ“ä½œå‚æ•°ï¼Œåé¢æ— éœ€å¢åŠ å‚æ•°å€¼ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œåˆ é™¤æ“ä½œæ˜¯é€»è¾‘åˆ é™¤ï¼Œä¹Ÿå°±æ˜¯è¯´æ•°æ®å­˜å‚¨çš„æ–‡ä»¶ä¾ç„¶å­˜åœ¨ï¼Œ
ä½†æ˜¯é€šè¿‡æŒ‡ä»¤æŸ¥è¯¢ä¸å‡ºæ¥ã€‚å¦‚æœæƒ³è¦ç›´æ¥åˆ é™¤ï¼Œéœ€è¦åœ¨server.<span class="hljs-property">properties</span>æ–‡ä»¶ä¸­è®¾ç½®å‚æ•°<span class="hljs-keyword">delete</span>.<span class="hljs-property">topic</span>.<span class="hljs-property">enable</span>=<span class="hljs-literal">true</span>

kafka-topics.<span class="hljs-property">bat</span> --bootstrap-server <span class="hljs-attr">localhost</span>:<span class="hljs-number">9092</span> --create --topic test
kafka-topics.<span class="hljs-property">bat</span> --bootstrap-server <span class="hljs-attr">localhost</span>:<span class="hljs-number">9092</span> --list
kafka-topics.<span class="hljs-property">bat</span> --bootstrap-server <span class="hljs-attr">localhost</span>:<span class="hljs-number">9092</span> --describe --topic test
kafka-topics.<span class="hljs-property">bat</span> --bootstrap-server <span class="hljs-attr">localhost</span>:<span class="hljs-number">9092</span> --topic test --alter --partitions <span class="hljs-number">2</span>
kafka-topics.<span class="hljs-property">bat</span> --bootstrap-server <span class="hljs-attr">localhost</span>:<span class="hljs-number">9092</span> --topic test --<span class="hljs-keyword">delete</span>

<span class="hljs-attr">notice</span>:
windowsç³»ç»Ÿä¸­ç”±äºæƒé™æˆ–è¿›ç¨‹é”å®šçš„é—®é¢˜ï¼Œåˆ é™¤topicä¼šå¯¼è‡´kafkaæœåŠ¡èŠ‚ç‚¹å¼‚å¸¸å…³é—­ã€‚

kafka-<span class="hljs-variable language_">console</span>-producer.<span class="hljs-property">bat</span> ç›¸å…³

kafka-<span class="hljs-variable language_">console</span>-producer.<span class="hljs-property">bat</span> --bootstrap-server <span class="hljs-attr">localhost</span>:<span class="hljs-number">9092</span> --topic test

typing message you want to send

kafka-<span class="hljs-variable language_">console</span>-consumer.<span class="hljs-property">bat</span> ç›¸å…³

--<span class="hljs-keyword">from</span>-beginning : ä»ç¬¬ä¸€æ¡æ•°æ®å¼€å§‹æ¶ˆè´¹ï¼Œæ— å‚æ•°å€¼ï¼Œæ˜¯ä¸€ä¸ªæ ‡è®°å‚æ•°

kafka-<span class="hljs-variable language_">console</span>-consumer.<span class="hljs-property">bat</span> --bootstrap-server <span class="hljs-attr">localhost</span>:<span class="hljs-number">9092</span> --topic test --<span class="hljs-keyword">from</span>-beginning

</code></pre>
<p>6.windowsç«¯æ¨¡æ‹Ÿé›†ç¾¤æœåŠ¡çš„æ­å»º</p>
<pre><code class="hljs language-js" lang="js">è§£å‹kafka_2<span class="hljs-number">.12</span>-<span class="hljs-number">3.6</span><span class="hljs-number">.1</span>.<span class="hljs-property">tgz</span> åˆ†åˆ«ç”Ÿæˆ<span class="hljs-number">4</span>ä¸ªæ–‡ä»¶å¤¹ node-<span class="hljs-number">1</span>,node-<span class="hljs-number">2</span>,node-<span class="hljs-number">3</span>,zookeeper


node-<span class="hljs-number">1</span> ä¿®æ”¹server.<span class="hljs-property">properties</span>
broker.<span class="hljs-property">id</span>=<span class="hljs-number">1</span>
listeners=<span class="hljs-attr">PLAINTEXT</span>:<span class="hljs-comment">//:9091 log.dirs=E:/kafka/node-1/data zookeeper.connect=localhost:2181/kafka</span>

node-<span class="hljs-number">2</span> ä¿®æ”¹server.<span class="hljs-property">properties</span> 
broker.<span class="hljs-property">id</span>=<span class="hljs-number">2</span> 
listeners=<span class="hljs-attr">PLAINTEXT</span>:<span class="hljs-comment">//:9092 log.dirs=E:/kafka/node-2/data zookeeper.connect=localhost:2181/kafka</span>

node-<span class="hljs-number">3</span> ä¿®æ”¹server.<span class="hljs-property">properties</span>
broker.<span class="hljs-property">id</span>=<span class="hljs-number">3</span> 
listeners=<span class="hljs-attr">PLAINTEXT</span>:<span class="hljs-comment">//:9093 log.dirs=E:/kafka/node-3/data zookeeper.connect=localhost:2181/kafka</span>


zookeeperæ–‡ä»¶å¤¹æ·»åŠ zk.<span class="hljs-property">cmd</span>
zk.<span class="hljs-property">cmd</span>å†…å®¹ï¼š
call bin/windows/zookeeper-server-start.<span class="hljs-property">bat</span> config/zookeeper.<span class="hljs-property">properties</span>



node-<span class="hljs-number">1</span> node-<span class="hljs-number">2</span> node-<span class="hljs-number">3</span> æ·»åŠ kafka.<span class="hljs-property">cmd</span>
kafka.<span class="hljs-property">cmd</span>å†…å®¹ï¼š
call bin/windows/kafka-server-start.<span class="hljs-property">bat</span> config/server.<span class="hljs-property">properties</span>

node-<span class="hljs-number">1</span> åŒçº§åˆ«è·¯å¾„æ·»åŠ cluster.<span class="hljs-property">cmd</span> cluster-clear.<span class="hljs-property">cmd</span>
</code></pre>
<p>7.cluster.cmd</p>
<pre><code class="hljs language-js" lang="js">cd zookeeper
start zk.<span class="hljs-property">cmd</span>
ping <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span> -n <span class="hljs-number">10</span> &gt;nul
cd ../node-<span class="hljs-number">1</span>
start kafka.<span class="hljs-property">cmd</span>
cd ../node-<span class="hljs-number">2</span>
start kafka.<span class="hljs-property">cmd</span>
cd ../node-<span class="hljs-number">3</span>
start kafka.<span class="hljs-property">cmd</span>
</code></pre>
<p>8.cluster-clear.cmd</p>
<pre><code class="hljs language-js" lang="js">cd zookeeper
rd /s /q data
cd ../node-<span class="hljs-number">1</span>
rd /s /q data
cd ../node-<span class="hljs-number">2</span>
rd /s /q data
cd ../node-<span class="hljs-number">3</span>
rd /s /q data
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[PyTorchåŠ¨æ€å›¾ç¼–ç¨‹ä¸è‡ªå®šä¹‰ç½‘ç»œå±‚å®æˆ˜æ•™ç¨‹]]></title>    <link>https://juejin.cn/post/7585446706327322633</link>    <guid>https://juejin.cn/post/7585446706327322633</guid>    <pubDate>2025-12-20T07:21:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585446706327322633" data-draft-id="7585706951583334409" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="PyTorchåŠ¨æ€å›¾ç¼–ç¨‹ä¸è‡ªå®šä¹‰ç½‘ç»œå±‚å®æˆ˜æ•™ç¨‹"/> <meta itemprop="keywords" content="Python"/> <meta itemprop="datePublished" content="2025-12-20T07:21:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="testç®¡å®¶"/> <meta itemprop="url" content="https://juejin.cn/user/2763513988408746"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="æ˜é‡‘"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            PyTorchåŠ¨æ€å›¾ç¼–ç¨‹ä¸è‡ªå®šä¹‰ç½‘ç»œå±‚å®æˆ˜æ•™ç¨‹
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2763513988408746/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    testç®¡å®¶
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T07:21:14.000Z" title="Sat Dec 20 2025 07:21:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    é˜…è¯»11åˆ†é’Ÿ
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>åœ¨æ·±åº¦å­¦ä¹ æ¡†æ¶çš„å‘å±•ä¸­ï¼ŒPyTorchå‡­å€Ÿ<strong>åŠ¨æ€è®¡ç®—å›¾</strong>çš„çµæ´»æ€§æˆä¸ºç§‘ç ”å’Œå·¥ç¨‹é¢†åŸŸçš„ä¸»æµé€‰æ‹©ï¼Œå…¶åŠ¨æ€å›¾æœºåˆ¶æ‰“ç ´äº†é™æ€å›¾æ¡†æ¶çš„ç¼–è¯‘é™åˆ¶ï¼Œè®©å¼€å‘è€…èƒ½ä»¥æ›´è´´è¿‘Pythonçš„ç¼–ç¨‹ä¹ æƒ¯æ„å»ºæ¨¡å‹ã€‚è€Œåœ¨å®é™…é¡¹ç›®ä¸­ï¼Œé¢å¯¹ä¸ªæ€§åŒ–çš„ä¸šåŠ¡éœ€æ±‚ï¼ˆå¦‚å®šåˆ¶åŒ–æ¿€æ´»å‡½æ•°ã€ç‰¹æ®Šå·ç§¯æ“ä½œï¼‰ï¼ŒPyTorchå†…ç½®çš„ç½‘ç»œå±‚å¾€å¾€æ— æ³•æ»¡è¶³è¦æ±‚ï¼Œæ­¤æ—¶æŒæ¡<strong>è‡ªå®šä¹‰ç½‘ç»œå±‚</strong>çš„å®ç°æ–¹æ³•å°±æˆä¸ºè¿›é˜¶çš„å…³é”®ã€‚</p>
<h2 data-id="heading-0">ä¸€ã€PyTorchåŠ¨æ€å›¾ç¼–ç¨‹ï¼šåŸç†ä¸å®æˆ˜</h2>
<h3 data-id="heading-1">1.1 åŠ¨æ€å›¾ä¸é™æ€å›¾çš„æ ¸å¿ƒå·®å¼‚</h3>
<p>æ·±åº¦å­¦ä¹ ä¸­çš„è®¡ç®—å›¾æ˜¯å¯¹æ¨¡å‹è¿ç®—æµç¨‹çš„å¯è§†åŒ–æŠ½è±¡ï¼Œæœ¬è´¨æ˜¯ç”±èŠ‚ç‚¹ï¼ˆå¼ é‡è¿ç®—ï¼‰å’Œè¾¹ï¼ˆå¼ é‡æ•°æ®ï¼‰ç»„æˆçš„æœ‰å‘å›¾ã€‚PyTorchçš„åŠ¨æ€å›¾ï¼ˆDynamic Computational Graphï¼‰ä¸TensorFlow1.xçš„é™æ€å›¾ï¼ˆStatic Computational Graphï¼‰æ ¸å¿ƒåŒºåˆ«åœ¨äº<strong>å›¾çš„æ„å»ºæ—¶æœº</strong>ï¼š</p>
<ul>
<li><strong>é™æ€å›¾</strong>ï¼šå…ˆå®šä¹‰å®Œæ•´çš„è®¡ç®—å›¾ç»“æ„ï¼Œå†å°†æ•°æ®å–‚å…¥æ‰§è¡Œï¼Œå›¾çš„ç»“æ„ä¸€æ—¦ç¡®å®šæ— æ³•å®æ—¶ä¿®æ”¹ï¼Œä¼˜åŠ¿æ˜¯ç¼–è¯‘ä¼˜åŒ–åæ‰§è¡Œæ•ˆç‡é«˜ï¼Œä½†è°ƒè¯•å’ŒåŠ¨æ€é€»è¾‘å®ç°éš¾åº¦å¤§ã€‚</li>
<li><strong>åŠ¨æ€å›¾</strong>ï¼šéšä»£ç æ‰§è¡Œ<strong>å³æ—¶æ„å»º</strong>è®¡ç®—å›¾ï¼Œæ¯è¿è¡Œä¸€è¡Œè¿ç®—ä»£ç ï¼Œå°±å‘å›¾ä¸­æ·»åŠ ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå›¾çš„ç»“æ„å¯æ ¹æ®è¾“å…¥æ•°æ®æˆ–æ¡ä»¶åˆ¤æ–­åŠ¨æ€è°ƒæ•´ï¼Œæ”¯æŒPythonåŸç”Ÿçš„å¾ªç¯ã€åˆ†æ”¯ç­‰æ§åˆ¶æµï¼Œè°ƒè¯•æ—¶èƒ½åƒæ™®é€šPythonä»£ç ä¸€æ ·é€è¡ŒæŸ¥çœ‹å¼ é‡å€¼ã€‚</li>
</ul>
<p>PyTorchçš„åŠ¨æ€å›¾æœºåˆ¶åŸºäº<strong>Autograd</strong>ï¼ˆè‡ªåŠ¨æ±‚å¯¼å¼•æ“ï¼‰å®ç°ï¼ŒAutogradä¼šè®°å½•å¼ é‡çš„æ‰€æœ‰è¿ç®—æ“ä½œï¼Œå¹¶åœ¨åå‘ä¼ æ’­æ—¶è‡ªåŠ¨è®¡ç®—æ¢¯åº¦ï¼Œè¿™ä¹Ÿæ˜¯åŠ¨æ€å›¾èƒ½å¤Ÿæ”¯æŒå®æ—¶æ±‚å¯¼çš„æ ¸å¿ƒã€‚</p>
<h3 data-id="heading-2">1.2 åŠ¨æ€å›¾çš„è‡ªåŠ¨æ±‚å¯¼åŸºç¡€</h3>
<p>PyTorchä¸­åªæœ‰è®¾ç½®<code>requires_grad=True</code>çš„å¼ é‡ï¼Œæ‰ä¼šè¢«Autogradè¿½è¸ªè¿ç®—å¹¶æ„å»ºè®¡ç®—å›¾ã€‚æˆ‘ä»¬é€šè¿‡ç®€å•çš„å¼ é‡è¿ç®—ç¤ºä¾‹ï¼Œç›´è§‚ç†è§£åŠ¨æ€å›¾çš„æ„å»ºä¸æ±‚å¯¼è¿‡ç¨‹ï¼š</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> torch

<span class="hljs-comment"># å®šä¹‰éœ€è¦æ±‚å¯¼çš„å¼ é‡</span>
x = torch.tensor([<span class="hljs-number">2.0</span>], requires_grad=<span class="hljs-literal">True</span>)
y = torch.tensor([<span class="hljs-number">3.0</span>], requires_grad=<span class="hljs-literal">True</span>)

<span class="hljs-comment"># åŠ¨æ€æ„å»ºè®¡ç®—å›¾ï¼šz = xÂ² + 2xy + yÂ³</span>
z = x ** <span class="hljs-number">2</span> + <span class="hljs-number">2</span> * x * y + y ** <span class="hljs-number">3</span>

<span class="hljs-comment"># åå‘ä¼ æ’­ï¼Œè®¡ç®—zå¯¹xå’Œyçš„æ¢¯åº¦</span>
z.backward()

<span class="hljs-comment"># æ‰“å°æ¢¯åº¦ç»“æœ</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"dz/dx: <span class="hljs-subst">{x.grad.item()}</span>"</span>)  <span class="hljs-comment"># ç†è®ºå€¼ï¼š2x+2y = 4+6=10</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"dz/dy: <span class="hljs-subst">{y.grad.item()}</span>"</span>)  <span class="hljs-comment"># ç†è®ºå€¼ï¼š2x+3yÂ² =4+27=31</span>
</code></pre>
<p>è¿è¡Œç»“æœä¼šè¾“å‡º<code>dz/dx: 10.0</code>å’Œ<code>dz/dy: 31.0</code>ï¼Œä¸ç†è®ºè®¡ç®—ä¸€è‡´ã€‚è¿™é‡Œéœ€è¦æ³¨æ„ï¼šAutogradæ„å»ºçš„è®¡ç®—å›¾æ˜¯<strong>åŠ¨æ€ä¸´æ—¶</strong>çš„ï¼Œæ¯æ¬¡<code>backward()</code>åï¼Œè®¡ç®—å›¾ä¼šè¢«é‡Šæ”¾ï¼Œè‹¥éœ€é‡å¤æ±‚å¯¼éœ€è®¾ç½®<code>retain_graph=True</code>ã€‚</p>
<h3 data-id="heading-3">1.3 åŠ¨æ€æ§åˆ¶æµçš„å®ç°</h3>
<p>åŠ¨æ€å›¾çš„æ ¸å¿ƒä¼˜åŠ¿æ˜¯æ”¯æŒPythonåŸç”Ÿæ§åˆ¶æµï¼Œæ¯”å¦‚æ ¹æ®å¼ é‡çš„å€¼åŠ¨æ€é€‰æ‹©è¿ç®—åˆ†æ”¯ã€‚ä»¥ä¸‹ç¤ºä¾‹æ¨¡æ‹Ÿä¸€ä¸ªâ€œæ ¹æ®è¾“å…¥å€¼å†³å®šå¾ªç¯æ¬¡æ•°â€çš„åŠ¨æ€è¿ç®—ï¼Œå±•ç¤ºåŠ¨æ€å›¾çš„çµæ´»æ€§ï¼š</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">dynamic_operation</span>(<span class="hljs-params">x</span>):
    <span class="hljs-comment"># åˆå§‹åŒ–è¾“å‡ºå¼ é‡</span>
    out = torch.tensor([<span class="hljs-number">0.0</span>], requires_grad=<span class="hljs-literal">True</span>)
    <span class="hljs-comment"># æ ¹æ®xçš„æ•°å€¼åŠ¨æ€ç¡®å®šå¾ªç¯æ¬¡æ•°</span>
    loop_times = <span class="hljs-built_in">int</span>(x.item()) <span class="hljs-keyword">if</span> x.item() &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">else</span> <span class="hljs-number">1</span>
    
    <span class="hljs-comment"># åŠ¨æ€å¾ªç¯æ„å»ºè®¡ç®—å›¾</span>
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(loop_times):
        out = out + x * (i + <span class="hljs-number">1</span>)
    <span class="hljs-keyword">return</span> out

<span class="hljs-comment"># æµ‹è¯•ä¸åŒè¾“å…¥çš„åŠ¨æ€è¿ç®—</span>
x1 = torch.tensor([<span class="hljs-number">2.0</span>], requires_grad=<span class="hljs-literal">True</span>)
res1 = dynamic_operation(x1)
res1.backward()
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"è¾“å…¥x=2æ—¶ï¼Œæ¢¯åº¦ä¸ºï¼š<span class="hljs-subst">{x1.grad.item()}</span>"</span>)  <span class="hljs-comment"># å¾ªç¯2æ¬¡ï¼š1*2 + 2*2 =6ï¼Œæ¢¯åº¦ä¸º3</span>

x2 = torch.tensor([-<span class="hljs-number">1.0</span>], requires_grad=<span class="hljs-literal">True</span>)
res2 = dynamic_operation(x2)
res2.backward()
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"è¾“å…¥x=-1æ—¶ï¼Œæ¢¯åº¦ä¸ºï¼š<span class="hljs-subst">{x2.grad.item()}</span>"</span>)  <span class="hljs-comment"># å¾ªç¯1æ¬¡ï¼š1*(-1)ï¼Œæ¢¯åº¦ä¸º1</span>
</code></pre>
<p>ä¸Šè¿°ä»£ç ä¸­ï¼Œå¾ªç¯æ¬¡æ•°ç”±è¾“å…¥å¼ é‡<code>x</code>çš„æ•°å€¼å†³å®šï¼Œé™æ€å›¾æ¡†æ¶éœ€é€šè¿‡ç‰¹æ®Šç®—å­å®ç°æ­¤ç±»é€»è¾‘ï¼Œè€ŒPyTorchçš„åŠ¨æ€å›¾å¯ç›´æ¥ä½¿ç”¨Pythonå¾ªç¯ï¼Œå¤§å¹…é™ä½ä»£ç å¤æ‚åº¦ã€‚</p>
<h3 data-id="heading-4">1.4 å®æˆ˜ï¼šåŠ¨æ€å›¾å®ç°çº¿æ€§å›å½’</h3>
<p>æˆ‘ä»¬ç»“åˆåŠ¨æ€å›¾å’ŒAutogradï¼Œå®ç°ä¸€ä¸ªç®€å•çš„çº¿æ€§å›å½’æ¨¡å‹ï¼Œå®Œæ•´å±•ç¤ºåŠ¨æ€å›¾çš„å»ºæ¨¡ã€è®­ç»ƒæµç¨‹ï¼š</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> torch
<span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt

<span class="hljs-comment"># 1. ç”Ÿæˆæ¨¡æ‹Ÿæ•°æ®</span>
torch.manual_seed(<span class="hljs-number">42</span>)  <span class="hljs-comment"># å›ºå®šéšæœºç§å­</span>
x = torch.randn(<span class="hljs-number">100</span>, <span class="hljs-number">1</span>)  <span class="hljs-comment"># ç‰¹å¾ï¼š100ä¸ªæ ·æœ¬ï¼Œ1ä¸ªç‰¹å¾</span>
y = <span class="hljs-number">3</span> * x + <span class="hljs-number">2</span> + torch.randn(<span class="hljs-number">100</span>, <span class="hljs-number">1</span>) * <span class="hljs-number">0.5</span>  <span class="hljs-comment"># æ ‡ç­¾ï¼šy=3x+2+å™ªå£°</span>

<span class="hljs-comment"># 2. å®šä¹‰æ¨¡å‹å‚æ•°ï¼ˆéœ€è¦æ±‚å¯¼ï¼‰</span>
w = torch.tensor([<span class="hljs-number">1.0</span>], requires_grad=<span class="hljs-literal">True</span>)
b = torch.tensor([<span class="hljs-number">0.0</span>], requires_grad=<span class="hljs-literal">True</span>)

<span class="hljs-comment"># 3. å®šä¹‰çº¿æ€§å›å½’å‰å‘ä¼ æ’­ï¼ˆåŠ¨æ€æ„å»ºè®¡ç®—å›¾ï¼‰</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">linear_model</span>(<span class="hljs-params">x</span>):
    <span class="hljs-keyword">return</span> w * x + b

<span class="hljs-comment"># 4. å®šä¹‰æŸå¤±å‡½æ•°ï¼ˆå‡æ–¹è¯¯å·®ï¼‰</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">mse_loss</span>(<span class="hljs-params">y_pred, y_true</span>):
    <span class="hljs-keyword">return</span> torch.mean((y_pred - y_true) ** <span class="hljs-number">2</span>)

<span class="hljs-comment"># 5. è®­ç»ƒæ¨¡å‹ï¼ˆåŠ¨æ€å›¾å®æ—¶æ›´æ–°ï¼‰</span>
learning_rate = <span class="hljs-number">0.1</span>
loss_list = []
<span class="hljs-keyword">for</span> epoch <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">100</span>):
    <span class="hljs-comment"># å‰å‘ä¼ æ’­ï¼šåŠ¨æ€æ„å»ºè®¡ç®—å›¾</span>
    y_pred = linear_model(x)
    loss = mse_loss(y_pred, y)
    
    <span class="hljs-comment"># åå‘ä¼ æ’­ï¼šè‡ªåŠ¨è®¡ç®—æ¢¯åº¦</span>
    loss.backward()
    
    <span class="hljs-comment"># æ›´æ–°å‚æ•°ï¼ˆéœ€ç¦ç”¨æ¢¯åº¦è¿½è¸ªï¼Œé¿å…åŠ å…¥è®¡ç®—å›¾ï¼‰</span>
    <span class="hljs-keyword">with</span> torch.no_grad():
        w -= learning_rate * w.grad
        b -= learning_rate * b.grad
        <span class="hljs-comment"># æ¸…ç©ºæ¢¯åº¦ï¼Œé¿å…ç´¯ç§¯</span>
        w.grad.zero_()
        b.grad.zero_()
    
    loss_list.append(loss.item())
    <span class="hljs-keyword">if</span> (epoch + <span class="hljs-number">1</span>) % <span class="hljs-number">10</span> == <span class="hljs-number">0</span>:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"Epoch <span class="hljs-subst">{epoch+<span class="hljs-number">1</span>}</span>, Loss: <span class="hljs-subst">{loss.item():<span class="hljs-number">.4</span>f}</span>, w: <span class="hljs-subst">{w.item():<span class="hljs-number">.4</span>f}</span>, b: <span class="hljs-subst">{b.item():<span class="hljs-number">.4</span>f}</span>"</span>)

<span class="hljs-comment"># 6. å¯è§†åŒ–æŸå¤±å˜åŒ–</span>
plt.plot(loss_list)
plt.xlabel(<span class="hljs-string">"Epoch"</span>)
plt.ylabel(<span class="hljs-string">"MSE Loss"</span>)
plt.title(<span class="hljs-string">"Training Loss Curve"</span>)
plt.show()
</code></pre>
<p>è®­ç»ƒå®Œæˆåï¼Œ<code>w</code>ä¼šè¶‹è¿‘äº3ï¼Œ<code>b</code>è¶‹è¿‘äº2ï¼Œå®Œç¾æ‹Ÿåˆæ¨¡æ‹Ÿæ•°æ®çš„çº¿æ€§å…³ç³»ã€‚æ•´ä¸ªè¿‡ç¨‹ä¸­ï¼Œè®¡ç®—å›¾éšæ¯æ¬¡å‰å‘ä¼ æ’­åŠ¨æ€æ„å»ºï¼Œåå‘ä¼ æ’­åè‡ªåŠ¨é‡Šæ”¾ï¼Œä½“ç°äº†PyTorchåŠ¨æ€å›¾â€œéšç”¨éšå»ºâ€çš„ç‰¹ç‚¹ã€‚</p>
<h2 data-id="heading-5">äºŒã€PyTorchè‡ªå®šä¹‰ç½‘ç»œå±‚ï¼šä»ç®€å•åˆ°å¤æ‚</h2>
<p>PyTorchçš„<code>torch.nn</code>æ¨¡å—æä¾›äº†ä¸°å¯Œçš„å†…ç½®å±‚ï¼ˆå¦‚<code>nn.Linear</code>ã€<code>nn.Conv2d</code>ï¼‰ï¼Œä½†é¢å¯¹å®šåˆ¶åŒ–éœ€æ±‚æ—¶ï¼Œæˆ‘ä»¬éœ€è¦åŸºäº<code>nn.Module</code>æˆ–<code>nn.Function</code>å®ç°è‡ªå®šä¹‰å±‚ã€‚å…¶ä¸­<code>nn.Module</code>æ˜¯PyTorchä¸­æ‰€æœ‰ç½‘ç»œå±‚å’Œæ¨¡å‹çš„åŸºç±»ï¼Œå°è£…äº†å‚æ•°ç®¡ç†ã€è®¾å¤‡è¿ç§»ã€å‰å‘ä¼ æ’­ç­‰æ ¸å¿ƒåŠŸèƒ½ï¼Œæ˜¯è‡ªå®šä¹‰å±‚çš„é¦–é€‰æ–¹å¼ã€‚</p>
<h3 data-id="heading-6">2.1 è‡ªå®šä¹‰ç½‘ç»œå±‚çš„æ ¸å¿ƒï¼šç»§æ‰¿nn.Module</h3>
<p>æ‰€æœ‰è‡ªå®šä¹‰ç½‘ç»œå±‚éƒ½éœ€è¦ç»§æ‰¿<code>nn.Module</code>ï¼Œå¹¶å®ç°**<code>forward()</code>æ–¹æ³•**ï¼ˆå®šä¹‰å‰å‘ä¼ æ’­é€»è¾‘ï¼‰ã€‚<code>nn.Module</code>ä¼šè‡ªåŠ¨å¤„ç†å‚æ•°çš„æ³¨å†Œã€æ¢¯åº¦è®¡ç®—å’Œè®¾å¤‡è¿ç§»ï¼Œæ ¸å¿ƒè¦ç‚¹ï¼š</p>
<ol>
<li>å¯å­¦ä¹ å‚æ•°éœ€ç”¨<code>nn.Parameter</code>å°è£…ï¼ˆä¼šè¢«è‡ªåŠ¨æ³¨å†Œåˆ°æ¨¡å‹çš„<code>parameters()</code>ä¸­ï¼‰ï¼›</li>
<li>éå¯å­¦ä¹ å‚æ•°å¯ç›´æ¥å®šä¹‰ä¸ºå¼ é‡ï¼ˆéœ€è®¾ç½®<code>requires_grad=False</code>ï¼‰ï¼›</li>
<li><code>forward()</code>æ–¹æ³•ä¸­å®ç°å¼ é‡çš„è¿ç®—é€»è¾‘ã€‚</li>
</ol>
<h3 data-id="heading-7">2.2 æ— å‚æ•°è‡ªå®šä¹‰å±‚ï¼šå®šåˆ¶åŒ–æ¿€æ´»å‡½æ•°</h3>
<p>é¦–å…ˆå®ç°ä¸€ä¸ªæ— å‚æ•°çš„è‡ªå®šä¹‰å±‚â€”â€”<strong>å¸¦é˜ˆå€¼çš„ReLUæ¿€æ´»å±‚</strong>ï¼ˆReLU-Thresholdï¼‰ï¼Œå½“è¾“å…¥å€¼å¤§äºé˜ˆå€¼æ—¶è¾“å‡ºåŸå€¼ï¼Œå¦åˆ™è¾“å‡º0ï¼š</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> torch
<span class="hljs-keyword">import</span> torch.nn <span class="hljs-keyword">as</span> nn

<span class="hljs-keyword">class</span> <span class="hljs-title class_">ReLUThreshold</span>(nn.Module):
    <span class="hljs-string">"""è‡ªå®šä¹‰å¸¦é˜ˆå€¼çš„ReLUæ¿€æ´»å±‚"""</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, threshold=<span class="hljs-number">0.5</span></span>):
        <span class="hljs-built_in">super</span>(ReLUThreshold, self).__init__()
        <span class="hljs-comment"># æ— å­¦ä¹ å‚æ•°ï¼Œç›´æ¥å®šä¹‰ä¸ºå®ä¾‹å˜é‡</span>
        self.threshold = threshold
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x</span>):
        <span class="hljs-comment"># å‰å‘ä¼ æ’­é€»è¾‘ï¼šx &gt; threshold åˆ™è¾“å‡ºxï¼Œå¦åˆ™è¾“å‡º0</span>
        <span class="hljs-keyword">return</span> torch.where(x &gt; self.threshold, x, torch.tensor(<span class="hljs-number">0.0</span>, device=x.device))

<span class="hljs-comment"># æµ‹è¯•è‡ªå®šä¹‰æ¿€æ´»å±‚</span>
relu_thresh = ReLUThreshold(threshold=<span class="hljs-number">0.3</span>)
x = torch.tensor([-<span class="hljs-number">0.2</span>, <span class="hljs-number">0.1</span>, <span class="hljs-number">0.4</span>, <span class="hljs-number">1.0</span>])
output = relu_thresh(x)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"è‡ªå®šä¹‰æ¿€æ´»å±‚è¾“å‡ºï¼š<span class="hljs-subst">{output}</span>"</span>)  <span class="hljs-comment"># è¾“å‡ºï¼štensor([0.0000, 0.0000, 0.4000, 1.0000])</span>
</code></pre>
<p>è¯¥å±‚æ— éœ€è¦å­¦ä¹ çš„å‚æ•°ï¼Œä»…éœ€åœ¨<code>__init__</code>ä¸­å®šä¹‰é˜ˆå€¼ï¼Œ<code>forward</code>ä¸­å®ç°æ ¸å¿ƒè¿ç®—å³å¯ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä½¿ç”¨<code>torch.where</code>æ—¶è¦ä¿è¯å¼ é‡çš„è®¾å¤‡ä¸€è‡´æ€§ï¼ˆ<code>device=x.device</code>ï¼‰ï¼Œé¿å…CPU/GPUå¼ é‡æ··åˆè¿ç®—çš„é”™è¯¯ã€‚</p>
<h3 data-id="heading-8">2.3 å¸¦å‚æ•°è‡ªå®šä¹‰å±‚ï¼šè‡ªå®šä¹‰å…¨è¿æ¥å±‚</h3>
<p>æ¥ä¸‹æ¥å®ç°å¸¦å¯å­¦ä¹ å‚æ•°çš„è‡ªå®šä¹‰å±‚â€”â€”<strong>è‡ªå®šä¹‰å…¨è¿æ¥å±‚</strong>ï¼ˆCustomLinearï¼‰ï¼Œæ¨¡æ‹Ÿ<code>nn.Linear</code>çš„åŠŸèƒ½ï¼Œæ‰‹åŠ¨å®ç°æƒé‡å’Œåç½®çš„å‚æ•°æ³¨å†Œä¸å‰å‘è¿ç®—ï¼š</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomLinear</span>(nn.Module):
    <span class="hljs-string">"""è‡ªå®šä¹‰å…¨è¿æ¥å±‚"""</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, in_features, out_features</span>):
        <span class="hljs-built_in">super</span>(CustomLinear, self).__init__()
        <span class="hljs-comment"># æ³¨å†Œå¯å­¦ä¹ å‚æ•°ï¼šæƒé‡å’Œåç½®ï¼ˆnn.Parameterä¼šè‡ªåŠ¨åŠ å…¥å‚æ•°åˆ—è¡¨ï¼‰</span>
        self.weight = nn.Parameter(torch.randn(out_features, in_features))
        self.bias = nn.Parameter(torch.randn(out_features))
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x</span>):
        <span class="hljs-comment"># å‰å‘ä¼ æ’­ï¼šy = x @ W.T + b</span>
        <span class="hljs-keyword">return</span> torch.matmul(x, self.weight.t()) + self.bias

<span class="hljs-comment"># æµ‹è¯•è‡ªå®šä¹‰å…¨è¿æ¥å±‚</span>
custom_linear = CustomLinear(in_features=<span class="hljs-number">5</span>, out_features=<span class="hljs-number">3</span>)
<span class="hljs-comment"># æŸ¥çœ‹å±‚çš„å¯å­¦ä¹ å‚æ•°</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"è‡ªå®šä¹‰å…¨è¿æ¥å±‚å‚æ•°ï¼š"</span>)
<span class="hljs-keyword">for</span> name, param <span class="hljs-keyword">in</span> custom_linear.named_parameters():
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{name}</span>: <span class="hljs-subst">{param.shape}</span>"</span>)

<span class="hljs-comment"># è¾“å…¥æµ‹è¯•ï¼š1ä¸ªæ ·æœ¬ï¼Œ5ä¸ªç‰¹å¾</span>
x = torch.randn(<span class="hljs-number">1</span>, <span class="hljs-number">5</span>)
output = custom_linear(x)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"è‡ªå®šä¹‰å…¨è¿æ¥å±‚è¾“å‡ºå½¢çŠ¶ï¼š<span class="hljs-subst">{output.shape}</span>"</span>)  <span class="hljs-comment"># è¾“å‡ºï¼štorch.Size([1, 3])</span>
</code></pre>
<p>è¿™é‡Œ<code>nn.Parameter</code>æ˜¯å…³é”®ï¼Œå®ƒç»§æ‰¿è‡ª<code>torch.Tensor</code>ï¼Œä½†ä¼šè¢«<code>nn.Module</code>è‡ªåŠ¨è¯†åˆ«ä¸ºå¯å­¦ä¹ å‚æ•°ï¼Œåœ¨è®­ç»ƒæ—¶å‚ä¸æ¢¯åº¦æ›´æ–°ã€‚å¦‚æœç›´æ¥ä½¿ç”¨<code>torch.tensor</code>å®šä¹‰æƒé‡ï¼Œå‚æ•°ä¸ä¼šè¢«æ³¨å†Œï¼Œåå‘ä¼ æ’­æ—¶æ— æ³•è®¡ç®—æ¢¯åº¦ã€‚</p>
<h3 data-id="heading-9">2.4 è¿›é˜¶ï¼šè‡ªå®šä¹‰å·ç§¯å±‚ï¼ˆæ·±åº¦å¯åˆ†ç¦»å·ç§¯ï¼‰</h3>
<p>åœ¨è®¡ç®—æœºè§†è§‰ä»»åŠ¡ä¸­ï¼Œæ·±åº¦å¯åˆ†ç¦»å·ç§¯ï¼ˆDepthwise Separable Convolutionï¼‰æ˜¯è½»é‡åŒ–æ¨¡å‹çš„å¸¸ç”¨æ“ä½œï¼ŒPyTorchè™½æœ‰<code>nn.Conv2d</code>ï¼Œä½†æˆ‘ä»¬å¯ä»¥è‡ªå®šä¹‰å®ç°è¯¥å±‚ï¼Œç†è§£å…¶æ ¸å¿ƒåŸç†ï¼š</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">DepthwiseSeparableConv</span>(nn.Module):
    <span class="hljs-string">"""è‡ªå®šä¹‰æ·±åº¦å¯åˆ†ç¦»å·ç§¯å±‚"""</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, in_channels, out_channels, kernel_size=<span class="hljs-number">3</span>, stride=<span class="hljs-number">1</span>, padding=<span class="hljs-number">1</span></span>):
        <span class="hljs-built_in">super</span>(DepthwiseSeparableConv, self).__init__()
        <span class="hljs-comment"># æ·±åº¦å·ç§¯ï¼šé€é€šé“å·ç§¯ï¼Œä¸æ”¹å˜é€šé“æ•°</span>
        self.depthwise = nn.Conv2d(
            in_channels=in_channels,
            out_channels=in_channels,
            kernel_size=kernel_size,
            stride=stride,
            padding=padding,
            groups=in_channels  <span class="hljs-comment"># groupsç­‰äºé€šé“æ•°å®ç°é€é€šé“å·ç§¯</span>
        )
        <span class="hljs-comment"># ç‚¹å·ç§¯ï¼š1x1å·ç§¯ï¼Œè°ƒæ•´é€šé“æ•°</span>
        self.pointwise = nn.Conv2d(
            in_channels=in_channels,
            out_channels=out_channels,
            kernel_size=<span class="hljs-number">1</span>,
            stride=<span class="hljs-number">1</span>,
            padding=<span class="hljs-number">0</span>
        )
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x</span>):
        <span class="hljs-comment"># å‰å‘ä¼ æ’­ï¼šæ·±åº¦å·ç§¯ -&gt; ç‚¹å·ç§¯</span>
        x = self.depthwise(x)
        x = self.pointwise(x)
        <span class="hljs-keyword">return</span> x

<span class="hljs-comment"># æµ‹è¯•æ·±åº¦å¯åˆ†ç¦»å·ç§¯å±‚</span>
ds_conv = DepthwiseSeparableConv(in_channels=<span class="hljs-number">3</span>, out_channels=<span class="hljs-number">16</span>)
<span class="hljs-comment"># è¾“å…¥ï¼š1ä¸ªæ ·æœ¬ï¼Œ3é€šé“ï¼Œ224x224çš„å›¾åƒ</span>
x = torch.randn(<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">224</span>, <span class="hljs-number">224</span>)
output = ds_conv(x)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"æ·±åº¦å¯åˆ†ç¦»å·ç§¯è¾“å‡ºå½¢çŠ¶ï¼š<span class="hljs-subst">{output.shape}</span>"</span>)  <span class="hljs-comment"># è¾“å‡ºï¼štorch.Size([1, 16, 224, 224])</span>
</code></pre>
<p>è¯¥å±‚é€šè¿‡ç»„åˆå†…ç½®çš„<code>nn.Conv2d</code>å®ç°è‡ªå®šä¹‰åŠŸèƒ½ï¼Œä½“ç°äº†PyTorchæ¨¡å—åŒ–ç¼–ç¨‹çš„çµæ´»æ€§ã€‚æ·±åº¦å¯åˆ†ç¦»å·ç§¯å°†æ ‡å‡†å·ç§¯æ‹†åˆ†ä¸ºæ·±åº¦å·ç§¯å’Œç‚¹å·ç§¯ï¼Œå¤§å¹…å‡å°‘äº†å‚æ•°é‡å’Œè®¡ç®—é‡ï¼Œæ˜¯MobileNetç­‰è½»é‡æ¨¡å‹çš„æ ¸å¿ƒç»„ä»¶ã€‚</p>
<h3 data-id="heading-10">2.5 åº•å±‚è‡ªå®šä¹‰ï¼šåŸºäºnn.Functionå®ç°è¿ç®—</h3>
<p>å¦‚æœéœ€è¦æ›´ç²¾ç»†åœ°æ§åˆ¶æ¢¯åº¦çš„è®¡ç®—è¿‡ç¨‹ï¼ˆæ¯”å¦‚æ‰‹åŠ¨å®ç°åå‘ä¼ æ’­ï¼‰ï¼Œå¯ä»¥åŸºäº<code>nn.Function</code>å®ç°è‡ªå®šä¹‰è¿ç®—ã€‚<code>nn.Function</code>æ˜¯PyTorchä¸­æ›´åº•å±‚çš„æ¥å£ï¼Œéœ€åŒæ—¶å®ç°<code>forward()</code>å’Œ<code>backward()</code>æ–¹æ³•ï¼Œé€‚åˆå¯¹æ±‚å¯¼é€»è¾‘æœ‰ç‰¹æ®Šå®šåˆ¶çš„åœºæ™¯ã€‚</p>
<p>ä»¥ä¸‹å®ç°ä¸€ä¸ªç®€å•çš„å¹³æ–¹è¿ç®—å±‚ï¼Œæ‰‹åŠ¨å®šä¹‰å‰å‘å’Œåå‘ä¼ æ’­ï¼š</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">SquareFunction</span>(torch.autograd.Function):
    <span class="hljs-string">"""åŸºäºnn.Functionçš„è‡ªå®šä¹‰å¹³æ–¹è¿ç®—"""</span>
<span class="hljs-meta">    @staticmethod</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">ctx, x</span>):
        <span class="hljs-comment"># å‰å‘ä¼ æ’­ï¼šä¿å­˜è¾“å…¥å¼ é‡åˆ°ctxï¼Œä¾›åå‘ä¼ æ’­ä½¿ç”¨</span>
        ctx.save_for_backward(x)
        <span class="hljs-keyword">return</span> x ** <span class="hljs-number">2</span>
    
<span class="hljs-meta">    @staticmethod</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">backward</span>(<span class="hljs-params">ctx, grad_output</span>):
        <span class="hljs-comment"># åå‘ä¼ æ’­ï¼šè®¡ç®—æ¢¯åº¦ï¼Œgrad_outputæ˜¯ä¸Šæ¸¸æ¢¯åº¦</span>
        x, = ctx.saved_tensors
        grad_x = <span class="hljs-number">2</span> * x * grad_output  <span class="hljs-comment"># å¹³æ–¹çš„å¯¼æ•°æ˜¯2xï¼Œä¹˜ä»¥ä¸Šæ¸¸æ¢¯åº¦</span>
        <span class="hljs-keyword">return</span> grad_x

<span class="hljs-comment"># å°è£…ä¸ºnn.Moduleå±‚ï¼ˆæ–¹ä¾¿ä¸å…¶ä»–å±‚ç»„åˆï¼‰</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">SquareLayer</span>(nn.Module):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x</span>):
        <span class="hljs-keyword">return</span> SquareFunction.apply(x)

<span class="hljs-comment"># æµ‹è¯•è‡ªå®šä¹‰è¿ç®—çš„æ¢¯åº¦è®¡ç®—</span>
square_layer = SquareLayer()
x = torch.tensor([<span class="hljs-number">3.0</span>], requires_grad=<span class="hljs-literal">True</span>)
y = square_layer(x)
y.backward()
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"å¹³æ–¹è¿ç®—è¾“å‡ºï¼š<span class="hljs-subst">{y.item()}</span>"</span>)  <span class="hljs-comment"># è¾“å‡ºï¼š9.0</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"å¹³æ–¹è¿ç®—æ¢¯åº¦ï¼š<span class="hljs-subst">{x.grad.item()}</span>"</span>)  <span class="hljs-comment"># è¾“å‡ºï¼š6.0ï¼ˆ2*3ï¼‰</span>
</code></pre>
<p><code>nn.Function</code>çš„<code>forward</code>æ–¹æ³•é€šè¿‡<code>ctx.save_for_backward()</code>ä¿å­˜å¼ é‡ï¼Œ<code>backward</code>æ–¹æ³•æ¥æ”¶ä¸Šæ¸¸æ¢¯åº¦å¹¶è®¡ç®—å½“å‰å±‚çš„æ¢¯åº¦ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ<code>nn.Function</code>çš„æ–¹æ³•å¿…é¡»æ˜¯é™æ€çš„ï¼Œä¸”é€šè¿‡<code>apply()</code>æ–¹æ³•è°ƒç”¨ã€‚</p>
<h3 data-id="heading-11">2.6 å®æˆ˜ï¼šç»„åˆè‡ªå®šä¹‰å±‚æ„å»ºå®Œæ•´æ¨¡å‹</h3>
<p>æœ€åï¼Œæˆ‘ä»¬å°†å‰é¢å®ç°çš„è‡ªå®šä¹‰å±‚ç»„åˆèµ·æ¥ï¼Œæ„å»ºä¸€ä¸ªç®€å•çš„å›¾åƒåˆ†ç±»æ¨¡å‹ï¼Œå±•ç¤ºè‡ªå®šä¹‰å±‚åœ¨å®é™…æ¨¡å‹ä¸­çš„åº”ç”¨ï¼š</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomModel</span>(nn.Module):
    <span class="hljs-string">"""ç»„åˆè‡ªå®šä¹‰å±‚çš„å›¾åƒåˆ†ç±»æ¨¡å‹"""</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, num_classes=<span class="hljs-number">10</span></span>):
        <span class="hljs-built_in">super</span>(CustomModel, self).__init__()
        <span class="hljs-comment"># è‡ªå®šä¹‰æ·±åº¦å¯åˆ†ç¦»å·ç§¯å±‚</span>
        self.ds_conv1 = DepthwiseSeparableConv(in_channels=<span class="hljs-number">3</span>, out_channels=<span class="hljs-number">32</span>)
        self.ds_conv2 = DepthwiseSeparableConv(in_channels=<span class="hljs-number">32</span>, out_channels=<span class="hljs-number">64</span>)
        <span class="hljs-comment"># è‡ªå®šä¹‰æ¿€æ´»å±‚</span>
        self.relu_thresh = ReLUThreshold(threshold=<span class="hljs-number">0.1</span>)
        <span class="hljs-comment"># æ± åŒ–å±‚</span>
        self.pool = nn.MaxPool2d(kernel_size=<span class="hljs-number">2</span>, stride=<span class="hljs-number">2</span>)
        <span class="hljs-comment"># è‡ªå®šä¹‰å…¨è¿æ¥å±‚</span>
        self.fc1 = CustomLinear(in_features=<span class="hljs-number">64</span>*<span class="hljs-number">56</span>*<span class="hljs-number">56</span>, out_features=<span class="hljs-number">128</span>)
        self.fc2 = CustomLinear(in_features=<span class="hljs-number">128</span>, out_features=num_classes)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x</span>):
        <span class="hljs-comment"># å·ç§¯å±‚ + æ¿€æ´» + æ± åŒ–</span>
        x = self.pool(self.relu_thresh(self.ds_conv1(x)))
        x = self.pool(self.relu_thresh(self.ds_conv2(x)))
        <span class="hljs-comment"># å±•å¹³</span>
        x = x.view(x.size(<span class="hljs-number">0</span>), -<span class="hljs-number">1</span>)
        <span class="hljs-comment"># å…¨è¿æ¥å±‚</span>
        x = self.relu_thresh(self.fc1(x))
        x = self.fc2(x)
        <span class="hljs-keyword">return</span> x

<span class="hljs-comment"># æµ‹è¯•è‡ªå®šä¹‰æ¨¡å‹</span>
model = CustomModel(num_classes=<span class="hljs-number">10</span>)
<span class="hljs-comment"># è¾“å…¥ï¼š2ä¸ªæ ·æœ¬ï¼Œ3é€šé“ï¼Œ224x224çš„å›¾åƒ</span>
x = torch.randn(<span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">224</span>, <span class="hljs-number">224</span>)
output = model(x)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"è‡ªå®šä¹‰æ¨¡å‹è¾“å‡ºå½¢çŠ¶ï¼š<span class="hljs-subst">{output.shape}</span>"</span>)  <span class="hljs-comment"># è¾“å‡ºï¼štorch.Size([2, 10])</span>

<span class="hljs-comment"># æŸ¥çœ‹æ¨¡å‹çš„æ‰€æœ‰å‚æ•°</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"\næ¨¡å‹å‚æ•°åˆ—è¡¨ï¼š"</span>)
<span class="hljs-keyword">for</span> name, param <span class="hljs-keyword">in</span> model.named_parameters():
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{name}</span>: <span class="hljs-subst">{param.shape}</span>"</span>)
</code></pre>
<p>è¯¥æ¨¡å‹ç»„åˆäº†æ·±åº¦å¯åˆ†ç¦»å·ç§¯ã€è‡ªå®šä¹‰æ¿€æ´»å±‚å’Œå…¨è¿æ¥å±‚ï¼Œå®Œå…¨åŸºäºPyTorchçš„æ¨¡å—åŒ–æœºåˆ¶æ„å»ºï¼Œå¯åƒå†…ç½®æ¨¡å‹ä¸€æ ·è¿›è¡Œè®­ç»ƒã€ä¿å­˜å’ŒåŠ è½½ã€‚</p>
<h2 data-id="heading-12">ä¸‰ã€è‡ªå®šä¹‰å±‚çš„å¸¸è§é—®é¢˜ä¸ä¼˜åŒ–æŠ€å·§</h2>
<h3 data-id="heading-13">3.1 å‚æ•°æ³¨å†Œçš„æ³¨æ„äº‹é¡¹</h3>
<ul>
<li>å¿…é¡»ä½¿ç”¨<code>nn.Parameter</code>å°è£…å¯å­¦ä¹ å‚æ•°ï¼Œå¦åˆ™å‚æ•°ä¸ä¼šè¢«åŠ å…¥<code>model.parameters()</code>ï¼Œè®­ç»ƒæ—¶æ— æ³•æ›´æ–°ï¼›</li>
<li>è‹¥éœ€å®šä¹‰å¤šä¸ªå‚æ•°ï¼Œå¯ä½¿ç”¨<code>nn.ParameterList</code>æˆ–<code>nn.ParameterDict</code>æ‰¹é‡æ³¨å†Œï¼Œä¾‹å¦‚ï¼š
<pre><code class="hljs language-python" lang="python">self.params = nn.ParameterList([nn.Parameter(torch.randn(<span class="hljs-number">3</span>, <span class="hljs-number">3</span>)) <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">2</span>)])
</code></pre>
</li>
</ul>
<h3 data-id="heading-14">3.2 è®¾å¤‡è¿ç§»çš„æ­£ç¡®æ€§</h3>
<p>è‡ªå®šä¹‰å±‚ä¸­çš„å¼ é‡ï¼ˆå¦‚éå‚æ•°çš„å¸¸é‡ï¼‰éœ€ä¸è¾“å…¥å¼ é‡çš„è®¾å¤‡ä¿æŒä¸€è‡´ï¼Œå¯é€šè¿‡<code>x.device</code>è·å–è¾“å…¥è®¾å¤‡ï¼Œé¿å…â€œCPUå¼ é‡ä¸CUDAå¼ é‡æ··åˆè¿ç®—â€çš„é”™è¯¯ã€‚ä¹Ÿå¯åœ¨æ¨¡å‹åˆå§‹åŒ–æ—¶æŒ‡å®šè®¾å¤‡ï¼Œæˆ–ä½¿ç”¨<code>model.to(device)</code>è‡ªåŠ¨è¿ç§»å‚æ•°ï¼ˆ<code>nn.Parameter</code>ä¼šè¢«è‡ªåŠ¨è¿ç§»ï¼‰ã€‚</p>
<h3 data-id="heading-15">3.3 æå‡è‡ªå®šä¹‰å±‚çš„æ‰§è¡Œæ•ˆç‡</h3>
<ul>
<li>å°½é‡ä½¿ç”¨PyTorchçš„å†…ç½®å¼ é‡è¿ç®—ï¼ˆå¦‚<code>torch.matmul</code>ã€<code>torch.conv2d</code>ï¼‰ï¼Œé¿å…PythonåŸç”Ÿå¾ªç¯ï¼ˆæ•ˆç‡æä½ï¼‰ï¼›</li>
<li>å¯¹äºé‡å¤çš„è¿ç®—é€»è¾‘ï¼Œå¯å°è£…ä¸º<code>nn.functional</code>ä¸­çš„å‡½æ•°ï¼ˆå¦‚<code>F.relu</code>ã€<code>F.max_pool2d</code>ï¼‰ï¼Œå‡å°‘ä»£ç å†—ä½™ï¼›</li>
<li>è‹¥è‡ªå®šä¹‰å±‚éœ€åœ¨GPUä¸ŠåŠ é€Ÿï¼Œç¡®ä¿æ‰€æœ‰è¿ç®—éƒ½ä½¿ç”¨CUDAå¼ é‡ï¼Œå¯é€šè¿‡<code>torch.cuda.is_available()</code>åˆ¤æ–­è®¾å¤‡å¹¶è‡ªåŠ¨åˆ‡æ¢ã€‚</li>
</ul>
<h3 data-id="heading-16">3.4 æ¢¯åº¦éªŒè¯</h3>
<p>è‡ªå®šä¹‰å±‚ï¼ˆå°¤å…¶æ˜¯åŸºäº<code>nn.Function</code>çš„å±‚ï¼‰éœ€éªŒè¯æ¢¯åº¦è®¡ç®—çš„æ­£ç¡®æ€§ï¼Œå¯ä½¿ç”¨<code>torch.autograd.gradcheck</code>å·¥å…·è¿›è¡Œæ¢¯åº¦æ£€æŸ¥ï¼š</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># æ¢¯åº¦æ£€æŸ¥ï¼šéªŒè¯SquareFunctionçš„æ¢¯åº¦æ˜¯å¦æ­£ç¡®</span>
x = torch.tensor([<span class="hljs-number">3.0</span>], dtype=torch.double, requires_grad=<span class="hljs-literal">True</span>)
test = torch.autograd.gradcheck(SquareFunction.apply, x, eps=<span class="hljs-number">1e-6</span>, atol=<span class="hljs-number">1e-4</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"æ¢¯åº¦æ£€æŸ¥ç»“æœï¼š<span class="hljs-subst">{test}</span>"</span>)  <span class="hljs-comment"># è¾“å‡ºTrueè¡¨ç¤ºæ¢¯åº¦æ­£ç¡®</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Javaæ–¹æ³•ï¼ˆå‡½æ•°ï¼‰å®Œå…¨æŒ‡å—ï¼šåˆå­¦è€…çš„ç¬¬ä¸€ä¸ª"å·¥å…·ç®±"]]></title>    <link>https://juejin.cn/post/7585412203978637355</link>    <guid>https://juejin.cn/post/7585412203978637355</guid>    <pubDate>2025-12-20T07:21:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585412203978637355" data-draft-id="7585382553290784804" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Javaæ–¹æ³•ï¼ˆå‡½æ•°ï¼‰å®Œå…¨æŒ‡å—ï¼šåˆå­¦è€…çš„ç¬¬ä¸€ä¸ª&quot;å·¥å…·ç®±&quot;"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2025-12-20T07:21:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="åƒè¥¿çº¢æŸ¿é•¿å¤§çš„ç•ªèŒ„"/> <meta itemprop="url" content="https://juejin.cn/user/3097787706900985"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="æ˜é‡‘"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Javaæ–¹æ³•ï¼ˆå‡½æ•°ï¼‰å®Œå…¨æŒ‡å—ï¼šåˆå­¦è€…çš„ç¬¬ä¸€ä¸ª"å·¥å…·ç®±"
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3097787706900985/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    åƒè¥¿çº¢æŸ¿é•¿å¤§çš„ç•ªèŒ„
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T07:21:23.000Z" title="Sat Dec 20 2025 07:21:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    é˜…è¯»11åˆ†é’Ÿ
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252b3a}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px;color:#5e7ce0}.markdown-body h1{font-size:24px;margin-bottom:5px;margin-top:80px;position:relative;text-align:center}.markdown-body h2{font-size:20px;padding-bottom:12px;border-bottom:1px solid #dfe1e6}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px;margin-top:30px}.markdown-body h5{font-size:14px;margin-top:20px}.markdown-body h6{font-size:14px;margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #dfe1e6;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#ffeeed;color:#c73636;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#252b3a;background:#f8f8f8}.markdown-body a{position:relative;text-decoration:none;color:#5e7ce0;padding-right:18px;padding-bottom:4px}.markdown-body a[href^=http]:after{position:absolute;display:inline-block;width:16px;height:16px;margin-left:2px;margin-top:6px;content:"";background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAIRlWElmTU0AKgAAAAgABQESAAMAAAABAAEAAAEaAAUAAAABAAAASgEbAAUAAAABAAAAUgEoAAMAAAABAAIAAIdpAAQAAAABAAAAWgAAAAAAAABIAAAAAQAAAEgAAAABAAOgAQADAAAAAQABAACgAgAEAAAAAQAAACCgAwAEAAAAAQAAACAAAAAAX7wP8AAAAAlwSFlzAAALEwAACxMBAJqcGAAAAVlpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IlhNUCBDb3JlIDYuMC4wIj4KICAgPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4KICAgICAgPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIKICAgICAgICAgICAgeG1sbnM6dGlmZj0iaHR0cDovL25zLmFkb2JlLmNvbS90aWZmLzEuMC8iPgogICAgICAgICA8dGlmZjpPcmllbnRhdGlvbj4xPC90aWZmOk9yaWVudGF0aW9uPgogICAgICA8L3JkZjpEZXNjcmlwdGlvbj4KICAgPC9yZGY6UkRGPgo8L3g6eG1wbWV0YT4KGV7hBwAABWVJREFUWAnlVktsVFUY/s85997pC9BOTKxRWnEKsXWlxjWJj0RWJjrFAAXjAlewYWOkgauACVu7a2IiNUEyExM3yoZE3Wmi7qgPJthJBDE6JUNpO3Mf5/j95/bOTOcBlBgXejJ37rn/Of/7O/9/iP7vQ/zTAcjnC4ry+a5ii1OkiYTpuvjvEc0Gp51uivP+ZW+QBuSW4QjW5rptAa1Ey0uOGKOxwPetVyafN6p/52/PkNBbjdAhGaGEpMRjLZTryB8+9MUSYSGNRIcBvm8kBAY9tHYlHz78nTs392xIkwv9FA3Oe33bdoX1ZZKOS0bH0CXI6RugYLW6BwIu5gskkQ4sEG0wYF25PjBzbZfSYY6kDLUmWMt7FR7Lw3xYUkaTdjxHfTPnPwav0iEGYADVa9XIRIEyxrAA0jIQxgFL22gYwF7A8/DAzNVdksJvJaTEUZ2kYnZWziN5s1ADPHneEIXByotYuMSrf9JEbbsuv7VcvbaKML8plXtQR0EdIYDqWEmtOgAomZFH8EjWSnek2ulmtljljttHbmaIHCCCHzd9MjwfsmscBeZH9Jyd10nMvz92UQrtCBKvMF06mQy0SiEdRMEGg8mN0YjAlgoDDkPrMI5qJKSkKKydpbB2CZjJkhIBvOBw2CGQgii85bpx//dMqFRKam5uvH7w+K97oe+Cl0HO68uIBH0qyEzpOMwIbZIcFq0I+9cwoElizCjk2KFI1y7Nnx614W1db58fOXIlMzs7Xn/jeDmvBV2Q0mXjGf554O/m4LZHp2N8r61WPMvLZWLdiC4GMAk5BjeeB5lhv39l6+BIbu3m760hXMDKBD08XBKzR8fr04nygnIypOOAJUx/fHrsi0Mnys+vVK+V4VUohaiyPCo2Q9DFALvF/ikw8WS4QvVZALS5ksw47/7R8ejgTPk1UFqU6/3zp8bOM7B/kdu/fkguPGU5JibW+F0sTjWOUw8DklRrg4BiLGeBqbaRLxjlT4no0InFV402RcftJz41cH/f/JnHP3kZaaF6VX/liwist9vYG5+NU9Cg3MNkt/+lU5wS8fTxq3mc7ILjDlAE4CJpe89BOWPiIjBhi9O6PI4G1jsc6RGB3lZwmS76k8H0zOKTkFboG8jS2krFKCX2fvTeaPHIBwAkMHHgncURnL3nuCSnxSopdIzN5th0BIonJ0Lf9yUA9iMkzdRWl3BixOusfDcwQVcS4UKIFwYfGPnM8wY/DyP9NFMXaTE5BU39tGkDgGZz+fJJG0oYcSaOafLcqdECY4LzfSObSzyUOgxqtyisr8SSNOOAkubWoh3TTaeA2YtFEXPnm5x81/j+6MI6JqyS25WSNU6hbCMKHG84marJbdR+vwakRhQLRuQpbzHRLjmpmijI+OmWCtq+LzWtnX5v30gHSsqmWne74DtiACi2+Wz0iXbuLt9D2cDyoPEkWOiyp5XUIwLMi/wJY1FbH5B9ONtdC1KrsD/Q0MCQAS0wccILORDW25amAeOtooAj/KQxfzF17uwTSQ1v3dJ7jnLINwdZYRDa4tPU0sHVXFo/vxFF5BqFqxRfOmgPCk4ft2NgKTCy2Y47JIEg+MIhjYsLy5I25qUYTQlCjMRHsr/UwdYwIK33UO1J5fFNB9XNO6akcywJofVmXQDP2wfrSPcI2xG5BSs3I+IosHr4EtvO1TDAu16xHQq5+ykMblfRXLbhEoFIdDTBdhldvzl+3CMg60ZktI2vNzLW6IIp0waLklot9L63yzuUp8dJd7bglPFe3hIXstBEP58/s6Ocyr4rH2+866ZNbriTzA0RSOWCwakMl1QJgculxPt8Z7O5GLdtW6bvU8R/nO1vb+hMExVAVtEAAAAASUVORK5CYII=");background-size:100%}.markdown-body a:active,.markdown-body a:hover{border-bottom:2px solid #5e7ce0}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #5e7ce0;border-spacing:0}.markdown-body thead{color:#fff;text-align:left}.markdown-body thead tr{background:#5e7ce0}.markdown-body thead th{border-bottom:1px solid #dfe1e6}.markdown-body tr{background-color:#fff}.markdown-body tr:nth-child(2n){background-color:#f2f5fc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#252b3a;padding:1px 23px;margin:22px 0;border-left:4px solid #5e7ce0;background-color:#f2f5fc}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{padding-left:10px;margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#5e7ce0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body ul li::marker{content:"â€¢";color:#5e7ce0}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}.markdown-body input[type=checkbox]:before{display:inline-block;width:16px;height:16px;content:"";background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEIAAABCCAYAAADjVADoAAAK2GlDQ1BJQ0MgUHJvZmlsZQAASImVlwdUU9kWhs+96Y0WiHRC70gngJTQQxGkg6iEJJBQYkgIKmJnUMGxoCKCZcSKKFhGQMaCWLANAopdJ8igoD4HC6Ki5t3AI8zMW++99fZaJ+dbO/vss/e55671XwAoYWyRKBdWAyBPWCCODQ2gJ6ek0nHPAQRgQAI2wIHNkYiYMTGRALHJ+a/28S4Sjdhte0Wuf///v5oGlyfhAAClIZzBlXDyEG5DxkuOSFwAAOoI4jddUCBScBfCmmKkQIR/V3DWBH9ScMY4o8njMfGxgQjTAcCT2WxxFgBkO8RPL+RkIXnIih4chVyBEOFihH05fDYX4TMI2+XlzVfwIMJWSLwIAApyOoCR8aecWX/Jn6HMz2ZnKXmir3HDBwkkolz2ov/zaP635eVKJ/ewQAaZLw6LVeyHnN/9nPkRShZmzIyeZAF3oiYF86VhCZPMkQSmTjKXHRShXJs7M3KSMwUhLGWeAlb8JPMkwXGTLJ4fq9wrUxzInGS2eHxfIsIyaU6C0s/nsZT5i/jxSZNcKEicOcmSnLiIqZhApV8sjVXWzxOGBkztG6LsPU/yp34FLOXaAn58mLJ39lT9PCFzKqckWVkblxcUPBWToIwXFQQo9xLlxijjebmhSr+kME65tgC5nFNrY5RnmM0Oj5lkIABRgA04dNVJAqCAt7BA0UjgfNEisSCLX0BnIm8bj84Schzs6M6Ozs4AKN7dievwnjb+TkK061O+NYjHr10ul5+e8oUi9/i4KfJYbk35LCsAUNUD4Op+jlRcOOFDK34wyNNTBZpABxgCU2AF7IEzcAfewB8Eg3AQDeJBCpiL1MoHeUAMFoBisAKUgnKwEWwF1WA32AsOgaPgBGgGZ8AFcAXcAF2gFzwCMjAAXoFh8BGMQRCEgygQFdKBjCBzyBZyhhiQLxQMRUKxUAqUDmVBQkgKFUOroHKoAqqG9kB10HHoNHQBugZ1Qw+gPmgIegd9gVEwGdaEDWALeDrMgJlwBBwPz4Gz4Hy4CC6B18NVcC18BG6CL8A34F5YBr+CR1AARULRUMYoexQDFYiKRqWiMlFi1FJUGaoSVYtqQLWiOlC3UTLUa9RnNBZNRdPR9mhvdBg6Ac1B56OXotehq9GH0E3oS+jb6D70MPo7hoLRx9hivDAsTDImC7MAU4qpxBzAnMJcxvRiBjAfsVgsDWuJ9cCGYVOw2djF2HXYndhGbBu2G9uPHcHhcDo4W5wPLhrHxhXgSnHbcUdw53E9uAHcJzwJb4R3xofgU/FC/Ep8Jf4w/hy+B/8CP0ZQI5gTvAjRBC5hEWEDYR+hlXCLMEAYI6oTLYk+xHhiNnEFsYrYQLxMfEx8TyKRTEiepFkkAWk5qYp0jHSV1Ef6TNYg25ADyWlkKXk9+SC5jfyA/J5CoVhQ/CmplALKekod5SLlKeWTClXFQYWlwlVZplKj0qTSo/JGlaBqrspUnatapFqpelL1luprNYKahVqgGlttqVqN2mm1e2oj6lR1J/Vo9Tz1deqH1a+pD2rgNCw0gjW4GiUaezUuavRTUVRTaiCVQ11F3Ue9TB3QxGpaarI0szXLNY9qdmoOa2louWolai3UqtE6qyWjoWgWNBYtl7aBdoJ2l/ZlmsE05jTetLXTGqb1TBvV1tP21+Zpl2k3avdqf9Gh6wTr5Ohs0mnWeaKL1rXRnaW7QHeX7mXd13qaet56HL0yvRN6D/VhfRv9WP3F+nv1b+qPGBgahBqIDLYbXDR4bUgz9DfMNtxieM5wyIhq5GskMNpidN7oJV2LzqTn0qvol+jDxvrGYcZS4z3GncZjJpYmCSYrTRpNnpgSTRmmmaZbTNtNh82MzKLMis3qzR6aE8wZ5nzzbeYd5qMWlhZJFqstmi0GLbUtWZZFlvWWj60oVn5W+Va1VnessdYM6xzrndZdNrCNmw3fpsbmli1s624rsN1p222HsfO0E9rV2t2zJ9sz7Qvt6+37HGgOkQ4rHZod3kw3m546fdP0junfHd0ccx33OT5y0nAKd1rp1Or0ztnGmeNc43zHheIS4rLMpcXlrautK891l+t9N6pblNtqt3a3b+4e7mL3BvchDzOPdI8dHvcYmowYxjrGVU+MZ4DnMs8znp+93L0KvE54/eFt753jfdh7cIblDN6MfTP6fUx82D57fGS+dN903598ZX7Gfmy/Wr9n/qb+XP8D/i+Y1sxs5hHmmwDHAHHAqYDRQK/AJYFtQaig0KCyoM5gjeCE4OrgpyEmIVkh9SHDoW6hi0PbwjBhEWGbwu6xDFgcVh1rONwjfEn4pQhyRFxEdcSzSJtIcWRrFBwVHrU56vFM85nCmc3RIJoVvTn6SYxlTH7ML7Ows2Jm1cx6HusUWxzbEUeNmxd3OO5jfED8hvhHCVYJ0oT2RNXEtMS6xNGkoKSKJFny9OQlyTdSdFMEKS2puNTE1AOpI7ODZ2+dPZDmllaadneO5ZyFc67N1Z2bO/fsPNV57Hkn0zHpSemH07+yo9m17JEMVsaOjGFOIGcb5xXXn7uFO8Tz4VXwXmT6ZFZkDmb5ZG3OGuL78Sv5rwWBgmrB2+yw7N3ZoznROQdz5LlJuY15+Lz0vNNCDWGO8NJ8w/kL53eLbEWlIlm+V/7W/GFxhPiABJLMkbQUaCIi6abUSvqDtK/Qt7Cm8NOCxAUnF6ovFC68uchm0dpFL4pCivYvRi/mLG4vNi5eUdy3hLlkz1JoacbS9mWmy0qWDSwPXX5oBXFFzopfVzqurFj5YVXSqtYSg5LlJf0/hP5QX6pSKi69t9p79e416DWCNZ1rXdZuX/u9jFt2vdyxvLL86zrOuus/Ov1Y9aN8feb6zg3uG3ZtxG4Ubry7yW/ToQr1iqKK/s1Rm5u20LeUbfmwdd7Wa5Wulbu3EbdJt8mqIqtatptt37j9azW/urcmoKZxh/6OtTtGd3J39uzy39Ww22B3+e4vPwl+ur8ndE9TrUVt5V7s3sK9z/cl7uvYz9hfd0D3QPmBbweFB2WHYg9dqvOoqzusf3hDPVwvrR86knak62jQ0ZYG+4Y9jbTG8mPgmPTYy+Ppx++eiDjRfpJxsuFn8593nKKeKmuCmhY1DTfzm2UtKS3dp8NPt7d6t576xeGXg2eMz9Sc1Tq74RzxXMk5+fmi8yNtorbXF7Iu9LfPa390MfninUuzLnVejrh89UrIlYsdzI7zV32unrnmde30dcb15hvuN5puut089avbr6c63Tubbnncauny7GrtntF9rsev58LtoNtX7rDu3Oid2dt9N+Hu/Xtp92T3ufcHH+Q+ePuw8OHYo+WPMY/Lnqg9qXyq/7T2N+vfGmXusrN9QX03n8U9e9TP6X/1u+T3rwMlzynPK18YvagbdB48MxQy1PVy9suBV6JXY69L/6H+jx1vrN78/If/HzeHk4cH3orfyt+te6/z/uAH1w/tIzEjTz/mfRwbLfuk8+nQZ8bnji9JX16MLfiK+1r1zfpb6/eI74/leXK5iC1mj0sBFDLgzEwA3h1EtHEKAFRElxNnT2jrcYMmvgfGCfwnntDf4+YOQAMyKWQR0x+Akwo5i8wqyKyQRPH+AHZxUY5/mSTTxXkiFxlRlphPcvl7AwBwrQB8E8vlYzvl8m/7kGIfANCWP6HpFYZFtHyD3vJRg6LbPe3g7zah9//U499noKjAFfx9/ieoZhkWVvYkwwAAAGxlWElmTU0AKgAAAAgABAEaAAUAAAABAAAAPgEbAAUAAAABAAAARgEoAAMAAAABAAIAAIdpAAQAAAABAAAATgAAAAAAAACQAAAAAQAAAJAAAAABAAKgAgAEAAAAAQAAAEKgAwAEAAAAAQAAAEIAAAAAgodoEQAAAAlwSFlzAAAWJQAAFiUBSVIk8AAAAhRJREFUeAHtnLEuBFEUhs9cu7JCskEhIrZAgYZGoREPwBuIygOoPITKA6jEG/AAolFoaFCgICIKZBNiY8Pyz5rNOWe9wNz5T7N3Z2eT/b/7zZlpziat3xKWBDJoEyh5EDd3DTk5r8vV7Yc8vzbl6zvfwvSERIYHyzI90SeLc1WZrFV85PR9oi+N/YMnOT6t/3tiLAeXFqqytjrSFacDYmfvQS6u37tOiPHA7FS/bK6PmWhpj4AJRYGA9MiKzLpK6An+cqiNVmRleUhArrec6PNzt/5sttLgh0cvcvfY6Px+ZNY9I6Ax6gKErY1xmZ8ZyD0E5MJGIgsyIZsunT3g7qALJuTdAp0nWyMTsunS2QNukbpwOcRaPpvOHvxzQow2ZBvrs+nsfLL8o0QQBJFdMO1XGkEjaIQlQCMsD/YIGkEjLAEaYXmwR9AIGmEJ0AjLgz2CRtAIS4BGWB7sETSCRlgCNMLyYI+gETTCEqARlgd7BI2gEZYAjbA82CNoBI2wBGiE5cEeQSNohCVAIywP9ggaQSMsARphebBH0AgaYQnQCMsjYC5SF2agYi2fTWcPGA7VFfO0n8+mswdMyOrCNJwnpz/P6xqZkE2Xzh4w8qcLI4Hbu/dydvkWBRAAQBZk0uOOyKyzp5PARRiF1puNtR+NTh+oMCvtJ+D8F2N6j6x+PrwzG46gRTDDm5BtsAGBg0X924Qfj7i23p7HNgQAAAAASUVORK5CYII=");background-size:100%;position:relative;right:2px;top:-5px}.markdown-body input[type=checkbox]:checked:before{background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEIAAABCCAYAAADjVADoAAAK2GlDQ1BJQ0MgUHJvZmlsZQAASImVlwdUU9kWhs+96Y0WiHRC70gngJTQQxGkg6iEJJBQYkgIKmJnUMGxoCKCZcSKKFhGQMaCWLANAopdJ8igoD4HC6Ki5t3AI8zMW++99fZaJ+dbO/vss/e55671XwAoYWyRKBdWAyBPWCCODQ2gJ6ek0nHPAQRgQAI2wIHNkYiYMTGRALHJ+a/28S4Sjdhte0Wuf///v5oGlyfhAAClIZzBlXDyEG5DxkuOSFwAAOoI4jddUCBScBfCmmKkQIR/V3DWBH9ScMY4o8njMfGxgQjTAcCT2WxxFgBkO8RPL+RkIXnIih4chVyBEOFihH05fDYX4TMI2+XlzVfwIMJWSLwIAApyOoCR8aecWX/Jn6HMz2ZnKXmir3HDBwkkolz2ov/zaP635eVKJ/ewQAaZLw6LVeyHnN/9nPkRShZmzIyeZAF3oiYF86VhCZPMkQSmTjKXHRShXJs7M3KSMwUhLGWeAlb8JPMkwXGTLJ4fq9wrUxzInGS2eHxfIsIyaU6C0s/nsZT5i/jxSZNcKEicOcmSnLiIqZhApV8sjVXWzxOGBkztG6LsPU/yp34FLOXaAn58mLJ39lT9PCFzKqckWVkblxcUPBWToIwXFQQo9xLlxijjebmhSr+kME65tgC5nFNrY5RnmM0Oj5lkIABRgA04dNVJAqCAt7BA0UjgfNEisSCLX0BnIm8bj84Schzs6M6Ozs4AKN7dievwnjb+TkK061O+NYjHr10ul5+e8oUi9/i4KfJYbk35LCsAUNUD4Op+jlRcOOFDK34wyNNTBZpABxgCU2AF7IEzcAfewB8Eg3AQDeJBCpiL1MoHeUAMFoBisAKUgnKwEWwF1WA32AsOgaPgBGgGZ8AFcAXcAF2gFzwCMjAAXoFh8BGMQRCEgygQFdKBjCBzyBZyhhiQLxQMRUKxUAqUDmVBQkgKFUOroHKoAqqG9kB10HHoNHQBugZ1Qw+gPmgIegd9gVEwGdaEDWALeDrMgJlwBBwPz4Gz4Hy4CC6B18NVcC18BG6CL8A34F5YBr+CR1AARULRUMYoexQDFYiKRqWiMlFi1FJUGaoSVYtqQLWiOlC3UTLUa9RnNBZNRdPR9mhvdBg6Ac1B56OXotehq9GH0E3oS+jb6D70MPo7hoLRx9hivDAsTDImC7MAU4qpxBzAnMJcxvRiBjAfsVgsDWuJ9cCGYVOw2djF2HXYndhGbBu2G9uPHcHhcDo4W5wPLhrHxhXgSnHbcUdw53E9uAHcJzwJb4R3xofgU/FC/Ep8Jf4w/hy+B/8CP0ZQI5gTvAjRBC5hEWEDYR+hlXCLMEAYI6oTLYk+xHhiNnEFsYrYQLxMfEx8TyKRTEiepFkkAWk5qYp0jHSV1Ef6TNYg25ADyWlkKXk9+SC5jfyA/J5CoVhQ/CmplALKekod5SLlKeWTClXFQYWlwlVZplKj0qTSo/JGlaBqrspUnatapFqpelL1luprNYKahVqgGlttqVqN2mm1e2oj6lR1J/Vo9Tz1deqH1a+pD2rgNCw0gjW4GiUaezUuavRTUVRTaiCVQ11F3Ue9TB3QxGpaarI0szXLNY9qdmoOa2louWolai3UqtE6qyWjoWgWNBYtl7aBdoJ2l/ZlmsE05jTetLXTGqb1TBvV1tP21+Zpl2k3avdqf9Gh6wTr5Ohs0mnWeaKL1rXRnaW7QHeX7mXd13qaet56HL0yvRN6D/VhfRv9WP3F+nv1b+qPGBgahBqIDLYbXDR4bUgz9DfMNtxieM5wyIhq5GskMNpidN7oJV2LzqTn0qvol+jDxvrGYcZS4z3GncZjJpYmCSYrTRpNnpgSTRmmmaZbTNtNh82MzKLMis3qzR6aE8wZ5nzzbeYd5qMWlhZJFqstmi0GLbUtWZZFlvWWj60oVn5W+Va1VnessdYM6xzrndZdNrCNmw3fpsbmli1s624rsN1p222HsfO0E9rV2t2zJ9sz7Qvt6+37HGgOkQ4rHZod3kw3m546fdP0junfHd0ccx33OT5y0nAKd1rp1Or0ztnGmeNc43zHheIS4rLMpcXlrautK891l+t9N6pblNtqt3a3b+4e7mL3BvchDzOPdI8dHvcYmowYxjrGVU+MZ4DnMs8znp+93L0KvE54/eFt753jfdh7cIblDN6MfTP6fUx82D57fGS+dN903598ZX7Gfmy/Wr9n/qb+XP8D/i+Y1sxs5hHmmwDHAHHAqYDRQK/AJYFtQaig0KCyoM5gjeCE4OrgpyEmIVkh9SHDoW6hi0PbwjBhEWGbwu6xDFgcVh1rONwjfEn4pQhyRFxEdcSzSJtIcWRrFBwVHrU56vFM85nCmc3RIJoVvTn6SYxlTH7ML7Ows2Jm1cx6HusUWxzbEUeNmxd3OO5jfED8hvhHCVYJ0oT2RNXEtMS6xNGkoKSKJFny9OQlyTdSdFMEKS2puNTE1AOpI7ODZ2+dPZDmllaadneO5ZyFc67N1Z2bO/fsPNV57Hkn0zHpSemH07+yo9m17JEMVsaOjGFOIGcb5xXXn7uFO8Tz4VXwXmT6ZFZkDmb5ZG3OGuL78Sv5rwWBgmrB2+yw7N3ZoznROQdz5LlJuY15+Lz0vNNCDWGO8NJ8w/kL53eLbEWlIlm+V/7W/GFxhPiABJLMkbQUaCIi6abUSvqDtK/Qt7Cm8NOCxAUnF6ovFC68uchm0dpFL4pCivYvRi/mLG4vNi5eUdy3hLlkz1JoacbS9mWmy0qWDSwPXX5oBXFFzopfVzqurFj5YVXSqtYSg5LlJf0/hP5QX6pSKi69t9p79e416DWCNZ1rXdZuX/u9jFt2vdyxvLL86zrOuus/Ov1Y9aN8feb6zg3uG3ZtxG4Ubry7yW/ToQr1iqKK/s1Rm5u20LeUbfmwdd7Wa5Wulbu3EbdJt8mqIqtatptt37j9azW/urcmoKZxh/6OtTtGd3J39uzy39Ww22B3+e4vPwl+ur8ndE9TrUVt5V7s3sK9z/cl7uvYz9hfd0D3QPmBbweFB2WHYg9dqvOoqzusf3hDPVwvrR86knak62jQ0ZYG+4Y9jbTG8mPgmPTYy+Ppx++eiDjRfpJxsuFn8593nKKeKmuCmhY1DTfzm2UtKS3dp8NPt7d6t576xeGXg2eMz9Sc1Tq74RzxXMk5+fmi8yNtorbXF7Iu9LfPa390MfninUuzLnVejrh89UrIlYsdzI7zV32unrnmde30dcb15hvuN5puut089avbr6c63Tubbnncauny7GrtntF9rsev58LtoNtX7rDu3Oid2dt9N+Hu/Xtp92T3ufcHH+Q+ePuw8OHYo+WPMY/Lnqg9qXyq/7T2N+vfGmXusrN9QX03n8U9e9TP6X/1u+T3rwMlzynPK18YvagbdB48MxQy1PVy9suBV6JXY69L/6H+jx1vrN78/If/HzeHk4cH3orfyt+te6/z/uAH1w/tIzEjTz/mfRwbLfuk8+nQZ8bnji9JX16MLfiK+1r1zfpb6/eI74/leXK5iC1mj0sBFDLgzEwA3h1EtHEKAFRElxNnT2jrcYMmvgfGCfwnntDf4+YOQAMyKWQR0x+Akwo5i8wqyKyQRPH+AHZxUY5/mSTTxXkiFxlRlphPcvl7AwBwrQB8E8vlYzvl8m/7kGIfANCWP6HpFYZFtHyD3vJRg6LbPe3g7zah9//U499noKjAFfx9/ieoZhkWVvYkwwAAAGxlWElmTU0AKgAAAAgABAEaAAUAAAABAAAAPgEbAAUAAAABAAAARgEoAAMAAAABAAIAAIdpAAQAAAABAAAATgAAAAAAAACQAAAAAQAAAJAAAAABAAKgAgAEAAAAAQAAAEKgAwAEAAAAAQAAAEIAAAAAgodoEQAAAAlwSFlzAAAWJQAAFiUBSVIk8AAABMtJREFUeAHtXM2KFDEQzrQKruIu4mEXRFlUVLz4A4K7B99AcO8io0/gwQfxDVzFuwu+gQf34EG8iOAPKAh6EFlBFMSf/qa2uqszlVR6ZtYxM5PDJNVVSer78nU6KrHzpyxuVlwx44AY2O0T8eb9D7f5fMu9fPvdff7y0/36nbdgdhUdd+jgHnf62JxbObvgjh/d60Pu2R35ajx49Mk9frqlBk7Kw8sXF9y1K4t9cCoi7tz/4F68/tYXMIkPzpzY725dP9yA1tsjoIRpIQHogRWYZSmwJ4Reh06nI2Nd7rYEA8zAzqXAxhgq/pc1d9vHKbEX+Dr4JbzypJDc/YxXYi/wifRLeOXpU5q7n/FK7EXsnBBeeRoqd7/EHj1ZhleeiMjdz8pArRKR+0pb+UsCuK0SkftKW/kzeFmrRHCAxWzufsaJOkqExWzufpOI8EpP1jnCJCK80pN1jjCJ4ICwMigidz/jRD3bI7bZUInIfaWt/KUSuK0SEd4jqFvufgYva5UIDrCYzd3POFFHifhfV/7k8lwPw7D5mUSEV3r854ju2pK7ffOIWzk/X+Go803Lr+ooGqoiwkyP9xzRXVt0q9sE3CgJYTLqfNPyE/irpkoEe2um6ck4bSiBSeD8JBl41jY/Hgd1lIiaaeoyLlsjgUGAjEH3DB4DtUpEW2Z3Mj5GAgA8efbVvXpX/200nln5IMYvKhHDrvylcwdc9+pSNdeg46WQsP7wo2s7fpWYaPT926fw9ZiVk4BpywYJkGuvlJs4EuWS0p/HTyHh3kbzH2najM85cR0lgpPiYMtukFB26m1u5Ua+vkFkWP3Zn0KCJDg1Px6f42Wtvhrhdyz8ncanrFKCmGH1wrwDMCrh/uxPIUFTAvdHbeVPsc1fVRE+c7Ud/k6fWt7XHFlYqcqQ5wTRvWpiY4wrIZwfDUL+akDRUBXB/jCzFCH9SHCzTDRUmsro7z+cEvrHwxOZn2ZTL/pVFcEBtRLoiWXfxQ5ehvoHHx4vpIwUEuJKSMvPz5/zQq0qwmIy5m+rjBQSwnsCQYnlgwjfT72av6oifOba2qnKcOXeGVIP0rT3BALTNr8mBWSpRHAgmJSTtLGhDHwj+A9GPCbX2DNiBSRoShg0H8zl5y/njxIhJ0WntralDJmIbO+UEvz85Zwt9wj7HIDB5Ttp7RkyGbRDSqC49vOjX50P9aexmr+qInzmajvtO13H02SpyrCVMNj8dT7/4BwByDXzRIC0LWXEldA/njVfip9GpV9VERxQM0lPhrVDyrCVMJr5/fwZJ+qWewR1lSuNJ21sXxnjVgIhck5VhM/cqG1WBpIAMX4Z9Xz+eP58sFUiOBArLQcZpQ0CNCXt1HzA5OfPOFGrrwYHyKTwbNJsxolaJUJbKeo0mu/4uMeXBHBbJSK88qP5jo97fAYva5UIDgivHEXk7mecqKNEhFeOhsjdbxKR+0pb+UsCuK0qIveVtvJn8LJWieAAi9nc/YwTdZQIi9nc/SYR4ZWenSO2yZvgcwTuRYZKWBnUI3e/xF7gcmio5L4HWPlL7AVuyPol95W28me8EnuBa8J+sZjM3c94JfYCd6VxTXjaCjDLe+K9cwTuSuOa8LQUYPXvh1d3w0HC7JK8kMK0/rcJfwHkVMYgi4xhOgAAAABJRU5ErkJggg==");background-size:100%}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-light">.hljs-comment,.hljs-quote{color:#696969}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#d91e18}.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#aa5d00}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:green}.hljs-section,.hljs-title{color:#007faa}.hljs-keyword,.hljs-selector-tag{color:#7928a1}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fefefe;color:#545454}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><p>åœ¨Javaç¼–ç¨‹ä¸­ï¼Œæ–¹æ³•å°±åƒæ˜¯ä½ çš„ä¸ªäººå·¥å…·ç®±é‡Œçš„å„ç§å·¥å…·â€”â€”é”¤å­ç”¨æ¥é’‰é’‰å­ï¼Œèºä¸åˆ€ç”¨æ¥æ‹§èºä¸ï¼Œæ¯ä¸ªå·¥å…·éƒ½æœ‰ä¸“é—¨çš„ç”¨é€”ã€‚ä»Šå¤©ï¼Œæˆ‘ä»¬æ¥å­¦ä¹ å¦‚ä½•åˆ›å»ºå’Œä½¿ç”¨è‡ªå·±çš„"ç¼–ç¨‹å·¥å…·"ï¼</p>
<h2 data-id="heading-0">å¼•å…¥ï¼šä¸ºä»€ä¹ˆéœ€è¦æ–¹æ³•ï¼Ÿ</h2>
<p>æƒ³è±¡ä¸€ä¸‹ï¼Œä½ æ­£åœ¨å†™ä¸€ä¸ªå­¦ç”Ÿæˆç»©ç®¡ç†ç³»ç»Ÿï¼š
<strong>æ²¡æœ‰æ–¹æ³•çš„æƒ…å†µï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
    <span class="hljs-comment">// è®¡ç®—ç¬¬ä¸€ä¸ªå­¦ç”Ÿçš„æ€»åˆ†</span>
    <span class="hljs-type">int</span> <span class="hljs-variable">score1</span> <span class="hljs-operator">=</span> <span class="hljs-number">85</span>;
    <span class="hljs-type">int</span> <span class="hljs-variable">score2</span> <span class="hljs-operator">=</span> <span class="hljs-number">90</span>;
    <span class="hljs-type">int</span> <span class="hljs-variable">score3</span> <span class="hljs-operator">=</span> <span class="hljs-number">78</span>;
    <span class="hljs-type">int</span> <span class="hljs-variable">total1</span> <span class="hljs-operator">=</span> score1 + score2 + score3;
    <span class="hljs-type">double</span> <span class="hljs-variable">average1</span> <span class="hljs-operator">=</span> total1 / <span class="hljs-number">3.0</span>;
    System.out.println(<span class="hljs-string">"ç¬¬ä¸€ä¸ªå­¦ç”Ÿå¹³å‡åˆ†ï¼š"</span> + average1);
    
    <span class="hljs-comment">// è®¡ç®—ç¬¬äºŒä¸ªå­¦ç”Ÿçš„æ€»åˆ†ï¼ˆé‡å¤å†™ä¸€éï¼ï¼‰</span>
    <span class="hljs-type">int</span> <span class="hljs-variable">score4</span> <span class="hljs-operator">=</span> <span class="hljs-number">92</span>;
    <span class="hljs-type">int</span> <span class="hljs-variable">score5</span> <span class="hljs-operator">=</span> <span class="hljs-number">88</span>;
    <span class="hljs-type">int</span> <span class="hljs-variable">score6</span> <span class="hljs-operator">=</span> <span class="hljs-number">95</span>;
    <span class="hljs-type">int</span> <span class="hljs-variable">total2</span> <span class="hljs-operator">=</span> score4 + score5 + score6;
    <span class="hljs-type">double</span> <span class="hljs-variable">average2</span> <span class="hljs-operator">=</span> total2 / <span class="hljs-number">3.0</span>;
    System.out.println(<span class="hljs-string">"ç¬¬äºŒä¸ªå­¦ç”Ÿå¹³å‡åˆ†ï¼š"</span> + average2);
    
    <span class="hljs-comment">// è®¡ç®—ç¬¬ä¸‰ä¸ªå­¦ç”Ÿçš„æ€»åˆ†ï¼ˆåˆé‡å¤å†™ä¸€éï¼ï¼‰</span>
    <span class="hljs-comment">// ... å¤ªéº»çƒ¦äº†ï¼</span>
}
</code></pre>
<p><strong>ä½¿ç”¨æ–¹æ³•çš„æƒ…å†µï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
    <span class="hljs-comment">// åªéœ€è¦è°ƒç”¨æ–¹æ³•ï¼Œä»£ç å˜å¾—è¶…çº§ç®€æ´ï¼</span>
    calculateAverage(<span class="hljs-number">85</span>, <span class="hljs-number">90</span>, <span class="hljs-number">78</span>, <span class="hljs-string">"ç¬¬ä¸€ä¸ªå­¦ç”Ÿ"</span>);
    calculateAverage(<span class="hljs-number">92</span>, <span class="hljs-number">88</span>, <span class="hljs-number">95</span>, <span class="hljs-string">"ç¬¬äºŒä¸ªå­¦ç”Ÿ"</span>);
    calculateAverage(<span class="hljs-number">76</span>, <span class="hljs-number">85</span>, <span class="hljs-number">90</span>, <span class="hljs-string">"ç¬¬ä¸‰ä¸ªå­¦ç”Ÿ"</span>);
}

<span class="hljs-comment">// å®šä¹‰ä¸€ä¸ªè®¡ç®—å¹³å‡åˆ†çš„æ–¹æ³•</span>
<span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">calculateAverage</span><span class="hljs-params">(<span class="hljs-type">int</span> score1, <span class="hljs-type">int</span> score2, <span class="hljs-type">int</span> score3, String name)</span> {
    <span class="hljs-type">int</span> <span class="hljs-variable">total</span> <span class="hljs-operator">=</span> score1 + score2 + score3;
    <span class="hljs-type">double</span> <span class="hljs-variable">average</span> <span class="hljs-operator">=</span> total / <span class="hljs-number">3.0</span>;
    System.out.println(name + <span class="hljs-string">"å¹³å‡åˆ†ï¼š"</span> + average);
}
</code></pre>
<p>çœ‹åˆ°åŒºåˆ«äº†å—ï¼Ÿæ–¹æ³•è®©ä»£ç æ›´ç®€æ´ã€æ›´æ˜“è¯»ã€æ›´æ˜“ç»´æŠ¤ï¼</p>
<h2 data-id="heading-1">ä¸€ã€æ–¹æ³•åŸºç¡€ï¼šä»€ä¹ˆæ˜¯æ–¹æ³•ï¼Ÿ</h2>
<h3 data-id="heading-2">1.1 æ–¹æ³•çš„é€šä¿—ç†è§£</h3>
<p><strong>æ–¹æ³•ï¼ˆMethodï¼‰</strong> Â å°±æ˜¯ä¸€æ®µæœ‰åå­—çš„ä»£ç å—ï¼Œå¯ä»¥é‡å¤ä½¿ç”¨ã€‚ä½ å¯ä»¥æŠŠå®ƒæƒ³è±¡æˆï¼š</p>
<ul>
<li><strong>ä¸€ä¸ªé­”æ³•å’’è¯­</strong>ï¼šå¿µå‡ºå’’è¯­ï¼ˆè°ƒç”¨æ–¹æ³•ï¼‰ï¼Œå°±ä¼šå‘ç”Ÿç‰¹å®šçš„é­”æ³•æ•ˆæœï¼ˆæ‰§è¡Œä»£ç ï¼‰</li>
<li><strong>ä¸€ä¸ªå¨æˆ¿é£Ÿè°±</strong>ï¼šæŒ‰ç…§é£Ÿè°±ï¼ˆæ–¹æ³•ï¼‰çš„æ­¥éª¤ï¼Œå°±èƒ½åšå‡ºç¾å‘³çš„èœï¼ˆå¾—åˆ°ç»“æœï¼‰</li>
<li><strong>ä¸€ä¸ªæ•°å­¦å…¬å¼</strong>ï¼šæ¯”å¦‚ "åœ†çš„é¢ç§¯ = Ï€ Ã— rÂ²"ï¼Œè¿™å°±æ˜¯ä¸€ä¸ªæ–¹æ³•</li>
</ul>
<h3 data-id="heading-3">1.2 æ–¹æ³•çš„ç»„æˆéƒ¨åˆ†</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// è®¿é—®ä¿®é¥°ç¬¦ è¿”å›å€¼ç±»å‹ æ–¹æ³•å(å‚æ•°åˆ—è¡¨) {</span>
<span class="hljs-comment">//     æ–¹æ³•ä½“</span>
<span class="hljs-comment">//     è¿”å›å€¼ï¼ˆå¦‚æœéœ€è¦ï¼‰</span>
<span class="hljs-comment">// }</span>

<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">add</span><span class="hljs-params">(<span class="hljs-type">int</span> a, <span class="hljs-type">int</span> b)</span> {
    <span class="hljs-type">int</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> a + b;
    <span class="hljs-keyword">return</span> result;
}
</code></pre>
<h2 data-id="heading-4">äºŒã€åˆ›å»ºå’Œä½¿ç”¨æ–¹æ³•</h2>
<h3 data-id="heading-5">2.1 æœ€ç®€å•çš„æ— å‚æ–¹æ³•</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SimpleMethod</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        System.out.println(<span class="hljs-string">"=== æœ€ç®€å•çš„æ— å‚æ–¹æ³• ===\n"</span>);
        
        <span class="hljs-comment">// è°ƒç”¨æ–¹æ³•ï¼šå°±åƒå–Šæœ‹å‹çš„åå­—</span>
        sayHello();      <span class="hljs-comment">// ç¬¬ä¸€æ¬¡è°ƒç”¨</span>
        sayHello();      <span class="hljs-comment">// ç¬¬äºŒæ¬¡è°ƒç”¨</span>
        sayHello();      <span class="hljs-comment">// å¯ä»¥æ— é™æ¬¡è°ƒç”¨ï¼</span>
    }
    
    <span class="hljs-comment">// å®šä¹‰ä¸€ä¸ªæ— å‚æ–¹æ³•ï¼šå‘ä¸–ç•Œé—®å¥½</span>
    <span class="hljs-comment">// staticï¼šè¡¨ç¤ºè¿™æ˜¯é™æ€æ–¹æ³•ï¼Œå¯ä»¥åœ¨mainä¸­ç›´æ¥è°ƒç”¨</span>
    <span class="hljs-comment">// voidï¼šè¡¨ç¤ºè¿™ä¸ªæ–¹æ³•ä¸è¿”å›ä»»ä½•å€¼</span>
    <span class="hljs-comment">// sayHelloï¼šæ–¹æ³•åï¼ˆæˆ‘ä»¬è‡ªå·±å–çš„ï¼‰</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sayHello</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"ä½ å¥½ï¼ŒJavaä¸–ç•Œï¼"</span>);
        System.out.println(<span class="hljs-string">"æˆ‘æ­£åœ¨å­¦ä¹ Javaæ–¹æ³•ï¼"</span>);
        System.out.println(<span class="hljs-string">"------------------"</span>);
    }
}
</code></pre>
<h3 data-id="heading-6">2.2 å¸¦å‚æ•°çš„æ–¹æ³•ï¼ˆè®©æ–¹æ³•æ›´çµæ´»ï¼‰</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MethodWithParameters</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        System.out.println(<span class="hljs-string">"=== å¸¦å‚æ•°çš„æ–¹æ³• ===\n"</span>);
        
        <span class="hljs-comment">// ä¼ é€’ä¸åŒçš„å‚æ•°ï¼Œå¾—åˆ°ä¸åŒçš„ç»“æœ</span>
        greet(<span class="hljs-string">"å°æ˜"</span>);          <span class="hljs-comment">// å‘å°æ˜é—®å¥½</span>
        greet(<span class="hljs-string">"å°çº¢"</span>);          <span class="hljs-comment">// å‘å°çº¢é—®å¥½</span>
        greet(<span class="hljs-string">"æè€å¸ˆ"</span>);        <span class="hljs-comment">// å‘æè€å¸ˆé—®å¥½</span>
        
        <span class="hljs-comment">// è®¡ç®—ä¸åŒæ•°å­—çš„å’Œ</span>
        printSum(<span class="hljs-number">5</span>, <span class="hljs-number">3</span>);        <span class="hljs-comment">// è®¡ç®—5+3</span>
        printSum(<span class="hljs-number">10</span>, <span class="hljs-number">20</span>);      <span class="hljs-comment">// è®¡ç®—10+20</span>
        printSum(<span class="hljs-number">100</span>, <span class="hljs-number">200</span>);    <span class="hljs-comment">// è®¡ç®—100+200</span>
    }
    
    <span class="hljs-comment">// å¸¦ä¸€ä¸ªå‚æ•°çš„æ–¹æ³•ï¼šå‘æŒ‡å®šçš„äººé—®å¥½</span>
    <span class="hljs-comment">// nameï¼šå‚æ•°ï¼Œè°ƒç”¨æ—¶éœ€è¦ä¼ å…¥</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">greet</span><span class="hljs-params">(String name)</span> {
        System.out.println(<span class="hljs-string">"ä½ å¥½ï¼Œ"</span> + name + <span class="hljs-string">"ï¼"</span>);
        System.out.println(<span class="hljs-string">"æ¬¢è¿æ¥åˆ°Javaè¯¾å ‚ï¼"</span>);
        System.out.println();
    }
    
    <span class="hljs-comment">// å¸¦ä¸¤ä¸ªå‚æ•°çš„æ–¹æ³•ï¼šè®¡ç®—ä¸¤ä¸ªæ•°çš„å’Œ</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">printSum</span><span class="hljs-params">(<span class="hljs-type">int</span> a, <span class="hljs-type">int</span> b)</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">sum</span> <span class="hljs-operator">=</span> a + b;
        System.out.println(a + <span class="hljs-string">" + "</span> + b + <span class="hljs-string">" = "</span> + sum);
    }
}
</code></pre>
<h3 data-id="heading-7">2.3 æœ‰è¿”å›å€¼çš„æ–¹æ³•ï¼ˆæ–¹æ³•å¯ä»¥"ç»™å‡ºç­”æ¡ˆ"ï¼‰</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MethodWithReturn</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        System.out.println(<span class="hljs-string">"=== æœ‰è¿”å›å€¼çš„æ–¹æ³• ===\n"</span>);
        
        <span class="hljs-comment">// è°ƒç”¨æ–¹æ³•å¹¶æ¥æ”¶è¿”å›å€¼</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">result1</span> <span class="hljs-operator">=</span> add(<span class="hljs-number">5</span>, <span class="hljs-number">3</span>);      <span class="hljs-comment">// è°ƒç”¨addæ–¹æ³•ï¼Œå¾—åˆ°è¿”å›å€¼8</span>
        System.out.println(<span class="hljs-string">"5 + 3 = "</span> + result1);
        
        <span class="hljs-type">int</span> <span class="hljs-variable">result2</span> <span class="hljs-operator">=</span> add(<span class="hljs-number">10</span>, <span class="hljs-number">20</span>);    <span class="hljs-comment">// å†æ¬¡è°ƒç”¨ï¼Œå¾—åˆ°30</span>
        System.out.println(<span class="hljs-string">"10 + 20 = "</span> + result2);
        
        <span class="hljs-comment">// è¿”å›å€¼å¯ä»¥ç›´æ¥ä½¿ç”¨</span>
        System.out.println(<span class="hljs-string">"7 + 8 = "</span> + add(<span class="hljs-number">7</span>, <span class="hljs-number">8</span>));
        
        <span class="hljs-comment">// ä½¿ç”¨è¿”å›å€¼è¿›è¡Œè¿›ä¸€æ­¥è®¡ç®—</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">total</span> <span class="hljs-operator">=</span> add(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>) + add(<span class="hljs-number">3</span>, <span class="hljs-number">4</span>) + add(<span class="hljs-number">5</span>, <span class="hljs-number">6</span>);
        System.out.println(<span class="hljs-string">"1+2 + 3+4 + 5+6 = "</span> + total);
        
        <span class="hljs-comment">// ä¸åŒç±»å‹çš„æ–¹æ³•</span>
        <span class="hljs-type">boolean</span> <span class="hljs-variable">isAdult</span> <span class="hljs-operator">=</span> checkAge(<span class="hljs-number">20</span>);
        System.out.println(<span class="hljs-string">"20å²æ˜¯æˆå¹´äººå—ï¼Ÿ"</span> + isAdult);
        
        <span class="hljs-type">double</span> <span class="hljs-variable">area</span> <span class="hljs-operator">=</span> calculateCircleArea(<span class="hljs-number">5.0</span>);
        System.out.println(<span class="hljs-string">"åŠå¾„ä¸º5çš„åœ†é¢ç§¯ï¼š"</span> + area);
    }
    
    <span class="hljs-comment">// æœ‰è¿”å›å€¼çš„æ–¹æ³•ï¼šè¿”å›ä¸¤ä¸ªæ•°çš„å’Œ</span>
    <span class="hljs-comment">// intï¼šè¡¨ç¤ºè¿™ä¸ªæ–¹æ³•è¿”å›ä¸€ä¸ªæ•´æ•°</span>
    <span class="hljs-comment">// returnï¼šè¿”å›è®¡ç®—ç»“æœ</span>
    <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">add</span><span class="hljs-params">(<span class="hljs-type">int</span> a, <span class="hljs-type">int</span> b)</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">sum</span> <span class="hljs-operator">=</span> a + b;   <span class="hljs-comment">// è®¡ç®—å’Œ</span>
        <span class="hljs-keyword">return</span> sum;        <span class="hljs-comment">// è¿”å›ç»“æœ</span>
    }
    
    <span class="hljs-comment">// æ£€æŸ¥å¹´é¾„æ˜¯å¦æˆå¹´</span>
    <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">checkAge</span><span class="hljs-params">(<span class="hljs-type">int</span> age)</span> {
        <span class="hljs-keyword">if</span> (age &gt;= <span class="hljs-number">18</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;   <span class="hljs-comment">// è¿”å›true</span>
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;  <span class="hljs-comment">// è¿”å›false</span>
        }
        <span class="hljs-comment">// æ³¨æ„ï¼šä¸€ä¸ªæ–¹æ³•å¿…é¡»ä¿è¯åœ¨æ‰€æœ‰æƒ…å†µä¸‹éƒ½æœ‰è¿”å›å€¼</span>
    }
    
    <span class="hljs-comment">// è®¡ç®—åœ†é¢ç§¯</span>
    <span class="hljs-keyword">static</span> <span class="hljs-type">double</span> <span class="hljs-title function_">calculateCircleArea</span><span class="hljs-params">(<span class="hljs-type">double</span> radius)</span> {
        <span class="hljs-type">double</span> <span class="hljs-variable">area</span> <span class="hljs-operator">=</span> <span class="hljs-number">3.14159</span> * radius * radius;
        <span class="hljs-keyword">return</span> area;  <span class="hljs-comment">// è¿”å›doubleç±»å‹</span>
    }
}
</code></pre>
<h3 data-id="heading-8">2.4 æ–¹æ³•å‚æ•°ä¼ é€’çš„ç»†èŠ‚</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ParameterDetails</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        System.out.println(<span class="hljs-string">"=== æ–¹æ³•å‚æ•°ç»†èŠ‚ ===\n"</span>);
        
        <span class="hljs-comment">// åŸºæœ¬ç±»å‹å‚æ•°ä¼ é€’ï¼ˆä¼ å€¼ï¼‰</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">x</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span>;
        System.out.println(<span class="hljs-string">"ä¿®æ”¹å‰ x = "</span> + x);
        changeNumber(x);  <span class="hljs-comment">// æŠŠxçš„å€¼10ä¼ ç»™æ–¹æ³•</span>
        System.out.println(<span class="hljs-string">"ä¿®æ”¹å x = "</span> + x);
        System.out.println(<span class="hljs-string">"ç»“è®ºï¼šåŸºæœ¬ç±»å‹å‚æ•°ä¸ä¼šæ”¹å˜åŸå˜é‡\n"</span>);
        
        <span class="hljs-comment">// æ•°ç»„å‚æ•°ä¼ é€’ï¼ˆä¼ å¼•ç”¨ï¼‰</span>
        <span class="hljs-type">int</span>[] scores = {<span class="hljs-number">85</span>, <span class="hljs-number">90</span>, <span class="hljs-number">78</span>};
        System.out.println(<span class="hljs-string">"ä¿®æ”¹å‰ scores[0] = "</span> + scores[<span class="hljs-number">0</span>]);
        changeArrayElement(scores);  <span class="hljs-comment">// æŠŠæ•°ç»„çš„"åœ°å€"ä¼ ç»™æ–¹æ³•</span>
        System.out.println(<span class="hljs-string">"ä¿®æ”¹å scores[0] = "</span> + scores[<span class="hljs-number">0</span>]);
        System.out.println(<span class="hljs-string">"ç»“è®ºï¼šæ•°ç»„å‚æ•°ä¼šæ”¹å˜åŸæ•°ç»„å†…å®¹\n"</span>);
        
        <span class="hljs-comment">// å¤šä¸ªå‚æ•°ç¤ºä¾‹</span>
        printStudentInfo(<span class="hljs-string">"å¼ ä¸‰"</span>, <span class="hljs-number">18</span>, <span class="hljs-number">95.5</span>);
        printStudentInfo(<span class="hljs-string">"æå››"</span>, <span class="hljs-number">20</span>, <span class="hljs-number">88.0</span>);
        
        <span class="hljs-comment">// å¯å˜å‚æ•°ï¼ˆå‚æ•°æ•°é‡å¯å˜ï¼‰</span>
        System.out.println(<span class="hljs-string">"\n=== å¯å˜å‚æ•° ==="</span>);
        System.out.println(<span class="hljs-string">"å¹³å‡åˆ†1ï¼š"</span> + calculateAverage(<span class="hljs-number">85</span>, <span class="hljs-number">90</span>, <span class="hljs-number">78</span>));
        System.out.println(<span class="hljs-string">"å¹³å‡åˆ†2ï¼š"</span> + calculateAverage(<span class="hljs-number">92</span>, <span class="hljs-number">88</span>, <span class="hljs-number">95</span>, <span class="hljs-number">76</span>, <span class="hljs-number">85</span>));
        System.out.println(<span class="hljs-string">"å¹³å‡åˆ†3ï¼š"</span> + calculateAverage(<span class="hljs-number">100</span>, <span class="hljs-number">95</span>));  <span class="hljs-comment">// ä¸¤ä¸ªå‚æ•°ä¹Ÿå¯ä»¥</span>
    }
    
    <span class="hljs-comment">// å°è¯•ä¿®æ”¹åŸºæœ¬ç±»å‹å‚æ•°</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">changeNumber</span><span class="hljs-params">(<span class="hljs-type">int</span> num)</span> {
        num = <span class="hljs-number">100</span>;  <span class="hljs-comment">// åªä¿®æ”¹äº†æ–¹æ³•å†…çš„å‰¯æœ¬</span>
        System.out.println(<span class="hljs-string">"æ–¹æ³•å†… num = "</span> + num);
    }
    
    <span class="hljs-comment">// ä¿®æ”¹æ•°ç»„å…ƒç´ </span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">changeArrayElement</span><span class="hljs-params">(<span class="hljs-type">int</span>[] arr)</span> {
        <span class="hljs-keyword">if</span> (arr.length &gt; <span class="hljs-number">0</span>) {
            arr[<span class="hljs-number">0</span>] = <span class="hljs-number">100</span>;  <span class="hljs-comment">// ä¿®æ”¹äº†åŸæ•°ç»„çš„å†…å®¹</span>
        }
    }
    
    <span class="hljs-comment">// å¤šä¸ªå‚æ•°çš„æ–¹æ³•</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">printStudentInfo</span><span class="hljs-params">(String name, <span class="hljs-type">int</span> age, <span class="hljs-type">double</span> score)</span> {
        System.out.println(<span class="hljs-string">"å§“åï¼š"</span> + name + <span class="hljs-string">"ï¼Œå¹´é¾„ï¼š"</span> + age + <span class="hljs-string">"ï¼Œæˆç»©ï¼š"</span> + score);
    }
    
    <span class="hljs-comment">// å¯å˜å‚æ•°ï¼šå¯ä»¥æ¥å—ä»»æ„æ•°é‡çš„å‚æ•°</span>
    <span class="hljs-comment">// è¯­æ³•ï¼šç±»å‹... å‚æ•°å</span>
    <span class="hljs-keyword">static</span> <span class="hljs-type">double</span> <span class="hljs-title function_">calculateAverage</span><span class="hljs-params">(<span class="hljs-type">int</span>... scores)</span> {
        <span class="hljs-keyword">if</span> (scores.length == <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-number">0.0</span>;
        }
        
        <span class="hljs-type">int</span> <span class="hljs-variable">sum</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> score : scores) {
            sum += score;
        }
        <span class="hljs-keyword">return</span> (<span class="hljs-type">double</span>) sum / scores.length;
    }
}
</code></pre>
<h2 data-id="heading-9">ä¸‰ã€æ–¹æ³•é‡è½½ï¼šåŒåä¸åŒ"å‚"</h2>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MethodOverloading</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        System.out.println(<span class="hljs-string">"=== æ–¹æ³•é‡è½½ ===\n"</span>);
        
        <span class="hljs-comment">// æ–¹æ³•é‡è½½ï¼šæ–¹æ³•åç›¸åŒï¼Œä½†å‚æ•°åˆ—è¡¨ä¸åŒ</span>
        <span class="hljs-comment">// Javaä¼šæ ¹æ®ä½ ä¼ å…¥çš„å‚æ•°è‡ªåŠ¨é€‰æ‹©åˆé€‚çš„ç‰ˆæœ¬</span>
        
        System.out.println(<span class="hljs-string">"æ•´æ•°ç›¸åŠ : "</span> + add(<span class="hljs-number">5</span>, <span class="hljs-number">3</span>));
        System.out.println(<span class="hljs-string">"å°æ•°ç›¸åŠ : "</span> + add(<span class="hljs-number">5.5</span>, <span class="hljs-number">3.3</span>));
        System.out.println(<span class="hljs-string">"ä¸‰ä¸ªæ•°ç›¸åŠ : "</span> + add(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>));
        System.out.println(<span class="hljs-string">"å­—ç¬¦ä¸²è¿æ¥: "</span> + add(<span class="hljs-string">"Hello, "</span>, <span class="hljs-string">"Java!"</span>));
        
        <span class="hljs-comment">// å®é™…åº”ç”¨ï¼šè®¡ç®—ä¸åŒå›¾å½¢çš„é¢ç§¯</span>
        System.out.println(<span class="hljs-string">"\n=== è®¡ç®—å›¾å½¢é¢ç§¯ ==="</span>);
        System.out.println(<span class="hljs-string">"æ­£æ–¹å½¢é¢ç§¯ï¼ˆè¾¹é•¿5ï¼‰: "</span> + calculateArea(<span class="hljs-number">5</span>));
        System.out.println(<span class="hljs-string">"é•¿æ–¹å½¢é¢ç§¯ï¼ˆé•¿5å®½3ï¼‰: "</span> + calculateArea(<span class="hljs-number">5</span>, <span class="hljs-number">3</span>));
        System.out.println(<span class="hljs-string">"åœ†é¢ç§¯ï¼ˆåŠå¾„4ï¼‰: "</span> + calculateArea(<span class="hljs-number">4.0</span>));
        
        <span class="hljs-comment">// æ³¨æ„ï¼šè¿”å›å€¼ç±»å‹ä¸åŒä¸èƒ½æ„æˆé‡è½½ï¼</span>
        <span class="hljs-comment">// é‡è½½åªçœ‹å‚æ•°ç±»å‹ã€æ•°é‡ã€é¡ºåºï¼Œä¸çœ‹è¿”å›å€¼</span>
    }
    
    <span class="hljs-comment">// ç‰ˆæœ¬1ï¼šä¸¤ä¸ªæ•´æ•°ç›¸åŠ </span>
    <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">add</span><span class="hljs-params">(<span class="hljs-type">int</span> a, <span class="hljs-type">int</span> b)</span> {
        System.out.print(<span class="hljs-string">"è°ƒç”¨intç‰ˆæœ¬ï¼š"</span>);
        <span class="hljs-keyword">return</span> a + b;
    }
    
    <span class="hljs-comment">// ç‰ˆæœ¬2ï¼šä¸‰ä¸ªæ•´æ•°ç›¸åŠ ï¼ˆå‚æ•°æ•°é‡ä¸åŒï¼‰</span>
    <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">add</span><span class="hljs-params">(<span class="hljs-type">int</span> a, <span class="hljs-type">int</span> b, <span class="hljs-type">int</span> c)</span> {
        System.out.print(<span class="hljs-string">"è°ƒç”¨ä¸‰ä¸ªå‚æ•°ç‰ˆæœ¬ï¼š"</span>);
        <span class="hljs-keyword">return</span> a + b + c;
    }
    
    <span class="hljs-comment">// ç‰ˆæœ¬3ï¼šä¸¤ä¸ªå°æ•°ç›¸åŠ ï¼ˆå‚æ•°ç±»å‹ä¸åŒï¼‰</span>
    <span class="hljs-keyword">static</span> <span class="hljs-type">double</span> <span class="hljs-title function_">add</span><span class="hljs-params">(<span class="hljs-type">double</span> a, <span class="hljs-type">double</span> b)</span> {
        System.out.print(<span class="hljs-string">"è°ƒç”¨doubleç‰ˆæœ¬ï¼š"</span>);
        <span class="hljs-keyword">return</span> a + b;
    }
    
    <span class="hljs-comment">// ç‰ˆæœ¬4ï¼šå­—ç¬¦ä¸²è¿æ¥ï¼ˆå®Œå…¨ä¸åŒç±»å‹ï¼‰</span>
    <span class="hljs-keyword">static</span> String <span class="hljs-title function_">add</span><span class="hljs-params">(String a, String b)</span> {
        System.out.print(<span class="hljs-string">"è°ƒç”¨Stringç‰ˆæœ¬ï¼š"</span>);
        <span class="hljs-keyword">return</span> a + b;
    }
    
    <span class="hljs-comment">// ç‰ˆæœ¬5ï¼šæ•´æ•°å’Œå°æ•°ç›¸åŠ ï¼ˆå‚æ•°é¡ºåºä¸åŒï¼‰</span>
    <span class="hljs-keyword">static</span> <span class="hljs-type">double</span> <span class="hljs-title function_">add</span><span class="hljs-params">(<span class="hljs-type">int</span> a, <span class="hljs-type">double</span> b)</span> {
        System.out.print(<span class="hljs-string">"è°ƒç”¨int-doubleç‰ˆæœ¬ï¼š"</span>);
        <span class="hljs-keyword">return</span> a + b;
    }
    
    <span class="hljs-comment">// ç‰ˆæœ¬6ï¼šå°æ•°å’Œæ•´æ•°ç›¸åŠ ï¼ˆå‚æ•°é¡ºåºä¸åŒï¼‰</span>
    <span class="hljs-keyword">static</span> <span class="hljs-type">double</span> <span class="hljs-title function_">add</span><span class="hljs-params">(<span class="hljs-type">double</span> a, <span class="hljs-type">int</span> b)</span> {
        System.out.print(<span class="hljs-string">"è°ƒç”¨double-intç‰ˆæœ¬ï¼š"</span>);
        <span class="hljs-keyword">return</span> a + b;
    }
    
    <span class="hljs-comment">// å›¾å½¢é¢ç§¯è®¡ç®—æ–¹æ³•ï¼ˆé‡è½½ç¤ºä¾‹ï¼‰</span>
    <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">calculateArea</span><span class="hljs-params">(<span class="hljs-type">int</span> side)</span> {
        <span class="hljs-keyword">return</span> side * side;  <span class="hljs-comment">// æ­£æ–¹å½¢</span>
    }
    
    <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">calculateArea</span><span class="hljs-params">(<span class="hljs-type">int</span> length, <span class="hljs-type">int</span> width)</span> {
        <span class="hljs-keyword">return</span> length * width;  <span class="hljs-comment">// é•¿æ–¹å½¢</span>
    }
    
    <span class="hljs-keyword">static</span> <span class="hljs-type">double</span> <span class="hljs-title function_">calculateArea</span><span class="hljs-params">(<span class="hljs-type">double</span> radius)</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-number">3.14159</span> * radius * radius;  <span class="hljs-comment">// åœ†å½¢</span>
    }
}
</code></pre>
<h2 data-id="heading-10">å››ã€æ–¹æ³•çš„æœ€ä½³å®è·µå’Œå¸¸è§é”™è¯¯</h2>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MethodBestPractices</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        System.out.println(<span class="hljs-string">"=== æ–¹æ³•çš„æœ€ä½³å®è·µ ===\n"</span>);
        
        <span class="hljs-comment">// âœ… å¥½æ–¹æ³•ï¼šå•ä¸€èŒè´£ï¼Œåªåšä¸€ä»¶äº‹</span>
        printWelcomeMessage();
        <span class="hljs-type">int</span> <span class="hljs-variable">sum</span> <span class="hljs-operator">=</span> calculateSum(<span class="hljs-number">10</span>, <span class="hljs-number">20</span>);
        System.out.println(<span class="hljs-string">"è®¡ç®—ç»“æœï¼š"</span> + sum);
        
        <span class="hljs-comment">// âœ… å¥½æ–¹æ³•ï¼šæœ‰æ„ä¹‰çš„å‘½å</span>
        <span class="hljs-type">boolean</span> <span class="hljs-variable">isValid</span> <span class="hljs-operator">=</span> isValidEmail(<span class="hljs-string">"test@example.com"</span>);
        System.out.println(<span class="hljs-string">"é‚®ç®±æ˜¯å¦æœ‰æ•ˆï¼š"</span> + isValid);
        
        <span class="hljs-comment">// âŒ å¸¸è§é”™è¯¯æ¼”ç¤º</span>
        System.out.println(<span class="hljs-string">"\n=== å¸¸è§é”™è¯¯ ==="</span>);
        
        <span class="hljs-comment">// é”™è¯¯1ï¼šæ–¹æ³•å¤ªé•¿ï¼ˆåº”è¯¥æ‹†åˆ†æˆå°æ–¹æ³•ï¼‰</span>
        <span class="hljs-comment">// é”™è¯¯2ï¼šæ–¹æ³•åæ— æ„ä¹‰ï¼ˆå¦‚ doSomethingã€processï¼‰</span>
        <span class="hljs-comment">// é”™è¯¯3ï¼šå‚æ•°å¤ªå¤šï¼ˆè¶…è¿‡3ä¸ªè¦è€ƒè™‘å°è£…æˆå¯¹è±¡ï¼‰</span>
        <span class="hljs-comment">// é”™è¯¯4ï¼šå‰¯ä½œç”¨å¤ªå¤šï¼ˆä¸€ä¸ªæ–¹æ³•åšäº†å¤ªå¤šäº‹æƒ…ï¼‰</span>
        
        <span class="hljs-comment">// å®ç”¨ç¤ºä¾‹ï¼šå­¦ç”Ÿç®¡ç†ç³»ç»Ÿ</span>
        System.out.println(<span class="hljs-string">"\n=== å­¦ç”Ÿç®¡ç†ç³»ç»Ÿç¤ºä¾‹ ==="</span>);
        
        <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> <span class="hljs-string">"å¼ ä¸‰"</span>;
        <span class="hljs-type">int</span>[] scores = {<span class="hljs-number">85</span>, <span class="hljs-number">90</span>, <span class="hljs-number">78</span>};
        
        <span class="hljs-comment">// ä½¿ç”¨å¤šä¸ªå°æ–¹æ³•ï¼Œä»£ç æ¸…æ™°æ˜“è¯»</span>
        printStudentHeader(name);
        <span class="hljs-type">double</span> <span class="hljs-variable">average</span> <span class="hljs-operator">=</span> calculateAverage(scores);
        <span class="hljs-type">String</span> <span class="hljs-variable">grade</span> <span class="hljs-operator">=</span> calculateGrade(average);
        printStudentResult(average, grade);
    }
    
    <span class="hljs-comment">// âœ… å¥½ä¾‹å­ï¼šæ–¹æ³•åæ¸…æ™°ï¼ŒåŠŸèƒ½å•ä¸€</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">printWelcomeMessage</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"=== æ¬¢è¿ä½¿ç”¨å­¦ç”Ÿç®¡ç†ç³»ç»Ÿ ==="</span>);
        System.out.println();
    }
    
    <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">calculateSum</span><span class="hljs-params">(<span class="hljs-type">int</span> a, <span class="hljs-type">int</span> b)</span> {
        <span class="hljs-keyword">return</span> a + b;
    }
    
    <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isValidEmail</span><span class="hljs-params">(String email)</span> {
        <span class="hljs-comment">// ç®€å•çš„é‚®ç®±éªŒè¯ï¼ˆå®é™…åº”è¯¥ç”¨æ­£åˆ™è¡¨è¾¾å¼ï¼‰</span>
        <span class="hljs-keyword">return</span> email != <span class="hljs-literal">null</span> &amp;&amp; 
               email.contains(<span class="hljs-string">"@"</span>) &amp;&amp; 
               email.contains(<span class="hljs-string">"."</span>);
    }
    
    <span class="hljs-comment">// å­¦ç”Ÿç®¡ç†ç›¸å…³æ–¹æ³•</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">printStudentHeader</span><span class="hljs-params">(String name)</span> {
        System.out.println(<span class="hljs-string">"å­¦ç”Ÿå§“åï¼š"</span> + name);
        System.out.println(<span class="hljs-string">"------------"</span>);
    }
    
    <span class="hljs-keyword">static</span> <span class="hljs-type">double</span> <span class="hljs-title function_">calculateAverage</span><span class="hljs-params">(<span class="hljs-type">int</span>[] scores)</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">sum</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> score : scores) {
            sum += score;
        }
        <span class="hljs-keyword">return</span> (<span class="hljs-type">double</span>) sum / scores.length;
    }
    
    <span class="hljs-keyword">static</span> String <span class="hljs-title function_">calculateGrade</span><span class="hljs-params">(<span class="hljs-type">double</span> average)</span> {
        <span class="hljs-keyword">if</span> (average &gt;= <span class="hljs-number">90</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">"A"</span>;
        <span class="hljs-keyword">if</span> (average &gt;= <span class="hljs-number">80</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">"B"</span>;
        <span class="hljs-keyword">if</span> (average &gt;= <span class="hljs-number">70</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">"C"</span>;
        <span class="hljs-keyword">if</span> (average &gt;= <span class="hljs-number">60</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">"D"</span>;
        <span class="hljs-keyword">return</span> <span class="hljs-string">"F"</span>;
    }
    
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">printStudentResult</span><span class="hljs-params">(<span class="hljs-type">double</span> average, String grade)</span> {
        System.out.printf(<span class="hljs-string">"å¹³å‡åˆ†ï¼š%.2f\n"</span>, average);
        System.out.println(<span class="hljs-string">"ç­‰çº§ï¼š"</span> + grade);
        System.out.println();
    }
    
    <span class="hljs-comment">// ğŸ“ æ–¹æ³•å‘½åè§„èŒƒï¼š</span>
    <span class="hljs-comment">// 1. åŠ¨è¯å¼€å¤´ï¼šgetã€setã€calculateã€printã€checkç­‰</span>
    <span class="hljs-comment">// 2. é©¼å³°å‘½åæ³•ï¼šcalculateAverageScore</span>
    <span class="hljs-comment">// 3. è§åçŸ¥ä¹‰ï¼šä¸è¦ç”¨aã€bã€cè¿™ç§æ— æ„ä¹‰çš„åå­—</span>
    
    <span class="hljs-comment">// ğŸ“ æ–¹æ³•è®¾è®¡åŸåˆ™ï¼š</span>
    <span class="hljs-comment">// 1. ä¸€ä¸ªæ–¹æ³•åªåšä¸€ä»¶äº‹</span>
    <span class="hljs-comment">// 2. æ–¹æ³•ä¸è¦å¤ªé•¿ï¼ˆä¸€èˆ¬ä¸è¶…è¿‡50è¡Œï¼‰</span>
    <span class="hljs-comment">// 3. å‚æ•°ä¸è¦å¤ªå¤šï¼ˆæœ€å¥½ä¸è¶…è¿‡3ä¸ªï¼‰</span>
    <span class="hljs-comment">// 4. é¿å…å‰¯ä½œç”¨ï¼ˆä¸è¦ä¿®æ”¹ä¸åº”è¯¥ä¿®æ”¹çš„ä¸œè¥¿ï¼‰</span>
}
</code></pre>
<h2 data-id="heading-11">äº”ã€é€’å½’æ–¹æ³•ï¼šè‡ªå·±è°ƒç”¨è‡ªå·±</h2>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RecursionDemo</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        System.out.println(<span class="hljs-string">"=== é€’å½’æ–¹æ³• ===\n"</span>);
        
        <span class="hljs-comment">// é€’å½’ï¼šæ–¹æ³•è‡ªå·±è°ƒç”¨è‡ªå·±</span>
        <span class="hljs-comment">// æ³¨æ„ï¼šå¿…é¡»æœ‰ç»“æŸæ¡ä»¶ï¼Œå¦åˆ™ä¼šæ— é™å¾ªç¯ï¼</span>
        
        System.out.println(<span class="hljs-string">"è®¡ç®—5çš„é˜¶ä¹˜ï¼š"</span>);
        <span class="hljs-type">int</span> <span class="hljs-variable">factorial</span> <span class="hljs-operator">=</span> calculateFactorial(<span class="hljs-number">5</span>);
        System.out.println(<span class="hljs-string">"5! = "</span> + factorial);
        
        System.out.println(<span class="hljs-string">"\nè®¡ç®—æ–æ³¢é‚£å¥‘æ•°åˆ—ï¼š"</span>);
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt;= <span class="hljs-number">10</span>; i++) {
            System.out.println(<span class="hljs-string">"fib("</span> + i + <span class="hljs-string">") = "</span> + fibonacci(i));
        }
        
        System.out.println(<span class="hljs-string">"\né€’å½’å®ç°æ•°å­—å€’åºï¼š"</span>);
        printReverse(<span class="hljs-number">12345</span>);
    }
    
    <span class="hljs-comment">// è®¡ç®—é˜¶ä¹˜ï¼šn! = n Ã— (n-1) Ã— ... Ã— 1</span>
    <span class="hljs-comment">// ä¾‹å¦‚ï¼š5! = 5 Ã— 4 Ã— 3 Ã— 2 Ã— 1 = 120</span>
    <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">calculateFactorial</span><span class="hljs-params">(<span class="hljs-type">int</span> n)</span> {
        <span class="hljs-comment">// ç»“æŸæ¡ä»¶ï¼š0çš„é˜¶ä¹˜æ˜¯1</span>
        <span class="hljs-keyword">if</span> (n == <span class="hljs-number">0</span> || n == <span class="hljs-number">1</span>) {
            System.out.println(<span class="hljs-string">"åˆ°è¾¾ç»“æŸæ¡ä»¶ï¼šfactorial("</span> + n + <span class="hljs-string">") = 1"</span>);
            <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
        } <span class="hljs-keyword">else</span> {
            System.out.println(<span class="hljs-string">"è®¡ç®— factorial("</span> + n + <span class="hljs-string">") = "</span> + n + <span class="hljs-string">" Ã— factorial("</span> + (n-<span class="hljs-number">1</span>) + <span class="hljs-string">")"</span>);
            <span class="hljs-keyword">return</span> n * calculateFactorial(n - <span class="hljs-number">1</span>);
        }
    }
    
    <span class="hljs-comment">// æ–æ³¢é‚£å¥‘æ•°åˆ—ï¼šæ¯ä¸ªæ•°æ˜¯å‰ä¸¤ä¸ªæ•°ä¹‹å’Œ</span>
    <span class="hljs-comment">// fib(0)=0, fib(1)=1, fib(2)=1, fib(3)=2, fib(4)=3, ...</span>
    <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">fibonacci</span><span class="hljs-params">(<span class="hljs-type">int</span> n)</span> {
        <span class="hljs-keyword">if</span> (n == <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (n == <span class="hljs-number">1</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">return</span> fibonacci(n - <span class="hljs-number">1</span>) + fibonacci(n - <span class="hljs-number">2</span>);
        }
    }
    
    <span class="hljs-comment">// é€’å½’æ‰“å°æ•°å­—å€’åº</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">printReverse</span><span class="hljs-params">(<span class="hljs-type">int</span> number)</span> {
        <span class="hljs-keyword">if</span> (number &lt; <span class="hljs-number">10</span>) {
            <span class="hljs-comment">// åªæœ‰ä¸€ä½æ•°ï¼Œç›´æ¥æ‰“å°</span>
            System.out.print(number);
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// æ‰“å°æœ€åä¸€ä½æ•°</span>
            System.out.print(number % <span class="hljs-number">10</span>);
            <span class="hljs-comment">// é€’å½’å¤„ç†å‰©ä¸‹çš„æ•°å­—</span>
            printReverse(number / <span class="hljs-number">10</span>);
        }
    }
}
</code></pre>
<h2 data-id="heading-12">å…­ã€å®ç”¨æ¡ˆä¾‹ï¼šå­¦ç”Ÿæˆç»©ç®¡ç†ç³»ç»Ÿ</h2>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StudentGradeSystem</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        System.out.println(<span class="hljs-string">"=== å­¦ç”Ÿæˆç»©ç®¡ç†ç³»ç»Ÿ ===\n"</span>);
        
        <span class="hljs-comment">// å­¦ç”Ÿæ•°æ®</span>
        String[] names = {<span class="hljs-string">"å¼ ä¸‰"</span>, <span class="hljs-string">"æå››"</span>, <span class="hljs-string">"ç‹äº”"</span>, <span class="hljs-string">"èµµå…­"</span>};
        <span class="hljs-type">int</span>[][] scores = {
            {<span class="hljs-number">85</span>, <span class="hljs-number">90</span>, <span class="hljs-number">78</span>},  <span class="hljs-comment">// å¼ ä¸‰çš„æˆç»©</span>
            {<span class="hljs-number">92</span>, <span class="hljs-number">88</span>, <span class="hljs-number">95</span>},  <span class="hljs-comment">// æå››çš„æˆç»©</span>
            {<span class="hljs-number">76</span>, <span class="hljs-number">85</span>, <span class="hljs-number">90</span>},  <span class="hljs-comment">// ç‹äº”çš„æˆç»©</span>
            {<span class="hljs-number">88</span>, <span class="hljs-number">92</span>, <span class="hljs-number">86</span>}   <span class="hljs-comment">// èµµå…­çš„æˆç»©</span>
        };
        
        <span class="hljs-comment">// å¤„ç†æ¯ä¸ªå­¦ç”Ÿ</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; names.length; i++) {
            processStudent(names[i], scores[i]);
        }
        
        <span class="hljs-comment">// æ‰¾å‡ºæœ€é«˜åˆ†çš„å­¦ç”Ÿ</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">topStudent</span> <span class="hljs-operator">=</span> findTopStudent(names, scores);
        System.out.println(<span class="hljs-string">"\nâ­ æœ€é«˜åˆ†å­¦ç”Ÿï¼š"</span> + topStudent);
        
        <span class="hljs-comment">// ç»Ÿè®¡å„åˆ†æ•°æ®µäººæ•°</span>
        printGradeDistribution(scores);
    }
    
    <span class="hljs-comment">// å¤„ç†å•ä¸ªå­¦ç”Ÿä¿¡æ¯</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processStudent</span><span class="hljs-params">(String name, <span class="hljs-type">int</span>[] studentScores)</span> {
        printDivider();
        System.out.println(<span class="hljs-string">"å­¦ç”Ÿï¼š"</span> + name);
        
        <span class="hljs-type">double</span> <span class="hljs-variable">average</span> <span class="hljs-operator">=</span> calculateAverage(studentScores);
        <span class="hljs-type">String</span> <span class="hljs-variable">grade</span> <span class="hljs-operator">=</span> getGradeLetter(average);
        <span class="hljs-type">String</span> <span class="hljs-variable">status</span> <span class="hljs-operator">=</span> getStatus(average);
        
        System.out.printf(<span class="hljs-string">"å¹³å‡åˆ†ï¼š%.2f\n"</span>, average);
        System.out.println(<span class="hljs-string">"ç­‰çº§ï¼š"</span> + grade);
        System.out.println(<span class="hljs-string">"çŠ¶æ€ï¼š"</span> + status);
        
        printScores(studentScores);
    }
    
    <span class="hljs-comment">// è®¡ç®—å¹³å‡åˆ†</span>
    <span class="hljs-keyword">static</span> <span class="hljs-type">double</span> <span class="hljs-title function_">calculateAverage</span><span class="hljs-params">(<span class="hljs-type">int</span>[] scores)</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">sum</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> score : scores) {
            sum += score;
        }
        <span class="hljs-keyword">return</span> (<span class="hljs-type">double</span>) sum / scores.length;
    }
    
    <span class="hljs-comment">// è·å–ç­‰çº§ï¼ˆA-Fï¼‰</span>
    <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getGradeLetter</span><span class="hljs-params">(<span class="hljs-type">double</span> average)</span> {
        <span class="hljs-keyword">if</span> (average &gt;= <span class="hljs-number">90</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">"A"</span>;
        <span class="hljs-keyword">if</span> (average &gt;= <span class="hljs-number">80</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">"B"</span>;
        <span class="hljs-keyword">if</span> (average &gt;= <span class="hljs-number">70</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">"C"</span>;
        <span class="hljs-keyword">if</span> (average &gt;= <span class="hljs-number">60</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">"D"</span>;
        <span class="hljs-keyword">return</span> <span class="hljs-string">"F"</span>;
    }
    
    <span class="hljs-comment">// è·å–çŠ¶æ€ï¼ˆä¼˜ç§€/è‰¯å¥½ç­‰ï¼‰</span>
    <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getStatus</span><span class="hljs-params">(<span class="hljs-type">double</span> average)</span> {
        <span class="hljs-keyword">if</span> (average &gt;= <span class="hljs-number">90</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">"ä¼˜ç§€"</span>;
        <span class="hljs-keyword">if</span> (average &gt;= <span class="hljs-number">80</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">"è‰¯å¥½"</span>;
        <span class="hljs-keyword">if</span> (average &gt;= <span class="hljs-number">70</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">"ä¸­ç­‰"</span>;
        <span class="hljs-keyword">if</span> (average &gt;= <span class="hljs-number">60</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">"åŠæ ¼"</span>;
        <span class="hljs-keyword">return</span> <span class="hljs-string">"ä¸åŠæ ¼"</span>;
    }
    
    <span class="hljs-comment">// æ‰“å°åˆ†æ•°è¯¦æƒ…</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">printScores</span><span class="hljs-params">(<span class="hljs-type">int</span>[] scores)</span> {
        System.out.print(<span class="hljs-string">"å„ç§‘åˆ†æ•°ï¼š"</span>);
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; scores.length; i++) {
            System.out.print(<span class="hljs-string">"ç§‘ç›®"</span> + (i+<span class="hljs-number">1</span>) + <span class="hljs-string">":"</span> + scores[i]);
            <span class="hljs-keyword">if</span> (i &lt; scores.length - <span class="hljs-number">1</span>) {
                System.out.print(<span class="hljs-string">", "</span>);
            }
        }
        System.out.println();
    }
    
    <span class="hljs-comment">// æ‰¾å‡ºæœ€é«˜åˆ†å­¦ç”Ÿ</span>
    <span class="hljs-keyword">static</span> String <span class="hljs-title function_">findTopStudent</span><span class="hljs-params">(String[] names, <span class="hljs-type">int</span>[][] allScores)</span> {
        <span class="hljs-type">double</span> <span class="hljs-variable">highestAverage</span> <span class="hljs-operator">=</span> -<span class="hljs-number">1</span>;
        <span class="hljs-type">String</span> <span class="hljs-variable">topStudent</span> <span class="hljs-operator">=</span> <span class="hljs-string">""</span>;
        
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; names.length; i++) {
            <span class="hljs-type">double</span> <span class="hljs-variable">average</span> <span class="hljs-operator">=</span> calculateAverage(allScores[i]);
            <span class="hljs-keyword">if</span> (average &gt; highestAverage) {
                highestAverage = average;
                topStudent = names[i];
            }
        }
        
        <span class="hljs-keyword">return</span> topStudent + String.format(<span class="hljs-string">" (%.2fåˆ†)"</span>, highestAverage);
    }
    
    <span class="hljs-comment">// ç»Ÿè®¡åˆ†æ•°åˆ†å¸ƒ</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">printGradeDistribution</span><span class="hljs-params">(<span class="hljs-type">int</span>[][] allScores)</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">excellent</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>, good = <span class="hljs-number">0</span>, medium = <span class="hljs-number">0</span>, pass = <span class="hljs-number">0</span>, fail = <span class="hljs-number">0</span>;
        
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span>[] scores : allScores) {
            <span class="hljs-type">double</span> <span class="hljs-variable">average</span> <span class="hljs-operator">=</span> calculateAverage(scores);
            <span class="hljs-keyword">if</span> (average &gt;= <span class="hljs-number">90</span>) excellent++;
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (average &gt;= <span class="hljs-number">80</span>) good++;
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (average &gt;= <span class="hljs-number">70</span>) medium++;
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (average &gt;= <span class="hljs-number">60</span>) pass++;
            <span class="hljs-keyword">else</span> fail++;
        }
        
        printDivider();
        System.out.println(<span class="hljs-string">"ğŸ“Š åˆ†æ•°åˆ†å¸ƒç»Ÿè®¡ï¼š"</span>);
        System.out.println(<span class="hljs-string">"ä¼˜ç§€ï¼ˆ90+ï¼‰: "</span> + excellent + <span class="hljs-string">"äºº"</span>);
        System.out.println(<span class="hljs-string">"è‰¯å¥½ï¼ˆ80-89ï¼‰: "</span> + good + <span class="hljs-string">"äºº"</span>);
        System.out.println(<span class="hljs-string">"ä¸­ç­‰ï¼ˆ70-79ï¼‰: "</span> + medium + <span class="hljs-string">"äºº"</span>);
        System.out.println(<span class="hljs-string">"åŠæ ¼ï¼ˆ60-69ï¼‰: "</span> + pass + <span class="hljs-string">"äºº"</span>);
        System.out.println(<span class="hljs-string">"ä¸åŠæ ¼ï¼ˆ&lt;60ï¼‰: "</span> + fail + <span class="hljs-string">"äºº"</span>);
    }
    
    <span class="hljs-comment">// æ‰“å°åˆ†éš”çº¿</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">printDivider</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"----------------------------"</span>);
    }
}
</code></pre>
<h2 data-id="heading-13">ä¸ƒã€æ€»ç»“ï¼šæœ€é‡è¦çš„çŸ¥è¯†ç‚¹</h2>
<h3 data-id="heading-14">ğŸ¯ æ ¸å¿ƒè¦ç‚¹æ€»ç»“ï¼š</h3>
<ol>
<li>
<p><strong>æ–¹æ³•æ˜¯ä»£ç çš„ç§¯æœ¨å—</strong>ï¼šæŠŠå¸¸ç”¨çš„ä»£ç å°è£…æˆæ–¹æ³•ï¼Œè®©ç¨‹åºæ›´æ¸…æ™°ã€æ›´æ˜“ç»´æŠ¤</p>
</li>
<li>
<p><strong>æ–¹æ³•ä¸‰è¦ç´ </strong>ï¼š</p>
<ul>
<li><strong>æ–¹æ³•å</strong>ï¼šè¦è§åçŸ¥ä¹‰ï¼Œç”¨åŠ¨è¯å¼€å¤´ï¼ˆå¦‚calculateã€printã€getï¼‰</li>
<li><strong>å‚æ•°åˆ—è¡¨</strong>ï¼šæ–¹æ³•éœ€è¦çš„è¾“å…¥ä¿¡æ¯</li>
<li><strong>è¿”å›å€¼</strong>ï¼šæ–¹æ³•æ‰§è¡Œåç»™å‡ºçš„ç»“æœï¼ˆæ²¡æœ‰è¿”å›å€¼ç”¨voidï¼‰</li>
</ul>
</li>
<li>
<p><strong>æ–¹æ³•è°ƒç”¨</strong>ï¼šä½¿ç”¨æ–¹æ³•ååŠ æ‹¬å·ï¼Œä¼ å…¥éœ€è¦çš„å‚æ•°</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// å®šä¹‰æ–¹æ³•</span>
<span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">add</span><span class="hljs-params">(<span class="hljs-type">int</span> a, <span class="hljs-type">int</span> b)</span> {
    <span class="hljs-keyword">return</span> a + b;
}

<span class="hljs-comment">// è°ƒç”¨æ–¹æ³•</span>
<span class="hljs-type">int</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> add(<span class="hljs-number">5</span>, <span class="hljs-number">3</span>);
</code></pre>
</li>
<li>
<p><strong>æ–¹æ³•é‡è½½</strong>ï¼šåŒä¸€ä¸ªæ–¹æ³•åï¼Œä¸åŒçš„å‚æ•°åˆ—è¡¨</p>
<pre><code class="hljs language-java" lang="java">add(<span class="hljs-number">5</span>, <span class="hljs-number">3</span>);      <span class="hljs-comment">// è°ƒç”¨intç‰ˆæœ¬</span>
add(<span class="hljs-number">5.5</span>, <span class="hljs-number">3.3</span>);  <span class="hljs-comment">// è°ƒç”¨doubleç‰ˆæœ¬</span>
</code></pre>
</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[linuxç«¯è¿›è¡Œkafkaé›†ç¾¤æœåŠ¡çš„æ­å»º]]></title>    <link>https://juejin.cn/post/7585397173023768595</link>    <guid>https://juejin.cn/post/7585397173023768595</guid>    <pubDate>2025-12-20T07:39:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585397173023768595" data-draft-id="7585382553290801188" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="linuxç«¯è¿›è¡Œkafkaé›†ç¾¤æœåŠ¡çš„æ­å»º"/> <meta itemprop="keywords" content="åç«¯"/> <meta itemprop="datePublished" content="2025-12-20T07:39:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="è‹ä¸‰çš„å¼€å‘æ—¥è®°"/> <meta itemprop="url" content="https://juejin.cn/user/4248949048749213"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="æ˜é‡‘"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            linuxç«¯è¿›è¡Œkafkaé›†ç¾¤æœåŠ¡çš„æ­å»º
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4248949048749213/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    è‹ä¸‰çš„å¼€å‘æ—¥è®°
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T07:39:09.000Z" title="Sat Dec 20 2025 07:39:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    é˜…è¯»1åˆ†é’Ÿ
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1.ç¯å¢ƒå˜é‡çš„é…ç½®</h2>
<h5 data-id="heading-1">1.1 ä¿®æ”¹/etc/hosts</h5>
<pre><code class="hljs language-js" lang="js"><span class="hljs-number">192.168</span><span class="hljs-number">.220</span><span class="hljs-number">.102</span> hadoop102
<span class="hljs-number">192.168</span><span class="hljs-number">.220</span><span class="hljs-number">.103</span> hadoop103
<span class="hljs-number">192.168</span><span class="hljs-number">.220</span><span class="hljs-number">.104</span> hadoop104
</code></pre>
<h5 data-id="heading-2">1.2 ä¿®æ”¹/etc/hostname</h5>
<pre><code class="hljs language-js" lang="js">hadoop102
</code></pre>
<h5 data-id="heading-3">1.3 æ·»åŠ æ–‡ä»¶/etc/profile.d/my_env.sh</h5>
<pre><code class="hljs language-js" lang="js">#<span class="hljs-variable constant_">JAVA_HOME</span>
<span class="hljs-keyword">export</span> <span class="hljs-variable constant_">JAVA_HOME</span>=<span class="hljs-regexp">/opt/m</span>odule/jdk1<span class="hljs-number">.8</span><span class="hljs-number">.0_212</span>
<span class="hljs-keyword">export</span> <span class="hljs-variable constant_">PATH</span>=<span class="hljs-attr">$PATH</span>:$JAVA_HOME/bin
#<span class="hljs-variable constant_">HADOOP_HOME</span>
<span class="hljs-keyword">export</span> <span class="hljs-variable constant_">HADOOP_HOME</span>=<span class="hljs-regexp">/opt/m</span>odule/hadoop-<span class="hljs-number">3.1</span><span class="hljs-number">.3</span>
<span class="hljs-keyword">export</span> <span class="hljs-variable constant_">PATH</span>=<span class="hljs-attr">$PATH</span>:$HADOOP_HOME/bin
<span class="hljs-keyword">export</span> <span class="hljs-variable constant_">PATH</span>=<span class="hljs-attr">$PATH</span>:$HADOOP_HOME/sbin
#<span class="hljs-variable constant_">KAFKA_HOME</span>
<span class="hljs-keyword">export</span> <span class="hljs-variable constant_">KAFKA_HOME</span>=<span class="hljs-regexp">/opt/m</span>odule/kafka
<span class="hljs-keyword">export</span> <span class="hljs-variable constant_">PATH</span>=<span class="hljs-attr">$PATH</span>:$KAFKA_HOME/bin

ä¿å­˜ä¹‹å source /etc/profile.<span class="hljs-property">d</span>/my_env.<span class="hljs-property">sh</span>
</code></pre>
<h2 data-id="heading-4">2.SSHä¹‹é—´è¿›è¡Œæ— å¯†ç™»å½•è®¿é—®</h2>
<pre><code class="hljs language-js" lang="js"><span class="hljs-number">1.</span>ä½¿ç”¨hadoop102 è¿›è¡Œæ¼”ç¤º

ç™»å½•è™šæ‹Ÿæœºhadoop102
ssh-keygen -t rsa 
ç„¶åæ•²ï¼ˆä¸‰ä¸ªå›è½¦ï¼‰ï¼Œå°±ä¼šç”Ÿæˆä¸¤ä¸ªæ–‡ä»¶id_rsaï¼ˆç§é’¥ï¼‰ã€id_rsa.<span class="hljs-property">pub</span>ï¼ˆå…¬é’¥ï¼‰

ssh-copy-id hadoop102
ssh-copy-id hadoop103
ssh-copy-id hadoop104
</code></pre>
<h2 data-id="heading-5">3.zookeeperå®‰è£…</h2>
<pre><code class="hljs language-js" lang="js">åœ¨/opt/<span class="hljs-variable language_">module</span>/zookeeper/ç›®å½•ä¸‹åˆ›å»ºzkData
# åˆ›å»ºmyidæ–‡ä»¶å†…å®¹å¦‚ä¸‹
<span class="hljs-number">1</span>

# è¿›å…¥cd /opt/<span class="hljs-variable language_">module</span>/zookeeper/confæ–‡ä»¶ç›®å½•
cd /opt/<span class="hljs-variable language_">module</span>/zookeeper/conf

# ä¿®æ”¹æ–‡ä»¶åç§°
mv zoo_sample.<span class="hljs-property">cfg</span> zoo.<span class="hljs-property">cfg</span>

# ä¿®æ”¹æ–‡ä»¶å†…å®¹
vim zoo.<span class="hljs-property">cfg</span>

# ä»¥ä¸‹å†…å®¹ä¸ºä¿®æ”¹å†…å®¹
dataDir=<span class="hljs-regexp">/opt/m</span>odule/zookeeper/zkData
server<span class="hljs-number">.1</span>=<span class="hljs-attr">hadoop102</span>:<span class="hljs-number">2888</span>:<span class="hljs-number">3888</span>
server<span class="hljs-number">.2</span>=<span class="hljs-attr">hadoop103</span>:<span class="hljs-number">2888</span>:<span class="hljs-number">3888</span>
server<span class="hljs-number">.3</span>=<span class="hljs-attr">hadoop104</span>:<span class="hljs-number">2888</span>:<span class="hljs-number">3888</span>

# è¿›å…¥/opt/<span class="hljs-variable language_">module</span>è·¯å¾„
cd /opt/<span class="hljs-variable language_">module</span>

# è°ƒç”¨åˆ†å‘è„šæœ¬å°†æœ¬æœºå¾—<span class="hljs-title class_">ZooKeeper</span>å®‰è£…åŒ…åˆ†å‘åˆ°å…¶ä»–ä¸¤å°æœºå™¨
xsync zookeeper
</code></pre>
<h2 data-id="heading-6">4.zookeeperå¯åŠ¨è„šæœ¬</h2>
<pre><code class="hljs language-js" lang="js">#!<span class="hljs-regexp">/bin/</span>bash

<span class="hljs-keyword">case</span> $1 <span class="hljs-keyword">in</span>
<span class="hljs-string">"start"</span>){
	<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> hadoop102 hadoop103 hadoop104
	<span class="hljs-keyword">do</span>
        echo ---------- zookeeper $i å¯åŠ¨ ------------
		ssh $i <span class="hljs-string">"/opt/module/zookeeper/bin/zkServer.sh start"</span>
	done
};;
<span class="hljs-string">"stop"</span>){
	<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> hadoop102 hadoop103 hadoop104
	<span class="hljs-keyword">do</span>
        echo ---------- zookeeper $i åœæ­¢ ------------    
		ssh $i <span class="hljs-string">"/opt/module/zookeeper/bin/zkServer.sh stop"</span>
	done
};;
<span class="hljs-string">"status"</span>){
	<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> hadoop102 hadoop103 hadoop104
	<span class="hljs-keyword">do</span>
        echo ---------- zookeeper $i çŠ¶æ€ ------------    
		ssh $i <span class="hljs-string">"/opt/module/zookeeper/bin/zkServer.sh status"</span>
	done
};;
esac
</code></pre>
<h2 data-id="heading-7">5.kafkaå®‰è£…</h2>
<pre><code class="hljs language-js" lang="js">vim server.<span class="hljs-property">properties</span>

#brokerçš„å…¨å±€å”¯ä¸€ç¼–å·ï¼Œæ¯ä¸ªæœåŠ¡èŠ‚ç‚¹ä¸èƒ½é‡å¤ï¼Œåªèƒ½æ˜¯æ•°å­—ã€‚
broker.<span class="hljs-property">id</span>=<span class="hljs-number">1</span> #(hadoop102-&gt;<span class="hljs-number">1</span> hadoop103-&gt;<span class="hljs-number">2</span> hadoop104-&gt;<span class="hljs-number">3</span>)

#brokerå¯¹å¤–æš´éœ²çš„<span class="hljs-variable constant_">IP</span>å’Œç«¯å£ ï¼ˆæ¯ä¸ªèŠ‚ç‚¹å•ç‹¬é…ç½®ï¼‰
advertised.<span class="hljs-property">listeners</span>=<span class="hljs-attr">PLAINTEXT</span>:<span class="hljs-comment">//hadoop102:9092 #(hadoop102-&gt;hadoop102:9092 hadoop103-&gt;hadoop103:9092 hadoop104-&gt;hadoop104:9092)</span>

è·¯å¾„ï¼Œè·¯å¾„ä¸è·¯å¾„ä¹‹é—´å¯ä»¥ç”¨<span class="hljs-string">"ï¼Œ"</span>åˆ†éš”
log.<span class="hljs-property">dirs</span>=<span class="hljs-regexp">/opt/m</span>odule/kafka/datas

#é…ç½®è¿æ¥<span class="hljs-title class_">Zookeeper</span>é›†ç¾¤åœ°å€ï¼ˆåœ¨zkæ ¹ç›®å½•ä¸‹åˆ›å»º/kafkaï¼Œæ–¹ä¾¿ç®¡ç†ï¼‰
zookeeper.<span class="hljs-property">connect</span>=<span class="hljs-attr">hadoop102</span>:<span class="hljs-number">2181</span>,<span class="hljs-attr">hadoop103</span>:<span class="hljs-number">2181</span>,<span class="hljs-attr">hadoop104</span>:<span class="hljs-number">2181</span>/kafka

</code></pre>
<h2 data-id="heading-8">6.kafkaå¯åŠ¨è„šæœ¬</h2>
<pre><code class="hljs language-js" lang="js">#! <span class="hljs-regexp">/bin/</span>bash

<span class="hljs-keyword">case</span> $1 <span class="hljs-keyword">in</span>
<span class="hljs-string">"start"</span>){
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> hadoop102 hadoop103 hadoop104
    <span class="hljs-keyword">do</span>
        echo <span class="hljs-string">" --------å¯åŠ¨ $i Kafka-------"</span>
        ssh $i <span class="hljs-string">"/opt/module/kafka/bin/kafka-server-start.sh -daemon /opt/module/kafka/config/server.properties"</span>
    done
};;
<span class="hljs-string">"stop"</span>){
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> hadoop102 hadoop103 hadoop104
    <span class="hljs-keyword">do</span>
        echo <span class="hljs-string">" --------åœæ­¢ $i Kafka-------"</span>
        ssh $i <span class="hljs-string">"/opt/module/kafka/bin/kafka-server-stop.sh "</span>
    done
};;
esac
</code></pre>
<h2 data-id="heading-9">7.clusterç®¡ç†è„šæœ¬</h2>
<pre><code class="hljs language-js" lang="js">#!<span class="hljs-regexp">/bin/</span>bash

<span class="hljs-keyword">case</span> $1 <span class="hljs-keyword">in</span>
<span class="hljs-string">"start"</span>){
        echo ================== å¯åŠ¨ <span class="hljs-title class_">Kafka</span>é›†ç¾¤ ==================
        #å¯åŠ¨ <span class="hljs-title class_">Zookeeper</span>é›†ç¾¤
        zk.<span class="hljs-property">sh</span> start

        #å¯åŠ¨ <span class="hljs-title class_">Kafka</span>é‡‡é›†é›†ç¾¤
        kafka.<span class="hljs-property">sh</span> start

        };;
<span class="hljs-string">"stop"</span>){
        echo ================== åœæ­¢ <span class="hljs-title class_">Kafka</span>é›†ç¾¤ ==================

        #åœæ­¢ <span class="hljs-title class_">Kafka</span>é‡‡é›†é›†ç¾¤
        kafka.<span class="hljs-property">sh</span> stop

		#å¾ªç¯ç›´è‡³ <span class="hljs-title class_">Kafka</span> é›†ç¾¤è¿›ç¨‹å…¨éƒ¨åœæ­¢
		kafka_count=$(xcall jps | grep <span class="hljs-title class_">Kafka</span> | wc -l)
		<span class="hljs-keyword">while</span> [ $kafka_count -gt <span class="hljs-number">0</span> ]
		<span class="hljs-keyword">do</span>
			sleep <span class="hljs-number">1</span>
			kafka_count=$(xcall | grep <span class="hljs-title class_">Kafka</span> | wc -l)
            echo <span class="hljs-string">"å½“å‰æœªåœæ­¢çš„ Kafka è¿›ç¨‹æ•°ä¸º $kafka_count"</span>
		done

        #åœæ­¢ <span class="hljs-title class_">Zookeeper</span>é›†ç¾¤
        zk.<span class="hljs-property">sh</span> stop
};;
esac
</code></pre>
<h2 data-id="heading-10">8.xcallä¸xsyncè„šæœ¬</h2>
<h5 data-id="heading-11">8.1 xcall</h5>
<pre><code class="hljs language-js" lang="js">#!<span class="hljs-regexp">/bin/</span>bash

# ====== èŠ‚ç‚¹åˆ—è¡¨ï¼ˆæŒ‰ä½ é›†ç¾¤å®é™…ä¿®æ”¹ï¼‰======
<span class="hljs-variable constant_">HOSTS</span>=(<span class="hljs-string">"hadoop102"</span> <span class="hljs-string">"hadoop103"</span> <span class="hljs-string">"hadoop104"</span>)

# ====== å‚æ•°æ ¡éªŒ ======
<span class="hljs-keyword">if</span> [ $# -lt <span class="hljs-number">1</span> ]; then
  echo <span class="hljs-string">"Usage: xcall &lt;command&gt;"</span>
  exit <span class="hljs-number">1</span>
fi

# ====== æ‰§è¡Œ ======
<span class="hljs-keyword">for</span> host <span class="hljs-keyword">in</span> <span class="hljs-string">"${HOSTS[@]}"</span>; <span class="hljs-keyword">do</span>
  echo <span class="hljs-string">"==================== $host ===================="</span>
  ssh $host <span class="hljs-string">"$@"</span>
done
</code></pre>
<h5 data-id="heading-12">8.2 xsync</h5>
<pre><code class="hljs language-js" lang="js">#!<span class="hljs-regexp">/bin/</span>bash

# <span class="hljs-number">1.</span> åˆ¤æ–­å‚æ•°ä¸ªæ•°
<span class="hljs-keyword">if</span> [ $# -lt <span class="hljs-number">1</span> ]; then
    echo <span class="hljs-string">"Not Enough Arguement!"</span>
    exit <span class="hljs-number">1</span>
fi

# <span class="hljs-number">2.</span> éå†é›†ç¾¤æ‰€æœ‰æœºå™¨
<span class="hljs-keyword">for</span> host <span class="hljs-keyword">in</span> hadoop102 hadoop103 hadoop104; <span class="hljs-keyword">do</span>
    echo <span class="hljs-string">"==================== $host ===================="</span>

    # <span class="hljs-number">3.</span> éå†æ‰€æœ‰ç›®å½•ï¼ŒæŒ¨ä¸ªå‘é€
    <span class="hljs-keyword">for</span> file <span class="hljs-keyword">in</span> <span class="hljs-string">"$@"</span>; <span class="hljs-keyword">do</span>
        # <span class="hljs-number">4.</span> åˆ¤æ–­æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        <span class="hljs-keyword">if</span> [ -e <span class="hljs-string">"$file"</span> ]; then
            # <span class="hljs-number">5.</span> è·å–çˆ¶ç›®å½•
            pdir=$(cd -P <span class="hljs-string">"$(dirname "</span>$file<span class="hljs-string">")"</span>; pwd)
            # <span class="hljs-number">6.</span> è·å–å½“å‰æ–‡ä»¶çš„åç§°
            fname=$(basename <span class="hljs-string">"$file"</span>)

            ssh <span class="hljs-string">"$host"</span> <span class="hljs-string">"mkdir -p $pdir"</span>
            rsync -av <span class="hljs-string">"$pdir/$fname"</span> <span class="hljs-string">"$host:$pdir"</span>
        <span class="hljs-keyword">else</span>
            echo <span class="hljs-string">"$file does not exist!"</span>
        fi
    done
done
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[ä»Activity.setContentView()å¼€å§‹]]></title>    <link>https://juejin.cn/post/7585397173023850515</link>    <guid>https://juejin.cn/post/7585397173023850515</guid>    <pubDate>2025-12-20T07:49:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585397173023850515" data-draft-id="7585468725332049974" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="ä»Activity.setContentView()å¼€å§‹"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2025-12-20T07:49:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="StarShip"/> <meta itemprop="url" content="https://juejin.cn/user/3790771820172391"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="æ˜é‡‘"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ä»Activity.setContentView()å¼€å§‹
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3790771820172391/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    StarShip
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T07:49:48.000Z" title="Sat Dec 20 2025 07:49:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    é˜…è¯»3åˆ†é’Ÿ
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">ä¸€ã€ä» Activity.setContentView() å¼€å§‹çš„è°ƒç”¨é“¾</h2>
<pre><code class="hljs language-scss" lang="scss">Activity<span class="hljs-selector-class">.setContentView</span>(layoutId)
    â†“
PhoneWindow<span class="hljs-selector-class">.setContentView</span>(view)
    â†“
åˆ›å»º / è£…é… DecorView
    â†“
WindowManager<span class="hljs-selector-class">.addView</span>(DecorView, params)
    â†“
WindowManagerGlobal<span class="hljs-selector-class">.addView</span>(...)
    â†“
new <span class="hljs-built_in">ViewRootImpl</span>(...)
    â†“
ViewRootImpl<span class="hljs-selector-class">.setView</span>(DecorView, params)
    â†“
<span class="hljs-built_in">requestLayout</span>() â†’ <span class="hljs-built_in">scheduleTraversals</span>()
    â†“
<span class="hljs-built_in">doTraversal</span>() â†’ <span class="hljs-built_in">performMeasure</span>() / <span class="hljs-built_in">performLayout</span>() / <span class="hljs-built_in">performDraw</span>()
    â†“
View æ ‘ <span class="hljs-built_in">onDraw</span>(Canvas)
    â†“
<span class="hljs-selector-tag">Canvas</span> â†’ Skia â†’ (OpenGL ES / è½¯ä»¶æ¸²æŸ“)
    â†“
ç»˜åˆ¶åˆ° Surface çš„ Buffer
</code></pre>
<hr/>
<h2 data-id="heading-1">äºŒã€Activity, Window, DecorViewï¼šç•Œé¢â€œå¤–å£³ç»“æ„â€</h2>
<ol>
<li>
<h3 data-id="heading-2">Activityï¼šé€»è¾‘å…¥å£ + æ‹¥æœ‰ä¸€ä¸ª Window</h3>
</li>
</ol>
<ul>
<li>æ¯ä¸ª Activity å†…éƒ¨éƒ½æŒæœ‰ä¸€ä¸ª Windowï¼ˆé€šå¸¸æ˜¯ <code>PhoneWindow</code>ï¼‰ã€‚</li>
<li>å½“ä½ è°ƒç”¨ï¼šsetContentView(R.layout.activity_main);</li>
</ul>
<p>å…¶å®æ˜¯</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">void</span> <span class="hljs-selector-tag">setContentView</span>(<span class="hljs-variable">@LayoutRes</span> int layoutResID) {
    <span class="hljs-selector-tag">getWindow</span>()<span class="hljs-selector-class">.setContentView</span>(layoutResID); <span class="hljs-comment">// äº¤ç»™ PhoneWindow</span>
}
</code></pre>
<ol start="2">
<li>
<h3 data-id="heading-3">Window / PhoneWindowï¼šç®¡ç† DecorView çš„â€œçª—å£å¯¹è±¡â€</h3>
</li>
</ol>
<ul>
<li>
<p>Window æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼ŒPhoneWindow æ˜¯å¸¸è§å®ç°ã€‚</p>
</li>
<li>
<p>å®ƒè´Ÿè´£ï¼š</p>
<ul>
<li>åˆ›å»ºå¹¶ç®¡ç† DecorViewï¼ˆæ•´ä¸ªçª—å£çš„æ ¹è§†å›¾ï¼‰ï¼›</li>
<li>å¤„ç†æ ‡é¢˜æ ã€çŠ¶æ€æ é€‚é…ç­‰â€œçª—å£è£…é¥°â€ã€‚</li>
</ul>
</li>
</ul>
<p>ç®€åŒ–çš„è°ƒç”¨é“¾ï¼š</p>
<pre><code class="hljs language-scss" lang="scss">Activity<span class="hljs-selector-class">.setContentView</span>()
    â””â”€ PhoneWindow<span class="hljs-selector-class">.setContentView</span>()
            â”œâ”€ <span class="hljs-built_in">ensureDecor</span>()  <span class="hljs-comment">// ç¡®ä¿ DecorView å·²åˆ›å»º</span>
            â”‚     â””â”€ <span class="hljs-built_in">installDecor</span>()
            â”‚          â””â”€ mDecor = new <span class="hljs-built_in">DecorView</span>(...)
            â””â”€ å°† layoutId inflate æˆ Viewï¼Œå¹¶æ·»åŠ åˆ° mDecor çš„ <span class="hljs-attribute">content</span> åŒºåŸŸ
</code></pre>
<ol start="3">
<li>
<h3 data-id="heading-4">DecorView &amp; View / ViewGroupï¼šUI æ ‘ç»“æ„</h3>
</li>
</ol>
<ul>
<li>
<p>DecorViewï¼š</p>
<ul>
<li>ç»§æ‰¿è‡ª ViewGroupï¼›</li>
<li>æ˜¯å½“å‰ Window çš„ æ ¹ Viewï¼›</li>
<li>å†…å«çŠ¶æ€æ /æ ‡é¢˜æ åŒºåŸŸ + å†…å®¹åŒºåŸŸã€‚</li>
</ul>
</li>
<li>
<p>XML å¸ƒå±€æœ€ç»ˆä¼šæˆä¸ºï¼š</p>
</li>
</ul>
<pre><code class="hljs language-scss" lang="scss">DecorView (FrameLayout)
    â””â”€ contentParent (id=android.R.id.content)
          â””â”€ ä½ çš„æ ¹ ViewGroup (ä¾‹å¦‚ ConstraintLayout)
                â””â”€ è‹¥å¹²å­ View / ViewGroup
</code></pre>
<p>è¿™äº› View/ViewGroup è´Ÿè´£åœ¨ä¸‰å¤§é˜¶æ®µä¸­å·¥ä½œï¼š</p>
<ul>
<li><code>onMeasure()</code>ï¼šè®¡ç®—å¤§å°ï¼›</li>
<li><code>onLayout()</code>ï¼šç¡®å®šä½ç½®ï¼›</li>
<li><code>onDraw(Canvas)</code>ï¼šåœ¨ Canvas ä¸Šç”»å‡ºè‡ªå·±ã€‚</li>
</ul>
<p>è¿™ä¸€åˆ‡ç›®å‰ è¿˜åªæ˜¯åœ¨<strong>å†…å­˜ç»“æ„</strong>ä¸Šå»ºç«‹ï¼Œè¿˜æ²¡æœ‰çœŸæ­£â€œå‡ºç°åœ¨å±å¹•ä¸Šâ€ã€‚</p>
<h2 data-id="heading-5">ä¸‰ã€WindowManager / WMS / ViewRootImplï¼šæŠŠ DecorView æŒ‚åˆ°çª—å£ &amp; Surface ä¸Š</h2>
<ol>
<li>
<h3 data-id="heading-6">WindowManagerï¼šåº”ç”¨ä¾§çª—å£ç®¡ç†æ¥å£</h3>
</li>
</ol>
<ul>
<li>Activity å†…å¯ä»¥è°ƒç”¨ <code>getWindowManager()</code> æˆ–ä½¿ç”¨ <code>WindowManager</code> æ·»åŠ /æ›´æ–° Viewï¼ˆå¦‚ Dialogã€Toastï¼‰ã€‚</li>
<li>å½“ <code>PhoneWindow.setContentView()</code> å®Œæˆ DecorView æ„é€ åï¼ŒActivity/ç³»ç»Ÿä¼šè°ƒç”¨ï¼š</li>
</ul>
<pre><code class="hljs language-ini" lang="ini">WindowManager <span class="hljs-attr">wm</span> = getWindowManager()<span class="hljs-comment">;</span>
wm.addView(decorView, layoutParams)<span class="hljs-comment">;</span>
</code></pre>
<ol start="2">
<li>
<h3 data-id="heading-7">WindowManagerGlobal / ViewRootImplï¼šå»ºç«‹ä¸ WMS çš„è¿æ¥</h3>
</li>
</ol>
<p><code>WindowManager.addView()</code> å†…éƒ¨æœ€ç»ˆèµ°åˆ°ï¼š</p>
<pre><code class="hljs language-scss" lang="scss">WindowManagerGlobal<span class="hljs-selector-class">.addView</span>(view, params)
    â”œâ”€ åˆ›å»º ViewRootImpl root = new <span class="hljs-built_in">ViewRootImpl</span>(context, display)
    â”œâ”€ root<span class="hljs-selector-class">.setView</span>(view, params)
    â””â”€ è®°å½• (view â†” root) æ˜ å°„å…³ç³»
</code></pre>
<p>æ­¤æ—¶å‡ ä¸ªå…³é”®ç‚¹ï¼š</p>
<ul>
<li>ViewRootImpl è¢«åˆ›å»ºï¼›</li>
<li>DecorView è¢«äº¤ç»™ ViewRootImpl ç®¡ç†ï¼›</li>
<li>ViewRootImpl é€šè¿‡ Binder ä¸ WMSï¼ˆWindowManagerServiceï¼‰ é€šä¿¡ï¼Œç”³è¯·çª—å£ã€å¸ƒå±€ã€Surface ç­‰ã€‚</li>
</ul>
<ol start="3">
<li>
<h3 data-id="heading-8">WMSï¼ˆWindowManagerServiceï¼‰ï¼šç³»ç»Ÿçº§çª—å£ç®¡ç†</h3>
</li>
</ol>
<p>åœ¨ ç³»ç»Ÿè¿›ç¨‹ ä¸­è¿è¡Œï¼Œç»Ÿä¸€ç®¡ç†æ‰€æœ‰ app çš„çª—å£ï¼š</p>
<ul>
<li>å†³å®šçª—å£çš„ä½ç½®ã€å°ºå¯¸ã€Z è½´é¡ºåºï¼›</li>
<li>ä¸ºçª—å£åˆ†é…/æ›´æ–°å¯¹åº”çš„ Surfaceï¼›</li>
<li>å°†çª—å£ä¿¡æ¯æä¾›ç»™ SurfaceFlinger åˆ·æ–°æ˜¾ç¤ºã€‚</li>
</ul>
<p>å…³ç³»å›¾ï¼ˆç»“æ„è§†è§’ï¼‰ï¼š</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-selector-attr">[ Activity ]</span>
    â””â”€ <span class="hljs-selector-attr">[ Window (PhoneWindow) ]</span>
            â””â”€ <span class="hljs-selector-attr">[ DecorView (ViewGroup æ ¹) ]</span>
                    â†‘
                    â”‚ <span class="hljs-built_in">setContentView</span>()
                    â”‚
<span class="hljs-selector-attr">[ WindowManagerImpl ]</span> (Appè¿›ç¨‹)
    â””â”€ <span class="hljs-selector-attr">[ WindowManagerGlobal ]</span>
            â””â”€ new <span class="hljs-built_in">ViewRootImpl</span>(...)
                    â””â”€ <span class="hljs-built_in">setView</span>(DecorView, params)
                           â†• Binder
                     <span class="hljs-selector-attr">[ WMS (ç³»ç»Ÿè¿›ç¨‹) ]</span>
                           â””â”€ ç®¡ç† Windowã€åˆ†é… Surface
</code></pre>
<h2 data-id="heading-9">å››ã€Surfaceï¼šViewRootImpl ä¸å›¾å½¢ç³»ç»Ÿçš„â€œæ¥ç¼å¤„â€</h2>
<ol>
<li>
<h3 data-id="heading-10">Surfaceï¼šåº•å±‚ç¼“å†²é˜Ÿåˆ—çš„ Java å°è£…</h3>
</li>
</ol>
<ul>
<li>
<p>æ¯ä¸ª Window åœ¨ WMS/SurfaceFlinger ä¾§éƒ½ä¼šæœ‰ä¸€ä¸ª Surface å¯¹åº”ï¼›</p>
</li>
<li>
<p>å¯¹ ViewRootImpl æ¥è¯´ï¼Œå®ƒæŒæœ‰ä¸€ä¸ª <code>Surface mSurface</code>ï¼š</p>
<ul>
<li>è¿™æ˜¯å®ƒç»˜åˆ¶è¾“å‡ºçš„ç›®æ ‡ï¼›</li>
<li>å†…éƒ¨ä¸ BufferQueue å…³è”ï¼Œç”Ÿäº§è€…æ˜¯å½“å‰çª—å£ï¼ˆApp ä¾§ï¼‰ï¼Œæ¶ˆè´¹è€…æ˜¯ SurfaceFlingerã€‚</li>
</ul>
</li>
</ul>
<ol start="2">
<li>
<h3 data-id="heading-11">ViewRootImpl.setView() &amp; requestLayout()</h3>
</li>
</ol>
<p><code>ViewRootImpl.setView()</code> å®Œæˆï¼š</p>
<ul>
<li>ä¿å­˜æ ¹ View = DecorViewï¼›</li>
<li>å‘ WMS æ³¨å†Œçª—å£ï¼›</li>
<li>åˆå§‹åŒ– <code>Surface</code>ï¼›</li>
<li>è°ƒç”¨ <code>requestLayout()</code>ï¼Œè§¦å‘ç¬¬ä¸€æ¬¡æµ‹é‡/å¸ƒå±€/ç»˜åˆ¶ã€‚</li>
</ul>
<p><code>requestLayout()</code> å†…éƒ¨æœ€ç»ˆä¼šèµ°åˆ°ï¼š</p>
<pre><code class="hljs language-scss" lang="scss">ViewRootImpl<span class="hljs-selector-class">.requestLayout</span>()
    â””â”€ <span class="hljs-built_in">scheduleTraversals</span>()
           â””â”€ mChoreographer<span class="hljs-selector-class">.postCallback</span>(TRAVERSAL, mTraversalRunnable, ...)
</code></pre>
<p>è¿™é‡Œå°±å¼•å‡ºäº† Choreographerã€‚</p>
<h2 data-id="heading-12">äº”ã€Choreographer + Handlerï¼šVSync é©±åŠ¨çš„ UI åˆ·æ–°</h2>
<ol>
<li>
<h3 data-id="heading-13">Handler / Looperï¼šæ¶ˆæ¯å¾ªç¯åŸºç¡€</h3>
</li>
</ol>
<ul>
<li>
<p>UI çº¿ç¨‹æ‹¥æœ‰ Looper + MessageQueueï¼›</p>
</li>
<li>
<p>Handler ç”¨æ¥ï¼š</p>
<ul>
<li>å‘é€æ¶ˆæ¯ã€æŠ•é€’ Runnableï¼›</li>
<li>åœ¨ UI çº¿ç¨‹æ‰§è¡Œå„ç§å›è°ƒï¼ˆåŒ…æ‹¬ ViewRootImpl çš„åˆ·æ–°é€»è¾‘ï¼‰ã€‚</li>
</ul>
</li>
</ul>
<ol start="2">
<li>
<h3 data-id="heading-14">Choreographerï¼šåŸºäº VSync çš„å¸§è°ƒåº¦å™¨</h3>
</li>
</ol>
<ul>
<li>
<p>Choreographer æŒ‚åœ¨ UI çº¿ç¨‹ä¸Šï¼›</p>
</li>
<li>
<p><code>scheduleTraversals()</code> ä¼šé€šè¿‡ Choreographer åœ¨ ä¸‹ä¸€ä¸ª VSync æ—¶ æ‰§è¡Œ <code>doTraversal()</code>ï¼Œè€Œä¸æ˜¯ç«‹åˆ»æ‰§è¡Œï¼š</p>
<ul>
<li>è¿™æ ·èƒ½ä¿è¯æ‰€æœ‰ <code>requestLayout()/invalidate()</code> åˆå¹¶åˆ°ä¸‹ä¸€å¸§ç»Ÿä¸€å¤„ç†ï¼›</li>
<li>é¿å…â€œæŠ–åŠ¨â€å’Œæ— æ„ä¹‰é‡å¤ç»˜åˆ¶ã€‚</li>
</ul>
</li>
</ul>
<p>ç®€åŒ–ç‰ˆæ—¶åºï¼š</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">requestLayout</span>() / <span class="hljs-built_in">invalidate</span>()
    â†“
ViewRootImpl<span class="hljs-selector-class">.scheduleTraversals</span>()
    â†“
Choreographer<span class="hljs-selector-class">.postCallback</span>(TRAVERSAL, doTraversal)
    â†“   (ç­‰åˆ°ä¸‹ä¸€æ¬¡ VSync)
Choreographer<span class="hljs-selector-id">#doFrame</span>()
    â””â”€ <span class="hljs-built_in">doTraversal</span>()  <span class="hljs-comment">// æ ¸å¿ƒæ¸²æŸ“æµç¨‹</span>
</code></pre>
<h2 data-id="heading-15">å…­ã€ViewRootImpl.doTraversal()ï¼šä¸‰å¤§æµç¨‹ + Canvas / Skia / OpenGL ES</h2>
<p><code>doTraversal()</code> é‡Œä¼šé¡ºåºæ‰§è¡Œï¼š</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">performMeasure</span>() â†’ <span class="hljs-built_in">performLayout</span>() â†’ <span class="hljs-built_in">performDraw</span>()
</code></pre>
<ol>
<li>
<h3 data-id="heading-16">performMeasure()</h3>
</li>
</ol>
<ul>
<li>
<p>ä» DecorView å¼€å§‹å‘ä¸‹ï¼š</p>
<ul>
<li>è°ƒç”¨æ¯ä¸ª View / ViewGroup çš„ <code>onMeasure()</code>ï¼›</li>
<li>è®¡ç®— width/heightã€‚</li>
</ul>
</li>
</ul>
<ol start="2">
<li>
<h3 data-id="heading-17">performLayout()</h3>
</li>
</ol>
<ul>
<li>
<p>å¯¹æ ¹ View è°ƒç”¨ <code>layout(l, t, r, b)</code>ï¼š</p>
<ul>
<li>ViewGroup ä¼šåœ¨ <code>onLayout()</code> ä¸­å®‰æ’å­ View çš„ä½ç½®ï¼›</li>
<li>æ•´ä¸ªæ ‘çš„å‡ ä½•ç»“æ„ç¡®å®šã€‚</li>
</ul>
</li>
</ul>
<ol start="3">
<li>
<h3 data-id="heading-18">performDraw()ï¼šçœŸæ­£çš„ç»˜åˆ¶</h3>
</li>
</ol>
<p>æ ¸å¿ƒé€»è¾‘ç±»ä¼¼ï¼š</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">performDraw</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// çœç•¥å‰ç½®é€»è¾‘</span>
    <span class="hljs-title function_">draw</span>(fullRedrawNeeded);
}

<span class="hljs-keyword">private</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">draw</span>(<span class="hljs-params"><span class="hljs-built_in">boolean</span> fullRedrawNeeded</span>) {
    <span class="hljs-comment">// è·å–/å‡†å¤‡ Canvas</span>
    <span class="hljs-comment">// è°ƒç”¨ DecorView.draw(canvas)</span>
}
</code></pre>
<p>è°ƒç”¨é“¾ï¼š</p>
<pre><code class="hljs language-scss" lang="scss">ViewRootImpl<span class="hljs-selector-class">.performDraw</span>()
    â””â”€ DecorView<span class="hljs-selector-class">.draw</span>(Canvas)
          â””â”€ <span class="hljs-built_in">drawBackground</span>()
          â””â”€ <span class="hljs-built_in">onDraw</span>(Canvas)
          â””â”€ <span class="hljs-built_in">dispatchDraw</span>(Canvas)  <span class="hljs-comment">// è°ƒå­ View çš„ draw()</span>
                 â””â”€ æ¯ä¸ªå­ View çš„ <span class="hljs-built_in">onDraw</span>(Canvas)
</code></pre>
<ol start="4">
<li>
<h3 data-id="heading-19">Canvas / Skia / OpenGL ES</h3>
</li>
</ol>
<p>åœ¨ <code>onDraw(Canvas)</code> ä¸­ï¼Œå¼€å‘è€…ç”¨ <code>Canvas</code> æä¾›çš„ API ç»˜åˆ¶ï¼š</p>
<pre><code class="hljs language-css" lang="css">protected void onDraw(<span class="hljs-selector-tag">Canvas</span> <span class="hljs-selector-tag">canvas</span>) {
    <span class="hljs-selector-tag">canvas</span><span class="hljs-selector-class">.drawRect</span>(...);
    <span class="hljs-selector-tag">canvas</span><span class="hljs-selector-class">.drawText</span>(...);
    <span class="hljs-selector-tag">canvas</span><span class="hljs-selector-class">.drawBitmap</span>(...);
}
</code></pre>
<p>åº•å±‚å‘ç”Ÿäº†ï¼š</p>
<pre><code class="hljs language-arduino" lang="arduino">Canvas API
    â†“
<span class="hljs-built_in">Skia</span> (<span class="hljs-number">2</span>D å¼•æ“)
    â†“
â€» è‹¥è½¯ä»¶æ¸²æŸ“ï¼šåœ¨ CPU å†…å­˜ buffer ä¸­ç”»åƒç´ 
â€» è‹¥ç¡¬ä»¶åŠ é€Ÿ(HWUI + OpenGL ES/Vulkan)ï¼š
       Skia å°†ç»˜åˆ¶æŒ‡ä»¤è½¬æ¢ä¸º GPU å‘½ä»¤
           â†“
       é€šè¿‡ OpenGL ES / Vulkan è°ƒ GPU æ¸²æŸ“
           â†“
       GPU æŠŠç»“æœå†™å…¥å½“å‰ Surface çš„ buffer
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Cozeç¼–ç¨‹é¦–æµ‹ï¼šæˆ‘ç”¨å¤§ç™½è¯æ­äº†ä¸ªâ€œAIæ¼«å‰§æµæ°´çº¿â€ï¼Œå¤ªç¦»è°±äº†ï¼]]></title>    <link>https://juejin.cn/post/7585463258690600969</link>    <guid>https://juejin.cn/post/7585463258690600969</guid>    <pubDate>2025-12-20T06:04:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585463258690600969" data-draft-id="7585686247269154825" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" Cozeç¼–ç¨‹é¦–æµ‹ï¼šæˆ‘ç”¨å¤§ç™½è¯æ­äº†ä¸ªâ€œAIæ¼«å‰§æµæ°´çº¿â€ï¼Œå¤ªç¦»è°±äº†ï¼"/> <meta itemprop="keywords" content="Coze,äººå·¥æ™ºèƒ½,AIGC"/> <meta itemprop="datePublished" content="2025-12-20T06:04:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="åç«¯å°è‚¥è‚ "/> <meta itemprop="url" content="https://juejin.cn/user/2966945320667536"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="æ˜é‡‘"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             Cozeç¼–ç¨‹é¦–æµ‹ï¼šæˆ‘ç”¨å¤§ç™½è¯æ­äº†ä¸ªâ€œAIæ¼«å‰§æµæ°´çº¿â€ï¼Œå¤ªç¦»è°±äº†ï¼
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2966945320667536/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    åç«¯å°è‚¥è‚ 
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T06:04:49.000Z" title="Sat Dec 20 2025 06:04:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    é˜…è¯»3åˆ†é’Ÿ
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯å°è‚¥è‚ ï¼ä»Šå¤©æˆ‘ä»¬å°†ç¡¬æ ¸å®æˆ˜ <strong>Coze ç¼–ç¨‹</strong>ï¼Œæ‰“é€ ä¸€å¥—å…¨è‡ªåŠ¨çš„ <strong>AI æ¼«å‰§åˆ†é•œå›¾ç‰‡ç”Ÿæˆ</strong> <strong>å·¥ä½œæµ</strong>ã€‚ä»ä¸€æ®µå°è¯´åŸæ–‡åˆ°ç²¾ç¾åˆ†é•œå›¾ä¸€é”®ç›´å‡ºï¼Œå…¨ç¨‹ä¿å§†çº§æ•™ç¨‹ï¼Œå¿«æ¥ç ä½è·Ÿç»ƒï¼Œæ­å»ºå±äºä½ çš„è‡ªåŠ¨åŒ–è§†è§‰æµæ°´çº¿å§~</p>
<h2 data-id="heading-0">1. å‰è¨€</h2>
<p>æœ€è¿‘AIæ¼«å‰§çˆ†ç«ï¼Œæˆ‘ä¹Ÿåœ¨å¸¦ç€ç¤¾ç¾¤çš„æœ‹å‹åšè¿™å—çš„å†…å®¹ï¼Œä¹‹å‰çš„æ–‡ç« å·²ç»è§£å†³äº†AIæ¼«å‰§ç‰ˆæƒçš„é—®é¢˜ï¼š<a href="https://juejin.cn/post/7582561515816484927" target="_blank" title="https://juejin.cn/post/7582561515816484927">çªç ´ LLM æé™ï¼n8n + MemMachine æ‰“é€ â€œæ— é™æµâ€å°è¯´ç”Ÿæˆå™¨</a>ï¼Œ<a href="https://juejin.cn/post/7580378958072610826" target="_blank" title="https://juejin.cn/post/7580378958072610826">é€šåƒç½‘æ–‡æŠ•ç¨¿+AIæ¼«å‰§ç‰ˆæƒï¼æˆ‘ç”¨ n8n+é£ä¹¦æ­äº†ä¸ªâ€œä¸‡å­—çˆ†æ¬¾å°è¯´æµæ°´çº¿â€</a>ã€‚</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/01e81656088d44cf89b833244974ac95~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766815489&amp;x-signature=%2BMocmb7BaaqP31Q06U8EyFWMALg%3D" alt="" loading="lazy"/></p>
<p><strong>ä»Šå¤©å°†ç»™å¤§å®¶å¸¦æ¥è¿›ä¸€æ­¥çš„å†…å®¹ï¼Œå°†å°è¯´åŸæ–‡è½¬æ¢ä¸ºåŠ¨ç”»åˆ†é•œå›¾ï¼Œåªéœ€è¦ç•¥åŠ ä¸€ç‚¹åŠ¨æ€æç¤ºè¯åˆ°AIè§†é¢‘è½¯ä»¶å°±å¯ä»¥äº§å‡ºAIæ¼«å‰§äº†ã€‚</strong></p>
<p><strong>å°±åœ¨æ˜¨å¤©ï¼ŒCoze ç¼–ç¨‹åŠŸèƒ½é‡ç£…å‘å¸ƒï¼Œå®ƒæœ€å¤§çš„é»‘ç§‘æŠ€åœ¨äºæ”¯æŒåŸºäºè‡ªç„¶è¯­è¨€æ­å»º</strong> <strong>å·¥ä½œæµ</strong> <strong>ã€‚</strong> æˆ‘æŠ±ç€è¯•ä¸€è¯•çš„å¿ƒæ€ï¼Œç›´æ¥æŠŠæˆ‘çš„éœ€æ±‚<strong>ä¸¢</strong>ç»™å®ƒï¼Œç»“æœå‡ºä¹æ„æ–™â€”â€”å®ƒç«Ÿç„¶ç§’æ‡‚ï¼Œå¹¶ç›´æ¥å¸®æˆ‘ç”Ÿæˆäº†å®Œæ•´çš„å·¥ä½œæµï¼æ•´ä¸ªè¿‡ç¨‹ä¸æ»‘æ— æ¯”ï¼Œåªéœ€è¦è¾“å…¥å°è¯´å†…å®¹ï¼Œç‚¹å‡»ã€è¯•è¿è¡Œã€‘ï¼Œå‡ åˆ†é’Ÿåï¼Œå¥‘åˆåº¦æé«˜çš„äººç‰©åˆ†é•œå›¾å°±è¯ç”Ÿäº†ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘å°±å¸¦å¤§å®¶å®æ“è¿™å¥—<strong>æœ‰æ‰‹å°±è¡Œ</strong>çš„ AI æ¼«å‰§åˆ†é•œæµã€‚</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dc91b20159e14457975b792c0d0b766b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766815489&amp;x-signature=%2Fj8e5mlULfTwGUKjhCycZa%2F3b6s%3D" alt="" loading="lazy"/></p>
<p>ä¸‹é¢æ­£å¼å¼€å§‹æ•™ç¨‹ï¼Œæ–‡æœ«è¿˜é€å·¥ä½œæµç”Ÿæˆæç¤ºè¯ï¼Œæ„Ÿå…´è¶£å°±ç ä½è·Ÿç»ƒ~</p>
<h2 data-id="heading-1">2. Cozeç¼–ç¨‹å·¥ä½œæµå®ç°</h2>
<p>åŸºäºCozeç¼–ç¨‹åˆ›å»ºaiåŠ¨æ¼«åˆ†é•œç¨¿çš„æ­¥éª¤éå¸¸ç®€å•ï¼Œé¦–å…ˆæ‰“å¼€ç½‘é¡µ<a href="https://link.juejin.cn?target=https%3A%2F%2Fcode.coze.cn%2Fhome%25EF%25BC%258C%25E8%25BE%2593%25E5%2585%25A5%25E6%258F%2590%25E7%25A4%25BA%25E8%25AF%258D%25E5%2590%258E%25E7%2582%25B9%25E5%2587%25BB%25E5%258F%2591%25E9%2580%2581%25E3%2580%2582" target="_blank" title="https://code.coze.cn/home%EF%BC%8C%E8%BE%93%E5%85%A5%E6%8F%90%E7%A4%BA%E8%AF%8D%E5%90%8E%E7%82%B9%E5%87%BB%E5%8F%91%E9%80%81%E3%80%82" ref="nofollow noopener noreferrer">code.coze.cn/homeï¼Œè¾“å…¥æç¤ºè¯åâ€¦</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5b874cff035b4696bee5566273902c78~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766815489&amp;x-signature=J0TRgzsgmdX3WsvVbsWbNBXSi14%3D" alt="" loading="lazy"/></p>
<p><strong>æç¤ºè¯ç¼–å†™æ€è·¯ï¼š</strong></p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> æå–å°è¯´å†…å®¹ç”ŸæˆçŸ­å‰§å‰§æœ¬
<span class="hljs-bullet">2.</span> åŸºäºçŸ­å‰§å‰§æœ¬æ„å»ºè§’è‰²æè¿°
<span class="hljs-bullet">3.</span> ç”Ÿæˆåˆ†é•œæ–‡ç”Ÿå›¾æç¤ºè¯
<span class="hljs-bullet">4.</span> è°ƒç”¨ç”Ÿå›¾æ¨¡å‹ç”Ÿæˆåˆ†é•œå›¾
</code></pre>
<p>åªéœ€è¦æŠŠè¿™å››ç‚¹é€»è¾‘å‘Šè¯‰ Cozeï¼Œå°±å¯ä»¥å¼€å§‹å·¥ä½œæµçš„æ„å»ºäº†ã€‚æ„å»ºå®Œæˆåï¼Œå³ä¾§ç•Œé¢ä¼šè‡ªåŠ¨ç”Ÿæˆå®Œæ•´çš„å·¥ä½œæµï¼š</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/791b103d180d45cbaf70b0394b7f4b72~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766815489&amp;x-signature=7FSFVMQHHtlnMtY3S44L4mZHrFI%3D" alt="" loading="lazy"/></p>
<p>ç‚¹å‡»å³ä¸Šè§’ã€è¯•è¿è¡Œã€‘æŒ‰é’®ï¼Œè¾“å…¥å°è¯´æ–‡æœ¬å†…å®¹åå†ç‚¹å‡»åº•éƒ¨ã€è¯•è¿è¡Œã€‘æŒ‰é’®ï¼Œç­‰å¾…å‡ åˆ†é’Ÿåå°±å¯ä»¥çœ‹åˆ°æˆå“åˆ†é•œå›¾ã€‚</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/375ecebc39764d21a3f89ad5ade3ead3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766815489&amp;x-signature=LEL4dvzfvgPfdYDM7oGSqjEDAzI%3D" alt="" loading="lazy"/></p>
<p>æ‰“å¼€å›¾ç‰‡çœ‹ä¸€ä¸‹ï¼Œ<strong>äººç‰©ä¸€è‡´æ€§</strong>ä¿æŒå¾—å¾ˆä¸é”™ï¼ä¸»è¦æ˜¯æˆ‘å®Œå…¨æ²¡è¿›è¡Œå¤æ‚çš„ç²¾è°ƒï¼Œå…¨æ˜¯ Coze è‡ªåŠ¨ç†è§£ç”Ÿæˆçš„ï¼Œè¿™ä¸ªå¥‘åˆåº¦å·²ç»éå¸¸æƒŠäººäº†ã€‚</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3db1029308e147fc99e03401bb00c8f9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766815489&amp;x-signature=ONcaipd%2BCH%2BEAAbGn1%2FhqGz%2B6i4%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d0fc134d51ec483b9e0278e79502d8a6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766815489&amp;x-signature=8lPFFqpZtE09Ax4abcfRXBXtUuI%3D" alt="" loading="lazy"/></p>
<p>ä»¥ä¸Šå°±æ˜¯æœ¬æœŸæ•™ç¨‹çš„å®Œæ•´å†…å®¹ã€‚æœ¬æ–‡ä¸­ç”Ÿæˆå·¥ä½œæµçš„æç¤ºè¯é™æ—¶æ´¾é€ï¼Œé™é‡30ä»½ï¼Œè¯„è®ºåŒºç•™è¨€aiæ¼«å‰§å³å¯è·å–ã€‚</p>
<h2 data-id="heading-2">3. ç»“è¯­</h2>
<p>è¿™æ¬¡ Coze ç¼–ç¨‹çš„æ›´æ–°ï¼Œæœ€å¤§çš„æ„ä¹‰ä¸åœ¨äºå·¥å…·æœ¬èº«ï¼Œè€Œåœ¨äºå®ƒå†æ¬¡é™ä½äº† AI å†…å®¹åˆ›ä½œçš„é—¨æ§›ã€‚<strong>ä»¥å‰æˆ‘ä»¬éœ€è¦å­¦ä¹ å¦‚ä½•æ­å»º</strong> <strong>å·¥ä½œæµ</strong> <strong>ï¼Œç°åœ¨æˆ‘ä»¬åªéœ€è¦å­¦ä¼šå¦‚ä½•æ¸…æ™°åœ°è¡¨è¾¾éœ€æ±‚ã€‚</strong> æœ¬æ–‡æ­å»ºçš„å·¥ä½œæµå¯¹äºæƒ³åš AI æ¼«å‰§å´è‹¦äºæ²¡æœ‰ç¾æœ¯åŸºç¡€ã€æˆ–è€…è§‰å¾—åˆ†é•œè€—æ—¶å¤ªé•¿çš„æœ‹å‹æ¥è¯´ï¼Œè¿™ç»å¯¹æ˜¯ä¸€ä¸ªææ•ˆåˆ©å™¨ã€‚</p>
<p><strong>å¦‚æœ¬æ¬¡åˆ†äº«å¯¹ä½ æœ‰å¸®åŠ©ï¼Œéº»çƒ¦ä¸€é”®ä¸‰è¿æ”¯æŒä¸€ä¸‹å°è‚¥è‚ ï¼Œæˆ‘ä»¬ä¸‹æœŸå†è§~</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eb8c39c5529840c38aea5bfdfadae0b6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766815489&amp;x-signature=7AKXNIR2fD4oNgW%2BEqtmftvo7P8%3D" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[ã€è½»æ¾æŒæ¡é€šä¿¡åè®®ã€‘C#çš„é€šä¿¡è¿‡ç¨‹ä¸åè®®å®æ“ | 2024å…¨æ–°]]></title>    <link>https://juejin.cn/post/7585382553290473508</link>    <guid>https://juejin.cn/post/7585382553290473508</guid>    <pubDate>2025-12-20T05:58:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585382553290473508" data-draft-id="7585412203978309675" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="ã€è½»æ¾æŒæ¡é€šä¿¡åè®®ã€‘C#çš„é€šä¿¡è¿‡ç¨‹ä¸åè®®å®æ“ | 2024å…¨æ–°"/> <meta itemprop="keywords" content="åç«¯"/> <meta itemprop="datePublished" content="2025-12-20T05:58:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="å­å…ƒyoukeit_xyz"/> <meta itemprop="url" content="https://juejin.cn/user/4469936823730986"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="æ˜é‡‘"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ã€è½»æ¾æŒæ¡é€šä¿¡åè®®ã€‘C#çš„é€šä¿¡è¿‡ç¨‹ä¸åè®®å®æ“ | 2024å…¨æ–°
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4469936823730986/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    å­å…ƒyoukeit_xyz
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T05:58:33.000Z" title="Sat Dec 20 2025 05:58:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    é˜…è¯»4åˆ†é’Ÿ
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>C<strong>QF é‡åŒ–é‡‘èä¸­æ–‡ç‰ˆï¼ˆ23 ç‰ˆï¼‰ç¡¬æ ¸èµ„æ–™ï½œ6 ä¸‡ä»·å€¼ï¼Œé‡åŒ–æŠ•èµ„é€šå…³ç§˜ç±</strong></p>
<p>åœ¨é‡åŒ–é‡‘èçš„ä¸–ç•Œé‡Œï¼Œç†è®ºä¸ä»£ç ä»æ¥ä¸åˆ†å®¶ã€‚CQFï¼ˆCertificate in Quantitative Financeï¼‰ä½œä¸ºå…¨çƒé¡¶å°–çš„é‡åŒ–é‡‘èè®¤è¯è¯¾ç¨‹ï¼Œå…¶æ ¸å¿ƒä¸ä»…åœ¨äºéšæœºå¾®ç§¯åˆ†ã€è¡ç”Ÿå“å®šä»·å’Œé£é™©ç®¡ç†ç­‰é«˜æ·±ç†è®ºï¼Œæ›´åœ¨äºå¦‚ä½•å°†è¿™äº›æ¨¡å‹è½¬åŒ–ä¸ºå¯è¿è¡Œã€å¯éªŒè¯ã€å¯äº¤æ˜“çš„ä»£ç ç³»ç»Ÿã€‚2023 å¹´æ–°ç‰ˆ CQF è¯¾ç¨‹è¿›ä¸€æ­¥å¼ºåŒ–äº†æœºå™¨å­¦ä¹ ã€é«˜é¢‘æ•°æ®å¤„ç†ä¸ Python å·¥ç¨‹å®è·µçš„æ¯”é‡ï¼Œå¯¹å­¦å‘˜çš„ç¼–ç¨‹èƒ½åŠ›æå‡ºäº†æ›´é«˜è¦æ±‚ã€‚</p>
<p>æœ¬æ–‡ç»“åˆã€ŠCQF é‡åŒ–é‡‘èä¸­æ–‡ç‰ˆï¼ˆ23 ç‰ˆï¼‰ã€‹ç¡¬æ ¸èµ„æ–™åŒ…ä¸­çš„æ ¸å¿ƒå†…å®¹ï¼Œé€šè¿‡<strong>çœŸå®ä»£ç ç¤ºä¾‹</strong>ï¼Œå¸¦ä½ ä¸€çª¥é‡åŒ–å»ºæ¨¡çš„å…³é”®ç¯èŠ‚â€”â€”ä» Black-Scholes å®šä»·åˆ°è’™ç‰¹å¡æ´›æ¨¡æ‹Ÿï¼Œå†åˆ°ä½¿ç”¨ LSTM é¢„æµ‹æ³¢åŠ¨ç‡ï¼ŒçœŸæ­£å®ç°â€œç†è®ºè½åœ°ã€ä»£ç é©±åŠ¨â€ã€‚</p>
<hr/>
<h3 data-id="heading-0">ä¸€ã€Black-Scholes æœŸæƒå®šä»·ï¼šç†è®ºçš„ç¬¬ä¸€è¡Œä»£ç </h3>
<p>Black-Scholes æ¨¡å‹æ˜¯ CQF ç¬¬ä¸€æ¨¡å—çš„åŸºçŸ³ã€‚å…¶è§£æè§£è™½ç®€æ´ï¼Œä½†ç†è§£å…¶å®ç°é€»è¾‘è‡³å…³é‡è¦ã€‚</p>
<pre><code class="hljs language-python" lang="python">python
ç¼–è¾‘
<span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
<span class="hljs-keyword">from</span> scipy.stats <span class="hljs-keyword">import</span> norm

<span class="hljs-keyword">def</span> <span class="hljs-title function_">black_scholes_call</span>(<span class="hljs-params">S, K, T, r, sigma</span>):
    <span class="hljs-string">"""
    è®¡ç®—æ¬§å¼çœ‹æ¶¨æœŸæƒçš„ Black-Scholes ä»·æ ¼
    :param S: æ ‡çš„èµ„äº§å½“å‰ä»·æ ¼
    :param K: è¡Œæƒä»·
    :param T: åˆ°æœŸæ—¶é—´ï¼ˆå¹´ï¼‰
    :param r: æ— é£é™©åˆ©ç‡
    :param sigma: æ³¢åŠ¨ç‡
    :return: æœŸæƒä»·æ ¼
    """</span>
    d1 = (np.log(S / K) + (r + <span class="hljs-number">0.5</span> * sigma**<span class="hljs-number">2</span>) * T) / (sigma * np.sqrt(T))
    d2 = d1 - sigma * np.sqrt(T)
    call_price = S * norm.cdf(d1) - K * np.exp(-r * T) * norm.cdf(d2)
    <span class="hljs-keyword">return</span> call_price

<span class="hljs-comment"># ç¤ºä¾‹ï¼šS=100, K=100, T=1å¹´, r=5%, sigma=20%</span>
price = black_scholes_call(<span class="hljs-number">100</span>, <span class="hljs-number">100</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0.05</span>, <span class="hljs-number">0.2</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"Call Option Price: <span class="hljs-subst">{price:<span class="hljs-number">.4</span>f}</span>"</span>)
</code></pre>
<p>è¿™æ®µä»£ç ä¸ä»…æ˜¯å…¬å¼ç¿»è¯‘ï¼Œæ›´æ˜¯åç»­ Greeksï¼ˆDeltaã€Gamma ç­‰ï¼‰è®¡ç®—å’Œå¯¹å†²ç­–ç•¥çš„åŸºç¡€ã€‚CQF èµ„æ–™åŒ…ä¸­æä¾›äº†å®Œæ•´çš„æ•æ„Ÿæ€§åˆ†ææ¨¡æ¿ï¼ŒåŠ©ä½ ç†è§£â€œä¸ºä»€ä¹ˆæ³¢åŠ¨ç‡æ˜¯æœŸæƒçš„å‘½è„‰â€ã€‚</p>
<hr/>
<h3 data-id="heading-1">äºŒã€è’™ç‰¹å¡æ´›æ¨¡æ‹Ÿï¼šä¸ºè·¯å¾„ä¾èµ–å‹è¡ç”Ÿå“å®šä»·</h3>
<p>å¯¹äºäºšå¼æœŸæƒã€å›æœ›æœŸæƒç­‰æ— è§£æè§£çš„äº§å“ï¼Œè’™ç‰¹å¡æ´›æ–¹æ³•æ˜¯ CQF å¼ºè°ƒçš„æ ¸å¿ƒæ•°å€¼æŠ€æœ¯ã€‚</p>
<pre><code class="hljs language-ini" lang="ini">python
ç¼–è¾‘
def monte_carlo_asian_call(S0, K, T, r, sigma, <span class="hljs-attr">N</span>=<span class="hljs-number">1000</span>, M=<span class="hljs-number">10000</span>):
    """
    è’™ç‰¹å¡æ´›æ¨¡æ‹Ÿäºšå¼çœ‹æ¶¨æœŸæƒï¼ˆç®—æœ¯å¹³å‡ï¼‰
    :param N: æ—¶é—´æ­¥æ•°
    :param M: æ¨¡æ‹Ÿè·¯å¾„æ•°
    """
    <span class="hljs-attr">dt</span> = T / N
    <span class="hljs-attr">drift</span> = (r - <span class="hljs-number">0.5</span> * sigma**<span class="hljs-number">2</span>) * dt
    <span class="hljs-attr">diffusion</span> = sigma * np.sqrt(dt)
    
    <span class="hljs-attr">payoffs</span> = []
    for _ in range(M):
        <span class="hljs-attr">path</span> = [S0]
        for _ in range(N):
            <span class="hljs-attr">Z</span> = np.random.normal()
            <span class="hljs-attr">St</span> = path[-<span class="hljs-number">1</span>] * np.exp(drift + diffusion * Z)
            path.append(St)
        <span class="hljs-attr">avg_price</span> = np.mean(path[<span class="hljs-number">1</span>:])  <span class="hljs-comment"># ç®—æœ¯å¹³å‡</span>
        <span class="hljs-attr">payoff</span> = max(avg_price - K, <span class="hljs-number">0</span>)
        payoffs.append(payoff)
    
    <span class="hljs-attr">option_price</span> = np.exp(-r * T) * np.mean(pay<span class="hljs-literal">off</span>s)
    return option_price

<span class="hljs-attr">price_mc</span> = monte_carlo_asian_call(<span class="hljs-number">100</span>, <span class="hljs-number">100</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0.05</span>, <span class="hljs-number">0.2</span>, N=<span class="hljs-number">252</span>, M=<span class="hljs-number">50000</span>)
print(f"Asian Call (MC): {price_mc:.4f}")
</code></pre>
<p>CQF èµ„æ–™åŒ…è¿›ä¸€æ­¥å¼•å…¥<strong>æ–¹å·®ç¼©å‡æŠ€æœ¯</strong>ï¼ˆå¦‚æ§åˆ¶å˜é‡æ³•ã€å¯¹å¶å˜é‡æ³•ï¼‰ï¼Œå°†æ¨¡æ‹Ÿæ•ˆç‡æå‡æ•°å€â€”â€”è¿™æ­£æ˜¯å®æˆ˜ä¸ç©å…·ä»£ç çš„åŒºåˆ«ã€‚</p>
<hr/>
<h3 data-id="heading-2">ä¸‰ã€ç”¨ GARCH æ¨¡å‹åŠ¨æ€é¢„æµ‹æ³¢åŠ¨ç‡</h3>
<p>CQF ç¬¬å››æ¨¡å—æ·±å…¥è®²è§£æ³¢åŠ¨ç‡å»ºæ¨¡ã€‚GARCH(1,1) æ˜¯ä¸šç•Œæ ‡å‡†ï¼Œç”¨äºæ•æ‰æ³¢åŠ¨ç‡èšé›†æ•ˆåº”ã€‚</p>
<pre><code class="hljs language-ini" lang="ini">python
ç¼–è¾‘
import arch

<span class="hljs-comment"># å‡è®¾å·²æœ‰è‚¡ç¥¨æ—¥æ”¶ç›Šç‡åºåˆ— returnsï¼ˆpandas Seriesï¼‰</span>
def fit_garch(returns):
    <span class="hljs-attr">model</span> = arch.arch_model(returns, vol=<span class="hljs-string">'Garch'</span>, p=<span class="hljs-number">1</span>, q=<span class="hljs-number">1</span>, dist=<span class="hljs-string">'Normal'</span>)
    <span class="hljs-attr">fitted</span> = model.fit(disp=<span class="hljs-string">'off'</span>)
    <span class="hljs-attr">forecast</span> = fitted.forecast(horizon=<span class="hljs-number">1</span>)
    <span class="hljs-comment"># é¢„æµ‹æœªæ¥1å¤©çš„æ¡ä»¶æ–¹å·®</span>
    <span class="hljs-attr">cond_vol</span> = np.sqrt(forecast.variance.values[-<span class="hljs-number">1</span>, <span class="hljs-number">0</span>])
    return cond_vol

<span class="hljs-comment"># ç¤ºä¾‹ï¼ˆéœ€çœŸå®æ•°æ®ï¼‰</span>
<span class="hljs-comment"># daily_returns = get_stock_returns('AAPL')</span>
<span class="hljs-comment"># vol_forecast = fit_garch(daily_returns)</span>
<span class="hljs-comment"># print(f"Predicted Volatility: {vol_forecast:.4f}")</span>
</code></pre>
<p>èµ„æ–™åŒ…æä¾›å®Œæ•´ A è‚¡/ç¾è‚¡æ•°æ®è·å–è„šæœ¬ï¼Œå¹¶å¯¹æ¯” GARCH ä¸éšå«æ³¢åŠ¨ç‡ï¼ˆIVï¼‰çš„é¢„æµ‹èƒ½åŠ›ï¼ŒåŠ©ä½ æ„å»ºæ›´ç¨³å¥çš„æœŸæƒäº¤æ˜“ç­–ç•¥ã€‚</p>
<hr/>
<h3 data-id="heading-3">å››ã€LSTM é¢„æµ‹è‚¡ä»·æ–¹å‘ï¼ˆCQF 23 ç‰ˆæ–°å¢ AI æ¨¡å—ï¼‰</h3>
<p>2023 ç‰ˆ CQF æ–°å¢â€œAI in Financeâ€ä¸“é¢˜ï¼Œå¼ºè°ƒæ·±åº¦å­¦ä¹ åœ¨ alpha æŒ–æ˜ä¸­çš„åº”ç”¨ã€‚</p>
<pre><code class="hljs language-ini" lang="ini">python
ç¼–è¾‘
from tensorflow.keras.models import Sequential
from tensorflow.keras.layers import LSTM, Dense
from sklearn.preprocessing import MinMaxScaler

def build_lstm_model(X_train):
    <span class="hljs-attr">model</span> = Sequential([
        LSTM(<span class="hljs-number">50</span>, return_sequences=<span class="hljs-literal">True</span>, input_shape=(X_train.shape[<span class="hljs-number">1</span>], <span class="hljs-number">1</span>)),
        LSTM(<span class="hljs-number">50</span>),
        Dense(<span class="hljs-number">1</span>, activation=<span class="hljs-string">'tanh'</span>)  <span class="hljs-comment"># è¾“å‡º -1 åˆ° 1ï¼Œä»£è¡¨æ¶¨è·Œæ–¹å‘</span>
    ])
    model.compile(<span class="hljs-attr">optimizer</span>=<span class="hljs-string">'adam'</span>, loss=<span class="hljs-string">'mse'</span>)
    return model

<span class="hljs-comment"># æ•°æ®é¢„å¤„ç†ï¼ˆç®€åŒ–ï¼‰</span>
<span class="hljs-attr">scaler</span> = MinMaxScaler()
<span class="hljs-attr">scaled_prices</span> = scaler.fit_transform(price_series.reshape(-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>))

<span class="hljs-comment"># æ„é€  X, yï¼šç”¨è¿‡å»60å¤©é¢„æµ‹ç¬¬61å¤©çš„æ”¶ç›Šç‡ç¬¦å·</span>
X, <span class="hljs-attr">y</span> = [], []
for i in range(60, len(scaled_prices)):
    X.append(scaled_prices<span class="hljs-section">[i-60:i, 0]</span>)
    <span class="hljs-attr">ret</span> = (price_series[i] - price_series[i-<span class="hljs-number">1</span>]) / price_series[i-<span class="hljs-number">1</span>]
    y.append(np.sign(ret))  <span class="hljs-comment"># +1 æˆ– -1</span>

X, <span class="hljs-attr">y</span> = np.array(X), np.array(y)
<span class="hljs-attr">X</span> = np.reshape(X, (X.shape[<span class="hljs-number">0</span>], X.shape[<span class="hljs-number">1</span>], <span class="hljs-number">1</span>))

<span class="hljs-comment"># è®­ç»ƒ</span>
<span class="hljs-attr">model</span> = build_lstm_model(X)
model.fit(X, y, <span class="hljs-attr">epochs</span>=<span class="hljs-number">10</span>, batch_size=<span class="hljs-number">32</span>, verbose=<span class="hljs-number">1</span>)
</code></pre>
<p>CQF èµ„æ–™åŒ…å¼ºè°ƒï¼š<strong>AI ä¸æ˜¯é­”æ³•ï¼Œè€Œæ˜¯ç‰¹å¾å·¥ç¨‹ + ç»æµé€»è¾‘ + ä¸¥è°¨å›æµ‹çš„ç»“åˆä½“</strong>ã€‚è¯¾ç¨‹æä¾›å®Œæ•´çš„å›æµ‹æ¡†æ¶ï¼Œé¿å…â€œè¿‡æ‹Ÿåˆé™·é˜±â€ã€‚</p>
<hr/>
<h3 data-id="heading-4">äº”ã€ä¸ºä»€ä¹ˆè¿™å¥—èµ„æ–™å€¼ 6 ä¸‡å…ƒï¼Ÿ</h3>
<p>ã€ŠCQF é‡åŒ–é‡‘èä¸­æ–‡ç‰ˆï¼ˆ23 ç‰ˆï¼‰ç¡¬æ ¸èµ„æ–™åŒ…ã€‹å¹¶éç®€å•ç¿»è¯‘ï¼Œè€Œæ˜¯ç”±å¤šä½ CQF æŒè¯äººã€å¯¹å†²åŸºé‡‘é‡åŒ–ç ”ç©¶å‘˜è”åˆæ‰“é€ ï¼ŒåŒ…å«ï¼š</p>
<ul>
<li><strong>å…¨å…­æ¨¡å—ç²¾è®²ç¬”è®° + ä¸­æ–‡æ¨å¯¼æ‰‹ç¨¿</strong>ï¼›</li>
<li><strong>200+ Jupyter Notebook å®æˆ˜é¡¹ç›®</strong>ï¼ˆå«ä¸Šè¿°æ‰€æœ‰ä»£ç ï¼‰ï¼›</li>
<li><strong>QuantLibã€Pyfolioã€Backtrader é«˜çº§ç”¨æ³•æŒ‡å—</strong>ï¼›</li>
<li><strong>Final Project é€‰é¢˜åº“ä¸è¯„å®¡æ ‡å‡†</strong>ï¼ˆå¦‚åŠ å¯†è´§å¸æ³¢åŠ¨ç‡æ›²é¢å»ºæ¨¡ã€ESG å› å­å¤šç©ºç­–ç•¥ï¼‰ï¼›</li>
<li><strong>é¢è¯•çœŸé¢˜ä¸ç®€å†ä¼˜åŒ–å»ºè®®</strong>ï¼ˆè¦†ç›– Citadelã€Two Sigmaã€å›½å†…é¡¶çº§ç§å‹Ÿï¼‰ã€‚</li>
</ul>
<p>å¯¹äºç«‹å¿—è¿›å…¥é‡åŒ–äº¤æ˜“ã€é£é™©ç®¡ç†æˆ–é‡‘èç§‘æŠ€é¢†åŸŸçš„ä½ ï¼Œè¿™ä¸ä»…æ˜¯é€šå…³ CQF çš„åˆ©å™¨ï¼Œæ›´æ˜¯è¸å…¥é«˜è–ªè¡Œä¸šçš„æ•²é—¨ç –ã€‚</p>
<hr/>
<h3 data-id="heading-5">ç»“è¯­</h3>
<p>é‡åŒ–é‡‘èçš„æœ¬è´¨ï¼Œæ˜¯ç”¨æ•°å­¦æè¿°å¸‚åœºï¼Œç”¨ä»£ç éªŒè¯é€»è¾‘ï¼Œç”¨çºªå¾‹æ‰§è¡Œç­–ç•¥ã€‚CQF æ•™ç»™ä½ çš„ä¸æ˜¯â€œå¿…èƒœå…¬å¼â€ï¼Œè€Œæ˜¯ä¸€å¥—<strong>ä¸¥è°¨ã€å¯è¯ä¼ªã€å¯è¿­ä»£çš„ç§‘å­¦æ–¹æ³•è®º</strong>ã€‚è€Œã€Š23 ç‰ˆä¸­æ–‡ç¡¬æ ¸èµ„æ–™åŒ…ã€‹ï¼Œå°±æ˜¯å°†è¿™å¥—æ–¹æ³•è®ºä»è‹±æ–‡æ–‡çŒ®ã€å¤æ‚å…¬å¼è½¬åŒ–ä¸ºä½ æŒ‡å°–å¯è¿è¡Œã€å¯è°ƒè¯•ã€å¯ç›ˆåˆ©çš„ç”Ÿäº§åŠ›å·¥å…·ã€‚</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[ESM æ¨¡å—ï¼ˆECMAScript Moduleï¼‰è¯¦è§£]]></title>    <link>https://juejin.cn/post/7585463195200995378</link>    <guid>https://juejin.cn/post/7585463195200995378</guid>    <pubDate>2025-12-20T05:53:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585463195200995378" data-draft-id="7585463258690568201" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="ESM æ¨¡å—ï¼ˆECMAScript Moduleï¼‰è¯¦è§£"/> <meta itemprop="keywords" content="å‰ç«¯"/> <meta itemprop="datePublished" content="2025-12-20T05:53:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ç”¨æˆ·5427784851540"/> <meta itemprop="url" content="https://juejin.cn/user/224762173330942"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="æ˜é‡‘"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ESM æ¨¡å—ï¼ˆECMAScript Moduleï¼‰è¯¦è§£
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/224762173330942/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ç”¨æˆ·5427784851540
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T05:53:52.000Z" title="Sat Dec 20 2025 05:53:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    é˜…è¯»6åˆ†é’Ÿ
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>ECMAScript æ¨¡å—ï¼ˆECMAScript Modulesï¼Œç®€ç§° ESMï¼‰æ˜¯ JavaScript è¯­è¨€å®˜æ–¹æ ‡å‡†åŒ–çš„æ¨¡å—ç³»ç»Ÿï¼Œè‡ª ECMAScript 2015ï¼ˆES6ï¼‰èµ·æ­£å¼å¼•å…¥ï¼Œå¹¶åœ¨åç»­ç‰ˆæœ¬ä¸­ä¸æ–­å®Œå–„ã€‚ä½œä¸ºç°ä»£ Web å¼€å‘çš„åŸºçŸ³ï¼ŒESM ä¸ä»…è§£å†³äº†é•¿æœŸä»¥æ¥ JavaScript ç¼ºä¹åŸç”Ÿæ¨¡å—åŒ–æ”¯æŒçš„é—®é¢˜ï¼Œè¿˜ä¸ºæ„å»ºé«˜æ€§èƒ½ã€å¯ç»´æŠ¤çš„å‰ç«¯å’Œåç«¯åº”ç”¨æä¾›äº†ç»Ÿä¸€æ ‡å‡†ã€‚</p>
<hr/>
<p>Â </p>
<h2 data-id="heading-0">ä¸€ã€JavaScript æ¨¡å—åŒ–çš„å†å²æ¼”è¿›</h2>
<p>åœ¨ ESM å‡ºç°ä¹‹å‰ï¼ŒJavaScript ç¤¾åŒºé•¿æœŸç¼ºä¹å®˜æ–¹æ¨¡å—ç³»ç»Ÿï¼Œå¼€å‘è€…ä¾èµ–å„ç§â€œçº¦å®šâ€æˆ–å·¥å…·å®ç°æ¨¡å—åŒ–ï¼š</p>
<ul>
<li><strong>å…¨å±€å˜é‡æ¨¡å¼</strong>ï¼šå°†åŠŸèƒ½æŒ‚è½½åˆ°å…¨å±€å¯¹è±¡ï¼ˆå¦‚ <code>window.MyLib</code>ï¼‰ï¼Œææ˜“é€ æˆå‘½åå†²çªã€‚</li>
<li><strong>IIFEï¼ˆç«‹å³è°ƒç”¨å‡½æ•°è¡¨è¾¾å¼ï¼‰</strong> ï¼šé€šè¿‡é—­åŒ…å®ç°ç§æœ‰ä½œç”¨åŸŸï¼Œä½†æ— æ³•è·¨æ–‡ä»¶å…±äº«ã€‚</li>
<li><strong>CommonJS</strong>ï¼šNode.js é‡‡ç”¨çš„åŒæ­¥ <code>require/module.exports</code> æ¨¡å¼ï¼Œé€‚åˆæœåŠ¡ç«¯ï¼Œä½†æ— æ³•ç›´æ¥ç”¨äºæµè§ˆå™¨ã€‚</li>
<li><strong>AMDï¼ˆAsynchronous Module Definitionï¼‰</strong> ï¼šå¦‚ RequireJSï¼Œæ”¯æŒå¼‚æ­¥åŠ è½½ï¼Œä½†è¯­æ³•å¤æ‚ã€‚</li>
<li><strong>UMDï¼ˆUniversal Module Definitionï¼‰</strong> ï¼šå…¼å®¹ CommonJSã€AMD å’Œå…¨å±€å˜é‡çš„æ··åˆæ–¹æ¡ˆã€‚</li>
</ul>
<p>è¿™äº›æ–¹æ¡ˆäº’ä¸å…¼å®¹ï¼Œå¯¼è‡´ç”Ÿæ€ç¢ç‰‡åŒ–ã€‚å¼€å‘è€…ä¸å¾—ä¸ä¾èµ–æ‰“åŒ…å·¥å…·ï¼ˆå¦‚ Webpackã€Browserifyï¼‰å°†æ¨¡å—è½¬æ¢ä¸ºç›®æ ‡ç¯å¢ƒå¯æ‰§è¡Œçš„ä»£ç ã€‚è¿™ç§â€œç¼–è¯‘æ—¶æ¨¡å—ç³»ç»Ÿâ€è™½è§£å†³äº†é—®é¢˜ï¼Œä½†ä¹Ÿå¸¦æ¥äº†æ„å»ºå¤æ‚åº¦é«˜ã€å¯åŠ¨æ…¢ç­‰å¼Šç«¯ã€‚</p>
<p>ESM çš„å‡ºç°ï¼Œæ ‡å¿—ç€ JavaScript ç»ˆäºæ‹¥æœ‰äº†<strong>è¯­è¨€å±‚é¢ã€è¿è¡Œæ—¶æ”¯æŒã€è·¨å¹³å°ç»Ÿä¸€</strong>çš„æ¨¡å—æ ‡å‡†ã€‚</p>
<hr/>
<p>Â </p>
<h2 data-id="heading-1">äºŒã€ESM çš„æ ¸å¿ƒè¯­æ³•ä¸ç‰¹æ€§</h2>
<p>ESM é‡‡ç”¨å£°æ˜å¼è¯­æ³•ï¼Œå¼ºè°ƒ<strong>é™æ€ç»“æ„</strong>å’Œ<strong>æ˜¾å¼ä¾èµ–</strong>ã€‚</p>
<h3 data-id="heading-2">1. å¯¼å‡ºï¼ˆExportï¼‰</h3>
<h4 data-id="heading-3">å‘½åå¯¼å‡ºï¼ˆNamed Exportsï¼‰</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// math.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">PI</span> = <span class="hljs-number">3.14159</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">a, b</span>) { <span class="hljs-keyword">return</span> a + b; }
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Calculator</span> { <span class="hljs-comment">/* ... */</span> }


<span class="hljs-comment">// æˆ–æ‰¹é‡å¯¼å‡º</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">subtract</span> = (<span class="hljs-params">a, b</span>) =&gt; a - b;
<span class="hljs-keyword">const</span> <span class="hljs-title function_">multiply</span> = (<span class="hljs-params">a, b</span>) =&gt; a * b;
<span class="hljs-keyword">export</span> { subtract, multiply };
</code></pre>
<h4 data-id="heading-4">é»˜è®¤å¯¼å‡ºï¼ˆDefault Exportï¼‰</h4>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// App.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">App</span> {
  <span class="hljs-comment">// ä¸€ä¸ªæ¨¡å—åªèƒ½æœ‰ä¸€ä¸ª default export</span>
}
</code></pre>
<blockquote>
<p>âœ… <strong>å…³é”®åŒºåˆ«</strong>ï¼šå‘½åå¯¼å‡ºå¯æœ‰å¤šä¸ªï¼Œå¯¼å…¥æ—¶éœ€ç”¨ç›¸åŒåç§°ï¼ˆæˆ–é‡å‘½åï¼‰ï¼Œé»˜è®¤å¯¼å‡ºæ— åç§°ï¼Œå¯¼å…¥æ—¶å¯ä»»æ„å‘½å</p>
</blockquote>
<h3 data-id="heading-5">2. å¯¼å…¥ï¼ˆImportï¼‰</h3>
<h4 data-id="heading-6">å¯¼å…¥å‘½åå¯¼å‡º</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-variable constant_">PI</span>, add } <span class="hljs-keyword">from</span> <span class="hljs-string">'./math.js'</span>;
<span class="hljs-keyword">import</span> { subtract <span class="hljs-keyword">as</span> minus } <span class="hljs-keyword">from</span> <span class="hljs-string">'./math.js'</span>; <span class="hljs-comment">// é‡å‘½å</span>
<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> <span class="hljs-title class_">MathUtils</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./math.js'</span>; <span class="hljs-comment">// å¯¼å…¥æ‰€æœ‰ä¸ºå‘½åç©ºé—´å¯¹è±¡</span>
</code></pre>
<h4 data-id="heading-7">å¯¼å…¥é»˜è®¤å¯¼å‡º</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">App</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./App.js'</span>; <span class="hljs-comment">// æ— éœ€èŠ±æ‹¬å·</span>
</code></pre>
<h4 data-id="heading-8">æ··åˆå¯¼å…¥</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { useState, useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
</code></pre>
<h4 data-id="heading-9">å‰¯ä½œç”¨å¯¼å…¥ï¼ˆä»…æ‰§è¡Œæ¨¡å—ï¼Œä¸å¯¼å…¥ç»‘å®šï¼‰</h4>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">import</span> <span class="hljs-string">'./polyfills.js'</span>; <span class="hljs-comment">// åˆå§‹åŒ–å…¨å±€è¡¥ä¸</span>
</code></pre>
<h3 data-id="heading-10">3. åŠ¨æ€å¯¼å…¥ï¼ˆDynamic Importï¼‰</h3>
<p>ES2020 å¼•å…¥ <code>import()</code> è¡¨è¾¾å¼ï¼Œæ”¯æŒè¿è¡Œæ—¶æŒ‰éœ€åŠ è½½ï¼š</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// æ¡ä»¶åŠ è½½</span>
<span class="hljs-keyword">if</span> (user.<span class="hljs-property">isAdmin</span>) {
  <span class="hljs-keyword">const</span> adminModule = <span class="hljs-keyword">await</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'./admin.js'</span>);
  adminModule.<span class="hljs-title function_">init</span>();
}


<span class="hljs-comment">// è·¯ç”±æ‡’åŠ è½½ï¼ˆReact/Vue ä¸­å¸¸è§ï¼‰</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">HomePage</span> = <span class="hljs-title function_">lazy</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'./HomePage'</span>));
</code></pre>
<blockquote>
<p>âš ï¸ æ³¨æ„ï¼š<code>import()</code> è¿”å› Promiseï¼Œè€Œé™æ€ <code>import</code> å¿…é¡»ä½äºé¡¶å±‚ä½œç”¨åŸŸã€‚</p>
</blockquote>
<hr/>
<p>Â </p>
<h2 data-id="heading-11">ä¸‰ã€ESM çš„æ ¸å¿ƒç‰¹æ€§ä¸è®¾è®¡å“²å­¦</h2>
<h3 data-id="heading-12">1. é™æ€åˆ†æï¼ˆStatic Analyzabilityï¼‰</h3>
<p>ESM çš„ <code>import</code>/<code>export</code> è¯­å¥<strong>å¿…é¡»æ˜¯é¡¶å±‚çš„ã€å­—é¢é‡çš„</strong>ï¼Œä¸èƒ½å‡ºç°åœ¨æ¡ä»¶è¯­å¥æˆ–å‡½æ•°ä¸­ï¼š</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// âŒ éæ³•</span>
<span class="hljs-keyword">if</span> (condition) {
  <span class="hljs-keyword">import</span> utils <span class="hljs-keyword">from</span> <span class="hljs-string">'./utils.js'</span>; <span class="hljs-comment">// SyntaxError</span>
}
</code></pre>
<p>è¿™ä¸€é™åˆ¶ä½¿å¾—å¼•æ“èƒ½åœ¨<strong>ä»£ç æ‰§è¡Œå‰</strong>è§£ææ•´ä¸ªä¾èµ–å›¾ï¼Œå¸¦æ¥ä¸‰å¤§ä¼˜åŠ¿ï¼š</p>
<ul>
<li><strong>Tree Shaking</strong>ï¼šæ‰“åŒ…å·¥å…·å¯ç²¾å‡†ç§»é™¤æœªä½¿ç”¨çš„å¯¼å‡ºï¼ˆå¦‚ Rollupã€Webpackï¼‰</li>
<li><strong>å¾ªç¯ä¾èµ–æ£€æµ‹</strong>ï¼šåœ¨ç¼–è¯‘é˜¶æ®µå‘ç°æ½œåœ¨é—®é¢˜</li>
<li><strong>æ€§èƒ½ä¼˜åŒ–</strong>ï¼šæµè§ˆå™¨å¯å¹¶è¡Œé¢„åŠ è½½ä¾èµ–</li>
</ul>
<h3 data-id="heading-13">2. å®æ—¶ç»‘å®šï¼ˆLive Bindingsï¼‰</h3>
<p>ESM å¯¼å‡ºçš„æ˜¯<strong>ç»‘å®šï¼ˆbindingï¼‰</strong> ï¼Œè€Œéå€¼çš„æ‹·è´ï¼š</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// counter.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">let</span> count = <span class="hljs-number">0</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">increment</span>(<span class="hljs-params"/>) { count++; }


<span class="hljs-comment">// main.js</span>
<span class="hljs-keyword">import</span> { count, increment } <span class="hljs-keyword">from</span> <span class="hljs-string">'./counter.js'</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(count); <span class="hljs-comment">// 0</span>
<span class="hljs-title function_">increment</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(count); <span class="hljs-comment">// 1 â€”â€” è‡ªåŠ¨åŒæ­¥ï¼</span>
</code></pre>
<p>è¿™ä¸ CommonJS çš„â€œå€¼æ‹·è´â€å½¢æˆé²œæ˜å¯¹æ¯”ï¼Œé¿å…äº†çŠ¶æ€ä¸ä¸€è‡´é—®é¢˜ã€‚</p>
<h3 data-id="heading-14">3. å•ä¾‹è¯­ä¹‰ï¼ˆSingleton Semanticsï¼‰</h3>
<p>æ¯ä¸ªæ¨¡å—åœ¨å•ä¸ªè¿è¡Œæ—¶ç¯å¢ƒä¸­<strong>åªæ‰§è¡Œä¸€æ¬¡</strong>ï¼Œåç»­å¯¼å…¥è¿”å›åŒä¸€å®ä¾‹ï¼š</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// config.js</span>
console.<span class="hljs-built_in">log</span>(<span class="hljs-string">'Config loaded!'</span>);
<span class="hljs-keyword">export</span> <span class="hljs-type">const</span> settings = { theme: <span class="hljs-string">'dark'</span> };


<span class="hljs-comment">// a.js å’Œ b.js éƒ½ import config.js</span>
<span class="hljs-comment">// "Config loaded!" ä»…æ‰“å°ä¸€æ¬¡</span>
</code></pre>
<p>è¿™ä¿è¯äº†æ¨¡å—çŠ¶æ€çš„å…¨å±€å”¯ä¸€æ€§ï¼Œé€‚ç”¨äºé…ç½®ã€ç¼“å­˜ç­‰åœºæ™¯ã€‚</p>
<hr/>
<p>Â </p>
<h2 data-id="heading-15">å››ã€ESM åœ¨æµè§ˆå™¨ä¸­çš„è¿è¡Œæœºåˆ¶</h2>
<h3 data-id="heading-16">1. å¯ç”¨æ–¹å¼</h3>
<p>åœ¨ HTML ä¸­é€šè¿‡ <code>&lt;script type="module"&gt;</code> å¯ç”¨ï¼š</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"module"</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"./main.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-comment">&lt;!-- æˆ–å†…è” --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"module"</span>&gt;</span><span class="javascript">
  <span class="hljs-keyword">import</span> { greet } <span class="hljs-keyword">from</span> <span class="hljs-string">'./utils.js'</span>;
  <span class="hljs-title function_">greet</span>();
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<blockquote>
</blockquote>
<blockquote>
<p>ğŸ”’ <strong>å®‰å…¨é™åˆ¶</strong>ï¼š</p>
</blockquote>
<blockquote>
</blockquote>
<blockquote>
<p>æ¨¡å—è„šæœ¬é»˜è®¤å¯ç”¨ <strong>CORS</strong>ï¼Œè·¨åŸŸéœ€æœåŠ¡å™¨è®¾ç½® <code>Access-Control-Allow-Origin</code></p>
</blockquote>
<blockquote>
<p>æ— æ³•åœ¨ <code>file://</code> åè®®ä¸‹è¿è¡Œï¼ˆéœ€æœ¬åœ°æœåŠ¡å™¨ï¼‰</p>
</blockquote>
<blockquote>
</blockquote>
<h3 data-id="heading-17">2. åŠ è½½ä¸æ‰§è¡Œæµç¨‹</h3>
<p>å½“æµè§ˆå™¨é‡åˆ°æ¨¡å—è„šæœ¬æ—¶ï¼š</p>
<ol>
<li><strong>è§£æä¾èµ–</strong>ï¼šé€’å½’è§£ææ‰€æœ‰ <code>import</code> è¯­å¥ï¼Œæ„å»ºä¾èµ–å›¾</li>
<li><strong>å¹¶è¡Œä¸‹è½½</strong>ï¼šé€šè¿‡ HTTP/2 å¤šè·¯å¤ç”¨å¹¶è¡Œè¯·æ±‚æ‰€æœ‰æ¨¡å—</li>
<li><strong>æ‹“æ‰‘æ’åº</strong>ï¼šæŒ‰ä¾èµ–é¡ºåºç¡®å®šæ‰§è¡Œé¡ºåºï¼ˆæ— ä¾èµ–çš„å…ˆæ‰§è¡Œï¼‰</li>
<li><strong>æ‰§è¡Œæ¨¡å—</strong>ï¼šæ¯ä¸ªæ¨¡å—ä»…æ‰§è¡Œä¸€æ¬¡ï¼Œå¯¼å‡ºç»‘å®šä¾›å…¶ä»–æ¨¡å—ä½¿ç”¨</li>
</ol>
<blockquote>
</blockquote>
<blockquote>
<p>ğŸ’¡ <strong>æ€§èƒ½ä¼˜åŠ¿</strong>ï¼š æ— éœ€æ‰“åŒ…å³å¯æŒ‰éœ€åŠ è½½ï¼Œæµè§ˆå™¨ç¼“å­˜ç²’åº¦æ›´ç»†ï¼ˆå•ä¸ªæ¨¡å—çº§åˆ«ï¼‰</p>
</blockquote>
<h3 data-id="heading-18">3. MIME ç±»å‹è¦æ±‚</h3>
<p>æœåŠ¡å™¨å¿…é¡»ä¸º <code>.js</code> æ–‡ä»¶è¿”å›æ­£ç¡®çš„ MIME ç±»å‹ï¼š</p>
<pre><code class="hljs language-bash" lang="bash">Content-Type: application/javascript
</code></pre>
<p>å¦åˆ™æµè§ˆå™¨ä¼šæ‹’ç»æ‰§è¡Œã€‚</p>
<hr/>
<p>Â </p>
<h2 data-id="heading-19">äº”ã€ESM åœ¨ Node.js ä¸­çš„æ”¯æŒ</h2>
<p>Node.js è‡ª v12 èµ·åŸç”Ÿæ”¯æŒ ESMï¼Œä½†éœ€æ³¨æ„ä¸ CommonJS çš„äº’æ“ä½œæ€§ã€‚</p>
<h3 data-id="heading-20">1. å¯ç”¨æ–¹å¼</h3>
<ul>
<li>æ–‡ä»¶æ‰©å±•å <code>.mjs</code></li>
<li>æˆ–åœ¨ <code>package.json</code> ä¸­è®¾ç½® <code>"type": "module"</code></li>
<li>æˆ–ä½¿ç”¨ <code>--input-type=module</code> æ ‡å¿—è¿è¡Œå­—ç¬¦ä¸²ä»£ç </li>
</ul>
<h3 data-id="heading-21">2. ä¸ CommonJS äº’æ“ä½œ</h3>
<h4 data-id="heading-22">ESM å¯¼å…¥ CommonJS</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// CommonJS æ¨¡å—å¯¼å‡ºçš„æ˜¯ module.exports å¯¹è±¡</span>
<span class="hljs-keyword">import</span> pkg <span class="hljs-keyword">from</span> <span class="hljs-string">'lodash'</span>; <span class="hljs-comment">// é»˜è®¤å¯¼å…¥æ•´ä¸ªå¯¹è±¡</span>
<span class="hljs-keyword">import</span> { debounce } <span class="hljs-keyword">from</span> <span class="hljs-string">'lodash'</span>; <span class="hljs-comment">// å‘½åå¯¼å…¥ï¼ˆéœ€æ”¯æŒï¼‰</span>
</code></pre>
<blockquote>
<p>âš ï¸ é™åˆ¶ï¼šCommonJS æ¨¡å—çš„åŠ¨æ€å±æ€§æ— æ³•è¢«é™æ€åˆ†æï¼Œå‘½åå¯¼å…¥å¯èƒ½å¤±è´¥ã€‚</p>
</blockquote>
<h4 data-id="heading-23">CommonJS å¯¼å…¥ ESMï¼ˆNode.js v14.13+ï¼‰</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ä½¿ç”¨ async/await</span>
<span class="hljs-keyword">const</span> myModule = <span class="hljs-keyword">await</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'./my-esm-module.js'</span>);
</code></pre>
<h3 data-id="heading-24">3. è·¯å¾„è§£æå·®å¼‚</h3>
<p>ESM <strong>å¿…é¡»ä½¿ç”¨å®Œæ•´è·¯å¾„</strong>ï¼ˆåŒ…æ‹¬æ‰©å±•åï¼‰ï¼š</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// âœ… æ­£ç¡®</span>
<span class="hljs-keyword">import</span> { foo } <span class="hljs-keyword">from</span> <span class="hljs-string">'./foo.js'</span>;
<span class="hljs-keyword">import</span> { bar } <span class="hljs-keyword">from</span> <span class="hljs-string">'./bar/index.js'</span>;


<span class="hljs-comment">// âŒ é”™è¯¯ï¼ˆNode.js ä¸è‡ªåŠ¨è¡¥å…¨ .jsï¼‰</span>
<span class="hljs-keyword">import</span> { foo } <span class="hljs-keyword">from</span> <span class="hljs-string">'./foo'</span>;
</code></pre>
<blockquote>
<p>ğŸ›  è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨ <code>--experimental-specifier-resolution=node</code> æˆ–æ„å»ºå·¥å…·å¤„ç†ã€‚</p>
</blockquote>
<hr/>
<p>Â </p>
<h2 data-id="heading-25">å…­ã€ESM vs CommonJSï¼šå…³é”®å·®å¼‚å¯¹æ¯”</h2>








































<table><thead><tr><th>ç‰¹æ€§</th><th>ESM</th><th>CommonJS</th></tr></thead><tbody><tr><td><strong>åŠ è½½æ—¶æœº</strong></td><td>å¼‚æ­¥ï¼ˆæµè§ˆå™¨å¹¶è¡ŒåŠ è½½ï¼‰</td><td>åŒæ­¥ï¼ˆNode.js é€è¡Œæ‰§è¡Œï¼‰</td></tr><tr><td><strong>å¯¼å‡ºæœ¬è´¨</strong></td><td>å®æ—¶ç»‘å®šï¼ˆLive Bindingï¼‰</td><td>å€¼æ‹·è´ï¼ˆCopy of Valueï¼‰</td></tr><tr><td><strong>this æŒ‡å‘</strong></td><td>undefined</td><td>module.exports</td></tr><tr><td><strong>å¾ªç¯ä¾èµ–</strong></td><td>æ”¯æŒï¼ˆç»‘å®šæœªåˆå§‹åŒ–æ—¶ä¸º undefinedï¼‰</td><td>æ”¯æŒï¼ˆè¿”å›éƒ¨åˆ†åˆå§‹åŒ–å¯¹è±¡ï¼‰</td></tr><tr><td><strong>Tree Shaking</strong></td><td>åŸç”Ÿæ”¯æŒ</td><td>éœ€å·¥å…·æ¨¡æ‹Ÿ</td></tr><tr><td><strong>é¡¶å±‚ await</strong></td><td>æ”¯æŒï¼ˆES2022ï¼‰</td><td>ä¸æ”¯æŒï¼ˆéœ€ IIFE åŒ…è£¹ï¼‰</td></tr></tbody></table>
<hr/>
<p>Â </p>
<h2 data-id="heading-26">ä¸ƒã€ESM çš„å®é™…åº”ç”¨åœºæ™¯</h2>
<h3 data-id="heading-27">1. å‰ç«¯å¼€å‘ï¼šViteã€Snowpack ç­‰ç°ä»£æ„å»ºå·¥å…·</h3>
<p>Vite åˆ©ç”¨æµè§ˆå™¨åŸç”Ÿ ESMï¼Œå®ç°<strong>æ— æ‰“åŒ…å¼€å‘</strong>ï¼š</p>
<ul>
<li>å¼€å‘é˜¶æ®µç›´æ¥ serve æºç </li>
<li>ä¾èµ–é¢„æ„å»ºä¸º ESM</li>
<li>HMR åŸºäºæ¨¡å—å›¾ç²¾å‡†æ›´æ–°</li>
</ul>
<h3 data-id="heading-28">2. å¾®å‰ç«¯æ¶æ„</h3>
<p>é€šè¿‡åŠ¨æ€ <code>import()</code> å®ç°å­åº”ç”¨æŒ‰éœ€åŠ è½½ï¼š</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">loadMicroApp</span> = async (name) =&gt; {
  const <span class="hljs-attr">app</span> = await import(`https://cdn.com/<span class="hljs-variable">${name}</span>/entry.js`)<span class="hljs-comment">;</span>
  app.bootstrap()<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>
</code></pre>
<h3 data-id="heading-29">3. CDN ç›´æ¥åˆ†å‘</h3>
<p>ç°ä»£ CDNï¼ˆå¦‚ Skypackã€esm.shï¼‰å°† npm åŒ…è‡ªåŠ¨è½¬æ¢ä¸º ESMï¼š</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'https://esm.sh/react'</span>;
<span class="hljs-keyword">import</span> { createRoot } <span class="hljs-keyword">from</span> <span class="hljs-string">'https://esm.sh/react-dom/client'</span>;
</code></pre>
<h3 data-id="heading-30">4. Web Workers ä¸ Service Workers</h3>
<p>Workers æ”¯æŒ ESM æ¨¡å—ï¼š</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// ä¸»çº¿ç¨‹</span>
<span class="hljs-keyword">const</span> worker = <span class="hljs-built_in">new</span> Worker(<span class="hljs-string">'./worker.js'</span>, { <span class="hljs-keyword">type</span>: <span class="hljs-string">'module'</span> });


<span class="hljs-comment">// worker.js</span>
<span class="hljs-keyword">import</span> { heavyTask } from <span class="hljs-string">'./utils.js'</span>;
</code></pre>
<hr/>
<p>Â </p>
<h2 data-id="heading-31">å…«ã€æœªæ¥å±•æœ›</h2>
<p>ESM ç”Ÿæ€ä»åœ¨å¿«é€Ÿå‘å±•ï¼š</p>
<p><strong>Import Maps</strong>ï¼šå…è®¸åœ¨ HTML ä¸­å®šä¹‰æ¨¡å—æ ‡è¯†ç¬¦æ˜ å°„ï¼Œè§£å†³è£¸æ¨¡å—ï¼ˆbare specifiersï¼‰é—®é¢˜</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"importmap"</span>&gt;</span><span class="javascript">
{
  <span class="hljs-string">"imports"</span>: {
    <span class="hljs-string">"lodash"</span>: <span class="hljs-string">"/node_modules/lodash-es/lodash.js"</span>
  }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<ul>
<li/>
<li><strong>Top-Level Await</strong>ï¼šå·²åœ¨ ES2022 æ ‡å‡†åŒ–ï¼Œç®€åŒ–å¼‚æ­¥æ¨¡å—åˆå§‹åŒ–</li>
<li><strong>JSON Modules</strong>ï¼šææ¡ˆé˜¶æ®µï¼Œå…è®¸ç›´æ¥ <code>import data from './config.json'</code></li>
</ul>
<hr/>
<p>Â </p>
<h2 data-id="heading-32">ç»“è¯­</h2>
<p>ECMAScript æ¨¡å—ä¸ä»…æ˜¯ JavaScript è¯­è¨€çš„ä¸€æ¬¡é‡è¦è¿›åŒ–ï¼Œæ›´æ˜¯ç°ä»£ Web å¼€å‘ç”Ÿæ€çš„åŸºç¡€è®¾æ–½ã€‚å®ƒé€šè¿‡é™æ€åˆ†æã€å®æ—¶ç»‘å®šã€å•ä¾‹è¯­ä¹‰ç­‰è®¾è®¡ï¼Œä¸ºæ„å»ºé«˜æ€§èƒ½ã€å¯ç»´æŠ¤çš„åº”ç”¨æä¾›äº†åšå®åŸºç¡€ã€‚éšç€æµè§ˆå™¨å’Œ Node.js çš„å…¨é¢æ”¯æŒï¼Œä»¥åŠ Vite ç­‰å·¥å…·çš„æ™®åŠï¼ŒESM æ­£é€æ­¥å–ä»£å†å²é—ç•™çš„æ¨¡å—æ–¹æ¡ˆï¼Œæˆä¸ºäº‹å®ä¸Šçš„æ ‡å‡†ã€‚</p>
<p>å¯¹äºå¼€å‘è€…è€Œè¨€ï¼Œæ·±å…¥ç†è§£ ESM çš„å·¥ä½œæœºåˆ¶ï¼Œä¸ä»…èƒ½å†™å‡ºæ›´é«˜æ•ˆçš„ä»£ç ï¼Œæ›´èƒ½å……åˆ†åˆ©ç”¨ç°ä»£å·¥å…·é“¾çš„ä¼˜åŠ¿ï¼Œåœ¨å·¥ç¨‹åŒ–å®è·µä¸­æ¸¸åˆƒæœ‰ä½™ã€‚æ­£å¦‚ TC39 å§”å‘˜ä¼šæ‰€å€¡å¯¼çš„ï¼šâ€œESM is the future of JavaScript modularity.â€ â€”â€” æ‹¥æŠ± ESMï¼Œå°±æ˜¯æ‹¥æŠ± JavaScript çš„æœªæ¥ã€‚</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Nginx ä¸ºä»€ä¹ˆèƒ½è¿›è¡Œé™æ€èµ„æºæ‰˜ç®¡]]></title>    <link>https://juejin.cn/post/7585706951583186953</link>    <guid>https://juejin.cn/post/7585706951583186953</guid>    <pubDate>2025-12-20T05:59:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585706951583186953" data-draft-id="7585706951583170569" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Nginx ä¸ºä»€ä¹ˆèƒ½è¿›è¡Œé™æ€èµ„æºæ‰˜ç®¡"/> <meta itemprop="keywords" content="Nginx"/> <meta itemprop="datePublished" content="2025-12-20T05:59:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ç”¨æˆ·5427784851540"/> <meta itemprop="url" content="https://juejin.cn/user/224762173330942"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="æ˜é‡‘"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Nginx ä¸ºä»€ä¹ˆèƒ½è¿›è¡Œé™æ€èµ„æºæ‰˜ç®¡
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/224762173330942/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ç”¨æˆ·5427784851540
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T05:59:37.000Z" title="Sat Dec 20 2025 05:59:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    é˜…è¯»4åˆ†é’Ÿ
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Nginx æœ¬è´¨æ˜¯ä¸€ä¸ª<strong>é«˜æ€§èƒ½çš„ HTTP æœåŠ¡å™¨</strong>ï¼Œå…¶æ ¸å¿ƒèƒ½åŠ›ä¹‹ä¸€å°±æ˜¯ç›´æ¥è¯»å–æœåŠ¡å™¨æœ¬åœ°æ–‡ä»¶å¹¶é€šè¿‡ HTTP åè®®è¿”å›ç»™å®¢æˆ·ç«¯ã€‚å…·ä½“æ¥è¯´ï¼Œå®ƒé€šè¿‡ä»¥ä¸‹æœºåˆ¶å®ç°é™æ€èµ„æºæ‰˜ç®¡ï¼š</p>
<h4 data-id="heading-0">1.Â <strong>äº‹ä»¶é©±åŠ¨æ¶æ„ï¼ˆéé˜»å¡ I/Oï¼‰</strong></h4>
<p>Nginx é‡‡ç”¨Â <strong>epoll/kqueue</strong>Â ç­‰ I/O å¤šè·¯å¤ç”¨æŠ€æœ¯ï¼Œèƒ½åœ¨å•ä¸ªè¿›ç¨‹å†…é«˜æ•ˆå¤„ç†<strong>æ•°ä¸‡å¹¶å‘è¿æ¥</strong>ï¼Œè€Œä¸ä¼šä¸ºæ¯ä¸ªè¿æ¥åˆ›å»ºæ–°è¿›ç¨‹/çº¿ç¨‹ï¼ˆé¿å…èµ„æºå¼€é”€ï¼‰ã€‚</p>
<ul>
<li><strong>å¯¹æ¯” Apache</strong>ï¼šä¼ ç»Ÿ Apache é‡‡ç”¨å¤šè¿›ç¨‹/å¤šçº¿ç¨‹æ¨¡å‹ï¼Œå¹¶å‘é‡é«˜æ—¶ä¼šå› è¿›ç¨‹åˆ‡æ¢å¯¼è‡´æ€§èƒ½ä¸‹é™ã€‚</li>
<li><strong>ä¼˜åŠ¿</strong>ï¼šå¤„ç†é™æ€èµ„æºæ—¶ï¼ŒNginx èƒ½ä»¥æå°çš„å†…å­˜å ç”¨å’Œ CPU æ¶ˆè€—æ”¯æŒé«˜å¹¶å‘è¯·æ±‚ã€‚</li>
</ul>
<h4 data-id="heading-1">2.Â <strong>æ–‡ä»¶ç³»ç»Ÿç›´æ¥è¯»å–</strong></h4>
<p>Nginx å¯ç›´æ¥æ“ä½œæœåŠ¡å™¨æ–‡ä»¶ç³»ç»Ÿï¼Œé€šè¿‡é…ç½®Â <code>root</code>Â æˆ–Â <code>alias</code>Â æŒ‡ä»¤æŒ‡å®šé™æ€èµ„æºç›®å½•ï¼Œä¾‹å¦‚ï¼š</p>
<pre><code class="hljs language-bash" lang="bash">server {
  root /usr/local/frontend/dist; <span class="hljs-comment"># é™æ€èµ„æºæ ¹ç›®å½•</span>
  location /images/ {
    <span class="hljs-built_in">alias</span> /data/pictures/; <span class="hljs-comment"># åˆ«åç›®å½•ï¼ˆä¸ root åŒºåˆ«ï¼šä¼šæ›¿æ¢ URL ä¸­çš„ /images/ï¼‰</span>
  }
}
</code></pre>
<p>å½“å®¢æˆ·ç«¯è¯·æ±‚Â <code>http://example.com/index.html</code>Â æ—¶ï¼ŒNginx ä¼šç›´æ¥è¯»å–Â <code>/usr/local/frontend/dist/index.html</code>Â å¹¶è¿”å›ã€‚</p>
<h4 data-id="heading-2">3.Â <strong>HTTP åè®®å®ç°</strong></h4>
<p>Nginx å†…ç½®å®Œæ•´çš„ HTTP åè®®è§£æå™¨ï¼Œèƒ½æ­£ç¡®å¤„ç†ï¼š</p>
<ul>
<li>è¯·æ±‚æ–¹æ³•ï¼ˆGET/HEAD ç­‰ï¼Œé™æ€èµ„æºå¸¸ç”¨ GETï¼‰</li>
<li>è¯·æ±‚å¤´ï¼ˆå¦‚Â <code>Range</code>Â æ–­ç‚¹ç»­ä¼ ï¼‰</li>
<li>å“åº”å¤´ï¼ˆå¦‚Â <code>Content-Type</code>ã€<code>Cache-Control</code>ï¼‰</li>
<li>çŠ¶æ€ç ï¼ˆ200/404/304 ç­‰ï¼‰</li>
</ul>
<p>ä¾‹å¦‚ï¼Œè¯·æ±‚å›¾ç‰‡æ—¶è‡ªåŠ¨è¿”å›Â <code>Content-Type: image/png</code>ï¼Œæµè§ˆå™¨æ®æ­¤æ­£ç¡®æ¸²æŸ“èµ„æºã€‚</p>
<p>Â </p>
<h3 data-id="heading-3">âš¡ é™æ€èµ„æºæ‰˜ç®¡çš„æ ¸å¿ƒé…ç½®æŒ‡ä»¤</h3>
<p>Nginx é€šè¿‡ä»¥ä¸‹å…³é”®æŒ‡ä»¤æ§åˆ¶é™æ€èµ„æºçš„è¯»å–å’Œå“åº”è¡Œä¸ºï¼š</p>
<h4 data-id="heading-4">1.Â <code>root</code> <strong>ï¼šæŒ‡å®šèµ„æºæ ¹ç›®å½•</strong></h4>
<pre><code class="hljs language-arduino" lang="arduino">location /<span class="hljs-type">static</span>/ {
  root /usr/share/nginx/; 
  # è¯·æ±‚ /<span class="hljs-type">static</span>/logo.png â†’ å®é™…è¯»å– /usr/share/nginx/<span class="hljs-type">static</span>/logo.png
}
</code></pre>
<h4 data-id="heading-5">2.Â <code>alias</code> <strong>ï¼šæ›¿æ¢ URL è·¯å¾„ï¼ˆä¸</strong> <code>root</code> <strong>åŒºåˆ«ï¼‰</strong></h4>
<pre><code class="hljs language-bash" lang="bash">location /static/ {
  <span class="hljs-built_in">alias</span> /usr/share/nginx/files/; 
  <span class="hljs-comment"># è¯·æ±‚ /static/logo.png â†’ å®é™…è¯»å– /usr/share/nginx/files/logo.pngï¼ˆæ³¨æ„ alias è·¯å¾„æœ«å°¾çš„ /ï¼‰</span>
}
</code></pre>
<h4 data-id="heading-6">3.Â <code>index</code> <strong>ï¼šé»˜è®¤ä¸»é¡µæ–‡ä»¶</strong></h4>
<pre><code class="hljs language-ini" lang="ini">server {
  index index.html index.htm<span class="hljs-comment">; </span>
  <span class="hljs-comment"># è¯·æ±‚ / â†’ è‡ªåŠ¨è¿”å› /index.htmlï¼ˆæŒ‰é¡ºåºæŸ¥æ‰¾ï¼‰</span>
}
</code></pre>
<h4 data-id="heading-7">4.Â <code>try_files</code> <strong>ï¼šæŒ‰é¡ºåºå°è¯•è¯»å–æ–‡ä»¶</strong></h4>
<p>è§£å†³ SPAï¼ˆå•é¡µåº”ç”¨ï¼‰è·¯ç”±åˆ·æ–° 404 é—®é¢˜ï¼š</p>
<pre><code class="hljs language-bash" lang="bash">location / {
  try_files <span class="hljs-variable">$uri</span> <span class="hljs-variable">$uri</span>/ /index.html; 
  <span class="hljs-comment"># å°è¯•è¯»å–è¯·æ±‚çš„æ–‡ä»¶ â†’ ç›®å½• â†’ æœ€åè¿”å› index.html</span>
}
</code></pre>
<h5 data-id="heading-8">ğŸ§©Â <code>try_files $uri $uri/ /index.html;</code>Â çš„æ ¸å¿ƒä½œç”¨</h5>
<p><strong>ä¸€å¥è¯æ¦‚æ‹¬</strong>ï¼šå½“ç”¨æˆ·è®¿é—®ä¸€ä¸ªè·¯å¾„æ—¶ï¼ŒNginx ä¼šæŒ‰é¡ºåºå°è¯•æŸ¥æ‰¾æ–‡ä»¶æˆ–ç›®å½•ï¼Œæ‰¾ä¸åˆ°å°±å…œåº•è¿”å›Â <code>index.html</code>ï¼ˆå‰ç«¯ SPA çš„å…¥å£æ–‡ä»¶ï¼‰ã€‚</p>
<h6 data-id="heading-9">é€‚ç”¨åœºæ™¯ï¼š</h6>
<p>å•é¡µåº”ç”¨ï¼ˆå¦‚ Vue/React/Angularï¼‰ï¼Œè¿™ç±»åº”ç”¨çš„è·¯ç”±ç”±å‰ç«¯ JavaScript æ§åˆ¶ï¼ˆå¦‚Â <code>vue-router</code>Â çš„Â <code>history</code>Â æ¨¡å¼ï¼‰ï¼Œè€Œéä¼ ç»Ÿçš„åç«¯è·¯ç”±ã€‚</p>
<h5 data-id="heading-10">ğŸ” é€æ®µè§£æï¼šä¸‰ä¸ªå‚æ•°çš„å«ä¹‰</h5>
<h6 data-id="heading-11">a.Â <code>$uri</code> <strong>ï¼šå°è¯•è®¿é—®è¯·æ±‚çš„æ–‡ä»¶</strong></h6>
<ul>
<li><code>$uri</code>Â æ˜¯ Nginx çš„å†…ç½®å˜é‡ï¼Œè¡¨ç¤ºå½“å‰è¯·æ±‚çš„Â <strong>æ–‡ä»¶è·¯å¾„</strong>ï¼ˆä¸åŒ…å«æŸ¥è¯¢å‚æ•°ï¼‰ã€‚</li>
<li>ä¾‹å¦‚ï¼š<br/>
ç”¨æˆ·è¯·æ±‚Â <code>http://example.com/about</code>Â â†’Â <code>$uri</code>Â æ˜¯Â <code>/about</code><br/>
Nginx ä¼šå…ˆæ£€æŸ¥æœåŠ¡å™¨ä¸Šæ˜¯å¦å­˜åœ¨Â <code>/usr/local/frontend/dist/about</code>Â <strong>æ–‡ä»¶</strong>ï¼ˆå‡è®¾Â <code>root</code>Â æŒ‡å‘Â <code>dist</code>Â ç›®å½•ï¼‰ã€‚</li>
</ul>
<h6 data-id="heading-12">b.Â <code>$uri/</code> <strong>ï¼šå°è¯•è®¿é—®è¯·æ±‚çš„ç›®å½•</strong></h6>
<ul>
<li>å¦‚æœÂ <code>$uri</code>Â å¯¹åº”çš„æ–‡ä»¶ä¸å­˜åœ¨ï¼ŒNginx ä¼šå°è¯•å°†å…¶ä½œä¸ºÂ <strong>ç›®å½•</strong>Â è®¿é—®ï¼ˆæ·»åŠ Â <code>/</code>ï¼‰ã€‚</li>
<li>ä¾‹å¦‚ï¼š<br/>
è¯·æ±‚Â <code>http://example.com/about</code>Â â†’ æ£€æŸ¥Â <code>/usr/local/frontend/dist/about/</code>Â ç›®å½•æ˜¯å¦å­˜åœ¨ï¼Œä»¥åŠè¯¥ç›®å½•ä¸‹æ˜¯å¦æœ‰Â <code>index.html</code>ï¼ˆç”±Â <code>index</code>Â æŒ‡ä»¤é…ç½®ï¼Œå¦‚Â <code>index index.html</code>ï¼‰ã€‚</li>
</ul>
<h6 data-id="heading-13">c.Â <code>/index.html</code> <strong>ï¼šå…œåº•è¿”å›å‰ç«¯å…¥å£æ–‡ä»¶</strong></h6>
<ul>
<li>å¦‚æœå‰ä¸¤ä¸ªå°è¯•éƒ½å¤±è´¥ï¼ˆæ–‡ä»¶å’Œç›®å½•éƒ½ä¸å­˜åœ¨ï¼‰ï¼ŒNginx ä¼šç›´æ¥è¿”å›Â <code>root</code>Â ç›®å½•ä¸‹çš„Â <code>index.html</code>ï¼ˆå³å‰ç«¯ SPA çš„å…¥å£æ–‡ä»¶ï¼‰ã€‚</li>
<li>æ­¤æ—¶ï¼Œå‰ç«¯è·¯ç”±ï¼ˆå¦‚Â <code>vue-router</code>ï¼‰ä¼šæ ¹æ® URL ä¸­çš„è·¯å¾„ï¼ˆå¦‚Â <code>/about</code>ï¼‰æ¸²æŸ“å¯¹åº”çš„é¡µé¢ç»„ä»¶ï¼Œä»è€Œé¿å… 404 é”™è¯¯ã€‚</li>
</ul>
<h6 data-id="heading-14">d. <code>history</code> <strong>æ¨¡å¼ vs</strong> <code>hash</code> <strong>æ¨¡å¼</strong></h6>
<ul>
<li><code>hash</code> <strong>æ¨¡å¼</strong>ï¼ˆå¦‚Â <code>http://example.com/#/about</code>Â ï¼‰ï¼šå“ˆå¸Œéƒ¨åˆ†ï¼ˆ<code>#/about</code>ï¼‰ä¸ä¼šå‘é€åˆ°æœåŠ¡å™¨ï¼Œå› æ­¤æ— éœ€Â <code>try_files</code>Â ä¹Ÿèƒ½æ­£å¸¸åˆ·æ–°ã€‚</li>
<li><code>history</code> <strong>æ¨¡å¼</strong>ï¼ˆå¦‚Â <code>http://example.com/about</code>Â ï¼‰ï¼šURL è·¯å¾„ä¼šå‘é€åˆ°æœåŠ¡å™¨ï¼Œå¿…é¡»é…ç½®Â <code>try_files</code>Â æ‰èƒ½é¿å… 404ã€‚</li>
<li><strong>æ¨è</strong>ï¼š<code>history</code>Â æ¨¡å¼ï¼ˆURL æ›´ç¾è§‚ï¼‰+Â <code>try_files</code>Â é…ç½®ã€‚</li>
</ul>
<h5 data-id="heading-15">ğŸ“ ä¸ºä»€ä¹ˆéœ€è¦è¿™è¡Œé…ç½®ï¼Ÿ</h5>
<p>å•é¡µåº”ç”¨çš„è·¯ç”±æ˜¯â€œå‰ç«¯æ¥ç®¡â€çš„ï¼Œæ‰€æœ‰é¡µé¢å®é™…ä¸Šéƒ½é€šè¿‡Â <code>index.html</code>Â åŠ è½½ï¼Œå†ç”± JavaScript æ ¹æ® URL åŠ¨æ€æ¸²æŸ“å†…å®¹ã€‚</p>
<h5 data-id="heading-16"><code>try_files $uri $uri/ /index.html;</code>Â çš„ä½œç”¨å°±æ˜¯å‘Šè¯‰ Nginxï¼šâ€œå¦‚æœç”¨æˆ·è®¿é—®çš„è·¯å¾„ä¸æ˜¯çœŸå®å­˜åœ¨çš„æ–‡ä»¶/ç›®å½•ï¼Œå°±æŠŠå¤„ç†æƒäº¤è¿˜ç»™å‰ç«¯è·¯ç”±ï¼ˆé€šè¿‡è¿”å›Â <code>index.html</code>ï¼‰â€ã€‚</h5>
<h4 data-id="heading-17">5.Â <code>expires</code> <strong>ä¸</strong> <code>Cache-Control</code> <strong>ï¼šç¼“å­˜æ§åˆ¶</strong></h4>
<pre><code class="hljs language-ruby" lang="ruby">nginx
å¤åˆ¶
location ~* .(js|<span class="hljs-params">css</span>|png)<span class="hljs-variable">$ </span>{
  expires 30d; <span class="hljs-comment"># æµè§ˆå™¨ç¼“å­˜ 30 å¤©</span>
  add_header <span class="hljs-title class_">Cache</span>-<span class="hljs-title class_">Control</span> <span class="hljs-string">"public, max-age=2592000, immutable"</span>;
}
</code></pre>
<p>Â </p>
<h3 data-id="heading-18">ğŸš€ Nginx é™æ€èµ„æºæ‰˜ç®¡çš„æ€§èƒ½ä¼˜åŒ–æ‰‹æ®µ</h3>
<p>é™¤äº†åŸºç¡€èƒ½åŠ›ï¼ŒNginx è¿˜æä¾›å¤šç§ä¼˜åŒ–ç­–ç•¥ï¼Œè®©é™æ€èµ„æºåŠ è½½æ›´å¿«ï¼š</p>
<h4 data-id="heading-19">1.Â <strong>å¯ç”¨</strong> <code>gzip</code> <strong>å‹ç¼©</strong></h4>
<p>å‹ç¼© JS/CSS/HTML ç­‰æ–‡æœ¬èµ„æºï¼Œå‡å°‘ä¼ è¾“ä½“ç§¯ï¼š</p>
<pre><code class="hljs language-bash" lang="bash">nginx
å¤åˆ¶
gzip on;
gzip_types text/css application/javascript text/html;
gzip_comp_level 5; <span class="hljs-comment"># å‹ç¼©ç­‰çº§ï¼ˆ1-9ï¼Œè¶Šé«˜å‹ç¼©ç‡è¶Šå¥½ä½†è€— CPUï¼‰</span>
</code></pre>
<h4 data-id="heading-20">2.Â <code>sendfile</code> <strong>é›¶æ‹·è´æŠ€æœ¯</strong></h4>
<p>è·³è¿‡ç”¨æˆ·æ€ä¸å†…æ ¸æ€çš„æ•°æ®æ‹·è´ï¼Œç›´æ¥ä»ç£ç›˜è¯»å–æ–‡ä»¶å‘é€åˆ°ç½‘ç»œï¼š</p>
<pre><code class="hljs language-csharp" lang="csharp">nginx
å¤åˆ¶
sendfile <span class="hljs-keyword">on</span>; <span class="hljs-meta"># å¯ç”¨é›¶æ‹·è´</span>
tcp_nopush <span class="hljs-keyword">on</span>; <span class="hljs-meta"># é…åˆ sendfile ä½¿ç”¨ï¼Œå‡å°‘ç½‘ç»œåŒ…æ•°é‡</span>
</code></pre>
<h4 data-id="heading-21">3.Â <code>open_file_cache</code> <strong>ç¼“å­˜æ–‡ä»¶å…ƒä¿¡æ¯</strong></h4>
<p>ç¼“å­˜æ–‡ä»¶çš„ inodeã€å¤§å°ã€ä¿®æ”¹æ—¶é—´ç­‰ä¿¡æ¯ï¼Œé¿å…é‡å¤ stat ç³»ç»Ÿè°ƒç”¨ï¼š</p>
<pre><code class="hljs language-ini" lang="ini">nginx
å¤åˆ¶
open_file_cache <span class="hljs-attr">max</span>=<span class="hljs-number">1000</span> inactive=<span class="hljs-number">20</span>s<span class="hljs-comment">;</span>
open_file_cache_valid 30s<span class="hljs-comment">;</span>
open_file_cache_min_uses 2<span class="hljs-comment">;</span>
</code></pre>
<h4 data-id="heading-22">4.Â <strong>é™åˆ¶è¯·æ±‚é€Ÿç‡ï¼ˆé˜²æ»¥ç”¨ï¼‰</strong></h4>
<pre><code class="hljs language-ini" lang="ini">nginx
å¤åˆ¶
limit_rate 100k<span class="hljs-comment">; # å•è¿æ¥é™é€Ÿ 100KB/s</span>
limit_conn_zone $binary_remote_addr <span class="hljs-attr">zone</span>=addr:<span class="hljs-number">10</span>m<span class="hljs-comment">;</span>
limit_conn addr 10<span class="hljs-comment">; # å• IP æœ€å¤š 10 ä¸ªå¹¶å‘è¿æ¥</span>
</code></pre>
<p>Â </p>
<h3 data-id="heading-23">ğŸ“š ä¸ºä»€ä¹ˆä¸ç›´æ¥ç”¨æµè§ˆå™¨æ‰“å¼€Â <code>dist</code>Â ç›®å½•çš„ HTML æ–‡ä»¶ï¼Ÿ</h3>
<p>è™½ç„¶Â <code>dist</code>Â ç›®å½•åŒ…å«é™æ€æ–‡ä»¶ï¼Œä½†ç›´æ¥é€šè¿‡Â <code>file:///path/to/dist/index.html</code>Â æ‰“å¼€ä¼šæœ‰é—®é¢˜ï¼š</p>
<ol>
<li><strong>è·¨åŸŸé™åˆ¶</strong>ï¼šæµè§ˆå™¨ç¦æ­¢Â <code>file://</code>Â åè®®ä¸‹çš„ AJAX è¯·æ±‚ï¼ˆå®‰å…¨ç­–ç•¥ï¼‰ã€‚</li>
<li><strong>è·¯å¾„é”™è¯¯</strong>ï¼šç›¸å¯¹è·¯å¾„ï¼ˆå¦‚Â <code>./js/app.js</code>ï¼‰ä¼šè¢«è§£æä¸ºÂ <code>file://</code>Â åè®®ï¼Œè€ŒéæœåŠ¡å™¨ URLã€‚</li>
<li><strong>è·¯ç”±å¤±æ•ˆ</strong>ï¼šSPA è·¯ç”±ï¼ˆå¦‚Â <code>/about</code>ï¼‰ä¼šè¢«æµè§ˆå™¨è§†ä¸ºæœ¬åœ°æ–‡ä»¶è·¯å¾„ï¼Œå¯¼è‡´ 404ã€‚</li>
</ol>
<p>è€Œ Nginx æä¾›äº†æ ‡å‡†çš„Â <code>http://</code>Â åè®®ç¯å¢ƒï¼Œå®Œç¾è§£å†³ä»¥ä¸Šé—®é¢˜ã€‚</p>
<hr/>
<p>Â </p>
<h3 data-id="heading-24">ğŸ“ æ€»ç»“ï¼šNginx é™æ€èµ„æºæ‰˜ç®¡çš„æ ¸å¿ƒä¼˜åŠ¿</h3>

























<table><thead><tr><th>ä¼˜åŠ¿</th><th>å…·ä½“è¯´æ˜</th></tr></thead><tbody><tr><td><strong>é«˜æ€§èƒ½</strong></td><td>äº‹ä»¶é©±åŠ¨æ¶æ„ + é›¶æ‹·è´æŠ€æœ¯ï¼Œæ”¯æŒé«˜å¹¶å‘ä½å»¶è¿Ÿ</td></tr><tr><td><strong>é…ç½®çµæ´»</strong></td><td>root/alias/try_filesÂ ç­‰æŒ‡ä»¤é€‚é…å„ç§åœºæ™¯</td></tr><tr><td><strong>åŠŸèƒ½ä¸°å¯Œ</strong></td><td>å†…ç½®ç¼“å­˜ã€å‹ç¼©ã€é™é€Ÿã€SSL ç­‰èƒ½åŠ›</td></tr><tr><td><strong>è½»é‡ç¨³å®š</strong></td><td>å†…å­˜å ç”¨ä½ï¼Œæ•…éšœç‡æä½ï¼Œ7x24 å°æ—¶è¿è¡Œæ— å‹åŠ›</td></tr></tbody></table>
<p>ç®€å•è¯´ï¼ŒNginx å°±åƒä¸€ä¸ª<strong>é«˜æ•ˆçš„"æ–‡ä»¶å¿«é€’å‘˜"</strong> ï¼šæ—¢èƒ½å¿«é€Ÿæ‰¾åˆ°æœåŠ¡å™¨ä¸Šçš„é™æ€æ–‡ä»¶ï¼Œåˆèƒ½é€šè¿‡å„ç§ä¼˜åŒ–æ‰‹æ®µæŠŠæ–‡ä»¶"å¿«é€’"åˆ°ç”¨æˆ·æµè§ˆå™¨ï¼Œè¿˜èƒ½é¡ºä¾¿å¤„ç†ç¼“å­˜ã€å‹ç¼©ç­‰"å¢å€¼æœåŠ¡"ã€‚è¿™ä¹Ÿæ˜¯å®ƒæˆä¸ºé™æ€èµ„æºæ‰˜ç®¡é¦–é€‰å·¥å…·çš„æ ¹æœ¬åŸå› ï¼</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[åœ¨Androidå¼€å‘ä¸­é˜…è¯»æºç çš„æŒ‡å¯¼æ€è·¯]]></title>    <link>https://juejin.cn/post/7585382553290506276</link>    <guid>https://juejin.cn/post/7585382553290506276</guid>    <pubDate>2025-12-20T06:12:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585382553290506276" data-draft-id="7585412203978276907" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="åœ¨Androidå¼€å‘ä¸­é˜…è¯»æºç çš„æŒ‡å¯¼æ€è·¯"/> <meta itemprop="keywords" content="å‰ç«¯"/> <meta itemprop="datePublished" content="2025-12-20T06:12:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Poorguy9527"/> <meta itemprop="url" content="https://juejin.cn/user/1746465251931063"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="æ˜é‡‘"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            åœ¨Androidå¼€å‘ä¸­é˜…è¯»æºç çš„æŒ‡å¯¼æ€è·¯
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1746465251931063/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Poorguy9527
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T06:12:17.000Z" title="Sat Dec 20 2025 06:12:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    é˜…è¯»3åˆ†é’Ÿ
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>é˜…è¯»æºç æ˜¯ç ”ç©¶æŠ€æœ¯åº•å±‚å®ç°é€»è¾‘çš„å¿…ç”±ä¹‹è·¯
ï¼Œä¹Ÿæ˜¯å¼€å‘è€…æˆé•¿è·¯ä¸Šå¿…å¤‡çš„ä¸€è¯¾</p>
</blockquote>
<p>é˜…è¯»Androidæºç ï¼ˆå°¤å…¶æ˜¯åƒKotlinåç¨‹è¿™æ ·çš„å¤æ‚æ¡†æ¶ï¼‰éœ€è¦æœ‰ç³»ç»Ÿçš„æ–¹æ³•å’Œæ¸…æ™°çš„æ€è·¯ã€‚ä»¥ä¸‹æ˜¯é«˜æ•ˆé˜…è¯»æºç çš„æŒ‡å¯¼æ€è·¯ï¼Œå¹¶ä»¥Kotlinåç¨‹ä¸ºä¾‹è¯´æ˜å…·ä½“å®æ–½æ­¥éª¤ï¼š</p>
<h2 data-id="heading-0">ğŸ“šÂ <strong>ä¸€ã€é€šç”¨æºç é˜…è¯»æ–¹æ³•è®º</strong></h2>
<h3 data-id="heading-1">1.Â <strong>æ˜ç¡®é˜…è¯»ç›®æ ‡</strong></h3>
<pre><code class="hljs language-text" lang="text">åˆçº§ï¼šç†è§£åŸºæœ¬ç”¨æ³•å’Œå·¥ä½œåŸç†
ä¸­çº§ï¼šæŒæ¡å†…éƒ¨æœºåˆ¶å’Œè®¾è®¡æ€æƒ³
é«˜çº§ï¼šèƒ½ä¿®æ”¹æ‰©å±•æˆ–è§£å†³æ·±å±‚æ¬¡é—®é¢˜
</code></pre>
<h3 data-id="heading-2">2.Â <strong>åˆ†å±‚æ¸è¿›ç­–ç•¥</strong></h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// æ¨èé˜…è¯»é¡ºåº</span>
<span class="hljs-number">1.</span> å®˜æ–¹æ–‡æ¡£å’Œç¤ºä¾‹
<span class="hljs-number">2.</span> å…³é”®APIä½¿ç”¨
<span class="hljs-number">3.</span> æ¶æ„æ¦‚è§ˆ
<span class="hljs-number">4.</span> æ ¸å¿ƒæµç¨‹è·Ÿè¸ª
<span class="hljs-number">5.</span> æ·±å…¥ç»†èŠ‚å®ç°
</code></pre>
<h2 data-id="heading-3">ğŸ”Â <strong>äºŒã€å…·ä½“åˆ°Kotlinåç¨‹æºç </strong></h2>
<h3 data-id="heading-4"><strong>ç¬¬ä¸€æ­¥ï¼šå‡†å¤‡å·¥ä½œ</strong></h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 1. æ­å»ºè°ƒè¯•ç¯å¢ƒ</span>
dependencies {
    implementation(<span class="hljs-string">"org.jetbrains.kotlinx:kotlinx-coroutines-core:1.7.3"</span>)
    implementation(<span class="hljs-string">"org.jetbrains.kotlinx:kotlinx-coroutines-debug:1.7.3"</span>)
}

<span class="hljs-comment">// 2. ä½¿ç”¨åç¨‹è°ƒè¯•å·¥å…·</span>
CoroutineScope(Dispatchers.Default + CoroutineName(<span class="hljs-string">"test"</span>)).launch {
    debugCoroutine()  <span class="hljs-comment">// è‡ªå®šä¹‰è°ƒè¯•å‡½æ•°</span>
}
</code></pre>
<h3 data-id="heading-5"><strong>ç¬¬äºŒæ­¥ï¼šç”±æµ…å…¥æ·±å››å±‚é˜…è¯»æ³•</strong></h3>
<h4 data-id="heading-6"><strong>ç¬¬1å±‚ï¼šå…¥å£å’Œæ ¸å¿ƒæ¥å£</strong></h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// å…ˆçœ‹è¿™å‡ ä¸ªæ ¸å¿ƒæ¥å£/ç±»</span>
<span class="hljs-number">1.</span> CoroutineScope - åç¨‹ä½œç”¨åŸŸ
<span class="hljs-number">2.</span> CoroutineContext - åç¨‹ä¸Šä¸‹æ–‡
<span class="hljs-number">3.</span> Continuation - ç»­ä½“ï¼ˆæ ¸å¿ƒæŠ½è±¡ï¼‰
<span class="hljs-number">4.</span> CoroutineDispatcher - è°ƒåº¦å™¨
<span class="hljs-number">5.</span> Job/Deferred - åç¨‹ä»»åŠ¡

<span class="hljs-comment">// é˜…è¯»è·¯å¾„å»ºè®®ï¼š</span>
kotlinx.coroutines/
â”œâ”€â”€ CoroutineScope.kt
â”œâ”€â”€ CoroutineContext.kt
â”œâ”€â”€ Continuation.kt
â””â”€â”€ AbstractCoroutine.kt
</code></pre>
<h4 data-id="heading-7"><strong>ç¬¬2å±‚ï¼šå¯åŠ¨æµç¨‹åˆ†æ</strong></h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// è·Ÿè¸ª launch/async æ‰§è¡Œæµç¨‹</span>
launch { 
    <span class="hljs-comment">// ä»£ç å—</span>
}

<span class="hljs-comment">// é˜…è¯»é¡ºåºï¼š</span>
<span class="hljs-number">1.</span> CoroutineScope.launch() æ‰©å±•å‡½æ•°
<span class="hljs-number">2.</span> StandaloneCoroutine / LazyStandaloneCoroutine
<span class="hljs-number">3.</span> start() -&gt; resumeWith()
<span class="hljs-number">4.</span> è°ƒåº¦å™¨åˆ†é…é€»è¾‘
</code></pre>
<h4 data-id="heading-8"><strong>ç¬¬3å±‚ï¼šè°ƒåº¦å™¨å®ç°</strong></h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// é‡ç‚¹é˜…è¯»ï¼š</span>
<span class="hljs-number">1.</span> Dispatchers.Main/Default/IO/Unconfined
<span class="hljs-number">2.</span> CoroutineScheduler.kt (çº¿ç¨‹æ± æ ¸å¿ƒ)
<span class="hljs-number">3.</span> ä»»åŠ¡çªƒå–ç®—æ³•

<span class="hljs-comment">// è°ƒè¯•æŠ€å·§ï¼šåˆ‡æ¢è°ƒåº¦å™¨è§‚å¯Ÿçº¿ç¨‹å˜åŒ–</span>
withContext(Dispatchers.IO) {
    println(<span class="hljs-string">"Thread: <span class="hljs-subst">${Thread.currentThread().name}</span>"</span>)
}
</code></pre>
<h4 data-id="heading-9"><strong>ç¬¬4å±‚ï¼šæŒ‚èµ·æœºåˆ¶</strong></h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// æ·±å…¥ç†è§£ suspend åŸç†</span>
<span class="hljs-number">1.</span> suspendCoroutine{} / suspendCancellableCoroutine{}
<span class="hljs-number">2.</span> ContinuationImpl
<span class="hljs-number">3.</span> BaseContinuationImpl.resumeWith()
<span class="hljs-number">4.</span> SafeContinuator

<span class="hljs-comment">// å…³é”®æ–‡ä»¶ï¼š</span>
kotlinx.coroutines.intrinsics/
â”œâ”€â”€ Cancellable.kt
â””â”€â”€ ContinuationImpl.kt
</code></pre>
<h3 data-id="heading-10"><strong>ç¬¬ä¸‰æ­¥ï¼šå®ç”¨è°ƒè¯•æŠ€å·§</strong></h3>
<h4 data-id="heading-11"><strong>1. ä½¿ç”¨åç¨‹è°ƒè¯•æ¨¡å¼</strong></h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// å¯åŠ¨æ—¶æ·»åŠ VMå‚æ•°</span>
-Dkotlinx.coroutines.debug=on

<span class="hljs-comment">// è¾“å‡ºåŒ…å«åç¨‹åçš„å †æ ˆ</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> = runBlocking {
    launch(CoroutineName(<span class="hljs-string">"my-coroutine"</span>)) {
        println(<span class="hljs-string">"Running in <span class="hljs-subst">${coroutineContext[CoroutineName]}</span>"</span>)
    }
}
</code></pre>
<h4 data-id="heading-12"><strong>2. å…³é”®æ–­ç‚¹è®¾ç½®</strong></h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># å»ºè®®æ–­ç‚¹ä½ç½®ï¼š</span>
1. AbstractCoroutine.resumeWith()  <span class="hljs-comment"># åç¨‹æ¢å¤ç‚¹</span>
2. CoroutineScheduler.dispatch()   <span class="hljs-comment"># ä»»åŠ¡è°ƒåº¦ç‚¹</span>
3. ContinuationImpl.invokeSuspend() <span class="hljs-comment"># æŒ‚èµ·å‡½æ•°æ‰§è¡Œç‚¹</span>
4. JobSupport.cancel()            <span class="hljs-comment"># å–æ¶ˆé€»è¾‘</span>
</code></pre>
<h4 data-id="heading-13"><strong>3. æ—¶åºå›¾ç»˜åˆ¶å·¥å…·</strong></h4>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
launch -&gt; CoroutineScope: åˆ›å»ºåç¨‹
CoroutineScope -&gt; CoroutineScheduler: æäº¤ä»»åŠ¡
CoroutineScheduler -&gt; Worker: åˆ†é…çº¿ç¨‹
Worker -&gt; Continuation: æ‰§è¡Œç»­ä½“
Continuation -&gt; suspend: é‡åˆ°æŒ‚èµ·ç‚¹
suspend -&gt; dispatch: é‡Šæ”¾çº¿ç¨‹

</code></pre>
<h2 data-id="heading-14">ğŸ› ï¸Â <strong>ä¸‰ã€é«˜æ•ˆå·¥å…·é“¾</strong></h2>
<h3 data-id="heading-15"><strong>1. IDEé…ç½®</strong></h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">Android Studio / IntelliJ IDEA:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">å®‰è£…</span> <span class="hljs-string">"Kotlin"</span> <span class="hljs-string">æ’ä»¶</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">å¯ç”¨</span> <span class="hljs-string">"Kotlinåç¨‹è°ƒè¯•å™¨"</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">é…ç½®æºç è·³è½¬:</span> <span class="hljs-string">Ctrl+Click</span> <span class="hljs-string">-&gt;</span> <span class="hljs-string">Download</span> <span class="hljs-string">Sources</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">ä½¿ç”¨</span> <span class="hljs-string">"Structure"</span> <span class="hljs-string">è§†å›¾æŸ¥çœ‹ç±»å±‚æ¬¡</span>
</code></pre>
<h3 data-id="heading-16"><strong>2. å‘½ä»¤è¡Œå·¥å…·</strong></h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># ç”Ÿæˆä¾èµ–å›¾</span>
./gradlew :app:dependencies

<span class="hljs-comment"># åç¼–è¯‘æŸ¥çœ‹å­—èŠ‚ç </span>
javap -c MyCoroutine.class

<span class="hljs-comment"># ä½¿ç”¨Kotlinç¼–è¯‘å™¨æ’ä»¶</span>
kotlinc -Xcoroutines=<span class="hljs-built_in">enable</span>
</code></pre>
<h3 data-id="heading-17"><strong>3. å¯è§†åŒ–å·¥å…·</strong></h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// åç¨‹å †æ ˆåˆ†æ</span>
<span class="hljs-keyword">val</span> stackTrace = Thread.currentThread().stackTrace
stackTrace.forEach { 
    <span class="hljs-keyword">if</span> (it.className.contains(<span class="hljs-string">"coroutine"</span>)) {
        println(<span class="hljs-string">"Coroutine related: <span class="hljs-variable">$it</span>"</span>)
    }
}
</code></pre>
<h2 data-id="heading-18">ğŸ“Â <strong>å››ã€å…·ä½“å®è·µï¼šåˆ†æä¸€ä¸ªæŒ‚èµ·å‡½æ•°</strong></h2>
<h3 data-id="heading-19"><strong>æ¡ˆä¾‹ï¼šdelay() å®ç°</strong></h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// é˜…è¯»è·¯å¾„ï¼š</span>
<span class="hljs-number">1.</span> kotlinx.coroutines.Delay.kt
<span class="hljs-number">2.</span> kotlinx.coroutines.Delay.delay()
<span class="hljs-number">3.</span> kotlinx.coroutines.EventLoopImplBase.delayNanos()
<span class="hljs-number">4.</span> kotlinx.coroutines.DelayQueue

<span class="hljs-comment">// å…³é”®ç†è§£ç‚¹ï¼š</span>
- å¦‚ä½•å®ç°éé˜»å¡å»¶è¿Ÿ
- ä¸Handler/Looperçš„é›†æˆ
- å–æ¶ˆæœºåˆ¶çš„å®ç°
</code></pre>
<h2 data-id="heading-20">ğŸ”§Â <strong>äº”ã€é—®é¢˜å¯¼å‘é˜…è¯»æ³•</strong></h2>
<p>å½“é‡åˆ°é—®é¢˜æ—¶ï¼ŒæŒ‰è¿™ä¸ªæµç¨‹ï¼š</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
A[å®é™…é—®é¢˜] --&gt; B[å®šä½ç›¸å…³ç±»]
B --&gt; C{æ˜¯å¦éœ€è¦æ·±å…¥?}
C --&gt;|æ˜¯| D[é˜…è¯»æ ¸å¿ƒæ–¹æ³•]
C --&gt;|å¦| E[æŸ¥çœ‹APIæ–‡æ¡£]
D --&gt; F[ç»˜åˆ¶è°ƒç”¨å…³ç³»]
F --&gt; G[éªŒè¯çŒœæƒ³]
</code></pre>
<h2 data-id="heading-21">ğŸ’¡Â <strong>å…­ã€å­¦ä¹ å»ºè®®</strong></h2>
<ol>
<li><strong>å…ˆä¼šç”¨å†è¯»æºç </strong>Â - ç†Ÿç»ƒæŒæ¡APIåå†æ·±å…¥</li>
<li><strong>å¸¦ç€é—®é¢˜è¯»</strong>Â - æ¯æ¬¡è§£å†³ä¸€ä¸ªå…·ä½“ç–‘é—®</li>
<li><strong>åšç¬”è®°ç”»å›¾</strong>Â - ç”¨å›¾è¡¨è®°å½•æ ¸å¿ƒæµç¨‹</li>
<li><strong>å†™æµ‹è¯•éªŒè¯</strong>Â - é€šè¿‡å•å…ƒæµ‹è¯•ç†è§£è¡Œä¸º</li>
<li><strong>å‚ä¸ç¤¾åŒº</strong>Â - å…³æ³¨Kotlinåç¨‹çš„GitHub Issues</li>
</ol>
<h2 data-id="heading-22">ğŸ“šÂ <strong>ä¸ƒã€æ¨èé˜…è¯»ææ–™</strong></h2>
<pre><code class="hljs language-text" lang="text">å®˜æ–¹æ–‡æ¡£:
- Kotlinåç¨‹æŒ‡å—: https://kotlinlang.org/docs/coroutines-guide.html
- è®¾è®¡æ–‡æ¡£: https://github.com/Kotlin/kotlinx.coroutines/blob/master/docs/topics/coroutines-design.md

æºç ä½ç½®:
- GitHub: kotlinx.coroutines
- åŒ…ç»“æ„: kotlinx.coroutines.*
</code></pre>
<p>è®°ä½ï¼š<strong>ä¸è¦è¯•å›¾ä¸€æ¬¡æ€§ç†è§£æ‰€æœ‰ä»£ç </strong>ã€‚åç¨‹æºç æœ‰2ä¸‡+è¡Œï¼Œåº”è¯¥åˆ†æ¨¡å—ã€åˆ†å±‚æ¬¡é€æ­¥æ·±å…¥ã€‚å»ºè®®å…ˆä»Â <code>kotlinx.coroutines.core</code>Â å¼€å§‹ï¼Œç†è§£åŸºæœ¬æ¨¡å‹åå†çœ‹Â <code>kotlinx.coroutines.android</code>Â ç­‰å¹³å°ç‰¹å®šå®ç°ã€‚</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[æ”¯ä»˜æˆåŠŸè®¢å•å´æ²¡äº†ï¼ŸMyBatisè¿æ¥æ± çš„å‘æˆ‘è¸©äº†]]></title>    <link>https://juejin.cn/post/7585446706327126025</link>    <guid>https://juejin.cn/post/7585446706327126025</guid>    <pubDate>2025-12-20T06:25:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585446706327126025" data-draft-id="7585463258690650121" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="æ”¯ä»˜æˆåŠŸè®¢å•å´æ²¡äº†ï¼ŸMyBatisè¿æ¥æ± çš„å‘æˆ‘è¸©äº†"/> <meta itemprop="keywords" content="åç«¯,é¢è¯•,Java"/> <meta itemprop="datePublished" content="2025-12-20T06:25:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="9å·è¾¾äºº"/> <meta itemprop="url" content="https://juejin.cn/user/2450136052270077"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="æ˜é‡‘"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            æ”¯ä»˜æˆåŠŸè®¢å•å´æ²¡äº†ï¼ŸMyBatisè¿æ¥æ± çš„å‘æˆ‘è¸©äº†
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2450136052270077/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    9å·è¾¾äºº
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T06:25:35.000Z" title="Sat Dec 20 2025 06:25:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    é˜…è¯»7åˆ†é’Ÿ
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">äº‹æ•…ç°åœº</h2>
<p>ä¸Šå‘¨çº¿ä¸Šç‚¸äº†ã€‚</p>
<p>æ”¯ä»˜ä¸šåŠ¡å‡ºäº†é—®é¢˜ï¼Œç”¨æˆ·æ”¯ä»˜æˆåŠŸï¼Œä½†è®¢å•è¡¨æ²¡æ•°æ®ã€‚æ›´è¯¡å¼‚çš„æ˜¯ï¼Œä¿®æ”¹è®¢å•æ—¶æœ‰æ—¶ä¹Ÿä¼šæç¤ºè·å–é”è¶…æ—¶ã€‚</p>
<p>DBAçœ‹äº†ä¸€çœ¼æ•°æ®åº“è¿æ¥ï¼Œå‘ç°å‡ ä¸ªäº‹åŠ¡ä¸€ç›´æ²¡æäº¤ï¼Œé”ç€è®¢å•è¡¨çš„å‡ è¡Œæ•°æ®ã€‚</p>
<p>æ’æŸ¥åŠå¤©ï¼Œæœ€åå‘ç°æ˜¯æŸä¸ªä¸šåŠ¡æ¥å£å¿˜äº†æäº¤äº‹åŠ¡ã€‚</p>
<p>æŒ‰ç†è¯´,äº‹åŠ¡æ²¡æäº¤åº”è¯¥å¾ˆå®¹æ˜“å‘ç°ã€‚ä½†è¿™ä¸ªbugå°±æ¯”è¾ƒéšè”½ã€‚</p>
<p><strong>4ä¸ªåå¸¸è¯†çš„ç°è±¡ï¼š</strong></p>
<ol>
<li><strong>ä¸šåŠ¡ä»£ç æ­£å¸¸æ‰§è¡Œå®Œæ¯•</strong> æ²¡æœ‰ä»»ä½•æŠ¥é”™ï¼Œæ—¥å¿—ä¹Ÿæ­£å¸¸æ‰“å°ã€‚</li>
<li><strong>æ—¥å¿—æ˜¾ç¤ºäº‹åŠ¡å·²æäº¤</strong> commitæ–¹æ³•è¢«è°ƒç”¨äº†ï¼Œä½†æ•°æ®åº“é‡Œæ²¡æ•°æ®ã€‚</li>
<li><strong>å¶å°”ä¼šæˆåŠŸ</strong> å¤§éƒ¨åˆ†æ—¶å€™å¤±è´¥ï¼Œä½†å¶å°”èƒ½æ­£å¸¸æ’å…¥è®¢å•ã€‚</li>
</ol>
<p>è¿™ç§æƒ…å†µè®©äººæ‘¸ä¸ç€å¤´è„‘ã€‚ä»£ç æ²¡æŠ¥é”™ï¼Œæ—¥å¿—ä¹Ÿæ­£å¸¸ï¼Œä¸ºå•¥æ•°æ®å°±æ˜¯ä¸å…¥åº“?</p>
<h2 data-id="heading-1">åº”æ€¥å¤„ç†</h2>
<p>çº¿ä¸Šå‡ºé—®é¢˜ï¼Œé‚£è‚¯å®šå…ˆæ¢å¤ä¸šåŠ¡å†è¯´ã€‚</p>
<p>æœ€å¿«çš„åŠæ³•å°±æ˜¯é‡å¯åº”ç”¨ï¼Œå¼ºåˆ¶é‡Šæ”¾è¿™äº›è¿æ¥ã€‚</p>
<p>é‡å¯å®Œï¼Œæ”¯ä»˜åŠŸèƒ½æ¢å¤æ­£å¸¸ã€‚ä½†é—®é¢˜è¿˜æ˜¯è¦æ‰¾åˆ°</p>
<p>é‡å¯åªèƒ½æš‚æ—¶ç¼“è§£ï¼Œå¾—æ‰¾åˆ°åˆ°åº•å“ªä¸ªä¸šåŠ¡å‡ºäº†é—®é¢˜ã€‚</p>
<p>å¯¹æ¯”äº†æœ€è¿‘çš„ä¸Šçº¿è®°å½•ï¼Œå‘ç°æœ‰ä¸ªæ–°ä¸šåŠ¡åˆšä¸Šçº¿ã€‚æ£€æŸ¥ä»£ç ï¼Œæœç„¶å‘ç°äº†é—®é¢˜ï¼š</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span>Â <span class="hljs-keyword">class</span>Â <span class="hljs-title class_">SomeService</span>Â {

Â Â Â Â <span class="hljs-keyword">public</span>Â voidÂ handleSpecialCase()Â {
Â Â Â Â Â Â Â Â <span class="hljs-comment">//Â å¼€å¯äº‹åŠ¡</span>
Â Â Â Â Â Â Â Â sqlSession.connection.setAutoCommit(<span class="hljs-literal">false</span>);

Â Â Â Â Â Â Â Â <span class="hljs-comment">//Â æ‰§è¡ŒSQL</span>
Â Â Â Â Â Â Â Â mapper.insert(<span class="hljs-keyword">data</span>);

Â Â Â Â Â Â Â Â <span class="hljs-comment">//Â ç‰¹æ®Šæƒ…å†µä¸‹ï¼Œå¿˜è®°commitäº†ï¼</span>
Â Â Â Â Â Â Â Â <span class="hljs-keyword">if</span>Â (specialCondition)Â {
Â Â Â Â Â Â Â Â Â Â Â Â <span class="hljs-comment">//Â æŸäº›æƒ…å†µä¸‹ä¼šreturnï¼Œä½†æ²¡commit</span>
Â Â Â Â Â Â Â Â Â Â Â Â <span class="hljs-keyword">return</span>;
Â Â Â Â Â Â Â Â }

Â Â Â Â Â Â Â Â sqlSession.commit();
Â Â Â Â }
}
</code></pre>
<p>ç‰¹æ®Šåˆ†æ”¯ç›´æ¥returnäº†ï¼Œcommitæ²¡æ‰§è¡Œã€‚</p>
<h3 data-id="heading-2">å¿«é€Ÿä¿®å¤</h3>
<p>ç«‹å³è¡¥ä¸Šcommitï¼Œé‡æ–°ä¸Šçº¿ï¼š</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span>Â <span class="hljs-keyword">class</span>Â <span class="hljs-title class_">SomeService</span>Â {

Â Â Â Â <span class="hljs-keyword">public</span>Â voidÂ handleSpecialCase()Â {
Â Â Â Â Â Â Â Â <span class="hljs-keyword">try</span>Â {
Â Â Â Â Â Â Â Â Â Â Â Â sqlSession.connection.setAutoCommit(<span class="hljs-literal">false</span>);
Â Â Â Â Â Â Â Â Â Â Â Â mapper.insert(<span class="hljs-keyword">data</span>);

Â Â Â Â Â Â Â Â Â Â Â Â <span class="hljs-keyword">if</span>Â (specialCondition)Â {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â sqlSession.commit();Â <span class="hljs-comment">//Â è¡¥ä¸Šï¼</span>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â <span class="hljs-keyword">return</span>;
Â Â Â Â Â Â Â Â Â Â Â Â }

Â Â Â Â Â Â Â Â Â Â Â Â sqlSession.commit();
Â Â Â Â Â Â Â Â }Â <span class="hljs-keyword">catch</span>Â (ExceptionÂ e)Â {
Â Â Â Â Â Â Â Â Â Â Â Â sqlSession.rollback();
Â Â Â Â Â Â Â Â Â Â Â Â <span class="hljs-keyword">throw</span>Â e;
Â Â Â Â Â Â Â Â }
Â Â Â Â }
}
</code></pre>
<p>ä¸Šçº¿åéªŒè¯ï¼Œé—®é¢˜è§£å†³ã€‚</p>
<h2 data-id="heading-3">äº‹åå¤ç›˜</h2>
<p>é—®é¢˜è™½ç„¶è§£å†³äº†ï¼Œä½†è¿˜æ˜¯å¾ˆå¥‡æ€ªï¼šä¸ºå•¥ä¸€ä¸ªä¸šåŠ¡çš„äº‹åŠ¡æ²¡æäº¤ï¼Œä¼šå½±å“åˆ°å…¶ä»–å®Œå…¨ä¸ç›¸å…³çš„æ”¯ä»˜ä¸šåŠ¡ï¼Ÿ</p>
<p>å‘¨æœ«èŠ±äº†åŠå¤©debugæºç ï¼Œç»ˆäºææ¸…æ¥šäº†ã€‚</p>
<h3 data-id="heading-4">æ–­ç‚¹æ‰“åœ¨getTransaction</h3>
<p>é¦–å…ˆåœ¨Springçš„<code>getTransaction</code>æ–¹æ³•æ‰“æ–­ç‚¹ï¼Œå‘ç°å‡ºé—®é¢˜çš„è¯·æ±‚éƒ½ä¼šèµ°åˆ°è¿™é‡Œï¼š</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">public</span>Â <span class="hljs-selector-tag">final</span>Â <span class="hljs-selector-tag">TransactionStatus</span>Â <span class="hljs-selector-tag">getTransaction</span>(<span class="hljs-variable">@Nullable</span>Â TransactionDefinitionÂ definition)
Â Â Â Â Â Â Â Â <span class="hljs-selector-tag">throws</span>Â <span class="hljs-selector-tag">TransactionException</span>Â {

Â Â Â Â <span class="hljs-comment">//Â ä½¿ç”¨é»˜è®¤çš„äº‹åŠ¡å®šä¹‰</span>
Â Â Â Â <span class="hljs-selector-tag">TransactionDefinition</span>Â <span class="hljs-selector-tag">def</span>Â =Â (definitionÂ !=Â nullÂ ?Â <span class="hljs-attribute">definitionÂ </span>:Â TransactionDefinition.<span class="hljs-built_in">withDefaults</span>());

Â Â Â Â <span class="hljs-comment">//Â å…³é”®ï¼šè·å–å½“å‰äº‹åŠ¡å¯¹è±¡</span>
Â Â Â Â <span class="hljs-selector-tag">Object</span>Â <span class="hljs-selector-tag">transaction</span>Â =Â <span class="hljs-selector-tag">doGetTransaction</span>();
Â Â Â Â <span class="hljs-selector-tag">boolean</span>Â <span class="hljs-selector-tag">debugEnabled</span>Â =Â <span class="hljs-selector-tag">logger</span><span class="hljs-selector-class">.isDebugEnabled</span>();

Â Â Â Â <span class="hljs-comment">//Â åˆ¤æ–­æ˜¯å¦æ˜¯å·²å­˜åœ¨çš„äº‹åŠ¡</span>
Â Â Â Â <span class="hljs-selector-tag">if</span>Â (<span class="hljs-built_in">isExistingTransaction</span>(transaction))Â {
Â Â Â Â Â Â Â Â <span class="hljs-comment">//Â å‘ç°å·²å­˜åœ¨çš„äº‹åŠ¡ï¼Œç›´æ¥è¿”å›</span>
Â Â Â Â Â Â Â Â <span class="hljs-selector-tag">return</span>Â <span class="hljs-selector-tag">handleExistingTransaction</span>(def,Â transaction,Â debugEnabled);
Â Â Â Â }

Â Â Â Â <span class="hljs-comment">//Â åˆ›å»ºæ–°äº‹åŠ¡çš„é€»è¾‘...</span>
}
</code></pre>
<p>é—®é¢˜å°±å‡ºåœ¨<code>doGetTransaction</code>è¿™ä¸ªæ–¹æ³•ã€‚</p>
<h3 data-id="heading-5">doGetTransactionä¼šå¤ç”¨è¿æ¥</h3>
<p>ç‚¹å¼€<code>doGetTransaction</code>ï¼Œä¼šå‘ç°ï¼š</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">protected</span>Â ObjectÂ <span class="hljs-title function_">doGetTransaction</span><span class="hljs-params">()</span>Â {
Â Â Â Â <span class="hljs-type">DataSourceTransactionObject</span>Â <span class="hljs-variable">txObject</span>Â <span class="hljs-operator">=</span>Â <span class="hljs-keyword">new</span>Â <span class="hljs-title class_">DataSourceTransactionObject</span>();
Â Â Â Â txObject.setSavepointAllowed(<span class="hljs-built_in">this</span>.isNestedTransactionAllowed());

Â Â Â Â <span class="hljs-comment">//Â å…³é”®ï¼šä»TransactionSynchronizationManagerè·å–è¿æ¥</span>
Â Â Â Â <span class="hljs-type">ConnectionHolder</span>Â <span class="hljs-variable">conHolder</span>Â <span class="hljs-operator">=</span>Â (ConnectionHolder)Â TransactionSynchronizationManager.getResource(<span class="hljs-built_in">this</span>.obtainDataSource());

Â Â Â Â txObject.setConnectionHolder(conHolder,Â <span class="hljs-literal">false</span>);
Â Â Â Â <span class="hljs-keyword">return</span>Â txObject;
}
</code></pre>
<p><code>TransactionSynchronizationManager.getResource</code>ä¼šä»è¿æ¥æ± æ‹¿è¿æ¥ã€‚å¦‚æœæ‹¿åˆ°ä¸€ä¸ªè¢«æ±¡æŸ“çš„è¿æ¥ï¼ˆä¸Šä¸€ä¸ªäº‹åŠ¡æ²¡æäº¤ï¼‰ï¼Œ<code>ConnectionHolder</code>é‡Œå°±å¸¦ç€ä¸Šä¸€ä¸ªäº‹åŠ¡çš„çŠ¶æ€ã€‚</p>
<h3 data-id="heading-6">isExistingTransactionçš„åˆ¤æ–­</h3>
<p>ç„¶å<code>isExistingTransaction</code>ä¼šæ£€æŸ¥è¿™ä¸ªè¿æ¥ï¼š</p>
<pre><code class="hljs language-scss" lang="scss">protectedÂ booleanÂ <span class="hljs-built_in">isExistingTransaction</span>(ObjectÂ transaction)Â {
Â Â Â Â DataSourceTransactionObjectÂ txObjectÂ =Â (DataSourceTransactionObject)transaction;
Â Â Â Â returnÂ txObject<span class="hljs-selector-class">.hasConnectionHolder</span>()Â &amp;&amp;Â txObject<span class="hljs-selector-class">.getConnectionHolder</span>()<span class="hljs-selector-class">.isTransactionActive</span>();
}
</code></pre>
<p>å¦‚æœè¿æ¥ä¸Šæœ‰äº‹åŠ¡æ ‡è®°(<code>isTransactionActive()</code>)ï¼Œå°±è®¤ä¸ºæ˜¯å·²å­˜åœ¨çš„äº‹åŠ¡ï¼Œä¸ä¼šåˆ›å»ºæ–°äº‹åŠ¡ã€‚</p>
<p>é—®é¢˜æ¥äº†ï¼šå¦‚æœä¸Šä¸€ä¸ªä¸šåŠ¡ç”¨å®Œè¿æ¥åï¼Œäº‹åŠ¡æ²¡æäº¤ä¹Ÿæ²¡å›æ»šï¼Œ<code>ConnectionHolder</code>çš„äº‹åŠ¡æ ‡è®°è¿˜åœ¨ã€‚ä¸‹ä¸€ä¸ªä¸šåŠ¡é€šè¿‡<code>doGetTransaction</code>ä»<code>TransactionSynchronizationManager</code>æ‹¿åˆ°è¿™ä¸ª<code>ConnectionHolder</code>ï¼Œå°±è¢«å½“æˆå·²å­˜åœ¨çš„äº‹åŠ¡äº†ã€‚</p>
<h3 data-id="heading-7">è¢«æ±¡æŸ“çš„è¿æ¥æ˜¯æ€ä¹ˆæ¥çš„</h3>
<p>å›é¡¾å‰é¢åº”æ€¥å¤„ç†æ—¶æ‰¾åˆ°çš„é‚£æ®µdemoä»£ç ï¼š</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span>Â <span class="hljs-keyword">class</span>Â <span class="hljs-title class_">SomeService</span>Â {

Â Â Â Â <span class="hljs-keyword">public</span>Â <span class="hljs-keyword">void</span>Â <span class="hljs-title function_">handleSpecialCase</span><span class="hljs-params">()</span>Â {
Â Â Â Â Â Â Â Â <span class="hljs-comment">//Â å¼€å¯äº‹åŠ¡</span>
Â Â Â Â Â Â Â Â <span class="hljs-type">TransactionStatus</span>Â <span class="hljs-variable">status</span>Â <span class="hljs-operator">=</span>Â transactionManager.getTransaction(<span class="hljs-keyword">new</span>Â <span class="hljs-title class_">DefaultTransactionDefinition</span>());

Â Â Â Â Â Â Â Â <span class="hljs-keyword">try</span>Â {
Â Â Â Â Â Â Â Â Â Â Â Â <span class="hljs-comment">//Â æ‰§è¡ŒSQL</span>
Â Â Â Â Â Â Â Â Â Â Â Â mapper.insert(data);

Â Â Â Â Â Â Â Â Â Â Â Â <span class="hljs-comment">//Â ç‰¹æ®Šåˆ†æ”¯ï¼šç›´æ¥returnï¼Œæ²¡commitï¼</span>
Â Â Â Â Â Â Â Â Â Â Â Â <span class="hljs-keyword">if</span>Â (specialCondition)Â {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â <span class="hljs-keyword">return</span>;
Â Â Â Â Â Â Â Â Â Â Â Â }

Â Â Â Â Â Â Â Â Â Â Â Â transactionManager.commit(status);
Â Â Â Â Â Â Â Â }Â <span class="hljs-keyword">catch</span>Â (ExceptionÂ e)Â {
Â Â Â Â Â Â Â Â Â Â Â Â transactionManager.rollback(status);
Â Â Â Â Â Â Â Â Â Â Â Â <span class="hljs-keyword">throw</span>Â e;
Â Â Â Â Â Â Â Â }
Â Â Â Â }
}
</code></pre>
<p>å½“èµ°åˆ°ç‰¹æ®Šåˆ†æ”¯returnæ—¶ï¼š</p>
<ul>
<li><code>ConnectionHolder</code>å·²ç»è¢«æ ‡è®°ä¸ºæœ‰äº‹åŠ¡ï¼ˆ<code>isTransactionActive() = true</code>ï¼‰</li>
<li>ä½†äº‹åŠ¡æ—¢æ²¡commitï¼Œä¹Ÿæ²¡rollback</li>
<li>æ–¹æ³•ç»“æŸåï¼Œè¿æ¥å½’è¿˜åˆ°<code>TransactionSynchronizationManager</code></li>
<li><code>ConnectionHolder</code>çš„äº‹åŠ¡æ ‡è®°è¿˜åœ¨</li>
</ul>
<p>è¿™ä¸ªè¿æ¥å°±è¢«æ±¡æŸ“äº†ã€‚</p>
<h3 data-id="heading-8">å¤ç”¨å¯¼è‡´çš„é—®é¢˜</h3>
<p>å…¶ä»–ä¸šåŠ¡åˆšå¥½å¤ç”¨åˆ°äº†è¿™ä¸ªè¢«æ±¡æŸ“çš„è¿æ¥ï¼š</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span>Â <span class="hljs-keyword">class</span>Â <span class="hljs-title class_">PaymentService</span>Â {

Â Â Â Â <span class="hljs-keyword">public</span>Â <span class="hljs-keyword">void</span>Â <span class="hljs-title function_">createOrder</span><span class="hljs-params">(OrderÂ order)</span>Â {
Â Â Â Â Â Â Â Â <span class="hljs-comment">//Â æ‰‹åŠ¨å¼€å¯äº‹åŠ¡</span>
Â Â Â Â Â Â Â Â <span class="hljs-type">TransactionStatus</span>Â <span class="hljs-variable">status</span>Â <span class="hljs-operator">=</span>Â transactionManager.getTransaction(<span class="hljs-keyword">new</span>Â <span class="hljs-title class_">DefaultTransactionDefinition</span>());

Â Â Â Â Â Â Â Â <span class="hljs-keyword">try</span>Â {
Â Â Â Â Â Â Â Â Â Â Â Â <span class="hljs-comment">//Â æ’å…¥è®¢å•</span>
Â Â Â Â Â Â Â Â Â Â Â Â orderMapper.insert(order);

Â Â Â Â Â Â Â Â Â Â Â Â <span class="hljs-comment">//Â æäº¤äº‹åŠ¡</span>
Â Â Â Â Â Â Â Â Â Â Â Â transactionManager.commit(status);
Â Â Â Â Â Â Â Â }Â <span class="hljs-keyword">catch</span>Â (ExceptionÂ e)Â {
Â Â Â Â Â Â Â Â Â Â Â Â transactionManager.rollback(status);
Â Â Â Â Â Â Â Â Â Â Â Â <span class="hljs-keyword">throw</span>Â e;
Â Â Â Â Â Â Â Â }
Â Â Â Â }
}
</code></pre>
<p>çœ‹èµ·æ¥æ²¡é—®é¢˜ï¼Œå¯¹å§ï¼Ÿä½†å½“è¿™ä¸ªæ–¹æ³•è·å–åˆ°è¢«æ±¡æŸ“çš„è¿æ¥æ—¶ï¼š</p>
<ol>
<li><code>getTransaction</code>åˆ¤æ–­<code>isExistingTransaction</code>ä¸ºtrue</li>
<li>èµ°è¿›<code>handleExistingTransaction</code>æ–¹æ³•</li>
<li>æ ¹æ®äº‹åŠ¡ä¼ æ’­è¡Œä¸ºï¼Œå¯èƒ½ä¼šåŠ å…¥ç°æœ‰äº‹åŠ¡ï¼Œè€Œä¸æ˜¯åˆ›å»ºæ–°äº‹åŠ¡</li>
<li>æœ€åcommitæ—¶ï¼Œå› ä¸ºä¸æ˜¯äº‹åŠ¡å‘èµ·è€…ï¼Œä¸ä¼šçœŸæ­£æäº¤</li>
</ol>
<h3 data-id="heading-9">processCommitçš„åˆ¤æ–­</h3>
<p>ç»§ç»­debugåˆ°commitæ–¹æ³•ï¼Œå‘ç°ä¼šæ‰§è¡ŒprocessCommitå»å®Œæˆæäº¤ï¼š</p>
<pre><code class="hljs language-scss" lang="scss">privateÂ voidÂ <span class="hljs-built_in">processCommit</span>(DefaultTransactionStatusÂ status)Â throwsÂ TransactionExceptionÂ {
Â Â Â Â tryÂ {
Â Â Â Â Â Â Â Â booleanÂ beforeCompletionInvokedÂ =Â false;

Â Â Â Â Â Â Â Â tryÂ {
Â Â Â Â Â Â Â Â Â Â Â Â <span class="hljs-built_in">prepareForCommit</span>(status);
Â Â Â Â Â Â Â Â Â Â Â Â <span class="hljs-built_in">triggerBeforeCommit</span>(status);
Â Â Â Â Â Â Â Â Â Â Â Â <span class="hljs-built_in">triggerBeforeCompletion</span>(status);
Â Â Â Â Â Â Â Â Â Â Â Â beforeCompletionInvokedÂ =Â true;

Â Â Â Â Â Â Â Â Â Â Â Â ifÂ (status.hasSavepoint())Â {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â status<span class="hljs-selector-class">.releaseHeldSavepoint</span>();
Â Â Â Â Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â Â Â Â Â <span class="hljs-comment">//Â å…³é”®åˆ¤æ–­ï¼šåªæœ‰æ–°äº‹åŠ¡æ‰çœŸæ­£æäº¤</span>
Â Â Â Â Â Â Â Â Â Â Â Â elseÂ ifÂ (status.isNewTransaction())Â {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â ifÂ (status.isDebug())Â {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â logger<span class="hljs-selector-class">.debug</span>("InitiatingÂ transactionÂ commit");
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â <span class="hljs-comment">//Â çœŸæ­£æ‰§è¡Œæ•°æ®åº“commit</span>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â <span class="hljs-built_in">doCommit</span>(status);
Â Â Â Â Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â Â Â Â Â <span class="hljs-comment">//Â å¦‚æœä¸æ˜¯æ–°äº‹åŠ¡ï¼Œä»€ä¹ˆéƒ½ä¸åšï¼</span>

Â Â Â Â Â Â Â Â }Â catchÂ (UnexpectedRollbackExceptionÂ ex)Â {
Â Â Â Â Â Â Â Â Â Â Â Â <span class="hljs-comment">//Â ...</span>
Â Â Â Â Â Â Â Â }

Â Â Â Â }Â finallyÂ {
Â Â Â Â Â Â Â Â <span class="hljs-built_in">cleanupAfterCompletion</span>(status);
Â Â Â Â }
}
</code></pre>
<p>å› ä¸º<code>status.isNewTransaction()</code>è¿”å›falseï¼ˆè¿™æ˜¯ä¸ªåŠ å…¥çš„äº‹åŠ¡ï¼Œä¸æ˜¯æ–°äº‹åŠ¡ï¼‰ï¼Œæ‰€ä»¥<code>doCommit(status)</code>æ ¹æœ¬ä¸ä¼šæ‰§è¡Œã€‚</p>
<p>çœŸæ­£çš„<code>connection.commit()</code>æ ¹æœ¬æ²¡æ‰§è¡Œã€‚</p>
<h3 data-id="heading-10">å®Œæ•´çš„é—®é¢˜é“¾è·¯</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/949f8bc5fad646ce99fe08ea931a121b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgOeWPt-i-vuS6ug==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766816735&amp;x-signature=eaui1jMxdtT2JMmKe2B7tW5yA9M%3D" alt="" loading="lazy"/></p>
<ol>
<li><code>SomeService.handleSpecialCase()</code>ç‰¹æ®Šåˆ†æ”¯æ²¡æäº¤äº‹åŠ¡</li>
<li>æ–¹æ³•ç»“æŸï¼Œ<code>ConnectionHolder</code>å½’è¿˜åˆ°<code>TransactionSynchronizationManager</code>ï¼Œä½†äº‹åŠ¡æ ‡è®°<code>isTransactionActive()</code>è¿˜æ˜¯true</li>
<li><code>PaymentService.createOrder()</code>è°ƒç”¨<code>doGetTransaction()</code></li>
<li><code>doGetTransaction</code>ä»<code>TransactionSynchronizationManager</code>æ‹¿åˆ°è¢«æ±¡æŸ“çš„<code>ConnectionHolder</code></li>
<li><code>isExistingTransaction</code>åˆ¤æ–­ä¸ºtrueï¼Œè®¤ä¸ºå·²æœ‰äº‹åŠ¡</li>
<li>èµ°<code>handleExistingTransaction</code>æµç¨‹ï¼ŒåŠ å…¥ç°æœ‰äº‹åŠ¡ï¼ˆ<code>isNewTransaction = false</code>ï¼‰</li>
<li>ä¸šåŠ¡ä»£ç æ‰§è¡Œå®Œï¼Œè°ƒç”¨<code>commit</code></li>
<li><code>processCommit</code>ä¸­åˆ¤æ–­<code>isNewTransaction()</code>ä¸ºfalseï¼Œè·³è¿‡<code>doCommit</code></li>
<li>æ•°æ®æ²¡å…¥åº“ï¼Œ<code>ConnectionHolder</code>ç»§ç»­å¾…åœ¨<code>TransactionSynchronizationManager</code>ï¼Œç»§ç»­æ±¡æŸ“ä¸‹ä¸€ä¸ªä¸šåŠ¡</li>
</ol>
<h2 data-id="heading-11">ä¸ºä»€ä¹ˆå¶å°”ä¼šæˆåŠŸï¼Ÿ</h2>
<p>å› ä¸º<code>TransactionSynchronizationManager</code>æ˜¯ThreadLocalå®ç°çš„ï¼Œæ¯ä¸ªçº¿ç¨‹æœ‰ç‹¬ç«‹çš„èµ„æºã€‚</p>
<p>å¦‚æœæ”¯ä»˜è¯·æ±‚åˆ†é…åˆ°ä¸€ä¸ªå¹²å‡€çš„çº¿ç¨‹ï¼ˆæ²¡æœ‰è¢«æ±¡æŸ“çš„<code>ConnectionHolder</code>ï¼‰ï¼Œå°±èƒ½æ­£å¸¸å·¥ä½œã€‚ä½†åªè¦åˆ†é…åˆ°è¢«æ±¡æŸ“çš„çº¿ç¨‹ï¼Œå°±ä¼šå‡ºé—®é¢˜ã€‚</p>
<p>è¿™å°±æ˜¯ä¸ºä»€ä¹ˆè¿™ä¸ªbugè¿™ä¹ˆéš¾å‘ç°ï¼š</p>
<ul>
<li>ä¸æ˜¯100%å¤ç°ï¼ˆå–å†³äºçº¿ç¨‹æ± è°ƒåº¦ï¼‰</li>
<li>æ²¡æœ‰æŠ¥é”™ä¿¡æ¯</li>
<li>æ—¥å¿—çœ‹èµ·æ¥æ­£å¸¸</li>
</ul>
<h2 data-id="heading-12">é¢„é˜²æªæ–½</h2>
<p>ç»è¿‡è¿™æ¬¡äº‹æ•…ï¼Œæˆ‘ä»¬åŠ äº†å‡ ä¸ªé¢„é˜²æªæ–½ã€‚</p>
<h3 data-id="heading-13">1. è¿æ¥æ± å¥åº·æ£€æŸ¥</h3>
<p>é…ç½®è¿æ¥æ± çš„è¿æ¥æ ¡éªŒï¼š</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
Â Â <span class="hljs-attr">datasource:</span>
Â Â Â Â <span class="hljs-attr">hikari:</span>
Â Â Â Â Â Â <span class="hljs-string">connection-test-query:</span>Â <span class="hljs-string">SELECT</span>Â <span class="hljs-number">1</span>
Â Â Â Â Â Â <span class="hljs-string">validation-timeout:</span>Â <span class="hljs-number">3000</span>
Â Â Â Â Â Â <span class="hljs-comment">#Â ä»æ± å­å–è¿æ¥å‰å…ˆæµ‹è¯•</span>
Â Â Â Â Â Â <span class="hljs-string">connection-init-sql:</span>Â <span class="hljs-string">SET</span>Â <span class="hljs-string">autocommit=1</span>
</code></pre>
<p><code>connection-init-sql</code>ä¼šåœ¨æ¯æ¬¡ä»æ± å­å–è¿æ¥æ—¶é‡ç½®çŠ¶æ€ï¼Œé¿å…è¢«æ±¡æŸ“çš„è¿æ¥å½±å“ä¸šåŠ¡ã€‚</p>
<h3 data-id="heading-14">2. ç›‘æ§å‘Šè­¦</h3>
<p>å¢åŠ æ•°æ®åº“é•¿äº‹åŠ¡ç›‘æ§ï¼š</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">--Â æŸ¥æ‰¾æ‰§è¡Œè¶…è¿‡30ç§’çš„äº‹åŠ¡</span>
<span class="hljs-keyword">SELECT</span>Â <span class="hljs-operator">*</span>
<span class="hljs-keyword">FROM</span>Â information_schema.innodb_trx
<span class="hljs-keyword">WHERE</span>Â TIME_TO_SEC(TIMEDIFF(NOW(),Â trx_started))Â <span class="hljs-operator">&gt;</span>Â <span class="hljs-number">30</span>;
</code></pre>
<p>é…ç½®å‘Šè­¦è§„åˆ™ï¼Œè¶…è¿‡30ç§’çš„äº‹åŠ¡ç«‹å³æŠ¥è­¦ã€‚</p>
<h2 data-id="heading-15">è¸©å‘æ€»ç»“</h2>
<p>è¿™æ¬¡äº‹æ•…è®©æˆ‘æ˜ç™½äº†å‡ ç‚¹ã€‚</p>
<h3 data-id="heading-16">1. è¿æ¥æ± ä¸åªæ˜¯æ€§èƒ½ä¼˜åŒ–</h3>
<p>ä¹‹å‰æˆ‘ä¸€ç›´è§‰å¾—è¿æ¥æ± å°±æ˜¯æå‡æ€§èƒ½çš„ã€‚è¿™æ¬¡æ‰æ‡‚ï¼Œè¿æ¥æ± è¿˜ä¼šå¸¦æ¥çŠ¶æ€å¤ç”¨çš„å‘ã€‚</p>
<p>ä¸€ä¸ªè¿æ¥çš„é—®é¢˜ï¼Œä¼šå½±å“åé¢æ‰€æœ‰å¤ç”¨è¿™ä¸ªè¿æ¥çš„ä¸šåŠ¡ã€‚</p>
<h3 data-id="heading-17">2. äº‹åŠ¡ç®¡ç†è¦å†™æ¸…æ¥š</h3>
<p>æ‰‹åŠ¨ç®¡ç†äº‹åŠ¡ï¼Œä¸€å®šè¦å†™æ¸…æ¥šcommitå’Œrollbackï¼š</p>
<ul>
<li>commitå†™åœ¨tryå—æœ«å°¾</li>
<li>rollbackå†™åœ¨catchå—</li>
<li>finallyå—å…³é—­èµ„æº</li>
</ul>
<p>åˆ«å·æ‡’çœè¿™å‡ è¡Œä»£ç ã€‚ä¸€ä¸ªé—æ¼çš„commitï¼Œå°±å¯èƒ½å¯¼è‡´çº¿ä¸Šäº‹æ•…ã€‚</p>
<h3 data-id="heading-18">3. ç›‘æ§è¦è¦†ç›–åˆ°æ•°æ®åº“å±‚</h3>
<p>åº”ç”¨å±‚æ—¥å¿—æ­£å¸¸ï¼Œä¸ä»£è¡¨æ•°æ®åº“å±‚æ²¡é—®é¢˜ã€‚</p>
<p>å¿…é¡»è¦æœ‰æ•°æ®åº“å±‚é¢çš„ç›‘æ§ï¼š</p>
<ul>
<li>æ…¢æŸ¥è¯¢</li>
<li>é•¿äº‹åŠ¡</li>
<li>é”ç­‰å¾…</li>
<li>è¿æ¥æ•°</li>
</ul>
<h3 data-id="heading-19">4. æºç ä¸èƒ½åªçœ‹ï¼Œè¦è°ƒè¯•</h3>
<p>çœ‹æºç å¾ˆå¤šæ—¶å€™çœ‹ä¸å‡ºé—®é¢˜ã€‚è¿™æ¬¡æ˜¯çœŸçš„æ‰“æ–­ç‚¹ä¸€æ­¥æ­¥èµ°ï¼Œæ‰å‘ç°<code>getTransaction</code>æ–¹æ³•é‡Œæœ‰ä¸ª<code>isExistingTransaction</code>çš„åˆ¤æ–­ã€‚</p>
<p>é‡åˆ°è¯¡å¼‚é—®é¢˜ï¼Œç›´æ¥ä¸Šæ–­ç‚¹è°ƒè¯•ã€‚çœ‹è°ƒç”¨æ ˆï¼Œçœ‹å˜é‡å€¼ï¼Œæ¯”çœ‹æ–‡æ¡£å¿«å¤šäº†ã€‚</p>
<h2 data-id="heading-20">å†™åœ¨æœ€å</h2>
<p>è¿™ä¸ªbugä¿®å¤åï¼Œæˆ‘è·ŸåŒäº‹ä¹Ÿåˆ†äº«äº†ä¸€ä¸‹ã€‚è®°å½•äº†é—®é¢˜ç°è±¡ã€æ’æŸ¥è¿‡ç¨‹ã€æ ¹æœ¬åŸå› ã€è§£å†³æ–¹æ¡ˆå’Œé¢„é˜²æªæ–½ã€‚</p>
<p>ä¸æ˜¯ä¸ºäº†ç”©é”…ï¼Œæ˜¯ä¸ºäº†è®©å›¢é˜Ÿå…¶ä»–äººé¿å…è¸©åŒæ ·çš„å‘ã€‚</p>
<p>æŠ€æœ¯å€ºä¸å¯æ€•ï¼Œå¯æ€•çš„æ˜¯è¸©å‘äº†è¿˜ä¸æ€»ç»“ã€‚</p>
<p>ç”Ÿäº§ç¯å¢ƒçš„æ¯ä¸€æ¬¡äº‹æ•…ï¼Œéƒ½æ˜¯å­¦ä¹ çš„æœºä¼šã€‚</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AQSæŠ½è±¡é˜Ÿåˆ—åŒæ­¥å™¨åŸç†ä¸åº”ç”¨]]></title>    <link>https://juejin.cn/post/7585382553290604580</link>    <guid>https://juejin.cn/post/7585382553290604580</guid>    <pubDate>2025-12-20T06:40:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585382553290604580" data-draft-id="7585171571129876516" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AQSæŠ½è±¡é˜Ÿåˆ—åŒæ­¥å™¨åŸç†ä¸åº”ç”¨"/> <meta itemprop="keywords" content="åç«¯"/> <meta itemprop="datePublished" content="2025-12-20T06:40:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ç„¡é‡"/> <meta itemprop="url" content="https://juejin.cn/user/1116759546145086"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="æ˜é‡‘"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AQSæŠ½è±¡é˜Ÿåˆ—åŒæ­¥å™¨åŸç†ä¸åº”ç”¨
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1116759546145086/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ç„¡é‡
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T06:40:38.000Z" title="Sat Dec 20 2025 06:40:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    é˜…è¯»33åˆ†é’Ÿ
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">ä¸€ã€ç†è®ºçŸ¥è¯†ä¸æ ¸å¿ƒæ¦‚å¿µ</h2>
<h3 data-id="heading-1">1.1 ä»€ä¹ˆæ˜¯AQS?</h3>
<p>AQS(AbstractQueuedSynchronizer,æŠ½è±¡é˜Ÿåˆ—åŒæ­¥å™¨)æ˜¯Javaå¹¶å‘åŒ…(JUC)ä¸­æœ€æ ¸å¿ƒçš„åŸºç¡€æ¡†æ¶ä¹‹ä¸€,ç”±Doug Leaå¤§å¸ˆè®¾è®¡å¹¶å®ç°ã€‚å®ƒä¸ºæ„å»ºé”å’ŒåŒæ­¥å™¨æä¾›äº†ä¸€å¥—é€šç”¨çš„æ¡†æ¶,é€šè¿‡<strong>å†…ç½®çš„FIFOåŒå‘é˜Ÿåˆ—</strong>æ¥ç®¡ç†çº¿ç¨‹çš„ç«äº‰å’Œç­‰å¾…ã€‚</p>
<p>ç®€å•æ¥è¯´,AQSè§£å†³äº†å®ç°åŒæ­¥å™¨æ—¶çš„å¤§é‡é€šç”¨æ€§å·¥ä½œ,åŒ…æ‹¬:</p>
<ul>
<li><strong>åŒæ­¥çŠ¶æ€çš„åŸå­æ€§ç®¡ç†</strong></li>
<li><strong>çº¿ç¨‹çš„é˜»å¡ä¸å”¤é†’</strong></li>
<li><strong>ç­‰å¾…é˜Ÿåˆ—çš„ç»´æŠ¤</strong></li>
</ul>
<p>å¼€å‘è€…åªéœ€è¦ç»§æ‰¿AQSå¹¶å®ç°ç‰¹å®šçš„å‡ ä¸ªæ–¹æ³•,å°±èƒ½æ„å»ºå‡ºå„ç§åŠŸèƒ½å¼ºå¤§çš„åŒæ­¥å·¥å…·ã€‚</p>
<h3 data-id="heading-2">1.2 AQSåœ¨Javaå¹¶å‘åŒ…ä¸­çš„åœ°ä½</h3>
<p>AQSæ˜¯æ•´ä¸ªJUCåŒ…çš„åŸºçŸ³,ä»¥ä¸‹åŒæ­¥å·¥å…·éƒ½åŸºäºAQSå®ç°:</p>
<p><strong>ç‹¬å é”:</strong></p>
<ul>
<li><code>ReentrantLock</code> - å¯é‡å…¥ç‹¬å é”</li>
<li><code>ReentrantReadWriteLock.WriteLock</code> - å†™é”</li>
</ul>
<p><strong>å…±äº«é”:</strong></p>
<ul>
<li><code>Semaphore</code> - ä¿¡å·é‡</li>
<li><code>CountDownLatch</code> - å€’è®¡æ•°é—¨é—©</li>
<li><code>ReentrantReadWriteLock.ReadLock</code> - è¯»é”</li>
</ul>
<p><strong>å…¶ä»–åŒæ­¥å·¥å…·:</strong></p>
<ul>
<li><code>CyclicBarrier</code> - å¾ªç¯å±éšœ(åŸºäºReentrantLock+Condition)</li>
<li><code>ThreadPoolExecutor.Worker</code> - çº¿ç¨‹æ± å·¥ä½œçº¿ç¨‹(å†…éƒ¨ä½¿ç”¨AQS)</li>
</ul>
<p>å¯ä»¥è¯´,æŒæ¡AQSåŸç†æ˜¯æ·±å…¥ç†è§£Javaå¹¶å‘ç¼–ç¨‹çš„å¿…ç»ä¹‹è·¯ã€‚</p>
<h3 data-id="heading-3">1.3 AQSçš„è®¾è®¡æ€æƒ³:æ¨¡æ¿æ–¹æ³•æ¨¡å¼</h3>
<p>AQSé‡‡ç”¨äº†<strong>æ¨¡æ¿æ–¹æ³•è®¾è®¡æ¨¡å¼</strong>:</p>
<p><strong>AQSå®šä¹‰äº†åŒæ­¥å™¨çš„éª¨æ¶æµç¨‹:</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// æ¨¡æ¿æ–¹æ³• - è·å–é”çš„æ ‡å‡†æµç¨‹</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">acquire</span><span class="hljs-params">(<span class="hljs-type">int</span> arg)</span> {
    <span class="hljs-keyword">if</span> (!tryAcquire(arg) &amp;&amp;           <span class="hljs-comment">// å°è¯•è·å–(å­ç±»å®ç°)</span>
        acquireQueued(                <span class="hljs-comment">// è¿›å…¥é˜Ÿåˆ—ç­‰å¾…(AQSå®ç°)</span>
            addWaiter(Node.EXCLUSIVE), arg)) <span class="hljs-comment">// åŠ å…¥é˜Ÿåˆ—(AQSå®ç°)</span>
        selfInterrupt();
}
</code></pre>
<p><strong>å­ç±»åªéœ€å®ç°å…·ä½“çš„è·å–/é‡Šæ”¾é€»è¾‘:</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryAcquire</span><span class="hljs-params">(<span class="hljs-type">int</span> arg)</span> {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnsupportedOperationException</span>();
}
</code></pre>
<p>è¿™ç§è®¾è®¡è®©AQSå¤ç”¨äº†çº¿ç¨‹è°ƒåº¦ã€é˜Ÿåˆ—ç®¡ç†ç­‰å¤æ‚é€»è¾‘,å­ç±»åªå…³æ³¨ä¸šåŠ¡è¯­ä¹‰ã€‚</p>
<h3 data-id="heading-4">1.4 åŒæ­¥å™¨ä¸é”çš„å…³ç³»</h3>
<p><strong>é”æ˜¯é¢å‘ä½¿ç”¨è€…çš„API</strong>, è€Œ<strong>åŒæ­¥å™¨æ˜¯é¢å‘é”å®ç°è€…çš„æ¡†æ¶</strong>:</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// é” - å¯¹å¤–API</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReentrantLock</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Lock</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Sync sync;  <span class="hljs-comment">// å†…éƒ¨åŒæ­¥å™¨</span>

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">lock</span><span class="hljs-params">()</span> {
        sync.acquire(<span class="hljs-number">1</span>);  <span class="hljs-comment">// å§”æ‰˜ç»™åŒæ­¥å™¨</span>
    }
}

<span class="hljs-comment">// åŒæ­¥å™¨ - å®ç°ç»†èŠ‚</span>
<span class="hljs-keyword">abstract</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Sync</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractQueuedSynchronizer</span> {
    <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">lock</span><span class="hljs-params">()</span>;

    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryAcquire</span><span class="hljs-params">(<span class="hljs-type">int</span> acquires)</span> {
        <span class="hljs-comment">// å…·ä½“çš„é”è·å–é€»è¾‘</span>
    }
}
</code></pre>
<p><strong>å…³é”®åŒºåˆ«:</strong></p>
<ul>
<li>é”å®šä¹‰äº†<code>lock()/unlock()</code>ç­‰ç”¨æˆ·å‹å¥½çš„API</li>
<li>åŒæ­¥å™¨è´Ÿè´£å®é™…çš„çº¿ç¨‹ç«äº‰ã€æ’é˜Ÿã€å”¤é†’ç­‰åº•å±‚æœºåˆ¶</li>
<li>ä¸€ä¸ªé”å¯ä»¥æœ‰å¤šç§åŒæ­¥å™¨å®ç°(å¦‚å…¬å¹³é”/éå…¬å¹³é”)</li>
</ul>
<hr/>
<h2 data-id="heading-5">äºŒã€åŸç†æ·±åº¦å‰–æ</h2>
<h3 data-id="heading-6">2.1 AQSæ ¸å¿ƒè®¾è®¡æ€æƒ³</h3>
<h4 data-id="heading-7">2.1.1 åŒæ­¥çŠ¶æ€(state)</h4>
<p>AQSä½¿ç”¨ä¸€ä¸ª<code>volatile int</code>ç±»å‹çš„æˆå‘˜å˜é‡<code>state</code>æ¥è¡¨ç¤ºåŒæ­¥çŠ¶æ€:</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> <span class="hljs-type">int</span> state;

<span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getState</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">return</span> state;
}

<span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setState</span><span class="hljs-params">(<span class="hljs-type">int</span> newState)</span> {
    state = newState;
}

<span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">compareAndSetState</span><span class="hljs-params">(<span class="hljs-type">int</span> expect, <span class="hljs-type">int</span> update)</span> {
    <span class="hljs-keyword">return</span> unsafe.compareAndSwapInt(<span class="hljs-built_in">this</span>, stateOffset, expect, update);
}
</code></pre>
<p><strong>stateçš„è¯­ä¹‰ç”±å­ç±»å®šä¹‰:</strong></p>






























<table><thead><tr><th>åŒæ­¥å™¨</th><th>stateå«ä¹‰</th><th>è·å–æ¡ä»¶</th></tr></thead><tbody><tr><td>ReentrantLock</td><td>é‡å…¥æ¬¡æ•°</td><td>state=0è¡¨ç¤ºæœªé”å®š</td></tr><tr><td>Semaphore</td><td>å‰©ä½™è®¸å¯æ•°</td><td>state&gt;0è¡¨ç¤ºæœ‰è®¸å¯</td></tr><tr><td>CountDownLatch</td><td>å€’è®¡æ•°å€¼</td><td>state=0è¡¨ç¤ºé—¨é—©æ‰“å¼€</td></tr><tr><td>ReentrantReadWriteLock</td><td>é«˜16ä½:è¯»é”æ•°<br/>ä½16ä½:å†™é”æ•°</td><td>å¤åˆåˆ¤æ–­</td></tr></tbody></table>
<p><strong>CASæ“ä½œä¿è¯åŸå­æ€§:</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// éå…¬å¹³é”çš„å¿«é€Ÿè·å–</span>
<span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">nonfairTryAcquire</span><span class="hljs-params">(<span class="hljs-type">int</span> acquires)</span> {
    <span class="hljs-keyword">final</span> <span class="hljs-type">Thread</span> <span class="hljs-variable">current</span> <span class="hljs-operator">=</span> Thread.currentThread();
    <span class="hljs-type">int</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> getState();
    <span class="hljs-keyword">if</span> (c == <span class="hljs-number">0</span>) {
        <span class="hljs-comment">// CASåŸå­æ“ä½œæŠ¢å é”</span>
        <span class="hljs-keyword">if</span> (compareAndSetState(<span class="hljs-number">0</span>, acquires)) {
            setExclusiveOwnerThread(current);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
}
</code></pre>
<h4 data-id="heading-8">2.1.2 CLHé˜Ÿåˆ—é”</h4>
<p>AQSå†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ªåŸºäº<strong>CLH(Craig, Landin, and Hagersten)é˜Ÿåˆ—é”</strong>çš„å˜ä½“:</p>
<p><strong>åŸå§‹CLHé˜Ÿåˆ—ç‰¹ç‚¹:</strong></p>
<ul>
<li>è‡ªæ—‹é”,åŸºäºé“¾è¡¨</li>
<li>æ¯ä¸ªèŠ‚ç‚¹è‡ªæ—‹æ£€æŸ¥å‰é©±èŠ‚ç‚¹çš„çŠ¶æ€</li>
<li>å‰é©±é‡Šæ”¾é”æ—¶,åç»§è‡ªåŠ¨è·å¾—é”</li>
</ul>
<p><strong>AQSçš„æ”¹è¿›:</strong></p>
<ul>
<li>ä½¿ç”¨åŒå‘é“¾è¡¨(ä¾¿äºå–æ¶ˆæ“ä½œ)</li>
<li>èŠ‚ç‚¹ä¸å†è‡ªæ—‹,è€Œæ˜¯é˜»å¡ç­‰å¾…(park/unpark)</li>
<li>å‰é©±èŠ‚ç‚¹è´Ÿè´£å”¤é†’åç»§èŠ‚ç‚¹</li>
</ul>
<p><strong>NodeèŠ‚ç‚¹ç»“æ„:</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Node</span> {
    <span class="hljs-comment">// æ¨¡å¼</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Node</span> <span class="hljs-variable">SHARED</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Node</span>();    <span class="hljs-comment">// å…±äº«æ¨¡å¼</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Node</span> <span class="hljs-variable">EXCLUSIVE</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;       <span class="hljs-comment">// ç‹¬å æ¨¡å¼</span>

    <span class="hljs-comment">// ç­‰å¾…çŠ¶æ€</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">CANCELLED</span> <span class="hljs-operator">=</span>  <span class="hljs-number">1</span>;  <span class="hljs-comment">// çº¿ç¨‹å·²å–æ¶ˆ</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">SIGNAL</span>    <span class="hljs-operator">=</span> -<span class="hljs-number">1</span>;  <span class="hljs-comment">// åç»§éœ€è¦å”¤é†’</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">CONDITION</span> <span class="hljs-operator">=</span> -<span class="hljs-number">2</span>;  <span class="hljs-comment">// åœ¨æ¡ä»¶é˜Ÿåˆ—ä¸­ç­‰å¾…</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">PROPAGATE</span> <span class="hljs-operator">=</span> -<span class="hljs-number">3</span>;  <span class="hljs-comment">// å…±äº«æ¨¡å¼ä¸‹ä¼ æ’­å”¤é†’</span>

    <span class="hljs-keyword">volatile</span> <span class="hljs-type">int</span> waitStatus;        <span class="hljs-comment">// å½“å‰èŠ‚ç‚¹çŠ¶æ€</span>
    <span class="hljs-keyword">volatile</span> Node prev;             <span class="hljs-comment">// å‰é©±èŠ‚ç‚¹</span>
    <span class="hljs-keyword">volatile</span> Node next;             <span class="hljs-comment">// åç»§èŠ‚ç‚¹</span>
    <span class="hljs-keyword">volatile</span> Thread thread;         <span class="hljs-comment">// ç­‰å¾…çš„çº¿ç¨‹</span>
    Node nextWaiter;               <span class="hljs-comment">// æ¡ä»¶é˜Ÿåˆ—ä¸‹ä¸€ä¸ªèŠ‚ç‚¹/æ¨¡å¼æ ‡è®°</span>
}
</code></pre>
<p><strong>é˜Ÿåˆ—ç»“æ„ç¤ºæ„(è§ä¸‹å›¾):</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f298f64fc56845e5b5e3301549ee0481~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54Sh6YeP:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766817638&amp;x-signature=7svwD2YJSrjKJGMFGzM25Q%2FlZF4%3D" alt="aqs-queue-structure.svg" loading="lazy"/>
<strong>åŒå‘é“¾è¡¨çš„ç»´æŠ¤:</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// å…¥é˜Ÿ - é€šè¿‡CASå°†èŠ‚ç‚¹åŠ åˆ°é˜Ÿå°¾</span>
<span class="hljs-keyword">private</span> Node <span class="hljs-title function_">enq</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Node node)</span> {
    <span class="hljs-keyword">for</span> (;;) {
        <span class="hljs-type">Node</span> <span class="hljs-variable">t</span> <span class="hljs-operator">=</span> tail;
        <span class="hljs-keyword">if</span> (t == <span class="hljs-literal">null</span>) {  <span class="hljs-comment">// é˜Ÿåˆ—ä¸ºç©º,åˆå§‹åŒ–</span>
            <span class="hljs-keyword">if</span> (compareAndSetHead(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Node</span>()))
                tail = head;
        } <span class="hljs-keyword">else</span> {
            node.prev = t;
            <span class="hljs-keyword">if</span> (compareAndSetTail(t, node)) {  <span class="hljs-comment">// CASè®¾ç½®tail</span>
                t.next = node;
                <span class="hljs-keyword">return</span> t;
            }
        }
    }
}
</code></pre>
<h4 data-id="heading-9">2.1.3 ç‹¬å æ¨¡å¼ä¸å…±äº«æ¨¡å¼</h4>
<p><strong>ç‹¬å æ¨¡å¼(Exclusive):</strong></p>
<ul>
<li>åŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½æŒæœ‰é”</li>
<li>å…¸å‹åº”ç”¨:ReentrantLockã€WriteLock</li>
</ul>
<p><strong>å…±äº«æ¨¡å¼(Shared):</strong></p>
<ul>
<li>åŒä¸€æ—¶åˆ»å…è®¸å¤šä¸ªçº¿ç¨‹åŒæ—¶æŒæœ‰</li>
<li>å…¸å‹åº”ç”¨:Semaphoreã€ReadLockã€CountDownLatch</li>
</ul>
<p><strong>å®ç°å·®å¼‚:</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ç‹¬å æ¨¡å¼ - è·å–æˆåŠŸååªå”¤é†’ä¸€ä¸ªåç»§</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setHead</span><span class="hljs-params">(Node node)</span> {
    head = node;
    node.thread = <span class="hljs-literal">null</span>;
    node.prev = <span class="hljs-literal">null</span>;
}

<span class="hljs-comment">// å…±äº«æ¨¡å¼ - è·å–æˆåŠŸåä¼ æ’­å”¤é†’</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setHeadAndPropagate</span><span class="hljs-params">(Node node, <span class="hljs-type">int</span> propagate)</span> {
    <span class="hljs-type">Node</span> <span class="hljs-variable">h</span> <span class="hljs-operator">=</span> head;
    setHead(node);

    <span class="hljs-comment">// å¦‚æœè¿˜æœ‰å‰©ä½™èµ„æº,ç»§ç»­å”¤é†’åç»§</span>
    <span class="hljs-keyword">if</span> (propagate &gt; <span class="hljs-number">0</span> || h == <span class="hljs-literal">null</span> || h.waitStatus &lt; <span class="hljs-number">0</span> ||
        (h = head) == <span class="hljs-literal">null</span> || h.waitStatus &lt; <span class="hljs-number">0</span>) {
        <span class="hljs-type">Node</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> node.next;
        <span class="hljs-keyword">if</span> (s == <span class="hljs-literal">null</span> || s.isShared())
            doReleaseShared();  <span class="hljs-comment">// ä¼ æ’­å”¤é†’</span>
    }
}
</code></pre>
<h3 data-id="heading-10">2.2 AQSæ ¸å¿ƒæ–¹æ³•æºç å‰–æ</h3>
<h4 data-id="heading-11">2.2.1 acquire(int arg) - ç‹¬å å¼è·å–</h4>
<p><strong>å®Œæ•´æµç¨‹:</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/62192b2f43e44181a3dd38ece2359787~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54Sh6YeP:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766817638&amp;x-signature=fkHI5VbjDn8QxCaSrChzzf6cvRI%3D" alt="aqs-acquire-flow.svg" loading="lazy"/></p>
<p><strong>æºç åˆ†æ:</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * ç‹¬å æ¨¡å¼è·å–,å¿½ç•¥ä¸­æ–­
 * 1. å°è¯•è·å–(tryAcquire)
 * 2. å¤±è´¥åˆ™åŠ å…¥é˜Ÿåˆ—å¹¶é˜»å¡(acquireQueued)
 * 3. è¢«å”¤é†’åé‡æ–°å°è¯•è·å–
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">acquire</span><span class="hljs-params">(<span class="hljs-type">int</span> arg)</span> {
    <span class="hljs-keyword">if</span> (!tryAcquire(arg) &amp;&amp;                    <span class="hljs-comment">// â‘ å°è¯•è·å–</span>
        acquireQueued(addWaiter(Node.EXCLUSIVE), arg))  <span class="hljs-comment">// â‘¡å…¥é˜Ÿ+è‡ªæ—‹</span>
        selfInterrupt();                        <span class="hljs-comment">// â‘¢è¡¥å¿ä¸­æ–­</span>
}

<span class="hljs-comment">// â‘  tryAcquire - å­ç±»å®ç°,å®šä¹‰è·å–è¯­ä¹‰</span>
<span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryAcquire</span><span class="hljs-params">(<span class="hljs-type">int</span> arg)</span> {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnsupportedOperationException</span>();
}

<span class="hljs-comment">// â‘¡ addWaiter - åˆ›å»ºèŠ‚ç‚¹å¹¶åŠ å…¥é˜Ÿå°¾</span>
<span class="hljs-keyword">private</span> Node <span class="hljs-title function_">addWaiter</span><span class="hljs-params">(Node mode)</span> {
    <span class="hljs-type">Node</span> <span class="hljs-variable">node</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Node</span>(Thread.currentThread(), mode);
    <span class="hljs-type">Node</span> <span class="hljs-variable">pred</span> <span class="hljs-operator">=</span> tail;

    <span class="hljs-comment">// å¿«é€Ÿå…¥é˜Ÿå°è¯•</span>
    <span class="hljs-keyword">if</span> (pred != <span class="hljs-literal">null</span>) {
        node.prev = pred;
        <span class="hljs-keyword">if</span> (compareAndSetTail(pred, node)) {
            pred.next = node;
            <span class="hljs-keyword">return</span> node;
        }
    }

    <span class="hljs-comment">// å¿«é€Ÿå¤±è´¥,è°ƒç”¨å®Œæ•´å…¥é˜Ÿé€»è¾‘</span>
    enq(node);
    <span class="hljs-keyword">return</span> node;
}

<span class="hljs-comment">// â‘¢ acquireQueued - åœ¨é˜Ÿåˆ—ä¸­è‡ªæ—‹è·å–</span>
<span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">acquireQueued</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Node node, <span class="hljs-type">int</span> arg)</span> {
    <span class="hljs-type">boolean</span> <span class="hljs-variable">failed</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">try</span> {
        <span class="hljs-type">boolean</span> <span class="hljs-variable">interrupted</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;
        <span class="hljs-keyword">for</span> (;;) {  <span class="hljs-comment">// è‡ªæ—‹</span>
            <span class="hljs-keyword">final</span> <span class="hljs-type">Node</span> <span class="hljs-variable">p</span> <span class="hljs-operator">=</span> node.predecessor();

            <span class="hljs-comment">// å‰é©±æ˜¯headæ‰æœ‰èµ„æ ¼å°è¯•è·å–</span>
            <span class="hljs-keyword">if</span> (p == head &amp;&amp; tryAcquire(arg)) {
                setHead(node);      <span class="hljs-comment">// è·å–æˆåŠŸ,è®¾ä¸ºæ–°head</span>
                p.next = <span class="hljs-literal">null</span>;      <span class="hljs-comment">// å¸®åŠ©GC</span>
                failed = <span class="hljs-literal">false</span>;
                <span class="hljs-keyword">return</span> interrupted;
            }

            <span class="hljs-comment">// æ£€æŸ¥æ˜¯å¦éœ€è¦é˜»å¡</span>
            <span class="hljs-keyword">if</span> (shouldParkAfterFailedAcquire(p, node) &amp;&amp;
                parkAndCheckInterrupt())  <span class="hljs-comment">// é˜»å¡ç­‰å¾…</span>
                interrupted = <span class="hljs-literal">true</span>;
        }
    } <span class="hljs-keyword">finally</span> {
        <span class="hljs-keyword">if</span> (failed)
            cancelAcquire(node);  <span class="hljs-comment">// å¼‚å¸¸æƒ…å†µå–æ¶ˆè·å–</span>
    }
}

<span class="hljs-comment">// åˆ¤æ–­æ˜¯å¦åº”è¯¥é˜»å¡</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">shouldParkAfterFailedAcquire</span><span class="hljs-params">(Node pred, Node node)</span> {
    <span class="hljs-type">int</span> <span class="hljs-variable">ws</span> <span class="hljs-operator">=</span> pred.waitStatus;

    <span class="hljs-keyword">if</span> (ws == Node.SIGNAL)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;  <span class="hljs-comment">// å‰é©±çŠ¶æ€ä¸ºSIGNAL,å¯ä»¥å®‰å¿ƒé˜»å¡</span>

    <span class="hljs-keyword">if</span> (ws &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-comment">// å‰é©±å·²å–æ¶ˆ,è·³è¿‡æ‰€æœ‰å·²å–æ¶ˆçš„èŠ‚ç‚¹</span>
        <span class="hljs-keyword">do</span> {
            node.prev = pred = pred.prev;
        } <span class="hljs-keyword">while</span> (pred.waitStatus &gt; <span class="hljs-number">0</span>);
        pred.next = node;
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// è®¾ç½®å‰é©±çŠ¶æ€ä¸ºSIGNAL</span>
        compareAndSetWaitStatus(pred, ws, Node.SIGNAL);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
}

<span class="hljs-comment">// é˜»å¡å½“å‰çº¿ç¨‹</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">parkAndCheckInterrupt</span><span class="hljs-params">()</span> {
    LockSupport.park(<span class="hljs-built_in">this</span>);  <span class="hljs-comment">// é˜»å¡</span>
    <span class="hljs-keyword">return</span> Thread.interrupted();  <span class="hljs-comment">// è¿”å›ä¸­æ–­çŠ¶æ€å¹¶æ¸…é™¤ä¸­æ–­æ ‡å¿—</span>
}
</code></pre>
<p><strong>å…³é”®ç‚¹:</strong></p>
<ol>
<li><strong>è‡ªæ—‹ä¸é˜»å¡ç»“åˆ</strong>: å…ˆè‡ªæ—‹å‡ æ¬¡,å¤±è´¥åæ‰é˜»å¡,å‡å°‘çº¿ç¨‹åˆ‡æ¢</li>
<li><strong>åªæœ‰headçš„åç»§èƒ½å°è¯•è·å–</strong>: ä¿è¯FIFOå…¬å¹³æ€§</li>
<li><strong>å‰é©±è´Ÿè´£å”¤é†’åç»§</strong>: é€šè¿‡waitStatus=SIGNALæ ‡è¯†</li>
<li><strong>ä¸­æ–­å¤„ç†</strong>: è·å–è¿‡ç¨‹ä¸­ä¸å“åº”ä¸­æ–­,åªè®°å½•æ ‡å¿—,æœ€åè¡¥å¿</li>
</ol>
<h4 data-id="heading-12">2.2.2 release(int arg) - ç‹¬å å¼é‡Šæ”¾</h4>
<p><strong>å®Œæ•´æµç¨‹:</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3bbb8fd5b8d848fda72108834ec7d602~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54Sh6YeP:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766817638&amp;x-signature=%2BpC%2FhgrD3axW4acoeizR3Td8zDY%3D" alt="aqs-release-flow.svg" loading="lazy"/></p>
<p><strong>æºç åˆ†æ:</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * ç‹¬å æ¨¡å¼é‡Šæ”¾
 * 1. å°è¯•é‡Šæ”¾(tryRelease)
 * 2. æˆåŠŸåˆ™å”¤é†’åç»§èŠ‚ç‚¹
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">release</span><span class="hljs-params">(<span class="hljs-type">int</span> arg)</span> {
    <span class="hljs-keyword">if</span> (tryRelease(arg)) {           <span class="hljs-comment">// â‘ å°è¯•é‡Šæ”¾</span>
        <span class="hljs-type">Node</span> <span class="hljs-variable">h</span> <span class="hljs-operator">=</span> head;
        <span class="hljs-keyword">if</span> (h != <span class="hljs-literal">null</span> &amp;&amp; h.waitStatus != <span class="hljs-number">0</span>)
            unparkSuccessor(h);      <span class="hljs-comment">// â‘¡å”¤é†’åç»§</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
}

<span class="hljs-comment">// â‘  tryRelease - å­ç±»å®ç°</span>
<span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryRelease</span><span class="hljs-params">(<span class="hljs-type">int</span> arg)</span> {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnsupportedOperationException</span>();
}

<span class="hljs-comment">// â‘¡ unparkSuccessor - å”¤é†’åç»§èŠ‚ç‚¹</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">unparkSuccessor</span><span class="hljs-params">(Node node)</span> {
    <span class="hljs-type">int</span> <span class="hljs-variable">ws</span> <span class="hljs-operator">=</span> node.waitStatus;
    <span class="hljs-keyword">if</span> (ws &lt; <span class="hljs-number">0</span>)
        compareAndSetWaitStatus(node, ws, <span class="hljs-number">0</span>);  <span class="hljs-comment">// æ¸…é™¤ä¿¡å·</span>

    <span class="hljs-type">Node</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> node.next;

    <span class="hljs-comment">// å¦‚æœåç»§ä¸ºç©ºæˆ–å·²å–æ¶ˆ,ä»tailå‘å‰æ‰¾æœ€è¿‘çš„æœ‰æ•ˆèŠ‚ç‚¹</span>
    <span class="hljs-keyword">if</span> (s == <span class="hljs-literal">null</span> || s.waitStatus &gt; <span class="hljs-number">0</span>) {
        s = <span class="hljs-literal">null</span>;
        <span class="hljs-keyword">for</span> (<span class="hljs-type">Node</span> <span class="hljs-variable">t</span> <span class="hljs-operator">=</span> tail; t != <span class="hljs-literal">null</span> &amp;&amp; t != node; t = t.prev)
            <span class="hljs-keyword">if</span> (t.waitStatus &lt;= <span class="hljs-number">0</span>)
                s = t;
    }

    <span class="hljs-keyword">if</span> (s != <span class="hljs-literal">null</span>)
        LockSupport.unpark(s.thread);  <span class="hljs-comment">// å”¤é†’çº¿ç¨‹</span>
}
</code></pre>
<p><strong>ä¸ºä»€ä¹ˆä»tailå‘å‰éå†?</strong></p>
<p>è€ƒè™‘å¹¶å‘å…¥é˜Ÿåœºæ™¯:</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// addWaiterä¸­çš„å…¥é˜Ÿæ“ä½œ</span>
node.prev = pred;                    <span class="hljs-comment">// â‘ è®¾ç½®prev</span>
<span class="hljs-keyword">if</span> (compareAndSetTail(pred, node)) { <span class="hljs-comment">// â‘¡CASè®¾ç½®tail</span>
    pred.next = node;                <span class="hljs-comment">// â‘¢è®¾ç½®next</span>
    <span class="hljs-keyword">return</span> node;
}
</code></pre>
<p>åœ¨â‘¡â‘¢ä¹‹é—´,<code>next</code>æŒ‡é’ˆå°šæœªè®¾ç½®,ä½†<code>prev</code>å·²ç»è®¾ç½®ã€‚ä»åå‘å‰éå†èƒ½ä¿è¯æ‰¾åˆ°æ‰€æœ‰å·²å…¥é˜Ÿçš„èŠ‚ç‚¹ã€‚</p>
<h4 data-id="heading-13">2.2.3 acquireShared(int arg) - å…±äº«å¼è·å–</h4>
<p><strong>æºç åˆ†æ:</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">acquireShared</span><span class="hljs-params">(<span class="hljs-type">int</span> arg)</span> {
    <span class="hljs-keyword">if</span> (tryAcquireShared(arg) &lt; <span class="hljs-number">0</span>)  <span class="hljs-comment">// è¿”å›å€¼:è´Ÿæ•°-å¤±è´¥,0-æˆåŠŸä½†æ— å‰©ä½™,æ­£æ•°-æˆåŠŸä¸”æœ‰å‰©ä½™</span>
        doAcquireShared(arg);
}

<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doAcquireShared</span><span class="hljs-params">(<span class="hljs-type">int</span> arg)</span> {
    <span class="hljs-keyword">final</span> <span class="hljs-type">Node</span> <span class="hljs-variable">node</span> <span class="hljs-operator">=</span> addWaiter(Node.SHARED);  <span class="hljs-comment">// å…±äº«æ¨¡å¼èŠ‚ç‚¹</span>
    <span class="hljs-type">boolean</span> <span class="hljs-variable">failed</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">try</span> {
        <span class="hljs-type">boolean</span> <span class="hljs-variable">interrupted</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;
        <span class="hljs-keyword">for</span> (;;) {
            <span class="hljs-keyword">final</span> <span class="hljs-type">Node</span> <span class="hljs-variable">p</span> <span class="hljs-operator">=</span> node.predecessor();
            <span class="hljs-keyword">if</span> (p == head) {
                <span class="hljs-type">int</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> tryAcquireShared(arg);
                <span class="hljs-keyword">if</span> (r &gt;= <span class="hljs-number">0</span>) {
                    setHeadAndPropagate(node, r);  <span class="hljs-comment">// å…³é”®:ä¼ æ’­å”¤é†’</span>
                    p.next = <span class="hljs-literal">null</span>;
                    <span class="hljs-keyword">if</span> (interrupted)
                        selfInterrupt();
                    failed = <span class="hljs-literal">false</span>;
                    <span class="hljs-keyword">return</span>;
                }
            }
            <span class="hljs-keyword">if</span> (shouldParkAfterFailedAcquire(p, node) &amp;&amp;
                parkAndCheckInterrupt())
                interrupted = <span class="hljs-literal">true</span>;
        }
    } <span class="hljs-keyword">finally</span> {
        <span class="hljs-keyword">if</span> (failed)
            cancelAcquire(node);
    }
}

<span class="hljs-comment">// å…±äº«æ¨¡å¼çš„æ ¸å¿ƒ:ä¼ æ’­å”¤é†’</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setHeadAndPropagate</span><span class="hljs-params">(Node node, <span class="hljs-type">int</span> propagate)</span> {
    <span class="hljs-type">Node</span> <span class="hljs-variable">h</span> <span class="hljs-operator">=</span> head;
    setHead(node);

    <span class="hljs-comment">// propagate &gt; 0è¡¨ç¤ºè¿˜æœ‰å‰©ä½™èµ„æº,ç»§ç»­å”¤é†’åç»§</span>
    <span class="hljs-keyword">if</span> (propagate &gt; <span class="hljs-number">0</span> || h == <span class="hljs-literal">null</span> || h.waitStatus &lt; <span class="hljs-number">0</span> ||
        (h = head) == <span class="hljs-literal">null</span> || h.waitStatus &lt; <span class="hljs-number">0</span>) {
        <span class="hljs-type">Node</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> node.next;
        <span class="hljs-keyword">if</span> (s == <span class="hljs-literal">null</span> || s.isShared())
            doReleaseShared();  <span class="hljs-comment">// é‡Šæ”¾å…±äº«é”,å”¤é†’åç»§</span>
    }
}
</code></pre>
<p><strong>å…±äº«æ¨¡å¼ä¸ç‹¬å æ¨¡å¼çš„å…³é”®åŒºåˆ«:</strong></p>
<ul>
<li>ç‹¬å : åªå”¤é†’ä¸€ä¸ªåç»§,åç»§æˆä¸ºæ–°head</li>
<li>å…±äº«: å”¤é†’åç»§,åç»§ç»§ç»­å”¤é†’ä¸‹ä¸€ä¸ª,å½¢æˆ<strong>ä¼ æ’­é“¾</strong></li>
</ul>
<h4 data-id="heading-14">2.2.4 æ¡ä»¶é˜Ÿåˆ—(Condition)</h4>
<p><strong>ConditionObjectå®ç°åŸç†:</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConditionObject</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Condition</span> {
    <span class="hljs-comment">// æ¡ä»¶é˜Ÿåˆ—å¤´å°¾æŒ‡é’ˆ(å•å‘é“¾è¡¨)</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">transient</span> Node firstWaiter;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">transient</span> Node lastWaiter;

    <span class="hljs-comment">// await - é‡Šæ”¾é”,åŠ å…¥æ¡ä»¶é˜Ÿåˆ—,ç­‰å¾…signal</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">await</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException {
        <span class="hljs-keyword">if</span> (Thread.interrupted())
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InterruptedException</span>();

        <span class="hljs-type">Node</span> <span class="hljs-variable">node</span> <span class="hljs-operator">=</span> addConditionWaiter();    <span class="hljs-comment">// â‘ åŠ å…¥æ¡ä»¶é˜Ÿåˆ—</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">savedState</span> <span class="hljs-operator">=</span> fullyRelease(node); <span class="hljs-comment">// â‘¡å®Œå…¨é‡Šæ”¾é”</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">interruptMode</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;

        <span class="hljs-comment">// â‘¢ä¸åœ¨åŒæ­¥é˜Ÿåˆ—ä¸­åˆ™é˜»å¡</span>
        <span class="hljs-keyword">while</span> (!isOnSyncQueue(node)) {
            LockSupport.park(<span class="hljs-built_in">this</span>);
            <span class="hljs-keyword">if</span> ((interruptMode = checkInterruptWhileWaiting(node)) != <span class="hljs-number">0</span>)
                <span class="hljs-keyword">break</span>;
        }

        <span class="hljs-comment">// â‘£è¢«signalå,é‡æ–°ç«äº‰é”</span>
        <span class="hljs-keyword">if</span> (acquireQueued(node, savedState) &amp;&amp; interruptMode != THROW_IE)
            interruptMode = REINTERRUPT;

        <span class="hljs-keyword">if</span> (node.nextWaiter != <span class="hljs-literal">null</span>)
            unlinkCancelledWaiters();  <span class="hljs-comment">// æ¸…ç†å–æ¶ˆèŠ‚ç‚¹</span>

        <span class="hljs-keyword">if</span> (interruptMode != <span class="hljs-number">0</span>)
            reportInterruptAfterWait(interruptMode);
    }

    <span class="hljs-comment">// signal - å°†æ¡ä»¶é˜Ÿåˆ—å¤´èŠ‚ç‚¹è½¬ç§»åˆ°åŒæ­¥é˜Ÿåˆ—</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">signal</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">if</span> (!isHeldExclusively())
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalMonitorStateException</span>();

        <span class="hljs-type">Node</span> <span class="hljs-variable">first</span> <span class="hljs-operator">=</span> firstWaiter;
        <span class="hljs-keyword">if</span> (first != <span class="hljs-literal">null</span>)
            doSignal(first);  <span class="hljs-comment">// è½¬ç§»åˆ°åŒæ­¥é˜Ÿåˆ—</span>
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doSignal</span><span class="hljs-params">(Node first)</span> {
        <span class="hljs-keyword">do</span> {
            <span class="hljs-keyword">if</span> ((firstWaiter = first.nextWaiter) == <span class="hljs-literal">null</span>)
                lastWaiter = <span class="hljs-literal">null</span>;
            first.nextWaiter = <span class="hljs-literal">null</span>;
        } <span class="hljs-keyword">while</span> (!transferForSignal(first) &amp;&amp;  <span class="hljs-comment">// è½¬ç§»èŠ‚ç‚¹</span>
                 (first = firstWaiter) != <span class="hljs-literal">null</span>);
    }
}

<span class="hljs-comment">// å°†èŠ‚ç‚¹ä»æ¡ä»¶é˜Ÿåˆ—è½¬ç§»åˆ°åŒæ­¥é˜Ÿåˆ—</span>
<span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">transferForSignal</span><span class="hljs-params">(Node node)</span> {
    <span class="hljs-comment">// CASä¿®æ”¹çŠ¶æ€ä»CONDITIONåˆ°0</span>
    <span class="hljs-keyword">if</span> (!compareAndSetWaitStatus(node, Node.CONDITION, <span class="hljs-number">0</span>))
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;

    <span class="hljs-comment">// åŠ å…¥åŒæ­¥é˜Ÿåˆ—</span>
    <span class="hljs-type">Node</span> <span class="hljs-variable">p</span> <span class="hljs-operator">=</span> enq(node);
    <span class="hljs-type">int</span> <span class="hljs-variable">ws</span> <span class="hljs-operator">=</span> p.waitStatus;

    <span class="hljs-comment">// å¦‚æœå‰é©±å·²å–æ¶ˆæˆ–è®¾ç½®SIGNALå¤±è´¥,ç›´æ¥å”¤é†’</span>
    <span class="hljs-keyword">if</span> (ws &gt; <span class="hljs-number">0</span> || !compareAndSetWaitStatus(p, ws, Node.SIGNAL))
        LockSupport.unpark(node.thread);
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}
</code></pre>
<p><strong>æ¡ä»¶é˜Ÿåˆ— vs åŒæ­¥é˜Ÿåˆ—:</strong></p>



































<table><thead><tr><th>ç»´åº¦</th><th>æ¡ä»¶é˜Ÿåˆ—</th><th>åŒæ­¥é˜Ÿåˆ—</th></tr></thead><tbody><tr><td>æ•°æ®ç»“æ„</td><td>å•å‘é“¾è¡¨</td><td>åŒå‘é“¾è¡¨</td></tr><tr><td>èŠ‚ç‚¹çŠ¶æ€</td><td>CONDITION(-2)</td><td>SIGNAL(-1)ç­‰</td></tr><tr><td>è§¦å‘æ¡ä»¶</td><td>await()ä¸»åŠ¨è¿›å…¥</td><td>é”ç«äº‰å¤±è´¥è¿›å…¥</td></tr><tr><td>é€€å‡ºæ¡ä»¶</td><td>signal()å”¤é†’</td><td>å‰é©±é‡Šæ”¾é”</td></tr><tr><td>å¤šæ¡ä»¶æ”¯æŒ</td><td>ä¸€ä¸ªLockå¤šä¸ªCondition</td><td>ä¸€ä¸ªåŒæ­¥é˜Ÿåˆ—</td></tr></tbody></table>
<p><strong>Conditionä½¿ç”¨åœºæ™¯:</strong></p>
<p>ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼:</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">BoundedBuffer</span> {
    <span class="hljs-keyword">final</span> <span class="hljs-type">Lock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReentrantLock</span>();
    <span class="hljs-keyword">final</span> <span class="hljs-type">Condition</span> <span class="hljs-variable">notFull</span>  <span class="hljs-operator">=</span> lock.newCondition();  <span class="hljs-comment">// éæ»¡æ¡ä»¶</span>
    <span class="hljs-keyword">final</span> <span class="hljs-type">Condition</span> <span class="hljs-variable">notEmpty</span> <span class="hljs-operator">=</span> lock.newCondition();  <span class="hljs-comment">// éç©ºæ¡ä»¶</span>

    <span class="hljs-keyword">final</span> Object[] items = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[<span class="hljs-number">100</span>];
    <span class="hljs-type">int</span> putptr, takeptr, count;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">put</span><span class="hljs-params">(Object x)</span> <span class="hljs-keyword">throws</span> InterruptedException {
        lock.lock();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">while</span> (count == items.length)
                notFull.await();  <span class="hljs-comment">// é˜Ÿåˆ—æ»¡,ç­‰å¾…notFullä¿¡å·</span>

            items[putptr] = x;
            <span class="hljs-keyword">if</span> (++putptr == items.length) putptr = <span class="hljs-number">0</span>;
            ++count;
            notEmpty.signal();  <span class="hljs-comment">// é€šçŸ¥æ¶ˆè´¹è€…</span>
        } <span class="hljs-keyword">finally</span> {
            lock.unlock();
        }
    }

    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">take</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException {
        lock.lock();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">while</span> (count == <span class="hljs-number">0</span>)
                notEmpty.await();  <span class="hljs-comment">// é˜Ÿåˆ—ç©º,ç­‰å¾…notEmptyä¿¡å·</span>

            <span class="hljs-type">Object</span> <span class="hljs-variable">x</span> <span class="hljs-operator">=</span> items[takeptr];
            <span class="hljs-keyword">if</span> (++takeptr == items.length) takeptr = <span class="hljs-number">0</span>;
            --count;
            notFull.signal();  <span class="hljs-comment">// é€šçŸ¥ç”Ÿäº§è€…</span>
            <span class="hljs-keyword">return</span> x;
        } <span class="hljs-keyword">finally</span> {
            lock.unlock();
        }
    }
}
</code></pre>
<h3 data-id="heading-15">2.3 ReentrantLock vs synchronizedæ·±åº¦å¯¹æ¯”</h3>
<h4 data-id="heading-16">2.3.1 åŠŸèƒ½å¯¹æ¯”</h4>























































<table><thead><tr><th>åŠŸèƒ½</th><th>synchronized</th><th>ReentrantLock</th></tr></thead><tbody><tr><td>å¯é‡å…¥æ€§</td><td>âœ…æ”¯æŒ</td><td>âœ…æ”¯æŒ</td></tr><tr><td>å…¬å¹³æ€§é€‰æ‹©</td><td>âŒä¸æ”¯æŒ(éå…¬å¹³)</td><td>âœ…æ”¯æŒå…¬å¹³/éå…¬å¹³</td></tr><tr><td>å¯ä¸­æ–­è·å–</td><td>âŒä¸æ”¯æŒ</td><td>âœ…lockInterruptibly()</td></tr><tr><td>è¶…æ—¶è·å–</td><td>âŒä¸æ”¯æŒ</td><td>âœ…tryLock(timeout)</td></tr><tr><td>éé˜»å¡è·å–</td><td>âŒä¸æ”¯æŒ</td><td>âœ…tryLock()</td></tr><tr><td>æ¡ä»¶å˜é‡</td><td>âŒåªæœ‰ä¸€ä¸ª(wait/notify)</td><td>âœ…å¤šä¸ªCondition</td></tr><tr><td>é”ç»‘å®š</td><td>âŒç»‘å®šå¯¹è±¡</td><td>âœ…å¯ç»‘å®šä»»æ„å¯¹è±¡</td></tr><tr><td>è‡ªåŠ¨é‡Šæ”¾</td><td>âœ…JVMè‡ªåŠ¨</td><td>âŒéœ€æ‰‹åŠ¨unlock</td></tr><tr><td>æ­»é”æ£€æµ‹</td><td>âœ…JVMæ”¯æŒ</td><td>âŒéœ€è‡ªè¡Œå®ç°</td></tr></tbody></table>
<p><strong>ä»£ç ç¤ºä¾‹å¯¹æ¯”:</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// synchronized - ç®€æ´ä½†åŠŸèƒ½å—é™</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">method</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// ä¸šåŠ¡é€»è¾‘</span>
}

<span class="hljs-comment">// ReentrantLock - çµæ´»ä½†éœ€æ‰‹åŠ¨ç®¡ç†</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ReentrantLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReentrantLock</span>(<span class="hljs-literal">true</span>);  <span class="hljs-comment">// å…¬å¹³é”</span>

<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">method</span><span class="hljs-params">()</span> {
    lock.lock();
    <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// ä¸šåŠ¡é€»è¾‘</span>
    } <span class="hljs-keyword">finally</span> {
        lock.unlock();  <span class="hljs-comment">// å¿…é¡»åœ¨finallyä¸­é‡Šæ”¾</span>
    }
}

<span class="hljs-comment">// å¯ä¸­æ–­è·å–</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">methodWithInterrupt</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException {
    lock.lockInterruptibly();
    <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// é•¿æ—¶é—´æ“ä½œ</span>
    } <span class="hljs-keyword">finally</span> {
        lock.unlock();
    }
}

<span class="hljs-comment">// è¶…æ—¶è·å–</span>
<span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">methodWithTimeout</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">if</span> (lock.tryLock(<span class="hljs-number">3</span>, TimeUnit.SECONDS)) {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// ä¸šåŠ¡é€»è¾‘</span>
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        } <span class="hljs-keyword">finally</span> {
            lock.unlock();
        }
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;  <span class="hljs-comment">// è·å–é”è¶…æ—¶</span>
}
</code></pre>
<h4 data-id="heading-17">2.3.2 æ€§èƒ½å¯¹æ¯”</h4>
<p><strong>JDK 1.6ä¹‹å‰:</strong></p>
<ul>
<li>synchronizedæ˜¯é‡é‡çº§é”,å®Œå…¨ä¾èµ–æ“ä½œç³»ç»Ÿäº’æ–¥é‡</li>
<li>ReentrantLockå®Œå…¨åœ¨ç”¨æˆ·æ€å®ç°,æ€§èƒ½æ˜æ˜¾ä¼˜äºsynchronized</li>
</ul>
<p><strong>JDK 1.6ä¹‹å(é”ä¼˜åŒ–):</strong></p>
<ul>
<li>synchronizedå¼•å…¥åå‘é”ã€è½»é‡çº§é”ã€è‡ªæ—‹é”ç­‰ä¼˜åŒ–</li>
<li>ä½ç«äº‰åœºæ™¯ä¸‹,synchronizedæ€§èƒ½ä¸ReentrantLockç›¸å½“ç”šè‡³æ›´å¥½</li>
</ul>
<p><strong>æ€§èƒ½æµ‹è¯•(JDK 17):</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@BenchmarkMode(Mode.Throughput)</span>
<span class="hljs-meta">@Warmup(iterations = 3)</span>
<span class="hljs-meta">@Measurement(iterations = 5)</span>
<span class="hljs-meta">@State(Scope.Benchmark)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LockBenchmark</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">syncLock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ReentrantLock</span> <span class="hljs-variable">reentrantLock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReentrantLock</span>();
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;

    <span class="hljs-comment">// ä½ç«äº‰åœºæ™¯(1çº¿ç¨‹)</span>
    <span class="hljs-meta">@Benchmark</span>
    <span class="hljs-meta">@Threads(1)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">synchronizedLowContention</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">synchronized</span> (syncLock) {
            count++;
        }
    }

    <span class="hljs-meta">@Benchmark</span>
    <span class="hljs-meta">@Threads(1)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">reentrantLockLowContention</span><span class="hljs-params">()</span> {
        reentrantLock.lock();
        <span class="hljs-keyword">try</span> {
            count++;
        } <span class="hljs-keyword">finally</span> {
            reentrantLock.unlock();
        }
    }

    <span class="hljs-comment">// é«˜ç«äº‰åœºæ™¯(16çº¿ç¨‹)</span>
    <span class="hljs-meta">@Benchmark</span>
    <span class="hljs-meta">@Threads(16)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">synchronizedHighContention</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">synchronized</span> (syncLock) {
            count++;
        }
    }

    <span class="hljs-meta">@Benchmark</span>
    <span class="hljs-meta">@Threads(16)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">reentrantLockHighContention</span><span class="hljs-params">()</span> {
        reentrantLock.lock();
        <span class="hljs-keyword">try</span> {
            count++;
        } <span class="hljs-keyword">finally</span> {
            reentrantLock.unlock();
        }
    }
}
</code></pre>
<p><strong>æµ‹è¯•ç»“æœ(ops/s,è¶Šé«˜è¶Šå¥½):</strong></p>























<table><thead><tr><th>åœºæ™¯</th><th>synchronized</th><th>ReentrantLock(éå…¬å¹³)</th><th>ReentrantLock(å…¬å¹³)</th></tr></thead><tbody><tr><td>ä½ç«äº‰(1çº¿ç¨‹)</td><td>120M</td><td>115M</td><td>110M</td></tr><tr><td>é«˜ç«äº‰(16çº¿ç¨‹)</td><td>8M</td><td>12M</td><td>6M</td></tr></tbody></table>
<p><strong>ç»“è®º:</strong></p>
<ul>
<li><strong>ä½ç«äº‰</strong>: synchronizedç•¥ä¼˜(JVMä¼˜åŒ–å¥½)</li>
<li><strong>é«˜ç«äº‰</strong>: ReentrantLockéå…¬å¹³æ¨¡å¼æœ€ä¼˜</li>
<li><strong>å…¬å¹³é”</strong>: æ€§èƒ½æ˜æ˜¾ä¸‹é™(éœ€ç»´æŠ¤FIFOé¡ºåº)</li>
</ul>
<h4 data-id="heading-18">2.3.3 ä½¿ç”¨åœºæ™¯é€‰æ‹©</h4>
<p><strong>é€‰æ‹©synchronizedçš„åœºæ™¯:</strong></p>
<ul>
<li>âœ… ç®€å•çš„äº’æ–¥è®¿é—®</li>
<li>âœ… ä¸éœ€è¦é«˜çº§ç‰¹æ€§(ä¸­æ–­ã€è¶…æ—¶ã€å…¬å¹³æ€§)</li>
<li>âœ… ä»£ç ç®€æ´æ€§ä¼˜å…ˆ</li>
<li>âœ… å…¼å®¹æ—§ä»£ç </li>
</ul>
<p><strong>é€‰æ‹©ReentrantLockçš„åœºæ™¯:</strong></p>
<ul>
<li>âœ… éœ€è¦å…¬å¹³é”(é¿å…çº¿ç¨‹é¥¥é¥¿)</li>
<li>âœ… éœ€è¦å¯ä¸­æ–­è·å–(å¦‚è¶…æ—¶å–æ¶ˆ)</li>
<li>âœ… éœ€è¦å°è¯•è·å–(tryLock)</li>
<li>âœ… éœ€è¦å¤šä¸ªæ¡ä»¶å˜é‡(å¤æ‚ç­‰å¾…é€šçŸ¥)</li>
<li>âœ… éœ€è¦é”æŠ•ç¥¨ã€å®šæ—¶ã€å¯ä¸­æ–­çš„é”è·å–</li>
</ul>
<p><strong>å†³ç­–æ ‘:</strong></p>
<pre><code class="hljs language-arduino" lang="arduino">éœ€è¦é«˜çº§ç‰¹æ€§?
â”œâ”€ æ˜¯ â†’ ReentrantLock
â”‚   â”œâ”€ éœ€è¦å…¬å¹³æ€§? â†’ <span class="hljs-keyword">new</span> <span class="hljs-built_in">ReentrantLock</span>(<span class="hljs-literal">true</span>)
â”‚   â””â”€ æ€§èƒ½ä¼˜å…ˆ? â†’ <span class="hljs-keyword">new</span> <span class="hljs-built_in">ReentrantLock</span>(<span class="hljs-literal">false</span>)
â””â”€ å¦ â†’ <span class="hljs-keyword">synchronized</span>
</code></pre>
<h3 data-id="heading-19">2.4 å…¶ä»–AQSåŒæ­¥å·¥å…·å®ç°åŸç†</h3>
<h4 data-id="heading-20">2.4.1 CountDownLatch - å€’è®¡æ•°é—¨é—©</h4>
<p><strong>å®ç°åŸç†:</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CountDownLatch</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Sync</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractQueuedSynchronizer</span> {
        Sync(<span class="hljs-type">int</span> count) {
            setState(count);  <span class="hljs-comment">// state=å€’è®¡æ•°åˆå§‹å€¼</span>
        }

        <span class="hljs-comment">// å…±äº«å¼è·å–:state=0æ—¶æˆåŠŸ</span>
        <span class="hljs-keyword">protected</span> <span class="hljs-type">int</span> <span class="hljs-title function_">tryAcquireShared</span><span class="hljs-params">(<span class="hljs-type">int</span> acquires)</span> {
            <span class="hljs-keyword">return</span> (getState() == <span class="hljs-number">0</span>) ? <span class="hljs-number">1</span> : -<span class="hljs-number">1</span>;
        }

        <span class="hljs-comment">// å…±äº«å¼é‡Šæ”¾:é€’å‡state</span>
        <span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryReleaseShared</span><span class="hljs-params">(<span class="hljs-type">int</span> releases)</span> {
            <span class="hljs-keyword">for</span> (;;) {
                <span class="hljs-type">int</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> getState();
                <span class="hljs-keyword">if</span> (c == <span class="hljs-number">0</span>)
                    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;  <span class="hljs-comment">// å·²ç»ä¸º0,æ— éœ€é‡Šæ”¾</span>

                <span class="hljs-type">int</span> <span class="hljs-variable">nextc</span> <span class="hljs-operator">=</span> c - <span class="hljs-number">1</span>;
                <span class="hljs-keyword">if</span> (compareAndSetState(c, nextc))
                    <span class="hljs-keyword">return</span> nextc == <span class="hljs-number">0</span>;  <span class="hljs-comment">// å‡åˆ°0æ—¶è¿”å›true,è§¦å‘å”¤é†’</span>
            }
        }
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Sync sync;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">CountDownLatch</span><span class="hljs-params">(<span class="hljs-type">int</span> count)</span> {
        <span class="hljs-keyword">if</span> (count &lt; <span class="hljs-number">0</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"count &lt; 0"</span>);
        <span class="hljs-built_in">this</span>.sync = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Sync</span>(count);
    }

    <span class="hljs-comment">// ç­‰å¾…stateå‡åˆ°0</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">await</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException {
        sync.acquireSharedInterruptibly(<span class="hljs-number">1</span>);
    }

    <span class="hljs-comment">// é€’å‡state</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">countDown</span><span class="hljs-params">()</span> {
        sync.releaseShared(<span class="hljs-number">1</span>);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-type">long</span> <span class="hljs-title function_">getCount</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> sync.getState();
    }
}
</code></pre>
<p><strong>å…³é”®ç‚¹:</strong></p>
<ul>
<li>stateè¡¨ç¤ºå€’è®¡æ•°å€¼</li>
<li><code>await()</code>åœ¨state&gt;0æ—¶é˜»å¡,state=0æ—¶æ‰€æœ‰çº¿ç¨‹ä¸€èµ·è¢«å”¤é†’</li>
<li><code>countDown()</code>æ¯æ¬¡é€’å‡state,å‡åˆ°0æ—¶å”¤é†’æ‰€æœ‰ç­‰å¾…çº¿ç¨‹</li>
<li><strong>ä¸€æ¬¡æ€§ä½¿ç”¨</strong>: stateå‡åˆ°0åæ— æ³•é‡ç½®</li>
</ul>
<h4 data-id="heading-21">2.4.2 CyclicBarrier - å¾ªç¯å±éšœ</h4>
<p><strong>å®ç°åŸç†(åŸºäºReentrantLock + Condition):</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CyclicBarrier</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ReentrantLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReentrantLock</span>();
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Condition</span> <span class="hljs-variable">trip</span> <span class="hljs-operator">=</span> lock.newCondition();
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> parties;        <span class="hljs-comment">// å‚ä¸çº¿ç¨‹æ•°</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Runnable barrierCommand;  <span class="hljs-comment">// å±éšœåŠ¨ä½œ</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> count;                <span class="hljs-comment">// å‰©ä½™ç­‰å¾…æ•°</span>

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Generation</span> {
        <span class="hljs-type">boolean</span> <span class="hljs-variable">broken</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;       <span class="hljs-comment">// å±éšœæ˜¯å¦è¢«ç ´å</span>
    }
    <span class="hljs-keyword">private</span> <span class="hljs-type">Generation</span> <span class="hljs-variable">generation</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Generation</span>();

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">CyclicBarrier</span><span class="hljs-params">(<span class="hljs-type">int</span> parties, Runnable barrierAction)</span> {
        <span class="hljs-keyword">if</span> (parties &lt;= <span class="hljs-number">0</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>();
        <span class="hljs-built_in">this</span>.parties = parties;
        <span class="hljs-built_in">this</span>.count = parties;
        <span class="hljs-built_in">this</span>.barrierCommand = barrierAction;
    }

    <span class="hljs-comment">// åˆ°è¾¾å±éšœç‚¹å¹¶ç­‰å¾…</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">await</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException, BrokenBarrierException {
        <span class="hljs-keyword">final</span> <span class="hljs-type">ReentrantLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.lock;
        lock.lock();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">final</span> <span class="hljs-type">Generation</span> <span class="hljs-variable">g</span> <span class="hljs-operator">=</span> generation;

            <span class="hljs-keyword">if</span> (g.broken)
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BrokenBarrierException</span>();

            <span class="hljs-keyword">if</span> (Thread.interrupted()) {
                breakBarrier();
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InterruptedException</span>();
            }

            <span class="hljs-type">int</span> <span class="hljs-variable">index</span> <span class="hljs-operator">=</span> --count;
            <span class="hljs-keyword">if</span> (index == <span class="hljs-number">0</span>) {  <span class="hljs-comment">// æœ€åä¸€ä¸ªåˆ°è¾¾</span>
                <span class="hljs-type">boolean</span> <span class="hljs-variable">ranAction</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;
                <span class="hljs-keyword">try</span> {
                    <span class="hljs-keyword">final</span> <span class="hljs-type">Runnable</span> <span class="hljs-variable">command</span> <span class="hljs-operator">=</span> barrierCommand;
                    <span class="hljs-keyword">if</span> (command != <span class="hljs-literal">null</span>)
                        command.run();  <span class="hljs-comment">// æ‰§è¡Œå±éšœåŠ¨ä½œ</span>
                    ranAction = <span class="hljs-literal">true</span>;
                    nextGeneration();   <span class="hljs-comment">// å¼€å¯ä¸‹ä¸€ä»£</span>
                    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
                } <span class="hljs-keyword">finally</span> {
                    <span class="hljs-keyword">if</span> (!ranAction)
                        breakBarrier();
                }
            }

            <span class="hljs-comment">// ä¸æ˜¯æœ€åä¸€ä¸ª,å¾ªç¯ç­‰å¾…</span>
            <span class="hljs-keyword">for</span> (;;) {
                <span class="hljs-keyword">try</span> {
                    trip.await();  <span class="hljs-comment">// ç­‰å¾…signal</span>
                    <span class="hljs-keyword">break</span>;
                } <span class="hljs-keyword">catch</span> (InterruptedException ie) {
                    <span class="hljs-keyword">if</span> (g == generation &amp;&amp; !g.broken) {
                        breakBarrier();
                        <span class="hljs-keyword">throw</span> ie;
                    } <span class="hljs-keyword">else</span> {
                        Thread.currentThread().interrupt();
                    }
                }

                <span class="hljs-keyword">if</span> (g.broken)
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BrokenBarrierException</span>();

                <span class="hljs-keyword">if</span> (g != generation)
                    <span class="hljs-keyword">return</span> index;
            }
        } <span class="hljs-keyword">finally</span> {
            lock.unlock();
        }
    }

    <span class="hljs-comment">// å¼€å¯ä¸‹ä¸€ä»£(é‡ç½®count,å”¤é†’æ‰€æœ‰ç­‰å¾…çº¿ç¨‹)</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">nextGeneration</span><span class="hljs-params">()</span> {
        trip.signalAll();
        count = parties;
        generation = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Generation</span>();
    }
}
</code></pre>
<p><strong>CountDownLatch vs CyclicBarrier:</strong></p>








































<table><thead><tr><th>ç»´åº¦</th><th>CountDownLatch</th><th>CyclicBarrier</th></tr></thead><tbody><tr><td>åº•å±‚å®ç°</td><td>AQSå…±äº«æ¨¡å¼</td><td>ReentrantLock + Condition</td></tr><tr><td>å¯é‡ç”¨æ€§</td><td>âŒä¸€æ¬¡æ€§</td><td>âœ…å¯é‡ç½®</td></tr><tr><td>ç­‰å¾…è§’è‰²</td><td>ä¸€ç»„ç­‰ä¸€ç»„</td><td>äº’ç›¸ç­‰å¾…</td></tr><tr><td>è®¡æ•°æ–¹å‘</td><td>é€’å‡åˆ°0</td><td>é€’å¢åˆ°N</td></tr><tr><td>å±éšœåŠ¨ä½œ</td><td>âŒä¸æ”¯æŒ</td><td>âœ…æ”¯æŒbarrierAction</td></tr><tr><td>å…¸å‹åœºæ™¯</td><td>ä¸»çº¿ç¨‹ç­‰æ‰€æœ‰å­çº¿ç¨‹å®Œæˆ</td><td>å¤šçº¿ç¨‹äº’ç›¸ç­‰å¾…åŒæ­¥ç‚¹</td></tr></tbody></table>
<h4 data-id="heading-22">2.4.3 Semaphore - ä¿¡å·é‡</h4>
<p><strong>å®ç°åŸç†:</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Semaphore</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">java</span>.io.Serializable {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Sync sync;

    <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Sync</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractQueuedSynchronizer</span> {
        Sync(<span class="hljs-type">int</span> <span class="hljs-keyword">permits</span>) {
            setState(<span class="hljs-keyword">permits</span>);  <span class="hljs-comment">// state=è®¸å¯æ•°</span>
        }

        <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getPermits</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">return</span> getState();
        }

        <span class="hljs-comment">// éå…¬å¹³è·å–</span>
        <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-title function_">nonfairTryAcquireShared</span><span class="hljs-params">(<span class="hljs-type">int</span> acquires)</span> {
            <span class="hljs-keyword">for</span> (;;) {
                <span class="hljs-type">int</span> <span class="hljs-variable">available</span> <span class="hljs-operator">=</span> getState();
                <span class="hljs-type">int</span> <span class="hljs-variable">remaining</span> <span class="hljs-operator">=</span> available - acquires;
                <span class="hljs-keyword">if</span> (remaining &lt; <span class="hljs-number">0</span> ||
                    compareAndSetState(available, remaining))
                    <span class="hljs-keyword">return</span> remaining;
            }
        }

        <span class="hljs-comment">// é‡Šæ”¾è®¸å¯</span>
        <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryReleaseShared</span><span class="hljs-params">(<span class="hljs-type">int</span> releases)</span> {
            <span class="hljs-keyword">for</span> (;;) {
                <span class="hljs-type">int</span> <span class="hljs-variable">current</span> <span class="hljs-operator">=</span> getState();
                <span class="hljs-type">int</span> <span class="hljs-variable">next</span> <span class="hljs-operator">=</span> current + releases;
                <span class="hljs-keyword">if</span> (next &lt; current)  <span class="hljs-comment">// æº¢å‡ºæ£€æŸ¥</span>
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"Maximum permit count exceeded"</span>);
                <span class="hljs-keyword">if</span> (compareAndSetState(current, next))
                    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
            }
        }
    }

    <span class="hljs-comment">// éå…¬å¹³ç‰ˆæœ¬</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NonfairSync</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Sync</span> {
        NonfairSync(<span class="hljs-type">int</span> <span class="hljs-keyword">permits</span>) {
            <span class="hljs-built_in">super</span>(<span class="hljs-keyword">permits</span>);
        }

        <span class="hljs-keyword">protected</span> <span class="hljs-type">int</span> <span class="hljs-title function_">tryAcquireShared</span><span class="hljs-params">(<span class="hljs-type">int</span> acquires)</span> {
            <span class="hljs-keyword">return</span> nonfairTryAcquireShared(acquires);
        }
    }

    <span class="hljs-comment">// å…¬å¹³ç‰ˆæœ¬</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FairSync</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Sync</span> {
        FairSync(<span class="hljs-type">int</span> <span class="hljs-keyword">permits</span>) {
            <span class="hljs-built_in">super</span>(<span class="hljs-keyword">permits</span>);
        }

        <span class="hljs-keyword">protected</span> <span class="hljs-type">int</span> <span class="hljs-title function_">tryAcquireShared</span><span class="hljs-params">(<span class="hljs-type">int</span> acquires)</span> {
            <span class="hljs-keyword">for</span> (;;) {
                <span class="hljs-comment">// å…¬å¹³æ€§:æ£€æŸ¥é˜Ÿåˆ—ä¸­æ˜¯å¦æœ‰ç­‰å¾…çº¿ç¨‹</span>
                <span class="hljs-keyword">if</span> (hasQueuedPredecessors())
                    <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;

                <span class="hljs-type">int</span> <span class="hljs-variable">available</span> <span class="hljs-operator">=</span> getState();
                <span class="hljs-type">int</span> <span class="hljs-variable">remaining</span> <span class="hljs-operator">=</span> available - acquires;
                <span class="hljs-keyword">if</span> (remaining &lt; <span class="hljs-number">0</span> ||
                    compareAndSetState(available, remaining))
                    <span class="hljs-keyword">return</span> remaining;
            }
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Semaphore</span><span class="hljs-params">(<span class="hljs-type">int</span> <span class="hljs-keyword">permits</span>, <span class="hljs-type">boolean</span> fair)</span> {
        sync = fair ? <span class="hljs-keyword">new</span> <span class="hljs-title class_">FairSync</span>(<span class="hljs-keyword">permits</span>) : <span class="hljs-keyword">new</span> <span class="hljs-title class_">NonfairSync</span>(<span class="hljs-keyword">permits</span>);
    }

    <span class="hljs-comment">// è·å–è®¸å¯</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">acquire</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException {
        sync.acquireSharedInterruptibly(<span class="hljs-number">1</span>);
    }

    <span class="hljs-comment">// é‡Šæ”¾è®¸å¯</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">release</span><span class="hljs-params">()</span> {
        sync.releaseShared(<span class="hljs-number">1</span>);
    }
}
</code></pre>
<p><strong>åº”ç”¨åœºæ™¯:</strong></p>
<ul>
<li>é™æµ(æ§åˆ¶å¹¶å‘è®¿é—®æ•°)</li>
<li>èµ„æºæ± (æ•°æ®åº“è¿æ¥æ± ã€çº¿ç¨‹æ± )</li>
</ul>
<h4 data-id="heading-23">2.4.4 ReadWriteLock - è¯»å†™é”</h4>
<p><strong>å®ç°åŸç†(stateçš„ä½è¿ç®—):</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">abstract</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Sync</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractQueuedSynchronizer</span> {
    <span class="hljs-comment">// stateçš„ä½åˆ’åˆ†</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">SHARED_SHIFT</span>   <span class="hljs-operator">=</span> <span class="hljs-number">16</span>;
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">SHARED_UNIT</span>    <span class="hljs-operator">=</span> (<span class="hljs-number">1</span> &lt;&lt; SHARED_SHIFT);  <span class="hljs-comment">// 65536</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">MAX_COUNT</span>      <span class="hljs-operator">=</span> (<span class="hljs-number">1</span> &lt;&lt; SHARED_SHIFT) - <span class="hljs-number">1</span>;  <span class="hljs-comment">// 65535</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">EXCLUSIVE_MASK</span> <span class="hljs-operator">=</span> (<span class="hljs-number">1</span> &lt;&lt; SHARED_SHIFT) - <span class="hljs-number">1</span>;  <span class="hljs-comment">// ä½16ä½æ©ç </span>

    <span class="hljs-comment">// è¯»é”è®¡æ•°(é«˜16ä½)</span>
    <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">sharedCount</span><span class="hljs-params">(<span class="hljs-type">int</span> c)</span>    { <span class="hljs-keyword">return</span> c &gt;&gt;&gt; SHARED_SHIFT; }

    <span class="hljs-comment">// å†™é”è®¡æ•°(ä½16ä½)</span>
    <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">exclusiveCount</span><span class="hljs-params">(<span class="hljs-type">int</span> c)</span> { <span class="hljs-keyword">return</span> c &amp; EXCLUSIVE_MASK; }

    <span class="hljs-comment">// è·å–å†™é”</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryAcquire</span><span class="hljs-params">(<span class="hljs-type">int</span> acquires)</span> {
        <span class="hljs-type">Thread</span> <span class="hljs-variable">current</span> <span class="hljs-operator">=</span> Thread.currentThread();
        <span class="hljs-type">int</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> getState();
        <span class="hljs-type">int</span> <span class="hljs-variable">w</span> <span class="hljs-operator">=</span> exclusiveCount(c);  <span class="hljs-comment">// å†™é”æ•°</span>

        <span class="hljs-keyword">if</span> (c != <span class="hljs-number">0</span>) {
            <span class="hljs-comment">// state!=0,å­˜åœ¨è¯»é”æˆ–å†™é”</span>
            <span class="hljs-keyword">if</span> (w == <span class="hljs-number">0</span> || current != getExclusiveOwnerThread())
                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;  <span class="hljs-comment">// å­˜åœ¨è¯»é”æˆ–å…¶ä»–çº¿ç¨‹æŒæœ‰å†™é”</span>

            <span class="hljs-keyword">if</span> (w + exclusiveCount(acquires) &gt; MAX_COUNT)
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"Maximum lock count exceeded"</span>);

            setState(c + acquires);  <span class="hljs-comment">// é‡å…¥</span>
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }

        <span class="hljs-keyword">if</span> (writerShouldBlock() ||
            !compareAndSetState(c, c + acquires))
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;

        setExclusiveOwnerThread(current);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }

    <span class="hljs-comment">// è·å–è¯»é”</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-title function_">tryAcquireShared</span><span class="hljs-params">(<span class="hljs-type">int</span> acquires)</span> {
        <span class="hljs-type">Thread</span> <span class="hljs-variable">current</span> <span class="hljs-operator">=</span> Thread.currentThread();
        <span class="hljs-type">int</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> getState();

        <span class="hljs-comment">// å­˜åœ¨å†™é”ä¸”ä¸æ˜¯å½“å‰çº¿ç¨‹æŒæœ‰</span>
        <span class="hljs-keyword">if</span> (exclusiveCount(c) != <span class="hljs-number">0</span> &amp;&amp;
            getExclusiveOwnerThread() != current)
            <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;

        <span class="hljs-type">int</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> sharedCount(c);
        <span class="hljs-keyword">if</span> (!readerShouldBlock() &amp;&amp;
            r &lt; MAX_COUNT &amp;&amp;
            compareAndSetState(c, c + SHARED_UNIT)) {  <span class="hljs-comment">// é«˜16ä½+1</span>

            <span class="hljs-keyword">if</span> (r == <span class="hljs-number">0</span>) {
                firstReader = current;
                firstReaderHoldCount = <span class="hljs-number">1</span>;
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (firstReader == current) {
                firstReaderHoldCount++;
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-comment">// ä½¿ç”¨ThreadLocalè®°å½•æ¯ä¸ªçº¿ç¨‹çš„è¯»é”é‡å…¥æ¬¡æ•°</span>
                <span class="hljs-type">HoldCounter</span> <span class="hljs-variable">rh</span> <span class="hljs-operator">=</span> cachedHoldCounter;
                <span class="hljs-keyword">if</span> (rh == <span class="hljs-literal">null</span> || rh.tid != getThreadId(current))
                    cachedHoldCounter = rh = readHolds.get();
                <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (rh.count == <span class="hljs-number">0</span>)
                    readHolds.set(rh);
                rh.count++;
            }
            <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
        }

        <span class="hljs-keyword">return</span> fullTryAcquireShared(current);
    }
}
</code></pre>
<p><strong>é”é™çº§æœºåˆ¶:</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// æ­£ç¡®çš„é”é™çº§ç¤ºä¾‹</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">CachedData</span> {
    Object data;
    <span class="hljs-keyword">volatile</span> <span class="hljs-type">boolean</span> cacheValid;
    <span class="hljs-keyword">final</span> <span class="hljs-type">ReentrantReadWriteLock</span> <span class="hljs-variable">rwl</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReentrantReadWriteLock</span>();

    <span class="hljs-keyword">void</span> <span class="hljs-title function_">processCachedData</span><span class="hljs-params">()</span> {
        rwl.readLock().lock();
        <span class="hljs-keyword">if</span> (!cacheValid) {
            <span class="hljs-comment">// éœ€è¦æ›´æ–°ç¼“å­˜</span>
            rwl.readLock().unlock();  <span class="hljs-comment">// â‘ é‡Šæ”¾è¯»é”</span>
            rwl.writeLock().lock();   <span class="hljs-comment">// â‘¡è·å–å†™é”</span>
            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">// å†æ¬¡æ£€æŸ¥(å…¶ä»–çº¿ç¨‹å¯èƒ½å·²æ›´æ–°)</span>
                <span class="hljs-keyword">if</span> (!cacheValid) {
                    data = loadData();
                    cacheValid = <span class="hljs-literal">true</span>;
                }

                <span class="hljs-comment">// â‘¢é”é™çº§:åœ¨æŒæœ‰å†™é”çš„æƒ…å†µä¸‹è·å–è¯»é”</span>
                rwl.readLock().lock();
            } <span class="hljs-keyword">finally</span> {
                rwl.writeLock().unlock();  <span class="hljs-comment">// â‘£é‡Šæ”¾å†™é”</span>
            }
        }

        <span class="hljs-keyword">try</span> {
            use(data);
        } <span class="hljs-keyword">finally</span> {
            rwl.readLock().unlock();  <span class="hljs-comment">// â‘¤é‡Šæ”¾è¯»é”</span>
        }
    }
}
</code></pre>
<p><strong>ä¸ºä»€ä¹ˆæ²¡æœ‰é”å‡çº§?</strong></p>
<p>é”å‡çº§(è¯»é”â†’å†™é”)ä¼šå¯¼è‡´æ­»é”:</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">çº¿ç¨‹A: æŒæœ‰è¯»é” â†’ æƒ³å‡çº§ä¸ºå†™é” â†’ ç­‰å¾…å…¶ä»–è¯»é”é‡Šæ”¾</span>
<span class="hljs-section">çº¿ç¨‹B: æŒæœ‰è¯»é” â†’ æƒ³å‡çº§ä¸ºå†™é” â†’ ç­‰å¾…å…¶ä»–è¯»é”é‡Šæ”¾</span>
â†’ æ­»é”!
</code></pre>
<p>é”é™çº§(å†™é”â†’è¯»é”)æ˜¯å®‰å…¨çš„:</p>
<pre><code class="hljs language-css" lang="css">çº¿ç¨‹<span class="hljs-selector-tag">A</span>: æŒæœ‰å†™é” â†’ è·å–è¯»é” â†’ é‡Šæ”¾å†™é”
æ­¤æ—¶æ— å…¶ä»–çº¿ç¨‹æŒæœ‰ä»»ä½•é”,ä¸ä¼šæ­»é”
</code></pre>
<hr/>
<h2 data-id="heading-24">ä¸‰ã€å®æˆ˜åœºæ™¯åº”ç”¨</h2>
<h3 data-id="heading-25">3.1 åœºæ™¯1: åˆ†å¸ƒå¼ä»»åŠ¡åè°ƒä¸­çš„CountDownLatchåº”ç”¨</h3>
<h4 data-id="heading-26">ä¸šåŠ¡èƒŒæ™¯</h4>
<p>ç”µå•†å¹³å°éœ€è¦æ‰¹é‡å¯¼å…¥è®¢å•æ•°æ®,æ¯æ‰¹æ¬¡1000ä¸ªè®¢å•ã€‚ä¸ºæé«˜æ•ˆç‡,é‡‡ç”¨å¤šçº¿ç¨‹å¹¶è¡Œå¯¼å…¥:</p>
<ul>
<li>å°†1000ä¸ªè®¢å•åˆ†æˆ10ç»„,æ¯ç»„100ä¸ª</li>
<li>10ä¸ªçº¿ç¨‹å¹¶è¡Œå¯¼å…¥</li>
<li>ä¸»çº¿ç¨‹éœ€è¦ç­‰å¾…æ‰€æœ‰å­çº¿ç¨‹å®Œæˆå,æ±‡æ€»å¯¼å…¥ç»“æœå¹¶å‘é€é€šçŸ¥</li>
</ul>
<h4 data-id="heading-27">æ–¹æ¡ˆè®¾è®¡</h4>
<p>ä½¿ç”¨<code>CountDownLatch</code>å®ç°ä¸»çº¿ç¨‹ç­‰å¾…:</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4f84c1a6010c43e2a08482a69cb32605~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54Sh6YeP:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766817638&amp;x-signature=nGYvSUPm%2FybNvRl3WTHIMhuUlF0%3D" alt="countdownlatch-scenario.svg" loading="lazy"/></p>
<h4 data-id="heading-28">å®Œæ•´ä»£ç å®ç°</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * è®¢å•æ‰¹é‡å¯¼å…¥æœåŠ¡
 */</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderBatchImportService</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> OrderRepository orderRepository;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> NotificationService notificationService;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(<span class="hljs-number">10</span>);

    <span class="hljs-comment">/**
     * æ‰¹é‡å¯¼å…¥è®¢å•
     * <span class="hljs-doctag">@param</span> orders å¾…å¯¼å…¥è®¢å•åˆ—è¡¨
     * <span class="hljs-doctag">@return</span> å¯¼å…¥ç»“æœç»Ÿè®¡
     */</span>
    <span class="hljs-keyword">public</span> ImportResult <span class="hljs-title function_">batchImport</span><span class="hljs-params">(List&lt;OrderDTO&gt; orders)</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">batchSize</span> <span class="hljs-operator">=</span> <span class="hljs-number">100</span>;
        <span class="hljs-type">int</span> <span class="hljs-variable">totalBatches</span> <span class="hljs-operator">=</span> (orders.size() + batchSize - <span class="hljs-number">1</span>) / batchSize;

        <span class="hljs-comment">// â‘ åˆ›å»ºCountDownLatch</span>
        <span class="hljs-type">CountDownLatch</span> <span class="hljs-variable">latch</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CountDownLatch</span>(totalBatches);

        <span class="hljs-comment">// ç»“æœæ”¶é›†å™¨(çº¿ç¨‹å®‰å…¨)</span>
        ConcurrentHashMap&lt;String, AtomicInteger&gt; resultMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();
        resultMap.put(<span class="hljs-string">"success"</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicInteger</span>(<span class="hljs-number">0</span>));
        resultMap.put(<span class="hljs-string">"failed"</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicInteger</span>(<span class="hljs-number">0</span>));

        log.info(<span class="hljs-string">"å¼€å§‹æ‰¹é‡å¯¼å…¥è®¢å•,æ€»æ•°:{},åˆ†{}æ‰¹"</span>, orders.size(), totalBatches);

        <span class="hljs-comment">// â‘¡æäº¤å­ä»»åŠ¡</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; totalBatches; i++) {
            <span class="hljs-type">int</span> <span class="hljs-variable">fromIndex</span> <span class="hljs-operator">=</span> i * batchSize;
            <span class="hljs-type">int</span> <span class="hljs-variable">toIndex</span> <span class="hljs-operator">=</span> Math.min(fromIndex + batchSize, orders.size());
            List&lt;OrderDTO&gt; batch = orders.subList(fromIndex, toIndex);

            executor.submit(() -&gt; {
                <span class="hljs-keyword">try</span> {
                    importBatch(batch, resultMap);
                } <span class="hljs-keyword">catch</span> (Exception e) {
                    log.error(<span class="hljs-string">"æ‰¹æ¬¡å¯¼å…¥å¤±è´¥"</span>, e);
                    resultMap.get(<span class="hljs-string">"failed"</span>).addAndGet(batch.size());
                } <span class="hljs-keyword">finally</span> {
                    latch.countDown();  <span class="hljs-comment">// â‘¢å®ŒæˆåcountDown</span>
                    log.info(<span class="hljs-string">"æ‰¹æ¬¡å®Œæˆ,å‰©ä½™æ‰¹æ¬¡:{}"</span>, latch.getCount());
                }
            });
        }

        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// â‘£ä¸»çº¿ç¨‹ç­‰å¾…æ‰€æœ‰å­çº¿ç¨‹å®Œæˆ(è¶…æ—¶30ç§’)</span>
            <span class="hljs-type">boolean</span> <span class="hljs-variable">finished</span> <span class="hljs-operator">=</span> latch.await(<span class="hljs-number">30</span>, TimeUnit.SECONDS);

            <span class="hljs-keyword">if</span> (!finished) {
                log.error(<span class="hljs-string">"æ‰¹é‡å¯¼å…¥è¶…æ—¶,å·²å®Œæˆæ‰¹æ¬¡:{}"</span>, totalBatches - latch.getCount());
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(<span class="hljs-string">"æ‰¹é‡å¯¼å…¥è¶…æ—¶"</span>);
            }

            <span class="hljs-comment">// â‘¤æ±‡æ€»ç»“æœ</span>
            <span class="hljs-type">ImportResult</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ImportResult</span>();
            result.setTotalCount(orders.size());
            result.setSuccessCount(resultMap.get(<span class="hljs-string">"success"</span>).get());
            result.setFailedCount(resultMap.get(<span class="hljs-string">"failed"</span>).get());

            log.info(<span class="hljs-string">"æ‰¹é‡å¯¼å…¥å®Œæˆ:{}"</span>, result);

            <span class="hljs-comment">// â‘¥å‘é€é€šçŸ¥</span>
            notificationService.sendImportResult(result);

            <span class="hljs-keyword">return</span> result;

        } <span class="hljs-keyword">catch</span> (InterruptedException e) {
            Thread.currentThread().interrupt();
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(<span class="hljs-string">"æ‰¹é‡å¯¼å…¥è¢«ä¸­æ–­"</span>, e);
        }
    }

    <span class="hljs-comment">/**
     * å¯¼å…¥å•ä¸ªæ‰¹æ¬¡
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">importBatch</span><span class="hljs-params">(List&lt;OrderDTO&gt; batch,
                           ConcurrentHashMap&lt;String, AtomicInteger&gt; resultMap)</span> {
        <span class="hljs-keyword">for</span> (OrderDTO orderDTO : batch) {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> convertToEntity(orderDTO);
                orderRepository.save(order);
                resultMap.get(<span class="hljs-string">"success"</span>).incrementAndGet();
            } <span class="hljs-keyword">catch</span> (Exception e) {
                log.error(<span class="hljs-string">"è®¢å•å¯¼å…¥å¤±è´¥,orderId:{}"</span>, orderDTO.getOrderId(), e);
                resultMap.get(<span class="hljs-string">"failed"</span>).incrementAndGet();
            }
        }
    }

    <span class="hljs-meta">@Data</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ImportResult</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> totalCount;
        <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> successCount;
        <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> failedCount;

        <span class="hljs-keyword">public</span> <span class="hljs-type">double</span> <span class="hljs-title function_">getSuccessRate</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">return</span> totalCount == <span class="hljs-number">0</span> ? <span class="hljs-number">0</span> : (<span class="hljs-type">double</span>) successCount / totalCount * <span class="hljs-number">100</span>;
        }
    }
}
</code></pre>
<h4 data-id="heading-29">é”™è¯¯å¤„ç†:å­ä»»åŠ¡å¼‚å¸¸çš„å…œåº•æ–¹æ¡ˆ</h4>
<p><strong>é—®é¢˜:</strong> å¦‚æœå­ä»»åŠ¡æŠ›å‡ºå¼‚å¸¸æœªæ•è·,å¯èƒ½å¯¼è‡´<code>countDown()</code>æœªæ‰§è¡Œ,ä¸»çº¿ç¨‹æ°¸ä¹…é˜»å¡ã€‚</p>
<p><strong>è§£å†³æ–¹æ¡ˆ:</strong></p>
<pre><code class="hljs language-java" lang="java">executor.submit(() -&gt; {
    <span class="hljs-keyword">try</span> {
        importBatch(batch, resultMap);
    } <span class="hljs-keyword">catch</span> (Exception e) {
        log.error(<span class="hljs-string">"æ‰¹æ¬¡å¯¼å…¥å¤±è´¥"</span>, e);
        resultMap.get(<span class="hljs-string">"failed"</span>).addAndGet(batch.size());
    } <span class="hljs-keyword">finally</span> {
        latch.countDown();  <span class="hljs-comment">// finallyç¡®ä¿ä¸€å®šæ‰§è¡Œ</span>
    }
});
</code></pre>
<h4 data-id="heading-30">è¶…æ—¶æ§åˆ¶</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// å¸¦è¶…æ—¶çš„await</span>
<span class="hljs-type">boolean</span> <span class="hljs-variable">finished</span> <span class="hljs-operator">=</span> latch.await(<span class="hljs-number">30</span>, TimeUnit.SECONDS);

<span class="hljs-keyword">if</span> (!finished) {
    <span class="hljs-comment">// è¶…æ—¶å¤„ç†</span>
    log.error(<span class="hljs-string">"éƒ¨åˆ†ä»»åŠ¡æœªå®Œæˆ,å·²å®Œæˆ:{}/{}"</span>,
             totalBatches - latch.getCount(), totalBatches);

    <span class="hljs-comment">// å–æ¶ˆæœªå®Œæˆçš„ä»»åŠ¡</span>
    executor.shutdownNow();

    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(<span class="hljs-string">"æ‰¹é‡å¯¼å…¥è¶…æ—¶"</span>);
}
</code></pre>
<h3 data-id="heading-31">3.2 åœºæ™¯2: ä½¿ç”¨Semaphoreé™æµ</h3>
<h4 data-id="heading-32">ä¸šåŠ¡èƒŒæ™¯</h4>
<p>ç”µå•†å¹³å°éœ€è¦é™åˆ¶æ•°æ®åº“è¿æ¥æ± çš„å¹¶å‘è®¿é—®æ•°é‡:</p>
<ul>
<li>æ•°æ®åº“æœ€å¤§è¿æ¥æ•°20</li>
<li>åº”ç”¨æœåŠ¡å™¨æœ‰100ä¸ªå·¥ä½œçº¿ç¨‹</li>
<li>éœ€è¦æ§åˆ¶åŒæ—¶è®¿é—®æ•°æ®åº“çš„çº¿ç¨‹æ•°â‰¤20</li>
</ul>
<h4 data-id="heading-33">æ–¹æ¡ˆè®¾è®¡</h4>
<p>ä½¿ç”¨<code>Semaphore(20)</code>é™åˆ¶å¹¶å‘:</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * åŸºäºSemaphoreçš„æ•°æ®åº“è¿æ¥æ± 
 */</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DatabaseConnectionPool</span> {

    <span class="hljs-comment">// å®é™…è¿æ¥æ± </span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> BlockingQueue&lt;Connection&gt; connections;

    <span class="hljs-comment">// ä¿¡å·é‡æ§åˆ¶å¹¶å‘æ•°</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Semaphore semaphore;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String jdbcUrl;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String username;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String password;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">DatabaseConnectionPool</span><span class="hljs-params">(String jdbcUrl, String username, String password,
                                 <span class="hljs-type">int</span> maxConnections, <span class="hljs-type">boolean</span> fair)</span> {
        <span class="hljs-built_in">this</span>.jdbcUrl = jdbcUrl;
        <span class="hljs-built_in">this</span>.username = username;
        <span class="hljs-built_in">this</span>.password = password;
        <span class="hljs-built_in">this</span>.connections = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedBlockingQueue</span>&lt;&gt;(maxConnections);
        <span class="hljs-built_in">this</span>.semaphore = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Semaphore</span>(maxConnections, fair);  <span class="hljs-comment">// å…¬å¹³/éå…¬å¹³å¯é€‰</span>

        <span class="hljs-comment">// åˆå§‹åŒ–è¿æ¥</span>
        initConnections(maxConnections);
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initConnections</span><span class="hljs-params">(<span class="hljs-type">int</span> count)</span> {
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; count; i++) {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-type">Connection</span> <span class="hljs-variable">conn</span> <span class="hljs-operator">=</span> DriverManager.getConnection(jdbcUrl, username, password);
                connections.offer(conn);
            } <span class="hljs-keyword">catch</span> (SQLException e) {
                log.error(<span class="hljs-string">"åˆå§‹åŒ–è¿æ¥å¤±è´¥"</span>, e);
            }
        }
        log.info(<span class="hljs-string">"æ•°æ®åº“è¿æ¥æ± åˆå§‹åŒ–å®Œæˆ,è¿æ¥æ•°:{}"</span>, connections.size());
    }

    <span class="hljs-comment">/**
     * è·å–è¿æ¥(é˜»å¡ç­‰å¾…)
     */</span>
    <span class="hljs-keyword">public</span> Connection <span class="hljs-title function_">getConnection</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException {
        <span class="hljs-comment">// â‘ è·å–è®¸å¯</span>
        semaphore.acquire();

        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// â‘¡ä»æ± ä¸­å–è¿æ¥</span>
            <span class="hljs-type">Connection</span> <span class="hljs-variable">conn</span> <span class="hljs-operator">=</span> connections.poll(<span class="hljs-number">10</span>, TimeUnit.SECONDS);
            <span class="hljs-keyword">if</span> (conn == <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"è·å–è¿æ¥è¶…æ—¶"</span>);
            }

            log.debug(<span class="hljs-string">"è·å–è¿æ¥æˆåŠŸ,å‰©ä½™è®¸å¯:{}"</span>, semaphore.availablePermits());
            <span class="hljs-keyword">return</span> conn;

        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-comment">// å¼‚å¸¸æ—¶éœ€è¦é‡Šæ”¾è®¸å¯</span>
            semaphore.release();
            <span class="hljs-keyword">throw</span> e;
        }
    }

    <span class="hljs-comment">/**
     * è·å–è¿æ¥(è¶…æ—¶ç­‰å¾…)
     */</span>
    <span class="hljs-keyword">public</span> Connection <span class="hljs-title function_">getConnection</span><span class="hljs-params">(<span class="hljs-type">long</span> timeout, TimeUnit unit)</span>
            <span class="hljs-keyword">throws</span> InterruptedException, TimeoutException {

        <span class="hljs-comment">// â‘ å°è¯•è·å–è®¸å¯(è¶…æ—¶)</span>
        <span class="hljs-keyword">if</span> (!semaphore.tryAcquire(timeout, unit)) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TimeoutException</span>(<span class="hljs-string">"è·å–è¿æ¥è¶…æ—¶,ç­‰å¾…æ—¶é—´:"</span> + timeout + unit);
        }

        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">Connection</span> <span class="hljs-variable">conn</span> <span class="hljs-operator">=</span> connections.poll(timeout, unit);
            <span class="hljs-keyword">if</span> (conn == <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TimeoutException</span>(<span class="hljs-string">"è¿æ¥æ± ä¸ºç©º"</span>);
            }
            <span class="hljs-keyword">return</span> conn;
        } <span class="hljs-keyword">catch</span> (Exception e) {
            semaphore.release();
            <span class="hljs-keyword">throw</span> e;
        }
    }

    <span class="hljs-comment">/**
     * é‡Šæ”¾è¿æ¥
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">releaseConnection</span><span class="hljs-params">(Connection conn)</span> {
        <span class="hljs-keyword">if</span> (conn != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">// â‘ å½’è¿˜è¿æ¥åˆ°æ± </span>
                <span class="hljs-keyword">if</span> (!connections.offer(conn, <span class="hljs-number">5</span>, TimeUnit.SECONDS)) {
                    log.error(<span class="hljs-string">"å½’è¿˜è¿æ¥å¤±è´¥,è¿æ¥æ± å·²æ»¡"</span>);
                    conn.close();  <span class="hljs-comment">// å…³é—­è¿æ¥</span>
                }
            } <span class="hljs-keyword">catch</span> (Exception e) {
                log.error(<span class="hljs-string">"å½’è¿˜è¿æ¥å¼‚å¸¸"</span>, e);
            } <span class="hljs-keyword">finally</span> {
                <span class="hljs-comment">// â‘¡é‡Šæ”¾è®¸å¯(å¿…é¡»æ‰§è¡Œ)</span>
                semaphore.release();
                log.debug(<span class="hljs-string">"é‡Šæ”¾è¿æ¥,å‰©ä½™è®¸å¯:{}"</span>, semaphore.availablePermits());
            }
        }
    }

    <span class="hljs-comment">/**
     * è·å–è¿æ¥æ± çŠ¶æ€
     */</span>
    <span class="hljs-keyword">public</span> PoolStats <span class="hljs-title function_">getStats</span><span class="hljs-params">()</span> {
        <span class="hljs-type">PoolStats</span> <span class="hljs-variable">stats</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PoolStats</span>();
        stats.setMaxConnections(semaphore.availablePermits() + semaphore.getQueueLength());
        stats.setAvailableConnections(semaphore.availablePermits());
        stats.setWaitingThreads(semaphore.getQueueLength());
        stats.setActiveConnections(stats.getMaxConnections() - stats.getAvailableConnections());
        <span class="hljs-keyword">return</span> stats;
    }

    <span class="hljs-meta">@Data</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PoolStats</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> maxConnections;
        <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> availableConnections;
        <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> activeConnections;
        <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> waitingThreads;
    }
}
</code></pre>
<h4 data-id="heading-34">ä½¿ç”¨ç¤ºä¾‹</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> DatabaseConnectionPool connectionPool;

    <span class="hljs-keyword">public</span> Order <span class="hljs-title function_">queryOrder</span><span class="hljs-params">(Long orderId)</span> {
        <span class="hljs-type">Connection</span> <span class="hljs-variable">conn</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// è·å–è¿æ¥(æœ€å¤šç­‰å¾…3ç§’)</span>
            conn = connectionPool.getConnection(<span class="hljs-number">3</span>, TimeUnit.SECONDS);

            <span class="hljs-type">PreparedStatement</span> <span class="hljs-variable">ps</span> <span class="hljs-operator">=</span> conn.prepareStatement(
                <span class="hljs-string">"SELECT * FROM t_order WHERE id = ?"</span>);
            ps.setLong(<span class="hljs-number">1</span>, orderId);

            <span class="hljs-type">ResultSet</span> <span class="hljs-variable">rs</span> <span class="hljs-operator">=</span> ps.executeQuery();
            <span class="hljs-keyword">if</span> (rs.next()) {
                <span class="hljs-keyword">return</span> mapToOrder(rs);
            }
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;

        } <span class="hljs-keyword">catch</span> (TimeoutException e) {
            log.error(<span class="hljs-string">"è·å–æ•°æ®åº“è¿æ¥è¶…æ—¶,orderId:{}"</span>, orderId);
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(<span class="hljs-string">"ç³»ç»Ÿç¹å¿™,è¯·ç¨åé‡è¯•"</span>);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"æŸ¥è¯¢è®¢å•å¤±è´¥,orderId:{}"</span>, orderId, e);
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(<span class="hljs-string">"æŸ¥è¯¢å¤±è´¥"</span>, e);
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-comment">// å¿…é¡»é‡Šæ”¾è¿æ¥</span>
            connectionPool.releaseConnection(conn);
        }
    }
}
</code></pre>
<h4 data-id="heading-35">å…¬å¹³ä¸éå…¬å¹³çš„é€‰æ‹©</h4>
<p><strong>éå…¬å¹³æ¨¡å¼(é»˜è®¤):</strong></p>
<ul>
<li>æ–°åˆ°è¾¾çš„çº¿ç¨‹å¯èƒ½ç›´æ¥è·å–è®¸å¯,æ— éœ€æ’é˜Ÿ</li>
<li>ååé‡é«˜,ä½†å¯èƒ½å¯¼è‡´é¥¥é¥¿</li>
</ul>
<p><strong>å…¬å¹³æ¨¡å¼:</strong></p>
<ul>
<li>ä¸¥æ ¼æŒ‰ç…§FIFOé¡ºåºåˆ†é…è®¸å¯</li>
<li>é¿å…é¥¥é¥¿,ä½†æ€§èƒ½ç¨å·®</li>
</ul>
<p><strong>æ€§èƒ½æµ‹è¯•å¯¹æ¯”:</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@BenchmarkMode(Mode.Throughput)</span>
<span class="hljs-meta">@State(Scope.Benchmark)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SemaphoreBenchmark</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-type">Semaphore</span> <span class="hljs-variable">fairSemaphore</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Semaphore</span>(<span class="hljs-number">20</span>, <span class="hljs-literal">true</span>);
    <span class="hljs-keyword">private</span> <span class="hljs-type">Semaphore</span> <span class="hljs-variable">unfairSemaphore</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Semaphore</span>(<span class="hljs-number">20</span>, <span class="hljs-literal">false</span>);

    <span class="hljs-meta">@Benchmark</span>
    <span class="hljs-meta">@Threads(100)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testFair</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException {
        fairSemaphore.acquire();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// æ¨¡æ‹Ÿä¸šåŠ¡æ“ä½œ</span>
            Thread.sleep(<span class="hljs-number">1</span>);
        } <span class="hljs-keyword">finally</span> {
            fairSemaphore.release();
        }
    }

    <span class="hljs-meta">@Benchmark</span>
    <span class="hljs-meta">@Threads(100)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testUnfair</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException {
        unfairSemaphore.acquire();
        <span class="hljs-keyword">try</span> {
            Thread.sleep(<span class="hljs-number">1</span>);
        } <span class="hljs-keyword">finally</span> {
            unfairSemaphore.release();
        }
    }
}

<span class="hljs-comment">// ç»“æœ(ops/s):</span>
<span class="hljs-comment">// testFair:    12000</span>
<span class="hljs-comment">// testUnfair:  18000  (æå‡50%)</span>
</code></pre>
<p><strong>é€‰æ‹©å»ºè®®:</strong></p>
<ul>
<li>é«˜åååœºæ™¯ â†’ éå…¬å¹³æ¨¡å¼</li>
<li>éœ€è¦é¿å…é¥¥é¥¿ â†’ å…¬å¹³æ¨¡å¼</li>
</ul>
<h3 data-id="heading-36">3.3 åœºæ™¯3: ä½¿ç”¨ReadWriteLockä¼˜åŒ–ç¼“å­˜</h3>
<h4 data-id="heading-37">ä¸šåŠ¡èƒŒæ™¯</h4>
<p>ç”µå•†å¹³å°çš„å•†å“æœåŠ¡éœ€è¦ç¼“å­˜çƒ­é—¨å•†å“ä¿¡æ¯:</p>
<ul>
<li>ç¼“å­˜è¯»æ“ä½œå 99%,å†™æ“ä½œå 1%</li>
<li>ä½¿ç”¨<code>synchronized</code>å¯¼è‡´è¯»æ“ä½œä¹Ÿä¸²è¡ŒåŒ–,æ€§èƒ½ç“¶é¢ˆæ˜æ˜¾</li>
</ul>
<h4 data-id="heading-38">ä½¿ç”¨synchronizedçš„æ€§èƒ½é—®é¢˜</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * åŸºäºsynchronizedçš„ç¼“å­˜(æ€§èƒ½å·®)
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductCacheSynchronized</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;Long, ProductDTO&gt; cache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();

    <span class="hljs-comment">// è¯»æ“ä½œä¹Ÿéœ€è¦åŠ é”,å¯¼è‡´ä¸²è¡ŒåŒ–</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> ProductDTO <span class="hljs-title function_">get</span><span class="hljs-params">(Long productId)</span> {
        <span class="hljs-keyword">return</span> cache.get(productId);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">put</span><span class="hljs-params">(Long productId, ProductDTO product)</span> {
        cache.put(productId, product);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">remove</span><span class="hljs-params">(Long productId)</span> {
        cache.remove(productId);
    }
}
</code></pre>
<p><strong>æ€§èƒ½é—®é¢˜:</strong></p>
<ul>
<li>è¯»æ“ä½œå 99%,ä½†ä¹Ÿéœ€è¦è·å–ç‹¬å é”</li>
<li>100ä¸ªçº¿ç¨‹åŒæ—¶è¯»å–,ä¹Ÿä¼šä¸²è¡Œæ‰§è¡Œ</li>
<li>ååé‡ä¸¥é‡å—é™</li>
</ul>
<h4 data-id="heading-39">ReadWriteLockæ”¹é€ </h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * åŸºäºReadWriteLockçš„ç¼“å­˜(æ€§èƒ½ä¼˜)
 */</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductCacheReadWriteLock</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;Long, ProductDTO&gt; cache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ReadWriteLock</span> <span class="hljs-variable">rwLock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReentrantReadWriteLock</span>();
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Lock</span> <span class="hljs-variable">readLock</span> <span class="hljs-operator">=</span> rwLock.readLock();
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Lock</span> <span class="hljs-variable">writeLock</span> <span class="hljs-operator">=</span> rwLock.writeLock();

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ProductRepository productRepository;

    <span class="hljs-comment">/**
     * è¯»å–ç¼“å­˜(å¤šçº¿ç¨‹å¹¶å‘è¯»)
     */</span>
    <span class="hljs-keyword">public</span> ProductDTO <span class="hljs-title function_">get</span><span class="hljs-params">(Long productId)</span> {
        readLock.lock();  <span class="hljs-comment">// è¯»é”</span>
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">ProductDTO</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> cache.get(productId);
            <span class="hljs-keyword">if</span> (product != <span class="hljs-literal">null</span>) {
                log.debug(<span class="hljs-string">"ç¼“å­˜å‘½ä¸­,productId:{}"</span>, productId);
                <span class="hljs-keyword">return</span> product;
            }
        } <span class="hljs-keyword">finally</span> {
            readLock.unlock();
        }

        <span class="hljs-comment">// ç¼“å­˜æœªå‘½ä¸­,éœ€è¦ä»æ•°æ®åº“åŠ è½½</span>
        <span class="hljs-keyword">return</span> loadFromDB(productId);
    }

    <span class="hljs-comment">/**
     * ä»æ•°æ®åº“åŠ è½½å¹¶æ›´æ–°ç¼“å­˜(é”é™çº§)
     */</span>
    <span class="hljs-keyword">private</span> ProductDTO <span class="hljs-title function_">loadFromDB</span><span class="hljs-params">(Long productId)</span> {
        writeLock.lock();  <span class="hljs-comment">// â‘ è·å–å†™é”</span>
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// â‘¡åŒé‡æ£€æŸ¥(å…¶ä»–çº¿ç¨‹å¯èƒ½å·²åŠ è½½)</span>
            <span class="hljs-type">ProductDTO</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> cache.get(productId);
            <span class="hljs-keyword">if</span> (product != <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">return</span> product;
            }

            <span class="hljs-comment">// â‘¢ä»æ•°æ®åº“åŠ è½½</span>
            log.info(<span class="hljs-string">"ä»æ•°æ®åº“åŠ è½½å•†å“,productId:{}"</span>, productId);
            product = productRepository.findById(productId);

            <span class="hljs-keyword">if</span> (product != <span class="hljs-literal">null</span>) {
                cache.put(productId, product);
            }

            <span class="hljs-keyword">return</span> product;

        } <span class="hljs-keyword">finally</span> {
            writeLock.unlock();
        }
    }

    <span class="hljs-comment">/**
     * æ›´æ–°ç¼“å­˜(ç‹¬å å†™)
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">put</span><span class="hljs-params">(Long productId, ProductDTO product)</span> {
        writeLock.lock();
        <span class="hljs-keyword">try</span> {
            cache.put(productId, product);
            log.info(<span class="hljs-string">"æ›´æ–°ç¼“å­˜,productId:{}"</span>, productId);
        } <span class="hljs-keyword">finally</span> {
            writeLock.unlock();
        }
    }

    <span class="hljs-comment">/**
     * åˆ é™¤ç¼“å­˜
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">remove</span><span class="hljs-params">(Long productId)</span> {
        writeLock.lock();
        <span class="hljs-keyword">try</span> {
            cache.remove(productId);
            log.info(<span class="hljs-string">"åˆ é™¤ç¼“å­˜,productId:{}"</span>, productId);
        } <span class="hljs-keyword">finally</span> {
            writeLock.unlock();
        }
    }

    <span class="hljs-comment">/**
     * æ‰¹é‡é¢„çƒ­ç¼“å­˜(é”é™çº§ç¤ºä¾‹)
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">warmUp</span><span class="hljs-params">(List&lt;Long&gt; productIds)</span> {
        writeLock.lock();  <span class="hljs-comment">// â‘ è·å–å†™é”</span>
        <span class="hljs-keyword">try</span> {
            log.info(<span class="hljs-string">"å¼€å§‹é¢„çƒ­ç¼“å­˜,å•†å“æ•°:{}"</span>, productIds.size());

            List&lt;ProductDTO&gt; products = productRepository.findByIds(productIds);
            <span class="hljs-keyword">for</span> (ProductDTO product : products) {
                cache.put(product.getProductId(), product);
            }

            <span class="hljs-comment">// â‘¡é”é™çº§:è·å–è¯»é”</span>
            readLock.lock();

        } <span class="hljs-keyword">finally</span> {
            writeLock.unlock();  <span class="hljs-comment">// â‘¢é‡Šæ”¾å†™é”</span>
        }

        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// â‘£æŒæœ‰è¯»é”,å…è®¸å…¶ä»–çº¿ç¨‹å¹¶å‘è¯»å–</span>
            log.info(<span class="hljs-string">"ç¼“å­˜é¢„çƒ­å®Œæˆ,å½“å‰ç¼“å­˜æ•°:{}"</span>, cache.size());
        } <span class="hljs-keyword">finally</span> {
            readLock.unlock();  <span class="hljs-comment">// â‘¤é‡Šæ”¾è¯»é”</span>
        }
    }

    <span class="hljs-comment">/**
     * è·å–ç¼“å­˜ç»Ÿè®¡
     */</span>
    <span class="hljs-keyword">public</span> CacheStats <span class="hljs-title function_">getStats</span><span class="hljs-params">()</span> {
        readLock.lock();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">CacheStats</span> <span class="hljs-variable">stats</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CacheStats</span>();
            stats.setCacheSize(cache.size());
            <span class="hljs-keyword">return</span> stats;
        } <span class="hljs-keyword">finally</span> {
            readLock.unlock();
        }
    }

    <span class="hljs-meta">@Data</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CacheStats</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> cacheSize;
    }
}
</code></pre>
<h4 data-id="heading-40">æ€§èƒ½æå‡æ•°æ®å¯¹æ¯”</h4>
<p><strong>æµ‹è¯•ä»£ç :</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@BenchmarkMode(Mode.Throughput)</span>
<span class="hljs-meta">@Warmup(iterations = 3)</span>
<span class="hljs-meta">@Measurement(iterations = 5)</span>
<span class="hljs-meta">@State(Scope.Benchmark)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CacheBenchmark</span> {

    <span class="hljs-keyword">private</span> ProductCacheSynchronized syncCache;
    <span class="hljs-keyword">private</span> ProductCacheReadWriteLock rwCache;

    <span class="hljs-meta">@Setup</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setup</span><span class="hljs-params">()</span> {
        syncCache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProductCacheSynchronized</span>();
        rwCache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProductCacheReadWriteLock</span>();

        <span class="hljs-comment">// é¢„çƒ­ç¼“å­˜</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">long</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; i &lt;= <span class="hljs-number">1000</span>; i++) {
            <span class="hljs-type">ProductDTO</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProductDTO</span>();
            product.setProductId(i);
            product.setProductName(<span class="hljs-string">"å•†å“"</span> + i);

            syncCache.put(i, product);
            rwCache.put(i, product);
        }
    }

    <span class="hljs-comment">// è¯»å¤šå†™å°‘åœºæ™¯(99%è¯»,1%å†™)</span>
    <span class="hljs-meta">@Benchmark</span>
    <span class="hljs-meta">@Threads(100)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testSynchronizedRead</span><span class="hljs-params">()</span> {
        <span class="hljs-type">long</span> <span class="hljs-variable">productId</span> <span class="hljs-operator">=</span> ThreadLocalRandom.current().nextLong(<span class="hljs-number">1</span>, <span class="hljs-number">1001</span>);

        <span class="hljs-keyword">if</span> (ThreadLocalRandom.current().nextInt(<span class="hljs-number">100</span>) &lt; <span class="hljs-number">99</span>) {
            <span class="hljs-comment">// 99%è¯»æ“ä½œ</span>
            syncCache.get(productId);
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 1%å†™æ“ä½œ</span>
            <span class="hljs-type">ProductDTO</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProductDTO</span>();
            product.setProductId(productId);
            syncCache.put(productId, product);
        }
    }

    <span class="hljs-meta">@Benchmark</span>
    <span class="hljs-meta">@Threads(100)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testReadWriteLockRead</span><span class="hljs-params">()</span> {
        <span class="hljs-type">long</span> <span class="hljs-variable">productId</span> <span class="hljs-operator">=</span> ThreadLocalRandom.current().nextLong(<span class="hljs-number">1</span>, <span class="hljs-number">1001</span>);

        <span class="hljs-keyword">if</span> (ThreadLocalRandom.current().nextInt(<span class="hljs-number">100</span>) &lt; <span class="hljs-number">99</span>) {
            rwCache.get(productId);
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-type">ProductDTO</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProductDTO</span>();
            product.setProductId(productId);
            rwCache.put(productId, product);
        }
    }
}
</code></pre>
<p><strong>æµ‹è¯•ç»“æœ(JDK 17, ops/s):</strong></p>



































<table><thead><tr><th>å¹¶å‘çº¿ç¨‹æ•°</th><th>synchronized</th><th>ReadWriteLock</th><th>æå‡å€æ•°</th></tr></thead><tbody><tr><td>10</td><td>850K</td><td>2.1M</td><td>2.5x</td></tr><tr><td>50</td><td>420K</td><td>3.8M</td><td>9.0x</td></tr><tr><td>100</td><td>280K</td><td>4.2M</td><td>15.0x</td></tr><tr><td>200</td><td>190K</td><td>4.5M</td><td>23.7x</td></tr></tbody></table>
<p><strong>ç»“è®º:</strong></p>
<ul>
<li>è¯»å¤šå†™å°‘åœºæ™¯ä¸‹,ReadWriteLockæ€§èƒ½æå‡æ˜¾è‘—</li>
<li>å¹¶å‘åº¦è¶Šé«˜,æ€§èƒ½ä¼˜åŠ¿è¶Šæ˜æ˜¾</li>
<li>100çº¿ç¨‹æ—¶æ€§èƒ½æå‡<strong>15å€</strong></li>
</ul>
<hr/>
<h2 data-id="heading-41">å››ã€ç”Ÿäº§æ¡ˆä¾‹ä¸æ•…éšœæ’æŸ¥</h2>
<h3 data-id="heading-42">4.1 æ¡ˆä¾‹1: AQSåœ¨é«˜å¹¶å‘åœºæ™¯çš„åº”ç”¨</h3>
<h4 data-id="heading-43">ä¸šåŠ¡åœºæ™¯:ç§’æ€ç³»ç»Ÿåº“å­˜æ‰£å‡</h4>
<p>ç”µå•†å¹³å°ç§’æ€æ´»åŠ¨,éœ€è¦ä¿è¯:</p>
<ul>
<li>åº“å­˜æ‰£å‡çš„åŸå­æ€§(ä¸èƒ½è¶…å–)</li>
<li>é«˜å¹¶å‘(QPS 10000+)</li>
<li>ä½å»¶è¿Ÿ(P99 &lt; 50ms)</li>
</ul>
<h4 data-id="heading-44">ä¸ºä»€ä¹ˆä¸ç”¨synchronized?</h4>
<p><strong>synchronizedçš„é—®é¢˜:</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ä½¿ç”¨synchronizedçš„åº“å­˜æ‰£å‡</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">deductStock</span><span class="hljs-params">(Long skuId, <span class="hljs-type">int</span> quantity)</span> {
    <span class="hljs-type">Integer</span> <span class="hljs-variable">stock</span> <span class="hljs-operator">=</span> stockMap.get(skuId);
    <span class="hljs-keyword">if</span> (stock == <span class="hljs-literal">null</span> || stock &lt; quantity) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;  <span class="hljs-comment">// åº“å­˜ä¸è¶³</span>
    }

    stockMap.put(skuId, stock - quantity);
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}
</code></pre>
<p><strong>æ€§èƒ½ç“¶é¢ˆ:</strong></p>
<ul>
<li>é”ç²’åº¦å¤ªç²—: æ‰€æœ‰SKUå…±ç”¨ä¸€æŠŠé”</li>
<li>SKU Açš„æ‰£å‡ä¼šé˜»å¡SKU Bçš„æ‰£å‡</li>
<li>é«˜å¹¶å‘ä¸‹ååé‡å—é™</li>
</ul>
<h4 data-id="heading-45">æŠ€æœ¯æ–¹æ¡ˆ:åˆ†æ®µé” + ReentrantLock</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * é«˜æ€§èƒ½åº“å­˜æ‰£å‡æœåŠ¡
 */</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StockDeductionService</span> {

    <span class="hljs-comment">// SKUç»´åº¦çš„åˆ†æ®µé”(é™ä½é”ç«äº‰)</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ConcurrentHashMap&lt;Long, ReentrantLock&gt; skuLocks = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();

    <span class="hljs-comment">// åº“å­˜ç¼“å­˜(Caffeineæœ¬åœ°ç¼“å­˜ + Redisåˆ†å¸ƒå¼ç¼“å­˜)</span>
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> Cache&lt;Long, Integer&gt; localCache;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RedisTemplate&lt;String, Integer&gt; redisTemplate;

    <span class="hljs-comment">/**
     * æ‰£å‡åº“å­˜
     * <span class="hljs-doctag">@param</span> skuId å•†å“SKU ID
     * <span class="hljs-doctag">@param</span> quantity æ‰£å‡æ•°é‡
     * <span class="hljs-doctag">@return</span> æ˜¯å¦æ‰£å‡æˆåŠŸ
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">deductStock</span><span class="hljs-params">(Long skuId, <span class="hljs-type">int</span> quantity)</span> {
        <span class="hljs-comment">// â‘ è·å–SKUç»´åº¦çš„é”(åˆ†æ®µé”,é™ä½ç«äº‰)</span>
        <span class="hljs-type">ReentrantLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> skuLocks.computeIfAbsent(skuId,
            k -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReentrantLock</span>(<span class="hljs-literal">false</span>));  <span class="hljs-comment">// éå…¬å¹³é”,æ€§èƒ½ä¼˜å…ˆ</span>

        <span class="hljs-comment">// â‘¡å°è¯•è·å–é”(è¶…æ—¶100ms)</span>
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">if</span> (!lock.tryLock(<span class="hljs-number">100</span>, TimeUnit.MILLISECONDS)) {
                log.warn(<span class="hljs-string">"è·å–åº“å­˜é”è¶…æ—¶,skuId:{}"</span>, skuId);
                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
            }
        } <span class="hljs-keyword">catch</span> (InterruptedException e) {
            Thread.currentThread().interrupt();
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }

        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// â‘¢å…ˆæŸ¥æœ¬åœ°ç¼“å­˜</span>
            <span class="hljs-type">Integer</span> <span class="hljs-variable">stock</span> <span class="hljs-operator">=</span> localCache.getIfPresent(skuId);

            <span class="hljs-keyword">if</span> (stock == <span class="hljs-literal">null</span>) {
                <span class="hljs-comment">// â‘£æœ¬åœ°ç¼“å­˜æœªå‘½ä¸­,æŸ¥Redis</span>
                <span class="hljs-type">String</span> <span class="hljs-variable">redisKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"stock:"</span> + skuId;
                stock = redisTemplate.opsForValue().get(redisKey);

                <span class="hljs-keyword">if</span> (stock == <span class="hljs-literal">null</span>) {
                    <span class="hljs-comment">// â‘¤Redisä¹Ÿæœªå‘½ä¸­,æŸ¥æ•°æ®åº“</span>
                    stock = loadStockFromDB(skuId);
                    <span class="hljs-keyword">if</span> (stock == <span class="hljs-literal">null</span>) {
                        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;  <span class="hljs-comment">// å•†å“ä¸å­˜åœ¨</span>
                    }

                    <span class="hljs-comment">// å›å†™ç¼“å­˜</span>
                    redisTemplate.opsForValue().set(redisKey, stock, <span class="hljs-number">60</span>, TimeUnit.SECONDS);
                }

                <span class="hljs-comment">// å›å†™æœ¬åœ°ç¼“å­˜</span>
                localCache.put(skuId, stock);
            }

            <span class="hljs-comment">// â‘¥æ£€æŸ¥åº“å­˜</span>
            <span class="hljs-keyword">if</span> (stock &lt; quantity) {
                log.warn(<span class="hljs-string">"åº“å­˜ä¸è¶³,skuId:{},å½“å‰åº“å­˜:{},æ‰£å‡æ•°é‡:{}"</span>,
                        skuId, stock, quantity);
                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
            }

            <span class="hljs-comment">// â‘¦æ‰£å‡åº“å­˜(æœ¬åœ°ç¼“å­˜ + Redis)</span>
            <span class="hljs-type">int</span> <span class="hljs-variable">newStock</span> <span class="hljs-operator">=</span> stock - quantity;
            localCache.put(skuId, newStock);

            <span class="hljs-type">String</span> <span class="hljs-variable">redisKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"stock:"</span> + skuId;
            redisTemplate.opsForValue().set(redisKey, newStock, <span class="hljs-number">60</span>, TimeUnit.SECONDS);

            <span class="hljs-comment">// â‘§å¼‚æ­¥æ›´æ–°æ•°æ®åº“(MQ)</span>
            sendStockUpdateMessage(skuId, newStock);

            log.info(<span class="hljs-string">"åº“å­˜æ‰£å‡æˆåŠŸ,skuId:{},æ‰£å‡:{},å‰©ä½™:{}"</span>, skuId, quantity, newStock);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;

        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-comment">// â‘¨é‡Šæ”¾é”(å¿…é¡»åœ¨finallyä¸­)</span>
            lock.unlock();
        }
    }

    <span class="hljs-comment">/**
     * ä»æ•°æ®åº“åŠ è½½åº“å­˜
     */</span>
    <span class="hljs-keyword">private</span> Integer <span class="hljs-title function_">loadStockFromDB</span><span class="hljs-params">(Long skuId)</span> {
        <span class="hljs-comment">// å®é™…å®ç°çœç•¥</span>
        <span class="hljs-keyword">return</span> <span class="hljs-number">1000</span>;
    }

    <span class="hljs-comment">/**
     * å¼‚æ­¥æ›´æ–°æ•°æ®åº“åº“å­˜(é€šè¿‡MQ)
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendStockUpdateMessage</span><span class="hljs-params">(Long skuId, <span class="hljs-type">int</span> newStock)</span> {
        <span class="hljs-comment">// å‘é€MQæ¶ˆæ¯,å¼‚æ­¥æ›´æ–°æ•°æ®åº“</span>
        <span class="hljs-comment">// å®é™…å®ç°çœç•¥</span>
    }

    <span class="hljs-comment">/**
     * å®šæ—¶æ¸…ç†ç©ºé—²é”å¯¹è±¡(é˜²æ­¢å†…å­˜æ³„æ¼)
     */</span>
    <span class="hljs-meta">@Scheduled(fixedRate = 60000)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">cleanIdleLocks</span><span class="hljs-params">()</span> {
        skuLocks.entrySet().removeIf(entry -&gt; {
            <span class="hljs-type">ReentrantLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> entry.getValue();
            <span class="hljs-comment">// å°è¯•è·å–é”,è·å–æˆåŠŸè¯´æ˜æ— äººä½¿ç”¨</span>
            <span class="hljs-keyword">if</span> (lock.tryLock()) {
                <span class="hljs-keyword">try</span> {
                    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;  <span class="hljs-comment">// ç§»é™¤</span>
                } <span class="hljs-keyword">finally</span> {
                    lock.unlock();
                }
            }
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;  <span class="hljs-comment">// ä¿ç•™</span>
        });

        log.info(<span class="hljs-string">"æ¸…ç†ç©ºé—²é”å®Œæˆ,å½“å‰é”æ•°é‡:{}"</span>, skuLocks.size());
    }
}
</code></pre>
<h4 data-id="heading-46">å‹æµ‹æ•°æ®ä¸ä¼˜åŒ–è¿‡ç¨‹</h4>
<p><strong>ä¼˜åŒ–å‰(synchronized):</strong></p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">å¹¶å‘:1000</span>
<span class="hljs-section">QPS: 2800</span>
<span class="hljs-section">P99å»¶è¿Ÿ: 350ms</span>
<span class="hljs-section">é”™è¯¯ç‡: 15% (è¶…æ—¶)</span>
</code></pre>
<p><strong>ä¼˜åŒ–å(ReentrantLockåˆ†æ®µé”):</strong></p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">å¹¶å‘:1000</span>
<span class="hljs-section">QPS: 12000  (æå‡4.3å€)</span>
<span class="hljs-section">P99å»¶è¿Ÿ: 45ms  (é™ä½87%)</span>
<span class="hljs-section">é”™è¯¯ç‡: 0.1%</span>
</code></pre>
<p><strong>ä¼˜åŒ–å…³é”®ç‚¹:</strong></p>
<ol>
<li><strong>åˆ†æ®µé”</strong>: æ¯ä¸ªSKUç‹¬ç«‹é”,é™ä½ç«äº‰</li>
<li><strong>éå…¬å¹³é”</strong>: æ€§èƒ½ä¼˜å…ˆ,é¿å…çº¿ç¨‹åˆ‡æ¢</li>
<li><strong>è¶…æ—¶æœºåˆ¶</strong>: <code>tryLock(100ms)</code>,é¿å…æ— é™ç­‰å¾…</li>
<li><strong>å¤šçº§ç¼“å­˜</strong>: æœ¬åœ°ç¼“å­˜(Caffeine) + Redis,é™ä½DBå‹åŠ›</li>
<li><strong>å¼‚æ­¥æ›´æ–°DB</strong>: é€šè¿‡MQå¼‚æ­¥,ä¸é˜»å¡ä¸»æµç¨‹</li>
</ol>
<h3 data-id="heading-47">4.2 æ¡ˆä¾‹2: CountDownLatchè¶…æ—¶æœªé‡Šæ”¾å¯¼è‡´çš„çº¿ç¨‹æ³„æ¼</h3>
<h4 data-id="heading-48">æ•…éšœç°è±¡</h4>
<p>ç”Ÿäº§ç¯å¢ƒå‘ç°çº¿ç¨‹æ± çº¿ç¨‹æ•°æŒç»­å¢é•¿,æœ€ç»ˆè€—å°½:</p>
<pre><code class="hljs language-arduino" lang="arduino">[ERROR] ThreadPoolExecutor: Worker creation failed
[WARN] ThreadPoolExecutor: Pool size: <span class="hljs-number">200</span>/<span class="hljs-number">200</span> (max)
</code></pre>
<h4 data-id="heading-49">é—®é¢˜åˆ†æ</h4>
<p><strong>æ’æŸ¥è¿‡ç¨‹:</strong></p>
<ol>
<li><strong>çº¿ç¨‹dumpåˆ†æ</strong></li>
</ol>
<pre><code class="hljs language-bash" lang="bash">jstack &lt;pid&gt; &gt; thread_dump.txt
</code></pre>
<p>å‘ç°å¤§é‡çº¿ç¨‹é˜»å¡åœ¨<code>CountDownLatch.await()</code>:</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-string">"batch-import-1"</span> <span class="hljs-comment">#123 prio=5 os_prio=0 waiting on condition</span>
   java.lang.Thread.State: <span class="hljs-title function_ invoke__">WAITING</span> (parking)
        at sun.misc.Unsafe.<span class="hljs-title function_ invoke__">park</span>(Native Method)
        at java.util.concurrent.locks.LockSupport.<span class="hljs-title function_ invoke__">park</span>(LockSupport.<span class="hljs-attr">java</span>:<span class="hljs-number">175</span>)
        at java.util.concurrent.locks.AbstractQueuedSynchronizer.parkAndCheckInterrupt
        at java.util.concurrent.locks.AbstractQueuedSynchronizer.doAcquireSharedInterruptibly
        at java.util.concurrent.CountDownLatch.<span class="hljs-title function_ invoke__">await</span>(CountDownLatch.<span class="hljs-attr">java</span>:<span class="hljs-number">231</span>)
        at com.example.service.BatchService.<span class="hljs-title function_ invoke__">importData</span>(BatchService.<span class="hljs-attr">java</span>:<span class="hljs-number">45</span>)
</code></pre>
<p>2.  <strong>ä»£ç å®¡æŸ¥</strong></p>
<p>å‘ç°é—®é¢˜ä»£ç :</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// âŒé”™è¯¯ä»£ç </span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">batchImport</span><span class="hljs-params">(List&lt;Data&gt; dataList)</span> {
    <span class="hljs-type">CountDownLatch</span> <span class="hljs-variable">latch</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CountDownLatch</span>(<span class="hljs-number">10</span>);

    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) {
        executor.submit(() -&gt; {
            processData(dataList.get(i));  <span class="hljs-comment">// å¯èƒ½æŠ›å¼‚å¸¸</span>
            latch.countDown();  <span class="hljs-comment">// å¼‚å¸¸æ—¶æœªæ‰§è¡Œ!</span>
        });
    }

    latch.await();  <span class="hljs-comment">// æ°¸ä¹…é˜»å¡!</span>
}
</code></pre>
<p><strong>æ ¹å› :</strong></p>
<ul>
<li>å­ä»»åŠ¡æŠ›å‡ºå¼‚å¸¸æ—¶,<code>countDown()</code>æœªæ‰§è¡Œ</li>
<li>ä¸»çº¿ç¨‹<code>await()</code>æ°¸ä¹…é˜»å¡</li>
<li>çº¿ç¨‹æ± çº¿ç¨‹è¢«å ç”¨,æœ€ç»ˆè€—å°½</li>
</ul>
<h4 data-id="heading-50">è§£å†³æ–¹æ¡ˆ</h4>
<p><strong>æ–¹æ¡ˆ1: finallyå—ä¿è¯countDown</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// âœ…æ­£ç¡®ä»£ç </span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">batchImport</span><span class="hljs-params">(List&lt;Data&gt; dataList)</span> {
    <span class="hljs-type">CountDownLatch</span> <span class="hljs-variable">latch</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CountDownLatch</span>(<span class="hljs-number">10</span>);

    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) {
        <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">index</span> <span class="hljs-operator">=</span> i;
        executor.submit(() -&gt; {
            <span class="hljs-keyword">try</span> {
                processData(dataList.get(index));
            } <span class="hljs-keyword">catch</span> (Exception e) {
                log.error(<span class="hljs-string">"å¤„ç†å¤±è´¥,index:{}"</span>, index, e);
            } <span class="hljs-keyword">finally</span> {
                latch.countDown();  <span class="hljs-comment">// å¿…å®šæ‰§è¡Œ</span>
            }
        });
    }

    <span class="hljs-comment">// å¢åŠ è¶…æ—¶ä¿æŠ¤</span>
    <span class="hljs-type">boolean</span> <span class="hljs-variable">finished</span> <span class="hljs-operator">=</span> latch.await(<span class="hljs-number">30</span>, TimeUnit.SECONDS);
    <span class="hljs-keyword">if</span> (!finished) {
        log.error(<span class="hljs-string">"æ‰¹é‡å¤„ç†è¶…æ—¶"</span>);
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(<span class="hljs-string">"æ‰¹é‡å¤„ç†è¶…æ—¶"</span>);
    }
}
</code></pre>
<p><strong>æ–¹æ¡ˆ2: ä½¿ç”¨CompletableFuture(æ¨è)</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// âœ…æ›´ä¼˜æ–¹æ¡ˆ:ä½¿ç”¨CompletableFuture</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">batchImport</span><span class="hljs-params">(List&lt;Data&gt; dataList)</span> {
    <span class="hljs-comment">// åˆ›å»ºå¼‚æ­¥ä»»åŠ¡</span>
    List&lt;CompletableFuture&lt;Void&gt;&gt; futures = dataList.stream()
        .map(data -&gt; CompletableFuture.runAsync(() -&gt; {
            processData(data);
        }, executor))
        .collect(Collectors.toList());

    <span class="hljs-comment">// ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆ(å¸¦è¶…æ—¶)</span>
    <span class="hljs-keyword">try</span> {
        CompletableFuture.allOf(futures.toArray(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CompletableFuture</span>[<span class="hljs-number">0</span>]))
            .get(<span class="hljs-number">30</span>, TimeUnit.SECONDS);
        log.info(<span class="hljs-string">"æ‰¹é‡å¤„ç†å®Œæˆ"</span>);
    } <span class="hljs-keyword">catch</span> (TimeoutException e) {
        log.error(<span class="hljs-string">"æ‰¹é‡å¤„ç†è¶…æ—¶"</span>);
        <span class="hljs-comment">// å–æ¶ˆæœªå®Œæˆçš„ä»»åŠ¡</span>
        futures.forEach(f -&gt; f.cancel(<span class="hljs-literal">true</span>));
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(<span class="hljs-string">"æ‰¹é‡å¤„ç†è¶…æ—¶"</span>, e);
    } <span class="hljs-keyword">catch</span> (Exception e) {
        log.error(<span class="hljs-string">"æ‰¹é‡å¤„ç†å¤±è´¥"</span>, e);
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(<span class="hljs-string">"æ‰¹é‡å¤„ç†å¤±è´¥"</span>, e);
    }
}
</code></pre>
<p><strong>CompletableFutureçš„ä¼˜åŠ¿:</strong></p>
<ul>
<li>âœ… å¼‚å¸¸è‡ªåŠ¨ä¼ æ’­,ä¸ä¼šä¸¢å¤±</li>
<li>âœ… æ”¯æŒé“¾å¼è°ƒç”¨,ä»£ç æ›´ä¼˜é›…</li>
<li>âœ… æ”¯æŒè¶…æ—¶å–æ¶ˆ</li>
<li>âœ… æ”¯æŒç»„åˆå¤šä¸ªå¼‚æ­¥ä»»åŠ¡</li>
</ul>
<h4 data-id="heading-51">æ”¹è¿›æ–¹æ¡ˆå¯¹æ¯”</h4>

























<table><thead><tr><th>æ–¹æ¡ˆ</th><th>ä¼˜ç‚¹</th><th>ç¼ºç‚¹</th></tr></thead><tbody><tr><td>CountDownLatch + finally</td><td>ç®€å•ç›´æ¥</td><td>å¼‚å¸¸å¤„ç†å¤æ‚,éœ€æ‰‹åŠ¨ç®¡ç†</td></tr><tr><td>CompletableFuture</td><td>å¼‚å¸¸è‡ªåŠ¨å¤„ç†,APIä¸°å¯Œ</td><td>å­¦ä¹ æˆæœ¬ç¨é«˜</td></tr><tr><td>CompletableFuture + è¶…æ—¶</td><td>å®Œå–„çš„å¼‚å¸¸å’Œè¶…æ—¶å¤„ç†</td><td>-</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-52">äº”ã€å¸¸è§é—®é¢˜ä¸é¿å‘æŒ‡å—</h2>
<h3 data-id="heading-53">5.1 AQSçš„stateå­—æ®µä¸ºä»€ä¹ˆç”¨volatile?</h3>
<p><strong>åŸå› 1: ä¿è¯å¯è§æ€§</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// çº¿ç¨‹A</span>
state = <span class="hljs-number">1</span>;  <span class="hljs-comment">// é‡Šæ”¾é”</span>

<span class="hljs-comment">// çº¿ç¨‹B</span>
<span class="hljs-keyword">if</span> (state == <span class="hljs-number">0</span>) {  <span class="hljs-comment">// è·å–é”</span>
    <span class="hljs-comment">// ...</span>
}
</code></pre>
<p>å¦‚æœ<code>state</code>ä¸æ˜¯<code>volatile</code>,çº¿ç¨‹Bå¯èƒ½è¯»å–åˆ°æ—§å€¼(ç¼“å­˜),å¯¼è‡´:</p>
<ul>
<li>çœ‹åˆ°state=0(å®é™…å·²è¢«ä¿®æ”¹ä¸º1)</li>
<li>é‡å¤è·å–é”,ç ´åäº’æ–¥æ€§</li>
</ul>
<p><strong>åŸå› 2: é…åˆCASä¿è¯åŸå­æ€§</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">compareAndSetState</span><span class="hljs-params">(<span class="hljs-type">int</span> expect, <span class="hljs-type">int</span> update)</span> {
    <span class="hljs-keyword">return</span> unsafe.compareAndSwapInt(<span class="hljs-built_in">this</span>, stateOffset, expect, update);
}
</code></pre>
<p>CASæ“ä½œæœ¬èº«æ˜¯åŸå­çš„,ä½†éœ€è¦<code>volatile</code>ä¿è¯:</p>
<ul>
<li>è¯»å–æœ€æ–°å€¼è¿›è¡Œæ¯”è¾ƒ</li>
<li>ä¿®æ”¹åç«‹å³å¯¹å…¶ä»–çº¿ç¨‹å¯è§</li>
</ul>
<p><strong>åŸå› 3: ç¦æ­¢é‡æ’åº</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// è·å–é”çš„å…¸å‹æµç¨‹</span>
<span class="hljs-keyword">if</span> (compareAndSetState(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>)) {  <span class="hljs-comment">// â‘ CASè·å–é”</span>
    setExclusiveOwnerThread(current);  <span class="hljs-comment">// â‘¡è®¾ç½®æŒæœ‰çº¿ç¨‹</span>
    <span class="hljs-comment">// â‘¢æ‰§è¡Œä¸´ç•ŒåŒºä»£ç </span>
}
</code></pre>
<p><code>volatile</code>çš„å†…å­˜å±éšœä¿è¯:</p>
<ul>
<li>â‘ â‘¡ä¸ä¼šé‡æ’åºåˆ°â‘¢ä¹‹å</li>
<li>å…¶ä»–çº¿ç¨‹çœ‹åˆ°state=1æ—¶,å¿…å®šä¹Ÿèƒ½çœ‹åˆ°ownerçº¿ç¨‹çš„è®¾ç½®</li>
</ul>
<h3 data-id="heading-54">5.2 ä¸ºä»€ä¹ˆéœ€è¦CLHé˜Ÿåˆ—?ç›´æ¥è‡ªæ—‹ä¸è¡Œå—?</h3>
<p><strong>çº¯è‡ªæ—‹çš„é—®é¢˜:</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// çº¯è‡ªæ—‹é”</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SpinLock</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">AtomicBoolean</span> <span class="hljs-variable">locked</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicBoolean</span>(<span class="hljs-literal">false</span>);

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">lock</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">while</span> (!locked.compareAndSet(<span class="hljs-literal">false</span>, <span class="hljs-literal">true</span>)) {
            <span class="hljs-comment">// ä¸æ–­è‡ªæ—‹,æµªè´¹CPU</span>
        }
    }
}
</code></pre>
<p><strong>é—®é¢˜:</strong></p>
<ol>
<li><strong>CPUç©ºè½¬</strong>: é«˜ç«äº‰ä¸‹,å¤§é‡çº¿ç¨‹è‡ªæ—‹,CPUåˆ©ç”¨ç‡100%ä½†æ— æ•ˆ</li>
<li><strong>ä¸å…¬å¹³</strong>: æ— æ³•ä¿è¯FIFOé¡ºåº,å¯èƒ½é¥¥é¥¿</li>
<li><strong>æ— æ³•æ”¯æŒä¸­æ–­/è¶…æ—¶</strong>: è‡ªæ—‹è¿‡ç¨‹æ— æ³•å“åº”ä¸­æ–­</li>
</ol>
<p><strong>CLHé˜Ÿåˆ—çš„ä¼˜åŠ¿:</strong></p>
<ol>
<li><strong>è‡ªæ—‹+é˜»å¡ç»“åˆ</strong>: å…ˆè‡ªæ—‹å‡ æ¬¡,å¤±è´¥åé˜»å¡(park),é¿å…CPUç©ºè½¬</li>
<li><strong>FIFOå…¬å¹³æ€§</strong>: é˜Ÿåˆ—å¤©ç„¶ä¿è¯å…ˆè¿›å…ˆå‡º</li>
<li><strong>æ”¯æŒä¸­æ–­/è¶…æ—¶</strong>: <code>parkNanos</code>/<code>parkUntil</code>æ”¯æŒè¶…æ—¶,<code>park</code>å¯è¢«ä¸­æ–­</li>
<li><strong>èŠ‚ç‚¹çŠ¶æ€ç®¡ç†</strong>: <code>waitStatus</code>è®°å½•èŠ‚ç‚¹çŠ¶æ€,ä¼˜åŒ–å”¤é†’æµç¨‹</li>
</ol>
<h3 data-id="heading-55">5.3 CountDownLatch vs CyclicBarrierå¦‚ä½•é€‰æ‹©?</h3>
<p><strong>CountDownLatchåœºæ™¯:</strong></p>
<ul>
<li>âœ… ä¸€ç»„çº¿ç¨‹ç­‰å¾…å¦ä¸€ç»„çº¿ç¨‹å®Œæˆ</li>
<li>âœ… ä¸€æ¬¡æ€§ä½¿ç”¨(æ— éœ€é‡ç½®)</li>
<li>âœ… ç­‰å¾…è€…ä¸æ‰§è¡Œè€…è§’è‰²æ˜ç¡®</li>
</ul>
<p><strong>ç¤ºä¾‹:</strong> ä¸»çº¿ç¨‹ç­‰å¾…æ‰€æœ‰å­çº¿ç¨‹å®Œæˆ</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">CountDownLatch</span> <span class="hljs-variable">latch</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CountDownLatch</span>(<span class="hljs-number">10</span>);

<span class="hljs-comment">// ä¸»çº¿ç¨‹</span>
latch.await();

<span class="hljs-comment">// å­çº¿ç¨‹</span>
latch.countDown();
</code></pre>
<p><strong>CyclicBarrieråœºæ™¯:</strong></p>
<ul>
<li>âœ… å¤šä¸ªçº¿ç¨‹ç›¸äº’ç­‰å¾…</li>
<li>âœ… éœ€è¦é‡å¤ä½¿ç”¨</li>
<li>âœ… åˆ°è¾¾å±éšœç‚¹åæ‰§è¡Œå…±åŒåŠ¨ä½œ</li>
</ul>
<p><strong>ç¤ºä¾‹:</strong> å¤šçº¿ç¨‹è®¡ç®—,æ¯è½®åŒæ­¥</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">CyclicBarrier</span> <span class="hljs-variable">barrier</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CyclicBarrier</span>(<span class="hljs-number">3</span>, () -&gt; {
    System.out.println(<span class="hljs-string">"ä¸€è½®è®¡ç®—å®Œæˆ"</span>);
});

<span class="hljs-comment">// æ¯ä¸ªçº¿ç¨‹</span>
<span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">round</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; round &lt; <span class="hljs-number">10</span>; round++) {
    compute(round);
    barrier.await();  <span class="hljs-comment">// ç­‰å¾…å…¶ä»–çº¿ç¨‹</span>
}
</code></pre>
<p><strong>å†³ç­–è¡¨:</strong></p>






























<table><thead><tr><th>éœ€æ±‚</th><th>CountDownLatch</th><th>CyclicBarrier</th></tr></thead><tbody><tr><td>é‡å¤ä½¿ç”¨</td><td>âŒ</td><td>âœ…</td></tr><tr><td>è§’è‰²åˆ†ç¦»(ç­‰å¾…è€…vsæ‰§è¡Œè€…)</td><td>âœ…</td><td>âŒ</td></tr><tr><td>å±éšœåŠ¨ä½œ</td><td>âŒ</td><td>âœ…</td></tr><tr><td>åº•å±‚å®ç°</td><td>AQS</td><td>ReentrantLock</td></tr></tbody></table>
<h3 data-id="heading-56">5.4 ReentrantLockä¸ºä»€ä¹ˆæ¨èåœ¨finallyä¸­unlock?</h3>
<p><strong>é”™è¯¯ç¤ºä¾‹:</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// âŒé”™è¯¯:unlockä¸åœ¨finallyä¸­</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transfer</span><span class="hljs-params">(Account from, Account to, <span class="hljs-type">int</span> amount)</span> {
    lock.lock();

    <span class="hljs-keyword">if</span> (from.getBalance() &lt; amount) {
        lock.unlock();  <span class="hljs-comment">// â‘ æå‰è¿”å›æ—¶é‡Šæ”¾</span>
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InsufficientBalanceException</span>();
    }

    from.deduct(amount);
    to.add(amount);  <span class="hljs-comment">// â‘¡å¦‚æœè¿™é‡ŒæŠ›å¼‚å¸¸,é”æ°¸ä¸é‡Šæ”¾!</span>

    lock.unlock();  <span class="hljs-comment">// â‘¢æ­£å¸¸æµç¨‹é‡Šæ”¾</span>
}
</code></pre>
<p><strong>é—®é¢˜:</strong></p>
<ul>
<li>å¦‚æœâ‘¡æŠ›å‡ºå¼‚å¸¸,â‘¢ä¸ä¼šæ‰§è¡Œ,é”æ°¸ä¸é‡Šæ”¾</li>
<li>å…¶ä»–çº¿ç¨‹æ°¸ä¹…é˜»å¡,å¯¼è‡´æ­»é”</li>
</ul>
<p><strong>æ­£ç¡®ç¤ºä¾‹:</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// âœ…æ­£ç¡®:unlockåœ¨finallyä¸­</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transfer</span><span class="hljs-params">(Account from, Account to, <span class="hljs-type">int</span> amount)</span> {
    lock.lock();
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">if</span> (from.getBalance() &lt; amount) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InsufficientBalanceException</span>();
        }

        from.deduct(amount);
        to.add(amount);
    } <span class="hljs-keyword">finally</span> {
        lock.unlock();  <span class="hljs-comment">// æ— è®ºå¦‚ä½•éƒ½ä¼šé‡Šæ”¾</span>
    }
}
</code></pre>
<p><strong>åŸåˆ™:</strong></p>
<ul>
<li><code>lock()</code>å’Œ<code>unlock()</code>å¿…é¡»é…å¯¹</li>
<li><code>unlock()</code>å¿…é¡»åœ¨<code>finally</code>å—ä¸­</li>
<li>é¿å…åœ¨<code>try</code>å—å¤–<code>lock()</code>(å¯èƒ½å¼‚å¸¸å¯¼è‡´æœªlockå°±unlock)</li>
</ul>
<h3 data-id="heading-57">5.5 Semaphoreçš„å…¬å¹³ä¸éå…¬å¹³æ¨¡å¼æ€§èƒ½å·®å¼‚å¤šå¤§?</h3>
<p>å‰é¢çš„æµ‹è¯•ç»“æœæ˜¾ç¤º:</p>
<ul>
<li><strong>éå…¬å¹³æ¨¡å¼ååé‡æå‡çº¦50%</strong></li>
<li><strong>å…¬å¹³æ¨¡å¼å»¶è¿Ÿæ›´ç¨³å®š,é¿å…é¥¥é¥¿</strong></li>
</ul>
<p><strong>é€‚ç”¨åœºæ™¯:</strong></p>
<ul>
<li><strong>é«˜ååä¸šåŠ¡</strong>: éå…¬å¹³æ¨¡å¼(å¦‚æ¥å£é™æµ)</li>
<li><strong>å…³é”®ä¸šåŠ¡</strong>: å…¬å¹³æ¨¡å¼(å¦‚ä»»åŠ¡è°ƒåº¦,é¿å…é¥¥é¥¿)</li>
</ul>
<h3 data-id="heading-58">5.6 ReadWriteLockçš„é”é™çº§æ˜¯ä»€ä¹ˆ?å¦‚ä½•å®ç°?</h3>
<p><strong>é”é™çº§:</strong> æŒæœ‰å†™é”æ—¶è·å–è¯»é”,ç„¶åé‡Šæ”¾å†™é”</p>
<p><strong>æ­£ç¡®ç¤ºä¾‹:</strong></p>
<pre><code class="hljs language-java" lang="java">rwLock.writeLock().lock();  <span class="hljs-comment">// â‘ è·å–å†™é”</span>
<span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// æ›´æ–°æ•°æ®</span>
    data = newData;

    rwLock.readLock().lock();  <span class="hljs-comment">// â‘¡è·å–è¯»é”(é”é™çº§)</span>
} <span class="hljs-keyword">finally</span> {
    rwLock.writeLock().unlock();  <span class="hljs-comment">// â‘¢é‡Šæ”¾å†™é”</span>
}

<span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// â‘£ä½¿ç”¨æ•°æ®(æŒæœ‰è¯»é”)</span>
    use(data);
} <span class="hljs-keyword">finally</span> {
    rwLock.readLock().unlock();  <span class="hljs-comment">// â‘¤é‡Šæ”¾è¯»é”</span>
}
</code></pre>
<p><strong>ä¸ºä»€ä¹ˆéœ€è¦é”é™çº§?</strong></p>
<ul>
<li>ä¿è¯æ•°æ®ä¸€è‡´æ€§: â‘¡â‘¢ä¹‹é—´,å…¶ä»–çº¿ç¨‹æ— æ³•ä¿®æ”¹æ•°æ®</li>
<li>æé«˜å¹¶å‘æ€§: é‡Šæ”¾å†™é”å,å…¶ä»–çº¿ç¨‹å¯ä»¥å¹¶å‘è¯»</li>
</ul>
<h3 data-id="heading-59">5.7 ä¸ºä»€ä¹ˆæ²¡æœ‰é”å‡çº§?</h3>
<p><strong>é”å‡çº§(è¯»é”â†’å†™é”)ä¼šå¯¼è‡´æ­»é”:</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// âŒæ­»é”ç¤ºä¾‹</span>
<span class="hljs-comment">// çº¿ç¨‹A</span>
readLock.lock();
<span class="hljs-comment">// ... æƒ³å‡çº§ä¸ºå†™é”</span>
writeLock.lock();  <span class="hljs-comment">// é˜»å¡,ç­‰å¾…è¯»é”é‡Šæ”¾</span>

<span class="hljs-comment">// çº¿ç¨‹B</span>
readLock.lock();
<span class="hljs-comment">// ... æƒ³å‡çº§ä¸ºå†™é”</span>
writeLock.lock();  <span class="hljs-comment">// é˜»å¡,ç­‰å¾…è¯»é”é‡Šæ”¾</span>

<span class="hljs-comment">// æ­»é”! ä¸¤ä¸ªçº¿ç¨‹éƒ½æŒæœ‰è¯»é”,éƒ½ç­‰å¾…å¯¹æ–¹é‡Šæ”¾</span>
</code></pre>
<p><strong>æ­£ç¡®åšæ³•: å…ˆé‡Šæ”¾è¯»é”,å†è·å–å†™é”</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// âœ…æ­£ç¡®</span>
readLock.lock();
<span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// è¯»å–æ•°æ®</span>
    <span class="hljs-keyword">if</span> (needUpdate) {
        readLock.unlock();  <span class="hljs-comment">// â‘ é‡Šæ”¾è¯»é”</span>

        writeLock.lock();  <span class="hljs-comment">// â‘¡è·å–å†™é”</span>
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// â‘¢åŒé‡æ£€æŸ¥</span>
            <span class="hljs-keyword">if</span> (needUpdate) {
                <span class="hljs-comment">// æ›´æ–°æ•°æ®</span>
            }
        } <span class="hljs-keyword">finally</span> {
            writeLock.unlock();
        }
    }
} <span class="hljs-keyword">finally</span> {
    <span class="hljs-keyword">if</span> (readLock.isHeldByCurrentThread()) {
        readLock.unlock();
    }
}
</code></pre>
<h3 data-id="heading-60">5.8 Condition vs wait/notifyçš„åŒºåˆ«?</h3>













































<table><thead><tr><th>ç‰¹æ€§</th><th>wait/notify</th><th>Condition</th></tr></thead><tbody><tr><td>ç»‘å®šå¯¹è±¡</td><td>ä»»æ„Object</td><td>Lock</td></tr><tr><td>æ¡ä»¶æ•°é‡</td><td>1ä¸ª(å¯¹è±¡ç›‘è§†å™¨)</td><td>å¤šä¸ª(ä¸€ä¸ªLockå¤šä¸ªCondition)</td></tr><tr><td>å”¤é†’ç²¾ç¡®æ€§</td><td>âŒnotifyéšæœºå”¤é†’</td><td>âœ…signalç²¾ç¡®å”¤é†’</td></tr><tr><td>æ”¯æŒä¸­æ–­</td><td>âœ…</td><td>âœ…</td></tr><tr><td>æ”¯æŒè¶…æ—¶</td><td>âœ…</td><td>âœ…</td></tr><tr><td>å¿…é¡»åœ¨åŒæ­¥å—</td><td>âœ…å¿…é¡»åœ¨synchronized</td><td>âœ…å¿…é¡»æŒæœ‰Lock</td></tr><tr><td>è™šå‡å”¤é†’</td><td>âš ï¸å­˜åœ¨</td><td>âš ï¸å­˜åœ¨</td></tr></tbody></table>
<p><strong>Conditionçš„ä¼˜åŠ¿:</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// å¤šæ¡ä»¶ç¤ºä¾‹:ç”Ÿäº§è€…-æ¶ˆè´¹è€…</span>
<span class="hljs-type">Lock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReentrantLock</span>();
<span class="hljs-type">Condition</span> <span class="hljs-variable">notFull</span> <span class="hljs-operator">=</span> lock.newCondition();   <span class="hljs-comment">// æ¡ä»¶1</span>
<span class="hljs-type">Condition</span> <span class="hljs-variable">notEmpty</span> <span class="hljs-operator">=</span> lock.newCondition();  <span class="hljs-comment">// æ¡ä»¶2</span>

<span class="hljs-comment">// ç”Ÿäº§è€…</span>
lock.lock();
<span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">while</span> (count == capacity) {
        notFull.await();  <span class="hljs-comment">// ç­‰å¾…notFullæ¡ä»¶</span>
    }
    <span class="hljs-comment">// ç”Ÿäº§</span>
    notEmpty.signal();  <span class="hljs-comment">// ç²¾ç¡®å”¤é†’æ¶ˆè´¹è€…</span>
} <span class="hljs-keyword">finally</span> {
    lock.unlock();
}

<span class="hljs-comment">// æ¶ˆè´¹è€…</span>
lock.lock();
<span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">while</span> (count == <span class="hljs-number">0</span>) {
        notEmpty.await();  <span class="hljs-comment">// ç­‰å¾…notEmptyæ¡ä»¶</span>
    }
    <span class="hljs-comment">// æ¶ˆè´¹</span>
    notFull.signal();  <span class="hljs-comment">// ç²¾ç¡®å”¤é†’ç”Ÿäº§è€…</span>
} <span class="hljs-keyword">finally</span> {
    lock.unlock();
}
</code></pre>
<hr/>
<h2 data-id="heading-61">å…­ã€æœ€ä½³å®è·µä¸æ€»ç»“</h2>
<h3 data-id="heading-62">6.1 å¦‚ä½•é€‰æ‹©åˆé€‚çš„åŒæ­¥å·¥å…·?</h3>
<p><strong>å†³ç­–æ ‘:</strong></p>
<pre><code class="hljs language-arduino" lang="arduino">éœ€è¦äº’æ–¥è®¿é—®?
â”œâ”€ æ˜¯ â†’ éœ€è¦é«˜çº§ç‰¹æ€§(ä¸­æ–­/è¶…æ—¶/å…¬å¹³/å¤šæ¡ä»¶)?
â”‚   â”œâ”€ æ˜¯ â†’ ReentrantLock
â”‚   â””â”€ å¦ â†’ <span class="hljs-keyword">synchronized</span>
â””â”€ å¦ â†’ éœ€è¦ä»€ä¹ˆæ ·çš„åè°ƒ?
    â”œâ”€ é™åˆ¶å¹¶å‘æ•° â†’ Semaphore
    â”œâ”€ ç­‰å¾…å¤šä¸ªçº¿ç¨‹å®Œæˆ â†’ CountDownLatch
    â”œâ”€ å¤šçº¿ç¨‹äº’ç›¸ç­‰å¾…åŒæ­¥ç‚¹ â†’ CyclicBarrier
    â”œâ”€ è¯»å¤šå†™å°‘ â†’ ReadWriteLock
    â””â”€ ç”Ÿäº§è€…-æ¶ˆè´¹è€… â†’ BlockingQueue
</code></pre>
<h3 data-id="heading-63">6.2 AQSè‡ªå®šä¹‰åŒæ­¥å™¨çš„å®ç°æ­¥éª¤</h3>
<p><strong>æ­¥éª¤1: ç»§æ‰¿AQS</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyLock</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Sync</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractQueuedSynchronizer</span> {
        <span class="hljs-comment">// å®ç°åŒæ­¥é€»è¾‘</span>
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Sync</span> <span class="hljs-variable">sync</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Sync</span>();
}
</code></pre>
<p><strong>æ­¥éª¤2: å®šä¹‰stateè¯­ä¹‰</strong></p>
<ul>
<li>ç‹¬å é”: state=0æœªé”,state=1å·²é”</li>
<li>å…±äº«é”: state=å‰©ä½™è®¸å¯æ•°</li>
<li>ä¿¡å·é‡: state=å¯ç”¨èµ„æºæ•°</li>
</ul>
<p><strong>æ­¥éª¤3: å®ç°tryAcquire/tryRelease(ç‹¬å æ¨¡å¼)</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryAcquire</span><span class="hljs-params">(<span class="hljs-type">int</span> arg)</span> {
    <span class="hljs-keyword">if</span> (compareAndSetState(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>)) {
        setExclusiveOwnerThread(Thread.currentThread());
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
}

<span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryRelease</span><span class="hljs-params">(<span class="hljs-type">int</span> arg)</span> {
    setExclusiveOwnerThread(<span class="hljs-literal">null</span>);
    setState(<span class="hljs-number">0</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}
</code></pre>
<p><strong>æ­¥éª¤4: å®ç°tryAcquireShared/tryReleaseShared(å…±äº«æ¨¡å¼)</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">protected</span> <span class="hljs-type">int</span> <span class="hljs-title function_">tryAcquireShared</span><span class="hljs-params">(<span class="hljs-type">int</span> arg)</span> {
    <span class="hljs-keyword">for</span> (;;) {
        <span class="hljs-type">int</span> <span class="hljs-variable">available</span> <span class="hljs-operator">=</span> getState();
        <span class="hljs-type">int</span> <span class="hljs-variable">remaining</span> <span class="hljs-operator">=</span> available - arg;
        <span class="hljs-keyword">if</span> (remaining &lt; <span class="hljs-number">0</span> || compareAndSetState(available, remaining))
            <span class="hljs-keyword">return</span> remaining;
    }
}

<span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryReleaseShared</span><span class="hljs-params">(<span class="hljs-type">int</span> arg)</span> {
    <span class="hljs-keyword">for</span> (;;) {
        <span class="hljs-type">int</span> <span class="hljs-variable">current</span> <span class="hljs-operator">=</span> getState();
        <span class="hljs-type">int</span> <span class="hljs-variable">next</span> <span class="hljs-operator">=</span> current + arg;
        <span class="hljs-keyword">if</span> (compareAndSetState(current, next))
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
}
</code></pre>
<p><strong>æ­¥éª¤5: æä¾›Lock API</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">lock</span><span class="hljs-params">()</span> {
    sync.acquire(<span class="hljs-number">1</span>);
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">unlock</span><span class="hljs-params">()</span> {
    sync.release(<span class="hljs-number">1</span>);
}

<span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryLock</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">return</span> sync.tryAcquire(<span class="hljs-number">1</span>);
}
</code></pre>
<h3 data-id="heading-64">6.3 åŒæ­¥å·¥å…·ä½¿ç”¨åŸåˆ™</h3>
<ol>
<li>
<p><strong>ä¼˜å…ˆä½¿ç”¨é«˜çº§å·¥å…·</strong></p>
<ul>
<li>ä½¿ç”¨<code>java.util.concurrent</code>åŒ…æä¾›çš„å·¥å…·</li>
<li>é¿å…ç›´æ¥ä½¿ç”¨<code>wait/notify</code></li>
</ul>
</li>
<li>
<p><strong>é”çš„ç²’åº¦è¦åˆé€‚</strong></p>
<ul>
<li>é”ç²’åº¦å¤ªç²— â†’ å¹¶å‘åº¦ä½</li>
<li>é”ç²’åº¦å¤ªç»† â†’ å¤æ‚åº¦é«˜,å®¹æ˜“æ­»é”</li>
</ul>
</li>
<li>
<p><strong>é¿å…é”åµŒå¥—</strong></p>
<ul>
<li>å®¹æ˜“æ­»é”</li>
<li>éš¾ä»¥ç»´æŠ¤</li>
</ul>
</li>
<li>
<p><strong>åŠæ—¶é‡Šæ”¾é”</strong></p>
<ul>
<li>é”ä¿æŠ¤çš„ä¸´ç•ŒåŒºå°½é‡å°</li>
<li><code>unlock()</code>å¿…é¡»åœ¨<code>finally</code>å—</li>
</ul>
</li>
<li>
<p><strong>ä¼˜å…ˆä½¿ç”¨éé˜»å¡ç®—æ³•</strong></p>
<ul>
<li>CASã€åŸå­ç±»ã€æ— é”æ•°æ®ç»“æ„</li>
<li>æ€§èƒ½æ›´å¥½,æ— æ­»é”é£é™©</li>
</ul>
</li>
</ol>
<h3 data-id="heading-65">6.4 æ€§èƒ½ä¼˜åŒ–å»ºè®®</h3>
<ol>
<li>
<p><strong>å‡å°‘é”ç«äº‰</strong></p>
<ul>
<li>ç¼©å°ä¸´ç•ŒåŒº</li>
<li>é”åˆ†æ®µ(ConcurrentHashMap)</li>
<li>è¯»å†™åˆ†ç¦»(ReadWriteLock)</li>
</ul>
</li>
<li>
<p><strong>é€‰æ‹©åˆé€‚çš„é”ç±»å‹</strong></p>
<ul>
<li>ä½ç«äº‰ â†’ synchronized</li>
<li>é«˜ç«äº‰ â†’ ReentrantLock(éå…¬å¹³)</li>
<li>è¯»å¤šå†™å°‘ â†’ ReadWriteLock</li>
</ul>
</li>
<li>
<p><strong>é¿å…é”çš„ä¸å¿…è¦è·å–</strong></p>
<ul>
<li>åŒé‡æ£€æŸ¥é”å®š(DCL)</li>
<li><code>tryLock()</code>å°è¯•è·å–</li>
</ul>
</li>
<li>
<p><strong>ä½¿ç”¨å¹¶å‘å®¹å™¨</strong></p>
<ul>
<li><code>ConcurrentHashMap</code> ä»£æ›¿ <code>Hashtable</code></li>
<li><code>CopyOnWriteArrayList</code> ä»£æ›¿ <code>Vector</code></li>
</ul>
</li>
</ol>
<h3 data-id="heading-66">6.5 å¸¸è§é™·é˜±æ€»ç»“</h3>













































<table><thead><tr><th>é™·é˜±</th><th>åæœ</th><th>é¿å…æ–¹æ³•</th></tr></thead><tbody><tr><td>unlock()ä¸åœ¨finally</td><td>é”æ³„æ¼,æ­»é”</td><td>å¿…é¡»åœ¨finallyä¸­unlock</td></tr><tr><td>CountDownLatchæœªcountDown</td><td>çº¿ç¨‹æ°¸ä¹…é˜»å¡</td><td>finallyä¿è¯countDown</td></tr><tr><td>Semaphoreè·å–åæœªé‡Šæ”¾</td><td>èµ„æºæ³„æ¼</td><td>finallyä¿è¯release</td></tr><tr><td>é”é‡å…¥æœªæ­£ç¡®è®¡æ•°</td><td>é”æå‰é‡Šæ”¾</td><td>ä½¿ç”¨ReentrantLock</td></tr><tr><td>è¯»é”å‡çº§ä¸ºå†™é”</td><td>æ­»é”</td><td>å…ˆé‡Šæ”¾è¯»é”å†è·å–å†™é”</td></tr><tr><td>synchronized(this)</td><td>é”ç²—ç²’åº¦</td><td>ä½¿ç”¨ç§æœ‰é”å¯¹è±¡</td></tr><tr><td>wait()ä¸åœ¨whileå¾ªç¯</td><td>è™šå‡å”¤é†’</td><td>ç”¨whileæ£€æŸ¥æ¡ä»¶</td></tr></tbody></table>
<h3 data-id="heading-67">6.6 æ€»ç»“</h3>
<p>AQSæ˜¯Javaå¹¶å‘ç¼–ç¨‹çš„åŸºçŸ³,æ·±å…¥ç†è§£AQSèƒ½å¤Ÿ:</p>
<ol>
<li><strong>æŒæ¡JUCæ ¸å¿ƒå·¥å…·åŸç†</strong>: ReentrantLockã€Semaphoreã€CountDownLatchç­‰</li>
<li><strong>æå‡å¹¶å‘ç¼–ç¨‹èƒ½åŠ›</strong>: é€‰æ‹©åˆé€‚çš„åŒæ­¥å·¥å…·,é¿å…å¸¸è§é™·é˜±</li>
<li><strong>ä¼˜åŒ–ç³»ç»Ÿæ€§èƒ½</strong>: æ ¹æ®åœºæ™¯é€‰æ‹©æœ€ä¼˜æ–¹æ¡ˆ,å¦‚è¯»å†™é”ã€åˆ†æ®µé”ç­‰</li>
<li><strong>è‡ªå®šä¹‰åŒæ­¥å™¨</strong>: åœ¨ç‰¹æ®Šåœºæ™¯ä¸‹å®ç°å®šåˆ¶åŒ–åŒæ­¥é€»è¾‘</li>
</ol>
<p><strong>æ ¸å¿ƒè¦ç‚¹å›é¡¾:</strong></p>
<ul>
<li><strong>AQSæ ¸å¿ƒ</strong>: state(åŒæ­¥çŠ¶æ€) + CLHé˜Ÿåˆ—(ç­‰å¾…çº¿ç¨‹) + CAS(åŸå­æ“ä½œ)</li>
<li><strong>ç‹¬å vså…±äº«</strong>: ç‹¬å ä¸€æ¬¡å”¤é†’ä¸€ä¸ª,å…±äº«ä¼ æ’­å”¤é†’</li>
<li><strong>Condition</strong>: ä¸€ä¸ªLockå¤šä¸ªæ¡ä»¶,ç²¾ç¡®å”¤é†’</li>
<li><strong>ReentrantLock vs synchronized</strong>: åŠŸèƒ½ä¸°å¯Œ vs ç®€æ´æ˜“ç”¨</li>
<li><strong>è¯»å†™é”</strong>: è¯»å¤šå†™å°‘åœºæ™¯æ€§èƒ½æå‡æ˜¾è‘—</li>
<li><strong>æœ€ä½³å®è·µ</strong>: é”ç²’åº¦é€‚ä¸­ã€åŠæ—¶é‡Šæ”¾ã€é¿å…åµŒå¥—ã€ä¼˜å…ˆéé˜»å¡</li>
</ul>
<p>æŒæ¡AQS,ä½ å·²ç»è¿ˆå…¥Javaå¹¶å‘ç¼–ç¨‹é«˜çº§é˜¶æ®µ!</p>
<pre><code class="hljs"/></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue 3 ä¸­å¼€å‘é«˜é˜¶ç»„ä»¶ï¼ˆHOCï¼‰ä¸ Renderless ç»„ä»¶]]></title>    <link>https://juejin.cn/post/7585446706327093257</link>    <guid>https://juejin.cn/post/7585446706327093257</guid>    <pubDate>2025-12-20T06:23:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585446706327093257" data-draft-id="7585706951583219721" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue 3 ä¸­å¼€å‘é«˜é˜¶ç»„ä»¶ï¼ˆHOCï¼‰ä¸ Renderless ç»„ä»¶"/> <meta itemprop="keywords" content="å‰ç«¯"/> <meta itemprop="datePublished" content="2025-12-20T06:23:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ç”¨æˆ·5427784851540"/> <meta itemprop="url" content="https://juejin.cn/user/224762173330942"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="æ˜é‡‘"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue 3 ä¸­å¼€å‘é«˜é˜¶ç»„ä»¶ï¼ˆHOCï¼‰ä¸ Renderless ç»„ä»¶
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/224762173330942/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ç”¨æˆ·5427784851540
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T06:23:44.000Z" title="Sat Dec 20 2025 06:23:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    é˜…è¯»4åˆ†é’Ÿ
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>åœ¨ Vue 3 çš„ç»„åˆå¼ APIï¼ˆComposition APIï¼‰æ—¶ä»£ï¼Œè™½ç„¶å®˜æ–¹æ›´æ¨èä½¿ç”¨ Composablesï¼ˆç»„åˆå‡½æ•°ï¼‰ æ¥å¤ç”¨é€»è¾‘ï¼Œä½†ç†è§£ é«˜é˜¶ç»„ä»¶ï¼ˆHigher-Order Component, HOCï¼‰ å’Œ Renderless ç»„ä»¶ï¼ˆæ— æ¸²æŸ“ç»„ä»¶ï¼‰ ä»ç„¶å…·æœ‰é‡è¦ä»·å€¼ã€‚å®ƒä»¬ä¸ä»…æ˜¯ React ç”Ÿæ€ä¸­çš„ç»å…¸æ¨¡å¼ï¼Œåœ¨ Vue ä¸­ä¹Ÿæœ‰å…¶é€‚ç”¨åœºæ™¯ï¼Œå°¤å…¶åœ¨éœ€è¦å°è£…å¤æ‚çŠ¶æ€é€»è¾‘å¹¶ä»¥ç»„ä»¶å½¢å¼æš´éœ²æ—¶ã€‚</p>
<p>æœ¬æ–‡å°†æ·±å…¥è®²è§£å¦‚ä½•åœ¨ Vue 3 ä¸­å®ç°è¿™ä¸¤ç§æ¨¡å¼ï¼Œå¹¶é€šè¿‡å®é™…æ¡ˆä¾‹å±•ç¤ºå…¶ç”¨æ³•ã€ä¼˜åŠ¿ä¸æ³¨æ„äº‹é¡¹ã€‚</p>
<hr/>
<p>Â </p>
<h2 data-id="heading-0">ä¸€ã€æ¦‚å¿µæ¾„æ¸…</h2>
<h3 data-id="heading-1">1. é«˜é˜¶ç»„ä»¶ï¼ˆHOCï¼‰</h3>
<blockquote>
<p>æ¥æ”¶ä¸€ä¸ªç»„ä»¶ä½œä¸ºå‚æ•°ï¼Œè¿”å›ä¸€ä¸ªæ–°ç»„ä»¶çš„å‡½æ•°ã€‚</p>
</blockquote>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">withLoading</span> = (<span class="hljs-params">WrappedComponent</span>) =&gt; {
  <span class="hljs-keyword">return</span> {
    <span class="hljs-title function_">setup</span>(<span class="hljs-params">props, { slots }</span>) {
      <span class="hljs-comment">// æ·»åŠ  loading é€»è¾‘</span>
      <span class="hljs-keyword">const</span> loading = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">true</span>);
      
      <span class="hljs-title function_">onMounted</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> loading.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>, <span class="hljs-number">1000</span>);
      });
      
      <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">h</span>(<span class="hljs-title class_">WrappedComponent</span>, {
        ...props,
        <span class="hljs-attr">loading</span>: loading.<span class="hljs-property">value</span>
      });
    }
  };
};
</code></pre>
<h3 data-id="heading-2">2. Renderless ç»„ä»¶ï¼ˆæ— æ¸²æŸ“ç»„ä»¶ï¼‰</h3>
<blockquote>
<p>ä¸åŒ…å«ä»»ä½• DOM ç»“æ„ï¼Œåªæä¾›é€»è¾‘å’Œæ•°æ®ï¼Œé€šè¿‡ä½œç”¨åŸŸæ’æ§½ï¼ˆscoped slotï¼‰å°†çŠ¶æ€ä¼ é€’ç»™å­ç»„ä»¶ã€‚</p>
</blockquote>
<pre><code class="hljs language-ini" lang="ini">&lt;template&gt;
  &lt;slot 
    :<span class="hljs-attr">loading</span>=<span class="hljs-string">"loading"</span> 
    :<span class="hljs-attr">startLoading</span>=<span class="hljs-string">"startLoading"</span>
  /&gt;
&lt;/template&gt;


&lt;script setup&gt;
import { ref } from 'vue'<span class="hljs-comment">;</span>


const <span class="hljs-attr">loading</span> = ref(<span class="hljs-literal">false</span>)<span class="hljs-comment">;</span>


const <span class="hljs-attr">startLoading</span> = () =&gt; {
  <span class="hljs-attr">loading.value</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
  setTimeout(() =&gt; <span class="hljs-attr">loading.value</span> = <span class="hljs-literal">false</span>, <span class="hljs-number">1000</span>)<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>
&lt;/script&gt;
</code></pre>
<blockquote>
<p>âœ… å…³é”®åŒºåˆ«ï¼šHOCï¼šåŒ…è£…ç°æœ‰ç»„ä»¶ï¼Œæ³¨å…¥ propsï¼ŒRenderlessï¼šè‡ªèº«ä¸æ¸²æŸ“ UIï¼Œé€šè¿‡Â <code>&lt;slot&gt;</code>Â æš´éœ²é€»è¾‘</p>
</blockquote>
<hr/>
<p>Â </p>
<h2 data-id="heading-3">äºŒã€å®æˆ˜ï¼šå¼€å‘ä¸€ä¸ªé€šç”¨æ•°æ®åŠ è½½ HOC</h2>
<h3 data-id="heading-4">åœºæ™¯</h3>
<p>ä¸ºä»»æ„ç»„ä»¶æ·»åŠ è‡ªåŠ¨æ•°æ®åŠ è½½èƒ½åŠ›ï¼Œæ— éœ€é‡å¤ç¼–å†™ <code>loading</code>ã€<code>error</code>ã€<code>data</code> çŠ¶æ€ç®¡ç†ã€‚</p>
<h3 data-id="heading-5">æ­¥éª¤ 1ï¼šå®šä¹‰ HOC å‡½æ•°</h3>
<pre><code class="hljs language-ini" lang="ini">// hoc/withAsyncData.js
import { defineComponent, ref, onMounted, h } from 'vue'<span class="hljs-comment">;</span>


/**
 * é«˜é˜¶ç»„ä»¶ï¼šä¸ºç»„ä»¶æ³¨å…¥å¼‚æ­¥æ•°æ®åŠ è½½èƒ½åŠ›
 * @param {Function} fetchFn - æ•°æ®è·å–å‡½æ•° (è¿”å› Promise)
 * @param {Object} options - é…ç½®é¡¹
 * @returns {Component} æ–°ç»„ä»¶
 */
export function withAsyncData(fetchFn, <span class="hljs-attr">options</span> = {}) {
  const {
    <span class="hljs-attr">loadingProp</span> = <span class="hljs-string">'loading'</span>,
    <span class="hljs-attr">dataProp</span> = <span class="hljs-string">'data'</span>,
    <span class="hljs-attr">errorProp</span> = <span class="hljs-string">'error'</span>,
    <span class="hljs-attr">autoLoad</span> = <span class="hljs-literal">true</span>
  } = options<span class="hljs-comment">;</span>


  return (WrappedComponent) =&gt; {
    return defineComponent({
      name: `WithAsyncData(${WrappedComponent.name || 'Anonymous'})`,
      
      props: WrappedComponent.props ? { ...WrappedComponent.props } : {},
      
      setup(props, { attrs, slots }) {
        const <span class="hljs-attr">loading</span> = ref(<span class="hljs-literal">false</span>)<span class="hljs-comment">;</span>
        const <span class="hljs-attr">data</span> = ref(null)<span class="hljs-comment">;</span>
        const <span class="hljs-attr">error</span> = ref(null)<span class="hljs-comment">;</span>


        const <span class="hljs-attr">loadData</span> = async () =&gt; {
          <span class="hljs-attr">loading.value</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
          <span class="hljs-attr">error.value</span> = null<span class="hljs-comment">;</span>
          
          try {
            const <span class="hljs-attr">result</span> = await fetchFn()<span class="hljs-comment">;</span>
            <span class="hljs-attr">data.value</span> = result<span class="hljs-comment">;</span>
          } catch (err) {
            <span class="hljs-attr">error.value</span> = err<span class="hljs-comment">;</span>
          } finally {
            <span class="hljs-attr">loading.value</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
          }
        }<span class="hljs-comment">;</span>


        if (autoLoad) {
          onMounted(loadData)<span class="hljs-comment">;</span>
        }


        // å°†çŠ¶æ€ä½œä¸º props æ³¨å…¥ WrappedComponent
        const <span class="hljs-attr">injectedProps</span> = {
          <span class="hljs-section">[loadingProp]</span>: loading.value,
          <span class="hljs-section">[dataProp]</span>: data.value,
          <span class="hljs-section">[errorProp]</span>: error.value,
          // æä¾›é‡æ–°åŠ è½½æ–¹æ³•
          reload: loadData
        }<span class="hljs-comment">;</span>


        return () =&gt; h(
          WrappedComponent,
          {
            ...props,
            ...attrs,
            ...injectedProps
          },
          slots
        )<span class="hljs-comment">;</span>
      }
    })<span class="hljs-comment">;</span>
  }<span class="hljs-comment">;</span>
}
</code></pre>
<h3 data-id="heading-6">æ­¥éª¤ 2ï¼šä½¿ç”¨ HOC</h3>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- UserList.vue --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"loading"</span>&gt;</span>åŠ è½½ä¸­...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-else-if</span>=<span class="hljs-string">"error"</span>&gt;</span>é”™è¯¯: {{ error.message }}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">ul</span> <span class="hljs-attr">v-else</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">"user in data"</span> <span class="hljs-attr">:key</span>=<span class="hljs-string">"user.id"</span>&gt;</span>{{ user.name }}<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"reload"</span>&gt;</span>åˆ·æ–°<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>


<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { defineComponent } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;


<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineComponent</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">'UserList'</span>,
  <span class="hljs-attr">props</span>: [<span class="hljs-string">'loading'</span>, <span class="hljs-string">'data'</span>, <span class="hljs-string">'error'</span>, <span class="hljs-string">'reload'</span>] <span class="hljs-comment">// æ¥æ”¶ HOC æ³¨å…¥çš„ props</span>
});
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>Â </p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- App.vue --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">UserListWithAsyncData</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>


<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> <span class="hljs-title class_">UserList</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./UserList.vue'</span>;
<span class="hljs-keyword">import</span> { withAsyncData } <span class="hljs-keyword">from</span> <span class="hljs-string">'./hoc/withAsyncData'</span>;


<span class="hljs-comment">// åˆ›å»ºå¢å¼ºåçš„ç»„ä»¶</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">UserListWithAsyncData</span> = <span class="hljs-title function_">withAsyncData</span>(
  <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/users'</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> res.<span class="hljs-title function_">json</span>()),
  { <span class="hljs-attr">autoLoad</span>: <span class="hljs-literal">true</span> }
)(<span class="hljs-title class_">UserList</span>);


<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">components</span>: {
    <span class="hljs-title class_">UserListWithAsyncData</span>
  }
};
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<blockquote>
<p>âœ… ä¼˜åŠ¿ï¼š
é€»è¾‘å¤ç”¨ï¼šä»»ä½•åˆ—è¡¨ç»„ä»¶éƒ½å¯å¿«é€Ÿè·å¾—åŠ è½½èƒ½åŠ›ï¼›
ç±»å‹å®‰å…¨ï¼šé€šè¿‡ props æ˜ç¡®æ¥å£ï¼›
å¯é…ç½®ï¼šæ”¯æŒè‡ªå®šä¹‰ prop åç§°</p>
</blockquote>
<hr/>
<p>Â </p>
<h2 data-id="heading-7">ä¸‰ã€å®æˆ˜ï¼šå¼€å‘ Renderless ç»„ä»¶</h2>
<h3 data-id="heading-8">åœºæ™¯</h3>
<p>åˆ›å»ºä¸€ä¸ªé€šç”¨çš„è®¡æ•°å™¨é€»è¾‘ç»„ä»¶ï¼Œä¸å…³å¿ƒ UI å¦‚ä½•å±•ç¤ºã€‚</p>
<h3 data-id="heading-9">æ­¥éª¤ 1ï¼šåˆ›å»º Renderless ç»„ä»¶</h3>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- renderless/CounterProvider.vue --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- æ— ä»»ä½• DOMï¼Œåªæš´éœ²é€»è¾‘ --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">slot</span> 
    <span class="hljs-attr">:count</span>=<span class="hljs-string">"count"</span>
    <span class="hljs-attr">:increment</span>=<span class="hljs-string">"increment"</span>
    <span class="hljs-attr">:decrement</span>=<span class="hljs-string">"decrement"</span>
    <span class="hljs-attr">:reset</span>=<span class="hljs-string">"reset"</span>
    <span class="hljs-attr">:isEven</span>=<span class="hljs-string">"isEven"</span>
  /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>


<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { ref, computed } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;


<span class="hljs-keyword">const</span> props = <span class="hljs-title function_">defineProps</span>({
  <span class="hljs-attr">initialCount</span>: {
    <span class="hljs-attr">type</span>: <span class="hljs-title class_">Number</span>,
    <span class="hljs-attr">default</span>: <span class="hljs-number">0</span>
  },
  <span class="hljs-attr">min</span>: <span class="hljs-title class_">Number</span>,
  <span class="hljs-attr">max</span>: <span class="hljs-title class_">Number</span>
});


<span class="hljs-keyword">const</span> count = <span class="hljs-title function_">ref</span>(props.<span class="hljs-property">initialCount</span>);


<span class="hljs-keyword">const</span> <span class="hljs-title function_">increment</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">if</span> (props.<span class="hljs-property">max</span> === <span class="hljs-literal">undefined</span> || count.<span class="hljs-property">value</span> &lt; props.<span class="hljs-property">max</span>) {
    count.<span class="hljs-property">value</span>++;
  }
};


<span class="hljs-keyword">const</span> <span class="hljs-title function_">decrement</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">if</span> (props.<span class="hljs-property">min</span> === <span class="hljs-literal">undefined</span> || count.<span class="hljs-property">value</span> &gt; props.<span class="hljs-property">min</span>) {
    count.<span class="hljs-property">value</span>--;
  }
};


<span class="hljs-keyword">const</span> <span class="hljs-title function_">reset</span> = (<span class="hljs-params"/>) =&gt; {
  count.<span class="hljs-property">value</span> = props.<span class="hljs-property">initialCount</span>;
};


<span class="hljs-keyword">const</span> isEven = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> count.<span class="hljs-property">value</span> % <span class="hljs-number">2</span> === <span class="hljs-number">0</span>);
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<h3 data-id="heading-10">æ­¥éª¤ 2ï¼šä½¿ç”¨ Renderless ç»„ä»¶</h3>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- App.vue --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- æ–¹å¼1ï¼šåŸºç¡€ç”¨æ³• --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">CounterProvider</span> <span class="hljs-attr">v-slot</span>=<span class="hljs-string">"{ count, increment, decrement }"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>å½“å‰è®¡æ•°: {{ count }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"increment"</span>&gt;</span>+1<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"decrement"</span>&gt;</span>-1<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">CounterProvider</span>&gt;</span>


    <span class="hljs-comment">&lt;!-- æ–¹å¼2ï¼šé«˜çº§ç”¨æ³•ï¼ˆå¸¦é™åˆ¶ï¼‰ --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">CounterProvider</span> 
      <span class="hljs-attr">:initial-count</span>=<span class="hljs-string">"10"</span> 
      <span class="hljs-attr">:min</span>=<span class="hljs-string">"0"</span> 
      <span class="hljs-attr">:max</span>=<span class="hljs-string">"20"</span>
      <span class="hljs-attr">v-slot</span>=<span class="hljs-string">"{ count, increment, decrement, isEven }"</span>
    &gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">:class</span>=<span class="hljs-string">"{ even: isEven }"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>å—é™è®¡æ•°å™¨ (0~20)<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>{{ count }} {{ isEven ? '(å¶æ•°)' : '(å¥‡æ•°)' }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"increment"</span> <span class="hljs-attr">:disabled</span>=<span class="hljs-string">"count &gt;= 20"</span>&gt;</span>+1<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"decrement"</span> <span class="hljs-attr">:disabled</span>=<span class="hljs-string">"count &lt;= 0"</span>&gt;</span>-1<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">CounterProvider</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>


<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> <span class="hljs-title class_">CounterProvider</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./renderless/CounterProvider.vue'</span>;
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>


<span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
<span class="hljs-selector-class">.even</span> { <span class="hljs-attribute">color</span>: green; }
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre>
<blockquote>
<p>âœ… ä¼˜åŠ¿ï¼š
å®Œå…¨è§£è€¦é€»è¾‘ä¸ UIï¼›
çµæ´»ç»„åˆï¼šåŒä¸€ä¸ªé€»è¾‘å¯é€‚é…å¤šç§ UIï¼›
ç±»å‹æ¨å¯¼ï¼šIDE å¯è‡ªåŠ¨æç¤º slot å±æ€§ï¼›</p>
</blockquote>
<hr/>
<p>Â </p>
<h2 data-id="heading-11">å››ã€HOC vs Renderless vs Composables å¯¹æ¯”</h2>









































<table><thead><tr><th>ç‰¹æ€§</th><th>HOC</th><th>Renderless ç»„ä»¶</th><th>Composables</th></tr></thead><tbody><tr><td>å¤ç”¨æ–¹å¼</td><td>åŒ…è£…ç»„ä»¶</td><td>ä½œç”¨åŸŸæ’æ§½</td><td>å‡½æ•°è°ƒç”¨</td></tr><tr><td>æ¨¡æ¿ä¾µå…¥æ€§</td><td>ä½ï¼ˆä½¿ç”¨è€…æ— æ„ŸçŸ¥ï¼‰</td><td>ä¸­ï¼ˆéœ€å†™Â ï¼‰</td><td>æ— </td></tr><tr><td>é€»è¾‘å¤æ‚åº¦</td><td>é€‚åˆç®€å• props æ³¨å…¥</td><td>é€‚åˆçŠ¶æ€+æ–¹æ³•æš´éœ²</td><td>æœ€çµæ´»</td></tr><tr><td>TypeScript æ”¯æŒ</td><td>éœ€æ‰‹åŠ¨å¤„ç†ç±»å‹</td><td>è‡ªåŠ¨æ¨å¯¼ slot ç±»å‹</td><td>æœ€ä½³</td></tr><tr><td>Vue 3 æ¨èåº¦</td><td>â­â­</td><td>â­â­â­</td><td>â­â­â­â­â­</td></tr></tbody></table>
<p>ğŸ“Œ å»ºè®®ï¼š</p>
<blockquote>
<p>Vue 3 ä¸­ä¼˜å…ˆä½¿ç”¨ Composablesï¼Œä»…åœ¨ä»¥ä¸‹æƒ…å†µè€ƒè™‘ HOC/Renderlessï¼š
éœ€è¦ä»¥ç»„ä»¶å½¢å¼åˆ†å‘ï¼ˆå¦‚ UI åº“ï¼‰ï¼›
ä¸ç¬¬ä¸‰æ–¹ç»„ä»¶é›†æˆï¼ˆæ— æ³•ä¿®æ”¹å…¶å†…éƒ¨é€»è¾‘ï¼‰ï¼›
å›¢é˜Ÿä¹ æƒ¯ç±» React çš„å¼€å‘æ¨¡å¼ï¼›</p>
</blockquote>
<hr/>
<p>Â </p>
<h2 data-id="heading-12">äº”ã€Composables æ›¿ä»£æ–¹æ¡ˆï¼ˆæ¨èï¼‰</h2>
<p>ä¸Šè¿°åŠŸèƒ½ç”¨ Composables å®ç°æ›´ç®€æ´ï¼š</p>
<pre><code class="hljs language-ini" lang="ini">// composables/useCounter.js
import { ref, computed, watch } from 'vue'<span class="hljs-comment">;</span>


export function useCounter(<span class="hljs-attr">initialValue</span> = <span class="hljs-number">0</span>, { min, max } = {}) {
  const <span class="hljs-attr">count</span> = ref(initialValue)<span class="hljs-comment">;</span>
  
  const <span class="hljs-attr">increment</span> = () =&gt; {
    if (<span class="hljs-attr">max</span> === undefined || count.value &lt; max) count.value++<span class="hljs-comment">;</span>
  }<span class="hljs-comment">;</span>
  
  const <span class="hljs-attr">decrement</span> = () =&gt; {
    if (<span class="hljs-attr">min</span> === undefined || count.value &gt; min) count.value--<span class="hljs-comment">;</span>
  }<span class="hljs-comment">;</span>
  
  const <span class="hljs-attr">reset</span> = () =&gt; count.value = initialValue<span class="hljs-comment">;</span>
  
  const <span class="hljs-attr">isEven</span> = computed(() =&gt; count.value % <span class="hljs-number">2</span> === <span class="hljs-number">0</span>)<span class="hljs-comment">;</span>
  
  // ç›‘å¬ initialValue å˜åŒ–
  watch(() =&gt; initialValue, (newVal) =&gt; {
    <span class="hljs-attr">count.value</span> = newVal<span class="hljs-comment">;</span>
  })<span class="hljs-comment">;</span>
  
  return {
    count,
    increment,
    decrement,
    reset,
    isEven
  }<span class="hljs-comment">;</span>
}
</code></pre>
<p>Â </p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- ä½¿ç”¨ Composables --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { useCounter } <span class="hljs-keyword">from</span> <span class="hljs-string">'./composables/useCounter'</span>;


<span class="hljs-keyword">const</span> { count, increment, decrement } = <span class="hljs-title function_">useCounter</span>(<span class="hljs-number">0</span>, { <span class="hljs-attr">min</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">max</span>: <span class="hljs-number">10</span> });
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>


<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>{{ count }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"increment"</span>&gt;</span>+1<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"decrement"</span>&gt;</span>-1<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
</code></pre>
<p>Â </p>
<hr/>
<h2 data-id="heading-13">å…­ã€æœ€ä½³å®è·µä¸æ³¨æ„äº‹é¡¹</h2>
<h3 data-id="heading-14">1. HOC æ³¨æ„äº‹é¡¹</h3>
<ul>
<li>é€ä¼  Props/Attrs/Slotsï¼šç¡®ä¿åŒ…è£…ç»„ä»¶çš„è¡Œä¸ºä¸åŸç»„ä»¶ä¸€è‡´</li>
<li>å‘½åè§„èŒƒï¼šä½¿ç”¨Â <code>WithXxx</code>Â å‰ç¼€ï¼ˆå¦‚Â <code>WithLoading</code>ï¼‰</li>
<li>é¿å…åµŒå¥—è¿‡æ·±ï¼šHOC åµŒå¥—ä¼šå¯¼è‡´è°ƒè¯•å›°éš¾</li>
</ul>
<h3 data-id="heading-15">2. Renderless ç»„ä»¶æ³¨æ„äº‹é¡¹</h3>
<ul>
<li>æ˜ç¡® Slot æ¥å£ï¼šä½¿ç”¨ TypeScript å®šä¹‰ slot props ç±»å‹</li>
<li>é¿å…è¿‡åº¦è®¾è®¡ï¼šç®€å•é€»è¾‘ç›´æ¥ç”¨ Composables</li>
<li>æ–‡æ¡£è¯´æ˜ï¼šæ¸…æ™°æ ‡æ³¨æš´éœ²çš„ slot å±æ€§</li>
</ul>
<h3 data-id="heading-16">3. æ€§èƒ½ä¼˜åŒ–</h3>
<ul>
<li>ç¼“å­˜è®¡ç®—å±æ€§ï¼šä½¿ç”¨Â <code>computed</code>Â è€Œéæ–¹æ³•</li>
<li>æŒ‰éœ€å“åº”ï¼šåªæš´éœ²å¿…è¦çš„çŠ¶æ€</li>
<li>æ¸…ç†å‰¯ä½œç”¨ï¼šåœ¨Â <code>onUnmounted</code>Â ä¸­æ¸…ç†å®šæ—¶å™¨ç­‰</li>
</ul>
<hr/>
<p>Â </p>
<h2 data-id="heading-17">ç»“è¯­</h2>
<p>è™½ç„¶ Vue 3 çš„ Composition API ä½¿å¾— Composables æˆä¸ºé€»è¾‘å¤ç”¨çš„é¦–é€‰ï¼Œä½†ç†è§£ HOC å’Œ Renderless ç»„ä»¶ä»æœ‰å…¶ä»·å€¼ï¼š</p>
<ul>
<li>HOCÂ é€‚åˆå¯¹ç°æœ‰ç»„ä»¶è¿›è¡Œâ€œè£…é¥°â€ï¼Œå°¤å…¶åœ¨æ— æ³•ä¿®æ”¹ç»„ä»¶æºç æ—¶</li>
<li>Renderless ç»„ä»¶Â åœ¨æ„å»º UI åº“æ—¶éå¸¸æœ‰ç”¨ï¼Œå…è®¸ç”¨æˆ·å®Œå…¨æ§åˆ¶æ¸²æŸ“</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[è§£æAndroidå†…å­˜åˆ†æçš„æŒ‡æ ‡]]></title>    <link>https://juejin.cn/post/7585446706326781961</link>    <guid>https://juejin.cn/post/7585446706326781961</guid>    <pubDate>2025-12-20T05:10:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585446706326781961" data-draft-id="7585463258690273289" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="è§£æAndroidå†…å­˜åˆ†æçš„æŒ‡æ ‡"/> <meta itemprop="keywords" content="Android,APP"/> <meta itemprop="datePublished" content="2025-12-20T05:10:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="æ„¤æ€’çš„ä»£ç "/> <meta itemprop="url" content="https://juejin.cn/user/4125023358426190"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="æ˜é‡‘"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            è§£æAndroidå†…å­˜åˆ†æçš„æŒ‡æ ‡
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4125023358426190/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    æ„¤æ€’çš„ä»£ç 
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T05:10:11.000Z" title="Sat Dec 20 2025 05:10:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    é˜…è¯»6åˆ†é’Ÿ
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>åœ¨ Android ç³»ç»Ÿå¼€å‘ä¸­ï¼Œä¸ºäº†ç²¾å‡†è¡¡é‡è¿›ç¨‹çš„å†…å­˜æ¶ˆè€—ï¼Œé€šå¸¸ä¼šä½¿ç”¨ <strong>VSSã€RSSã€PSSã€USS</strong> è¿™å››ä¸ªæŒ‡æ ‡ã€‚ç”±äºå†…å­˜å…±äº«æœºåˆ¶çš„å­˜åœ¨ï¼Œå•ä¸€çš„â€œå†…å­˜å ç”¨â€æ•°å­—å¾€å¾€æ— æ³•çœŸå®åæ˜ è¿›ç¨‹å¯¹ç³»ç»Ÿçš„å½±å“ï¼Œå› æ­¤è¿™å››ä¸ªæŒ‡æ ‡æä¾›äº†ä¸åŒç»´åº¦çš„è§‚å¯Ÿè§†è§’ã€‚</p>
<h2 data-id="heading-0">0x00 æ ¸å¿ƒå«ä¹‰è¯¦è§£</h2>
<p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸€ä¸ªç®€å•çš„æ¨¡å‹æ¥ç†è§£ï¼šå‡è®¾è¿›ç¨‹ A ä½¿ç”¨äº† <strong>50MB ç§æœ‰å†…å­˜</strong>ï¼Œå¹¶ä¸è¿›ç¨‹ B å…±äº«ä¸€ä¸ª <strong>20MB çš„åŠ¨æ€åº“</strong>ã€‚</p>
<h3 data-id="heading-1"><strong>VSS (Virtual Set Size) - è™šæ‹Ÿè€—ç”¨å†…å­˜</strong></h3>
<ul>
<li><strong>å«ä¹‰</strong>ï¼šè¿›ç¨‹èƒ½è®¿é—®åˆ°çš„å…¨éƒ¨è™šæ‹Ÿåœ°å€ç©ºé—´å¤§å°ã€‚</li>
<li><strong>åŒ…å«</strong>ï¼šå·²åˆ†é…ä½†æœªå®é™…ä½¿ç”¨çš„å†…å­˜ã€æ˜ å°„åˆ°ç£ç›˜çš„æ–‡ä»¶ã€å…±äº«åº“å ç”¨çš„å…¨éƒ¨ç©ºé—´ç­‰ã€‚</li>
<li><strong>ç‰¹ç‚¹</strong>ï¼šæ•°å€¼æœ€å¤§ã€‚å®ƒä¸ä»£è¡¨çœŸå®çš„ç‰©ç†å†…å­˜æ¶ˆè€—ï¼Œå¯¹äº<strong>æ€§èƒ½åˆ†ææ„ä¹‰è¾ƒå°</strong>ã€‚</li>
</ul>
<h3 data-id="heading-2"><strong>RSS (Resident Set Size) - å®é™…ä½¿ç”¨ç‰©ç†å†…å­˜</strong></h3>
<ul>
<li><strong>å«ä¹‰</strong>ï¼šè¿›ç¨‹å½“å‰å®é™…å ç”¨çš„ç‰©ç†å†…å­˜ï¼ˆRAMï¼‰ã€‚</li>
<li><strong>åŒ…å«</strong>ï¼šè¿›ç¨‹çš„ç§æœ‰å†…å­˜ + <strong>å…±äº«åº“çš„å…¨éƒ¨å¤§å°</strong>ã€‚</li>
<li><strong>ç¼ºç‚¹</strong>ï¼šå­˜åœ¨â€œé‡å¤è®¡ç®—â€ã€‚å¦‚æœæœ‰ 10 ä¸ªè¿›ç¨‹éƒ½ç”¨äº†é‚£ä¸ª 20MB çš„å…±äº«åº“ï¼Œæ¯ä¸ªè¿›ç¨‹çš„ RSS éƒ½ä¼šè®¡å…¥è¿™ 20MBã€‚å°†æ‰€æœ‰è¿›ç¨‹çš„ RSS ç›¸åŠ ï¼Œä¼šè¿œå¤§äºç³»ç»Ÿæ€»å†…å­˜ã€‚</li>
</ul>
<h3 data-id="heading-3"><strong>PSS (Proportional Set Size) - æ¯”ä¾‹åˆ†é…å†…å­˜</strong></h3>
<ul>
<li><strong>å«ä¹‰</strong>ï¼šå°†å…±äº«åº“çš„å¤§å°æŒ‰å…±äº«è¿›ç¨‹çš„æ•°é‡<strong>å‡æ‘Š</strong>ã€‚</li>
<li><strong>è®¡ç®—</strong>ï¼šç§æœ‰å†…å­˜ + (å…±äº«åº“å¤§å° / å…±äº«è¯¥åº“çš„è¿›ç¨‹æ•°)ã€‚</li>
<li><strong>ä¼˜ç‚¹</strong>ï¼š<strong>æœ€å®¢è§‚çš„æŒ‡æ ‡</strong>ã€‚å¦‚æœå°†ç³»ç»Ÿä¸­æ‰€æœ‰è¿›ç¨‹çš„ PSS ç›¸åŠ ï¼Œç»“æœå‡ ä¹ç­‰äºç³»ç»Ÿå®é™…æ¶ˆè€—çš„æ€»å†…å­˜ã€‚å®ƒæ˜¯è¡¡é‡è¿›ç¨‹ç³»ç»Ÿçº§è´Ÿæ‹…çš„æœ€ä½³æ ‡å‡†ã€‚</li>
</ul>
<h3 data-id="heading-4"><strong>USS (Unique Set Size) - è¿›ç¨‹ç‹¬å å†…å­˜ï¼ˆæœ€å¸¸ç”¨ï¼‰</strong></h3>
<ul>
<li><strong>å«ä¹‰</strong>ï¼šè¿›ç¨‹å®Œå…¨ç‹¬å çš„ç‰©ç†å†…å­˜ã€‚</li>
<li><strong>åŒ…å«</strong>ï¼šåªæœ‰è¯¥è¿›ç¨‹èƒ½è®¿é—®åˆ°çš„ RAM åŒºåŸŸã€‚</li>
<li><strong>ä¼˜ç‚¹</strong>ï¼š<strong>åˆ†æå†…å­˜æ³„éœ²çš„æ ¸å¿ƒæŒ‡æ ‡</strong>ã€‚å®ƒè¡¨ç¤ºå¦‚æœæ€æ­»è¯¥è¿›ç¨‹ï¼Œç³»ç»Ÿèƒ½ç«‹åˆ»å›æ”¶çš„å†…å­˜é‡ã€‚</li>
</ul>
<h2 data-id="heading-5">0x01 æ ¸å¿ƒåˆ¤æ–­æ ‡å‡†ï¼šä¸ºä»€ä¹ˆ USS æ˜¯â€œé‡‘æ ‡å‡†â€ï¼Ÿ</h2>
<p>åœ¨åˆ†ææ³„æ¼æ—¶ï¼Œæˆ‘ä»¬é€šå¸¸éµå¾ªè¿™ä¸ªä¼˜å…ˆçº§ï¼š<strong>USS &gt; PSS &gt; RSS &gt; VSS</strong>ã€‚</p>
<ul>
<li><strong>VSS å’Œ RSS çš„å±€é™æ€§</strong>ï¼šç”±äº RSS åŒ…å«äº†å…±äº«åº“å†…å­˜ï¼Œå½“ç³»ç»Ÿå…¶ä»–è¿›ç¨‹åŠ è½½æˆ–å¸è½½å…±äº«åº“æ—¶ï¼Œä½ çš„è¿›ç¨‹ RSS å¯èƒ½ä¼šæ³¢åŠ¨ï¼Œè¿™ä¼šäº§ç”Ÿâ€œä¼ªæ³„æ¼â€çš„å¹²æ‰°ã€‚</li>
<li><strong>PSS çš„å‚è€ƒæ„ä¹‰</strong>ï¼šPSS èƒ½å¤Ÿåæ˜ ä½ çš„è¿›ç¨‹å¯¹ç³»ç»Ÿæ€»å†…å­˜çš„çœŸå®è´¡çŒ®ã€‚å¦‚æœ PSS æŒç»­ä¸Šæ¶¨ï¼Œè¯´æ˜ä½ çš„åº”ç”¨æ­£åœ¨æ‹–æ…¢ç³»ç»Ÿã€‚</li>
<li><strong>USS çš„å†³å®šæ€§ä½œç”¨</strong>ï¼š<strong>USS åªåŒ…å«è¿›ç¨‹å®Œå…¨ç‹¬å çš„å†…å­˜ã€‚</strong> å†…å­˜æ³„æ¼æœ¬è´¨ä¸Šæ˜¯è¿›ç¨‹å†…éƒ¨çš„å¯¹è±¡æ— æ³•è¢«å›æ”¶ï¼Œå› æ­¤<strong>å†…å­˜æ³„æ¼ä¸€å®šä¼šç›´æ¥åæ˜ åœ¨ USS çš„ä¸Šæ¶¨ä¸Š</strong>ã€‚</li>
</ul>
<h2 data-id="heading-6">0x02 åˆ†æå†…å­˜æ³„æ¼åˆ†æçš„æµç¨‹</h2>
<h3 data-id="heading-7">ç¬¬ä¸€æ­¥ï¼šå»ºç«‹åŸºå‡†çº¿ (Baseline)</h3>
<p>åœ¨åº”ç”¨å¯åŠ¨å¹¶è¿›å…¥ä¸»ç•Œé¢ç¨³å®šåï¼Œè®°å½•å½“å‰çš„å†…å­˜çŠ¶æ€ã€‚</p>
<pre><code class="hljs language-shell" lang="shell">adb shell dumpsys meminfo &lt;your_package_name&gt;
</code></pre>
<p>é‡ç‚¹è®°å½•ï¼š<code>TOTAL Pss</code> å’Œ <code>Private Dirty</code>ï¼ˆåè€…éå¸¸æ¥è¿‘ USSï¼‰ã€‚</p>
<h3 data-id="heading-8">ç¬¬äºŒæ­¥ï¼šæ‰§è¡Œé‡å¤æ€§æ“ä½œ (Stress Test)</h3>
<p>å†…å­˜æ³„æ¼é€šå¸¸å‘ç”Ÿåœ¨ Activity é”€æ¯æˆ–é•¿ç”Ÿå‘½å‘¨æœŸå¯¹è±¡ï¼ˆå¦‚ Singletonã€Threadï¼‰ä¸­ã€‚æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š</p>
<ol>
<li>è¿›å…¥ä¸€ä¸ªæ€€ç–‘æœ‰æ³„æ¼çš„é¡µé¢ï¼Œå†é€€å‡ºã€‚</li>
<li>é‡å¤ä¸Šè¿°è¿‡ç¨‹ <strong>10 æ¬¡ä»¥ä¸Š</strong>ã€‚</li>
<li>æ‰‹åŠ¨è§¦å‘å‡ æ¬¡ GCï¼ˆåœ¨ Android Studio Profiler ä¸­ç‚¹å‡»å°åƒåœ¾æ¡¶å›¾æ ‡ï¼Œæˆ–é€šè¿‡ <code>adb shell cmd activity gc</code>ï¼‰ã€‚</li>
</ol>
<h3 data-id="heading-9">ç¬¬ä¸‰æ­¥ï¼šå¯¹æ¯”è§‚æµ‹</h3>
<p>å†æ¬¡è¿è¡Œ <code>adb shell dumpsys meminfo &lt;your_package_name&gt;</code>ï¼Œè§‚å¯Ÿæ•°æ®å˜åŒ–ï¼š</p>
<ul>
<li><strong>å¦‚æœ USS (Private Dirty) é˜¶æ¢¯å¼ä¸Šå‡</strong>ï¼šè¯´æ˜å­˜åœ¨<strong>ç§æœ‰å†…å­˜æ³„æ¼</strong>ï¼ˆé€šå¸¸æ˜¯ Java å¯¹è±¡ã€Bitmap æˆ– Native å †å†…å­˜ï¼‰ã€‚</li>
<li><strong>å¦‚æœ PSS ä¸Šå‡ä½† USS ç¨³å®š</strong>ï¼šè¿™ç§æƒ…å†µæå°‘è§ï¼Œå¯èƒ½æ„å‘³ç€ä½ è°ƒç”¨çš„ç³»ç»Ÿå…±äº«èµ„æºï¼ˆå¦‚æŸäº›ç³»ç»ŸæœåŠ¡çš„ç¼“å­˜ï¼‰åœ¨å¢åŠ ï¼Œè€Œä¸æ˜¯ä½ è¿›ç¨‹å†…éƒ¨çš„æ³„æ¼ã€‚</li>
<li><strong>å¦‚æœ PSS/USS å‡ä¸å¢åŠ ï¼Œä½† VSS ç–¯ç‹‚å¢é•¿</strong>ï¼šè¯´æ˜ä½ åœ¨ä¸æ–­åœ°ç”³è¯·è™šæ‹Ÿåœ°å€ç©ºé—´ï¼ˆä¾‹å¦‚åˆ›å»ºäº†å¤§é‡çº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹å ç”¨ 1MB è™šæ‹Ÿæ ˆç©ºé—´ï¼Œä½†å®é™…è¿˜æ²¡å¼€å§‹ä½¿ç”¨ç‰©ç†å†…å­˜ï¼‰ã€‚</li>
</ul>
<pre><code class="hljs language-shell" lang="shell">Applications Memory Usage (in Kilobytes):
Uptime: 102275 Realtime: 102275

** MEMINFO in pid 3069 [com.android.launcher3] **
                   Pss  Private  Private     Swap      Rss     Heap     Heap     Heap
                 Total    Dirty    Clean    Dirty    Total     Size    Alloc     Free
                ------   ------   ------   ------   ------   ------   ------   ------
  Native Heap    11128    11060        0        0    13796    19812    13511     2600
  Dalvik Heap     2316     2188        0        0     6620    27729     3153    24576
 Dalvik Other     2587     2264        0        0     3528                           
        Stack      736      736        0        0      740                           
       Ashmem        2        0        0        0        8                           
      Gfx dev     1244     1244        0        0     1244                           
    Other dev       36        0       36        0      284                           
     .so mmap     6076      212      128        0    54512                           
    .jar mmap     1922        0        0        0    26648                           
    .apk mmap    14824        0    13900        0    38756                           
    .ttf mmap       54        0        0        0      228                           
    .dex mmap      213        4        0        0      504                           
    .oat mmap       55        0        0        0     2044                           
    .art mmap     7794     7404        4        0    20040                           
   Other mmap     1179        4       32        0     4984                           
   EGL mtrack    40288    40288        0        0    40288                           
    GL mtrack     6104     6104        0        0     6104                           
      Unknown      466      448        0        0     1100                           
        TOTAL    97024    71956    14100        0    97024    47541    16664    27176
 
 App Summary
                       Pss(KB)                        Rss(KB)
                        ------                         ------
           Java Heap:     9596                          26660
         Native Heap:    11060                          13796
                Code:    14256                         123424
               Stack:      736                            740
            Graphics:    47636                          47636
       Private Other:     2772
              System:    10968
             Unknown:                                    9172
 
           TOTAL PSS:    97024            TOTAL RSS:   221428      TOTAL SWAP (KB):        0
 
...

</code></pre>
<h2 data-id="heading-10">0x03 é’ˆå¯¹ä¸åŒç±»å‹çš„æ³„æ¼åˆ†æ</h2>
<h3 data-id="heading-11">A. Java å±‚æ³„æ¼ (Activity/Fragment)</h3>
<ul>
<li>
<p><strong>ç°è±¡</strong>ï¼š<code>TOTAL Pss</code> å’Œ <code>Java Heap</code> æŒç»­å¢é•¿ã€‚</p>
</li>
<li>
<p><strong>åˆ†æ</strong>ï¼šæŸ¥çœ‹ <code>dumpsys meminfo</code> æœ€åçš„ <code>Objects</code> éƒ¨åˆ†ã€‚</p>
<ul>
<li><code>Views</code> å’Œ <code>Activities</code> çš„æ•°é‡ã€‚å¦‚æœä½ é€€å‡ºäº†é¡µé¢ï¼Œ<code>Activities</code> æ•°é‡æ²¡æœ‰å‡å°‘ï¼Œé‚£å°±æ˜¯å…¸å‹çš„ Activity æ³„æ¼ã€‚</li>
</ul>
</li>
</ul>
<h3 data-id="heading-12">B. Native å±‚æ³„æ¼ (C++/JNI)</h3>
<ul>
<li><strong>ç°è±¡</strong>ï¼š<code>Native Heap</code> æŒ‡æ ‡æŒç»­å¢é•¿ï¼Œä¸” <code>USS</code> åŒæ­¥ä¸Šæ¶¨ã€‚</li>
<li><strong>åˆ†æ</strong>ï¼šå¦‚æœä½ åœ¨ JNI ä¸­ä½¿ç”¨äº† <code>malloc</code> æˆ– <code>new</code> ä½†æ²¡æœ‰ <code>free</code>ï¼Œè¿™éƒ¨åˆ†å†…å­˜ä¼šä½“ç°åœ¨ <code>Native Heap</code> ä¸­ã€‚</li>
</ul>
<h3 data-id="heading-13">C. å…±äº«å†…å­˜/æ–‡ä»¶æè¿°ç¬¦æ³„æ¼ (SharedMemory/FD)</h3>
<p>å¦‚æœ SharedMemory æ²¡æœ‰è¢«æ­£ç¡®å…³é—­ï¼š</p>
<ul>
<li>
<p><strong>ç°è±¡</strong>ï¼š<code>USS</code> å¯èƒ½ä¸ä¼šæ˜¾è‘—å¢é•¿ï¼ˆå¦‚æœä½ å·²ç» <code>munmap</code> äº†ï¼‰ï¼Œä½†<strong>æ–‡ä»¶æè¿°ç¬¦ (FD)</strong> ä¼šè€—å°½ã€‚</p>
</li>
<li>
<p><strong>æ£€æŸ¥æ–¹å¼</strong>ï¼š</p>
<pre><code class="hljs language-bash" lang="bash">adb shell <span class="hljs-built_in">ls</span> -l /proc/&lt;pid&gt;/fd | <span class="hljs-built_in">wc</span> -l
</code></pre>
<p>ä¾‹å¦‚æ£€æŸ¥<code>3069</code>å·è¿›ç¨‹(<code>com.android.launcher3</code>)</p>
<pre><code class="hljs language-shell" lang="shell">adb root
adb shell ls -l /proc/3069/fd | wc -l
<span class="hljs-meta prompt_">
# </span><span class="bash">è¾“å‡º</span>
<span class="hljs-meta prompt_"># </span><span class="bash">82</span>
</code></pre>
<p>é‡å¤æ“ä½œåï¼Œå¦‚æœ FD æ•°é‡ä¸æ–­å¢åŠ ï¼Œè¯´æ˜ä½ çš„ <code>SharedMemory</code> æˆ– <code>ParcelFileDescriptor</code> æ²¡æœ‰æ‰§è¡Œ <code>close()</code>ã€‚</p>
</li>
</ul>
<h2 data-id="heading-14">0x04 è‡ªåŠ¨åŒ–æ£€æµ‹å·¥å…·æ¨è</h2>
<p>è™½ç„¶æ‰‹åŠ¨åˆ†æ <code>dumpsys</code> å¾ˆæœ‰å¸®åŠ©ï¼Œä½†åœ¨å®é™…å¼€å‘ä¸­ï¼Œå»ºè®®é…åˆä»¥ä¸‹å·¥å…·ï¼š</p>





















<table><thead><tr><th><strong>å·¥å…·</strong></th><th><strong>ä¼˜åŠ¿</strong></th></tr></thead><tbody><tr><td><strong>LeakCanary</strong></td><td>è‡ªåŠ¨åŒ–ç¨‹åº¦æœ€é«˜ï¼Œç›´æ¥åœ¨æ‰‹æœºç«¯å¼¹çª—å‘ŠçŸ¥ Java æ³„æ¼å¼•ç”¨é“¾ã€‚</td></tr><tr><td><strong>Android Studio Profiler</strong></td><td>å¯è§†åŒ–å®æ—¶æŸ¥çœ‹ PSS åˆ†å¸ƒï¼Œæ”¯æŒ Capture Heap Dump åˆ†æå †å¿«ç…§ã€‚</td></tr><tr><td><strong>Perfetto / Systrace</strong></td><td>é€‚åˆåˆ†æ Native å±‚å’Œç³»ç»Ÿçº§çš„å†…å­˜åˆ†é…è¡Œä¸ºã€‚</td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[ä½¿ç”¨ Node.js Elasticsearch å®¢æˆ·ç«¯ç´¢å¼•å¤§å‹ CSV æ–‡ä»¶]]></title>    <link>https://juejin.cn/post/7585390679398957062</link>    <guid>https://juejin.cn/post/7585390679398957062</guid>    <pubDate>2025-12-20T04:10:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585390679398957062" data-draft-id="7585412203978162219" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="ä½¿ç”¨ Node.js Elasticsearch å®¢æˆ·ç«¯ç´¢å¼•å¤§å‹ CSV æ–‡ä»¶"/> <meta itemprop="keywords" content="Elasticsearch"/> <meta itemprop="datePublished" content="2025-12-20T04:10:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Elasticsearch"/> <meta itemprop="url" content="https://juejin.cn/user/2612095360441448"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="æ˜é‡‘"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ä½¿ç”¨ Node.js Elasticsearch å®¢æˆ·ç«¯ç´¢å¼•å¤§å‹ CSV æ–‡ä»¶
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2612095360441448/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Elasticsearch
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T04:10:45.000Z" title="Sat Dec 20 2025 04:10:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    é˜…è¯»2åˆ†é’Ÿ
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>ä½œè€…ï¼šæ¥è‡ª ElasticÂ <a href="https://link.juejin.cn?target=https%3A%2F%2Fdiscuss.elastic.co%2Fu%2Fjoshmock" title="https://discuss.elastic.co/u/joshmock" target="_blank" ref="nofollow noopener noreferrer">joshmock</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a63db05724934ee494f54a3ab790d1a9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766808645&amp;x-signature=3Ak4aLkmgmzCh6BMEheIyUvXemY%3D" alt="" loading="lazy"/></p>
<p>ä½¿ç”¨ <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Fapi%2Fdoc%2Felasticsearch%2Foperation%2Foperation-bulk" title="https://www.elastic.co/docs/api/doc/elasticsearch/operation/operation-bulk" target="_blank" ref="nofollow noopener noreferrer">bulk API</a> å¯ä»¥è½»æ¾åœ°å°†å¤§é‡æ–‡æ¡£ç´¢å¼•åˆ° Elasticsearchï¼šå°†ä½ çš„æ•°æ®è®°å½•è½¬æ¢ä¸º JSON æ–‡æ¡£ï¼Œå¹¶æ’å…¥æŒ‡ç¤ºå®ƒä»¬åº”è¯¥æ·»åŠ åˆ°å“ªä¸ªç´¢å¼•çš„æŒ‡ä»¤ï¼Œç„¶åå°†è¿™ä¸ªå¤§çš„æ¢è¡Œåˆ†éš” JSON blob ä½œä¸ºè¯·æ±‚ä½“ï¼Œé€šè¿‡å•ä¸ª HTTP è¯·æ±‚å‘é€åˆ° Elasticsearch é›†ç¾¤ã€‚æˆ–è€…ï¼Œä½¿ç”¨ Node.js å®¢æˆ·ç«¯çš„ bulk å‡½æ•°ã€‚</p>
<p>æ›´å¤šé˜…è¯»ï¼šE<a href="https://link.juejin.cn?target=https%3A%2F%2Felasticstack.blog.csdn.net%2Farticle%2Fdetails%2F124318170" title="https://elasticstack.blog.csdn.net/article/details/124318170" target="_blank" ref="nofollow noopener noreferrer">lasticsearchï¼šä½¿ç”¨æœ€æ–°çš„ Nodejs client 8.x æ¥åˆ›å»ºç´¢å¼•å¹¶æœç´¢</a></p>
<p>ä¸‹é¢æ¼”ç¤ºå¦‚ä½•è¯»å– CSV æ–‡ä»¶ï¼Œå°†å…¶è¡Œè½¬æ¢ä¸º JSON å¯¹è±¡ï¼Œå¹¶è¿›è¡Œç´¢å¼•ï¼š</p>
<pre><code class="hljs language-php" lang="php">`

<span class="hljs-number">1</span>.  import { Client } <span class="hljs-keyword">from</span> <span class="hljs-string">'@elastic/elasticsearch'</span>
<span class="hljs-number">2</span>.  import { parse } <span class="hljs-keyword">from</span> <span class="hljs-string">"csv-parse/sync"</span>
<span class="hljs-number">3</span>.  import { readFileSync } <span class="hljs-keyword">from</span> <span class="hljs-string">'node:fs'</span>

<span class="hljs-number">5</span>.  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">csv</span> = <span class="hljs-title function_ invoke__">parse</span>(<span class="hljs-title function_ invoke__">readFileSync</span>(<span class="hljs-string">'data.csv'</span>, <span class="hljs-string">'utf8'</span>), { <span class="hljs-attr">columns</span>: <span class="hljs-literal">true</span> })
<span class="hljs-number">6</span>.  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">operations</span> = csv.<span class="hljs-title function_ invoke__">flatMap</span>(row =&gt; [
<span class="hljs-number">7</span>.    { <span class="hljs-attr">index</span>: { <span class="hljs-attr">_index</span>: <span class="hljs-string">"my_index"</span> } },
<span class="hljs-number">8</span>.    row
<span class="hljs-number">9</span>.  ])

<span class="hljs-number">11</span>.  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">client</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Client</span>({ node: <span class="hljs-string">'http://localhost:9200'</span> })
<span class="hljs-number">12</span>.  await client.<span class="hljs-title function_ invoke__">bulk</span>({ operations })

`AIå†™ä»£ç ![](https:<span class="hljs-comment">//csdnimg.cn/release/blogv2/dist/pc/img/runCode/icon-arrowwhite.png)</span>
</code></pre>
<p>ä½†æ˜¯ï¼Œå¦‚æœä½ éœ€è¦å‘é€çš„æ•°æ®é‡è¶…è¿‡ Elasticsearch å•æ¬¡è¯·æ±‚èƒ½æ¥æ”¶çš„å¤§å°ï¼Œæˆ–è€…ä½ çš„ CSV æ–‡ä»¶å¤ªå¤§ï¼Œæ— æ³•ä¸€æ¬¡æ€§å…¨éƒ¨åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œè¯¥æ€ä¹ˆåŠï¼Ÿè¿™æ—¶å¯ä»¥ä½¿ç”¨ <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Freference%2Felasticsearch%2Fclients%2Fjavascript%2Fclient-helpers%23bulk-helper" title="https://www.elastic.co/docs/reference/elasticsearch/clients/javascript/client-helpers#bulk-helper" target="_blank" ref="nofollow noopener noreferrer">bulk helper</a>ï¼</p>
<p>è™½ç„¶ bulk API æœ¬èº«å·²ç»å¾ˆç®€å•ï¼Œä½†å¯¹äºæ›´å¤æ‚çš„åœºæ™¯ï¼Œhelper æä¾›äº†å¯¹æµå¼è¾“å…¥çš„æ”¯æŒï¼Œå¯ä»¥å°†å¤§å‹æ•°æ®é›†æ‹†åˆ†ä¸ºå¤šä¸ªè¯·æ±‚ç­‰ã€‚</p>
<p>ä¾‹å¦‚ï¼Œå¦‚æœä½ çš„ Elasticsearch æœåŠ¡å™¨åªèƒ½æ¥æ”¶å°äº 10MB çš„ HTTP è¯·æ±‚ï¼Œä½ å¯ä»¥é€šè¿‡è®¾ç½® flushBytes å€¼æ¥æŒ‡ç¤º bulk helper æ‹†åˆ†æ•°æ®ã€‚æ¯å½“è¯·æ±‚å³å°†è¶…è¿‡è®¾ç½®å€¼æ—¶ï¼Œå°±ä¼šå‘é€ä¸€æ¬¡ bulk è¯·æ±‚ï¼š</p>
<pre><code class="hljs language-php" lang="php">`

<span class="hljs-number">1</span>.  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">csv</span> = <span class="hljs-title function_ invoke__">parse</span>(<span class="hljs-title function_ invoke__">readFileSync</span>(<span class="hljs-string">'data.csv'</span>, <span class="hljs-string">'utf8'</span>), { <span class="hljs-attr">columns</span>: <span class="hljs-literal">true</span> })
<span class="hljs-number">2</span>.  await client.helpers.<span class="hljs-title function_ invoke__">bulk</span>({
<span class="hljs-number">3</span>.    <span class="hljs-attr">datasource</span>: csv,
<span class="hljs-number">4</span>.    <span class="hljs-title function_ invoke__">onDocument</span>(doc) {
<span class="hljs-number">5</span>.      <span class="hljs-keyword">return</span> { <span class="hljs-attr">index</span>: { <span class="hljs-attr">_index</span>: <span class="hljs-string">"my_index"</span> } }
<span class="hljs-number">6</span>.    },
<span class="hljs-number">7</span>.    // send a bulk request <span class="hljs-keyword">for</span> every <span class="hljs-number">9.5</span>MB
<span class="hljs-number">8</span>.    <span class="hljs-attr">flushBytes</span>: <span class="hljs-number">9500000</span>
<span class="hljs-number">9</span>.  })

`AIå†™ä»£ç 
</code></pre>
<p>æˆ–è€…ï¼Œå¦‚æœä½ çš„ CSV æ–‡ä»¶å¤ªå¤§æ— æ³•ä¸€æ¬¡æ€§åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œhelper å¯ä»¥å°†<a href="https://link.juejin.cn?target=https%3A%2F%2Fnodejs.org%2Fapi%2Fstream.html" title="https://nodejs.org/api/stream.html" target="_blank" ref="nofollow noopener noreferrer">æµ</a>ä½œä¸ºæ•°æ®æºï¼Œè€Œä¸æ˜¯ä½¿ç”¨æ•°ç»„ï¼š</p>
<pre><code class="hljs language-php" lang="php">`

<span class="hljs-number">1</span>.  import { createReadStream } <span class="hljs-keyword">from</span> <span class="hljs-string">'node:fs'</span>
<span class="hljs-number">2</span>.  import { parse } <span class="hljs-keyword">from</span> <span class="hljs-string">'csv-parse'</span>

<span class="hljs-number">4</span>.  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">parser</span> = <span class="hljs-title function_ invoke__">parse</span>({ <span class="hljs-attr">columns</span>: <span class="hljs-literal">true</span> })
<span class="hljs-number">5</span>.  await client.helpers.<span class="hljs-title function_ invoke__">bulk</span>({
<span class="hljs-number">6</span>.    <span class="hljs-attr">datasource</span>: <span class="hljs-title function_ invoke__">createReadStream</span>(<span class="hljs-string">'data.csv'</span>).<span class="hljs-title function_ invoke__">pipe</span>(parser),
<span class="hljs-number">7</span>.    <span class="hljs-title function_ invoke__">onDocument</span>(doc) {
<span class="hljs-number">8</span>.      <span class="hljs-keyword">return</span> { <span class="hljs-attr">index</span>: { <span class="hljs-attr">_index</span>: <span class="hljs-string">"my_index"</span> } }
<span class="hljs-number">9</span>.    }
<span class="hljs-number">10</span>.  })

`AIå†™ä»£ç ![](https:<span class="hljs-comment">//csdnimg.cn/release/blogv2/dist/pc/img/runCode/icon-arrowwhite.png)</span>
</code></pre>
<p>è¿™ä¼šå°† CSV æ–‡ä»¶ä¸­çš„è¡Œç¼“å†²åˆ°å†…å­˜ä¸­ï¼Œè§£æä¸º JSON å¯¹è±¡ï¼Œå¹¶è®© helper å°†ç»“æœåˆ·æ–°ä¸ºä¸€ä¸ªæˆ–å¤šä¸ª HTTP è¯·æ±‚å‘é€å‡ºå»ã€‚è¿™ä¸ªè§£å†³æ–¹æ¡ˆä¸ä»…èŠ‚çœå†…å­˜ï¼Œè€Œä¸”é˜…è¯»èµ·æ¥ä¹Ÿå’Œå°†æ•´ä¸ªæ–‡ä»¶åŠ è½½åˆ°å†…å­˜ä¸­çš„æ–¹æ³•ä¸€æ ·ç®€å•ï¼</p>
<p>åŸæ–‡ï¼š<a href="https://link.juejin.cn?target=https%3A%2F%2Fdiscuss.elastic.co%2Ft%2Fdec-9th-2025-en-use-the-node-js-elasticsearch-client-to-index-large-csv-files%2F382901" title="https://discuss.elastic.co/t/dec-9th-2025-en-use-the-node-js-elasticsearch-client-to-index-large-csv-files/382901" target="_blank" ref="nofollow noopener noreferrer">discuss.elastic.co/t/dec-9th-2â€¦</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[é¢è¯•å®˜é—®Redisä¸»ä»å»¶è¿Ÿå¯¼è‡´è„æ•°æ®è¯»æ€ä¹ˆè§£å†³ï¼Ÿ]]></title>    <link>https://juejin.cn/post/7585686247269187593</link>    <guid>https://juejin.cn/post/7585686247269187593</guid>    <pubDate>2025-12-20T05:02:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585686247269187593" data-draft-id="7585382553290342436" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="é¢è¯•å®˜é—®Redisä¸»ä»å»¶è¿Ÿå¯¼è‡´è„æ•°æ®è¯»æ€ä¹ˆè§£å†³ï¼Ÿ"/> <meta itemprop="keywords" content="åç«¯,Redis,é¢è¯•"/> <meta itemprop="datePublished" content="2025-12-20T05:02:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="æƒ³ç”¨offeræ‰“ç‰Œ"/> <meta itemprop="url" content="https://juejin.cn/user/578781641968972"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="æ˜é‡‘"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            é¢è¯•å®˜é—®Redisä¸»ä»å»¶è¿Ÿå¯¼è‡´è„æ•°æ®è¯»æ€ä¹ˆè§£å†³ï¼Ÿ
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/578781641968972/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    æƒ³ç”¨offeræ‰“ç‰Œ
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T05:02:26.000Z" title="Sat Dec 20 2025 05:02:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    é˜…è¯»4åˆ†é’Ÿ
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.8;font-weight:400;font-size:16px;word-spacing:2px;letter-spacing:2px;overflow-x:hidden;color:#3e3e3e;background-image:linear-gradient(90deg,rgba(50,0,0,.05) 3%,transparent 0),linear-gradient(1turn,rgba(50,0,0,.05) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:30px;margin-bottom:5px}.markdown-body h2{padding-bottom:12px;font-size:24px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:1.2em;border-bottom:2px solid #ef7060;word-spacing:0!important;letter-spacing:0!important;font-size:inherit;line-height:inherit;display:block;font-weight:400;background:#ef7060;color:#fff;padding:10px;border-top-right-radius:3px;border-top-left-radius:3px;margin-right:3px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="monokai">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#272822;color:#ddd}.hljs-keyword,.hljs-literal,.hljs-name,.hljs-selector-tag,.hljs-strong,.hljs-tag{color:#f92672}.hljs-code{color:#66d9ef}.hljs-class .hljs-title{color:#fff}.hljs-attribute,.hljs-link,.hljs-regexp,.hljs-symbol{color:#bf79db}.hljs-addition,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-emphasis,.hljs-section,.hljs-selector-attr,.hljs-selector-pseudo,.hljs-string,.hljs-subst,.hljs-template-tag,.hljs-template-variable,.hljs-title,.hljs-type,.hljs-variable{color:#a6e22e}.hljs-comment,.hljs-deletion,.hljs-meta,.hljs-quote{color:#75715e}.hljs-doctag,.hljs-keyword,.hljs-literal,.hljs-section,.hljs-selector-id,.hljs-selector-tag,.hljs-title,.hljs-type{font-weight:700}</style><h2 data-id="heading-0">å¼•è¨€</h2>
<blockquote>
<p>å¤§å®¶å¥½å•Šï¼Œä»Šå¤©ç»™å¤§å®¶å¸¦æ¥ä¸€ä¸ªé¢è¯•å¸¸é—®é¢˜ï¼šredisä¸»ä»æ•°æ®åŒæ­¥å»¶è¿Ÿï¼Œæ‹…å¿ƒä»èŠ‚ç‚¹è¯»åˆ°è„æ•°æ®ï¼Œæ€ä¹ˆåŠï¼ŸRedis ä¸»ä»å¤åˆ¶é»˜è®¤æ˜¯<strong>å¼‚æ­¥</strong>çš„ï¼Œè¿™æ„å‘³ç€åœ¨ CAP ç†è®ºä¸­ï¼ŒRedis é»˜è®¤ä¿è¯çš„æ˜¯ <strong>APï¼ˆå¯ç”¨æ€§ + åˆ†åŒºå®¹é”™æ€§ï¼‰</strong> ï¼Œè€Œä¸æ˜¯ CPï¼ˆå¼ºä¸€è‡´æ€§ï¼‰ã€‚å› æ­¤ï¼Œä¸»ä»å»¶è¿Ÿå¯¼è‡´çš„â€œè¯»è„æ•°æ®â€ï¼ˆStale Dataï¼‰åœ¨ç†è®ºä¸Šæ— æ³•å®Œå…¨é¿å…ï¼Œåªèƒ½é€šè¿‡ä¸šåŠ¡ç­–ç•¥æˆ–æŠ€æœ¯æ‰‹æ®µæ¥ç¼“è§£</p>
</blockquote>
<h2 data-id="heading-1">Redisä¸»ä»æ¶æ„</h2>
<p>è¦å…ˆå¼„æ˜ç™½ä¸ºä»€ä¹ˆredisä¸»ä»æ¶æ„ä¼šå‡ºç°è„æ•°æ®è¯»ï¼Œæˆ‘ä»¬æ‰èƒ½æƒ³å‡ºå¯¹åº”çš„ç¼“è§£ä¹‹ç­–ã€‚</p>
<p>ä¸¾ä¸€ä¸ªæ —å­ï¼šredisä¸€ä¸»äºŒä»æ¶æ„ï¼Œä¸»èŠ‚ç‚¹è´Ÿè´£å˜æ›´æ•°æ®ï¼Œç„¶ååŒæ­¥ç»™ä»èŠ‚ç‚¹ã€‚ä»èŠ‚ç‚¹è´Ÿè´£è¯»æ•°æ®ã€‚å› æ­¤ä»è¿™æ ·çš„æ¶æ„æ¥è¯´ï¼Œå‡ºç°è„æ•°æ®è¯»ä»ç†è®ºä¸Šè¯´æ˜¯ä¸å¯é¿å…çš„ï¼Œå› ä¸ºä¸»ä»èŠ‚ç‚¹æ•°æ®åŒæ­¥æ— æ³•åšåˆ°é›¶å»¶è¿Ÿã€‚</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/beb441caceb446e68c34d30d982c22cd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oOz55Sob2ZmZXLmiZPniYw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766811746&amp;x-signature=8RnX77VUEIrXkT2iFv%2B%2FZcIR00Q%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-2">Redisä¸»ä»æ•°æ®åŒæ­¥å»¶è¿Ÿå¾ˆå¤§çš„å¸¸è§åŸå› </h2>
<h3 data-id="heading-3">å¤åˆ¶ç§¯å‹å †ç§¯</h3>
<p>ä¸»èŠ‚ç‚¹æ¯ç§’å¤„ç†å¤§é‡å†™æ“ä½œï¼ˆå¦‚é«˜é¢‘ SETã€INCRã€LPUSH ç­‰ï¼‰ï¼Œäº§ç”Ÿå¤§é‡å¤åˆ¶æµï¼Œä»èŠ‚ç‚¹æ¶ˆè´¹é€Ÿåº¦è·Ÿä¸ä¸Šä¸»èŠ‚ç‚¹ç”Ÿäº§é€Ÿåº¦ï¼Œå¯¼è‡´å¤åˆ¶ç§¯å‹å †ç§¯ã€‚</p>
<p><code>lave0</code>/<code>slave1</code>Â çš„Â <code>offset</code>Â ä¸ä¸»èŠ‚ç‚¹Â <code>master_repl_offset</code>Â çš„å·®å€¼å°±æ˜¯æ˜¯å¦å¤åˆ¶ç§¯å‹å †ç§¯çš„æ ‡å‡†ã€‚è‹¥å·®å€¼æŒç»­å¢å¤§ï¼Œè¯´æ˜å¤åˆ¶è¿½ä¸ä¸Šã€‚</p>
<h3 data-id="heading-4">BigKey</h3>
<p>Redisçš„BigKeyä¼ è¾“æ˜¯å¯¼è‡´ä¸»ä»å»¶è¿Ÿæœ€å¸¸è§çš„åŸå› ã€‚
Master ä¼ è¾“ä¸€ä¸ªå‡ å MB çš„ List æˆ– Hash ç»™ Slaveï¼Œç½‘ç»œè¢«å ç”¨ï¼Œè§£æè¢«é˜»å¡ï¼Œå¯¼è‡´åç»­å‘½ä»¤ç¬é—´å †ç§¯å»¶è¿Ÿã€‚</p>
<h3 data-id="heading-5">ç½‘ç»œä¸ç¡¬ä»¶</h3>
<ul>
<li>
<p><strong>åŒå±€åŸŸç½‘:</strong> ç¡®ä¿ä¸»ä»åœ¨åŒä¸€æœºæˆ¿/å±€åŸŸç½‘ï¼Œè·¨å…¬åŸŸç½‘åŒæ­¥å»¶è¿Ÿæå¤§ã€‚</p>
</li>
<li>
<p><strong>æœºå™¨è´Ÿè½½:</strong> æ£€æŸ¥ Slave èŠ‚ç‚¹çš„ AOF é‡å†™ï¼ˆRewriteï¼‰æˆ– RDB ç”Ÿæˆæ˜¯å¦å¯¼è‡´ CPU é£™å‡ï¼Œé˜»å¡äº†ä¸»çº¿ç¨‹çš„åŒæ­¥å›æ”¾</p>
</li>
</ul>
<h2 data-id="heading-6">è§£å†³æ–¹æ³•</h2>
<p>æˆ‘ä»<strong>ä¸šåŠ¡å®¹å¿åº¦</strong>ã€<strong>ä»£ç é€»è¾‘</strong>å’Œ<strong>è¿ç»´é…ç½®</strong>ä¸‰ä¸ªå±‚é¢æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p>
<p>å…³é”®æ˜¯ä¸è¦è¯•å›¾å…¨å±€è§£å†³â€œ0å»¶è¿Ÿâ€ï¼Œè€Œæ˜¯æ ¹æ®æ•°æ®æ•æ„Ÿåº¦æ‹†åˆ†ç­–ç•¥ã€‚</p>
<h3 data-id="heading-7">å…³é”®ä¸šåŠ¡å¼ºåˆ¶è¯»ä¸» (Read from Master)</h3>
<p>è¿™æ˜¯æœ€ç®€å•ä¸”æœ€æœ‰æ•ˆçš„æ–¹æ¡ˆã€‚å¯¹äºå¿…é¡»å‡†ç¡®çš„æ•°æ®ï¼Œä¸è¦èµ°è¯»å†™åˆ†ç¦»çš„é€»è¾‘ï¼Œç›´æ¥è·¯ç”±åˆ° Master èŠ‚ç‚¹ã€‚
æ¯”å¦‚ä½™é¢ï¼Œåº“å­˜æ‰£å‡ï¼Œè®¢å•çŠ¶æ€ç­‰ç­‰ã€‚</p>
<p>åœ¨Javaä¸­ï¼Œå¯ä»¥ç±»ä¼¼è¿™æ ·å†™ï¼š</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">if</span> (isCriticalData) {
    redisTemplate.opsForValue().get(key); <span class="hljs-comment">// é…ç½®ä¸ºä¸»åº“è¿æ¥</span>
} <span class="hljs-keyword">else</span> {
    redisReadReplicaTemplate.opsForValue().get(key); <span class="hljs-comment">// é…ç½®ä¸ºä»åº“è¿æ¥</span>
}
</code></pre>
<h3 data-id="heading-8">ä½¿ç”¨ <code>WAIT</code> å‘½ä»¤ (å¼ºä¸€è‡´æ€§æŠ˜è¡·,ä¸æ¨è)</h3>
<p>Redis æ”¯æŒ <code>WAIT</code> å‘½ä»¤ï¼Œå®ƒå¯ä»¥é˜»å¡å½“å‰å†™æ“ä½œçš„å®¢æˆ·ç«¯ï¼Œç›´åˆ°å†™æ“ä½œè¢«åŒæ­¥åˆ°æŒ‡å®šæ•°é‡çš„ä»èŠ‚ç‚¹ã€‚</p>
<ul>
<li><strong>å‘½ä»¤:</strong> <code>WAIT numreplicas timeout</code></li>
<li><strong>é€»è¾‘:</strong> åªæœ‰å½“è‡³å°‘ <code>numreplicas</code> ä¸ªä»èŠ‚ç‚¹ç¡®è®¤æ¥æ”¶åˆ°å†™æ“ä½œåï¼ŒMaster æ‰ä¼šè¿”å›æˆåŠŸã€‚</li>
<li><strong>ä»£ä»·:</strong> <strong>ä¸¥é‡ç‰ºç‰²å†™æ€§èƒ½</strong>ã€‚å¦‚æœä»èŠ‚ç‚¹æ•…éšœæˆ–ç½‘ç»œæŠ–åŠ¨ï¼Œå†™æ“ä½œä¼šé˜»å¡ç›´åˆ°è¶…æ—¶ã€‚</li>
<li><strong>é€‚ç”¨:</strong> æå…¶é‡è¦ä¸”å†™é¢‘ç‡è¾ƒä½çš„æ•°æ®</li>
</ul>
<h3 data-id="heading-9">ä¸šåŠ¡å±‚æ ¡éªŒ "ç‰ˆæœ¬å·" æˆ– "æ—¶é—´æˆ³"</h3>
<p>å¦‚æœä½ å¿…é¡»è¯»ä»åº“ï¼Œä½†åˆæƒ³çŸ¥é“æ•°æ®æ˜¯å¦è¿‡æœŸï¼š</p>
<ol>
<li><strong>å†™å…¥æ—¶:</strong> åœ¨ Value ä¸­å†™å…¥ä¸€ä¸ªæ—¶é—´æˆ³æˆ–ç‰ˆæœ¬å· <code>v1</code>ã€‚</li>
<li><strong>å¦å¤–å­˜å‚¨:</strong> å°†è¯¥ Key çš„æœ€æ–°ç‰ˆæœ¬å· <code>v1</code> å­˜å…¥ä¸€ä¸ªé«˜å¯ç”¨çš„ç¼“å­˜ï¼ˆå¦‚ Zookeeperã€Etcd æˆ– Redis Master çš„ä¸€ä¸ªä¸“ç”¨ Keyï¼‰ã€‚</li>
<li><strong>è¯»å–æ—¶:</strong> è¯»å–ä»åº“æ•°æ®ï¼Œå¯¹æ¯”å…¶ä¸­çš„ç‰ˆæœ¬å·ä¸ Master/ä¸­å¿ƒå­˜å‚¨çš„ç‰ˆæœ¬å·ã€‚å¦‚æœä¸ä¸€è‡´ï¼Œè¯´æ˜å»¶è¿Ÿäº†ï¼Œè§¦å‘<strong>å›æºè¯»ä¸»åº“</strong></li>
</ol>
<h3 data-id="heading-10">æœç»BigKeyç­‰</h3>
<p>è¿˜æœ‰å¾ˆå¤šç­–ç•¥ï¼Œæ¯”å¦‚ä»£ç å±‚æˆ‘ä»¬è¦æ‹†åˆ†bigkeyï¼Œç›‘æ§ä¸»ä»å¤åˆ¶åç§»é‡ç­‰ç­‰</p>
<h2 data-id="heading-11">æ€»ç»“</h2>
<p>æˆ‘ä»¬è¦æ ¹æ®ä¸šåŠ¡æ•æ„Ÿåº¦æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæ ¹æ®æ•°æ®æ•æ„Ÿåº¦æ¥æ‹†åˆ†ç­–ç•¥ï¼š</p>

























<table><thead><tr><th><strong>åœºæ™¯</strong></th><th><strong>ç¤ºä¾‹</strong></th><th><strong>æ¨èç­–ç•¥</strong></th></tr></thead><tbody><tr><td><strong>å¼ºä¸€è‡´æ€§</strong></td><td>ä½™é¢ã€åº“å­˜æ‰£å‡ã€è®¢å•çŠ¶æ€</td><td><strong>å¼ºåˆ¶è¯»ä¸»åº“ (Master)</strong></td></tr><tr><td><strong>æœ€ç»ˆä¸€è‡´æ€§</strong></td><td>ç”¨æˆ·æ˜µç§°ã€éå®æ—¶æ’è¡Œæ¦œã€å†å²è®°å½•</td><td><strong>è¯»ä»åº“ + ç›‘æ§/é‡è¯•</strong></td></tr><tr><td><strong>é«˜æ•æ„Ÿåº¦</strong></td><td>ç§’æ€èµ„æ ¼ã€é…ç½®å¼€å…³</td><td><strong>ä½¿ç”¨ <code>WAIT</code> å‘½ä»¤æˆ–åˆ†å¸ƒå¼é”</strong></td></tr></tbody></table>
<ul>
<li>
<p><strong>æœ€é«˜ä¼˜å…ˆçº§:</strong> æ¢³ç†ä¸šåŠ¡ã€‚å°†<strong>å¿…é¡»å¼ºä¸€è‡´</strong>çš„è¯»è¯·æ±‚ï¼ˆå¦‚é‡‘é¢ï¼‰ï¼Œåœ¨ä»£ç å±‚é¢æŒ‡å®š<strong>ç›´æ¥è¯» Master</strong>ã€‚è¿™æ˜¯æœ€ç¨³å¦¥çš„ã€‚</p>
</li>
<li>
<p><strong>æ¬¡ä¼˜å…ˆçº§:</strong> æ£€æŸ¥æ˜¯å¦æœ‰ <strong>BigKey</strong> é˜»å¡äº†åŒæ­¥é“¾è·¯ã€‚</p>
</li>
<li>
<p><strong>å¯é€‰ç­–ç•¥:</strong> å¦‚æœå¿…é¡»è¯»ä»åº“ä¸”è¦æ±‚è¾ƒé«˜ä¸€è‡´æ€§ï¼Œå®ç°ä¸€ä¸ªç®€å•çš„<strong>ç›‘æ§ç†”æ–­æœºåˆ¶</strong>ï¼ˆé€šè¿‡ Java/Go å®šæ—¶æ£€æŸ¥ Offsetï¼‰ï¼Œè‡ªåŠ¨éš”ç¦»é«˜å»¶è¿Ÿçš„ä»èŠ‚ç‚¹</p>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[ä»é›¶æ­ä¸€ä¸ª Vue å°å®¶ï¼šç”¨ Vite + è·¯ç”±è½»æ¾å…¥é—¨ç°ä»£å‰ç«¯å¼€å‘]]></title>    <link>https://juejin.cn/post/7585400495683665962</link>    <guid>https://juejin.cn/post/7585400495683665962</guid>    <pubDate>2025-12-20T04:08:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585400495683665962" data-draft-id="7585400495683026986" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="ä»é›¶æ­ä¸€ä¸ª Vue å°å®¶ï¼šç”¨ Vite + è·¯ç”±è½»æ¾å…¥é—¨ç°ä»£å‰ç«¯å¼€å‘"/> <meta itemprop="keywords" content="Vue.js,å‰ç«¯æ¡†æ¶,é¢è¯•"/> <meta itemprop="datePublished" content="2025-12-20T04:08:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="é±¼é±¼å—"/> <meta itemprop="url" content="https://juejin.cn/user/4302802432307224"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="æ˜é‡‘"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ä»é›¶æ­ä¸€ä¸ª Vue å°å®¶ï¼šç”¨ Vite + è·¯ç”±è½»æ¾å…¥é—¨ç°ä»£å‰ç«¯å¼€å‘
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4302802432307224/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    é±¼é±¼å—
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T04:08:42.000Z" title="Sat Dec 20 2025 04:08:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    é˜…è¯»8åˆ†é’Ÿ
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">ä»é›¶å¼€å§‹ï¼Œè½»æ¾èµ°è¿› Vue çš„ä¸–ç•Œï¼šä¸€ä¸ªâ€œå…¨å®¶æ¡¶â€å°é¡¹ç›®çš„æ­å»ºä¹‹æ—…</h2>
<p>å¦‚æœä½ åˆšåˆšæ¥è§¦å‰ç«¯å¼€å‘ï¼Œå¬åˆ°â€œVueâ€ã€â€œViteâ€ã€â€œè·¯ç”±â€è¿™äº›è¯æ—¶æ˜¯ä¸æ˜¯æœ‰ç‚¹æ‡µï¼Ÿåˆ«æ‹…å¿ƒï¼æˆ‘ä»¬å¯ä»¥æŠŠå†™ä»£ç æƒ³è±¡æˆ<strong>æ­ç§¯æœ¨ã€è£…ä¿®æˆ¿å­ã€ç”šè‡³å®‰æ’ä¸€åœºå®¶åº­æ—…è¡Œ</strong>ã€‚ä»Šå¤©ï¼Œæˆ‘ä»¬å°±é€šè¿‡ä¸€ä¸ªåä¸º <code>all-vue</code> çš„å°é¡¹ç›®ï¼Œå¸¦ä½ ä¸€æ­¥æ­¥ç†è§£ç°ä»£ Vue åº”ç”¨æ˜¯æ€ä¹ˆâ€œæ­èµ·æ¥â€çš„ã€‚</p>
<hr/>
<h3 data-id="heading-1">ğŸ  ç¬¬ä¸€æ­¥ï¼šé€‰å¥½åœ°åŸºâ€”â€”ç”¨ Vite å¿«é€Ÿå»ºé¡¹ç›®</h3>
<h4 data-id="heading-2"><strong>ä»€ä¹ˆæ˜¯viteï¼Ÿ</strong></h4>
<blockquote>
<p><strong>Vite</strong>ï¼ˆæ³•è¯­ï¼Œæ„ä¸ºâ€œå¿«â€ï¼‰æ˜¯ä¸€ä¸ªç”± Vue.js ä½œè€… <strong>å°¤é›¨æºªï¼ˆEvan Youï¼‰</strong> ä¸»å¯¼å¼€å‘çš„ç°ä»£åŒ–å‰ç«¯æ„å»ºå·¥å…·ã€‚å®ƒæ—¨åœ¨è§£å†³ä¼ ç»Ÿæ‰“åŒ…å·¥å…·ï¼ˆå¦‚ Webpackï¼‰åœ¨å¼€å‘é˜¶æ®µå¯åŠ¨æ…¢ã€çƒ­æ›´æ–°ï¼ˆHMRï¼‰å»¶è¿Ÿé«˜ç­‰é—®é¢˜ï¼Œæä¾›æé€Ÿçš„å¼€å‘ä½“éªŒã€‚</p>
</blockquote>
<p>æƒ³è±¡ä½ è¦ç›–ä¸€æ ‹æˆ¿å­ã€‚ä¼ ç»Ÿæ–¹å¼å¯èƒ½è¦å…ˆæ‰“åœ°åŸºã€ç Œç –ã€é“ºç”µçº¿â€¦â€¦ç¹çåˆè€—æ—¶ã€‚è€Œ <strong>Vite</strong> å°±åƒä¸€ä½è¶…çº§é«˜æ•ˆçš„å»ºç­‘æ‰¿åŒ…å•†ï¼Œä½ åªè¦è¯´ä¸€å¥ï¼šâ€œæˆ‘è¦ä¸€ä¸ª Vue æˆ¿å­â€ï¼Œå®ƒç«‹åˆ»ç»™ä½ æ­å¥½æ¡†æ¶ï¼Œè¿æ°´ç”µéƒ½é€šå¥½äº†ï¼</p>
<p>åœ¨ç»ˆç«¯é‡Œè¿è¡Œï¼š</p>
<pre><code class="hljs language-sql" lang="sql">npm init vite<span class="hljs-variable">@latest</span> <span class="hljs-keyword">all</span><span class="hljs-operator">-</span>vue <span class="hljs-comment">-- --template vue</span>
</code></pre>
<p>å‡ ç§’é’Ÿåï¼Œä½ å°±å¾—åˆ°äº†ä¸€ä¸ªç»“æ„æ¸…æ™°çš„é¡¹ç›®ç›®å½•ã€‚å…¶ä¸­æœ€å…³é”®çš„æ˜¯ï¼š</p>
<ul>
<li><code>index.html</code>ï¼šè¿™æ˜¯ä½ æˆ¿å­çš„â€œå¤§é—¨â€ï¼Œæµè§ˆå™¨ä¸€æ‰“å¼€å°±çœ‹åˆ°å®ƒã€‚</li>
<li><code>src/main.js</code>ï¼šè¿™æ˜¯æ•´æ ‹æˆ¿å­çš„â€œæ€»å¼€å…³â€ï¼Œè´Ÿè´£å¯åŠ¨æ•´ä¸ªåº”ç”¨ã€‚</li>
<li><code>src/App.vue</code>ï¼šè¿™æ˜¯â€œå®¢å…â€ï¼Œæ‰€æœ‰æˆ¿é—´ï¼ˆé¡µé¢ï¼‰éƒ½è¦ä»è¿™é‡Œè¿›å‡ºã€‚</li>
</ul>
<p>Vite çš„ä¼˜åŠ¿åœ¨äº<strong>å¿«</strong>â€”â€”ä¿®æ”¹ä»£ç åï¼Œæµè§ˆå™¨å‡ ä¹ç¬é—´åˆ·æ–°ï¼Œå°±åƒä½ æ¢äº†ä¸ªæ²™å‘ï¼Œå®¶äººé©¬ä¸Šå°±èƒ½åä¸Šå»è¯•èˆ’æœä¸èˆ’æœã€‚</p>
<hr/>
<h3 data-id="heading-3">ğŸ—ï¸ ç¬¬äºŒæ­¥ï¼šè®¤è¯†æ•´æ ‹æ¥¼â€”â€”é¡¹ç›®ç»“æ„æ¦‚è§ˆ</h3>
<p>è¿è¡Œ <code>npm init vite@latest all-vue -- --template vue</code> åï¼Œä½ ä¼šå¾—åˆ°è¿™æ ·ä¸€æ ‹â€œæ•°å­—å…¬å¯“â€ï¼š</p>
<p>é¡¹ç›®ç»“æ„ç®€ç•¥é¢„è§ˆï¼š</p>
<pre><code class="hljs language-bash" lang="bash">/all-vue
â”œâ”€â”€ public/            <span class="hljs-comment"># å…¬å…±èµ„æºï¼ˆå¦‚ logo.pngï¼‰</span>
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ assets/        <span class="hljs-comment"># å›¾ç‰‡ã€å­—ä½“ç­‰é™æ€èµ„æº</span>
â”‚   â”œâ”€â”€ components/    <span class="hljs-comment"># å¯å¤ç”¨çš„å°éƒ¨ä»¶ï¼ˆæŒ‰é’®ã€å¡ç‰‡ç­‰ï¼‰</span>
â”‚   â”œâ”€â”€ views/         <span class="hljs-comment"># ç‹¬ç«‹é¡µé¢ï¼ˆé¦–é¡µã€å…³äºé¡µç­‰ï¼‰</span>
|   |     |â€”â€” About.vue <span class="hljs-comment"># å…³äºé¡µé¢çš„Vueç»„ä»¶</span>
|   |     |â€”â€” Home.vue <span class="hljs-comment"># ä¸»é¡µçš„vueç»„ä»¶</span>
â”‚   â”œâ”€â”€ router/        <span class="hljs-comment"># å®¤å†…å¯¼èˆªç³»ç»Ÿ</span>
|   |     |â€”â€” index.js <span class="hljs-comment"># è·¯ç”±æ€»æ§</span>
â”‚   â”œâ”€â”€ App.vue        <span class="hljs-comment"># ä¸­å¤®æ§åˆ¶å°ï¼ˆå®¢å…ï¼‰</span>
â”‚   â””â”€â”€ main.js        <span class="hljs-comment"># æ™ºèƒ½é’¥åŒ™</span>
â”œâ”€â”€ index.html         <span class="hljs-comment"># å…¥æˆ·å¤§é—¨</span>
â”œâ”€â”€ package.json       <span class="hljs-comment"># å…¬å¯“çš„â€œä½æˆ·æ‰‹å†Œ + è£…ä¿®æ¸…å•â€</span>
â””â”€â”€ vite.config.js     <span class="hljs-comment"># å»ºç­‘è§„èŒƒè¯´æ˜ä¹¦</span>
</code></pre>
<p>å…¶ä¸­ï¼Œ<code>package.json</code> å°±åƒè¿™æ ‹æ¥¼çš„<strong>ä½æˆ·æ‰‹å†Œ + è£…ä¿®ææ–™æ¸…å•</strong>ã€‚æ‰“å¼€å®ƒï¼Œä½ ä¼šçœ‹åˆ°ï¼š</p>
<pre><code class="hljs language-perl" lang="perl">{
  <span class="hljs-string">"name"</span>: <span class="hljs-string">"all-vue"</span>,
  <span class="hljs-string">"version"</span>: <span class="hljs-string">"0.0.0"</span>,
  <span class="hljs-string">"scripts"</span>: {
    <span class="hljs-string">"dev"</span>: <span class="hljs-string">"vite"</span>,
    <span class="hljs-string">"build"</span>: <span class="hljs-string">"vite build"</span>,
    <span class="hljs-string">"preview"</span>: <span class="hljs-string">"vite preview"</span>
  },
  <span class="hljs-string">"dependencies"</span>: {
    <span class="hljs-string">"vue"</span>: <span class="hljs-string">"^3.4.0"</span>,
    <span class="hljs-string">"vue-router"</span>: <span class="hljs-string">"^4.3.0"</span>
  },
  <span class="hljs-string">"devDependencies"</span>: {
    <span class="hljs-string">"@vitejs/plugin-vue"</span>: <span class="hljs-string">"^5.0.0"</span>,
    <span class="hljs-string">"vite"</span>: <span class="hljs-string">"^5.0.0"</span>
  }
}
</code></pre>
<ul>
<li><strong><code>dependencies</code></strong>ï¼šè¿™æ˜¯â€œå…¥ä½å¿…éœ€å“â€ï¼Œæ¯”å¦‚ Vue æ¡†æ¶æœ¬èº«ã€è·¯ç”±ç³»ç»Ÿâ€”â€”æ²¡æœ‰å®ƒä»¬ï¼Œæˆ¿å­æ²¡æ³•æ­£å¸¸è¿è½¬ï¼›</li>
<li><strong><code>devDependencies</code></strong>ï¼šè¿™æ˜¯â€œè£…ä¿®å·¥å…·åŒ…â€ï¼Œåªåœ¨å¼€å‘æ—¶ç”¨ï¼ˆæ¯”å¦‚ Vite æ„å»ºå·¥å…·ï¼‰ï¼Œä½æˆ·å…¥ä½åå°±ä¸éœ€è¦äº†ï¼›</li>
<li><strong><code>scripts</code></strong>ï¼šè¿™æ˜¯â€œå¿«æ·æŒ‡ä»¤â€ï¼Œæ¯”å¦‚ <code>npm run dev</code> å°±æ˜¯â€œå¯åŠ¨é¢„è§ˆæ¨¡å¼â€ï¼Œ<code>npm run build</code> æ˜¯â€œæ‰“åŒ…äº¤ä»˜â€ã€‚</li>
</ul>
<p>æœ‰äº†è¿™ä»½æ¸…å•ï¼Œä»»ä½•å¼€å‘è€…éƒ½èƒ½ä¸€é”®è¿˜åŸä½ çš„æ•´å¥—ç¯å¢ƒâ€”â€”å°±åƒç…§ç€å®œå®¶è¯´æ˜ä¹¦ç»„è£…å®¶å…·ä¸€æ ·å¯é ã€‚</p>
<hr/>
<h3 data-id="heading-4">ğŸšª ç¬¬ä¸‰æ­¥ï¼šè®¤è¯†â€œå¤§é—¨â€â€”â€”index.html çš„ä¸¤ä¸ªç§˜å¯†</h3>
<p>è™½ç„¶ç°ä»£ Vue åº”ç”¨çš„é€»è¾‘å‡ ä¹å…¨åœ¨ JavaScript å’Œ <code>.vue</code> æ–‡ä»¶é‡Œï¼Œä½†ä¸€åˆ‡çš„èµ·ç‚¹ï¼Œå…¶å®æ˜¯è¿™ä¸ªçœ‹ä¼¼ç®€å•çš„ <code>index.html</code>ï¼š</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span> /&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"icon"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"image/svg+xml"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"/vite.svg"</span> /&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span> /&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>all-vue<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"app"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"module"</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"/src/main.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p>åˆ«å°çœ‹è¿™åå‡ è¡Œä»£ç ï¼Œå®ƒè—ç€ä¸¤ä¸ªå…³é”®è®¾è®¡ï¼š</p>
<h4 data-id="heading-5">ğŸ”Œ 1. <code>&lt;div id="app"&gt;&lt;/div&gt;</code>ï¼šVue çš„â€œæ’åº§â€</h4>
<p>ä½ å¯ä»¥æŠŠå®ƒæƒ³è±¡æˆå¢™ä¸Šé¢„ç•™çš„ä¸€ä¸ª<strong>æ™ºèƒ½æ’åº§é¢æ¿</strong>ã€‚å®ƒæœ¬èº«ç©ºæ— ä¸€ç‰©ï¼Œä½†ä¸€æ—¦é€šç”µï¼ˆVue åº”ç”¨å¯åŠ¨ï¼‰ï¼Œå°±ä¼šè‡ªåŠ¨â€œæŠ•å½±â€å‡ºæ•´ä¸ªç”¨æˆ·ç•Œé¢ã€‚</p>
<p>åœ¨ <code>main.js</code> ä¸­ï¼Œæˆ‘ä»¬è¿™æ ·å†™ï¼š</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title function_">createApp</span>(<span class="hljs-title class_">App</span>).<span class="hljs-title function_">mount</span>(<span class="hljs-string">'#app'</span>)
</code></pre>
<p>è¿™å¥è¯çš„æ„æ€å°±æ˜¯ï¼šâ€œè¯·æŠŠ <code>App.vue</code> è¿™ä¸ªâ€˜å®¢å…â€™çš„å†…å®¹ï¼ŒæŠ•å°„åˆ° id ä¸º <code>app</code> çš„é‚£ä¸ªæ’åº§ä¸Šã€‚â€<br/>
æ²¡æœ‰è¿™ä¸ªæ’åº§ï¼ŒVue å†å‰å®³ä¹Ÿæ— å¤„æ–½å±•ï¼›æœ‰äº†å®ƒï¼ŒåŠ¨æ€å†…å®¹æ‰èƒ½åœ¨é™æ€ HTML ä¸­ç”Ÿæ ¹å‘èŠ½ã€‚</p>
<h4 data-id="heading-6">âš¡ 2. <code>&lt;script type="module" src="/src/main.js"&gt;&lt;/script&gt;</code>ï¼šåŸç”Ÿ ES æ¨¡å—çš„é­”æ³•</h4>
<p>æ³¨æ„è¿™é‡Œçš„ <code>type="module"</code>ã€‚è¿™æ˜¯ç°ä»£æµè§ˆå™¨æ”¯æŒçš„ä¸€ç§<strong>åŸç”Ÿæ¨¡å—åŠ è½½æ–¹å¼</strong>ã€‚ä¼ ç»Ÿè„šæœ¬æ˜¯â€œä¸€è‚¡è„‘å…¨å¡è¿›æ¥â€ï¼Œè€Œæ¨¡å—åŒ–è„šæœ¬åˆ™åƒå¿«é€’åŒ…è£¹â€”â€”æ¯ä¸ªæ–‡ä»¶ç‹¬ç«‹æ‰“åŒ…ï¼ŒæŒ‰éœ€å¼•ç”¨ï¼Œäº’ä¸å¹²æ‰°ã€‚</p>
<p>Vite æ­£æ˜¯åˆ©ç”¨äº†è¿™ä¸€ç‰¹æ€§ï¼Œ<strong>æ— éœ€æ‰“åŒ…å³å¯ç›´æ¥åœ¨æµè§ˆå™¨ä¸­è¿è¡Œæ¨¡å—åŒ–çš„ä»£ç </strong>ã€‚è¿™æ„å‘³ç€ï¼š</p>
<ul>
<li>å¼€å‘æ—¶å¯åŠ¨é£å¿«ï¼ˆå†·å¯åŠ¨å¿«ï¼‰ï¼›</li>
<li>ä¿®æ”¹æ–‡ä»¶åçƒ­æ›´æ–°æå¿«ï¼ˆHMR ç²¾å‡†æ›¿æ¢ï¼‰ï¼›</li>
<li>ä»£ç ç»“æ„æ¸…æ™°ï¼Œç¬¦åˆç°ä»£å·¥ç¨‹è§„èŒƒã€‚</li>
</ul>
<p>æ‰€ä»¥ï¼Œ<code>index.html</code> ä¸ä»…æ˜¯å…¥å£ï¼Œæ›´æ˜¯è¿æ¥<strong>é™æ€ HTML ä¸–ç•Œ</strong>ä¸<strong>åŠ¨æ€ Vue ä¸–ç•Œ</strong>çš„æ¡¥æ¢ã€‚</p>
<hr/>
<h3 data-id="heading-7">ğŸ”‘ ç¬¬å››æ­¥ï¼šæ‰“é€ â€œé’¥åŒ™â€â€”â€”main.js å¦‚ä½•å¯åŠ¨åº”ç”¨</h3>
<p>æœ‰äº†å¤§é—¨ï¼Œå°±å¾—æœ‰é’¥åŒ™ã€‚<code>main.js</code> å°±æ˜¯è¿™æŠŠç²¾å¯†çš„ç”µå­é’¥åŒ™ï¼Œè´Ÿè´£æ¿€æ´»æ•´å¥—æ™ºèƒ½å®¶å±…ç³»ç»Ÿï¼š</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { createApp } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">App</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./App.vue'</span>
<span class="hljs-keyword">import</span> router <span class="hljs-keyword">from</span> <span class="hljs-string">'./router'</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'./style.css'</span>

<span class="hljs-title function_">createApp</span>(<span class="hljs-title class_">App</span>).<span class="hljs-title function_">use</span>(router).<span class="hljs-title function_">mount</span>(<span class="hljs-string">'#app'</span>)
</code></pre>
<p>è¿™æ®µä»£ç åšäº†ä¸‰ä»¶äº‹ï¼Œç¯ç¯ç›¸æ‰£ï¼š</p>
<ol>
<li><strong>å¼•å…¥æ ¸å¿ƒæ¨¡å—</strong>ï¼šä» Vue æ‹¿åˆ°â€œé€ æˆ¿å­â€çš„å·¥å…·ï¼ˆ<code>createApp</code>ï¼‰ï¼Œä»æœ¬åœ°æ‹¿åˆ°â€œå®¢å…è®¾è®¡å›¾â€ï¼ˆ<code>App.vue</code>ï¼‰å’Œâ€œå¯¼èˆªç³»ç»Ÿâ€ï¼ˆ<code>router</code>ï¼‰ï¼›</li>
<li><strong>ç»„è£…ç³»ç»Ÿ</strong>ï¼šç”¨ <code>.use(router)</code> æŠŠå¯¼èˆªæ’ä»¶è£…è¿›ä¸»ç¨‹åºï¼›</li>
<li><strong>æ’å…¥æ’åº§</strong>ï¼š<code>.mount('#app')</code> è¡¨ç¤ºï¼šâ€œè¯·æŠŠè¿™å¥—ç³»ç»Ÿé€šç”µå®‰è£…åœ¨ <code>index.html</code> ä¸­ id ä¸º <code>app</code> çš„æ’åº§ä¸Šã€‚â€</li>
</ol>
<p>æ²¡æœ‰è¿™æŠŠé’¥åŒ™ï¼Œå†æ¼‚äº®çš„å®¢å…ä¹Ÿåªæ˜¯ä¸€å †å›¾çº¸ï¼›æœ‰äº†å®ƒï¼Œæ•´ä¸ªæˆ¿å­æ‰çœŸæ­£â€œæ´»â€èµ·æ¥ã€‚</p>
<hr/>
<h3 data-id="heading-8">ğŸ’¡ ç¬¬äº”æ­¥ï¼šç‚¹äº®å®¢å…â€”â€”æ ¹ç»„ä»¶ App.vue</h3>
<p>é’¥åŒ™è½¬åŠ¨ï¼Œé—¨å¼€äº†ï¼Œæˆ‘ä»¬èµ°è¿› <code>App.vue</code> â€”â€” è¿™æ˜¯æ‰€æœ‰åŠŸèƒ½çš„æ€»æ§ä¸­å¿ƒï¼š</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"app"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">nav</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">router-link</span> <span class="hljs-attr">to</span>=<span class="hljs-string">"/"</span>&gt;</span>Home<span class="hljs-tag">&lt;/<span class="hljs-name">router-link</span>&gt;</span> |
      <span class="hljs-tag">&lt;<span class="hljs-name">router-link</span> <span class="hljs-attr">to</span>=<span class="hljs-string">"/about"</span>&gt;</span>About<span class="hljs-tag">&lt;/<span class="hljs-name">router-link</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">nav</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">router-view</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
</code></pre>
<blockquote>
<p>å¤šäººä¸€å¼€å§‹ä¼šç›´æ¥å†™ <code>&lt;div&gt;Home | About&lt;/div&gt;</code>ï¼Œä½†è¿™åªæ˜¯é™æ€æ–‡å­—ã€‚è¦è®©å®ƒä»¬å˜æˆå¯ç‚¹å‡»çš„å¯¼èˆªï¼Œå°±å¾—ç”¨ Vue Router æä¾›çš„ <code>&lt;router-link&gt;</code> ç»„ä»¶ã€‚</p>
</blockquote>
<p>è¿™é‡Œæœ‰ä¸¤ä¸ªæ ¸å¿ƒå…ƒç´ ï¼š</p>
<ul>
<li><strong><code>&lt;router-link&gt;</code></strong> ï¼šæ™ºèƒ½é—¨æŠŠæ‰‹ï¼Œç‚¹å‡»ä¸åˆ·æ–°é¡µé¢ï¼Œåªåˆ‡æ¢å†…å®¹ï¼›</li>
<li><strong><code>&lt;router-view /&gt;</code></strong> ï¼šé­”æ³•åœ°æ¿ï¼Œå½“å‰è¯¥å±•ç¤ºå“ªä¸ªæˆ¿é—´ï¼Œå®ƒå°±å®æ—¶æŠ•å½±å‡ºæ¥ã€‚</li>
</ul>
<p>è™½ç„¶åŸå§‹æ–‡ä»¶åªå†™äº† <code>HomeAbout</code>ï¼Œä½†æ­£ç¡®çš„å†™æ³•åº”å¦‚ä¸Šæ‰€ç¤ºâ€”â€”è®©æ–‡å­—å˜æˆå¯äº¤äº’çš„å¯¼èˆªã€‚</p>
<hr/>
<h3 data-id="heading-9">ğŸ—ºï¸ ç¬¬å…­æ­¥ï¼šè£…ä¸Šå¯¼èˆªç³»ç»Ÿâ€”â€”é…ç½® Vue Router</h3>
<p>è·¯ç”±ï¼Œå°±åƒæ˜¯ä½ å®¶é‡Œçš„<strong>æ™ºèƒ½å¯¼èˆªç³»ç»Ÿ</strong>ã€‚æ²¡æœ‰å®ƒï¼Œä½ åªèƒ½å¾…åœ¨å®¢å…ï¼›æœ‰äº†å®ƒï¼Œä½ æ‰èƒ½è‡ªç”±ç©¿æ¢­äºå„ä¸ªæˆ¿é—´ã€‚</p>
<p>æˆ‘ä»¬åœ¨ <code>src/router/index.js</code> ä¸­è¿™æ ·é…ç½®ï¼š</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { createRouter, createWebHashHistory } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue-router'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Home</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'../views/Home.vue'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">About</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'../views/About.vue'</span>

<span class="hljs-keyword">const</span> routes = [
  { <span class="hljs-attr">path</span>: <span class="hljs-string">'/'</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'Home'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">Home</span> },
  { <span class="hljs-attr">path</span>: <span class="hljs-string">'/about'</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'About'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">About</span> }
]

<span class="hljs-keyword">const</span> router = <span class="hljs-title function_">createRouter</span>({
  <span class="hljs-attr">history</span>: <span class="hljs-title function_">createWebHashHistory</span>(),
  routes
})

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> router
</code></pre>
<p>è¿™æ®µä»£ç çš„æ„æ€æ˜¯ï¼š</p>
<ul>
<li>å½“ç”¨æˆ·è®¿é—® <code>/</code>ï¼ˆä¹Ÿå°±æ˜¯ä¸»é¡µï¼‰ï¼Œå°±æ˜¾ç¤º <code>Home.vue</code> è¿™ä¸ªæˆ¿é—´ï¼›</li>
<li>å½“ç”¨æˆ·è®¿é—® <code>/about</code>ï¼Œå°±å¸¦ä»–å» <code>About.vue</code> é‚£ä¸ªæˆ¿é—´ã€‚</li>
</ul>
<p>æ³¨æ„è¿™é‡Œç”¨äº† <code>createWebHashHistory()</code>ï¼Œè¿™æ„å‘³ç€ç½‘å€ä¼šå˜æˆ <code>http://localhost:5173/#/about</code>ã€‚é‚£ä¸ª <code>#</code> å°±åƒé—¨ç‰Œå·é‡Œçš„â€œåˆ†éš”ç¬¦â€ï¼Œå‘Šè¯‰ç³»ç»Ÿï¼šâ€œåé¢çš„éƒ¨åˆ†æ˜¯å†…éƒ¨æˆ¿é—´å·ï¼Œä¸æ˜¯æ–°åœ°å€â€ã€‚</p>
<hr/>
<h3 data-id="heading-10">ğŸ›‹ï¸ ç¬¬ä¸ƒæ­¥ï¼šå¸ƒç½®æˆ¿é—´â€”â€”ç¼–å†™é¡µé¢ç»„ä»¶</h3>
<p>ç°åœ¨ï¼Œæˆ‘ä»¬æ¥è£…ä¿®ä¸¤ä¸ªæˆ¿é—´ã€‚</p>
<h4 data-id="heading-11">é¦–é¡µï¼ˆHome.vueï¼‰</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Home<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
</code></pre>
<h4 data-id="heading-12">å…³äºé¡µï¼ˆAbout.vueï¼‰</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>About<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
</code></pre>
<p>æ¯ä¸ª <code>.vue</code> æ–‡ä»¶éƒ½æ˜¯ä¸€ä¸ªè‡ªåŒ…å«çš„â€œåŠŸèƒ½å•å…ƒâ€ï¼šæœ‰è‡ªå·±çš„ç»“æ„ï¼ˆtemplateï¼‰ã€é€»è¾‘ï¼ˆscriptï¼‰å’Œæ ·å¼ï¼ˆstyleï¼‰ã€‚å®ƒä»¬å½¼æ­¤éš”ç¦»ï¼Œå´èƒ½é€šè¿‡è·¯ç”±æ— ç¼åˆ‡æ¢ã€‚</p>
<hr/>
<h3 data-id="heading-13">ğŸ¨ ç¬¬å…«æ­¥ï¼šç¾åŒ–å®¶å›­â€”â€”å…¨å±€æ ·å¼ style.css</h3>
<p>è™½ç„¶åŠŸèƒ½é½å¤‡ï¼Œä½†æˆ¿å­è¿˜æ˜¯ç°æ‰‘æ‰‘çš„ã€‚è¿™æ—¶å€™ï¼Œ<code>style.css</code> å°±æ´¾ä¸Šç”¨åœºäº†ã€‚ä½ å¯ä»¥åœ¨è¿™é‡Œå†™ï¼š</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">body</span> {
  <span class="hljs-attribute">font-family</span>: <span class="hljs-string">'Arial'</span>, sans-serif;
  <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#f5f5f5</span>;
}

<span class="hljs-selector-tag">nav</span> {
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">1rem</span>;
  <span class="hljs-attribute">background</span>: white;
  <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">2px</span> <span class="hljs-number">4px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0.1</span>);
}
</code></pre>
<p>å°±åƒç»™å¢™å£åˆ·æ¼†ã€ç»™åœ°æ¿æ‰“èœ¡ï¼Œè®©æ•´ä¸ªå®¶æ›´æ¸©é¦¨èˆ’é€‚ã€‚</p>
<hr/>
<h3 data-id="heading-14">â–¶ï¸ æœ€åä¸€æ­¥ï¼šå¯åŠ¨ä½ çš„ Vue å®¶å›­ï¼</h3>
<p>ç°åœ¨ï¼Œæ‰€æœ‰â€œè£…ä¿®ææ–™â€éƒ½å·²å°±ä½â€”â€”åœ°åŸºæ‰“å¥½äº†ï¼ˆVite é¡¹ç›®ï¼‰ã€å¤§é—¨è£…ä¸Šäº†ï¼ˆ<code>index.html</code>ï¼‰ã€é’¥åŒ™é…å¥½äº†ï¼ˆ<code>main.js</code>ï¼‰ã€å®¢å…å¸ƒç½®å¦¥å½“ï¼ˆ<code>App.vue</code>ï¼‰ï¼Œè¿æˆ¿é—´ï¼ˆ<code>Home.vue</code>ã€<code>About.vue</code>ï¼‰å’Œå¯¼èˆªç³»ç»Ÿï¼ˆVue Routerï¼‰ä¹Ÿéƒ½è°ƒè¯•å®Œæ¯•ã€‚æ˜¯æ—¶å€™æ‰“å¼€ç”µé—¸ï¼Œç‚¹äº®æ•´æ ‹æˆ¿å­äº†ï¼</p>
<p>è¯·åœ¨ç»ˆç«¯ï¼ˆå‘½ä»¤è¡Œï¼‰ä¸­ä¾æ¬¡æ‰§è¡Œä»¥ä¸‹ä¸¤æ¡å‘½ä»¤ï¼ˆç¡®ä¿ä½ å·²åœ¨ <code>all-vue</code> é¡¹ç›®ç›®å½•ä¸‹ï¼‰ï¼š</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># ç¬¬ä¸€æ­¥ï¼šå®‰è£…â€œä½æˆ·æ‰‹å†Œâ€é‡Œåˆ—å‡ºçš„æ‰€æœ‰ä¾èµ–ï¼ˆæ¯”å¦‚ Vue å’Œè·¯ç”±ï¼‰</span>
npm install

<span class="hljs-comment"># ç¬¬äºŒæ­¥ï¼šå¯åŠ¨å¼€å‘æœåŠ¡å™¨â€”â€”ç›¸å½“äºæŒ‰ä¸‹â€œæ™ºèƒ½å®¶å±…æ€»å¼€å…³â€</span>
npm run dev
</code></pre>
<p>è¿è¡ŒæˆåŠŸåï¼Œä½ ä¼šçœ‹åˆ°ç±»ä¼¼è¿™æ ·çš„æç¤ºï¼š</p>
<pre><code class="hljs language-arduino" lang="arduino">  VITE v5<span class="hljs-number">.0</span><span class="hljs-number">.0</span>  ready in <span class="hljs-number">320</span> ms

  âœ  Local:   http:<span class="hljs-comment">//localhost:5173/</span>
  âœ  Network: use --host to expose
</code></pre>
<p>è¿™æ—¶ï¼Œåªéœ€æ‰“å¼€æµè§ˆå™¨ï¼Œè®¿é—® <strong><a href="https://link.juejin.cn?target=http%3A%2F%2Flocalhost%3A5173%2F" target="_blank" title="http://localhost:5173/" ref="nofollow noopener noreferrer">http://localhost:5173/</a></strong> ï¼ˆç«¯å£å·å¯èƒ½ç•¥æœ‰ä¸åŒï¼‰ï¼Œå°±èƒ½çœ‹åˆ°ä½ çš„ Vue å°å®¶å•¦ï¼</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/440dcba58617403380171870481fdee4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bG86bG85Z2X:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766808522&amp;x-signature=PS6EH4QoNScSUb1Hfyz%2Ff%2FzfYA0%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>ç‚¹å‡» <strong>Home</strong>ï¼Œå®¢å…ä¸­å¤®æ˜¾ç¤º â€œHomeâ€ï¼›</li>
<li>ç‚¹å‡» <strong>About</strong>ï¼Œç¬é—´åˆ‡æ¢åˆ° â€œAboutâ€ é¡µé¢â€”â€”<strong>å…¨ç¨‹æ— éœ€åˆ·æ–°</strong>ï¼Œå°±åƒåœ¨å®¶è‡ªç”±èµ°åŠ¨ä¸€æ ·ä¸æ»‘ã€‚</li>
</ul>
<p>ğŸ‰ <strong>æ­å–œä½ ï¼ä½ ä¸ä»…çœ‹æ‡‚äº†ä»£ç ï¼Œè¿˜äº²æ‰‹è®©å®ƒè·‘èµ·æ¥äº†ï¼</strong></p>
<p>è¿™ä¸å†æ˜¯ä¸€å †æŠ½è±¡çš„æ–‡ä»¶ï¼Œè€Œæ˜¯ä¸€ä¸ªçœŸæ­£èƒ½äº¤äº’çš„ Web åº”ç”¨ã€‚ä½ å·²ç»å®Œæˆäº†ä»â€œé›¶â€åˆ°â€œä¸€â€çš„é£è·ƒâ€”â€”è€Œè¿™ï¼Œæ­£æ˜¯æ‰€æœ‰ä¼Ÿå¤§é¡¹ç›®çš„èµ·ç‚¹ã€‚</p>
<hr/>
<h3 data-id="heading-15">ğŸ§© æ€»ç»“ï¼šVue é¡¹ç›®çš„â€œç”Ÿæ´»åŒ–â€é€»è¾‘é“¾</h3>
<p>è®©æˆ‘ä»¬ç”¨ä¸€æ¬¡æ™ºèƒ½å®¶å±…å…¥ä½ä½“éªŒæ¥ä¸²èµ·å…¨è¿‡ç¨‹ï¼š</p>
<ol>
<li><strong>Vite æ˜¯å¼€å‘å•†</strong>ï¼šæä¾›æ ‡å‡†åŒ–ç²¾è£…ä¿®æ ·æ¿é—´ï¼›</li>
<li><strong>index.html æ˜¯å…¥æˆ·é—¨</strong>ï¼šè®¾æœ‰æ™ºèƒ½æ’åº§ï¼ˆ<code>#app</code>ï¼‰å’Œæ¨¡å—åŒ–æ¥çº¿å£ï¼ˆ<code>type="module"</code>ï¼‰ï¼›</li>
<li><strong>main.js æ˜¯ç”µå­é’¥åŒ™</strong>ï¼šæ’å…¥åæ¿€æ´»æ•´å¥—ç³»ç»Ÿï¼›</li>
<li><strong>App.vue æ˜¯ä¸­å¤®æ§åˆ¶å°</strong>ï¼šé›†æˆå¯¼èˆªä¸å†…å®¹å±•ç¤ºåŒºï¼›</li>
<li><strong>Vue Router æ˜¯å®¤å†…å¯¼èˆªå›¾</strong>ï¼šå®šä¹‰å„æˆ¿é—´è·¯å¾„ï¼›</li>
<li><strong>Home.vue / About.vue æ˜¯åŠŸèƒ½æˆ¿é—´</strong>ï¼šå„è‡ªç‹¬ç«‹ï¼ŒæŒ‰éœ€è¿›å…¥ï¼›</li>
<li><strong>style.css æ˜¯å…¨å±‹è½¯è£…æ–¹æ¡ˆ</strong>ï¼šç»Ÿä¸€è§†è§‰é£æ ¼ã€‚</li>
</ol>
<h3 data-id="heading-16">âœ¨ å†™åœ¨æœ€åï¼šä½ å·²ç»ç«™åœ¨ Vue çš„é—¨å£</h3>
<p>è¿™ä¸ª <code>all-vue</code> é¡¹ç›®è™½å°ï¼Œå´åŒ…å«äº†ç°ä»£ Vue åº”ç”¨çš„æ ¸å¿ƒéª¨æ¶ï¼š<strong>ç»„ä»¶åŒ– + è·¯ç”± + å“åº”å¼ + å·¥ç¨‹åŒ–æ„å»º</strong>ã€‚ä½ ä¸éœ€è¦ä¸€å¼€å§‹å°±æ‡‚æ‰€æœ‰ç»†èŠ‚ï¼Œå°±åƒå­¦éª‘è‡ªè¡Œè½¦ï¼Œå…ˆæ‰¶ç¨³è½¦æŠŠï¼Œå†æ…¢æ…¢è¹¬è„šè¸ã€‚</p>
<p>å½“ä½ è¿è¡Œ <code>npm run dev</code>ï¼Œçœ‹åˆ°æµè§ˆå™¨é‡Œå‡ºç°â€œHomeâ€å’Œâ€œAboutâ€ä¸¤ä¸ªé“¾æ¥ï¼Œå¹¶èƒ½è‡ªç”±åˆ‡æ¢æ—¶â€”â€”æ­å–œä½ ï¼Œä½ å·²ç»æˆåŠŸè¿ˆå‡ºäº† Vue å¼€å‘çš„ç¬¬ä¸€æ­¥ï¼</p>
<p>æ¥ä¸‹æ¥ï¼Œä½ å¯ä»¥ï¼š</p>
<ul>
<li>åœ¨ Home é‡ŒåŠ ä¸€å¼ å›¾ç‰‡ï¼›</li>
<li>åœ¨ About é‡Œå†™ä¸€æ®µè‡ªæˆ‘ä»‹ç»ï¼›</li>
<li>ç”¨ CSS è®©å¯¼èˆªæ å˜å½©è‰²ï¼›</li>
<li>ç”šè‡³æ·»åŠ ç¬¬ä¸‰ä¸ªé¡µé¢â€¦â€¦</li>
</ul>
<p>ç¼–ç¨‹ä¸æ˜¯é­”æ³•ï¼Œè€Œæ˜¯ä¸€æ­¥æ­¥æ­å»ºçš„è¿‡ç¨‹ã€‚è€Œä½ ï¼Œå·²ç»æ­å¥½äº†ç¬¬ä¸€å—ç§¯æœ¨ã€‚</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android Viewæ¡†æ¶æ¦‚è§ˆ]]></title>    <link>https://juejin.cn/post/7585382553290375204</link>    <guid>https://juejin.cn/post/7585382553290375204</guid>    <pubDate>2025-12-20T04:08:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585382553290375204" data-draft-id="7585400495683616810" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android Viewæ¡†æ¶æ¦‚è§ˆ"/> <meta itemprop="keywords" content="Android,è®¡ç®—æœºå›¾å½¢å­¦"/> <meta itemprop="datePublished" content="2025-12-20T04:08:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="StarShip"/> <meta itemprop="url" content="https://juejin.cn/user/3790771820172391"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="æ˜é‡‘"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android Viewæ¡†æ¶æ¦‚è§ˆ
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3790771820172391/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    StarShip
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T04:08:17.000Z" title="Sat Dec 20 2025 04:08:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    é˜…è¯»6åˆ†é’Ÿ
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">ä¸€ã€æ•´ä½“åˆ†å±‚æ€»è§ˆ</h2>
<p>å…ˆçœ‹ä¸€ä¸ªâ€œä» App åˆ° ç³»ç»ŸæœåŠ¡ åˆ° æ˜¾ç¤ºç³»ç»Ÿâ€çš„æ–‡å­—æ¶æ„å›¾ï¼š</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-selector-attr">[ åº”ç”¨è¿›ç¨‹ App Process ]</span>
    â”œâ”€ Activity
    â”‚    â””â”€ Window (PhoneWindow)
    â”‚         â””â”€ DecorView (æ ¹ ViewGroup)
    â”‚               â””â”€ ViewGroup ... View æ ‘
    â”œâ”€ ViewRootImpl   (æ¡¥æ¢ï¼šViewä¸–ç•Œ â†” Window/Surfaceä¸–ç•Œ)
    â”œâ”€ WindowManager  (Framework æ¥å£ï¼Œå®ç°åœ¨ app è¿›ç¨‹)
    â”œâ”€ Handler / Looper (UIçº¿ç¨‹æ¶ˆæ¯å¾ªç¯)
    â”œâ”€ Choreographer  (åŸºäº VSync è°ƒåº¦ç»˜åˆ¶/åŠ¨ç”»)
    â”œâ”€ <span class="hljs-selector-tag">Canvas</span>         (ç»˜å›¾ API æŠ½è±¡ï¼Œåº•å±‚ç”± Skia å®ç°)
    â”œâ”€ Skia / HWUI    (<span class="hljs-number">2</span>D å›¾å½¢å¼•æ“ï¼Œç”Ÿæˆ GPU/CPU ç»˜åˆ¶å‘½ä»¤)
    â”œâ”€ OpenGL ES (æˆ– Vulkan) (ä¸ GPU äº¤äº’æ¥å£)
    â””â”€ Surface / SurfaceView / TextureView (å›¾å½¢ç¼“å†²é˜Ÿåˆ—çš„â€œç«¯å£â€)

<span class="hljs-selector-attr">[ System Server è¿›ç¨‹ ]</span>
    â”œâ”€ WindowManagerService (WMS)
    â”‚    â””â”€ ç®¡ç† Window çš„å±‚çº§ã€ä½ç½®ã€å¯è§ã€ç„¦ç‚¹ç­‰
    â””â”€ SurfaceFlinger (å›¾å½¢åˆæˆæœåŠ¡ï¼Œä¸åœ¨æ­¤é—®é¢˜æ ¸å¿ƒï¼Œç•¥æ)

<span class="hljs-selector-attr">[ æ˜¾ç¤ºå­ç³»ç»Ÿ / HAL / é©±åŠ¨ ]</span>
    â”œâ”€ Hardware Composer (HWC)
    â”œâ”€ Gralloc / GPU é©±åŠ¨
    â””â”€ æ˜¾ç¤ºé©±åŠ¨ / å±å¹•
</code></pre>
<p>è®°ä½ä¸€ä»¶äº‹ï¼šActivity åªç®¡â€œæƒ³æ˜¾ç¤ºä»€ä¹ˆ View æ ‘â€ï¼ŒçœŸæ­£çš„çª—å£ã€Surface å’Œæ˜¾ç¤ºï¼Œéƒ½æ˜¯ Window / WMS / Surface / ViewRootImpl åœ¨å¹²æ´»ã€‚</p>
<h2 data-id="heading-1">äºŒã€UI æ ‘ç›¸å…³æ ¸å¿ƒæ¦‚å¿µï¼šActivity â†’ Window â†’ DecorView â†’ ViewGroup / View</h2>
<ol>
<li>
<h3 data-id="heading-2">Activity</h3>
</li>
</ol>
<ul>
<li>
<p>èŒè´£ï¼š</p>
<ul>
<li>ç®¡ç†ä¸€ä¸ªå±å¹•ç•Œé¢çš„ç”Ÿå‘½å‘¨æœŸï¼š<code>onCreate</code> / <code>onStart</code> / <code>onResume</code> ç­‰ï¼›</li>
<li>é€šè¿‡ <code>setContentView()</code> æŒ‡å®šè¦æ˜¾ç¤ºçš„å¸ƒå±€ï¼ˆView æ ‘ï¼‰ã€‚</li>
</ul>
</li>
<li>
<p>å…³é”®ç‚¹ï¼šActivity æœ¬èº« ä¸ç›´æ¥æŒæœ‰è§†å›¾æ ‘ï¼Œè€Œæ˜¯é€šè¿‡ Window æ¥é—´æ¥ç®¡ç† UIã€‚</p>
</li>
</ul>
<ol start="2">
<li>
<h3 data-id="heading-3">Window &amp; WindowManager</h3>
</li>
</ol>
<ul>
<li>
<p>Windowï¼ˆé€šå¸¸æ˜¯ PhoneWindowï¼‰</p>
<ul>
<li>
<p>Activity è°ƒç”¨ <code>getWindow()</code> å¾—åˆ°çš„å°±æ˜¯å®ƒï¼›</p>
</li>
<li>
<p>ä»£è¡¨çš„æ˜¯å½“å‰ Activity çš„â€œçª—å£æŠ½è±¡â€ï¼Œè´Ÿè´£ç®¡ç†ï¼š</p>
<ul>
<li>æ ‡é¢˜æ ã€çŠ¶æ€æ å ä½ã€å¯¼èˆªæ åŒºåŸŸï¼ˆéœ€è¦æ—¶ï¼‰ï¼›</li>
<li>å†…å®¹è§†å›¾ï¼ˆ<code>setContentView()</code> å¡è¿›å»çš„ View æ ‘ï¼‰ã€‚</li>
</ul>
</li>
</ul>
</li>
<li>
<p>WindowManager</p>
<ul>
<li>æ˜¯ä¸€ä¸ª æ¥å£ï¼Œåº”ç”¨é€šè¿‡å®ƒ æ·»åŠ /æ›´æ–°/åˆ é™¤ Windowï¼›</li>
<li>åœ¨åº”ç”¨è¿›ç¨‹ä¸­ï¼Œ<code>WindowManager</code> çš„å®ç°æ˜¯ <code>WindowManagerImpl</code>ï¼›</li>
<li>å†…éƒ¨æœ€ç»ˆä¼šé€šè¿‡ Binder è·Ÿç³»ç»Ÿè¿›ç¨‹çš„ WindowManagerService (WMS) é€šä¿¡ã€‚</li>
</ul>
</li>
</ul>
<ol start="3">
<li>
<h3 data-id="heading-4">DecorView</h3>
</li>
</ol>
<ul>
<li>
<p>DecorView æ˜¯ æ•´ä¸ªçª—å£çš„æ ¹ Viewï¼Œæ˜¯ä¸€ä¸ª ç‰¹æ®Šçš„ ViewGroupï¼š</p>
<ul>
<li>é¡¶å±‚æ˜¯çª—å£è£…é¥°ï¼ˆçŠ¶æ€æ å ä½ã€æ ‡é¢˜æ ã€ActionBar ç­‰ï¼‰ï¼›</li>
<li>ä¸­é—´æ˜¯å†…å®¹åŒºåŸŸï¼š<code>android.R.id.content</code> å¯¹åº”çš„åŒºåŸŸï¼›</li>
<li>Activity çš„ <code>setContentView(layout)</code> å®é™…ä¸Šæ˜¯æŠŠä½ çš„å¸ƒå±€æ·»åŠ åˆ° DecorView çš„å†…å®¹åŒºåŸŸã€‚</li>
</ul>
</li>
<li>
<p>ç»“æ„ç¤ºæ„ï¼š</p>
</li>
</ul>
<pre><code class="hljs language-scss" lang="scss">DecorView (extends FrameLayout)
    â”œâ”€ StatusBar å ä½ï¼ˆå¯é€‰ï¼‰
    â”œâ”€ TitleBar / Toolbarï¼ˆå¯é€‰ï¼‰
    â””â”€ contentParent (id=android.R.id.content)
          â””â”€ ä½ çš„å¸ƒå±€æ ¹ ViewGroup (LinearLayout / ConstraintLayout / ...)
                â””â”€ å­ View / ViewGroup ...
</code></pre>
<ol start="4">
<li>
<h3 data-id="heading-5">View &amp; ViewGroup</h3>
</li>
</ol>
<ul>
<li>
<p>View</p>
<ul>
<li>
<p>UI çš„æœ€å°å•å…ƒï¼šTextViewã€Buttonã€ImageView ç­‰éƒ½ç»§æ‰¿è‡ªå®ƒï¼›</p>
</li>
<li>
<p>è´Ÿè´£ï¼š</p>
<ul>
<li>æµ‹é‡ï¼š<code>onMeasure()</code>ï¼›</li>
<li>å¸ƒå±€ä½ç½®ï¼ˆç”±çˆ¶å¸ƒå±€å†³å®šï¼‰ï¼š<code>onLayout()</code>ï¼›</li>
<li>ç»˜åˆ¶ï¼š<code>onDraw(Canvas canvas)</code>ã€‚</li>
</ul>
</li>
</ul>
</li>
</ul>
<ol start="5">
<li>
<h3 data-id="heading-6">ViewGroup</h3>
</li>
</ol>
<ul>
<li>
<p>ç»§æ‰¿è‡ª Viewï¼Œæ˜¯å„ç§å¸ƒå±€å®¹å™¨çš„åŸºç±»ï¼ˆLinearLayoutã€RelativeLayoutã€ConstraintLayout ç­‰ï¼‰ï¼›</p>
</li>
<li>
<p>è´Ÿè´£ï¼š</p>
<ul>
<li>ç®¡ç†å­ View çš„æ·»åŠ /åˆ é™¤ï¼›</li>
<li>åœ¨ <code>onLayout()</code> ä¸­æ’åˆ—å­ View</li>
</ul>
</li>
</ul>
<h2 data-id="heading-7">ä¸‰ã€ViewRootImplï¼šJava View ä¸–ç•Œ â†” Window/Surface ä¸–ç•Œçš„æ¡¥æ¢</h2>
<p>æ ¸å¿ƒï¼šViewRootImpl æŠŠ View æ ‘ç»‘å®šåˆ°ä¸€ä¸ª Window/Surface ä¸Šï¼Œå¹¶é©±åŠ¨ measure/layout/drawã€‚</p>
<ol>
<li>
<h3 data-id="heading-8">ViewRootImpl æ˜¯è°åˆ›å»ºçš„ï¼Ÿ</h3>
</li>
</ol>
<ul>
<li>
<p>å½“ Activity ç¬¬ä¸€æ¬¡ <code>setContentView()</code>ï¼Œå¹¶é€šè¿‡ <code>WindowManager.addView(DecorView, params)</code> æ—¶ï¼š</p>
<ul>
<li><code>WindowManagerGlobal</code> ä¼šä¸ºè¿™ä¸ª DecorView åˆ›å»ºä¸€ä¸ª ViewRootImpl å®ä¾‹ï¼›</li>
<li>å¹¶æŠŠ DecorView ä½œä¸º ViewRootImpl çš„â€œæ ¹ Viewâ€ã€‚</li>
</ul>
</li>
</ul>
<ol start="2">
<li>
<h3 data-id="heading-9">ViewRootImpl çš„èŒè´£</h3>
</li>
</ol>
<ul>
<li>
<p>æ¥æ”¶æ¥è‡ª WMS çš„å›è°ƒï¼ˆæ¯”å¦‚çª—å£å°ºå¯¸æ”¹å˜ã€å¯è§æ€§æ”¹å˜ç­‰ï¼‰ï¼›</p>
</li>
<li>
<p>åœ¨ UI çº¿ç¨‹ä¸Šé©±åŠ¨ View æ ‘çš„ä¸‰å¤§æµç¨‹ï¼š</p>
<ul>
<li>
<p><code>performTraversals()</code>ï¼š</p>
<ul>
<li><code>performMeasure()</code> â†’ æ ¹ View çš„ <code>onMeasure()</code> é“¾ï¼›</li>
<li><code>performLayout()</code> â†’ æ ¹ View çš„ <code>onLayout()</code> é“¾ï¼›</li>
<li><code>performDraw()</code> â†’ æ ¹ View çš„ <code>draw()</code> é“¾ã€‚</li>
</ul>
</li>
</ul>
</li>
<li>
<p>ç®¡ç†ä¸ Surface çš„ç»‘å®šï¼ˆé€šè¿‡ <code>SurfaceHolder</code>/<code>Surface</code>ï¼Œä¸åº•å±‚ BufferQueue å¯¹æ¥ï¼‰ï¼›</p>
</li>
<li>
<p>æŠŠ <code>invalidate()</code> / <code>requestLayout()</code> äº§ç”Ÿçš„é‡ç»˜/é‡å¸ƒå±€è¯·æ±‚å½’ä¸€ï¼Œåœ¨åˆé€‚çš„ VSync æ—¶æœºåˆ·æ–°ã€‚</p>
</li>
</ul>
<ol start="3">
<li>
<h3 data-id="heading-10">ViewRootImplã€Windowã€WMS çš„å…³ç³»å›¾</h3>
</li>
</ol>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-selector-attr">[ Activity ]</span>
    â””â”€ <span class="hljs-selector-attr">[ Window (PhoneWindow) ]</span>
            â””â”€ <span class="hljs-selector-attr">[ DecorView (æ ¹ ViewGroup) ]</span>

<span class="hljs-selector-attr">[ WindowManagerImpl ]</span>  (app è¿›ç¨‹)
    â””â”€ <span class="hljs-built_in">addView</span>(DecorView, params)
         â””â”€ <span class="hljs-selector-attr">[ ViewRootImpl ]</span> â†â†’ <span class="hljs-selector-attr">[ WMS (ç³»ç»Ÿè¿›ç¨‹) ]</span>
              â””â”€ æŒæœ‰ DecorView ä½œä¸º mView
              â””â”€ æŒæœ‰ Surface (mSurface)
              â””â”€ è´Ÿè´£ measure/layout/draw
</code></pre>
<h2 data-id="heading-11">å››ã€WindowManagerServiceï¼ˆWMSï¼‰ï¼šç³»ç»Ÿçº§çš„çª—å£ç®¡ç†è€…</h2>
<ul>
<li>
<p>è¿è¡Œåœ¨ System Server è¿›ç¨‹ï¼›</p>
</li>
<li>
<p>ç®¡ç†æ•´ä¸ªç³»ç»Ÿæ‰€æœ‰çª—å£ï¼ˆåº”ç”¨ Windowã€ç³»ç»Ÿæ ã€Dialog ç­‰ï¼‰çš„ï¼š</p>
<ul>
<li>Z è½´é¡ºåºï¼ˆè°åœ¨ä¸Šè°åœ¨ä¸‹ï¼‰ï¼›</li>
<li>å°ºå¯¸/ä½ç½®/å¯è§æ€§ï¼›</li>
<li>ç„¦ç‚¹ã€è¾“å…¥äº‹ä»¶ç›®æ ‡çª—å£ç­‰ã€‚</li>
</ul>
</li>
<li>
<p><code>WindowManager</code>ï¼ˆåº”ç”¨ä¾§ï¼‰æ‰€æœ‰æ“ä½œæœ€ç»ˆéƒ½ä¼šé€šè¿‡ Binder è°ƒç”¨ WMSï¼Œä¾‹å¦‚ï¼š</p>
<ul>
<li><code>addView(...)</code> â†’ <code>WMS.addWindow(...)</code>ï¼›</li>
<li><code>updateViewLayout(...)</code> â†’ <code>WMS.relayoutWindow(...)</code>ï¼›</li>
<li><code>removeView(...)</code> â†’ <code>WMS.removeWindow(...)</code>ã€‚</li>
</ul>
</li>
<li>
<p>WMS å†³å®šæ¯ä¸ª Window æ‹¥æœ‰ä¸€ä¸ªä»€ä¹ˆæ ·çš„ Surfaceï¼ˆå¤§å°ã€æ ¼å¼ç­‰ï¼‰ï¼Œç„¶åé€šçŸ¥å¯¹åº”çš„ ViewRootImpl è¿›è¡Œæ¸²æŸ“ã€‚</p>
</li>
</ul>
<h2 data-id="heading-12">äº”ã€Surface / Canvas / SurfaceViewï¼šå›¾åƒè¾“å‡ºçš„â€œç»ˆç«¯â€</h2>
<ol>
<li>
<h3 data-id="heading-13">Surfaceï¼šæ˜¾ç¤ºçš„â€œç”»å¸ƒç¼“å†²ç®¡é“â€--æ•°æ®é©±åŠ¨ï¼Œä»¥ç”»å¸ƒæ•°æ®ä¸ºä¸­å¿ƒï¼Œæ‰¿ä¸Šå¯ä¸‹äº†</h3>
</li>
</ol>
<ul>
<li>
<p>Surface æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªä¸åº•å±‚ BufferQueue ç»‘å®šçš„å¯¹è±¡ï¼š</p>
<ul>
<li>ä¸Šå±‚ï¼ˆåº”ç”¨ / RenderThread / SurfaceView çš„ç»˜åˆ¶çº¿ç¨‹ï¼‰ä½œä¸º Producer å¾€é‡Œå†™å›¾åƒï¼›</li>
<li>ä¸‹å±‚ï¼ˆSurfaceFlingerï¼‰ä½œä¸º Consumer ä»ä¸­å–å›¾åƒåšåˆæˆã€‚</li>
</ul>
</li>
<li>
<p>æ¯ä¸ªçª—å£é€šå¸¸å¯¹åº”ä¸€ä¸ª Surfaceï¼š</p>
<ul>
<li>ViewRootImpl é€šè¿‡ <code>mSurface</code> æŠŠ View çš„ç»˜åˆ¶ç»“æœè¾“å‡ºåˆ°è¿™ä¸ª Surfaceã€‚</li>
</ul>
</li>
</ul>
<ol start="2">
<li>
<h3 data-id="heading-14">Canvasï¼šæä¾›ç»™ View ä½¿ç”¨çš„äºŒç»´ç»˜å›¾æ¥å£</h3>
</li>
</ol>
<ul>
<li>
<p>åœ¨ <code>View#onDraw(Canvas canvas)</code> é‡Œä½¿ç”¨ï¼›</p>
</li>
<li>
<p>Canvas åº•å±‚å…¶å®æ˜¯ è°ƒç”¨ Skiaï¼š</p>
<ul>
<li>è½¯ä»¶æ¸²æŸ“ï¼šSkia åœ¨ CPU å†…å­˜é‡Œç”»ï¼›</li>
<li>ç¡¬ä»¶åŠ é€Ÿï¼šSkia ç”Ÿæˆ GPU ç»˜å›¾æŒ‡ä»¤ï¼ˆæœ€ç»ˆé€šè¿‡ OpenGL ES/Vulkan æ‰§è¡Œï¼‰ã€‚</li>
</ul>
</li>
</ul>
<ol start="3">
<li>
<h3 data-id="heading-15">SurfaceViewï¼šä¸€ä¸ªâ€œç‰¹æ®Šçš„ Viewâ€ï¼Œè‡ªå·±æœ‰ç‹¬ç«‹ Surface</h3>
</li>
</ol>
<ul>
<li>
<p>æ™®é€š Viewï¼š</p>
<ul>
<li>æœ€ç»ˆéƒ½ç»˜åˆ¶åˆ°æ‰€åœ¨çª—å£çš„ åŒä¸€ä¸ª Surfaceï¼›</li>
<li>å…ˆç”± UI æ¸²æŸ“ç”Ÿæˆä¸€ä¸ªå±‚ï¼Œä¹‹åç”± SurfaceFlinger åˆæˆã€‚</li>
</ul>
</li>
<li>
<p>SurfaceViewï¼š</p>
<ul>
<li>
<p>å†…éƒ¨ä¼šåˆ›å»ºä¸€ä¸ª ç‹¬ç«‹çš„ Surfaceï¼ˆé€šå¸¸æ˜¯ç›´æ¥ç”±ç³»ç»Ÿåˆæˆåˆ°å±å¹•ï¼Œæ”¯æŒè§†é¢‘ã€æ¸¸æˆç­‰é«˜æ€§èƒ½åœºæ™¯ï¼‰ï¼›</p>
</li>
<li>
<p>å…¶å­ View æ˜¾ç¤ºåŒºåŸŸåªæ˜¯ä¸€ä¸ªâ€œæ´â€ï¼š</p>
<ul>
<li>Window çš„ä¸» Surface æŒ–ä¸€ä¸ªé€æ˜åŒºåŸŸï¼›</li>
<li>SurfaceView ä¸“ç”¨çš„ Surface æ˜¾ç¤ºåœ¨è¿™ä¸ªæ´é‡Œã€‚</li>
</ul>
</li>
</ul>
</li>
<li>
<p>ç‰¹ç‚¹ï¼š</p>
<ul>
<li>æ”¯æŒ å•ç‹¬çš„ç»˜åˆ¶çº¿ç¨‹ï¼ˆåå°çº¿ç¨‹ï¼‰ï¼Œä¸å ç”¨ UI çº¿ç¨‹ï¼›</li>
<li>å¸¸ç”¨äºï¼šè§†é¢‘æ’­æ”¾ã€ç›¸æœºé¢„è§ˆã€éœ€è¦è‡ªå®šä¹‰æ¸²æŸ“çš„æ¸¸æˆã€‚</li>
</ul>
</li>
</ul>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-selector-attr">[ Window çš„ä¸» Surface ]</span>      <span class="hljs-selector-attr">[ SurfaceView ä¸“ç”¨ Surface ]</span>
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ å…¶ä»–æ™®é€š View ç»˜åˆ¶ â”‚       â”‚   è§†é¢‘/æ¸¸æˆå†…å®¹    â”‚
    â”‚   (UI çº¿ç¨‹ç»˜åˆ¶)   â”‚       â”‚ (æ¸²æŸ“çº¿ç¨‹ç»˜åˆ¶)     â”‚
    â”‚  <span class="hljs-selector-attr">[æŒ–ä¸€ä¸ªæ´åŒºåŸŸ]</span>   â”‚â—€â”€â”€â”€â”€â”€â–¶â”‚ å¯¹åº”å±å¹•æŸå—åŒºåŸŸ   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre>
<h2 data-id="heading-16">å…­ã€æ¶ˆæ¯ã€èŠ‚å¥ä¸åŠ¨ç”»ï¼šHandler / Choreographer / VSync</h2>
<ol>
<li>
<h3 data-id="heading-17">Handlerï¼šUI çº¿ç¨‹çš„æ¶ˆæ¯é©±åŠ¨æœºåˆ¶</h3>
</li>
</ol>
<ul>
<li>
<p>UI çº¿ç¨‹æœ‰ä¸€ä¸ª Looper + MessageQueueï¼š</p>
<ul>
<li>Handler æ˜¯å‘é€/å¤„ç†æ¶ˆæ¯çš„å·¥å…·ï¼›</li>
</ul>
</li>
<li>
<p>ViewRootImpl çš„å¾ˆå¤šæ“ä½œéƒ½æ˜¯é€šè¿‡ Handler æŠ•é€’åˆ° UI çº¿ç¨‹æ‰§è¡Œï¼š</p>
<ul>
<li>æ¯”å¦‚ <code>requestLayout()</code> / <code>invalidate()</code> æœ€ç»ˆä¼šæ’é˜Ÿä¸€ä¸ªâ€œé‡æ–°æµ‹é‡/å¸ƒå±€/ç»˜åˆ¶â€çš„æ¶ˆæ¯ã€‚</li>
</ul>
</li>
</ul>
<ol start="2">
<li>
<h3 data-id="heading-18">Choreographerï¼šåŸºäº VSync çš„ç»Ÿä¸€è°ƒåº¦å™¨</h3>
</li>
</ol>
<ul>
<li>
<p>Choreographer æŒ‚åœ¨ UI çº¿ç¨‹ä¸Šï¼Œä½¿ç”¨ Handler é©±åŠ¨ï¼›</p>
</li>
<li>
<p>æ¯æ¬¡å±å¹•å‘å‡ºä¸€å¸§ VSync ä¿¡å· æ—¶ï¼š</p>
<ul>
<li>
<p>Choreographer æ”¶åˆ°å›è°ƒï¼Œåœ¨ åŒä¸€ä¸ª frame å†…æŒ‰é¡ºåºè§¦å‘ï¼š</p>
<ul>
<li>è¾“å…¥å¤„ç†ï¼ˆInputï¼‰ï¼›</li>
<li>åŠ¨ç”»ï¼ˆAnimationï¼‰ï¼›</li>
<li>View æ ‘ç»˜åˆ¶ï¼ˆTraversal â†’ ViewRootImpl#doTraversalï¼‰ã€‚</li>
</ul>
</li>
</ul>
</li>
<li>
<p>ä½œç”¨ï¼šä¿è¯ UI ç»˜åˆ¶å’ŒåŠ¨ç”»è·Ÿå±å¹•åˆ·æ–°åŒæ­¥ï¼Œå‡å°‘æ’•è£‚ä¸æŠ–åŠ¨ã€‚</p>
</li>
</ul>
<ol start="3">
<li>
<h3 data-id="heading-19">ä¸‰è€…å…³ç³»å›¾ï¼ˆUI çº¿ç¨‹ä¸Šï¼‰ï¼š</h3>
</li>
</ol>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-selector-attr">[VSync ä¿¡å·]</span> â”€â”€â–º <span class="hljs-selector-attr">[Choreographer#doFrame()]</span>
                      â”‚
                      â”œâ”€ å¤„ç†è¾“å…¥äº‹ä»¶
                      â”œâ”€ è®¡ç®—åŠ¨ç”» (ValueAnimator, ViewPropertyAnimator...)
                      â””â”€ è°ƒç”¨ ViewRootImpl<span class="hljs-selector-class">.scheduleTraversals</span>()
                               â”‚
                               â””â”€ Handler<span class="hljs-selector-class">.post</span>(...) -&gt; <span class="hljs-built_in">doTraversal</span>()
                                       â”œâ”€ <span class="hljs-built_in">measure</span>()
                                       â”œâ”€ <span class="hljs-built_in">layout</span>()
                                       â””â”€ <span class="hljs-built_in">draw</span>()  (ç”Ÿæˆç»˜åˆ¶å‘½ä»¤ / DisplayList)
</code></pre>
<h2 data-id="heading-20">ä¸ƒã€Skia / OpenGL ESï¼šView çš„ç»˜åˆ¶åˆ°åº•æ˜¯æ€ä¹ˆç”»å‡ºæ¥çš„ï¼Ÿ</h2>
<ol>
<li>
<h3 data-id="heading-21">Skiaï¼š2D å›¾å½¢å¼•æ“</h3>
</li>
</ol>
<ul>
<li>
<p>Android ä¸­ <code>Canvas</code> çš„çœŸæ­£æ‰§è¡Œè€…ï¼›</p>
</li>
<li>
<p>æä¾›ï¼š</p>
<ul>
<li>ç”»çº¿ã€ç”»çŸ©å½¢ã€ç”»åœ†ã€ç”»æ–‡æœ¬ï¼›</li>
<li>ç”» Bitmapã€è£å‰ªã€å˜æ¢ç­‰ï¼›</li>
</ul>
</li>
<li>
<p>åœ¨ Android çš„ ç¡¬ä»¶åŠ é€Ÿ UI ç®¡çº¿ï¼ˆHWUIï¼‰ ä¸­ï¼š</p>
<ul>
<li>Skia ä¸ä¼šç›´æ¥åœ¨ CPU å†…å­˜ç”»åƒç´ ï¼›</li>
<li>è€Œæ˜¯æŠŠç»˜åˆ¶æ“ä½œè½¬æ¢ä¸º GPU å‘½ä»¤ï¼Œäº¤ç»™ OpenGL ES/Vulkan æ‰§è¡Œã€‚</li>
</ul>
</li>
</ul>
<ol start="2">
<li>
<h3 data-id="heading-22">OpenGL ESï¼šä¸ GPU å¯¹è¯çš„ API</h3>
</li>
</ol>
<ul>
<li>
<p>å›¾å½¢ç¡¬ä»¶æ ‡å‡†æ¥å£ï¼›</p>
</li>
<li>
<p>åœ¨ Android ä¸­ï¼š</p>
<ul>
<li>
<p>Skia ä¼šè°ƒç”¨ OpenGL ESï¼Œå®ç°ï¼š</p>
<ul>
<li>å‡ ä½•å˜æ¢ï¼ˆå¹³ç§»/ç¼©æ”¾/æ—‹è½¬ï¼‰ï¼›</li>
<li>çº¹ç†ç»˜åˆ¶ï¼ˆView å†…å®¹ä½œä¸ºçº¹ç†è´´åœ¨çŸ©å½¢ä¸Šï¼‰ï¼›</li>
<li>alpha æ··åˆã€é˜´å½±ã€åœ†è§’ç­‰æ•ˆæœã€‚</li>
</ul>
</li>
</ul>
</li>
<li>
<p>GLSurfaceView / æ¸¸æˆå¼•æ“ ç­‰ä¹Ÿä¼šç›´æ¥ä½¿ç”¨ OpenGL ES ç»˜åˆ¶è‡ªå·±çš„å†…å®¹åˆ° Surfaceã€‚</p>
</li>
</ul>
<ol start="3">
<li>
<h3 data-id="heading-23">View ç»˜åˆ¶è°ƒç”¨é“¾ï¼ˆç¡¬ä»¶åŠ é€Ÿæ—¶ï¼Œç®€åŒ–ç‰ˆï¼‰</h3>
</li>
</ol>
<pre><code class="hljs language-scss" lang="scss">ViewRootImpl<span class="hljs-selector-class">.performDraw</span>()
    â””â”€ DecorView<span class="hljs-selector-class">.draw</span>(canvas)
         â””â”€ å„ View çš„ <span class="hljs-built_in">onDraw</span>(canvas)
               â””â”€ è°ƒç”¨ <span class="hljs-selector-tag">Canvas</span> API (drawRect/drawText/drawBitmap...)
                     â””â”€ <span class="hljs-selector-tag">Canvas</span> â†’ Skia
                           â””â”€ Skia ç”Ÿæˆ GPU å‘½ä»¤
                               â””â”€ é€šè¿‡ OpenGL ES / Vulkan è°ƒç”¨ GPU
                                   â””â”€ GPU åœ¨ Surface å¯¹åº”çš„ buffer ä¸­ç”Ÿæˆæœ€ç»ˆåƒç´ 
</code></pre>
<h2 data-id="heading-24">å…«ã€ç»¼åˆå…³ç³»å¤§å›¾ï¼ˆç®€åŒ–ç‰ˆï¼‰</h2>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-attr">[ Activity ]</span>
    â””â”€ æŒæœ‰ <span class="hljs-selector-attr">[Window (PhoneWindow)]</span>
            â””â”€ <span class="hljs-selector-attr">[DecorView: æ ¹ ViewGroup]</span>
                    â””â”€ <span class="hljs-selector-tag">ViewGroup</span> / <span class="hljs-selector-tag">View</span> æ ‘
                          â””â”€ <span class="hljs-selector-tag">onDraw</span>(Canvas) â†’ <span class="hljs-selector-tag">Canvas</span> â†’ <span class="hljs-selector-tag">Skia</span> â†’ <span class="hljs-selector-tag">OpenGL</span> <span class="hljs-selector-tag">ES</span>

<span class="hljs-selector-attr">[ WindowManager ]</span>
    â””â”€ <span class="hljs-selector-tag">addView</span>(DecorView, params)
          â””â”€ åˆ›å»º <span class="hljs-selector-attr">[ViewRootImpl]</span>
                â”œâ”€ æŒæœ‰ <span class="hljs-selector-tag">DecorView</span>
                â”œâ”€ æŒæœ‰ <span class="hljs-selector-tag">Surface</span>
                â”œâ”€ é€šè¿‡ <span class="hljs-selector-tag">Handler</span> åœ¨ <span class="hljs-selector-tag">UI</span> çº¿ç¨‹ <span class="hljs-selector-tag">scheduleTraversals</span>()
                â””â”€ å’Œ <span class="hljs-selector-attr">[WMS]</span> é€šä¿¡ï¼ˆçª—å£å¤§å°/ä½ç½®/<span class="hljs-selector-tag">Surface</span> ç­‰ï¼‰

<span class="hljs-selector-attr">[ Handler / Looper / Choreographer ]</span>
    â”œâ”€ <span class="hljs-selector-tag">Looper</span> è´Ÿè´£ <span class="hljs-selector-tag">UI</span> çº¿ç¨‹æ¶ˆæ¯å¾ªç¯
    â”œâ”€ <span class="hljs-selector-tag">Handler</span> æŠ•é€’ <span class="hljs-selector-tag">measure</span>/<span class="hljs-selector-tag">layout</span>/<span class="hljs-selector-tag">draw</span> ç­‰æ¶ˆæ¯
    â””â”€ <span class="hljs-selector-tag">Choreographer</span> ä½¿ç”¨ <span class="hljs-selector-tag">VSync</span> å›è°ƒç»Ÿä¸€é©±åŠ¨:
           <span class="hljs-selector-tag">Input</span> â†’ <span class="hljs-selector-tag">Animation</span> â†’ <span class="hljs-selector-tag">Traversal</span> (ViewRootImpl.doTraversal)

<span class="hljs-selector-attr">[ WMS (WindowManagerService) ]</span>
    â””â”€ ç®¡ç†æ‰€æœ‰ <span class="hljs-selector-tag">Window</span>
    â””â”€ ä¸º <span class="hljs-selector-tag">Window</span> åˆ†é… <span class="hljs-selector-tag">Surface</span>
    â””â”€ å‘Šè¯‰ <span class="hljs-selector-tag">app</span> ç«¯ <span class="hljs-selector-tag">ViewRootImpl</span> çª—å£å˜åŒ–ç­‰ä¿¡æ¯

<span class="hljs-selector-attr">[ Surface / SurfaceView ]</span>
    â”œâ”€ <span class="hljs-selector-tag">Surface</span>: ä¸ <span class="hljs-selector-tag">BufferQueue</span> ç›¸è¿ï¼Œ<span class="hljs-selector-tag">ViewRootImpl</span>/<span class="hljs-selector-tag">RenderThread</span> æ¸²æŸ“ç›®æ ‡
    â””â”€ <span class="hljs-selector-tag">SurfaceView</span>: ç‰¹æ®Š <span class="hljs-selector-tag">View</span>ï¼Œè‡ªæœ‰ <span class="hljs-selector-tag">Surface</span>ï¼Œå¯ç”±å•ç‹¬çº¿ç¨‹/<span class="hljs-selector-tag">GL</span> æ¸²æŸ“

<span class="hljs-selector-attr">[ Skia / OpenGL ES ]</span>
    â”œâ”€ <span class="hljs-selector-tag">Skia</span>: <span class="hljs-selector-tag">Canvas</span> çš„å®ç°ï¼Œç”Ÿæˆç»˜åˆ¶å‘½ä»¤
    â””â”€ <span class="hljs-selector-tag">OpenGL</span> <span class="hljs-selector-tag">ES</span>: äº¤ç»™ <span class="hljs-selector-tag">GPU</span> æ‰§è¡Œç»˜å›¾ï¼Œç¡¬ä»¶åŠ é€Ÿè·¯å¾„
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android å››å¤§ç»„ä»¶ä¸ AMS äº¤äº’çš„å®Œæ•´å¯¹æ¯”]]></title>    <link>https://juejin.cn/post/7585463258690224137</link>    <guid>https://juejin.cn/post/7585463258690224137</guid>    <pubDate>2025-12-20T04:15:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585463258690224137" data-draft-id="7585227038992269350" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android å››å¤§ç»„ä»¶ä¸ AMS äº¤äº’çš„å®Œæ•´å¯¹æ¯”"/> <meta itemprop="keywords" content="é¢è¯•"/> <meta itemprop="datePublished" content="2025-12-20T04:15:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="æ‡’çŒ«çˆ±ä¸Šé±¼"/> <meta itemprop="url" content="https://juejin.cn/user/325111174151821"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="æ˜é‡‘"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android å››å¤§ç»„ä»¶ä¸ AMS äº¤äº’çš„å®Œæ•´å¯¹æ¯”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/325111174151821/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    æ‡’çŒ«çˆ±ä¸Šé±¼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T04:15:20.000Z" title="Sat Dec 20 2025 04:15:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    é˜…è¯»7åˆ†é’Ÿ
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">å¼•è¨€</h2>
<p>Android ç³»ç»Ÿé€šè¿‡ ActivityManagerServiceï¼ˆAMSï¼‰ç»Ÿä¸€ç®¡ç†å››å¤§ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸå’Œäº¤äº’ã€‚è™½ç„¶éƒ½æ˜¯é€šè¿‡ Binder ä¸ AMS é€šä¿¡ï¼Œä½†å››å¤§ç»„ä»¶åœ¨äº¤äº’æ–¹å¼ã€ç”Ÿå‘½å‘¨æœŸç®¡ç†ã€è¿›ç¨‹ä¼˜å…ˆçº§ç­‰æ–¹é¢å­˜åœ¨æ˜¾è‘—å·®å¼‚ã€‚æœ¬æ–‡å°†åˆ†æè¿™äº›å·®å¼‚ï¼Œå¸®åŠ©å¼€å‘è€…æ›´å¥½åœ°ç†è§£ Android ç³»ç»Ÿæ¶æ„ã€‚</p>
<h2 data-id="heading-1">å››å¤§ç»„ä»¶ä¸ AMS äº¤äº’å¯¹æ¯”è¡¨</h2>


















































<table><thead><tr><th>ç»„ä»¶</th><th>å¯åŠ¨/æ³¨å†Œæ¨¡å¼</th><th>AMSæ•°æ®ç»“æ„</th><th>ç”Ÿå‘½å‘¨æœŸç®¡ç†</th><th>è¿›ç¨‹äº¤äº’</th><th>ä¼˜å…ˆçº§ç®¡ç†</th><th>ä¸»è¦ç‰¹ç‚¹</th></tr></thead><tbody><tr><td>Activity</td><td>æ˜¾å¼/éšå¼ Intent</td><td>ActivityStack/Task/ActivityRecord</td><td>æ ˆå¼ç®¡ç†ï¼ŒAMS ä¸¥æ ¼æ§åˆ¶çŠ¶æ€è½¬æ¢</td><td>å¼ºç»‘å®šï¼Œæ¯ä¸ªçŠ¶æ€å˜åŒ–éƒ½é€šçŸ¥ AMS</td><td>å‰å°/å¯è§è¿›ç¨‹ï¼Œç”±ä»»åŠ¡æ ˆä½ç½®å†³å®š</td><td>ç”¨æˆ·äº¤äº’ç•Œé¢ï¼ŒAMS ç®¡ç†çª—å£ã€è¾“å…¥ç„¦ç‚¹</td></tr><tr><td>Service</td><td>startService()/bindService()</td><td>ServiceRecord/ConnectionRecord</td><td>å¯åŠ¨/ç»‘å®šä¸¤å¥—ç”Ÿå‘½å‘¨æœŸï¼ŒAMS åè°ƒè¿›ç¨‹ä¼˜å…ˆçº§</td><td>å¯åŠ¨/åœæ­¢/ç»‘å®š/è§£ç»‘æ—¶äº¤äº’</td><td>åŠ¨æ€å˜åŒ–ï¼ˆå‰å°/å¯è§/æœåŠ¡è¿›ç¨‹ï¼‰</td><td>åå°æ‰§è¡Œï¼ŒAMS ç®¡ç†è¿›ç¨‹ä¿æ´»å’Œç»‘å®šå…³ç³»</td></tr><tr><td>BroadcastReceiver</td><td>é™æ€æ³¨å†Œ/åŠ¨æ€æ³¨å†Œ</td><td>BroadcastQueue/ReceiverList/BroadcastRecord</td><td>ç¬æ—¶æ‰§è¡Œï¼Œæ— æŒä¹…çŠ¶æ€ï¼ŒAMS ç®¡ç†åˆ†å‘é˜Ÿåˆ—</td><td>å‘é€/æ¥æ”¶æ—¶äº¤äº’ï¼Œæ‰§è¡Œå®Œå³ç»“æŸ</td><td>æ— ç‹¬ç«‹ä¼˜å…ˆçº§ï¼Œä¾èµ–å®¿ä¸»è¿›ç¨‹</td><td>äº‹ä»¶é©±åŠ¨ï¼ŒAMS å¤„ç†æƒé™å’Œæœ‰åºåˆ†å‘</td></tr><tr><td>ContentProvider</td><td>è‡ªåŠ¨å‘å¸ƒ</td><td>ProviderMap/ContentProviderRecord</td><td>æŒä¹…å­˜åœ¨ï¼Œä¸åº”ç”¨è¿›ç¨‹åŒç”Ÿå‘½å‘¨æœŸ</td><td>æŸ¥è¯¢/æ’å…¥/æ›´æ–°/åˆ é™¤æ—¶äº¤äº’</td><td>ä¾èµ–å®¿ä¸»è¿›ç¨‹ï¼Œä½† AMS ç®¡ç†è®¿é—®æƒé™</td><td>æ•°æ®å…±äº«ï¼ŒAMS è·¯ç”± URI å’Œæƒé™æ§åˆ¶</td></tr></tbody></table>
<h2 data-id="heading-2">è¯¦ç»†äº¤äº’æœºåˆ¶åˆ†æ</h2>
<h3 data-id="heading-3">1. Activity ä¸ AMS äº¤äº’</h3>
<p><strong>æ ¸å¿ƒäº¤äº’æµç¨‹</strong></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// å¯åŠ¨æµç¨‹</span>
åº”ç”¨è¿›ç¨‹ â†’ <span class="hljs-attr">AMS</span>: <span class="hljs-title function_">startActivity</span>(intent)  <span class="hljs-comment">// å¯åŠ¨è¯·æ±‚</span>
<span class="hljs-variable constant_">AMS</span> â†’ åº”ç”¨è¿›ç¨‹: <span class="hljs-title function_">scheduleLaunchActivity</span>()  <span class="hljs-comment">// è°ƒåº¦å¯åŠ¨</span>
åº”ç”¨è¿›ç¨‹ â†’ <span class="hljs-attr">AMS</span>: <span class="hljs-title function_">activityPaused</span>()  <span class="hljs-comment">// çŠ¶æ€åŒæ­¥</span>
<span class="hljs-variable constant_">AMS</span> â†’ å…¶ä»–åº”ç”¨è¿›ç¨‹: <span class="hljs-title function_">schedulePauseActivity</span>()  <span class="hljs-comment">// æš‚åœå…¶ä»–Activity</span>
<span class="hljs-variable constant_">AMS</span> â†’ åº”ç”¨è¿›ç¨‹: <span class="hljs-title function_">scheduleResumeActivity</span>()  <span class="hljs-comment">// æ¢å¤å½“å‰Activity</span>
</code></pre>
<p><strong>AMS ç®¡ç†è¦ç‚¹ï¼š</strong></p>
<ul>
<li>ç»´æŠ¤ ActivityStack å’Œ Task çš„ä»»åŠ¡æ ˆç»“æ„</li>
<li>æ§åˆ¶ Back Stack å›é€€é€»è¾‘</li>
<li>ç®¡ç† Activity çš„å¯åŠ¨æ¨¡å¼ï¼ˆstandardã€singleTop ç­‰ï¼‰</li>
<li>å¤„ç†å¤šçª—å£æ¨¡å¼ä¸‹çš„å¯è§æ€§</li>
<li>åè°ƒ Activity è½¬åœºåŠ¨ç”»</li>
</ul>
<p><strong>è¿›ç¨‹ä¼˜å…ˆçº§ï¼š</strong> Activity æ‰€åœ¨è¿›ç¨‹ä¼˜å…ˆçº§ç”±å…¶åœ¨ä»»åŠ¡æ ˆä¸­çš„ä½ç½®å†³å®šï¼š</p>
<ul>
<li>å‰å° Activity â†’ å‰å°è¿›ç¨‹ï¼ˆadj=0ï¼‰</li>
<li>å¯è§ä½†ä¸åœ¨å‰å° â†’ å¯è§è¿›ç¨‹ï¼ˆadj=100ï¼‰</li>
<li>å®Œå…¨ä¸å¯è§ â†’ ç¼“å­˜è¿›ç¨‹ï¼ˆadj=900+ï¼‰</li>
</ul>
<h3 data-id="heading-4">2. Service ä¸ AMS äº¤äº’</h3>
<p><strong>å¯åŠ¨æœåŠ¡æµç¨‹ï¼š</strong></p>
<pre><code class="hljs language-js" lang="js">åº”ç”¨è¿›ç¨‹ â†’ <span class="hljs-attr">AMS</span>: <span class="hljs-title function_">startService</span>(intent)
<span class="hljs-variable constant_">AMS</span> â†’ åº”ç”¨è¿›ç¨‹: <span class="hljs-title function_">scheduleCreateService</span>() â†’ <span class="hljs-title function_">scheduleServiceArgs</span>()
<span class="hljs-comment">// ç»‘å®šæœåŠ¡æµç¨‹</span>
åº”ç”¨è¿›ç¨‹ â†’ <span class="hljs-attr">AMS</span>: <span class="hljs-title function_">bindService</span>(intent, conn, flags)
<span class="hljs-variable constant_">AMS</span> â†’ æœåŠ¡ç«¯è¿›ç¨‹: <span class="hljs-title function_">scheduleBindService</span>()
<span class="hljs-variable constant_">AMS</span> â†’ å®¢æˆ·ç«¯è¿›ç¨‹: è¿”å› <span class="hljs-title class_">IBinder</span>
</code></pre>
<p><strong>AMS ç®¡ç†è¦ç‚¹ï¼š</strong></p>
<ul>
<li>ç»´æŠ¤ ServiceRecord è®°å½•æœåŠ¡çŠ¶æ€</li>
<li>ç®¡ç† ConnectionRecord ç»‘å®šå…³ç³»</li>
<li>æ§åˆ¶æœåŠ¡è¿›ç¨‹çš„ä¼˜å…ˆçº§</li>
<li>å¤„ç†å‰å°æœåŠ¡é€šçŸ¥</li>
<li>åè°ƒè·¨è¿›ç¨‹æœåŠ¡ç»‘å®š</li>
</ul>
<p><strong>è¿›ç¨‹ä¼˜å…ˆçº§åŠ¨æ€å˜åŒ–ï¼š</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// AMS åŠ¨æ€è°ƒæ•´æœåŠ¡è¿›ç¨‹ä¼˜å…ˆçº§</span>
<span class="hljs-keyword">if</span> (service.isForeground) {
    <span class="hljs-comment">// å‰å°æœåŠ¡ï¼Œä¼˜å…ˆçº§æœ€é«˜</span>
    process.setAdj(ProcessList.FOREGROUND_APP_ADJ);  <span class="hljs-comment">// 0</span>
} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (process.hasVisibleActivities()) {
    <span class="hljs-comment">// ç»‘å®šåˆ°å¯è§Activityï¼Œä¼˜å…ˆçº§è¾ƒé«˜</span>
    process.setAdj(ProcessList.VISIBLE_APP_ADJ);  <span class="hljs-comment">// 100</span>
} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (process.hasServices()) {
    <span class="hljs-comment">// åªæœ‰æœåŠ¡ï¼Œæ— å¯è§ç»„ä»¶</span>
    process.setAdj(ProcessList.SERVICE_ADJ);  <span class="hljs-comment">// 500</span>
} <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// æ— æ´»è·ƒç»„ä»¶ï¼Œä¼˜å…ˆçº§æœ€ä½</span>
    process.setAdj(ProcessList.CACHED_APP_MIN_ADJ);  <span class="hljs-comment">// 900+</span>
}
</code></pre>
<h3 data-id="heading-5">3. BroadcastReceiver ä¸ AMS äº¤äº’</h3>
<p><strong>æ³¨å†Œå’Œå‘é€æµç¨‹ï¼š</strong></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// æ³¨å†Œæµç¨‹</span>
åº”ç”¨è¿›ç¨‹ â†’ <span class="hljs-attr">AMS</span>: <span class="hljs-title function_">registerReceiver</span>(receiver, filter)
<span class="hljs-comment">// å‘é€æµç¨‹</span>
åº”ç”¨è¿›ç¨‹ â†’ <span class="hljs-attr">AMS</span>: <span class="hljs-title function_">sendBroadcast</span>(intent)
<span class="hljs-variable constant_">AMS</span> â†’ æ¥æ”¶è¿›ç¨‹: <span class="hljs-title function_">scheduleReceiver</span>()  <span class="hljs-comment">// å¼‚æ­¥åˆ†å‘</span>
<span class="hljs-comment">// æ‰§è¡Œå®Œæˆå</span>
æ¥æ”¶è¿›ç¨‹ â†’ <span class="hljs-attr">AMS</span>: æ— å›è°ƒï¼Œæ‰§è¡Œå®Œå³ç»“æŸ
</code></pre>
<p><strong>AMS ç®¡ç†è¦ç‚¹ï¼š</strong></p>
<ul>
<li>ç»´æŠ¤å¹¿æ’­é˜Ÿåˆ—ï¼ˆæœ‰åº/æ— åºï¼‰</li>
<li>å¤„ç†ç²˜æ€§å¹¿æ’­ç¼“å­˜</li>
<li>æ£€æŸ¥å‘é€å’Œæ¥æ”¶æƒé™</li>
<li>æ§åˆ¶å¹¿æ’­è¶…æ—¶</li>
<li>ç®¡ç†è¿›ç¨‹ä¼˜å…ˆçº§ä¸´æ—¶æå‡</li>
</ul>
<p><strong>å¹¿æ’­æ‰§è¡Œç‰¹ç‚¹ï¼š</strong></p>
<ul>
<li>ç¬æ—¶æ‰§è¡Œï¼Œæ— ç”Ÿå‘½å‘¨æœŸçŠ¶æ€ç»´æŠ¤</li>
<li>AMS ä¸è·Ÿè¸ªæ¥æ”¶å™¨æ‰§è¡ŒçŠ¶æ€</li>
<li>å¼‚æ­¥åˆ†å‘ï¼Œå¯èƒ½å»¶è¿Ÿæˆ–ä¸¢å¼ƒ</li>
<li>å¯å¹¶è¡Œæ‰§è¡Œå¤šä¸ªæ— åºå¹¿æ’­</li>
</ul>
<h3 data-id="heading-6">4. ContentProvider ä¸ AMS äº¤äº’</h3>
<p><strong>å‘å¸ƒå’ŒæŸ¥è¯¢æµç¨‹ï¼š</strong></p>
<pre><code class="hljs language-js" lang="js">/ å‘å¸ƒæµç¨‹
åº”ç”¨è¿›ç¨‹ â†’ <span class="hljs-attr">AMS</span>: <span class="hljs-title function_">publishContentProviders</span>(providers)
<span class="hljs-comment">// æŸ¥è¯¢æµç¨‹</span>
å®¢æˆ·ç«¯è¿›ç¨‹ â†’ <span class="hljs-attr">AMS</span>: <span class="hljs-title function_">getContentProvider</span>(name)
<span class="hljs-variable constant_">AMS</span> â†’ æœåŠ¡ç«¯è¿›ç¨‹: æ— ç›´æ¥è°ƒç”¨ï¼Œè¿”å›å·²å‘å¸ƒçš„<span class="hljs-title class_">Provider</span>æ¥å£
å®¢æˆ·ç«¯è¿›ç¨‹ â†’ æœåŠ¡ç«¯è¿›ç¨‹: ç›´æ¥è°ƒç”¨<span class="hljs-title class_">IContentProvider</span>.<span class="hljs-title function_">query</span>()
</code></pre>
<p><strong>AMS ç®¡ç†è¦ç‚¹ï¼š</strong></p>
<ul>
<li>ç»´æŠ¤ ProviderMap è·¯ç”±è¡¨</li>
<li>æ£€æŸ¥è·¨è¿›ç¨‹è®¿é—®æƒé™</li>
<li>ç®¡ç† Provider å¼•ç”¨è®¡æ•°</li>
<li>å¤„ç† Provider è¿›ç¨‹æ­»äº¡</li>
<li>åè°ƒ URI æƒé™æˆæƒ</li>
</ul>
<p><strong>æ•°æ®å…±äº«æ¨¡å‹ï¼š</strong></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// AMS ä¸­çš„Providerè·¯ç”±</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ProviderMap</span> {
    <span class="hljs-comment">// authority â†’ ContentProviderRecord</span>
    <span class="hljs-title class_">ArrayMap</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">ContentProviderRecord</span>&gt; mProvidersByName;
    <span class="hljs-comment">// component â†’ ContentProviderRecord  </span>
    <span class="hljs-title class_">ArrayMap</span>&lt;<span class="hljs-title class_">ComponentName</span>, <span class="hljs-title class_">ContentProviderRecord</span>&gt; mProvidersByClass;
}

<span class="hljs-comment">// ContentProviderRecord</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ContentProviderRecord</span> {
    <span class="hljs-title class_">IContentProvider</span> provider;  <span class="hljs-comment">// çœŸæ­£çš„Provideræ¥å£</span>
    <span class="hljs-title class_">ProcessRecord</span> app;          <span class="hljs-comment">// æ‰€åœ¨è¿›ç¨‹</span>
    int externalProcessNo;      <span class="hljs-comment">// å¤–éƒ¨è¿›ç¨‹å¼•ç”¨è®¡æ•°</span>
    <span class="hljs-comment">// å½“å¼•ç”¨è®¡æ•°ä¸º0æ—¶ï¼ŒAMSå¯é€šçŸ¥è¿›ç¨‹æ¸…ç†Provider</span>
}
</code></pre>
<h2 data-id="heading-7">è·¨è¿›ç¨‹é€šä¿¡å·®å¼‚</h2>
<h3 data-id="heading-8">1. Binder é€šä¿¡é¢‘ç‡</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// Activity: é«˜é¢‘é€šä¿¡</span>
<span class="hljs-comment">// æ¯ä¸ªç”Ÿå‘½å‘¨æœŸå˜åŒ–éƒ½è¦é€šä¿¡</span>
<span class="hljs-title function_">onCreate</span>() â†” <span class="hljs-title function_">onCreate</span>() é€šçŸ¥
<span class="hljs-title function_">onStart</span>()  â†” <span class="hljs-title function_">onStart</span>() é€šçŸ¥  
<span class="hljs-title function_">onResume</span>() â†” <span class="hljs-title function_">onResume</span>() é€šçŸ¥
<span class="hljs-title function_">onPause</span>()  â†” <span class="hljs-title function_">onPause</span>() é€šçŸ¥
<span class="hljs-title function_">onStop</span>()   â†” <span class="hljs-title function_">onStop</span>() é€šçŸ¥
<span class="hljs-title function_">onDestroy</span>()â†” <span class="hljs-title function_">onDestroy</span>() é€šçŸ¥

<span class="hljs-comment">// Service: ä¸­é¢‘é€šä¿¡</span>
<span class="hljs-comment">// å¯åŠ¨/åœæ­¢/ç»‘å®š/è§£ç»‘æ—¶é€šä¿¡</span>
<span class="hljs-title function_">onCreate</span>() â†” å¯åŠ¨æ—¶é€šä¿¡
<span class="hljs-title function_">onStartCommand</span>() â†” æ¯æ¬¡å¯åŠ¨é€šä¿¡
<span class="hljs-title function_">onBind</span>() â†” ç»‘å®šæ—¶é€šä¿¡
<span class="hljs-title function_">onUnbind</span>() â†” è§£ç»‘æ—¶é€šä¿¡

<span class="hljs-comment">// Broadcast: ä½é¢‘é€šä¿¡</span>
<span class="hljs-comment">// æ³¨å†Œ/å‘é€æ—¶é€šä¿¡</span>
<span class="hljs-title function_">registerReceiver</span>() â†” æ³¨å†Œæ—¶é€šä¿¡
<span class="hljs-title function_">sendBroadcast</span>() â†” å‘é€æ—¶é€šä¿¡
<span class="hljs-comment">// onReceive() æ‰§è¡Œæ— éœ€å›è°ƒAMS</span>

<span class="hljs-comment">// ContentProvider: æŒ‰éœ€é€šä¿¡</span>
<span class="hljs-comment">// è·å–Provideræ—¶é€šä¿¡ä¸€æ¬¡</span>
<span class="hljs-title function_">getContentProvider</span>() â†” è·å–æ—¶é€šä¿¡
<span class="hljs-comment">// åç»­æ“ä½œç›´æ¥ä¸Providerè¿›ç¨‹é€šä¿¡</span>

</code></pre>
<h3 data-id="heading-9">2. æ•°æ®ä¼ è¾“é‡</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// Activity: å¤§é‡æ•°æ®</span>
<span class="hljs-comment">// ä¼ é€’æ•´ä¸ªActivityRecordï¼ŒåŒ…å«Intentã€Optionsç­‰</span>
data.<span class="hljs-title function_">writeParcelable</span>(activityRecord);

<span class="hljs-comment">// Service: ä¸­ç­‰æ•°æ®  </span>
<span class="hljs-comment">// ä¼ é€’Intentå’Œå¯åŠ¨å‚æ•°</span>
data.<span class="hljs-title function_">writeParcelable</span>(service);
data.<span class="hljs-title function_">writeInt</span>(flags);
data.<span class="hljs-title function_">writeInt</span>(startId);

<span class="hljs-comment">// Broadcast: å°é‡æ•°æ®</span>
<span class="hljs-comment">// ä¸»è¦ä¼ é€’Intent</span>
data.<span class="hljs-title function_">writeParcelable</span>(intent);

<span class="hljs-comment">// ContentProvider: å˜é•¿æ•°æ®</span>
<span class="hljs-comment">// ä¼ é€’URIå’ŒæŸ¥è¯¢å‚æ•°</span>
data.<span class="hljs-title function_">writeParcelable</span>(uri);
data.<span class="hljs-title function_">writeStringArray</span>(projection);
data.<span class="hljs-title function_">writeString</span>(selection);
data.<span class="hljs-title function_">writeStringArray</span>(selectionArgs);

</code></pre>
<h2 data-id="heading-10">ç”Ÿå‘½å‘¨æœŸç®¡ç†æ·±åº¦</h2>
<h3 data-id="heading-11">1. Activity ç”Ÿå‘½å‘¨æœŸï¼ˆAMS å®Œå…¨æ§åˆ¶ï¼‰</h3>
<p>è¿™ä¸ªç”Ÿå‘½å‘¨æœŸæ˜¯æ²¡æœ‰è®¾ç½®configChangeså‚æ•°ã€‚ä¸»è¦ç®€å•ä»‹ç»ä¸€ä¸‹AMSæ˜¯å¦‚ä½•å‚ä¸åˆ°Activityçš„ç”Ÿå‘½å‘¨æœŸä¸­çš„ã€‚è®¾ç½®äº†configChangeså‚æ•°çš„æœ‰å…´è¶£çš„å¯ä»¥å•ç‹¬æœç´¢ä¸€ä¸‹ç›¸å…³æ–‡æ¡£ã€‚
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e23535642b09449584b9c9ac713780f2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oeS54yr54ix5LiK6bG8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766808919&amp;x-signature=LVjOadSv9XLB97Ih4n8A4rU%2Fqpc%3D" alt="Activity ç”Ÿå‘½å‘¨æœŸ.png" loading="lazy"/></p>
<h3 data-id="heading-12">2. Service ç”Ÿå‘½å‘¨æœŸï¼ˆAMS éƒ¨åˆ†æ§åˆ¶ï¼‰</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// å¯åŠ¨å¼æœåŠ¡</span>
<span class="hljs-attr">AMS</span>: å¯åŠ¨æœåŠ¡ â†’ åº”ç”¨: <span class="hljs-title function_">onCreate</span>() â†’ <span class="hljs-title function_">onStartCommand</span>() â†’ è¿è¡Œ
      â†“
<span class="hljs-attr">AMS</span>: åœæ­¢æœåŠ¡ â†’ åº”ç”¨: <span class="hljs-title function_">onDestroy</span>()

<span class="hljs-comment">// ç»‘å®šå¼æœåŠ¡  </span>
<span class="hljs-attr">AMS</span>: ç»‘å®šæœåŠ¡ â†’ åº”ç”¨: <span class="hljs-title function_">onCreate</span>() â†’ <span class="hljs-title function_">onBind</span>() â†’ æœåŠ¡ç»‘å®š
      â†“
<span class="hljs-attr">AMS</span>: æ‰€æœ‰å®¢æˆ·ç«¯è§£ç»‘ â†’ åº”ç”¨: <span class="hljs-title function_">onUnbind</span>() â†’ <span class="hljs-title function_">onDestroy</span>()
</code></pre>
<h3 data-id="heading-13">3. BroadcastReceiver ç”Ÿå‘½å‘¨æœŸï¼ˆAMS ä¸ç®¡ç†ï¼‰</h3>
<pre><code class="hljs language-js" lang="js">/ <span class="hljs-variable constant_">AMS</span>åªç®¡ç†åˆ†å‘ï¼Œä¸ç®¡ç†æ‰§è¡ŒçŠ¶æ€
<span class="hljs-attr">AMS</span>: æ”¶åˆ°å¹¿æ’­ â†’ æŸ¥æ‰¾æ¥æ”¶å™¨ â†’ åˆ†å‘åˆ°è¿›ç¨‹
åº”ç”¨è¿›ç¨‹: åˆ›å»º<span class="hljs-title class_">Receiver</span>å®ä¾‹ â†’ <span class="hljs-title function_">onReceive</span>() â†’ é”€æ¯å®ä¾‹
<span class="hljs-comment">// æ‰§è¡Œå®Œæ¯•å³ç»“æŸï¼Œæ— çŠ¶æ€è·Ÿè¸ª</span>
</code></pre>
<h3 data-id="heading-14">4. ContentProvider ç”Ÿå‘½å‘¨æœŸï¼ˆä¸åº”ç”¨è¿›ç¨‹ç»‘å®šï¼‰</h3>
<pre><code class="hljs language-js" lang="js">/ <span class="hljs-title class_">Provider</span>ç”Ÿå‘½å‘¨æœŸè·Ÿéšåº”ç”¨è¿›ç¨‹
åº”ç”¨è¿›ç¨‹å¯åŠ¨ â†’ <span class="hljs-title function_">onCreate</span>() â†’ è¿è¡Œ
      â†“
åº”ç”¨è¿›ç¨‹æ­»äº¡ â†’ <span class="hljs-title function_">onDestroy</span>()

<span class="hljs-comment">// AMSåªç®¡ç†Providerçš„å‘å¸ƒå’Œå¼•ç”¨</span>
<span class="hljs-attr">AMS</span>: å‘å¸ƒ<span class="hljs-title class_">Provider</span> â†’ å¢åŠ å¼•ç”¨ â†’ å‡å°‘å¼•ç”¨ â†’ é€šçŸ¥æ¸…ç†

</code></pre>
<h2 data-id="heading-15">AMS ä¸­çš„è°ƒåº¦ç­–ç•¥</h2>
<h3 data-id="heading-16">1. ä¼˜å…ˆçº§è°ƒåº¦å·®å¼‚</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// Activityè°ƒåº¦ï¼šåŸºäºä»»åŠ¡æ ˆ</span>
<span class="hljs-title class_">ActivityStack</span>.<span class="hljs-title function_">getNextActivityToResume</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// æ€»æ˜¯æ¢å¤æ ˆé¡¶Activity</span>
    <span class="hljs-keyword">return</span> mActivities.<span class="hljs-title function_">get</span>(mActivities.<span class="hljs-title function_">size</span>() - <span class="hljs-number">1</span>);
}

<span class="hljs-comment">// Serviceè°ƒåº¦ï¼šåŸºäºè¿›ç¨‹çŠ¶æ€</span>
<span class="hljs-title function_">updateServiceProcessLocked</span>(<span class="hljs-params">ServiceRecord sr</span>) {
    <span class="hljs-keyword">if</span> (sr.<span class="hljs-property">isForeground</span>) {
        <span class="hljs-comment">// å‰å°æœåŠ¡ï¼Œä¿æŒè¿›ç¨‹å­˜æ´»</span>
        <span class="hljs-title function_">keepProcessAlive</span>(sr.<span class="hljs-property">app</span>);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (sr.<span class="hljs-property">bindings</span>.<span class="hljs-title function_">size</span>() &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-comment">// æœ‰ç»‘å®šï¼Œé€‚å½“ä¿æ´»</span>
        <span class="hljs-title function_">adjustProcessAdj</span>(sr.<span class="hljs-property">app</span>, <span class="hljs-title class_">ProcessList</span>.<span class="hljs-property">SERVICE_ADJ</span>);
    }
}

<span class="hljs-comment">// Broadcastè°ƒåº¦ï¼šåŸºäºé˜Ÿåˆ—</span>
<span class="hljs-title class_">BroadcastQueue</span>.<span class="hljs-title function_">scheduleBroadcastsLocked</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// é¡ºåºå¤„ç†é˜Ÿåˆ—ä¸­çš„å¹¿æ’­</span>
    <span class="hljs-title function_">processNextBroadcast</span>(<span class="hljs-literal">true</span>);
}

<span class="hljs-comment">// ContentProviderè°ƒåº¦ï¼šåŸºäºéœ€æ±‚</span>
<span class="hljs-title function_">getContentProviderImpl</span>(<span class="hljs-params">name</span>) {
    <span class="hljs-comment">// æŒ‰éœ€å¯åŠ¨Providerè¿›ç¨‹</span>
    <span class="hljs-keyword">if</span> (provider == <span class="hljs-literal">null</span>) {
        <span class="hljs-title function_">startProcessLocked</span>(cpr.<span class="hljs-property">processName</span>, ...);
    }
}

</code></pre>
<h3 data-id="heading-17">2. å†…å­˜ç®¡ç†ç­–ç•¥</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// å››å¤§ç»„ä»¶çš„å†…å­˜å›æ”¶ä¼˜å…ˆçº§</span>
boolean <span class="hljs-title function_">shouldKillProcess</span>(<span class="hljs-params">ProcessRecord app</span>) {
    <span class="hljs-comment">// è®¡ç®—è¿›ç¨‹é‡è¦æ€§</span>
    int importance = <span class="hljs-title function_">calculateImportance</span>(app);
    
    <span class="hljs-comment">// åˆ¤æ–­æ ‡å‡†ï¼ˆç®€åŒ–ï¼‰ï¼š</span>
    <span class="hljs-comment">// 1. æœ‰å‰å°Activityçš„è¿›ç¨‹æœ€åæ€</span>
    <span class="hljs-comment">// 2. æœ‰å¯è§Activityçš„è¿›ç¨‹æ¬¡ä¹‹</span>
    <span class="hljs-comment">// 3. æœ‰å‰å°Serviceçš„è¿›ç¨‹å†æ¬¡</span>
    <span class="hljs-comment">// 4. æœ‰æ™®é€šServiceçš„è¿›ç¨‹</span>
    <span class="hljs-comment">// 5. æœ‰ç¼“å­˜Providerçš„è¿›ç¨‹</span>
    <span class="hljs-comment">// 6. åªæœ‰BroadcastReceiverçš„è¿›ç¨‹æœ€å…ˆæ€</span>
    
    <span class="hljs-keyword">return</span> importance &lt; threshold;
}

</code></pre>
<h2 data-id="heading-18">æ€»ç»“</h2>
<p>å››å¤§ç»„ä»¶ä¸ AMS çš„äº¤äº’ä½“ç°äº† Android ç³»ç»Ÿçš„åˆ†å±‚è®¾è®¡ï¼š</p>
<ol>
<li><strong>Activityâ€‹ - ç”¨æˆ·ç•Œé¢å±‚ï¼š</strong> AMS ä¸¥æ ¼ç®¡ç†ï¼Œç¡®ä¿ç”¨æˆ·ä½“éªŒ</li>
<li><strong>Serviceâ€‹ - åå°ä»»åŠ¡å±‚ï¼š</strong> AMS åè°ƒè¿›ç¨‹ä¼˜å…ˆçº§ï¼Œå¹³è¡¡æ€§èƒ½</li>
<li><strong>BroadcastReceiverâ€‹ - äº‹ä»¶é€šä¿¡å±‚ï¼š</strong> AMS è´Ÿè´£è·¯ç”±ï¼Œè§£è€¦ç»„ä»¶</li>
<li><strong>ContentProviderâ€‹ - æ•°æ®å…±äº«å±‚ï¼š</strong> AMS æ§åˆ¶è®¿é—®ï¼Œä¿è¯å®‰å…¨</li>
</ol>
<p>å…³é”®åŒºåˆ«åœ¨äºï¼š</p>
<ul>
<li><strong>æ§åˆ¶ç²’åº¦ï¼š</strong> Activity æœ€ç»†ï¼ŒBroadcast æœ€ç²—</li>
<li><strong>çŠ¶æ€ç®¡ç†ï¼š</strong> Activity å’Œ Service æœ‰çŠ¶æ€ï¼ŒBroadcast æ— çŠ¶æ€</li>
<li><strong>è¿›ç¨‹å½±å“ï¼š</strong> Activity å’Œå‰å° Service å¯æå‡è¿›ç¨‹ä¼˜å…ˆçº§</li>
<li><strong>é€šä¿¡æ¨¡å¼ï¼š</strong> Activity/Service åŒå‘ï¼ŒBroadcast å•å‘ï¼ŒProvider æŒ‰éœ€</li>
</ul>
<p>AMS ä½œä¸ºç³»ç»Ÿåè°ƒè€…ï¼Œé’ˆå¯¹ä¸åŒç»„ä»¶çš„ç‰¹æ€§é‡‡ç”¨ä¸åŒçš„ç®¡ç†ç­–ç•¥ï¼Œç¡®ä¿ç³»ç»Ÿé«˜æ•ˆã€ç¨³å®šè¿è¡Œã€‚</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[[macosç³»ç»Ÿ]æˆ‘ç”¨çš„æ˜¯è‹¹æœç”µè„‘, ç»ˆç«¯çš„shellæ˜¯zsh,è€Œä¸æ˜¯bash, é‚£æˆ‘åœ¨æ‰§è¡Œ.shæ–‡ä»¶çš„æ—¶å€™, æ˜¯bash xxx.shè¿˜æ˜¯zsh xxx.sh]]></title>    <link>https://juejin.cn/post/7585382553290391588</link>    <guid>https://juejin.cn/post/7585382553290391588</guid>    <pubDate>2025-12-20T04:18:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585382553290391588" data-draft-id="7585400495683698730" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="[macosç³»ç»Ÿ]æˆ‘ç”¨çš„æ˜¯è‹¹æœç”µè„‘, ç»ˆç«¯çš„shellæ˜¯zsh,è€Œä¸æ˜¯bash, é‚£æˆ‘åœ¨æ‰§è¡Œ.shæ–‡ä»¶çš„æ—¶å€™, æ˜¯bash xxx.shè¿˜æ˜¯zsh xxx.sh"/> <meta itemprop="keywords" content="Shell"/> <meta itemprop="datePublished" content="2025-12-20T04:18:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="import_random"/> <meta itemprop="url" content="https://juejin.cn/user/2013961033882312"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="æ˜é‡‘"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            [macosç³»ç»Ÿ]æˆ‘ç”¨çš„æ˜¯è‹¹æœç”µè„‘, ç»ˆç«¯çš„shellæ˜¯zsh,è€Œä¸æ˜¯bash, é‚£æˆ‘åœ¨æ‰§è¡Œ.shæ–‡ä»¶çš„æ—¶å€™, æ˜¯bash xxx.shè¿˜æ˜¯zsh xxx.sh
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2013961033882312/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    import_random
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T04:18:07.000Z" title="Sat Dec 20 2025 04:18:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    é˜…è¯»1åˆ†é’Ÿ
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>åœ¨ macOS çš„ zsh ç»ˆç«¯ä¸­æ‰§è¡Œ .sh æ–‡ä»¶æ—¶ï¼Œ<strong>å–å†³äºä½ çš„éœ€æ±‚å’Œè„šæœ¬çš„ shebangï¼ˆç¬¬ä¸€è¡Œå£°æ˜ï¼‰</strong>ã€‚ä»¥ä¸‹æ˜¯å‡ ç§æƒ…å†µå’Œå»ºè®®ï¼š</p>
<h2 data-id="heading-0">1. <strong>å¦‚æœè„šæœ¬æœ‰ shebangï¼ˆæ¨èï¼‰</strong></h2>
<p>è„šæœ¬ç¬¬ä¸€è¡ŒæŒ‡å®šäº†è§£é‡Šå™¨ï¼Œä¾‹å¦‚ï¼š</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>
</code></pre>
<p>æˆ–</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/zsh</span>
</code></pre>
<p>å¯ä»¥ç›´æ¥æ‰§è¡Œï¼š</p>
<pre><code class="hljs language-bash" lang="bash">./xxx.sh
</code></pre>
<p>ç³»ç»Ÿä¼šè‡ªåŠ¨ä½¿ç”¨ shebang æŒ‡å®šçš„è§£é‡Šå™¨ã€‚</p>
<h2 data-id="heading-1">2. <strong>å¦‚æœæƒ³æ˜¾å¼æŒ‡å®šè§£é‡Šå™¨</strong></h2>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># ç”¨ bash æ‰§è¡Œ</span>
bash xxx.sh

<span class="hljs-comment"># ç”¨ zsh æ‰§è¡Œ</span>
zsh xxx.sh
</code></pre>
<h2 data-id="heading-2">3. <strong>é‡è¦åŒºåˆ«</strong></h2>
<ul>
<li><strong>bash xxx.sh</strong>ï¼šå¼ºåˆ¶ä½¿ç”¨ bash è§£é‡Šå™¨</li>
<li><strong>zsh xxx.sh</strong>ï¼šå¼ºåˆ¶ä½¿ç”¨ zsh è§£é‡Šå™¨</li>
<li><strong>./xxx.sh</strong>ï¼šä½¿ç”¨ shebang æŒ‡å®šçš„è§£é‡Šå™¨ï¼ˆéœ€è¦æ–‡ä»¶æœ‰æ‰§è¡Œæƒé™ï¼‰</li>
</ul>
<h2 data-id="heading-3">4. <strong>ç»™è„šæœ¬æ·»åŠ æ‰§è¡Œæƒé™</strong></h2>
<p>å¦‚æœç»å¸¸æ‰§è¡Œï¼Œå»ºè®®ï¼š</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">chmod</span> +x xxx.sh
./xxx.sh
</code></pre>
<h2 data-id="heading-4">5. <strong>æœ€ä½³å®è·µ</strong></h2>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># å…ˆæ£€æŸ¥è„šæœ¬ shebang</span>
<span class="hljs-built_in">head</span> -1 xxx.sh

<span class="hljs-comment"># å¦‚æœæœ‰ shebangï¼Œç¡®ä¿æœ‰æ‰§è¡Œæƒé™</span>
<span class="hljs-built_in">chmod</span> +x xxx.sh
./xxx.sh

<span class="hljs-comment"># å¦‚æœæ²¡æœ‰ shebangæˆ–æƒ³å¼ºåˆ¶ä½¿ç”¨ç‰¹å®šshell</span>
bash xxx.sh   <span class="hljs-comment"># ç”¨ bash æ‰§è¡Œ</span>
zsh xxx.sh    <span class="hljs-comment"># ç”¨ zsh æ‰§è¡Œ</span>
</code></pre>
<h2 data-id="heading-5">6. <strong>åˆ¤æ–­å½“å‰é»˜è®¤shell</strong></h2>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">echo</span> <span class="hljs-variable">$SHELL</span>  <span class="hljs-comment"># æ˜¾ç¤ºé»˜è®¤ç™»å½•shell</span>
<span class="hljs-built_in">echo</span> <span class="hljs-variable">$0</span>      <span class="hljs-comment"># æ˜¾ç¤ºå½“å‰ä½¿ç”¨çš„shell</span>
</code></pre>
<p><strong>ç®€å•å»ºè®®</strong>ï¼šå¦‚æœè„šæœ¬æ˜¯ bash å†™çš„ï¼ˆå¤šæ•°æƒ…å†µï¼‰ï¼Œç”¨ <code>bash xxx.sh</code>ï¼›å¦‚æœæ˜¯ zsh å†™çš„ï¼Œç”¨ <code>zsh xxx.sh</code>ã€‚æœ€å¥½ç»™è„šæœ¬åŠ ä¸Šæ­£ç¡®çš„ shebangã€‚</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[å·¥ç¨‹åŒ–å·¥å…·ç±»ï¼šæ¨¡å—åŒ–ç³»ç»Ÿå…¨è§£æä¸å®è·µ]]></title>    <link>https://juejin.cn/post/7585412203978227755</link>    <guid>https://juejin.cn/post/7585412203978227755</guid>    <pubDate>2025-12-20T05:11:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585412203978227755" data-draft-id="7585390679399071750" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="å·¥ç¨‹åŒ–å·¥å…·ç±»ï¼šæ¨¡å—åŒ–ç³»ç»Ÿå…¨è§£æä¸å®è·µ"/> <meta itemprop="keywords" content="å‰ç«¯,JavaScript,é¢è¯•"/> <meta itemprop="datePublished" content="2025-12-20T05:11:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="1024è‚¥å®…"/> <meta itemprop="url" content="https://juejin.cn/user/588993964030574"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="æ˜é‡‘"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            å·¥ç¨‹åŒ–å·¥å…·ç±»ï¼šæ¨¡å—åŒ–ç³»ç»Ÿå…¨è§£æä¸å®è·µ
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/588993964030574/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    1024è‚¥å®…
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T05:11:39.000Z" title="Sat Dec 20 2025 05:11:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    é˜…è¯»8åˆ†é’Ÿ
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h4 data-id="heading-0">å¼•è¨€</h4>
<p>åœ¨å‰ç«¯å¼€å‘çš„æ¼”è¿›å†ç¨‹ä¸­ï¼Œæ¨¡å—åŒ–ä¸€ç›´æ˜¯å·¥ç¨‹åŒ–å®è·µçš„æ ¸å¿ƒã€‚ä»æ—©æœŸçš„è„šæœ¬æ ‡ç­¾å †ç Œåˆ°ç°ä»£çš„ES Modulesï¼Œæ¨¡å—åŒ–æŠ€æœ¯æå¤§åœ°æå‡äº†ä»£ç çš„å¯ç»´æŠ¤æ€§ã€å¤ç”¨æ€§å’Œåä½œæ•ˆç‡ã€‚æœ¬æ–‡å°†æ·±å…¥æ¢è®¨æ¨¡å—åŒ–çš„å„ä¸ªæ–¹é¢ï¼ŒåŒ…æ‹¬æ¨¡å—åŠ è½½å™¨å®ç°ã€è§„èŒƒæ¼”åŒ–ã€PolyfillæŠ€æœ¯ï¼Œå¹¶è¡¥å……æ„å»ºå·¥å…·ã€æ€§èƒ½ä¼˜åŒ–ç­‰å·¥ç¨‹åŒ–å®è·µï¼Œå…¨é¢è§£ææ¨¡å—åŒ–åœ¨ç°ä»£å‰ç«¯å¼€å‘ä¸­çš„åº”ç”¨ã€‚</p>
<h4 data-id="heading-1">ä¸€ã€å®ç°ç®€å•çš„æ¨¡å—åŠ è½½å™¨</h4>
<p>åœ¨ç†è§£å¤æ‚æ¨¡å—ç³»ç»Ÿä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆå®ç°ä¸€ä¸ªç®€å•çš„æ¨¡å—åŠ è½½å™¨ï¼Œäº†è§£å…¶æ ¸å¿ƒåŸç†ã€‚</p>
<h5 data-id="heading-2">1.1 åŸºç¡€æ¨¡å—åŠ è½½å™¨å®ç°</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ç®€å•çš„æ¨¡å—æ³¨å†Œè¡¨</span>
<span class="hljs-keyword">const</span> moduleRegistry = {};
<span class="hljs-keyword">const</span> moduleCache = {};

<span class="hljs-comment">// æ¨¡å—å®šä¹‰å‡½æ•°</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">define</span>(<span class="hljs-params">name, dependencies, factory</span>) {
  <span class="hljs-keyword">if</span> (!moduleRegistry[name]) {
    moduleRegistry[name] = {
      dependencies,
      factory,
      <span class="hljs-attr">resolved</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">exports</span>: <span class="hljs-literal">null</span>
    };
  }
}

<span class="hljs-comment">// æ¨¡å—åŠ è½½å‡½æ•°</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">require</span>(<span class="hljs-params">name</span>) {
  <span class="hljs-comment">// æ£€æŸ¥ç¼“å­˜</span>
  <span class="hljs-keyword">if</span> (moduleCache[name]) {
    <span class="hljs-keyword">return</span> moduleCache[name];
  }
  
  <span class="hljs-keyword">const</span> <span class="hljs-variable language_">module</span> = moduleRegistry[name];
  <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">module</span>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`Module <span class="hljs-subst">${name}</span> not found`</span>);
  }
  
  <span class="hljs-comment">// è§£æä¾èµ–</span>
  <span class="hljs-keyword">const</span> resolvedDeps = <span class="hljs-variable language_">module</span>.<span class="hljs-property">dependencies</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">dep</span> =&gt;</span> {
    <span class="hljs-keyword">if</span> (dep === <span class="hljs-string">'exports'</span> || dep === <span class="hljs-string">'module'</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>; <span class="hljs-comment">// ç‰¹æ®Šå¤„ç†</span>
    }
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">require</span>(dep);
  });
  
  <span class="hljs-comment">// æ‰§è¡Œå·¥å‚å‡½æ•°è·å–æ¨¡å—å¯¼å‡º</span>
  <span class="hljs-keyword">const</span> factoryResult = <span class="hljs-variable language_">module</span>.<span class="hljs-property">factory</span>.<span class="hljs-title function_">apply</span>(<span class="hljs-literal">null</span>, resolvedDeps);
  
  <span class="hljs-comment">// ç¼“å­˜æ¨¡å—å¯¼å‡º</span>
  moduleCache[name] = factoryResult || {};
  <span class="hljs-variable language_">module</span>.<span class="hljs-property">resolved</span> = <span class="hljs-literal">true</span>;
  
  <span class="hljs-keyword">return</span> moduleCache[name];
}

<span class="hljs-comment">// ä½¿ç”¨ç¤ºä¾‹</span>
<span class="hljs-title function_">define</span>(<span class="hljs-string">'math'</span>, [], <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">add</span>: <span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> a + b,
    <span class="hljs-attr">multiply</span>: <span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> a * b
  };
});

<span class="hljs-title function_">define</span>(<span class="hljs-string">'calculator'</span>, [<span class="hljs-string">'math'</span>], <span class="hljs-keyword">function</span>(<span class="hljs-params">math</span>) {
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">calculate</span>: <span class="hljs-function">(<span class="hljs-params">x, y</span>) =&gt;</span> math.<span class="hljs-title function_">multiply</span>(math.<span class="hljs-title function_">add</span>(x, y), <span class="hljs-number">2</span>)
  };
});

<span class="hljs-comment">// ä½¿ç”¨æ¨¡å—</span>
<span class="hljs-keyword">const</span> calculator = <span class="hljs-built_in">require</span>(<span class="hljs-string">'calculator'</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(calculator.<span class="hljs-title function_">calculate</span>(<span class="hljs-number">2</span>, <span class="hljs-number">3</span>)); <span class="hljs-comment">// 10</span>
</code></pre>
<h5 data-id="heading-3">1.2 å¼‚æ­¥æ¨¡å—åŠ è½½å™¨</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">AsyncModuleLoader</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">modules</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">loading</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
  }
  
  <span class="hljs-comment">// å®šä¹‰æ¨¡å—</span>
  <span class="hljs-title function_">define</span>(<span class="hljs-params">name, deps, factory</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">modules</span>.<span class="hljs-title function_">set</span>(name, {
      deps,
      factory,
      <span class="hljs-attr">exports</span>: <span class="hljs-literal">null</span>,
      <span class="hljs-attr">resolved</span>: <span class="hljs-literal">false</span>
    });
  }
  
  <span class="hljs-comment">// å¼‚æ­¥åŠ è½½æ¨¡å—</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">require</span>(<span class="hljs-params">name</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">modules</span>.<span class="hljs-title function_">get</span>(name)?.<span class="hljs-property">resolved</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">modules</span>.<span class="hljs-title function_">get</span>(name).<span class="hljs-property">exports</span>;
    }
    
    <span class="hljs-comment">// é˜²æ­¢é‡å¤åŠ è½½</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">loading</span>.<span class="hljs-title function_">has</span>(name)) {
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">loading</span>.<span class="hljs-title function_">get</span>(name);
    }
    
    <span class="hljs-comment">// åˆ›å»ºåŠ è½½Promise</span>
    <span class="hljs-keyword">const</span> loadPromise = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_loadModule</span>(name);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">loading</span>.<span class="hljs-title function_">set</span>(name, loadPromise);
    
    <span class="hljs-keyword">return</span> loadPromise;
  }
  
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">_loadModule</span>(<span class="hljs-params">name</span>) {
    <span class="hljs-keyword">const</span> <span class="hljs-variable language_">module</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">modules</span>.<span class="hljs-title function_">get</span>(name);
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">module</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`Module <span class="hljs-subst">${name}</span> not found`</span>);
    }
    
    <span class="hljs-comment">// åŠ è½½æ‰€æœ‰ä¾èµ–</span>
    <span class="hljs-keyword">const</span> depPromises = <span class="hljs-variable language_">module</span>.<span class="hljs-property">deps</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">dep</span> =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-built_in">require</span>(dep));
    <span class="hljs-keyword">const</span> deps = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>(depPromises);
    
    <span class="hljs-comment">// æ‰§è¡Œå·¥å‚å‡½æ•°</span>
    <span class="hljs-keyword">const</span> <span class="hljs-built_in">exports</span> = <span class="hljs-variable language_">module</span>.<span class="hljs-property">factory</span>.<span class="hljs-title function_">apply</span>(<span class="hljs-literal">null</span>, deps);
    
    <span class="hljs-comment">// æ›´æ–°æ¨¡å—çŠ¶æ€</span>
    <span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-built_in">exports</span> || {};
    <span class="hljs-variable language_">module</span>.<span class="hljs-property">resolved</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">loading</span>.<span class="hljs-title function_">delete</span>(name);
    
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span>;
  }
}

<span class="hljs-comment">// ä½¿ç”¨ç¤ºä¾‹</span>
<span class="hljs-keyword">const</span> loader = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AsyncModuleLoader</span>();

loader.<span class="hljs-title function_">define</span>(<span class="hljs-string">'utils'</span>, [], <span class="hljs-function">() =&gt;</span> ({
  <span class="hljs-attr">format</span>: <span class="hljs-function"><span class="hljs-params">str</span> =&gt;</span> str.<span class="hljs-title function_">toUpperCase</span>()
}));

loader.<span class="hljs-title function_">define</span>(<span class="hljs-string">'app'</span>, [<span class="hljs-string">'utils'</span>], <span class="hljs-function">(<span class="hljs-params">utils</span>) =&gt;</span> {
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">run</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(utils.<span class="hljs-title function_">format</span>(<span class="hljs-string">'hello'</span>))
  };
});

loader.<span class="hljs-built_in">require</span>(<span class="hljs-string">'app'</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">app</span> =&gt;</span> app.<span class="hljs-title function_">run</span>()); <span class="hljs-comment">// è¾“å‡º: HELLO</span>
</code></pre>
<h4 data-id="heading-4">äºŒã€AMDè§„èŒƒå®ç°</h4>
<p>AMDï¼ˆAsynchronous Module Definitionï¼‰è§„èŒƒæ˜¯RequireJSæ¨å¹¿çš„å¼‚æ­¥æ¨¡å—å®šä¹‰æ ‡å‡†ã€‚</p>
<h5 data-id="heading-5">2.1 ç®€åŒ–çš„AMDå®ç°</h5>
<pre><code class="hljs language-javascript" lang="javascript">(<span class="hljs-keyword">function</span>(<span class="hljs-params"><span class="hljs-variable language_">global</span></span>) {
  <span class="hljs-comment">// æ¨¡å—ç¼“å­˜</span>
  <span class="hljs-keyword">const</span> modules = {};
  <span class="hljs-keyword">const</span> inProgress = {};
  
  <span class="hljs-comment">// å®šä¹‰å‡½æ•°</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">define</span>(<span class="hljs-params">id, dependencies, factory</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">arguments</span>.<span class="hljs-property">length</span> === <span class="hljs-number">2</span>) {
      factory = dependencies;
      dependencies = [];
    }
    
    modules[id] = {
      <span class="hljs-attr">id</span>: id,
      <span class="hljs-attr">dependencies</span>: dependencies,
      <span class="hljs-attr">factory</span>: factory,
      <span class="hljs-attr">exports</span>: <span class="hljs-literal">null</span>,
      <span class="hljs-attr">resolved</span>: <span class="hljs-literal">false</span>
    };
    
    <span class="hljs-comment">// å°è¯•è§£ææ¨¡å—</span>
    <span class="hljs-title function_">resolveModule</span>(id);
  }
  
  <span class="hljs-comment">// ä¾èµ–è§£æ</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">resolveModule</span>(<span class="hljs-params">id</span>) {
    <span class="hljs-keyword">const</span> <span class="hljs-variable language_">module</span> = modules[id];
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">module</span> || <span class="hljs-variable language_">module</span>.<span class="hljs-property">resolved</span>) <span class="hljs-keyword">return</span>;
    
    <span class="hljs-comment">// æ£€æŸ¥ä¾èµ–æ˜¯å¦éƒ½å¯ç”¨</span>
    <span class="hljs-keyword">const</span> deps = <span class="hljs-variable language_">module</span>.<span class="hljs-property">dependencies</span>;
    <span class="hljs-keyword">const</span> missingDeps = deps.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">dep</span> =&gt;</span> 
      !modules[dep] || !modules[dep].<span class="hljs-property">resolved</span>
    );
    
    <span class="hljs-keyword">if</span> (missingDeps.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {
      <span class="hljs-comment">// æ‰€æœ‰ä¾èµ–å·²å°±ç»ªï¼Œæ‰§è¡Œå·¥å‚å‡½æ•°</span>
      <span class="hljs-title function_">executeModule</span>(id);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// ç­‰å¾…ä¾èµ–</span>
      missingDeps.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">dep</span> =&gt;</span> {
        <span class="hljs-keyword">if</span> (!inProgress[dep]) {
          inProgress[dep] = [];
        }
        inProgress[dep].<span class="hljs-title function_">push</span>(id);
      });
    }
  }
  
  <span class="hljs-comment">// æ‰§è¡Œæ¨¡å—</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">executeModule</span>(<span class="hljs-params">id</span>) {
    <span class="hljs-keyword">const</span> <span class="hljs-variable language_">module</span> = modules[id];
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">module</span>.<span class="hljs-property">resolved</span>) <span class="hljs-keyword">return</span>;
    
    <span class="hljs-comment">// è·å–ä¾èµ–çš„exports</span>
    <span class="hljs-keyword">const</span> depExports = <span class="hljs-variable language_">module</span>.<span class="hljs-property">dependencies</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">dep</span> =&gt;</span> {
      <span class="hljs-keyword">if</span> (dep === <span class="hljs-string">'exports'</span>) <span class="hljs-keyword">return</span> {};
      <span class="hljs-keyword">if</span> (dep === <span class="hljs-string">'require'</span>) <span class="hljs-keyword">return</span> <span class="hljs-title function_">createRequire</span>();
      <span class="hljs-keyword">if</span> (dep === <span class="hljs-string">'module'</span>) <span class="hljs-keyword">return</span> { <span class="hljs-attr">id</span>: <span class="hljs-variable language_">module</span>.<span class="hljs-property">id</span>, <span class="hljs-attr">exports</span>: {} };
      <span class="hljs-keyword">return</span> modules[dep].<span class="hljs-property">exports</span>;
    });
    
    <span class="hljs-comment">// æ‰§è¡Œå·¥å‚å‡½æ•°</span>
    <span class="hljs-keyword">const</span> <span class="hljs-built_in">exports</span> = <span class="hljs-variable language_">module</span>.<span class="hljs-property">factory</span>.<span class="hljs-title function_">apply</span>(<span class="hljs-literal">null</span>, depExports);
    
    <span class="hljs-comment">// è®¾ç½®exports</span>
    <span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-built_in">exports</span> || 
      (depExports[<span class="hljs-variable language_">module</span>.<span class="hljs-property">dependencies</span>.<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">'exports'</span>)] || {});
    <span class="hljs-variable language_">module</span>.<span class="hljs-property">resolved</span> = <span class="hljs-literal">true</span>;
    
    <span class="hljs-comment">// é€šçŸ¥ç­‰å¾…æ­¤æ¨¡å—çš„å…¶ä»–æ¨¡å—</span>
    <span class="hljs-keyword">if</span> (inProgress[id]) {
      inProgress[id].<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">dependentId</span> =&gt;</span> <span class="hljs-title function_">resolveModule</span>(dependentId));
      <span class="hljs-keyword">delete</span> inProgress[id];
    }
  }
  
  <span class="hljs-comment">// åˆ›å»ºrequireå‡½æ•°</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">createRequire</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params">ids, callback</span>) {
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> ids === <span class="hljs-string">'string'</span>) ids = [ids];
      
      <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>(ids.<span class="hljs-title function_">map</span>(loadModule))
        .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">modules</span> =&gt;</span> {
          <span class="hljs-keyword">if</span> (callback) callback.<span class="hljs-title function_">apply</span>(<span class="hljs-literal">null</span>, modules);
        });
    };
  }
  
  <span class="hljs-comment">// å¼‚æ­¥åŠ è½½æ¨¡å—</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">loadModule</span>(<span class="hljs-params">id</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (modules[id] &amp;&amp; modules[id].<span class="hljs-property">resolved</span>) {
        <span class="hljs-title function_">resolve</span>(modules[id].<span class="hljs-property">exports</span>);
        <span class="hljs-keyword">return</span>;
      }
      
      <span class="hljs-comment">// åŠ¨æ€åŠ è½½è„šæœ¬</span>
      <span class="hljs-keyword">const</span> script = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'script'</span>);
      script.<span class="hljs-property">src</span> = id + <span class="hljs-string">'.js'</span>;
      script.<span class="hljs-property">onload</span> = <span class="hljs-function">() =&gt;</span> {
        <span class="hljs-comment">// ç­‰å¾…æ¨¡å—è§£æ</span>
        <span class="hljs-keyword">const</span> checkInterval = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
          <span class="hljs-keyword">if</span> (modules[id] &amp;&amp; modules[id].<span class="hljs-property">resolved</span>) {
            <span class="hljs-built_in">clearInterval</span>(checkInterval);
            <span class="hljs-title function_">resolve</span>(modules[id].<span class="hljs-property">exports</span>);
          }
        }, <span class="hljs-number">10</span>);
      };
      script.<span class="hljs-property">onerror</span> = reject;
      <span class="hljs-variable language_">document</span>.<span class="hljs-property">head</span>.<span class="hljs-title function_">appendChild</span>(script);
    });
  }
  
  <span class="hljs-comment">// æš´éœ²åˆ°å…¨å±€</span>
  <span class="hljs-variable language_">global</span>.<span class="hljs-property">define</span> = define;
  <span class="hljs-variable language_">global</span>.<span class="hljs-property">require</span> = <span class="hljs-title function_">createRequire</span>();
  
})(<span class="hljs-keyword">typeof</span> <span class="hljs-variable language_">window</span> !== <span class="hljs-string">'undefined'</span> ? <span class="hljs-variable language_">window</span> : <span class="hljs-variable language_">global</span>);

<span class="hljs-comment">// ä½¿ç”¨ç¤ºä¾‹</span>
<span class="hljs-title function_">define</span>(<span class="hljs-string">'math'</span>, [], <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">add</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">a, b</span>) { <span class="hljs-keyword">return</span> a + b; }
  };
});

<span class="hljs-title function_">define</span>(<span class="hljs-string">'app'</span>, [<span class="hljs-string">'math'</span>, <span class="hljs-string">'require'</span>], <span class="hljs-keyword">function</span>(<span class="hljs-params">math, <span class="hljs-built_in">require</span></span>) {
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">calculate</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">return</span> math.<span class="hljs-title function_">add</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>);
    },
    <span class="hljs-attr">loadExtra</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
      <span class="hljs-built_in">require</span>([<span class="hljs-string">'utils'</span>], <span class="hljs-keyword">function</span>(<span class="hljs-params">utils</span>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Utils loaded'</span>);
      });
    }
  };
});

<span class="hljs-built_in">require</span>([<span class="hljs-string">'app'</span>], <span class="hljs-keyword">function</span>(<span class="hljs-params">app</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(app.<span class="hljs-title function_">calculate</span>()); <span class="hljs-comment">// 3</span>
});
</code></pre>
<h4 data-id="heading-6">ä¸‰ã€CMDè§„èŒƒå®ç°</h4>
<p>CMDï¼ˆCommon Module Definitionï¼‰è§„èŒƒç”±Sea.jsæ¨å¹¿ï¼Œå¼ºè°ƒå°±è¿‘ä¾èµ–ã€‚</p>
<h5 data-id="heading-7">3.1 ç®€åŒ–çš„CMDå®ç°</h5>
<pre><code class="hljs language-javascript" lang="javascript">(<span class="hljs-keyword">function</span>(<span class="hljs-params"><span class="hljs-variable language_">global</span></span>) {
  <span class="hljs-keyword">const</span> modules = {};
  <span class="hljs-keyword">const</span> factories = {};
  <span class="hljs-keyword">const</span> cache = {};
  
  <span class="hljs-comment">// æ¨¡å—çŠ¶æ€</span>
  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">STATUS</span> = {
    <span class="hljs-attr">PENDING</span>: <span class="hljs-number">0</span>,
    <span class="hljs-attr">LOADING</span>: <span class="hljs-number">1</span>,
    <span class="hljs-attr">LOADED</span>: <span class="hljs-number">2</span>,
    <span class="hljs-attr">EXECUTING</span>: <span class="hljs-number">3</span>,
    <span class="hljs-attr">EXECUTED</span>: <span class="hljs-number">4</span>
  };
  
  <span class="hljs-comment">// å®šä¹‰å‡½æ•°</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">define</span>(<span class="hljs-params">factory</span>) {
    <span class="hljs-comment">// è·å–å½“å‰è„šæœ¬</span>
    <span class="hljs-keyword">const</span> scripts = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementsByTagName</span>(<span class="hljs-string">'script'</span>);
    <span class="hljs-keyword">const</span> currentScript = scripts[scripts.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>];
    <span class="hljs-keyword">const</span> id = currentScript.<span class="hljs-property">src</span>.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/\.js$/</span>, <span class="hljs-string">''</span>);
    
    factories[id] = factory;
    modules[id] = {
      <span class="hljs-attr">id</span>: id,
      <span class="hljs-attr">factory</span>: factory,
      <span class="hljs-attr">deps</span>: [],
      <span class="hljs-attr">exports</span>: <span class="hljs-literal">null</span>,
      <span class="hljs-attr">status</span>: <span class="hljs-variable constant_">STATUS</span>.<span class="hljs-property">PENDING</span>,
      <span class="hljs-attr">callbacks</span>: []
    };
    
    <span class="hljs-comment">// è§£æä¾èµ–</span>
    <span class="hljs-title function_">parseDependencies</span>(id);
  }
  
  <span class="hljs-comment">// è§£æä¾èµ–</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">parseDependencies</span>(<span class="hljs-params">id</span>) {
    <span class="hljs-keyword">const</span> factory = factories[id];
    <span class="hljs-keyword">if</span> (!factory) <span class="hljs-keyword">return</span>;
    
    <span class="hljs-keyword">const</span> source = factory.<span class="hljs-title function_">toString</span>();
    <span class="hljs-keyword">const</span> requireRegex = <span class="hljs-regexp">/require\s*\(\s*['"]([^'"]+)['"]\s*\)/g</span>;
    <span class="hljs-keyword">const</span> deps = [];
    <span class="hljs-keyword">let</span> match;
    
    <span class="hljs-keyword">while</span> ((match = requireRegex.<span class="hljs-title function_">exec</span>(source)) !== <span class="hljs-literal">null</span>) {
      deps.<span class="hljs-title function_">push</span>(match[<span class="hljs-number">1</span>]);
    }
    
    modules[id].<span class="hljs-property">deps</span> = deps;
  }
  
  <span class="hljs-comment">// å¼‚æ­¥åŠ è½½æ¨¡å—</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">require</span>(<span class="hljs-params">id, callback</span>) {
    <span class="hljs-keyword">const</span> <span class="hljs-variable language_">module</span> = modules[id];
    
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">module</span> &amp;&amp; <span class="hljs-variable language_">module</span>.<span class="hljs-property">status</span> === <span class="hljs-variable constant_">STATUS</span>.<span class="hljs-property">EXECUTED</span>) {
      <span class="hljs-comment">// æ¨¡å—å·²æ‰§è¡Œï¼Œç›´æ¥è¿”å›</span>
      <span class="hljs-keyword">if</span> (callback) {
        <span class="hljs-title function_">callback</span>(<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span>);
      }
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span>;
    }
    
    <span class="hljs-comment">// æ¨¡å—æœªåŠ è½½ï¼Œå¼€å§‹åŠ è½½</span>
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">module</span> || <span class="hljs-variable language_">module</span>.<span class="hljs-property">status</span> === <span class="hljs-variable constant_">STATUS</span>.<span class="hljs-property">PENDING</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">loadModule</span>(id, callback);
    }
    
    <span class="hljs-comment">// æ¨¡å—åŠ è½½ä¸­ï¼Œæ·»åŠ å›è°ƒ</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">module</span>.<span class="hljs-property">status</span> &lt; <span class="hljs-variable constant_">STATUS</span>.<span class="hljs-property">EXECUTED</span>) {
      <span class="hljs-variable language_">module</span>.<span class="hljs-property">callbacks</span>.<span class="hljs-title function_">push</span>(callback);
    }
  }
  
  <span class="hljs-comment">// åŠ è½½æ¨¡å—</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">loadModule</span>(<span class="hljs-params">id, callback</span>) {
    <span class="hljs-keyword">const</span> <span class="hljs-variable language_">module</span> = modules[id] || (modules[id] = {
      <span class="hljs-attr">id</span>: id,
      <span class="hljs-attr">deps</span>: [],
      <span class="hljs-attr">exports</span>: <span class="hljs-literal">null</span>,
      <span class="hljs-attr">status</span>: <span class="hljs-variable constant_">STATUS</span>.<span class="hljs-property">LOADING</span>,
      <span class="hljs-attr">callbacks</span>: callback ? [callback] : []
    });
    
    <span class="hljs-comment">// åˆ›å»ºscriptæ ‡ç­¾åŠ è½½</span>
    <span class="hljs-keyword">const</span> script = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'script'</span>);
    script.<span class="hljs-property">src</span> = id + <span class="hljs-string">'.js'</span>;
    script.<span class="hljs-property">async</span> = <span class="hljs-literal">true</span>;
    
    script.<span class="hljs-property">onload</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">module</span>.<span class="hljs-property">status</span> = <span class="hljs-variable constant_">STATUS</span>.<span class="hljs-property">LOADED</span>;
      <span class="hljs-title function_">executeModule</span>(id);
    };
    
    script.<span class="hljs-property">onerror</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to load module: <span class="hljs-subst">${id}</span>`</span>);
    };
    
    <span class="hljs-variable language_">document</span>.<span class="hljs-property">head</span>.<span class="hljs-title function_">appendChild</span>(script);
    
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
  }
  
  <span class="hljs-comment">// æ‰§è¡Œæ¨¡å—</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">executeModule</span>(<span class="hljs-params">id</span>) {
    <span class="hljs-keyword">const</span> <span class="hljs-variable language_">module</span> = modules[id];
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">module</span> || <span class="hljs-variable language_">module</span>.<span class="hljs-property">status</span> &gt;= <span class="hljs-variable constant_">STATUS</span>.<span class="hljs-property">EXECUTING</span>) <span class="hljs-keyword">return</span>;
    
    <span class="hljs-variable language_">module</span>.<span class="hljs-property">status</span> = <span class="hljs-variable constant_">STATUS</span>.<span class="hljs-property">EXECUTING</span>;
    
    <span class="hljs-comment">// æ”¶é›†ä¾èµ–</span>
    <span class="hljs-keyword">const</span> deps = <span class="hljs-variable language_">module</span>.<span class="hljs-property">deps</span>;
    <span class="hljs-keyword">const</span> depValues = deps.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">depId</span> =&gt;</span> {
      <span class="hljs-keyword">const</span> depModule = modules[depId];
      <span class="hljs-keyword">if</span> (depModule &amp;&amp; depModule.<span class="hljs-property">status</span> === <span class="hljs-variable constant_">STATUS</span>.<span class="hljs-property">EXECUTED</span>) {
        <span class="hljs-keyword">return</span> depModule.<span class="hljs-property">exports</span>;
      }
      <span class="hljs-comment">// åŒæ­¥åŠ è½½ä¾èµ–ï¼ˆç®€åŒ–å®ç°ï¼‰</span>
      <span class="hljs-keyword">return</span> <span class="hljs-built_in">require</span>(depId);
    });
    
    <span class="hljs-comment">// æ‰§è¡Œå·¥å‚å‡½æ•°</span>
    <span class="hljs-keyword">const</span> factory = factories[id];
    <span class="hljs-keyword">if</span> (!factory) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`Factory not found for module: <span class="hljs-subst">${id}</span>`</span>);
    }
    
    <span class="hljs-comment">// æä¾›requireã€exportsã€moduleå‚æ•°</span>
    <span class="hljs-keyword">const</span> localRequire = <span class="hljs-keyword">function</span>(<span class="hljs-params">depId</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-built_in">require</span>(depId);
    };
    
    <span class="hljs-keyword">const</span> localExports = {};
    <span class="hljs-keyword">const</span> localModule = { <span class="hljs-attr">exports</span>: localExports };
    
    <span class="hljs-comment">// æ‰§è¡Œ</span>
    <span class="hljs-keyword">const</span> result = factory.<span class="hljs-title function_">call</span>(<span class="hljs-literal">null</span>, localRequire, localExports, localModule);
    
    <span class="hljs-comment">// è®¾ç½®exports</span>
    <span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = localModule.<span class="hljs-property">exports</span> || result || localExports;
    <span class="hljs-variable language_">module</span>.<span class="hljs-property">status</span> = <span class="hljs-variable constant_">STATUS</span>.<span class="hljs-property">EXECUTED</span>;
    
    <span class="hljs-comment">// æ‰§è¡Œå›è°ƒ</span>
    <span class="hljs-variable language_">module</span>.<span class="hljs-property">callbacks</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">cb</span> =&gt;</span> <span class="hljs-title function_">cb</span>(<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span>));
    <span class="hljs-variable language_">module</span>.<span class="hljs-property">callbacks</span> = [];
  }
  
  <span class="hljs-comment">// æš´éœ²å…¨å±€</span>
  <span class="hljs-variable language_">global</span>.<span class="hljs-property">define</span> = define;
  <span class="hljs-variable language_">global</span>.<span class="hljs-property">require</span> = <span class="hljs-built_in">require</span>;
  
})(<span class="hljs-keyword">typeof</span> <span class="hljs-variable language_">window</span> !== <span class="hljs-string">'undefined'</span> ? <span class="hljs-variable language_">window</span> : <span class="hljs-variable language_">global</span>);

<span class="hljs-comment">// ä½¿ç”¨ç¤ºä¾‹</span>
<span class="hljs-comment">// æ–‡ä»¶: math.js</span>
<span class="hljs-title function_">define</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"><span class="hljs-built_in">require</span>, <span class="hljs-built_in">exports</span>, <span class="hljs-variable language_">module</span></span>) {
  <span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
    <span class="hljs-attr">add</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">a, b</span>) {
      <span class="hljs-keyword">return</span> a + b;
    }
  };
});

<span class="hljs-comment">// æ–‡ä»¶: app.js</span>
<span class="hljs-title function_">define</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"><span class="hljs-built_in">require</span>, <span class="hljs-built_in">exports</span>, <span class="hljs-variable language_">module</span></span>) {
  <span class="hljs-keyword">var</span> math = <span class="hljs-built_in">require</span>(<span class="hljs-string">'math'</span>);
  
  <span class="hljs-built_in">exports</span>.<span class="hljs-property">calculate</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> math.<span class="hljs-title function_">add</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>);
  };
});

<span class="hljs-comment">// ä¸»æ–‡ä»¶</span>
<span class="hljs-built_in">require</span>(<span class="hljs-string">'app'</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params">app</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(app.<span class="hljs-title function_">calculate</span>()); <span class="hljs-comment">// 3</span>
});
</code></pre>
<h4 data-id="heading-8">å››ã€ES Moduleçš„ç®€å•Polyfill</h4>
<p>è™½ç„¶ç°ä»£æµè§ˆå™¨æ”¯æŒES Modulesï¼Œä½†åœ¨æŸäº›åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬ä»éœ€è¦Polyfillæ”¯æŒã€‚</p>
<h5 data-id="heading-9">4.1 åŸºç¡€ESM Polyfillå®ç°</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ES Module Polyfill</span>
(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> moduleMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
  <span class="hljs-keyword">const</span> moduleCache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
  
  <span class="hljs-comment">// æ‹¦æˆªimportè¯­å¥ï¼ˆé€šè¿‡åŠ¨æ€importå®ç°ï¼‰</span>
  <span class="hljs-variable language_">window</span>.<span class="hljs-property">importModule</span> = <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span>(<span class="hljs-params">modulePath</span>) {
    <span class="hljs-comment">// æ£€æŸ¥ç¼“å­˜</span>
    <span class="hljs-keyword">if</span> (moduleCache.<span class="hljs-title function_">has</span>(modulePath)) {
      <span class="hljs-keyword">return</span> moduleCache.<span class="hljs-title function_">get</span>(modulePath);
    }
    
    <span class="hljs-comment">// åŠ è½½æ¨¡å—ä»£ç </span>
    <span class="hljs-keyword">const</span> code = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchModule</span>(modulePath);
    
    <span class="hljs-comment">// è§£æä¾èµ–</span>
    <span class="hljs-keyword">const</span> deps = <span class="hljs-title function_">extractDependencies</span>(code);
    
    <span class="hljs-comment">// åŠ è½½ä¾èµ–</span>
    <span class="hljs-keyword">const</span> depPromises = deps.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">dep</span> =&gt;</span> 
      importModule(<span class="hljs-title function_">resolvePath</span>(modulePath, dep))
    );
    <span class="hljs-keyword">const</span> dependencies = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>(depPromises);
    
    <span class="hljs-comment">// æ‰§è¡Œæ¨¡å—</span>
    <span class="hljs-keyword">const</span> moduleExports = {};
    <span class="hljs-keyword">const</span> <span class="hljs-variable language_">module</span> = {
      <span class="hljs-attr">exports</span>: moduleExports
    };
    
    <span class="hljs-comment">// åˆ›å»ºåŒ…è£…å‡½æ•°</span>
    <span class="hljs-keyword">const</span> wrapper = <span class="hljs-title function_">createWrapper</span>(code, dependencies);
    <span class="hljs-title function_">wrapper</span>(
      moduleExports, <span class="hljs-comment">// exports</span>
      <span class="hljs-variable language_">module</span>,        <span class="hljs-comment">// module</span>
      modulePath     <span class="hljs-comment">// __filenameï¼ˆæ¨¡æ‹Ÿï¼‰</span>
    );
    
    <span class="hljs-comment">// ç¼“å­˜ç»“æœ</span>
    <span class="hljs-keyword">const</span> <span class="hljs-built_in">exports</span> = <span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> === moduleExports ? 
      moduleExports : <span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span>;
    moduleCache.<span class="hljs-title function_">set</span>(modulePath, <span class="hljs-built_in">exports</span>);
    
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">exports</span>;
  };
  
  <span class="hljs-comment">// æå–ä¾èµ–</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">extractDependencies</span>(<span class="hljs-params">code</span>) {
    <span class="hljs-keyword">const</span> importRegex = <span class="hljs-regexp">/import\s+.*?\s+from\s+['"](.*?)['"]/g</span>;
    <span class="hljs-keyword">const</span> dynamicImportRegex = <span class="hljs-regexp">/import\s*\(['"](.*?)['"]\)/g</span>;
    <span class="hljs-keyword">const</span> deps = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>();
    
    <span class="hljs-keyword">let</span> match;
    <span class="hljs-keyword">while</span> ((match = importRegex.<span class="hljs-title function_">exec</span>(code)) !== <span class="hljs-literal">null</span>) {
      deps.<span class="hljs-title function_">add</span>(match[<span class="hljs-number">1</span>]);
    }
    
    <span class="hljs-comment">// é‡ç½®æ­£åˆ™</span>
    importRegex.<span class="hljs-property">lastIndex</span> = <span class="hljs-number">0</span>;
    
    <span class="hljs-keyword">while</span> ((match = dynamicImportRegex.<span class="hljs-title function_">exec</span>(code)) !== <span class="hljs-literal">null</span>) {
      deps.<span class="hljs-title function_">add</span>(match[<span class="hljs-number">1</span>]);
    }
    
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(deps);
  }
  
  <span class="hljs-comment">// åˆ›å»ºåŒ…è£…å‡½æ•°</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">createWrapper</span>(<span class="hljs-params">code, dependencies</span>) {
    <span class="hljs-keyword">const</span> wrapperCode = <span class="hljs-string">`
      (function(exports, module, __filename, __dirname) {
        // æ³¨å…¥ä¾èµ–
        const [
          <span class="hljs-subst">${dependencies.map((_, i) =&gt; <span class="hljs-string">`__dep<span class="hljs-subst">${i}</span>`</span>).join(<span class="hljs-string">', '</span>)}</span>
        ] = arguments[4];
        
        <span class="hljs-subst">${code}</span>
        
        // è¿”å›é»˜è®¤å¯¼å‡º
        return module.exports &amp;&amp; module.exports.default ?
          module.exports.default : module.exports;
      })
    `</span>;
    
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">eval</span>(wrapperCode);
  }
  
  <span class="hljs-comment">// è§£æè·¯å¾„</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">resolvePath</span>(<span class="hljs-params">basePath, targetPath</span>) {
    <span class="hljs-keyword">if</span> (targetPath.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'./'</span>) || targetPath.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'../'</span>)) {
      <span class="hljs-keyword">const</span> baseDir = basePath.<span class="hljs-title function_">substring</span>(<span class="hljs-number">0</span>, basePath.<span class="hljs-title function_">lastIndexOf</span>(<span class="hljs-string">'/'</span>));
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title function_">URL</span>(targetPath, baseDir + <span class="hljs-string">'/'</span>).<span class="hljs-property">pathname</span>;
    }
    <span class="hljs-keyword">return</span> targetPath;
  }
  
  <span class="hljs-comment">// è·å–æ¨¡å—ä»£ç </span>
  <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchModule</span>(<span class="hljs-params">path</span>) {
    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(path);
    <span class="hljs-keyword">if</span> (!response.<span class="hljs-property">ok</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`Failed to load module: <span class="hljs-subst">${path}</span>`</span>);
    }
    <span class="hljs-keyword">return</span> response.<span class="hljs-title function_">text</span>();
  }
  
  <span class="hljs-comment">// æ‹¦æˆªscript type="module"</span>
  <span class="hljs-title function_">interceptModuleScripts</span>();
  
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">interceptModuleScripts</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> originalCreateElement = <span class="hljs-variable language_">document</span>.<span class="hljs-property">createElement</span>;
    
    <span class="hljs-variable language_">document</span>.<span class="hljs-property">createElement</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">tagName</span>) {
      <span class="hljs-keyword">const</span> element = originalCreateElement.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">document</span>, tagName);
      
      <span class="hljs-keyword">if</span> (tagName === <span class="hljs-string">'script'</span>) {
        <span class="hljs-keyword">const</span> originalSetAttribute = element.<span class="hljs-property">setAttribute</span>.<span class="hljs-title function_">bind</span>(element);
        
        element.<span class="hljs-property">setAttribute</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">name, value</span>) {
          <span class="hljs-title function_">originalSetAttribute</span>(name, value);
          
          <span class="hljs-keyword">if</span> (name === <span class="hljs-string">'type'</span> &amp;&amp; value === <span class="hljs-string">'module'</span>) {
            <span class="hljs-comment">// æ‹¦æˆªæ¨¡å—è„šæœ¬</span>
            <span class="hljs-keyword">const</span> src = element.<span class="hljs-title function_">getAttribute</span>(<span class="hljs-string">'src'</span>);
            <span class="hljs-keyword">if</span> (src) {
              element.<span class="hljs-property">type</span> = <span class="hljs-string">'text/javascript'</span>;
              importModule(src).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {
                <span class="hljs-keyword">if</span> (element.<span class="hljs-property">onload</span>) element.<span class="hljs-title function_">onload</span>();
              }).<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> {
                <span class="hljs-keyword">if</span> (element.<span class="hljs-property">onerror</span>) element.<span class="hljs-title function_">onerror</span>(err);
              });
            }
          }
        };
      }
      
      <span class="hljs-keyword">return</span> element;
    };
  }
})();

<span class="hljs-comment">// ä½¿ç”¨ç¤ºä¾‹</span>
<span class="hljs-comment">// æ¨¡å—æ–‡ä»¶: utils.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">capitalize</span>(<span class="hljs-params">str</span>) {
  <span class="hljs-keyword">return</span> str.<span class="hljs-title function_">charAt</span>(<span class="hljs-number">0</span>).<span class="hljs-title function_">toUpperCase</span>() + str.<span class="hljs-title function_">slice</span>(<span class="hljs-number">1</span>);
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">greet</span>(<span class="hljs-params">name</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-string">`Hello, <span class="hljs-subst">${capitalize(name)}</span>!`</span>;
}

<span class="hljs-comment">// ä¸»æ–‡ä»¶</span>
importModule(<span class="hljs-string">'./utils.js'</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">utils</span> =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(utils.<span class="hljs-title function_">default</span>(<span class="hljs-string">'world'</span>)); <span class="hljs-comment">// Hello, World!</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(utils.<span class="hljs-title function_">capitalize</span>(<span class="hljs-string">'test'</span>)); <span class="hljs-comment">// Test</span>
});
</code></pre>
<h5 data-id="heading-10">4.2 æ”¯æŒTree Shakingçš„ESM Polyfill</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ESMCompat</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">modules</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">usedExports</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>();
  }
  
  <span class="hljs-comment">// æ³¨å†Œæ¨¡å—</span>
  <span class="hljs-title function_">register</span>(<span class="hljs-params">name, code</span>) {
    <span class="hljs-keyword">const</span> ast = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">parse</span>(code);
    <span class="hljs-keyword">const</span> <span class="hljs-built_in">exports</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">extractExports</span>(ast);
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">modules</span>.<span class="hljs-title function_">set</span>(name, {
      code,
      ast,
      <span class="hljs-built_in">exports</span>,
      <span class="hljs-attr">used</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>()
    });
  }
  
  <span class="hljs-comment">// è§£æä»£ç ä¸ºASTï¼ˆç®€åŒ–ç‰ˆï¼‰</span>
  <span class="hljs-title function_">parse</span>(<span class="hljs-params">code</span>) {
    <span class="hljs-comment">// ç®€åŒ–å®ç°ï¼šå®é™…åº”ä½¿ç”¨Babelç­‰è§£æå™¨</span>
    <span class="hljs-keyword">const</span> exportMatches = code.<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/export\s+(const|let|var|function|class|default)\s+(\w+)/g</span>) || [];
    <span class="hljs-keyword">const</span> imports = code.<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/import\s+\{([^}]+)\}\s+from\s+['"]([^'"]+)['"]/g</span>) || [];
    
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">exports</span>: exportMatches.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">match</span> =&gt;</span> ({
        <span class="hljs-attr">type</span>: match.<span class="hljs-title function_">split</span>(<span class="hljs-string">' '</span>)[<span class="hljs-number">1</span>],
        <span class="hljs-attr">name</span>: match.<span class="hljs-title function_">split</span>(<span class="hljs-string">' '</span>)[<span class="hljs-number">2</span>]
      })),
      <span class="hljs-attr">imports</span>: imports.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">match</span> =&gt;</span> {
        <span class="hljs-keyword">const</span> parts = match.<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/import\s+\{([^}]+)\}\s+from\s+['"]([^'"]+)['"]/</span>);
        <span class="hljs-keyword">return</span> {
          <span class="hljs-attr">specifiers</span>: parts[<span class="hljs-number">1</span>].<span class="hljs-title function_">split</span>(<span class="hljs-string">','</span>).<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">s</span> =&gt;</span> s.<span class="hljs-title function_">trim</span>()),
          <span class="hljs-attr">source</span>: parts[<span class="hljs-number">2</span>]
        };
      })
    };
  }
  
  <span class="hljs-comment">// æå–å¯¼å‡º</span>
  <span class="hljs-title function_">extractExports</span>(<span class="hljs-params">ast</span>) {
    <span class="hljs-keyword">return</span> ast.<span class="hljs-property">exports</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">exp</span> =&gt;</span> exp.<span class="hljs-property">name</span>);
  }
  
  <span class="hljs-comment">// ä½¿ç”¨æ¨¡å—ï¼ˆæ ‡è®°ä½¿ç”¨çš„å¯¼å‡ºï¼‰</span>
  <span class="hljs-title function_">use</span>(<span class="hljs-params">name, ...<span class="hljs-built_in">exports</span></span>) {
    <span class="hljs-keyword">const</span> <span class="hljs-variable language_">module</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">modules</span>.<span class="hljs-title function_">get</span>(name);
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">module</span>) {
      <span class="hljs-built_in">exports</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">exp</span> =&gt;</span> {
        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span>.<span class="hljs-title function_">includes</span>(exp)) {
          <span class="hljs-variable language_">module</span>.<span class="hljs-property">used</span>.<span class="hljs-title function_">add</span>(exp);
        }
      });
    }
  }
  
  <span class="hljs-comment">// ç”Ÿæˆä¼˜åŒ–åçš„ä»£ç </span>
  <span class="hljs-title function_">generateOptimized</span>(<span class="hljs-params">name</span>) {
    <span class="hljs-keyword">const</span> <span class="hljs-variable language_">module</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">modules</span>.<span class="hljs-title function_">get</span>(name);
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">module</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">''</span>;
    
    <span class="hljs-keyword">let</span> code = <span class="hljs-variable language_">module</span>.<span class="hljs-property">code</span>;
    
    <span class="hljs-comment">// ç§»é™¤æœªä½¿ç”¨çš„å¯¼å‡ºï¼ˆç®€åŒ–å®ç°ï¼‰</span>
    <span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">exp</span> =&gt;</span> {
      <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">module</span>.<span class="hljs-property">used</span>.<span class="hljs-title function_">has</span>(exp)) {
        <span class="hljs-keyword">const</span> regex = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RegExp</span>(<span class="hljs-string">`export\\s+.*?\\b<span class="hljs-subst">${exp}</span>\\b[^;]*;`</span>, <span class="hljs-string">'g'</span>);
        code = code.<span class="hljs-title function_">replace</span>(regex, <span class="hljs-string">''</span>);
      }
    });
    
    <span class="hljs-keyword">return</span> code;
  }
}

<span class="hljs-comment">// ä½¿ç”¨ç¤ºä¾‹</span>
<span class="hljs-keyword">const</span> compat = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ESMCompat</span>();

compat.<span class="hljs-title function_">register</span>(<span class="hljs-string">'math'</span>, <span class="hljs-string">`
export const PI = 3.14159;
export function add(a, b) { return a + b; }
export function multiply(a, b) { return a * b; }
export function unusedFunction() { return 'unused'; }
`</span>);

<span class="hljs-comment">// æ ‡è®°ä½¿ç”¨çš„å¯¼å‡º</span>
compat.<span class="hljs-title function_">use</span>(<span class="hljs-string">'math'</span>, <span class="hljs-string">'PI'</span>, <span class="hljs-string">'add'</span>);

<span class="hljs-comment">// ç”Ÿæˆä¼˜åŒ–ä»£ç </span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(compat.<span class="hljs-title function_">generateOptimized</span>(<span class="hljs-string">'math'</span>));
<span class="hljs-comment">// è¾“å‡ºå°†åªåŒ…å«PIå’Œaddçš„å¯¼å‡º</span>
</code></pre>
<h4 data-id="heading-11">äº”ã€æ¨¡å—åŒ–æ„å»ºå·¥å…·é›†æˆ</h4>
<p>ç°ä»£å¼€å‘ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨æ„å»ºå·¥å…·å¤„ç†æ¨¡å—åŒ–ã€‚ä»¥ä¸‹å±•ç¤ºå¦‚ä½•é›†æˆWebpack-likeçš„ç®€å•æ‰“åŒ…å™¨ã€‚</p>
<h5 data-id="heading-12">5.1 ç®€æ˜“æ¨¡å—æ‰“åŒ…å™¨</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>);
<span class="hljs-keyword">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>);
<span class="hljs-keyword">const</span> { parse } = <span class="hljs-built_in">require</span>(<span class="hljs-string">'@babel/parser'</span>);
<span class="hljs-keyword">const</span> traverse = <span class="hljs-built_in">require</span>(<span class="hljs-string">'@babel/traverse'</span>).<span class="hljs-property">default</span>;
<span class="hljs-keyword">const</span> generate = <span class="hljs-built_in">require</span>(<span class="hljs-string">'@babel/generator'</span>).<span class="hljs-property">default</span>;
<span class="hljs-keyword">const</span> t = <span class="hljs-built_in">require</span>(<span class="hljs-string">'@babel/types'</span>);

<span class="hljs-keyword">class</span> <span class="hljs-title class_">SimpleBundler</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">entry</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">entry</span> = entry;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">modules</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">moduleId</span> = <span class="hljs-number">0</span>;
  }
  
  <span class="hljs-comment">// æ„å»º</span>
  <span class="hljs-title function_">build</span>(<span class="hljs-params">outputPath</span>) {
    <span class="hljs-keyword">const</span> entryModule = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">collectDependencies</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">entry</span>);
    <span class="hljs-keyword">const</span> bundleCode = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">generateBundle</span>(entryModule);
    
    fs.<span class="hljs-title function_">writeFileSync</span>(outputPath, bundleCode);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Bundle generated: <span class="hljs-subst">${outputPath}</span>`</span>);
  }
  
  <span class="hljs-comment">// æ”¶é›†ä¾èµ–</span>
  <span class="hljs-title function_">collectDependencies</span>(<span class="hljs-params">filePath</span>) {
    <span class="hljs-keyword">const</span> fileContent = fs.<span class="hljs-title function_">readFileSync</span>(filePath, <span class="hljs-string">'utf-8'</span>);
    <span class="hljs-keyword">const</span> ast = <span class="hljs-title function_">parse</span>(fileContent, {
      <span class="hljs-attr">sourceType</span>: <span class="hljs-string">'module'</span>,
      <span class="hljs-attr">plugins</span>: [<span class="hljs-string">'jsx'</span>]
    });
    
    <span class="hljs-keyword">const</span> dependencies = [];
    <span class="hljs-keyword">const</span> dirname = path.<span class="hljs-title function_">dirname</span>(filePath);
    
    <span class="hljs-comment">// éå†ASTæ”¶é›†importè¯­å¥</span>
    <span class="hljs-title function_">traverse</span>(ast, {
      <span class="hljs-title class_">ImportDeclaration</span>: <span class="hljs-function">(<span class="hljs-params">{ node }</span>) =&gt;</span> {
        <span class="hljs-keyword">const</span> importPath = node.<span class="hljs-property">source</span>.<span class="hljs-property">value</span>;
        <span class="hljs-keyword">const</span> absolutePath = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">resolvePath</span>(importPath, dirname);
        dependencies.<span class="hljs-title function_">push</span>(absolutePath);
      },
      <span class="hljs-title class_">CallExpression</span>: <span class="hljs-function">(<span class="hljs-params">{ node }</span>) =&gt;</span> {
        <span class="hljs-keyword">if</span> (node.<span class="hljs-property">callee</span>.<span class="hljs-property">type</span> === <span class="hljs-string">'Import'</span>) {
          <span class="hljs-keyword">const</span> importPath = node.<span class="hljs-property">arguments</span>[<span class="hljs-number">0</span>].<span class="hljs-property">value</span>;
          <span class="hljs-keyword">const</span> absolutePath = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">resolvePath</span>(importPath, dirname);
          dependencies.<span class="hljs-title function_">push</span>(absolutePath);
        }
      }
    });
    
    <span class="hljs-keyword">const</span> moduleId = <span class="hljs-variable language_">this</span>.<span class="hljs-property">moduleId</span>++;
    <span class="hljs-keyword">const</span> <span class="hljs-variable language_">module</span> = {
      <span class="hljs-attr">id</span>: moduleId,
      filePath,
      <span class="hljs-attr">code</span>: fileContent,
      dependencies,
      <span class="hljs-attr">mapping</span>: {}
    };
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">modules</span>.<span class="hljs-title function_">set</span>(filePath, <span class="hljs-variable language_">module</span>);
    
    <span class="hljs-comment">// é€’å½’æ”¶é›†ä¾èµ–</span>
    dependencies.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">dep</span> =&gt;</span> {
      <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">modules</span>.<span class="hljs-title function_">has</span>(dep)) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">collectDependencies</span>(dep);
      }
    });
    
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">module</span>;
  }
  
  <span class="hljs-comment">// è§£æè·¯å¾„</span>
  <span class="hljs-title function_">resolvePath</span>(<span class="hljs-params">importPath, baseDir</span>) {
    <span class="hljs-keyword">if</span> (importPath.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'.'</span>)) {
      <span class="hljs-keyword">return</span> path.<span class="hljs-title function_">resolve</span>(baseDir, importPath);
    }
    <span class="hljs-comment">// å¤„ç†node_modulesï¼ˆç®€åŒ–ï¼‰</span>
    <span class="hljs-keyword">const</span> nodeModulePath = path.<span class="hljs-title function_">resolve</span>(process.<span class="hljs-title function_">cwd</span>(), <span class="hljs-string">'node_modules'</span>, importPath);
    <span class="hljs-keyword">if</span> (fs.<span class="hljs-title function_">existsSync</span>(nodeModulePath)) {
      <span class="hljs-keyword">return</span> nodeModulePath;
    }
    <span class="hljs-keyword">return</span> importPath;
  }
  
  <span class="hljs-comment">// ç”Ÿæˆæ‰“åŒ…ä»£ç </span>
  <span class="hljs-title function_">generateBundle</span>(<span class="hljs-params">entryModule</span>) {
    <span class="hljs-keyword">const</span> modules = [];
    
    <span class="hljs-comment">// åˆ›å»ºæ¨¡å—æ˜ å°„</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">modules</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">module</span> =&gt;</span> {
      <span class="hljs-keyword">const</span> transformedCode = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">transformModule</span>(<span class="hljs-variable language_">module</span>);
      modules.<span class="hljs-title function_">push</span>(<span class="hljs-string">`
        <span class="hljs-subst">${<span class="hljs-variable language_">module</span>.id}</span>: {
          factory: function(require, module, exports) {
            <span class="hljs-subst">${transformedCode}</span>
          },
          mapping: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(<span class="hljs-variable language_">module</span>.mapping)}</span>
        }
      `</span>);
    });
    
    <span class="hljs-comment">// ç”Ÿæˆè¿è¡Œæ—¶</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">`
      (function(modules) {
        const moduleCache = {};
        
        function require(id) {
          if (moduleCache[id]) {
            return moduleCache[id].exports;
          }
          
          const mod = modules[id];
          const localRequire = function(modulePath) {
            return require(mod.mapping[modulePath]);
          };
          
          const module = { exports: {} };
          mod.factory(localRequire, module, module.exports);
          
          moduleCache[id] = module;
          return module.exports;
        }
        
        // å¯åŠ¨å…¥å£æ¨¡å—
        require(0);
      })({
        <span class="hljs-subst">${modules.join(<span class="hljs-string">',\n'</span>)}</span>
      });
    `</span>;
  }
  
  <span class="hljs-comment">// è½¬æ¢æ¨¡å—ä»£ç </span>
  <span class="hljs-title function_">transformModule</span>(<span class="hljs-params"><span class="hljs-variable language_">module</span></span>) {
    <span class="hljs-keyword">const</span> ast = <span class="hljs-title function_">parse</span>(<span class="hljs-variable language_">module</span>.<span class="hljs-property">code</span>, {
      <span class="hljs-attr">sourceType</span>: <span class="hljs-string">'module'</span>
    });
    
    <span class="hljs-comment">// æ„å»ºè·¯å¾„æ˜ å°„</span>
    <span class="hljs-keyword">let</span> importIndex = <span class="hljs-number">0</span>;
    
    <span class="hljs-title function_">traverse</span>(ast, {
      <span class="hljs-title class_">ImportDeclaration</span>: <span class="hljs-function">(<span class="hljs-params">{ node }</span>) =&gt;</span> {
        <span class="hljs-keyword">const</span> importPath = node.<span class="hljs-property">source</span>.<span class="hljs-property">value</span>;
        <span class="hljs-keyword">const</span> depModule = <span class="hljs-variable language_">this</span>.<span class="hljs-property">modules</span>.<span class="hljs-title function_">get</span>(
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">resolvePath</span>(importPath, path.<span class="hljs-title function_">dirname</span>(<span class="hljs-variable language_">module</span>.<span class="hljs-property">filePath</span>))
        );
        
        <span class="hljs-keyword">if</span> (depModule) {
          <span class="hljs-keyword">const</span> importName = <span class="hljs-string">`__import_<span class="hljs-subst">${importIndex++}</span>`</span>;
          <span class="hljs-variable language_">module</span>.<span class="hljs-property">mapping</span>[importPath] = depModule.<span class="hljs-property">id</span>;
          
          <span class="hljs-comment">// æ›¿æ¢importè¯­å¥</span>
          <span class="hljs-keyword">const</span> specifiers = node.<span class="hljs-property">specifiers</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">spec</span> =&gt;</span> {
            <span class="hljs-keyword">if</span> (t.<span class="hljs-title function_">isImportDefaultSpecifier</span>(spec)) {
              <span class="hljs-keyword">return</span> t.<span class="hljs-title function_">variableDeclarator</span>(
                spec.<span class="hljs-property">local</span>,
                t.<span class="hljs-title function_">memberExpression</span>(
                  t.<span class="hljs-title function_">identifier</span>(importName),
                  t.<span class="hljs-title function_">identifier</span>(<span class="hljs-string">'default'</span>)
                )
              );
            } <span class="hljs-keyword">else</span> {
              <span class="hljs-keyword">return</span> t.<span class="hljs-title function_">variableDeclarator</span>(
                spec.<span class="hljs-property">local</span>,
                t.<span class="hljs-title function_">memberExpression</span>(
                  t.<span class="hljs-title function_">identifier</span>(importName),
                  spec.<span class="hljs-property">imported</span> || spec.<span class="hljs-property">local</span>
                )
              );
            }
          });
          
          <span class="hljs-keyword">return</span> t.<span class="hljs-title function_">variableDeclaration</span>(<span class="hljs-string">'const'</span>, specifiers);
        }
      }
    });
    
    <span class="hljs-comment">// ç§»é™¤exportè¯­å¥</span>
    <span class="hljs-title function_">traverse</span>(ast, {
      <span class="hljs-title class_">ExportNamedDeclaration</span>: <span class="hljs-function">(<span class="hljs-params">{ node, remove }</span>) =&gt;</span> {
        <span class="hljs-keyword">if</span> (node.<span class="hljs-property">declaration</span>) {
          <span class="hljs-keyword">return</span> node.<span class="hljs-property">declaration</span>;
        }
        <span class="hljs-title function_">remove</span>();
      },
      <span class="hljs-title class_">ExportDefaultDeclaration</span>: <span class="hljs-function">(<span class="hljs-params">{ node }</span>) =&gt;</span> {
        <span class="hljs-keyword">return</span> t.<span class="hljs-title function_">expressionStatement</span>(
          t.<span class="hljs-title function_">assignmentExpression</span>(
            <span class="hljs-string">'='</span>,
            t.<span class="hljs-title function_">memberExpression</span>(
              t.<span class="hljs-title function_">identifier</span>(<span class="hljs-string">'module'</span>),
              t.<span class="hljs-title function_">identifier</span>(<span class="hljs-string">'exports'</span>)
            ),
            t.<span class="hljs-title function_">objectExpression</span>([
              t.<span class="hljs-title function_">objectProperty</span>(
                t.<span class="hljs-title function_">identifier</span>(<span class="hljs-string">'default'</span>),
                node.<span class="hljs-property">declaration</span>
              )
            ])
          )
        );
      }
    });
    
    <span class="hljs-keyword">const</span> { code } = <span class="hljs-title function_">generate</span>(ast);
    <span class="hljs-keyword">return</span> code;
  }
}

<span class="hljs-comment">// ä½¿ç”¨ç¤ºä¾‹</span>
<span class="hljs-keyword">const</span> bundler = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleBundler</span>(<span class="hljs-string">'./src/index.js'</span>);
bundler.<span class="hljs-title function_">build</span>(<span class="hljs-string">'./dist/bundle.js'</span>);
</code></pre>
<h4 data-id="heading-13">å…­ã€æ¨¡å—è”é‚¦ä¸å¾®å‰ç«¯æ¶æ„</h4>
<p>æ¨¡å—è”é‚¦ï¼ˆModule Federationï¼‰æ˜¯Webpack 5å¼•å…¥çš„é‡è¦ç‰¹æ€§ï¼Œæ”¯æŒè·¨åº”ç”¨å…±äº«æ¨¡å—ã€‚</p>
<h5 data-id="heading-14">6.1 ç®€æ˜“æ¨¡å—è”é‚¦å®ç°</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// æ¨¡å—è”é‚¦ç®¡ç†å™¨</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ModuleFederation</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">config</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span> = config;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">remotes</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">exposes</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">shared</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">init</span>();
  }
  
  <span class="hljs-title function_">init</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// åˆå§‹åŒ–å…±äº«æ¨¡å—</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>.<span class="hljs-property">shared</span>) {
      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>.<span class="hljs-property">shared</span>).<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">[name, config]</span>) =&gt;</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">shared</span>.<span class="hljs-title function_">set</span>(name, {
          <span class="hljs-attr">module</span>: <span class="hljs-built_in">require</span>(name),
          <span class="hljs-attr">version</span>: config.<span class="hljs-property">version</span>,
          <span class="hljs-attr">singleton</span>: config.<span class="hljs-property">singleton</span> || <span class="hljs-literal">false</span>
        });
      });
    }
    
    <span class="hljs-comment">// åˆå§‹åŒ–æš´éœ²æ¨¡å—</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>.<span class="hljs-property">exposes</span>) {
      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>.<span class="hljs-property">exposes</span>).<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">[name, modulePath]</span>) =&gt;</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">exposes</span>.<span class="hljs-title function_">set</span>(name, <span class="hljs-built_in">require</span>(modulePath));
      });
    }
  }
  
  <span class="hljs-comment">// æ³¨å†Œè¿œç¨‹åº”ç”¨</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">registerRemote</span>(<span class="hljs-params">name, url</span>) {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> remoteManifest = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">fetchRemoteManifest</span>(url);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">remotes</span>.<span class="hljs-title function_">set</span>(name, {
        url,
        <span class="hljs-attr">manifest</span>: remoteManifest
      });
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Remote <span class="hljs-subst">${name}</span> registered`</span>);
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to register remote <span class="hljs-subst">${name}</span>:`</span>, error);
    }
  }
  
  <span class="hljs-comment">// è·å–è¿œç¨‹æ¸…å•</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">fetchRemoteManifest</span>(<span class="hljs-params">url</span>) {
    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">`<span class="hljs-subst">${url}</span>/federation-manifest.json`</span>);
    <span class="hljs-keyword">return</span> response.<span class="hljs-title function_">json</span>();
  }
  
  <span class="hljs-comment">// è·å–æ¨¡å—</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">getModule</span>(<span class="hljs-params">remoteName, moduleName</span>) {
    <span class="hljs-comment">// æ£€æŸ¥å…±äº«æ¨¡å—</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">shared</span>.<span class="hljs-title function_">has</span>(moduleName)) {
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">shared</span>.<span class="hljs-title function_">get</span>(moduleName).<span class="hljs-property">module</span>;
    }
    
    <span class="hljs-comment">// æ£€æŸ¥æœ¬åœ°æš´éœ²</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">exposes</span>.<span class="hljs-title function_">has</span>(moduleName)) {
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">exposes</span>.<span class="hljs-title function_">get</span>(moduleName);
    }
    
    <span class="hljs-comment">// æ£€æŸ¥è¿œç¨‹æ¨¡å—</span>
    <span class="hljs-keyword">const</span> remote = <span class="hljs-variable language_">this</span>.<span class="hljs-property">remotes</span>.<span class="hljs-title function_">get</span>(remoteName);
    <span class="hljs-keyword">if</span> (remote) {
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">loadRemoteModule</span>(remote, moduleName);
    }
    
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`Module <span class="hljs-subst">${moduleName}</span> not found`</span>);
  }
  
  <span class="hljs-comment">// åŠ è½½è¿œç¨‹æ¨¡å—</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">loadRemoteModule</span>(<span class="hljs-params">remote, moduleName</span>) {
    <span class="hljs-keyword">const</span> moduleUrl = <span class="hljs-string">`<span class="hljs-subst">${remote.url}</span>/<span class="hljs-subst">${moduleName}</span>.js`</span>;
    
    <span class="hljs-comment">// åŠ¨æ€åŠ è½½è„šæœ¬</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> script = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'script'</span>);
      script.<span class="hljs-property">src</span> = moduleUrl;
      
      script.<span class="hljs-property">onload</span> = <span class="hljs-function">() =&gt;</span> {
        <span class="hljs-comment">// å‡è®¾è¿œç¨‹æ¨¡å—ä¼šæš´éœ²åˆ°å…¨å±€</span>
        <span class="hljs-keyword">const</span> <span class="hljs-variable language_">module</span> = <span class="hljs-variable language_">window</span>[<span class="hljs-string">`<span class="hljs-subst">${remote.name}</span>_<span class="hljs-subst">${moduleName}</span>`</span>];
        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">module</span>) {
          <span class="hljs-title function_">resolve</span>(<span class="hljs-variable language_">module</span>);
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`Module <span class="hljs-subst">${moduleName}</span> not found in remote`</span>));
        }
      };
      
      script.<span class="hljs-property">onerror</span> = reject;
      <span class="hljs-variable language_">document</span>.<span class="hljs-property">head</span>.<span class="hljs-title function_">appendChild</span>(script);
    });
  }
  
  <span class="hljs-comment">// æš´éœ²æ¨¡å—</span>
  <span class="hljs-title function_">expose</span>(<span class="hljs-params">name, <span class="hljs-variable language_">module</span></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">exposes</span>.<span class="hljs-title function_">set</span>(name, <span class="hljs-variable language_">module</span>);
    <span class="hljs-comment">// æš´éœ²åˆ°å…¨å±€ï¼ˆä¾›è¿œç¨‹è®¿é—®ï¼‰</span>
    <span class="hljs-variable language_">window</span>[<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.config.name}</span>_<span class="hljs-subst">${name}</span>`</span>] = <span class="hljs-variable language_">module</span>;
  }
}

<span class="hljs-comment">// ä½¿ç”¨ç¤ºä¾‹</span>
<span class="hljs-comment">// App 1 é…ç½®</span>
<span class="hljs-keyword">const</span> federation1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ModuleFederation</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">'app1'</span>,
  <span class="hljs-attr">exposes</span>: {
    <span class="hljs-string">'./Button'</span>: <span class="hljs-string">'./src/components/Button.js'</span>
  },
  <span class="hljs-attr">shared</span>: {
    <span class="hljs-attr">react</span>: { <span class="hljs-attr">singleton</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">version</span>: <span class="hljs-string">'17.0.0'</span> },
    <span class="hljs-string">'react-dom'</span>: { <span class="hljs-attr">singleton</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">version</span>: <span class="hljs-string">'17.0.0'</span> }
  }
});

<span class="hljs-comment">// App 2 é…ç½®</span>
<span class="hljs-keyword">const</span> federation2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ModuleFederation</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">'app2'</span>,
  <span class="hljs-attr">remotes</span>: {
    <span class="hljs-attr">app1</span>: <span class="hljs-string">'http://localhost:3001'</span>
  },
  <span class="hljs-attr">shared</span>: {
    <span class="hljs-attr">react</span>: { <span class="hljs-attr">singleton</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">version</span>: <span class="hljs-string">'17.0.0'</span> }
  }
});

<span class="hljs-comment">// App2ä¸­ä½¿ç”¨App1çš„æ¨¡å—</span>
federation2.<span class="hljs-title function_">getModule</span>(<span class="hljs-string">'app1'</span>, <span class="hljs-string">'Button'</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">Button</span> =&gt;</span> {
  <span class="hljs-comment">// ä½¿ç”¨è¿œç¨‹Buttonç»„ä»¶</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Remote Button loaded:'</span>, <span class="hljs-title class_">Button</span>);
});
</code></pre>
<h5 data-id="heading-15">ä¸ƒã€æ¨¡å—åŒ–æ€§èƒ½ä¼˜åŒ–</h5>
<h5 data-id="heading-16">7.1 ä»£ç åˆ†å‰²ä¸æ‡’åŠ è½½</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">CodeSplitter</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">chunks</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">loadedChunks</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>();
  }
  
  <span class="hljs-comment">// å®šä¹‰ä»£ç åˆ†å‰²ç‚¹</span>
  <span class="hljs-title function_">defineChunk</span>(<span class="hljs-params">name, getChunk</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">chunks</span>.<span class="hljs-title function_">set</span>(name, getChunk);
  }
  
  <span class="hljs-comment">// æ‡’åŠ è½½ä»£ç å—</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">loadChunk</span>(<span class="hljs-params">name</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">loadedChunks</span>.<span class="hljs-title function_">has</span>(name)) {
      <span class="hljs-keyword">return</span>;
    }
    
    <span class="hljs-keyword">const</span> getChunk = <span class="hljs-variable language_">this</span>.<span class="hljs-property">chunks</span>.<span class="hljs-title function_">get</span>(name);
    <span class="hljs-keyword">if</span> (!getChunk) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`Chunk <span class="hljs-subst">${name}</span> not found`</span>);
    }
    
    <span class="hljs-comment">// æ ‡è®°ä¸ºåŠ è½½ä¸­</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">loadedChunks</span>.<span class="hljs-title function_">add</span>(name);
    
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">await</span> <span class="hljs-title function_">getChunk</span>();
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Chunk <span class="hljs-subst">${name}</span> loaded`</span>);
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">loadedChunks</span>.<span class="hljs-title function_">delete</span>(name);
      <span class="hljs-keyword">throw</span> error;
    }
  }
  
  <span class="hljs-comment">// é¢„åŠ è½½ä»£ç å—</span>
  <span class="hljs-title function_">preloadChunk</span>(<span class="hljs-params">name</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">loadedChunks</span>.<span class="hljs-title function_">has</span>(name)) <span class="hljs-keyword">return</span>;
    
    <span class="hljs-keyword">const</span> link = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'link'</span>);
    link.<span class="hljs-property">rel</span> = <span class="hljs-string">'preload'</span>;
    link.<span class="hljs-property">as</span> = <span class="hljs-string">'script'</span>;
    
    <span class="hljs-keyword">const</span> getChunk = <span class="hljs-variable language_">this</span>.<span class="hljs-property">chunks</span>.<span class="hljs-title function_">get</span>(name);
    <span class="hljs-keyword">if</span> (getChunk &amp;&amp; getChunk.<span class="hljs-property">chunkPath</span>) {
      link.<span class="hljs-property">href</span> = getChunk.<span class="hljs-property">chunkPath</span>;
      <span class="hljs-variable language_">document</span>.<span class="hljs-property">head</span>.<span class="hljs-title function_">appendChild</span>(link);
    }
  }
}

<span class="hljs-comment">// WebpackåŠ¨æ€å¯¼å…¥å…¼å®¹</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">dynamicImport</span>(<span class="hljs-params">modulePath</span>) {
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> __webpack_require__ !== <span class="hljs-string">'undefined'</span>) {
    <span class="hljs-comment">// Webpackç¯å¢ƒ</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">import</span>(<span class="hljs-comment">/* webpackChunkName: "[request]" */</span> modulePath);
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// åŸç”Ÿç¯å¢ƒ</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">import</span>(modulePath);
  }
}

<span class="hljs-comment">// ä½¿ç”¨ç¤ºä¾‹</span>
<span class="hljs-keyword">const</span> splitter = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CodeSplitter</span>();

<span class="hljs-comment">// å®šä¹‰ä»£ç å—</span>
splitter.<span class="hljs-title function_">defineChunk</span>(<span class="hljs-string">'dashboard'</span>, <span class="hljs-function">() =&gt;</span> 
  <span class="hljs-title function_">dynamicImport</span>(<span class="hljs-string">'./Dashboard.js'</span>)
);

splitter.<span class="hljs-title function_">defineChunk</span>(<span class="hljs-string">'analytics'</span>, <span class="hljs-function">() =&gt;</span> 
  <span class="hljs-title function_">dynamicImport</span>(<span class="hljs-string">'./Analytics.js'</span>)
);

<span class="hljs-comment">// è·¯ç”±æ‡’åŠ è½½</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">loadRoute</span>(<span class="hljs-params">routeName</span>) {
  <span class="hljs-keyword">switch</span> (routeName) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">'dashboard'</span>:
      <span class="hljs-keyword">await</span> splitter.<span class="hljs-title function_">loadChunk</span>(<span class="hljs-string">'dashboard'</span>);
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-string">'analytics'</span>:
      <span class="hljs-keyword">await</span> splitter.<span class="hljs-title function_">loadChunk</span>(<span class="hljs-string">'analytics'</span>);
      <span class="hljs-keyword">break</span>;
  }
}

<span class="hljs-comment">// é¢„åŠ è½½</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'mouseover'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
  <span class="hljs-keyword">if</span> (e.<span class="hljs-property">target</span>.<span class="hljs-property">href</span> &amp;&amp; e.<span class="hljs-property">target</span>.<span class="hljs-property">href</span>.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'dashboard'</span>)) {
    splitter.<span class="hljs-title function_">preloadChunk</span>(<span class="hljs-string">'dashboard'</span>);
  }
});
</code></pre>
<h5 data-id="heading-17">7.2 æ¨¡å—ç¼“å­˜ç­–ç•¥</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ModuleCache</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">ttl</span> = <span class="hljs-number">5</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>; <span class="hljs-comment">// 5åˆ†é’Ÿ</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxSize</span> = <span class="hljs-number">100</span>; <span class="hljs-comment">// æœ€å¤§ç¼“å­˜æ¨¡å—æ•°</span>
  }
  
  <span class="hljs-comment">// è·å–æ¨¡å—</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">get</span>(<span class="hljs-params">key, fetchModule</span>) {
    <span class="hljs-keyword">const</span> cached = <span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>.<span class="hljs-title function_">get</span>(key);
    
    <span class="hljs-comment">// æ£€æŸ¥ç¼“å­˜æ˜¯å¦æœ‰æ•ˆ</span>
    <span class="hljs-keyword">if</span> (cached &amp;&amp; <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() - cached.<span class="hljs-property">timestamp</span> &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">ttl</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Cache hit: <span class="hljs-subst">${key}</span>`</span>);
      <span class="hljs-keyword">return</span> cached.<span class="hljs-property">module</span>;
    }
    
    <span class="hljs-comment">// ç¼“å­˜å¤±æ•ˆæˆ–ä¸å­˜åœ¨ï¼Œé‡æ–°è·å–</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Cache miss: <span class="hljs-subst">${key}</span>`</span>);
    <span class="hljs-keyword">const</span> <span class="hljs-variable language_">module</span> = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchModule</span>();
    
    <span class="hljs-comment">// æ›´æ–°ç¼“å­˜</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">set</span>(key, <span class="hljs-variable language_">module</span>);
    
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">module</span>;
  }
  
  <span class="hljs-comment">// è®¾ç½®ç¼“å­˜</span>
  <span class="hljs-title function_">set</span>(<span class="hljs-params">key, <span class="hljs-variable language_">module</span></span>) {
    <span class="hljs-comment">// æ¸…ç†è¿‡æœŸç¼“å­˜</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">cleanup</span>();
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>.<span class="hljs-title function_">set</span>(key, {
      <span class="hljs-variable language_">module</span>,
      <span class="hljs-attr">timestamp</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>()
    });
  }
  
  <span class="hljs-comment">// æ¸…ç†ç¼“å­˜</span>
  <span class="hljs-title function_">cleanup</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> now = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
    
    <span class="hljs-comment">// æ¸…ç†è¿‡æœŸ</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> [key, value] <span class="hljs-keyword">of</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>) {
      <span class="hljs-keyword">if</span> (now - value.<span class="hljs-property">timestamp</span> &gt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">ttl</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>.<span class="hljs-title function_">delete</span>(key);
      }
    }
    
    <span class="hljs-comment">// æ¸…ç†è¶…å‡ºå¤§å°é™åˆ¶çš„ï¼ˆLRUç­–ç•¥ï¼‰</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>.<span class="hljs-property">size</span> &gt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxSize</span>) {
      <span class="hljs-keyword">const</span> entries = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>.<span class="hljs-title function_">entries</span>());
      entries.<span class="hljs-title function_">sort</span>(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> a[<span class="hljs-number">1</span>].<span class="hljs-property">timestamp</span> - b[<span class="hljs-number">1</span>].<span class="hljs-property">timestamp</span>);
      
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; entries.<span class="hljs-property">length</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxSize</span>; i++) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>.<span class="hljs-title function_">delete</span>(entries[i][<span class="hljs-number">0</span>]);
      }
    }
  }
  
  <span class="hljs-comment">// æ¸…ç©ºç¼“å­˜</span>
  <span class="hljs-title function_">clear</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>.<span class="hljs-title function_">clear</span>();
  }
}

<span class="hljs-comment">// ä½¿ç”¨ç¤ºä¾‹</span>
<span class="hljs-keyword">const</span> moduleCache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ModuleCache</span>();

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">loadModuleWithCache</span>(<span class="hljs-params">modulePath</span>) {
  <span class="hljs-keyword">return</span> moduleCache.<span class="hljs-title function_">get</span>(modulePath, <span class="hljs-keyword">async</span> () =&gt; {
    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(modulePath);
    <span class="hljs-keyword">return</span> response.<span class="hljs-title function_">text</span>();
  });
}
</code></pre>
<h4 data-id="heading-18">å…«ã€æ¨¡å—åŒ–æœ€ä½³å®è·µä¸å·¥ç¨‹åŒ–</h4>
<h5 data-id="heading-19">8.1 æ¨¡å—è®¾è®¡åŸåˆ™</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 1. å•ä¸€èŒè´£åŸåˆ™</span>
<span class="hljs-comment">// ä¸å¥½çš„ä¾‹å­</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserManager</span> {
  <span class="hljs-comment">// æ··åˆäº†ç”¨æˆ·ç®¡ç†ã€éªŒè¯ã€é€šçŸ¥ç­‰å¤šä¸ªèŒè´£</span>
}

<span class="hljs-comment">// å¥½çš„ä¾‹å­</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserRepository</span> {
  <span class="hljs-comment">// åªè´Ÿè´£æ•°æ®è®¿é—®</span>
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserValidator</span> {
  <span class="hljs-comment">// åªè´Ÿè´£éªŒè¯</span>
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserNotifier</span> {
  <span class="hljs-comment">// åªè´Ÿè´£é€šçŸ¥</span>
}

<span class="hljs-comment">// 2. ä¾èµ–æ³¨å…¥</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">userRepository, validator, notifier</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">userRepository</span> = userRepository;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">validator</span> = validator;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">notifier</span> = notifier;
  }
  
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">register</span>(<span class="hljs-params">user</span>) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">validator</span>.<span class="hljs-title function_">validate</span>(user)) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'Invalid user'</span>);
    }
    
    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">userRepository</span>.<span class="hljs-title function_">save</span>(user);
    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">notifier</span>.<span class="hljs-title function_">sendWelcome</span>(user.<span class="hljs-property">email</span>);
  }
}

<span class="hljs-comment">// 3. æ¥å£æŠ½è±¡</span>
<span class="hljs-comment">// å®šä¹‰æ¥å£</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">IStorage</span> {
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">save</span>(<span class="hljs-params">key, value</span>) {}
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">get</span>(<span class="hljs-params">key</span>) {}
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">key</span>) {}
}

<span class="hljs-comment">// å…·ä½“å®ç°</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">LocalStorage</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">IStorage</span> {
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">save</span>(<span class="hljs-params">key, value</span>) {
    <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(key, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(value));
  }
  
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">get</span>(<span class="hljs-params">key</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(<span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(key));
  }
  
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">key</span>) {
    <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">removeItem</span>(key);
  }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">APIService</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">storage</span>) {
    <span class="hljs-keyword">if</span> (!(storage <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">IStorage</span>)) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'Invalid storage implementation'</span>);
    }
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">storage</span> = storage;
  }
}
</code></pre>
<h5 data-id="heading-20">8.2 æ¨¡å—ç‰ˆæœ¬ç®¡ç†ä¸å‡çº§</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ModuleVersionManager</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">versions</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">deprecations</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
  }
  
  <span class="hljs-comment">// æ³¨å†Œæ¨¡å—ç‰ˆæœ¬</span>
  <span class="hljs-title function_">register</span>(<span class="hljs-params">moduleName, version, <span class="hljs-variable language_">module</span></span>) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">versions</span>.<span class="hljs-title function_">has</span>(moduleName)) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">versions</span>.<span class="hljs-title function_">set</span>(moduleName, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>());
    }
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">versions</span>.<span class="hljs-title function_">get</span>(moduleName).<span class="hljs-title function_">set</span>(version, <span class="hljs-variable language_">module</span>);
  }
  
  <span class="hljs-comment">// è·å–æ¨¡å—ï¼ˆæ”¯æŒè¯­ä¹‰åŒ–ç‰ˆæœ¬ï¼‰</span>
  <span class="hljs-title function_">get</span>(<span class="hljs-params">moduleName, versionRange = <span class="hljs-string">'latest'</span></span>) {
    <span class="hljs-keyword">const</span> moduleVersions = <span class="hljs-variable language_">this</span>.<span class="hljs-property">versions</span>.<span class="hljs-title function_">get</span>(moduleName);
    <span class="hljs-keyword">if</span> (!moduleVersions) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`Module <span class="hljs-subst">${moduleName}</span> not found`</span>);
    }
    
    <span class="hljs-keyword">if</span> (versionRange === <span class="hljs-string">'latest'</span>) {
      <span class="hljs-keyword">const</span> latestVersion = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(moduleVersions.<span class="hljs-title function_">keys</span>())
        .<span class="hljs-title function_">sort</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">compareVersions</span>)
        .<span class="hljs-title function_">pop</span>();
      <span class="hljs-keyword">return</span> moduleVersions.<span class="hljs-title function_">get</span>(latestVersion);
    }
    
    <span class="hljs-comment">// ç®€åŒ–çš„ç‰ˆæœ¬èŒƒå›´è§£æ</span>
    <span class="hljs-keyword">const</span> availableVersions = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(moduleVersions.<span class="hljs-title function_">keys</span>())
      .<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">v</span> =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">satisfiesVersion</span>(v, versionRange))
      .<span class="hljs-title function_">sort</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">compareVersions</span>);
    
    <span class="hljs-keyword">if</span> (availableVersions.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`No version of <span class="hljs-subst">${moduleName}</span> satisfies <span class="hljs-subst">${versionRange}</span>`</span>);
    }
    
    <span class="hljs-keyword">return</span> moduleVersions.<span class="hljs-title function_">get</span>(availableVersions.<span class="hljs-title function_">pop</span>());
  }
  
  <span class="hljs-comment">// æ¯”è¾ƒç‰ˆæœ¬</span>
  <span class="hljs-title function_">compareVersions</span>(<span class="hljs-params">v1, v2</span>) {
    <span class="hljs-keyword">const</span> parts1 = v1.<span class="hljs-title function_">split</span>(<span class="hljs-string">'.'</span>).<span class="hljs-title function_">map</span>(<span class="hljs-title class_">Number</span>);
    <span class="hljs-keyword">const</span> parts2 = v2.<span class="hljs-title function_">split</span>(<span class="hljs-string">'.'</span>).<span class="hljs-title function_">map</span>(<span class="hljs-title class_">Number</span>);
    
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; i++) {
      <span class="hljs-keyword">if</span> (parts1[i] !== parts2[i]) {
        <span class="hljs-keyword">return</span> parts1[i] - parts2[i];
      }
    }
    
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
  }
  
  <span class="hljs-comment">// æ£€æŸ¥ç‰ˆæœ¬æ˜¯å¦æ»¡è¶³èŒƒå›´</span>
  <span class="hljs-title function_">satisfiesVersion</span>(<span class="hljs-params">version, range</span>) {
    <span class="hljs-comment">// ç®€åŒ–å®ç°ï¼Œå®é™…åº”ä½¿ç”¨semveråº“</span>
    <span class="hljs-keyword">if</span> (range === <span class="hljs-string">'*'</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    
    <span class="hljs-keyword">const</span> [op, versionRange] = range.<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/^([&gt;=&lt;~^]*)(\d+\.\d+\.\d+)$/</span>).<span class="hljs-title function_">slice</span>(<span class="hljs-number">1</span>);
    <span class="hljs-keyword">const</span> vParts = version.<span class="hljs-title function_">split</span>(<span class="hljs-string">'.'</span>).<span class="hljs-title function_">map</span>(<span class="hljs-title class_">Number</span>);
    <span class="hljs-keyword">const</span> rParts = versionRange.<span class="hljs-title function_">split</span>(<span class="hljs-string">'.'</span>).<span class="hljs-title function_">map</span>(<span class="hljs-title class_">Number</span>);
    
    <span class="hljs-keyword">switch</span> (op) {
      <span class="hljs-keyword">case</span> <span class="hljs-string">'^'</span>: <span class="hljs-comment">// å…¼å®¹ç‰ˆæœ¬</span>
        <span class="hljs-keyword">return</span> vParts[<span class="hljs-number">0</span>] === rParts[<span class="hljs-number">0</span>] &amp;&amp; vParts[<span class="hljs-number">1</span>] &gt;= rParts[<span class="hljs-number">1</span>];
      <span class="hljs-keyword">case</span> <span class="hljs-string">'~'</span>: <span class="hljs-comment">// è¿‘ä¼¼ç‰ˆæœ¬</span>
        <span class="hljs-keyword">return</span> vParts[<span class="hljs-number">0</span>] === rParts[<span class="hljs-number">0</span>] &amp;&amp; 
               vParts[<span class="hljs-number">1</span>] === rParts[<span class="hljs-number">1</span>] &amp;&amp; 
               vParts[<span class="hljs-number">2</span>] &gt;= rParts[<span class="hljs-number">2</span>];
      <span class="hljs-keyword">case</span> <span class="hljs-string">'&gt;='</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">compareVersions</span>(version, versionRange) &gt;= <span class="hljs-number">0</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">'&gt;'</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">compareVersions</span>(version, versionRange) &gt; <span class="hljs-number">0</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">'&lt;='</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">compareVersions</span>(version, versionRange) &lt;= <span class="hljs-number">0</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">'&lt;'</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">compareVersions</span>(version, versionRange) &lt; <span class="hljs-number">0</span>;
      <span class="hljs-attr">default</span>:
        <span class="hljs-keyword">return</span> version === versionRange;
    }
  }
  
  <span class="hljs-comment">// å¼ƒç”¨é€šçŸ¥</span>
  <span class="hljs-title function_">deprecate</span>(<span class="hljs-params">moduleName, version, message</span>) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">deprecations</span>.<span class="hljs-title function_">has</span>(moduleName)) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">deprecations</span>.<span class="hljs-title function_">set</span>(moduleName, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>());
    }
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">deprecations</span>.<span class="hljs-title function_">get</span>(moduleName).<span class="hljs-title function_">set</span>(version, {
      message,
      <span class="hljs-attr">deprecatedAt</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>()
    });
    
    <span class="hljs-comment">// æ·»åŠ æ§åˆ¶å°è­¦å‘Š</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">`Module <span class="hljs-subst">${moduleName}</span>@<span class="hljs-subst">${version}</span> is deprecated: <span class="hljs-subst">${message}</span>`</span>);
  }
}

<span class="hljs-comment">// ä½¿ç”¨ç¤ºä¾‹</span>
<span class="hljs-keyword">const</span> versionManager = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ModuleVersionManager</span>();

<span class="hljs-comment">// æ³¨å†Œä¸åŒç‰ˆæœ¬</span>
versionManager.<span class="hljs-title function_">register</span>(<span class="hljs-string">'utils'</span>, <span class="hljs-string">'1.0.0'</span>, {
  <span class="hljs-attr">oldMethod</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-string">'old'</span>
});

versionManager.<span class="hljs-title function_">register</span>(<span class="hljs-string">'utils'</span>, <span class="hljs-string">'1.1.0'</span>, {
  <span class="hljs-attr">oldMethod</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-string">'old'</span>,
  <span class="hljs-attr">newMethod</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-string">'new'</span>
});

versionManager.<span class="hljs-title function_">register</span>(<span class="hljs-string">'utils'</span>, <span class="hljs-string">'2.0.0'</span>, {
  <span class="hljs-attr">newMethod</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-string">'new'</span>,
  <span class="hljs-attr">betterMethod</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-string">'better'</span>
});

<span class="hljs-comment">// æ ‡è®°å¼ƒç”¨</span>
versionManager.<span class="hljs-title function_">deprecate</span>(<span class="hljs-string">'utils'</span>, <span class="hljs-string">'1.0.0'</span>, <span class="hljs-string">'è¯·å‡çº§åˆ°1.1.0+ç‰ˆæœ¬'</span>);

<span class="hljs-comment">// è·å–æ¨¡å—</span>
<span class="hljs-keyword">const</span> utilsV1 = versionManager.<span class="hljs-title function_">get</span>(<span class="hljs-string">'utils'</span>, <span class="hljs-string">'^1.0.0'</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(utilsV1); <span class="hljs-comment">// 1.1.0ç‰ˆæœ¬</span>

<span class="hljs-keyword">const</span> utilsLatest = versionManager.<span class="hljs-title function_">get</span>(<span class="hljs-string">'utils'</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(utilsLatest); <span class="hljs-comment">// 2.0.0ç‰ˆæœ¬</span>
</code></pre>
<h4 data-id="heading-21">æ€»ç»“</h4>
<p>æ¨¡å—åŒ–æ˜¯ç°ä»£å‰ç«¯å·¥ç¨‹åŒ–çš„åŸºçŸ³ï¼Œä»å‰ç«¯çš„è„šæœ¬æ ‡ç­¾åˆ°ES Modulesï¼Œå†åˆ°æ¨¡å—è”é‚¦ç­‰é«˜çº§æ¨¡å¼ï¼Œæ¨¡å—åŒ–æŠ€æœ¯ä¸æ–­æ¼”è¿›ã€‚æœ¬æ–‡ä»ç®€å•æ¨¡å—åŠ è½½å™¨å®ç°å¼€å§‹ï¼Œé€æ­¥æ·±å…¥AMDã€CMDè§„èŒƒï¼Œæ¢è®¨ES Moduleçš„PolyfillæŠ€æœ¯ï¼Œå¹¶è¡¥å……äº†æ„å»ºå·¥å…·é›†æˆã€æ¨¡å—è”é‚¦ã€æ€§èƒ½ä¼˜åŒ–ç­‰å·¥ç¨‹åŒ–å®è·µã€‚</p>
<p><strong>å…³é”®è¦ç‚¹æ€»ç»“:</strong></p>
<ol>
<li><strong>æ¨¡å—åŠ è½½å™¨æ ¸å¿ƒåŸç†:</strong> ä¾èµ–ç®¡ç†ã€ç¼“å­˜ã€å¼‚æ­¥åŠ è½½</li>
<li><strong>è§„èŒƒæ¼”è¿›:</strong> ä»AMD/CMDåˆ°ES Modulesçš„ç»Ÿä¸€</li>
<li><strong>å·¥ç¨‹åŒ–å®è·µ:</strong> ä»£ç åˆ†å‰²ã€æ‡’åŠ è½½ã€ç‰ˆæœ¬ç®¡ç†ã€ä¾èµ–æ³¨å…¥</li>
<li><strong>æœªæ¥è¶‹åŠ¿:</strong> æ¨¡å—è”é‚¦ã€å¾®å‰ç«¯æ¶æ„ã€Web Assemblyæ¨¡å—åŒ–</li>
</ol>
<p>æ¨¡å—åŒ–ä¸ä»…ä»…æ˜¯æŠ€æœ¯é€‰æ‹©ï¼Œæ›´æ˜¯ä¸€ç§è®¾è®¡å“²å­¦ã€‚è‰¯å¥½çš„æ¨¡å—åŒ–è®¾è®¡èƒ½å¤Ÿæå‡ä»£ç çš„å¯ç»´æŠ¤æ€§ã€å¯æµ‹è¯•æ€§å’Œå›¢é˜Ÿåä½œæ•ˆç‡ã€‚åœ¨å®é™…é¡¹ç›®ä¸­ï¼Œåº”æ ¹æ®å›¢é˜Ÿè§„æ¨¡ã€é¡¹ç›®å¤æ‚åº¦å’ŒæŠ€æœ¯æ ˆé€‰æ‹©åˆé€‚çš„æ¨¡å—åŒ–æ–¹æ¡ˆï¼Œå¹¶ä¸æ–­ä¼˜åŒ–æ¨¡å—è¾¹ç•Œå’Œä¾èµ–å…³ç³»ã€‚</p>
<p>éšç€å‰ç«¯æŠ€æœ¯çš„ä¸æ–­å‘å±•ï¼Œæ¨¡å—åŒ–å°†ç»§ç»­æ¼”è¿›ï¼Œä½†æ ¸å¿ƒåŸåˆ™â€”â€”å…³æ³¨ç‚¹åˆ†ç¦»ã€æ¥å£æŠ½è±¡ã€ä¾èµ–ç®¡ç†â€”â€”å°†å§‹ç»ˆä¿æŒä¸å˜ã€‚æŒæ¡æ¨¡å—åŒ–çš„æ ¸å¿ƒåŸç†å’Œå®è·µï¼Œèƒ½å¤Ÿå¸®åŠ©å¼€å‘è€…æ„å»ºæ›´å¥å£®ã€å¯ç»´æŠ¤çš„å‰ç«¯åº”ç”¨ã€‚</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue2ä¸­èƒ½å¦å®ç°è¾“å…¥ä¸­æ–‡è‡ªåŠ¨è½¬åŒ–ä¸ºæ‹¼éŸ³, ä¸”ä¸å¸¦éŸ³è°ƒ]]></title>    <link>https://juejin.cn/post/7585463258690420745</link>    <guid>https://juejin.cn/post/7585463258690420745</guid>    <pubDate>2025-12-20T04:55:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585463258690420745" data-draft-id="7585382317444972554" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue2ä¸­èƒ½å¦å®ç°è¾“å…¥ä¸­æ–‡è‡ªåŠ¨è½¬åŒ–ä¸ºæ‹¼éŸ³, ä¸”ä¸å¸¦éŸ³è°ƒ"/> <meta itemprop="keywords" content="Vue.js"/> <meta itemprop="datePublished" content="2025-12-20T04:55:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ç”¨æˆ·722786812344"/> <meta itemprop="url" content="https://juejin.cn/user/4100515739233513"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="æ˜é‡‘"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue2ä¸­èƒ½å¦å®ç°è¾“å…¥ä¸­æ–‡è‡ªåŠ¨è½¬åŒ–ä¸ºæ‹¼éŸ³, ä¸”ä¸å¸¦éŸ³è°ƒ
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4100515739233513/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ç”¨æˆ·722786812344
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T04:55:37.000Z" title="Sat Dec 20 2025 04:55:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    é˜…è¯»2åˆ†é’Ÿ
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>vue2ä¸­èƒ½å¦å®ç°è¾“å…¥ä¸­æ–‡è‡ªåŠ¨è½¬åŒ–ä¸ºæ‹¼éŸ³, ä¸”ä¸å¸¦éŸ³è°ƒã€‚æœ‰ä»¥ä¸‹å‡ ç§æ–¹æ¡ˆ</p>
<p>æ–¹æ¡ˆä¸€ï¼šä½¿ç”¨pinyinåº“ï¼ˆæ¨èï¼‰</p>
<p>1.å®‰è£…ä¾èµ–</p>
<pre><code class="hljs">npm install pinyin
</code></pre>
<p>2.åœ¨Vueç»„ä»¶ä¸­ä½¿ç”¨</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> 
      <span class="hljs-attr">v-model</span>=<span class="hljs-string">"chineseInput"</span> 
      <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"è¾“å…¥ä¸­æ–‡"</span>
      @<span class="hljs-attr">input</span>=<span class="hljs-string">"convertToPinyin"</span>
    /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>ä¸­æ–‡: {{ chineseInput }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>æ‹¼éŸ³: {{ pinyinOutput }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> pinyin <span class="hljs-keyword">from</span> <span class="hljs-string">'pinyin'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">chineseInput</span>: <span class="hljs-string">''</span>,
      <span class="hljs-attr">pinyinOutput</span>: <span class="hljs-string">''</span>
    }
  },
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-title function_">convertToPinyin</span>(<span class="hljs-params"/>) {
      <span class="hljs-comment">// ä½¿ç”¨pinyinåº“è½¬æ¢ï¼Œè®¾ç½®styleä¸ºNORMALå»é™¤éŸ³è°ƒ</span>
      <span class="hljs-keyword">const</span> result = <span class="hljs-title function_">pinyin</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">chineseInput</span>, {
        <span class="hljs-attr">style</span>: pinyin.<span class="hljs-property">STYLE_NORMAL</span>, <span class="hljs-comment">// ä¸å¸¦éŸ³è°ƒ</span>
        <span class="hljs-attr">heteronym</span>: <span class="hljs-literal">false</span> <span class="hljs-comment">// ä¸å¯ç”¨å¤šéŸ³å­—æ¨¡å¼</span>
      })
      
      <span class="hljs-comment">// å°†äºŒç»´æ•°ç»„è½¬æ¢ä¸ºä¸€ç»´å­—ç¬¦ä¸²</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">pinyinOutput</span> = result.<span class="hljs-title function_">flat</span>().<span class="hljs-title function_">join</span>(<span class="hljs-string">''</span>)
    }
  }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>æ–¹æ¡ˆäºŒï¼šè‡ªå®šä¹‰æŒ‡ä»¤å®ç°</p>
<p>1.åˆ›å»ºè‡ªå®šä¹‰æŒ‡ä»¤</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// directives/pinyin.js</span>
<span class="hljs-keyword">import</span> pinyin <span class="hljs-keyword">from</span> <span class="hljs-string">'pinyin'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> pinyinDirective = {
  <span class="hljs-title function_">bind</span>(<span class="hljs-params">el, binding, vnode</span>) {
    <span class="hljs-keyword">const</span> vm = vnode.<span class="hljs-property">context</span>
    <span class="hljs-keyword">const</span> expression = binding.<span class="hljs-property">expression</span>
    
    el.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'input'</span>, <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> result = <span class="hljs-title function_">pinyin</span>(event.<span class="hljs-property">target</span>.<span class="hljs-property">value</span>, {
        <span class="hljs-attr">style</span>: pinyin.<span class="hljs-property">STYLE_NORMAL</span>
      })
      
      <span class="hljs-keyword">const</span> pinyinText = result.<span class="hljs-title function_">flat</span>().<span class="hljs-title function_">join</span>(<span class="hljs-string">''</span>)
      
      <span class="hljs-comment">// æ›´æ–°ç»‘å®šçš„æ•°æ®</span>
      vm[expression] = pinyinText
    })
  }
}

<span class="hljs-comment">// åœ¨main.jsä¸­æ³¨å†Œå…¨å±€æŒ‡ä»¤</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Vue</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> { pinyinDirective } <span class="hljs-keyword">from</span> <span class="hljs-string">'./directives/pinyin'</span>

<span class="hljs-title class_">Vue</span>.<span class="hljs-title function_">directive</span>(<span class="hljs-string">'pinyin'</span>, pinyinDirective)
</code></pre>
<p>2.åœ¨ç»„ä»¶ä¸­ä½¿ç”¨æŒ‡ä»¤</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"chineseText"</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"è¾“å…¥ä¸­æ–‡"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">v-pinyin</span>=<span class="hljs-string">"pinyinText"</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"è¿™é‡Œæ˜¾ç¤ºæ‹¼éŸ³"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>æ‹¼éŸ³ç»“æœ: {{ pinyinText }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span>
export default {
### data(https://www.falvce.com/) {
    return {
      chineseText: '',
      pinyinText: ''
    }
  }
}
<span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>æ–¹æ¡ˆä¸‰ï¼šä½¿ç”¨è®¡ç®—å±æ€§</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"chineseInput"</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"è¾“å…¥ä¸­æ–‡"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>æ‹¼éŸ³: {{ pinyinResult }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> pinyin <span class="hljs-keyword">from</span> <span class="hljs-string">'pinyin'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">chineseInput</span>: <span class="hljs-string">''</span>
    }
  },
  <span class="hljs-attr">computed</span>: {
    <span class="hljs-title function_">pinyinResult</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">chineseInput</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">''</span>
      
      <span class="hljs-keyword">const</span> result = <span class="hljs-title function_">pinyin</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">chineseInput</span>, {
        <span class="hljs-attr">style</span>: pinyin.<span class="hljs-property">STYLE_NORMAL</span>
      })
      
      <span class="hljs-keyword">return</span> result.<span class="hljs-title function_">flat</span>().<span class="hljs-title function_">join</span>(<span class="hljs-string">''</span>)
    }
  }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>æ–¹æ¡ˆå››ï¼šå¸¦é˜²æŠ–çš„ä¼˜åŒ–ç‰ˆæœ¬</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> 
      <span class="hljs-attr">v-model</span>=<span class="hljs-string">"chineseInput"</span> 
      <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"è¾“å…¥ä¸­æ–‡"</span>
      @<span class="hljs-attr">input</span>=<span class="hljs-string">"debouncedConvertPinyin"</span>
    /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>æ‹¼éŸ³: {{ pinyinOutput }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> pinyin <span class="hljs-keyword">from</span> <span class="hljs-string">'pinyin'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">data</span>(<span class="hljs-params">https:<span class="hljs-comment">//www.falvce.com/) {</span>
    <span class="hljs-keyword">return</span> {
      chineseInput: <span class="hljs-string">''</span>,
      pinyinOutput: <span class="hljs-string">''</span>,
      timeout: <span class="hljs-literal">null</span>
    }
  },
  methods: {
    convertToPinyin() {
      <span class="hljs-keyword">const</span> result = pinyin(<span class="hljs-variable language_">this</span>.chineseInput, {
        style: pinyin.STYLE_NORMAL
      })
      <span class="hljs-variable language_">this</span>.pinyinOutput = result.flat().join(<span class="hljs-string">''</span>)
    },
    
    debouncedConvertPinyin() {
      // é˜²æŠ–å¤„ç†ï¼Œé¿å…é¢‘ç¹è½¬æ¢
      <span class="hljs-built_in">clearTimeout</span>(<span class="hljs-variable language_">this</span>.timeout)
      <span class="hljs-variable language_">this</span>.timeout = <span class="hljs-built_in">setTimeout</span>(() =&gt; {
        <span class="hljs-variable language_">this</span>.convertToPinyin()
      }, <span class="hljs-number">300</span>)
    }
  },
  
  beforeDestroy() {
    <span class="hljs-built_in">clearTimeout</span>(<span class="hljs-variable language_">this</span>.timeout)
  }
}
</span></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>æ–¹æ¡ˆäº”ï¼šä½¿ç”¨å…¶ä»–æ‹¼éŸ³åº“</p>
<p>å¦‚æœä¸ä½¿ç”¨pinyinåº“ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨è€ƒè™‘å…¶ä»–æ›¿ä»£æ–¹æ¡ˆ</p>
<p>ä½¿ç”¨tiny-pinyin</p>
<pre><code class="hljs">npm install tiny-pinyin
</code></pre>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { pinyin } <span class="hljs-keyword">from</span> <span class="hljs-string">'tiny-pinyin'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-title function_">convertToPinyin</span>(<span class="hljs-params">text</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">pinyin</span>(text, { <span class="hljs-attr">toneType</span>: <span class="hljs-string">'none'</span> }) <span class="hljs-comment">// ä¸å¸¦éŸ³è°ƒ</span>
    }
  }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>æ³¨æ„äº‹é¡¹</p>
<ul>
<li>æ€§èƒ½è€ƒè™‘ï¼šå¯¹äºå¤§é‡æ–‡æœ¬è½¬æ¢ï¼Œå»ºè®®ä½¿ç”¨é˜²æŠ–æˆ–èŠ‚æµ</li>
<li>å¤šéŸ³å­—å¤„ç†ï¼šä¸Šè¿°ç¤ºä¾‹å…³é—­äº†å¤šéŸ³å­—æ¨¡å¼ï¼Œå¦‚éœ€å¤„ç†å¤šéŸ³å­—éœ€è¦é¢å¤–é€»è¾‘</li>
<li>éä¸­æ–‡å­—ç¬¦ï¼šæ‹¼éŸ³åº“é€šå¸¸ä¼šä¿ç•™éä¸­æ–‡å­—ç¬¦ä¸å˜</li>
<li>ç©ºæ ¼å¤„ç†ï¼šå¯æ ¹æ®éœ€æ±‚å†³å®šæ˜¯å¦ä¿ç•™ç©ºæ ¼</li>
<li>æ¨èä½¿ç”¨æ–¹æ¡ˆä¸€æˆ–æ–¹æ¡ˆä¸‰ï¼Œå®ƒä»¬å®ç°ç®€å•ä¸”æ˜“äºç»´æŠ¤ã€‚</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[ä»é›¶æ‰‹å†™ä¸€ä¸ª printf å‡½æ•°ï¼šå˜å‚å®ä¸é»˜è®¤å‚æ•°æå‡]]></title>    <link>https://juejin.cn/post/7585446706326765577</link>    <guid>https://juejin.cn/post/7585446706326765577</guid>    <pubDate>2025-12-20T04:58:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585446706326765577" data-draft-id="7585382317444988938" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="ä»é›¶æ‰‹å†™ä¸€ä¸ª printf å‡½æ•°ï¼šå˜å‚å®ä¸é»˜è®¤å‚æ•°æå‡"/> <meta itemprop="keywords" content="Linux"/> <meta itemprop="datePublished" content="2025-12-20T04:58:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="xlp666hub"/> <meta itemprop="url" content="https://juejin.cn/user/2965810860569131"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="æ˜é‡‘"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ä»é›¶æ‰‹å†™ä¸€ä¸ª printf å‡½æ•°ï¼šå˜å‚å®ä¸é»˜è®¤å‚æ•°æå‡
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2965810860569131/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    xlp666hub
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T04:58:51.000Z" title="Sat Dec 20 2025 04:58:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    é˜…è¯»18åˆ†é’Ÿ
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>åœ¨å­¦ä¹  C è¯­è¨€çš„è¿‡ç¨‹ä¸­ï¼Œ<code>printf</code> åº”è¯¥æ˜¯æˆ‘ä»¬æ‰“äº¤é“æœ€å¤šçš„å‡½æ•°äº†ã€‚ä½†ä½ æ˜¯å¦æ€è€ƒè¿‡ä¸‹é¢çš„é—®é¢˜ï¼šæ™®é€šçš„å‡½æ•°å‚æ•°ä¸ªæ•°éƒ½æ˜¯<strong>å›ºå®š</strong>çš„ï¼Œä¸ºä»€ä¹ˆ <code>printf</code> å¯ä»¥æ¥å—æ— é™ä¸ªå‚æ•°ï¼Ÿç¼–è¯‘å™¨åˆæ˜¯æ€ä¹ˆçŸ¥é“æˆ‘ä»¬ä¼ äº†å‡ ä¸ªå‚æ•°çš„ï¼Ÿä¸ºä»€ä¹ˆ <code>%c</code> æ˜æ˜æ˜¯æ‰“å°å­—ç¬¦ï¼Œåº•å±‚å´è¦æŒ‰ <code>int</code> ç±»å‹æ¥å¤„ç†ï¼Ÿ</p>
<p>åœ¨è¿™ç¯‡æ–‡ç« ï¼Œæˆ‘ä»¬å°±ä»é›¶æ‰‹å†™ä¸€ä¸ª <code>my_printf</code>ï¼Œå½»åº•å¼„æ‡‚ C è¯­è¨€ <strong>å˜å‚å‡½æ•°</strong> å’Œ <strong>å‡½æ•°è°ƒç”¨æ ˆ</strong> çš„åº•å±‚åŸç†ã€‚</p>
<h2 data-id="heading-0">1. æ ¸å¿ƒåŸç†</h2>
<h3 data-id="heading-1">1.1 ç¼–è¯‘å™¨</h3>
<p>å¯¹äºæˆ‘ä»¬æ¯”è¾ƒå¸¸è§çš„æ™®é€šå‡½æ•°ï¼Œä»–ä»¬çš„<strong>å‚æ•°ç±»å‹å’Œæ•°é‡ä¸€èˆ¬æ˜¯å›ºå®š</strong>çš„ï¼Œåƒè¿™æ ·ï¼š</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">void</span> <span class="hljs-title function_">func</span><span class="hljs-params">(<span class="hljs-type">int</span> a, <span class="hljs-type">int</span> b)</span>;
</code></pre>
<p>è¿™ç§æƒ…å†µä¸‹ï¼Œç¼–è¯‘å™¨åœ¨ç¼–è¯‘æ—¶éå¸¸æ¸…æ¥šï¼Œè°ƒç”¨è¿™ä¸ªå‡½æ•°éœ€è¦ä¼ é€’ 2 ä¸ª <code>int</code>ã€‚</p>
<p>æˆ‘ä»¬å†æ¥çœ‹çœ‹<code>printf</code>å‡½æ•°çš„å£°æ˜ï¼š</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e2c8cdbea42742f287599d6207bb0bd7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeGxwNjY2aHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766811531&amp;x-signature=dZN5CQgMwCKeSzLt9Ea2ylcqDh4%3D" alt="1. printfå£°æ˜.png" loading="lazy"/></p>
<h4 data-id="heading-2">1.1.1 restrict çš„ä½œç”¨</h4>
<p>åœ¨è¿›å…¥å’±ä»¬çš„æ­£é¢˜ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆéœ€è¦äº†è§£ä¸€ä¸‹å›¾ä¸­çš„<code>restrict</code> åˆ°åº•æ˜¯èµ·äº†ä»€ä¹ˆä½œç”¨ã€‚<code>restrict</code> æ˜¯ C99 æ ‡å‡†å¼•å…¥çš„å…³é”®å­—ï¼Œé€šä¿—ä¸€ç‚¹æ¥è¯´ï¼Œå®ƒçš„ä½œç”¨æ˜¯å‘Šè¯‰ç¼–è¯‘å™¨ï¼šè¿™ä¸ª <code>const char *</code> æŒ‡é’ˆæ˜¯è®¿é—®å®ƒæ‰€æŒ‡å‘å†…å­˜çš„<strong>å”¯ä¸€</strong>å…¥å£ï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œåˆ«æ— å…¶ä»–æŒ‡é’ˆï¼Œä»è€Œä½¿å¾—ç¼–è¯‘å™¨å¯ä»¥æ”¾å¿ƒå¤§èƒ†åœ°å»ä¼˜åŒ–ä»£ç ã€‚</p>
<p>ä»…ä»…è¿™æ ·è¯­è¨€æè¿°ä¸€ä¸‹ï¼Œå¯èƒ½è¿˜æ˜¯æœ‰ç‚¹ä¸å¤Ÿå½¢è±¡ï¼Œä¸ºäº†å¸®åŠ©å¤§å®¶ç†è§£ï¼Œæˆ‘ä¸‹é¢ä¸¾ä¸ªä¾‹å­ï¼š</p>
<p>ç¼–è¯‘å™¨åœ¨ä¼˜åŒ–ä»£ç æ—¶ï¼Œå…¶å®æ˜¯éå¸¸ä¿å®ˆçš„ï¼Œå› ä¸ºå®ƒéå¸¸å®³æ€•<strong>ä¸¤ä¸ªä¸åŒçš„æŒ‡é’ˆå®é™…ä¸ŠæŒ‡å‘åŒä¸€å—å†…å­˜ï¼ˆæŒ‡é’ˆåˆ«åï¼‰</strong> ã€‚è¯·çœ‹ä¸‹é¢çš„ä»£ç ï¼š</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">void</span> <span class="hljs-title function_">add</span><span class="hljs-params">(<span class="hljs-type">int</span> *a, <span class="hljs-type">int</span> *b, <span class="hljs-type">int</span> *val)</span> 
{
 Â  Â *a += *val;
 Â  Â *b += *val;
}
</code></pre>
<p>è¿™ä¸ª<code>add</code>å‡½æ•°æ¥æ”¶ä¸‰ä¸ª<code>int *</code>ç±»å‹çš„å‚æ•°ï¼Œåˆ†åˆ«æ˜¯<code>a</code>ï¼Œ<code>b</code>ï¼Œ<code>val</code>ï¼Œç„¶åå°†<code>val</code>æ‰€æŒ‡å‘å†…å­˜çš„å€¼åˆ†åˆ«åŠ åˆ°<code>a</code>å’Œ<code>b</code>æ‰€æŒ‡å‘å†…å­˜ä¸­çš„å€¼ã€‚</p>
<p>ä¸Šé¢å…¶å®ä¹Ÿæåˆ°äº†ï¼Œç¼–è¯‘å™¨ä¼˜åŒ–ä»£ç æ—¶æ˜¯å¾ˆ<strong>ä¿å®ˆ</strong>çš„ã€‚æˆ‘ä»¬æ¥æ¢³ç†ä¸€ä¸‹è¿™ä¸ªè¿‡ç¨‹ï¼Œç¼–è¯‘å™¨åœ¨ç¬¬ä¸€æ­¥ä¼šè¯»å– <code>* val</code> çš„å€¼ï¼Œç„¶ååŠ åˆ° <code>* a</code>ä¸­å»ï¼Œç¬¬äºŒæ­¥ï¼Œå†æ¬¡è¯»å– <code>* val</code> çš„å€¼ï¼Œç„¶åå°†è¯»å–åˆ°çš„ <code>* val</code>çš„å€¼åŠ åˆ° <code>* b</code>ä¸­å»ã€‚</p>
<p>å¯èƒ½æœ‰äººè¿™æ ·æƒ³ï¼šç¬¬ä¸€æ­¥ä¸æ˜¯å·²ç»è¯»å–äº† <code>* val</code> çš„å€¼äº†å—ï¼Ÿä¸ºä»€ä¹ˆç¬¬äºŒæ­¥è¿˜è¦å†è¯»å–ä¸€éå‘¢ï¼Ÿç›´æ¥ä½¿ç”¨ç¬¬ä¸€æ­¥è¯»å–åˆ°çš„å€¼ä¸è¡Œå—ï¼Ÿ</p>
<p>è€Œç¼–è¯‘å™¨æ˜¯è¿™æ ·æƒ³çš„ï¼šå¦‚æœåœ¨ä¼ å‚æ•°æ˜¯ <code>a</code> å’Œ <code>val</code> æŒ‡å‘çš„æ˜¯<strong>åŒä¸€ä¸ªåœ°å€</strong>æ€ä¹ˆåŠï¼Ÿç¬¬ä¸€æ­¥çš„æ“ä½œæ”¹å˜äº† <code>* a</code> çš„å€¼ï¼ŒåŒæ—¶ä¹Ÿæ”¹å˜äº† <code>* val</code> çš„å€¼ï¼Œå¦‚æœè¿˜ä½¿ç”¨æ”¹å˜ä¹‹å‰çš„ <code>* val</code> çš„å€¼ï¼Œé‚£è®¡ç®—ä¸æ˜¯å‡ºé”™äº†å—ï¼Ÿå› æ­¤ï¼Œåœ¨ç¼–è¯‘å™¨ä¸èƒ½ç¡®ä¿ä¸¤ä¸ªæŒ‡é’ˆæŒ‡å‘çš„ä¸æ˜¯åŒä¸€å—å†…å­˜æ—¶ï¼Œå®ƒåœ¨ä½¿ç”¨è¿™å—å†…å­˜ä¸­çš„å€¼ä¹‹å‰éƒ½ä¼šå»å†…å­˜é‡Œé¢é‡æ–°è¯»å–ä¸€ä¸‹ï¼Œä»¥é˜²è®¡ç®—å‘ç”Ÿé”™è¯¯ã€‚</p>
<p>è€Œå¦‚æœæˆ‘ä»¬åŠ ä¸Š<code>restrict</code>ï¼Œåƒä¸‹é¢è¿™æ ·ï¼š</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">void</span> <span class="hljs-title function_">add_2</span><span class="hljs-params">(<span class="hljs-type">int</span> *a, <span class="hljs-type">int</span> *b, <span class="hljs-type">int</span> *<span class="hljs-keyword">restrict</span> val)</span> {
 Â  Â *a += *val;
 Â  Â *b += *val;
}
</code></pre>
<p>è¿™å°±ç›¸å½“äºå‘Šè¯‰ç¼–è¯‘å™¨ï¼Œ<code>* val</code> çš„å€¼ç»å¯¹ä¸ä¼šè¢« <code>a</code> æˆ– <code>b</code> ä¿®æ”¹ï¼Œè¿™æ ·ç¼–è¯‘å™¨åœ¨ç¬¬ä¸€æ¬¡è¯»å–äº† <code>* val</code> çš„å€¼åï¼Œç¬¬äºŒæ­¥æ—¶ç›´æ¥å°±èƒ½ä½¿ç”¨ï¼Œçœå¾—å†å›å†…å­˜é‡Œé¢å»æŸ¥ã€‚è¿™æ ·ä¹Ÿä¼šå¸¦æ¥ç›¸åº”çš„<strong>æ€§èƒ½æå‡</strong>ã€‚</p>
<h4 data-id="heading-3">1.1.2 restrict æ¡ˆä¾‹åˆ†æ</h4>
<p>ä¸ºäº†è®©å¤§å®¶èƒ½å¤Ÿæ›´æ¸…æ™°åœ°çœ‹åˆ°è¿™ä¸ªç°è±¡ï¼Œæˆ‘è¿›è¡Œäº†ä¸‹é¢çš„å®éªŒï¼š</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">void</span> <span class="hljs-title function_">add</span><span class="hljs-params">(<span class="hljs-type">int</span> *a, <span class="hljs-type">int</span> *b, <span class="hljs-type">int</span> *val)</span> 
{
 Â  Â *a += *val;
 Â  Â *b += *val;
}
â€‹
<span class="hljs-type">void</span> <span class="hljs-title function_">add_2</span><span class="hljs-params">(<span class="hljs-type">int</span> *a, <span class="hljs-type">int</span> *b, <span class="hljs-type">int</span> *<span class="hljs-keyword">restrict</span> val)</span> 
{
 Â  Â *a += *val;
 Â  Â *b += *val;
}
â€‹
</code></pre>
<p>è¿™æ®µä»£ç <code>add</code>å‡½æ•°çš„ <code>val</code> æˆ‘æ²¡åŠ <code>restrict</code>ï¼Œè€Œ<code>add_2</code>å‡½æ•°æˆ‘åŠ äº†ã€‚ç„¶åå¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤ï¼Œå°†è¿™æ®µä»£ç ç¼–è¯‘æˆæ±‡ç¼–ä»£ç ï¼š</p>
<pre><code class="hljs language-bash" lang="bash">gcc -O2 -S demo.c -o demo.s
</code></pre>
<p><strong>-O2</strong>é€‰é¡¹æ˜¯å¼€å¯ç¼–è¯‘å™¨ä¼˜åŒ–ï¼Œ<strong>-S</strong>æ˜¯ç”Ÿæˆæ±‡ç¼–ä»£ç ã€‚</p>
<p>ä¸‹é¢æ˜¯æˆ‘æˆªå–çš„éƒ¨åˆ†æ±‡ç¼–ä»£ç ï¼š</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8afde7b2d5c84d1ea2c8f1c6e900a3a2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeGxwNjY2aHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766811531&amp;x-signature=uPoMSWWbo1QF9NopqA1jZAHPAmM%3D" alt="2. æ±‡ç¼–ä»£ç .png" loading="lazy"/></p>
<p>ç”Ÿæˆçš„æ±‡ç¼–ä»£ç ä¸­ï¼Œæˆ‘ä»¬åªéœ€è¦çœ‹å…³é”®éƒ¨åˆ†ï¼Œå¯¹äº<code>add</code>å‡½æ•°ï¼Œæˆ‘ä»¬éœ€è¦çœ‹ç¬¬ 10-13 è¡Œï¼Œå¯¹äº<code>add_2</code>å‡½æ•°ï¼Œæˆ‘ä»¬éœ€è¦çœ‹ 25-27 è¡Œã€‚</p>
<p>åœ¨æˆ‘ä½¿ç”¨çš„ 64 ä½ Linux ç³»ç»Ÿä¸­ï¼Œ<strong>å‡½æ•°å‚æ•°æ˜¯é€šè¿‡å¯„å­˜å™¨ä¼ é€’</strong>çš„ï¼Œæœ‰<strong>å›ºå®šçš„é¡ºåº</strong>ã€‚ç¬¬ä¸€ä¸ªå‚æ•° <code>a</code> æ”¾åœ¨å¯„å­˜å™¨ <code>%rdi</code> ä¸­ï¼Œç¬¬äºŒä¸ªå‚æ•° <code>b</code> æ”¾åœ¨å¯„å­˜å™¨ <code>%rsi</code> ä¸­ï¼Œç¬¬ä¸‰ä¸ªå‚æ•° <code>val</code> å­˜æ”¾åœ¨å¯„å­˜å™¨ <code>%rdx</code> ä¸­ã€‚è€Œ <code>%eax</code> æ˜¯ä¸€ä¸ªé€šç”¨å¯„å­˜å™¨ï¼Œç”¨äºä¸´æ—¶å­˜æ”¾æ•°æ®ã€‚</p>
<p>åœ¨äº†è§£äº†ä¸€äº›å¿…å¤‡çš„çŸ¥è¯†åï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹å‡½æ•°<code>add</code>çš„å…³é”®éƒ¨åˆ†ã€‚ç¬¬10è¡Œï¼Œ<code>movl (%rdx), %eax</code> ï¼Œå»<code>val</code>æŒ‡å‘çš„å†…å­˜åœ°å€ <code>%rdx</code> ï¼ŒæŠŠé‡Œé¢çš„æ•°å­—å–å‡ºæ¥æ”¾åˆ° <code>%eax</code> ä¸­ã€‚ç¬¬11è¡Œï¼Œ<code>addl %eax, (%rdi)</code>ï¼Œå°† <code>%eax</code> ä¸­çš„æ•°åŠ åˆ°<code>a</code>æŒ‡å‘çš„å†…å­˜åœ°å€ <code>%rdi</code> ä¸­å»ã€‚åœ¨çœ‹ç¬¬12è¡Œï¼Œåˆå»<code>val</code>æŒ‡å‘çš„ <code>%rdx</code> ï¼ŒæŠŠé‡Œé¢çš„å€¼å–å‡ºæ¥æ”¾åˆ° <code>%eax</code> ä¸­ï¼Œç¬¬13è¡Œï¼Œ<code>addl %eax, (%rsi)</code>ï¼ŒæŠŠ <code>%eax</code> ä¸­çš„æ•°åŠ åˆ° <code>%rsi</code> ä¸­å»ã€‚åœ¨æˆ‘ä»¬çœ‹æ¥ï¼Œç¬¬äºŒæ¬¡å†å»è¯» <code>* val</code> çš„å€¼æ˜¯å¤šæ­¤ä¸€ä¸¾çš„ï¼Œä½†æ˜¯ç¼–è¯‘å™¨å®³æ€•æ—§å€¼è¢«ä¿®æ”¹ï¼Œå°±åªèƒ½å†å»è¯»ä¸€æ¬¡ï¼Œæ‹¿åˆ°æœ€æ–°çš„å€¼ã€‚</p>
<p>å†æ¥çœ‹å‡½æ•° <code>add_2</code> ï¼Œè¿™é‡Œçš„<code>val</code>åŠ äº†<code>restrict</code>å…³é”®å­—ï¼Œæˆ‘ä»¬çœ‹çœ‹æƒ…å†µæ˜¯å¦æœ‰æ‰€ä¸åŒã€‚ç¬¬25è¡Œä¾ç„¶æ˜¯å»<code>val</code>æŒ‡å‘çš„å†…å­˜ï¼Œå°†å€¼å–å‡ºæ¥æ”¾åˆ° <code>%eax</code> ä¸­ï¼Œç¬¬26è¡Œå°† <code>%eax</code> ä¸­çš„å€¼åŠ åˆ°<code>a</code>æ‰€æŒ‡å‘çš„å†…å­˜åœ°å€ <code>%rdi</code> ä¸­å»ã€‚è€Œåˆ°äº†ç¬¬27è¡Œï¼Œå®ƒæ²¡æœ‰å†å»è¯»ä¸€é <code>* val</code> çš„å€¼ï¼Œè€Œæ˜¯ç›´æ¥ä½¿ç”¨æ—§çš„ <code>* val</code> çš„å€¼ç›´æ¥åŠ åˆ°<code>b</code>æŒ‡å‘çš„å†…å­˜ <code>%rsi</code> ä¸­å»ã€‚</p>
<p>åˆ°è¿™é‡Œç›¸ä¿¡å¤§å®¶å·²ç»å¾ˆæ¸…æ™°äº†ã€‚<strong>å†…å­˜æ˜¯æ…¢é€Ÿè®¾å¤‡ï¼Œè€Œå¯„å­˜å™¨é€Ÿåº¦æ˜¯æå¿«</strong>çš„ï¼ŒåŠ ä¸Š<code>restrict</code>å…³é”®è¯ï¼Œæˆ‘ä»¬èŠ‚çœäº†ä¸€æ¬¡å»å†…å­˜è¯»å–çš„å¼€é”€ã€‚</p>
<h4 data-id="heading-4">1.1.3 å°ç»“</h4>
<p>åœ¨äº†è§£äº†<code>restrict</code>ä¹‹åï¼Œæ–°çš„é—®é¢˜æœ‰æµ®å‡ºæ°´é¢äº†ã€‚å›è¿‡å¤´å»çœ‹<code>printf</code>å‡½æ•°çš„å£°æ˜ï¼Œç¼–è¯‘å™¨<strong>åªèƒ½çŸ¥é“æœ‰ä¸€ä¸ªå›ºå®šå‚æ•°</strong><code>format</code>ï¼Œä»–ä¸çŸ¥é“åé¢è¿˜æœ‰æ²¡æœ‰å‚æ•°ï¼Œæ›´ä¸çŸ¥é“åé¢å‚æ•°æ˜¯ä»€ä¹ˆç±»å‹çš„ã€‚æ—¢ç„¶ç¼–è¯‘å™¨ä¸çŸ¥é“ï¼Œé‚£ä¹ˆ<code>printf</code>æ˜¯æ€æ ·æ­£ç¡®çš„æ‰“å°å‡ºå†…å®¹çš„å‘¢ï¼Ÿç­”æ¡ˆè—åœ¨ä¸‹ä¸€ç« çš„å†…å®¹é‡Œé¢ã€‚</p>
<h3 data-id="heading-5">1.2 å‡½æ•°è°ƒç”¨æ ˆ</h3>
<p>å‡å¦‚æˆ‘ä»¬åœ¨32ä½ç³»ç»Ÿä¸‹è°ƒç”¨ä¸‹é¢çš„ä»£ç ï¼š</p>
<pre><code class="hljs language-c" lang="c">my_printf(<span class="hljs-string">"Num:%d"</span>, <span class="hljs-number">100</span>);
</code></pre>
<p>æ­¤æ—¶ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹<strong>å‡½æ•°è°ƒç”¨æ ˆ</strong>çš„å¸ƒå±€ï¼š</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bc36a4b670a148bab85ab6f565721104~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeGxwNjY2aHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766811531&amp;x-signature=%2FA1s7OoajLA6UlPAknx4wUTBmBc%3D" alt="3. æ ˆå¸§.png" loading="lazy"/></p>
<p>æ³¨ï¼šç°ä»£ x64 æˆ– ARM æ¶æ„é€šå¸¸ä¼˜å…ˆä½¿ç”¨å¯„å­˜å™¨ä¼ å‚ï¼ˆä¸Šé¢æ±‡ç¼–çš„è§£é‡Šä¸­æåˆ°è¿‡ï¼‰ï¼Œä½† <code>stdarg.h</code> çš„å°è£…è®©æˆ‘ä»¬åœ¨é€»è¾‘ä¸Šè¿˜æ˜¯å¯ä»¥åƒæ“ä½œæ ˆä¸€æ ·å»å¤„ç†å®ƒä»¬ï¼Œæ ¸å¿ƒæ€æƒ³æ˜¯ä¸å˜çš„ã€‚</p>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬è¦çŸ¥é“ï¼Œ<strong>æ ˆæ˜¯ä»é«˜åœ°å€å‘ä½åœ°å€ç”Ÿé•¿çš„</strong>ã€‚å¯ä»¥ä»”ç»†è§‚å¯Ÿä¸€ä¸‹å›¾ä¸­å·¦è¾¹å‡½æ•°è°ƒç”¨æ ˆçš„å¸ƒå±€ï¼Œæœ€ä¸Šé¢çš„æ˜¯ä¹‹å‰çš„æ ˆå¸§ã€‚</p>
<p>å…¶æ¬¡ï¼Œæˆ‘ä»¬è¿˜è¦çŸ¥é“ï¼Œ<strong>å‡½æ•°å‚æ•°çš„å…¥æ ˆé¡ºåºæ˜¯ä»å³å‘å·¦</strong>çš„ã€‚åœ¨æˆ‘ä¸¾çš„è¿™ä¸ªä¾‹å­é‡Œé¢ï¼Œ<strong>æœ€å³è¾¹çš„å‚æ•°100</strong> å…ˆå…¥æ ˆï¼Œå®ƒç´§è´´ç€ä¹‹å‰çš„æ ˆå¸§ï¼Œç„¶åå®ƒå·¦è¾¹çš„å‚æ•°ï¼ˆä¹Ÿå°±æ˜¯ â€œ<code>Num:%d</code>â€ çš„æ‰€åœ¨çš„åœ°å€ï¼‰å…¥æ ˆï¼Œç´§è´´ç€å‚æ•°100å­˜æ”¾ã€‚æœ€åå‡½æ•°çš„è¿”å›åœ°å€å…¥æ ˆã€‚</p>
<p>ç†è§£äº†è¿™å¼ å›¾ï¼Œé‚£ä¸€åˆ‡å°±éƒ½æ˜äº†äº†ã€‚è™½ç„¶ç¼–è¯‘å™¨<strong>åªçŸ¥é“ç¬¬ä¸€ä¸ªå›ºå®šå‚æ•°</strong>ï¼Œè€Œä¸çŸ¥é“å®ƒåé¢æœ‰ä»€ä¹ˆï¼Œä½†æ ¹æ® C è¯­è¨€çš„è°ƒç”¨çº¦å®šï¼Œ<strong>å˜å‚ä¸€å®šç´§ç´§æŒ¨ç€å›ºå®šå‚æ•°å­˜æ”¾</strong>ï¼Œå¹¶ä¸”ä½äºæ›´é«˜çš„åœ°å€ã€‚</p>
<p>ä¸‹é¢æˆ‘ä»¬æ¥é¡ºä¸€ä¸‹æ•´ä¸ªæµç¨‹ï¼Œå‚æ•°<code>format</code>çš„ç±»å‹æ˜¯<code>const char *</code>ï¼Œä¹Ÿå°±æ˜¯è¯´å®ƒ<strong>æœ¬èº«æ˜¯ä¸€ä¸ªæŒ‡é’ˆ</strong>ï¼ŒçœŸæ­£çš„å­—ç¬¦ä¸²å†…å®¹ â€œ<code>Num:%d</code>â€ å­˜æ”¾åœ¨<strong>åªè¯»æ•°æ®åŒº(.rodata)</strong> ï¼Œåœ¨32ä¸ºç³»ç»Ÿä¸‹å®ƒçš„å¤§å°æ˜¯ <strong>4 ä¸ªå­—èŠ‚</strong>ï¼Œè€Œæœ¬èº«å­˜æ”¾ <code>format</code> çš„åœ°å€æˆ‘ä»¬ä¹Ÿæ˜¯çŸ¥é“çš„ã€‚æˆ‘ä»¬è¦åšçš„ï¼Œæ˜¯æ‹¿åˆ°<code>format</code>å˜é‡æœ¬èº«åœ¨æ ˆä¸Šçš„åœ°å€ï¼Œç„¶ååŠ ä¸Š<code>format</code>çš„å¤§å°ï¼Œä¹Ÿå°±æ˜¯4ä¸ªå­—èŠ‚ï¼Œè¿™æ ·æŒ‡é’ˆå°±è·³è¿‡äº†<code>format</code>å æ®çš„åœ°å€ï¼Œä»è€Œèƒ½å¤Ÿå¾—åˆ°å˜å‚ï¼ˆ100ï¼‰çš„åœ°å€ã€‚åŒç†ï¼Œå°±ç®—åé¢è¿˜æœ‰å…¶ä»–å˜å‚ï¼Œæˆ‘ä»¬ä¹Ÿèƒ½é€šè¿‡<strong>åœ°å€åç§»</strong>çš„æ–¹æ³•æ‰¾åˆ°ä»–ã€‚</p>
<p>å¦‚æœä½¿ç”¨çš„æ˜¯<strong>64ä½ç³»ç»Ÿ</strong>ï¼Œé‚£ä¹ˆ<code>format</code>çš„å¤§å°å°±ä¼šæ”¹å˜ä¸º 8 ä¸ªå­—èŠ‚ï¼Œä½†æ˜¯åŸç†è¿˜æ˜¯è¿™æ ·çš„ã€‚</p>
<p>è¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆç¼–è¯‘å™¨å¹¶ä¸çŸ¥é“<code>format</code>åé¢çš„å‚æ•°æ˜¯ä»€ä¹ˆï¼Œè€Œ<code>printf</code>å´èƒ½æ­£ç¡®æ‰“å°å‡ºæ¥çš„åŸå› ã€‚</p>
<h3 data-id="heading-6">1.3 å˜å‚å®çš„æœ¬è´¨</h3>
<p>ç†è®ºä¸Šï¼Œæˆ‘ä»¬ç¡®å®å¯ä»¥æ‰‹åŠ¨é€šè¿‡ <code>(char*)&amp;format + 4</code> æ¥æ‰¾åˆ°ä¸‹ä¸€ä¸ªå‚æ•°ã€‚</p>
<p>è¿™é‡Œå…ˆç®€è¦æä¸€ä¸‹ä¸ºä»€ä¹ˆå–<code>format</code>çš„åœ°å€åè¦è½¬ä¸º<code>char *</code>ç±»å‹ï¼Œè¿™å°±æ¶‰åŠåˆ°Cè¯­è¨€ä¸­ä¸€ä¸ªåŸºç¡€çŸ¥è¯†ç‚¹â€”â€”<strong>æŒ‡é’ˆè¿ç®—</strong>ã€‚åœ¨Cè¯­è¨€ä¸­ï¼Œ<strong>æŒ‡é’ˆåŠ å‡çš„å•ä½ä¸æ˜¯å­—èŠ‚ï¼Œè€Œæ˜¯å®ƒæŒ‡å‘çš„æ•°æ®ç±»å‹çš„å¤§å°</strong>ã€‚æˆ‘æŠŠæŒ‡é’ˆè½¬ä¸º<code>char *</code>ç±»å‹ï¼Œæ˜¯ä¸ºäº†èƒ½å¤Ÿè®©å®ƒä»¥å­—èŠ‚ä¸ºå•ä½ç§»åŠ¨ã€‚åœ¨è½¬æ¢ç±»å‹ä¹‹åï¼Œ<code>(char*)&amp;format</code>çš„æ•°æ®ç±»å‹ä¸º<code>char *</code>ï¼Œå®ƒæŒ‡å‘çš„æ˜¯<code>char</code>ç±»å‹ï¼Œé•¿åº¦ä¸º 1 ä¸ªå­—èŠ‚ï¼Œæ‰€ä»¥<code>(char*)&amp;format + 4</code>ï¼ŒæŒ‡é’ˆå°±ä¼šç²¾ç¡®çš„ç§»åŠ¨4ä¸ªå­—èŠ‚ï¼Œåˆšå¥½è·³è¿‡<code>format</code>å˜é‡ã€‚å¦‚æœä¸è½¬çš„è¯ï¼Œ<code>&amp;format</code> çš„ç±»å‹æ˜¯ <code>char**</code>ï¼Œå®ƒæŒ‡å‘çš„æ˜¯ <code>char*</code> (æŒ‡é’ˆï¼Œåœ¨32ä½ç³»ç»Ÿé‡Œé¢å¤§å°ä¸º 4 )ï¼Œå†ç»™ä»–åŠ ä¸Š 4 ï¼Œé‚£ä¹ˆè¿™ä¸ªæŒ‡é’ˆå°±ä¼šç§»åŠ¨16ä¸ªå­—èŠ‚ï¼Œå·²ç»é”™è¿‡äº†æˆ‘ä»¬è¦æ‰¾çš„å˜å‚ã€‚</p>
<p>ä½†ç›´æ¥å†™<strong>ç¡¬ç¼–ç </strong>çš„æ•°å­—ï¼ˆ+4ï¼‰æ˜¯<strong>éå¸¸å±é™©</strong>çš„ã€‚å› ä¸ºåœ¨ 64 ä½ç³»ç»Ÿä¸Šå®ƒåº”è¯¥æ˜¯ +8ï¼Œåœ¨æŸäº›ç‰¹æ®Šæ¶æ„ä¸Šå¯¹é½æ–¹å¼å¯èƒ½æ›´å¤æ‚ã€‚å› æ­¤ï¼Œä¸ºäº†è§£å†³è·¨å¹³å°é—®é¢˜ï¼ŒC è¯­è¨€åœ¨ <code>&lt;stdarg.h&gt;</code> ä¸­å°è£…äº†ä¸€å¥—<strong>æ ‡å‡†å®</strong>ã€‚</p>
<p>ä¸ºäº†å¼„æ‡‚è¿™äº›å®æ‰§è¡Œçš„æ“ä½œå’Œæˆ‘ä¸Šé¢æè¿°çš„æ˜¯å¦ä¸€è‡´ï¼Œæˆ‘æŸ¥çœ‹äº†ç°ä»£Linuxç¯å¢ƒä¸‹<code>&lt;stdarg.h&gt;</code>çš„æºç ã€‚ç»“æœå‘ç°GCCçš„<code>&lt;stdarg.h&gt;</code>çš„å®ç°å¦‚ä¸‹ï¼š</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2673290464e742919f497b9ec02e41e3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeGxwNjY2aHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766811531&amp;x-signature=bDG0BsQcUVQI99ZeVbHGPCCTx2c%3D" alt="4. stdargæºç .png" loading="lazy"/></p>
<p>è¿™é‡Œè¦ç®€å•è¡¥å……ä¸€ä¸‹ï¼Œæ™®é€šçš„å¤´æ–‡ä»¶ï¼ˆå¦‚ <code>stdio.h</code>ï¼‰é€šå¸¸ç”± C æ ‡å‡†åº“æä¾›ï¼Œæ”¾åœ¨ <code>/usr/include</code>ã€‚ä½† <code>stdarg.h</code> éå¸¸ç‰¹æ®Šï¼Œå®ƒæ¶‰åŠå‚æ•°ä¼ é€’çš„åº•å±‚ç»†èŠ‚ï¼ˆå¦‚å¯„å­˜å™¨ä½¿ç”¨ã€æ ˆå¸§å¸ƒå±€ï¼‰ï¼Œè¿™äº›æ˜¯<strong>ä¾èµ–ç¼–è¯‘å™¨å®ç°</strong>çš„ã€‚å› æ­¤ï¼ŒGCC ä¸ä¼šä½¿ç”¨ç³»ç»Ÿé»˜è®¤çš„ stdarg.hï¼Œè€Œæ˜¯ä¼šä¼˜å…ˆä½¿ç”¨è‡ªå·±<strong>ç§æœ‰ç›®å½•</strong>ä¸‹çš„ç‰ˆæœ¬ã€‚</p>
<p>å› æ­¤æˆ‘ä»¬è¦ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤å»æŸ¥çœ‹ï¼š</p>
<pre><code class="hljs language-bash" lang="bash">vim $(gcc -print-file-name=include/stdarg.h)
</code></pre>
<p>ä¸ºä»€ä¹ˆè¦ä½¿ç”¨è¿™æ¡å‘½ä»¤å‘¢ï¼Ÿå› ä¸º<code>gcc</code>å®‰è£…ç›®å½•ç‰ˆæœ¬ä¼—å¤šï¼Œè·¯å¾„éšç‰ˆæœ¬å˜åŒ–ï¼Œè€Œè¿™æ¡å‘½ä»¤èƒ½è·å¾—<code>gcc</code>å®é™…ä½¿ç”¨çš„æ–‡ä»¶å¹¶ä½¿ç”¨<code>vim</code>ç¼–è¾‘å™¨æ‰“å¼€å®ƒã€‚</p>
<p>ç°åœ¨æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹<code>&lt;stdarg.h&gt;</code>çš„æºç ï¼Œå…¨æ˜¯ <code>__builtin_</code> å¼€å¤´çš„å‡½æ•°ã€‚è¿™æ˜¯å› ä¸ºç°ä»£ CPU æ¶æ„ï¼ˆå¦‚ x86-64ï¼‰çš„å‚æ•°ä¼ é€’éå¸¸å¤æ‚ï¼ˆ<strong>ä¼˜å…ˆä½¿ç”¨å¯„å­˜å™¨ï¼Œå¯„å­˜å™¨ç”¨å®Œäº†æ‰å‹æ ˆ</strong>ï¼‰ï¼Œå•çº¯çš„æŒ‡é’ˆåŠ å‡æ³•å·²ç»æ— æ³•æå®šäº†ã€‚ç¼–è¯‘å™¨ä¸ºäº†æè‡´çš„æ€§èƒ½ä¼˜åŒ–ï¼Œé€‰æ‹©æŠŠè¿™äº›æ“ä½œç›´æ¥<strong>å†…ç½®</strong>åœ¨ç¼–è¯‘å™¨å†…éƒ¨ã€‚</p>
<p>ä¸ºäº†èƒ½å¤Ÿè®©å¤§å®¶çœ‹åˆ°å®é™…çš„Cè¯­è¨€å®ç°ï¼Œæˆ‘ç¿»å‡ºäº† <strong>Linux 0.11 å†…æ ¸æºç </strong> ï¼Œæˆ‘æŠŠæºç çš„å†…å®¹ç›´æ¥æ”¾åœ¨ä¸‹é¢çš„ä»£ç å—ä¸­ï¼ˆæ³¨ï¼šåŸæ±åŸå‘³ï¼Œæˆ‘ä¸€ç‚¹æ²¡æ”¹ï¼‰ï¼š</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> _STDARG_H</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> _STDARG_H</span>
â€‹
<span class="hljs-keyword">typedef</span> <span class="hljs-type">char</span> *va_list;
â€‹
<span class="hljs-comment">/* Amount of space required in an argument list for an arg of type TYPE.
 Â  TYPE may alternatively be an expression whose type is used.  */</span>
â€‹
<span class="hljs-meta">#<span class="hljs-keyword">define</span> __va_rounded_size(TYPE)  \
 Â (((sizeof (TYPE) + sizeof (int) - 1) / sizeof (int)) * sizeof (int))</span>
â€‹
<span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> __sparc__</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> va_start(AP, LASTARG)                       \
 (AP = ((char *) &amp;(LASTARG) + __va_rounded_size (LASTARG)))</span>
<span class="hljs-meta">#<span class="hljs-keyword">else</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> va_start(AP, LASTARG)                       \
 (__builtin_saveregs (),                        \
 Â AP = ((char *) &amp;(LASTARG) + __va_rounded_size (LASTARG)))</span>
<span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>
â€‹
<span class="hljs-type">void</span> <span class="hljs-title function_">va_end</span> <span class="hljs-params">(va_list)</span>;      <span class="hljs-comment">/* Defined in gnulib */</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> va_end(AP)</span>
â€‹
<span class="hljs-meta">#<span class="hljs-keyword">define</span> va_arg(AP, TYPE)                        \
 (AP += __va_rounded_size (TYPE),                   \
 Â *((TYPE *) (AP - __va_rounded_size (TYPE))))</span>
â€‹
<span class="hljs-meta">#<span class="hljs-keyword">endif</span> <span class="hljs-comment">/* _STDARG_H */</span></span>
</code></pre>
<p>æºç ç¬¬ 9ï¼Œ10 è¡Œå®šä¹‰äº†ä¸€ä¸ªå® <code>__va_rounded_size</code>ï¼Œè¿™è¡Œä»£ç çœ‹ç€å¤æ‚ï¼Œå…¶å®åªåšä¸€ä»¶äº‹ï¼Œå°±æ˜¯<strong>å‘ä¸Šå–æ•´åˆ° int çš„å€æ•°</strong>ã€‚ä¹Ÿå°±æ˜¯è¯´å¦‚æœä½ ä¼ <code>char</code>ï¼Œç®—å‡ºæ¥æ˜¯ 4ï¼Œå¦‚æœä½ ä¼ <code>int</code>ï¼Œç®—å‡ºæ¥è¿˜æ˜¯ 4ï¼Œå¦‚æœä½ ä¼ <code>double</code>ï¼Œç®—å‡ºæ¥å°±æ˜¯ 8 ã€‚è¿™ä¹Ÿè§£é‡Šäº†ä¸ºä»€ä¹ˆæˆ‘ä»¬åœ¨æ‰‹åŠ¨æ¨å¯¼æ—¶ï¼Œé»˜è®¤æ­¥é•¿æ˜¯ 4 çš„åŸå› ï¼Œæœ¬è´¨ä¸Šæ˜¯<strong>ä¸ºäº†ä¿è¯æ ˆä¸Šçš„å†…å­˜å¯¹é½</strong>ã€‚</p>
<p>ç„¶åè¯·çœ‹æºç ç¬¬ 13 è¡Œï¼Œç›¸ä¿¡å¤§å®¶å·²ç»çœ‹åˆ°äº†<code>char *</code>å¼ºè½¬ï¼Œ<code>&amp;LASTARG</code> å–å‡ºçš„æ˜¯å›ºå®šå‚æ•°çš„åœ°å€ï¼Œå¦‚æœä¸è½¬æˆ <code>char *</code>ï¼ŒæŒ‡é’ˆåŠ æ³•ä¼šæŒ‰ç…§è¯¥ç±»å‹çš„æ­¥é•¿ç§»åŠ¨ï¼Œè½¬æˆ <code>char *</code> åï¼ŒåŠ æ³•å°±å˜æˆäº†<strong>å­—èŠ‚çº§</strong>çš„ç§»åŠ¨ã€‚è¿™ä¹Ÿè¯å®äº†<strong>å¿…é¡»è¦å°†æŒ‡é’ˆè½¬ä¸ºå•å­—èŠ‚æ­¥é•¿</strong>ï¼Œæ‰èƒ½ç²¾ç¡®è·¨è¿‡å›ºå®šå‚æ•°ï¼ŒæŒ‡å‘<strong>å˜å‚</strong>çš„ç¬¬ä¸€ä¸ªå…ƒç´ ã€‚</p>
<p>å†çœ‹æºç ç¬¬ 24 è¡Œï¼Œè¿™é‡Œçš„æ“ä½œéå¸¸æœ‰æ„æ€ï¼Œå®ƒåˆ©ç”¨äº† C è¯­è¨€çš„ <strong>é€—å·è¡¨è¾¾å¼</strong>ï¼š(A, B)ã€‚è§„åˆ™æ˜¯ï¼š<strong>å…ˆæ‰§è¡Œ Aï¼Œå†æ‰§è¡Œ Bï¼Œå¹¶ä¸”æ•´ä¸ªè¡¨è¾¾å¼çš„å€¼ç­‰äº B çš„å€¼ã€‚</strong> åœ¨é€—å·å‰ï¼Œæ¸¸æ ‡ AP ç›´æ¥<strong>å‘å‰ç§»åŠ¨</strong>ï¼Œè·¨è¿‡äº†å½“å‰è¿™ä¸ªå‚æ•°ï¼ŒæŒ‡å‘äº†<strong>ä¸‹ä¸€ä¸ªå‚æ•°</strong>çš„èµ·ç‚¹ã€‚é€—å·åï¼Œç”¨æ–°çš„å‚æ•°èµ·å§‹åœ°å€å‡å»å½“å‰å‚æ•°çš„å¤§å°ï¼Œå°±æ˜¯å½“å‰å‚æ•°çš„èµ·å§‹åœ°å€ï¼ŒæŠŠè¿™ä¸ªåœ°å€å¼ºè½¬ä¸º<code>TYPE *</code>ï¼Œå†è§£å¼•ç”¨ï¼Œæœ€åæ‹¿åˆ°æ•°æ®ã€‚æœ€å<strong>è¿™ä¸ªå®çš„å€¼å°±æ˜¯æ‹¿åˆ°çš„æ•°æ®</strong>ã€‚è‡³äºé€—å·åé¢ä¸ºä»€ä¹ˆè¦å¼ºè½¬ä¸º<code>TYPE *</code>ç„¶åå†è§£å¼•ç”¨ï¼Œè¿™æ˜¯å› ä¸º<strong>è§£å¼•ç”¨åå–å‡ºæ•°æ®çš„é•¿åº¦æ˜¯æ ¹æ®è¢«è§£å¼•ç”¨çš„è¿™ä¸ªä¸œè¥¿çš„æ•°æ®ç±»å‹å†³å®š</strong>çš„ï¼Œå¦‚æœè¿™ä¸ªæ•°æ®ç±»å‹ä¸æ˜¯<code>TYPE *</code>ï¼Œé‚£ä¹ˆè§£å¼•ç”¨å–å‡ºçš„æ•°æ®é•¿åº¦è‡ªç„¶å°±ä¸ç¬¦åˆæˆ‘ä»¬çš„é¢„æœŸã€‚</p>
<h2 data-id="heading-7">2. é»˜è®¤å‚æ•°æå‡</h2>
<p>ææ‡‚äº†åº•å±‚çš„å®å®šä¹‰ï¼Œæˆ‘ä»¬ç»ˆäºå¯ä»¥å¼€å§‹å†™ä»£ç äº†ã€‚ä½†åœ¨åŠ¨æ‰‹ä¹‹å‰ï¼Œå¿…é¡»å…ˆè®²ä¸€ä¸ªå¤§å®¶å¯èƒ½ä¼š<strong>è¸©çš„å‘</strong>ã€‚</p>
<p>æˆ‘ä»¬åœ¨å®ç° <code>my_printf</code> å¤„ç† <code>%c</code>å­—ç¬¦æ—¶ï¼Œå¦‚æœæ²¡æœ‰äº†è§£è¿‡è¿™ä¸ªç»†èŠ‚ï¼Œç›´è§‰ä¸Šä¼šè¿™æ ·å†™ï¼š</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">char</span> c = va_arg(ap, <span class="hljs-type">char</span>); Â <span class="hljs-comment">//é”™è¯¯å†™æ³•</span>
</code></pre>
<p>è¿™æ ·å†™ä¼šå¯¼è‡´æŒ‡é’ˆåç§»é‡å‡ºç°é”™è¯¯ï¼Œç”šè‡³è¯»åˆ°ä¹±ç ã€‚</p>
<h3 data-id="heading-8">2.1 ä¸ºä»€ä¹ˆä¸èƒ½ç›´æ¥å–char</h3>
<p>ä¸çŸ¥é“å¤§å®¶å¯¹æˆ‘ä»¬ 1.3 èŠ‚ä¸­æåˆ°çš„<code>__va_rounded_size</code>è¿™ä¸ªå®è¿˜æœ‰å°è±¡å—ã€‚æ— è®ºä½ ä¼ å…¥çš„æ•°æ®ç±»å‹å¤šå°ï¼Œæ ˆä¸Šçš„æ§½ä½æœ€å°ä¹Ÿæ˜¯ <code>sizeof(int)</code>ã€‚åœ¨ C è¯­è¨€çš„<strong>å˜å‚å‡½æ•°è°ƒç”¨çº¦å®š</strong>ä¸­ï¼Œæœ‰ä¸€æ¡<strong>é»˜è®¤å‚æ•°æå‡</strong>è§„åˆ™ï¼š</p>
<p><strong>charã€short</strong> åœ¨å…¥æ ˆå‰ä¼šè‡ªåŠ¨å‡çº§ä¸º <strong>int</strong>ã€‚</p>
<p><strong>float</strong> åœ¨å…¥æ ˆå‰ä¼šè‡ªåŠ¨å‡çº§ä¸º <strong>double</strong>ã€‚</p>
<h3 data-id="heading-9">2.2 åŸç†åˆ†æ</h3>
<p><strong>å¦‚æœä½ å†™ <code>va_arg(ap, char)</code>ï¼š</strong> å®è®¡ç®—å‡ºçš„æ­¥é•¿æ˜¯ <code>sizeof(char)</code> = 1 å­—èŠ‚ã€‚æ¸¸æ ‡ AP åªå¾€åç§»äº† 1 ä¸ªå­—èŠ‚ã€‚ä½†å®é™…ä¸Šï¼Œæ ˆé‡Œé‚£ä¸ªå­—ç¬¦å äº† 4 ä¸ªå­—èŠ‚ã€‚</p>
<p>ç»“æœå°±æ˜¯<strong>æŒ‡é’ˆé”™ä½</strong>ï¼Œåé¢çš„<strong>æ‰€æœ‰å‚æ•°è¯»å–å…¨ä¹±å¥—</strong>ã€‚</p>
<p>é‚£ä¹ˆæ€æ ·å†™æ‰æ˜¯æ­£ç¡®çš„å‘¢ï¼Ÿæ—¢ç„¶ç¼–è¯‘å™¨æŠŠ <code>char</code> å˜æˆäº† <code>int</code> å¡è¿›æ ˆé‡Œï¼Œé‚£æˆ‘ä»¬å–çš„æ—¶å€™ï¼Œä¹Ÿå¿…é¡»æŒ‰ <code>int</code> å»å–ï¼Œç„¶åå†å¼ºè½¬å›æ¥ã€‚æƒ³ä¸‹é¢è¿™æ ·ï¼š</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">int</span> val = va_arg(ap, <span class="hljs-type">int</span>); Â  <span class="hljs-comment">// æŒ‰ç…§ int çš„æ­¥é•¿å»æ ˆé‡Œææ•°æ®</span>
my_putchar((<span class="hljs-type">char</span>)val); Â  <span class="hljs-comment">// å¼ºè½¬å› char ä½¿ç”¨</span>
</code></pre>
<h2 data-id="heading-10">3. æ ¸å¿ƒä»£ç å®ç°</h2>
<p>ç†è®ºç°åœ¨å·²ç»äº†è§£çš„å·®ä¸å¤šäº†ï¼Œæˆ‘ä»¬ç°åœ¨æ¥ç›´æ¥ä½¿ç”¨ç³»ç»Ÿè°ƒç”¨<code>write</code>å®ç°ä¸€ä¸ª<code>my_printf</code>ã€‚</p>
<h3 data-id="heading-11">3.1 åŸºç¡€å‡½æ•°ç¼–å†™</h3>
<p><code>printf</code> çš„æ ¸å¿ƒéš¾ç‚¹åœ¨äº<strong>æŠŠæ•´æ•°è½¬æ¢æˆå­—ç¬¦ä¸²</strong>ï¼Œä¾‹å¦‚æŠŠæ•´æ•° 123 å˜æˆå­—ç¬¦æ•°ç»„ <code>{'1', '2', '3', '\0'}</code>ã€‚æ ‡å‡†åº“æœ‰ <code>itoa</code>ï¼Œä½†æˆ‘ä»¬è¦è‡ªå·±å†™ä¸€ä¸ªã€‚è¯·çœ‹ä¸‹é¢ä»£ç ï¼š</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdarg.h&gt;</span></span>
â€‹
<span class="hljs-comment">//å¾€å±å¹•å†™ä¸€ä¸ªå­—ç¬¦</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">my_putchar</span><span class="hljs-params">(<span class="hljs-type">char</span> c)</span> 
{
 Â  Â write(<span class="hljs-number">1</span>, &amp;c, <span class="hljs-number">1</span>);
}
â€‹
<span class="hljs-comment">//å¾€å±å¹•å†™å­—ç¬¦ä¸²</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">my_putstr</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *str)</span> 
{
 Â  Â <span class="hljs-type">int</span> i = <span class="hljs-number">0</span>;
 Â  Â <span class="hljs-keyword">while</span>(str[i]) my_putchar(str[i++]);
}
â€‹
<span class="hljs-comment">//å°†æ•´æ•° value è½¬æ¢ä¸ºå­—ç¬¦ä¸²å¹¶æ‰“å°</span>
<span class="hljs-comment">//baseè¡¨ç¤º 10 è¿›åˆ¶æˆ– 16 è¿›åˆ¶</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">my_itoa</span><span class="hljs-params">(<span class="hljs-type">int</span> value, <span class="hljs-type">int</span> base)</span> 
{
 Â  Â <span class="hljs-type">char</span> buffer[<span class="hljs-number">32</span>];
 Â  Â <span class="hljs-type">int</span> i = <span class="hljs-number">0</span>, is_neg = <span class="hljs-number">0</span>;
â€‹
 Â  Â <span class="hljs-comment">// 0 æ˜¯ç‰¹æ®Šæƒ…å†µï¼Œå•ç‹¬å¤„ç†</span>
 Â  Â <span class="hljs-keyword">if</span> (value == <span class="hljs-number">0</span>) 
 Â   {
 Â  Â  Â  Â my_putchar(<span class="hljs-string">'0'</span>);
 Â  Â  Â  Â <span class="hljs-keyword">return</span>;
 Â   }
 Â  Â 
 Â  Â <span class="hljs-comment">//å¤„ç†è´Ÿæ•° (è¿™é‡Œåªå¤„ç†åè¿›åˆ¶)</span>
 Â  Â <span class="hljs-keyword">if</span> (value &lt; <span class="hljs-number">0</span> &amp;&amp; base == <span class="hljs-number">10</span>) 
 Â   {
 Â  Â  Â  Â is_neg = <span class="hljs-number">1</span>;
 Â  Â  Â  Â value = -value;
 Â   }
â€‹
 Â  Â <span class="hljs-comment">//å¾ªç¯å–æ¨¡ï¼ŒæŠŠ value çš„å„ä½æ•°ä»åå¾€å‰ä¾æ¬¡å­˜åœ¨ buffer ä¸­</span>
 Â  Â <span class="hljs-keyword">while</span> (value != <span class="hljs-number">0</span>) 
 Â   {
 Â  Â  Â  Â <span class="hljs-type">int</span> rem = value % base;
 Â  Â  Â  Â buffer[i++] = (rem &gt; <span class="hljs-number">9</span>) ? (rem - <span class="hljs-number">10</span>) + <span class="hljs-string">'a'</span> : rem + <span class="hljs-string">'0'</span>;<span class="hljs-comment">//å¦‚æœæ˜¯åå…­è¿›åˆ¶ï¼Œè¦å¤„ç† a-f</span>
 Â  Â  Â  Â value /= base;
 Â   }
â€‹
 Â  Â <span class="hljs-comment">//å¦‚æœæ˜¯è´Ÿæ•°ï¼Œç»™ buffer æœ€åå†è¡¥ä¸ªè´Ÿå·</span>
 Â  Â <span class="hljs-keyword">if</span> (is_neg) buffer[i++] = <span class="hljs-string">'-'</span>;
â€‹
 Â  Â <span class="hljs-comment">//é€†åºæ‰“å°ï¼ŒæŠŠ buffer çš„å†…å®¹ä»åå¾€å‰ä¾æ¬¡æ‰“å°</span>
 Â  Â <span class="hljs-keyword">while</span> (i &gt; <span class="hljs-number">0</span>) my_putchar(buffer[--i]);
}
</code></pre>
<p>è™½ç„¶ä¸Šé¢çš„æ³¨é‡Šå·²ç»å¾ˆå®Œå–„äº†ï¼Œä½†æˆ‘è¿˜æ˜¯æƒ³ç®€å•è§£é‡Šä¸€ä¸‹ä¸Šé¢ä»£ç çš„å®ç°ã€‚æˆ‘ä»¬å‡è®¾ä¼ è¿›å»çš„æ•°å­—æ˜¯ 123 ã€‚</p>
<p>è®¡ç®—æœºä¸è®¤è¯† 123 è¿™ä¸ªæ•´ä½“ï¼Œå®ƒåªè®¤è¯†äºŒè¿›åˆ¶ã€‚ä¸ºäº†æŠŠå®ƒå˜æˆå­—ç¬¦ '1', '2', '3'ï¼Œæˆ‘ä»¬éœ€è¦ä»<strong>ä¸ªä½</strong>å¼€å§‹å‰¥ç¦»ï¼Œè¯·ç»“åˆ<code>while</code>å¾ªç¯ä¸­çš„ä»£ç ç†è§£ä¸‹é¢è¿‡ç¨‹ï¼š</p>
<p><strong><code>value % base</code></strong>ï¼šæ‹¿åˆ°æœ€åä¸€ä½æ•°å­—ï¼Œä¾‹å¦‚ <code>123 % 10 = 3</code> ã€‚</p>
<p>ç„¶åå°†å®ƒæ”¾åœ¨<code>buffer[0]</code>ï¼Œç„¶å <code>i</code> å˜æˆ 1 ã€‚</p>
<p><strong><code>value / base</code></strong>ï¼šå»æ‰æœ€åä¸€ä½ï¼Œä¾‹å¦‚ <code>123 / 10 = 12</code> ã€‚</p>
<p>å°±è¿™æ ·å¾ªç¯ 3 æ¬¡ï¼Œ<code>buffer[] = {3, 2, 1}</code>ï¼Œè¿™æ—¶ <code>i</code> ä¸º 3 ã€‚</p>
<p>å› ä¸ºå®ƒä¸æ˜¯è´Ÿæ•°ï¼Œä¸‹ä¸€æ­¥å°±å¯ä»¥å¾ªç¯æ‰“å°äº†ã€‚æ‰“å°çš„æ—¶å€™ï¼Œ<code>i</code> å…ˆå‡ 1ï¼Œå˜æˆ 2 ï¼Œè¿™æ—¶æ‰“å°å‡º<code>buffer[2]</code>ä¹Ÿå°±æ˜¯ 1ï¼Œä¾æ¬¡ç±»æ¨ï¼Œæœ€ç»ˆæ‰“å°å‡º 1ï¼Œ2ï¼Œ3 ä¸‰ä¸ªå­—ç¬¦ã€‚</p>
<h3 data-id="heading-12">3.2 ä¸»è¦é€»è¾‘</h3>
<p>æœ‰äº† <code>my_itoa</code> å’Œæ ‡å‡†å®ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç¼–å†™ä¸»å‡½æ•°é€»è¾‘äº†ã€‚</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">int</span> <span class="hljs-title function_">my_printf</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *format, ...)</span> 
{
 Â  Â va_list ap;
 Â  Â va_start(ap, format); <span class="hljs-comment">//åˆå§‹åŒ–ï¼Œè®© ap æŒ‡å‘ç¬¬ä¸€ä¸ªå˜å‚</span>
â€‹
 Â  Â <span class="hljs-type">const</span> <span class="hljs-type">char</span> *p = format;
 Â  Â <span class="hljs-keyword">while</span> (*p != <span class="hljs-string">'\0'</span>) 
 Â   {
 Â  Â  Â  Â <span class="hljs-keyword">if</span> (*p == <span class="hljs-string">'%'</span>) 
 Â  Â  Â   {
 Â  Â  Â  Â  Â  Â p++; <span class="hljs-comment">// è·³è¿‡ '%'</span>
 Â  Â  Â  Â  Â  Â 
 Â  Â  Â  Â  Â  Â <span class="hljs-keyword">switch</span> (*p) 
 Â  Â  Â  Â  Â   {
 Â  Â  Â  Â  Â  Â  Â  Â <span class="hljs-keyword">case</span> <span class="hljs-string">'d'</span>: <span class="hljs-comment">// åè¿›åˆ¶æ•´æ•°</span>
 Â  Â  Â  Â  Â  Â  Â   { 
 Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <span class="hljs-type">int</span> val = va_arg(ap, <span class="hljs-type">int</span>); <span class="hljs-comment">// ä»æ ˆé‡Œå–å‡ºä¸€ä¸ª int</span>
 Â  Â  Â  Â  Â  Â  Â  Â  Â  Â my_itoa(val, <span class="hljs-number">10</span>); Â  Â  Â  Â  Â 
 Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <span class="hljs-keyword">break</span>;
 Â  Â  Â  Â  Â  Â  Â   }
 Â  Â  Â  Â  Â  Â  Â  Â <span class="hljs-keyword">case</span> <span class="hljs-string">'x'</span>: <span class="hljs-comment">// åå…­è¿›åˆ¶æ•´æ•°</span>
 Â  Â  Â  Â  Â  Â  Â   { 
 Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <span class="hljs-type">int</span> val = va_arg(ap, <span class="hljs-type">int</span>);
 Â  Â  Â  Â  Â  Â  Â  Â  Â  Â my_putstr(<span class="hljs-string">"0x"</span>); Â  Â  Â  Â  Â  <span class="hljs-comment">// åŠ ä¸ªå‰ç¼€</span>
 Â  Â  Â  Â  Â  Â  Â  Â  Â  Â my_itoa(val, <span class="hljs-number">16</span>);
 Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <span class="hljs-keyword">break</span>;
 Â  Â  Â  Â  Â  Â  Â   }
 Â  Â  Â  Â  Â  Â  Â  Â <span class="hljs-keyword">case</span> <span class="hljs-string">'c'</span>: <span class="hljs-comment">// å­—ç¬¦</span>
 Â  Â  Â  Â  Â  Â  Â   { 
 Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <span class="hljs-type">int</span> val = va_arg(ap, <span class="hljs-type">int</span>); 
 Â  Â  Â  Â  Â  Â  Â  Â  Â  Â my_putchar((<span class="hljs-type">char</span>)val);
 Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <span class="hljs-keyword">break</span>;
 Â  Â  Â  Â  Â  Â  Â   }
 Â  Â  Â  Â  Â  Â  Â  Â <span class="hljs-keyword">case</span> <span class="hljs-string">'s'</span>: <span class="hljs-comment">// å­—ç¬¦ä¸²</span>
 Â  Â  Â  Â  Â  Â  Â   { 
 Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <span class="hljs-comment">// å­—ç¬¦ä¸²æœ¬è´¨æ˜¯ char* æŒ‡é’ˆï¼ŒæŒ‡é’ˆä¸éœ€è¦æå‡</span>
 Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <span class="hljs-type">char</span> *str = va_arg(ap, <span class="hljs-type">char</span>*);
 Â  Â  Â  Â  Â  Â  Â  Â  Â  Â my_putstr(str);
 Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <span class="hljs-keyword">break</span>;
 Â  Â  Â  Â  Â  Â  Â   }
 Â  Â  Â  Â  Â  Â  Â  Â <span class="hljs-keyword">default</span>: <span class="hljs-comment">// å¦‚æœä¸æ˜¯ä¸Šé¢çš„å‡ ç§ï¼ŒåŸæ ·æ‰“å°</span>
 Â  Â  Â  Â  Â  Â  Â  Â  Â  Â my_putchar(<span class="hljs-string">'%'</span>);<span class="hljs-comment">//è®°å¾—å…ˆæŠŠè·³è¿‡çš„é‚£ä¸ª % æ‰“å°äº†</span>
 Â  Â  Â  Â  Â  Â  Â  Â  Â  Â my_putchar(*p);
 Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <span class="hljs-keyword">break</span>;
 Â  Â  Â  Â  Â   }
 Â  Â  Â   } <span class="hljs-keyword">else</span> 
 Â  Â  Â   {
 Â  Â  Â  Â  Â  Â <span class="hljs-comment">// æ™®é€šå­—ç¬¦</span>
 Â  Â  Â  Â  Â  Â my_putchar(*p);
 Â  Â  Â   }
 Â  Â  Â  Â p++; <span class="hljs-comment">// ç»§ç»­æ‰«æä¸‹ä¸€ä¸ªå­—ç¬¦</span>
 Â   }
â€‹
 Â  Â va_end(ap); <span class="hljs-comment">//å°† ap ç½®ç©ºï¼Œé˜²æ­¢é‡æŒ‡é’ˆ</span>
 Â  Â <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>; Â  <span class="hljs-comment">//è¿™é‡Œç®€åŒ–ç‰ˆè¿”å› 0ï¼Œæ ‡å‡†åº“é€šå¸¸è¿”å›æ‰“å°çš„å­—ç¬¦æ•°</span>
}
</code></pre>
<p>è¿™æ®µä»£ç çš„ä¸»è¦é€»è¾‘æ˜¯ï¼šå¦‚æœé‡åˆ°æ™®é€šå­—ç¬¦ï¼Œé‚£å°±ç›´æ¥è¾“å‡ºã€‚å¦‚æœé‡åˆ° <code>%</code>ï¼Œæš‚åœè¾“å‡ºï¼ŒæŸ¥çœ‹ä¸‹ä¸€ä¸ªå­—ç¬¦æ˜¯ä»€ä¹ˆå†å†³å®šå»æ ˆé‡Œå–ä»€ä¹ˆæ•°æ®ã€‚</p>
<p>ç†è§£äº†ä¸»è¦é€»è¾‘ï¼Œæˆ‘ä»¬å†çœ‹ä¸€ä¸‹å‡ ä¸ªå…³é”®ç»†èŠ‚ï¼š</p>
<pre><code class="hljs language-c" lang="c">va_start(ap, format);
</code></pre>
<p>æ‰§è¡Œå®Œè¿™å¥ï¼ŒæŒ‡é’ˆ <code>ap</code> å°±å·²ç»è·³è¿‡äº† <code>format</code> å­—ç¬¦ä¸²æœ¬èº«ï¼Œåœåœ¨äº†<strong>ç¬¬ä¸€ä¸ªå˜å‚</strong>çš„å†…å­˜èµ·å§‹ä½ç½®ï¼Œå‡†å¤‡éšæ—¶è¢«è°ƒç”¨ã€‚</p>
<p>ç„¶åæ˜¯<code>switch-case</code>é€»è¾‘ï¼Œæ ¹æ® <code>%</code> åé¢çš„å­—æ¯ï¼Œå†³å®š<strong>ç”¨ä»€ä¹ˆç±»å‹å»å–æ ˆé‡Œçš„æ•°æ®</strong>ã€‚å¦‚æœæ˜¯<code>%d</code>ï¼Œè°ƒç”¨ <code>va_arg(ap, int)</code>ã€‚ç¼–è¯‘å™¨ä¼šç”ŸæˆæŒ‡ä»¤ï¼Œä»å½“å‰æ ˆä½ç½®å¤åˆ¶ 4 ä¸ªå­—èŠ‚ï¼Œè§£é‡Šä¸º <code>int</code>ï¼Œç„¶åè°ƒç”¨æˆ‘ä»¬å†™å¥½çš„ <code>my_itoa</code> è½¬æˆå­—ç¬¦æ‰“å°ã€‚å¦‚æœæ˜¯<code>%x</code>ï¼Œé€»è¾‘å’Œä¸Šé¢ç›¸åŒï¼Œä½†æˆ‘æ‰‹åŠ¨æ‰“å°äº† <code>"0x"</code> å‰ç¼€ï¼Œè¿™æ ·èƒ½ä¸åè¿›åˆ¶æœ‰æ‰€åŒºåˆ«ã€‚å¦‚æœæ˜¯ <code>%s</code> ï¼Œè°ƒç”¨<code>va_arg(ap, char*)</code>ã€‚æ³¨æ„è¿™é‡Œå–å‡ºçš„åªæ˜¯ä¸€ä¸ª<strong>æŒ‡é’ˆ</strong>ï¼ŒçœŸæ­£çš„å­—ç¬¦ä¸²å†…å®¹å­˜å‚¨åœ¨å¸¸é‡åŒºæˆ–å †åŒºï¼Œæˆ‘ä»¬æŠŠè¿™ä¸ªåœ°å€äº¤ç»™ <code>my_putstr</code> å»éå†æ‰“å°ã€‚ç„¶åå°±æ˜¯é‚£ä¸ªåç›´è§‰çš„ <code>%c</code> ï¼Œè™½ç„¶æˆ‘ä»¬è¦æ‰“å°çš„æ˜¯ <code>char</code>ï¼Œä½†åœ¨ <code>va_arg</code> é‡Œå¿…é¡»å†™ <code>int</code>ï¼Œæ­£å¦‚ç¬¬äºŒç« æ‰€è¿°ï¼ŒC è¯­è¨€çš„<strong>é»˜è®¤å‚æ•°æå‡</strong>è§„åˆ™ï¼Œ<code>char</code> åœ¨å…¥æ ˆæ—¶å·²ç»è¢«å¼ºè½¬ä¸º <code>int</code> äº†ï¼Œå› æ­¤æˆ‘ä»¬å–çš„æ—¶å€™ä¹Ÿè¦æŒ‰ç…§<code>int</code>æ¥å–ã€‚</p>
<p>æœ€å<code>va_end(ap)</code>ï¼Œè°ƒç”¨å®ƒæ¥å°†æŒ‡é’ˆç½®ç©ºã€‚</p>
<h2 data-id="heading-13">4. æµ‹è¯•ä¸éªŒè¯</h2>
<p>ä¸ºäº†éªŒè¯æˆ‘ä»¬çš„ <code>my_printf</code> æ˜¯å¦ç»å¾—èµ·è€ƒéªŒï¼Œæˆ‘ç¼–å†™äº†ä¸€ä¸ª <code>main</code> å‡½æ•°ï¼Œè¦†ç›–äº†æ•´æ•°ã€åå…­è¿›åˆ¶ã€å­—ç¬¦ä¸²ï¼Œå’Œæœ€å…³é”®çš„<strong>å­—ç¬¦æå‡</strong>ã€‚</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> 
{
 Â  Â my_putstr(<span class="hljs-string">"=== My Printf Test ===\n"</span>);
â€‹
 Â  Â my_printf(<span class="hljs-string">"Integer: %d\n"</span>, <span class="hljs-number">12345</span>);
 Â  Â my_printf(<span class="hljs-string">"Negative: %d\n"</span>, <span class="hljs-number">-6789</span>);
 Â  Â 
 Â  Â my_printf(<span class="hljs-string">"Hex: %x\n"</span>, <span class="hljs-number">255</span>); 
â€‹
 Â  Â my_printf(<span class="hljs-string">"String: %s\n"</span>, <span class="hljs-string">"Hello World"</span>);
â€‹
 Â  Â my_printf(<span class="hljs-string">"Char: %c\n"</span>, <span class="hljs-string">'A'</span>); 
â€‹
 Â  Â my_printf(<span class="hljs-string">"Mix: %d + %c = %s\n"</span>, <span class="hljs-number">1</span>, <span class="hljs-string">'2'</span>, <span class="hljs-string">"Three"</span>);
â€‹
 Â  Â <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p>è¿è¡Œç»“æœå¦‚ä¸‹ï¼Œå¤§å®¶å¯ä»¥çœ‹åˆ°ï¼Œå„ç§ç±»å‹éƒ½èƒ½æ­£å¸¸æ‰“å°ã€‚åŒ…æ‹¬æ¶‰åŠåˆ°å‚æ•°æå‡çš„<code>char</code>å‹ï¼Œä¹Ÿèƒ½æ­£å¸¸æ‰“å°ã€‚</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3713c1563d184b3d889fc1a3da08156a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeGxwNjY2aHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766811531&amp;x-signature=8y2WwYyxXCY6skeTKZ7J9rH41Qs%3D" alt="5. è¿è¡Œç»“æœ.png" loading="lazy"/></p>
<h2 data-id="heading-14">5. æ€»ç»“</h2>
<p>å†™åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬çš„ <code>my_printf</code> å·²ç»è·‘é€šäº†ã€‚ä½†è¯´å®è¯ï¼Œè¿™ä¸åˆ° 100 è¡Œçš„ä»£ç æœ¬èº«å¹¶ä¸é‡è¦ï¼Œæ¯•ç«Ÿåœ¨å®é™…åº”ç”¨ä¸­ï¼Œæˆ‘ä»¬æ°¸è¿œä¼šå»ç”¨æ ‡å‡†åº“é‚£ä¸ªç»è¿‡åƒé”¤ç™¾ç‚¼çš„ <code>printf</code>ã€‚</p>
<p>è€Œ<strong>è¿™ä¸ªæ‰‹å†™ <code>printf</code> çœŸæ­£çš„ä»·å€¼ï¼Œåœ¨äºå®ƒæ˜¯æˆ‘ä»¬æ¢ç´¢åº•å±‚åŸç†çš„ä¸€ä¸ªå¼•å¯¼ã€‚</strong></p>
<p>é€šè¿‡è¿™å‡ ç« çš„åˆ†æï¼Œæˆ‘ä»¬æ”¶è·çš„ä¸æ˜¯ä¸€ä¸ªç²—ç³™çš„æ‰“å°å‡½æ•°ï¼Œè€Œæ˜¯å¯¹ C è¯­è¨€è¿è¡Œæœºåˆ¶çš„æ·±åˆ»ç†è§£ã€‚</p>
<p>æˆ‘ä»¬äº²æ‰‹è¯æ˜äº† <code>&lt;stdarg.h&gt;</code> é‡Œé‚£äº›çœ‹ä¼¼é«˜æ·±çš„å®ï¼Œå‰¥å»å®ƒå…‰é²œäº®ä¸½çš„å¤–å£³åï¼Œä¸è¿‡æ˜¯<strong>æœ´å®æ— åçš„æŒ‡é’ˆåŠ å‡æ³•</strong>ã€‚</p>
<p>æˆ‘ä»¬æ·±åˆ»ä½“ä¼šåˆ°äº†<strong>é»˜è®¤å‚æ•°æå‡</strong>çš„å­˜åœ¨ã€‚è¿™ä¸æ˜¯ä¹¦æœ¬ä¸Šçš„æ­»è®°ç¡¬èƒŒï¼Œè€Œæ˜¯ä¸ºäº†è®© CPU è·‘å¾—æ›´å¿«ã€å†…å­˜å¯¹é½æ›´æ–¹ä¾¿è€Œè®¾è®¡çš„ç¡¬ä»¶å¦¥åã€‚</p>
<p>æˆ‘ä»¬è¿˜çŸ¥é“å‚æ•°åœ¨å†…å­˜é‡Œæ˜¯æŒ¨ç€æ”¾çš„ï¼Œæ‹¿åˆ°ä¸€ä¸ªå‚æ•°å°±èƒ½é¡ºè—¤æ‘¸ç“œæ‹¿åˆ°å…¶ä»–çš„å‚æ•°ã€‚</p>
<p>å¥½äº†ï¼Œè¿™ç¯‡æ–‡ç« åˆ°è¿™é‡Œå°±ç»“æŸäº†ã€‚æœ€åæˆ‘è¿˜æƒ³è¯´ä¸¤å¥ç§æˆ¿è¯ï¼Œæˆ‘çœŸå¿ƒå¸Œæœ›è¿™ç¯‡æ–‡ç« èƒ½å¸®åŠ©åˆ°å¤§å®¶ï¼Œå¦‚æœå¤§å®¶è§‰å¾—çœ‹å®Œè¿™ç¯‡æ–‡ç« æœ‰æ‰€æ”¶è·çš„è¯ï¼Œå¹¶ä¸”ä½ è‡ªå·±ä¹Ÿæ„¿æ„çš„è¯ï¼Œå¸Œæœ›ä½ èƒ½ç•™ä¸‹ä¸€ä¸ªå…³æ³¨ï¼Œæˆ‘åœ¨è¿™é‡Œå…ˆè¯´ä¸€å£°æ„Ÿè°¢ï¼Œåé¢æˆ‘è¿˜ä¼šå†å‘è¿™ç§èƒ½å¸®åŠ©å¤§å®¶æ·±å…¥ç†è§£åº•å±‚åŸç†çš„æ–‡ç« ã€‚</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>